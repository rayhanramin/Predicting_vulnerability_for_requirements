<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27450:e5737872508567abf8b0444f43eb4ee4ce211c75</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e5737872508567abf8b0444f43eb4ee4ce211c75" />
<meta property="og:url" content="/comm-central/rev/e5737872508567abf8b0444f43eb4ee4ce211c75" />
<meta property="og:description" content="Bug 1577835 - Reformat chat/ code with eslint and Prettier. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e5737872508567abf8b0444f43eb4ee4ce211c75 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e5737872508567abf8b0444f43eb4ee4ce211c75">shortlog</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e5737872508567abf8b0444f43eb4ee4ce211c75">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75">files</a> |
changeset |
<a href="/comm-central/raw-rev/e5737872508567abf8b0444f43eb4ee4ce211c75">raw</a>  | <a href="/comm-central/archive/e5737872508567abf8b0444f43eb4ee4ce211c75.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">Bug 1577835</a> - Reformat chat/ code with eslint and Prettier. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#117;&#108;&#32;&#77;&#111;&#114;&#114;&#105;&#115;&#32;&#60;&#112;&#97;&#117;&#108;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 30 Aug 2019 13:43:03 -0400</td></tr>

<tr>
 <td>changeset 27450</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e5737872508567abf8b0444f43eb4ee4ce211c75">e5737872508567abf8b0444f43eb4ee4ce211c75</a></td>
</tr>



<tr>
<td>parent 27449</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d62d63b2f73ccbbb09eafb7c9ac345c1a3467a5d">d62d63b2f73ccbbb09eafb7c9ac345c1a3467a5d</a>
</td>
</tr>

<tr>
<td>child 27451</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8e3167f4cea7e33c9b7948a3ce7981774d1f2a2d">8e3167f4cea7e33c9b7948a3ce7981774d1f2a2d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e5737872508567abf8b0444f43eb4ee4ce211c75">16348</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 01 Sep 2019 21:02:53 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8177b85d18db [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8177b85d18db77c4787461cd6db9575ef9935aea">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8177b85d18db77c4787461cd6db9575ef9935aea&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">1577835</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">Bug 1577835</a> - Reformat chat/ code with eslint and Prettier. r=mkmelin
# ignore-this-changeset

These changes were achieved by:

1. Using eslint to add curly brackets to control
statements that did not have them (if, else, etc.),
thanks to the eslint rule: &quot;curly&quot;: [&quot;error&quot;, &quot;all&quot;]

Done by running |mach eslint chat/ --fix|

2. Reformatting the code using Prettier.

Done by deleting the chat/ line from
the .prettierignore file and running:
|mach eslint chat/ --fix|</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/.prettierignore">.prettierignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/.prettierignore">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/.prettierignore">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/.prettierignore">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/.prettierignore">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/.prettierignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCommands.js">chat/components/src/imCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCommands.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCommands.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCommands.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCommands.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imContacts.js">chat/components/src/imContacts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imContacts.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imContacts.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imConversations.js">chat/components/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCore.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCore.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/logger.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/logger.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/smileProtocolHandler.js">chat/components/src/smileProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/smileProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/smileProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/smileProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/smileProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/smileProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_accounts.js">chat/components/src/test/test_accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_accounts.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_accounts.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_accounts.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_accounts.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_accounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_commands.js">chat/components/src/test/test_commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_commands.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_commands.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_commands.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_commands.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_conversations.js">chat/components/src/test/test_conversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_conversations.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_conversations.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_conversations.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_conversations.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_conversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_logger.js">chat/components/src/test/test_logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_logger.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_logger.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_logger.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_logger.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/components/src/test/test_logger.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/browserRequest.js">chat/content/browserRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/browserRequest.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/browserRequest.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-account-richlistitem.js">chat/content/chat-account-richlistitem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-account-richlistitem.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-account-richlistitem.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-account-richlistitem.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-account-richlistitem.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-account-richlistitem.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-tooltip.js">chat/content/chat-tooltip.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-tooltip.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-tooltip.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-tooltip.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-tooltip.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/chat-tooltip.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/conversation-browser.js">chat/content/conversation-browser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/conversation-browser.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/conversation-browser.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/conversation-browser.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/conversation-browser.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/conversation-browser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/imAccountOptionsHelper.js">chat/content/imAccountOptionsHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/imAccountOptionsHelper.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/imAccountOptionsHelper.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/imAccountOptionsHelper.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/imAccountOptionsHelper.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/imAccountOptionsHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-add-fingerprint.js">chat/content/otr-add-fingerprint.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-add-fingerprint.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-add-fingerprint.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-add-fingerprint.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-add-fingerprint.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-add-fingerprint.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-auth.js">chat/content/otr-auth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-auth.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-auth.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-auth.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-auth.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-auth.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-finger.js">chat/content/otr-finger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-finger.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-finger.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-finger.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-finger.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otr-finger.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otrWorker.js">chat/content/otrWorker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otrWorker.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otrWorker.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otrWorker.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otrWorker.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/content/otrWorker.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ArrayBufferUtils.jsm">chat/modules/ArrayBufferUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ArrayBufferUtils.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ArrayBufferUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ArrayBufferUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ArrayBufferUtils.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ArrayBufferUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/CLib.jsm">chat/modules/CLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/CLib.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/CLib.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/CLib.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/CLib.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/CLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/NormalizedMap.jsm">chat/modules/NormalizedMap.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/NormalizedMap.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/NormalizedMap.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/NormalizedMap.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/NormalizedMap.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/NormalizedMap.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTR.jsm">chat/modules/OTR.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTR.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTR.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTR.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTR.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTR.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRHelpers.jsm">chat/modules/OTRHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRHelpers.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRHelpers.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRLib.jsm">chat/modules/OTRLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRLib.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRLib.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRLib.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRLib.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRUI.jsm">chat/modules/OTRUI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRUI.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRUI.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRUI.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRUI.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/OTRUI.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ToLocaleFormat.jsm">chat/modules/ToLocaleFormat.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ToLocaleFormat.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ToLocaleFormat.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ToLocaleFormat.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ToLocaleFormat.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/ToLocaleFormat.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/hiddenWindow.jsm">chat/modules/hiddenWindow.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/hiddenWindow.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/hiddenWindow.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/hiddenWindow.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/hiddenWindow.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/hiddenWindow.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imContentSink.jsm">chat/modules/imContentSink.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imContentSink.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imContentSink.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imContentSink.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imContentSink.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imContentSink.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imServices.jsm">chat/modules/imServices.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imServices.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imServices.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imServices.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imServices.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imServices.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imSmileys.jsm">chat/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imStatusUtils.jsm">chat/modules/imStatusUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imStatusUtils.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imStatusUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imStatusUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imStatusUtils.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imStatusUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imTextboxUtils.jsm">chat/modules/imTextboxUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imTextboxUtils.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imTextboxUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imTextboxUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imTextboxUtils.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imTextboxUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imThemes.jsm">chat/modules/imThemes.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imThemes.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imThemes.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imThemes.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imThemes.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imThemes.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/socket.jsm">chat/modules/socket.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/socket.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/socket.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/socket.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/socket.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/socket.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_ArrayBufferUtils.js">chat/modules/test/test_ArrayBufferUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_ArrayBufferUtils.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_ArrayBufferUtils.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_ArrayBufferUtils.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_ArrayBufferUtils.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_ArrayBufferUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_NormalizedMap.js">chat/modules/test/test_NormalizedMap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_NormalizedMap.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_NormalizedMap.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_NormalizedMap.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_NormalizedMap.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_NormalizedMap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_filtering.js">chat/modules/test/test_filtering.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_filtering.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_filtering.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_filtering.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_filtering.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/modules/test/test_filtering.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/facebook/facebook.js">chat/protocols/facebook/facebook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/facebook/facebook.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/facebook/facebook.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/facebook/facebook.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/facebook/facebook.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/facebook/facebook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/gtalk/gtalk.js">chat/protocols/gtalk/gtalk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/gtalk/gtalk.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/gtalk/gtalk.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/gtalk/gtalk.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/gtalk/gtalk.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/gtalk/gtalk.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/irc.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/irc.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircBase.jsm">chat/protocols/irc/ircBase.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircBase.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircBase.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircBase.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircBase.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircBase.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCAP.jsm">chat/protocols/irc/ircCAP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCAP.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCAP.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCAP.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCAP.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCAP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCTCP.jsm">chat/protocols/irc/ircCTCP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCTCP.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCTCP.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCTCP.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCTCP.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCTCP.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCommands.jsm">chat/protocols/irc/ircCommands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCommands.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCommands.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCommands.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCommands.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircCommands.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircDCC.jsm">chat/protocols/irc/ircDCC.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircDCC.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircDCC.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircDCC.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircDCC.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircDCC.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircHandlers.jsm">chat/protocols/irc/ircHandlers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircHandlers.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircHandlers.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircHandlers.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircHandlers.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircHandlers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircISUPPORT.jsm">chat/protocols/irc/ircISUPPORT.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircISUPPORT.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircISUPPORT.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircISUPPORT.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircISUPPORT.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircISUPPORT.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircMultiPrefix.jsm">chat/protocols/irc/ircMultiPrefix.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircMultiPrefix.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircMultiPrefix.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircMultiPrefix.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircMultiPrefix.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircMultiPrefix.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircNonStandard.jsm">chat/protocols/irc/ircNonStandard.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircNonStandard.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircNonStandard.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircNonStandard.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircNonStandard.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircNonStandard.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircSASL.jsm">chat/protocols/irc/ircSASL.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircSASL.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircSASL.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircSASL.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircSASL.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircSASL.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServerTime.jsm">chat/protocols/irc/ircServerTime.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServerTime.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServerTime.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServerTime.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServerTime.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServerTime.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServices.jsm">chat/protocols/irc/ircServices.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServices.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServices.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServices.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServices.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircServices.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircUtils.jsm">chat/protocols/irc/ircUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircUtils.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircUtils.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircWatchMonitor.jsm">chat/protocols/irc/ircWatchMonitor.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircWatchMonitor.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircWatchMonitor.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircWatchMonitor.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircWatchMonitor.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/ircWatchMonitor.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpColoring.js">chat/protocols/irc/test/test_ctcpColoring.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpColoring.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpColoring.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpColoring.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpColoring.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpColoring.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpDequote.js">chat/protocols/irc/test/test_ctcpDequote.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpDequote.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpDequote.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpDequote.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpDequote.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpDequote.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpFormatting.js">chat/protocols/irc/test/test_ctcpFormatting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpFormatting.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpFormatting.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpFormatting.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpFormatting.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpFormatting.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpQuote.js">chat/protocols/irc/test/test_ctcpQuote.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpQuote.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpQuote.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpQuote.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpQuote.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ctcpQuote.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCAP.js">chat/protocols/irc/test/test_ircCAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCAP.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCAP.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCAP.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCAP.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCAP.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCommands.js">chat/protocols/irc/test/test_ircCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCommands.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCommands.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCommands.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCommands.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircMessage.js">chat/protocols/irc/test/test_ircMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircMessage.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircMessage.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircMessage.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircMessage.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircMessage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircNonStandard.js">chat/protocols/irc/test/test_ircNonStandard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircNonStandard.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircNonStandard.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircNonStandard.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircNonStandard.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircNonStandard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircServerTime.js">chat/protocols/irc/test/test_ircServerTime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircServerTime.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircServerTime.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircServerTime.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircServerTime.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_ircServerTime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_sendBufferedCommand.js">chat/protocols/irc/test/test_sendBufferedCommand.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_sendBufferedCommand.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_sendBufferedCommand.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_sendBufferedCommand.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_sendBufferedCommand.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_sendBufferedCommand.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_setMode.js">chat/protocols/irc/test/test_setMode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_setMode.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_setMode.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_setMode.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_setMode.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_setMode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_splitLongMessages.js">chat/protocols/irc/test/test_splitLongMessages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_splitLongMessages.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_splitLongMessages.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_splitLongMessages.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_splitLongMessages.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_splitLongMessages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_tryNewNick.js">chat/protocols/irc/test/test_tryNewNick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_tryNewNick.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_tryNewNick.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_tryNewNick.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_tryNewNick.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/irc/test/test_tryNewNick.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/jsTest/jsTestProtocol.js">chat/protocols/jsTest/jsTestProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/jsTest/jsTestProtocol.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/jsTest/jsTestProtocol.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/jsTest/jsTestProtocol.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/jsTest/jsTestProtocol.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/jsTest/jsTestProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix-sdk.jsm">chat/protocols/matrix/matrix-sdk.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix-sdk.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix-sdk.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix-sdk.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix-sdk.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix-sdk.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix.js">chat/protocols/matrix/matrix.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/matrix/matrix.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/odnoklassniki/odnoklassniki.js">chat/protocols/odnoklassniki/odnoklassniki.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/odnoklassniki/odnoklassniki.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/odnoklassniki/odnoklassniki.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/odnoklassniki/odnoklassniki.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/odnoklassniki/odnoklassniki.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/odnoklassniki/odnoklassniki.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/skype.js">chat/protocols/skype/skype.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/skype.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/skype.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/skype.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/skype.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/skype.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_MagicSha256.js">chat/protocols/skype/test/test_MagicSha256.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_MagicSha256.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_MagicSha256.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_MagicSha256.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_MagicSha256.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_MagicSha256.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_contactUrlToName.js">chat/protocols/skype/test/test_contactUrlToName.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_contactUrlToName.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_contactUrlToName.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_contactUrlToName.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_contactUrlToName.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/skype/test/test_contactUrlToName.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/twitter/twitter.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/twitter/twitter.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_authmechs.js">chat/protocols/xmpp/test/test_authmechs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_authmechs.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_authmechs.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_authmechs.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_authmechs.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_authmechs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_dnsSrv.js">chat/protocols/xmpp/test/test_dnsSrv.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_dnsSrv.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_dnsSrv.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_dnsSrv.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_dnsSrv.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_dnsSrv.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">chat/protocols/xmpp/test/test_parseJidAndNormalization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseVCard.js">chat/protocols/xmpp/test/test_parseVCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseVCard.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseVCard.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseVCard.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseVCard.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_parseVCard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_saslPrep.js">chat/protocols/xmpp/test/test_saslPrep.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_saslPrep.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_saslPrep.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_saslPrep.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_saslPrep.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_saslPrep.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppParser.js">chat/protocols/xmpp/test/test_xmppParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppParser.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppParser.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppParser.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppParser.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppParser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppXml.js">chat/protocols/xmpp/test/test_xmppXml.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppXml.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppXml.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppXml.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppXml.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/test/test_xmppXml.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-authmechs.jsm">chat/protocols/xmpp/xmpp-authmechs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-authmechs.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-authmechs.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-authmechs.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-authmechs.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-authmechs.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-commands.jsm">chat/protocols/xmpp/xmpp-commands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-commands.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-commands.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-commands.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-commands.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-commands.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-session.jsm">chat/protocols/xmpp/xmpp-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-session.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-session.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-session.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-session.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-xml.jsm">chat/protocols/xmpp/xmpp-xml.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-xml.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-xml.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-xml.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-xml.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp-xml.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.js">chat/protocols/xmpp/xmpp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/yahoo/yahoo.js">file</a> |
<a href="/comm-central/annotate/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/yahoo/yahoo.js">annotate</a> |
<a href="/comm-central/diff/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/e5737872508567abf8b0444f43eb4ee4ce211c75/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.prettierignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.prettierignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,15 +6,14 @@</span>
<a href="#l1.4"></a><span id="l1.4"> *.xhtml</span>
<a href="#l1.5"></a><span id="l1.5"> *.xul</span>
<a href="#l1.6"></a><span id="l1.6"> *.xml</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # Ignore .eslintrc.js for now.</span>
<a href="#l1.9"></a><span id="l1.9"> .eslintrc.js</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> # Ignore all top-level directories that contain JS files (for now).</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-chat/**</span>
<a href="#l1.13"></a><span id="l1.13"> common/**</span>
<a href="#l1.14"></a><span id="l1.14"> editor/**</span>
<a href="#l1.15"></a><span id="l1.15"> ldap/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/**</span>
<a href="#l1.17"></a><span id="l1.17"> mailnews/**</span>
<a href="#l1.18"></a><span id="l1.18"> suite/**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/src/imAccounts.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -6,18 +6,21 @@ var {</span>
<a href="#l2.4"></a><span id="l2.4">   EmptyEnumerator,</span>
<a href="#l2.5"></a><span id="l2.5">   nsSimpleEnumerator,</span>
<a href="#l2.6"></a><span id="l2.6">   XPCOMUtils,</span>
<a href="#l2.7"></a><span id="l2.7">   setTimeout,</span>
<a href="#l2.8"></a><span id="l2.8">   clearTimeout,</span>
<a href="#l2.9"></a><span id="l2.9">   executeSoon,</span>
<a href="#l2.10"></a><span id="l2.10">   l10nHelper,</span>
<a href="#l2.11"></a><span id="l2.11"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-var {GenericAccountPrototype, GenericAccountBuddyPrototype} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+var {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  GenericAccountPrototype,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  GenericAccountBuddyPrototype,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> var kPrefAutologinPending = &quot;messenger.accounts.autoLoginPending&quot;;</span>
<a href="#l2.21"></a><span id="l2.21"> var kPrefMessengerAccounts = &quot;messenger.accounts&quot;;</span>
<a href="#l2.22"></a><span id="l2.22"> var kPrefAccountPrefix = &quot;messenger.account.&quot;;</span>
<a href="#l2.23"></a><span id="l2.23"> var kAccountKeyPrefix = &quot;account&quot;;</span>
<a href="#l2.24"></a><span id="l2.24"> var kAccountOptionPrefPrefix = &quot;options.&quot;;</span>
<a href="#l2.25"></a><span id="l2.25"> var kPrefAccountName = &quot;name&quot;;</span>
<a href="#l2.26"></a><span id="l2.26"> var kPrefAccountPrpl = &quot;prpl&quot;;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineat">@@ -32,128 +35,171 @@ var kPrefAccountPassword = &quot;password&quot;;</span>
<a href="#l2.28"></a><span id="l2.28"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l2.29"></a><span id="l2.29">   l10nHelper(&quot;chrome://chat/locale/accounts.properties&quot;)</span>
<a href="#l2.30"></a><span id="l2.30"> );</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> XPCOMUtils.defineLazyGetter(this, &quot;_maxDebugMessages&quot;, () =&gt;</span>
<a href="#l2.33"></a><span id="l2.33">   Services.prefs.getIntPref(&quot;messenger.accounts.maxDebugMessages&quot;)</span>
<a href="#l2.34"></a><span id="l2.34"> );</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;HttpProtocolHandler&quot;,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  &quot;@mozilla.org/network/protocol;1?name=http&quot;, &quot;nsIHttpProtocolHandler&quot;);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  this,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  &quot;HttpProtocolHandler&quot;,</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  &quot;@mozilla.org/network/protocol;1?name=http&quot;,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  &quot;nsIHttpProtocolHandler&quot;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+);</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45"> var gUserCanceledMasterPasswordPrompt = false;</span>
<a href="#l2.46"></a><span id="l2.46"> var gConvertingOldPasswords = false;</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48"> var SavePrefTimer = {</span>
<a href="#l2.49"></a><span id="l2.49">   saveNow() {</span>
<a href="#l2.50"></a><span id="l2.50">     if (this._timer) {</span>
<a href="#l2.51"></a><span id="l2.51">       clearTimeout(this._timer);</span>
<a href="#l2.52"></a><span id="l2.52">       this._timer = null;</span>
<a href="#l2.53"></a><span id="l2.53">     }</span>
<a href="#l2.54"></a><span id="l2.54">     Services.prefs.savePrefFile(null);</span>
<a href="#l2.55"></a><span id="l2.55">   },</span>
<a href="#l2.56"></a><span id="l2.56">   _timer: null,</span>
<a href="#l2.57"></a><span id="l2.57">   unInitTimer() {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-    if (this._timer)</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    if (this._timer) {</span>
<a href="#l2.60"></a><span id="l2.60">       this.saveNow();</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    }</span>
<a href="#l2.62"></a><span id="l2.62">   },</span>
<a href="#l2.63"></a><span id="l2.63">   initTimer() {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    if (!this._timer)</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    if (!this._timer) {</span>
<a href="#l2.66"></a><span id="l2.66">       this._timer = setTimeout(this.saveNow.bind(this), 5000);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    }</span>
<a href="#l2.68"></a><span id="l2.68">   },</span>
<a href="#l2.69"></a><span id="l2.69"> };</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71"> var AutoLoginCounter = {</span>
<a href="#l2.72"></a><span id="l2.72">   _count: 0,</span>
<a href="#l2.73"></a><span id="l2.73">   startAutoLogin() {</span>
<a href="#l2.74"></a><span id="l2.74">     ++this._count;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-    if (this._count != 1)</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    if (this._count != 1) {</span>
<a href="#l2.77"></a><span id="l2.77">       return;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+    }</span>
<a href="#l2.79"></a><span id="l2.79">     Services.prefs.setIntPref(kPrefAutologinPending, Date.now() / 1000);</span>
<a href="#l2.80"></a><span id="l2.80">     SavePrefTimer.saveNow();</span>
<a href="#l2.81"></a><span id="l2.81">   },</span>
<a href="#l2.82"></a><span id="l2.82">   finishedAutoLogin() {</span>
<a href="#l2.83"></a><span id="l2.83">     --this._count;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    if (this._count != 0)</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+    if (this._count != 0) {</span>
<a href="#l2.86"></a><span id="l2.86">       return;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+    }</span>
<a href="#l2.88"></a><span id="l2.88">     Services.prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l2.89"></a><span id="l2.89">     SavePrefTimer.initTimer();</span>
<a href="#l2.90"></a><span id="l2.90">   },</span>
<a href="#l2.91"></a><span id="l2.91"> };</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-function UnknownProtocol(aPrplId)</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-{</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+function UnknownProtocol(aPrplId) {</span>
<a href="#l2.96"></a><span id="l2.96">   this.id = aPrplId;</span>
<a href="#l2.97"></a><span id="l2.97"> }</span>
<a href="#l2.98"></a><span id="l2.98"> UnknownProtocol.prototype = {</span>
<a href="#l2.99"></a><span id="l2.99">   __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Unknown protocol&quot;),</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-  get name() { return &quot;&quot;; },</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-  get normalizedName() { return this.name; },</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://chat/skin/prpl-unknown/&quot;; },</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  getOptions() { return EmptyEnumerator; },</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-  getUsernameSplit() { return EmptyEnumerator; },</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-  get usernameEmptyText() { return &quot;&quot;; },</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  get name() {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+  },</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  get normalizedName() {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+    return this.name;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  },</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    return &quot;chrome://chat/skin/prpl-unknown/&quot;;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+  },</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  getOptions() {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+    return EmptyEnumerator;</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  },</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  getUsernameSplit() {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+    return EmptyEnumerator;</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+  },</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+  },</span>
<a href="#l2.124"></a><span id="l2.124"> </span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-  getAccount(aKey, aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-  accountExists() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  getAccount(aKey, aName) {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  },</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  accountExists() {</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+  },</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134">   // false seems an acceptable default for all options</span>
<a href="#l2.135"></a><span id="l2.135">   // (they should never be called anyway).</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-  get uniqueChatName() { return false; },</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-  get chatHasTopic() { return false; },</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-  get noPassword() { return false; },</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-  get newMailNotification() { return false; },</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-  get imagesInIM() { return false; },</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-  get passwordOptional() { return true; },</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  get usePointSize() { return true; },</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-  get registerNoScreenName() { return false; },</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-  get slashCommandsNative() { return false; },</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-  get usePurpleProxy() { return false; },</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+  get uniqueChatName() {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+    return false;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  },</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+    return false;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+  },</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  get noPassword() {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    return false;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  },</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  get newMailNotification() {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+    return false;</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+  },</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+  get imagesInIM() {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+    return false;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  },</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  get passwordOptional() {</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    return true;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+  },</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+  get usePointSize() {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+    return true;</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+  },</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  get registerNoScreenName() {</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+    return false;</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  },</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  get slashCommandsNative() {</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+    return false;</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+  },</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+  get usePurpleProxy() {</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+    return false;</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+  },</span>
<a href="#l2.176"></a><span id="l2.176"> };</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178"> // An unknown prplIAccount.</span>
<a href="#l2.179"></a><span id="l2.179"> function UnknownAccount(aAccount) {</span>
<a href="#l2.180"></a><span id="l2.180">   this._init(aAccount.protocol, aAccount);</span>
<a href="#l2.181"></a><span id="l2.181"> }</span>
<a href="#l2.182"></a><span id="l2.182"> UnknownAccount.prototype = GenericAccountPrototype;</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184"> function UnknownAccountBuddy(aAccount, aBuddy, aTag) {</span>
<a href="#l2.185"></a><span id="l2.185">   this._init(new UnknownAccount(aAccount), aBuddy, aTag);</span>
<a href="#l2.186"></a><span id="l2.186"> }</span>
<a href="#l2.187"></a><span id="l2.187"> UnknownAccountBuddy.prototype = GenericAccountBuddyPrototype;</span>
<a href="#l2.188"></a><span id="l2.188"> </span>
<a href="#l2.189"></a><span id="l2.189"> // aName and aPrplId are provided as parameter only if this is a new</span>
<a href="#l2.190"></a><span id="l2.190"> // account that doesn't exist in the preferences. In this case, these</span>
<a href="#l2.191"></a><span id="l2.191"> // 2 values should be stored.</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-function imAccount(aKey, aName, aPrplId)</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-{</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-  if (!aKey.startsWith(kAccountKeyPrefix))</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+function imAccount(aKey, aName, aPrplId) {</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+  if (!aKey.startsWith(kAccountKeyPrefix)) {</span>
<a href="#l2.197"></a><span id="l2.197">     throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  }</span>
<a href="#l2.199"></a><span id="l2.199"> </span>
<a href="#l2.200"></a><span id="l2.200">   this.id = aKey;</span>
<a href="#l2.201"></a><span id="l2.201">   this.numericId = parseInt(aKey.substr(kAccountKeyPrefix.length));</span>
<a href="#l2.202"></a><span id="l2.202">   gAccountsService._keepAccount(this);</span>
<a href="#l2.203"></a><span id="l2.203">   this.prefBranch = Services.prefs.getBranch(kPrefAccountPrefix + aKey + &quot;.&quot;);</span>
<a href="#l2.204"></a><span id="l2.204"> </span>
<a href="#l2.205"></a><span id="l2.205">   if (aName) {</span>
<a href="#l2.206"></a><span id="l2.206">     this.name = aName;</span>
<a href="#l2.207"></a><span id="l2.207">     this.prefBranch.setStringPref(kPrefAccountName, aName);</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209">     this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-  }</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-  else {</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+  } else {</span>
<a href="#l2.213"></a><span id="l2.213">     this.name = this.prefBranch.getStringPref(kPrefAccountName);</span>
<a href="#l2.214"></a><span id="l2.214">   }</span>
<a href="#l2.215"></a><span id="l2.215"> </span>
<a href="#l2.216"></a><span id="l2.216">   let prplId = aPrplId;</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-  if (prplId)</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  if (prplId) {</span>
<a href="#l2.219"></a><span id="l2.219">     this.prefBranch.setCharPref(kPrefAccountPrpl, prplId);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-  else</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+  } else {</span>
<a href="#l2.222"></a><span id="l2.222">     prplId = this.prefBranch.getCharPref(kPrefAccountPrpl);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+  }</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225">   // Get the protocol plugin, or fallback to an UnknownProtocol instance.</span>
<a href="#l2.226"></a><span id="l2.226">   this.protocol = Services.core.getProtocolById(prplId);</span>
<a href="#l2.227"></a><span id="l2.227">   if (!this.protocol) {</span>
<a href="#l2.228"></a><span id="l2.228">     this.protocol = new UnknownProtocol(prplId);</span>
<a href="#l2.229"></a><span id="l2.229">     this._connectionErrorReason = Ci.imIAccount.ERROR_UNKNOWN_PRPL;</span>
<a href="#l2.230"></a><span id="l2.230">     return;</span>
<a href="#l2.231"></a><span id="l2.231">   }</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineat">@@ -164,238 +210,280 @@ function imAccount(aKey, aName, aPrplId)</span>
<a href="#l2.233"></a><span id="l2.233">   // Get the prplIAccount from the protocol plugin.</span>
<a href="#l2.234"></a><span id="l2.234">   this.prplAccount = this.protocol.getAccount(this);</span>
<a href="#l2.235"></a><span id="l2.235"> </span>
<a href="#l2.236"></a><span id="l2.236">   // Send status change notifications to the account.</span>
<a href="#l2.237"></a><span id="l2.237">   this.observedStatusInfo = null; // (To execute the setter).</span>
<a href="#l2.238"></a><span id="l2.238"> </span>
<a href="#l2.239"></a><span id="l2.239">   // If we have never finished the first connection attempt for this account,</span>
<a href="#l2.240"></a><span id="l2.240">   // mark the account as having caused a crash.</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-  if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING)</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l2.243"></a><span id="l2.243">     this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_CRASHED;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+  }</span>
<a href="#l2.245"></a><span id="l2.245"> </span>
<a href="#l2.246"></a><span id="l2.246">   Services.logins.initializationPromise.then(() =&gt; {</span>
<a href="#l2.247"></a><span id="l2.247">     // Try to convert old passwords stored in the preferences.</span>
<a href="#l2.248"></a><span id="l2.248">     // Don't try too hard if the user has canceled a master password prompt:</span>
<a href="#l2.249"></a><span id="l2.249">     // we don't want to display several of theses prompts at startup.</span>
<a href="#l2.250"></a><span id="l2.250">     if (gConvertingOldPasswords &amp;&amp; !this.protocol.noPassword) {</span>
<a href="#l2.251"></a><span id="l2.251">       try {</span>
<a href="#l2.252"></a><span id="l2.252">         let password = this.prefBranch.getStringPref(kPrefAccountPassword);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        if (password &amp;&amp; !this.password)</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+        if (password &amp;&amp; !this.password) {</span>
<a href="#l2.255"></a><span id="l2.255">           this.password = password;</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-      } catch (e) { /* No password saved in the prefs for this account. */ }</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+        }</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+      } catch (e) {</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+        /* No password saved in the prefs for this account. */</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+      }</span>
<a href="#l2.261"></a><span id="l2.261">     }</span>
<a href="#l2.262"></a><span id="l2.262"> </span>
<a href="#l2.263"></a><span id="l2.263">     // Check for errors that should prevent connection attempts.</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-    if (this._passwordRequired &amp;&amp; !this.password)</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+    if (this._passwordRequired &amp;&amp; !this.password) {</span>
<a href="#l2.266"></a><span id="l2.266">       this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-    else if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_CRASHED)</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+    } else if (</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+      this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_CRASHED</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+    ) {</span>
<a href="#l2.271"></a><span id="l2.271">       this._connectionErrorReason = Ci.imIAccount.ERROR_CRASHED;</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+    }</span>
<a href="#l2.273"></a><span id="l2.273">   });</span>
<a href="#l2.274"></a><span id="l2.274"> }</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276"> imAccount.prototype = {</span>
<a href="#l2.277"></a><span id="l2.277">   __proto__: ClassInfo([&quot;imIAccount&quot;, &quot;prplIAccount&quot;], &quot;im account object&quot;),</span>
<a href="#l2.278"></a><span id="l2.278"> </span>
<a href="#l2.279"></a><span id="l2.279">   name: &quot;&quot;,</span>
<a href="#l2.280"></a><span id="l2.280">   id: &quot;&quot;,</span>
<a href="#l2.281"></a><span id="l2.281">   numericId: 0,</span>
<a href="#l2.282"></a><span id="l2.282">   protocol: null,</span>
<a href="#l2.283"></a><span id="l2.283">   prplAccount: null,</span>
<a href="#l2.284"></a><span id="l2.284">   connectionState: Ci.imIAccount.STATE_DISCONNECTED,</span>
<a href="#l2.285"></a><span id="l2.285">   connectionStateMsg: &quot;&quot;,</span>
<a href="#l2.286"></a><span id="l2.286">   connectionErrorMessage: &quot;&quot;,</span>
<a href="#l2.287"></a><span id="l2.287">   _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l2.288"></a><span id="l2.288">   get connectionErrorReason() {</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-    if (this._connectionErrorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-        (this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-         !this._password))</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+    if (</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+      this._connectionErrorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+      (this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+        !this._password)</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+    ) {</span>
<a href="#l2.297"></a><span id="l2.297">       return this._connectionErrorReason;</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+    }</span>
<a href="#l2.299"></a><span id="l2.299">     return this.prplAccount.connectionErrorReason;</span>
<a href="#l2.300"></a><span id="l2.300">   },</span>
<a href="#l2.301"></a><span id="l2.301"> </span>
<a href="#l2.302"></a><span id="l2.302">   observe(aSubject, aTopic, aData) {</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-    if (aTopic == &quot;account-connect-progress&quot;)</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+    if (aTopic == &quot;account-connect-progress&quot;) {</span>
<a href="#l2.305"></a><span id="l2.305">       this.connectionStateMsg = aData;</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-    else if (aTopic == &quot;account-connecting&quot;) {</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+    } else if (aTopic == &quot;account-connecting&quot;) {</span>
<a href="#l2.308"></a><span id="l2.308">       if (this.prplAccount.connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l2.309"></a><span id="l2.309">         delete this.connectionErrorMessage;</span>
<a href="#l2.310"></a><span id="l2.310">         if (this.timeOfNextReconnect - Date.now() &gt; 1000) {</span>
<a href="#l2.311"></a><span id="l2.311">           // This is a manual reconnection, reset the auto-reconnect stuff</span>
<a href="#l2.312"></a><span id="l2.312">           this.timeOfLastConnect = 0;</span>
<a href="#l2.313"></a><span id="l2.313">           this._cancelReconnection();</span>
<a href="#l2.314"></a><span id="l2.314">         }</span>
<a href="#l2.315"></a><span id="l2.315">       }</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK)</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l2.318"></a><span id="l2.318">         this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_PENDING;</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+      }</span>
<a href="#l2.320"></a><span id="l2.320">       this.connectionState = Ci.imIAccount.STATE_CONNECTING;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-    }</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-    else if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+    } else if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l2.324"></a><span id="l2.324">       this.connectionState = Ci.imIAccount.STATE_CONNECTED;</span>
<a href="#l2.325"></a><span id="l2.325">       this._finishedAutoLogin();</span>
<a href="#l2.326"></a><span id="l2.326">       this.timeOfLastConnect = Date.now();</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK)</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l2.329"></a><span id="l2.329">         this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+      }</span>
<a href="#l2.331"></a><span id="l2.331">       delete this.connectionStateMsg;</span>
<a href="#l2.332"></a><span id="l2.332"> </span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-      if (this.canJoinChat &amp;&amp;</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-          this.prefBranch.prefHasUserValue(kPrefAccountAutoJoin)) {</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+      if (</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+        this.canJoinChat &amp;&amp;</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+        this.prefBranch.prefHasUserValue(kPrefAccountAutoJoin)</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+      ) {</span>
<a href="#l2.339"></a><span id="l2.339">         let autojoin = this.prefBranch.getStringPref(kPrefAccountAutoJoin);</span>
<a href="#l2.340"></a><span id="l2.340">         if (autojoin) {</span>
<a href="#l2.341"></a><span id="l2.341">           for (let room of autojoin.trim().split(/,\s*/)) {</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-            if (room)</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+            if (room) {</span>
<a href="#l2.344"></a><span id="l2.344">               this.joinChat(this.getChatRoomDefaultFieldValues(room));</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+            }</span>
<a href="#l2.346"></a><span id="l2.346">           }</span>
<a href="#l2.347"></a><span id="l2.347">         }</span>
<a href="#l2.348"></a><span id="l2.348">       }</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-    }</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-    else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+    } else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l2.352"></a><span id="l2.352">       this.connectionState = Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l2.353"></a><span id="l2.353">       this.connectionErrorMessage = aData;</span>
<a href="#l2.354"></a><span id="l2.354">       delete this.connectionStateMsg;</span>
<a href="#l2.355"></a><span id="l2.355">       this._finishedAutoLogin();</span>
<a href="#l2.356"></a><span id="l2.356"> </span>
<a href="#l2.357"></a><span id="l2.357">       let firstConnectionState = this.firstConnectionState;</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-      if (firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK &amp;&amp;</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-          firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_CRASHED)</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+      if (</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+        firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK &amp;&amp;</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+        firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_CRASHED</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+      ) {</span>
<a href="#l2.364"></a><span id="l2.364">         this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+      }</span>
<a href="#l2.366"></a><span id="l2.366"> </span>
<a href="#l2.367"></a><span id="l2.367">       let connectionErrorReason = this.prplAccount.connectionErrorReason;</span>
<a href="#l2.368"></a><span id="l2.368">       if (connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-        if (connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-            connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR)</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+        if (</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+          connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+          connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+        ) {</span>
<a href="#l2.375"></a><span id="l2.375">           this._startReconnectTimer();</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+        }</span>
<a href="#l2.377"></a><span id="l2.377">         this._sendNotification(&quot;account-connect-error&quot;);</span>
<a href="#l2.378"></a><span id="l2.378">       }</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-    }</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-    else if (aTopic == &quot;account-disconnected&quot;) {</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+    } else if (aTopic == &quot;account-disconnected&quot;) {</span>
<a href="#l2.382"></a><span id="l2.382">       this.connectionState = Ci.imIAccount.STATE_DISCONNECTED;</span>
<a href="#l2.383"></a><span id="l2.383">       let connectionErrorReason = this.prplAccount.connectionErrorReason;</span>
<a href="#l2.384"></a><span id="l2.384">       if (connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l2.385"></a><span id="l2.385">         // If the account was disconnected with an error, save the debug messages.</span>
<a href="#l2.386"></a><span id="l2.386">         this._omittedDebugMessagesBeforeError += this._omittedDebugMessages;</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-        if (this._debugMessagesBeforeError)</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+        if (this._debugMessagesBeforeError) {</span>
<a href="#l2.389"></a><span id="l2.389">           this._omittedDebugMessagesBeforeError += this._debugMessagesBeforeError.length;</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+        }</span>
<a href="#l2.391"></a><span id="l2.391">         this._debugMessagesBeforeError = this._debugMessages;</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-      }</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-      else {</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+      } else {</span>
<a href="#l2.395"></a><span id="l2.395">         // After a clean disconnection, drop the debug messages that</span>
<a href="#l2.396"></a><span id="l2.396">         // could have been left by a previous error.</span>
<a href="#l2.397"></a><span id="l2.397">         delete this._omittedDebugMessagesBeforeError;</span>
<a href="#l2.398"></a><span id="l2.398">         delete this._debugMessagesBeforeError;</span>
<a href="#l2.399"></a><span id="l2.399">       }</span>
<a href="#l2.400"></a><span id="l2.400">       delete this._omittedDebugMessages;</span>
<a href="#l2.401"></a><span id="l2.401">       delete this._debugMessages;</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-      if (this._statusObserver &amp;&amp;</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-          connectionErrorReason == Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-          this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+      if (</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+        this._statusObserver &amp;&amp;</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+        connectionErrorReason == Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+        this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+      ) {</span>
<a href="#l2.410"></a><span id="l2.410">         // If the status changed back to online while an account was still</span>
<a href="#l2.411"></a><span id="l2.411">         // disconnecting, it was not reconnected automatically at that point,</span>
<a href="#l2.412"></a><span id="l2.412">         // so we must do it now. (This happens for protocols like IRC where</span>
<a href="#l2.413"></a><span id="l2.413">         // disconnection is not immediate.)</span>
<a href="#l2.414"></a><span id="l2.414">         this._sendNotification(aTopic, aData);</span>
<a href="#l2.415"></a><span id="l2.415">         this.connect();</span>
<a href="#l2.416"></a><span id="l2.416">         return;</span>
<a href="#l2.417"></a><span id="l2.417">       }</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+    } else {</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l2.420"></a><span id="l2.420">     }</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-    else</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l2.423"></a><span id="l2.423">     this._sendNotification(aTopic, aData);</span>
<a href="#l2.424"></a><span id="l2.424">   },</span>
<a href="#l2.425"></a><span id="l2.425"> </span>
<a href="#l2.426"></a><span id="l2.426">   _debugMessages: null,</span>
<a href="#l2.427"></a><span id="l2.427">   _omittedDebugMessages: 0,</span>
<a href="#l2.428"></a><span id="l2.428">   _debugMessagesBeforeError: null,</span>
<a href="#l2.429"></a><span id="l2.429">   _omittedDebugMessagesBeforeError: 0,</span>
<a href="#l2.430"></a><span id="l2.430">   logDebugMessage(aMessage, aLevel) {</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-    if (!this._debugMessages)</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+    if (!this._debugMessages) {</span>
<a href="#l2.433"></a><span id="l2.433">       this._debugMessages = [];</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-    if (_maxDebugMessages &amp;&amp;</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-        this._debugMessages.length &gt;= _maxDebugMessages) {</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+    }</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+    if (_maxDebugMessages &amp;&amp; this._debugMessages.length &gt;= _maxDebugMessages) {</span>
<a href="#l2.438"></a><span id="l2.438">       this._debugMessages.shift();</span>
<a href="#l2.439"></a><span id="l2.439">       ++this._omittedDebugMessages;</span>
<a href="#l2.440"></a><span id="l2.440">     }</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-    this._debugMessages.push({logLevel: aLevel, message: aMessage});</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+    this._debugMessages.push({ logLevel: aLevel, message: aMessage });</span>
<a href="#l2.443"></a><span id="l2.443">   },</span>
<a href="#l2.444"></a><span id="l2.444">   _createDebugMessage(aMessage) {</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-    let scriptError =</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-      Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(Ci.nsIScriptError);</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-    scriptError.init(aMessage, &quot;&quot;, &quot;&quot;, 0, null, Ci.nsIScriptError.warningFlag,</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-                     &quot;component javascript&quot;);</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-    return {logLevel: 0, message: scriptError};</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+    let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+      Ci.nsIScriptError</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+    );</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+    scriptError.init(</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+      aMessage,</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+      0,</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+      null,</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+      Ci.nsIScriptError.warningFlag,</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+      &quot;component javascript&quot;</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+    );</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+    return { logLevel: 0, message: scriptError };</span>
<a href="#l2.463"></a><span id="l2.463">   },</span>
<a href="#l2.464"></a><span id="l2.464">   getDebugMessages(aCount) {</span>
<a href="#l2.465"></a><span id="l2.465">     let messages = [];</span>
<a href="#l2.466"></a><span id="l2.466">     if (this._omittedDebugMessagesBeforeError) {</span>
<a href="#l2.467"></a><span id="l2.467">       let text = this._omittedDebugMessagesBeforeError + &quot; messages omitted&quot;;</span>
<a href="#l2.468"></a><span id="l2.468">       messages.push(this._createDebugMessage(text));</span>
<a href="#l2.469"></a><span id="l2.469">     }</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-    if (this._debugMessagesBeforeError)</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+    if (this._debugMessagesBeforeError) {</span>
<a href="#l2.472"></a><span id="l2.472">       messages = messages.concat(this._debugMessagesBeforeError);</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+    }</span>
<a href="#l2.474"></a><span id="l2.474">     if (this._omittedDebugMessages) {</span>
<a href="#l2.475"></a><span id="l2.475">       let text = this._omittedDebugMessages + &quot; messages omitted&quot;;</span>
<a href="#l2.476"></a><span id="l2.476">       messages.push(this._createDebugMessage(text));</span>
<a href="#l2.477"></a><span id="l2.477">     }</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-    if (this._debugMessages)</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+    if (this._debugMessages) {</span>
<a href="#l2.480"></a><span id="l2.480">       messages = messages.concat(this._debugMessages);</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+    }</span>
<a href="#l2.482"></a><span id="l2.482">     if (messages.length) {</span>
<a href="#l2.483"></a><span id="l2.483">       let appInfo = Services.appinfo;</span>
<a href="#l2.484"></a><span id="l2.484">       let header =</span>
<a href="#l2.485"></a><span id="l2.485">         `${appInfo.name} ${appInfo.version} (${appInfo.appBuildID}), ` +</span>
<a href="#l2.486"></a><span id="l2.486">         `Gecko ${appInfo.platformVersion} (${appInfo.platformBuildID}) ` +</span>
<a href="#l2.487"></a><span id="l2.487">         `on ${HttpProtocolHandler.oscpu}`;</span>
<a href="#l2.488"></a><span id="l2.488">       messages.unshift(this._createDebugMessage(header));</span>
<a href="#l2.489"></a><span id="l2.489">     }</span>
<a href="#l2.490"></a><span id="l2.490"> </span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-    if (aCount)</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+    if (aCount) {</span>
<a href="#l2.493"></a><span id="l2.493">       aCount.value = messages.length;</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+    }</span>
<a href="#l2.495"></a><span id="l2.495">     return messages;</span>
<a href="#l2.496"></a><span id="l2.496">   },</span>
<a href="#l2.497"></a><span id="l2.497"> </span>
<a href="#l2.498"></a><span id="l2.498">   _observedStatusInfo: null,</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-  get observedStatusInfo() { return this._observedStatusInfo; },</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+  get observedStatusInfo() {</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+    return this._observedStatusInfo;</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+  },</span>
<a href="#l2.503"></a><span id="l2.503">   _statusObserver: null,</span>
<a href="#l2.504"></a><span id="l2.504">   set observedStatusInfo(aUserStatusInfo) {</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-    if (!this.prplAccount)</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+    if (!this.prplAccount) {</span>
<a href="#l2.507"></a><span id="l2.507">       return;</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-    if (this._statusObserver)</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+    }</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+    if (this._statusObserver) {</span>
<a href="#l2.511"></a><span id="l2.511">       this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+    }</span>
<a href="#l2.513"></a><span id="l2.513">     this._observedStatusInfo = aUserStatusInfo;</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-    if (this._statusObserver)</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+    if (this._statusObserver) {</span>
<a href="#l2.516"></a><span id="l2.516">       this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+    }</span>
<a href="#l2.518"></a><span id="l2.518">   },</span>
<a href="#l2.519"></a><span id="l2.519">   _removeStatusObserver() {</span>
<a href="#l2.520"></a><span id="l2.520">     if (this._statusObserver) {</span>
<a href="#l2.521"></a><span id="l2.521">       this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l2.522"></a><span id="l2.522">       delete this._statusObserver;</span>
<a href="#l2.523"></a><span id="l2.523">     }</span>
<a href="#l2.524"></a><span id="l2.524">   },</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-  get statusInfo() { return this._observedStatusInfo || Services.core.globalUserStatus; },</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+  get statusInfo() {</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+    return this._observedStatusInfo || Services.core.globalUserStatus;</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+  },</span>
<a href="#l2.529"></a><span id="l2.529"> </span>
<a href="#l2.530"></a><span id="l2.530">   reconnectAttempt: 0,</span>
<a href="#l2.531"></a><span id="l2.531">   timeOfLastConnect: 0,</span>
<a href="#l2.532"></a><span id="l2.532">   timeOfNextReconnect: 0,</span>
<a href="#l2.533"></a><span id="l2.533">   _reconnectTimer: null,</span>
<a href="#l2.534"></a><span id="l2.534">   _startReconnectTimer() {</span>
<a href="#l2.535"></a><span id="l2.535">     if (Services.io.offline) {</span>
<a href="#l2.536"></a><span id="l2.536">       Cu.reportError(&quot;_startReconnectTimer called while offline&quot;);</span>
<a href="#l2.537"></a><span id="l2.537">       return;</span>
<a href="#l2.538"></a><span id="l2.538">     }</span>
<a href="#l2.539"></a><span id="l2.539"> </span>
<a href="#l2.540"></a><span id="l2.540">     /* If the last successful connection is older than 10 seconds, reset the</span>
<a href="#l2.541"></a><span id="l2.541">        number of reconnection attempts. */</span>
<a href="#l2.542"></a><span id="l2.542">     const kTimeBeforeSuccessfulConnection = 10;</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-    if (this.timeOfLastConnect &amp;&amp;</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-        this.timeOfLastConnect + kTimeBeforeSuccessfulConnection * 1000 &lt; Date.now()) {</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+    if (</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+      this.timeOfLastConnect &amp;&amp;</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+      this.timeOfLastConnect + kTimeBeforeSuccessfulConnection * 1000 &lt;</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+        Date.now()</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+    ) {</span>
<a href="#l2.550"></a><span id="l2.550">       delete this.reconnectAttempt;</span>
<a href="#l2.551"></a><span id="l2.551">       delete this.timeOfLastConnect;</span>
<a href="#l2.552"></a><span id="l2.552">     }</span>
<a href="#l2.553"></a><span id="l2.553"> </span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-    let timers =</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-      Services.prefs.getCharPref(&quot;messenger.accounts.reconnectTimer&quot;).split(&quot;,&quot;);</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+    let timers = Services.prefs</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+      .getCharPref(&quot;messenger.accounts.reconnectTimer&quot;)</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+      .split(&quot;,&quot;);</span>
<a href="#l2.559"></a><span id="l2.559">     let delay = timers[Math.min(this.reconnectAttempt, timers.length - 1)];</span>
<a href="#l2.560"></a><span id="l2.560">     let msDelay = parseInt(delay) * 1000;</span>
<a href="#l2.561"></a><span id="l2.561">     ++this.reconnectAttempt;</span>
<a href="#l2.562"></a><span id="l2.562">     this.timeOfNextReconnect = Date.now() + msDelay;</span>
<a href="#l2.563"></a><span id="l2.563">     this._reconnectTimer = setTimeout(this.connect.bind(this), msDelay);</span>
<a href="#l2.564"></a><span id="l2.564">   },</span>
<a href="#l2.565"></a><span id="l2.565"> </span>
<a href="#l2.566"></a><span id="l2.566">   _sendNotification(aTopic, aData) {</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineat">@@ -405,68 +493,77 @@ imAccount.prototype = {</span>
<a href="#l2.568"></a><span id="l2.568">   get firstConnectionState() {</span>
<a href="#l2.569"></a><span id="l2.569">     try {</span>
<a href="#l2.570"></a><span id="l2.570">       return this.prefBranch.getIntPref(kPrefAccountFirstConnectionState);</span>
<a href="#l2.571"></a><span id="l2.571">     } catch (e) {</span>
<a href="#l2.572"></a><span id="l2.572">       return Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l2.573"></a><span id="l2.573">     }</span>
<a href="#l2.574"></a><span id="l2.574">   },</span>
<a href="#l2.575"></a><span id="l2.575">   set firstConnectionState(aState) {</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-    if (aState == Ci.imIAccount.FIRST_CONNECTION_OK)</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+    if (aState == Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l2.578"></a><span id="l2.578">       this.prefBranch.deleteBranch(kPrefAccountFirstConnectionState);</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineminus">-    else {</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineplus">+    } else {</span>
<a href="#l2.581"></a><span id="l2.581">       this.prefBranch.setIntPref(kPrefAccountFirstConnectionState, aState);</span>
<a href="#l2.582"></a><span id="l2.582">       // We want to save this pref immediately when trying to connect.</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-      if (aState == Ci.imIAccount.FIRST_CONNECTION_PENDING)</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineplus">+      if (aState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l2.585"></a><span id="l2.585">         SavePrefTimer.saveNow();</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-      else</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+      } else {</span>
<a href="#l2.588"></a><span id="l2.588">         SavePrefTimer.initTimer();</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+      }</span>
<a href="#l2.590"></a><span id="l2.590">     }</span>
<a href="#l2.591"></a><span id="l2.591">   },</span>
<a href="#l2.592"></a><span id="l2.592"> </span>
<a href="#l2.593"></a><span id="l2.593">   _pendingReconnectForConnectionInfoChange: false,</span>
<a href="#l2.594"></a><span id="l2.594">   _connectionInfoChanged() {</span>
<a href="#l2.595"></a><span id="l2.595">     // The next connection will be the first connection with these parameters.</span>
<a href="#l2.596"></a><span id="l2.596">     this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l2.597"></a><span id="l2.597"> </span>
<a href="#l2.598"></a><span id="l2.598">     // We want to attempt to reconnect with the new settings only if a</span>
<a href="#l2.599"></a><span id="l2.599">     // previous attempt failed or a connection attempt is currently</span>
<a href="#l2.600"></a><span id="l2.600">     // pending (so we can return early if the account is currently</span>
<a href="#l2.601"></a><span id="l2.601">     // connected or disconnected without error).</span>
<a href="#l2.602"></a><span id="l2.602">     // The code doing the reconnection attempt is wrapped within an</span>
<a href="#l2.603"></a><span id="l2.603">     // executeSoon call so that when multiple settings are changed at</span>
<a href="#l2.604"></a><span id="l2.604">     // once we don't attempt to reconnect until they are all saved.</span>
<a href="#l2.605"></a><span id="l2.605">     // If a reconnect attempt is already scheduled, we can also return early.</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-    if (this._pendingReconnectForConnectionInfoChange || this.connected ||</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-        (this.disconnected &amp;&amp;</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-         this.connectionErrorReason == Ci.prplIAccount.NO_ERROR))</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+    if (</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineplus">+      this._pendingReconnectForConnectionInfoChange ||</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+      this.connected ||</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineplus">+      (this.disconnected &amp;&amp;</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineplus">+        this.connectionErrorReason == Ci.prplIAccount.NO_ERROR)</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+    ) {</span>
<a href="#l2.615"></a><span id="l2.615">       return;</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineplus">+    }</span>
<a href="#l2.617"></a><span id="l2.617"> </span>
<a href="#l2.618"></a><span id="l2.618">     this._pendingReconnectForConnectionInfoChange = true;</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-    executeSoon(function() {</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-      delete this._pendingReconnectForConnectionInfoChange;</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-      // If the connection parameters have changed while we were</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-      // trying to connect, cancel the ongoing connection attempt and</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-      // try again with the new parameters.</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineminus">-      if (this.connecting) {</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineminus">-        this.disconnect();</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-        this.connect();</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-        return;</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-      }</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-      // If the account was disconnected because of a non-fatal</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-      // connection error, retry now that we have new parameters.</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-      let errorReason = this.connectionErrorReason;</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-      if (this.disconnected &amp;&amp;</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+    executeSoon(</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+      function() {</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineplus">+        delete this._pendingReconnectForConnectionInfoChange;</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineplus">+        // If the connection parameters have changed while we were</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+        // trying to connect, cancel the ongoing connection attempt and</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+        // try again with the new parameters.</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineplus">+        if (this.connecting) {</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+          this.disconnect();</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineplus">+          this.connect();</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+          return;</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+        }</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+        // If the account was disconnected because of a non-fatal</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineplus">+        // connection error, retry now that we have new parameters.</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineplus">+        let errorReason = this.connectionErrorReason;</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineplus">+        if (</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineplus">+          this.disconnected &amp;&amp;</span>
<a href="#l2.649"></a><span id="l2.649">           errorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l2.650"></a><span id="l2.650">           errorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD &amp;&amp;</span>
<a href="#l2.651"></a><span id="l2.651">           errorReason != Ci.imIAccount.ERROR_CRASHED &amp;&amp;</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-          errorReason != Ci.imIAccount.ERROR_UNKNOWN_PRPL) {</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-        this.connect();</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-      }</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-    }.bind(this));</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+          errorReason != Ci.imIAccount.ERROR_UNKNOWN_PRPL</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+        ) {</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineplus">+          this.connect();</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineplus">+        }</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineplus">+      }.bind(this)</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineplus">+    );</span>
<a href="#l2.662"></a><span id="l2.662">   },</span>
<a href="#l2.663"></a><span id="l2.663"> </span>
<a href="#l2.664"></a><span id="l2.664">   // If the protocol plugin is missing, we can't access the normalizedName,</span>
<a href="#l2.665"></a><span id="l2.665">   // but in lots of cases this.name is equivalent.</span>
<a href="#l2.666"></a><span id="l2.666">   get normalizedName() {</span>
<a href="#l2.667"></a><span id="l2.667">     return this.prplAccount ? this.prplAccount.normalizedName : this.name;</span>
<a href="#l2.668"></a><span id="l2.668">   },</span>
<a href="#l2.669"></a><span id="l2.669">   normalize(aName) {</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineat">@@ -475,464 +572,574 @@ imAccount.prototype = {</span>
<a href="#l2.671"></a><span id="l2.671"> </span>
<a href="#l2.672"></a><span id="l2.672">   _sendUpdateNotification() {</span>
<a href="#l2.673"></a><span id="l2.673">     this._sendNotification(&quot;account-updated&quot;);</span>
<a href="#l2.674"></a><span id="l2.674">   },</span>
<a href="#l2.675"></a><span id="l2.675"> </span>
<a href="#l2.676"></a><span id="l2.676">   set alias(val) {</span>
<a href="#l2.677"></a><span id="l2.677">     if (val) {</span>
<a href="#l2.678"></a><span id="l2.678">       this.prefBranch.setStringPref(kPrefAccountAlias, val);</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineplus">+    } else {</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+      this.prefBranch.deleteBranch(kPrefAccountAlias);</span>
<a href="#l2.681"></a><span id="l2.681">     }</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineminus">-    else</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineminus">-      this.prefBranch.deleteBranch(kPrefAccountAlias);</span>
<a href="#l2.684"></a><span id="l2.684">     this._sendUpdateNotification();</span>
<a href="#l2.685"></a><span id="l2.685">   },</span>
<a href="#l2.686"></a><span id="l2.686">   get alias() {</span>
<a href="#l2.687"></a><span id="l2.687">     try {</span>
<a href="#l2.688"></a><span id="l2.688">       return this.prefBranch.getStringPref(kPrefAccountAlias);</span>
<a href="#l2.689"></a><span id="l2.689">     } catch (e) {</span>
<a href="#l2.690"></a><span id="l2.690">       return &quot;&quot;;</span>
<a href="#l2.691"></a><span id="l2.691">     }</span>
<a href="#l2.692"></a><span id="l2.692">   },</span>
<a href="#l2.693"></a><span id="l2.693"> </span>
<a href="#l2.694"></a><span id="l2.694">   _password: &quot;&quot;,</span>
<a href="#l2.695"></a><span id="l2.695">   get password() {</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineminus">-    if (this._password)</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineplus">+    if (this._password) {</span>
<a href="#l2.698"></a><span id="l2.698">       return this._password;</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineplus">+    }</span>
<a href="#l2.700"></a><span id="l2.700"> </span>
<a href="#l2.701"></a><span id="l2.701">     // Avoid prompting the user for the master password more than once at startup.</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineminus">-    if (gUserCanceledMasterPasswordPrompt)</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineplus">+    if (gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l2.704"></a><span id="l2.704">       return &quot;&quot;;</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+    }</span>
<a href="#l2.706"></a><span id="l2.706"> </span>
<a href="#l2.707"></a><span id="l2.707">     let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l2.708"></a><span id="l2.708">     let logins;</span>
<a href="#l2.709"></a><span id="l2.709">     try {</span>
<a href="#l2.710"></a><span id="l2.710">       logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l2.711"></a><span id="l2.711">     } catch (e) {</span>
<a href="#l2.712"></a><span id="l2.712">       this._handleMasterPasswordException(e);</span>
<a href="#l2.713"></a><span id="l2.713">       return &quot;&quot;;</span>
<a href="#l2.714"></a><span id="l2.714">     }</span>
<a href="#l2.715"></a><span id="l2.715">     let normalizedName = this.normalizedName;</span>
<a href="#l2.716"></a><span id="l2.716">     for (let login of logins) {</span>
<a href="#l2.717"></a><span id="l2.717">       if (login.username == normalizedName) {</span>
<a href="#l2.718"></a><span id="l2.718">         this._password = login.password;</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-        if (this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD) {</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineplus">+        if (</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineplus">+          this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineplus">+        ) {</span>
<a href="#l2.723"></a><span id="l2.723">           // We have found a password for an account marked as missing password,</span>
<a href="#l2.724"></a><span id="l2.724">           // re-check all others accounts missing a password. But first,</span>
<a href="#l2.725"></a><span id="l2.725">           // remove the error on our own account to avoid re-checking it.</span>
<a href="#l2.726"></a><span id="l2.726">           delete this._connectionErrorReason;</span>
<a href="#l2.727"></a><span id="l2.727">           gAccountsService._checkIfPasswordStillMissing();</span>
<a href="#l2.728"></a><span id="l2.728">         }</span>
<a href="#l2.729"></a><span id="l2.729">         return this._password;</span>
<a href="#l2.730"></a><span id="l2.730">       }</span>
<a href="#l2.731"></a><span id="l2.731">     }</span>
<a href="#l2.732"></a><span id="l2.732">     return &quot;&quot;;</span>
<a href="#l2.733"></a><span id="l2.733">   },</span>
<a href="#l2.734"></a><span id="l2.734">   _checkIfPasswordStillMissing() {</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineminus">-    if (this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineminus">-        !this.password)</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineplus">+    if (</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineplus">+      this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+      !this.password</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineplus">+    ) {</span>
<a href="#l2.741"></a><span id="l2.741">       return;</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineplus">+    }</span>
<a href="#l2.743"></a><span id="l2.743"> </span>
<a href="#l2.744"></a><span id="l2.744">     delete this._connectionErrorReason;</span>
<a href="#l2.745"></a><span id="l2.745">     this._sendUpdateNotification();</span>
<a href="#l2.746"></a><span id="l2.746">   },</span>
<a href="#l2.747"></a><span id="l2.747">   get _passwordRequired() {</span>
<a href="#l2.748"></a><span id="l2.748">     return !this.protocol.noPassword &amp;&amp; !this.protocol.passwordOptional;</span>
<a href="#l2.749"></a><span id="l2.749">   },</span>
<a href="#l2.750"></a><span id="l2.750">   set password(aPassword) {</span>
<a href="#l2.751"></a><span id="l2.751">     this._password = aPassword;</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineminus">-    if (gUserCanceledMasterPasswordPrompt)</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineplus">+    if (gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l2.754"></a><span id="l2.754">       return;</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineminus">-    let newLogin = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineminus">-                   .createInstance(Ci.nsILoginInfo);</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineplus">+    }</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineplus">+    let newLogin = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineplus">+      Ci.nsILoginInfo</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineplus">+    );</span>
<a href="#l2.761"></a><span id="l2.761">     let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineminus">-    newLogin.init(passwordURI, null, passwordURI, this.normalizedName,</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineminus">-                  aPassword, &quot;&quot;, &quot;&quot;);</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineplus">+    newLogin.init(</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineplus">+      passwordURI,</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineplus">+      null,</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineplus">+      passwordURI,</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineplus">+      this.normalizedName,</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineplus">+      aPassword,</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineplus">+      &quot;&quot;</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineplus">+    );</span>
<a href="#l2.773"></a><span id="l2.773">     try {</span>
<a href="#l2.774"></a><span id="l2.774">       let logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l2.775"></a><span id="l2.775">       let saved = false;</span>
<a href="#l2.776"></a><span id="l2.776">       for (let login of logins) {</span>
<a href="#l2.777"></a><span id="l2.777">         if (newLogin.matches(login, true)) {</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineminus">-          if (aPassword)</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineplus">+          if (aPassword) {</span>
<a href="#l2.780"></a><span id="l2.780">             Services.logins.modifyLogin(login, newLogin);</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineminus">-          else</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineplus">+          } else {</span>
<a href="#l2.783"></a><span id="l2.783">             Services.logins.removeLogin(login);</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineplus">+          }</span>
<a href="#l2.785"></a><span id="l2.785">           saved = true;</span>
<a href="#l2.786"></a><span id="l2.786">           break;</span>
<a href="#l2.787"></a><span id="l2.787">         }</span>
<a href="#l2.788"></a><span id="l2.788">       }</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-      if (!saved &amp;&amp; aPassword)</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineplus">+      if (!saved &amp;&amp; aPassword) {</span>
<a href="#l2.791"></a><span id="l2.791">         Services.logins.addLogin(newLogin);</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineplus">+      }</span>
<a href="#l2.793"></a><span id="l2.793">     } catch (e) {</span>
<a href="#l2.794"></a><span id="l2.794">       this._handleMasterPasswordException(e);</span>
<a href="#l2.795"></a><span id="l2.795">     }</span>
<a href="#l2.796"></a><span id="l2.796"> </span>
<a href="#l2.797"></a><span id="l2.797">     this._connectionInfoChanged();</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineminus">-    if (aPassword &amp;&amp;</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineminus">-        this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD)</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineplus">+    if (</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineplus">+      aPassword &amp;&amp;</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineplus">+      this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineplus">+    ) {</span>
<a href="#l2.804"></a><span id="l2.804">       this._connectionErrorReason = Ci.imIAccount.NO_ERROR;</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineminus">-    else if (!aPassword &amp;&amp; this._passwordRequired)</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineplus">+    } else if (!aPassword &amp;&amp; this._passwordRequired) {</span>
<a href="#l2.807"></a><span id="l2.807">       this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineplus">+    }</span>
<a href="#l2.809"></a><span id="l2.809">     this._sendUpdateNotification();</span>
<a href="#l2.810"></a><span id="l2.810">   },</span>
<a href="#l2.811"></a><span id="l2.811">   _handleMasterPasswordException(aException) {</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineminus">-    if (aException.result != Cr.NS_ERROR_ABORT)</span>
<a href="#l2.813"></a><span id="l2.813" class="difflineplus">+    if (aException.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l2.814"></a><span id="l2.814">       throw aException;</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineplus">+    }</span>
<a href="#l2.816"></a><span id="l2.816"> </span>
<a href="#l2.817"></a><span id="l2.817">     gUserCanceledMasterPasswordPrompt = true;</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineminus">-    executeSoon(function() { gUserCanceledMasterPasswordPrompt = false; });</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineplus">+    executeSoon(function() {</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineplus">+      gUserCanceledMasterPasswordPrompt = false;</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineplus">+    });</span>
<a href="#l2.822"></a><span id="l2.822">   },</span>
<a href="#l2.823"></a><span id="l2.823"> </span>
<a href="#l2.824"></a><span id="l2.824">   get autoLogin() {</span>
<a href="#l2.825"></a><span id="l2.825">     return this.prefBranch.getBoolPref(kPrefAccountAutoLogin, true);</span>
<a href="#l2.826"></a><span id="l2.826">   },</span>
<a href="#l2.827"></a><span id="l2.827">   set autoLogin(val) {</span>
<a href="#l2.828"></a><span id="l2.828">     this.prefBranch.setBoolPref(kPrefAccountAutoLogin, val);</span>
<a href="#l2.829"></a><span id="l2.829">     SavePrefTimer.initTimer();</span>
<a href="#l2.830"></a><span id="l2.830">     this._sendUpdateNotification();</span>
<a href="#l2.831"></a><span id="l2.831">   },</span>
<a href="#l2.832"></a><span id="l2.832">   _autoLoginPending: false,</span>
<a href="#l2.833"></a><span id="l2.833">   checkAutoLogin() {</span>
<a href="#l2.834"></a><span id="l2.834">     // No auto-login if: the account has an error at the imIAccount level</span>
<a href="#l2.835"></a><span id="l2.835">     // (unknown protocol, missing password, first connection crashed),</span>
<a href="#l2.836"></a><span id="l2.836">     // the account is already connected or connecting, or autoLogin is off.</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineminus">-    if (this._connectionErrorReason != Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l2.838"></a><span id="l2.838" class="difflineminus">-        this.connecting || this.connected || !this.autoLogin)</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineplus">+    if (</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineplus">+      this._connectionErrorReason != Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineplus">+      this.connecting ||</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineplus">+      this.connected ||</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineplus">+      !this.autoLogin</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineplus">+    ) {</span>
<a href="#l2.845"></a><span id="l2.845">       return;</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineplus">+    }</span>
<a href="#l2.847"></a><span id="l2.847"> </span>
<a href="#l2.848"></a><span id="l2.848">     this._autoLoginPending = true;</span>
<a href="#l2.849"></a><span id="l2.849">     AutoLoginCounter.startAutoLogin();</span>
<a href="#l2.850"></a><span id="l2.850">     try {</span>
<a href="#l2.851"></a><span id="l2.851">       this.connect();</span>
<a href="#l2.852"></a><span id="l2.852">     } catch (e) {</span>
<a href="#l2.853"></a><span id="l2.853">       Cu.reportError(e);</span>
<a href="#l2.854"></a><span id="l2.854">       this._finishedAutoLogin();</span>
<a href="#l2.855"></a><span id="l2.855">     }</span>
<a href="#l2.856"></a><span id="l2.856">   },</span>
<a href="#l2.857"></a><span id="l2.857">   _finishedAutoLogin() {</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_autoLoginPending&quot;))</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineplus">+    if (!this.hasOwnProperty(&quot;_autoLoginPending&quot;)) {</span>
<a href="#l2.860"></a><span id="l2.860">       return;</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineplus">+    }</span>
<a href="#l2.862"></a><span id="l2.862">     delete this._autoLoginPending;</span>
<a href="#l2.863"></a><span id="l2.863">     AutoLoginCounter.finishedAutoLogin();</span>
<a href="#l2.864"></a><span id="l2.864">   },</span>
<a href="#l2.865"></a><span id="l2.865"> </span>
<a href="#l2.866"></a><span id="l2.866">   // Delete the account (from the preferences, mozStorage, and call unInit).</span>
<a href="#l2.867"></a><span id="l2.867">   remove() {</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineminus">-    let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l2.869"></a><span id="l2.869" class="difflineminus">-                .createInstance(Ci.nsILoginInfo);</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineplus">+    let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineplus">+      Ci.nsILoginInfo</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineplus">+    );</span>
<a href="#l2.873"></a><span id="l2.873">     let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l2.874"></a><span id="l2.874">     // Note: the normalizedName may not be exactly right if the</span>
<a href="#l2.875"></a><span id="l2.875">     // protocol plugin is missing.</span>
<a href="#l2.876"></a><span id="l2.876">     login.init(passwordURI, null, passwordURI, this.normalizedName, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l2.877"></a><span id="l2.877">     let logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l2.878"></a><span id="l2.878">     for (let l of logins) {</span>
<a href="#l2.879"></a><span id="l2.879">       if (login.matches(l, true)) {</span>
<a href="#l2.880"></a><span id="l2.880">         Services.logins.removeLogin(l);</span>
<a href="#l2.881"></a><span id="l2.881">         break;</span>
<a href="#l2.882"></a><span id="l2.882">       }</span>
<a href="#l2.883"></a><span id="l2.883">     }</span>
<a href="#l2.884"></a><span id="l2.884" class="difflineminus">-    if (this.connected || this.connecting)</span>
<a href="#l2.885"></a><span id="l2.885" class="difflineplus">+    if (this.connected || this.connecting) {</span>
<a href="#l2.886"></a><span id="l2.886">       this.disconnect();</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineminus">-    if (this.prplAccount)</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineplus">+    }</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l2.890"></a><span id="l2.890">       this.prplAccount.remove();</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineplus">+    }</span>
<a href="#l2.892"></a><span id="l2.892">     this.unInit();</span>
<a href="#l2.893"></a><span id="l2.893">     Services.contacts.forgetAccount(this.numericId);</span>
<a href="#l2.894"></a><span id="l2.894">     this.prefBranch.deleteBranch(&quot;&quot;);</span>
<a href="#l2.895"></a><span id="l2.895">   },</span>
<a href="#l2.896"></a><span id="l2.896">   unInit() {</span>
<a href="#l2.897"></a><span id="l2.897">     // remove any pending reconnection timer.</span>
<a href="#l2.898"></a><span id="l2.898">     this._cancelReconnection();</span>
<a href="#l2.899"></a><span id="l2.899"> </span>
<a href="#l2.900"></a><span id="l2.900">     // Keeping a status observer could cause an immediate reconnection.</span>
<a href="#l2.901"></a><span id="l2.901">     this._removeStatusObserver();</span>
<a href="#l2.902"></a><span id="l2.902"> </span>
<a href="#l2.903"></a><span id="l2.903">     // remove any pending autologin preference used for crash detection.</span>
<a href="#l2.904"></a><span id="l2.904">     this._finishedAutoLogin();</span>
<a href="#l2.905"></a><span id="l2.905"> </span>
<a href="#l2.906"></a><span id="l2.906">     // If the first connection was pending on quit, we set it back to unknown.</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineminus">-    if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING)</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineplus">+    if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l2.909"></a><span id="l2.909">       this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineplus">+    }</span>
<a href="#l2.911"></a><span id="l2.911"> </span>
<a href="#l2.912"></a><span id="l2.912">     // and make sure we cleanup the save pref timer.</span>
<a href="#l2.913"></a><span id="l2.913">     SavePrefTimer.unInitTimer();</span>
<a href="#l2.914"></a><span id="l2.914"> </span>
<a href="#l2.915"></a><span id="l2.915" class="difflineminus">-    if (this.prplAccount)</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l2.917"></a><span id="l2.917">       this.prplAccount.unInit();</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineplus">+    }</span>
<a href="#l2.919"></a><span id="l2.919"> </span>
<a href="#l2.920"></a><span id="l2.920">     delete this.protocol;</span>
<a href="#l2.921"></a><span id="l2.921">     delete this.prplAccount;</span>
<a href="#l2.922"></a><span id="l2.922">   },</span>
<a href="#l2.923"></a><span id="l2.923"> </span>
<a href="#l2.924"></a><span id="l2.924">   get _ensurePrplAccount() {</span>
<a href="#l2.925"></a><span id="l2.925" class="difflineminus">-    if (this.prplAccount)</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l2.927"></a><span id="l2.927">       return this.prplAccount;</span>
<a href="#l2.928"></a><span id="l2.928" class="difflineplus">+    }</span>
<a href="#l2.929"></a><span id="l2.929">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.930"></a><span id="l2.930">   },</span>
<a href="#l2.931"></a><span id="l2.931">   connect() {</span>
<a href="#l2.932"></a><span id="l2.932" class="difflineminus">-    if (!this.prplAccount)</span>
<a href="#l2.933"></a><span id="l2.933" class="difflineplus">+    if (!this.prplAccount) {</span>
<a href="#l2.934"></a><span id="l2.934">       throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineplus">+    }</span>
<a href="#l2.936"></a><span id="l2.936"> </span>
<a href="#l2.937"></a><span id="l2.937">     if (this._passwordRequired) {</span>
<a href="#l2.938"></a><span id="l2.938">       // If the previous connection attempt failed because we have a wrong password,</span>
<a href="#l2.939"></a><span id="l2.939">       // clear the passwor cache so that if there's no password in the password</span>
<a href="#l2.940"></a><span id="l2.940">       // manager the user gets prompted again.</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineminus">-      if (this.connectionErrorReason == Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED)</span>
<a href="#l2.942"></a><span id="l2.942" class="difflineplus">+      if (</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineplus">+        this.connectionErrorReason ==</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineplus">+        Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineplus">+      ) {</span>
<a href="#l2.946"></a><span id="l2.946">         delete this._password;</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineplus">+      }</span>
<a href="#l2.948"></a><span id="l2.948"> </span>
<a href="#l2.949"></a><span id="l2.949">       let password = this.password;</span>
<a href="#l2.950"></a><span id="l2.950">       if (!password) {</span>
<a href="#l2.951"></a><span id="l2.951">         let prompts = Services.prompt;</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineminus">-        let shouldSave = {value: false};</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineminus">-        password = {value: &quot;&quot;};</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineminus">-        if (!prompts.promptPassword(null, _(&quot;passwordPromptTitle&quot;, this.name),</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineminus">-                                    _(&quot;passwordPromptText&quot;, this.name),</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineminus">-                                    password, _(&quot;passwordPromptSaveCheckbox&quot;),</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineminus">-                                    shouldSave))</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineplus">+        let shouldSave = { value: false };</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineplus">+        password = { value: &quot;&quot; };</span>
<a href="#l2.960"></a><span id="l2.960" class="difflineplus">+        if (</span>
<a href="#l2.961"></a><span id="l2.961" class="difflineplus">+          !prompts.promptPassword(</span>
<a href="#l2.962"></a><span id="l2.962" class="difflineplus">+            null,</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineplus">+            _(&quot;passwordPromptTitle&quot;, this.name),</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineplus">+            _(&quot;passwordPromptText&quot;, this.name),</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineplus">+            password,</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineplus">+            _(&quot;passwordPromptSaveCheckbox&quot;),</span>
<a href="#l2.967"></a><span id="l2.967" class="difflineplus">+            shouldSave</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineplus">+          )</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineplus">+        ) {</span>
<a href="#l2.970"></a><span id="l2.970">           return;</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineplus">+        }</span>
<a href="#l2.972"></a><span id="l2.972"> </span>
<a href="#l2.973"></a><span id="l2.973" class="difflineminus">-        if (shouldSave.value)</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineplus">+        if (shouldSave.value) {</span>
<a href="#l2.975"></a><span id="l2.975">           this.password = password.value;</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineminus">-        else</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineplus">+        } else {</span>
<a href="#l2.978"></a><span id="l2.978">           this._password = password.value;</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineplus">+        }</span>
<a href="#l2.980"></a><span id="l2.980">       }</span>
<a href="#l2.981"></a><span id="l2.981">     }</span>
<a href="#l2.982"></a><span id="l2.982"> </span>
<a href="#l2.983"></a><span id="l2.983">     if (!this._statusObserver) {</span>
<a href="#l2.984"></a><span id="l2.984">       this._statusObserver = {</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineminus">-        observe: (function(aSubject, aTopic, aData) {</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineplus">+        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l2.987"></a><span id="l2.987">           // Disconnect or reconnect the account automatically, otherwise notify</span>
<a href="#l2.988"></a><span id="l2.988">           // the prplAccount instance.</span>
<a href="#l2.989"></a><span id="l2.989">           let statusType = aSubject.statusType;</span>
<a href="#l2.990"></a><span id="l2.990">           let connectionErrorReason = this.connectionErrorReason;</span>
<a href="#l2.991"></a><span id="l2.991">           if (statusType == Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineminus">-            if (this.connected || this.connecting)</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineplus">+            if (this.connected || this.connecting) {</span>
<a href="#l2.994"></a><span id="l2.994">               this.prplAccount.disconnect();</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineplus">+            }</span>
<a href="#l2.996"></a><span id="l2.996">             this._cancelReconnection();</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineplus">+          } else if (</span>
<a href="#l2.998"></a><span id="l2.998" class="difflineplus">+            statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineplus">+            this.disconnected &amp;&amp;</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineplus">+            (connectionErrorReason == Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineplus">+              connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineplus">+              connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR)</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineplus">+          ) {</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineplus">+            this.prplAccount.connect();</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineplus">+          } else if (this.connected) {</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineplus">+            this.prplAccount.observe(aSubject, aTopic, aData);</span>
<a href="#l2.1007"></a><span id="l2.1007">           }</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineminus">-          else if (statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineminus">-                   this.disconnected &amp;&amp;</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineminus">-                   (connectionErrorReason == Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineminus">-                    connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineminus">-                    connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR))</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineminus">-            this.prplAccount.connect();</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineminus">-          else if (this.connected)</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineminus">-            this.prplAccount.observe(aSubject, aTopic, aData);</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineminus">-        }).bind(this),</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineplus">+        }.bind(this),</span>
<a href="#l2.1018"></a><span id="l2.1018">       };</span>
<a href="#l2.1019"></a><span id="l2.1019"> </span>
<a href="#l2.1020"></a><span id="l2.1020">       this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l2.1021"></a><span id="l2.1021">     }</span>
<a href="#l2.1022"></a><span id="l2.1022"> </span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineminus">-    if (!Services.io.offline &amp;&amp;</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-        this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineminus">-        this.disconnected)</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineplus">+    if (</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineplus">+      !Services.io.offline &amp;&amp;</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineplus">+      this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineplus">+      this.disconnected</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineplus">+    ) {</span>
<a href="#l2.1031"></a><span id="l2.1031">       this.prplAccount.connect();</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineplus">+    }</span>
<a href="#l2.1033"></a><span id="l2.1033">   },</span>
<a href="#l2.1034"></a><span id="l2.1034">   disconnect() {</span>
<a href="#l2.1035"></a><span id="l2.1035">     this._removeStatusObserver();</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineminus">-    if (!this.disconnected)</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineplus">+    if (!this.disconnected) {</span>
<a href="#l2.1038"></a><span id="l2.1038">       this._ensurePrplAccount.disconnect();</span>
<a href="#l2.1039"></a><span id="l2.1039" class="difflineplus">+    }</span>
<a href="#l2.1040"></a><span id="l2.1040">   },</span>
<a href="#l2.1041"></a><span id="l2.1041"> </span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineminus">-  get disconnected() { return this.connectionState == Ci.imIAccount.STATE_DISCONNECTED; },</span>
<a href="#l2.1043"></a><span id="l2.1043" class="difflineminus">-  get connected() { return this.connectionState == Ci.imIAccount.STATE_CONNECTED; },</span>
<a href="#l2.1044"></a><span id="l2.1044" class="difflineminus">-  get connecting() { return this.connectionState == Ci.imIAccount.STATE_CONNECTING; },</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineminus">-  get disconnecting() { return this.connectionState == Ci.imIAccount.STATE_DISCONNECTING; },</span>
<a href="#l2.1046"></a><span id="l2.1046" class="difflineplus">+  get disconnected() {</span>
<a href="#l2.1047"></a><span id="l2.1047" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_DISCONNECTED;</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineplus">+  },</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineplus">+  get connected() {</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_CONNECTED;</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineplus">+  },</span>
<a href="#l2.1052"></a><span id="l2.1052" class="difflineplus">+  get connecting() {</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_CONNECTING;</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineplus">+  },</span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineplus">+  get disconnecting() {</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineplus">+  },</span>
<a href="#l2.1058"></a><span id="l2.1058"> </span>
<a href="#l2.1059"></a><span id="l2.1059">   _cancelReconnection() {</span>
<a href="#l2.1060"></a><span id="l2.1060">     if (this._reconnectTimer) {</span>
<a href="#l2.1061"></a><span id="l2.1061">       clearTimeout(this._reconnectTimer);</span>
<a href="#l2.1062"></a><span id="l2.1062">       delete this._reconnectTimer;</span>
<a href="#l2.1063"></a><span id="l2.1063">     }</span>
<a href="#l2.1064"></a><span id="l2.1064">     delete this.reconnectAttempt;</span>
<a href="#l2.1065"></a><span id="l2.1065">     delete this.timeOfNextReconnect;</span>
<a href="#l2.1066"></a><span id="l2.1066">   },</span>
<a href="#l2.1067"></a><span id="l2.1067">   cancelReconnection() {</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineminus">-    if (!this.disconnected)</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineplus">+    if (!this.disconnected) {</span>
<a href="#l2.1070"></a><span id="l2.1070">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineplus">+    }</span>
<a href="#l2.1072"></a><span id="l2.1072"> </span>
<a href="#l2.1073"></a><span id="l2.1073">     // Ensure we don't keep a status observer that could re-enable the</span>
<a href="#l2.1074"></a><span id="l2.1074">     // auto-reconnect timers.</span>
<a href="#l2.1075"></a><span id="l2.1075">     this.disconnect();</span>
<a href="#l2.1076"></a><span id="l2.1076"> </span>
<a href="#l2.1077"></a><span id="l2.1077">     this._cancelReconnection();</span>
<a href="#l2.1078"></a><span id="l2.1078">   },</span>
<a href="#l2.1079"></a><span id="l2.1079">   createConversation(aName) {</span>
<a href="#l2.1080"></a><span id="l2.1080">     return this._ensurePrplAccount.createConversation(aName);</span>
<a href="#l2.1081"></a><span id="l2.1081">   },</span>
<a href="#l2.1082"></a><span id="l2.1082">   addBuddy(aTag, aName) {</span>
<a href="#l2.1083"></a><span id="l2.1083">     this._ensurePrplAccount.addBuddy(aTag, aName);</span>
<a href="#l2.1084"></a><span id="l2.1084">   },</span>
<a href="#l2.1085"></a><span id="l2.1085">   loadBuddy(aBuddy, aTag) {</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineminus">-    if (this.prplAccount)</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l2.1088"></a><span id="l2.1088">       return this.prplAccount.loadBuddy(aBuddy, aTag);</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineplus">+    }</span>
<a href="#l2.1090"></a><span id="l2.1090">     // Generate dummy account buddies for unknown protocols.</span>
<a href="#l2.1091"></a><span id="l2.1091">     return new UnknownAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l2.1092"></a><span id="l2.1092">   },</span>
<a href="#l2.1093"></a><span id="l2.1093">   requestBuddyInfo(aBuddyName) {</span>
<a href="#l2.1094"></a><span id="l2.1094">     this._ensurePrplAccount.requestBuddyInfo(aBuddyName);</span>
<a href="#l2.1095"></a><span id="l2.1095">   },</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineminus">-  getChatRoomFields() { return this._ensurePrplAccount.getChatRoomFields(); },</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineplus">+  getChatRoomFields() {</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineplus">+    return this._ensurePrplAccount.getChatRoomFields();</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineplus">+  },</span>
<a href="#l2.1100"></a><span id="l2.1100">   getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineminus">-    return this._ensurePrplAccount.getChatRoomDefaultFieldValues(aDefaultChatName);</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineplus">+    return this._ensurePrplAccount.getChatRoomDefaultFieldValues(</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineplus">+      aDefaultChatName</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineplus">+    );</span>
<a href="#l2.1105"></a><span id="l2.1105">   },</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineminus">-  get canJoinChat() { return this.prplAccount ? this.prplAccount.canJoinChat : false; },</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineplus">+    return this.prplAccount ? this.prplAccount.canJoinChat : false;</span>
<a href="#l2.1109"></a><span id="l2.1109" class="difflineplus">+  },</span>
<a href="#l2.1110"></a><span id="l2.1110">   joinChat(aComponents) {</span>
<a href="#l2.1111"></a><span id="l2.1111">     this._ensurePrplAccount.joinChat(aComponents);</span>
<a href="#l2.1112"></a><span id="l2.1112">   },</span>
<a href="#l2.1113"></a><span id="l2.1113">   setBool(aName, aVal) {</span>
<a href="#l2.1114"></a><span id="l2.1114">     this.prefBranch.setBoolPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l2.1115"></a><span id="l2.1115">     this._connectionInfoChanged();</span>
<a href="#l2.1116"></a><span id="l2.1116" class="difflineminus">-    if (this.prplAccount)</span>
<a href="#l2.1117"></a><span id="l2.1117" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l2.1118"></a><span id="l2.1118">       this.prplAccount.setBool(aName, aVal);</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineplus">+    }</span>
<a href="#l2.1120"></a><span id="l2.1120">     SavePrefTimer.initTimer();</span>
<a href="#l2.1121"></a><span id="l2.1121">   },</span>
<a href="#l2.1122"></a><span id="l2.1122">   setInt(aName, aVal) {</span>
<a href="#l2.1123"></a><span id="l2.1123">     this.prefBranch.setIntPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l2.1124"></a><span id="l2.1124">     this._connectionInfoChanged();</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineminus">-    if (this.prplAccount)</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l2.1127"></a><span id="l2.1127">       this.prplAccount.setInt(aName, aVal);</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineplus">+    }</span>
<a href="#l2.1129"></a><span id="l2.1129">     SavePrefTimer.initTimer();</span>
<a href="#l2.1130"></a><span id="l2.1130">   },</span>
<a href="#l2.1131"></a><span id="l2.1131">   setString(aName, aVal) {</span>
<a href="#l2.1132"></a><span id="l2.1132">     this.prefBranch.setStringPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l2.1133"></a><span id="l2.1133">     this._connectionInfoChanged();</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineminus">-    if (this.prplAccount)</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l2.1136"></a><span id="l2.1136">       this.prplAccount.setString(aName, aVal);</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineplus">+    }</span>
<a href="#l2.1138"></a><span id="l2.1138">     SavePrefTimer.initTimer();</span>
<a href="#l2.1139"></a><span id="l2.1139">   },</span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineminus">-  save() { SavePrefTimer.saveNow(); },</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineplus">+  save() {</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineplus">+    SavePrefTimer.saveNow();</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+  },</span>
<a href="#l2.1144"></a><span id="l2.1144"> </span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineminus">-  get HTMLEnabled() { return this._ensurePrplAccount.HTMLEnabled; },</span>
<a href="#l2.1146"></a><span id="l2.1146" class="difflineminus">-  get HTMLEscapePlainText() { return this._ensurePrplAccount.HTMLEscapePlainText; },</span>
<a href="#l2.1147"></a><span id="l2.1147" class="difflineminus">-  get noBackgroundColors() { return this._ensurePrplAccount.noBackgroundColors; },</span>
<a href="#l2.1148"></a><span id="l2.1148" class="difflineminus">-  get autoResponses() { return this._ensurePrplAccount.autoResponses; },</span>
<a href="#l2.1149"></a><span id="l2.1149" class="difflineminus">-  get singleFormatting() { return this._ensurePrplAccount.singleFormatting; },</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineminus">-  get noFontSizes() { return this._ensurePrplAccount.noFontSizes; },</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineminus">-  get noUrlDesc() { return this._ensurePrplAccount.noUrlDesc; },</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineminus">-  get noImages() { return this._ensurePrplAccount.noImages; },</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineplus">+  get HTMLEnabled() {</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineplus">+    return this._ensurePrplAccount.HTMLEnabled;</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineplus">+  },</span>
<a href="#l2.1156"></a><span id="l2.1156" class="difflineplus">+  get HTMLEscapePlainText() {</span>
<a href="#l2.1157"></a><span id="l2.1157" class="difflineplus">+    return this._ensurePrplAccount.HTMLEscapePlainText;</span>
<a href="#l2.1158"></a><span id="l2.1158" class="difflineplus">+  },</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineplus">+  get noBackgroundColors() {</span>
<a href="#l2.1160"></a><span id="l2.1160" class="difflineplus">+    return this._ensurePrplAccount.noBackgroundColors;</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineplus">+  },</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineplus">+  get autoResponses() {</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineplus">+    return this._ensurePrplAccount.autoResponses;</span>
<a href="#l2.1164"></a><span id="l2.1164" class="difflineplus">+  },</span>
<a href="#l2.1165"></a><span id="l2.1165" class="difflineplus">+  get singleFormatting() {</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineplus">+    return this._ensurePrplAccount.singleFormatting;</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineplus">+  },</span>
<a href="#l2.1168"></a><span id="l2.1168" class="difflineplus">+  get noFontSizes() {</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineplus">+    return this._ensurePrplAccount.noFontSizes;</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineplus">+  },</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineplus">+  get noUrlDesc() {</span>
<a href="#l2.1172"></a><span id="l2.1172" class="difflineplus">+    return this._ensurePrplAccount.noUrlDesc;</span>
<a href="#l2.1173"></a><span id="l2.1173" class="difflineplus">+  },</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineplus">+  get noImages() {</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineplus">+    return this._ensurePrplAccount.noImages;</span>
<a href="#l2.1176"></a><span id="l2.1176" class="difflineplus">+  },</span>
<a href="#l2.1177"></a><span id="l2.1177"> };</span>
<a href="#l2.1178"></a><span id="l2.1178"> </span>
<a href="#l2.1179"></a><span id="l2.1179"> var gAccountsService = null;</span>
<a href="#l2.1180"></a><span id="l2.1180"> </span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineminus">-function AccountsService() { }</span>
<a href="#l2.1182"></a><span id="l2.1182" class="difflineplus">+function AccountsService() {}</span>
<a href="#l2.1183"></a><span id="l2.1183"> AccountsService.prototype = {</span>
<a href="#l2.1184"></a><span id="l2.1184">   initAccounts() {</span>
<a href="#l2.1185"></a><span id="l2.1185">     this._initAutoLoginStatus();</span>
<a href="#l2.1186"></a><span id="l2.1186">     this._accounts = [];</span>
<a href="#l2.1187"></a><span id="l2.1187">     this._accountsById = {};</span>
<a href="#l2.1188"></a><span id="l2.1188">     gAccountsService = this;</span>
<a href="#l2.1189"></a><span id="l2.1189" class="difflineminus">-    gConvertingOldPasswords =</span>
<a href="#l2.1190"></a><span id="l2.1190" class="difflineminus">-      Services.prefs.getBoolPref(kPrefConvertOldPasswords);</span>
<a href="#l2.1191"></a><span id="l2.1191" class="difflineplus">+    gConvertingOldPasswords = Services.prefs.getBoolPref(</span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineplus">+      kPrefConvertOldPasswords</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineplus">+    );</span>
<a href="#l2.1194"></a><span id="l2.1194">     let accountList = this._accountList;</span>
<a href="#l2.1195"></a><span id="l2.1195" class="difflineminus">-    for (let account of (accountList ? accountList.split(&quot;,&quot;) : [])) {</span>
<a href="#l2.1196"></a><span id="l2.1196" class="difflineplus">+    for (let account of accountList ? accountList.split(&quot;,&quot;) : []) {</span>
<a href="#l2.1197"></a><span id="l2.1197">       try {</span>
<a href="#l2.1198"></a><span id="l2.1198">         account.trim();</span>
<a href="#l2.1199"></a><span id="l2.1199" class="difflineminus">-        if (!account)</span>
<a href="#l2.1200"></a><span id="l2.1200" class="difflineplus">+        if (!account) {</span>
<a href="#l2.1201"></a><span id="l2.1201">           throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.1202"></a><span id="l2.1202" class="difflineplus">+        }</span>
<a href="#l2.1203"></a><span id="l2.1203">         new imAccount(account);</span>
<a href="#l2.1204"></a><span id="l2.1204">       } catch (e) {</span>
<a href="#l2.1205"></a><span id="l2.1205">         Cu.reportError(e);</span>
<a href="#l2.1206"></a><span id="l2.1206">         dump(e + &quot; &quot; + e.toSource() + &quot;\n&quot;);</span>
<a href="#l2.1207"></a><span id="l2.1207">       }</span>
<a href="#l2.1208"></a><span id="l2.1208">     }</span>
<a href="#l2.1209"></a><span id="l2.1209">     // If the user has canceled a master password prompt, we haven't</span>
<a href="#l2.1210"></a><span id="l2.1210">     // been able to save any password, so the old password conversion</span>
<a href="#l2.1211"></a><span id="l2.1211">     // still needs to happen.</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineminus">-    if (gConvertingOldPasswords &amp;&amp; !gUserCanceledMasterPasswordPrompt)</span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineplus">+    if (gConvertingOldPasswords &amp;&amp; !gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l2.1214"></a><span id="l2.1214">       Services.prefs.setBoolPref(kPrefConvertOldPasswords, false);</span>
<a href="#l2.1215"></a><span id="l2.1215" class="difflineplus">+    }</span>
<a href="#l2.1216"></a><span id="l2.1216"> </span>
<a href="#l2.1217"></a><span id="l2.1217">     this._prefObserver = this.observe.bind(this);</span>
<a href="#l2.1218"></a><span id="l2.1218">     Services.prefs.addObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l2.1219"></a><span id="l2.1219">   },</span>
<a href="#l2.1220"></a><span id="l2.1220"> </span>
<a href="#l2.1221"></a><span id="l2.1221">   _observingAccountListChange: true,</span>
<a href="#l2.1222"></a><span id="l2.1222">   _prefObserver: null,</span>
<a href="#l2.1223"></a><span id="l2.1223">   observe(aSubject, aTopic, aData) {</span>
<a href="#l2.1224"></a><span id="l2.1224" class="difflineminus">-    if (aTopic != &quot;nsPref:changed&quot; || aData != kPrefMessengerAccounts ||</span>
<a href="#l2.1225"></a><span id="l2.1225" class="difflineminus">-       !this._observingAccountListChange)</span>
<a href="#l2.1226"></a><span id="l2.1226" class="difflineplus">+    if (</span>
<a href="#l2.1227"></a><span id="l2.1227" class="difflineplus">+      aTopic != &quot;nsPref:changed&quot; ||</span>
<a href="#l2.1228"></a><span id="l2.1228" class="difflineplus">+      aData != kPrefMessengerAccounts ||</span>
<a href="#l2.1229"></a><span id="l2.1229" class="difflineplus">+      !this._observingAccountListChange</span>
<a href="#l2.1230"></a><span id="l2.1230" class="difflineplus">+    ) {</span>
<a href="#l2.1231"></a><span id="l2.1231">       return;</span>
<a href="#l2.1232"></a><span id="l2.1232" class="difflineplus">+    }</span>
<a href="#l2.1233"></a><span id="l2.1233"> </span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineminus">-    this._accounts =</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineminus">-      this._accountList.split(&quot;,&quot;).map(account =&gt; account.trim())</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineminus">-          .filter(k =&gt; k.startsWith(kAccountKeyPrefix))</span>
<a href="#l2.1237"></a><span id="l2.1237" class="difflineminus">-          .map(k =&gt; parseInt(k.substr(kAccountKeyPrefix.length)))</span>
<a href="#l2.1238"></a><span id="l2.1238" class="difflineminus">-          .map(this.getAccountByNumericId, this)</span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineminus">-          .filter(a =&gt; a);</span>
<a href="#l2.1240"></a><span id="l2.1240" class="difflineplus">+    this._accounts = this._accountList</span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineplus">+      .split(&quot;,&quot;)</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineplus">+      .map(account =&gt; account.trim())</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineplus">+      .filter(k =&gt; k.startsWith(kAccountKeyPrefix))</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineplus">+      .map(k =&gt; parseInt(k.substr(kAccountKeyPrefix.length)))</span>
<a href="#l2.1245"></a><span id="l2.1245" class="difflineplus">+      .map(this.getAccountByNumericId, this)</span>
<a href="#l2.1246"></a><span id="l2.1246" class="difflineplus">+      .filter(a =&gt; a);</span>
<a href="#l2.1247"></a><span id="l2.1247"> </span>
<a href="#l2.1248"></a><span id="l2.1248">     Services.obs.notifyObservers(this, &quot;account-list-updated&quot;);</span>
<a href="#l2.1249"></a><span id="l2.1249">   },</span>
<a href="#l2.1250"></a><span id="l2.1250"> </span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineminus">-  get _accountList() { return Services.prefs.getCharPref(kPrefMessengerAccounts); },</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineplus">+  get _accountList() {</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineplus">+    return Services.prefs.getCharPref(kPrefMessengerAccounts);</span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineplus">+  },</span>
<a href="#l2.1255"></a><span id="l2.1255">   set _accountList(aNewList) {</span>
<a href="#l2.1256"></a><span id="l2.1256">     this._observingAccountListChange = false;</span>
<a href="#l2.1257"></a><span id="l2.1257">     Services.prefs.setCharPref(kPrefMessengerAccounts, aNewList);</span>
<a href="#l2.1258"></a><span id="l2.1258">     delete this._observingAccountListChange;</span>
<a href="#l2.1259"></a><span id="l2.1259">   },</span>
<a href="#l2.1260"></a><span id="l2.1260"> </span>
<a href="#l2.1261"></a><span id="l2.1261">   unInitAccounts() {</span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineminus">-    for (let account of this._accounts)</span>
<a href="#l2.1263"></a><span id="l2.1263" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l2.1264"></a><span id="l2.1264">       account.unInit();</span>
<a href="#l2.1265"></a><span id="l2.1265" class="difflineplus">+    }</span>
<a href="#l2.1266"></a><span id="l2.1266">     gAccountsService = null;</span>
<a href="#l2.1267"></a><span id="l2.1267">     delete this._accounts;</span>
<a href="#l2.1268"></a><span id="l2.1268">     delete this._accountsById;</span>
<a href="#l2.1269"></a><span id="l2.1269">     Services.prefs.removeObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l2.1270"></a><span id="l2.1270">     delete this._prefObserver;</span>
<a href="#l2.1271"></a><span id="l2.1271">   },</span>
<a href="#l2.1272"></a><span id="l2.1272"> </span>
<a href="#l2.1273"></a><span id="l2.1273">   autoLoginStatus: Ci.imIAccountsService.AUTOLOGIN_ENABLED,</span>
<a href="#l2.1274"></a><span id="l2.1274">   _initAutoLoginStatus() {</span>
<a href="#l2.1275"></a><span id="l2.1275">     /* If auto-login is already disabled, do nothing */</span>
<a href="#l2.1276"></a><span id="l2.1276" class="difflineminus">-    if (this.autoLoginStatus != Ci.imIAccountsService.AUTOLOGIN_ENABLED)</span>
<a href="#l2.1277"></a><span id="l2.1277" class="difflineplus">+    if (this.autoLoginStatus != Ci.imIAccountsService.AUTOLOGIN_ENABLED) {</span>
<a href="#l2.1278"></a><span id="l2.1278">       return;</span>
<a href="#l2.1279"></a><span id="l2.1279" class="difflineplus">+    }</span>
<a href="#l2.1280"></a><span id="l2.1280"> </span>
<a href="#l2.1281"></a><span id="l2.1281">     let prefs = Services.prefs;</span>
<a href="#l2.1282"></a><span id="l2.1282">     if (!prefs.getIntPref(&quot;messenger.startup.action&quot;)) {</span>
<a href="#l2.1283"></a><span id="l2.1283">       // the value 0 means that we start without connecting the accounts</span>
<a href="#l2.1284"></a><span id="l2.1284">       this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_USER_DISABLED;</span>
<a href="#l2.1285"></a><span id="l2.1285">       return;</span>
<a href="#l2.1286"></a><span id="l2.1286">     }</span>
<a href="#l2.1287"></a><span id="l2.1287"> </span>
<a href="#l2.1288"></a><span id="l2.1288">     /* Disable auto-login if we are running in safe mode */</span>
<a href="#l2.1289"></a><span id="l2.1289">     if (Services.appinfo.inSafeMode) {</span>
<a href="#l2.1290"></a><span id="l2.1290">       this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_SAFE_MODE;</span>
<a href="#l2.1291"></a><span id="l2.1291">       return;</span>
<a href="#l2.1292"></a><span id="l2.1292">     }</span>
<a href="#l2.1293"></a><span id="l2.1293"> </span>
<a href="#l2.1294"></a><span id="l2.1294">     /* Check if we crashed at the last startup during autologin */</span>
<a href="#l2.1295"></a><span id="l2.1295">     let autoLoginPending;</span>
<a href="#l2.1296"></a><span id="l2.1296" class="difflineminus">-    if (prefs.getPrefType(kPrefAutologinPending) == prefs.PREF_INVALID ||</span>
<a href="#l2.1297"></a><span id="l2.1297" class="difflineminus">-        !(autoLoginPending = prefs.getIntPref(kPrefAutologinPending))) {</span>
<a href="#l2.1298"></a><span id="l2.1298" class="difflineplus">+    if (</span>
<a href="#l2.1299"></a><span id="l2.1299" class="difflineplus">+      prefs.getPrefType(kPrefAutologinPending) == prefs.PREF_INVALID ||</span>
<a href="#l2.1300"></a><span id="l2.1300" class="difflineplus">+      !(autoLoginPending = prefs.getIntPref(kPrefAutologinPending))</span>
<a href="#l2.1301"></a><span id="l2.1301" class="difflineplus">+    ) {</span>
<a href="#l2.1302"></a><span id="l2.1302">       // if the pref isn't set, then we haven't crashed: keep autologin enabled</span>
<a href="#l2.1303"></a><span id="l2.1303">       return;</span>
<a href="#l2.1304"></a><span id="l2.1304">     }</span>
<a href="#l2.1305"></a><span id="l2.1305"> </span>
<a href="#l2.1306"></a><span id="l2.1306">     // Last autologin hasn't finished properly.</span>
<a href="#l2.1307"></a><span id="l2.1307">     // For now, assume it's because of a crash.</span>
<a href="#l2.1308"></a><span id="l2.1308">     this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_CRASH;</span>
<a href="#l2.1309"></a><span id="l2.1309">     prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l2.1310"></a><span id="l2.1310"> </span>
<a href="#l2.1311"></a><span id="l2.1311">     // If the crash reporter isn't built, we can't know anything more.</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineminus">-    if (!(&quot;nsICrashReporter&quot; in Ci))</span>
<a href="#l2.1313"></a><span id="l2.1313" class="difflineplus">+    if (!(&quot;nsICrashReporter&quot; in Ci)) {</span>
<a href="#l2.1314"></a><span id="l2.1314">       return;</span>
<a href="#l2.1315"></a><span id="l2.1315" class="difflineplus">+    }</span>
<a href="#l2.1316"></a><span id="l2.1316"> </span>
<a href="#l2.1317"></a><span id="l2.1317">     try {</span>
<a href="#l2.1318"></a><span id="l2.1318">       // Try to get more info with breakpad</span>
<a href="#l2.1319"></a><span id="l2.1319">       let lastCrashTime = 0;</span>
<a href="#l2.1320"></a><span id="l2.1320"> </span>
<a href="#l2.1321"></a><span id="l2.1321">       /* Locate the LastCrash file */</span>
<a href="#l2.1322"></a><span id="l2.1322">       let lastCrash = Services.dirsvc.get(&quot;UAppData&quot;, Ci.nsIFile);</span>
<a href="#l2.1323"></a><span id="l2.1323">       lastCrash.append(&quot;Crash Reports&quot;);</span>
<a href="#l2.1324"></a><span id="l2.1324">       lastCrash.append(&quot;LastCrash&quot;);</span>
<a href="#l2.1325"></a><span id="l2.1325">       if (lastCrash.exists()) {</span>
<a href="#l2.1326"></a><span id="l2.1326">         /* Ok, the file exists, now let's try to read it */</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineminus">-        let is = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineminus">-                 .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineminus">-        let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineminus">-                  .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineplus">+        let is = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].createInstance(</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineplus">+          Ci.nsIFileInputStream</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineplus">+        );</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineplus">+        let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(</span>
<a href="#l2.1335"></a><span id="l2.1335" class="difflineplus">+          Ci.nsIScriptableInputStream</span>
<a href="#l2.1336"></a><span id="l2.1336" class="difflineplus">+        );</span>
<a href="#l2.1337"></a><span id="l2.1337">         is.init(lastCrash, -1, 0, 0);</span>
<a href="#l2.1338"></a><span id="l2.1338">         sis.init(sis);</span>
<a href="#l2.1339"></a><span id="l2.1339"> </span>
<a href="#l2.1340"></a><span id="l2.1340">         lastCrashTime = parseInt(sis.read(lastCrash.fileSize));</span>
<a href="#l2.1341"></a><span id="l2.1341"> </span>
<a href="#l2.1342"></a><span id="l2.1342">         sis.close();</span>
<a href="#l2.1343"></a><span id="l2.1343">       }</span>
<a href="#l2.1344"></a><span id="l2.1344">       // The file not existing is totally acceptable, it just means that</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineat">@@ -945,131 +1152,153 @@ AccountsService.prototype = {</span>
<a href="#l2.1346"></a><span id="l2.1346"> </span>
<a href="#l2.1347"></a><span id="l2.1347">       if (lastCrashTime &lt; autoLoginPending) {</span>
<a href="#l2.1348"></a><span id="l2.1348">         // the last crash caught by breakpad is older than our last autologin</span>
<a href="#l2.1349"></a><span id="l2.1349">         // attempt.</span>
<a href="#l2.1350"></a><span id="l2.1350">         // If breakpad is currently enabled, we can be confident that</span>
<a href="#l2.1351"></a><span id="l2.1351">         // autologin was interrupted for an exterior reason</span>
<a href="#l2.1352"></a><span id="l2.1352">         // (application killed by the user, power outage, ...)</span>
<a href="#l2.1353"></a><span id="l2.1353">         try {</span>
<a href="#l2.1354"></a><span id="l2.1354" class="difflineminus">-          Services.appinfo.QueryInterface(Ci.nsICrashReporter)</span>
<a href="#l2.1355"></a><span id="l2.1355" class="difflineminus">-                  .annotateCrashReport(&quot;=&quot;, &quot;&quot;);</span>
<a href="#l2.1356"></a><span id="l2.1356" class="difflineplus">+          Services.appinfo</span>
<a href="#l2.1357"></a><span id="l2.1357" class="difflineplus">+            .QueryInterface(Ci.nsICrashReporter)</span>
<a href="#l2.1358"></a><span id="l2.1358" class="difflineplus">+            .annotateCrashReport(&quot;=&quot;, &quot;&quot;);</span>
<a href="#l2.1359"></a><span id="l2.1359">         } catch (e) {</span>
<a href="#l2.1360"></a><span id="l2.1360">           // This should fail with NS_ERROR_INVALID_ARG if breakpad is enabled,</span>
<a href="#l2.1361"></a><span id="l2.1361">           // and NS_ERROR_NOT_INITIALIZED if it is not.</span>
<a href="#l2.1362"></a><span id="l2.1362" class="difflineminus">-          if (e.result != Cr.NS_ERROR_NOT_INITIALIZED)</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineplus">+          if (e.result != Cr.NS_ERROR_NOT_INITIALIZED) {</span>
<a href="#l2.1364"></a><span id="l2.1364">             this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineplus">+          }</span>
<a href="#l2.1366"></a><span id="l2.1366">         }</span>
<a href="#l2.1367"></a><span id="l2.1367">       }</span>
<a href="#l2.1368"></a><span id="l2.1368">     } catch (e) {</span>
<a href="#l2.1369"></a><span id="l2.1369">       // if we failed to get the last crash time, then keep the</span>
<a href="#l2.1370"></a><span id="l2.1370">       // AUTOLOGIN_CRASH value in mAutoLoginStatus and return.</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineminus">-</span>
<a href="#l2.1372"></a><span id="l2.1372">     }</span>
<a href="#l2.1373"></a><span id="l2.1373">   },</span>
<a href="#l2.1374"></a><span id="l2.1374"> </span>
<a href="#l2.1375"></a><span id="l2.1375">   processAutoLogin() {</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineminus">-    if (!this._accounts)  // if we're already shutting down</span>
<a href="#l2.1377"></a><span id="l2.1377" class="difflineplus">+    if (!this._accounts) {</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineplus">+      // if we're already shutting down</span>
<a href="#l2.1379"></a><span id="l2.1379">       return;</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+    }</span>
<a href="#l2.1381"></a><span id="l2.1381"> </span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineminus">-    for (let account of this._accounts)</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l2.1384"></a><span id="l2.1384">       account.checkAutoLogin();</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineplus">+    }</span>
<a href="#l2.1386"></a><span id="l2.1386"> </span>
<a href="#l2.1387"></a><span id="l2.1387">     // Make sure autologin is now enabled, so that we don't display a</span>
<a href="#l2.1388"></a><span id="l2.1388">     // message stating that it is disabled and asking the user if it</span>
<a href="#l2.1389"></a><span id="l2.1389">     // should be processed now.</span>
<a href="#l2.1390"></a><span id="l2.1390">     this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l2.1391"></a><span id="l2.1391"> </span>
<a href="#l2.1392"></a><span id="l2.1392">     // Notify observers so that any message stating that autologin is</span>
<a href="#l2.1393"></a><span id="l2.1393">     // disabled can be removed</span>
<a href="#l2.1394"></a><span id="l2.1394">     Services.obs.notifyObservers(this, &quot;autologin-processed&quot;);</span>
<a href="#l2.1395"></a><span id="l2.1395">   },</span>
<a href="#l2.1396"></a><span id="l2.1396"> </span>
<a href="#l2.1397"></a><span id="l2.1397">   _checkingIfPasswordStillMissing: false,</span>
<a href="#l2.1398"></a><span id="l2.1398">   _checkIfPasswordStillMissing() {</span>
<a href="#l2.1399"></a><span id="l2.1399">     // Avoid recursion.</span>
<a href="#l2.1400"></a><span id="l2.1400" class="difflineminus">-    if (this._checkingIfPasswordStillMissing)</span>
<a href="#l2.1401"></a><span id="l2.1401" class="difflineplus">+    if (this._checkingIfPasswordStillMissing) {</span>
<a href="#l2.1402"></a><span id="l2.1402">       return;</span>
<a href="#l2.1403"></a><span id="l2.1403" class="difflineplus">+    }</span>
<a href="#l2.1404"></a><span id="l2.1404"> </span>
<a href="#l2.1405"></a><span id="l2.1405">     this._checkingIfPasswordStillMissing = true;</span>
<a href="#l2.1406"></a><span id="l2.1406" class="difflineminus">-    for (let account of this._accounts)</span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l2.1408"></a><span id="l2.1408">       account._checkIfPasswordStillMissing();</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineplus">+    }</span>
<a href="#l2.1410"></a><span id="l2.1410">     delete this._checkingIfPasswordStillMissing;</span>
<a href="#l2.1411"></a><span id="l2.1411">   },</span>
<a href="#l2.1412"></a><span id="l2.1412"> </span>
<a href="#l2.1413"></a><span id="l2.1413">   getAccountById(aAccountId) {</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineminus">-    if (!aAccountId.startsWith(kAccountKeyPrefix))</span>
<a href="#l2.1415"></a><span id="l2.1415" class="difflineplus">+    if (!aAccountId.startsWith(kAccountKeyPrefix)) {</span>
<a href="#l2.1416"></a><span id="l2.1416">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.1417"></a><span id="l2.1417" class="difflineplus">+    }</span>
<a href="#l2.1418"></a><span id="l2.1418"> </span>
<a href="#l2.1419"></a><span id="l2.1419">     let id = parseInt(aAccountId.substr(kAccountKeyPrefix.length));</span>
<a href="#l2.1420"></a><span id="l2.1420">     return this.getAccountByNumericId(id);</span>
<a href="#l2.1421"></a><span id="l2.1421">   },</span>
<a href="#l2.1422"></a><span id="l2.1422"> </span>
<a href="#l2.1423"></a><span id="l2.1423">   _keepAccount(aAccount) {</span>
<a href="#l2.1424"></a><span id="l2.1424">     this._accounts.push(aAccount);</span>
<a href="#l2.1425"></a><span id="l2.1425">     this._accountsById[aAccount.numericId] = aAccount;</span>
<a href="#l2.1426"></a><span id="l2.1426">   },</span>
<a href="#l2.1427"></a><span id="l2.1427" class="difflineminus">-  getAccountByNumericId(aAccountId) { return this._accountsById[aAccountId]; },</span>
<a href="#l2.1428"></a><span id="l2.1428" class="difflineminus">-  getAccounts() { return new nsSimpleEnumerator(this._accounts); },</span>
<a href="#l2.1429"></a><span id="l2.1429" class="difflineplus">+  getAccountByNumericId(aAccountId) {</span>
<a href="#l2.1430"></a><span id="l2.1430" class="difflineplus">+    return this._accountsById[aAccountId];</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineplus">+  },</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineplus">+  getAccounts() {</span>
<a href="#l2.1433"></a><span id="l2.1433" class="difflineplus">+    return new nsSimpleEnumerator(this._accounts);</span>
<a href="#l2.1434"></a><span id="l2.1434" class="difflineplus">+  },</span>
<a href="#l2.1435"></a><span id="l2.1435"> </span>
<a href="#l2.1436"></a><span id="l2.1436">   createAccount(aName, aPrpl) {</span>
<a href="#l2.1437"></a><span id="l2.1437">     // Ensure an account with the same name and protocol doesn't already exist.</span>
<a href="#l2.1438"></a><span id="l2.1438">     let prpl = Services.core.getProtocolById(aPrpl);</span>
<a href="#l2.1439"></a><span id="l2.1439" class="difflineminus">-    if (!prpl)</span>
<a href="#l2.1440"></a><span id="l2.1440" class="difflineplus">+    if (!prpl) {</span>
<a href="#l2.1441"></a><span id="l2.1441">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1442"></a><span id="l2.1442" class="difflineplus">+    }</span>
<a href="#l2.1443"></a><span id="l2.1443">     if (prpl.accountExists(aName)) {</span>
<a href="#l2.1444"></a><span id="l2.1444">       Cu.reportError(&quot;Attempted to create a duplicate account!&quot;);</span>
<a href="#l2.1445"></a><span id="l2.1445">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l2.1446"></a><span id="l2.1446">     }</span>
<a href="#l2.1447"></a><span id="l2.1447"> </span>
<a href="#l2.1448"></a><span id="l2.1448">     /* First get a unique id for the new account. */</span>
<a href="#l2.1449"></a><span id="l2.1449">     let id;</span>
<a href="#l2.1450"></a><span id="l2.1450">     for (id = 1; ; ++id) {</span>
<a href="#l2.1451"></a><span id="l2.1451" class="difflineminus">-      if (this._accountsById.hasOwnProperty(id))</span>
<a href="#l2.1452"></a><span id="l2.1452" class="difflineplus">+      if (this._accountsById.hasOwnProperty(id)) {</span>
<a href="#l2.1453"></a><span id="l2.1453">         continue;</span>
<a href="#l2.1454"></a><span id="l2.1454" class="difflineplus">+      }</span>
<a href="#l2.1455"></a><span id="l2.1455"> </span>
<a href="#l2.1456"></a><span id="l2.1456">       /* id isn't used by a known account, double check it isn't</span>
<a href="#l2.1457"></a><span id="l2.1457">        already used in the sqlite database. This should never</span>
<a href="#l2.1458"></a><span id="l2.1458">        happen, except if we have a corrupted profile. */</span>
<a href="#l2.1459"></a><span id="l2.1459" class="difflineminus">-      if (!Services.contacts.accountIdExists(id))</span>
<a href="#l2.1460"></a><span id="l2.1460" class="difflineplus">+      if (!Services.contacts.accountIdExists(id)) {</span>
<a href="#l2.1461"></a><span id="l2.1461">         break;</span>
<a href="#l2.1462"></a><span id="l2.1462" class="difflineminus">-      Services.console.logStringMessage(&quot;No account &quot; + id + &quot; but there is some data in the buddy list for an account with this number. Your profile may be corrupted.&quot;);</span>
<a href="#l2.1463"></a><span id="l2.1463" class="difflineplus">+      }</span>
<a href="#l2.1464"></a><span id="l2.1464" class="difflineplus">+      Services.console.logStringMessage(</span>
<a href="#l2.1465"></a><span id="l2.1465" class="difflineplus">+        &quot;No account &quot; +</span>
<a href="#l2.1466"></a><span id="l2.1466" class="difflineplus">+          id +</span>
<a href="#l2.1467"></a><span id="l2.1467" class="difflineplus">+          &quot; but there is some data in the buddy list for an account with this number. Your profile may be corrupted.&quot;</span>
<a href="#l2.1468"></a><span id="l2.1468" class="difflineplus">+      );</span>
<a href="#l2.1469"></a><span id="l2.1469">     }</span>
<a href="#l2.1470"></a><span id="l2.1470"> </span>
<a href="#l2.1471"></a><span id="l2.1471">     /* Actually create the new account. */</span>
<a href="#l2.1472"></a><span id="l2.1472">     let key = kAccountKeyPrefix + id;</span>
<a href="#l2.1473"></a><span id="l2.1473">     let account = new imAccount(key, aName, aPrpl);</span>
<a href="#l2.1474"></a><span id="l2.1474"> </span>
<a href="#l2.1475"></a><span id="l2.1475">     /* Save the account list pref. */</span>
<a href="#l2.1476"></a><span id="l2.1476">     let list = this._accountList;</span>
<a href="#l2.1477"></a><span id="l2.1477">     this._accountList = list ? list + &quot;,&quot; + key : key;</span>
<a href="#l2.1478"></a><span id="l2.1478"> </span>
<a href="#l2.1479"></a><span id="l2.1479">     Services.obs.notifyObservers(account, &quot;account-added&quot;);</span>
<a href="#l2.1480"></a><span id="l2.1480">     return account;</span>
<a href="#l2.1481"></a><span id="l2.1481">   },</span>
<a href="#l2.1482"></a><span id="l2.1482"> </span>
<a href="#l2.1483"></a><span id="l2.1483">   deleteAccount(aAccountId) {</span>
<a href="#l2.1484"></a><span id="l2.1484">     let account = this.getAccountById(aAccountId);</span>
<a href="#l2.1485"></a><span id="l2.1485" class="difflineminus">-    if (!account)</span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineplus">+    if (!account) {</span>
<a href="#l2.1487"></a><span id="l2.1487">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.1488"></a><span id="l2.1488" class="difflineplus">+    }</span>
<a href="#l2.1489"></a><span id="l2.1489"> </span>
<a href="#l2.1490"></a><span id="l2.1490">     let index = this._accounts.indexOf(account);</span>
<a href="#l2.1491"></a><span id="l2.1491" class="difflineminus">-    if (index == -1)</span>
<a href="#l2.1492"></a><span id="l2.1492" class="difflineplus">+    if (index == -1) {</span>
<a href="#l2.1493"></a><span id="l2.1493">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineplus">+    }</span>
<a href="#l2.1495"></a><span id="l2.1495"> </span>
<a href="#l2.1496"></a><span id="l2.1496">     let id = account.numericId;</span>
<a href="#l2.1497"></a><span id="l2.1497">     account.remove();</span>
<a href="#l2.1498"></a><span id="l2.1498">     this._accounts.splice(index, 1);</span>
<a href="#l2.1499"></a><span id="l2.1499">     delete this._accountsById[id];</span>
<a href="#l2.1500"></a><span id="l2.1500">     Services.obs.notifyObservers(account, &quot;account-removed&quot;);</span>
<a href="#l2.1501"></a><span id="l2.1501"> </span>
<a href="#l2.1502"></a><span id="l2.1502">     /* Update the account list pref. */</span>
<a href="#l2.1503"></a><span id="l2.1503">     let list = this._accountList;</span>
<a href="#l2.1504"></a><span id="l2.1504" class="difflineminus">-    this._accountList =</span>
<a href="#l2.1505"></a><span id="l2.1505" class="difflineminus">-      list.split(&quot;,&quot;).filter(k =&gt; k.trim() != aAccountId).join(&quot;,&quot;);</span>
<a href="#l2.1506"></a><span id="l2.1506" class="difflineplus">+    this._accountList = list</span>
<a href="#l2.1507"></a><span id="l2.1507" class="difflineplus">+      .split(&quot;,&quot;)</span>
<a href="#l2.1508"></a><span id="l2.1508" class="difflineplus">+      .filter(k =&gt; k.trim() != aAccountId)</span>
<a href="#l2.1509"></a><span id="l2.1509" class="difflineplus">+      .join(&quot;,&quot;);</span>
<a href="#l2.1510"></a><span id="l2.1510">   },</span>
<a href="#l2.1511"></a><span id="l2.1511"> </span>
<a href="#l2.1512"></a><span id="l2.1512">   QueryInterface: ChromeUtils.generateQI([Ci.imIAccountsService]),</span>
<a href="#l2.1513"></a><span id="l2.1513">   classDescription: &quot;Accounts&quot;,</span>
<a href="#l2.1514"></a><span id="l2.1514">   classID: Components.ID(&quot;{a94b5427-cd8d-40cf-b47e-b67671953e70}&quot;),</span>
<a href="#l2.1515"></a><span id="l2.1515">   contractID: &quot;@mozilla.org/chat/accounts-service;1&quot;,</span>
<a href="#l2.1516"></a><span id="l2.1516"> };</span>
<a href="#l2.1517"></a><span id="l2.1517"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/src/imCommands.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/src/imCommands.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,84 +1,96 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> var {</span>
<a href="#l3.11"></a><span id="l3.11">   XPCOMUtils,</span>
<a href="#l3.12"></a><span id="l3.12">   setTimeout,</span>
<a href="#l3.13"></a><span id="l3.13">   clearTimeout,</span>
<a href="#l3.14"></a><span id="l3.14">   executeSoon,</span>
<a href="#l3.15"></a><span id="l3.15">   nsSimpleEnumerator,</span>
<a href="#l3.16"></a><span id="l3.16">   EmptyEnumerator,</span>
<a href="#l3.17"></a><span id="l3.17">   ClassInfo,</span>
<a href="#l3.18"></a><span id="l3.18">   l10nHelper,</span>
<a href="#l3.19"></a><span id="l3.19">   initLogModule,</span>
<a href="#l3.20"></a><span id="l3.20"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l3.23"></a><span id="l3.23">   l10nHelper(&quot;chrome://chat/locale/commands.properties&quot;)</span>
<a href="#l3.24"></a><span id="l3.24"> );</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-function CommandsService() { }</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+function CommandsService() {}</span>
<a href="#l3.28"></a><span id="l3.28"> CommandsService.prototype = {</span>
<a href="#l3.29"></a><span id="l3.29">   initCommands() {</span>
<a href="#l3.30"></a><span id="l3.30">     this._commands = {};</span>
<a href="#l3.31"></a><span id="l3.31">     // The say command is directly implemented in the UI layer, but has a</span>
<a href="#l3.32"></a><span id="l3.32">     // dummy command registered here so it shows up as a command (e.g. when</span>
<a href="#l3.33"></a><span id="l3.33">     // using the /help command).</span>
<a href="#l3.34"></a><span id="l3.34">     this.registerCommand({</span>
<a href="#l3.35"></a><span id="l3.35">       name: &quot;say&quot;,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-      get helpString() { return _(&quot;sayHelpString&quot;); },</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+      get helpString() {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+        return _(&quot;sayHelpString&quot;);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      },</span>
<a href="#l3.40"></a><span id="l3.40">       usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l3.41"></a><span id="l3.41">       priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l3.42"></a><span id="l3.42">       run(aMsg, aConv) {</span>
<a href="#l3.43"></a><span id="l3.43">         throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.44"></a><span id="l3.44">       },</span>
<a href="#l3.45"></a><span id="l3.45">     });</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">     this.registerCommand({</span>
<a href="#l3.48"></a><span id="l3.48">       name: &quot;raw&quot;,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-      get helpString() { return _(&quot;rawHelpString&quot;); },</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+      get helpString() {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+        return _(&quot;rawHelpString&quot;);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+      },</span>
<a href="#l3.53"></a><span id="l3.53">       usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l3.54"></a><span id="l3.54">       priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l3.55"></a><span id="l3.55">       run(aMsg, aConv) {</span>
<a href="#l3.56"></a><span id="l3.56">         let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-        if (!conv)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+        if (!conv) {</span>
<a href="#l3.59"></a><span id="l3.59">           return false;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+        }</span>
<a href="#l3.61"></a><span id="l3.61">         conv.sendMsg(aMsg);</span>
<a href="#l3.62"></a><span id="l3.62">         return true;</span>
<a href="#l3.63"></a><span id="l3.63">       },</span>
<a href="#l3.64"></a><span id="l3.64">     });</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66">     this.registerCommand({</span>
<a href="#l3.67"></a><span id="l3.67">       // Reference the command service so we can use the internal properties</span>
<a href="#l3.68"></a><span id="l3.68">       // directly.</span>
<a href="#l3.69"></a><span id="l3.69">       cmdSrv: this,</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71">       name: &quot;help&quot;,</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-      get helpString() { return _(&quot;helpHelpString&quot;); },</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+      get helpString() {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+        return _(&quot;helpHelpString&quot;);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+      },</span>
<a href="#l3.76"></a><span id="l3.76">       usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l3.77"></a><span id="l3.77">       priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l3.78"></a><span id="l3.78">       run(aMsg, aConv) {</span>
<a href="#l3.79"></a><span id="l3.79">         aMsg = aMsg.trim();</span>
<a href="#l3.80"></a><span id="l3.80">         let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-        if (!conv)</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+        if (!conv) {</span>
<a href="#l3.83"></a><span id="l3.83">           return false;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+        }</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">         // Handle when no command is given, list all possible commands that are</span>
<a href="#l3.87"></a><span id="l3.87">         // available for this conversation (alphabetically).</span>
<a href="#l3.88"></a><span id="l3.88">         if (!aMsg) {</span>
<a href="#l3.89"></a><span id="l3.89">           let commands = this.cmdSrv.listCommandsForConversation(aConv, {});</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-          if (!commands.length)</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+          if (!commands.length) {</span>
<a href="#l3.92"></a><span id="l3.92">             return false;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+          }</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95">           // Concatenate the command names (separated by a comma and space).</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-          let cmds = commands.map(aCmd =&gt; aCmd.name).sort().join(&quot;, &quot;);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+          let cmds = commands</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+            .map(aCmd =&gt; aCmd.name)</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+            .sort()</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+            .join(&quot;, &quot;);</span>
<a href="#l3.101"></a><span id="l3.101">           let message = _(&quot;commands&quot;, cmds);</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103">           // Display the message</span>
<a href="#l3.104"></a><span id="l3.104">           conv.systemMessage(message);</span>
<a href="#l3.105"></a><span id="l3.105">           return true;</span>
<a href="#l3.106"></a><span id="l3.106">         }</span>
<a href="#l3.107"></a><span id="l3.107"> </span>
<a href="#l3.108"></a><span id="l3.108">         // A command name was given, find the commands that match.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineat">@@ -90,18 +102,19 @@ CommandsService.prototype = {</span>
<a href="#l3.110"></a><span id="l3.110">           conv.systemMessage(message);</span>
<a href="#l3.111"></a><span id="l3.111">           return true;</span>
<a href="#l3.112"></a><span id="l3.112">         }</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114">         // Only show the help for the one of the highest priority.</span>
<a href="#l3.115"></a><span id="l3.115">         let cmd = cmdArray[0];</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117">         let text = cmd.helpString;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-        if (!text)</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+        if (!text) {</span>
<a href="#l3.120"></a><span id="l3.120">           text = _(&quot;noHelp&quot;, cmd.name);</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+        }</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123">         // Display the message.</span>
<a href="#l3.124"></a><span id="l3.124">         conv.systemMessage(text);</span>
<a href="#l3.125"></a><span id="l3.125">         return true;</span>
<a href="#l3.126"></a><span id="l3.126">       },</span>
<a href="#l3.127"></a><span id="l3.127">     });</span>
<a href="#l3.128"></a><span id="l3.128"> </span>
<a href="#l3.129"></a><span id="l3.129">     // Status commands</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineat">@@ -111,147 +124,171 @@ CommandsService.prototype = {</span>
<a href="#l3.131"></a><span id="l3.131">       busy: &quot;UNAVAILABLE&quot;,</span>
<a href="#l3.132"></a><span id="l3.132">       dnd: &quot;UNAVAILABLE&quot;,</span>
<a href="#l3.133"></a><span id="l3.133">       offline: &quot;OFFLINE&quot;,</span>
<a href="#l3.134"></a><span id="l3.134">     };</span>
<a href="#l3.135"></a><span id="l3.135">     for (let cmd in status) {</span>
<a href="#l3.136"></a><span id="l3.136">       let statusValue = Ci.imIStatusInfo[&quot;STATUS_&quot; + status[cmd]];</span>
<a href="#l3.137"></a><span id="l3.137">       this.registerCommand({</span>
<a href="#l3.138"></a><span id="l3.138">         name: cmd,</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-        get helpString() { return _(&quot;statusCommand&quot;, this.name, _(this.name)); },</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+        get helpString() {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+          return _(&quot;statusCommand&quot;, this.name, _(this.name));</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+        },</span>
<a href="#l3.143"></a><span id="l3.143">         usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l3.144"></a><span id="l3.144">         priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l3.145"></a><span id="l3.145">         run(aMsg) {</span>
<a href="#l3.146"></a><span id="l3.146">           Services.core.globalUserStatus.setStatus(statusValue, aMsg);</span>
<a href="#l3.147"></a><span id="l3.147">           return true;</span>
<a href="#l3.148"></a><span id="l3.148">         },</span>
<a href="#l3.149"></a><span id="l3.149">       });</span>
<a href="#l3.150"></a><span id="l3.150">     }</span>
<a href="#l3.151"></a><span id="l3.151">   },</span>
<a href="#l3.152"></a><span id="l3.152">   unInitCommands() {</span>
<a href="#l3.153"></a><span id="l3.153">     delete this._commands;</span>
<a href="#l3.154"></a><span id="l3.154">   },</span>
<a href="#l3.155"></a><span id="l3.155"> </span>
<a href="#l3.156"></a><span id="l3.156">   registerCommand(aCommand, aPrplId) {</span>
<a href="#l3.157"></a><span id="l3.157">     let name = aCommand.name;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-    if (!name)</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+    if (!name) {</span>
<a href="#l3.160"></a><span id="l3.160">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+    }</span>
<a href="#l3.162"></a><span id="l3.162"> </span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-    if (!(this._commands.hasOwnProperty(name)))</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+    if (!this._commands.hasOwnProperty(name)) {</span>
<a href="#l3.165"></a><span id="l3.165">       this._commands[name] = {};</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+    }</span>
<a href="#l3.167"></a><span id="l3.167">     this._commands[name][aPrplId || &quot;&quot;] = aCommand;</span>
<a href="#l3.168"></a><span id="l3.168">   },</span>
<a href="#l3.169"></a><span id="l3.169">   unregisterCommand(aCommandName, aPrplId) {</span>
<a href="#l3.170"></a><span id="l3.170">     if (this._commands.hasOwnProperty(aCommandName)) {</span>
<a href="#l3.171"></a><span id="l3.171">       let prplId = aPrplId || &quot;&quot;;</span>
<a href="#l3.172"></a><span id="l3.172">       let commands = this._commands[aCommandName];</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-      if (commands.hasOwnProperty(prplId))</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+      if (commands.hasOwnProperty(prplId)) {</span>
<a href="#l3.175"></a><span id="l3.175">         delete commands[prplId];</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-      if (!Object.keys(commands).length)</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+      }</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+      if (!Object.keys(commands).length) {</span>
<a href="#l3.179"></a><span id="l3.179">         delete this._commands[aCommandName];</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+      }</span>
<a href="#l3.181"></a><span id="l3.181">     }</span>
<a href="#l3.182"></a><span id="l3.182">   },</span>
<a href="#l3.183"></a><span id="l3.183">   listCommandsForConversation(aConversation, commandCount) {</span>
<a href="#l3.184"></a><span id="l3.184">     let result = [];</span>
<a href="#l3.185"></a><span id="l3.185">     let prplId = aConversation &amp;&amp; aConversation.account.protocol.id;</span>
<a href="#l3.186"></a><span id="l3.186">     for (let name in this._commands) {</span>
<a href="#l3.187"></a><span id="l3.187">       let commands = this._commands[name];</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-      if (commands.hasOwnProperty(&quot;&quot;))</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+      if (commands.hasOwnProperty(&quot;&quot;)) {</span>
<a href="#l3.190"></a><span id="l3.190">         result.push(commands[&quot;&quot;]);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-      if (prplId &amp;&amp; commands.hasOwnProperty(prplId))</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+      }</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+      if (prplId &amp;&amp; commands.hasOwnProperty(prplId)) {</span>
<a href="#l3.194"></a><span id="l3.194">         result.push(commands[prplId]);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+      }</span>
<a href="#l3.196"></a><span id="l3.196">     }</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    if (aConversation)</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+    if (aConversation) {</span>
<a href="#l3.199"></a><span id="l3.199">       result = result.filter(this._usageContextFilter(aConversation));</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+    }</span>
<a href="#l3.201"></a><span id="l3.201">     commandCount.value = result.length;</span>
<a href="#l3.202"></a><span id="l3.202">     return result;</span>
<a href="#l3.203"></a><span id="l3.203">   },</span>
<a href="#l3.204"></a><span id="l3.204">   // List only the commands for a protocol (excluding the global commands).</span>
<a href="#l3.205"></a><span id="l3.205">   listCommandsForProtocol(aPrplId, commandCount) {</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    if (!aPrplId)</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    if (!aPrplId) {</span>
<a href="#l3.208"></a><span id="l3.208">       throw new Error(&quot;You must provide a prpl ID.&quot;);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+    }</span>
<a href="#l3.210"></a><span id="l3.210"> </span>
<a href="#l3.211"></a><span id="l3.211">     let result = [];</span>
<a href="#l3.212"></a><span id="l3.212">     for (let name in this._commands) {</span>
<a href="#l3.213"></a><span id="l3.213">       let commands = this._commands[name];</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-      if (commands.hasOwnProperty(aPrplId))</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+      if (commands.hasOwnProperty(aPrplId)) {</span>
<a href="#l3.216"></a><span id="l3.216">         result.push(commands[aPrplId]);</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+      }</span>
<a href="#l3.218"></a><span id="l3.218">     }</span>
<a href="#l3.219"></a><span id="l3.219">     commandCount.value = result.length;</span>
<a href="#l3.220"></a><span id="l3.220">     return result;</span>
<a href="#l3.221"></a><span id="l3.221">   },</span>
<a href="#l3.222"></a><span id="l3.222">   _usageContextFilter(aConversation) {</span>
<a href="#l3.223"></a><span id="l3.223">     let usageContext =</span>
<a href="#l3.224"></a><span id="l3.224">       Ci.imICommand[&quot;CMD_CONTEXT_&quot; + (aConversation.isChat ? &quot;CHAT&quot; : &quot;IM&quot;)];</span>
<a href="#l3.225"></a><span id="l3.225">     return c =&gt; c.usageContext &amp; usageContext;</span>
<a href="#l3.226"></a><span id="l3.226">   },</span>
<a href="#l3.227"></a><span id="l3.227">   _findCommands(aConversation, aName) {</span>
<a href="#l3.228"></a><span id="l3.228">     let prplId = null;</span>
<a href="#l3.229"></a><span id="l3.229">     if (aConversation) {</span>
<a href="#l3.230"></a><span id="l3.230">       let account = aConversation.account;</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-      if (account.connected)</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+      if (account.connected) {</span>
<a href="#l3.233"></a><span id="l3.233">         prplId = account.protocol.id;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+      }</span>
<a href="#l3.235"></a><span id="l3.235">     }</span>
<a href="#l3.236"></a><span id="l3.236"> </span>
<a href="#l3.237"></a><span id="l3.237">     let commandNames;</span>
<a href="#l3.238"></a><span id="l3.238">     // If there is an exact match for the given command name,</span>
<a href="#l3.239"></a><span id="l3.239">     // don't look at any other commands.</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-    if (this._commands.hasOwnProperty(aName))</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+    if (this._commands.hasOwnProperty(aName)) {</span>
<a href="#l3.242"></a><span id="l3.242">       commandNames = [aName];</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+    }</span>
<a href="#l3.244"></a><span id="l3.244">     // Otherwise, check if there is a partial match.</span>
<a href="#l3.245"></a><span id="l3.245">     else {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-      commandNames = Object.keys(this._commands)</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-                           .filter(command =&gt; command.startsWith(aName));</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+      commandNames = Object.keys(this._commands).filter(command =&gt;</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+        command.startsWith(aName)</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+      );</span>
<a href="#l3.251"></a><span id="l3.251">     }</span>
<a href="#l3.252"></a><span id="l3.252"> </span>
<a href="#l3.253"></a><span id="l3.253">     // If a single full command name matches the given (partial)</span>
<a href="#l3.254"></a><span id="l3.254">     // command name, return the results for that command name. Otherwise,</span>
<a href="#l3.255"></a><span id="l3.255">     // return an empty array (don't assume a certain command).</span>
<a href="#l3.256"></a><span id="l3.256">     let cmdArray = [];</span>
<a href="#l3.257"></a><span id="l3.257">     for (let commandName of commandNames) {</span>
<a href="#l3.258"></a><span id="l3.258">       let matches = [];</span>
<a href="#l3.259"></a><span id="l3.259"> </span>
<a href="#l3.260"></a><span id="l3.260">       // Get the 2 possible commands (the global and the proto specific).</span>
<a href="#l3.261"></a><span id="l3.261">       let commands = this._commands[commandName];</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-      if (commands.hasOwnProperty(&quot;&quot;))</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+      if (commands.hasOwnProperty(&quot;&quot;)) {</span>
<a href="#l3.264"></a><span id="l3.264">         matches.push(commands[&quot;&quot;]);</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-      if (prplId &amp;&amp; commands.hasOwnProperty(prplId))</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+      }</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+      if (prplId &amp;&amp; commands.hasOwnProperty(prplId)) {</span>
<a href="#l3.268"></a><span id="l3.268">         matches.push(commands[prplId]);</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+      }</span>
<a href="#l3.270"></a><span id="l3.270"> </span>
<a href="#l3.271"></a><span id="l3.271">       // Remove the commands that can't apply in this context.</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-      if (aConversation)</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+      if (aConversation) {</span>
<a href="#l3.274"></a><span id="l3.274">         matches = matches.filter(this._usageContextFilter(aConversation));</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+      }</span>
<a href="#l3.276"></a><span id="l3.276"> </span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-      if (!matches.length)</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+      if (!matches.length) {</span>
<a href="#l3.279"></a><span id="l3.279">         continue;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+      }</span>
<a href="#l3.281"></a><span id="l3.281"> </span>
<a href="#l3.282"></a><span id="l3.282">       // If we have found a second matching command name, return the empty array.</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-      if (cmdArray.length)</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+      if (cmdArray.length) {</span>
<a href="#l3.285"></a><span id="l3.285">         return [];</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+      }</span>
<a href="#l3.287"></a><span id="l3.287"> </span>
<a href="#l3.288"></a><span id="l3.288">       cmdArray = matches;</span>
<a href="#l3.289"></a><span id="l3.289">     }</span>
<a href="#l3.290"></a><span id="l3.290"> </span>
<a href="#l3.291"></a><span id="l3.291">     // Sort the matching commands by priority before returning the array.</span>
<a href="#l3.292"></a><span id="l3.292">     return cmdArray.sort((a, b) =&gt; b.priority - a.priority);</span>
<a href="#l3.293"></a><span id="l3.293">   },</span>
<a href="#l3.294"></a><span id="l3.294">   executeCommand(aMessage, aConversation, aReturnedConv) {</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-    if (!aMessage)</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+    if (!aMessage) {</span>
<a href="#l3.297"></a><span id="l3.297">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+    }</span>
<a href="#l3.299"></a><span id="l3.299"> </span>
<a href="#l3.300"></a><span id="l3.300">     let matchResult;</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-    if (aMessage[0] != &quot;/&quot; ||</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-        !(matchResult = /^\/([a-z0-9]+)(?: |$)([\s\S]*)/.exec(aMessage)))</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+    if (</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+      aMessage[0] != &quot;/&quot; ||</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+      !(matchResult = /^\/([a-z0-9]+)(?: |$)([\s\S]*)/.exec(aMessage))</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+    ) {</span>
<a href="#l3.307"></a><span id="l3.307">       return false;</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+    }</span>
<a href="#l3.309"></a><span id="l3.309"> </span>
<a href="#l3.310"></a><span id="l3.310">     let [, name, args] = matchResult;</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312">     let cmdArray = this._findCommands(aConversation, name);</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    if (!cmdArray.length)</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+    if (!cmdArray.length) {</span>
<a href="#l3.315"></a><span id="l3.315">       return false;</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+    }</span>
<a href="#l3.317"></a><span id="l3.317"> </span>
<a href="#l3.318"></a><span id="l3.318">     // cmdArray contains commands sorted by priority, attempt to apply</span>
<a href="#l3.319"></a><span id="l3.319">     // them in order until one succeeds.</span>
<a href="#l3.320"></a><span id="l3.320">     if (!cmdArray.some(aCmd =&gt; aCmd.run(args, aConversation, aReturnedConv))) {</span>
<a href="#l3.321"></a><span id="l3.321">       // If they all failed, print help message.</span>
<a href="#l3.322"></a><span id="l3.322">       this.executeCommand(&quot;/help &quot; + name, aConversation);</span>
<a href="#l3.323"></a><span id="l3.323">     }</span>
<a href="#l3.324"></a><span id="l3.324">     return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/components/src/imContacts.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/components/src/imContacts.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> var {</span>
<a href="#l4.11"></a><span id="l4.11">   XPCOMUtils,</span>
<a href="#l4.12"></a><span id="l4.12">   setTimeout,</span>
<a href="#l4.13"></a><span id="l4.13">   clearTimeout,</span>
<a href="#l4.14"></a><span id="l4.14">   executeSoon,</span>
<a href="#l4.15"></a><span id="l4.15">   nsSimpleEnumerator,</span>
<a href="#l4.16"></a><span id="l4.16">   EmptyEnumerator,</span>
<a href="#l4.17"></a><span id="l4.17">   ClassInfo,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineat">@@ -16,40 +16,41 @@ var {</span>
<a href="#l4.19"></a><span id="l4.19"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l4.22"></a><span id="l4.22">   l10nHelper(&quot;chrome://chat/locale/contacts.properties&quot;)</span>
<a href="#l4.23"></a><span id="l4.23"> );</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> var gDBConnection = null;</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-function executeAsyncThenFinalize(statement)</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-{</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+function executeAsyncThenFinalize(statement) {</span>
<a href="#l4.30"></a><span id="l4.30">   statement.executeAsync();</span>
<a href="#l4.31"></a><span id="l4.31">   statement.finalize();</span>
<a href="#l4.32"></a><span id="l4.32"> }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-function getDBConnection()</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-{</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+function getDBConnection() {</span>
<a href="#l4.37"></a><span id="l4.37">   const NS_APP_USER_PROFILE_50_DIR = &quot;ProfD&quot;;</span>
<a href="#l4.38"></a><span id="l4.38">   let dbFile = Services.dirsvc.get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);</span>
<a href="#l4.39"></a><span id="l4.39">   dbFile.append(&quot;blist.sqlite&quot;);</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">   let conn = Services.storage.openDatabase(dbFile);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-  if (!conn.connectionReady)</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  if (!conn.connectionReady) {</span>
<a href="#l4.44"></a><span id="l4.44">     throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  }</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">   // Grow blist db in 512KB increments.</span>
<a href="#l4.48"></a><span id="l4.48">   try {</span>
<a href="#l4.49"></a><span id="l4.49">     conn.setGrowthIncrement(512 * 1024, &quot;&quot;);</span>
<a href="#l4.50"></a><span id="l4.50">   } catch (e) {</span>
<a href="#l4.51"></a><span id="l4.51">     if (e.result == Cr.NS_ERROR_FILE_TOO_BIG) {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-      Services.console.logStringMessage(&quot;Not setting growth increment on &quot; +</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-                                        &quot;blist.sqlite because the available &quot; +</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-                                        &quot;disk space is limited&quot;);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+      Services.console.logStringMessage(</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+        &quot;Not setting growth increment on &quot; +</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+          &quot;blist.sqlite because the available &quot; +</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+          &quot;disk space is limited&quot;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      );</span>
<a href="#l4.60"></a><span id="l4.60">     } else {</span>
<a href="#l4.61"></a><span id="l4.61">       throw e;</span>
<a href="#l4.62"></a><span id="l4.62">     }</span>
<a href="#l4.63"></a><span id="l4.63">   }</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">   // Create tables and indexes.</span>
<a href="#l4.66"></a><span id="l4.66">   [</span>
<a href="#l4.67"></a><span id="l4.67">     &quot;CREATE TABLE IF NOT EXISTS accounts (&quot; +</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineat">@@ -105,18 +106,19 @@ function getDBConnection()</span>
<a href="#l4.69"></a><span id="l4.69"> // committed automatically at the end of the event loop spin so that</span>
<a href="#l4.70"></a><span id="l4.70"> // we flush buddy list data to disk only once per event loop spin.</span>
<a href="#l4.71"></a><span id="l4.71"> var gDBConnWithPendingTransaction = null;</span>
<a href="#l4.72"></a><span id="l4.72"> Object.defineProperty(this, &quot;DBConn&quot;, {</span>
<a href="#l4.73"></a><span id="l4.73">   configurable: true,</span>
<a href="#l4.74"></a><span id="l4.74">   enumerable: true,</span>
<a href="#l4.75"></a><span id="l4.75"> </span>
<a href="#l4.76"></a><span id="l4.76">   get() {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    if (gDBConnWithPendingTransaction)</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+    if (gDBConnWithPendingTransaction) {</span>
<a href="#l4.79"></a><span id="l4.79">       return gDBConnWithPendingTransaction;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    }</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">     if (!gDBConnection) {</span>
<a href="#l4.83"></a><span id="l4.83">       gDBConnection = getDBConnection();</span>
<a href="#l4.84"></a><span id="l4.84">       Services.obs.addObserver(function dbClose(aSubject, aTopic, aData) {</span>
<a href="#l4.85"></a><span id="l4.85">         Services.obs.removeObserver(dbClose, aTopic);</span>
<a href="#l4.86"></a><span id="l4.86">         if (gDBConnection) {</span>
<a href="#l4.87"></a><span id="l4.87">           gDBConnection.asyncClose();</span>
<a href="#l4.88"></a><span id="l4.88">           gDBConnection = null;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineat">@@ -128,207 +130,253 @@ Object.defineProperty(this, &quot;DBConn&quot;, {</span>
<a href="#l4.90"></a><span id="l4.90">     executeSoon(function() {</span>
<a href="#l4.91"></a><span id="l4.91">       gDBConnWithPendingTransaction.commitTransaction();</span>
<a href="#l4.92"></a><span id="l4.92">       gDBConnWithPendingTransaction = null;</span>
<a href="#l4.93"></a><span id="l4.93">     });</span>
<a href="#l4.94"></a><span id="l4.94">     return gDBConnection;</span>
<a href="#l4.95"></a><span id="l4.95">   },</span>
<a href="#l4.96"></a><span id="l4.96"> });</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-function TagsService() { }</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+function TagsService() {}</span>
<a href="#l4.100"></a><span id="l4.100"> TagsService.prototype = {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-  get wrappedJSObject() { return this; },</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  get defaultTag() { return this.createTag(_(&quot;defaultGroup&quot;)); },</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  get wrappedJSObject() {</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+    return this;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  },</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  get defaultTag() {</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    return this.createTag(_(&quot;defaultGroup&quot;));</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  },</span>
<a href="#l4.109"></a><span id="l4.109">   createTag(aName) {</span>
<a href="#l4.110"></a><span id="l4.110">     // If the tag already exists, we don't want to create a duplicate.</span>
<a href="#l4.111"></a><span id="l4.111">     let tag = this.getTagByName(aName);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-    if (tag)</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    if (tag) {</span>
<a href="#l4.114"></a><span id="l4.114">       return tag;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    }</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-    let statement = DBConn.createStatement(&quot;INSERT INTO tags (name, position) VALUES(:name, 0)&quot;);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      &quot;INSERT INTO tags (name, position) VALUES(:name, 0)&quot;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    );</span>
<a href="#l4.121"></a><span id="l4.121">     try {</span>
<a href="#l4.122"></a><span id="l4.122">       statement.params.name = aName;</span>
<a href="#l4.123"></a><span id="l4.123">       statement.executeStep();</span>
<a href="#l4.124"></a><span id="l4.124">     } finally {</span>
<a href="#l4.125"></a><span id="l4.125">       statement.finalize();</span>
<a href="#l4.126"></a><span id="l4.126">     }</span>
<a href="#l4.127"></a><span id="l4.127"> </span>
<a href="#l4.128"></a><span id="l4.128">     tag = new Tag(DBConn.lastInsertRowID, aName);</span>
<a href="#l4.129"></a><span id="l4.129">     Tags.push(tag);</span>
<a href="#l4.130"></a><span id="l4.130">     return tag;</span>
<a href="#l4.131"></a><span id="l4.131">   },</span>
<a href="#l4.132"></a><span id="l4.132">   // Get an existing tag by (numeric) id. Returns null if not found.</span>
<a href="#l4.133"></a><span id="l4.133">   getTagById: aId =&gt; TagsById[aId],</span>
<a href="#l4.134"></a><span id="l4.134">   // Get an existing tag by name (will do an SQL query). Returns null</span>
<a href="#l4.135"></a><span id="l4.135">   // if not found.</span>
<a href="#l4.136"></a><span id="l4.136">   getTagByName(aName) {</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-    let statement = DBConn.createStatement(&quot;SELECT id FROM tags where name = :name&quot;);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+      &quot;SELECT id FROM tags where name = :name&quot;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    );</span>
<a href="#l4.141"></a><span id="l4.141">     statement.params.name = aName;</span>
<a href="#l4.142"></a><span id="l4.142">     try {</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-      if (!statement.executeStep())</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+      if (!statement.executeStep()) {</span>
<a href="#l4.145"></a><span id="l4.145">         return null;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+      }</span>
<a href="#l4.147"></a><span id="l4.147">       return this.getTagById(statement.row.id);</span>
<a href="#l4.148"></a><span id="l4.148">     } finally {</span>
<a href="#l4.149"></a><span id="l4.149">       statement.finalize();</span>
<a href="#l4.150"></a><span id="l4.150">     }</span>
<a href="#l4.151"></a><span id="l4.151">   },</span>
<a href="#l4.152"></a><span id="l4.152">   // Get an array of all existing tags.</span>
<a href="#l4.153"></a><span id="l4.153">   getTags(aTagCount) {</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    if (Tags.length)</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-      Tags.sort((a, b) =&gt; a.name.toLowerCase().localeCompare(b.name.toLowerCase()));</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-    else</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+    if (Tags.length) {</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+      Tags.sort((a, b) =&gt;</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+        a.name.toLowerCase().localeCompare(b.name.toLowerCase())</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+      );</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+    } else {</span>
<a href="#l4.162"></a><span id="l4.162">       this.defaultTag;</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+    }</span>
<a href="#l4.164"></a><span id="l4.164"> </span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-    if (aTagCount)</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    if (aTagCount) {</span>
<a href="#l4.167"></a><span id="l4.167">       aTagCount.value = Tags.length;</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+    }</span>
<a href="#l4.169"></a><span id="l4.169">     return Tags;</span>
<a href="#l4.170"></a><span id="l4.170">   },</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172">   isTagHidden: aTag =&gt; aTag.id in otherContactsTag._hiddenTags,</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-  hideTag(aTag) { otherContactsTag.hideTag(aTag); },</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-  showTag(aTag) { otherContactsTag.showTag(aTag); },</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  hideTag(aTag) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    otherContactsTag.hideTag(aTag);</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+  },</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+  showTag(aTag) {</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+    otherContactsTag.showTag(aTag);</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  },</span>
<a href="#l4.181"></a><span id="l4.181">   get otherContactsTag() {</span>
<a href="#l4.182"></a><span id="l4.182">     otherContactsTag._initContacts();</span>
<a href="#l4.183"></a><span id="l4.183">     return otherContactsTag;</span>
<a href="#l4.184"></a><span id="l4.184">   },</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186">   QueryInterface: ChromeUtils.generateQI([Ci.imITagsService]),</span>
<a href="#l4.187"></a><span id="l4.187">   classDescription: &quot;Tags&quot;,</span>
<a href="#l4.188"></a><span id="l4.188">   classID: Components.ID(&quot;{1fa92237-4303-4384-b8ac-4e65b50810a5}&quot;),</span>
<a href="#l4.189"></a><span id="l4.189">   contractID: &quot;@mozilla.org/chat/tags-service;1&quot;,</span>
<a href="#l4.190"></a><span id="l4.190"> };</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192"> // TODO move into the tagsService</span>
<a href="#l4.193"></a><span id="l4.193"> var Tags = [];</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-var TagsById = { };</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+var TagsById = {};</span>
<a href="#l4.196"></a><span id="l4.196"> </span>
<a href="#l4.197"></a><span id="l4.197"> function Tag(aId, aName) {</span>
<a href="#l4.198"></a><span id="l4.198">   this._id = aId;</span>
<a href="#l4.199"></a><span id="l4.199">   this._name = aName;</span>
<a href="#l4.200"></a><span id="l4.200">   this._contacts = [];</span>
<a href="#l4.201"></a><span id="l4.201">   this._observers = [];</span>
<a href="#l4.202"></a><span id="l4.202"> </span>
<a href="#l4.203"></a><span id="l4.203">   TagsById[this.id] = this;</span>
<a href="#l4.204"></a><span id="l4.204"> }</span>
<a href="#l4.205"></a><span id="l4.205"> Tag.prototype = {</span>
<a href="#l4.206"></a><span id="l4.206">   __proto__: ClassInfo(&quot;imITag&quot;, &quot;Tag&quot;),</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-  get id() { return this._id; },</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-  get name() { return this._name; },</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+  get id() {</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+    return this._id;</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+  },</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+  get name() {</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    return this._name;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  },</span>
<a href="#l4.215"></a><span id="l4.215">   set name(aNewName) {</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-    let statement = DBConn.createStatement(&quot;UPDATE tags SET name = :name WHERE id = :id&quot;);</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+      &quot;UPDATE tags SET name = :name WHERE id = :id&quot;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+    );</span>
<a href="#l4.220"></a><span id="l4.220">     try {</span>
<a href="#l4.221"></a><span id="l4.221">       statement.params.name = aNewName;</span>
<a href="#l4.222"></a><span id="l4.222">       statement.params.id = this._id;</span>
<a href="#l4.223"></a><span id="l4.223">       statement.execute();</span>
<a href="#l4.224"></a><span id="l4.224">     } finally {</span>
<a href="#l4.225"></a><span id="l4.225">       statement.finalize();</span>
<a href="#l4.226"></a><span id="l4.226">     }</span>
<a href="#l4.227"></a><span id="l4.227"> </span>
<a href="#l4.228"></a><span id="l4.228">     // FIXME move the account buddies if some use this tag as their group</span>
<a href="#l4.229"></a><span id="l4.229">     return aNewName;</span>
<a href="#l4.230"></a><span id="l4.230">   },</span>
<a href="#l4.231"></a><span id="l4.231">   getContacts(aContactCount) {</span>
<a href="#l4.232"></a><span id="l4.232">     let contacts = this._contacts.filter(c =&gt; !c._empty);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-    if (aContactCount)</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    if (aContactCount) {</span>
<a href="#l4.235"></a><span id="l4.235">       aContactCount.value = contacts.length;</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+    }</span>
<a href="#l4.237"></a><span id="l4.237">     return contacts;</span>
<a href="#l4.238"></a><span id="l4.238">   },</span>
<a href="#l4.239"></a><span id="l4.239">   _addContact(aContact) {</span>
<a href="#l4.240"></a><span id="l4.240">     this._contacts.push(aContact);</span>
<a href="#l4.241"></a><span id="l4.241">   },</span>
<a href="#l4.242"></a><span id="l4.242">   _removeContact(aContact) {</span>
<a href="#l4.243"></a><span id="l4.243">     let index = this._contacts.indexOf(aContact);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-    if (index != -1)</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    if (index != -1) {</span>
<a href="#l4.246"></a><span id="l4.246">       this._contacts.splice(index, 1);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    }</span>
<a href="#l4.248"></a><span id="l4.248">   },</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">   addObserver(aObserver) {</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-    if (!this._observers.includes(aObserver))</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l4.253"></a><span id="l4.253">       this._observers.push(aObserver);</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+    }</span>
<a href="#l4.255"></a><span id="l4.255">   },</span>
<a href="#l4.256"></a><span id="l4.256">   removeObserver(aObserver) {</span>
<a href="#l4.257"></a><span id="l4.257">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l4.258"></a><span id="l4.258">   },</span>
<a href="#l4.259"></a><span id="l4.259">   notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-    for (let observer of this._observers)</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l4.262"></a><span id="l4.262">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    }</span>
<a href="#l4.264"></a><span id="l4.264">   },</span>
<a href="#l4.265"></a><span id="l4.265"> };</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-</span>
<a href="#l4.268"></a><span id="l4.268"> var otherContactsTag = {</span>
<a href="#l4.269"></a><span id="l4.269">   __proto__: ClassInfo([&quot;nsIObserver&quot;, &quot;imITag&quot;], &quot;Other Contacts Tag&quot;),</span>
<a href="#l4.270"></a><span id="l4.270">   hiddenTagsPref: &quot;messenger.buddies.hiddenTags&quot;,</span>
<a href="#l4.271"></a><span id="l4.271">   _hiddenTags: {},</span>
<a href="#l4.272"></a><span id="l4.272">   _contactsInitialized: false,</span>
<a href="#l4.273"></a><span id="l4.273">   _saveHiddenTagsPref() {</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-    Services.prefs.setCharPref(this.hiddenTagsPref,</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-                               Object.keys(this._hiddenTags).join(&quot;,&quot;));</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+    Services.prefs.setCharPref(</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+      this.hiddenTagsPref,</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+      Object.keys(this._hiddenTags).join(&quot;,&quot;)</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+    );</span>
<a href="#l4.280"></a><span id="l4.280">   },</span>
<a href="#l4.281"></a><span id="l4.281">   showTag(aTag) {</span>
<a href="#l4.282"></a><span id="l4.282">     let id = aTag.id;</span>
<a href="#l4.283"></a><span id="l4.283">     delete this._hiddenTags[id];</span>
<a href="#l4.284"></a><span id="l4.284">     let contacts = Object.keys(this._contacts).map(id =&gt; this._contacts[id]);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-    for (let contact of contacts)</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-      if (contact.getTags().some(t =&gt; t.id == id))</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+    for (let contact of contacts) {</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+      if (contact.getTags().some(t =&gt; t.id == id)) {</span>
<a href="#l4.289"></a><span id="l4.289">         this._removeContact(contact);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+      }</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+    }</span>
<a href="#l4.292"></a><span id="l4.292"> </span>
<a href="#l4.293"></a><span id="l4.293">     aTag.notifyObservers(aTag, &quot;tag-shown&quot;);</span>
<a href="#l4.294"></a><span id="l4.294">     Services.obs.notifyObservers(aTag, &quot;tag-shown&quot;);</span>
<a href="#l4.295"></a><span id="l4.295">     this._saveHiddenTagsPref();</span>
<a href="#l4.296"></a><span id="l4.296">   },</span>
<a href="#l4.297"></a><span id="l4.297">   hideTag(aTag) {</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-    if (aTag.id &lt; 0 || aTag.id in otherContactsTag._hiddenTags)</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    if (aTag.id &lt; 0 || aTag.id in otherContactsTag._hiddenTags) {</span>
<a href="#l4.300"></a><span id="l4.300">       return;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    }</span>
<a href="#l4.302"></a><span id="l4.302"> </span>
<a href="#l4.303"></a><span id="l4.303">     this._hiddenTags[aTag.id] = aTag;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-    if (this._contactsInitialized)</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+    if (this._contactsInitialized) {</span>
<a href="#l4.306"></a><span id="l4.306">       this._hideTag(aTag);</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+    }</span>
<a href="#l4.308"></a><span id="l4.308"> </span>
<a href="#l4.309"></a><span id="l4.309">     aTag.notifyObservers(aTag, &quot;tag-hidden&quot;);</span>
<a href="#l4.310"></a><span id="l4.310">     Services.obs.notifyObservers(aTag, &quot;tag-hidden&quot;);</span>
<a href="#l4.311"></a><span id="l4.311">     this._saveHiddenTagsPref();</span>
<a href="#l4.312"></a><span id="l4.312">   },</span>
<a href="#l4.313"></a><span id="l4.313">   _hideTag(aTag) {</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-    for (let contact of aTag.getContacts())</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-      if (!(contact.id in this._contacts) &amp;&amp;</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-          contact.getTags().every(t =&gt; t.id in this._hiddenTags))</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+    for (let contact of aTag.getContacts()) {</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+      if (</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+        !(contact.id in this._contacts) &amp;&amp;</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+        contact.getTags().every(t =&gt; t.id in this._hiddenTags)</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+      ) {</span>
<a href="#l4.322"></a><span id="l4.322">         this._addContact(contact);</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+      }</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+    }</span>
<a href="#l4.325"></a><span id="l4.325">   },</span>
<a href="#l4.326"></a><span id="l4.326">   observe(aSubject, aTopic, aData) {</span>
<a href="#l4.327"></a><span id="l4.327">     aSubject.QueryInterface(Ci.imIContact);</span>
<a href="#l4.328"></a><span id="l4.328">     if (aTopic == &quot;contact-tag-removed&quot; || aTopic == &quot;contact-added&quot;) {</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-      if (!(aSubject.id in this._contacts) &amp;&amp;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-          !(parseInt(aData) in this._hiddenTags) &amp;&amp;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-          aSubject.getTags().every(t =&gt; t.id in this._hiddenTags))</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+      if (</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+        !(aSubject.id in this._contacts) &amp;&amp;</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+        !(parseInt(aData) in this._hiddenTags) &amp;&amp;</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+        aSubject.getTags().every(t =&gt; t.id in this._hiddenTags)</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+      ) {</span>
<a href="#l4.337"></a><span id="l4.337">         this._addContact(aSubject);</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+      }</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+    } else if (</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+      aSubject.id in this._contacts &amp;&amp;</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+      (aTopic == &quot;contact-removed&quot; ||</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+        (aTopic == &quot;contact-tag-added&quot; &amp;&amp;</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+          !(parseInt(aData) in this._hiddenTags)))</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+    ) {</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+      this._removeContact(aSubject);</span>
<a href="#l4.346"></a><span id="l4.346">     }</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-    else if (aSubject.id in this._contacts &amp;&amp;</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-             (aTopic == &quot;contact-removed&quot; ||</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-              (aTopic == &quot;contact-tag-added&quot; &amp;&amp;</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-              !(parseInt(aData) in this._hiddenTags))))</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-      this._removeContact(aSubject);</span>
<a href="#l4.352"></a><span id="l4.352">   },</span>
<a href="#l4.353"></a><span id="l4.353"> </span>
<a href="#l4.354"></a><span id="l4.354">   _initHiddenTags() {</span>
<a href="#l4.355"></a><span id="l4.355">     let pref = Services.prefs.getCharPref(this.hiddenTagsPref);</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-    if (!pref)</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+    if (!pref) {</span>
<a href="#l4.358"></a><span id="l4.358">       return;</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-    for (let tagId of pref.split(&quot;,&quot;))</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+    }</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+    for (let tagId of pref.split(&quot;,&quot;)) {</span>
<a href="#l4.362"></a><span id="l4.362">       this._hiddenTags[tagId] = TagsById[tagId];</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+    }</span>
<a href="#l4.364"></a><span id="l4.364">   },</span>
<a href="#l4.365"></a><span id="l4.365">   _initContacts() {</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-    if (this._contactsInitialized)</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+    if (this._contactsInitialized) {</span>
<a href="#l4.368"></a><span id="l4.368">       return;</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+    }</span>
<a href="#l4.370"></a><span id="l4.370">     this._observers = [];</span>
<a href="#l4.371"></a><span id="l4.371">     this._observer = {</span>
<a href="#l4.372"></a><span id="l4.372">       self: this,</span>
<a href="#l4.373"></a><span id="l4.373">       observe(aSubject, aTopic, aData) {</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-        if (aTopic == &quot;contact-moved-in&quot; &amp;&amp; !(aSubject instanceof Contact))</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+        if (aTopic == &quot;contact-moved-in&quot; &amp;&amp; !(aSubject instanceof Contact)) {</span>
<a href="#l4.376"></a><span id="l4.376">           return;</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+        }</span>
<a href="#l4.378"></a><span id="l4.378"> </span>
<a href="#l4.379"></a><span id="l4.379">         this.self.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l4.380"></a><span id="l4.380">       },</span>
<a href="#l4.381"></a><span id="l4.381">     };</span>
<a href="#l4.382"></a><span id="l4.382">     this._contacts = {};</span>
<a href="#l4.383"></a><span id="l4.383">     this._contactsInitialized = true;</span>
<a href="#l4.384"></a><span id="l4.384">     for (let id in this._hiddenTags) {</span>
<a href="#l4.385"></a><span id="l4.385">       let tag = this._hiddenTags[id];</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineat">@@ -336,539 +384,662 @@ var otherContactsTag = {</span>
<a href="#l4.387"></a><span id="l4.387">     }</span>
<a href="#l4.388"></a><span id="l4.388">     Services.obs.addObserver(this, &quot;contact-tag-added&quot;);</span>
<a href="#l4.389"></a><span id="l4.389">     Services.obs.addObserver(this, &quot;contact-tag-removed&quot;);</span>
<a href="#l4.390"></a><span id="l4.390">     Services.obs.addObserver(this, &quot;contact-added&quot;);</span>
<a href="#l4.391"></a><span id="l4.391">     Services.obs.addObserver(this, &quot;contact-removed&quot;);</span>
<a href="#l4.392"></a><span id="l4.392">   },</span>
<a href="#l4.393"></a><span id="l4.393"> </span>
<a href="#l4.394"></a><span id="l4.394">   // imITag implementation</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-  get id() { return -1; },</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-  get name() { return &quot;__others__&quot;; },</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-  set name(aNewName) { throw Cr.NS_ERROR_NOT_AVAILABLE; },</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+  get id() {</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+    return -1;</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+  },</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+  get name() {</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+    return &quot;__others__&quot;;</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+  },</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+  set name(aNewName) {</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+    throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+  },</span>
<a href="#l4.407"></a><span id="l4.407">   getContacts(aContactCount) {</span>
<a href="#l4.408"></a><span id="l4.408">     let contacts = Object.keys(this._contacts).map(id =&gt; this._contacts[id]);</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineminus">-    if (aContactCount)</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+    if (aContactCount) {</span>
<a href="#l4.411"></a><span id="l4.411">       aContactCount.value = contacts.length;</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+    }</span>
<a href="#l4.413"></a><span id="l4.413">     return contacts;</span>
<a href="#l4.414"></a><span id="l4.414">   },</span>
<a href="#l4.415"></a><span id="l4.415">   _addContact(aContact) {</span>
<a href="#l4.416"></a><span id="l4.416">     this._contacts[aContact.id] = aContact;</span>
<a href="#l4.417"></a><span id="l4.417">     this.notifyObservers(aContact, &quot;contact-moved-in&quot;);</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-    for (let observer of ContactsById[aContact.id]._observers)</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+    for (let observer of ContactsById[aContact.id]._observers) {</span>
<a href="#l4.420"></a><span id="l4.420">       observer.observe(this, &quot;contact-moved-in&quot;, null);</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+    }</span>
<a href="#l4.422"></a><span id="l4.422">     aContact.addObserver(this._observer);</span>
<a href="#l4.423"></a><span id="l4.423">   },</span>
<a href="#l4.424"></a><span id="l4.424">   _removeContact(aContact) {</span>
<a href="#l4.425"></a><span id="l4.425">     delete this._contacts[aContact.id];</span>
<a href="#l4.426"></a><span id="l4.426">     aContact.removeObserver(this._observer);</span>
<a href="#l4.427"></a><span id="l4.427">     this.notifyObservers(aContact, &quot;contact-moved-out&quot;);</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-    for (let observer of ContactsById[aContact.id]._observers)</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+    for (let observer of ContactsById[aContact.id]._observers) {</span>
<a href="#l4.430"></a><span id="l4.430">       observer.observe(this, &quot;contact-moved-out&quot;, null);</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+    }</span>
<a href="#l4.432"></a><span id="l4.432">   },</span>
<a href="#l4.433"></a><span id="l4.433"> </span>
<a href="#l4.434"></a><span id="l4.434">   addObserver(aObserver) {</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-    if (!this._observers.includes(aObserver))</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l4.437"></a><span id="l4.437">       this._observers.push(aObserver);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+    }</span>
<a href="#l4.439"></a><span id="l4.439">   },</span>
<a href="#l4.440"></a><span id="l4.440">   removeObserver(aObserver) {</span>
<a href="#l4.441"></a><span id="l4.441">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l4.442"></a><span id="l4.442">   },</span>
<a href="#l4.443"></a><span id="l4.443">   notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-    for (let observer of this._observers)</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l4.446"></a><span id="l4.446">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+    }</span>
<a href="#l4.448"></a><span id="l4.448">   },</span>
<a href="#l4.449"></a><span id="l4.449"> };</span>
<a href="#l4.450"></a><span id="l4.450"> </span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-var ContactsById = { };</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+var ContactsById = {};</span>
<a href="#l4.454"></a><span id="l4.454"> var LastDummyContactId = 0;</span>
<a href="#l4.455"></a><span id="l4.455"> function Contact(aId, aAlias) {</span>
<a href="#l4.456"></a><span id="l4.456">   // Assign a negative id to dummy contacts that have a single buddy</span>
<a href="#l4.457"></a><span id="l4.457">   this._id = aId || --LastDummyContactId;</span>
<a href="#l4.458"></a><span id="l4.458">   this._alias = aAlias;</span>
<a href="#l4.459"></a><span id="l4.459">   this._tags = [];</span>
<a href="#l4.460"></a><span id="l4.460">   this._buddies = [];</span>
<a href="#l4.461"></a><span id="l4.461">   this._observers = [];</span>
<a href="#l4.462"></a><span id="l4.462"> </span>
<a href="#l4.463"></a><span id="l4.463">   ContactsById[this._id] = this;</span>
<a href="#l4.464"></a><span id="l4.464"> }</span>
<a href="#l4.465"></a><span id="l4.465"> Contact.prototype = {</span>
<a href="#l4.466"></a><span id="l4.466">   __proto__: ClassInfo(&quot;imIContact&quot;, &quot;Contact&quot;),</span>
<a href="#l4.467"></a><span id="l4.467">   _id: 0,</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-  get id() { return this._id; },</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-  get alias() { return this._alias; },</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+  get id() {</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+    return this._id;</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+  },</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+  get alias() {</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+    return this._alias;</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+  },</span>
<a href="#l4.476"></a><span id="l4.476">   set alias(aNewAlias) {</span>
<a href="#l4.477"></a><span id="l4.477">     this._ensureNotDummy();</span>
<a href="#l4.478"></a><span id="l4.478"> </span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-    let statement = DBConn.createStatement(&quot;UPDATE contacts SET alias = :alias WHERE id = :id&quot;);</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+      &quot;UPDATE contacts SET alias = :alias WHERE id = :id&quot;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+    );</span>
<a href="#l4.483"></a><span id="l4.483">     statement.params.alias = aNewAlias;</span>
<a href="#l4.484"></a><span id="l4.484">     statement.params.id = this._id;</span>
<a href="#l4.485"></a><span id="l4.485">     executeAsyncThenFinalize(statement);</span>
<a href="#l4.486"></a><span id="l4.486"> </span>
<a href="#l4.487"></a><span id="l4.487">     let oldDisplayName = this.displayName;</span>
<a href="#l4.488"></a><span id="l4.488">     this._alias = aNewAlias;</span>
<a href="#l4.489"></a><span id="l4.489">     this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l4.490"></a><span id="l4.490">     for (let buddy of this._buddies) {</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-      for (let accountBuddy of buddy._accounts)</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+      for (let accountBuddy of buddy._accounts) {</span>
<a href="#l4.493"></a><span id="l4.493">         accountBuddy.serverAlias = aNewAlias;</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+      }</span>
<a href="#l4.495"></a><span id="l4.495">     }</span>
<a href="#l4.496"></a><span id="l4.496">     return aNewAlias;</span>
<a href="#l4.497"></a><span id="l4.497">   },</span>
<a href="#l4.498"></a><span id="l4.498">   _ensureNotDummy() {</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-    if (this._id &gt;= 0)</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+    if (this._id &gt;= 0) {</span>
<a href="#l4.501"></a><span id="l4.501">       return;</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+    }</span>
<a href="#l4.503"></a><span id="l4.503"> </span>
<a href="#l4.504"></a><span id="l4.504">     // Create a real contact for this dummy contact</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-    let statement = DBConn.createStatement(&quot;INSERT INTO contacts DEFAULT VALUES&quot;);</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+      &quot;INSERT INTO contacts DEFAULT VALUES&quot;</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+    );</span>
<a href="#l4.509"></a><span id="l4.509">     try {</span>
<a href="#l4.510"></a><span id="l4.510">       statement.execute();</span>
<a href="#l4.511"></a><span id="l4.511">     } finally {</span>
<a href="#l4.512"></a><span id="l4.512">       statement.finalize();</span>
<a href="#l4.513"></a><span id="l4.513">     }</span>
<a href="#l4.514"></a><span id="l4.514">     delete ContactsById[this._id];</span>
<a href="#l4.515"></a><span id="l4.515">     let oldId = this._id;</span>
<a href="#l4.516"></a><span id="l4.516">     this._id = DBConn.lastInsertRowID;</span>
<a href="#l4.517"></a><span id="l4.517">     ContactsById[this._id] = this;</span>
<a href="#l4.518"></a><span id="l4.518">     this._notifyObservers(&quot;no-longer-dummy&quot;, oldId.toString());</span>
<a href="#l4.519"></a><span id="l4.519">     // Update the contact_id for the single existing buddy of this contact</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-    statement = DBConn.createStatement(&quot;UPDATE buddies SET contact_id = :id WHERE id = :buddy_id&quot;);</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+      &quot;UPDATE buddies SET contact_id = :id WHERE id = :buddy_id&quot;</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+    );</span>
<a href="#l4.524"></a><span id="l4.524">     statement.params.id = this._id;</span>
<a href="#l4.525"></a><span id="l4.525">     statement.params.buddy_id = this._buddies[0].id;</span>
<a href="#l4.526"></a><span id="l4.526">     executeAsyncThenFinalize(statement);</span>
<a href="#l4.527"></a><span id="l4.527">   },</span>
<a href="#l4.528"></a><span id="l4.528"> </span>
<a href="#l4.529"></a><span id="l4.529">   getTags(aTagCount) {</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-    if (aTagCount)</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+    if (aTagCount) {</span>
<a href="#l4.532"></a><span id="l4.532">       aTagCount.value = this._tags.length;</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+    }</span>
<a href="#l4.534"></a><span id="l4.534">     return this._tags;</span>
<a href="#l4.535"></a><span id="l4.535">   },</span>
<a href="#l4.536"></a><span id="l4.536">   addTag(aTag, aInherited) {</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-    if (this.hasTag(aTag))</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+    if (this.hasTag(aTag)) {</span>
<a href="#l4.539"></a><span id="l4.539">       return;</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+    }</span>
<a href="#l4.541"></a><span id="l4.541"> </span>
<a href="#l4.542"></a><span id="l4.542">     if (!aInherited) {</span>
<a href="#l4.543"></a><span id="l4.543">       this._ensureNotDummy();</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-      let statement =</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-        DBConn.createStatement(&quot;INSERT INTO contact_tag (contact_id, tag_id) &quot; +</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-                               &quot;VALUES(:contactId, :tagId)&quot;);</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+      let statement = DBConn.createStatement(</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+        &quot;INSERT INTO contact_tag (contact_id, tag_id) &quot; +</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+          &quot;VALUES(:contactId, :tagId)&quot;</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+      );</span>
<a href="#l4.551"></a><span id="l4.551">       statement.params.contactId = this.id;</span>
<a href="#l4.552"></a><span id="l4.552">       statement.params.tagId = aTag.id;</span>
<a href="#l4.553"></a><span id="l4.553">       executeAsyncThenFinalize(statement);</span>
<a href="#l4.554"></a><span id="l4.554">     }</span>
<a href="#l4.555"></a><span id="l4.555"> </span>
<a href="#l4.556"></a><span id="l4.556">     aTag = TagsById[aTag.id];</span>
<a href="#l4.557"></a><span id="l4.557">     this._tags.push(aTag);</span>
<a href="#l4.558"></a><span id="l4.558">     aTag._addContact(this);</span>
<a href="#l4.559"></a><span id="l4.559"> </span>
<a href="#l4.560"></a><span id="l4.560">     aTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-    for (let observer of this._observers)</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l4.563"></a><span id="l4.563">       observer.observe(aTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+    }</span>
<a href="#l4.565"></a><span id="l4.565">     Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aTag.id);</span>
<a href="#l4.566"></a><span id="l4.566">   },</span>
<a href="#l4.567"></a><span id="l4.567">   /* Remove a tag from the local tags of the contact. */</span>
<a href="#l4.568"></a><span id="l4.568">   _removeTag(aTag) {</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineminus">-    if (!this.hasTag(aTag) || this._isTagInherited(aTag))</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+    if (!this.hasTag(aTag) || this._isTagInherited(aTag)) {</span>
<a href="#l4.571"></a><span id="l4.571">       return;</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+    }</span>
<a href="#l4.573"></a><span id="l4.573"> </span>
<a href="#l4.574"></a><span id="l4.574">     this._removeContactTagRow(aTag);</span>
<a href="#l4.575"></a><span id="l4.575"> </span>
<a href="#l4.576"></a><span id="l4.576">     this._tags = this._tags.filter(tag =&gt; tag.id != aTag.id);</span>
<a href="#l4.577"></a><span id="l4.577">     aTag = TagsById[aTag.id];</span>
<a href="#l4.578"></a><span id="l4.578">     aTag._removeContact(this);</span>
<a href="#l4.579"></a><span id="l4.579"> </span>
<a href="#l4.580"></a><span id="l4.580">     aTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-    for (let observer of this._observers)</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l4.583"></a><span id="l4.583">       observer.observe(aTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+    }</span>
<a href="#l4.585"></a><span id="l4.585">     Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aTag.id);</span>
<a href="#l4.586"></a><span id="l4.586">   },</span>
<a href="#l4.587"></a><span id="l4.587">   _removeContactTagRow(aTag) {</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-    let statement = DBConn.createStatement(&quot;DELETE FROM contact_tag &quot; +</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineminus">-                                           &quot;WHERE contact_id = :contactId &quot; +</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-                                           &quot;AND tag_id = :tagId&quot;);</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+      &quot;DELETE FROM contact_tag &quot; +</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+        &quot;WHERE contact_id = :contactId &quot; +</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+        &quot;AND tag_id = :tagId&quot;</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+    );</span>
<a href="#l4.596"></a><span id="l4.596">     statement.params.contactId = this.id;</span>
<a href="#l4.597"></a><span id="l4.597">     statement.params.tagId = aTag.id;</span>
<a href="#l4.598"></a><span id="l4.598">     executeAsyncThenFinalize(statement);</span>
<a href="#l4.599"></a><span id="l4.599">   },</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineminus">-  hasTag(aTag) { return this._tags.some((t =&gt; t.id == aTag.id)); },</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+  hasTag(aTag) {</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+    return this._tags.some(t =&gt; t.id == aTag.id);</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+  },</span>
<a href="#l4.604"></a><span id="l4.604">   _massMove: false,</span>
<a href="#l4.605"></a><span id="l4.605">   removeTag(aTag) {</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-    if (!this.hasTag(aTag))</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-      throw new Error(&quot;Attempting to remove a tag that the contact doesn't have&quot;);</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-    if (this._tags.length == 1)</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+    if (!this.hasTag(aTag)) {</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+      throw new Error(</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+        &quot;Attempting to remove a tag that the contact doesn't have&quot;</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+      );</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+    }</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+    if (this._tags.length == 1) {</span>
<a href="#l4.615"></a><span id="l4.615">       throw new Error(&quot;Attempting to remove the last tag of a contact&quot;);</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+    }</span>
<a href="#l4.617"></a><span id="l4.617"> </span>
<a href="#l4.618"></a><span id="l4.618">     this._massMove = true;</span>
<a href="#l4.619"></a><span id="l4.619">     let hasTag = this.hasTag.bind(this);</span>
<a href="#l4.620"></a><span id="l4.620">     let newTag = this._tags[this._tags[0].id != aTag.id ? 0 : 1];</span>
<a href="#l4.621"></a><span id="l4.621">     let moved = false;</span>
<a href="#l4.622"></a><span id="l4.622">     this._buddies.forEach(function(aBuddy) {</span>
<a href="#l4.623"></a><span id="l4.623">       aBuddy._accounts.forEach(function(aAccountBuddy) {</span>
<a href="#l4.624"></a><span id="l4.624">         if (aAccountBuddy.tag.id == aTag.id) {</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineminus">-          if (aBuddy._accounts.some(ab =&gt;</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineminus">-               ab.account.numericId == aAccountBuddy.account.numericId &amp;&amp;</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineminus">-               ab.tag.id != aTag.id &amp;&amp; hasTag(ab.tag))) {</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+          if (</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+            aBuddy._accounts.some(</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+              ab =&gt;</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+                ab.account.numericId == aAccountBuddy.account.numericId &amp;&amp;</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineplus">+                ab.tag.id != aTag.id &amp;&amp;</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+                hasTag(ab.tag)</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+            )</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+          ) {</span>
<a href="#l4.636"></a><span id="l4.636">             // A buddy that already has an accountBuddy of the same</span>
<a href="#l4.637"></a><span id="l4.637">             // account with another tag of the contact shouldn't be</span>
<a href="#l4.638"></a><span id="l4.638">             // moved to newTag, just remove the accountBuddy</span>
<a href="#l4.639"></a><span id="l4.639">             // associated to the tag we are removing.</span>
<a href="#l4.640"></a><span id="l4.640">             aAccountBuddy.remove();</span>
<a href="#l4.641"></a><span id="l4.641">             moved = true;</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineminus">-          }</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineminus">-          else {</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+          } else {</span>
<a href="#l4.645"></a><span id="l4.645">             try {</span>
<a href="#l4.646"></a><span id="l4.646">               aAccountBuddy.tag = newTag;</span>
<a href="#l4.647"></a><span id="l4.647">               moved = true;</span>
<a href="#l4.648"></a><span id="l4.648">             } catch (e) {</span>
<a href="#l4.649"></a><span id="l4.649">               // Ignore failures. Some protocol plugins may not implement this.</span>
<a href="#l4.650"></a><span id="l4.650">             }</span>
<a href="#l4.651"></a><span id="l4.651">           }</span>
<a href="#l4.652"></a><span id="l4.652">         }</span>
<a href="#l4.653"></a><span id="l4.653">       });</span>
<a href="#l4.654"></a><span id="l4.654">     });</span>
<a href="#l4.655"></a><span id="l4.655">     this._massMove = false;</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-    if (moved)</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+    if (moved) {</span>
<a href="#l4.658"></a><span id="l4.658">       this._moved(aTag, newTag);</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineminus">-    else {</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+    } else {</span>
<a href="#l4.661"></a><span id="l4.661">       // If we are here, the old tag is not inherited from a buddy, so</span>
<a href="#l4.662"></a><span id="l4.662">       // just remove the local tag.</span>
<a href="#l4.663"></a><span id="l4.663">       this._removeTag(aTag);</span>
<a href="#l4.664"></a><span id="l4.664">     }</span>
<a href="#l4.665"></a><span id="l4.665">   },</span>
<a href="#l4.666"></a><span id="l4.666">   _isTagInherited(aTag) {</span>
<a href="#l4.667"></a><span id="l4.667">     for (let buddy of this._buddies) {</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-      for (let accountBuddy of buddy._accounts)</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-        if (accountBuddy.tag.id == aTag.id)</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+      for (let accountBuddy of buddy._accounts) {</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+        if (accountBuddy.tag.id == aTag.id) {</span>
<a href="#l4.672"></a><span id="l4.672">           return true;</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineplus">+        }</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineplus">+      }</span>
<a href="#l4.675"></a><span id="l4.675">     }</span>
<a href="#l4.676"></a><span id="l4.676">     return false;</span>
<a href="#l4.677"></a><span id="l4.677">   },</span>
<a href="#l4.678"></a><span id="l4.678">   _moved(aOldTag, aNewTag) {</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineminus">-    if (this._massMove)</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+    if (this._massMove) {</span>
<a href="#l4.681"></a><span id="l4.681">       return;</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+    }</span>
<a href="#l4.683"></a><span id="l4.683"> </span>
<a href="#l4.684"></a><span id="l4.684">     // Avoid xpconnect wrappers.</span>
<a href="#l4.685"></a><span id="l4.685">     aNewTag = aNewTag &amp;&amp; TagsById[aNewTag.id];</span>
<a href="#l4.686"></a><span id="l4.686">     aOldTag = aOldTag &amp;&amp; TagsById[aOldTag.id];</span>
<a href="#l4.687"></a><span id="l4.687"> </span>
<a href="#l4.688"></a><span id="l4.688">     // Decide what we need to do. Return early if nothing to do.</span>
<a href="#l4.689"></a><span id="l4.689">     let shouldRemove =</span>
<a href="#l4.690"></a><span id="l4.690">       aOldTag &amp;&amp; this.hasTag(aOldTag) &amp;&amp; !this._isTagInherited(aOldTag);</span>
<a href="#l4.691"></a><span id="l4.691">     let shouldAdd =</span>
<a href="#l4.692"></a><span id="l4.692">       aNewTag &amp;&amp; !this.hasTag(aNewTag) &amp;&amp; this._isTagInherited(aNewTag);</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineminus">-    if (!shouldRemove &amp;&amp; !shouldAdd)</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+    if (!shouldRemove &amp;&amp; !shouldAdd) {</span>
<a href="#l4.695"></a><span id="l4.695">       return;</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+    }</span>
<a href="#l4.697"></a><span id="l4.697"> </span>
<a href="#l4.698"></a><span id="l4.698">     // Apply the changes.</span>
<a href="#l4.699"></a><span id="l4.699">     let tags = this._tags;</span>
<a href="#l4.700"></a><span id="l4.700">     if (shouldRemove) {</span>
<a href="#l4.701"></a><span id="l4.701">       tags = tags.filter(aTag =&gt; aTag.id != aOldTag.id);</span>
<a href="#l4.702"></a><span id="l4.702">       aOldTag._removeContact(this);</span>
<a href="#l4.703"></a><span id="l4.703">     }</span>
<a href="#l4.704"></a><span id="l4.704">     if (shouldAdd) {</span>
<a href="#l4.705"></a><span id="l4.705">       tags.push(aNewTag);</span>
<a href="#l4.706"></a><span id="l4.706">       aNewTag._addContact(this);</span>
<a href="#l4.707"></a><span id="l4.707">     }</span>
<a href="#l4.708"></a><span id="l4.708">     this._tags = tags;</span>
<a href="#l4.709"></a><span id="l4.709"> </span>
<a href="#l4.710"></a><span id="l4.710">     // Finally, notify of the changes.</span>
<a href="#l4.711"></a><span id="l4.711">     if (shouldRemove) {</span>
<a href="#l4.712"></a><span id="l4.712">       aOldTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-      for (let observer of this._observers)</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+      for (let observer of this._observers) {</span>
<a href="#l4.715"></a><span id="l4.715">         observer.observe(aOldTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineplus">+      }</span>
<a href="#l4.717"></a><span id="l4.717">       Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aOldTag.id);</span>
<a href="#l4.718"></a><span id="l4.718">     }</span>
<a href="#l4.719"></a><span id="l4.719">     if (shouldAdd) {</span>
<a href="#l4.720"></a><span id="l4.720">       aNewTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineminus">-      for (let observer of this._observers)</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+      for (let observer of this._observers) {</span>
<a href="#l4.723"></a><span id="l4.723">         observer.observe(aNewTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+      }</span>
<a href="#l4.725"></a><span id="l4.725">       Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aNewTag.id);</span>
<a href="#l4.726"></a><span id="l4.726">     }</span>
<a href="#l4.727"></a><span id="l4.727">     Services.obs.notifyObservers(this, &quot;contact-moved&quot;);</span>
<a href="#l4.728"></a><span id="l4.728">   },</span>
<a href="#l4.729"></a><span id="l4.729"> </span>
<a href="#l4.730"></a><span id="l4.730">   getBuddies(aBuddyCount) {</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineminus">-    if (aBuddyCount)</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+    if (aBuddyCount) {</span>
<a href="#l4.733"></a><span id="l4.733">       aBuddyCount.value = this._buddies.length;</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineplus">+    }</span>
<a href="#l4.735"></a><span id="l4.735">     return this._buddies;</span>
<a href="#l4.736"></a><span id="l4.736">   },</span>
<a href="#l4.737"></a><span id="l4.737">   get _empty() {</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineminus">-    return this._buddies.length == 0 ||</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineminus">-           this._buddies.every(b =&gt; b._empty);</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineplus">+    return this._buddies.length == 0 || this._buddies.every(b =&gt; b._empty);</span>
<a href="#l4.741"></a><span id="l4.741">   },</span>
<a href="#l4.742"></a><span id="l4.742"> </span>
<a href="#l4.743"></a><span id="l4.743">   mergeContact(aContact) {</span>
<a href="#l4.744"></a><span id="l4.744">     // Avoid merging the contact with itself or merging into an</span>
<a href="#l4.745"></a><span id="l4.745">     // already removed contact.</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineminus">-    if (aContact.id == this.id || !(this.id in ContactsById))</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineplus">+    if (aContact.id == this.id || !(this.id in ContactsById)) {</span>
<a href="#l4.748"></a><span id="l4.748">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineplus">+    }</span>
<a href="#l4.750"></a><span id="l4.750"> </span>
<a href="#l4.751"></a><span id="l4.751">     this._ensureNotDummy();</span>
<a href="#l4.752"></a><span id="l4.752">     let contact = ContactsById[aContact.id]; // remove XPConnect wrapper</span>
<a href="#l4.753"></a><span id="l4.753"> </span>
<a href="#l4.754"></a><span id="l4.754">     // Copy all the contact-only tags first, otherwise they would be lost.</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineminus">-    for (let tag of contact.getTags())</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineminus">-      if (!contact._isTagInherited(tag))</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineplus">+    for (let tag of contact.getTags()) {</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineplus">+      if (!contact._isTagInherited(tag)) {</span>
<a href="#l4.759"></a><span id="l4.759">         this.addTag(tag);</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+      }</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+    }</span>
<a href="#l4.762"></a><span id="l4.762"> </span>
<a href="#l4.763"></a><span id="l4.763">     // Adopt each buddy. Removing the last one will delete the contact.</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineminus">-    for (let buddy of contact.getBuddies())</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+    for (let buddy of contact.getBuddies()) {</span>
<a href="#l4.766"></a><span id="l4.766">       buddy.contact = this;</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineplus">+    }</span>
<a href="#l4.768"></a><span id="l4.768">     this._updatePreferredBuddy();</span>
<a href="#l4.769"></a><span id="l4.769">   },</span>
<a href="#l4.770"></a><span id="l4.770">   moveBuddyBefore(aBuddy, aBeforeBuddy) {</span>
<a href="#l4.771"></a><span id="l4.771">     let buddy = BuddiesById[aBuddy.id]; // remove XPConnect wrapper</span>
<a href="#l4.772"></a><span id="l4.772">     let oldPosition = this._buddies.indexOf(buddy);</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineminus">-    if (oldPosition == -1)</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineplus">+    if (oldPosition == -1) {</span>
<a href="#l4.775"></a><span id="l4.775">       throw new Error(&quot;aBuddy isn't attached to this contact&quot;);</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineplus">+    }</span>
<a href="#l4.777"></a><span id="l4.777"> </span>
<a href="#l4.778"></a><span id="l4.778">     let newPosition = -1;</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineminus">-    if (aBeforeBuddy)</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineplus">+    if (aBeforeBuddy) {</span>
<a href="#l4.781"></a><span id="l4.781">       newPosition = this._buddies.indexOf(BuddiesById[aBeforeBuddy.id]);</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-    if (newPosition == -1)</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+    }</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+    if (newPosition == -1) {</span>
<a href="#l4.785"></a><span id="l4.785">       newPosition = this._buddies.length - 1;</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+    }</span>
<a href="#l4.787"></a><span id="l4.787"> </span>
<a href="#l4.788"></a><span id="l4.788" class="difflineminus">-    if (oldPosition == newPosition)</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineplus">+    if (oldPosition == newPosition) {</span>
<a href="#l4.790"></a><span id="l4.790">       return;</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineplus">+    }</span>
<a href="#l4.792"></a><span id="l4.792"> </span>
<a href="#l4.793"></a><span id="l4.793">     this._buddies.splice(oldPosition, 1);</span>
<a href="#l4.794"></a><span id="l4.794">     this._buddies.splice(newPosition, 0, buddy);</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineminus">-    this._updatePositions(Math.min(oldPosition, newPosition),</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineminus">-                          Math.max(oldPosition, newPosition));</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineplus">+    this._updatePositions(</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineplus">+      Math.min(oldPosition, newPosition),</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+      Math.max(oldPosition, newPosition)</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineplus">+    );</span>
<a href="#l4.801"></a><span id="l4.801">     buddy._notifyObservers(&quot;position-changed&quot;, String(newPosition));</span>
<a href="#l4.802"></a><span id="l4.802">     this._updatePreferredBuddy(buddy);</span>
<a href="#l4.803"></a><span id="l4.803">   },</span>
<a href="#l4.804"></a><span id="l4.804">   adoptBuddy(aBuddy) {</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineminus">-    if (aBuddy.contact.id == this.id)</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+    if (aBuddy.contact.id == this.id) {</span>
<a href="#l4.807"></a><span id="l4.807">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+    }</span>
<a href="#l4.809"></a><span id="l4.809"> </span>
<a href="#l4.810"></a><span id="l4.810">     let buddy = BuddiesById[aBuddy.id]; // remove XPConnect wrapper</span>
<a href="#l4.811"></a><span id="l4.811">     buddy.contact = this;</span>
<a href="#l4.812"></a><span id="l4.812">     this._updatePreferredBuddy(buddy);</span>
<a href="#l4.813"></a><span id="l4.813">   },</span>
<a href="#l4.814"></a><span id="l4.814">   _massRemove: false,</span>
<a href="#l4.815"></a><span id="l4.815">   _removeBuddy(aBuddy) {</span>
<a href="#l4.816"></a><span id="l4.816">     if (this._buddies.length == 1) {</span>
<a href="#l4.817"></a><span id="l4.817">       if (this._id &gt; 0) {</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineminus">-        let statement =</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineminus">-          DBConn.createStatement(&quot;DELETE FROM contacts WHERE id = :id&quot;);</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineplus">+        let statement = DBConn.createStatement(</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+          &quot;DELETE FROM contacts WHERE id = :id&quot;</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineplus">+        );</span>
<a href="#l4.823"></a><span id="l4.823">         statement.params.id = this._id;</span>
<a href="#l4.824"></a><span id="l4.824">         executeAsyncThenFinalize(statement);</span>
<a href="#l4.825"></a><span id="l4.825">       }</span>
<a href="#l4.826"></a><span id="l4.826">       this._notifyObservers(&quot;removed&quot;);</span>
<a href="#l4.827"></a><span id="l4.827">       delete ContactsById[this._id];</span>
<a href="#l4.828"></a><span id="l4.828"> </span>
<a href="#l4.829"></a><span id="l4.829" class="difflineminus">-      for (let tag of this._tags)</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineplus">+      for (let tag of this._tags) {</span>
<a href="#l4.831"></a><span id="l4.831">         tag._removeContact(this);</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineminus">-      let statement =</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineminus">-        DBConn.createStatement(&quot;DELETE FROM contact_tag WHERE contact_id = :id&quot;);</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+      }</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+      let statement = DBConn.createStatement(</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+        &quot;DELETE FROM contact_tag WHERE contact_id = :id&quot;</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+      );</span>
<a href="#l4.838"></a><span id="l4.838">       statement.params.id = this._id;</span>
<a href="#l4.839"></a><span id="l4.839">       executeAsyncThenFinalize(statement);</span>
<a href="#l4.840"></a><span id="l4.840"> </span>
<a href="#l4.841"></a><span id="l4.841">       delete this._tags;</span>
<a href="#l4.842"></a><span id="l4.842">       delete this._buddies;</span>
<a href="#l4.843"></a><span id="l4.843">       delete this._observers;</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineminus">-    }</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineminus">-    else {</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineplus">+    } else {</span>
<a href="#l4.847"></a><span id="l4.847">       let index = this._buddies.indexOf(aBuddy);</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineminus">-      if (index == -1)</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineplus">+      if (index == -1) {</span>
<a href="#l4.850"></a><span id="l4.850">         throw new Error(&quot;Removing an unknown buddy from contact &quot; + this._id);</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineplus">+      }</span>
<a href="#l4.852"></a><span id="l4.852"> </span>
<a href="#l4.853"></a><span id="l4.853">       this._buddies = this._buddies.filter(b =&gt; b !== aBuddy);</span>
<a href="#l4.854"></a><span id="l4.854"> </span>
<a href="#l4.855"></a><span id="l4.855">       // If we are actually removing the whole contact, don't bother updating</span>
<a href="#l4.856"></a><span id="l4.856">       // the positions or the preferred buddy.</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineminus">-      if (this._massRemove)</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineplus">+      if (this._massRemove) {</span>
<a href="#l4.859"></a><span id="l4.859">         return;</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineplus">+      }</span>
<a href="#l4.861"></a><span id="l4.861"> </span>
<a href="#l4.862"></a><span id="l4.862">       // No position to update if the removed buddy is at the last position.</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineminus">-      if (index &lt; this._buddies.length)</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+      if (index &lt; this._buddies.length) {</span>
<a href="#l4.865"></a><span id="l4.865">         this._updatePositions(index);</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineplus">+      }</span>
<a href="#l4.867"></a><span id="l4.867"> </span>
<a href="#l4.868"></a><span id="l4.868" class="difflineminus">-      if (this._preferredBuddy.id == aBuddy.id)</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+      if (this._preferredBuddy.id == aBuddy.id) {</span>
<a href="#l4.870"></a><span id="l4.870">         this._updatePreferredBuddy();</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineplus">+      }</span>
<a href="#l4.872"></a><span id="l4.872">     }</span>
<a href="#l4.873"></a><span id="l4.873">   },</span>
<a href="#l4.874"></a><span id="l4.874">   _updatePositions(aIndexBegin, aIndexEnd) {</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineminus">-    if (aIndexEnd === undefined)</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineplus">+    if (aIndexEnd === undefined) {</span>
<a href="#l4.877"></a><span id="l4.877">       aIndexEnd = this._buddies.length - 1;</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineminus">-    if (aIndexBegin &gt; aIndexEnd)</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineplus">+    }</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+    if (aIndexBegin &gt; aIndexEnd) {</span>
<a href="#l4.881"></a><span id="l4.881">       throw new Error(&quot;_updatePositions: Invalid indexes&quot;);</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+    }</span>
<a href="#l4.883"></a><span id="l4.883"> </span>
<a href="#l4.884"></a><span id="l4.884" class="difflineminus">-    let statement =</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineminus">-      DBConn.createStatement(&quot;UPDATE buddies SET position = :position &quot; +</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineminus">-                             &quot;WHERE id = :buddyId&quot;);</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineplus">+      &quot;UPDATE buddies SET position = :position &quot; + &quot;WHERE id = :buddyId&quot;</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineplus">+    );</span>
<a href="#l4.890"></a><span id="l4.890">     for (let i = aIndexBegin; i &lt;= aIndexEnd; ++i) {</span>
<a href="#l4.891"></a><span id="l4.891">       statement.params.position = i;</span>
<a href="#l4.892"></a><span id="l4.892">       statement.params.buddyId = this._buddies[i].id;</span>
<a href="#l4.893"></a><span id="l4.893">       statement.executeAsync();</span>
<a href="#l4.894"></a><span id="l4.894">     }</span>
<a href="#l4.895"></a><span id="l4.895">     statement.finalize();</span>
<a href="#l4.896"></a><span id="l4.896">   },</span>
<a href="#l4.897"></a><span id="l4.897"> </span>
<a href="#l4.898"></a><span id="l4.898">   detachBuddy(aBuddy) {</span>
<a href="#l4.899"></a><span id="l4.899">     // Should return a new contact with the same list of tags.</span>
<a href="#l4.900"></a><span id="l4.900">     let buddy = BuddiesById[aBuddy.id];</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineminus">-    if (buddy.contact.id != this.id)</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineplus">+    if (buddy.contact.id != this.id) {</span>
<a href="#l4.903"></a><span id="l4.903">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineminus">-    if (buddy.contact._buddies.length == 1)</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineplus">+    }</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineplus">+    if (buddy.contact._buddies.length == 1) {</span>
<a href="#l4.907"></a><span id="l4.907">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineplus">+    }</span>
<a href="#l4.909"></a><span id="l4.909"> </span>
<a href="#l4.910"></a><span id="l4.910">     // Save the list of tags, it may be destoyed if the buddy was the last one.</span>
<a href="#l4.911"></a><span id="l4.911">     let tags = buddy.contact.getTags();</span>
<a href="#l4.912"></a><span id="l4.912"> </span>
<a href="#l4.913"></a><span id="l4.913">     // Create a new dummy contact and use it for the detached buddy.</span>
<a href="#l4.914"></a><span id="l4.914">     buddy.contact = new Contact();</span>
<a href="#l4.915"></a><span id="l4.915">     buddy.contact._notifyObservers(&quot;added&quot;);</span>
<a href="#l4.916"></a><span id="l4.916"> </span>
<a href="#l4.917"></a><span id="l4.917">     // The first tag was inherited during the contact setter.</span>
<a href="#l4.918"></a><span id="l4.918">     // This will copy the remaining tags.</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineminus">-    for (let tag of tags)</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineplus">+    for (let tag of tags) {</span>
<a href="#l4.921"></a><span id="l4.921">       buddy.contact.addTag(tag);</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+    }</span>
<a href="#l4.923"></a><span id="l4.923"> </span>
<a href="#l4.924"></a><span id="l4.924">     return buddy.contact;</span>
<a href="#l4.925"></a><span id="l4.925">   },</span>
<a href="#l4.926"></a><span id="l4.926">   remove() {</span>
<a href="#l4.927"></a><span id="l4.927">     this._massRemove = true;</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineminus">-    for (let buddy of this._buddies)</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l4.930"></a><span id="l4.930">       buddy.remove();</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineplus">+    }</span>
<a href="#l4.932"></a><span id="l4.932">   },</span>
<a href="#l4.933"></a><span id="l4.933"> </span>
<a href="#l4.934"></a><span id="l4.934">   // imIStatusInfo implementation</span>
<a href="#l4.935"></a><span id="l4.935">   _preferredBuddy: null,</span>
<a href="#l4.936"></a><span id="l4.936">   get preferredBuddy() {</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineminus">-    if (!this._preferredBuddy)</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineplus">+    if (!this._preferredBuddy) {</span>
<a href="#l4.939"></a><span id="l4.939">       this._updatePreferredBuddy();</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineplus">+    }</span>
<a href="#l4.941"></a><span id="l4.941">     return this._preferredBuddy;</span>
<a href="#l4.942"></a><span id="l4.942">   },</span>
<a href="#l4.943"></a><span id="l4.943">   set preferredBuddy(aBuddy) {</span>
<a href="#l4.944"></a><span id="l4.944">     let shouldNotify = this._preferredBuddy != null;</span>
<a href="#l4.945"></a><span id="l4.945">     let oldDisplayName =</span>
<a href="#l4.946"></a><span id="l4.946">       this._preferredBuddy &amp;&amp; this._preferredBuddy.displayName;</span>
<a href="#l4.947"></a><span id="l4.947">     this._preferredBuddy = aBuddy;</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineminus">-    if (shouldNotify)</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+    if (shouldNotify) {</span>
<a href="#l4.950"></a><span id="l4.950">       this._notifyObservers(&quot;preferred-buddy-changed&quot;);</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineminus">-    if (oldDisplayName &amp;&amp; this._preferredBuddy.displayName != oldDisplayName)</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineplus">+    }</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineplus">+    if (oldDisplayName &amp;&amp; this._preferredBuddy.displayName != oldDisplayName) {</span>
<a href="#l4.954"></a><span id="l4.954">       this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+    }</span>
<a href="#l4.956"></a><span id="l4.956">     this._updateStatus();</span>
<a href="#l4.957"></a><span id="l4.957">   },</span>
<a href="#l4.958"></a><span id="l4.958">   // aBuddy indicate which buddy's availability has changed.</span>
<a href="#l4.959"></a><span id="l4.959">   _updatePreferredBuddy(aBuddy) {</span>
<a href="#l4.960"></a><span id="l4.960">     if (aBuddy) {</span>
<a href="#l4.961"></a><span id="l4.961">       aBuddy = BuddiesById[aBuddy.id]; // remove potential XPConnect wrapper</span>
<a href="#l4.962"></a><span id="l4.962"> </span>
<a href="#l4.963"></a><span id="l4.963">       if (!this._preferredBuddy) {</span>
<a href="#l4.964"></a><span id="l4.964">         this.preferredBuddy = aBuddy;</span>
<a href="#l4.965"></a><span id="l4.965">         return;</span>
<a href="#l4.966"></a><span id="l4.966">       }</span>
<a href="#l4.967"></a><span id="l4.967"> </span>
<a href="#l4.968"></a><span id="l4.968">       if (aBuddy.id == this._preferredBuddy.id) {</span>
<a href="#l4.969"></a><span id="l4.969">         // The suggested buddy is already preferred, check if its</span>
<a href="#l4.970"></a><span id="l4.970">         // availability has changed.</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineminus">-        if (aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineminus">-            (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineminus">-             aBuddy.availabilityDetails &gt;= this._availabilityDetails)) {</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineplus">+        if (</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineplus">+          aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineplus">+          (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineplus">+            aBuddy.availabilityDetails &gt;= this._availabilityDetails)</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineplus">+        ) {</span>
<a href="#l4.979"></a><span id="l4.979">           // keep the currently preferred buddy, only update the status.</span>
<a href="#l4.980"></a><span id="l4.980">           this._updateStatus();</span>
<a href="#l4.981"></a><span id="l4.981">           return;</span>
<a href="#l4.982"></a><span id="l4.982">         }</span>
<a href="#l4.983"></a><span id="l4.983">         // We aren't sure that the currently preferred buddy should</span>
<a href="#l4.984"></a><span id="l4.984">         // still be preferred. Let's go through the list!</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineminus">-      }</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineminus">-      else {</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineplus">+      } else {</span>
<a href="#l4.988"></a><span id="l4.988">         // The suggested buddy is not currently preferred. If it is</span>
<a href="#l4.989"></a><span id="l4.989">         // more available or at a better position, prefer it!</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineminus">-        if (aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineminus">-            (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineminus">-             (aBuddy.availabilityDetails &gt; this._availabilityDetails ||</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineplus">+        if (</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineplus">+          aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineplus">+          (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineplus">+            (aBuddy.availabilityDetails &gt; this._availabilityDetails ||</span>
<a href="#l4.997"></a><span id="l4.997">               (aBuddy.availabilityDetails == this._availabilityDetails &amp;&amp;</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineminus">-               this._buddies.indexOf(aBuddy) &lt; this._buddies.indexOf(this.preferredBuddy)))))</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineplus">+                this._buddies.indexOf(aBuddy) &lt;</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineplus">+                  this._buddies.indexOf(this.preferredBuddy))))</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineplus">+        ) {</span>
<a href="#l4.1002"></a><span id="l4.1002">           this.preferredBuddy = aBuddy;</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineplus">+        }</span>
<a href="#l4.1004"></a><span id="l4.1004">         return;</span>
<a href="#l4.1005"></a><span id="l4.1005">       }</span>
<a href="#l4.1006"></a><span id="l4.1006">     }</span>
<a href="#l4.1007"></a><span id="l4.1007"> </span>
<a href="#l4.1008"></a><span id="l4.1008">     let preferred;</span>
<a href="#l4.1009"></a><span id="l4.1009">     // |this._buddies| is ordered by user preference, so in case of</span>
<a href="#l4.1010"></a><span id="l4.1010">     // equal availability, keep the current value of |preferred|.</span>
<a href="#l4.1011"></a><span id="l4.1011">     for (let buddy of this._buddies) {</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineminus">-      if (!preferred || preferred.statusType &lt; buddy.statusType ||</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineminus">-          (preferred.statusType == buddy.statusType &amp;&amp;</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineminus">-           preferred.availabilityDetails &lt; buddy.availabilityDetails))</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineplus">+      if (</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineplus">+        !preferred ||</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineplus">+        preferred.statusType &lt; buddy.statusType ||</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineplus">+        (preferred.statusType == buddy.statusType &amp;&amp;</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineplus">+          preferred.availabilityDetails &lt; buddy.availabilityDetails)</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineplus">+      ) {</span>
<a href="#l4.1021"></a><span id="l4.1021">         preferred = buddy;</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineplus">+      }</span>
<a href="#l4.1023"></a><span id="l4.1023">     }</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineminus">-    if (preferred &amp;&amp; (!this._preferredBuddy ||</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineminus">-                      preferred.id != this._preferredBuddy.id))</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+    if (</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineplus">+      preferred &amp;&amp;</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineplus">+      (!this._preferredBuddy || preferred.id != this._preferredBuddy.id)</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineplus">+    ) {</span>
<a href="#l4.1030"></a><span id="l4.1030">       this.preferredBuddy = preferred;</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineplus">+    }</span>
<a href="#l4.1032"></a><span id="l4.1032">   },</span>
<a href="#l4.1033"></a><span id="l4.1033">   _updateStatus() {</span>
<a href="#l4.1034"></a><span id="l4.1034">     let buddy = this._preferredBuddy; // for convenience</span>
<a href="#l4.1035"></a><span id="l4.1035"> </span>
<a href="#l4.1036"></a><span id="l4.1036">     // Decide which notifications should be fired.</span>
<a href="#l4.1037"></a><span id="l4.1037">     let notifications = [];</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineminus">-    if (this._statusType != buddy.statusType ||</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineminus">-        this._availabilityDetails != buddy.availabilityDetails)</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineplus">+    if (</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineplus">+      this._statusType != buddy.statusType ||</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineplus">+      this._availabilityDetails != buddy.availabilityDetails</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+    ) {</span>
<a href="#l4.1044"></a><span id="l4.1044">       notifications.push(&quot;availability-changed&quot;);</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineminus">-    if (this._statusType != buddy.statusType ||</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineminus">-        this._statusText != buddy.statusText) {</span>
<a href="#l4.1047"></a><span id="l4.1047" class="difflineplus">+    }</span>
<a href="#l4.1048"></a><span id="l4.1048" class="difflineplus">+    if (</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineplus">+      this._statusType != buddy.statusType ||</span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineplus">+      this._statusText != buddy.statusText</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineplus">+    ) {</span>
<a href="#l4.1052"></a><span id="l4.1052">       notifications.push(&quot;status-changed&quot;);</span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineminus">-      if (this.online &amp;&amp; buddy.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineplus">+      if (this.online &amp;&amp; buddy.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l4.1055"></a><span id="l4.1055">         notifications.push(&quot;signed-off&quot;);</span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineminus">-      if (!this.online &amp;&amp; buddy.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineplus">+      }</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineplus">+      if (!this.online &amp;&amp; buddy.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l4.1059"></a><span id="l4.1059">         notifications.push(&quot;signed-on&quot;);</span>
<a href="#l4.1060"></a><span id="l4.1060" class="difflineplus">+      }</span>
<a href="#l4.1061"></a><span id="l4.1061">     }</span>
<a href="#l4.1062"></a><span id="l4.1062"> </span>
<a href="#l4.1063"></a><span id="l4.1063">     // Actually change the stored status.</span>
<a href="#l4.1064"></a><span id="l4.1064" class="difflineminus">-    [this._statusType, this._statusText, this._availabilityDetails] =</span>
<a href="#l4.1065"></a><span id="l4.1065" class="difflineminus">-      [buddy.statusType, buddy.statusText, buddy.availabilityDetails];</span>
<a href="#l4.1066"></a><span id="l4.1066" class="difflineplus">+    [this._statusType, this._statusText, this._availabilityDetails] = [</span>
<a href="#l4.1067"></a><span id="l4.1067" class="difflineplus">+      buddy.statusType,</span>
<a href="#l4.1068"></a><span id="l4.1068" class="difflineplus">+      buddy.statusText,</span>
<a href="#l4.1069"></a><span id="l4.1069" class="difflineplus">+      buddy.availabilityDetails,</span>
<a href="#l4.1070"></a><span id="l4.1070" class="difflineplus">+    ];</span>
<a href="#l4.1071"></a><span id="l4.1071"> </span>
<a href="#l4.1072"></a><span id="l4.1072">     // Fire the notifications.</span>
<a href="#l4.1073"></a><span id="l4.1073">     notifications.forEach(function(aTopic) {</span>
<a href="#l4.1074"></a><span id="l4.1074">       this._notifyObservers(aTopic);</span>
<a href="#l4.1075"></a><span id="l4.1075">     }, this);</span>
<a href="#l4.1076"></a><span id="l4.1076">   },</span>
<a href="#l4.1077"></a><span id="l4.1077" class="difflineminus">-  get displayName() { return this._alias || this.preferredBuddy.displayName; },</span>
<a href="#l4.1078"></a><span id="l4.1078" class="difflineminus">-  get buddyIconFilename() { return this.preferredBuddy.buddyIconFilename; },</span>
<a href="#l4.1079"></a><span id="l4.1079" class="difflineplus">+  get displayName() {</span>
<a href="#l4.1080"></a><span id="l4.1080" class="difflineplus">+    return this._alias || this.preferredBuddy.displayName;</span>
<a href="#l4.1081"></a><span id="l4.1081" class="difflineplus">+  },</span>
<a href="#l4.1082"></a><span id="l4.1082" class="difflineplus">+  get buddyIconFilename() {</span>
<a href="#l4.1083"></a><span id="l4.1083" class="difflineplus">+    return this.preferredBuddy.buddyIconFilename;</span>
<a href="#l4.1084"></a><span id="l4.1084" class="difflineplus">+  },</span>
<a href="#l4.1085"></a><span id="l4.1085">   _statusType: 0,</span>
<a href="#l4.1086"></a><span id="l4.1086" class="difflineminus">-  get statusType() { return this._statusType; },</span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineminus">-  get online() { return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE; },</span>
<a href="#l4.1088"></a><span id="l4.1088" class="difflineminus">-  get available() { return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE; },</span>
<a href="#l4.1089"></a><span id="l4.1089" class="difflineminus">-  get idle() { return this.statusType == Ci.imIStatusInfo.STATUS_IDLE; },</span>
<a href="#l4.1090"></a><span id="l4.1090" class="difflineminus">-  get mobile() { return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE; },</span>
<a href="#l4.1091"></a><span id="l4.1091" class="difflineplus">+  get statusType() {</span>
<a href="#l4.1092"></a><span id="l4.1092" class="difflineplus">+    return this._statusType;</span>
<a href="#l4.1093"></a><span id="l4.1093" class="difflineplus">+  },</span>
<a href="#l4.1094"></a><span id="l4.1094" class="difflineplus">+  get online() {</span>
<a href="#l4.1095"></a><span id="l4.1095" class="difflineplus">+    return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l4.1096"></a><span id="l4.1096" class="difflineplus">+  },</span>
<a href="#l4.1097"></a><span id="l4.1097" class="difflineplus">+  get available() {</span>
<a href="#l4.1098"></a><span id="l4.1098" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l4.1099"></a><span id="l4.1099" class="difflineplus">+  },</span>
<a href="#l4.1100"></a><span id="l4.1100" class="difflineplus">+  get idle() {</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l4.1102"></a><span id="l4.1102" class="difflineplus">+  },</span>
<a href="#l4.1103"></a><span id="l4.1103" class="difflineplus">+  get mobile() {</span>
<a href="#l4.1104"></a><span id="l4.1104" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l4.1105"></a><span id="l4.1105" class="difflineplus">+  },</span>
<a href="#l4.1106"></a><span id="l4.1106">   _statusText: &quot;&quot;,</span>
<a href="#l4.1107"></a><span id="l4.1107" class="difflineminus">-  get statusText() { return this._statusText; },</span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineplus">+  get statusText() {</span>
<a href="#l4.1109"></a><span id="l4.1109" class="difflineplus">+    return this._statusText;</span>
<a href="#l4.1110"></a><span id="l4.1110" class="difflineplus">+  },</span>
<a href="#l4.1111"></a><span id="l4.1111">   _availabilityDetails: 0,</span>
<a href="#l4.1112"></a><span id="l4.1112" class="difflineminus">-  get availabilityDetails() { return this._availabilityDetails; },</span>
<a href="#l4.1113"></a><span id="l4.1113" class="difflineminus">-  get canSendMessage() { return this.preferredBuddy.canSendMessage; },</span>
<a href="#l4.1114"></a><span id="l4.1114" class="difflineplus">+  get availabilityDetails() {</span>
<a href="#l4.1115"></a><span id="l4.1115" class="difflineplus">+    return this._availabilityDetails;</span>
<a href="#l4.1116"></a><span id="l4.1116" class="difflineplus">+  },</span>
<a href="#l4.1117"></a><span id="l4.1117" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l4.1118"></a><span id="l4.1118" class="difflineplus">+    return this.preferredBuddy.canSendMessage;</span>
<a href="#l4.1119"></a><span id="l4.1119" class="difflineplus">+  },</span>
<a href="#l4.1120"></a><span id="l4.1120">   // XXX should we list the buddies in the tooltip?</span>
<a href="#l4.1121"></a><span id="l4.1121" class="difflineminus">-  getTooltipInfo() { return this.preferredBuddy.getTooltipInfo(); },</span>
<a href="#l4.1122"></a><span id="l4.1122" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l4.1123"></a><span id="l4.1123" class="difflineplus">+    return this.preferredBuddy.getTooltipInfo();</span>
<a href="#l4.1124"></a><span id="l4.1124" class="difflineplus">+  },</span>
<a href="#l4.1125"></a><span id="l4.1125">   createConversation() {</span>
<a href="#l4.1126"></a><span id="l4.1126">     let uiConv = Services.conversations.getUIConversationByContactId(this.id);</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineminus">-    if (uiConv)</span>
<a href="#l4.1128"></a><span id="l4.1128" class="difflineplus">+    if (uiConv) {</span>
<a href="#l4.1129"></a><span id="l4.1129">       return uiConv.target;</span>
<a href="#l4.1130"></a><span id="l4.1130" class="difflineplus">+    }</span>
<a href="#l4.1131"></a><span id="l4.1131">     return this.preferredBuddy.createConversation();</span>
<a href="#l4.1132"></a><span id="l4.1132">   },</span>
<a href="#l4.1133"></a><span id="l4.1133"> </span>
<a href="#l4.1134"></a><span id="l4.1134">   addObserver(aObserver) {</span>
<a href="#l4.1135"></a><span id="l4.1135" class="difflineminus">-    if (!this._observers.includes(aObserver))</span>
<a href="#l4.1136"></a><span id="l4.1136" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l4.1137"></a><span id="l4.1137">       this._observers.push(aObserver);</span>
<a href="#l4.1138"></a><span id="l4.1138" class="difflineplus">+    }</span>
<a href="#l4.1139"></a><span id="l4.1139">   },</span>
<a href="#l4.1140"></a><span id="l4.1140">   removeObserver(aObserver) {</span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_observers&quot;))</span>
<a href="#l4.1142"></a><span id="l4.1142" class="difflineplus">+    if (!this.hasOwnProperty(&quot;_observers&quot;)) {</span>
<a href="#l4.1143"></a><span id="l4.1143">       return;</span>
<a href="#l4.1144"></a><span id="l4.1144" class="difflineplus">+    }</span>
<a href="#l4.1145"></a><span id="l4.1145"> </span>
<a href="#l4.1146"></a><span id="l4.1146">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l4.1147"></a><span id="l4.1147">   },</span>
<a href="#l4.1148"></a><span id="l4.1148">   // internal calls + calls from add-ons</span>
<a href="#l4.1149"></a><span id="l4.1149">   notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l4.1150"></a><span id="l4.1150" class="difflineminus">-    for (let observer of this._observers)</span>
<a href="#l4.1151"></a><span id="l4.1151" class="difflineminus">-      if (&quot;observe&quot; in observer) // avoid failing on destructed XBL bindings...</span>
<a href="#l4.1152"></a><span id="l4.1152" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l4.1153"></a><span id="l4.1153" class="difflineplus">+      if (&quot;observe&quot; in observer) {</span>
<a href="#l4.1154"></a><span id="l4.1154" class="difflineplus">+        // avoid failing on destructed XBL bindings...</span>
<a href="#l4.1155"></a><span id="l4.1155">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l4.1156"></a><span id="l4.1156" class="difflineminus">-    for (let tag of this._tags)</span>
<a href="#l4.1157"></a><span id="l4.1157" class="difflineplus">+      }</span>
<a href="#l4.1158"></a><span id="l4.1158" class="difflineplus">+    }</span>
<a href="#l4.1159"></a><span id="l4.1159" class="difflineplus">+    for (let tag of this._tags) {</span>
<a href="#l4.1160"></a><span id="l4.1160">       tag.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l4.1161"></a><span id="l4.1161" class="difflineplus">+    }</span>
<a href="#l4.1162"></a><span id="l4.1162">     Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l4.1163"></a><span id="l4.1163">   },</span>
<a href="#l4.1164"></a><span id="l4.1164">   _notifyObservers(aTopic, aData) {</span>
<a href="#l4.1165"></a><span id="l4.1165">     this.notifyObservers(this, &quot;contact-&quot; + aTopic, aData);</span>
<a href="#l4.1166"></a><span id="l4.1166">   },</span>
<a href="#l4.1167"></a><span id="l4.1167"> </span>
<a href="#l4.1168"></a><span id="l4.1168">   // This is called by the imIBuddy implementations.</span>
<a href="#l4.1169"></a><span id="l4.1169">   _observe(aSubject, aTopic, aData) {</span>
<a href="#l4.1170"></a><span id="l4.1170" class="difflineat">@@ -877,261 +1048,355 @@ Contact.prototype = {</span>
<a href="#l4.1171"></a><span id="l4.1171"> </span>
<a href="#l4.1172"></a><span id="l4.1172">     let isPreferredBuddy =</span>
<a href="#l4.1173"></a><span id="l4.1173">       aSubject instanceof Buddy &amp;&amp; aSubject.id == this.preferredBuddy.id;</span>
<a href="#l4.1174"></a><span id="l4.1174">     switch (aTopic) {</span>
<a href="#l4.1175"></a><span id="l4.1175">       case &quot;buddy-availability-changed&quot;:</span>
<a href="#l4.1176"></a><span id="l4.1176">         this._updatePreferredBuddy(aSubject);</span>
<a href="#l4.1177"></a><span id="l4.1177">         break;</span>
<a href="#l4.1178"></a><span id="l4.1178">       case &quot;buddy-status-changed&quot;:</span>
<a href="#l4.1179"></a><span id="l4.1179" class="difflineminus">-        if (isPreferredBuddy)</span>
<a href="#l4.1180"></a><span id="l4.1180" class="difflineplus">+        if (isPreferredBuddy) {</span>
<a href="#l4.1181"></a><span id="l4.1181">           this._updateStatus();</span>
<a href="#l4.1182"></a><span id="l4.1182" class="difflineplus">+        }</span>
<a href="#l4.1183"></a><span id="l4.1183">         break;</span>
<a href="#l4.1184"></a><span id="l4.1184">       case &quot;buddy-display-name-changed&quot;:</span>
<a href="#l4.1185"></a><span id="l4.1185" class="difflineminus">-        if (isPreferredBuddy &amp;&amp; !this._alias)</span>
<a href="#l4.1186"></a><span id="l4.1186" class="difflineplus">+        if (isPreferredBuddy &amp;&amp; !this._alias) {</span>
<a href="#l4.1187"></a><span id="l4.1187">           this._notifyObservers(&quot;display-name-changed&quot;, aData);</span>
<a href="#l4.1188"></a><span id="l4.1188" class="difflineplus">+        }</span>
<a href="#l4.1189"></a><span id="l4.1189">         break;</span>
<a href="#l4.1190"></a><span id="l4.1190">       case &quot;buddy-icon-changed&quot;:</span>
<a href="#l4.1191"></a><span id="l4.1191" class="difflineminus">-        if (isPreferredBuddy)</span>
<a href="#l4.1192"></a><span id="l4.1192" class="difflineplus">+        if (isPreferredBuddy) {</span>
<a href="#l4.1193"></a><span id="l4.1193">           this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l4.1194"></a><span id="l4.1194" class="difflineplus">+        }</span>
<a href="#l4.1195"></a><span id="l4.1195">         break;</span>
<a href="#l4.1196"></a><span id="l4.1196">       case &quot;buddy-added&quot;:</span>
<a href="#l4.1197"></a><span id="l4.1197">         // Currently buddies are always added in dummy empty contacts,</span>
<a href="#l4.1198"></a><span id="l4.1198">         // later we may want to check this._buddies.length == 1.</span>
<a href="#l4.1199"></a><span id="l4.1199">         this._notifyObservers(&quot;added&quot;);</span>
<a href="#l4.1200"></a><span id="l4.1200">         break;</span>
<a href="#l4.1201"></a><span id="l4.1201">       case &quot;buddy-removed&quot;:</span>
<a href="#l4.1202"></a><span id="l4.1202">         this._removeBuddy(aSubject);</span>
<a href="#l4.1203"></a><span id="l4.1203">     }</span>
<a href="#l4.1204"></a><span id="l4.1204">   },</span>
<a href="#l4.1205"></a><span id="l4.1205"> };</span>
<a href="#l4.1206"></a><span id="l4.1206"> </span>
<a href="#l4.1207"></a><span id="l4.1207" class="difflineminus">-var BuddiesById = { };</span>
<a href="#l4.1208"></a><span id="l4.1208" class="difflineplus">+var BuddiesById = {};</span>
<a href="#l4.1209"></a><span id="l4.1209"> function Buddy(aId, aKey, aName, aSrvAlias, aContactId) {</span>
<a href="#l4.1210"></a><span id="l4.1210">   this._id = aId;</span>
<a href="#l4.1211"></a><span id="l4.1211">   this._key = aKey;</span>
<a href="#l4.1212"></a><span id="l4.1212">   this._name = aName;</span>
<a href="#l4.1213"></a><span id="l4.1213" class="difflineminus">-  if (aSrvAlias)</span>
<a href="#l4.1214"></a><span id="l4.1214" class="difflineplus">+  if (aSrvAlias) {</span>
<a href="#l4.1215"></a><span id="l4.1215">     this._srvAlias = aSrvAlias;</span>
<a href="#l4.1216"></a><span id="l4.1216" class="difflineplus">+  }</span>
<a href="#l4.1217"></a><span id="l4.1217">   this._accounts = [];</span>
<a href="#l4.1218"></a><span id="l4.1218">   this._observers = [];</span>
<a href="#l4.1219"></a><span id="l4.1219"> </span>
<a href="#l4.1220"></a><span id="l4.1220" class="difflineminus">-  if (aContactId)</span>
<a href="#l4.1221"></a><span id="l4.1221" class="difflineplus">+  if (aContactId) {</span>
<a href="#l4.1222"></a><span id="l4.1222">     this._contact = ContactsById[aContactId];</span>
<a href="#l4.1223"></a><span id="l4.1223" class="difflineplus">+  }</span>
<a href="#l4.1224"></a><span id="l4.1224">   // Avoid failure if aContactId was invalid.</span>
<a href="#l4.1225"></a><span id="l4.1225" class="difflineminus">-  if (!this._contact)</span>
<a href="#l4.1226"></a><span id="l4.1226" class="difflineplus">+  if (!this._contact) {</span>
<a href="#l4.1227"></a><span id="l4.1227">     this._contact = new Contact(null, null);</span>
<a href="#l4.1228"></a><span id="l4.1228" class="difflineplus">+  }</span>
<a href="#l4.1229"></a><span id="l4.1229"> </span>
<a href="#l4.1230"></a><span id="l4.1230">   this._contact._buddies.push(this);</span>
<a href="#l4.1231"></a><span id="l4.1231"> </span>
<a href="#l4.1232"></a><span id="l4.1232">   BuddiesById[this._id] = this;</span>
<a href="#l4.1233"></a><span id="l4.1233"> }</span>
<a href="#l4.1234"></a><span id="l4.1234"> Buddy.prototype = {</span>
<a href="#l4.1235"></a><span id="l4.1235">   __proto__: ClassInfo(&quot;imIBuddy&quot;, &quot;Buddy&quot;),</span>
<a href="#l4.1236"></a><span id="l4.1236" class="difflineminus">-  get id() { return this._id; },</span>
<a href="#l4.1237"></a><span id="l4.1237" class="difflineplus">+  get id() {</span>
<a href="#l4.1238"></a><span id="l4.1238" class="difflineplus">+    return this._id;</span>
<a href="#l4.1239"></a><span id="l4.1239" class="difflineplus">+  },</span>
<a href="#l4.1240"></a><span id="l4.1240">   destroy() {</span>
<a href="#l4.1241"></a><span id="l4.1241" class="difflineminus">-    for (let ab of this._accounts)</span>
<a href="#l4.1242"></a><span id="l4.1242" class="difflineplus">+    for (let ab of this._accounts) {</span>
<a href="#l4.1243"></a><span id="l4.1243">       ab.unInit();</span>
<a href="#l4.1244"></a><span id="l4.1244" class="difflineplus">+    }</span>
<a href="#l4.1245"></a><span id="l4.1245">     delete this._accounts;</span>
<a href="#l4.1246"></a><span id="l4.1246">     delete this._observers;</span>
<a href="#l4.1247"></a><span id="l4.1247">     delete this._preferredAccount;</span>
<a href="#l4.1248"></a><span id="l4.1248">   },</span>
<a href="#l4.1249"></a><span id="l4.1249" class="difflineminus">-  get protocol() { return this._accounts[0].account.protocol; },</span>
<a href="#l4.1250"></a><span id="l4.1250" class="difflineminus">-  get userName() { return this._name; },</span>
<a href="#l4.1251"></a><span id="l4.1251" class="difflineminus">-  get normalizedName() { return this._key; },</span>
<a href="#l4.1252"></a><span id="l4.1252" class="difflineplus">+  get protocol() {</span>
<a href="#l4.1253"></a><span id="l4.1253" class="difflineplus">+    return this._accounts[0].account.protocol;</span>
<a href="#l4.1254"></a><span id="l4.1254" class="difflineplus">+  },</span>
<a href="#l4.1255"></a><span id="l4.1255" class="difflineplus">+  get userName() {</span>
<a href="#l4.1256"></a><span id="l4.1256" class="difflineplus">+    return this._name;</span>
<a href="#l4.1257"></a><span id="l4.1257" class="difflineplus">+  },</span>
<a href="#l4.1258"></a><span id="l4.1258" class="difflineplus">+  get normalizedName() {</span>
<a href="#l4.1259"></a><span id="l4.1259" class="difflineplus">+    return this._key;</span>
<a href="#l4.1260"></a><span id="l4.1260" class="difflineplus">+  },</span>
<a href="#l4.1261"></a><span id="l4.1261">   _srvAlias: &quot;&quot;,</span>
<a href="#l4.1262"></a><span id="l4.1262">   _contact: null,</span>
<a href="#l4.1263"></a><span id="l4.1263" class="difflineminus">-  get contact() { return this._contact; },</span>
<a href="#l4.1264"></a><span id="l4.1264" class="difflineplus">+  get contact() {</span>
<a href="#l4.1265"></a><span id="l4.1265" class="difflineplus">+    return this._contact;</span>
<a href="#l4.1266"></a><span id="l4.1266" class="difflineplus">+  },</span>
<a href="#l4.1267"></a><span id="l4.1267">   set contact(aContact) /* not in imIBuddy */ {</span>
<a href="#l4.1268"></a><span id="l4.1268" class="difflineminus">-    if (aContact.id == this._contact.id)</span>
<a href="#l4.1269"></a><span id="l4.1269" class="difflineplus">+    if (aContact.id == this._contact.id) {</span>
<a href="#l4.1270"></a><span id="l4.1270">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l4.1271"></a><span id="l4.1271" class="difflineplus">+    }</span>
<a href="#l4.1272"></a><span id="l4.1272"> </span>
<a href="#l4.1273"></a><span id="l4.1273">     this._notifyObservers(&quot;moved-out-of-contact&quot;);</span>
<a href="#l4.1274"></a><span id="l4.1274">     this._contact._removeBuddy(this);</span>
<a href="#l4.1275"></a><span id="l4.1275"> </span>
<a href="#l4.1276"></a><span id="l4.1276">     this._contact = aContact;</span>
<a href="#l4.1277"></a><span id="l4.1277">     this._contact._buddies.push(this);</span>
<a href="#l4.1278"></a><span id="l4.1278"> </span>
<a href="#l4.1279"></a><span id="l4.1279">     // Ensure all the inherited tags are in the new contact.</span>
<a href="#l4.1280"></a><span id="l4.1280" class="difflineminus">-    for (let accountBuddy of this._accounts)</span>
<a href="#l4.1281"></a><span id="l4.1281" class="difflineplus">+    for (let accountBuddy of this._accounts) {</span>
<a href="#l4.1282"></a><span id="l4.1282">       this._contact.addTag(TagsById[accountBuddy.tag.id], true);</span>
<a href="#l4.1283"></a><span id="l4.1283" class="difflineplus">+    }</span>
<a href="#l4.1284"></a><span id="l4.1284"> </span>
<a href="#l4.1285"></a><span id="l4.1285" class="difflineminus">-    let statement =</span>
<a href="#l4.1286"></a><span id="l4.1286" class="difflineminus">-      DBConn.createStatement(&quot;UPDATE buddies SET contact_id = :contactId, &quot; +</span>
<a href="#l4.1287"></a><span id="l4.1287" class="difflineminus">-                             &quot;position = :position &quot; +</span>
<a href="#l4.1288"></a><span id="l4.1288" class="difflineminus">-                             &quot;WHERE id = :buddyId&quot;);</span>
<a href="#l4.1289"></a><span id="l4.1289" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.1290"></a><span id="l4.1290" class="difflineplus">+      &quot;UPDATE buddies SET contact_id = :contactId, &quot; +</span>
<a href="#l4.1291"></a><span id="l4.1291" class="difflineplus">+        &quot;position = :position &quot; +</span>
<a href="#l4.1292"></a><span id="l4.1292" class="difflineplus">+        &quot;WHERE id = :buddyId&quot;</span>
<a href="#l4.1293"></a><span id="l4.1293" class="difflineplus">+    );</span>
<a href="#l4.1294"></a><span id="l4.1294">     statement.params.contactId = aContact.id &gt; 0 ? aContact.id : 0;</span>
<a href="#l4.1295"></a><span id="l4.1295">     statement.params.position = aContact._buddies.length - 1;</span>
<a href="#l4.1296"></a><span id="l4.1296">     statement.params.buddyId = this.id;</span>
<a href="#l4.1297"></a><span id="l4.1297">     executeAsyncThenFinalize(statement);</span>
<a href="#l4.1298"></a><span id="l4.1298"> </span>
<a href="#l4.1299"></a><span id="l4.1299">     this._notifyObservers(&quot;moved-into-contact&quot;);</span>
<a href="#l4.1300"></a><span id="l4.1300">     return aContact;</span>
<a href="#l4.1301"></a><span id="l4.1301">   },</span>
<a href="#l4.1302"></a><span id="l4.1302">   _hasAccountBuddy(aAccountId, aTagId) {</span>
<a href="#l4.1303"></a><span id="l4.1303">     for (let ab of this._accounts) {</span>
<a href="#l4.1304"></a><span id="l4.1304" class="difflineminus">-      if (ab.account.numericId == aAccountId &amp;&amp; ab.tag.id == aTagId)</span>
<a href="#l4.1305"></a><span id="l4.1305" class="difflineplus">+      if (ab.account.numericId == aAccountId &amp;&amp; ab.tag.id == aTagId) {</span>
<a href="#l4.1306"></a><span id="l4.1306">         return true;</span>
<a href="#l4.1307"></a><span id="l4.1307" class="difflineplus">+      }</span>
<a href="#l4.1308"></a><span id="l4.1308">     }</span>
<a href="#l4.1309"></a><span id="l4.1309">     return false;</span>
<a href="#l4.1310"></a><span id="l4.1310">   },</span>
<a href="#l4.1311"></a><span id="l4.1311">   getAccountBuddies(aAccountBuddyCount) {</span>
<a href="#l4.1312"></a><span id="l4.1312" class="difflineminus">-    if (aAccountBuddyCount)</span>
<a href="#l4.1313"></a><span id="l4.1313" class="difflineplus">+    if (aAccountBuddyCount) {</span>
<a href="#l4.1314"></a><span id="l4.1314">       aAccountBuddyCount.value = this._accounts.length;</span>
<a href="#l4.1315"></a><span id="l4.1315" class="difflineplus">+    }</span>
<a href="#l4.1316"></a><span id="l4.1316">     return this._accounts;</span>
<a href="#l4.1317"></a><span id="l4.1317">   },</span>
<a href="#l4.1318"></a><span id="l4.1318"> </span>
<a href="#l4.1319"></a><span id="l4.1319">   _addAccount(aAccountBuddy, aTag) {</span>
<a href="#l4.1320"></a><span id="l4.1320">     this._accounts.push(aAccountBuddy);</span>
<a href="#l4.1321"></a><span id="l4.1321">     let contact = this._contact;</span>
<a href="#l4.1322"></a><span id="l4.1322">     if (!this._contact._tags.includes(aTag)) {</span>
<a href="#l4.1323"></a><span id="l4.1323">       this._contact._tags.push(aTag);</span>
<a href="#l4.1324"></a><span id="l4.1324">       aTag._addContact(contact);</span>
<a href="#l4.1325"></a><span id="l4.1325">     }</span>
<a href="#l4.1326"></a><span id="l4.1326"> </span>
<a href="#l4.1327"></a><span id="l4.1327" class="difflineminus">-    if (!this._preferredAccount)</span>
<a href="#l4.1328"></a><span id="l4.1328" class="difflineplus">+    if (!this._preferredAccount) {</span>
<a href="#l4.1329"></a><span id="l4.1329">       this._preferredAccount = aAccountBuddy;</span>
<a href="#l4.1330"></a><span id="l4.1330" class="difflineplus">+    }</span>
<a href="#l4.1331"></a><span id="l4.1331">   },</span>
<a href="#l4.1332"></a><span id="l4.1332" class="difflineminus">-  get _empty() { return this._accounts.length == 0; },</span>
<a href="#l4.1333"></a><span id="l4.1333" class="difflineplus">+  get _empty() {</span>
<a href="#l4.1334"></a><span id="l4.1334" class="difflineplus">+    return this._accounts.length == 0;</span>
<a href="#l4.1335"></a><span id="l4.1335" class="difflineplus">+  },</span>
<a href="#l4.1336"></a><span id="l4.1336"> </span>
<a href="#l4.1337"></a><span id="l4.1337">   remove() {</span>
<a href="#l4.1338"></a><span id="l4.1338" class="difflineminus">-    for (let account of this._accounts)</span>
<a href="#l4.1339"></a><span id="l4.1339" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l4.1340"></a><span id="l4.1340">       account.remove();</span>
<a href="#l4.1341"></a><span id="l4.1341" class="difflineplus">+    }</span>
<a href="#l4.1342"></a><span id="l4.1342">   },</span>
<a href="#l4.1343"></a><span id="l4.1343"> </span>
<a href="#l4.1344"></a><span id="l4.1344">   // imIStatusInfo implementation</span>
<a href="#l4.1345"></a><span id="l4.1345">   _preferredAccount: null,</span>
<a href="#l4.1346"></a><span id="l4.1346" class="difflineminus">-  get preferredAccountBuddy() { return this._preferredAccount; },</span>
<a href="#l4.1347"></a><span id="l4.1347" class="difflineplus">+  get preferredAccountBuddy() {</span>
<a href="#l4.1348"></a><span id="l4.1348" class="difflineplus">+    return this._preferredAccount;</span>
<a href="#l4.1349"></a><span id="l4.1349" class="difflineplus">+  },</span>
<a href="#l4.1350"></a><span id="l4.1350">   _isPreferredAccount(aAccountBuddy) {</span>
<a href="#l4.1351"></a><span id="l4.1351" class="difflineminus">-    if (aAccountBuddy.account.numericId != this._preferredAccount.account.numericId)</span>
<a href="#l4.1352"></a><span id="l4.1352" class="difflineplus">+    if (</span>
<a href="#l4.1353"></a><span id="l4.1353" class="difflineplus">+      aAccountBuddy.account.numericId !=</span>
<a href="#l4.1354"></a><span id="l4.1354" class="difflineplus">+      this._preferredAccount.account.numericId</span>
<a href="#l4.1355"></a><span id="l4.1355" class="difflineplus">+    ) {</span>
<a href="#l4.1356"></a><span id="l4.1356">       return false;</span>
<a href="#l4.1357"></a><span id="l4.1357" class="difflineplus">+    }</span>
<a href="#l4.1358"></a><span id="l4.1358"> </span>
<a href="#l4.1359"></a><span id="l4.1359">     // In case we have more than one accountBuddy for the same buddy</span>
<a href="#l4.1360"></a><span id="l4.1360">     // and account (possible if the buddy is in several groups on the</span>
<a href="#l4.1361"></a><span id="l4.1361">     // server), the protocol plugin may be broken and not update all</span>
<a href="#l4.1362"></a><span id="l4.1362">     // instances, so ensure we handle the notifications on the instance</span>
<a href="#l4.1363"></a><span id="l4.1363">     // that is currently being notified of a change:</span>
<a href="#l4.1364"></a><span id="l4.1364">     this._preferredAccount = aAccountBuddy;</span>
<a href="#l4.1365"></a><span id="l4.1365"> </span>
<a href="#l4.1366"></a><span id="l4.1366">     return true;</span>
<a href="#l4.1367"></a><span id="l4.1367">   },</span>
<a href="#l4.1368"></a><span id="l4.1368">   set preferredAccount(aAccount) {</span>
<a href="#l4.1369"></a><span id="l4.1369">     let oldDisplayName =</span>
<a href="#l4.1370"></a><span id="l4.1370">       this._preferredAccount &amp;&amp; this._preferredAccount.displayName;</span>
<a href="#l4.1371"></a><span id="l4.1371">     this._preferredAccount = aAccount;</span>
<a href="#l4.1372"></a><span id="l4.1372">     this._notifyObservers(&quot;preferred-account-changed&quot;);</span>
<a href="#l4.1373"></a><span id="l4.1373" class="difflineminus">-    if (oldDisplayName &amp;&amp; this._preferredAccount.displayName != oldDisplayName)</span>
<a href="#l4.1374"></a><span id="l4.1374" class="difflineplus">+    if (</span>
<a href="#l4.1375"></a><span id="l4.1375" class="difflineplus">+      oldDisplayName &amp;&amp;</span>
<a href="#l4.1376"></a><span id="l4.1376" class="difflineplus">+      this._preferredAccount.displayName != oldDisplayName</span>
<a href="#l4.1377"></a><span id="l4.1377" class="difflineplus">+    ) {</span>
<a href="#l4.1378"></a><span id="l4.1378">       this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l4.1379"></a><span id="l4.1379" class="difflineplus">+    }</span>
<a href="#l4.1380"></a><span id="l4.1380">     this._updateStatus();</span>
<a href="#l4.1381"></a><span id="l4.1381">   },</span>
<a href="#l4.1382"></a><span id="l4.1382">   // aAccount indicate which account's availability has changed.</span>
<a href="#l4.1383"></a><span id="l4.1383">   _updatePreferredAccount(aAccount) {</span>
<a href="#l4.1384"></a><span id="l4.1384">     if (aAccount) {</span>
<a href="#l4.1385"></a><span id="l4.1385" class="difflineminus">-      if (aAccount.account.numericId == this._preferredAccount.account.numericId) {</span>
<a href="#l4.1386"></a><span id="l4.1386" class="difflineplus">+      if (</span>
<a href="#l4.1387"></a><span id="l4.1387" class="difflineplus">+        aAccount.account.numericId == this._preferredAccount.account.numericId</span>
<a href="#l4.1388"></a><span id="l4.1388" class="difflineplus">+      ) {</span>
<a href="#l4.1389"></a><span id="l4.1389">         // The suggested account is already preferred, check if its</span>
<a href="#l4.1390"></a><span id="l4.1390">         // availability has changed.</span>
<a href="#l4.1391"></a><span id="l4.1391" class="difflineminus">-        if (aAccount.statusType &gt; this._statusType ||</span>
<a href="#l4.1392"></a><span id="l4.1392" class="difflineminus">-            (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.1393"></a><span id="l4.1393" class="difflineminus">-             aAccount.availabilityDetails &gt;= this._availabilityDetails)) {</span>
<a href="#l4.1394"></a><span id="l4.1394" class="difflineplus">+        if (</span>
<a href="#l4.1395"></a><span id="l4.1395" class="difflineplus">+          aAccount.statusType &gt; this._statusType ||</span>
<a href="#l4.1396"></a><span id="l4.1396" class="difflineplus">+          (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.1397"></a><span id="l4.1397" class="difflineplus">+            aAccount.availabilityDetails &gt;= this._availabilityDetails)</span>
<a href="#l4.1398"></a><span id="l4.1398" class="difflineplus">+        ) {</span>
<a href="#l4.1399"></a><span id="l4.1399">           // keep the currently preferred account, only update the status.</span>
<a href="#l4.1400"></a><span id="l4.1400">           this._updateStatus();</span>
<a href="#l4.1401"></a><span id="l4.1401">           return;</span>
<a href="#l4.1402"></a><span id="l4.1402">         }</span>
<a href="#l4.1403"></a><span id="l4.1403">         // We aren't sure that the currently preferred account should</span>
<a href="#l4.1404"></a><span id="l4.1404">         // still be preferred. Let's go through the list!</span>
<a href="#l4.1405"></a><span id="l4.1405" class="difflineminus">-      }</span>
<a href="#l4.1406"></a><span id="l4.1406" class="difflineminus">-      else {</span>
<a href="#l4.1407"></a><span id="l4.1407" class="difflineplus">+      } else {</span>
<a href="#l4.1408"></a><span id="l4.1408">         // The suggested account is not currently preferred. If it is</span>
<a href="#l4.1409"></a><span id="l4.1409">         // more available, prefer it!</span>
<a href="#l4.1410"></a><span id="l4.1410" class="difflineminus">-        if (aAccount.statusType &gt; this._statusType ||</span>
<a href="#l4.1411"></a><span id="l4.1411" class="difflineminus">-            (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.1412"></a><span id="l4.1412" class="difflineminus">-             aAccount.availabilityDetails &gt; this._availabilityDetails))</span>
<a href="#l4.1413"></a><span id="l4.1413" class="difflineplus">+        if (</span>
<a href="#l4.1414"></a><span id="l4.1414" class="difflineplus">+          aAccount.statusType &gt; this._statusType ||</span>
<a href="#l4.1415"></a><span id="l4.1415" class="difflineplus">+          (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l4.1416"></a><span id="l4.1416" class="difflineplus">+            aAccount.availabilityDetails &gt; this._availabilityDetails)</span>
<a href="#l4.1417"></a><span id="l4.1417" class="difflineplus">+        ) {</span>
<a href="#l4.1418"></a><span id="l4.1418">           this.preferredAccount = aAccount;</span>
<a href="#l4.1419"></a><span id="l4.1419" class="difflineplus">+        }</span>
<a href="#l4.1420"></a><span id="l4.1420">         return;</span>
<a href="#l4.1421"></a><span id="l4.1421">       }</span>
<a href="#l4.1422"></a><span id="l4.1422">     }</span>
<a href="#l4.1423"></a><span id="l4.1423"> </span>
<a href="#l4.1424"></a><span id="l4.1424">     let preferred;</span>
<a href="#l4.1425"></a><span id="l4.1425">     // TODO take into account the order of the account-manager list.</span>
<a href="#l4.1426"></a><span id="l4.1426">     for (let account of this._accounts) {</span>
<a href="#l4.1427"></a><span id="l4.1427" class="difflineminus">-      if (!preferred || preferred.statusType &lt; account.statusType ||</span>
<a href="#l4.1428"></a><span id="l4.1428" class="difflineminus">-          (preferred.statusType == account.statusType &amp;&amp;</span>
<a href="#l4.1429"></a><span id="l4.1429" class="difflineminus">-           preferred.availabilityDetails &lt; account.availabilityDetails))</span>
<a href="#l4.1430"></a><span id="l4.1430" class="difflineplus">+      if (</span>
<a href="#l4.1431"></a><span id="l4.1431" class="difflineplus">+        !preferred ||</span>
<a href="#l4.1432"></a><span id="l4.1432" class="difflineplus">+        preferred.statusType &lt; account.statusType ||</span>
<a href="#l4.1433"></a><span id="l4.1433" class="difflineplus">+        (preferred.statusType == account.statusType &amp;&amp;</span>
<a href="#l4.1434"></a><span id="l4.1434" class="difflineplus">+          preferred.availabilityDetails &lt; account.availabilityDetails)</span>
<a href="#l4.1435"></a><span id="l4.1435" class="difflineplus">+      ) {</span>
<a href="#l4.1436"></a><span id="l4.1436">         preferred = account;</span>
<a href="#l4.1437"></a><span id="l4.1437" class="difflineplus">+      }</span>
<a href="#l4.1438"></a><span id="l4.1438">     }</span>
<a href="#l4.1439"></a><span id="l4.1439">     if (!this._preferredAccount) {</span>
<a href="#l4.1440"></a><span id="l4.1440" class="difflineminus">-      if (preferred)</span>
<a href="#l4.1441"></a><span id="l4.1441" class="difflineplus">+      if (preferred) {</span>
<a href="#l4.1442"></a><span id="l4.1442">         this.preferredAccount = preferred;</span>
<a href="#l4.1443"></a><span id="l4.1443" class="difflineplus">+      }</span>
<a href="#l4.1444"></a><span id="l4.1444">       return;</span>
<a href="#l4.1445"></a><span id="l4.1445">     }</span>
<a href="#l4.1446"></a><span id="l4.1446" class="difflineminus">-    if (preferred.account.numericId != this._preferredAccount.account.numericId)</span>
<a href="#l4.1447"></a><span id="l4.1447" class="difflineplus">+    if (</span>
<a href="#l4.1448"></a><span id="l4.1448" class="difflineplus">+      preferred.account.numericId != this._preferredAccount.account.numericId</span>
<a href="#l4.1449"></a><span id="l4.1449" class="difflineplus">+    ) {</span>
<a href="#l4.1450"></a><span id="l4.1450">       this.preferredAccount = preferred;</span>
<a href="#l4.1451"></a><span id="l4.1451" class="difflineminus">-    else</span>
<a href="#l4.1452"></a><span id="l4.1452" class="difflineplus">+    } else {</span>
<a href="#l4.1453"></a><span id="l4.1453">       this._updateStatus();</span>
<a href="#l4.1454"></a><span id="l4.1454" class="difflineplus">+    }</span>
<a href="#l4.1455"></a><span id="l4.1455">   },</span>
<a href="#l4.1456"></a><span id="l4.1456">   _updateStatus() {</span>
<a href="#l4.1457"></a><span id="l4.1457">     let account = this._preferredAccount; // for convenience</span>
<a href="#l4.1458"></a><span id="l4.1458"> </span>
<a href="#l4.1459"></a><span id="l4.1459">     // Decide which notifications should be fired.</span>
<a href="#l4.1460"></a><span id="l4.1460">     let notifications = [];</span>
<a href="#l4.1461"></a><span id="l4.1461" class="difflineminus">-    if (this._statusType != account.statusType ||</span>
<a href="#l4.1462"></a><span id="l4.1462" class="difflineminus">-        this._availabilityDetails != account.availabilityDetails)</span>
<a href="#l4.1463"></a><span id="l4.1463" class="difflineplus">+    if (</span>
<a href="#l4.1464"></a><span id="l4.1464" class="difflineplus">+      this._statusType != account.statusType ||</span>
<a href="#l4.1465"></a><span id="l4.1465" class="difflineplus">+      this._availabilityDetails != account.availabilityDetails</span>
<a href="#l4.1466"></a><span id="l4.1466" class="difflineplus">+    ) {</span>
<a href="#l4.1467"></a><span id="l4.1467">       notifications.push(&quot;availability-changed&quot;);</span>
<a href="#l4.1468"></a><span id="l4.1468" class="difflineminus">-    if (this._statusType != account.statusType ||</span>
<a href="#l4.1469"></a><span id="l4.1469" class="difflineminus">-        this._statusText != account.statusText) {</span>
<a href="#l4.1470"></a><span id="l4.1470" class="difflineplus">+    }</span>
<a href="#l4.1471"></a><span id="l4.1471" class="difflineplus">+    if (</span>
<a href="#l4.1472"></a><span id="l4.1472" class="difflineplus">+      this._statusType != account.statusType ||</span>
<a href="#l4.1473"></a><span id="l4.1473" class="difflineplus">+      this._statusText != account.statusText</span>
<a href="#l4.1474"></a><span id="l4.1474" class="difflineplus">+    ) {</span>
<a href="#l4.1475"></a><span id="l4.1475">       notifications.push(&quot;status-changed&quot;);</span>
<a href="#l4.1476"></a><span id="l4.1476" class="difflineminus">-      if (this.online &amp;&amp; account.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l4.1477"></a><span id="l4.1477" class="difflineplus">+      if (</span>
<a href="#l4.1478"></a><span id="l4.1478" class="difflineplus">+        this.online &amp;&amp;</span>
<a href="#l4.1479"></a><span id="l4.1479" class="difflineplus">+        account.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l4.1480"></a><span id="l4.1480" class="difflineplus">+      ) {</span>
<a href="#l4.1481"></a><span id="l4.1481">         notifications.push(&quot;signed-off&quot;);</span>
<a href="#l4.1482"></a><span id="l4.1482" class="difflineminus">-      if (!this.online &amp;&amp; account.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l4.1483"></a><span id="l4.1483" class="difflineplus">+      }</span>
<a href="#l4.1484"></a><span id="l4.1484" class="difflineplus">+      if (</span>
<a href="#l4.1485"></a><span id="l4.1485" class="difflineplus">+        !this.online &amp;&amp;</span>
<a href="#l4.1486"></a><span id="l4.1486" class="difflineplus">+        account.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l4.1487"></a><span id="l4.1487" class="difflineplus">+      ) {</span>
<a href="#l4.1488"></a><span id="l4.1488">         notifications.push(&quot;signed-on&quot;);</span>
<a href="#l4.1489"></a><span id="l4.1489" class="difflineplus">+      }</span>
<a href="#l4.1490"></a><span id="l4.1490">     }</span>
<a href="#l4.1491"></a><span id="l4.1491"> </span>
<a href="#l4.1492"></a><span id="l4.1492">     // Actually change the stored status.</span>
<a href="#l4.1493"></a><span id="l4.1493" class="difflineminus">-    [this._statusType, this._statusText, this._availabilityDetails] =</span>
<a href="#l4.1494"></a><span id="l4.1494" class="difflineminus">-      [account.statusType, account.statusText, account.availabilityDetails];</span>
<a href="#l4.1495"></a><span id="l4.1495" class="difflineplus">+    [this._statusType, this._statusText, this._availabilityDetails] = [</span>
<a href="#l4.1496"></a><span id="l4.1496" class="difflineplus">+      account.statusType,</span>
<a href="#l4.1497"></a><span id="l4.1497" class="difflineplus">+      account.statusText,</span>
<a href="#l4.1498"></a><span id="l4.1498" class="difflineplus">+      account.availabilityDetails,</span>
<a href="#l4.1499"></a><span id="l4.1499" class="difflineplus">+    ];</span>
<a href="#l4.1500"></a><span id="l4.1500"> </span>
<a href="#l4.1501"></a><span id="l4.1501">     // Fire the notifications.</span>
<a href="#l4.1502"></a><span id="l4.1502">     notifications.forEach(function(aTopic) {</span>
<a href="#l4.1503"></a><span id="l4.1503">       this._notifyObservers(aTopic);</span>
<a href="#l4.1504"></a><span id="l4.1504">     }, this);</span>
<a href="#l4.1505"></a><span id="l4.1505">   },</span>
<a href="#l4.1506"></a><span id="l4.1506">   get displayName() {</span>
<a href="#l4.1507"></a><span id="l4.1507" class="difflineminus">-    return this._preferredAccount &amp;&amp; this._preferredAccount.displayName ||</span>
<a href="#l4.1508"></a><span id="l4.1508" class="difflineminus">-           this._srvAlias || this._name;</span>
<a href="#l4.1509"></a><span id="l4.1509" class="difflineplus">+    return (</span>
<a href="#l4.1510"></a><span id="l4.1510" class="difflineplus">+      (this._preferredAccount &amp;&amp; this._preferredAccount.displayName) ||</span>
<a href="#l4.1511"></a><span id="l4.1511" class="difflineplus">+      this._srvAlias ||</span>
<a href="#l4.1512"></a><span id="l4.1512" class="difflineplus">+      this._name</span>
<a href="#l4.1513"></a><span id="l4.1513" class="difflineplus">+    );</span>
<a href="#l4.1514"></a><span id="l4.1514">   },</span>
<a href="#l4.1515"></a><span id="l4.1515" class="difflineminus">-  get buddyIconFilename() { return this._preferredAccount.buddyIconFilename; },</span>
<a href="#l4.1516"></a><span id="l4.1516" class="difflineplus">+  get buddyIconFilename() {</span>
<a href="#l4.1517"></a><span id="l4.1517" class="difflineplus">+    return this._preferredAccount.buddyIconFilename;</span>
<a href="#l4.1518"></a><span id="l4.1518" class="difflineplus">+  },</span>
<a href="#l4.1519"></a><span id="l4.1519">   _statusType: 0,</span>
<a href="#l4.1520"></a><span id="l4.1520" class="difflineminus">-  get statusType() { return this._statusType; },</span>
<a href="#l4.1521"></a><span id="l4.1521" class="difflineminus">-  get online() { return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE; },</span>
<a href="#l4.1522"></a><span id="l4.1522" class="difflineminus">-  get available() { return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE; },</span>
<a href="#l4.1523"></a><span id="l4.1523" class="difflineminus">-  get idle() { return this.statusType == Ci.imIStatusInfo.STATUS_IDLE; },</span>
<a href="#l4.1524"></a><span id="l4.1524" class="difflineminus">-  get mobile() { return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE; },</span>
<a href="#l4.1525"></a><span id="l4.1525" class="difflineplus">+  get statusType() {</span>
<a href="#l4.1526"></a><span id="l4.1526" class="difflineplus">+    return this._statusType;</span>
<a href="#l4.1527"></a><span id="l4.1527" class="difflineplus">+  },</span>
<a href="#l4.1528"></a><span id="l4.1528" class="difflineplus">+  get online() {</span>
<a href="#l4.1529"></a><span id="l4.1529" class="difflineplus">+    return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l4.1530"></a><span id="l4.1530" class="difflineplus">+  },</span>
<a href="#l4.1531"></a><span id="l4.1531" class="difflineplus">+  get available() {</span>
<a href="#l4.1532"></a><span id="l4.1532" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l4.1533"></a><span id="l4.1533" class="difflineplus">+  },</span>
<a href="#l4.1534"></a><span id="l4.1534" class="difflineplus">+  get idle() {</span>
<a href="#l4.1535"></a><span id="l4.1535" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l4.1536"></a><span id="l4.1536" class="difflineplus">+  },</span>
<a href="#l4.1537"></a><span id="l4.1537" class="difflineplus">+  get mobile() {</span>
<a href="#l4.1538"></a><span id="l4.1538" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l4.1539"></a><span id="l4.1539" class="difflineplus">+  },</span>
<a href="#l4.1540"></a><span id="l4.1540">   _statusText: &quot;&quot;,</span>
<a href="#l4.1541"></a><span id="l4.1541" class="difflineminus">-  get statusText() { return this._statusText; },</span>
<a href="#l4.1542"></a><span id="l4.1542" class="difflineplus">+  get statusText() {</span>
<a href="#l4.1543"></a><span id="l4.1543" class="difflineplus">+    return this._statusText;</span>
<a href="#l4.1544"></a><span id="l4.1544" class="difflineplus">+  },</span>
<a href="#l4.1545"></a><span id="l4.1545">   _availabilityDetails: 0,</span>
<a href="#l4.1546"></a><span id="l4.1546" class="difflineminus">-  get availabilityDetails() { return this._availabilityDetails; },</span>
<a href="#l4.1547"></a><span id="l4.1547" class="difflineminus">-  get canSendMessage() { return this._preferredAccount.canSendMessage; },</span>
<a href="#l4.1548"></a><span id="l4.1548" class="difflineplus">+  get availabilityDetails() {</span>
<a href="#l4.1549"></a><span id="l4.1549" class="difflineplus">+    return this._availabilityDetails;</span>
<a href="#l4.1550"></a><span id="l4.1550" class="difflineplus">+  },</span>
<a href="#l4.1551"></a><span id="l4.1551" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l4.1552"></a><span id="l4.1552" class="difflineplus">+    return this._preferredAccount.canSendMessage;</span>
<a href="#l4.1553"></a><span id="l4.1553" class="difflineplus">+  },</span>
<a href="#l4.1554"></a><span id="l4.1554">   // XXX should we list the accounts in the tooltip?</span>
<a href="#l4.1555"></a><span id="l4.1555" class="difflineminus">-  getTooltipInfo() { return this._preferredAccount.getTooltipInfo(); },</span>
<a href="#l4.1556"></a><span id="l4.1556" class="difflineminus">-  createConversation() { return this._preferredAccount.createConversation(); },</span>
<a href="#l4.1557"></a><span id="l4.1557" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l4.1558"></a><span id="l4.1558" class="difflineplus">+    return this._preferredAccount.getTooltipInfo();</span>
<a href="#l4.1559"></a><span id="l4.1559" class="difflineplus">+  },</span>
<a href="#l4.1560"></a><span id="l4.1560" class="difflineplus">+  createConversation() {</span>
<a href="#l4.1561"></a><span id="l4.1561" class="difflineplus">+    return this._preferredAccount.createConversation();</span>
<a href="#l4.1562"></a><span id="l4.1562" class="difflineplus">+  },</span>
<a href="#l4.1563"></a><span id="l4.1563"> </span>
<a href="#l4.1564"></a><span id="l4.1564">   addObserver(aObserver) {</span>
<a href="#l4.1565"></a><span id="l4.1565" class="difflineminus">-    if (!this._observers.includes(aObserver))</span>
<a href="#l4.1566"></a><span id="l4.1566" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l4.1567"></a><span id="l4.1567">       this._observers.push(aObserver);</span>
<a href="#l4.1568"></a><span id="l4.1568" class="difflineplus">+    }</span>
<a href="#l4.1569"></a><span id="l4.1569">   },</span>
<a href="#l4.1570"></a><span id="l4.1570">   removeObserver(aObserver) {</span>
<a href="#l4.1571"></a><span id="l4.1571" class="difflineminus">-    if (!this._observers)</span>
<a href="#l4.1572"></a><span id="l4.1572" class="difflineplus">+    if (!this._observers) {</span>
<a href="#l4.1573"></a><span id="l4.1573">       return;</span>
<a href="#l4.1574"></a><span id="l4.1574" class="difflineplus">+    }</span>
<a href="#l4.1575"></a><span id="l4.1575">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l4.1576"></a><span id="l4.1576">   },</span>
<a href="#l4.1577"></a><span id="l4.1577">   // internal calls + calls from add-ons</span>
<a href="#l4.1578"></a><span id="l4.1578">   notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l4.1579"></a><span id="l4.1579">     try {</span>
<a href="#l4.1580"></a><span id="l4.1580" class="difflineminus">-      for (let observer of this._observers)</span>
<a href="#l4.1581"></a><span id="l4.1581" class="difflineplus">+      for (let observer of this._observers) {</span>
<a href="#l4.1582"></a><span id="l4.1582">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l4.1583"></a><span id="l4.1583" class="difflineplus">+      }</span>
<a href="#l4.1584"></a><span id="l4.1584">       this._contact._observe(aSubject, aTopic, aData);</span>
<a href="#l4.1585"></a><span id="l4.1585">     } catch (e) {</span>
<a href="#l4.1586"></a><span id="l4.1586">       Cu.reportError(e);</span>
<a href="#l4.1587"></a><span id="l4.1587">     }</span>
<a href="#l4.1588"></a><span id="l4.1588">   },</span>
<a href="#l4.1589"></a><span id="l4.1589">   _notifyObservers(aTopic, aData) {</span>
<a href="#l4.1590"></a><span id="l4.1590">     this.notifyObservers(this, &quot;buddy-&quot; + aTopic, aData);</span>
<a href="#l4.1591"></a><span id="l4.1591">   },</span>
<a href="#l4.1592"></a><span id="l4.1592" class="difflineat">@@ -1141,146 +1406,173 @@ Buddy.prototype = {</span>
<a href="#l4.1593"></a><span id="l4.1593">     // Forward the notification.</span>
<a href="#l4.1594"></a><span id="l4.1594">     this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l4.1595"></a><span id="l4.1595"> </span>
<a href="#l4.1596"></a><span id="l4.1596">     switch (aTopic) {</span>
<a href="#l4.1597"></a><span id="l4.1597">       case &quot;account-buddy-availability-changed&quot;:</span>
<a href="#l4.1598"></a><span id="l4.1598">         this._updatePreferredAccount(aSubject);</span>
<a href="#l4.1599"></a><span id="l4.1599">         break;</span>
<a href="#l4.1600"></a><span id="l4.1600">       case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l4.1601"></a><span id="l4.1601" class="difflineminus">-        if (this._isPreferredAccount(aSubject))</span>
<a href="#l4.1602"></a><span id="l4.1602" class="difflineplus">+        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l4.1603"></a><span id="l4.1603">           this._updateStatus();</span>
<a href="#l4.1604"></a><span id="l4.1604" class="difflineplus">+        }</span>
<a href="#l4.1605"></a><span id="l4.1605">         break;</span>
<a href="#l4.1606"></a><span id="l4.1606">       case &quot;account-buddy-display-name-changed&quot;:</span>
<a href="#l4.1607"></a><span id="l4.1607">         if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l4.1608"></a><span id="l4.1608">           this._srvAlias =</span>
<a href="#l4.1609"></a><span id="l4.1609">             this.displayName != this.userName ? this.displayName : &quot;&quot;;</span>
<a href="#l4.1610"></a><span id="l4.1610" class="difflineminus">-          let statement =</span>
<a href="#l4.1611"></a><span id="l4.1611" class="difflineminus">-            DBConn.createStatement(&quot;UPDATE buddies SET srv_alias = :srvAlias &quot; +</span>
<a href="#l4.1612"></a><span id="l4.1612" class="difflineminus">-                                   &quot;WHERE id = :buddyId&quot;);</span>
<a href="#l4.1613"></a><span id="l4.1613" class="difflineplus">+          let statement = DBConn.createStatement(</span>
<a href="#l4.1614"></a><span id="l4.1614" class="difflineplus">+            &quot;UPDATE buddies SET srv_alias = :srvAlias &quot; + &quot;WHERE id = :buddyId&quot;</span>
<a href="#l4.1615"></a><span id="l4.1615" class="difflineplus">+          );</span>
<a href="#l4.1616"></a><span id="l4.1616">           statement.params.buddyId = this.id;</span>
<a href="#l4.1617"></a><span id="l4.1617">           statement.params.srvAlias = this._srvAlias;</span>
<a href="#l4.1618"></a><span id="l4.1618">           executeAsyncThenFinalize(statement);</span>
<a href="#l4.1619"></a><span id="l4.1619">           this._notifyObservers(&quot;display-name-changed&quot;, aData);</span>
<a href="#l4.1620"></a><span id="l4.1620">         }</span>
<a href="#l4.1621"></a><span id="l4.1621">         break;</span>
<a href="#l4.1622"></a><span id="l4.1622">       case &quot;account-buddy-icon-changed&quot;:</span>
<a href="#l4.1623"></a><span id="l4.1623" class="difflineminus">-        if (this._isPreferredAccount(aSubject))</span>
<a href="#l4.1624"></a><span id="l4.1624" class="difflineplus">+        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l4.1625"></a><span id="l4.1625">           this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l4.1626"></a><span id="l4.1626" class="difflineplus">+        }</span>
<a href="#l4.1627"></a><span id="l4.1627">         break;</span>
<a href="#l4.1628"></a><span id="l4.1628">       case &quot;account-buddy-added&quot;:</span>
<a href="#l4.1629"></a><span id="l4.1629">         if (this._accounts.length == 0) {</span>
<a href="#l4.1630"></a><span id="l4.1630">           // Add the new account in the empty buddy instance.</span>
<a href="#l4.1631"></a><span id="l4.1631">           // The TagsById hack is to bypass the xpconnect wrapper.</span>
<a href="#l4.1632"></a><span id="l4.1632">           this._addAccount(aSubject, TagsById[aSubject.tag.id]);</span>
<a href="#l4.1633"></a><span id="l4.1633">           this._updateStatus();</span>
<a href="#l4.1634"></a><span id="l4.1634">           this._notifyObservers(&quot;added&quot;);</span>
<a href="#l4.1635"></a><span id="l4.1635" class="difflineminus">-        }</span>
<a href="#l4.1636"></a><span id="l4.1636" class="difflineminus">-        else {</span>
<a href="#l4.1637"></a><span id="l4.1637" class="difflineplus">+        } else {</span>
<a href="#l4.1638"></a><span id="l4.1638">           this._accounts.push(aSubject);</span>
<a href="#l4.1639"></a><span id="l4.1639">           this.contact._moved(null, aSubject.tag);</span>
<a href="#l4.1640"></a><span id="l4.1640">           this._updatePreferredAccount(aSubject);</span>
<a href="#l4.1641"></a><span id="l4.1641">         }</span>
<a href="#l4.1642"></a><span id="l4.1642">         break;</span>
<a href="#l4.1643"></a><span id="l4.1643">       case &quot;account-buddy-removed&quot;:</span>
<a href="#l4.1644"></a><span id="l4.1644">         if (this._accounts.length == 1) {</span>
<a href="#l4.1645"></a><span id="l4.1645" class="difflineminus">-          let statement =</span>
<a href="#l4.1646"></a><span id="l4.1646" class="difflineminus">-            DBConn.createStatement(&quot;DELETE FROM buddies WHERE id = :id&quot;);</span>
<a href="#l4.1647"></a><span id="l4.1647" class="difflineplus">+          let statement = DBConn.createStatement(</span>
<a href="#l4.1648"></a><span id="l4.1648" class="difflineplus">+            &quot;DELETE FROM buddies WHERE id = :id&quot;</span>
<a href="#l4.1649"></a><span id="l4.1649" class="difflineplus">+          );</span>
<a href="#l4.1650"></a><span id="l4.1650">           try {</span>
<a href="#l4.1651"></a><span id="l4.1651">             statement.params.id = this.id;</span>
<a href="#l4.1652"></a><span id="l4.1652">             statement.execute();</span>
<a href="#l4.1653"></a><span id="l4.1653">           } finally {</span>
<a href="#l4.1654"></a><span id="l4.1654">             statement.finalize();</span>
<a href="#l4.1655"></a><span id="l4.1655">           }</span>
<a href="#l4.1656"></a><span id="l4.1656">           this._notifyObservers(&quot;removed&quot;);</span>
<a href="#l4.1657"></a><span id="l4.1657"> </span>
<a href="#l4.1658"></a><span id="l4.1658">           delete BuddiesById[this._id];</span>
<a href="#l4.1659"></a><span id="l4.1659">           this.destroy();</span>
<a href="#l4.1660"></a><span id="l4.1660" class="difflineminus">-        }</span>
<a href="#l4.1661"></a><span id="l4.1661" class="difflineminus">-        else {</span>
<a href="#l4.1662"></a><span id="l4.1662" class="difflineplus">+        } else {</span>
<a href="#l4.1663"></a><span id="l4.1663">           this._accounts = this._accounts.filter(function(ab) {</span>
<a href="#l4.1664"></a><span id="l4.1664" class="difflineminus">-            return (ab.account.numericId != aSubject.account.numericId ||</span>
<a href="#l4.1665"></a><span id="l4.1665" class="difflineminus">-                    ab.tag.id != aSubject.tag.id);</span>
<a href="#l4.1666"></a><span id="l4.1666" class="difflineplus">+            return (</span>
<a href="#l4.1667"></a><span id="l4.1667" class="difflineplus">+              ab.account.numericId != aSubject.account.numericId ||</span>
<a href="#l4.1668"></a><span id="l4.1668" class="difflineplus">+              ab.tag.id != aSubject.tag.id</span>
<a href="#l4.1669"></a><span id="l4.1669" class="difflineplus">+            );</span>
<a href="#l4.1670"></a><span id="l4.1670">           });</span>
<a href="#l4.1671"></a><span id="l4.1671" class="difflineminus">-          if (this._preferredAccount.account.numericId == aSubject.account.numericId &amp;&amp;</span>
<a href="#l4.1672"></a><span id="l4.1672" class="difflineminus">-              this._preferredAccount.tag.id == aSubject.tag.id) {</span>
<a href="#l4.1673"></a><span id="l4.1673" class="difflineplus">+          if (</span>
<a href="#l4.1674"></a><span id="l4.1674" class="difflineplus">+            this._preferredAccount.account.numericId ==</span>
<a href="#l4.1675"></a><span id="l4.1675" class="difflineplus">+              aSubject.account.numericId &amp;&amp;</span>
<a href="#l4.1676"></a><span id="l4.1676" class="difflineplus">+            this._preferredAccount.tag.id == aSubject.tag.id</span>
<a href="#l4.1677"></a><span id="l4.1677" class="difflineplus">+          ) {</span>
<a href="#l4.1678"></a><span id="l4.1678">             this._preferredAccount = null;</span>
<a href="#l4.1679"></a><span id="l4.1679">             this._updatePreferredAccount();</span>
<a href="#l4.1680"></a><span id="l4.1680">           }</span>
<a href="#l4.1681"></a><span id="l4.1681">           this.contact._moved(aSubject.tag);</span>
<a href="#l4.1682"></a><span id="l4.1682">         }</span>
<a href="#l4.1683"></a><span id="l4.1683">         break;</span>
<a href="#l4.1684"></a><span id="l4.1684">     }</span>
<a href="#l4.1685"></a><span id="l4.1685">   },</span>
<a href="#l4.1686"></a><span id="l4.1686"> };</span>
<a href="#l4.1687"></a><span id="l4.1687"> </span>
<a href="#l4.1688"></a><span id="l4.1688" class="difflineminus">-</span>
<a href="#l4.1689"></a><span id="l4.1689" class="difflineminus">-function ContactsService() { }</span>
<a href="#l4.1690"></a><span id="l4.1690" class="difflineplus">+function ContactsService() {}</span>
<a href="#l4.1691"></a><span id="l4.1691"> ContactsService.prototype = {</span>
<a href="#l4.1692"></a><span id="l4.1692">   initContacts() {</span>
<a href="#l4.1693"></a><span id="l4.1693">     let statement = DBConn.createStatement(&quot;SELECT id, name FROM tags&quot;);</span>
<a href="#l4.1694"></a><span id="l4.1694">     try {</span>
<a href="#l4.1695"></a><span id="l4.1695" class="difflineminus">-      while (statement.executeStep())</span>
<a href="#l4.1696"></a><span id="l4.1696" class="difflineplus">+      while (statement.executeStep()) {</span>
<a href="#l4.1697"></a><span id="l4.1697">         Tags.push(new Tag(statement.getInt32(0), statement.getUTF8String(1)));</span>
<a href="#l4.1698"></a><span id="l4.1698" class="difflineplus">+      }</span>
<a href="#l4.1699"></a><span id="l4.1699">     } finally {</span>
<a href="#l4.1700"></a><span id="l4.1700">       statement.finalize();</span>
<a href="#l4.1701"></a><span id="l4.1701">     }</span>
<a href="#l4.1702"></a><span id="l4.1702"> </span>
<a href="#l4.1703"></a><span id="l4.1703">     statement = DBConn.createStatement(&quot;SELECT id, alias FROM contacts&quot;);</span>
<a href="#l4.1704"></a><span id="l4.1704">     try {</span>
<a href="#l4.1705"></a><span id="l4.1705" class="difflineminus">-      while (statement.executeStep())</span>
<a href="#l4.1706"></a><span id="l4.1706" class="difflineplus">+      while (statement.executeStep()) {</span>
<a href="#l4.1707"></a><span id="l4.1707">         new Contact(statement.getInt32(0), statement.getUTF8String(1));</span>
<a href="#l4.1708"></a><span id="l4.1708" class="difflineplus">+      }</span>
<a href="#l4.1709"></a><span id="l4.1709">     } finally {</span>
<a href="#l4.1710"></a><span id="l4.1710">       statement.finalize();</span>
<a href="#l4.1711"></a><span id="l4.1711">     }</span>
<a href="#l4.1712"></a><span id="l4.1712"> </span>
<a href="#l4.1713"></a><span id="l4.1713" class="difflineminus">-    statement =</span>
<a href="#l4.1714"></a><span id="l4.1714" class="difflineminus">-      DBConn.createStatement(&quot;SELECT contact_id, tag_id FROM contact_tag&quot;);</span>
<a href="#l4.1715"></a><span id="l4.1715" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l4.1716"></a><span id="l4.1716" class="difflineplus">+      &quot;SELECT contact_id, tag_id FROM contact_tag&quot;</span>
<a href="#l4.1717"></a><span id="l4.1717" class="difflineplus">+    );</span>
<a href="#l4.1718"></a><span id="l4.1718">     try {</span>
<a href="#l4.1719"></a><span id="l4.1719">       while (statement.executeStep()) {</span>
<a href="#l4.1720"></a><span id="l4.1720">         let contact = ContactsById[statement.getInt32(0)];</span>
<a href="#l4.1721"></a><span id="l4.1721">         let tag = TagsById[statement.getInt32(1)];</span>
<a href="#l4.1722"></a><span id="l4.1722">         contact._tags.push(tag);</span>
<a href="#l4.1723"></a><span id="l4.1723">         tag._addContact(contact);</span>
<a href="#l4.1724"></a><span id="l4.1724">       }</span>
<a href="#l4.1725"></a><span id="l4.1725">     } finally {</span>
<a href="#l4.1726"></a><span id="l4.1726">       statement.finalize();</span>
<a href="#l4.1727"></a><span id="l4.1727">     }</span>
<a href="#l4.1728"></a><span id="l4.1728"> </span>
<a href="#l4.1729"></a><span id="l4.1729" class="difflineminus">-    statement = DBConn.createStatement(&quot;SELECT id, key, name, srv_alias, contact_id FROM buddies ORDER BY position&quot;);</span>
<a href="#l4.1730"></a><span id="l4.1730" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l4.1731"></a><span id="l4.1731" class="difflineplus">+      &quot;SELECT id, key, name, srv_alias, contact_id FROM buddies ORDER BY position&quot;</span>
<a href="#l4.1732"></a><span id="l4.1732" class="difflineplus">+    );</span>
<a href="#l4.1733"></a><span id="l4.1733">     try {</span>
<a href="#l4.1734"></a><span id="l4.1734">       while (statement.executeStep()) {</span>
<a href="#l4.1735"></a><span id="l4.1735" class="difflineminus">-        new Buddy(statement.getInt32(0), statement.getUTF8String(1),</span>
<a href="#l4.1736"></a><span id="l4.1736" class="difflineminus">-                statement.getUTF8String(2), statement.getUTF8String(3),</span>
<a href="#l4.1737"></a><span id="l4.1737" class="difflineminus">-                statement.getInt32(4));</span>
<a href="#l4.1738"></a><span id="l4.1738" class="difflineplus">+        new Buddy(</span>
<a href="#l4.1739"></a><span id="l4.1739" class="difflineplus">+          statement.getInt32(0),</span>
<a href="#l4.1740"></a><span id="l4.1740" class="difflineplus">+          statement.getUTF8String(1),</span>
<a href="#l4.1741"></a><span id="l4.1741" class="difflineplus">+          statement.getUTF8String(2),</span>
<a href="#l4.1742"></a><span id="l4.1742" class="difflineplus">+          statement.getUTF8String(3),</span>
<a href="#l4.1743"></a><span id="l4.1743" class="difflineplus">+          statement.getInt32(4)</span>
<a href="#l4.1744"></a><span id="l4.1744" class="difflineplus">+        );</span>
<a href="#l4.1745"></a><span id="l4.1745">         // FIXME is there a way to enforce that all AccountBuddies of a Buddy have the same protocol?</span>
<a href="#l4.1746"></a><span id="l4.1746">       }</span>
<a href="#l4.1747"></a><span id="l4.1747">     } finally {</span>
<a href="#l4.1748"></a><span id="l4.1748">       statement.finalize();</span>
<a href="#l4.1749"></a><span id="l4.1749">     }</span>
<a href="#l4.1750"></a><span id="l4.1750"> </span>
<a href="#l4.1751"></a><span id="l4.1751" class="difflineminus">-    statement = DBConn.createStatement(&quot;SELECT account_id, buddy_id, tag_id FROM account_buddy&quot;);</span>
<a href="#l4.1752"></a><span id="l4.1752" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l4.1753"></a><span id="l4.1753" class="difflineplus">+      &quot;SELECT account_id, buddy_id, tag_id FROM account_buddy&quot;</span>
<a href="#l4.1754"></a><span id="l4.1754" class="difflineplus">+    );</span>
<a href="#l4.1755"></a><span id="l4.1755">     try {</span>
<a href="#l4.1756"></a><span id="l4.1756">       while (statement.executeStep()) {</span>
<a href="#l4.1757"></a><span id="l4.1757">         let accountId = statement.getInt32(0);</span>
<a href="#l4.1758"></a><span id="l4.1758">         let buddyId = statement.getInt32(1);</span>
<a href="#l4.1759"></a><span id="l4.1759">         let tagId = statement.getInt32(2);</span>
<a href="#l4.1760"></a><span id="l4.1760"> </span>
<a href="#l4.1761"></a><span id="l4.1761">         if (!BuddiesById.hasOwnProperty(buddyId)) {</span>
<a href="#l4.1762"></a><span id="l4.1762" class="difflineminus">-          Cu.reportError(&quot;Corrupted database: account_buddy entry for account &quot; +</span>
<a href="#l4.1763"></a><span id="l4.1763" class="difflineminus">-                         accountId + &quot; and tag &quot; + tagId +</span>
<a href="#l4.1764"></a><span id="l4.1764" class="difflineminus">-                         &quot; references unknown buddy with id &quot; + buddyId);</span>
<a href="#l4.1765"></a><span id="l4.1765" class="difflineplus">+          Cu.reportError(</span>
<a href="#l4.1766"></a><span id="l4.1766" class="difflineplus">+            &quot;Corrupted database: account_buddy entry for account &quot; +</span>
<a href="#l4.1767"></a><span id="l4.1767" class="difflineplus">+              accountId +</span>
<a href="#l4.1768"></a><span id="l4.1768" class="difflineplus">+              &quot; and tag &quot; +</span>
<a href="#l4.1769"></a><span id="l4.1769" class="difflineplus">+              tagId +</span>
<a href="#l4.1770"></a><span id="l4.1770" class="difflineplus">+              &quot; references unknown buddy with id &quot; +</span>
<a href="#l4.1771"></a><span id="l4.1771" class="difflineplus">+              buddyId</span>
<a href="#l4.1772"></a><span id="l4.1772" class="difflineplus">+          );</span>
<a href="#l4.1773"></a><span id="l4.1773">           continue;</span>
<a href="#l4.1774"></a><span id="l4.1774">         }</span>
<a href="#l4.1775"></a><span id="l4.1775"> </span>
<a href="#l4.1776"></a><span id="l4.1776">         let buddy = BuddiesById[buddyId];</span>
<a href="#l4.1777"></a><span id="l4.1777">         if (buddy._hasAccountBuddy(accountId, tagId)) {</span>
<a href="#l4.1778"></a><span id="l4.1778" class="difflineminus">-          Cu.reportError(&quot;Corrupted database: duplicated account_buddy entry: &quot; +</span>
<a href="#l4.1779"></a><span id="l4.1779" class="difflineminus">-                         &quot;account_id = &quot; + accountId + &quot;, buddy_id = &quot; + buddyId +</span>
<a href="#l4.1780"></a><span id="l4.1780" class="difflineminus">-                         &quot;, tag_id = &quot; + tagId);</span>
<a href="#l4.1781"></a><span id="l4.1781" class="difflineplus">+          Cu.reportError(</span>
<a href="#l4.1782"></a><span id="l4.1782" class="difflineplus">+            &quot;Corrupted database: duplicated account_buddy entry: &quot; +</span>
<a href="#l4.1783"></a><span id="l4.1783" class="difflineplus">+              &quot;account_id = &quot; +</span>
<a href="#l4.1784"></a><span id="l4.1784" class="difflineplus">+              accountId +</span>
<a href="#l4.1785"></a><span id="l4.1785" class="difflineplus">+              &quot;, buddy_id = &quot; +</span>
<a href="#l4.1786"></a><span id="l4.1786" class="difflineplus">+              buddyId +</span>
<a href="#l4.1787"></a><span id="l4.1787" class="difflineplus">+              &quot;, tag_id = &quot; +</span>
<a href="#l4.1788"></a><span id="l4.1788" class="difflineplus">+              tagId</span>
<a href="#l4.1789"></a><span id="l4.1789" class="difflineplus">+          );</span>
<a href="#l4.1790"></a><span id="l4.1790">           continue;</span>
<a href="#l4.1791"></a><span id="l4.1791">         }</span>
<a href="#l4.1792"></a><span id="l4.1792"> </span>
<a href="#l4.1793"></a><span id="l4.1793">         let account = Services.accounts.getAccountByNumericId(accountId);</span>
<a href="#l4.1794"></a><span id="l4.1794">         let tag = TagsById[tagId];</span>
<a href="#l4.1795"></a><span id="l4.1795">         try {</span>
<a href="#l4.1796"></a><span id="l4.1796">           buddy._addAccount(account.loadBuddy(buddy, tag), tag);</span>
<a href="#l4.1797"></a><span id="l4.1797">         } catch (e) {</span>
<a href="#l4.1798"></a><span id="l4.1798" class="difflineat">@@ -1290,147 +1582,170 @@ ContactsService.prototype = {</span>
<a href="#l4.1799"></a><span id="l4.1799">       }</span>
<a href="#l4.1800"></a><span id="l4.1800">     } finally {</span>
<a href="#l4.1801"></a><span id="l4.1801">       statement.finalize();</span>
<a href="#l4.1802"></a><span id="l4.1802">     }</span>
<a href="#l4.1803"></a><span id="l4.1803">     otherContactsTag._initHiddenTags();</span>
<a href="#l4.1804"></a><span id="l4.1804">   },</span>
<a href="#l4.1805"></a><span id="l4.1805">   unInitContacts() {</span>
<a href="#l4.1806"></a><span id="l4.1806">     Tags = [];</span>
<a href="#l4.1807"></a><span id="l4.1807" class="difflineminus">-    TagsById = { };</span>
<a href="#l4.1808"></a><span id="l4.1808" class="difflineplus">+    TagsById = {};</span>
<a href="#l4.1809"></a><span id="l4.1809">     // Avoid shutdown leaks caused by references to native components</span>
<a href="#l4.1810"></a><span id="l4.1810">     // implementing prplIAccountBuddy.</span>
<a href="#l4.1811"></a><span id="l4.1811">     for (let buddyId in BuddiesById) {</span>
<a href="#l4.1812"></a><span id="l4.1812">       let buddy = BuddiesById[buddyId];</span>
<a href="#l4.1813"></a><span id="l4.1813">       buddy.destroy();</span>
<a href="#l4.1814"></a><span id="l4.1814">     }</span>
<a href="#l4.1815"></a><span id="l4.1815" class="difflineminus">-    BuddiesById = { };</span>
<a href="#l4.1816"></a><span id="l4.1816" class="difflineminus">-    ContactsById = { };</span>
<a href="#l4.1817"></a><span id="l4.1817" class="difflineplus">+    BuddiesById = {};</span>
<a href="#l4.1818"></a><span id="l4.1818" class="difflineplus">+    ContactsById = {};</span>
<a href="#l4.1819"></a><span id="l4.1819">   },</span>
<a href="#l4.1820"></a><span id="l4.1820"> </span>
<a href="#l4.1821"></a><span id="l4.1821">   getContactById: aId =&gt; ContactsById[aId],</span>
<a href="#l4.1822"></a><span id="l4.1822">   // Get an array of all existing contacts.</span>
<a href="#l4.1823"></a><span id="l4.1823">   getContacts(aContactCount) {</span>
<a href="#l4.1824"></a><span id="l4.1824">     let contacts = Object.keys(ContactsById)</span>
<a href="#l4.1825"></a><span id="l4.1825" class="difflineminus">-                         .filter(id =&gt; !ContactsById[id]._empty)</span>
<a href="#l4.1826"></a><span id="l4.1826" class="difflineminus">-                         .map(id =&gt; ContactsById[id]);</span>
<a href="#l4.1827"></a><span id="l4.1827" class="difflineminus">-    if (aContactCount)</span>
<a href="#l4.1828"></a><span id="l4.1828" class="difflineplus">+      .filter(id =&gt; !ContactsById[id]._empty)</span>
<a href="#l4.1829"></a><span id="l4.1829" class="difflineplus">+      .map(id =&gt; ContactsById[id]);</span>
<a href="#l4.1830"></a><span id="l4.1830" class="difflineplus">+    if (aContactCount) {</span>
<a href="#l4.1831"></a><span id="l4.1831">       aContactCount.value = contacts.length;</span>
<a href="#l4.1832"></a><span id="l4.1832" class="difflineplus">+    }</span>
<a href="#l4.1833"></a><span id="l4.1833">     return contacts;</span>
<a href="#l4.1834"></a><span id="l4.1834">   },</span>
<a href="#l4.1835"></a><span id="l4.1835">   getBuddyById: aId =&gt; BuddiesById[aId],</span>
<a href="#l4.1836"></a><span id="l4.1836">   getBuddyByNameAndProtocol(aNormalizedName, aPrpl) {</span>
<a href="#l4.1837"></a><span id="l4.1837" class="difflineminus">-    let statement =</span>
<a href="#l4.1838"></a><span id="l4.1838" class="difflineminus">-      DBConn.createStatement(&quot;SELECT b.id FROM buddies b &quot; +</span>
<a href="#l4.1839"></a><span id="l4.1839" class="difflineminus">-                             &quot;JOIN account_buddy ab ON buddy_id = b.id &quot; +</span>
<a href="#l4.1840"></a><span id="l4.1840" class="difflineminus">-                             &quot;JOIN accounts a ON account_id = a.id &quot; +</span>
<a href="#l4.1841"></a><span id="l4.1841" class="difflineminus">-                             &quot;WHERE b.key = :buddyName and a.prpl = :prplId&quot;);</span>
<a href="#l4.1842"></a><span id="l4.1842" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.1843"></a><span id="l4.1843" class="difflineplus">+      &quot;SELECT b.id FROM buddies b &quot; +</span>
<a href="#l4.1844"></a><span id="l4.1844" class="difflineplus">+        &quot;JOIN account_buddy ab ON buddy_id = b.id &quot; +</span>
<a href="#l4.1845"></a><span id="l4.1845" class="difflineplus">+        &quot;JOIN accounts a ON account_id = a.id &quot; +</span>
<a href="#l4.1846"></a><span id="l4.1846" class="difflineplus">+        &quot;WHERE b.key = :buddyName and a.prpl = :prplId&quot;</span>
<a href="#l4.1847"></a><span id="l4.1847" class="difflineplus">+    );</span>
<a href="#l4.1848"></a><span id="l4.1848">     statement.params.buddyName = aNormalizedName;</span>
<a href="#l4.1849"></a><span id="l4.1849">     statement.params.prplId = aPrpl.id;</span>
<a href="#l4.1850"></a><span id="l4.1850">     try {</span>
<a href="#l4.1851"></a><span id="l4.1851" class="difflineminus">-      if (!statement.executeStep())</span>
<a href="#l4.1852"></a><span id="l4.1852" class="difflineplus">+      if (!statement.executeStep()) {</span>
<a href="#l4.1853"></a><span id="l4.1853">         return null;</span>
<a href="#l4.1854"></a><span id="l4.1854" class="difflineplus">+      }</span>
<a href="#l4.1855"></a><span id="l4.1855">       return BuddiesById[statement.row.id];</span>
<a href="#l4.1856"></a><span id="l4.1856">     } finally {</span>
<a href="#l4.1857"></a><span id="l4.1857">       statement.finalize();</span>
<a href="#l4.1858"></a><span id="l4.1858">     }</span>
<a href="#l4.1859"></a><span id="l4.1859">   },</span>
<a href="#l4.1860"></a><span id="l4.1860">   getAccountBuddyByNameAndAccount(aNormalizedName, aAccount) {</span>
<a href="#l4.1861"></a><span id="l4.1861" class="difflineminus">-    let buddy = this.getBuddyByNameAndProtocol(aNormalizedName,</span>
<a href="#l4.1862"></a><span id="l4.1862" class="difflineminus">-                                               aAccount.protocol);</span>
<a href="#l4.1863"></a><span id="l4.1863" class="difflineplus">+    let buddy = this.getBuddyByNameAndProtocol(</span>
<a href="#l4.1864"></a><span id="l4.1864" class="difflineplus">+      aNormalizedName,</span>
<a href="#l4.1865"></a><span id="l4.1865" class="difflineplus">+      aAccount.protocol</span>
<a href="#l4.1866"></a><span id="l4.1866" class="difflineplus">+    );</span>
<a href="#l4.1867"></a><span id="l4.1867">     if (buddy) {</span>
<a href="#l4.1868"></a><span id="l4.1868">       let id = aAccount.id;</span>
<a href="#l4.1869"></a><span id="l4.1869">       for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l4.1870"></a><span id="l4.1870" class="difflineminus">-        if (accountBuddy.account.id == id)</span>
<a href="#l4.1871"></a><span id="l4.1871" class="difflineplus">+        if (accountBuddy.account.id == id) {</span>
<a href="#l4.1872"></a><span id="l4.1872">           return accountBuddy;</span>
<a href="#l4.1873"></a><span id="l4.1873" class="difflineplus">+        }</span>
<a href="#l4.1874"></a><span id="l4.1874">       }</span>
<a href="#l4.1875"></a><span id="l4.1875">     }</span>
<a href="#l4.1876"></a><span id="l4.1876">     return null;</span>
<a href="#l4.1877"></a><span id="l4.1877">   },</span>
<a href="#l4.1878"></a><span id="l4.1878"> </span>
<a href="#l4.1879"></a><span id="l4.1879">   accountBuddyAdded(aAccountBuddy) {</span>
<a href="#l4.1880"></a><span id="l4.1880">     let account = aAccountBuddy.account;</span>
<a href="#l4.1881"></a><span id="l4.1881">     let normalizedName = aAccountBuddy.normalizedName;</span>
<a href="#l4.1882"></a><span id="l4.1882" class="difflineminus">-    let buddy = this.getBuddyByNameAndProtocol(normalizedName, account.protocol);</span>
<a href="#l4.1883"></a><span id="l4.1883" class="difflineplus">+    let buddy = this.getBuddyByNameAndProtocol(</span>
<a href="#l4.1884"></a><span id="l4.1884" class="difflineplus">+      normalizedName,</span>
<a href="#l4.1885"></a><span id="l4.1885" class="difflineplus">+      account.protocol</span>
<a href="#l4.1886"></a><span id="l4.1886" class="difflineplus">+    );</span>
<a href="#l4.1887"></a><span id="l4.1887">     if (!buddy) {</span>
<a href="#l4.1888"></a><span id="l4.1888" class="difflineminus">-      let statement =</span>
<a href="#l4.1889"></a><span id="l4.1889" class="difflineminus">-        DBConn.createStatement(&quot;INSERT INTO buddies &quot; +</span>
<a href="#l4.1890"></a><span id="l4.1890" class="difflineminus">-                               &quot;(key, name, srv_alias, position) &quot; +</span>
<a href="#l4.1891"></a><span id="l4.1891" class="difflineminus">-                               &quot;VALUES(:key, :name, :srvAlias, 0)&quot;);</span>
<a href="#l4.1892"></a><span id="l4.1892" class="difflineplus">+      let statement = DBConn.createStatement(</span>
<a href="#l4.1893"></a><span id="l4.1893" class="difflineplus">+        &quot;INSERT INTO buddies &quot; +</span>
<a href="#l4.1894"></a><span id="l4.1894" class="difflineplus">+          &quot;(key, name, srv_alias, position) &quot; +</span>
<a href="#l4.1895"></a><span id="l4.1895" class="difflineplus">+          &quot;VALUES(:key, :name, :srvAlias, 0)&quot;</span>
<a href="#l4.1896"></a><span id="l4.1896" class="difflineplus">+      );</span>
<a href="#l4.1897"></a><span id="l4.1897">       try {</span>
<a href="#l4.1898"></a><span id="l4.1898">         let name = aAccountBuddy.userName;</span>
<a href="#l4.1899"></a><span id="l4.1899">         let srvAlias = aAccountBuddy.serverAlias;</span>
<a href="#l4.1900"></a><span id="l4.1900">         statement.params.key = normalizedName;</span>
<a href="#l4.1901"></a><span id="l4.1901">         statement.params.name = name;</span>
<a href="#l4.1902"></a><span id="l4.1902">         statement.params.srvAlias = srvAlias;</span>
<a href="#l4.1903"></a><span id="l4.1903">         statement.execute();</span>
<a href="#l4.1904"></a><span id="l4.1904" class="difflineminus">-        buddy =</span>
<a href="#l4.1905"></a><span id="l4.1905" class="difflineminus">-          new Buddy(DBConn.lastInsertRowID, normalizedName, name, srvAlias, 0);</span>
<a href="#l4.1906"></a><span id="l4.1906" class="difflineplus">+        buddy = new Buddy(</span>
<a href="#l4.1907"></a><span id="l4.1907" class="difflineplus">+          DBConn.lastInsertRowID,</span>
<a href="#l4.1908"></a><span id="l4.1908" class="difflineplus">+          normalizedName,</span>
<a href="#l4.1909"></a><span id="l4.1909" class="difflineplus">+          name,</span>
<a href="#l4.1910"></a><span id="l4.1910" class="difflineplus">+          srvAlias,</span>
<a href="#l4.1911"></a><span id="l4.1911" class="difflineplus">+          0</span>
<a href="#l4.1912"></a><span id="l4.1912" class="difflineplus">+        );</span>
<a href="#l4.1913"></a><span id="l4.1913">       } finally {</span>
<a href="#l4.1914"></a><span id="l4.1914">         statement.finalize();</span>
<a href="#l4.1915"></a><span id="l4.1915">       }</span>
<a href="#l4.1916"></a><span id="l4.1916">     }</span>
<a href="#l4.1917"></a><span id="l4.1917"> </span>
<a href="#l4.1918"></a><span id="l4.1918">     // Initialize the 'buddy' field of the prplIAccountBuddy instance.</span>
<a href="#l4.1919"></a><span id="l4.1919">     aAccountBuddy.buddy = buddy;</span>
<a href="#l4.1920"></a><span id="l4.1920"> </span>
<a href="#l4.1921"></a><span id="l4.1921">     // Ensure we aren't storing a duplicate entry.</span>
<a href="#l4.1922"></a><span id="l4.1922">     let accountId = account.numericId;</span>
<a href="#l4.1923"></a><span id="l4.1923">     let tagId = aAccountBuddy.tag.id;</span>
<a href="#l4.1924"></a><span id="l4.1924">     if (buddy._hasAccountBuddy(accountId, tagId)) {</span>
<a href="#l4.1925"></a><span id="l4.1925" class="difflineminus">-      Cu.reportError(&quot;Attempting to store a duplicate account buddy &quot; +</span>
<a href="#l4.1926"></a><span id="l4.1926" class="difflineminus">-                     normalizedName + &quot;, account id = &quot; + accountId +</span>
<a href="#l4.1927"></a><span id="l4.1927" class="difflineminus">-                     &quot;, tag id = &quot; + tagId);</span>
<a href="#l4.1928"></a><span id="l4.1928" class="difflineplus">+      Cu.reportError(</span>
<a href="#l4.1929"></a><span id="l4.1929" class="difflineplus">+        &quot;Attempting to store a duplicate account buddy &quot; +</span>
<a href="#l4.1930"></a><span id="l4.1930" class="difflineplus">+          normalizedName +</span>
<a href="#l4.1931"></a><span id="l4.1931" class="difflineplus">+          &quot;, account id = &quot; +</span>
<a href="#l4.1932"></a><span id="l4.1932" class="difflineplus">+          accountId +</span>
<a href="#l4.1933"></a><span id="l4.1933" class="difflineplus">+          &quot;, tag id = &quot; +</span>
<a href="#l4.1934"></a><span id="l4.1934" class="difflineplus">+          tagId</span>
<a href="#l4.1935"></a><span id="l4.1935" class="difflineplus">+      );</span>
<a href="#l4.1936"></a><span id="l4.1936">       return;</span>
<a href="#l4.1937"></a><span id="l4.1937">     }</span>
<a href="#l4.1938"></a><span id="l4.1938"> </span>
<a href="#l4.1939"></a><span id="l4.1939">     // Store the new account buddy.</span>
<a href="#l4.1940"></a><span id="l4.1940" class="difflineminus">-    let statement =</span>
<a href="#l4.1941"></a><span id="l4.1941" class="difflineminus">-      DBConn.createStatement(&quot;INSERT INTO account_buddy &quot; +</span>
<a href="#l4.1942"></a><span id="l4.1942" class="difflineminus">-                             &quot;(account_id, buddy_id, tag_id) &quot; +</span>
<a href="#l4.1943"></a><span id="l4.1943" class="difflineminus">-                             &quot;VALUES(:accountId, :buddyId, :tagId)&quot;);</span>
<a href="#l4.1944"></a><span id="l4.1944" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.1945"></a><span id="l4.1945" class="difflineplus">+      &quot;INSERT INTO account_buddy &quot; +</span>
<a href="#l4.1946"></a><span id="l4.1946" class="difflineplus">+        &quot;(account_id, buddy_id, tag_id) &quot; +</span>
<a href="#l4.1947"></a><span id="l4.1947" class="difflineplus">+        &quot;VALUES(:accountId, :buddyId, :tagId)&quot;</span>
<a href="#l4.1948"></a><span id="l4.1948" class="difflineplus">+    );</span>
<a href="#l4.1949"></a><span id="l4.1949">     try {</span>
<a href="#l4.1950"></a><span id="l4.1950">       statement.params.accountId = accountId;</span>
<a href="#l4.1951"></a><span id="l4.1951">       statement.params.buddyId = buddy.id;</span>
<a href="#l4.1952"></a><span id="l4.1952">       statement.params.tagId = tagId;</span>
<a href="#l4.1953"></a><span id="l4.1953">       statement.execute();</span>
<a href="#l4.1954"></a><span id="l4.1954">     } finally {</span>
<a href="#l4.1955"></a><span id="l4.1955">       statement.finalize();</span>
<a href="#l4.1956"></a><span id="l4.1956">     }</span>
<a href="#l4.1957"></a><span id="l4.1957"> </span>
<a href="#l4.1958"></a><span id="l4.1958">     // Fire the notifications.</span>
<a href="#l4.1959"></a><span id="l4.1959">     buddy.observe(aAccountBuddy, &quot;account-buddy-added&quot;);</span>
<a href="#l4.1960"></a><span id="l4.1960">   },</span>
<a href="#l4.1961"></a><span id="l4.1961">   accountBuddyRemoved(aAccountBuddy) {</span>
<a href="#l4.1962"></a><span id="l4.1962">     let buddy = aAccountBuddy.buddy;</span>
<a href="#l4.1963"></a><span id="l4.1963" class="difflineminus">-    let statement =</span>
<a href="#l4.1964"></a><span id="l4.1964" class="difflineminus">-      DBConn.createStatement(&quot;DELETE FROM account_buddy &quot; +</span>
<a href="#l4.1965"></a><span id="l4.1965" class="difflineminus">-                                    &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l4.1966"></a><span id="l4.1966" class="difflineminus">-                                          &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l4.1967"></a><span id="l4.1967" class="difflineminus">-                                          &quot;tag_id = :tagId&quot;);</span>
<a href="#l4.1968"></a><span id="l4.1968" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.1969"></a><span id="l4.1969" class="difflineplus">+      &quot;DELETE FROM account_buddy &quot; +</span>
<a href="#l4.1970"></a><span id="l4.1970" class="difflineplus">+        &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l4.1971"></a><span id="l4.1971" class="difflineplus">+        &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l4.1972"></a><span id="l4.1972" class="difflineplus">+        &quot;tag_id = :tagId&quot;</span>
<a href="#l4.1973"></a><span id="l4.1973" class="difflineplus">+    );</span>
<a href="#l4.1974"></a><span id="l4.1974">     try {</span>
<a href="#l4.1975"></a><span id="l4.1975">       statement.params.accountId = aAccountBuddy.account.numericId;</span>
<a href="#l4.1976"></a><span id="l4.1976">       statement.params.buddyId = buddy.id;</span>
<a href="#l4.1977"></a><span id="l4.1977">       statement.params.tagId = aAccountBuddy.tag.id;</span>
<a href="#l4.1978"></a><span id="l4.1978">       statement.execute();</span>
<a href="#l4.1979"></a><span id="l4.1979">     } finally {</span>
<a href="#l4.1980"></a><span id="l4.1980">       statement.finalize();</span>
<a href="#l4.1981"></a><span id="l4.1981">     }</span>
<a href="#l4.1982"></a><span id="l4.1982"> </span>
<a href="#l4.1983"></a><span id="l4.1983">     buddy.observe(aAccountBuddy, &quot;account-buddy-removed&quot;);</span>
<a href="#l4.1984"></a><span id="l4.1984">   },</span>
<a href="#l4.1985"></a><span id="l4.1985"> </span>
<a href="#l4.1986"></a><span id="l4.1986">   accountBuddyMoved(aAccountBuddy, aOldTag, aNewTag) {</span>
<a href="#l4.1987"></a><span id="l4.1987">     let buddy = aAccountBuddy.buddy;</span>
<a href="#l4.1988"></a><span id="l4.1988" class="difflineminus">-    let statement =</span>
<a href="#l4.1989"></a><span id="l4.1989" class="difflineminus">-      DBConn.createStatement(&quot;UPDATE account_buddy &quot; +</span>
<a href="#l4.1990"></a><span id="l4.1990" class="difflineminus">-                             &quot;SET tag_id = :newTagId &quot; +</span>
<a href="#l4.1991"></a><span id="l4.1991" class="difflineminus">-                             &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l4.1992"></a><span id="l4.1992" class="difflineminus">-                                   &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l4.1993"></a><span id="l4.1993" class="difflineminus">-                                   &quot;tag_id = :oldTagId&quot;);</span>
<a href="#l4.1994"></a><span id="l4.1994" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.1995"></a><span id="l4.1995" class="difflineplus">+      &quot;UPDATE account_buddy &quot; +</span>
<a href="#l4.1996"></a><span id="l4.1996" class="difflineplus">+        &quot;SET tag_id = :newTagId &quot; +</span>
<a href="#l4.1997"></a><span id="l4.1997" class="difflineplus">+        &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l4.1998"></a><span id="l4.1998" class="difflineplus">+        &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l4.1999"></a><span id="l4.1999" class="difflineplus">+        &quot;tag_id = :oldTagId&quot;</span>
<a href="#l4.2000"></a><span id="l4.2000" class="difflineplus">+    );</span>
<a href="#l4.2001"></a><span id="l4.2001">     try {</span>
<a href="#l4.2002"></a><span id="l4.2002">       statement.params.accountId = aAccountBuddy.account.numericId;</span>
<a href="#l4.2003"></a><span id="l4.2003">       statement.params.buddyId = buddy.id;</span>
<a href="#l4.2004"></a><span id="l4.2004">       statement.params.oldTagId = aOldTag.id;</span>
<a href="#l4.2005"></a><span id="l4.2005">       statement.params.newTagId = aNewTag.id;</span>
<a href="#l4.2006"></a><span id="l4.2006">       statement.execute();</span>
<a href="#l4.2007"></a><span id="l4.2007">     } finally {</span>
<a href="#l4.2008"></a><span id="l4.2008">       statement.finalize();</span>
<a href="#l4.2009"></a><span id="l4.2009" class="difflineat">@@ -1442,74 +1757,85 @@ ContactsService.prototype = {</span>
<a href="#l4.2010"></a><span id="l4.2010">     // keeping direct tag &lt;-&gt; contact links in the contact_tag table.</span>
<a href="#l4.2011"></a><span id="l4.2011">     contact._removeContactTagRow(aNewTag);</span>
<a href="#l4.2012"></a><span id="l4.2012"> </span>
<a href="#l4.2013"></a><span id="l4.2013">     buddy.observe(aAccountBuddy, &quot;account-buddy-moved&quot;);</span>
<a href="#l4.2014"></a><span id="l4.2014">     contact._moved(aOldTag, aNewTag);</span>
<a href="#l4.2015"></a><span id="l4.2015">   },</span>
<a href="#l4.2016"></a><span id="l4.2016"> </span>
<a href="#l4.2017"></a><span id="l4.2017">   storeAccount(aId, aUserName, aPrplId) {</span>
<a href="#l4.2018"></a><span id="l4.2018" class="difflineminus">-    let statement =</span>
<a href="#l4.2019"></a><span id="l4.2019" class="difflineminus">-      DBConn.createStatement(&quot;SELECT name, prpl FROM accounts WHERE id = :id&quot;);</span>
<a href="#l4.2020"></a><span id="l4.2020" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.2021"></a><span id="l4.2021" class="difflineplus">+      &quot;SELECT name, prpl FROM accounts WHERE id = :id&quot;</span>
<a href="#l4.2022"></a><span id="l4.2022" class="difflineplus">+    );</span>
<a href="#l4.2023"></a><span id="l4.2023">     statement.params.id = aId;</span>
<a href="#l4.2024"></a><span id="l4.2024">     try {</span>
<a href="#l4.2025"></a><span id="l4.2025">       if (statement.executeStep()) {</span>
<a href="#l4.2026"></a><span id="l4.2026" class="difflineminus">-        if (statement.getUTF8String(0) == aUserName &amp;&amp;</span>
<a href="#l4.2027"></a><span id="l4.2027" class="difflineminus">-            statement.getUTF8String(1) == aPrplId)</span>
<a href="#l4.2028"></a><span id="l4.2028" class="difflineminus">-          return; // The account is already stored correctly.</span>
<a href="#l4.2029"></a><span id="l4.2029" class="difflineplus">+        if (</span>
<a href="#l4.2030"></a><span id="l4.2030" class="difflineplus">+          statement.getUTF8String(0) == aUserName &amp;&amp;</span>
<a href="#l4.2031"></a><span id="l4.2031" class="difflineplus">+          statement.getUTF8String(1) == aPrplId</span>
<a href="#l4.2032"></a><span id="l4.2032" class="difflineplus">+        ) {</span>
<a href="#l4.2033"></a><span id="l4.2033" class="difflineplus">+          return;</span>
<a href="#l4.2034"></a><span id="l4.2034" class="difflineplus">+        } // The account is already stored correctly.</span>
<a href="#l4.2035"></a><span id="l4.2035">         throw Cr.NS_ERROR_UNEXPECTED; // Corrupted database?!?</span>
<a href="#l4.2036"></a><span id="l4.2036">       }</span>
<a href="#l4.2037"></a><span id="l4.2037">     } finally {</span>
<a href="#l4.2038"></a><span id="l4.2038">       statement.finalize();</span>
<a href="#l4.2039"></a><span id="l4.2039">     }</span>
<a href="#l4.2040"></a><span id="l4.2040"> </span>
<a href="#l4.2041"></a><span id="l4.2041">     // Actually store the account.</span>
<a href="#l4.2042"></a><span id="l4.2042" class="difflineminus">-    statement = DBConn.createStatement(&quot;INSERT INTO accounts (id, name, prpl) &quot; +</span>
<a href="#l4.2043"></a><span id="l4.2043" class="difflineminus">-                                       &quot;VALUES(:id, :userName, :prplId)&quot;);</span>
<a href="#l4.2044"></a><span id="l4.2044" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l4.2045"></a><span id="l4.2045" class="difflineplus">+      &quot;INSERT INTO accounts (id, name, prpl) &quot; +</span>
<a href="#l4.2046"></a><span id="l4.2046" class="difflineplus">+        &quot;VALUES(:id, :userName, :prplId)&quot;</span>
<a href="#l4.2047"></a><span id="l4.2047" class="difflineplus">+    );</span>
<a href="#l4.2048"></a><span id="l4.2048">     try {</span>
<a href="#l4.2049"></a><span id="l4.2049">       statement.params.id = aId;</span>
<a href="#l4.2050"></a><span id="l4.2050">       statement.params.userName = aUserName;</span>
<a href="#l4.2051"></a><span id="l4.2051">       statement.params.prplId = aPrplId;</span>
<a href="#l4.2052"></a><span id="l4.2052">       statement.execute();</span>
<a href="#l4.2053"></a><span id="l4.2053">     } finally {</span>
<a href="#l4.2054"></a><span id="l4.2054">       statement.finalize();</span>
<a href="#l4.2055"></a><span id="l4.2055">     }</span>
<a href="#l4.2056"></a><span id="l4.2056">   },</span>
<a href="#l4.2057"></a><span id="l4.2057">   accountIdExists(aId) {</span>
<a href="#l4.2058"></a><span id="l4.2058" class="difflineminus">-    let statement =</span>
<a href="#l4.2059"></a><span id="l4.2059" class="difflineminus">-      DBConn.createStatement(&quot;SELECT id FROM accounts WHERE id = :id&quot;);</span>
<a href="#l4.2060"></a><span id="l4.2060" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.2061"></a><span id="l4.2061" class="difflineplus">+      &quot;SELECT id FROM accounts WHERE id = :id&quot;</span>
<a href="#l4.2062"></a><span id="l4.2062" class="difflineplus">+    );</span>
<a href="#l4.2063"></a><span id="l4.2063">     try {</span>
<a href="#l4.2064"></a><span id="l4.2064">       statement.params.id = aId;</span>
<a href="#l4.2065"></a><span id="l4.2065">       return statement.executeStep();</span>
<a href="#l4.2066"></a><span id="l4.2066">     } finally {</span>
<a href="#l4.2067"></a><span id="l4.2067">       statement.finalize();</span>
<a href="#l4.2068"></a><span id="l4.2068">     }</span>
<a href="#l4.2069"></a><span id="l4.2069">   },</span>
<a href="#l4.2070"></a><span id="l4.2070">   forgetAccount(aId) {</span>
<a href="#l4.2071"></a><span id="l4.2071" class="difflineminus">-    let statement =</span>
<a href="#l4.2072"></a><span id="l4.2072" class="difflineminus">-      DBConn.createStatement(&quot;DELETE FROM accounts WHERE id = :accountId&quot;);</span>
<a href="#l4.2073"></a><span id="l4.2073" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l4.2074"></a><span id="l4.2074" class="difflineplus">+      &quot;DELETE FROM accounts WHERE id = :accountId&quot;</span>
<a href="#l4.2075"></a><span id="l4.2075" class="difflineplus">+    );</span>
<a href="#l4.2076"></a><span id="l4.2076">     try {</span>
<a href="#l4.2077"></a><span id="l4.2077">       statement.params.accountId = aId;</span>
<a href="#l4.2078"></a><span id="l4.2078">       statement.execute();</span>
<a href="#l4.2079"></a><span id="l4.2079">     } finally {</span>
<a href="#l4.2080"></a><span id="l4.2080">       statement.finalize();</span>
<a href="#l4.2081"></a><span id="l4.2081">     }</span>
<a href="#l4.2082"></a><span id="l4.2082"> </span>
<a href="#l4.2083"></a><span id="l4.2083">     // removing the account from the accounts table is not enough,</span>
<a href="#l4.2084"></a><span id="l4.2084">     // we need to remove all the associated account_buddy entries too</span>
<a href="#l4.2085"></a><span id="l4.2085" class="difflineminus">-    statement = DBConn.createStatement(&quot;DELETE FROM account_buddy &quot; +</span>
<a href="#l4.2086"></a><span id="l4.2086" class="difflineminus">-                                       &quot;WHERE account_id = :accountId&quot;);</span>
<a href="#l4.2087"></a><span id="l4.2087" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l4.2088"></a><span id="l4.2088" class="difflineplus">+      &quot;DELETE FROM account_buddy &quot; + &quot;WHERE account_id = :accountId&quot;</span>
<a href="#l4.2089"></a><span id="l4.2089" class="difflineplus">+    );</span>
<a href="#l4.2090"></a><span id="l4.2090">     try {</span>
<a href="#l4.2091"></a><span id="l4.2091">       statement.params.accountId = aId;</span>
<a href="#l4.2092"></a><span id="l4.2092">       statement.execute();</span>
<a href="#l4.2093"></a><span id="l4.2093">     } finally {</span>
<a href="#l4.2094"></a><span id="l4.2094">       statement.finalize();</span>
<a href="#l4.2095"></a><span id="l4.2095">     }</span>
<a href="#l4.2096"></a><span id="l4.2096">   },</span>
<a href="#l4.2097"></a><span id="l4.2097"> </span>
<a href="#l4.2098"></a><span id="l4.2098">   QueryInterface: ChromeUtils.generateQI([Ci.imIContactsService]),</span>
<a href="#l4.2099"></a><span id="l4.2099">   classDescription: &quot;Contacts&quot;,</span>
<a href="#l4.2100"></a><span id="l4.2100">   classID: Components.ID(&quot;{8c3725dd-ee26-489d-8135-736015af8c7f}&quot;),</span>
<a href="#l4.2101"></a><span id="l4.2101">   contractID: &quot;@mozilla.org/chat/contacts-service;1&quot;,</span>
<a href="#l4.2102"></a><span id="l4.2102"> };</span>
<a href="#l4.2103"></a><span id="l4.2103"> </span>
<a href="#l4.2104"></a><span id="l4.2104" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([ContactsService,</span>
<a href="#l4.2105"></a><span id="l4.2105" class="difflineminus">-                                                      TagsService]);</span>
<a href="#l4.2106"></a><span id="l4.2106" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([</span>
<a href="#l4.2107"></a><span id="l4.2107" class="difflineplus">+  ContactsService,</span>
<a href="#l4.2108"></a><span id="l4.2108" class="difflineplus">+  TagsService,</span>
<a href="#l4.2109"></a><span id="l4.2109" class="difflineplus">+]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/components/src/imConversations.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/components/src/imConversations.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-var {Status} = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+var { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12"> var {</span>
<a href="#l5.13"></a><span id="l5.13">   XPCOMUtils,</span>
<a href="#l5.14"></a><span id="l5.14">   setTimeout,</span>
<a href="#l5.15"></a><span id="l5.15">   clearTimeout,</span>
<a href="#l5.16"></a><span id="l5.16">   executeSoon,</span>
<a href="#l5.17"></a><span id="l5.17">   nsSimpleEnumerator,</span>
<a href="#l5.18"></a><span id="l5.18">   EmptyEnumerator,</span>
<a href="#l5.19"></a><span id="l5.19">   ClassInfo,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineat">@@ -53,355 +53,470 @@ imMessage.prototype = {</span>
<a href="#l5.21"></a><span id="l5.21">   cancelled: false,</span>
<a href="#l5.22"></a><span id="l5.22">   color: &quot;&quot;,</span>
<a href="#l5.23"></a><span id="l5.23">   _displayMessage: null,</span>
<a href="#l5.24"></a><span id="l5.24">   encrypted: false,</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   get displayMessage() {</span>
<a href="#l5.27"></a><span id="l5.27">     // Explicitly test for null so that blank messages don't fall back to</span>
<a href="#l5.28"></a><span id="l5.28">     // the original. Especially problematic in encryption extensions like OTR.</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-    return this._displayMessage !== null ?</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-      this._displayMessage : this.prplMessage.originalMessage;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+    return this._displayMessage !== null</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+      ? this._displayMessage</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+      : this.prplMessage.originalMessage;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  },</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  set displayMessage(aMsg) {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    this._displayMessage = aMsg;</span>
<a href="#l5.37"></a><span id="l5.37">   },</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  set displayMessage(aMsg) { this._displayMessage = aMsg; },</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  get message() { return this.prplMessage.message; },</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-  set message(aMsg) { this.prplMessage.message = aMsg; },</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  get message() {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+    return this.prplMessage.message;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  },</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  set message(aMsg) {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    this.prplMessage.message = aMsg;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  },</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49">   // from prplIMessage</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-  get who() { return this.prplMessage.who; },</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-  get time() { return this.prplMessage.time; },</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-  get id() { return this.prplMessage.id; },</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-  get alias() { return this.prplMessage.alias; },</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  get iconURL() { return this.prplMessage.iconURL; },</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-  get conversation() { return this.prplMessage.conversation; },</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  set conversation(aConv) { this.prplMessage.conversation = aConv; },</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  get outgoing() { return this.prplMessage.outgoing; },</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-  get incoming() { return this.prplMessage.incoming; },</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  get system() { return this.prplMessage.system; },</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-  get autoResponse() { return this.prplMessage.autoResponse; },</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-  get containsNick() { return this.prplMessage.containsNick; },</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-  get noLog() { return this.prplMessage.noLog; },</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-  get error() { return this.prplMessage.error; },</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-  get delayed() { return this.prplMessage.delayed; },</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-  get noFormat() { return this.prplMessage.noFormat; },</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  get containsImages() { return this.prplMessage.containsImages; },</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  get notification() { return this.prplMessage.notification; },</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  get noLinkification() { return this.prplMessage.noLinkification; },</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  get originalMessage() { return this.prplMessage.originalMessage; },</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-  getActions(aCount) { return this.prplMessage.getActions(aCount || {}); },</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  get who() {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+    return this.prplMessage.who;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  },</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  get time() {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    return this.prplMessage.time;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  },</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  get id() {</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+    return this.prplMessage.id;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  },</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  get alias() {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    return this.prplMessage.alias;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  },</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  get iconURL() {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+    return this.prplMessage.iconURL;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+  },</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  get conversation() {</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+    return this.prplMessage.conversation;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+  },</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  set conversation(aConv) {</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+    this.prplMessage.conversation = aConv;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  },</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  get outgoing() {</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    return this.prplMessage.outgoing;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  },</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  get incoming() {</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+    return this.prplMessage.incoming;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  },</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  get system() {</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    return this.prplMessage.system;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  },</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  get autoResponse() {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    return this.prplMessage.autoResponse;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  },</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  get containsNick() {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+    return this.prplMessage.containsNick;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  },</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  get noLog() {</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    return this.prplMessage.noLog;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  },</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  get error() {</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    return this.prplMessage.error;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  },</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  get delayed() {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+    return this.prplMessage.delayed;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  },</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+  get noFormat() {</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+    return this.prplMessage.noFormat;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  },</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  get containsImages() {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    return this.prplMessage.containsImages;</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  },</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+  get notification() {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    return this.prplMessage.notification;</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+  },</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  get noLinkification() {</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+    return this.prplMessage.noLinkification;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  },</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  get originalMessage() {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+    return this.prplMessage.originalMessage;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  },</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+  getActions(aCount) {</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+    return this.prplMessage.getActions(aCount || {});</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  },</span>
<a href="#l5.134"></a><span id="l5.134"> };</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-function UIConversation(aPrplConversation)</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-{</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+function UIConversation(aPrplConversation) {</span>
<a href="#l5.139"></a><span id="l5.139">   this._prplConv = {};</span>
<a href="#l5.140"></a><span id="l5.140">   this.id = ++gLastUIConvId;</span>
<a href="#l5.141"></a><span id="l5.141">   this._observers = [];</span>
<a href="#l5.142"></a><span id="l5.142">   this._messages = [];</span>
<a href="#l5.143"></a><span id="l5.143">   this.changeTargetTo(aPrplConversation);</span>
<a href="#l5.144"></a><span id="l5.144">   let iface = Ci[&quot;prplIConv&quot; + (aPrplConversation.isChat ? &quot;Chat&quot; : &quot;IM&quot;)];</span>
<a href="#l5.145"></a><span id="l5.145">   this._interfaces = this._interfaces.concat(iface);</span>
<a href="#l5.146"></a><span id="l5.146">   // XPConnect will create a wrapper around 'this' after here,</span>
<a href="#l5.147"></a><span id="l5.147">   // so the list of exposed interfaces shouldn't change anymore.</span>
<a href="#l5.148"></a><span id="l5.148">   this.updateContactObserver();</span>
<a href="#l5.149"></a><span id="l5.149">   Services.obs.notifyObservers(this, &quot;new-ui-conversation&quot;);</span>
<a href="#l5.150"></a><span id="l5.150"> }</span>
<a href="#l5.151"></a><span id="l5.151"> </span>
<a href="#l5.152"></a><span id="l5.152"> UIConversation.prototype = {</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-  __proto__: ClassInfo([&quot;imIConversation&quot;, &quot;prplIConversation&quot;, &quot;nsIObserver&quot;],</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-                       &quot;UI conversation&quot;),</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+  __proto__: ClassInfo(</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+    [&quot;imIConversation&quot;, &quot;prplIConversation&quot;, &quot;nsIObserver&quot;],</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+    &quot;UI conversation&quot;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+  ),</span>
<a href="#l5.159"></a><span id="l5.159">   _observedContact: null,</span>
<a href="#l5.160"></a><span id="l5.160">   get contact() {</span>
<a href="#l5.161"></a><span id="l5.161">     let target = this.target;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    if (!target.isChat &amp;&amp; target.buddy)</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+    if (!target.isChat &amp;&amp; target.buddy) {</span>
<a href="#l5.164"></a><span id="l5.164">       return target.buddy.buddy.contact;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+    }</span>
<a href="#l5.166"></a><span id="l5.166">     return null;</span>
<a href="#l5.167"></a><span id="l5.167">   },</span>
<a href="#l5.168"></a><span id="l5.168">   updateContactObserver() {</span>
<a href="#l5.169"></a><span id="l5.169">     let contact = this.contact;</span>
<a href="#l5.170"></a><span id="l5.170">     if (contact &amp;&amp; !this._observedContact) {</span>
<a href="#l5.171"></a><span id="l5.171">       contact.addObserver(this);</span>
<a href="#l5.172"></a><span id="l5.172">       this._observedContact = contact;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-    }</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    else if (!contact &amp;&amp; this.observedContact) {</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+    } else if (!contact &amp;&amp; this.observedContact) {</span>
<a href="#l5.176"></a><span id="l5.176">       this._observedContact.removeObserver(this);</span>
<a href="#l5.177"></a><span id="l5.177">       delete this._observedContact;</span>
<a href="#l5.178"></a><span id="l5.178">     }</span>
<a href="#l5.179"></a><span id="l5.179">   },</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-  get target() { return this._prplConv[this._currentTargetId]; },</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+  get target() {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+    return this._prplConv[this._currentTargetId];</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+  },</span>
<a href="#l5.184"></a><span id="l5.184">   set target(aPrplConversation) {</span>
<a href="#l5.185"></a><span id="l5.185">     this.changeTargetTo(aPrplConversation);</span>
<a href="#l5.186"></a><span id="l5.186">   },</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-  get hasMultipleTargets() { return Object.keys(this._prplConv).length &gt; 1; },</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+  get hasMultipleTargets() {</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+    return Object.keys(this._prplConv).length &gt; 1;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  },</span>
<a href="#l5.191"></a><span id="l5.191">   getTargetByAccount(aAccount) {</span>
<a href="#l5.192"></a><span id="l5.192">     let accountId = aAccount.id;</span>
<a href="#l5.193"></a><span id="l5.193">     for (let id in this._prplConv) {</span>
<a href="#l5.194"></a><span id="l5.194">       let prplConv = this._prplConv[id];</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-      if (prplConv.account.id == accountId)</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+      if (prplConv.account.id == accountId) {</span>
<a href="#l5.197"></a><span id="l5.197">         return prplConv;</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+      }</span>
<a href="#l5.199"></a><span id="l5.199">     }</span>
<a href="#l5.200"></a><span id="l5.200">     return null;</span>
<a href="#l5.201"></a><span id="l5.201">   },</span>
<a href="#l5.202"></a><span id="l5.202">   _currentTargetId: 0,</span>
<a href="#l5.203"></a><span id="l5.203">   changeTargetTo(aPrplConversation) {</span>
<a href="#l5.204"></a><span id="l5.204">     let id = aPrplConversation.id;</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-    if (this._currentTargetId == id)</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+    if (this._currentTargetId == id) {</span>
<a href="#l5.207"></a><span id="l5.207">       return;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+    }</span>
<a href="#l5.209"></a><span id="l5.209"> </span>
<a href="#l5.210"></a><span id="l5.210">     if (!(id in this._prplConv)) {</span>
<a href="#l5.211"></a><span id="l5.211">       this._prplConv[id] = aPrplConversation;</span>
<a href="#l5.212"></a><span id="l5.212">       aPrplConversation.addObserver(this.observeConv.bind(this, id));</span>
<a href="#l5.213"></a><span id="l5.213">     }</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215">     let shouldNotify = this._currentTargetId;</span>
<a href="#l5.216"></a><span id="l5.216">     this._currentTargetId = id;</span>
<a href="#l5.217"></a><span id="l5.217">     if (!this.isChat) {</span>
<a href="#l5.218"></a><span id="l5.218">       let buddy = this.buddy;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-      if (buddy)</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-        ({statusType: this.statusType, statusText: this.statusText} = buddy);</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+      if (buddy) {</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+        ({ statusType: this.statusType, statusText: this.statusText } = buddy);</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+      }</span>
<a href="#l5.224"></a><span id="l5.224">     }</span>
<a href="#l5.225"></a><span id="l5.225">     if (shouldNotify) {</span>
<a href="#l5.226"></a><span id="l5.226">       this.notifyObservers(this, &quot;target-prpl-conversation-changed&quot;);</span>
<a href="#l5.227"></a><span id="l5.227">       let target = this.target;</span>
<a href="#l5.228"></a><span id="l5.228">       let params = [target.title, target.account.protocol.name];</span>
<a href="#l5.229"></a><span id="l5.229">       this.systemMessage(bundle.formatStringFromName(&quot;targetChanged&quot;, params));</span>
<a href="#l5.230"></a><span id="l5.230">     }</span>
<a href="#l5.231"></a><span id="l5.231">   },</span>
<a href="#l5.232"></a><span id="l5.232">   // Returns a boolean indicating if the ui-conversation was closed.</span>
<a href="#l5.233"></a><span id="l5.233">   // If the conversation was closed, aContactId.value is set to the contact id</span>
<a href="#l5.234"></a><span id="l5.234">   // or 0 if no contact was associated with the conversation.</span>
<a href="#l5.235"></a><span id="l5.235">   removeTarget(aPrplConversation, aContactId) {</span>
<a href="#l5.236"></a><span id="l5.236">     let id = aPrplConversation.id;</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-    if (!(id in this._prplConv))</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+    if (!(id in this._prplConv)) {</span>
<a href="#l5.239"></a><span id="l5.239">       throw new Error(&quot;unknown prpl conversation&quot;);</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+    }</span>
<a href="#l5.241"></a><span id="l5.241"> </span>
<a href="#l5.242"></a><span id="l5.242">     delete this._prplConv[id];</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-    if (this._currentTargetId != id)</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+    if (this._currentTargetId != id) {</span>
<a href="#l5.245"></a><span id="l5.245">       return false;</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+    }</span>
<a href="#l5.247"></a><span id="l5.247"> </span>
<a href="#l5.248"></a><span id="l5.248">     for (let newId in this._prplConv) {</span>
<a href="#l5.249"></a><span id="l5.249">       this.changeTargetTo(this._prplConv[newId]);</span>
<a href="#l5.250"></a><span id="l5.250">       return false;</span>
<a href="#l5.251"></a><span id="l5.251">     }</span>
<a href="#l5.252"></a><span id="l5.252"> </span>
<a href="#l5.253"></a><span id="l5.253">     if (this._observedContact) {</span>
<a href="#l5.254"></a><span id="l5.254">       this._observedContact.removeObserver(this);</span>
<a href="#l5.255"></a><span id="l5.255">       aContactId.value = this._observedContact.id;</span>
<a href="#l5.256"></a><span id="l5.256">       delete this._observedContact;</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+    } else {</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+      aContactId.value = 0;</span>
<a href="#l5.259"></a><span id="l5.259">     }</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-    else</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-      aContactId.value = 0;</span>
<a href="#l5.262"></a><span id="l5.262"> </span>
<a href="#l5.263"></a><span id="l5.263">     delete this._currentTargetId;</span>
<a href="#l5.264"></a><span id="l5.264">     this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l5.265"></a><span id="l5.265">     return true;</span>
<a href="#l5.266"></a><span id="l5.266">   },</span>
<a href="#l5.267"></a><span id="l5.267"> </span>
<a href="#l5.268"></a><span id="l5.268">   _unreadMessageCount: 0,</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-  get unreadMessageCount() { return this._unreadMessageCount; },</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+  get unreadMessageCount() {</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+    return this._unreadMessageCount;</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+  },</span>
<a href="#l5.273"></a><span id="l5.273">   _unreadTargetedMessageCount: 0,</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-  get unreadTargetedMessageCount() { return this._unreadTargetedMessageCount; },</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+  get unreadTargetedMessageCount() {</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+    return this._unreadTargetedMessageCount;</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+  },</span>
<a href="#l5.278"></a><span id="l5.278">   _unreadIncomingMessageCount: 0,</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-  get unreadIncomingMessageCount() { return this._unreadIncomingMessageCount; },</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+  get unreadIncomingMessageCount() {</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+    return this._unreadIncomingMessageCount;</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+  },</span>
<a href="#l5.283"></a><span id="l5.283">   markAsRead() {</span>
<a href="#l5.284"></a><span id="l5.284">     delete this._unreadMessageCount;</span>
<a href="#l5.285"></a><span id="l5.285">     delete this._unreadTargetedMessageCount;</span>
<a href="#l5.286"></a><span id="l5.286">     delete this._unreadIncomingMessageCount;</span>
<a href="#l5.287"></a><span id="l5.287">     this._notifyUnreadCountChanged();</span>
<a href="#l5.288"></a><span id="l5.288">   },</span>
<a href="#l5.289"></a><span id="l5.289">   _lastNotifiedUnreadCount: 0,</span>
<a href="#l5.290"></a><span id="l5.290">   _notifyUnreadCountChanged() {</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-    if (this._unreadIncomingMessageCount == this._lastNotifiedUnreadCount)</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+    if (this._unreadIncomingMessageCount == this._lastNotifiedUnreadCount) {</span>
<a href="#l5.293"></a><span id="l5.293">       return;</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+    }</span>
<a href="#l5.295"></a><span id="l5.295"> </span>
<a href="#l5.296"></a><span id="l5.296">     this._lastNotifiedUnreadCount = this._unreadIncomingMessageCount;</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-    for (let observer of this._observers)</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-      observer.observe(this, &quot;unread-message-count-changed&quot;,</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-                       this._unreadIncomingMessageCount.toString());</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+      observer.observe(</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+        this,</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+        &quot;unread-message-count-changed&quot;,</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+        this._unreadIncomingMessageCount.toString()</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+      );</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+    }</span>
<a href="#l5.307"></a><span id="l5.307">   },</span>
<a href="#l5.308"></a><span id="l5.308">   getMessages(aMessageCount) {</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-    if (aMessageCount)</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+    if (aMessageCount) {</span>
<a href="#l5.311"></a><span id="l5.311">       aMessageCount.value = this._messages.length;</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+    }</span>
<a href="#l5.313"></a><span id="l5.313">     return this._messages;</span>
<a href="#l5.314"></a><span id="l5.314">   },</span>
<a href="#l5.315"></a><span id="l5.315">   checkClose() {</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-    if (!this._currentTargetId)</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-      return true; // already closed.</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+    if (!this._currentTargetId) {</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+      return true;</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+    } // already closed.</span>
<a href="#l5.321"></a><span id="l5.321"> </span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-    if (!Services.prefs.getBoolPref(&quot;messenger.conversations.alwaysClose&quot;) &amp;&amp;</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-        (this.isChat &amp;&amp; !this.left ||</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-         !this.isChat &amp;&amp; (this.unreadIncomingMessageCount != 0 ||</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-                          Services.prefs.getBoolPref(&quot;messenger.conversations.holdByDefault&quot;))))</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+    if (</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+      !Services.prefs.getBoolPref(&quot;messenger.conversations.alwaysClose&quot;) &amp;&amp;</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+      ((this.isChat &amp;&amp; !this.left) ||</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+        (!this.isChat &amp;&amp;</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+          (this.unreadIncomingMessageCount != 0 ||</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+            Services.prefs.getBoolPref(</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+              &quot;messenger.conversations.holdByDefault&quot;</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+            ))))</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+    ) {</span>
<a href="#l5.335"></a><span id="l5.335">       return false;</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+    }</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338">     this.close();</span>
<a href="#l5.339"></a><span id="l5.339">     return true;</span>
<a href="#l5.340"></a><span id="l5.340">   },</span>
<a href="#l5.341"></a><span id="l5.341"> </span>
<a href="#l5.342"></a><span id="l5.342">   observe(aSubject, aTopic, aData) {</span>
<a href="#l5.343"></a><span id="l5.343">     if (aTopic == &quot;contact-no-longer-dummy&quot;) {</span>
<a href="#l5.344"></a><span id="l5.344">       let oldId = parseInt(aData);</span>
<a href="#l5.345"></a><span id="l5.345">       // gConversationsService is ugly... :(</span>
<a href="#l5.346"></a><span id="l5.346">       delete gConversationsService._uiConvByContactId[oldId];</span>
<a href="#l5.347"></a><span id="l5.347">       gConversationsService._uiConvByContactId[aSubject.id] = this;</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-    }</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-    else if (aTopic == &quot;account-buddy-status-changed&quot;) {</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-      if (!this._statusUpdatePending &amp;&amp;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineminus">-          aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-          aSubject.buddy.id == this.buddy.buddy.id) {</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-status-changed&quot;) {</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+      if (</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+        !this._statusUpdatePending &amp;&amp;</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+        aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+        aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+      ) {</span>
<a href="#l5.359"></a><span id="l5.359">         this._statusUpdatePending = true;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-        Services.tm.mainThread.dispatch(this.updateBuddyStatus.bind(this),</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-                                        Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+        Services.tm.mainThread.dispatch(</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+          this.updateBuddyStatus.bind(this),</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+          Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+        );</span>
<a href="#l5.366"></a><span id="l5.366">       }</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-icon-changed&quot;) {</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+      if (</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+        !this._statusUpdatePending &amp;&amp;</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+        aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+        aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+      ) {</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+        this._iconUpdatePending = true;</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+        Services.tm.mainThread.dispatch(</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+          this.updateIcon.bind(this),</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+          Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+        );</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+      }</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+    } else if (</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+      aTopic == &quot;account-buddy-display-name-changed&quot; &amp;&amp;</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+      aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+      aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+    ) {</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+      this.notifyObservers(this, &quot;update-buddy-display-name&quot;);</span>
<a href="#l5.385"></a><span id="l5.385">     }</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-    else if (aTopic == &quot;account-buddy-icon-changed&quot;) {</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-      if (!this._statusUpdatePending &amp;&amp;</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-          aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-          aSubject.buddy.id == this.buddy.buddy.id) {</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-        this._iconUpdatePending = true;</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-        Services.tm.mainThread.dispatch(this.updateIcon.bind(this),</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-                                        Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-      }</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-    }</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-    else if (aTopic == &quot;account-buddy-display-name-changed&quot; &amp;&amp;</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-             aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-             aSubject.buddy.id == this.buddy.buddy.id)</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-      this.notifyObservers(this, &quot;update-buddy-display-name&quot;);</span>
<a href="#l5.399"></a><span id="l5.399">   },</span>
<a href="#l5.400"></a><span id="l5.400"> </span>
<a href="#l5.401"></a><span id="l5.401">   _iconUpdatePending: false,</span>
<a href="#l5.402"></a><span id="l5.402">   updateIcon() {</span>
<a href="#l5.403"></a><span id="l5.403">     delete this._iconUpdatePending;</span>
<a href="#l5.404"></a><span id="l5.404">     this.notifyObservers(this, &quot;update-buddy-icon&quot;);</span>
<a href="#l5.405"></a><span id="l5.405">   },</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407">   _statusUpdatePending: false,</span>
<a href="#l5.408"></a><span id="l5.408">   updateBuddyStatus() {</span>
<a href="#l5.409"></a><span id="l5.409">     delete this._statusUpdatePending;</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-    let {statusType: statusType, statusText: statusText} = this.buddy;</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+    let { statusType: statusType, statusText: statusText } = this.buddy;</span>
<a href="#l5.412"></a><span id="l5.412"> </span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-    if ((&quot;statusType&quot; in this) &amp;&amp; this.statusType == statusType &amp;&amp;</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-        this.statusText == statusText)</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+    if (</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+      &quot;statusType&quot; in this &amp;&amp;</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+      this.statusType == statusType &amp;&amp;</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+      this.statusText == statusText</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+    ) {</span>
<a href="#l5.420"></a><span id="l5.420">       return;</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+    }</span>
<a href="#l5.422"></a><span id="l5.422"> </span>
<a href="#l5.423"></a><span id="l5.423">     let wasUnknown = this.statusType == Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l5.424"></a><span id="l5.424">     this.statusType = statusType;</span>
<a href="#l5.425"></a><span id="l5.425">     this.statusText = statusText;</span>
<a href="#l5.426"></a><span id="l5.426"> </span>
<a href="#l5.427"></a><span id="l5.427">     this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l5.428"></a><span id="l5.428"> </span>
<a href="#l5.429"></a><span id="l5.429">     let msg;</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-    if (statusType == Ci.imIStatusInfo.STATUS_UNKNOWN)</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+    if (statusType == Ci.imIStatusInfo.STATUS_UNKNOWN) {</span>
<a href="#l5.432"></a><span id="l5.432">       msg = bundle.formatStringFromName(&quot;statusUnknown&quot;, [this.title]);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-    else {</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+    } else {</span>
<a href="#l5.435"></a><span id="l5.435">       let status = Status.toLabel(statusType);</span>
<a href="#l5.436"></a><span id="l5.436">       let stringId = wasUnknown ? &quot;statusChangedFromUnknown&quot; : &quot;statusChanged&quot;;</span>
<a href="#l5.437"></a><span id="l5.437">       if (this._justReconnected) {</span>
<a href="#l5.438"></a><span id="l5.438">         stringId = &quot;statusKnown&quot;;</span>
<a href="#l5.439"></a><span id="l5.439">         delete this._justReconnected;</span>
<a href="#l5.440"></a><span id="l5.440">       }</span>
<a href="#l5.441"></a><span id="l5.441">       if (statusText) {</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-        msg = bundle.formatStringFromName(stringId + &quot;WithStatusText&quot;,</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-                                          [this.title, status, statusText]);</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+        msg = bundle.formatStringFromName(stringId + &quot;WithStatusText&quot;, [</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+          this.title,</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+          status,</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+          statusText,</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+        ]);</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+      } else {</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+        msg = bundle.formatStringFromName(stringId, [this.title, status]);</span>
<a href="#l5.451"></a><span id="l5.451">       }</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-      else</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-        msg = bundle.formatStringFromName(stringId, [this.title, status]);</span>
<a href="#l5.454"></a><span id="l5.454">     }</span>
<a href="#l5.455"></a><span id="l5.455">     this.systemMessage(msg);</span>
<a href="#l5.456"></a><span id="l5.456">   },</span>
<a href="#l5.457"></a><span id="l5.457"> </span>
<a href="#l5.458"></a><span id="l5.458">   _disconnected: false,</span>
<a href="#l5.459"></a><span id="l5.459">   disconnecting() {</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-    if (this._disconnected)</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+    if (this._disconnected) {</span>
<a href="#l5.462"></a><span id="l5.462">       return;</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+    }</span>
<a href="#l5.464"></a><span id="l5.464"> </span>
<a href="#l5.465"></a><span id="l5.465">     this._disconnected = true;</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-    if (this.contact)</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-      return; // handled by the contact observer.</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+    if (this.contact) {</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+      return;</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+    } // handled by the contact observer.</span>
<a href="#l5.471"></a><span id="l5.471"> </span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-    if (this.isChat &amp;&amp; this.left)</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+    if (this.isChat &amp;&amp; this.left) {</span>
<a href="#l5.474"></a><span id="l5.474">       this._wasLeft = true;</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-    else</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+    } else {</span>
<a href="#l5.477"></a><span id="l5.477">       this.systemMessage(bundle.GetStringFromName(&quot;accountDisconnected&quot;));</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+    }</span>
<a href="#l5.479"></a><span id="l5.479">     this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l5.480"></a><span id="l5.480">   },</span>
<a href="#l5.481"></a><span id="l5.481">   connected() {</span>
<a href="#l5.482"></a><span id="l5.482">     if (this._disconnected) {</span>
<a href="#l5.483"></a><span id="l5.483">       delete this._disconnected;</span>
<a href="#l5.484"></a><span id="l5.484">       let msg = bundle.GetStringFromName(&quot;accountReconnected&quot;);</span>
<a href="#l5.485"></a><span id="l5.485">       if (this.isChat) {</span>
<a href="#l5.486"></a><span id="l5.486">         if (!this._wasLeft) {</span>
<a href="#l5.487"></a><span id="l5.487">           this.systemMessage(msg);</span>
<a href="#l5.488"></a><span id="l5.488">           // Reconnect chat if possible.</span>
<a href="#l5.489"></a><span id="l5.489">           let chatRoomFields = this.target.chatRoomFields;</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-          if (chatRoomFields)</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+          if (chatRoomFields) {</span>
<a href="#l5.492"></a><span id="l5.492">             this.account.joinChat(chatRoomFields);</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+          }</span>
<a href="#l5.494"></a><span id="l5.494">         }</span>
<a href="#l5.495"></a><span id="l5.495">         delete this._wasLeft;</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineminus">-      }</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-      else {</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+      } else {</span>
<a href="#l5.499"></a><span id="l5.499">         this._justReconnected = true;</span>
<a href="#l5.500"></a><span id="l5.500">         // Exclude convs with contacts, these receive presence info updates</span>
<a href="#l5.501"></a><span id="l5.501">         // (and therefore a reconnected message).</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineminus">-        if (!this.contact)</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+        if (!this.contact) {</span>
<a href="#l5.504"></a><span id="l5.504">           this.systemMessage(msg);</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+        }</span>
<a href="#l5.506"></a><span id="l5.506">       }</span>
<a href="#l5.507"></a><span id="l5.507">     }</span>
<a href="#l5.508"></a><span id="l5.508">     this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l5.509"></a><span id="l5.509">   },</span>
<a href="#l5.510"></a><span id="l5.510"> </span>
<a href="#l5.511"></a><span id="l5.511">   observeConv(aTargetId, aSubject, aTopic, aData) {</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-    if (aTargetId != this._currentTargetId &amp;&amp;</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-        (aTopic == &quot;new-text&quot; ||</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-         (aTopic == &quot;update-typing&quot; &amp;&amp;</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-          this._prplConv[aTargetId].typingState == Ci.prplIConvIM.TYPING)))</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+    if (</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+      aTargetId != this._currentTargetId &amp;&amp;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+      (aTopic == &quot;new-text&quot; ||</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+        (aTopic == &quot;update-typing&quot; &amp;&amp;</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+          this._prplConv[aTargetId].typingState == Ci.prplIConvIM.TYPING))</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+    ) {</span>
<a href="#l5.522"></a><span id="l5.522">       this.target = this._prplConv[aTargetId];</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+    }</span>
<a href="#l5.524"></a><span id="l5.524"> </span>
<a href="#l5.525"></a><span id="l5.525">     this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l5.526"></a><span id="l5.526">   },</span>
<a href="#l5.527"></a><span id="l5.527"> </span>
<a href="#l5.528"></a><span id="l5.528">   systemMessage(aText, aIsError) {</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-    let flags = {system: true, noLog: true, error: !!aIsError};</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-    (new Message(&quot;system&quot;, aText, flags)).conversation = this;</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+    let flags = { system: true, noLog: true, error: !!aIsError };</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+    new Message(&quot;system&quot;, aText, flags).conversation = this;</span>
<a href="#l5.533"></a><span id="l5.533">   },</span>
<a href="#l5.534"></a><span id="l5.534"> </span>
<a href="#l5.535"></a><span id="l5.535">   // prplIConversation</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-  get isChat() { return this.target.isChat; },</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-  get account() { return this.target.account; },</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-  get name() { return this.target.name; },</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-  get normalizedName() { return this.target.normalizedName; },</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-  get title() { return this.target.title; },</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-  get startDate() { return this.target.startDate; },</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+  get isChat() {</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+    return this.target.isChat;</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+  },</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+  get account() {</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+    return this.target.account;</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+  },</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+  get name() {</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+    return this.target.name;</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+  },</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+  get normalizedName() {</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+    return this.target.normalizedName;</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+  },</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+  get title() {</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+    return this.target.title;</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+  },</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+  get startDate() {</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+    return this.target.startDate;</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+  },</span>
<a href="#l5.560"></a><span id="l5.560">   sendMsg(aMsg) {</span>
<a href="#l5.561"></a><span id="l5.561">     // Add-ons (eg. pastebin) have an opportunity to cancel the message at this</span>
<a href="#l5.562"></a><span id="l5.562">     // point, or change the text content of the message.</span>
<a href="#l5.563"></a><span id="l5.563">     // If an add-on wants to split a message, it should truncate the first</span>
<a href="#l5.564"></a><span id="l5.564">     // message, and insert new messages using the conversation's sendMsg method.</span>
<a href="#l5.565"></a><span id="l5.565">     let om = new OutgoingMessage(aMsg, this);</span>
<a href="#l5.566"></a><span id="l5.566">     this.notifyObservers(om, &quot;preparing-message&quot;);</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineminus">-    if (om.cancelled)</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+    if (om.cancelled) {</span>
<a href="#l5.569"></a><span id="l5.569">       return;</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+    }</span>
<a href="#l5.571"></a><span id="l5.571"> </span>
<a href="#l5.572"></a><span id="l5.572">     // Protocols have an opportunity here to preprocess messages before they are</span>
<a href="#l5.573"></a><span id="l5.573">     // sent (eg. split long messages). If a message is split here, the split</span>
<a href="#l5.574"></a><span id="l5.574">     // will be visible in the UI.</span>
<a href="#l5.575"></a><span id="l5.575">     let messages = this.target.prepareForSending(om);</span>
<a href="#l5.576"></a><span id="l5.576"> </span>
<a href="#l5.577"></a><span id="l5.577">     // Protocols can return null if they don't need to make any changes.</span>
<a href="#l5.578"></a><span id="l5.578">     // (nb. passing null with retval array results in an empty array)</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-    if (!messages || !messages.length)</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+    if (!messages || !messages.length) {</span>
<a href="#l5.581"></a><span id="l5.581">       messages = [om.message];</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+    }</span>
<a href="#l5.583"></a><span id="l5.583"> </span>
<a href="#l5.584"></a><span id="l5.584">     for (let msg of messages) {</span>
<a href="#l5.585"></a><span id="l5.585">       // Add-ons (eg. OTR) have an opportunity to tweak or cancel the message</span>
<a href="#l5.586"></a><span id="l5.586">       // at this point.</span>
<a href="#l5.587"></a><span id="l5.587">       om = new OutgoingMessage(msg, this.target);</span>
<a href="#l5.588"></a><span id="l5.588">       this.notifyObservers(om, &quot;sending-message&quot;);</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-      if (om.cancelled)</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+      if (om.cancelled) {</span>
<a href="#l5.591"></a><span id="l5.591">         continue;</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+      }</span>
<a href="#l5.593"></a><span id="l5.593">       this.target.sendMsg(om.message);</span>
<a href="#l5.594"></a><span id="l5.594">     }</span>
<a href="#l5.595"></a><span id="l5.595">   },</span>
<a href="#l5.596"></a><span id="l5.596">   unInit() {</span>
<a href="#l5.597"></a><span id="l5.597">     for (let id in this._prplConv) {</span>
<a href="#l5.598"></a><span id="l5.598">       let conv = this._prplConv[id];</span>
<a href="#l5.599"></a><span id="l5.599">       gConversationsService.forgetConversation(conv);</span>
<a href="#l5.600"></a><span id="l5.600">     }</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineat">@@ -413,171 +528,218 @@ UIConversation.prototype = {</span>
<a href="#l5.602"></a><span id="l5.602">     delete this._currentTargetId;</span>
<a href="#l5.603"></a><span id="l5.603">     this.notifyObservers(this, &quot;ui-conversation-destroyed&quot;);</span>
<a href="#l5.604"></a><span id="l5.604">   },</span>
<a href="#l5.605"></a><span id="l5.605">   close() {</span>
<a href="#l5.606"></a><span id="l5.606">     for (let id in this._prplConv) {</span>
<a href="#l5.607"></a><span id="l5.607">       let conv = this._prplConv[id];</span>
<a href="#l5.608"></a><span id="l5.608">       conv.close();</span>
<a href="#l5.609"></a><span id="l5.609">     }</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_currentTargetId&quot;))</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+    if (!this.hasOwnProperty(&quot;_currentTargetId&quot;)) {</span>
<a href="#l5.612"></a><span id="l5.612">       return;</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+    }</span>
<a href="#l5.614"></a><span id="l5.614">     delete this._currentTargetId;</span>
<a href="#l5.615"></a><span id="l5.615">     this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l5.616"></a><span id="l5.616">     Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l5.617"></a><span id="l5.617">   },</span>
<a href="#l5.618"></a><span id="l5.618">   addObserver(aObserver) {</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineminus">-    if (!this._observers.includes(aObserver))</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l5.621"></a><span id="l5.621">       this._observers.push(aObserver);</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineplus">+    }</span>
<a href="#l5.623"></a><span id="l5.623">   },</span>
<a href="#l5.624"></a><span id="l5.624">   removeObserver(aObserver) {</span>
<a href="#l5.625"></a><span id="l5.625">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l5.626"></a><span id="l5.626">   },</span>
<a href="#l5.627"></a><span id="l5.627">   notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l5.628"></a><span id="l5.628">     if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l5.629"></a><span id="l5.629">       aSubject = new imMessage(aSubject);</span>
<a href="#l5.630"></a><span id="l5.630">       this.notifyObservers(aSubject, &quot;received-message&quot;);</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineminus">-      if (aSubject.cancelled)</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+      if (aSubject.cancelled) {</span>
<a href="#l5.633"></a><span id="l5.633">         return;</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-      if (!aSubject.system)</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+      }</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+      if (!aSubject.system) {</span>
<a href="#l5.637"></a><span id="l5.637">         aSubject.conversation.prepareForDisplaying(aSubject);</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+      }</span>
<a href="#l5.639"></a><span id="l5.639"> </span>
<a href="#l5.640"></a><span id="l5.640">       this._messages.push(aSubject);</span>
<a href="#l5.641"></a><span id="l5.641">       ++this._unreadMessageCount;</span>
<a href="#l5.642"></a><span id="l5.642">       if (aSubject.incoming &amp;&amp; !aSubject.system) {</span>
<a href="#l5.643"></a><span id="l5.643">         ++this._unreadIncomingMessageCount;</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineminus">-        if (!this.isChat || aSubject.containsNick)</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+        if (!this.isChat || aSubject.containsNick) {</span>
<a href="#l5.646"></a><span id="l5.646">           ++this._unreadTargetedMessageCount;</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+        }</span>
<a href="#l5.648"></a><span id="l5.648">       }</span>
<a href="#l5.649"></a><span id="l5.649">     }</span>
<a href="#l5.650"></a><span id="l5.650"> </span>
<a href="#l5.651"></a><span id="l5.651">     for (let observer of this._observers) {</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-      if (!observer.observe &amp;&amp; !this._observers.includes(observer))</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineminus">-        continue; // observer removed by a previous call to another observer.</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+      if (!observer.observe &amp;&amp; !this._observers.includes(observer)) {</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+        continue;</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+      } // observer removed by a previous call to another observer.</span>
<a href="#l5.657"></a><span id="l5.657">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l5.658"></a><span id="l5.658">     }</span>
<a href="#l5.659"></a><span id="l5.659">     this._notifyUnreadCountChanged();</span>
<a href="#l5.660"></a><span id="l5.660"> </span>
<a href="#l5.661"></a><span id="l5.661">     if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l5.662"></a><span id="l5.662">       Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-      if (aSubject.incoming &amp;&amp; !aSubject.system &amp;&amp;</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-          (!this.isChat || aSubject.containsNick)) {</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+      if (</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+        aSubject.incoming &amp;&amp;</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+        !aSubject.system &amp;&amp;</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+        (!this.isChat || aSubject.containsNick)</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+      ) {</span>
<a href="#l5.670"></a><span id="l5.670">         this.notifyObservers(aSubject, &quot;new-directed-incoming-message&quot;, aData);</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineminus">-        Services.obs.notifyObservers(aSubject, &quot;new-directed-incoming-message&quot;, aData);</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+        Services.obs.notifyObservers(</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+          aSubject,</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+          &quot;new-directed-incoming-message&quot;,</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+          aData</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+        );</span>
<a href="#l5.677"></a><span id="l5.677">       }</span>
<a href="#l5.678"></a><span id="l5.678">     }</span>
<a href="#l5.679"></a><span id="l5.679">   },</span>
<a href="#l5.680"></a><span id="l5.680"> </span>
<a href="#l5.681"></a><span id="l5.681">   // Used above when notifying of new-texts originating in the</span>
<a href="#l5.682"></a><span id="l5.682">   // UIConversation. This happens when this.systemMessage() is called. The</span>
<a href="#l5.683"></a><span id="l5.683">   // conversation for the message is set as the UIConversation.</span>
<a href="#l5.684"></a><span id="l5.684">   prepareForDisplaying(aMsg) {},</span>
<a href="#l5.685"></a><span id="l5.685"> </span>
<a href="#l5.686"></a><span id="l5.686">   // prplIConvIM</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-  get buddy() { return this.target.buddy; },</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-  get typingState() { return this.target.typingState; },</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineminus">-  sendTyping(aString) { return this.target.sendTyping(aString); },</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+  get buddy() {</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+    return this.target.buddy;</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+  },</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+  get typingState() {</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+    return this.target.typingState;</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+  },</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+  sendTyping(aString) {</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineplus">+    return this.target.sendTyping(aString);</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+  },</span>
<a href="#l5.699"></a><span id="l5.699"> </span>
<a href="#l5.700"></a><span id="l5.700">   // Chat only</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineminus">-  getParticipants() { return this.target.getParticipants(); },</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineminus">-  get topic() { return this.target.topic; },</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineminus">-  set topic(aTopic) { this.target.topic = aTopic; },</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineminus">-  get topicSetter() { return this.target.topicSetter; },</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineminus">-  get topicSettable() { return this.target.topicSettable; },</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineminus">-  get noTopicString() { return bundle.GetStringFromName(&quot;noTopic&quot;); },</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineminus">-  get nick() { return this.target.nick; },</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineminus">-  get left() { return this.target.left; },</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineminus">-  get joining() { return this.target.joining; },</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+  getParticipants() {</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+    return this.target.getParticipants();</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+  },</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+  get topic() {</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+    return this.target.topic;</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+  },</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+  set topic(aTopic) {</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+    this.target.topic = aTopic;</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+  },</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+  get topicSetter() {</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+    return this.target.topicSetter;</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+  },</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+  get topicSettable() {</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineplus">+    return this.target.topicSettable;</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+  },</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+  get noTopicString() {</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+    return bundle.GetStringFromName(&quot;noTopic&quot;);</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+  },</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+  get nick() {</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+    return this.target.nick;</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+  },</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+  get left() {</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+    return this.target.left;</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+  },</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+  get joining() {</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+    return this.target.joining;</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+  },</span>
<a href="#l5.737"></a><span id="l5.737"> };</span>
<a href="#l5.738"></a><span id="l5.738"> </span>
<a href="#l5.739"></a><span id="l5.739"> var gConversationsService;</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineminus">-function ConversationsService() { gConversationsService = this; }</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineplus">+function ConversationsService() {</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineplus">+  gConversationsService = this;</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineplus">+}</span>
<a href="#l5.744"></a><span id="l5.744"> ConversationsService.prototype = {</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineminus">-  get wrappedJSObject() { return this; },</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+  get wrappedJSObject() {</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+    return this;</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+  },</span>
<a href="#l5.749"></a><span id="l5.749"> </span>
<a href="#l5.750"></a><span id="l5.750">   initConversations() {</span>
<a href="#l5.751"></a><span id="l5.751">     this._uiConv = {};</span>
<a href="#l5.752"></a><span id="l5.752">     this._uiConvByContactId = {};</span>
<a href="#l5.753"></a><span id="l5.753">     this._prplConversations = [];</span>
<a href="#l5.754"></a><span id="l5.754">     Services.obs.addObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l5.755"></a><span id="l5.755">     Services.obs.addObserver(this, &quot;account-connected&quot;);</span>
<a href="#l5.756"></a><span id="l5.756">     Services.obs.addObserver(this, &quot;account-buddy-added&quot;);</span>
<a href="#l5.757"></a><span id="l5.757">     Services.obs.addObserver(this, &quot;account-buddy-removed&quot;);</span>
<a href="#l5.758"></a><span id="l5.758">   },</span>
<a href="#l5.759"></a><span id="l5.759"> </span>
<a href="#l5.760"></a><span id="l5.760">   unInitConversations() {</span>
<a href="#l5.761"></a><span id="l5.761">     let UIConvs = this.getUIConversations();</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineminus">-    for (let UIConv of UIConvs)</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+    for (let UIConv of UIConvs) {</span>
<a href="#l5.764"></a><span id="l5.764">       UIConv.unInit();</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineplus">+    }</span>
<a href="#l5.766"></a><span id="l5.766">     delete this._uiConv;</span>
<a href="#l5.767"></a><span id="l5.767">     delete this._uiConvByContactId;</span>
<a href="#l5.768"></a><span id="l5.768">     // This should already be empty, but just to be sure...</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-    for (let prplConv of this._prplConversations)</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+    for (let prplConv of this._prplConversations) {</span>
<a href="#l5.771"></a><span id="l5.771">       prplConv.unInit();</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+    }</span>
<a href="#l5.773"></a><span id="l5.773">     delete this._prplConversations;</span>
<a href="#l5.774"></a><span id="l5.774">     Services.obs.removeObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l5.775"></a><span id="l5.775">     Services.obs.removeObserver(this, &quot;account-connected&quot;);</span>
<a href="#l5.776"></a><span id="l5.776">     Services.obs.removeObserver(this, &quot;account-buddy-added&quot;);</span>
<a href="#l5.777"></a><span id="l5.777">     Services.obs.removeObserver(this, &quot;account-buddy-removed&quot;);</span>
<a href="#l5.778"></a><span id="l5.778">   },</span>
<a href="#l5.779"></a><span id="l5.779"> </span>
<a href="#l5.780"></a><span id="l5.780">   observe(aSubject, aTopic, aData) {</span>
<a href="#l5.781"></a><span id="l5.781">     if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l5.782"></a><span id="l5.782">       for (let id in this._uiConv) {</span>
<a href="#l5.783"></a><span id="l5.783">         let conv = this._uiConv[id];</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineminus">-        if (conv.account.id == aSubject.id)</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineplus">+        if (conv.account.id == aSubject.id) {</span>
<a href="#l5.786"></a><span id="l5.786">           conv.connected();</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+        }</span>
<a href="#l5.788"></a><span id="l5.788">       }</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineminus">-    }</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineminus">-    else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+    } else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l5.792"></a><span id="l5.792">       for (let id in this._uiConv) {</span>
<a href="#l5.793"></a><span id="l5.793">         let conv = this._uiConv[id];</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineminus">-        if (conv.account.id == aSubject.id)</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+        if (conv.account.id == aSubject.id) {</span>
<a href="#l5.796"></a><span id="l5.796">           conv.disconnecting();</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+        }</span>
<a href="#l5.798"></a><span id="l5.798">       }</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineminus">-    }</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineminus">-    else if (aTopic == &quot;account-buddy-added&quot;) {</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-added&quot;) {</span>
<a href="#l5.802"></a><span id="l5.802">       let accountBuddy = aSubject;</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineminus">-      let prplConversation =</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineminus">-        this.getConversationByNameAndAccount(accountBuddy.normalizedName,</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineminus">-                                             accountBuddy.account, false);</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineminus">-      if (!prplConversation)</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+      let prplConversation = this.getConversationByNameAndAccount(</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+        accountBuddy.normalizedName,</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+        accountBuddy.account,</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+        false</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+      );</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineplus">+      if (!prplConversation) {</span>
<a href="#l5.813"></a><span id="l5.813">         return;</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+      }</span>
<a href="#l5.815"></a><span id="l5.815"> </span>
<a href="#l5.816"></a><span id="l5.816">       let uiConv = this.getUIConversation(prplConversation);</span>
<a href="#l5.817"></a><span id="l5.817">       let contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l5.818"></a><span id="l5.818">       if (contactId in this._uiConvByContactId) {</span>
<a href="#l5.819"></a><span id="l5.819">         // Trouble! There is an existing uiConv for this contact.</span>
<a href="#l5.820"></a><span id="l5.820">         // We should avoid having two uiConvs with the same contact.</span>
<a href="#l5.821"></a><span id="l5.821">         // This is ugly UX, but at least can only happen if there is</span>
<a href="#l5.822"></a><span id="l5.822">         // already an accountBuddy with the same name for the same</span>
<a href="#l5.823"></a><span id="l5.823">         // protocol on a different account, which should be rare.</span>
<a href="#l5.824"></a><span id="l5.824">         this.removeConversation(prplConversation);</span>
<a href="#l5.825"></a><span id="l5.825">         return;</span>
<a href="#l5.826"></a><span id="l5.826">       }</span>
<a href="#l5.827"></a><span id="l5.827">       // Link the existing uiConv to the contact.</span>
<a href="#l5.828"></a><span id="l5.828">       this._uiConvByContactId[contactId] = uiConv;</span>
<a href="#l5.829"></a><span id="l5.829">       uiConv.updateContactObserver();</span>
<a href="#l5.830"></a><span id="l5.830">       uiConv.notifyObservers(uiConv, &quot;update-conv-buddy&quot;);</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineminus">-    }</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineminus">-    else if (aTopic == &quot;account-buddy-removed&quot;) {</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-removed&quot;) {</span>
<a href="#l5.834"></a><span id="l5.834">       let accountBuddy = aSubject;</span>
<a href="#l5.835"></a><span id="l5.835">       let contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineminus">-      if (!(contactId in this._uiConvByContactId))</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+      if (!(contactId in this._uiConvByContactId)) {</span>
<a href="#l5.838"></a><span id="l5.838">         return;</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+      }</span>
<a href="#l5.840"></a><span id="l5.840">       let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l5.841"></a><span id="l5.841"> </span>
<a href="#l5.842"></a><span id="l5.842">       // If there is more than one target on the uiConv, close the</span>
<a href="#l5.843"></a><span id="l5.843">       // prplConv as we can't dissociate the uiConv from the contact.</span>
<a href="#l5.844"></a><span id="l5.844">       // The conversation with the contact will continue with a different</span>
<a href="#l5.845"></a><span id="l5.845">       // target.</span>
<a href="#l5.846"></a><span id="l5.846">       if (uiConv.hasMultipleTargets) {</span>
<a href="#l5.847"></a><span id="l5.847">         let prplConversation = uiConv.getTargetByAccount(accountBuddy.account);</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineminus">-        if (prplConversation)</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+        if (prplConversation) {</span>
<a href="#l5.850"></a><span id="l5.850">           this.removeConversation(prplConversation);</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineplus">+        }</span>
<a href="#l5.852"></a><span id="l5.852">         return;</span>
<a href="#l5.853"></a><span id="l5.853">       }</span>
<a href="#l5.854"></a><span id="l5.854"> </span>
<a href="#l5.855"></a><span id="l5.855">       delete this._uiConvByContactId[contactId];</span>
<a href="#l5.856"></a><span id="l5.856">       uiConv.updateContactObserver();</span>
<a href="#l5.857"></a><span id="l5.857">       uiConv.notifyObservers(uiConv, &quot;update-conv-buddy&quot;);</span>
<a href="#l5.858"></a><span id="l5.858">     }</span>
<a href="#l5.859"></a><span id="l5.859">   },</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineat">@@ -589,94 +751,108 @@ ConversationsService.prototype = {</span>
<a href="#l5.861"></a><span id="l5.861"> </span>
<a href="#l5.862"></a><span id="l5.862">     // Notify observers.</span>
<a href="#l5.863"></a><span id="l5.863">     Services.obs.notifyObservers(aPrplConversation, &quot;new-conversation&quot;);</span>
<a href="#l5.864"></a><span id="l5.864"> </span>
<a href="#l5.865"></a><span id="l5.865">     // Update or create the corresponding UI conversation.</span>
<a href="#l5.866"></a><span id="l5.866">     let contactId;</span>
<a href="#l5.867"></a><span id="l5.867">     if (!aPrplConversation.isChat) {</span>
<a href="#l5.868"></a><span id="l5.868">       let accountBuddy = aPrplConversation.buddy;</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineminus">-      if (accountBuddy)</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineplus">+      if (accountBuddy) {</span>
<a href="#l5.871"></a><span id="l5.871">         contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineplus">+      }</span>
<a href="#l5.873"></a><span id="l5.873">     }</span>
<a href="#l5.874"></a><span id="l5.874"> </span>
<a href="#l5.875"></a><span id="l5.875">     if (contactId) {</span>
<a href="#l5.876"></a><span id="l5.876">       if (contactId in this._uiConvByContactId) {</span>
<a href="#l5.877"></a><span id="l5.877">         let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l5.878"></a><span id="l5.878">         uiConv.target = aPrplConversation;</span>
<a href="#l5.879"></a><span id="l5.879">         this._uiConv[aPrplConversation.id] = uiConv;</span>
<a href="#l5.880"></a><span id="l5.880">         return;</span>
<a href="#l5.881"></a><span id="l5.881">       }</span>
<a href="#l5.882"></a><span id="l5.882">     }</span>
<a href="#l5.883"></a><span id="l5.883"> </span>
<a href="#l5.884"></a><span id="l5.884">     let newUIConv = new UIConversation(aPrplConversation);</span>
<a href="#l5.885"></a><span id="l5.885">     this._uiConv[aPrplConversation.id] = newUIConv;</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-    if (contactId)</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineplus">+    if (contactId) {</span>
<a href="#l5.888"></a><span id="l5.888">       this._uiConvByContactId[contactId] = newUIConv;</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineplus">+    }</span>
<a href="#l5.890"></a><span id="l5.890">   },</span>
<a href="#l5.891"></a><span id="l5.891">   removeConversation(aPrplConversation) {</span>
<a href="#l5.892"></a><span id="l5.892">     Services.obs.notifyObservers(aPrplConversation, &quot;conversation-closed&quot;);</span>
<a href="#l5.893"></a><span id="l5.893"> </span>
<a href="#l5.894"></a><span id="l5.894">     let uiConv = this.getUIConversation(aPrplConversation);</span>
<a href="#l5.895"></a><span id="l5.895">     delete this._uiConv[aPrplConversation.id];</span>
<a href="#l5.896"></a><span id="l5.896">     let contactId = {};</span>
<a href="#l5.897"></a><span id="l5.897">     if (uiConv.removeTarget(aPrplConversation, contactId)) {</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineminus">-      if (contactId.value)</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+      if (contactId.value) {</span>
<a href="#l5.900"></a><span id="l5.900">         delete this._uiConvByContactId[contactId.value];</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineplus">+      }</span>
<a href="#l5.902"></a><span id="l5.902">       Services.obs.notifyObservers(uiConv, &quot;ui-conversation-closed&quot;);</span>
<a href="#l5.903"></a><span id="l5.903">     }</span>
<a href="#l5.904"></a><span id="l5.904">     this.forgetConversation(aPrplConversation);</span>
<a href="#l5.905"></a><span id="l5.905">   },</span>
<a href="#l5.906"></a><span id="l5.906">   forgetConversation(aPrplConversation) {</span>
<a href="#l5.907"></a><span id="l5.907">     aPrplConversation.unInit();</span>
<a href="#l5.908"></a><span id="l5.908"> </span>
<a href="#l5.909"></a><span id="l5.909" class="difflineminus">-    this._prplConversations =</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineminus">-      this._prplConversations.filter(c =&gt; c !== aPrplConversation);</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineplus">+    this._prplConversations = this._prplConversations.filter(</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineplus">+      c =&gt; c !== aPrplConversation</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineplus">+    );</span>
<a href="#l5.914"></a><span id="l5.914">   },</span>
<a href="#l5.915"></a><span id="l5.915"> </span>
<a href="#l5.916"></a><span id="l5.916">   getUIConversations(aConvCount) {</span>
<a href="#l5.917"></a><span id="l5.917">     let rv = [];</span>
<a href="#l5.918"></a><span id="l5.918">     if (this._uiConv) {</span>
<a href="#l5.919"></a><span id="l5.919">       for (let prplConvId in this._uiConv) {</span>
<a href="#l5.920"></a><span id="l5.920">         // Since an UIConversation may be linked to multiple prplConversations,</span>
<a href="#l5.921"></a><span id="l5.921">         // we must ensure we don't return the same UIConversation twice,</span>
<a href="#l5.922"></a><span id="l5.922">         // by checking the id matches that of the active prplConversation.</span>
<a href="#l5.923"></a><span id="l5.923">         let uiConv = this._uiConv[prplConvId];</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineminus">-        if (prplConvId == uiConv.target.id)</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineplus">+        if (prplConvId == uiConv.target.id) {</span>
<a href="#l5.926"></a><span id="l5.926">           rv.push(uiConv);</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineplus">+        }</span>
<a href="#l5.928"></a><span id="l5.928">       }</span>
<a href="#l5.929"></a><span id="l5.929">     }</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineminus">-    if (aConvCount)</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineplus">+    if (aConvCount) {</span>
<a href="#l5.932"></a><span id="l5.932">       aConvCount.value = rv.length;</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+    }</span>
<a href="#l5.934"></a><span id="l5.934">     return rv;</span>
<a href="#l5.935"></a><span id="l5.935">   },</span>
<a href="#l5.936"></a><span id="l5.936">   getUIConversation(aPrplConversation) {</span>
<a href="#l5.937"></a><span id="l5.937">     let id = aPrplConversation.id;</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineminus">-    if (this._uiConv &amp;&amp; id in this._uiConv)</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineplus">+    if (this._uiConv &amp;&amp; id in this._uiConv) {</span>
<a href="#l5.940"></a><span id="l5.940">       return this._uiConv[id];</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineplus">+    }</span>
<a href="#l5.942"></a><span id="l5.942">     throw new Error(&quot;Unknown conversation&quot;);</span>
<a href="#l5.943"></a><span id="l5.943">   },</span>
<a href="#l5.944"></a><span id="l5.944">   getUIConversationByContactId(aId) {</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineminus">-    return (aId in this._uiConvByContactId) ? this._uiConvByContactId[aId] : null;</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+    return aId in this._uiConvByContactId ? this._uiConvByContactId[aId] : null;</span>
<a href="#l5.947"></a><span id="l5.947">   },</span>
<a href="#l5.948"></a><span id="l5.948"> </span>
<a href="#l5.949"></a><span id="l5.949" class="difflineminus">-  getConversations() { return new nsSimpleEnumerator(this._prplConversations); },</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+  getConversations() {</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineplus">+    return new nsSimpleEnumerator(this._prplConversations);</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineplus">+  },</span>
<a href="#l5.953"></a><span id="l5.953">   getConversationById(aId) {</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-    for (let conv of this._prplConversations)</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineminus">-      if (conv.id == aId)</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineplus">+    for (let conv of this._prplConversations) {</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineplus">+      if (conv.id == aId) {</span>
<a href="#l5.958"></a><span id="l5.958">         return conv;</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+      }</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+    }</span>
<a href="#l5.961"></a><span id="l5.961">     return null;</span>
<a href="#l5.962"></a><span id="l5.962">   },</span>
<a href="#l5.963"></a><span id="l5.963">   getConversationByNameAndAccount(aName, aAccount, aIsChat) {</span>
<a href="#l5.964"></a><span id="l5.964">     let normalizedName = aAccount.normalize(aName);</span>
<a href="#l5.965"></a><span id="l5.965">     for (let conv of this._prplConversations) {</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineminus">-      if (aAccount.normalize(conv.name) == normalizedName &amp;&amp;</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineminus">-          aAccount.numericId == conv.account.numericId &amp;&amp;</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineminus">-          conv.isChat == aIsChat)</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineplus">+      if (</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineplus">+        aAccount.normalize(conv.name) == normalizedName &amp;&amp;</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineplus">+        aAccount.numericId == conv.account.numericId &amp;&amp;</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineplus">+        conv.isChat == aIsChat</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineplus">+      ) {</span>
<a href="#l5.974"></a><span id="l5.974">         return conv;</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineplus">+      }</span>
<a href="#l5.976"></a><span id="l5.976">     }</span>
<a href="#l5.977"></a><span id="l5.977">     return null;</span>
<a href="#l5.978"></a><span id="l5.978">   },</span>
<a href="#l5.979"></a><span id="l5.979"> </span>
<a href="#l5.980"></a><span id="l5.980">   QueryInterface: ChromeUtils.generateQI([Ci.imIConversationsService]),</span>
<a href="#l5.981"></a><span id="l5.981">   classDescription: &quot;Conversations&quot;,</span>
<a href="#l5.982"></a><span id="l5.982">   classID: Components.ID(&quot;{b2397cd5-c76d-4618-8410-f344c7c6443a}&quot;),</span>
<a href="#l5.983"></a><span id="l5.983">   contractID: &quot;@mozilla.org/chat/conversations-service;1&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/components/src/imCore.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/components/src/imCore.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,174 +1,204 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> var {</span>
<a href="#l6.11"></a><span id="l6.11">   XPCOMUtils,</span>
<a href="#l6.12"></a><span id="l6.12">   ClassInfo,</span>
<a href="#l6.13"></a><span id="l6.13">   initLogModule,</span>
<a href="#l6.14"></a><span id="l6.14">   nsSimpleEnumerator,</span>
<a href="#l6.15"></a><span id="l6.15"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;categoryManager&quot;,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-                                   &quot;@mozilla.org/categorymanager;1&quot;,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-                                   &quot;nsICategoryManager&quot;);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  this,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  &quot;categoryManager&quot;,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  &quot;@mozilla.org/categorymanager;1&quot;,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  &quot;nsICategoryManager&quot;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+);</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> var kQuitApplicationGranted = &quot;quit-application-granted&quot;;</span>
<a href="#l6.28"></a><span id="l6.28"> var kProtocolPluginCategory = &quot;im-protocol-plugin&quot;;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-var kPrefReportIdle =        &quot;messenger.status.reportIdle&quot;;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-var kPrefUserIconFilename =  &quot;messenger.status.userIconFileName&quot;;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-var kPrefUserDisplayname =   &quot;messenger.status.userDisplayName&quot;;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-var kPrefTimeBeforeIdle =    &quot;messenger.status.timeBeforeIdle&quot;;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-var kPrefAwayWhenIdle =      &quot;messenger.status.awayWhenIdle&quot;;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-var kPrefDefaultMessage =    &quot;messenger.status.defaultIdleAwayMessage&quot;;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+var kPrefReportIdle = &quot;messenger.status.reportIdle&quot;;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+var kPrefUserIconFilename = &quot;messenger.status.userIconFileName&quot;;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+var kPrefUserDisplayname = &quot;messenger.status.userDisplayName&quot;;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+var kPrefTimeBeforeIdle = &quot;messenger.status.timeBeforeIdle&quot;;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+var kPrefAwayWhenIdle = &quot;messenger.status.awayWhenIdle&quot;;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+var kPrefDefaultMessage = &quot;messenger.status.defaultIdleAwayMessage&quot;;</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43"> var NS_IOSERVICE_GOING_OFFLINE_TOPIC = &quot;network:offline-about-to-go-offline&quot;;</span>
<a href="#l6.44"></a><span id="l6.44"> var NS_IOSERVICE_OFFLINE_STATUS_TOPIC = &quot;network:offline-status-changed&quot;;</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-function UserStatus()</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-{</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+function UserStatus() {</span>
<a href="#l6.49"></a><span id="l6.49">   this._observers = [];</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  if (Services.prefs.getBoolPref(kPrefReportIdle))</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  if (Services.prefs.getBoolPref(kPrefReportIdle)) {</span>
<a href="#l6.53"></a><span id="l6.53">     this._addIdleObserver();</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  }</span>
<a href="#l6.55"></a><span id="l6.55">   Services.prefs.addObserver(kPrefReportIdle, this);</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  if (Services.io.offline)</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  if (Services.io.offline) {</span>
<a href="#l6.59"></a><span id="l6.59">     this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  }</span>
<a href="#l6.61"></a><span id="l6.61">   Services.obs.addObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC);</span>
<a href="#l6.62"></a><span id="l6.62">   Services.obs.addObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC);</span>
<a href="#l6.63"></a><span id="l6.63"> }</span>
<a href="#l6.64"></a><span id="l6.64"> UserStatus.prototype = {</span>
<a href="#l6.65"></a><span id="l6.65">   __proto__: ClassInfo(&quot;imIUserStatusInfo&quot;, &quot;User status info&quot;),</span>
<a href="#l6.66"></a><span id="l6.66"> </span>
<a href="#l6.67"></a><span id="l6.67">   unInit() {</span>
<a href="#l6.68"></a><span id="l6.68">     this._observers = [];</span>
<a href="#l6.69"></a><span id="l6.69">     Services.prefs.removeObserver(kPrefReportIdle, this);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-    if (this._observingIdleness)</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    if (this._observingIdleness) {</span>
<a href="#l6.72"></a><span id="l6.72">       this._removeIdleObserver();</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    }</span>
<a href="#l6.74"></a><span id="l6.74">     Services.obs.removeObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC);</span>
<a href="#l6.75"></a><span id="l6.75">     Services.obs.removeObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC);</span>
<a href="#l6.76"></a><span id="l6.76">   },</span>
<a href="#l6.77"></a><span id="l6.77">   _observingIdleness: false,</span>
<a href="#l6.78"></a><span id="l6.78">   _addIdleObserver() {</span>
<a href="#l6.79"></a><span id="l6.79">     this._observingIdleness = true;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    this._idleService =</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-      Cc[&quot;@mozilla.org/widget/idleservice;1&quot;].getService(Ci.nsIIdleService);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+    this._idleService = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;].getService(</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+      Ci.nsIIdleService</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+    );</span>
<a href="#l6.85"></a><span id="l6.85">     Services.obs.addObserver(this, &quot;im-sent&quot;);</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">     this._timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    if (this._timeBeforeIdle &lt; 0)</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    if (this._timeBeforeIdle &lt; 0) {</span>
<a href="#l6.90"></a><span id="l6.90">       this._timeBeforeIdle = 0;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    }</span>
<a href="#l6.92"></a><span id="l6.92">     Services.prefs.addObserver(kPrefTimeBeforeIdle, this);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-    if (this._timeBeforeIdle)</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+    if (this._timeBeforeIdle) {</span>
<a href="#l6.95"></a><span id="l6.95">       this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+    }</span>
<a href="#l6.97"></a><span id="l6.97">   },</span>
<a href="#l6.98"></a><span id="l6.98">   _removeIdleObserver() {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-    if (this._timeBeforeIdle)</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    if (this._timeBeforeIdle) {</span>
<a href="#l6.101"></a><span id="l6.101">       this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+    }</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104">     Services.prefs.removeObserver(kPrefTimeBeforeIdle, this);</span>
<a href="#l6.105"></a><span id="l6.105">     delete this._timeBeforeIdle;</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107">     Services.obs.removeObserver(this, &quot;im-sent&quot;);</span>
<a href="#l6.108"></a><span id="l6.108">     delete this._idleService;</span>
<a href="#l6.109"></a><span id="l6.109">     delete this._observingIdleness;</span>
<a href="#l6.110"></a><span id="l6.110">   },</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112">   observe(aSubject, aTopic, aData) {</span>
<a href="#l6.113"></a><span id="l6.113">     if (aTopic == &quot;nsPref:changed&quot;) {</span>
<a href="#l6.114"></a><span id="l6.114">       if (aData == kPrefReportIdle) {</span>
<a href="#l6.115"></a><span id="l6.115">         let reportIdle = Services.prefs.getBoolPref(kPrefReportIdle);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-        if (reportIdle &amp;&amp; !this._observingIdleness)</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+        if (reportIdle &amp;&amp; !this._observingIdleness) {</span>
<a href="#l6.118"></a><span id="l6.118">           this._addIdleObserver();</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-        else if (!reportIdle &amp;&amp; this._observingIdleness)</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-        this._removeIdleObserver();</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-      }</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-      else if (aData == kPrefTimeBeforeIdle) {</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+        } else if (!reportIdle &amp;&amp; this._observingIdleness) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+          this._removeIdleObserver();</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+        }</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+      } else if (aData == kPrefTimeBeforeIdle) {</span>
<a href="#l6.127"></a><span id="l6.127">         let timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l6.128"></a><span id="l6.128">         if (timeBeforeIdle != this._timeBeforeIdle) {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-          if (this._timeBeforeIdle)</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+          if (this._timeBeforeIdle) {</span>
<a href="#l6.131"></a><span id="l6.131">             this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+          }</span>
<a href="#l6.133"></a><span id="l6.133">           this._timeBeforeIdle = timeBeforeIdle;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-          if (this._timeBeforeIdle)</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+          if (this._timeBeforeIdle) {</span>
<a href="#l6.136"></a><span id="l6.136">             this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+          }</span>
<a href="#l6.138"></a><span id="l6.138">         }</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+      } else {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+        throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l6.141"></a><span id="l6.141">       }</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-      else</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-        throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-    }</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-    else if (aTopic == NS_IOSERVICE_GOING_OFFLINE_TOPIC)</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+    } else if (aTopic == NS_IOSERVICE_GOING_OFFLINE_TOPIC) {</span>
<a href="#l6.147"></a><span id="l6.147">       this.offline = true;</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    else if (aTopic == NS_IOSERVICE_OFFLINE_STATUS_TOPIC &amp;&amp; aData == &quot;online&quot;)</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    } else if (</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+      aTopic == NS_IOSERVICE_OFFLINE_STATUS_TOPIC &amp;&amp;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+      aData == &quot;online&quot;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+    ) {</span>
<a href="#l6.153"></a><span id="l6.153">       this.offline = false;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-    else</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+    } else {</span>
<a href="#l6.156"></a><span id="l6.156">       this._checkIdle();</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+    }</span>
<a href="#l6.158"></a><span id="l6.158">   },</span>
<a href="#l6.159"></a><span id="l6.159"> </span>
<a href="#l6.160"></a><span id="l6.160">   _offlineStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l6.161"></a><span id="l6.161">   set offline(aOffline) {</span>
<a href="#l6.162"></a><span id="l6.162">     let statusType = this.statusType;</span>
<a href="#l6.163"></a><span id="l6.163">     let statusText = this.statusText;</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-    if (aOffline)</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+    if (aOffline) {</span>
<a href="#l6.166"></a><span id="l6.166">       this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-    else</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+    } else {</span>
<a href="#l6.169"></a><span id="l6.169">       delete this._offlineStatusType;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-    if (this.statusType != statusType || this.statusText != statusText)</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+    }</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+    if (this.statusType != statusType || this.statusText != statusText) {</span>
<a href="#l6.173"></a><span id="l6.173">       this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+    }</span>
<a href="#l6.175"></a><span id="l6.175">   },</span>
<a href="#l6.176"></a><span id="l6.176"> </span>
<a href="#l6.177"></a><span id="l6.177">   _idleTime: 0,</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-  get idleTime() { return this._idleTime; },</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+  get idleTime() {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    return this._idleTime;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  },</span>
<a href="#l6.182"></a><span id="l6.182">   set idleTime(aIdleTime) {</span>
<a href="#l6.183"></a><span id="l6.183">     this._idleTime = aIdleTime;</span>
<a href="#l6.184"></a><span id="l6.184">     this._notifyObservers(&quot;idle-time-changed&quot;, aIdleTime);</span>
<a href="#l6.185"></a><span id="l6.185">   },</span>
<a href="#l6.186"></a><span id="l6.186">   _idle: false,</span>
<a href="#l6.187"></a><span id="l6.187">   _idleStatusText: &quot;&quot;,</span>
<a href="#l6.188"></a><span id="l6.188">   _idleStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l6.189"></a><span id="l6.189">   _checkIdle() {</span>
<a href="#l6.190"></a><span id="l6.190">     let idleTime = Math.floor(this._idleService.idleTime / 1000);</span>
<a href="#l6.191"></a><span id="l6.191">     let idle = this._timeBeforeIdle &amp;&amp; idleTime &gt;= this._timeBeforeIdle;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    if (idle == this._idle)</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+    if (idle == this._idle) {</span>
<a href="#l6.194"></a><span id="l6.194">       return;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+    }</span>
<a href="#l6.196"></a><span id="l6.196"> </span>
<a href="#l6.197"></a><span id="l6.197">     let statusType = this.statusType;</span>
<a href="#l6.198"></a><span id="l6.198">     let statusText = this.statusText;</span>
<a href="#l6.199"></a><span id="l6.199">     this._idle = idle;</span>
<a href="#l6.200"></a><span id="l6.200">     if (idle) {</span>
<a href="#l6.201"></a><span id="l6.201">       this.idleTime = idleTime;</span>
<a href="#l6.202"></a><span id="l6.202">       if (Services.prefs.getBoolPref(kPrefAwayWhenIdle)) {</span>
<a href="#l6.203"></a><span id="l6.203">         this._idleStatusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-        this._idleStatusText =</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-          Services.prefs.getComplexValue(kPrefDefaultMessage,</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-                                         Ci.nsIPrefLocalizedString).data;</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+        this._idleStatusText = Services.prefs.getComplexValue(</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+          kPrefDefaultMessage,</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+          Ci.nsIPrefLocalizedString</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+        ).data;</span>
<a href="#l6.211"></a><span id="l6.211">       }</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-    }</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-    else {</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    } else {</span>
<a href="#l6.215"></a><span id="l6.215">       this.idleTime = 0;</span>
<a href="#l6.216"></a><span id="l6.216">       delete this._idleStatusType;</span>
<a href="#l6.217"></a><span id="l6.217">       delete this._idleStatusText;</span>
<a href="#l6.218"></a><span id="l6.218">     }</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-    if (this.statusType != statusType || this.statusText != statusText)</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+    if (this.statusType != statusType || this.statusText != statusText) {</span>
<a href="#l6.221"></a><span id="l6.221">       this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+    }</span>
<a href="#l6.223"></a><span id="l6.223">   },</span>
<a href="#l6.224"></a><span id="l6.224"> </span>
<a href="#l6.225"></a><span id="l6.225">   _statusText: &quot;&quot;,</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-  get statusText() { return this._statusText || this._idleStatusText; },</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+  get statusText() {</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+    return this._statusText || this._idleStatusText;</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+  },</span>
<a href="#l6.230"></a><span id="l6.230">   _statusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-  get statusType() { return Math.min(this._statusType, this._idleStatusType, this._offlineStatusType); },</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+  get statusType() {</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+    return Math.min(</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+      this._statusType,</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+      this._idleStatusType,</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+      this._offlineStatusType</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+    );</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+  },</span>
<a href="#l6.239"></a><span id="l6.239">   setStatus(aStatus, aMessage) {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    if (aStatus != Ci.imIStatusInfo.STATUS_UNKNOWN)</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+    if (aStatus != Ci.imIStatusInfo.STATUS_UNKNOWN) {</span>
<a href="#l6.242"></a><span id="l6.242">       this._statusType = aStatus;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-    if (aStatus != Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+    }</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+    if (aStatus != Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l6.246"></a><span id="l6.246">       this._statusText = aMessage;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+    }</span>
<a href="#l6.248"></a><span id="l6.248">     this._notifyObservers(&quot;status-changed&quot;, aMessage);</span>
<a href="#l6.249"></a><span id="l6.249">   },</span>
<a href="#l6.250"></a><span id="l6.250"> </span>
<a href="#l6.251"></a><span id="l6.251">   _getProfileDir: () =&gt; Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile),</span>
<a href="#l6.252"></a><span id="l6.252">   setUserIcon(aIconFile) {</span>
<a href="#l6.253"></a><span id="l6.253">     let folder = this._getProfileDir();</span>
<a href="#l6.254"></a><span id="l6.254"> </span>
<a href="#l6.255"></a><span id="l6.255">     let newName = &quot;&quot;;</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineat">@@ -187,29 +217,31 @@ UserStatus.prototype = {</span>
<a href="#l6.257"></a><span id="l6.257">     Services.prefs.setCharPref(kPrefUserIconFilename, newName);</span>
<a href="#l6.258"></a><span id="l6.258"> </span>
<a href="#l6.259"></a><span id="l6.259">     // Now that the new icon has been copied to the profile directory</span>
<a href="#l6.260"></a><span id="l6.260">     // and the pref value changed, we can remove the old icon. Ignore</span>
<a href="#l6.261"></a><span id="l6.261">     // failures so that we always fire the user-icon-changed notification.</span>
<a href="#l6.262"></a><span id="l6.262">     try {</span>
<a href="#l6.263"></a><span id="l6.263">       if (oldFileName) {</span>
<a href="#l6.264"></a><span id="l6.264">         folder.append(oldFileName);</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-        if (folder.exists())</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+        if (folder.exists()) {</span>
<a href="#l6.267"></a><span id="l6.267">           folder.remove(false);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+        }</span>
<a href="#l6.269"></a><span id="l6.269">       }</span>
<a href="#l6.270"></a><span id="l6.270">     } catch (e) {</span>
<a href="#l6.271"></a><span id="l6.271">       Cu.reportError(e);</span>
<a href="#l6.272"></a><span id="l6.272">     }</span>
<a href="#l6.273"></a><span id="l6.273"> </span>
<a href="#l6.274"></a><span id="l6.274">     this._notifyObservers(&quot;user-icon-changed&quot;, newName);</span>
<a href="#l6.275"></a><span id="l6.275">   },</span>
<a href="#l6.276"></a><span id="l6.276">   getUserIcon() {</span>
<a href="#l6.277"></a><span id="l6.277">     let filename = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-    if (!filename)</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-      return null; // No icon has been set.</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+    if (!filename) {</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+      return null;</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+    } // No icon has been set.</span>
<a href="#l6.283"></a><span id="l6.283"> </span>
<a href="#l6.284"></a><span id="l6.284">     let file = this._getProfileDir();</span>
<a href="#l6.285"></a><span id="l6.285">     file.append(filename);</span>
<a href="#l6.286"></a><span id="l6.286"> </span>
<a href="#l6.287"></a><span id="l6.287">     if (!file.exists()) {</span>
<a href="#l6.288"></a><span id="l6.288">       Services.console.logStringMessage(&quot;Invalid userIconFileName preference&quot;);</span>
<a href="#l6.289"></a><span id="l6.289">       return null;</span>
<a href="#l6.290"></a><span id="l6.290">     }</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineat">@@ -221,38 +253,45 @@ UserStatus.prototype = {</span>
<a href="#l6.292"></a><span id="l6.292">     return Services.prefs.getStringPref(kPrefUserDisplayname);</span>
<a href="#l6.293"></a><span id="l6.293">   },</span>
<a href="#l6.294"></a><span id="l6.294">   set displayName(aDisplayName) {</span>
<a href="#l6.295"></a><span id="l6.295">     Services.prefs.setStringPref(kPrefUserDisplayname, aDisplayName);</span>
<a href="#l6.296"></a><span id="l6.296">     this._notifyObservers(&quot;user-display-name-changed&quot;, aDisplayName);</span>
<a href="#l6.297"></a><span id="l6.297">   },</span>
<a href="#l6.298"></a><span id="l6.298"> </span>
<a href="#l6.299"></a><span id="l6.299">   addObserver(aObserver) {</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-    if (!this._observers.includes(aObserver))</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l6.302"></a><span id="l6.302">       this._observers.push(aObserver);</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+    }</span>
<a href="#l6.304"></a><span id="l6.304">   },</span>
<a href="#l6.305"></a><span id="l6.305">   removeObserver(aObserver) {</span>
<a href="#l6.306"></a><span id="l6.306">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l6.307"></a><span id="l6.307">   },</span>
<a href="#l6.308"></a><span id="l6.308">   _notifyObservers(aTopic, aData) {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-    for (let observer of this._observers)</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l6.311"></a><span id="l6.311">       observer.observe(this, aTopic, aData);</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+    }</span>
<a href="#l6.313"></a><span id="l6.313">   },</span>
<a href="#l6.314"></a><span id="l6.314"> };</span>
<a href="#l6.315"></a><span id="l6.315"> </span>
<a href="#l6.316"></a><span id="l6.316"> var gCoreService;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-function CoreService() { gCoreService = this; }</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+function CoreService() {</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+  gCoreService = this;</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+}</span>
<a href="#l6.321"></a><span id="l6.321"> CoreService.prototype = {</span>
<a href="#l6.322"></a><span id="l6.322">   globalUserStatus: null,</span>
<a href="#l6.323"></a><span id="l6.323"> </span>
<a href="#l6.324"></a><span id="l6.324">   _initialized: false,</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-  get initialized() { return this._initialized; },</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+  get initialized() {</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+    return this._initialized;</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+  },</span>
<a href="#l6.329"></a><span id="l6.329">   init() {</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-    if (this._initialized)</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+    if (this._initialized) {</span>
<a href="#l6.332"></a><span id="l6.332">       return;</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+    }</span>
<a href="#l6.334"></a><span id="l6.334"> </span>
<a href="#l6.335"></a><span id="l6.335">     initLogModule(&quot;core&quot;, this);</span>
<a href="#l6.336"></a><span id="l6.336"> </span>
<a href="#l6.337"></a><span id="l6.337">     Services.obs.addObserver(this, kQuitApplicationGranted);</span>
<a href="#l6.338"></a><span id="l6.338">     this._initialized = true;</span>
<a href="#l6.339"></a><span id="l6.339"> </span>
<a href="#l6.340"></a><span id="l6.340">     Services.cmd.initCommands();</span>
<a href="#l6.341"></a><span id="l6.341">     this._protos = {};</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineat">@@ -274,68 +313,76 @@ CoreService.prototype = {</span>
<a href="#l6.343"></a><span id="l6.343">     // is available.</span>
<a href="#l6.344"></a><span id="l6.344">     if (accounts.autoLoginStatus == Ci.imIAccountsService.AUTOLOGIN_ENABLED) {</span>
<a href="#l6.345"></a><span id="l6.345">       Services.logins.initializationPromise.then(() =&gt; {</span>
<a href="#l6.346"></a><span id="l6.346">         Services.accounts.processAutoLogin();</span>
<a href="#l6.347"></a><span id="l6.347">       });</span>
<a href="#l6.348"></a><span id="l6.348">     }</span>
<a href="#l6.349"></a><span id="l6.349">   },</span>
<a href="#l6.350"></a><span id="l6.350">   observe(aObject, aTopic, aData) {</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    if (aTopic == kQuitApplicationGranted)</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+    if (aTopic == kQuitApplicationGranted) {</span>
<a href="#l6.353"></a><span id="l6.353">       this.quit();</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+    }</span>
<a href="#l6.355"></a><span id="l6.355">   },</span>
<a href="#l6.356"></a><span id="l6.356">   quit() {</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-    if (!this._initialized)</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    if (!this._initialized) {</span>
<a href="#l6.359"></a><span id="l6.359">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+    }</span>
<a href="#l6.361"></a><span id="l6.361"> </span>
<a href="#l6.362"></a><span id="l6.362">     Services.obs.removeObserver(this, kQuitApplicationGranted);</span>
<a href="#l6.363"></a><span id="l6.363">     Services.obs.notifyObservers(this, &quot;prpl-quit&quot;);</span>
<a href="#l6.364"></a><span id="l6.364"> </span>
<a href="#l6.365"></a><span id="l6.365">     Services.conversations.unInitConversations();</span>
<a href="#l6.366"></a><span id="l6.366">     Services.accounts.unInitAccounts();</span>
<a href="#l6.367"></a><span id="l6.367">     Services.contacts.unInitContacts();</span>
<a href="#l6.368"></a><span id="l6.368">     Services.cmd.unInitCommands();</span>
<a href="#l6.369"></a><span id="l6.369"> </span>
<a href="#l6.370"></a><span id="l6.370">     this.globalUserStatus.unInit();</span>
<a href="#l6.371"></a><span id="l6.371">     delete this.globalUserStatus;</span>
<a href="#l6.372"></a><span id="l6.372">     delete this._protos;</span>
<a href="#l6.373"></a><span id="l6.373">     delete this._initialized;</span>
<a href="#l6.374"></a><span id="l6.374">   },</span>
<a href="#l6.375"></a><span id="l6.375"> </span>
<a href="#l6.376"></a><span id="l6.376">   getProtocols() {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-    if (!this._initialized)</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+    if (!this._initialized) {</span>
<a href="#l6.379"></a><span id="l6.379">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+    }</span>
<a href="#l6.381"></a><span id="l6.381"> </span>
<a href="#l6.382"></a><span id="l6.382">     let protocols = [];</span>
<a href="#l6.383"></a><span id="l6.383">     let entries = categoryManager.enumerateCategory(kProtocolPluginCategory);</span>
<a href="#l6.384"></a><span id="l6.384">     while (entries.hasMoreElements()) {</span>
<a href="#l6.385"></a><span id="l6.385">       let id = entries.getNext().QueryInterface(Ci.nsISupportsCString).data;</span>
<a href="#l6.386"></a><span id="l6.386"> </span>
<a href="#l6.387"></a><span id="l6.387">       // If the preference is set to disable this prpl, don't show it in the</span>
<a href="#l6.388"></a><span id="l6.388">       // full list of protocols.</span>
<a href="#l6.389"></a><span id="l6.389">       let pref = &quot;chat.prpls.&quot; + id + &quot;.disable&quot;;</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-      if (Services.prefs.getPrefType(pref) == Services.prefs.PREF_BOOL &amp;&amp;</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-          Services.prefs.getBoolPref(pref)) {</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+      if (</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+        Services.prefs.getPrefType(pref) == Services.prefs.PREF_BOOL &amp;&amp;</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+        Services.prefs.getBoolPref(pref)</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+      ) {</span>
<a href="#l6.396"></a><span id="l6.396">         this.LOG(&quot;Disabling prpl: &quot; + id);</span>
<a href="#l6.397"></a><span id="l6.397">         continue;</span>
<a href="#l6.398"></a><span id="l6.398">       }</span>
<a href="#l6.399"></a><span id="l6.399"> </span>
<a href="#l6.400"></a><span id="l6.400">       let proto = this.getProtocolById(id);</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-      if (proto)</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+      if (proto) {</span>
<a href="#l6.403"></a><span id="l6.403">         protocols.push(proto);</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+      }</span>
<a href="#l6.405"></a><span id="l6.405">     }</span>
<a href="#l6.406"></a><span id="l6.406">     return new nsSimpleEnumerator(protocols);</span>
<a href="#l6.407"></a><span id="l6.407">   },</span>
<a href="#l6.408"></a><span id="l6.408"> </span>
<a href="#l6.409"></a><span id="l6.409">   getProtocolById(aPrplId) {</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-    if (!this._initialized)</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+    if (!this._initialized) {</span>
<a href="#l6.412"></a><span id="l6.412">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+    }</span>
<a href="#l6.414"></a><span id="l6.414"> </span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-    if (this._protos.hasOwnProperty(aPrplId))</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+    if (this._protos.hasOwnProperty(aPrplId)) {</span>
<a href="#l6.417"></a><span id="l6.417">       return this._protos[aPrplId];</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+    }</span>
<a href="#l6.419"></a><span id="l6.419"> </span>
<a href="#l6.420"></a><span id="l6.420">     let cid;</span>
<a href="#l6.421"></a><span id="l6.421">     try {</span>
<a href="#l6.422"></a><span id="l6.422">       cid = categoryManager.getCategoryEntry(kProtocolPluginCategory, aPrplId);</span>
<a href="#l6.423"></a><span id="l6.423">     } catch (e) {</span>
<a href="#l6.424"></a><span id="l6.424">       return null; // no protocol registered for this id.</span>
<a href="#l6.425"></a><span id="l6.425">     }</span>
<a href="#l6.426"></a><span id="l6.426"> </span>
<a href="#l6.427"></a><span id="l6.427" class="difflineat">@@ -343,18 +390,19 @@ CoreService.prototype = {</span>
<a href="#l6.428"></a><span id="l6.428">     try {</span>
<a href="#l6.429"></a><span id="l6.429">       proto = Cc[cid].createInstance(Ci.prplIProtocol);</span>
<a href="#l6.430"></a><span id="l6.430">     } catch (e) {</span>
<a href="#l6.431"></a><span id="l6.431">       // This is a real error, the protocol is registered and failed to init.</span>
<a href="#l6.432"></a><span id="l6.432">       let error = &quot;failed to create an instance of &quot; + cid + &quot;: &quot; + e;</span>
<a href="#l6.433"></a><span id="l6.433">       dump(error + &quot;\n&quot;);</span>
<a href="#l6.434"></a><span id="l6.434">       Cu.reportError(error);</span>
<a href="#l6.435"></a><span id="l6.435">     }</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-    if (!proto)</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+    if (!proto) {</span>
<a href="#l6.438"></a><span id="l6.438">       return null;</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+    }</span>
<a href="#l6.440"></a><span id="l6.440"> </span>
<a href="#l6.441"></a><span id="l6.441">     try {</span>
<a href="#l6.442"></a><span id="l6.442">       proto.init(aPrplId);</span>
<a href="#l6.443"></a><span id="l6.443">     } catch (e) {</span>
<a href="#l6.444"></a><span id="l6.444">       Cu.reportError(&quot;Could not initialize protocol &quot; + aPrplId + &quot;: &quot; + e);</span>
<a href="#l6.445"></a><span id="l6.445">       return null;</span>
<a href="#l6.446"></a><span id="l6.446">     }</span>
<a href="#l6.447"></a><span id="l6.447"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/components/src/logger.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/components/src/logger.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,25 +1,29 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> var CC = Components.Constructor;</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-var {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  EmptyEnumerator,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  l10nHelper,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-var {GenericMessagePrototype} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-var {ClassInfo} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-var {ToLocaleFormat} = ChromeUtils.import(&quot;resource:///modules/ToLocaleFormat.jsm&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-var {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-var {getHiddenHTMLWindow} = ChromeUtils.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+var { EmptyEnumerator, l10nHelper, XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+);</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+var { GenericMessagePrototype } = ChromeUtils.import(</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+var { ClassInfo } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+var { ToLocaleFormat } = ChromeUtils.import(</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+  &quot;resource:///modules/ToLocaleFormat.jsm&quot;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+var { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+var { getHiddenHTMLWindow } = ChromeUtils.import(</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  &quot;resource:///modules/hiddenWindow.jsm&quot;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+);</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l7.38"></a><span id="l7.38">   l10nHelper(&quot;chrome://chat/locale/logger.properties&quot;)</span>
<a href="#l7.39"></a><span id="l7.39"> );</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41"> var kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43"> /*</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineat">@@ -30,24 +34,27 @@ var kLineBreak = &quot;@mozilla.org/windows-r</span>
<a href="#l7.45"></a><span id="l7.45"> var gFilePromises = new Map();</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47"> // Uses above map to queue operations on a file.</span>
<a href="#l7.48"></a><span id="l7.48"> function queueFileOperation(aPath, aOperation) {</span>
<a href="#l7.49"></a><span id="l7.49">   // Ensure the operation is queued regardless of whether the last one succeeded.</span>
<a href="#l7.50"></a><span id="l7.50">   // This is safe since the promise is returned and consumers are expected to</span>
<a href="#l7.51"></a><span id="l7.51">   // handle any errors. If there's no promise existing for the given path already,</span>
<a href="#l7.52"></a><span id="l7.52">   // queue the operation on a dummy pre-resolved promise.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  let promise =</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    (gFilePromises.get(aPath) || Promise.resolve()).then(aOperation, aOperation);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  let promise = (gFilePromises.get(aPath) || Promise.resolve()).then(</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    aOperation,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+    aOperation</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  );</span>
<a href="#l7.59"></a><span id="l7.59">   gFilePromises.set(aPath, promise);</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61">   let cleanup = () =&gt; {</span>
<a href="#l7.62"></a><span id="l7.62">     // If no further operations have been queued, remove the reference from the map.</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    if (gFilePromises.get(aPath) === promise)</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+    if (gFilePromises.get(aPath) === promise) {</span>
<a href="#l7.65"></a><span id="l7.65">       gFilePromises.delete(aPath);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    }</span>
<a href="#l7.67"></a><span id="l7.67">   };</span>
<a href="#l7.68"></a><span id="l7.68">   // Ensure we clear unused promises whether they resolved or rejected.</span>
<a href="#l7.69"></a><span id="l7.69">   promise.then(cleanup, cleanup);</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71">   return promise;</span>
<a href="#l7.72"></a><span id="l7.72"> }</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74"> /*</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineat">@@ -56,23 +63,24 @@ function queueFileOperation(aPath, aOper</span>
<a href="#l7.76"></a><span id="l7.76">  * We open the file, append, and close it immediately. The alternative is to keep</span>
<a href="#l7.77"></a><span id="l7.77">  * it open and append as required, but we want to make sure we don't open a file</span>
<a href="#l7.78"></a><span id="l7.78">  * for reading while it's already open for writing, so we close it every time</span>
<a href="#l7.79"></a><span id="l7.79">  * (opening a file multiple times concurrently may fail on Windows).</span>
<a href="#l7.80"></a><span id="l7.80">  * Note: This function creates parent directories if required.</span>
<a href="#l7.81"></a><span id="l7.81">  */</span>
<a href="#l7.82"></a><span id="l7.82"> function appendToFile(aPath, aEncodedString, aCreate) {</span>
<a href="#l7.83"></a><span id="l7.83">   return queueFileOperation(aPath, async function() {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-    await OS.File.makeDir(OS.Path.dirname(aPath),</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-                          {ignoreExisting: true, from: OS.Constants.Path.profileDir});</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-    let file = await OS.File.open(aPath, {write: true, create: aCreate});</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    await OS.File.makeDir(OS.Path.dirname(aPath), {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+      ignoreExisting: true,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+      from: OS.Constants.Path.profileDir,</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    });</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    let file = await OS.File.open(aPath, { write: true, create: aCreate });</span>
<a href="#l7.92"></a><span id="l7.92">     try {</span>
<a href="#l7.93"></a><span id="l7.93">       await file.write(aEncodedString);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    }</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-    finally {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    } finally {</span>
<a href="#l7.97"></a><span id="l7.97">       /*</span>
<a href="#l7.98"></a><span id="l7.98">        * If both the write() above and the close() below throw, and we don't</span>
<a href="#l7.99"></a><span id="l7.99">        * handle the close error here, the promise will be rejected with the close</span>
<a href="#l7.100"></a><span id="l7.100">        * error and the write error will be dropped. To avoid this, we log any</span>
<a href="#l7.101"></a><span id="l7.101">        * close error here so that any write error will be propagated.</span>
<a href="#l7.102"></a><span id="l7.102">        */</span>
<a href="#l7.103"></a><span id="l7.103">       await file.close().catch(Cu.reportError);</span>
<a href="#l7.104"></a><span id="l7.104">     }</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineat">@@ -80,97 +88,111 @@ function appendToFile(aPath, aEncodedStr</span>
<a href="#l7.106"></a><span id="l7.106"> }</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108"> OS.File.profileBeforeChange.addBlocker(</span>
<a href="#l7.109"></a><span id="l7.109">   &quot;Chat logger: writing all pending messages&quot;,</span>
<a href="#l7.110"></a><span id="l7.110">   async function() {</span>
<a href="#l7.111"></a><span id="l7.111">     for (let promise of gFilePromises.values()) {</span>
<a href="#l7.112"></a><span id="l7.112">       try {</span>
<a href="#l7.113"></a><span id="l7.113">         await promise;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-      }</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-      catch (aError) {</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+      } catch (aError) {</span>
<a href="#l7.117"></a><span id="l7.117">         // Ignore the error, whatever queued the operation will take care of it.</span>
<a href="#l7.118"></a><span id="l7.118">       }</span>
<a href="#l7.119"></a><span id="l7.119">     }</span>
<a href="#l7.120"></a><span id="l7.120">   }</span>
<a href="#l7.121"></a><span id="l7.121"> );</span>
<a href="#l7.122"></a><span id="l7.122"> </span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-</span>
<a href="#l7.124"></a><span id="l7.124"> // This function checks names against OS naming conventions and alters them</span>
<a href="#l7.125"></a><span id="l7.125"> // accordingly so that they can be used as file/folder names.</span>
<a href="#l7.126"></a><span id="l7.126"> function encodeName(aName) {</span>
<a href="#l7.127"></a><span id="l7.127">   // Reserved device names by Windows (prefixing &quot;%&quot;).</span>
<a href="#l7.128"></a><span id="l7.128">   let reservedNames = /^(CON|PRN|AUX|NUL|COM\d|LPT\d)$/i;</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-  if (reservedNames.test(aName))</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  if (reservedNames.test(aName)) {</span>
<a href="#l7.131"></a><span id="l7.131">     return &quot;%&quot; + aName;</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  }</span>
<a href="#l7.133"></a><span id="l7.133"> </span>
<a href="#l7.134"></a><span id="l7.134">   // &quot;.&quot; and &quot; &quot; must not be at the end of a file or folder name (appending &quot;_&quot;).</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-  if (/[\. _]/.test(aName.slice(-1)))</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  if (/[\. _]/.test(aName.slice(-1))) {</span>
<a href="#l7.137"></a><span id="l7.137">     aName += &quot;_&quot;;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+  }</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">   // Reserved characters are replaced by %[hex value]. encodeURIComponent() is</span>
<a href="#l7.141"></a><span id="l7.141">   // not sufficient, nevertheless decodeURIComponent() can be used to decode.</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  function encodeReservedChars(match) { return &quot;%&quot; + match.charCodeAt(0).toString(16); }</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  function encodeReservedChars(match) {</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+    return &quot;%&quot; + match.charCodeAt(0).toString(16);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  }</span>
<a href="#l7.146"></a><span id="l7.146">   return aName.replace(/[&lt;&gt;:&quot;\/\\|?*&amp;%]/g, encodeReservedChars);</span>
<a href="#l7.147"></a><span id="l7.147"> }</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149"> function getLogFolderPathForAccount(aAccount) {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  return OS.Path.join(OS.Constants.Path.profileDir,</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-                      &quot;logs&quot;, aAccount.protocol.normalizedName,</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-                      encodeName(aAccount.normalizedName));</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  return OS.Path.join(</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+    OS.Constants.Path.profileDir,</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    &quot;logs&quot;,</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+    aAccount.protocol.normalizedName,</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    encodeName(aAccount.normalizedName)</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  );</span>
<a href="#l7.159"></a><span id="l7.159"> }</span>
<a href="#l7.160"></a><span id="l7.160"> </span>
<a href="#l7.161"></a><span id="l7.161"> function getLogFilePathForConversation(aConv, aFormat, aStartTime) {</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-  if (!aStartTime)</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+  if (!aStartTime) {</span>
<a href="#l7.164"></a><span id="l7.164">     aStartTime = aConv.startDate / 1000;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  }</span>
<a href="#l7.166"></a><span id="l7.166">   let path = getLogFolderPathForAccount(aConv.account);</span>
<a href="#l7.167"></a><span id="l7.167">   let name = aConv.normalizedName;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  if (convIsRealMUC(aConv))</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+  if (convIsRealMUC(aConv)) {</span>
<a href="#l7.170"></a><span id="l7.170">     name += &quot;.chat&quot;;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-  return OS.Path.join(path, encodeName(name),</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-                      getNewLogFileName(aFormat, aStartTime));</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  }</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  return OS.Path.join(</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    path,</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    encodeName(name),</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+    getNewLogFileName(aFormat, aStartTime)</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+  );</span>
<a href="#l7.179"></a><span id="l7.179"> }</span>
<a href="#l7.180"></a><span id="l7.180"> </span>
<a href="#l7.181"></a><span id="l7.181"> function getNewLogFileName(aFormat, aStartTime) {</span>
<a href="#l7.182"></a><span id="l7.182">   let date = aStartTime ? new Date(aStartTime) : new Date();</span>
<a href="#l7.183"></a><span id="l7.183">   let dateTime = ToLocaleFormat(&quot;%Y-%m-%d.%H%M%S&quot;, date);</span>
<a href="#l7.184"></a><span id="l7.184">   let offset = date.getTimezoneOffset();</span>
<a href="#l7.185"></a><span id="l7.185">   if (offset &lt; 0) {</span>
<a href="#l7.186"></a><span id="l7.186">     dateTime += &quot;+&quot;;</span>
<a href="#l7.187"></a><span id="l7.187">     offset *= -1;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  } else {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+    dateTime += &quot;-&quot;;</span>
<a href="#l7.190"></a><span id="l7.190">   }</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-  else</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-    dateTime += &quot;-&quot;;</span>
<a href="#l7.193"></a><span id="l7.193">   let minutes = offset % 60;</span>
<a href="#l7.194"></a><span id="l7.194">   offset = (offset - minutes) / 60;</span>
<a href="#l7.195"></a><span id="l7.195">   function twoDigits(aNumber) {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    if (aNumber == 0)</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    if (aNumber == 0) {</span>
<a href="#l7.198"></a><span id="l7.198">       return &quot;00&quot;;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+    }</span>
<a href="#l7.200"></a><span id="l7.200">     return aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l7.201"></a><span id="l7.201">   }</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-  if (!aFormat)</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+  if (!aFormat) {</span>
<a href="#l7.204"></a><span id="l7.204">     aFormat = &quot;txt&quot;;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+  }</span>
<a href="#l7.206"></a><span id="l7.206">   return dateTime + twoDigits(offset) + twoDigits(minutes) + &quot;.&quot; + aFormat;</span>
<a href="#l7.207"></a><span id="l7.207"> }</span>
<a href="#l7.208"></a><span id="l7.208"> </span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-</span>
<a href="#l7.210"></a><span id="l7.210"> // One of these is maintained for every conversation being logged. It initializes</span>
<a href="#l7.211"></a><span id="l7.211"> // a log file and appends to it as required.</span>
<a href="#l7.212"></a><span id="l7.212"> function LogWriter(aConversation) {</span>
<a href="#l7.213"></a><span id="l7.213">   this._conv = aConversation;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-  if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;)</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+  if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;) {</span>
<a href="#l7.216"></a><span id="l7.216">     this.format = &quot;json&quot;;</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+  }</span>
<a href="#l7.218"></a><span id="l7.218">   this.paths = [];</span>
<a href="#l7.219"></a><span id="l7.219">   this.startNewFile(this._conv.startDate / 1000);</span>
<a href="#l7.220"></a><span id="l7.220"> }</span>
<a href="#l7.221"></a><span id="l7.221"> LogWriter.prototype = {</span>
<a href="#l7.222"></a><span id="l7.222">   // All log file paths used by this LogWriter.</span>
<a href="#l7.223"></a><span id="l7.223">   paths: [],</span>
<a href="#l7.224"></a><span id="l7.224">   // Path of the log file that is currently being written to.</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-  get currentPath() { return this.paths[this.paths.length - 1]; },</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+  get currentPath() {</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    return this.paths[this.paths.length - 1];</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+  },</span>
<a href="#l7.229"></a><span id="l7.229">   // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l7.230"></a><span id="l7.230">   // has been written.</span>
<a href="#l7.231"></a><span id="l7.231">   _initialized: null,</span>
<a href="#l7.232"></a><span id="l7.232">   _startTime: null,</span>
<a href="#l7.233"></a><span id="l7.233">   _lastMessageTime: null,</span>
<a href="#l7.234"></a><span id="l7.234">   _messageCount: 0,</span>
<a href="#l7.235"></a><span id="l7.235">   format: &quot;txt&quot;,</span>
<a href="#l7.236"></a><span id="l7.236">   encoder: new TextEncoder(),</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineat">@@ -179,225 +201,277 @@ LogWriter.prototype = {</span>
<a href="#l7.238"></a><span id="l7.238">     // log file is the time of the next message. Since message times are in seconds,</span>
<a href="#l7.239"></a><span id="l7.239">     // if we receive 1000 messages within a second after starting the new file,</span>
<a href="#l7.240"></a><span id="l7.240">     // we will create another file, using the same start time - and so the same</span>
<a href="#l7.241"></a><span id="l7.241">     // file name. To avoid this, ensure the new start time is at least one second</span>
<a href="#l7.242"></a><span id="l7.242">     // greater than the current one. This is ugly, but should rarely be needed.</span>
<a href="#l7.243"></a><span id="l7.243">     aStartTime = Math.max(aStartTime, this._startTime + 1000);</span>
<a href="#l7.244"></a><span id="l7.244">     this._startTime = this._lastMessageTime = aStartTime;</span>
<a href="#l7.245"></a><span id="l7.245">     this._messageCount = 0;</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-    this.paths.push(getLogFilePathForConversation(this._conv, this.format, aStartTime));</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+    this.paths.push(</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+      getLogFilePathForConversation(this._conv, this.format, aStartTime)</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+    );</span>
<a href="#l7.250"></a><span id="l7.250">     let account = this._conv.account;</span>
<a href="#l7.251"></a><span id="l7.251">     let header;</span>
<a href="#l7.252"></a><span id="l7.252">     if (this.format == &quot;json&quot;) {</span>
<a href="#l7.253"></a><span id="l7.253">       header = {</span>
<a href="#l7.254"></a><span id="l7.254">         date: new Date(this._startTime),</span>
<a href="#l7.255"></a><span id="l7.255">         name: this._conv.name,</span>
<a href="#l7.256"></a><span id="l7.256">         title: this._conv.title,</span>
<a href="#l7.257"></a><span id="l7.257">         account: account.normalizedName,</span>
<a href="#l7.258"></a><span id="l7.258">         protocol: account.protocol.normalizedName,</span>
<a href="#l7.259"></a><span id="l7.259">         isChat: this._conv.isChat,</span>
<a href="#l7.260"></a><span id="l7.260">         normalizedName: this._conv.normalizedName,</span>
<a href="#l7.261"></a><span id="l7.261">       };</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-      if (aContinuedSession)</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+      if (aContinuedSession) {</span>
<a href="#l7.264"></a><span id="l7.264">         header.continuedSession = true;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+      }</span>
<a href="#l7.266"></a><span id="l7.266">       header = JSON.stringify(header) + &quot;\n&quot;;</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-    }</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-    else {</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+    } else {</span>
<a href="#l7.270"></a><span id="l7.270">       const dateTimeFormatter = new Services.intl.DateTimeFormat(&quot;en-US&quot;, {</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-        dateStyle: &quot;full&quot;, timeStyle: &quot;long&quot;,</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+        dateStyle: &quot;full&quot;,</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+        timeStyle: &quot;long&quot;,</span>
<a href="#l7.274"></a><span id="l7.274">       });</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-      header = &quot;Conversation with &quot; + this._conv.name +</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-               &quot; at &quot; + dateTimeFormatter.format(new Date(this._conv.startDate / 1000)) +</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-               &quot; on &quot; + account.name +</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-               &quot; (&quot; + account.protocol.normalizedName + &quot;)&quot; + kLineBreak;</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+      header =</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+        &quot;Conversation with &quot; +</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+        this._conv.name +</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+        &quot; at &quot; +</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+        dateTimeFormatter.format(new Date(this._conv.startDate / 1000)) +</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+        &quot; on &quot; +</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+        account.name +</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+        &quot; (&quot; +</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+        account.protocol.normalizedName +</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+        &quot;)&quot; +</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+        kLineBreak;</span>
<a href="#l7.290"></a><span id="l7.290">     }</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-    this._initialized =</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-      appendToFile(this.currentPath, this.encoder.encode(header), true);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+    this._initialized = appendToFile(</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+      this.currentPath,</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+      this.encoder.encode(header),</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+      true</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+    );</span>
<a href="#l7.298"></a><span id="l7.298">     // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l7.299"></a><span id="l7.299">     // writing the header failed.</span>
<a href="#l7.300"></a><span id="l7.300">     this._initialized.catch(aError =&gt;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-                            Cu.reportError(&quot;Failed to initialize log file:\n&quot; + aError));</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+      Cu.reportError(&quot;Failed to initialize log file:\n&quot; + aError)</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+    );</span>
<a href="#l7.304"></a><span id="l7.304">   },</span>
<a href="#l7.305"></a><span id="l7.305">   _serialize(aString) {</span>
<a href="#l7.306"></a><span id="l7.306">     // TODO cleanup once bug 102699 is fixed</span>
<a href="#l7.307"></a><span id="l7.307">     let doc = getHiddenHTMLWindow().document;</span>
<a href="#l7.308"></a><span id="l7.308">     let div = doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;div&quot;);</span>
<a href="#l7.309"></a><span id="l7.309">     // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-    div.innerHTML = aString.replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;).replace(/&lt;br&gt;/gi, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+    div.innerHTML = aString</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+      .replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;)</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+      .replace(/&lt;br&gt;/gi, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l7.314"></a><span id="l7.314">     const type = &quot;text/plain&quot;;</span>
<a href="#l7.315"></a><span id="l7.315">     let encoder = Cu.createDocumentEncoder(type);</span>
<a href="#l7.316"></a><span id="l7.316">     encoder.init(doc, type, 0);</span>
<a href="#l7.317"></a><span id="l7.317">     encoder.setContainerNode(div);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-    encoder.setNodeFixup({fixupNode(aNode, aSerializeKids) {</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-      if (aNode.localName == &quot;a&quot; &amp;&amp; aNode.hasAttribute(&quot;href&quot;)) {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-        let url = aNode.getAttribute(&quot;href&quot;);</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-        let content = aNode.textContent;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-        if (url != content)</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-          aNode.textContent = content + &quot; (&quot; + url + &quot;)&quot;;</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-      }</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-      return null;</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-    }});</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+    encoder.setNodeFixup({</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+      fixupNode(aNode, aSerializeKids) {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+        if (aNode.localName == &quot;a&quot; &amp;&amp; aNode.hasAttribute(&quot;href&quot;)) {</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+          let url = aNode.getAttribute(&quot;href&quot;);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+          let content = aNode.textContent;</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+          if (url != content) {</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+            aNode.textContent = content + &quot; (&quot; + url + &quot;)&quot;;</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+          }</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+        }</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+        return null;</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+      },</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+    });</span>
<a href="#l7.339"></a><span id="l7.339">     return encoder.encodeToString();</span>
<a href="#l7.340"></a><span id="l7.340">   },</span>
<a href="#l7.341"></a><span id="l7.341">   // We start a new log file in the following cases:</span>
<a href="#l7.342"></a><span id="l7.342">   // - If it has been 30 minutes since the last message.</span>
<a href="#l7.343"></a><span id="l7.343">   kInactivityLimit: 30 * 60 * 1000,</span>
<a href="#l7.344"></a><span id="l7.344">   // - If at midnight, it's been longer than 3 hours since we started the file.</span>
<a href="#l7.345"></a><span id="l7.345">   kDayOverlapLimit: 3 * 60 * 60 * 1000,</span>
<a href="#l7.346"></a><span id="l7.346">   // - After every 1000 messages.</span>
<a href="#l7.347"></a><span id="l7.347">   kMessageCountLimit: 1000,</span>
<a href="#l7.348"></a><span id="l7.348">   logMessage(aMessage) {</span>
<a href="#l7.349"></a><span id="l7.349">     // aMessage.time is in seconds, we need it in milliseconds.</span>
<a href="#l7.350"></a><span id="l7.350">     let messageTime = aMessage.time * 1000;</span>
<a href="#l7.351"></a><span id="l7.351">     let messageMidnight = new Date(messageTime).setHours(0, 0, 0, 0);</span>
<a href="#l7.352"></a><span id="l7.352"> </span>
<a href="#l7.353"></a><span id="l7.353">     let inactivityLimitExceeded =</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-      !aMessage.delayed &amp;&amp; messageTime - this._lastMessageTime &gt; this.kInactivityLimit;</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+      !aMessage.delayed &amp;&amp;</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+      messageTime - this._lastMessageTime &gt; this.kInactivityLimit;</span>
<a href="#l7.357"></a><span id="l7.357">     let dayOverlapLimitExceeded =</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-      !aMessage.delayed &amp;&amp; messageMidnight - this._startTime &gt; this.kDayOverlapLimit;</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+      !aMessage.delayed &amp;&amp;</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+      messageMidnight - this._startTime &gt; this.kDayOverlapLimit;</span>
<a href="#l7.361"></a><span id="l7.361"> </span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-    if (inactivityLimitExceeded || dayOverlapLimitExceeded ||</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-        this._messageCount == this.kMessageCountLimit) {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+    if (</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+      inactivityLimitExceeded ||</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+      dayOverlapLimitExceeded ||</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+      this._messageCount == this.kMessageCountLimit</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+    ) {</span>
<a href="#l7.369"></a><span id="l7.369">       // We start a new session if the inactivity limit was exceeded.</span>
<a href="#l7.370"></a><span id="l7.370">       this.startNewFile(messageTime, !inactivityLimitExceeded);</span>
<a href="#l7.371"></a><span id="l7.371">     }</span>
<a href="#l7.372"></a><span id="l7.372">     ++this._messageCount;</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-    if (!aMessage.delayed)</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+    if (!aMessage.delayed) {</span>
<a href="#l7.376"></a><span id="l7.376">       this._lastMessageTime = messageTime;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+    }</span>
<a href="#l7.378"></a><span id="l7.378"> </span>
<a href="#l7.379"></a><span id="l7.379">     let lineToWrite;</span>
<a href="#l7.380"></a><span id="l7.380">     if (this.format == &quot;json&quot;) {</span>
<a href="#l7.381"></a><span id="l7.381">       let msg = {</span>
<a href="#l7.382"></a><span id="l7.382">         date: new Date(messageTime),</span>
<a href="#l7.383"></a><span id="l7.383">         who: aMessage.who,</span>
<a href="#l7.384"></a><span id="l7.384">         text: aMessage.displayMessage,</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-        flags: [&quot;outgoing&quot;, &quot;incoming&quot;, &quot;system&quot;, &quot;autoResponse&quot;,</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-                &quot;containsNick&quot;, &quot;error&quot;, &quot;delayed&quot;,</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-                &quot;noFormat&quot;, &quot;containsImages&quot;, &quot;notification&quot;,</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-                &quot;noLinkification&quot;].filter(f =&gt; aMessage[f]),</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+        flags: [</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+          &quot;outgoing&quot;,</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+          &quot;incoming&quot;,</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+          &quot;system&quot;,</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+          &quot;autoResponse&quot;,</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+          &quot;containsNick&quot;,</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+          &quot;error&quot;,</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+          &quot;delayed&quot;,</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+          &quot;noFormat&quot;,</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+          &quot;containsImages&quot;,</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+          &quot;notification&quot;,</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+          &quot;noLinkification&quot;,</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+        ].filter(f =&gt; aMessage[f]),</span>
<a href="#l7.402"></a><span id="l7.402">       };</span>
<a href="#l7.403"></a><span id="l7.403">       let alias = aMessage.alias;</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-      if (alias &amp;&amp; alias != msg.who)</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+      if (alias &amp;&amp; alias != msg.who) {</span>
<a href="#l7.406"></a><span id="l7.406">         msg.alias = alias;</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+      }</span>
<a href="#l7.408"></a><span id="l7.408">       lineToWrite = JSON.stringify(msg) + &quot;\n&quot;;</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-    }</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-    else {</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+    } else {</span>
<a href="#l7.412"></a><span id="l7.412">       // Text log.</span>
<a href="#l7.413"></a><span id="l7.413">       let date = new Date(messageTime);</span>
<a href="#l7.414"></a><span id="l7.414">       let line = &quot;(&quot; + date.toLocaleTimeString() + &quot;) &quot;;</span>
<a href="#l7.415"></a><span id="l7.415">       let msg = this._serialize(aMessage.displayMessage);</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-      if (aMessage.system)</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+      if (aMessage.system) {</span>
<a href="#l7.418"></a><span id="l7.418">         line += msg;</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-      else {</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+      } else {</span>
<a href="#l7.421"></a><span id="l7.421">         let sender = aMessage.alias || aMessage.who;</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-        if (aMessage.autoResponse)</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+        if (aMessage.autoResponse) {</span>
<a href="#l7.424"></a><span id="l7.424">           line += sender + &quot; &lt;AUTO-REPLY&gt;: &quot; + msg;</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-        else if (msg.startsWith(&quot;/me &quot;))</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+        } else if (msg.startsWith(&quot;/me &quot;)) {</span>
<a href="#l7.427"></a><span id="l7.427">           line += &quot;***&quot; + sender + &quot; &quot; + msg.substr(4);</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-        else</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+        } else {</span>
<a href="#l7.430"></a><span id="l7.430">           line += sender + &quot;: &quot; + msg;</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+        }</span>
<a href="#l7.432"></a><span id="l7.432">       }</span>
<a href="#l7.433"></a><span id="l7.433">       lineToWrite = line + kLineBreak;</span>
<a href="#l7.434"></a><span id="l7.434">     }</span>
<a href="#l7.435"></a><span id="l7.435">     lineToWrite = this.encoder.encode(lineToWrite);</span>
<a href="#l7.436"></a><span id="l7.436">     this._initialized.then(() =&gt; {</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-      appendToFile(this.currentPath, lineToWrite)</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-        .catch(aError =&gt; Cu.reportError(&quot;Failed to log message:\n&quot; + aError));</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+      appendToFile(this.currentPath, lineToWrite).catch(aError =&gt;</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+        Cu.reportError(&quot;Failed to log message:\n&quot; + aError)</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+      );</span>
<a href="#l7.442"></a><span id="l7.442">     });</span>
<a href="#l7.443"></a><span id="l7.443">   },</span>
<a href="#l7.444"></a><span id="l7.444"> };</span>
<a href="#l7.445"></a><span id="l7.445"> </span>
<a href="#l7.446"></a><span id="l7.446"> var dummyLogWriter = {</span>
<a href="#l7.447"></a><span id="l7.447">   paths: null,</span>
<a href="#l7.448"></a><span id="l7.448">   currentPath: null,</span>
<a href="#l7.449"></a><span id="l7.449">   logMessage() {},</span>
<a href="#l7.450"></a><span id="l7.450"> };</span>
<a href="#l7.451"></a><span id="l7.451"> </span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-</span>
<a href="#l7.453"></a><span id="l7.453"> var gLogWritersById = new Map();</span>
<a href="#l7.454"></a><span id="l7.454"> function getLogWriter(aConversation) {</span>
<a href="#l7.455"></a><span id="l7.455">   let id = aConversation.id;</span>
<a href="#l7.456"></a><span id="l7.456">   if (!gLogWritersById.has(id)) {</span>
<a href="#l7.457"></a><span id="l7.457">     let prefName =</span>
<a href="#l7.458"></a><span id="l7.458">       &quot;purple.logging.log_&quot; + (aConversation.isChat ? &quot;chats&quot; : &quot;ims&quot;);</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-    if (Services.prefs.getBoolPref(prefName))</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+    if (Services.prefs.getBoolPref(prefName)) {</span>
<a href="#l7.461"></a><span id="l7.461">       gLogWritersById.set(id, new LogWriter(aConversation));</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-    else</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+    } else {</span>
<a href="#l7.464"></a><span id="l7.464">       gLogWritersById.set(id, dummyLogWriter);</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+    }</span>
<a href="#l7.466"></a><span id="l7.466">   }</span>
<a href="#l7.467"></a><span id="l7.467">   return gLogWritersById.get(id);</span>
<a href="#l7.468"></a><span id="l7.468"> }</span>
<a href="#l7.469"></a><span id="l7.469"> </span>
<a href="#l7.470"></a><span id="l7.470"> function closeLogWriter(aConversation) {</span>
<a href="#l7.471"></a><span id="l7.471">   gLogWritersById.delete(aConversation.id);</span>
<a href="#l7.472"></a><span id="l7.472"> }</span>
<a href="#l7.473"></a><span id="l7.473"> </span>
<a href="#l7.474"></a><span id="l7.474"> // LogWriter for system logs.</span>
<a href="#l7.475"></a><span id="l7.475"> function SystemLogWriter(aAccount) {</span>
<a href="#l7.476"></a><span id="l7.476">   this._account = aAccount;</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-  this.path = OS.Path.join(getLogFolderPathForAccount(aAccount), &quot;.system&quot;,</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-                           getNewLogFileName());</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+  this.path = OS.Path.join(</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+    getLogFolderPathForAccount(aAccount),</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+    &quot;.system&quot;,</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+    getNewLogFileName()</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+  );</span>
<a href="#l7.484"></a><span id="l7.484">   const dateTimeFormatter = new Services.intl.DateTimeFormat(&quot;en-US&quot;, {</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-    dateStyle: &quot;full&quot;, timeStyle: &quot;long&quot;,</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+    dateStyle: &quot;full&quot;,</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+    timeStyle: &quot;long&quot;,</span>
<a href="#l7.488"></a><span id="l7.488">   });</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-  let header = &quot;System log for account &quot; + aAccount.name +</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-               &quot; (&quot; + aAccount.protocol.normalizedName +</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineminus">-               &quot;) connected at &quot; +</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineminus">-               dateTimeFormatter.format(new Date()) + kLineBreak;</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineminus">-  this._initialized = appendToFile(this.path, this.encoder.encode(header), true);</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+  let header =</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+    &quot;System log for account &quot; +</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+    aAccount.name +</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+    &quot; (&quot; +</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineplus">+    aAccount.protocol.normalizedName +</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+    &quot;) connected at &quot; +</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineplus">+    dateTimeFormatter.format(new Date()) +</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+    kLineBreak;</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+  this._initialized = appendToFile(</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+    this.path,</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+    this.encoder.encode(header),</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+    true</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+  );</span>
<a href="#l7.507"></a><span id="l7.507">   // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l7.508"></a><span id="l7.508">   // writing the header failed.</span>
<a href="#l7.509"></a><span id="l7.509">   this._initialized.catch(aError =&gt;</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-                          Cu.reportError(&quot;Error initializing system log:\n&quot; + aError));</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+    Cu.reportError(&quot;Error initializing system log:\n&quot; + aError)</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+  );</span>
<a href="#l7.513"></a><span id="l7.513"> }</span>
<a href="#l7.514"></a><span id="l7.514"> SystemLogWriter.prototype = {</span>
<a href="#l7.515"></a><span id="l7.515">   encoder: new TextEncoder(),</span>
<a href="#l7.516"></a><span id="l7.516">   // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l7.517"></a><span id="l7.517">   // has been written.</span>
<a href="#l7.518"></a><span id="l7.518">   _initialized: null,</span>
<a href="#l7.519"></a><span id="l7.519">   path: null,</span>
<a href="#l7.520"></a><span id="l7.520">   logEvent(aString) {</span>
<a href="#l7.521"></a><span id="l7.521">     let date = ToLocaleFormat(&quot;%x %X&quot;, new Date());</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-    let lineToWrite =</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-      this.encoder.encode(&quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak);</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+    let lineToWrite = this.encoder.encode(</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+      &quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+    );</span>
<a href="#l7.527"></a><span id="l7.527">     this._initialized.then(() =&gt; {</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-      appendToFile(this.path, lineToWrite)</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-        .catch(aError =&gt; Cu.reportError(&quot;Failed to log event:\n&quot; + aError));</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineplus">+      appendToFile(this.path, lineToWrite).catch(aError =&gt;</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+        Cu.reportError(&quot;Failed to log event:\n&quot; + aError)</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+      );</span>
<a href="#l7.533"></a><span id="l7.533">     });</span>
<a href="#l7.534"></a><span id="l7.534">   },</span>
<a href="#l7.535"></a><span id="l7.535"> };</span>
<a href="#l7.536"></a><span id="l7.536"> </span>
<a href="#l7.537"></a><span id="l7.537"> var dummySystemLogWriter = {</span>
<a href="#l7.538"></a><span id="l7.538">   path: null,</span>
<a href="#l7.539"></a><span id="l7.539">   logEvent() {},</span>
<a href="#l7.540"></a><span id="l7.540"> };</span>
<a href="#l7.541"></a><span id="l7.541"> </span>
<a href="#l7.542"></a><span id="l7.542" class="difflineminus">-</span>
<a href="#l7.543"></a><span id="l7.543"> var gSystemLogWritersById = new Map();</span>
<a href="#l7.544"></a><span id="l7.544"> function getSystemLogWriter(aAccount, aCreate) {</span>
<a href="#l7.545"></a><span id="l7.545">   let id = aAccount.id;</span>
<a href="#l7.546"></a><span id="l7.546">   if (aCreate) {</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineminus">-    if (!Services.prefs.getBoolPref(&quot;purple.logging.log_system&quot;))</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;purple.logging.log_system&quot;)) {</span>
<a href="#l7.549"></a><span id="l7.549">       return dummySystemLogWriter;</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+    }</span>
<a href="#l7.551"></a><span id="l7.551">     let writer = new SystemLogWriter(aAccount);</span>
<a href="#l7.552"></a><span id="l7.552">     gSystemLogWritersById.set(id, writer);</span>
<a href="#l7.553"></a><span id="l7.553">     return writer;</span>
<a href="#l7.554"></a><span id="l7.554">   }</span>
<a href="#l7.555"></a><span id="l7.555"> </span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-  return gSystemLogWritersById.has(id) &amp;&amp; gSystemLogWritersById.get(id) ||</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineminus">-    dummySystemLogWriter;</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+  return (</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+    (gSystemLogWritersById.has(id) &amp;&amp; gSystemLogWritersById.get(id)) ||</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+    dummySystemLogWriter</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+  );</span>
<a href="#l7.562"></a><span id="l7.562"> }</span>
<a href="#l7.563"></a><span id="l7.563"> </span>
<a href="#l7.564"></a><span id="l7.564"> function closeSystemLogWriter(aAccount) {</span>
<a href="#l7.565"></a><span id="l7.565">   gSystemLogWritersById.delete(aAccount.id);</span>
<a href="#l7.566"></a><span id="l7.566"> }</span>
<a href="#l7.567"></a><span id="l7.567"> </span>
<a href="#l7.568"></a><span id="l7.568" class="difflineminus">-</span>
<a href="#l7.569"></a><span id="l7.569"> /**</span>
<a href="#l7.570"></a><span id="l7.570">  * Takes a properly formatted log file name and extracts the date information</span>
<a href="#l7.571"></a><span id="l7.571">  * and filetype, returning the results as an Array.</span>
<a href="#l7.572"></a><span id="l7.572">  *</span>
<a href="#l7.573"></a><span id="l7.573">  * Filenames are expected to be formatted as:</span>
<a href="#l7.574"></a><span id="l7.574">  *</span>
<a href="#l7.575"></a><span id="l7.575">  * YYYY-MM-DD.HHmmSS+ZZzz.format</span>
<a href="#l7.576"></a><span id="l7.576">  *</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineat">@@ -405,89 +479,111 @@ function closeSystemLogWriter(aAccount) </span>
<a href="#l7.578"></a><span id="l7.578">  * @returns an Array, where the first element is a Date object for the date</span>
<a href="#l7.579"></a><span id="l7.579">  *          that the log file represents, and the file type as a string.</span>
<a href="#l7.580"></a><span id="l7.580">  */</span>
<a href="#l7.581"></a><span id="l7.581"> function getDateFromFilename(aFilename) {</span>
<a href="#l7.582"></a><span id="l7.582">   const kRegExp = /([\d]{4})-([\d]{2})-([\d]{2}).([\d]{2})([\d]{2})([\d]{2})([+-])([\d]{2})([\d]{2}).*\.([A-Za-z]+)$/;</span>
<a href="#l7.583"></a><span id="l7.583"> </span>
<a href="#l7.584"></a><span id="l7.584">   let r = aFilename.match(kRegExp);</span>
<a href="#l7.585"></a><span id="l7.585">   if (!r) {</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-    Cu.reportError(&quot;Found log file with name not maching YYYY-MM-DD.HHmmSS+ZZzz.format: &quot; + aFilename);</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+    Cu.reportError(</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+      &quot;Found log file with name not maching YYYY-MM-DD.HHmmSS+ZZzz.format: &quot; +</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+        aFilename</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+    );</span>
<a href="#l7.591"></a><span id="l7.591">     return [];</span>
<a href="#l7.592"></a><span id="l7.592">   }</span>
<a href="#l7.593"></a><span id="l7.593"> </span>
<a href="#l7.594"></a><span id="l7.594">   // We ignore the timezone offset for now (FIXME)</span>
<a href="#l7.595"></a><span id="l7.595">   return [new Date(r[1], r[2] - 1, r[3], r[4], r[5], r[6]), r[10]];</span>
<a href="#l7.596"></a><span id="l7.596"> }</span>
<a href="#l7.597"></a><span id="l7.597"> </span>
<a href="#l7.598"></a><span id="l7.598"> /**</span>
<a href="#l7.599"></a><span id="l7.599">  * Returns true if a Conversation is both a chat conversation, and not</span>
<a href="#l7.600"></a><span id="l7.600">  * a Twitter conversation.</span>
<a href="#l7.601"></a><span id="l7.601">  */</span>
<a href="#l7.602"></a><span id="l7.602"> function convIsRealMUC(aConversation) {</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineminus">-  return (aConversation.isChat &amp;&amp;</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineminus">-          aConversation.account.protocol.id != &quot;prpl-twitter&quot;);</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineplus">+  return (</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineplus">+    aConversation.isChat &amp;&amp; aConversation.account.protocol.id != &quot;prpl-twitter&quot;</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineplus">+  );</span>
<a href="#l7.608"></a><span id="l7.608"> }</span>
<a href="#l7.609"></a><span id="l7.609"> </span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-</span>
<a href="#l7.611"></a><span id="l7.611"> function LogMessage(aData, aConversation) {</span>
<a href="#l7.612"></a><span id="l7.612">   this._init(aData.who, aData.text);</span>
<a href="#l7.613"></a><span id="l7.613">   this._conversation = aConversation;</span>
<a href="#l7.614"></a><span id="l7.614">   this.time = Math.round(new Date(aData.date) / 1000);</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineminus">-  if (&quot;alias&quot; in aData)</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+  if (&quot;alias&quot; in aData) {</span>
<a href="#l7.617"></a><span id="l7.617">     this._alias = aData.alias;</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-  for (let flag of aData.flags)</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+  }</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+  for (let flag of aData.flags) {</span>
<a href="#l7.621"></a><span id="l7.621">     this[flag] = true;</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineplus">+  }</span>
<a href="#l7.623"></a><span id="l7.623"> }</span>
<a href="#l7.624"></a><span id="l7.624"> </span>
<a href="#l7.625"></a><span id="l7.625"> LogMessage.prototype = {</span>
<a href="#l7.626"></a><span id="l7.626">   __proto__: GenericMessagePrototype,</span>
<a href="#l7.627"></a><span id="l7.627">   _interfaces: [Ci.imIMessage, Ci.prplIMessage],</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineminus">-  get displayMessage() { return this.originalMessage; },</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineplus">+  get displayMessage() {</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+    return this.originalMessage;</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineplus">+  },</span>
<a href="#l7.632"></a><span id="l7.632"> };</span>
<a href="#l7.633"></a><span id="l7.633"> </span>
<a href="#l7.634"></a><span id="l7.634" class="difflineminus">-</span>
<a href="#l7.635"></a><span id="l7.635"> function LogConversation(aMessages, aProperties) {</span>
<a href="#l7.636"></a><span id="l7.636">   this._messages = aMessages;</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-  for (let property in aProperties)</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+  for (let property in aProperties) {</span>
<a href="#l7.639"></a><span id="l7.639">     this[property] = aProperties[property];</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+  }</span>
<a href="#l7.641"></a><span id="l7.641"> }</span>
<a href="#l7.642"></a><span id="l7.642"> LogConversation.prototype = {</span>
<a href="#l7.643"></a><span id="l7.643">   __proto__: ClassInfo(&quot;imILogConversation&quot;, &quot;Log conversation object&quot;),</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineminus">-  get isChat() { return this._isChat; },</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineminus">-  get buddy() { return null; },</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineminus">-  get account() { return {</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-    alias: &quot;&quot;,</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-    name: this._accountName,</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-    normalizedName: this._accountName,</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineminus">-    protocol: {name: this._protocolName},</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineminus">-    statusInfo: Services.core.globalUserStatus,</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-  }; },</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineplus">+  get isChat() {</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineplus">+    return this._isChat;</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+  },</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineplus">+  get buddy() {</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineplus">+    return null;</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineplus">+  },</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineplus">+  get account() {</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineplus">+    return {</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineplus">+      alias: &quot;&quot;,</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineplus">+      name: this._accountName,</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineplus">+      normalizedName: this._accountName,</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+      protocol: { name: this._protocolName },</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineplus">+      statusInfo: Services.core.globalUserStatus,</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+    };</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineplus">+  },</span>
<a href="#l7.668"></a><span id="l7.668">   getMessages(aMessageCount) {</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineminus">-    if (aMessageCount)</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+    if (aMessageCount) {</span>
<a href="#l7.671"></a><span id="l7.671">       aMessageCount.value = this._messages.length;</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+    }</span>
<a href="#l7.673"></a><span id="l7.673">     return this._messages.map(m =&gt; new LogMessage(m, this));</span>
<a href="#l7.674"></a><span id="l7.674">   },</span>
<a href="#l7.675"></a><span id="l7.675">   getMessagesEnumerator(aMessageCount) {</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineminus">-    if (aMessageCount)</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+    if (aMessageCount) {</span>
<a href="#l7.678"></a><span id="l7.678">       aMessageCount.value = this._messages.length;</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+    }</span>
<a href="#l7.680"></a><span id="l7.680">     let enumerator = {</span>
<a href="#l7.681"></a><span id="l7.681">       _index: 0,</span>
<a href="#l7.682"></a><span id="l7.682">       _conv: this,</span>
<a href="#l7.683"></a><span id="l7.683">       _messages: this._messages,</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineminus">-      hasMoreElements() { return this._index &lt; this._messages.length; },</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineminus">-      getNext() { return new LogMessage(this._messages[this._index++], this._conv); },</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineplus">+      hasMoreElements() {</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineplus">+        return this._index &lt; this._messages.length;</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineplus">+      },</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineplus">+      getNext() {</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+        return new LogMessage(this._messages[this._index++], this._conv);</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineplus">+      },</span>
<a href="#l7.692"></a><span id="l7.692">       QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineminus">-      * [Symbol.iterator]() { while (this.hasMoreElements()) yield this.getNext(); },</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineplus">+      *[Symbol.iterator]() {</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+        while (this.hasMoreElements()) {</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+          yield this.getNext();</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+        }</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineplus">+      },</span>
<a href="#l7.699"></a><span id="l7.699">     };</span>
<a href="#l7.700"></a><span id="l7.700">     return enumerator;</span>
<a href="#l7.701"></a><span id="l7.701">   },</span>
<a href="#l7.702"></a><span id="l7.702"> };</span>
<a href="#l7.703"></a><span id="l7.703"> </span>
<a href="#l7.704"></a><span id="l7.704" class="difflineminus">-</span>
<a href="#l7.705"></a><span id="l7.705"> /**</span>
<a href="#l7.706"></a><span id="l7.706">  * A Log object represents one or more log files. The constructor expects one</span>
<a href="#l7.707"></a><span id="l7.707">  * argument, which is either a single path to a (json or txt) log file or an</span>
<a href="#l7.708"></a><span id="l7.708">  * array of objects each having two properties:</span>
<a href="#l7.709"></a><span id="l7.709">  *   path: The full path of the (json only) log file it represents.</span>
<a href="#l7.710"></a><span id="l7.710">  *   time: The Date object extracted from the filename of the logfile.</span>
<a href="#l7.711"></a><span id="l7.711">  *</span>
<a href="#l7.712"></a><span id="l7.712">  * The returned Log object's time property will be:</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineat">@@ -508,18 +604,20 @@ function Log(aEntries) {</span>
<a href="#l7.714"></a><span id="l7.714">     this.time = date.valueOf() / 1000;</span>
<a href="#l7.715"></a><span id="l7.715">     this.format = format;</span>
<a href="#l7.716"></a><span id="l7.716">     // Wrap the path in an array</span>
<a href="#l7.717"></a><span id="l7.717">     this._entryPaths = [path];</span>
<a href="#l7.718"></a><span id="l7.718">     return;</span>
<a href="#l7.719"></a><span id="l7.719">   }</span>
<a href="#l7.720"></a><span id="l7.720"> </span>
<a href="#l7.721"></a><span id="l7.721">   if (!aEntries.length) {</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineminus">-    throw new Error(&quot;Log was passed an invalid argument, &quot; +</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineminus">-                    &quot;expected a non-empty array or a string.&quot;);</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineplus">+    throw new Error(</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+      &quot;Log was passed an invalid argument, &quot; +</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineplus">+        &quot;expected a non-empty array or a string.&quot;</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineplus">+    );</span>
<a href="#l7.728"></a><span id="l7.728">   }</span>
<a href="#l7.729"></a><span id="l7.729"> </span>
<a href="#l7.730"></a><span id="l7.730">   // Assume aEntries is an array of objects.</span>
<a href="#l7.731"></a><span id="l7.731">   // Sort our list of entries for this day in increasing order.</span>
<a href="#l7.732"></a><span id="l7.732">   aEntries.sort((aLeft, aRight) =&gt; aLeft.time - aRight.time);</span>
<a href="#l7.733"></a><span id="l7.733"> </span>
<a href="#l7.734"></a><span id="l7.734">   this._entryPaths = aEntries.map(entry =&gt; entry.path);</span>
<a href="#l7.735"></a><span id="l7.735">   // Calculate the timestamp for the first entry down to the day.</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineat">@@ -540,29 +638,30 @@ Log.prototype = {</span>
<a href="#l7.737"></a><span id="l7.737">   async getConversation() {</span>
<a href="#l7.738"></a><span id="l7.738">     /*</span>
<a href="#l7.739"></a><span id="l7.739">      * Read the set of log files asynchronously and return a promise that</span>
<a href="#l7.740"></a><span id="l7.740">      * resolves to a LogConversation instance. Even if a file contains some</span>
<a href="#l7.741"></a><span id="l7.741">      * junk (invalid JSON), messages that are valid will be read. If the first</span>
<a href="#l7.742"></a><span id="l7.742">      * line of metadata is corrupt however, the data isn't useful and the</span>
<a href="#l7.743"></a><span id="l7.743">      * promise will resolve to null.</span>
<a href="#l7.744"></a><span id="l7.744">      */</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineminus">-    if (this.format != &quot;json&quot;)</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+    if (this.format != &quot;json&quot;) {</span>
<a href="#l7.747"></a><span id="l7.747">       return null;</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+    }</span>
<a href="#l7.749"></a><span id="l7.749">     let messages = [];</span>
<a href="#l7.750"></a><span id="l7.750">     let properties = {};</span>
<a href="#l7.751"></a><span id="l7.751">     let firstFile = true;</span>
<a href="#l7.752"></a><span id="l7.752">     let decoder = new TextDecoder();</span>
<a href="#l7.753"></a><span id="l7.753">     for (let path of this._entryPaths) {</span>
<a href="#l7.754"></a><span id="l7.754">       let lines;</span>
<a href="#l7.755"></a><span id="l7.755">       try {</span>
<a href="#l7.756"></a><span id="l7.756">         let contents = await queueFileOperation(path, () =&gt; OS.File.read(path));</span>
<a href="#l7.757"></a><span id="l7.757">         lines = decoder.decode(contents).split(&quot;\n&quot;);</span>
<a href="#l7.758"></a><span id="l7.758">       } catch (aError) {</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineminus">-        Cu.reportError(&quot;Error reading log file \&quot;&quot; + path + &quot;\&quot;:\n&quot; + aError);</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+        Cu.reportError('Error reading log file &quot;' + path + '&quot;:\n' + aError);</span>
<a href="#l7.761"></a><span id="l7.761">         continue;</span>
<a href="#l7.762"></a><span id="l7.762">       }</span>
<a href="#l7.763"></a><span id="l7.763">       let nextLine = lines.shift();</span>
<a href="#l7.764"></a><span id="l7.764">       let filename = OS.Path.basename(path);</span>
<a href="#l7.765"></a><span id="l7.765"> </span>
<a href="#l7.766"></a><span id="l7.766">       let data;</span>
<a href="#l7.767"></a><span id="l7.767">       try {</span>
<a href="#l7.768"></a><span id="l7.768">         // This will fail if either nextLine is undefined, or not valid JSON.</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineat">@@ -594,35 +693,37 @@ Log.prototype = {</span>
<a href="#l7.770"></a><span id="l7.770">         properties._protocolName = data.protocol;</span>
<a href="#l7.771"></a><span id="l7.771">         properties._isChat = data.isChat;</span>
<a href="#l7.772"></a><span id="l7.772">         properties.normalizedName = data.normalizedName;</span>
<a href="#l7.773"></a><span id="l7.773">         firstFile = false;</span>
<a href="#l7.774"></a><span id="l7.774">       }</span>
<a href="#l7.775"></a><span id="l7.775"> </span>
<a href="#l7.776"></a><span id="l7.776">       while (lines.length) {</span>
<a href="#l7.777"></a><span id="l7.777">         nextLine = lines.shift();</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineminus">-        if (!nextLine)</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineplus">+        if (!nextLine) {</span>
<a href="#l7.780"></a><span id="l7.780">           break;</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineplus">+        }</span>
<a href="#l7.782"></a><span id="l7.782">         try {</span>
<a href="#l7.783"></a><span id="l7.783">           messages.push(JSON.parse(nextLine));</span>
<a href="#l7.784"></a><span id="l7.784">         } catch (e) {</span>
<a href="#l7.785"></a><span id="l7.785">           // If a message line contains junk, just ignore the error and</span>
<a href="#l7.786"></a><span id="l7.786">           // continue reading the conversation.</span>
<a href="#l7.787"></a><span id="l7.787">         }</span>
<a href="#l7.788"></a><span id="l7.788">       }</span>
<a href="#l7.789"></a><span id="l7.789">     }</span>
<a href="#l7.790"></a><span id="l7.790"> </span>
<a href="#l7.791"></a><span id="l7.791" class="difflineminus">-    if (firstFile) // All selected log files are invalid.</span>
<a href="#l7.792"></a><span id="l7.792" class="difflineplus">+    if (firstFile) {</span>
<a href="#l7.793"></a><span id="l7.793" class="difflineplus">+      // All selected log files are invalid.</span>
<a href="#l7.794"></a><span id="l7.794">       return null;</span>
<a href="#l7.795"></a><span id="l7.795" class="difflineplus">+    }</span>
<a href="#l7.796"></a><span id="l7.796"> </span>
<a href="#l7.797"></a><span id="l7.797">     return new LogConversation(messages, properties);</span>
<a href="#l7.798"></a><span id="l7.798">   },</span>
<a href="#l7.799"></a><span id="l7.799"> };</span>
<a href="#l7.800"></a><span id="l7.800"> </span>
<a href="#l7.801"></a><span id="l7.801" class="difflineminus">-</span>
<a href="#l7.802"></a><span id="l7.802"> /**</span>
<a href="#l7.803"></a><span id="l7.803">  * Log enumerators provide lists of log files (&quot;entries&quot;). aEntries is an array</span>
<a href="#l7.804"></a><span id="l7.804">  * of the OS.File.DirectoryIterator.Entry instances which represent the log</span>
<a href="#l7.805"></a><span id="l7.805">  * files to be parsed.</span>
<a href="#l7.806"></a><span id="l7.806">  *</span>
<a href="#l7.807"></a><span id="l7.807">  * DailyLogEnumerator organizes entries by date, and enumerates them in order.</span>
<a href="#l7.808"></a><span id="l7.808">  * LogEnumerator enumerates logs in the same order as the input array.</span>
<a href="#l7.809"></a><span id="l7.809">  */</span>
<a href="#l7.810"></a><span id="l7.810" class="difflineat">@@ -645,320 +746,393 @@ function DailyLogEnumerator(aEntries) {</span>
<a href="#l7.811"></a><span id="l7.811">       // into the same Arrays. We clone the date for the log, reset it to</span>
<a href="#l7.812"></a><span id="l7.812">       // the 0th hour/minute/second, and use that to construct an ID for the</span>
<a href="#l7.813"></a><span id="l7.813">       // Array we'll put the log in.</span>
<a href="#l7.814"></a><span id="l7.814">       dateForID.setHours(0);</span>
<a href="#l7.815"></a><span id="l7.815">       dateForID.setMinutes(0);</span>
<a href="#l7.816"></a><span id="l7.816">       dateForID.setSeconds(0);</span>
<a href="#l7.817"></a><span id="l7.817">       dayID = dateForID.toISOString();</span>
<a href="#l7.818"></a><span id="l7.818"> </span>
<a href="#l7.819"></a><span id="l7.819" class="difflineminus">-      if (!(dayID in this._entries))</span>
<a href="#l7.820"></a><span id="l7.820" class="difflineplus">+      if (!(dayID in this._entries)) {</span>
<a href="#l7.821"></a><span id="l7.821">         this._entries[dayID] = [];</span>
<a href="#l7.822"></a><span id="l7.822" class="difflineplus">+      }</span>
<a href="#l7.823"></a><span id="l7.823"> </span>
<a href="#l7.824"></a><span id="l7.824">       this._entries[dayID].push({</span>
<a href="#l7.825"></a><span id="l7.825">         path,</span>
<a href="#l7.826"></a><span id="l7.826">         time: logDate,</span>
<a href="#l7.827"></a><span id="l7.827">       });</span>
<a href="#l7.828"></a><span id="l7.828" class="difflineminus">-    }</span>
<a href="#l7.829"></a><span id="l7.829" class="difflineminus">-    else {</span>
<a href="#l7.830"></a><span id="l7.830" class="difflineplus">+    } else {</span>
<a href="#l7.831"></a><span id="l7.831">       // Add legacy text logs as individual paths.</span>
<a href="#l7.832"></a><span id="l7.832">       dayID = dateForID.toISOString() + &quot;txt&quot;;</span>
<a href="#l7.833"></a><span id="l7.833">       this._entries[dayID] = path;</span>
<a href="#l7.834"></a><span id="l7.834">     }</span>
<a href="#l7.835"></a><span id="l7.835">   }</span>
<a href="#l7.836"></a><span id="l7.836"> </span>
<a href="#l7.837"></a><span id="l7.837">   this._days = Object.keys(this._entries).sort();</span>
<a href="#l7.838"></a><span id="l7.838">   this._index = 0;</span>
<a href="#l7.839"></a><span id="l7.839"> }</span>
<a href="#l7.840"></a><span id="l7.840"> DailyLogEnumerator.prototype = {</span>
<a href="#l7.841"></a><span id="l7.841">   _entries: {},</span>
<a href="#l7.842"></a><span id="l7.842">   _days: [],</span>
<a href="#l7.843"></a><span id="l7.843">   _index: 0,</span>
<a href="#l7.844"></a><span id="l7.844" class="difflineminus">-  hasMoreElements() { return this._index &lt; this._days.length; },</span>
<a href="#l7.845"></a><span id="l7.845" class="difflineplus">+  hasMoreElements() {</span>
<a href="#l7.846"></a><span id="l7.846" class="difflineplus">+    return this._index &lt; this._days.length;</span>
<a href="#l7.847"></a><span id="l7.847" class="difflineplus">+  },</span>
<a href="#l7.848"></a><span id="l7.848">   getNext() {</span>
<a href="#l7.849"></a><span id="l7.849">     let dayID = this._days[this._index++];</span>
<a href="#l7.850"></a><span id="l7.850">     return new Log(this._entries[dayID]);</span>
<a href="#l7.851"></a><span id="l7.851">   },</span>
<a href="#l7.852"></a><span id="l7.852">   QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineminus">-  * [Symbol.iterator]() { while (this.hasMoreElements()) yield this.getNext(); },</span>
<a href="#l7.854"></a><span id="l7.854" class="difflineplus">+  *[Symbol.iterator]() {</span>
<a href="#l7.855"></a><span id="l7.855" class="difflineplus">+    while (this.hasMoreElements()) {</span>
<a href="#l7.856"></a><span id="l7.856" class="difflineplus">+      yield this.getNext();</span>
<a href="#l7.857"></a><span id="l7.857" class="difflineplus">+    }</span>
<a href="#l7.858"></a><span id="l7.858" class="difflineplus">+  },</span>
<a href="#l7.859"></a><span id="l7.859"> };</span>
<a href="#l7.860"></a><span id="l7.860"> </span>
<a href="#l7.861"></a><span id="l7.861"> function LogEnumerator(aEntries) {</span>
<a href="#l7.862"></a><span id="l7.862">   this._entries = aEntries;</span>
<a href="#l7.863"></a><span id="l7.863">   this._entries.sort((a, b) =&gt; a.name &gt; b.name);</span>
<a href="#l7.864"></a><span id="l7.864"> }</span>
<a href="#l7.865"></a><span id="l7.865"> LogEnumerator.prototype = {</span>
<a href="#l7.866"></a><span id="l7.866">   _entries: [],</span>
<a href="#l7.867"></a><span id="l7.867">   hasMoreElements() {</span>
<a href="#l7.868"></a><span id="l7.868">     return this._entries.length &gt; 0;</span>
<a href="#l7.869"></a><span id="l7.869">   },</span>
<a href="#l7.870"></a><span id="l7.870">   getNext() {</span>
<a href="#l7.871"></a><span id="l7.871">     // Create and return a log from the first entry.</span>
<a href="#l7.872"></a><span id="l7.872">     return new Log(this._entries.shift().path);</span>
<a href="#l7.873"></a><span id="l7.873">   },</span>
<a href="#l7.874"></a><span id="l7.874">   QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l7.875"></a><span id="l7.875" class="difflineminus">-  * [Symbol.iterator]() { while (this.hasMoreElements()) yield this.getNext(); },</span>
<a href="#l7.876"></a><span id="l7.876" class="difflineplus">+  *[Symbol.iterator]() {</span>
<a href="#l7.877"></a><span id="l7.877" class="difflineplus">+    while (this.hasMoreElements()) {</span>
<a href="#l7.878"></a><span id="l7.878" class="difflineplus">+      yield this.getNext();</span>
<a href="#l7.879"></a><span id="l7.879" class="difflineplus">+    }</span>
<a href="#l7.880"></a><span id="l7.880" class="difflineplus">+  },</span>
<a href="#l7.881"></a><span id="l7.881"> };</span>
<a href="#l7.882"></a><span id="l7.882"> </span>
<a href="#l7.883"></a><span id="l7.883" class="difflineminus">-</span>
<a href="#l7.884"></a><span id="l7.884" class="difflineminus">-function Logger() { }</span>
<a href="#l7.885"></a><span id="l7.885" class="difflineplus">+function Logger() {}</span>
<a href="#l7.886"></a><span id="l7.886"> Logger.prototype = {</span>
<a href="#l7.887"></a><span id="l7.887">   // Returned Promise resolves to an array of entries for the</span>
<a href="#l7.888"></a><span id="l7.888">   // log folder if it exists, otherwise null.</span>
<a href="#l7.889"></a><span id="l7.889">   async _getLogArray(aAccount, aNormalizedName) {</span>
<a href="#l7.890"></a><span id="l7.890">     let iterator, path;</span>
<a href="#l7.891"></a><span id="l7.891">     try {</span>
<a href="#l7.892"></a><span id="l7.892" class="difflineminus">-      path = OS.Path.join(getLogFolderPathForAccount(aAccount),</span>
<a href="#l7.893"></a><span id="l7.893" class="difflineminus">-                          encodeName(aNormalizedName));</span>
<a href="#l7.894"></a><span id="l7.894" class="difflineplus">+      path = OS.Path.join(</span>
<a href="#l7.895"></a><span id="l7.895" class="difflineplus">+        getLogFolderPathForAccount(aAccount),</span>
<a href="#l7.896"></a><span id="l7.896" class="difflineplus">+        encodeName(aNormalizedName)</span>
<a href="#l7.897"></a><span id="l7.897" class="difflineplus">+      );</span>
<a href="#l7.898"></a><span id="l7.898">       if (await queueFileOperation(path, () =&gt; OS.File.exists(path))) {</span>
<a href="#l7.899"></a><span id="l7.899">         iterator = new OS.File.DirectoryIterator(path);</span>
<a href="#l7.900"></a><span id="l7.900">         let entries = await iterator.nextBatch();</span>
<a href="#l7.901"></a><span id="l7.901">         iterator.close();</span>
<a href="#l7.902"></a><span id="l7.902">         return entries;</span>
<a href="#l7.903"></a><span id="l7.903">       }</span>
<a href="#l7.904"></a><span id="l7.904">     } catch (aError) {</span>
<a href="#l7.905"></a><span id="l7.905" class="difflineminus">-      if (iterator)</span>
<a href="#l7.906"></a><span id="l7.906" class="difflineplus">+      if (iterator) {</span>
<a href="#l7.907"></a><span id="l7.907">         iterator.close();</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineminus">-      Cu.reportError(&quot;Error getting directory entries for \&quot;&quot; +</span>
<a href="#l7.909"></a><span id="l7.909" class="difflineminus">-                     path + &quot;\&quot;:\n&quot; + aError);</span>
<a href="#l7.910"></a><span id="l7.910" class="difflineplus">+      }</span>
<a href="#l7.911"></a><span id="l7.911" class="difflineplus">+      Cu.reportError(</span>
<a href="#l7.912"></a><span id="l7.912" class="difflineplus">+        'Error getting directory entries for &quot;' + path + '&quot;:\n' + aError</span>
<a href="#l7.913"></a><span id="l7.913" class="difflineplus">+      );</span>
<a href="#l7.914"></a><span id="l7.914">     }</span>
<a href="#l7.915"></a><span id="l7.915">     return [];</span>
<a href="#l7.916"></a><span id="l7.916">   },</span>
<a href="#l7.917"></a><span id="l7.917">   getLogFromFile(aFilePath, aGroupByDay) {</span>
<a href="#l7.918"></a><span id="l7.918" class="difflineminus">-    if (!aGroupByDay)</span>
<a href="#l7.919"></a><span id="l7.919" class="difflineplus">+    if (!aGroupByDay) {</span>
<a href="#l7.920"></a><span id="l7.920">       return Promise.resolve(new Log(aFilePath));</span>
<a href="#l7.921"></a><span id="l7.921" class="difflineplus">+    }</span>
<a href="#l7.922"></a><span id="l7.922">     let [targetDate] = getDateFromFilename(OS.Path.basename(aFilePath));</span>
<a href="#l7.923"></a><span id="l7.923" class="difflineminus">-    if (!targetDate)</span>
<a href="#l7.924"></a><span id="l7.924" class="difflineplus">+    if (!targetDate) {</span>
<a href="#l7.925"></a><span id="l7.925">       return null;</span>
<a href="#l7.926"></a><span id="l7.926" class="difflineplus">+    }</span>
<a href="#l7.927"></a><span id="l7.927"> </span>
<a href="#l7.928"></a><span id="l7.928">     targetDate = targetDate.toDateString();</span>
<a href="#l7.929"></a><span id="l7.929"> </span>
<a href="#l7.930"></a><span id="l7.930">     // We'll assume that the files relevant to our interests are</span>
<a href="#l7.931"></a><span id="l7.931">     // in the same folder as the one provided.</span>
<a href="#l7.932"></a><span id="l7.932">     let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aFilePath));</span>
<a href="#l7.933"></a><span id="l7.933">     let relevantEntries = [];</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineminus">-    return iterator.forEach(function(aEntry) {</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineminus">-      if (aEntry.isDir)</span>
<a href="#l7.936"></a><span id="l7.936" class="difflineminus">-        return;</span>
<a href="#l7.937"></a><span id="l7.937" class="difflineminus">-      let path = aEntry.path;</span>
<a href="#l7.938"></a><span id="l7.938" class="difflineminus">-      let [logTime] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l7.939"></a><span id="l7.939" class="difflineplus">+    return iterator</span>
<a href="#l7.940"></a><span id="l7.940" class="difflineplus">+      .forEach(function(aEntry) {</span>
<a href="#l7.941"></a><span id="l7.941" class="difflineplus">+        if (aEntry.isDir) {</span>
<a href="#l7.942"></a><span id="l7.942" class="difflineplus">+          return;</span>
<a href="#l7.943"></a><span id="l7.943" class="difflineplus">+        }</span>
<a href="#l7.944"></a><span id="l7.944" class="difflineplus">+        let path = aEntry.path;</span>
<a href="#l7.945"></a><span id="l7.945" class="difflineplus">+        let [logTime] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l7.946"></a><span id="l7.946"> </span>
<a href="#l7.947"></a><span id="l7.947" class="difflineminus">-      // If someone placed a 'foreign' file into the logs directory,</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineminus">-      // pattern matching fails and getDateFromFilename() returns [].</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineminus">-      if (logTime &amp;&amp; targetDate == logTime.toDateString()) {</span>
<a href="#l7.950"></a><span id="l7.950" class="difflineminus">-        relevantEntries.push({</span>
<a href="#l7.951"></a><span id="l7.951" class="difflineminus">-          path,</span>
<a href="#l7.952"></a><span id="l7.952" class="difflineminus">-          time: logTime,</span>
<a href="#l7.953"></a><span id="l7.953" class="difflineminus">-        });</span>
<a href="#l7.954"></a><span id="l7.954" class="difflineminus">-      }</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineminus">-    }).then(() =&gt; {</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineminus">-      iterator.close();</span>
<a href="#l7.957"></a><span id="l7.957" class="difflineminus">-      return new Log(relevantEntries);</span>
<a href="#l7.958"></a><span id="l7.958" class="difflineminus">-    }, aError =&gt; {</span>
<a href="#l7.959"></a><span id="l7.959" class="difflineminus">-      iterator.close();</span>
<a href="#l7.960"></a><span id="l7.960" class="difflineminus">-      throw aError;</span>
<a href="#l7.961"></a><span id="l7.961" class="difflineminus">-    });</span>
<a href="#l7.962"></a><span id="l7.962" class="difflineplus">+        // If someone placed a 'foreign' file into the logs directory,</span>
<a href="#l7.963"></a><span id="l7.963" class="difflineplus">+        // pattern matching fails and getDateFromFilename() returns [].</span>
<a href="#l7.964"></a><span id="l7.964" class="difflineplus">+        if (logTime &amp;&amp; targetDate == logTime.toDateString()) {</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineplus">+          relevantEntries.push({</span>
<a href="#l7.966"></a><span id="l7.966" class="difflineplus">+            path,</span>
<a href="#l7.967"></a><span id="l7.967" class="difflineplus">+            time: logTime,</span>
<a href="#l7.968"></a><span id="l7.968" class="difflineplus">+          });</span>
<a href="#l7.969"></a><span id="l7.969" class="difflineplus">+        }</span>
<a href="#l7.970"></a><span id="l7.970" class="difflineplus">+      })</span>
<a href="#l7.971"></a><span id="l7.971" class="difflineplus">+      .then(</span>
<a href="#l7.972"></a><span id="l7.972" class="difflineplus">+        () =&gt; {</span>
<a href="#l7.973"></a><span id="l7.973" class="difflineplus">+          iterator.close();</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineplus">+          return new Log(relevantEntries);</span>
<a href="#l7.975"></a><span id="l7.975" class="difflineplus">+        },</span>
<a href="#l7.976"></a><span id="l7.976" class="difflineplus">+        aError =&gt; {</span>
<a href="#l7.977"></a><span id="l7.977" class="difflineplus">+          iterator.close();</span>
<a href="#l7.978"></a><span id="l7.978" class="difflineplus">+          throw aError;</span>
<a href="#l7.979"></a><span id="l7.979" class="difflineplus">+        }</span>
<a href="#l7.980"></a><span id="l7.980" class="difflineplus">+      );</span>
<a href="#l7.981"></a><span id="l7.981">   },</span>
<a href="#l7.982"></a><span id="l7.982">   // Creates and returns the appropriate LogEnumerator for the given log array</span>
<a href="#l7.983"></a><span id="l7.983">   // depending on aGroupByDay, or an EmptyEnumerator if the input array is empty.</span>
<a href="#l7.984"></a><span id="l7.984">   _getEnumerator(aLogArray, aGroupByDay) {</span>
<a href="#l7.985"></a><span id="l7.985">     let enumerator = aGroupByDay ? DailyLogEnumerator : LogEnumerator;</span>
<a href="#l7.986"></a><span id="l7.986">     return aLogArray.length ? new enumerator(aLogArray) : EmptyEnumerator;</span>
<a href="#l7.987"></a><span id="l7.987">   },</span>
<a href="#l7.988"></a><span id="l7.988">   async getLogPathsForConversation(aConversation) {</span>
<a href="#l7.989"></a><span id="l7.989">     let writer = gLogWritersById.get(aConversation.id);</span>
<a href="#l7.990"></a><span id="l7.990">     // Resolve to null if we haven't created a LogWriter yet for this conv, or</span>
<a href="#l7.991"></a><span id="l7.991">     // if logging is disabled (paths will be null).</span>
<a href="#l7.992"></a><span id="l7.992" class="difflineminus">-    if (!writer || !writer.paths)</span>
<a href="#l7.993"></a><span id="l7.993" class="difflineplus">+    if (!writer || !writer.paths) {</span>
<a href="#l7.994"></a><span id="l7.994">       return null;</span>
<a href="#l7.995"></a><span id="l7.995" class="difflineplus">+    }</span>
<a href="#l7.996"></a><span id="l7.996">     let paths = writer.paths;</span>
<a href="#l7.997"></a><span id="l7.997">     // Wait for any pending file operations to finish, then resolve to the paths</span>
<a href="#l7.998"></a><span id="l7.998">     // regardless of whether these operations succeeded.</span>
<a href="#l7.999"></a><span id="l7.999" class="difflineminus">-    for (let path of paths)</span>
<a href="#l7.1000"></a><span id="l7.1000" class="difflineplus">+    for (let path of paths) {</span>
<a href="#l7.1001"></a><span id="l7.1001">       await gFilePromises.get(path);</span>
<a href="#l7.1002"></a><span id="l7.1002" class="difflineplus">+    }</span>
<a href="#l7.1003"></a><span id="l7.1003">     return paths;</span>
<a href="#l7.1004"></a><span id="l7.1004">   },</span>
<a href="#l7.1005"></a><span id="l7.1005">   getLogsForAccountAndName(aAccount, aNormalizedName, aGroupByDay) {</span>
<a href="#l7.1006"></a><span id="l7.1006" class="difflineminus">-    return this._getLogArray(aAccount, aNormalizedName)</span>
<a href="#l7.1007"></a><span id="l7.1007" class="difflineminus">-               .then(aEntries =&gt; this._getEnumerator(aEntries, aGroupByDay));</span>
<a href="#l7.1008"></a><span id="l7.1008" class="difflineplus">+    return this._getLogArray(aAccount, aNormalizedName).then(aEntries =&gt;</span>
<a href="#l7.1009"></a><span id="l7.1009" class="difflineplus">+      this._getEnumerator(aEntries, aGroupByDay)</span>
<a href="#l7.1010"></a><span id="l7.1010" class="difflineplus">+    );</span>
<a href="#l7.1011"></a><span id="l7.1011">   },</span>
<a href="#l7.1012"></a><span id="l7.1012">   getLogsForAccountBuddy(aAccountBuddy, aGroupByDay) {</span>
<a href="#l7.1013"></a><span id="l7.1013" class="difflineminus">-    return this.getLogsForAccountAndName(aAccountBuddy.account,</span>
<a href="#l7.1014"></a><span id="l7.1014" class="difflineminus">-                                         aAccountBuddy.normalizedName, aGroupByDay);</span>
<a href="#l7.1015"></a><span id="l7.1015" class="difflineplus">+    return this.getLogsForAccountAndName(</span>
<a href="#l7.1016"></a><span id="l7.1016" class="difflineplus">+      aAccountBuddy.account,</span>
<a href="#l7.1017"></a><span id="l7.1017" class="difflineplus">+      aAccountBuddy.normalizedName,</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineplus">+      aGroupByDay</span>
<a href="#l7.1019"></a><span id="l7.1019" class="difflineplus">+    );</span>
<a href="#l7.1020"></a><span id="l7.1020">   },</span>
<a href="#l7.1021"></a><span id="l7.1021">   async getLogsForBuddy(aBuddy, aGroupByDay) {</span>
<a href="#l7.1022"></a><span id="l7.1022">     let entries = [];</span>
<a href="#l7.1023"></a><span id="l7.1023">     for (let accountBuddy of aBuddy.getAccountBuddies()) {</span>
<a href="#l7.1024"></a><span id="l7.1024" class="difflineminus">-      entries = entries.concat(await this._getLogArray(accountBuddy.account,</span>
<a href="#l7.1025"></a><span id="l7.1025" class="difflineminus">-                                                       accountBuddy.normalizedName));</span>
<a href="#l7.1026"></a><span id="l7.1026" class="difflineplus">+      entries = entries.concat(</span>
<a href="#l7.1027"></a><span id="l7.1027" class="difflineplus">+        await this._getLogArray(</span>
<a href="#l7.1028"></a><span id="l7.1028" class="difflineplus">+          accountBuddy.account,</span>
<a href="#l7.1029"></a><span id="l7.1029" class="difflineplus">+          accountBuddy.normalizedName</span>
<a href="#l7.1030"></a><span id="l7.1030" class="difflineplus">+        )</span>
<a href="#l7.1031"></a><span id="l7.1031" class="difflineplus">+      );</span>
<a href="#l7.1032"></a><span id="l7.1032">     }</span>
<a href="#l7.1033"></a><span id="l7.1033">     return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l7.1034"></a><span id="l7.1034">   },</span>
<a href="#l7.1035"></a><span id="l7.1035">   async getLogsForContact(aContact, aGroupByDay) {</span>
<a href="#l7.1036"></a><span id="l7.1036">     let entries = [];</span>
<a href="#l7.1037"></a><span id="l7.1037">     for (let buddy of aContact.getBuddies()) {</span>
<a href="#l7.1038"></a><span id="l7.1038">       for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l7.1039"></a><span id="l7.1039" class="difflineminus">-        entries = entries.concat(await this._getLogArray(accountBuddy.account,</span>
<a href="#l7.1040"></a><span id="l7.1040" class="difflineminus">-                                                         accountBuddy.normalizedName));</span>
<a href="#l7.1041"></a><span id="l7.1041" class="difflineplus">+        entries = entries.concat(</span>
<a href="#l7.1042"></a><span id="l7.1042" class="difflineplus">+          await this._getLogArray(</span>
<a href="#l7.1043"></a><span id="l7.1043" class="difflineplus">+            accountBuddy.account,</span>
<a href="#l7.1044"></a><span id="l7.1044" class="difflineplus">+            accountBuddy.normalizedName</span>
<a href="#l7.1045"></a><span id="l7.1045" class="difflineplus">+          )</span>
<a href="#l7.1046"></a><span id="l7.1046" class="difflineplus">+        );</span>
<a href="#l7.1047"></a><span id="l7.1047">       }</span>
<a href="#l7.1048"></a><span id="l7.1048">     }</span>
<a href="#l7.1049"></a><span id="l7.1049">     return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l7.1050"></a><span id="l7.1050">   },</span>
<a href="#l7.1051"></a><span id="l7.1051">   getLogsForConversation(aConversation, aGroupByDay) {</span>
<a href="#l7.1052"></a><span id="l7.1052">     let name = aConversation.normalizedName;</span>
<a href="#l7.1053"></a><span id="l7.1053" class="difflineminus">-    if (convIsRealMUC(aConversation))</span>
<a href="#l7.1054"></a><span id="l7.1054" class="difflineplus">+    if (convIsRealMUC(aConversation)) {</span>
<a href="#l7.1055"></a><span id="l7.1055">       name += &quot;.chat&quot;;</span>
<a href="#l7.1056"></a><span id="l7.1056" class="difflineminus">-    return this.getLogsForAccountAndName(aConversation.account, name, aGroupByDay);</span>
<a href="#l7.1057"></a><span id="l7.1057" class="difflineplus">+    }</span>
<a href="#l7.1058"></a><span id="l7.1058" class="difflineplus">+    return this.getLogsForAccountAndName(</span>
<a href="#l7.1059"></a><span id="l7.1059" class="difflineplus">+      aConversation.account,</span>
<a href="#l7.1060"></a><span id="l7.1060" class="difflineplus">+      name,</span>
<a href="#l7.1061"></a><span id="l7.1061" class="difflineplus">+      aGroupByDay</span>
<a href="#l7.1062"></a><span id="l7.1062" class="difflineplus">+    );</span>
<a href="#l7.1063"></a><span id="l7.1063">   },</span>
<a href="#l7.1064"></a><span id="l7.1064">   getSystemLogsForAccount(aAccount) {</span>
<a href="#l7.1065"></a><span id="l7.1065">     return this.getLogsForAccountAndName(aAccount, &quot;.system&quot;);</span>
<a href="#l7.1066"></a><span id="l7.1066">   },</span>
<a href="#l7.1067"></a><span id="l7.1067">   async getSimilarLogs(aLog, aGroupByDay) {</span>
<a href="#l7.1068"></a><span id="l7.1068">     let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aLog.path));</span>
<a href="#l7.1069"></a><span id="l7.1069">     let entries;</span>
<a href="#l7.1070"></a><span id="l7.1070">     try {</span>
<a href="#l7.1071"></a><span id="l7.1071">       entries = await iterator.nextBatch();</span>
<a href="#l7.1072"></a><span id="l7.1072">     } catch (aError) {</span>
<a href="#l7.1073"></a><span id="l7.1073" class="difflineminus">-      Cu.reportError(&quot;Error getting similar logs for \&quot;&quot; +</span>
<a href="#l7.1074"></a><span id="l7.1074" class="difflineminus">-                     aLog.path + &quot;\&quot;:\n&quot; + aError);</span>
<a href="#l7.1075"></a><span id="l7.1075" class="difflineplus">+      Cu.reportError(</span>
<a href="#l7.1076"></a><span id="l7.1076" class="difflineplus">+        'Error getting similar logs for &quot;' + aLog.path + '&quot;:\n' + aError</span>
<a href="#l7.1077"></a><span id="l7.1077" class="difflineplus">+      );</span>
<a href="#l7.1078"></a><span id="l7.1078">     }</span>
<a href="#l7.1079"></a><span id="l7.1079">     // If there was an error, this will return an EmptyEnumerator.</span>
<a href="#l7.1080"></a><span id="l7.1080">     return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l7.1081"></a><span id="l7.1081">   },</span>
<a href="#l7.1082"></a><span id="l7.1082"> </span>
<a href="#l7.1083"></a><span id="l7.1083">   getLogFolderPathForAccount(aAccount) {</span>
<a href="#l7.1084"></a><span id="l7.1084">     return getLogFolderPathForAccount(aAccount);</span>
<a href="#l7.1085"></a><span id="l7.1085">   },</span>
<a href="#l7.1086"></a><span id="l7.1086"> </span>
<a href="#l7.1087"></a><span id="l7.1087">   deleteLogFolderForAccount(aAccount) {</span>
<a href="#l7.1088"></a><span id="l7.1088" class="difflineminus">-    if (!aAccount.disconnecting &amp;&amp; !aAccount.disconnected)</span>
<a href="#l7.1089"></a><span id="l7.1089" class="difflineminus">-      throw new Error(&quot;Account must be disconnected first before deleting logs.&quot;);</span>
<a href="#l7.1090"></a><span id="l7.1090" class="difflineplus">+    if (!aAccount.disconnecting &amp;&amp; !aAccount.disconnected) {</span>
<a href="#l7.1091"></a><span id="l7.1091" class="difflineplus">+      throw new Error(</span>
<a href="#l7.1092"></a><span id="l7.1092" class="difflineplus">+        &quot;Account must be disconnected first before deleting logs.&quot;</span>
<a href="#l7.1093"></a><span id="l7.1093" class="difflineplus">+      );</span>
<a href="#l7.1094"></a><span id="l7.1094" class="difflineplus">+    }</span>
<a href="#l7.1095"></a><span id="l7.1095"> </span>
<a href="#l7.1096"></a><span id="l7.1096" class="difflineminus">-    if (aAccount.disconnecting)</span>
<a href="#l7.1097"></a><span id="l7.1097" class="difflineminus">-      Cu.reportError(&quot;Account is still disconnecting while we attempt to remove logs.&quot;);</span>
<a href="#l7.1098"></a><span id="l7.1098" class="difflineplus">+    if (aAccount.disconnecting) {</span>
<a href="#l7.1099"></a><span id="l7.1099" class="difflineplus">+      Cu.reportError(</span>
<a href="#l7.1100"></a><span id="l7.1100" class="difflineplus">+        &quot;Account is still disconnecting while we attempt to remove logs.&quot;</span>
<a href="#l7.1101"></a><span id="l7.1101" class="difflineplus">+      );</span>
<a href="#l7.1102"></a><span id="l7.1102" class="difflineplus">+    }</span>
<a href="#l7.1103"></a><span id="l7.1103"> </span>
<a href="#l7.1104"></a><span id="l7.1104">     let logPath = this.getLogFolderPathForAccount(aAccount);</span>
<a href="#l7.1105"></a><span id="l7.1105">     // Find all operations on files inside the log folder.</span>
<a href="#l7.1106"></a><span id="l7.1106">     let pendingPromises = [];</span>
<a href="#l7.1107"></a><span id="l7.1107">     function checkLogFiles(promiseOperation, filePath) {</span>
<a href="#l7.1108"></a><span id="l7.1108" class="difflineminus">-      if (filePath.startsWith(logPath))</span>
<a href="#l7.1109"></a><span id="l7.1109" class="difflineplus">+      if (filePath.startsWith(logPath)) {</span>
<a href="#l7.1110"></a><span id="l7.1110">         pendingPromises.push(promiseOperation);</span>
<a href="#l7.1111"></a><span id="l7.1111" class="difflineplus">+      }</span>
<a href="#l7.1112"></a><span id="l7.1112">     }</span>
<a href="#l7.1113"></a><span id="l7.1113">     gFilePromises.forEach(checkLogFiles);</span>
<a href="#l7.1114"></a><span id="l7.1114">     // After all operations finish, remove the whole log folder.</span>
<a href="#l7.1115"></a><span id="l7.1115">     return Promise.all(pendingPromises)</span>
<a href="#l7.1116"></a><span id="l7.1116" class="difflineminus">-                  .then(values =&gt; { OS.File.removeDir(logPath, { ignoreAbsent: true }); })</span>
<a href="#l7.1117"></a><span id="l7.1117" class="difflineminus">-                  .catch(aError =&gt; Cu.reportError(&quot;Failed to remove log folders:\n&quot; + aError));</span>
<a href="#l7.1118"></a><span id="l7.1118" class="difflineplus">+      .then(values =&gt; {</span>
<a href="#l7.1119"></a><span id="l7.1119" class="difflineplus">+        OS.File.removeDir(logPath, { ignoreAbsent: true });</span>
<a href="#l7.1120"></a><span id="l7.1120" class="difflineplus">+      })</span>
<a href="#l7.1121"></a><span id="l7.1121" class="difflineplus">+      .catch(aError =&gt;</span>
<a href="#l7.1122"></a><span id="l7.1122" class="difflineplus">+        Cu.reportError(&quot;Failed to remove log folders:\n&quot; + aError)</span>
<a href="#l7.1123"></a><span id="l7.1123" class="difflineplus">+      );</span>
<a href="#l7.1124"></a><span id="l7.1124">   },</span>
<a href="#l7.1125"></a><span id="l7.1125"> </span>
<a href="#l7.1126"></a><span id="l7.1126">   async forEach(aCallback) {</span>
<a href="#l7.1127"></a><span id="l7.1127">     let getAllSubdirs = async function(aPaths, aErrorMsg) {</span>
<a href="#l7.1128"></a><span id="l7.1128">       let entries = [];</span>
<a href="#l7.1129"></a><span id="l7.1129">       for (let path of aPaths) {</span>
<a href="#l7.1130"></a><span id="l7.1130">         let iterator = new OS.File.DirectoryIterator(path);</span>
<a href="#l7.1131"></a><span id="l7.1131">         try {</span>
<a href="#l7.1132"></a><span id="l7.1132">           entries = entries.concat(await iterator.nextBatch());</span>
<a href="#l7.1133"></a><span id="l7.1133">         } catch (aError) {</span>
<a href="#l7.1134"></a><span id="l7.1134" class="difflineminus">-          if (aErrorMsg)</span>
<a href="#l7.1135"></a><span id="l7.1135" class="difflineplus">+          if (aErrorMsg) {</span>
<a href="#l7.1136"></a><span id="l7.1136">             Cu.reportError(aErrorMsg + &quot;\n&quot; + aError);</span>
<a href="#l7.1137"></a><span id="l7.1137" class="difflineplus">+          }</span>
<a href="#l7.1138"></a><span id="l7.1138">         } finally {</span>
<a href="#l7.1139"></a><span id="l7.1139">           iterator.close();</span>
<a href="#l7.1140"></a><span id="l7.1140">         }</span>
<a href="#l7.1141"></a><span id="l7.1141">       }</span>
<a href="#l7.1142"></a><span id="l7.1142" class="difflineminus">-      entries = entries.filter(aEntry =&gt; aEntry.isDir)</span>
<a href="#l7.1143"></a><span id="l7.1143" class="difflineminus">-                       .map(aEntry =&gt; aEntry.path);</span>
<a href="#l7.1144"></a><span id="l7.1144" class="difflineplus">+      entries = entries</span>
<a href="#l7.1145"></a><span id="l7.1145" class="difflineplus">+        .filter(aEntry =&gt; aEntry.isDir)</span>
<a href="#l7.1146"></a><span id="l7.1146" class="difflineplus">+        .map(aEntry =&gt; aEntry.path);</span>
<a href="#l7.1147"></a><span id="l7.1147">       return entries;</span>
<a href="#l7.1148"></a><span id="l7.1148">     };</span>
<a href="#l7.1149"></a><span id="l7.1149"> </span>
<a href="#l7.1150"></a><span id="l7.1150">     let logsPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l7.1151"></a><span id="l7.1151">     let prpls = await getAllSubdirs([logsPath]);</span>
<a href="#l7.1152"></a><span id="l7.1152" class="difflineminus">-    let accounts =</span>
<a href="#l7.1153"></a><span id="l7.1153" class="difflineminus">-      await getAllSubdirs(prpls, &quot;Error while sweeping prpl folder:&quot;);</span>
<a href="#l7.1154"></a><span id="l7.1154" class="difflineminus">-    let logFolders =</span>
<a href="#l7.1155"></a><span id="l7.1155" class="difflineminus">-      await getAllSubdirs(accounts, &quot;Error while sweeping account folder:&quot;);</span>
<a href="#l7.1156"></a><span id="l7.1156" class="difflineplus">+    let accounts = await getAllSubdirs(</span>
<a href="#l7.1157"></a><span id="l7.1157" class="difflineplus">+      prpls,</span>
<a href="#l7.1158"></a><span id="l7.1158" class="difflineplus">+      &quot;Error while sweeping prpl folder:&quot;</span>
<a href="#l7.1159"></a><span id="l7.1159" class="difflineplus">+    );</span>
<a href="#l7.1160"></a><span id="l7.1160" class="difflineplus">+    let logFolders = await getAllSubdirs(</span>
<a href="#l7.1161"></a><span id="l7.1161" class="difflineplus">+      accounts,</span>
<a href="#l7.1162"></a><span id="l7.1162" class="difflineplus">+      &quot;Error while sweeping account folder:&quot;</span>
<a href="#l7.1163"></a><span id="l7.1163" class="difflineplus">+    );</span>
<a href="#l7.1164"></a><span id="l7.1164">     for (let folder of logFolders) {</span>
<a href="#l7.1165"></a><span id="l7.1165">       let iterator = new OS.File.DirectoryIterator(folder);</span>
<a href="#l7.1166"></a><span id="l7.1166">       try {</span>
<a href="#l7.1167"></a><span id="l7.1167">         await iterator.forEach(aEntry =&gt; {</span>
<a href="#l7.1168"></a><span id="l7.1168" class="difflineminus">-          if (aEntry.isDir || !aEntry.name.endsWith(&quot;.json&quot;))</span>
<a href="#l7.1169"></a><span id="l7.1169" class="difflineplus">+          if (aEntry.isDir || !aEntry.name.endsWith(&quot;.json&quot;)) {</span>
<a href="#l7.1170"></a><span id="l7.1170">             return null;</span>
<a href="#l7.1171"></a><span id="l7.1171" class="difflineplus">+          }</span>
<a href="#l7.1172"></a><span id="l7.1172">           return aCallback.processLog(aEntry.path);</span>
<a href="#l7.1173"></a><span id="l7.1173">         });</span>
<a href="#l7.1174"></a><span id="l7.1174">       } catch (aError) {</span>
<a href="#l7.1175"></a><span id="l7.1175">         // If the callback threw, reject the promise and let the caller handle it.</span>
<a href="#l7.1176"></a><span id="l7.1176" class="difflineminus">-        if (!(aError instanceof OS.File.Error))</span>
<a href="#l7.1177"></a><span id="l7.1177" class="difflineplus">+        if (!(aError instanceof OS.File.Error)) {</span>
<a href="#l7.1178"></a><span id="l7.1178">           throw aError;</span>
<a href="#l7.1179"></a><span id="l7.1179" class="difflineplus">+        }</span>
<a href="#l7.1180"></a><span id="l7.1180">         Cu.reportError(&quot;Error sweeping log folder:\n&quot; + aError);</span>
<a href="#l7.1181"></a><span id="l7.1181">       } finally {</span>
<a href="#l7.1182"></a><span id="l7.1182">         iterator.close();</span>
<a href="#l7.1183"></a><span id="l7.1183">       }</span>
<a href="#l7.1184"></a><span id="l7.1184">     }</span>
<a href="#l7.1185"></a><span id="l7.1185">   },</span>
<a href="#l7.1186"></a><span id="l7.1186"> </span>
<a href="#l7.1187"></a><span id="l7.1187">   observe(aSubject, aTopic, aData) {</span>
<a href="#l7.1188"></a><span id="l7.1188">     switch (aTopic) {</span>
<a href="#l7.1189"></a><span id="l7.1189" class="difflineminus">-    case &quot;profile-after-change&quot;:</span>
<a href="#l7.1190"></a><span id="l7.1190" class="difflineminus">-      Services.obs.addObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l7.1191"></a><span id="l7.1191" class="difflineminus">-      break;</span>
<a href="#l7.1192"></a><span id="l7.1192" class="difflineminus">-    case &quot;final-ui-startup&quot;:</span>
<a href="#l7.1193"></a><span id="l7.1193" class="difflineminus">-      Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l7.1194"></a><span id="l7.1194" class="difflineminus">-      [&quot;new-text&quot;, &quot;conversation-closed&quot;, &quot;conversation-left-chat&quot;,</span>
<a href="#l7.1195"></a><span id="l7.1195" class="difflineminus">-       &quot;account-connected&quot;, &quot;account-disconnected&quot;,</span>
<a href="#l7.1196"></a><span id="l7.1196" class="difflineminus">-       &quot;account-buddy-status-changed&quot;].forEach(function(aEvent) {</span>
<a href="#l7.1197"></a><span id="l7.1197" class="difflineminus">-        Services.obs.addObserver(this, aEvent);</span>
<a href="#l7.1198"></a><span id="l7.1198" class="difflineminus">-      }, this);</span>
<a href="#l7.1199"></a><span id="l7.1199" class="difflineminus">-      break;</span>
<a href="#l7.1200"></a><span id="l7.1200" class="difflineminus">-    case &quot;new-text&quot;:</span>
<a href="#l7.1201"></a><span id="l7.1201" class="difflineminus">-      let excludeBecauseEncrypted = false;</span>
<a href="#l7.1202"></a><span id="l7.1202" class="difflineminus">-      if (aSubject.encrypted) {</span>
<a href="#l7.1203"></a><span id="l7.1203" class="difflineminus">-        excludeBecauseEncrypted = !Services.prefs.getBoolPref(</span>
<a href="#l7.1204"></a><span id="l7.1204" class="difflineminus">-          &quot;messenger.account.&quot; + aSubject.conversation.account.id +</span>
<a href="#l7.1205"></a><span id="l7.1205" class="difflineminus">-          &quot;.options.otrAllowMsgLog&quot;,</span>
<a href="#l7.1206"></a><span id="l7.1206" class="difflineminus">-          Services.prefs.getBoolPref(&quot;chat.otr.default.allowMsgLog&quot;));</span>
<a href="#l7.1207"></a><span id="l7.1207" class="difflineminus">-      }</span>
<a href="#l7.1208"></a><span id="l7.1208" class="difflineminus">-      if (!aSubject.noLog &amp;&amp; !excludeBecauseEncrypted) {</span>
<a href="#l7.1209"></a><span id="l7.1209" class="difflineminus">-        let log = getLogWriter(aSubject.conversation);</span>
<a href="#l7.1210"></a><span id="l7.1210" class="difflineminus">-        log.logMessage(aSubject);</span>
<a href="#l7.1211"></a><span id="l7.1211" class="difflineminus">-      }</span>
<a href="#l7.1212"></a><span id="l7.1212" class="difflineminus">-      break;</span>
<a href="#l7.1213"></a><span id="l7.1213" class="difflineminus">-    case &quot;conversation-closed&quot;:</span>
<a href="#l7.1214"></a><span id="l7.1214" class="difflineminus">-    case &quot;conversation-left-chat&quot;:</span>
<a href="#l7.1215"></a><span id="l7.1215" class="difflineminus">-      closeLogWriter(aSubject);</span>
<a href="#l7.1216"></a><span id="l7.1216" class="difflineminus">-      break;</span>
<a href="#l7.1217"></a><span id="l7.1217" class="difflineminus">-    case &quot;account-connected&quot;:</span>
<a href="#l7.1218"></a><span id="l7.1218" class="difflineminus">-      getSystemLogWriter(aSubject, true).logEvent(&quot;+++ &quot; + aSubject.name +</span>
<a href="#l7.1219"></a><span id="l7.1219" class="difflineminus">-                                                &quot; signed on&quot;);</span>
<a href="#l7.1220"></a><span id="l7.1220" class="difflineminus">-      break;</span>
<a href="#l7.1221"></a><span id="l7.1221" class="difflineminus">-    case &quot;account-disconnected&quot;:</span>
<a href="#l7.1222"></a><span id="l7.1222" class="difflineminus">-      getSystemLogWriter(aSubject).logEvent(&quot;+++ &quot; + aSubject.name +</span>
<a href="#l7.1223"></a><span id="l7.1223" class="difflineminus">-                                          &quot; signed off&quot;);</span>
<a href="#l7.1224"></a><span id="l7.1224" class="difflineminus">-      closeSystemLogWriter(aSubject);</span>
<a href="#l7.1225"></a><span id="l7.1225" class="difflineminus">-      break;</span>
<a href="#l7.1226"></a><span id="l7.1226" class="difflineminus">-    case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l7.1227"></a><span id="l7.1227" class="difflineminus">-      let status;</span>
<a href="#l7.1228"></a><span id="l7.1228" class="difflineminus">-      if (!aSubject.online)</span>
<a href="#l7.1229"></a><span id="l7.1229" class="difflineminus">-        status = &quot;Offline&quot;;</span>
<a href="#l7.1230"></a><span id="l7.1230" class="difflineminus">-      else if (aSubject.mobile)</span>
<a href="#l7.1231"></a><span id="l7.1231" class="difflineminus">-        status = &quot;Mobile&quot;;</span>
<a href="#l7.1232"></a><span id="l7.1232" class="difflineminus">-      else if (aSubject.idle)</span>
<a href="#l7.1233"></a><span id="l7.1233" class="difflineminus">-        status = &quot;Idle&quot;;</span>
<a href="#l7.1234"></a><span id="l7.1234" class="difflineminus">-      else if (aSubject.available)</span>
<a href="#l7.1235"></a><span id="l7.1235" class="difflineminus">-        status = &quot;Available&quot;;</span>
<a href="#l7.1236"></a><span id="l7.1236" class="difflineminus">-      else</span>
<a href="#l7.1237"></a><span id="l7.1237" class="difflineminus">-        status = &quot;Unavailable&quot;;</span>
<a href="#l7.1238"></a><span id="l7.1238" class="difflineplus">+      case &quot;profile-after-change&quot;:</span>
<a href="#l7.1239"></a><span id="l7.1239" class="difflineplus">+        Services.obs.addObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l7.1240"></a><span id="l7.1240" class="difflineplus">+        break;</span>
<a href="#l7.1241"></a><span id="l7.1241" class="difflineplus">+      case &quot;final-ui-startup&quot;:</span>
<a href="#l7.1242"></a><span id="l7.1242" class="difflineplus">+        Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l7.1243"></a><span id="l7.1243" class="difflineplus">+        [</span>
<a href="#l7.1244"></a><span id="l7.1244" class="difflineplus">+          &quot;new-text&quot;,</span>
<a href="#l7.1245"></a><span id="l7.1245" class="difflineplus">+          &quot;conversation-closed&quot;,</span>
<a href="#l7.1246"></a><span id="l7.1246" class="difflineplus">+          &quot;conversation-left-chat&quot;,</span>
<a href="#l7.1247"></a><span id="l7.1247" class="difflineplus">+          &quot;account-connected&quot;,</span>
<a href="#l7.1248"></a><span id="l7.1248" class="difflineplus">+          &quot;account-disconnected&quot;,</span>
<a href="#l7.1249"></a><span id="l7.1249" class="difflineplus">+          &quot;account-buddy-status-changed&quot;,</span>
<a href="#l7.1250"></a><span id="l7.1250" class="difflineplus">+        ].forEach(function(aEvent) {</span>
<a href="#l7.1251"></a><span id="l7.1251" class="difflineplus">+          Services.obs.addObserver(this, aEvent);</span>
<a href="#l7.1252"></a><span id="l7.1252" class="difflineplus">+        }, this);</span>
<a href="#l7.1253"></a><span id="l7.1253" class="difflineplus">+        break;</span>
<a href="#l7.1254"></a><span id="l7.1254" class="difflineplus">+      case &quot;new-text&quot;:</span>
<a href="#l7.1255"></a><span id="l7.1255" class="difflineplus">+        let excludeBecauseEncrypted = false;</span>
<a href="#l7.1256"></a><span id="l7.1256" class="difflineplus">+        if (aSubject.encrypted) {</span>
<a href="#l7.1257"></a><span id="l7.1257" class="difflineplus">+          excludeBecauseEncrypted = !Services.prefs.getBoolPref(</span>
<a href="#l7.1258"></a><span id="l7.1258" class="difflineplus">+            &quot;messenger.account.&quot; +</span>
<a href="#l7.1259"></a><span id="l7.1259" class="difflineplus">+              aSubject.conversation.account.id +</span>
<a href="#l7.1260"></a><span id="l7.1260" class="difflineplus">+              &quot;.options.otrAllowMsgLog&quot;,</span>
<a href="#l7.1261"></a><span id="l7.1261" class="difflineplus">+            Services.prefs.getBoolPref(&quot;chat.otr.default.allowMsgLog&quot;)</span>
<a href="#l7.1262"></a><span id="l7.1262" class="difflineplus">+          );</span>
<a href="#l7.1263"></a><span id="l7.1263" class="difflineplus">+        }</span>
<a href="#l7.1264"></a><span id="l7.1264" class="difflineplus">+        if (!aSubject.noLog &amp;&amp; !excludeBecauseEncrypted) {</span>
<a href="#l7.1265"></a><span id="l7.1265" class="difflineplus">+          let log = getLogWriter(aSubject.conversation);</span>
<a href="#l7.1266"></a><span id="l7.1266" class="difflineplus">+          log.logMessage(aSubject);</span>
<a href="#l7.1267"></a><span id="l7.1267" class="difflineplus">+        }</span>
<a href="#l7.1268"></a><span id="l7.1268" class="difflineplus">+        break;</span>
<a href="#l7.1269"></a><span id="l7.1269" class="difflineplus">+      case &quot;conversation-closed&quot;:</span>
<a href="#l7.1270"></a><span id="l7.1270" class="difflineplus">+      case &quot;conversation-left-chat&quot;:</span>
<a href="#l7.1271"></a><span id="l7.1271" class="difflineplus">+        closeLogWriter(aSubject);</span>
<a href="#l7.1272"></a><span id="l7.1272" class="difflineplus">+        break;</span>
<a href="#l7.1273"></a><span id="l7.1273" class="difflineplus">+      case &quot;account-connected&quot;:</span>
<a href="#l7.1274"></a><span id="l7.1274" class="difflineplus">+        getSystemLogWriter(aSubject, true).logEvent(</span>
<a href="#l7.1275"></a><span id="l7.1275" class="difflineplus">+          &quot;+++ &quot; + aSubject.name + &quot; signed on&quot;</span>
<a href="#l7.1276"></a><span id="l7.1276" class="difflineplus">+        );</span>
<a href="#l7.1277"></a><span id="l7.1277" class="difflineplus">+        break;</span>
<a href="#l7.1278"></a><span id="l7.1278" class="difflineplus">+      case &quot;account-disconnected&quot;:</span>
<a href="#l7.1279"></a><span id="l7.1279" class="difflineplus">+        getSystemLogWriter(aSubject).logEvent(</span>
<a href="#l7.1280"></a><span id="l7.1280" class="difflineplus">+          &quot;+++ &quot; + aSubject.name + &quot; signed off&quot;</span>
<a href="#l7.1281"></a><span id="l7.1281" class="difflineplus">+        );</span>
<a href="#l7.1282"></a><span id="l7.1282" class="difflineplus">+        closeSystemLogWriter(aSubject);</span>
<a href="#l7.1283"></a><span id="l7.1283" class="difflineplus">+        break;</span>
<a href="#l7.1284"></a><span id="l7.1284" class="difflineplus">+      case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l7.1285"></a><span id="l7.1285" class="difflineplus">+        let status;</span>
<a href="#l7.1286"></a><span id="l7.1286" class="difflineplus">+        if (!aSubject.online) {</span>
<a href="#l7.1287"></a><span id="l7.1287" class="difflineplus">+          status = &quot;Offline&quot;;</span>
<a href="#l7.1288"></a><span id="l7.1288" class="difflineplus">+        } else if (aSubject.mobile) {</span>
<a href="#l7.1289"></a><span id="l7.1289" class="difflineplus">+          status = &quot;Mobile&quot;;</span>
<a href="#l7.1290"></a><span id="l7.1290" class="difflineplus">+        } else if (aSubject.idle) {</span>
<a href="#l7.1291"></a><span id="l7.1291" class="difflineplus">+          status = &quot;Idle&quot;;</span>
<a href="#l7.1292"></a><span id="l7.1292" class="difflineplus">+        } else if (aSubject.available) {</span>
<a href="#l7.1293"></a><span id="l7.1293" class="difflineplus">+          status = &quot;Available&quot;;</span>
<a href="#l7.1294"></a><span id="l7.1294" class="difflineplus">+        } else {</span>
<a href="#l7.1295"></a><span id="l7.1295" class="difflineplus">+          status = &quot;Unavailable&quot;;</span>
<a href="#l7.1296"></a><span id="l7.1296" class="difflineplus">+        }</span>
<a href="#l7.1297"></a><span id="l7.1297"> </span>
<a href="#l7.1298"></a><span id="l7.1298" class="difflineminus">-      let statusText = aSubject.statusText;</span>
<a href="#l7.1299"></a><span id="l7.1299" class="difflineminus">-      if (statusText)</span>
<a href="#l7.1300"></a><span id="l7.1300" class="difflineminus">-        status += &quot; (\&quot;&quot; + statusText + &quot;\&quot;)&quot;;</span>
<a href="#l7.1301"></a><span id="l7.1301" class="difflineplus">+        let statusText = aSubject.statusText;</span>
<a href="#l7.1302"></a><span id="l7.1302" class="difflineplus">+        if (statusText) {</span>
<a href="#l7.1303"></a><span id="l7.1303" class="difflineplus">+          status += ' (&quot;' + statusText + '&quot;)';</span>
<a href="#l7.1304"></a><span id="l7.1304" class="difflineplus">+        }</span>
<a href="#l7.1305"></a><span id="l7.1305"> </span>
<a href="#l7.1306"></a><span id="l7.1306" class="difflineminus">-      let nameText = aSubject.displayName + &quot; (&quot; + aSubject.userName + &quot;)&quot;;</span>
<a href="#l7.1307"></a><span id="l7.1307" class="difflineminus">-      getSystemLogWriter(aSubject.account).logEvent(nameText + &quot; is now &quot; + status);</span>
<a href="#l7.1308"></a><span id="l7.1308" class="difflineminus">-      break;</span>
<a href="#l7.1309"></a><span id="l7.1309" class="difflineminus">-    default:</span>
<a href="#l7.1310"></a><span id="l7.1310" class="difflineminus">-      throw new Error(&quot;Unexpected notification &quot; + aTopic);</span>
<a href="#l7.1311"></a><span id="l7.1311" class="difflineplus">+        let nameText = aSubject.displayName + &quot; (&quot; + aSubject.userName + &quot;)&quot;;</span>
<a href="#l7.1312"></a><span id="l7.1312" class="difflineplus">+        getSystemLogWriter(aSubject.account).logEvent(</span>
<a href="#l7.1313"></a><span id="l7.1313" class="difflineplus">+          nameText + &quot; is now &quot; + status</span>
<a href="#l7.1314"></a><span id="l7.1314" class="difflineplus">+        );</span>
<a href="#l7.1315"></a><span id="l7.1315" class="difflineplus">+        break;</span>
<a href="#l7.1316"></a><span id="l7.1316" class="difflineplus">+      default:</span>
<a href="#l7.1317"></a><span id="l7.1317" class="difflineplus">+        throw new Error(&quot;Unexpected notification &quot; + aTopic);</span>
<a href="#l7.1318"></a><span id="l7.1318">     }</span>
<a href="#l7.1319"></a><span id="l7.1319">   },</span>
<a href="#l7.1320"></a><span id="l7.1320"> </span>
<a href="#l7.1321"></a><span id="l7.1321">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver, Ci.imILogger]),</span>
<a href="#l7.1322"></a><span id="l7.1322">   classDescription: &quot;Logger&quot;,</span>
<a href="#l7.1323"></a><span id="l7.1323">   classID: Components.ID(&quot;{fb0dc220-2c7a-4216-9f19-6b8f3480eae9}&quot;),</span>
<a href="#l7.1324"></a><span id="l7.1324">   contractID: &quot;@mozilla.org/chat/logger;1&quot;,</span>
<a href="#l7.1325"></a><span id="l7.1325"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/components/src/smileProtocolHandler.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/components/src/smileProtocolHandler.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,41 +1,46 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+);</span>
<a href="#l8.14"></a><span id="l8.14"> var {</span>
<a href="#l8.15"></a><span id="l8.15">   smileImMarkup,</span>
<a href="#l8.16"></a><span id="l8.16">   smileTextNode,</span>
<a href="#l8.17"></a><span id="l8.17">   smileString,</span>
<a href="#l8.18"></a><span id="l8.18">   getSmileRealURI,</span>
<a href="#l8.19"></a><span id="l8.19">   getSmileyList,</span>
<a href="#l8.20"></a><span id="l8.20"> } = ChromeUtils.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22"> var kSmileRegexp = /^smile:\/\//;</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-function smileProtocolHandler() { }</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+function smileProtocolHandler() {}</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> smileProtocolHandler.prototype = {</span>
<a href="#l8.28"></a><span id="l8.28">   scheme: &quot;smile&quot;,</span>
<a href="#l8.29"></a><span id="l8.29">   defaultPort: -1,</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  protocolFlags: Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                 Ci.nsIProtocolHandler.URI_NOAUTH |</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-                 Ci.nsIProtocolHandler.URI_IS_UI_RESOURCE |</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-                 Ci.nsIProtocolHandler.URI_IS_LOCAL_RESOURCE,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  protocolFlags:</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+    Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    Ci.nsIProtocolHandler.URI_NOAUTH |</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+    Ci.nsIProtocolHandler.URI_IS_UI_RESOURCE |</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+    Ci.nsIProtocolHandler.URI_IS_LOCAL_RESOURCE,</span>
<a href="#l8.39"></a><span id="l8.39">   newChannel(aURI, aLoadInfo) {</span>
<a href="#l8.40"></a><span id="l8.40">     let smile = aURI.spec.replace(kSmileRegexp, &quot;&quot;);</span>
<a href="#l8.41"></a><span id="l8.41">     let uri = Services.io.newURI(getSmileRealURI(smile));</span>
<a href="#l8.42"></a><span id="l8.42">     let channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l8.43"></a><span id="l8.43">     channel.originalURI = aURI;</span>
<a href="#l8.44"></a><span id="l8.44">     return channel;</span>
<a href="#l8.45"></a><span id="l8.45">   },</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  allowPort(aPort, aScheme) { return false; },</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  allowPort(aPort, aScheme) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    return false;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  },</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51">   classDescription: &quot;Smile Protocol Handler&quot;,</span>
<a href="#l8.52"></a><span id="l8.52">   classID: Components.ID(&quot;{04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}&quot;),</span>
<a href="#l8.53"></a><span id="l8.53">   contractID: &quot;@mozilla.org/network/protocol;1?name=smile&quot;,</span>
<a href="#l8.54"></a><span id="l8.54">   QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l8.55"></a><span id="l8.55"> };</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([smileProtocolHandler]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/components/src/test/test_accounts.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/components/src/test/test_accounts.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-const {updateAppInfo} = ChromeUtils.import(&quot;resource://testing-common/AppInfo.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+const { updateAppInfo } = ChromeUtils.import(</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  &quot;resource://testing-common/AppInfo.jsm&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> function run_test() {</span>
<a href="#l9.16"></a><span id="l9.16">   do_get_profile();</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   // Test the handling of accounts for unknown protocols.</span>
<a href="#l9.19"></a><span id="l9.19">   const kAccountName = &quot;Unknown&quot;;</span>
<a href="#l9.20"></a><span id="l9.20">   const kPrplId = &quot;prpl-unknown&quot;;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -23,15 +25,18 @@ function run_test() {</span>
<a href="#l9.23"></a><span id="l9.23">     updateAppInfo();</span>
<a href="#l9.24"></a><span id="l9.24">     Services.core.init();</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">     let account = Services.accounts.getAccountByNumericId(1);</span>
<a href="#l9.27"></a><span id="l9.27">     Assert.ok(account instanceof Ci.imIAccount);</span>
<a href="#l9.28"></a><span id="l9.28">     Assert.equal(account.name, kAccountName);</span>
<a href="#l9.29"></a><span id="l9.29">     Assert.equal(account.normalizedName, kAccountName);</span>
<a href="#l9.30"></a><span id="l9.30">     Assert.equal(account.protocol.id, kPrplId);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    Assert.equal(account.connectionErrorReason, Ci.imIAccount.ERROR_UNKNOWN_PRPL);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    Assert.equal(</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+      account.connectionErrorReason,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+      Ci.imIAccount.ERROR_UNKNOWN_PRPL</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+    );</span>
<a href="#l9.36"></a><span id="l9.36">   } finally {</span>
<a href="#l9.37"></a><span id="l9.37">     Services.core.quit();</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">     prefs.deleteBranch(&quot;messenger&quot;);</span>
<a href="#l9.40"></a><span id="l9.40">   }</span>
<a href="#l9.41"></a><span id="l9.41"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/components/src/test/test_commands.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/components/src/test/test_commands.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,153 +1,240 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10"> // We don't load the command service via Services as we want to access</span>
<a href="#l10.11"></a><span id="l10.11"> // _findCommands in order to avoid having to intercept command execution.</span>
<a href="#l10.12"></a><span id="l10.12"> var imCommands = {};</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/imCommands.js&quot;, imCommands);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  &quot;resource:///components/imCommands.js&quot;,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  imCommands</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+);</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> var kPrplId = &quot;green&quot;;</span>
<a href="#l10.20"></a><span id="l10.20"> var kPrplId2 = &quot;red&quot;;</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> var fakeAccount = {</span>
<a href="#l10.23"></a><span id="l10.23">   connected: true,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-  protocol: {id: kPrplId},</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  protocol: { id: kPrplId },</span>
<a href="#l10.26"></a><span id="l10.26"> };</span>
<a href="#l10.27"></a><span id="l10.27"> var fakeDisconnectedAccount = {</span>
<a href="#l10.28"></a><span id="l10.28">   connected: false,</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  protocol: {id: kPrplId},</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  protocol: { id: kPrplId },</span>
<a href="#l10.31"></a><span id="l10.31"> };</span>
<a href="#l10.32"></a><span id="l10.32"> var fakeAccount2 = {</span>
<a href="#l10.33"></a><span id="l10.33">   connected: true,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  protocol: {id: kPrplId2},</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  protocol: { id: kPrplId2 },</span>
<a href="#l10.36"></a><span id="l10.36"> };</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38"> var fakeConversation = {</span>
<a href="#l10.39"></a><span id="l10.39">   account: fakeAccount,</span>
<a href="#l10.40"></a><span id="l10.40">   isChat: true,</span>
<a href="#l10.41"></a><span id="l10.41"> };</span>
<a href="#l10.42"></a><span id="l10.42"> </span>
<a href="#l10.43"></a><span id="l10.43"> function fakeCommand(aName, aUsageContext) {</span>
<a href="#l10.44"></a><span id="l10.44">   this.name = aName;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  if (aUsageContext)</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  if (aUsageContext) {</span>
<a href="#l10.47"></a><span id="l10.47">     this.usageContext = aUsageContext;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  }</span>
<a href="#l10.49"></a><span id="l10.49"> }</span>
<a href="#l10.50"></a><span id="l10.50"> fakeCommand.prototype = {</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  get helpString() { return &quot;&quot;; },</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  get helpString() {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  },</span>
<a href="#l10.55"></a><span id="l10.55">   usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l10.56"></a><span id="l10.56">   priority: Ci.imICommand.CMD_PRIORITY_PRPL,</span>
<a href="#l10.57"></a><span id="l10.57">   run: (aMsg, aConv) =&gt; true,</span>
<a href="#l10.58"></a><span id="l10.58"> };</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60"> function run_test() {</span>
<a href="#l10.61"></a><span id="l10.61">   let cmdserv = new imCommands.CommandsService();</span>
<a href="#l10.62"></a><span id="l10.62">   cmdserv.initCommands();</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64">   // Some commands providing multiple possible completions.</span>
<a href="#l10.65"></a><span id="l10.65">   cmdserv.registerCommand(new fakeCommand(&quot;banana&quot;), kPrplId2);</span>
<a href="#l10.66"></a><span id="l10.66">   cmdserv.registerCommand(new fakeCommand(&quot;baloney&quot;), kPrplId2);</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">   // MUC-only command.</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  cmdserv.registerCommand(new fakeCommand(&quot;balderdash&quot;,</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-                                          Ci.imICommand.CMD_CONTEXT_CHAT),</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-                          kPrplId);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  cmdserv.registerCommand(</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    new fakeCommand(&quot;balderdash&quot;, Ci.imICommand.CMD_CONTEXT_CHAT),</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    kPrplId</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  );</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">   // Name clashes with global command.</span>
<a href="#l10.78"></a><span id="l10.78">   cmdserv.registerCommand(new fakeCommand(&quot;offline&quot;), kPrplId);</span>
<a href="#l10.79"></a><span id="l10.79"> </span>
<a href="#l10.80"></a><span id="l10.80">   // Name starts with another command name.</span>
<a href="#l10.81"></a><span id="l10.81">   cmdserv.registerCommand(new fakeCommand(&quot;helpme&quot;), kPrplId);</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83">   // Command name contains numbers.</span>
<a href="#l10.84"></a><span id="l10.84">   cmdserv.registerCommand(new fakeCommand(&quot;r9kbeta&quot;), kPrplId);</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86">   // Array of (possibly partial) command names as entered by the user.</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-  let testCmds = [&quot;x&quot;, &quot;b&quot;, &quot;ba&quot;, &quot;bal&quot;, &quot;back&quot;, &quot;hel&quot;, &quot;help&quot;, &quot;off&quot;, &quot;offline&quot;];</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  let testCmds = [</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    &quot;x&quot;,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+    &quot;b&quot;,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    &quot;ba&quot;,</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    &quot;bal&quot;,</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    &quot;back&quot;,</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+    &quot;hel&quot;,</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+    &quot;help&quot;,</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+    &quot;off&quot;,</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+    &quot;offline&quot;,</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+  ];</span>
<a href="#l10.99"></a><span id="l10.99"> </span>
<a href="#l10.100"></a><span id="l10.100">   // We test an array of different possible conversations.</span>
<a href="#l10.101"></a><span id="l10.101">   // cmdlist lists all the available commands for the given conversation.</span>
<a href="#l10.102"></a><span id="l10.102">   // results is an array which for each testCmd provides an array containing</span>
<a href="#l10.103"></a><span id="l10.103">   // data with which the return value of _findCommands can be checked. In</span>
<a href="#l10.104"></a><span id="l10.104">   // particular, the name of the command and whether the first (i.e. preferred)</span>
<a href="#l10.105"></a><span id="l10.105">   // entry in the returned array of commands is a prpl command. (If the latter</span>
<a href="#l10.106"></a><span id="l10.106">   // boolean is not given, false is assumed, if the name is not given, that</span>
<a href="#l10.107"></a><span id="l10.107">   // corresponds to no commands being returned.)</span>
<a href="#l10.108"></a><span id="l10.108">   let testData = [</span>
<a href="#l10.109"></a><span id="l10.109">     {</span>
<a href="#l10.110"></a><span id="l10.110">       desc: &quot;No conversation argument.&quot;,</span>
<a href="#l10.111"></a><span id="l10.111">       cmdlist: &quot;away, back, busy, dnd, help, offline, raw, say&quot;,</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-      results: [[], [], [&quot;back&quot;], [], [&quot;back&quot;], [&quot;help&quot;], [&quot;help&quot;], [&quot;offline&quot;], [&quot;offline&quot;]],</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+      results: [</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+        [],</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+        [],</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+        [],</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+      ],</span>
<a href="#l10.124"></a><span id="l10.124">     },</span>
<a href="#l10.125"></a><span id="l10.125">     {</span>
<a href="#l10.126"></a><span id="l10.126">       desc: &quot;Disconnected conversation with fakeAccount.&quot;,</span>
<a href="#l10.127"></a><span id="l10.127">       conv: {</span>
<a href="#l10.128"></a><span id="l10.128">         account: fakeDisconnectedAccount,</span>
<a href="#l10.129"></a><span id="l10.129">       },</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-      cmdlist: &quot;away, back, busy, dnd, help, helpme, offline, offline, r9kbeta, raw, say&quot;,</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-      results: [[], [], [&quot;back&quot;], [], [&quot;back&quot;], [&quot;help&quot;], [&quot;help&quot;], [&quot;offline&quot;], [&quot;offline&quot;]],</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+      cmdlist:</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+        &quot;away, back, busy, dnd, help, helpme, offline, offline, r9kbeta, raw, say&quot;,</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+      results: [</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+        [],</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+        [],</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+        [],</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+      ],</span>
<a href="#l10.145"></a><span id="l10.145">     },</span>
<a href="#l10.146"></a><span id="l10.146">     {</span>
<a href="#l10.147"></a><span id="l10.147">       desc: &quot;Conversation with fakeAccount.&quot;,</span>
<a href="#l10.148"></a><span id="l10.148">       conv: {</span>
<a href="#l10.149"></a><span id="l10.149">         account: fakeAccount,</span>
<a href="#l10.150"></a><span id="l10.150">       },</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-      cmdlist: &quot;away, back, busy, dnd, help, helpme, offline, offline, r9kbeta, raw, say&quot;,</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-      results: [[], [], [&quot;back&quot;], [], [&quot;back&quot;], [], [&quot;help&quot;], [&quot;offline&quot;], [&quot;offline&quot;]],</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+      cmdlist:</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+        &quot;away, back, busy, dnd, help, helpme, offline, offline, r9kbeta, raw, say&quot;,</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+      results: [</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+        [],</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+        [],</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+        [],</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+        [],</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+      ],</span>
<a href="#l10.166"></a><span id="l10.166">     },</span>
<a href="#l10.167"></a><span id="l10.167">     {</span>
<a href="#l10.168"></a><span id="l10.168">       desc: &quot;MUC with fakeAccount.&quot;,</span>
<a href="#l10.169"></a><span id="l10.169">       conv: {</span>
<a href="#l10.170"></a><span id="l10.170">         account: fakeAccount,</span>
<a href="#l10.171"></a><span id="l10.171">         isChat: true,</span>
<a href="#l10.172"></a><span id="l10.172">       },</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-      cmdlist: &quot;away, back, balderdash, busy, dnd, help, helpme, offline, offline, r9kbeta, raw, say&quot;,</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-      results: [[], [], [], [&quot;balderdash&quot;, true], [&quot;back&quot;], [], [&quot;help&quot;], [&quot;offline&quot;], [&quot;offline&quot;]],</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+      cmdlist:</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+        &quot;away, back, balderdash, busy, dnd, help, helpme, offline, offline, r9kbeta, raw, say&quot;,</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+      results: [</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+        [],</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+        [],</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+        [],</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+        [&quot;balderdash&quot;, true],</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+        [],</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+      ],</span>
<a href="#l10.188"></a><span id="l10.188">     },</span>
<a href="#l10.189"></a><span id="l10.189">     {</span>
<a href="#l10.190"></a><span id="l10.190">       desc: &quot;Conversation with fakeAccount2.&quot;,</span>
<a href="#l10.191"></a><span id="l10.191">       conv: {</span>
<a href="#l10.192"></a><span id="l10.192">         account: fakeAccount2,</span>
<a href="#l10.193"></a><span id="l10.193">       },</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-      cmdlist: &quot;away, back, baloney, banana, busy, dnd, help, offline, raw, say&quot;,</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-      results: [[], [], [], [&quot;baloney&quot;, true], [&quot;back&quot;], [&quot;help&quot;], [&quot;help&quot;], [&quot;offline&quot;], [&quot;offline&quot;]],</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+      cmdlist:</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+        &quot;away, back, baloney, banana, busy, dnd, help, offline, raw, say&quot;,</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+      results: [</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+        [],</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+        [],</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+        [],</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+        [&quot;baloney&quot;, true],</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+      ],</span>
<a href="#l10.209"></a><span id="l10.209">     },</span>
<a href="#l10.210"></a><span id="l10.210">     {</span>
<a href="#l10.211"></a><span id="l10.211">       desc: &quot;MUC with fakeAccount2.&quot;,</span>
<a href="#l10.212"></a><span id="l10.212">       conv: {</span>
<a href="#l10.213"></a><span id="l10.213">         account: fakeAccount2,</span>
<a href="#l10.214"></a><span id="l10.214">         isChat: true,</span>
<a href="#l10.215"></a><span id="l10.215">       },</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-      cmdlist: &quot;away, back, baloney, banana, busy, dnd, help, offline, raw, say&quot;,</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-      results: [[], [], [], [&quot;baloney&quot;, true], [&quot;back&quot;], [&quot;help&quot;], [&quot;help&quot;], [&quot;offline&quot;], [&quot;offline&quot;]],</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+      cmdlist:</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+        &quot;away, back, baloney, banana, busy, dnd, help, offline, raw, say&quot;,</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+      results: [</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+        [],</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+        [],</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+        [],</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+        [&quot;baloney&quot;, true],</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+        [&quot;back&quot;],</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+        [&quot;help&quot;],</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+        [&quot;offline&quot;],</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+      ],</span>
<a href="#l10.231"></a><span id="l10.231">     },</span>
<a href="#l10.232"></a><span id="l10.232">   ];</span>
<a href="#l10.233"></a><span id="l10.233"> </span>
<a href="#l10.234"></a><span id="l10.234">   for (let test of testData) {</span>
<a href="#l10.235"></a><span id="l10.235">     info(&quot;The following tests are with: &quot; + test.desc);</span>
<a href="#l10.236"></a><span id="l10.236"> </span>
<a href="#l10.237"></a><span id="l10.237">     // Check which commands are available in which context.</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-    let cmdlist = cmdserv.listCommandsForConversation(test.conv, {})</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-                         .map(aCmd =&gt; aCmd.name).sort().join(&quot;, &quot;);</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+    let cmdlist = cmdserv</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+      .listCommandsForConversation(test.conv, {})</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+      .map(aCmd =&gt; aCmd.name)</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+      .sort()</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+      .join(&quot;, &quot;);</span>
<a href="#l10.245"></a><span id="l10.245">     Assert.equal(cmdlist, test.cmdlist);</span>
<a href="#l10.246"></a><span id="l10.246"> </span>
<a href="#l10.247"></a><span id="l10.247">     for (let testCmd of testCmds) {</span>
<a href="#l10.248"></a><span id="l10.248">       info(&quot;Testing command found for '&quot; + testCmd + &quot;'&quot;);</span>
<a href="#l10.249"></a><span id="l10.249">       let expectedResult = test.results.shift();</span>
<a href="#l10.250"></a><span id="l10.250">       let cmdArray = cmdserv._findCommands(test.conv, testCmd);</span>
<a href="#l10.251"></a><span id="l10.251">       // Check whether commands are only returned when appropriate.</span>
<a href="#l10.252"></a><span id="l10.252">       Assert.equal(cmdArray.length &gt; 0, expectedResult.length &gt; 0);</span>
<a href="#l10.253"></a><span id="l10.253">       if (cmdArray.length) {</span>
<a href="#l10.254"></a><span id="l10.254">         // Check if the right command was returned.</span>
<a href="#l10.255"></a><span id="l10.255">         Assert.equal(cmdArray[0].name, expectedResult[0]);</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-        Assert.equal(cmdArray[0].priority == Ci.imICommand.CMD_PRIORITY_PRPL,</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-                     !!expectedResult[1]);</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+        Assert.equal(</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+          cmdArray[0].priority == Ci.imICommand.CMD_PRIORITY_PRPL,</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+          !!expectedResult[1]</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+        );</span>
<a href="#l10.262"></a><span id="l10.262">       }</span>
<a href="#l10.263"></a><span id="l10.263">     }</span>
<a href="#l10.264"></a><span id="l10.264">   }</span>
<a href="#l10.265"></a><span id="l10.265"> </span>
<a href="#l10.266"></a><span id="l10.266">   // Array of messages to test command execution of.</span>
<a href="#l10.267"></a><span id="l10.267">   let testMessages = [</span>
<a href="#l10.268"></a><span id="l10.268">     {</span>
<a href="#l10.269"></a><span id="l10.269">       message: &quot;/r9kbeta&quot;,</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineat">@@ -169,13 +256,16 @@ function run_test() {</span>
<a href="#l10.271"></a><span id="l10.271">       message: &quot;/notregistered&quot;,</span>
<a href="#l10.272"></a><span id="l10.272">       result: false,</span>
<a href="#l10.273"></a><span id="l10.273">     },</span>
<a href="#l10.274"></a><span id="l10.274">   ];</span>
<a href="#l10.275"></a><span id="l10.275"> </span>
<a href="#l10.276"></a><span id="l10.276">   // Test command execution.</span>
<a href="#l10.277"></a><span id="l10.277">   for (let executionTest of testMessages) {</span>
<a href="#l10.278"></a><span id="l10.278">     info(&quot;Testing command execution for '&quot; + executionTest.message + &quot;'&quot;);</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-    Assert.equal(cmdserv.executeCommand(executionTest.message, fakeConversation), executionTest.result);</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+    Assert.equal(</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+      cmdserv.executeCommand(executionTest.message, fakeConversation),</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+      executionTest.result</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+    );</span>
<a href="#l10.284"></a><span id="l10.284">   }</span>
<a href="#l10.285"></a><span id="l10.285"> </span>
<a href="#l10.286"></a><span id="l10.286">   cmdserv.unInitCommands();</span>
<a href="#l10.287"></a><span id="l10.287"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/components/src/test/test_conversations.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/components/src/test/test_conversations.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,68 +1,83 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l11.5"></a><span id="l11.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-var {</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-  GenericConvIMPrototype,</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-  Message,</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+var { GenericConvIMPrototype, Message } = ChromeUtils.import(</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+);</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> var imConversations = {};</span>
<a href="#l11.18"></a><span id="l11.18"> Services.scriptloader.loadSubScript(</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  &quot;resource:///components/imConversations.js&quot;, imConversations</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  &quot;resource:///components/imConversations.js&quot;,</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+  imConversations</span>
<a href="#l11.22"></a><span id="l11.22"> );</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> // Fake prplConversation</span>
<a href="#l11.25"></a><span id="l11.25"> var _id = 0;</span>
<a href="#l11.26"></a><span id="l11.26"> function Conversation(aName) {</span>
<a href="#l11.27"></a><span id="l11.27">   this._name = aName;</span>
<a href="#l11.28"></a><span id="l11.28">   this._observers = [];</span>
<a href="#l11.29"></a><span id="l11.29">   this._date = Date.now() * 1000;</span>
<a href="#l11.30"></a><span id="l11.30">   this.id = ++_id;</span>
<a href="#l11.31"></a><span id="l11.31"> }</span>
<a href="#l11.32"></a><span id="l11.32"> Conversation.prototype = {</span>
<a href="#l11.33"></a><span id="l11.33">   __proto__: GenericConvIMPrototype,</span>
<a href="#l11.34"></a><span id="l11.34">   _account: {</span>
<a href="#l11.35"></a><span id="l11.35">     imAccount: {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-      protocol: {name: &quot;Fake Protocol&quot;},</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+      protocol: { name: &quot;Fake Protocol&quot; },</span>
<a href="#l11.38"></a><span id="l11.38">       alias: &quot;&quot;,</span>
<a href="#l11.39"></a><span id="l11.39">       name: &quot;Fake Account&quot;,</span>
<a href="#l11.40"></a><span id="l11.40">     },</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-    ERROR(e) { throw e; },</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+    ERROR(e) {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      throw e;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    },</span>
<a href="#l11.45"></a><span id="l11.45">     DEBUG() {},</span>
<a href="#l11.46"></a><span id="l11.46">   },</span>
<a href="#l11.47"></a><span id="l11.47">   addObserver(aObserver) {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-    if (!(aObserver instanceof Ci.nsIObserver))</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-      aObserver = {observe: aObserver};</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+    if (!(aObserver instanceof Ci.nsIObserver)) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+      aObserver = { observe: aObserver };</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+    }</span>
<a href="#l11.53"></a><span id="l11.53">     GenericConvIMPrototype.addObserver.call(this, aObserver);</span>
<a href="#l11.54"></a><span id="l11.54">   },</span>
<a href="#l11.55"></a><span id="l11.55"> };</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57"> // Ensure that when iMsg.message is set to a message (including the empty</span>
<a href="#l11.58"></a><span id="l11.58"> // string), it returns that message. If not, it should return the original</span>
<a href="#l11.59"></a><span id="l11.59"> // message. This prevents regressions due to JS coercions.</span>
<a href="#l11.60"></a><span id="l11.60"> var test_null_message = function() {</span>
<a href="#l11.61"></a><span id="l11.61">   let originalMessage = &quot;Hi!&quot;;</span>
<a href="#l11.62"></a><span id="l11.62">   let pMsg = new Message(&quot;buddy&quot;, originalMessage, {</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    outgoing: true, _alias: &quot;buddy&quot;, time: Date.now(),</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+    outgoing: true,</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    _alias: &quot;buddy&quot;,</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+    time: Date.now(),</span>
<a href="#l11.67"></a><span id="l11.67">   });</span>
<a href="#l11.68"></a><span id="l11.68">   let iMsg = new imConversations.imMessage(pMsg);</span>
<a href="#l11.69"></a><span id="l11.69">   equal(iMsg.message, originalMessage, &quot;Expected the original message.&quot;);</span>
<a href="#l11.70"></a><span id="l11.70">   // Setting the message should prevent a fallback to the original.</span>
<a href="#l11.71"></a><span id="l11.71">   iMsg.message = &quot;&quot;;</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  equal(iMsg.message, &quot;&quot;, &quot;Expected an empty string; not the original message.&quot;);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  equal(iMsg.originalMessage, originalMessage, &quot;Expected the original message.&quot;);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  equal(</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+    iMsg.message,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+    &quot;Expected an empty string; not the original message.&quot;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  );</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+  equal(</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    iMsg.originalMessage,</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    originalMessage,</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+    &quot;Expected the original message.&quot;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  );</span>
<a href="#l11.84"></a><span id="l11.84"> };</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86"> // ROT13, used as an example transformation.</span>
<a href="#l11.87"></a><span id="l11.87"> function rot13(aString) {</span>
<a href="#l11.88"></a><span id="l11.88">   return aString.replace(/[a-zA-Z]/g, function(c) {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-    return String.fromCharCode(c.charCodeAt(0) + (c.toLowerCase() &lt; &quot;n&quot; ? 1 : -1) * 13);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+    return String.fromCharCode(</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+      c.charCodeAt(0) + (c.toLowerCase() &lt; &quot;n&quot; ? 1 : -1) * 13</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+    );</span>
<a href="#l11.93"></a><span id="l11.93">   });</span>
<a href="#l11.94"></a><span id="l11.94"> }</span>
<a href="#l11.95"></a><span id="l11.95"> </span>
<a href="#l11.96"></a><span id="l11.96"> // A test that exercises the message transformation pipeline.</span>
<a href="#l11.97"></a><span id="l11.97"> //</span>
<a href="#l11.98"></a><span id="l11.98"> // From the sending users perspective, this looks like:</span>
<a href="#l11.99"></a><span id="l11.99"> //   -&gt; UIConv sendMsg</span>
<a href="#l11.100"></a><span id="l11.100"> //   -&gt; UIConv notifyObservers `preparing-message`</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineat">@@ -81,90 +96,117 @@ function rot13(aString) {</span>
<a href="#l11.102"></a><span id="l11.102"> //   -&gt; UIConv notifyObservers `received-message`</span>
<a href="#l11.103"></a><span id="l11.103"> //   -&gt; protocol prepareForDisplaying</span>
<a href="#l11.104"></a><span id="l11.104"> //   -&gt; UIConv notifyObservers `new-text`</span>
<a href="#l11.105"></a><span id="l11.105"> //</span>
<a href="#l11.106"></a><span id="l11.106"> // The test walks the sending path, which covers both.</span>
<a href="#l11.107"></a><span id="l11.107"> var test_message_transformation = function() {</span>
<a href="#l11.108"></a><span id="l11.108">   let conv = new Conversation();</span>
<a href="#l11.109"></a><span id="l11.109">   conv.sendMsg = function(aMsg) {</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-    this.writeMessage(&quot;user&quot;, aMsg, {outgoing: true});</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+    this.writeMessage(&quot;user&quot;, aMsg, { outgoing: true });</span>
<a href="#l11.112"></a><span id="l11.112">   };</span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114">   let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l11.115"></a><span id="l11.115">   let message = &quot;Hello!&quot;;</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-  let receivedMsg = false, newTxt = false;</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+  let receivedMsg = false,</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+    newTxt = false;</span>
<a href="#l11.119"></a><span id="l11.119"> </span>
<a href="#l11.120"></a><span id="l11.120">   uiConv.addObserver({</span>
<a href="#l11.121"></a><span id="l11.121">     observe(aObject, aTopic, aMsg) {</span>
<a href="#l11.122"></a><span id="l11.122">       switch (aTopic) {</span>
<a href="#l11.123"></a><span id="l11.123">         case &quot;sending-message&quot;:</span>
<a href="#l11.124"></a><span id="l11.124">           ok(!newTxt, &quot;sending-message should fire before new-text.&quot;);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-          ok(!receivedMsg, &quot;sending-message should fire before received-message.&quot;);</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-          ok(aObject.QueryInterface(Ci.imIOutgoingMessage), &quot;Wrong message type.&quot;);</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+          ok(</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+            !receivedMsg,</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+            &quot;sending-message should fire before received-message.&quot;</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+          );</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+          ok(</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+            aObject.QueryInterface(Ci.imIOutgoingMessage),</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+            &quot;Wrong message type.&quot;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+          );</span>
<a href="#l11.135"></a><span id="l11.135">           aObject.message = rot13(aObject.message);</span>
<a href="#l11.136"></a><span id="l11.136">           break;</span>
<a href="#l11.137"></a><span id="l11.137">         case &quot;received-message&quot;:</span>
<a href="#l11.138"></a><span id="l11.138">           ok(!newTxt, &quot;received-message should fire before new-text.&quot;);</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-          ok(!receivedMsg, &quot;Sanity check that receive-message hasn't fired yet.&quot;);</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+          ok(</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+            !receivedMsg,</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+            &quot;Sanity check that receive-message hasn't fired yet.&quot;</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+          );</span>
<a href="#l11.144"></a><span id="l11.144">           ok(aObject.outgoing, &quot;Expected an outgoing message.&quot;);</span>
<a href="#l11.145"></a><span id="l11.145">           ok(aObject.QueryInterface(Ci.imIMessage), &quot;Wrong message type.&quot;);</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-          equal(aObject.displayMessage, rot13(message), &quot;Expected to have been rotated while sending-message.&quot;);</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+          equal(</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+            aObject.displayMessage,</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+            rot13(message),</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+            &quot;Expected to have been rotated while sending-message.&quot;</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+          );</span>
<a href="#l11.152"></a><span id="l11.152">           aObject.displayMessage = rot13(aObject.displayMessage);</span>
<a href="#l11.153"></a><span id="l11.153">           receivedMsg = true;</span>
<a href="#l11.154"></a><span id="l11.154">           break;</span>
<a href="#l11.155"></a><span id="l11.155">         case &quot;new-text&quot;:</span>
<a href="#l11.156"></a><span id="l11.156">           ok(!newTxt, &quot;Sanity check that new-text hasn't fired yet.&quot;);</span>
<a href="#l11.157"></a><span id="l11.157">           ok(receivedMsg, &quot;Expected received-message to have fired.&quot;);</span>
<a href="#l11.158"></a><span id="l11.158">           ok(aObject.outgoing, &quot;Expected an outgoing message.&quot;);</span>
<a href="#l11.159"></a><span id="l11.159">           ok(aObject.QueryInterface(Ci.imIMessage), &quot;Wrong message type.&quot;);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-          equal(aObject.displayMessage, message, &quot;Expected to have been rotated back to msg in received-message.&quot;);</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+          equal(</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+            aObject.displayMessage,</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+            message,</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+            &quot;Expected to have been rotated back to msg in received-message.&quot;</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+          );</span>
<a href="#l11.166"></a><span id="l11.166">           newTxt = true;</span>
<a href="#l11.167"></a><span id="l11.167">           break;</span>
<a href="#l11.168"></a><span id="l11.168">       }</span>
<a href="#l11.169"></a><span id="l11.169">     },</span>
<a href="#l11.170"></a><span id="l11.170">   });</span>
<a href="#l11.171"></a><span id="l11.171"> </span>
<a href="#l11.172"></a><span id="l11.172">   uiConv.sendMsg(message);</span>
<a href="#l11.173"></a><span id="l11.173">   ok(newTxt, &quot;Expected new-text to have fired.&quot;);</span>
<a href="#l11.174"></a><span id="l11.174"> };</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176"> // A test that cancels a message before it can be sent.</span>
<a href="#l11.177"></a><span id="l11.177"> var test_cancel_send_message = function() {</span>
<a href="#l11.178"></a><span id="l11.178">   let conv = new Conversation();</span>
<a href="#l11.179"></a><span id="l11.179">   conv.sendMsg = function(aMsg) {</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-    ok(false, &quot;The message should have been halted in the conversation service.&quot;);</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+    ok(</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+      false,</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+      &quot;The message should have been halted in the conversation service.&quot;</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+    );</span>
<a href="#l11.185"></a><span id="l11.185">   };</span>
<a href="#l11.186"></a><span id="l11.186"> </span>
<a href="#l11.187"></a><span id="l11.187">   let sending = false;</span>
<a href="#l11.188"></a><span id="l11.188">   let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l11.189"></a><span id="l11.189">   uiConv.addObserver({</span>
<a href="#l11.190"></a><span id="l11.190">     observe(aObject, aTopic, aMsg) {</span>
<a href="#l11.191"></a><span id="l11.191">       switch (aTopic) {</span>
<a href="#l11.192"></a><span id="l11.192">         case &quot;sending-message&quot;:</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-          ok(aObject.QueryInterface(Ci.imIOutgoingMessage), &quot;Wrong message type.&quot;);</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+          ok(</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+            aObject.QueryInterface(Ci.imIOutgoingMessage),</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+            &quot;Wrong message type.&quot;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+          );</span>
<a href="#l11.198"></a><span id="l11.198">           aObject.cancelled = true;</span>
<a href="#l11.199"></a><span id="l11.199">           sending = true;</span>
<a href="#l11.200"></a><span id="l11.200">           break;</span>
<a href="#l11.201"></a><span id="l11.201">         case &quot;received-message&quot;:</span>
<a href="#l11.202"></a><span id="l11.202">         case &quot;new-text&quot;:</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-          ok(false, &quot;No other notification should be fired for a cancelled message.&quot;);</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+          ok(</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+            false,</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+            &quot;No other notification should be fired for a cancelled message.&quot;</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+          );</span>
<a href="#l11.208"></a><span id="l11.208">           break;</span>
<a href="#l11.209"></a><span id="l11.209">       }</span>
<a href="#l11.210"></a><span id="l11.210">     },</span>
<a href="#l11.211"></a><span id="l11.211">   });</span>
<a href="#l11.212"></a><span id="l11.212">   uiConv.sendMsg(&quot;Hi!&quot;);</span>
<a href="#l11.213"></a><span id="l11.213">   ok(sending, &quot;The sending-message notification was never fired.&quot;);</span>
<a href="#l11.214"></a><span id="l11.214"> };</span>
<a href="#l11.215"></a><span id="l11.215"> </span>
<a href="#l11.216"></a><span id="l11.216"> // A test that cancels a message before it gets displayed.</span>
<a href="#l11.217"></a><span id="l11.217"> var test_cancel_display_message = function() {</span>
<a href="#l11.218"></a><span id="l11.218">   let conv = new Conversation();</span>
<a href="#l11.219"></a><span id="l11.219">   conv.sendMsg = function(aMsg) {</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-    this.writeMessage(&quot;user&quot;, aMsg, {outgoing: true});</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+    this.writeMessage(&quot;user&quot;, aMsg, { outgoing: true });</span>
<a href="#l11.222"></a><span id="l11.222">   };</span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224">   let received = false;</span>
<a href="#l11.225"></a><span id="l11.225">   let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l11.226"></a><span id="l11.226">   uiConv.addObserver({</span>
<a href="#l11.227"></a><span id="l11.227">     observe(aObject, aTopic, aMsg) {</span>
<a href="#l11.228"></a><span id="l11.228">       switch (aTopic) {</span>
<a href="#l11.229"></a><span id="l11.229">         case &quot;received-message&quot;:</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineat">@@ -183,17 +225,17 @@ var test_cancel_display_message = functi</span>
<a href="#l11.231"></a><span id="l11.231">   ok(received, &quot;The received-message notification was never fired.&quot;);</span>
<a href="#l11.232"></a><span id="l11.232"> };</span>
<a href="#l11.233"></a><span id="l11.233"> </span>
<a href="#l11.234"></a><span id="l11.234"> // A test that ensures protocols get a chance to prepare a message before</span>
<a href="#l11.235"></a><span id="l11.235"> // sending and displaying.</span>
<a href="#l11.236"></a><span id="l11.236"> var test_prpl_message_prep = function() {</span>
<a href="#l11.237"></a><span id="l11.237">   let conv = new Conversation();</span>
<a href="#l11.238"></a><span id="l11.238">   conv.sendMsg = function(aMsg) {</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-    this.writeMessage(&quot;user&quot;, aMsg, {outgoing: true});</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+    this.writeMessage(&quot;user&quot;, aMsg, { outgoing: true });</span>
<a href="#l11.241"></a><span id="l11.241">   };</span>
<a href="#l11.242"></a><span id="l11.242"> </span>
<a href="#l11.243"></a><span id="l11.243">   let msg = &quot;Hi!&quot;;</span>
<a href="#l11.244"></a><span id="l11.244">   let prefix = &quot;test&gt; &quot;;</span>
<a href="#l11.245"></a><span id="l11.245"> </span>
<a href="#l11.246"></a><span id="l11.246">   let prepared = false;</span>
<a href="#l11.247"></a><span id="l11.247">   conv.prepareForSending = function(aMsg) {</span>
<a href="#l11.248"></a><span id="l11.248">     ok(aMsg.QueryInterface(Ci.imIOutgoingMessage), &quot;Wrong message type.&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/components/src/test/test_logger.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/components/src/test/test_logger.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,19 +1,22 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> do_get_profile();</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> var gLogger = {};</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/logger.js&quot;, gLogger);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  &quot;resource:///components/logger.js&quot;,</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  gLogger</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+);</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> var logDirPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24"> var dummyAccount = {</span>
<a href="#l12.25"></a><span id="l12.25">   name: &quot;dummy-account&quot;,</span>
<a href="#l12.26"></a><span id="l12.26">   normalizedName: &quot;dummyaccount&quot;,</span>
<a href="#l12.27"></a><span id="l12.27">   protocol: {</span>
<a href="#l12.28"></a><span id="l12.28">     normalizedName: &quot;dummy&quot;,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineat">@@ -30,48 +33,60 @@ var dummyTwitterAccount = {</span>
<a href="#l12.30"></a><span id="l12.30">   },</span>
<a href="#l12.31"></a><span id="l12.31"> };</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33"> var dummyConv = {</span>
<a href="#l12.34"></a><span id="l12.34">   account: dummyAccount,</span>
<a href="#l12.35"></a><span id="l12.35">   id: 0,</span>
<a href="#l12.36"></a><span id="l12.36">   title: &quot;dummy conv&quot;,</span>
<a href="#l12.37"></a><span id="l12.37">   normalizedName: &quot;dummyconv&quot;,</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  get name() { return this.normalizedName; },</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-  get startDate() { return new Date(2011, 5, 28).valueOf() * 1000; },</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+  get name() {</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    return this.normalizedName;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  },</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  get startDate() {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    return new Date(2011, 5, 28).valueOf() * 1000;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  },</span>
<a href="#l12.46"></a><span id="l12.46">   isChat: false,</span>
<a href="#l12.47"></a><span id="l12.47"> };</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49"> // A day after the first one.</span>
<a href="#l12.50"></a><span id="l12.50"> var dummyConv2 = {</span>
<a href="#l12.51"></a><span id="l12.51">   account: dummyAccount,</span>
<a href="#l12.52"></a><span id="l12.52">   id: 0,</span>
<a href="#l12.53"></a><span id="l12.53">   title: &quot;dummy conv&quot;,</span>
<a href="#l12.54"></a><span id="l12.54">   normalizedName: &quot;dummyconv&quot;,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-  get name() { return this.normalizedName; },</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-  get startDate() { return new Date(2011, 5, 29).valueOf() * 1000; },</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  get name() {</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+    return this.normalizedName;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  },</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  get startDate() {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    return new Date(2011, 5, 29).valueOf() * 1000;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+  },</span>
<a href="#l12.63"></a><span id="l12.63">   isChat: false,</span>
<a href="#l12.64"></a><span id="l12.64"> };</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66"> var dummyMUC = {</span>
<a href="#l12.67"></a><span id="l12.67">   account: dummyAccount,</span>
<a href="#l12.68"></a><span id="l12.68">   id: 1,</span>
<a href="#l12.69"></a><span id="l12.69">   title: &quot;Dummy MUC&quot;,</span>
<a href="#l12.70"></a><span id="l12.70">   normalizedName: &quot;dummymuc&quot;,</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-  get name() { return this.normalizedName; },</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+  get name() {</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    return this.normalizedName;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  },</span>
<a href="#l12.75"></a><span id="l12.75">   startDate: new Date(2011, 5, 28).valueOf() * 1000,</span>
<a href="#l12.76"></a><span id="l12.76">   isChat: true,</span>
<a href="#l12.77"></a><span id="l12.77"> };</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79"> var dummyTwitterConv = {</span>
<a href="#l12.80"></a><span id="l12.80">   account: dummyTwitterAccount,</span>
<a href="#l12.81"></a><span id="l12.81">   id: 2,</span>
<a href="#l12.82"></a><span id="l12.82">   title: &quot;Dummy Twitter Conv&quot;,</span>
<a href="#l12.83"></a><span id="l12.83">   normalizedName: &quot;dummytwitterconv&quot;,</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-  get name() { return this.normalizedName; },</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  get name() {</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+    return this.normalizedName;</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  },</span>
<a href="#l12.88"></a><span id="l12.88">   startDate: new Date(2011, 5, 28).valueOf() * 1000,</span>
<a href="#l12.89"></a><span id="l12.89">   isChat: true,</span>
<a href="#l12.90"></a><span id="l12.90"> };</span>
<a href="#l12.91"></a><span id="l12.91"> </span>
<a href="#l12.92"></a><span id="l12.92"> var encodeName_input = [</span>
<a href="#l12.93"></a><span id="l12.93">   &quot;CON&quot;,</span>
<a href="#l12.94"></a><span id="l12.94">   &quot;PRN&quot;,</span>
<a href="#l12.95"></a><span id="l12.95">   &quot;AUX&quot;,</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineat">@@ -80,39 +95,39 @@ var encodeName_input = [</span>
<a href="#l12.97"></a><span id="l12.97">   &quot;LPT5&quot;,</span>
<a href="#l12.98"></a><span id="l12.98">   &quot;file&quot;,</span>
<a href="#l12.99"></a><span id="l12.99">   &quot;file.&quot;,</span>
<a href="#l12.100"></a><span id="l12.100">   &quot;file &quot;,</span>
<a href="#l12.101"></a><span id="l12.101">   &quot;file_&quot;,</span>
<a href="#l12.102"></a><span id="l12.102">   &quot;file&lt;&quot;,</span>
<a href="#l12.103"></a><span id="l12.103">   &quot;file&gt;&quot;,</span>
<a href="#l12.104"></a><span id="l12.104">   &quot;file:&quot;,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-  &quot;file\&quot;&quot;,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  'file&quot;',</span>
<a href="#l12.107"></a><span id="l12.107">   &quot;file/&quot;,</span>
<a href="#l12.108"></a><span id="l12.108">   &quot;file\\&quot;,</span>
<a href="#l12.109"></a><span id="l12.109">   &quot;file|&quot;,</span>
<a href="#l12.110"></a><span id="l12.110">   &quot;file?&quot;,</span>
<a href="#l12.111"></a><span id="l12.111">   &quot;file*&quot;,</span>
<a href="#l12.112"></a><span id="l12.112">   &quot;file&amp;&quot;,</span>
<a href="#l12.113"></a><span id="l12.113">   &quot;file%&quot;,</span>
<a href="#l12.114"></a><span id="l12.114">   &quot;fi&lt;le&quot;,</span>
<a href="#l12.115"></a><span id="l12.115">   &quot;fi&gt;le&quot;,</span>
<a href="#l12.116"></a><span id="l12.116">   &quot;fi:le&quot;,</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  &quot;fi\&quot;le&quot;,</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  'fi&quot;le',</span>
<a href="#l12.119"></a><span id="l12.119">   &quot;fi/le&quot;,</span>
<a href="#l12.120"></a><span id="l12.120">   &quot;fi\\le&quot;,</span>
<a href="#l12.121"></a><span id="l12.121">   &quot;fi|le&quot;,</span>
<a href="#l12.122"></a><span id="l12.122">   &quot;fi?le&quot;,</span>
<a href="#l12.123"></a><span id="l12.123">   &quot;fi*le&quot;,</span>
<a href="#l12.124"></a><span id="l12.124">   &quot;fi&amp;le&quot;,</span>
<a href="#l12.125"></a><span id="l12.125">   &quot;fi%le&quot;,</span>
<a href="#l12.126"></a><span id="l12.126">   &quot;&lt;file&quot;,</span>
<a href="#l12.127"></a><span id="l12.127">   &quot;&gt;file&quot;,</span>
<a href="#l12.128"></a><span id="l12.128">   &quot;:file&quot;,</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-  &quot;\&quot;file&quot;,</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+  '&quot;file',</span>
<a href="#l12.131"></a><span id="l12.131">   &quot;/file&quot;,</span>
<a href="#l12.132"></a><span id="l12.132">   &quot;\\file&quot;,</span>
<a href="#l12.133"></a><span id="l12.133">   &quot;|file&quot;,</span>
<a href="#l12.134"></a><span id="l12.134">   &quot;?file&quot;,</span>
<a href="#l12.135"></a><span id="l12.135">   &quot;*file&quot;,</span>
<a href="#l12.136"></a><span id="l12.136">   &quot;&amp;file&quot;,</span>
<a href="#l12.137"></a><span id="l12.137">   &quot;%file&quot;,</span>
<a href="#l12.138"></a><span id="l12.138">   &quot;\\fi?*&amp;%le&lt;&gt;&quot;,</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineat">@@ -184,81 +199,107 @@ var test_queueFileOperation = async func</span>
<a href="#l12.140"></a><span id="l12.140">   equal(gFP.get(&quot;path2&quot;), p2);</span>
<a href="#l12.141"></a><span id="l12.141">   // This should throw since p2 rejected. Drop the error.</span>
<a href="#l12.142"></a><span id="l12.142">   await p2.then(() =&gt; do_throw(), () =&gt; {});</span>
<a href="#l12.143"></a><span id="l12.143">   ok(!gFP.has(&quot;path2&quot;));</span>
<a href="#l12.144"></a><span id="l12.144"> </span>
<a href="#l12.145"></a><span id="l12.145">   let onPromiseComplete = (aPromise, aHandler) =&gt; {</span>
<a href="#l12.146"></a><span id="l12.146">     return aPromise.then(aHandler, aHandler);</span>
<a href="#l12.147"></a><span id="l12.147">   };</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-  let test_queueOrder = (aOperation) =&gt; {</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+  let test_queueOrder = aOperation =&gt; {</span>
<a href="#l12.150"></a><span id="l12.150">     let promise = qFO(&quot;queueOrderPath&quot;, aOperation);</span>
<a href="#l12.151"></a><span id="l12.151">     let firstOperationComplete = false;</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-    onPromiseComplete(promise, () =&gt; firstOperationComplete = true);</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+    onPromiseComplete(promise, () =&gt; (firstOperationComplete = true));</span>
<a href="#l12.154"></a><span id="l12.154">     return qFO(&quot;queueOrderPath&quot;, () =&gt; {</span>
<a href="#l12.155"></a><span id="l12.155">       ok(firstOperationComplete);</span>
<a href="#l12.156"></a><span id="l12.156">     });</span>
<a href="#l12.157"></a><span id="l12.157">   };</span>
<a href="#l12.158"></a><span id="l12.158">   // Test the queue order for rejected and resolved promises.</span>
<a href="#l12.159"></a><span id="l12.159">   await test_queueOrder(dummyResolvedOperation);</span>
<a href="#l12.160"></a><span id="l12.160">   await test_queueOrder(dummyRejectedOperation);</span>
<a href="#l12.161"></a><span id="l12.161"> };</span>
<a href="#l12.162"></a><span id="l12.162"> </span>
<a href="#l12.163"></a><span id="l12.163"> var test_getLogFolderPathForAccount = async function() {</span>
<a href="#l12.164"></a><span id="l12.164">   let path = gLogger.getLogFolderPathForAccount(dummyAccount);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-  equal(OS.Path.join(logDirPath, dummyAccount.protocol.normalizedName,</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-                     gLogger.encodeName(dummyAccount.normalizedName)), path);</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+  equal(</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+    OS.Path.join(</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+      logDirPath,</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+      dummyAccount.protocol.normalizedName,</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+      gLogger.encodeName(dummyAccount.normalizedName)</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+    ),</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+    path</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+  );</span>
<a href="#l12.175"></a><span id="l12.175"> };</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177"> // Tests the global function getLogFilePathForConversation in logger.js.</span>
<a href="#l12.178"></a><span id="l12.178"> var test_getLogFilePathForConversation = async function() {</span>
<a href="#l12.179"></a><span id="l12.179">   let path = gLogger.getLogFilePathForConversation(dummyConv, &quot;format&quot;);</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-  let expectedPath = OS.Path.join(logDirPath, dummyAccount.protocol.normalizedName,</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-                                  gLogger.encodeName(dummyAccount.normalizedName));</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+  let expectedPath = OS.Path.join(</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+    logDirPath,</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+    dummyAccount.protocol.normalizedName,</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+    gLogger.encodeName(dummyAccount.normalizedName)</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  );</span>
<a href="#l12.187"></a><span id="l12.187">   expectedPath = OS.Path.join(</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineminus">-    expectedPath, gLogger.encodeName(dummyConv.normalizedName));</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+    expectedPath,</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+    gLogger.encodeName(dummyConv.normalizedName)</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+  );</span>
<a href="#l12.192"></a><span id="l12.192">   expectedPath = OS.Path.join(</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-    expectedPath, gLogger.getNewLogFileName(&quot;format&quot;, dummyConv.startDate / 1000));</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+    expectedPath,</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+    gLogger.getNewLogFileName(&quot;format&quot;, dummyConv.startDate / 1000)</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+  );</span>
<a href="#l12.197"></a><span id="l12.197">   equal(path, expectedPath);</span>
<a href="#l12.198"></a><span id="l12.198"> };</span>
<a href="#l12.199"></a><span id="l12.199"> </span>
<a href="#l12.200"></a><span id="l12.200"> var test_getLogFilePathForMUC = async function() {</span>
<a href="#l12.201"></a><span id="l12.201">   let path = gLogger.getLogFilePathForConversation(dummyMUC, &quot;format&quot;);</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-  let expectedPath = OS.Path.join(logDirPath, dummyAccount.protocol.normalizedName,</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-                                  gLogger.encodeName(dummyAccount.normalizedName));</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+  let expectedPath = OS.Path.join(</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+    logDirPath,</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+    dummyAccount.protocol.normalizedName,</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+    gLogger.encodeName(dummyAccount.normalizedName)</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+  );</span>
<a href="#l12.209"></a><span id="l12.209">   expectedPath = OS.Path.join(</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-    expectedPath, gLogger.encodeName(dummyMUC.normalizedName + &quot;.chat&quot;));</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+    expectedPath,</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+    gLogger.encodeName(dummyMUC.normalizedName + &quot;.chat&quot;)</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+  );</span>
<a href="#l12.214"></a><span id="l12.214">   expectedPath = OS.Path.join(</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-    expectedPath, gLogger.getNewLogFileName(&quot;format&quot;, dummyMUC.startDate / 1000));</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+    expectedPath,</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+    gLogger.getNewLogFileName(&quot;format&quot;, dummyMUC.startDate / 1000)</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+  );</span>
<a href="#l12.219"></a><span id="l12.219">   equal(path, expectedPath);</span>
<a href="#l12.220"></a><span id="l12.220"> };</span>
<a href="#l12.221"></a><span id="l12.221"> </span>
<a href="#l12.222"></a><span id="l12.222"> var test_getLogFilePathForTwitterConv = async function() {</span>
<a href="#l12.223"></a><span id="l12.223">   let path = gLogger.getLogFilePathForConversation(dummyTwitterConv, &quot;format&quot;);</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineminus">-  let expectedPath =</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-    OS.Path.join(logDirPath, dummyTwitterAccount.protocol.normalizedName,</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-                 gLogger.encodeName(dummyTwitterAccount.normalizedName));</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+  let expectedPath = OS.Path.join(</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+    logDirPath,</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+    dummyTwitterAccount.protocol.normalizedName,</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+    gLogger.encodeName(dummyTwitterAccount.normalizedName)</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+  );</span>
<a href="#l12.232"></a><span id="l12.232">   expectedPath = OS.Path.join(</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-    expectedPath, gLogger.encodeName(dummyTwitterConv.normalizedName));</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    expectedPath,</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+    gLogger.encodeName(dummyTwitterConv.normalizedName)</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+  );</span>
<a href="#l12.237"></a><span id="l12.237">   expectedPath = OS.Path.join(</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-    expectedPath, gLogger.getNewLogFileName(&quot;format&quot;,</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-                                            dummyTwitterConv.startDate / 1000));</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    expectedPath,</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+    gLogger.getNewLogFileName(&quot;format&quot;, dummyTwitterConv.startDate / 1000)</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+  );</span>
<a href="#l12.243"></a><span id="l12.243">   equal(path, expectedPath);</span>
<a href="#l12.244"></a><span id="l12.244"> };</span>
<a href="#l12.245"></a><span id="l12.245"> </span>
<a href="#l12.246"></a><span id="l12.246"> var test_appendToFile = async function() {</span>
<a href="#l12.247"></a><span id="l12.247">   const kStringToWrite = &quot;Hello, world!&quot;;</span>
<a href="#l12.248"></a><span id="l12.248">   let path = OS.Path.join(OS.Constants.Path.profileDir, &quot;testFile.txt&quot;);</span>
<a href="#l12.249"></a><span id="l12.249">   let encoder = new TextEncoder();</span>
<a href="#l12.250"></a><span id="l12.250">   let encodedString = encoder.encode(kStringToWrite);</span>
<a href="#l12.251"></a><span id="l12.251">   gLogger.appendToFile(path, encodedString);</span>
<a href="#l12.252"></a><span id="l12.252">   encodedString = encoder.encode(kStringToWrite);</span>
<a href="#l12.253"></a><span id="l12.253">   gLogger.appendToFile(path, encodedString);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-  let text = (new TextDecoder()).decode(</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-    await gLogger.queueFileOperation(path, () =&gt; OS.File.read(path)));</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+  let text = new TextDecoder().decode(</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+    await gLogger.queueFileOperation(path, () =&gt; OS.File.read(path))</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+  );</span>
<a href="#l12.259"></a><span id="l12.259">   // The read text should be equal to kStringToWrite repeated twice.</span>
<a href="#l12.260"></a><span id="l12.260">   equal(text, kStringToWrite + kStringToWrite);</span>
<a href="#l12.261"></a><span id="l12.261">   await OS.File.remove(path);</span>
<a href="#l12.262"></a><span id="l12.262"> };</span>
<a href="#l12.263"></a><span id="l12.263"> </span>
<a href="#l12.264"></a><span id="l12.264"> // Tests the getLogPathsForConversation API defined in the imILogger interface.</span>
<a href="#l12.265"></a><span id="l12.265"> var test_getLogPathsForConversation = async function() {</span>
<a href="#l12.266"></a><span id="l12.266">   let logger = new gLogger.Logger();</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineat">@@ -310,72 +351,82 @@ var test_logging = async function() {</span>
<a href="#l12.268"></a><span id="l12.268">       },</span>
<a href="#l12.269"></a><span id="l12.269">     ];</span>
<a href="#l12.270"></a><span id="l12.270">   };</span>
<a href="#l12.271"></a><span id="l12.271">   let firstDayMsgs = getMsgsForConv(dummyConv);</span>
<a href="#l12.272"></a><span id="l12.272">   let secondDayMsgs = getMsgsForConv(dummyConv2);</span>
<a href="#l12.273"></a><span id="l12.273"> </span>
<a href="#l12.274"></a><span id="l12.274">   let logMessagesForConv = async function(aConv, aMessages) {</span>
<a href="#l12.275"></a><span id="l12.275">     let logWriter = gLogger.getLogWriter(aConv);</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-    for (let message of aMessages)</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+    for (let message of aMessages) {</span>
<a href="#l12.278"></a><span id="l12.278">       logWriter.logMessage(message);</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+    }</span>
<a href="#l12.280"></a><span id="l12.280">     // If we don't wait for the messages to get written, we have no guarantee</span>
<a href="#l12.281"></a><span id="l12.281">     // later in the test that the log files were created, and getConversation</span>
<a href="#l12.282"></a><span id="l12.282">     // will return an EmptyEnumerator. Logging the messages is queued on the</span>
<a href="#l12.283"></a><span id="l12.283">     // _initialized promise, so we need to await on that first.</span>
<a href="#l12.284"></a><span id="l12.284">     await logWriter._initialized;</span>
<a href="#l12.285"></a><span id="l12.285">     await gLogger.gFilePromises.get(logWriter.currentPath);</span>
<a href="#l12.286"></a><span id="l12.286">     // Ensure two different files for the different dates.</span>
<a href="#l12.287"></a><span id="l12.287">     gLogger.closeLogWriter(aConv);</span>
<a href="#l12.288"></a><span id="l12.288">   };</span>
<a href="#l12.289"></a><span id="l12.289">   await logMessagesForConv(dummyConv, firstDayMsgs);</span>
<a href="#l12.290"></a><span id="l12.290">   await logMessagesForConv(dummyConv2, secondDayMsgs);</span>
<a href="#l12.291"></a><span id="l12.291"> </span>
<a href="#l12.292"></a><span id="l12.292">   // Write a zero-length file and a file with incorrect JSON for each day</span>
<a href="#l12.293"></a><span id="l12.293">   // to ensure they are handled correctly.</span>
<a href="#l12.294"></a><span id="l12.294">   let logDir = OS.Path.dirname(</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineminus">-    gLogger.getLogFilePathForConversation(dummyConv, &quot;json&quot;));</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+    gLogger.getLogFilePathForConversation(dummyConv, &quot;json&quot;)</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+  );</span>
<a href="#l12.298"></a><span id="l12.298">   let createBadFiles = async function(aConv) {</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineminus">-    let blankFile = OS.Path.join(logDir,</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-      gLogger.getNewLogFileName(&quot;json&quot;, (aConv.startDate + oneSec) / 1000));</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-    let invalidJSONFile = OS.Path.join(logDir,</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-      gLogger.getNewLogFileName(&quot;json&quot;, (aConv.startDate + (2 * oneSec)) / 1000));</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-    let file = await OS.File.open(blankFile, {truncate: true});</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+    let blankFile = OS.Path.join(</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+      logDir,</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+      gLogger.getNewLogFileName(&quot;json&quot;, (aConv.startDate + oneSec) / 1000)</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+    );</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+    let invalidJSONFile = OS.Path.join(</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+      logDir,</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+      gLogger.getNewLogFileName(&quot;json&quot;, (aConv.startDate + 2 * oneSec) / 1000)</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+    );</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+    let file = await OS.File.open(blankFile, { truncate: true });</span>
<a href="#l12.313"></a><span id="l12.313">     await file.close();</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-    await OS.File.writeAtomic(invalidJSONFile,</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineminus">-                              new TextEncoder().encode(&quot;This isn't JSON!&quot;));</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+    await OS.File.writeAtomic(</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+      invalidJSONFile,</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+      new TextEncoder().encode(&quot;This isn't JSON!&quot;)</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+    );</span>
<a href="#l12.320"></a><span id="l12.320">   };</span>
<a href="#l12.321"></a><span id="l12.321">   await createBadFiles(dummyConv);</span>
<a href="#l12.322"></a><span id="l12.322">   await createBadFiles(dummyConv2);</span>
<a href="#l12.323"></a><span id="l12.323"> </span>
<a href="#l12.324"></a><span id="l12.324">   let testMsgs = function(aMsgs, aExpectedMsgs, aExpectedSessions) {</span>
<a href="#l12.325"></a><span id="l12.325">     // Ensure the number of session messages is correct.</span>
<a href="#l12.326"></a><span id="l12.326">     let sessions = aMsgs.filter(aMsg =&gt; aMsg.who == &quot;sessionstart&quot;).length;</span>
<a href="#l12.327"></a><span id="l12.327">     equal(sessions, aExpectedSessions);</span>
<a href="#l12.328"></a><span id="l12.328"> </span>
<a href="#l12.329"></a><span id="l12.329">     // Discard session messages, etc.</span>
<a href="#l12.330"></a><span id="l12.330">     aMsgs = aMsgs.filter(aMsg =&gt; !aMsg.noLog);</span>
<a href="#l12.331"></a><span id="l12.331"> </span>
<a href="#l12.332"></a><span id="l12.332">     equal(aMsgs.length, aExpectedMsgs.length);</span>
<a href="#l12.333"></a><span id="l12.333"> </span>
<a href="#l12.334"></a><span id="l12.334">     for (let i = 0; i &lt; aMsgs.length; ++i) {</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-      let message = aMsgs[i], expectedMessage = aExpectedMsgs[i];</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+      let message = aMsgs[i],</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+        expectedMessage = aExpectedMsgs[i];</span>
<a href="#l12.338"></a><span id="l12.338">       for (let prop in expectedMessage) {</span>
<a href="#l12.339"></a><span id="l12.339">         ok(prop in message);</span>
<a href="#l12.340"></a><span id="l12.340">         equal(expectedMessage[prop], message[prop]);</span>
<a href="#l12.341"></a><span id="l12.341">       }</span>
<a href="#l12.342"></a><span id="l12.342">     }</span>
<a href="#l12.343"></a><span id="l12.343">   };</span>
<a href="#l12.344"></a><span id="l12.344"> </span>
<a href="#l12.345"></a><span id="l12.345">   let logs = await logger.getLogsForConversation(dummyConv);</span>
<a href="#l12.346"></a><span id="l12.346">   let allLogMsgs = [];</span>
<a href="#l12.347"></a><span id="l12.347">   while (logs.hasMoreElements()) {</span>
<a href="#l12.348"></a><span id="l12.348">     let conv = await logs.getNext().getConversation();</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineminus">-    if (!conv)</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+    if (!conv) {</span>
<a href="#l12.351"></a><span id="l12.351">       continue;</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+    }</span>
<a href="#l12.353"></a><span id="l12.353">     allLogMsgs = allLogMsgs.concat(conv.getMessages());</span>
<a href="#l12.354"></a><span id="l12.354">   }</span>
<a href="#l12.355"></a><span id="l12.355">   // Two session messages, one for each valid log file.</span>
<a href="#l12.356"></a><span id="l12.356">   testMsgs(allLogMsgs, firstDayMsgs.concat(secondDayMsgs), 2);</span>
<a href="#l12.357"></a><span id="l12.357"> </span>
<a href="#l12.358"></a><span id="l12.358">   // Accepts time in seconds, reduces it to a date, and returns the value in millis.</span>
<a href="#l12.359"></a><span id="l12.359">   let reduceTimeToDate = function(aTime) {</span>
<a href="#l12.360"></a><span id="l12.360">     let date = new Date(aTime * 1000);</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineat">@@ -403,25 +454,27 @@ var test_logging = async function() {</span>
<a href="#l12.362"></a><span id="l12.362">   await logger.forEach({</span>
<a href="#l12.363"></a><span id="l12.363">     async processLog(aLog) {</span>
<a href="#l12.364"></a><span id="l12.364">       let info = await OS.File.stat(aLog);</span>
<a href="#l12.365"></a><span id="l12.365">       ok(!info.isDir);</span>
<a href="#l12.366"></a><span id="l12.366">       ok(aLog.endsWith(&quot;.json&quot;));</span>
<a href="#l12.367"></a><span id="l12.367">       await OS.File.remove(aLog);</span>
<a href="#l12.368"></a><span id="l12.368">     },</span>
<a href="#l12.369"></a><span id="l12.369">   });</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineminus">-  let logFolder = OS.Path.dirname(gLogger.getLogFilePathForConversation(dummyConv));</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+  let logFolder = OS.Path.dirname(</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineplus">+    gLogger.getLogFilePathForConversation(dummyConv)</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+  );</span>
<a href="#l12.374"></a><span id="l12.374">   // The folder should now be empty - this will throw if it isn't.</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineminus">-  await OS.File.removeEmptyDir(logFolder, {ignoreAbsent: false});</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineplus">+  await OS.File.removeEmptyDir(logFolder, { ignoreAbsent: false });</span>
<a href="#l12.377"></a><span id="l12.377"> };</span>
<a href="#l12.378"></a><span id="l12.378"> </span>
<a href="#l12.379"></a><span id="l12.379"> var test_logFileSplitting = async function() {</span>
<a href="#l12.380"></a><span id="l12.380">   // Start clean, remove the log directory.</span>
<a href="#l12.381"></a><span id="l12.381">   let logFolderPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineminus">-  await OS.File.removeDir(logFolderPath, {ignoreAbsent: true});</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+  await OS.File.removeDir(logFolderPath, { ignoreAbsent: true });</span>
<a href="#l12.384"></a><span id="l12.384">   let logWriter = gLogger.getLogWriter(dummyConv);</span>
<a href="#l12.385"></a><span id="l12.385">   let startTime = logWriter._startTime / 1000; // Message times are in seconds.</span>
<a href="#l12.386"></a><span id="l12.386">   let oldPath = logWriter.currentPath;</span>
<a href="#l12.387"></a><span id="l12.387">   let message = {</span>
<a href="#l12.388"></a><span id="l12.388">     time: startTime,</span>
<a href="#l12.389"></a><span id="l12.389">     who: &quot;John Doe&quot;,</span>
<a href="#l12.390"></a><span id="l12.390">     originalMessage: &quot;Hello, world!&quot;,</span>
<a href="#l12.391"></a><span id="l12.391">     outgoing: true,</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineat">@@ -429,60 +482,68 @@ var test_logFileSplitting = async functi</span>
<a href="#l12.393"></a><span id="l12.393"> </span>
<a href="#l12.394"></a><span id="l12.394">   let logMessage = async function(aMessage) {</span>
<a href="#l12.395"></a><span id="l12.395">     logWriter.logMessage(aMessage);</span>
<a href="#l12.396"></a><span id="l12.396">     await logWriter._initialized;</span>
<a href="#l12.397"></a><span id="l12.397">     await gLogger.gFilePromises.get(logWriter.currentPath);</span>
<a href="#l12.398"></a><span id="l12.398">   };</span>
<a href="#l12.399"></a><span id="l12.399"> </span>
<a href="#l12.400"></a><span id="l12.400">   await logMessage(message);</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineminus">-  message.time += (logWriter.kInactivityLimit / 1000) + 1;</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+  message.time += logWriter.kInactivityLimit / 1000 + 1;</span>
<a href="#l12.403"></a><span id="l12.403">   // This should go in a new log file.</span>
<a href="#l12.404"></a><span id="l12.404">   await logMessage(message);</span>
<a href="#l12.405"></a><span id="l12.405">   notEqual(logWriter.currentPath, oldPath);</span>
<a href="#l12.406"></a><span id="l12.406">   // The log writer's new start time should be the time of the message.</span>
<a href="#l12.407"></a><span id="l12.407">   equal(message.time * 1000, logWriter._startTime);</span>
<a href="#l12.408"></a><span id="l12.408"> </span>
<a href="#l12.409"></a><span id="l12.409">   let getCurrentHeader = async function() {</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineminus">-    return JSON.parse(new TextDecoder()</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineminus">-                      .decode(await OS.File.read(logWriter.currentPath))</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineminus">-                      .split(&quot;\n&quot;)[0]);</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineplus">+    return JSON.parse(</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineplus">+      new TextDecoder()</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineplus">+        .decode(await OS.File.read(logWriter.currentPath))</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineplus">+        .split(&quot;\n&quot;)[0]</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineplus">+    );</span>
<a href="#l12.418"></a><span id="l12.418">   };</span>
<a href="#l12.419"></a><span id="l12.419"> </span>
<a href="#l12.420"></a><span id="l12.420">   // The header of the new log file should not have the continuedSession flag set.</span>
<a href="#l12.421"></a><span id="l12.421">   ok(!(await getCurrentHeader()).continuedSession);</span>
<a href="#l12.422"></a><span id="l12.422"> </span>
<a href="#l12.423"></a><span id="l12.423">   // Set the start time sufficiently before midnight, and the last message time</span>
<a href="#l12.424"></a><span id="l12.424">   // to just before midnight. A new log file should be created at midnight.</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineminus">-  logWriter._startTime = new Date(logWriter._startTime)</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineminus">-    .setHours(24, 0, 0, -(logWriter.kDayOverlapLimit + 1));</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineplus">+  logWriter._startTime = new Date(logWriter._startTime).setHours(</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineplus">+    24,</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineplus">+    0,</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineplus">+    0,</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineplus">+    -(logWriter.kDayOverlapLimit + 1)</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineplus">+  );</span>
<a href="#l12.433"></a><span id="l12.433">   let nearlyMidnight = new Date(logWriter._startTime).setHours(24, 0, 0, -1);</span>
<a href="#l12.434"></a><span id="l12.434">   oldPath = logWriter.currentPath;</span>
<a href="#l12.435"></a><span id="l12.435">   logWriter._lastMessageTime = nearlyMidnight;</span>
<a href="#l12.436"></a><span id="l12.436">   message.time = new Date(nearlyMidnight).setHours(24, 0, 0, 1) / 1000;</span>
<a href="#l12.437"></a><span id="l12.437">   await logMessage(message);</span>
<a href="#l12.438"></a><span id="l12.438">   // The message should have gone in a new file.</span>
<a href="#l12.439"></a><span id="l12.439">   notEqual(oldPath, logWriter.currentPath);</span>
<a href="#l12.440"></a><span id="l12.440">   // The header should have the continuedSession flag set this time.</span>
<a href="#l12.441"></a><span id="l12.441">   ok((await getCurrentHeader()).continuedSession);</span>
<a href="#l12.442"></a><span id="l12.442"> </span>
<a href="#l12.443"></a><span id="l12.443">   // Ensure a new file is created every kMessageCountLimit messages.</span>
<a href="#l12.444"></a><span id="l12.444">   oldPath = logWriter.currentPath;</span>
<a href="#l12.445"></a><span id="l12.445">   let messageCountLimit = logWriter.kMessageCountLimit;</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineminus">-  for (let i = 0; i &lt; messageCountLimit; ++i)</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+  for (let i = 0; i &lt; messageCountLimit; ++i) {</span>
<a href="#l12.448"></a><span id="l12.448">     logMessage(message);</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineplus">+  }</span>
<a href="#l12.450"></a><span id="l12.450">   await logMessage(message);</span>
<a href="#l12.451"></a><span id="l12.451">   notEqual(oldPath, logWriter.currentPath);</span>
<a href="#l12.452"></a><span id="l12.452">   // The header should have the continuedSession flag set this time too.</span>
<a href="#l12.453"></a><span id="l12.453">   ok((await getCurrentHeader()).continuedSession);</span>
<a href="#l12.454"></a><span id="l12.454">   // Again, to make sure it still works correctly after splitting it once already.</span>
<a href="#l12.455"></a><span id="l12.455">   oldPath = logWriter.currentPath;</span>
<a href="#l12.456"></a><span id="l12.456">   // We already logged one message to ensure it went into a new file, so i = 1.</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineminus">-  for (let i = 1; i &lt; messageCountLimit; ++i)</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+  for (let i = 1; i &lt; messageCountLimit; ++i) {</span>
<a href="#l12.459"></a><span id="l12.459">     logMessage(message);</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+  }</span>
<a href="#l12.461"></a><span id="l12.461">   await logMessage(message);</span>
<a href="#l12.462"></a><span id="l12.462">   notEqual(oldPath, logWriter.currentPath);</span>
<a href="#l12.463"></a><span id="l12.463">   ok((await getCurrentHeader()).continuedSession);</span>
<a href="#l12.464"></a><span id="l12.464"> </span>
<a href="#l12.465"></a><span id="l12.465">   // The new start time is the time of the message. If we log sufficiently more</span>
<a href="#l12.466"></a><span id="l12.466">   // messages with the same time property, ensure that the start time of the next</span>
<a href="#l12.467"></a><span id="l12.467">   // log file is greater than the previous one, and that a new path is being used.</span>
<a href="#l12.468"></a><span id="l12.468">   let oldStartTime = logWriter._startTime;</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineat">@@ -501,18 +562,19 @@ var test_logFileSplitting = async functi</span>
<a href="#l12.470"></a><span id="l12.470">   ok(logWriter._startTime &gt; oldStartTime);</span>
<a href="#l12.471"></a><span id="l12.471"> </span>
<a href="#l12.472"></a><span id="l12.472">   // Clean up.</span>
<a href="#l12.473"></a><span id="l12.473">   await OS.File.removeDir(logFolderPath);</span>
<a href="#l12.474"></a><span id="l12.474"> };</span>
<a href="#l12.475"></a><span id="l12.475"> </span>
<a href="#l12.476"></a><span id="l12.476"> function run_test() {</span>
<a href="#l12.477"></a><span id="l12.477">   // Test encodeName().</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineminus">-  for (let i = 0; i &lt; encodeName_input.length; ++i)</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineplus">+  for (let i = 0; i &lt; encodeName_input.length; ++i) {</span>
<a href="#l12.480"></a><span id="l12.480">     equal(gLogger.encodeName(encodeName_input[i]), encodeName_output[i]);</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineplus">+  }</span>
<a href="#l12.482"></a><span id="l12.482"> </span>
<a href="#l12.483"></a><span id="l12.483">   // Test convIsRealMUC().</span>
<a href="#l12.484"></a><span id="l12.484">   ok(!gLogger.convIsRealMUC(dummyConv));</span>
<a href="#l12.485"></a><span id="l12.485">   ok(!gLogger.convIsRealMUC(dummyTwitterConv));</span>
<a href="#l12.486"></a><span id="l12.486">   ok(gLogger.convIsRealMUC(dummyMUC));</span>
<a href="#l12.487"></a><span id="l12.487"> </span>
<a href="#l12.488"></a><span id="l12.488">   add_task(test_getLogFolderPathForAccount);</span>
<a href="#l12.489"></a><span id="l12.489"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/content/browserRequest.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/content/browserRequest.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,85 +1,95 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> var wpl = Ci.nsIWebProgressListener;</span>
<a href="#l13.12"></a><span id="l13.12"> </span>
<a href="#l13.13"></a><span id="l13.13"> var reporterListener = {</span>
<a href="#l13.14"></a><span id="l13.14">   _isBusy: false,</span>
<a href="#l13.15"></a><span id="l13.15">   get statusMeter() {</span>
<a href="#l13.16"></a><span id="l13.16">     delete this.statusMeter;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    return this.statusMeter = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+    return (this.statusMeter = document.getElementById(&quot;statusbar-icon&quot;));</span>
<a href="#l13.19"></a><span id="l13.19">   },</span>
<a href="#l13.20"></a><span id="l13.20">   get securityButton() {</span>
<a href="#l13.21"></a><span id="l13.21">     delete this.securityButton;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-    return this.securityButton = document.getElementById(&quot;security-button&quot;);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    return (this.securityButton = document.getElementById(&quot;security-button&quot;));</span>
<a href="#l13.24"></a><span id="l13.24">   },</span>
<a href="#l13.25"></a><span id="l13.25">   get securityLabel() {</span>
<a href="#l13.26"></a><span id="l13.26">     delete this.securityLabel;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    return this.securityLabel = document.getElementById(&quot;security-status&quot;);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+    return (this.securityLabel = document.getElementById(&quot;security-status&quot;));</span>
<a href="#l13.29"></a><span id="l13.29">   },</span>
<a href="#l13.30"></a><span id="l13.30">   get securityDisplay() {</span>
<a href="#l13.31"></a><span id="l13.31">     delete this.securityDisplay;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-    return this.securityDisplay = document.getElementById(&quot;security-display&quot;);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+    return (this.securityDisplay = document.getElementById(&quot;security-display&quot;));</span>
<a href="#l13.34"></a><span id="l13.34">   },</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-                                          &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+    &quot;nsIWebProgressListener&quot;,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+    &quot;nsISupportsWeakReference&quot;,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  ]),</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  onStateChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-                /* in nsIRequest */ aRequest,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-                /* in unsigned long */ aStateFlags,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-                /* in nsresult */ aStatus) {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-    if (aStateFlags &amp; wpl.STATE_START &amp;&amp;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-        aStateFlags &amp; wpl.STATE_IS_NETWORK) {</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  onStateChange(</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    /* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    /* in nsIRequest */ aRequest,</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    /* in unsigned long */ aStateFlags,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    /* in nsresult */ aStatus</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  ) {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    if (aStateFlags &amp; wpl.STATE_START &amp;&amp; aStateFlags &amp; wpl.STATE_IS_NETWORK) {</span>
<a href="#l13.56"></a><span id="l13.56">       this.statusMeter.value = 0;</span>
<a href="#l13.57"></a><span id="l13.57">       this.statusMeter.parentNode.collapsed = false;</span>
<a href="#l13.58"></a><span id="l13.58">       this.securityLabel.collapsed = true;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    }</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    else if (aStateFlags &amp; wpl.STATE_STOP &amp;&amp;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-             aStateFlags &amp; wpl.STATE_IS_NETWORK) {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    } else if (</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+      aStateFlags &amp; wpl.STATE_STOP &amp;&amp;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+      aStateFlags &amp; wpl.STATE_IS_NETWORK</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+    ) {</span>
<a href="#l13.66"></a><span id="l13.66">       this.statusMeter.parentNode.collapsed = true;</span>
<a href="#l13.67"></a><span id="l13.67">       this.securityLabel.collapsed = false;</span>
<a href="#l13.68"></a><span id="l13.68">     }</span>
<a href="#l13.69"></a><span id="l13.69">   },</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  onProgressChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-                   /* in nsIRequest */ aRequest,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-                   /* in long */ aCurSelfProgress,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-                   /* in long */ aMaxSelfProgress,</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-                   /* in long */ aCurTotalProgress,</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-                   /* in long */ aMaxTotalProgress) {</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+  onProgressChange(</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+    /* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    /* in nsIRequest */ aRequest,</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+    /* in long */ aCurSelfProgress,</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+    /* in long */ aMaxSelfProgress,</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    /* in long */ aCurTotalProgress,</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+    /* in long */ aMaxTotalProgress</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  ) {</span>
<a href="#l13.85"></a><span id="l13.85">     if (aMaxTotalProgress &gt; 0) {</span>
<a href="#l13.86"></a><span id="l13.86">       let percentage = (aCurTotalProgress * 100) / aMaxTotalProgress;</span>
<a href="#l13.87"></a><span id="l13.87">       this.statusMeter.value = percentage;</span>
<a href="#l13.88"></a><span id="l13.88">     }</span>
<a href="#l13.89"></a><span id="l13.89">   },</span>
<a href="#l13.90"></a><span id="l13.90"> </span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-  onLocationChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-                   /* in nsIRequest */ aRequest,</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-                   /* in nsIURI */ aLocation) {</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+  onLocationChange(</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+    /* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+    /* in nsIRequest */ aRequest,</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+    /* in nsIURI */ aLocation</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+  ) {</span>
<a href="#l13.99"></a><span id="l13.99">     this.securityDisplay.setAttribute(&quot;value&quot;, aLocation.host);</span>
<a href="#l13.100"></a><span id="l13.100">   },</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-  onStatusChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-                 /* in nsIRequest */ aRequest,</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-                 /* in nsresult */ aStatus,</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-                 /* in wstring */ aMessage) {</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-  },</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+  onStatusChange(</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+    /* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+    /* in nsIRequest */ aRequest,</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    /* in nsresult */ aStatus,</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+    /* in wstring */ aMessage</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  ) {},</span>
<a href="#l13.113"></a><span id="l13.113"> </span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-  onSecurityChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-                   /* in nsIRequest */ aRequest,</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-                   /* in unsigned long */ aState) {</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-    const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-                              wpl.STATE_IS_BROKEN |</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-                              wpl.STATE_IS_INSECURE;</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+  onSecurityChange(</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    /* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+    /* in nsIRequest */ aRequest,</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+    /* in unsigned long */ aState</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+  ) {</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+    const wpl_security_bits =</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+      wpl.STATE_IS_SECURE | wpl.STATE_IS_BROKEN | wpl.STATE_IS_INSECURE;</span>
<a href="#l13.127"></a><span id="l13.127">     let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l13.128"></a><span id="l13.128">     let level;</span>
<a href="#l13.129"></a><span id="l13.129"> </span>
<a href="#l13.130"></a><span id="l13.130">     switch (aState &amp; wpl_security_bits) {</span>
<a href="#l13.131"></a><span id="l13.131">       case wpl.STATE_IS_SECURE:</span>
<a href="#l13.132"></a><span id="l13.132">         level = &quot;high&quot;;</span>
<a href="#l13.133"></a><span id="l13.133">         break;</span>
<a href="#l13.134"></a><span id="l13.134">       case wpl.STATE_IS_BROKEN:</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineat">@@ -89,55 +99,56 @@ var reporterListener = {</span>
<a href="#l13.136"></a><span id="l13.136">     if (level) {</span>
<a href="#l13.137"></a><span id="l13.137">       this.securityButton.setAttribute(&quot;level&quot;, level);</span>
<a href="#l13.138"></a><span id="l13.138">       this.securityButton.hidden = false;</span>
<a href="#l13.139"></a><span id="l13.139">       this.securityLabel.setAttribute(&quot;value&quot;, browser.securityUI.tooltipText);</span>
<a href="#l13.140"></a><span id="l13.140">     } else {</span>
<a href="#l13.141"></a><span id="l13.141">       this.securityButton.hidden = true;</span>
<a href="#l13.142"></a><span id="l13.142">       this.securityButton.removeAttribute(&quot;level&quot;);</span>
<a href="#l13.143"></a><span id="l13.143">     }</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-    this.securityButton.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-                                     browser.securityUI.tooltipText);</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+    this.securityButton.setAttribute(</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+      &quot;tooltiptext&quot;,</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+      browser.securityUI.tooltipText</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+    );</span>
<a href="#l13.150"></a><span id="l13.150">   },</span>
<a href="#l13.151"></a><span id="l13.151"> </span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-  onContentBlockingEvent(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-                         /* in nsIRequest */ aRequest,</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-                         /* in unsigned long */ aEvent) {</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-  },</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+  onContentBlockingEvent(</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+    /* in nsIWebProgress */ aWebProgress,</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+    /* in nsIRequest */ aRequest,</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    /* in unsigned long */ aEvent</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+  ) {},</span>
<a href="#l13.161"></a><span id="l13.161"> };</span>
<a href="#l13.162"></a><span id="l13.162"> </span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-function cancelRequest()</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-{</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+function cancelRequest() {</span>
<a href="#l13.166"></a><span id="l13.166">   reportUserClosed();</span>
<a href="#l13.167"></a><span id="l13.167">   window.close();</span>
<a href="#l13.168"></a><span id="l13.168"> }</span>
<a href="#l13.169"></a><span id="l13.169"> </span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-function reportUserClosed()</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-{</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+function reportUserClosed() {</span>
<a href="#l13.173"></a><span id="l13.173">   let request = window.arguments[0];</span>
<a href="#l13.174"></a><span id="l13.174">   request.QueryInterface(Ci.prplIRequestBrowser);</span>
<a href="#l13.175"></a><span id="l13.175">   request.cancelled();</span>
<a href="#l13.176"></a><span id="l13.176"> }</span>
<a href="#l13.177"></a><span id="l13.177"> </span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-function loadRequestedUrl()</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-{</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+function loadRequestedUrl() {</span>
<a href="#l13.181"></a><span id="l13.181">   let request = window.arguments[0];</span>
<a href="#l13.182"></a><span id="l13.182">   request.QueryInterface(Ci.prplIRequestBrowser);</span>
<a href="#l13.183"></a><span id="l13.183">   document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l13.184"></a><span id="l13.184">   let account = request.account;</span>
<a href="#l13.185"></a><span id="l13.185">   document.getElementById(&quot;headerLabel&quot;).value =</span>
<a href="#l13.186"></a><span id="l13.186">     account.protocol.name + &quot; - &quot; + account.name;</span>
<a href="#l13.187"></a><span id="l13.187">   document.getElementById(&quot;headerImage&quot;).src =</span>
<a href="#l13.188"></a><span id="l13.188">     account.protocol.iconBaseURI + &quot;icon48.png&quot;;</span>
<a href="#l13.189"></a><span id="l13.189"> </span>
<a href="#l13.190"></a><span id="l13.190">   let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l13.191"></a><span id="l13.191">   browser.docShell.allowPlugins = false;</span>
<a href="#l13.192"></a><span id="l13.192"> </span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-  if (Services.prefs.getBoolPref(&quot;chat.browserRequest.disableJavascript&quot;))</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+  if (Services.prefs.getBoolPref(&quot;chat.browserRequest.disableJavascript&quot;)) {</span>
<a href="#l13.195"></a><span id="l13.195">     browser.docShell.allowJavascript = false;</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+  }</span>
<a href="#l13.197"></a><span id="l13.197"> </span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-  browser.addProgressListener(reporterListener,</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-                              Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+  browser.addProgressListener(reporterListener, Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l13.201"></a><span id="l13.201">   let url = request.url;</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-  if (url != &quot;&quot;)</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+  if (url != &quot;&quot;) {</span>
<a href="#l13.204"></a><span id="l13.204">     browser.setAttribute(&quot;src&quot;, url);</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+  }</span>
<a href="#l13.206"></a><span id="l13.206">   request.loaded(window, browser.webProgress);</span>
<a href="#l13.207"></a><span id="l13.207"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/content/chat-account-richlistitem.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/content/chat-account-richlistitem.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,58 +1,64 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> &quot;use strict&quot;;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12"> /* global MozElements, MozXULElement, gAccountManager */</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14"> // Wrap in a block to prevent leaking to window scope.</span>
<a href="#l14.15"></a><span id="l14.15"> {</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-  const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-  const { DownloadUtils } = ChromeUtils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  const { Services } = ChromeUtils.import(</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+    &quot;resource://gre/modules/Services.jsm&quot;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+  );</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+  const { DownloadUtils } = ChromeUtils.import(</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+    &quot;resource://gre/modules/DownloadUtils.jsm&quot;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+  );</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">   /**</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-  * The MozChatAccountRichlistitem widget displays the information about the</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-  * configured account: i.e. icon, state, name, error, checkbox for</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  * auto sign in and buttons for disconnect and properties.</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-  *</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  * @extends {MozElements.MozRichlistitem}</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  */</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+   * The MozChatAccountRichlistitem widget displays the information about the</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+   * configured account: i.e. icon, state, name, error, checkbox for</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+   * auto sign in and buttons for disconnect and properties.</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+   *</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+   * @extends {MozElements.MozRichlistitem}</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+   */</span>
<a href="#l14.38"></a><span id="l14.38">   class MozChatAccountRichlistitem extends MozElements.MozRichlistitem {</span>
<a href="#l14.39"></a><span id="l14.39">     static get inheritedAttributes() {</span>
<a href="#l14.40"></a><span id="l14.40">       return {</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-        &quot;stack&quot;: &quot;tooltiptext=protocol&quot;,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+        stack: &quot;tooltiptext=protocol&quot;,</span>
<a href="#l14.43"></a><span id="l14.43">         &quot;.accountIcon&quot;: &quot;src=prplicon&quot;,</span>
<a href="#l14.44"></a><span id="l14.44">         &quot;.accountName&quot;: &quot;value=name&quot;,</span>
<a href="#l14.45"></a><span id="l14.45">         &quot;.autoSignOn&quot;: &quot;checked=autologin&quot;,</span>
<a href="#l14.46"></a><span id="l14.46">         &quot;.account-buttons&quot;: &quot;autologin,name&quot;,</span>
<a href="#l14.47"></a><span id="l14.47">       };</span>
<a href="#l14.48"></a><span id="l14.48">     }</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">     connectedCallback() {</span>
<a href="#l14.51"></a><span id="l14.51">       if (this.delayConnectedCallback() || this.hasChildNodes()) {</span>
<a href="#l14.52"></a><span id="l14.52">         return;</span>
<a href="#l14.53"></a><span id="l14.53">       }</span>
<a href="#l14.54"></a><span id="l14.54"> </span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-      this.addEventListener(&quot;dblclick&quot;, (event) =&gt; {</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+      this.addEventListener(&quot;dblclick&quot;, event =&gt; {</span>
<a href="#l14.57"></a><span id="l14.57">         if (event.button == 0) {</span>
<a href="#l14.58"></a><span id="l14.58">           // If we double clicked on a widget that has already done</span>
<a href="#l14.59"></a><span id="l14.59">           // something with the first click, we should ignore the event</span>
<a href="#l14.60"></a><span id="l14.60">           let localName = event.originalTarget.localName;</span>
<a href="#l14.61"></a><span id="l14.61">           if (localName != &quot;button&quot; &amp;&amp; localName != &quot;checkbox&quot;) {</span>
<a href="#l14.62"></a><span id="l14.62">             this.buttons.proceedDefaultAction();</span>
<a href="#l14.63"></a><span id="l14.63">           }</span>
<a href="#l14.64"></a><span id="l14.64">         }</span>
<a href="#l14.65"></a><span id="l14.65">         // Prevent from loading an account wizzard</span>
<a href="#l14.66"></a><span id="l14.66">         event.stopPropagation();</span>
<a href="#l14.67"></a><span id="l14.67">       });</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-      this.appendChild(MozXULElement.parseXULToFragment(`</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+      this.appendChild(</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+        MozXULElement.parseXULToFragment(</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+          `</span>
<a href="#l14.73"></a><span id="l14.73">         &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l14.74"></a><span id="l14.74">           &lt;hbox flex=&quot;1&quot; align=&quot;top&quot;&gt;</span>
<a href="#l14.75"></a><span id="l14.75">             &lt;vbox&gt;</span>
<a href="#l14.76"></a><span id="l14.76">               &lt;stack&gt;</span>
<a href="#l14.77"></a><span id="l14.77">                 &lt;image class=&quot;accountIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l14.78"></a><span id="l14.78">                 &lt;image class=&quot;accountStateIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l14.79"></a><span id="l14.79">               &lt;/stack&gt;</span>
<a href="#l14.80"></a><span id="l14.80">               &lt;spacer flex=&quot;1&quot;&gt;&lt;/spacer&gt;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineat">@@ -74,17 +80,20 @@</span>
<a href="#l14.82"></a><span id="l14.82">           &lt;/hbox&gt;</span>
<a href="#l14.83"></a><span id="l14.83">           &lt;hbox flex=&quot;1&quot; class=&quot;account-buttons&quot;&gt;</span>
<a href="#l14.84"></a><span id="l14.84">             &lt;button class=&quot;disconnectButton&quot; command=&quot;cmd_disconnect&quot;&gt;&lt;/button&gt;</span>
<a href="#l14.85"></a><span id="l14.85">             &lt;button class=&quot;connectButton&quot; command=&quot;cmd_connect&quot;&gt;&lt;/button&gt;</span>
<a href="#l14.86"></a><span id="l14.86">             &lt;spacer flex=&quot;1&quot;&gt;&lt;/spacer&gt;</span>
<a href="#l14.87"></a><span id="l14.87">             &lt;button command=&quot;cmd_edit&quot;&gt;&lt;/button&gt;</span>
<a href="#l14.88"></a><span id="l14.88">           &lt;/hbox&gt;</span>
<a href="#l14.89"></a><span id="l14.89">         &lt;/vbox&gt;</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-    `, [&quot;chrome://chat/locale/accounts.dtd&quot;]));</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+    `,</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+          [&quot;chrome://chat/locale/accounts.dtd&quot;]</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+        )</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+      );</span>
<a href="#l14.95"></a><span id="l14.95">       this.initializeAttributeInheritance();</span>
<a href="#l14.96"></a><span id="l14.96">     }</span>
<a href="#l14.97"></a><span id="l14.97"> </span>
<a href="#l14.98"></a><span id="l14.98">     set autoLogin(val) {</span>
<a href="#l14.99"></a><span id="l14.99">       if (val) {</span>
<a href="#l14.100"></a><span id="l14.100">         this.setAttribute(&quot;autologin&quot;, &quot;true&quot;);</span>
<a href="#l14.101"></a><span id="l14.101">       } else {</span>
<a href="#l14.102"></a><span id="l14.102">         this.removeAttribute(&quot;autologin&quot;);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineat">@@ -149,94 +158,119 @@</span>
<a href="#l14.104"></a><span id="l14.104">       } else if (this._account.disconnecting) {</span>
<a href="#l14.105"></a><span id="l14.105">         state = &quot;connected&quot;;</span>
<a href="#l14.106"></a><span id="l14.106">       }</span>
<a href="#l14.107"></a><span id="l14.107">       this.setAttribute(&quot;state&quot;, state);</span>
<a href="#l14.108"></a><span id="l14.108">       this.autoLogin = aAccount.autoLogin;</span>
<a href="#l14.109"></a><span id="l14.109">     }</span>
<a href="#l14.110"></a><span id="l14.110"> </span>
<a href="#l14.111"></a><span id="l14.111">     updateConnectionState() {</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-      let bundle = Services.strings.createBundle(&quot;chrome://messenger/locale/imAccounts.properties&quot;);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+      let bundle = Services.strings.createBundle(</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+        &quot;chrome://messenger/locale/imAccounts.properties&quot;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+      );</span>
<a href="#l14.116"></a><span id="l14.116">       const key = &quot;account.connection.progress&quot;;</span>
<a href="#l14.117"></a><span id="l14.117">       let text = this._account.connectionStateMsg;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-      text = text ? bundle.formatStringFromName(key, [text]) :</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-        bundle.GetStringFromName(&quot;account.connecting&quot;);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+      text = text</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+        ? bundle.formatStringFromName(key, [text])</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+        : bundle.GetStringFromName(&quot;account.connecting&quot;);</span>
<a href="#l14.123"></a><span id="l14.123"> </span>
<a href="#l14.124"></a><span id="l14.124">       let progress = this.querySelector(&quot;.connecting&quot;);</span>
<a href="#l14.125"></a><span id="l14.125">       progress.setAttribute(&quot;value&quot;, text);</span>
<a href="#l14.126"></a><span id="l14.126">       if (this.reconnectUpdateInterval) {</span>
<a href="#l14.127"></a><span id="l14.127">         this._cancelReconnectTimer();</span>
<a href="#l14.128"></a><span id="l14.128">       }</span>
<a href="#l14.129"></a><span id="l14.129"> </span>
<a href="#l14.130"></a><span id="l14.130">       this.removeAttribute(&quot;certError&quot;);</span>
<a href="#l14.131"></a><span id="l14.131">     }</span>
<a href="#l14.132"></a><span id="l14.132"> </span>
<a href="#l14.133"></a><span id="l14.133">     updateConnectionError() {</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-      let bundle = Services.strings.createBundle(&quot;chrome://messenger/locale/imAccounts.properties&quot;);</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+      let bundle = Services.strings.createBundle(</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+        &quot;chrome://messenger/locale/imAccounts.properties&quot;</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+      );</span>
<a href="#l14.138"></a><span id="l14.138">       const key = &quot;account.connection.error&quot;;</span>
<a href="#l14.139"></a><span id="l14.139">       let account = this._account;</span>
<a href="#l14.140"></a><span id="l14.140">       let text;</span>
<a href="#l14.141"></a><span id="l14.141">       let errorReason = account.connectionErrorReason;</span>
<a href="#l14.142"></a><span id="l14.142">       if (errorReason == Ci.imIAccount.ERROR_UNKNOWN_PRPL) {</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-        text = bundle.formatStringFromName(key + &quot;UnknownPrpl&quot;, [account.protocol.id]);</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+        text = bundle.formatStringFromName(key + &quot;UnknownPrpl&quot;, [</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+          account.protocol.id,</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+        ]);</span>
<a href="#l14.147"></a><span id="l14.147">       } else if (errorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD) {</span>
<a href="#l14.148"></a><span id="l14.148">         text = bundle.GetStringFromName(key + &quot;EnteringPasswordRequired&quot;);</span>
<a href="#l14.149"></a><span id="l14.149">       } else if (errorReason == Ci.imIAccount.ERROR_CRASHED) {</span>
<a href="#l14.150"></a><span id="l14.150">         text = bundle.GetStringFromName(key + &quot;CrashedAccount&quot;);</span>
<a href="#l14.151"></a><span id="l14.151">       } else {</span>
<a href="#l14.152"></a><span id="l14.152">         text = account.connectionErrorMessage;</span>
<a href="#l14.153"></a><span id="l14.153">       }</span>
<a href="#l14.154"></a><span id="l14.154"> </span>
<a href="#l14.155"></a><span id="l14.155">       if (errorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD) {</span>
<a href="#l14.156"></a><span id="l14.156">         text = bundle.formatStringFromName(key, [text]);</span>
<a href="#l14.157"></a><span id="l14.157">       }</span>
<a href="#l14.158"></a><span id="l14.158"> </span>
<a href="#l14.159"></a><span id="l14.159">       this.setAttribute(&quot;error&quot;, &quot;true&quot;);</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-      if ((Ci.imIAccount.ERROR_CERT_NOT_PROVIDED &lt;= errorReason &amp;&amp;</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-        errorReason &lt;= Ci.imIAccount.ERROR_CERT_OTHER_ERROR) &amp;&amp;</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-        account.prplAccount.connectionTarget) {</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+      if (</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+        Ci.imIAccount.ERROR_CERT_NOT_PROVIDED &lt;= errorReason &amp;&amp;</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+        errorReason &lt;= Ci.imIAccount.ERROR_CERT_OTHER_ERROR &amp;&amp;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+        account.prplAccount.connectionTarget</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+      ) {</span>
<a href="#l14.168"></a><span id="l14.168">         this.setAttribute(&quot;certError&quot;, &quot;true&quot;);</span>
<a href="#l14.169"></a><span id="l14.169">       }</span>
<a href="#l14.170"></a><span id="l14.170">       let error = this.querySelector(&quot;.error-description&quot;);</span>
<a href="#l14.171"></a><span id="l14.171">       error.textContent = text;</span>
<a href="#l14.172"></a><span id="l14.172"> </span>
<a href="#l14.173"></a><span id="l14.173">       let updateReconnect = () =&gt; {</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-        let date = Math.round((account.timeOfNextReconnect - Date.now()) / 1000);</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+        let date = Math.round(</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+          (account.timeOfNextReconnect - Date.now()) / 1000</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+        );</span>
<a href="#l14.178"></a><span id="l14.178">         let reconnect = &quot;&quot;;</span>
<a href="#l14.179"></a><span id="l14.179">         if (date &gt; 0) {</span>
<a href="#l14.180"></a><span id="l14.180">           let [val1, unit1, val2, unit2] = DownloadUtils.convertTimeUnits(date);</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-          if (!val2)</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-            reconnect = bundle.formatStringFromName(&quot;account.reconnectInSingle&quot;,</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-              [val1, unit1]);</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-          else</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineminus">-            reconnect = bundle.formatStringFromName(&quot;account.reconnectInDouble&quot;,</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-              [val1, unit1, val2, unit2]);</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+          if (!val2) {</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+            reconnect = bundle.formatStringFromName(</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+              &quot;account.reconnectInSingle&quot;,</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+              [val1, unit1]</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+            );</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+          } else {</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+            reconnect = bundle.formatStringFromName(</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+              &quot;account.reconnectInDouble&quot;,</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+              [val1, unit1, val2, unit2]</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+            );</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+          }</span>
<a href="#l14.198"></a><span id="l14.198">         }</span>
<a href="#l14.199"></a><span id="l14.199">         this.querySelector(&quot;.error-reconnect&quot;).textContent = reconnect;</span>
<a href="#l14.200"></a><span id="l14.200">         return reconnect;</span>
<a href="#l14.201"></a><span id="l14.201">       };</span>
<a href="#l14.202"></a><span id="l14.202">       if (updateReconnect() &amp;&amp; !this.reconnectUpdateInterval) {</span>
<a href="#l14.203"></a><span id="l14.203">         this.setAttribute(&quot;reconnectPending&quot;, &quot;true&quot;);</span>
<a href="#l14.204"></a><span id="l14.204">         this.reconnectUpdateInterval = setInterval(updateReconnect, 1000);</span>
<a href="#l14.205"></a><span id="l14.205">         gAccountManager.disableCommandItems();</span>
<a href="#l14.206"></a><span id="l14.206">       }</span>
<a href="#l14.207"></a><span id="l14.207">     }</span>
<a href="#l14.208"></a><span id="l14.208"> </span>
<a href="#l14.209"></a><span id="l14.209">     refreshConnectedLabel() {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-      let bundle = Services.strings.createBundle(&quot;chrome://messenger/locale/imAccounts.properties&quot;);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-      let date = 60 * Math.floor((Date.now() - this._account.timeOfLastConnect) / 60000);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+      let bundle = Services.strings.createBundle(</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+        &quot;chrome://messenger/locale/imAccounts.properties&quot;</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+      );</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+      let date =</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+        60 * Math.floor((Date.now() - this._account.timeOfLastConnect) / 60000);</span>
<a href="#l14.217"></a><span id="l14.217">       let value;</span>
<a href="#l14.218"></a><span id="l14.218">       if (date &gt; 0) {</span>
<a href="#l14.219"></a><span id="l14.219">         let [val1, unit1, val2, unit2] = DownloadUtils.convertTimeUnits(date);</span>
<a href="#l14.220"></a><span id="l14.220">         if (!val2) {</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-          value = bundle.formatStringFromName(&quot;account.connectedForSingle&quot;,</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-            [val1, unit1]);</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+          value = bundle.formatStringFromName(&quot;account.connectedForSingle&quot;, [</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+            val1,</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+            unit1,</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+          ]);</span>
<a href="#l14.227"></a><span id="l14.227">         } else {</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-          value = bundle.formatStringFromName(&quot;account.connectedForDouble&quot;,</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-            [val1, unit1, val2, unit2]);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+          value = bundle.formatStringFromName(&quot;account.connectedForDouble&quot;, [</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+            val1,</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+            unit1,</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+            val2,</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+            unit2,</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+          ]);</span>
<a href="#l14.236"></a><span id="l14.236">         }</span>
<a href="#l14.237"></a><span id="l14.237">       } else {</span>
<a href="#l14.238"></a><span id="l14.238">         value = bundle.GetStringFromName(&quot;account.connectedForSeconds&quot;);</span>
<a href="#l14.239"></a><span id="l14.239">       }</span>
<a href="#l14.240"></a><span id="l14.240">       this.connectedLabel.value = value;</span>
<a href="#l14.241"></a><span id="l14.241">     }</span>
<a href="#l14.242"></a><span id="l14.242"> </span>
<a href="#l14.243"></a><span id="l14.243">     _cancelReconnectTimer() {</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineat">@@ -256,45 +290,56 @@</span>
<a href="#l14.245"></a><span id="l14.245">     restoreItems() {</span>
<a href="#l14.246"></a><span id="l14.246">       // Called after a removal and reinsertion of the binding</span>
<a href="#l14.247"></a><span id="l14.247">       this._buttons = null;</span>
<a href="#l14.248"></a><span id="l14.248">       this._connectedLabel = null;</span>
<a href="#l14.249"></a><span id="l14.249">       if (this._account.connected) {</span>
<a href="#l14.250"></a><span id="l14.250">         this.refreshConnectedLabel();</span>
<a href="#l14.251"></a><span id="l14.251">       } else if (this._account.connecting) {</span>
<a href="#l14.252"></a><span id="l14.252">         this.updateConnectionState();</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-      } else if (this._account.connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+      } else if (</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+        this._account.connectionErrorReason != Ci.prplIAccount.NO_ERROR</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+      ) {</span>
<a href="#l14.257"></a><span id="l14.257">         this.updateConnectionError();</span>
<a href="#l14.258"></a><span id="l14.258">       }</span>
<a href="#l14.259"></a><span id="l14.259">     }</span>
<a href="#l14.260"></a><span id="l14.260"> </span>
<a href="#l14.261"></a><span id="l14.261">     destroy() {</span>
<a href="#l14.262"></a><span id="l14.262">       // If we have a reconnect timer, stop it:</span>
<a href="#l14.263"></a><span id="l14.263">       // it will throw errors otherwise (see bug 480).</span>
<a href="#l14.264"></a><span id="l14.264">       if (!this.reconnectUpdateInterval) {</span>
<a href="#l14.265"></a><span id="l14.265">         return;</span>
<a href="#l14.266"></a><span id="l14.266">       }</span>
<a href="#l14.267"></a><span id="l14.267">       clearInterval(this.reconnectUpdateInterval);</span>
<a href="#l14.268"></a><span id="l14.268">       delete this.reconnectUpdateInterval;</span>
<a href="#l14.269"></a><span id="l14.269">     }</span>
<a href="#l14.270"></a><span id="l14.270"> </span>
<a href="#l14.271"></a><span id="l14.271">     get activeButton() {</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-      let action = this.account.disconnected ? &quot;.connectButton&quot; : &quot;.disconnectButton&quot;;</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+      let action = this.account.disconnected</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+        ? &quot;.connectButton&quot;</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+        : &quot;.disconnectButton&quot;;</span>
<a href="#l14.276"></a><span id="l14.276">       return this.querySelector(action);</span>
<a href="#l14.277"></a><span id="l14.277">     }</span>
<a href="#l14.278"></a><span id="l14.278"> </span>
<a href="#l14.279"></a><span id="l14.279">     setFocus() {</span>
<a href="#l14.280"></a><span id="l14.280">       let focusTarget = this.activeButton;</span>
<a href="#l14.281"></a><span id="l14.281">       let accountName = this.getAttribute(&quot;name&quot;);</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-      focusTarget.setAttribute(&quot;aria-label&quot;, focusTarget.label + &quot; &quot; + accountName);</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+      focusTarget.setAttribute(</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+        &quot;aria-label&quot;,</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+        focusTarget.label + &quot; &quot; + accountName</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+      );</span>
<a href="#l14.287"></a><span id="l14.287">       if (focusTarget.disabled) {</span>
<a href="#l14.288"></a><span id="l14.288">         focusTarget = document.getElementById(&quot;accountlist&quot;);</span>
<a href="#l14.289"></a><span id="l14.289">       }</span>
<a href="#l14.290"></a><span id="l14.290">       focusTarget.focus();</span>
<a href="#l14.291"></a><span id="l14.291">     }</span>
<a href="#l14.292"></a><span id="l14.292"> </span>
<a href="#l14.293"></a><span id="l14.293">     proceedDefaultAction() {</span>
<a href="#l14.294"></a><span id="l14.294">       this.activeButton.click();</span>
<a href="#l14.295"></a><span id="l14.295">     }</span>
<a href="#l14.296"></a><span id="l14.296">   }</span>
<a href="#l14.297"></a><span id="l14.297"> </span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-  customElements.define(&quot;chat-account-richlistitem&quot;, MozChatAccountRichlistitem, { extends: &quot;richlistitem&quot; });</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+  customElements.define(</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+    &quot;chat-account-richlistitem&quot;,</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+    MozChatAccountRichlistitem,</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+    { extends: &quot;richlistitem&quot; }</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+  );</span>
<a href="#l14.304"></a><span id="l14.304"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/content/chat-tooltip.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/content/chat-tooltip.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -4,25 +4,25 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> &quot;use strict&quot;;</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> /* global MozXULElement */</span>
<a href="#l15.8"></a><span id="l15.8"> /* global getBrowser */</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> // Wrap in a block to prevent leaking to window scope.</span>
<a href="#l15.11"></a><span id="l15.11"> {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  let {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  let {Status} = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  let { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+  let { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17">   /**</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-  * The MozChatTooltip widget implements a custom tooltip for chat. This tooltip</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-  * is used to display a rich tooltip when you mouse over contacts, channels</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-  * etc. in the chat view.</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  * @extends {MozXULElement}</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-  */</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+   * The MozChatTooltip widget implements a custom tooltip for chat. This tooltip</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+   * is used to display a rich tooltip when you mouse over contacts, channels</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+   * etc. in the chat view.</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+   * @extends {MozXULElement}</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+   */</span>
<a href="#l15.28"></a><span id="l15.28">   class MozChatTooltip extends MozXULElement {</span>
<a href="#l15.29"></a><span id="l15.29">     static get inheritedAttributes() {</span>
<a href="#l15.30"></a><span id="l15.30">       return {</span>
<a href="#l15.31"></a><span id="l15.31">         &quot;.userIconHolder&quot;: &quot;userIcon&quot;,</span>
<a href="#l15.32"></a><span id="l15.32">         &quot;.userIcon&quot;: &quot;src=userIcon&quot;,</span>
<a href="#l15.33"></a><span id="l15.33">         &quot;.statusTypeIcon&quot;: &quot;status,left&quot;,</span>
<a href="#l15.34"></a><span id="l15.34">         &quot;.tooltipDisplayName&quot;: &quot;value=displayname&quot;,</span>
<a href="#l15.35"></a><span id="l15.35">         &quot;.tooltipProtoIcon&quot;: &quot;src=iconPrpl,status&quot;,</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineat">@@ -32,37 +32,46 @@</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">     constructor() {</span>
<a href="#l15.39"></a><span id="l15.39">       super();</span>
<a href="#l15.40"></a><span id="l15.40">       this._buddy = null;</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42">       this.observer = {</span>
<a href="#l15.43"></a><span id="l15.43">         // @see {nsIObserver}</span>
<a href="#l15.44"></a><span id="l15.44">         observe: (subject, topic, data) =&gt; {</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-          if (subject == this.buddy &amp;&amp;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-              (topic == &quot;account-buddy-status-changed&quot; ||</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-               topic == &quot;account-buddy-status-detail-changed&quot; ||</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-               topic == &quot;account-buddy-display-name-changed&quot; ||</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-               topic == &quot;account-buddy-icon-changed&quot;)) {</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+          if (</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+            subject == this.buddy &amp;&amp;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+            (topic == &quot;account-buddy-status-changed&quot; ||</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+              topic == &quot;account-buddy-status-detail-changed&quot; ||</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+              topic == &quot;account-buddy-display-name-changed&quot; ||</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+              topic == &quot;account-buddy-icon-changed&quot;)</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+          ) {</span>
<a href="#l15.57"></a><span id="l15.57">             this.updateTooltipFromBuddy(this.buddy);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-          } else if (topic == &quot;user-info-received&quot; &amp;&amp;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-                     data == this.observedUserInfo) {</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-            this.updateTooltipInfo(subject.QueryInterface(Ci.nsISimpleEnumerator));</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+          } else if (</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+            topic == &quot;user-info-received&quot; &amp;&amp;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+            data == this.observedUserInfo</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+          ) {</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+            this.updateTooltipInfo(</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+              subject.QueryInterface(Ci.nsISimpleEnumerator)</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+            );</span>
<a href="#l15.68"></a><span id="l15.68">           }</span>
<a href="#l15.69"></a><span id="l15.69">         },</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-        QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver, Ci.nsISupportsWeakReference]),</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+          Ci.nsIObserver,</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+          Ci.nsISupportsWeakReference,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+        ]),</span>
<a href="#l15.75"></a><span id="l15.75">       };</span>
<a href="#l15.76"></a><span id="l15.76"> </span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-      this.addEventListener(&quot;popupshowing&quot;, (event) =&gt; {</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+      this.addEventListener(&quot;popupshowing&quot;, event =&gt; {</span>
<a href="#l15.79"></a><span id="l15.79">         if (!this._onPopupShowing()) {</span>
<a href="#l15.80"></a><span id="l15.80">           event.preventDefault();</span>
<a href="#l15.81"></a><span id="l15.81">         }</span>
<a href="#l15.82"></a><span id="l15.82">       });</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-      this.addEventListener(&quot;popuphiding&quot;, (event) =&gt; {</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+      this.addEventListener(&quot;popuphiding&quot;, event =&gt; {</span>
<a href="#l15.86"></a><span id="l15.86">         this.buddy = null;</span>
<a href="#l15.87"></a><span id="l15.87">         this.removeAttribute(&quot;noTopic&quot;);</span>
<a href="#l15.88"></a><span id="l15.88">         this.removeAttribute(&quot;left&quot;);</span>
<a href="#l15.89"></a><span id="l15.89">         if (&quot;observedUserInfo&quot; in this &amp;&amp; this.observedUserInfo) {</span>
<a href="#l15.90"></a><span id="l15.90">           Services.obs.removeObserver(this.observer, &quot;user-info-received&quot;);</span>
<a href="#l15.91"></a><span id="l15.91">           delete this.observedUserInfo;</span>
<a href="#l15.92"></a><span id="l15.92">         }</span>
<a href="#l15.93"></a><span id="l15.93">       });</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineat">@@ -82,40 +91,56 @@</span>
<a href="#l15.95"></a><span id="l15.95"> </span>
<a href="#l15.96"></a><span id="l15.96">       // Reset tooltip.</span>
<a href="#l15.97"></a><span id="l15.97">       let largeTooltip = this.querySelector(&quot;.largeTooltip&quot;);</span>
<a href="#l15.98"></a><span id="l15.98">       largeTooltip.hidden = false;</span>
<a href="#l15.99"></a><span id="l15.99">       this.removeAttribute(&quot;label&quot;);</span>
<a href="#l15.100"></a><span id="l15.100"> </span>
<a href="#l15.101"></a><span id="l15.101">       let localName = elt.localName;</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-      if (localName == &quot;richlistitem&quot; &amp;&amp; elt.getAttribute(&quot;is&quot;) == &quot;chat-group&quot;) {</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+      if (</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+        localName == &quot;richlistitem&quot; &amp;&amp;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+        elt.getAttribute(&quot;is&quot;) == &quot;chat-group&quot;</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+      ) {</span>
<a href="#l15.108"></a><span id="l15.108">         return false;</span>
<a href="#l15.109"></a><span id="l15.109">       }</span>
<a href="#l15.110"></a><span id="l15.110"> </span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-      if (localName == &quot;richlistitem&quot; &amp;&amp;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-          elt.getAttribute(&quot;is&quot;) == &quot;chat-imconv&quot; &amp;&amp; elt.conv) {</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+      if (</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+        localName == &quot;richlistitem&quot; &amp;&amp;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+        elt.getAttribute(&quot;is&quot;) == &quot;chat-imconv&quot; &amp;&amp;</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+        elt.conv</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+      ) {</span>
<a href="#l15.118"></a><span id="l15.118">         return this.updateTooltipFromConversation(elt.conv);</span>
<a href="#l15.119"></a><span id="l15.119">       }</span>
<a href="#l15.120"></a><span id="l15.120"> </span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-      if (localName == &quot;richlistitem&quot; &amp;&amp; elt.getAttribute(&quot;is&quot;) == &quot;chat-contact&quot;) {</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-        return this.updateTooltipFromBuddy(elt.contact.preferredBuddy.preferredAccountBuddy);</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+      if (</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+        localName == &quot;richlistitem&quot; &amp;&amp;</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+        elt.getAttribute(&quot;is&quot;) == &quot;chat-contact&quot;</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+      ) {</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+        return this.updateTooltipFromBuddy(</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+          elt.contact.preferredBuddy.preferredAccountBuddy</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+        );</span>
<a href="#l15.130"></a><span id="l15.130">       }</span>
<a href="#l15.131"></a><span id="l15.131"> </span>
<a href="#l15.132"></a><span id="l15.132">       if (localName == &quot;richlistitem&quot;) {</span>
<a href="#l15.133"></a><span id="l15.133">         let contactlistbox = document.getElementById(&quot;contactlistbox&quot;);</span>
<a href="#l15.134"></a><span id="l15.134">         let conv = contactlistbox.selectedItem.conv;</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-        return this.updateTooltipFromParticipant(elt.chatBuddy.name, conv,</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-          elt.chatBuddy);</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+        return this.updateTooltipFromParticipant(</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+          elt.chatBuddy.name,</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+          conv,</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+          elt.chatBuddy</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+        );</span>
<a href="#l15.142"></a><span id="l15.142">       }</span>
<a href="#l15.143"></a><span id="l15.143"> </span>
<a href="#l15.144"></a><span id="l15.144">       let classList = elt.classList;</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-      if (classList.contains(&quot;ib-nick&quot;) ||</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-          classList.contains(&quot;ib-sender&quot;) ||</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-          classList.contains(&quot;ib-person&quot;)) {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+      if (</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+        classList.contains(&quot;ib-nick&quot;) ||</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+        classList.contains(&quot;ib-sender&quot;) ||</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+        classList.contains(&quot;ib-person&quot;)</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+      ) {</span>
<a href="#l15.153"></a><span id="l15.153">         let conv = getBrowser()._conv;</span>
<a href="#l15.154"></a><span id="l15.154">         if (conv.isChat) {</span>
<a href="#l15.155"></a><span id="l15.155">           return this.updateTooltipFromParticipant(elt.textContent, conv);</span>
<a href="#l15.156"></a><span id="l15.156">         }</span>
<a href="#l15.157"></a><span id="l15.157">         if (elt.textContent == conv.name) {</span>
<a href="#l15.158"></a><span id="l15.158">           return this.updateTooltipFromConversation(conv);</span>
<a href="#l15.159"></a><span id="l15.159">         }</span>
<a href="#l15.160"></a><span id="l15.160">       }</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineat">@@ -123,26 +148,32 @@</span>
<a href="#l15.162"></a><span id="l15.162">       // Are we over a message?</span>
<a href="#l15.163"></a><span id="l15.163">       for (let node = elt; node; node = node.parentNode) {</span>
<a href="#l15.164"></a><span id="l15.164">         if (!node._originalMsg) {</span>
<a href="#l15.165"></a><span id="l15.165">           continue;</span>
<a href="#l15.166"></a><span id="l15.166">         }</span>
<a href="#l15.167"></a><span id="l15.167">         // It's a message, so add a date/time tooltip.</span>
<a href="#l15.168"></a><span id="l15.168">         let date = new Date(node._originalMsg.time * 1000);</span>
<a href="#l15.169"></a><span id="l15.169">         let text;</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-        if ((new Date()).toDateString() == date.toDateString()) {</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-          const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-            timeStyle: &quot;medium&quot;,</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-          });</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+        if (new Date().toDateString() == date.toDateString()) {</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+          const dateTimeFormatter = new Services.intl.DateTimeFormat(</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+            undefined,</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+            {</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+              timeStyle: &quot;medium&quot;,</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+            }</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+          );</span>
<a href="#l15.181"></a><span id="l15.181">           text = dateTimeFormatter.format(date);</span>
<a href="#l15.182"></a><span id="l15.182">         } else {</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-          const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-            dateStyle: &quot;short&quot;,</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-            timeStyle: &quot;medium&quot;,</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-          });</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+          const dateTimeFormatter = new Services.intl.DateTimeFormat(</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+            undefined,</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+            {</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+              dateStyle: &quot;short&quot;,</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+              timeStyle: &quot;medium&quot;,</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+            }</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+          );</span>
<a href="#l15.194"></a><span id="l15.194">           text = dateTimeFormatter.format(date);</span>
<a href="#l15.195"></a><span id="l15.195">         }</span>
<a href="#l15.196"></a><span id="l15.196">         // Setting the attribute on this node means that if the element</span>
<a href="#l15.197"></a><span id="l15.197">         // we are pointing at carries a title set by the prpl,</span>
<a href="#l15.198"></a><span id="l15.198">         // that title won't be overridden.</span>
<a href="#l15.199"></a><span id="l15.199">         node.setAttribute(&quot;title&quot;, text);</span>
<a href="#l15.200"></a><span id="l15.200">         break;</span>
<a href="#l15.201"></a><span id="l15.201">       }</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineat">@@ -152,17 +183,18 @@</span>
<a href="#l15.203"></a><span id="l15.203">       return false;</span>
<a href="#l15.204"></a><span id="l15.204">     }</span>
<a href="#l15.205"></a><span id="l15.205"> </span>
<a href="#l15.206"></a><span id="l15.206">     connectedCallback() {</span>
<a href="#l15.207"></a><span id="l15.207">       if (this.delayConnectedCallback()) {</span>
<a href="#l15.208"></a><span id="l15.208">         return;</span>
<a href="#l15.209"></a><span id="l15.209">       }</span>
<a href="#l15.210"></a><span id="l15.210">       this.textContent = &quot;&quot;;</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-      this.appendChild(MozXULElement.parseXULToFragment(`</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+      this.appendChild(</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+        MozXULElement.parseXULToFragment(`</span>
<a href="#l15.214"></a><span id="l15.214">         &lt;vbox class=&quot;largeTooltip&quot;&gt;</span>
<a href="#l15.215"></a><span id="l15.215">           &lt;hbox align=&quot;start&quot; crop=&quot;end&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l15.216"></a><span id="l15.216">             &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l15.217"></a><span id="l15.217">               &lt;stack&gt;</span>
<a href="#l15.218"></a><span id="l15.218">                 &lt;!-- The box around the user icon is a workaround for bug 955673. --&gt;</span>
<a href="#l15.219"></a><span id="l15.219">                 &lt;box class=&quot;userIconHolder&quot;&gt;</span>
<a href="#l15.220"></a><span id="l15.220">                   &lt;image class=&quot;userIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l15.221"></a><span id="l15.221">                 &lt;/box&gt;</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineat">@@ -184,24 +216,26 @@</span>
<a href="#l15.223"></a><span id="l15.223">           &lt;grid&gt;</span>
<a href="#l15.224"></a><span id="l15.224">             &lt;columns&gt;</span>
<a href="#l15.225"></a><span id="l15.225">               &lt;column&gt;&lt;/column&gt;</span>
<a href="#l15.226"></a><span id="l15.226">               &lt;column flex=&quot;1&quot;&gt;&lt;/column&gt;</span>
<a href="#l15.227"></a><span id="l15.227">             &lt;/columns&gt;</span>
<a href="#l15.228"></a><span id="l15.228">             &lt;rows class=&quot;tooltipRows&quot;&gt;&lt;/rows&gt;</span>
<a href="#l15.229"></a><span id="l15.229">           &lt;/grid&gt;</span>
<a href="#l15.230"></a><span id="l15.230">         &lt;/vbox&gt;</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-      `));</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+      `)</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+      );</span>
<a href="#l15.234"></a><span id="l15.234">       this.initializeAttributeInheritance();</span>
<a href="#l15.235"></a><span id="l15.235">     }</span>
<a href="#l15.236"></a><span id="l15.236"> </span>
<a href="#l15.237"></a><span id="l15.237">     get bundle() {</span>
<a href="#l15.238"></a><span id="l15.238">       if (!this._bundle) {</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-        this._bundle =</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-          Services.strings.createBundle(&quot;chrome://chat/locale/imtooltip.properties&quot;);</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+        this._bundle = Services.strings.createBundle(</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+          &quot;chrome://chat/locale/imtooltip.properties&quot;</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+        );</span>
<a href="#l15.244"></a><span id="l15.244">       }</span>
<a href="#l15.245"></a><span id="l15.245">       return this._bundle;</span>
<a href="#l15.246"></a><span id="l15.246">     }</span>
<a href="#l15.247"></a><span id="l15.247"> </span>
<a href="#l15.248"></a><span id="l15.248">     set buddy(val) {</span>
<a href="#l15.249"></a><span id="l15.249">       if (val == this._buddy) {</span>
<a href="#l15.250"></a><span id="l15.250">         return val;</span>
<a href="#l15.251"></a><span id="l15.251">       }</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineat">@@ -388,19 +422,20 @@</span>
<a href="#l15.253"></a><span id="l15.253">       }</span>
<a href="#l15.254"></a><span id="l15.254"> </span>
<a href="#l15.255"></a><span id="l15.255">       let account = aConv.account;</span>
<a href="#l15.256"></a><span id="l15.256">       let normalizedNick = aConv.target.getNormalizedChatBuddyName(aNick);</span>
<a href="#l15.257"></a><span id="l15.257">       // To try to ensure that we aren't misidentifying a nick with a</span>
<a href="#l15.258"></a><span id="l15.258">       // contact, we require at least that the normalizedChatBuddyName of</span>
<a href="#l15.259"></a><span id="l15.259">       // the nick is normalized like a normalizedName for contacts.</span>
<a href="#l15.260"></a><span id="l15.260">       if (normalizedNick == account.normalize(normalizedNick)) {</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-        let accountBuddy =</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-          Services.contacts.getAccountBuddyByNameAndAccount(normalizedNick,</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineminus">-            account);</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+        let accountBuddy = Services.contacts.getAccountBuddyByNameAndAccount(</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+          normalizedNick,</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+          account</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+        );</span>
<a href="#l15.268"></a><span id="l15.268">         if (accountBuddy) {</span>
<a href="#l15.269"></a><span id="l15.269">           return this.updateTooltipFromBuddy(accountBuddy);</span>
<a href="#l15.270"></a><span id="l15.270">         }</span>
<a href="#l15.271"></a><span id="l15.271">       }</span>
<a href="#l15.272"></a><span id="l15.272"> </span>
<a href="#l15.273"></a><span id="l15.273">       this.reset();</span>
<a href="#l15.274"></a><span id="l15.274">       this.setAttribute(&quot;displayname&quot;, aNick);</span>
<a href="#l15.275"></a><span id="l15.275">       this.setAttribute(&quot;iconPrpl&quot;, account.protocol.iconBaseURI + &quot;icon.png&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/content/conversation-browser.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/content/conversation-browser.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,760 +1,853 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> &quot;use strict&quot;;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12"> /* global MozXULElement */</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> // Wrap in a block to prevent leaking to window scope.</span>
<a href="#l16.15"></a><span id="l16.15"> {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-  const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  const { Services } = ChromeUtils.import(</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+    &quot;resource://gre/modules/Services.jsm&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+  );</span>
<a href="#l16.20"></a><span id="l16.20">   const {</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-  initHTMLDocument,</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-  serializeSelection,</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-  getCurrentTheme,</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-  isNextMessage,</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-  getHTMLForMessage,</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-  insertHTMLForMessage,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imThemes.jsm&quot;);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-  const {smileTextNode} = ChromeUtils.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-  const {cleanupImMarkup} = ChromeUtils.import(&quot;resource:///modules/imContentSink.jsm&quot;);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+    initHTMLDocument,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+    serializeSelection,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+    getCurrentTheme,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+    isNextMessage,</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+    getHTMLForMessage,</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+    insertHTMLForMessage,</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  } = ChromeUtils.import(&quot;resource:///modules/imThemes.jsm&quot;);</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+  const { smileTextNode } = ChromeUtils.import(</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+    &quot;resource:///modules/imSmileys.jsm&quot;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  );</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+  const { cleanupImMarkup } = ChromeUtils.import(</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+    &quot;resource:///modules/imContentSink.jsm&quot;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+  );</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  (function() {</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+    // &lt;browser&gt; is lazily set up through setElementCreationCallback,</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+    // i.e. put into customElements the first time it's really seen.</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+    // Create a fake to ensure browser exists in customElements, since otherwise</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+    // we can't extend it. Then make sure this fake doesn't stay around.</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+    if (!customElements.get(&quot;browser&quot;)) {</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+      delete document.createXULElement(&quot;browser&quot;);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+    }</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  })();</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  /**</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+   * The chat conversation browser, i.e. the main content on the chat tab.</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+   * @augments {MozBrowser}</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+   */</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+  class MozConversationBrowser extends customElements.get(&quot;browser&quot;) {</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+    constructor() {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+      super();</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+      this._conv = null;</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-(function() {</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-  // &lt;browser&gt; is lazily set up through setElementCreationCallback,</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  // i.e. put into customElements the first time it's really seen.</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-  // Create a fake to ensure browser exists in customElements, since otherwise</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-  // we can't extend it. Then make sure this fake doesn't stay around.</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-  if (!customElements.get(&quot;browser&quot;)) {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-    delete document.createXULElement(&quot;browser&quot;);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-  }</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-})();</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+      // @implements {nsIWebProgressListener}</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+      this.progressListener = {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+        onStateChange: (progress, request, stateFlags, status) =&gt; {</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+          if (</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+            !(stateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) ||</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+            !(</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+              stateFlags &amp; Ci.nsIWebProgressListener.STATE_IS_DOCUMENT ||</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+              stateFlags &amp; Ci.nsIWebProgressListener.STATE_IS_WINDOW</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+            )</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+          ) {</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+            return;</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+          }</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+          if (!this._loadState) {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+            initHTMLDocument(this._conv, this.theme, this.contentDocument);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+            this._loadState = 1;</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+            this._exposeMethodsToContent();</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+            return;</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+          }</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+          this.removeProgressListener(this.progressListener);</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+          this.initMagicCopy();</span>
<a href="#l16.94"></a><span id="l16.94"> </span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-/**</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">- * The chat conversation browser, i.e. the main content on the chat tab.</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">- * @augments {MozBrowser}</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">- */</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-class MozConversationBrowser extends customElements.get(&quot;browser&quot;) {</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-  constructor() {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-    super();</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+          // We need to reset these variables here to avoid a race</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+          // condition if we are starting to display a new conversation</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+          // but the display of the previous conversation wasn't finished.</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+          // This can happen if the user quickly changes the selected</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+          // conversation in the log viewer.</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+          this._lastMessage = null;</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+          this._lastMessageIsContext = true;</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+          this._firstNonContextElt = null;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+          this._messageDisplayPending = false;</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+          this._pendingMessages = [];</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+          this._nextPendingMessageIndex = 0;</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+          this._pendingMessagesDisplayed = 0;</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+          this._displayPendingMessagesCalls = 0;</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+          this._sessions = [];</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+          if (this.progressBar) {</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+            this.progressBar.hidden = true;</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+          }</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+          this.onChatNodeContentLoad = this.onContentElementLoad.bind(this);</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+          this.contentChatNode.addEventListener(</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+            &quot;load&quot;,</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+            this.onChatNodeContentLoad,</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+            true</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+          );</span>
<a href="#l16.126"></a><span id="l16.126"> </span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-    this._conv = null;</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+          // Notify observers to get the conversation shown.</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+          Services.obs.notifyObservers(this, &quot;conversation-loaded&quot;);</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+        },</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+        onProgressChange(</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+          progress,</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+          request,</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+          curSelf,</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+          maxSelf,</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+          curTotal,</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+          maxTotal</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+        ) {},</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+        onLocationChange(aprogress, request, location) {},</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+        onStatusChange(progress, request, status, message) {},</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+        onSecurityChange(progress, request, state) {},</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+        onContentBlockingEvent(progress, request, event) {},</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+          Ci.nsIWebProgressListener,</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+          Ci.nsISupportsWeakReference,</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+        ]),</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+      };</span>
<a href="#l16.148"></a><span id="l16.148"> </span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-    // @implements {nsIWebProgressListener}</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-    this.progressListener = {</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-      onStateChange: (progress, request, stateFlags, status) =&gt; {</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-        if (!(stateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) ||</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-            !((stateFlags &amp; Ci.nsIWebProgressListener.STATE_IS_DOCUMENT) ||</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-              (stateFlags &amp; Ci.nsIWebProgressListener.STATE_IS_WINDOW))) {</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+      // Make sure to load URLs externally.</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+      this.addEventListener(&quot;click&quot;, event =&gt; {</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+        // Right click should open the context menu.</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+        if (event.button == 2) {</span>
<a href="#l16.159"></a><span id="l16.159">           return;</span>
<a href="#l16.160"></a><span id="l16.160">         }</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-        if (!this._loadState) {</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-          initHTMLDocument(this._conv, this.theme, this.contentDocument);</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-          this._loadState = 1;</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-          this._exposeMethodsToContent();</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+        // The 'click' event is fired even when the link is</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+        // activated with the keyboard.</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+        // The event target may be a descendant of the actual link.</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+        let url;</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+        for (let elem = event.target; elem; elem = elem.parentNode) {</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+          if (elem instanceof HTMLAnchorElement) {</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+            url = elem.href;</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+            if (url) {</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+              break;</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+            }</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+          }</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+        }</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+        if (!url) {</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+          return;</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+        }</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+        let uri = Services.io.newURI(url);</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+        // http and https are the only schemes that are both</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+        // allowed by our IM filters and exposed.</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+        if (!uri.schemeIs(&quot;http&quot;) &amp;&amp; !uri.schemeIs(&quot;https&quot;)) {</span>
<a href="#l16.188"></a><span id="l16.188">           return;</span>
<a href="#l16.189"></a><span id="l16.189">         }</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-        this.removeProgressListener(this.progressListener);</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+        event.preventDefault();</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+        // loadURI can throw if the default browser is misconfigured.</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+        Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+          .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+          .loadURI(uri);</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+      });</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+      this.addEventListener(&quot;keypress&quot;, event =&gt; {</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+        switch (event.keyCode) {</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+          case KeyEvent.DOM_VK_PAGE_UP: {</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+            if (event.shiftKey) {</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+              this.contentWindow.scrollByPages(-1);</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+            } else if (event.altKey) {</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+              this.scrollToPreviousSection();</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+            }</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+            break;</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+          }</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+          case KeyEvent.DOM_VK_PAGE_DOWN: {</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+            if (event.shiftKey) {</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+              this.contentWindow.scrollByPages(1);</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+            } else if (event.altKey) {</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+              this.scrollToNextSection();</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+            }</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+            break;</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+          }</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+          case KeyEvent.DOM_VK_HOME: {</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+            this.scrollToPreviousSection();</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+            event.preventDefault();</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+            break;</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+          }</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+          case KeyEvent.DOM_VK_END: {</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+            this.scrollToNextSection();</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+            event.preventDefault();</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+            break;</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+          }</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+        }</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+      });</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+    }</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+    connectedCallback() {</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+      super.connectedCallback();</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+      this._theme = null;</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+      this._loadState = 0;</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+      this.autoCopyEnabled = false;</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+      this.magicCopyPref =</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+        &quot;messenger.conversations.selections.magicCopyEnabled&quot;;</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+      this.magicCopyInitialized = false;</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+      this._destroyed = false;</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+      // Makes the chat browser scroll to the bottom automatically when we append</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+      // a new message. This behavior gets disabled when the user scrolls up to</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+      // look at the history, and we re-enable it when the user scrolls to</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+      // (within 10px) of the bottom.</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+      this._convScrollEnabled = true;</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+      this._textModifiers = [smileTextNode];</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+      // These variables are reset in onStateChange:</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+      this._lastMessage = null;</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+      this._lastMessageIsContext = true;</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+      this._firstNonContextElt = null;</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+      this._messageDisplayPending = false;</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+      this._pendingMessages = [];</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+      this._nextPendingMessageIndex = 0;</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+      this._pendingMessagesDisplayed = 0;</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+      this._displayPendingMessagesCalls = 0;</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+      this._sessions = [];</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+      this.progressBar = null;</span>
<a href="#l16.269"></a><span id="l16.269"> </span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-        this.initMagicCopy();</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+      this.addEventListener(&quot;scroll&quot;, this.browserScroll);</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+      this.addEventListener(&quot;resize&quot;, this.browserResize);</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+      // @implements {nsIObserver}</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+      this.prefObserver = (subject, topic, data) =&gt; {</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+        if (this.magicCopyEnabled) {</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+          this.enableMagicCopy();</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+        } else {</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+          this.disableMagicCopy();</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+        }</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+      };</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+      // @implements {nsIController}</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+      this.copyController = {</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+        supportsCommand(command) {</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+          return command == &quot;cmd_copy&quot; || command == &quot;cmd_cut&quot;;</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+        },</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+        isCommandEnabled: command =&gt; {</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+          return (</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+            command == &quot;cmd_copy&quot; &amp;&amp;</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+            !this.contentWindow.getSelection().isCollapsed</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+          );</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+        },</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+        doCommand: command =&gt; {</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+          let selection = this.contentWindow.getSelection();</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+          if (selection.isCollapsed) {</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+            return;</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+          }</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+          Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+            .getService(Ci.nsIClipboardHelper)</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+            .copyString(serializeSelection(selection));</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+        },</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+        onEvent(command) {},</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([Ci.nsIController]),</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+      };</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+      // @implements {nsISelectionListener}</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+      this.chatSelectionListener = {</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+        notifySelectionChanged(document, selection, reason) {</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+          if (</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+            !(</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+              reason &amp; Ci.nsISelectionListener.MOUSEUP_REASON ||</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+              reason &amp; Ci.nsISelectionListener.SELECTALL_REASON ||</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+              reason &amp; Ci.nsISelectionListener.KEYPRESS_REASON</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineplus">+            )</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+          ) {</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+            return;</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+          } // we are still dragging, don't bother with the selection</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineplus">+</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+          Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+            .getService(Ci.nsIClipboardHelper)</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+            .copyStringToClipboard(</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+              serializeSelection(selection),</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+              Ci.nsIClipboard.kSelectionClipboard</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineplus">+            );</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+        },</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([Ci.nsISelectionListener]),</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+      };</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineplus">+    }</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+    init(conversation) {</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineplus">+      // Magic Copy may be initialized if the convbrowser is already</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineplus">+      // displaying a conversation.</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineplus">+      this.uninitMagicCopy();</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineplus">+</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineplus">+      this._conv = conversation;</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+      // init is called when the message style preview is</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+      // reloaded so we need to reset _theme.</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+      this._theme = null;</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+      // Prevent ongoing asynchronous message display from continuing.</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+      this._messageDisplayPending = false;</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+      // _loadState is 0 while loading conv.html and 1 while</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+      // loading the real conversation HTML.</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+      this._loadState = 0;</span>
<a href="#l16.349"></a><span id="l16.349"> </span>
<a href="#l16.350"></a><span id="l16.350" class="difflineminus">-        // We need to reset these variables here to avoid a race</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-        // condition if we are starting to display a new conversation</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineminus">-        // but the display of the previous conversation wasn't finished.</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineminus">-        // This can happen if the user quickly changes the selected</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineminus">-        // conversation in the log viewer.</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineminus">-        this._lastMessage = null;</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineminus">-        this._lastMessageIsContext = true;</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineminus">-        this._firstNonContextElt = null;</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineminus">-        this._messageDisplayPending = false;</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+      this.docShell.charset = &quot;UTF-8&quot;;</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+      const URI = &quot;chrome://chat/content/conv.html&quot;;</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+      const loadURIOptions = {</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+        triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+      };</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+      this.webNavigation.loadURI(URI, loadURIOptions);</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+      this.addProgressListener(this.progressListener);</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+    }</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+    get theme() {</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+      return this._theme || (this._theme = getCurrentTheme());</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+    }</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+    get contentDocument() {</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+      return this.webNavigation.document;</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+    }</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineplus">+</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineplus">+    get contentChatNode() {</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+      return this.contentDocument.getElementById(&quot;Chat&quot;);</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineplus">+    }</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineplus">+</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+    get magicCopyEnabled() {</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+      return Services.prefs.getBoolPref(this.magicCopyPref);</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+    }</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+    enableMagicCopy() {</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+      this.contentWindow.controllers.insertControllerAt(0, this.copyController);</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+      this.autoCopyEnabled =</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+        Services.clipboard.supportsSelectionClipboard() &amp;&amp;</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+        Services.prefs.getBoolPref(&quot;clipboard.autocopy&quot;);</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+      if (this.autoCopyEnabled) {</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+        this.contentWindow</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+          .getSelection()</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+          .addSelectionListener(this.chatSelectionListener);</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineplus">+      }</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineplus">+    }</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineplus">+</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineplus">+    disableMagicCopy() {</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+      this.contentWindow.controllers.removeController(this.copyController);</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+      if (this.autoCopyEnabled) {</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+        this.contentWindow</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineplus">+          .getSelection()</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineplus">+          .removeSelectionListener(this.chatSelectionListener);</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineplus">+      }</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineplus">+    }</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineplus">+</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineplus">+    initMagicCopy() {</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineplus">+      if (this.magicCopyInitialized) {</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineplus">+        return;</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineplus">+      }</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineplus">+      Services.prefs.addObserver(this.magicCopyPref, this.prefObserver);</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineplus">+      this.magicCopyInitialized = true;</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+      if (this.magicCopyEnabled) {</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+        this.enableMagicCopy();</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+      }</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineplus">+    }</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineplus">+</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineplus">+    uninitMagicCopy() {</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineplus">+      if (!this.magicCopyInitialized) {</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineplus">+        return;</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineplus">+      }</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineplus">+      Services.prefs.removeObserver(this.magicCopyPref, this.prefObserver);</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+      if (this.magicCopyEnabled) {</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+        this.disableMagicCopy();</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineplus">+      }</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineplus">+      this.magicCopyInitialized = false;</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+    }</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineplus">+</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineplus">+    destroy() {</span>
<a href="#l16.428"></a><span id="l16.428" class="difflineplus">+      super.destroy();</span>
<a href="#l16.429"></a><span id="l16.429" class="difflineplus">+      if (this._destroyed) {</span>
<a href="#l16.430"></a><span id="l16.430" class="difflineplus">+        return;</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineplus">+      }</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineplus">+      this._destroyed = true;</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+      this._messageDisplayPending = false;</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineplus">+      this.uninitMagicCopy();</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineplus">+      if (this.contentChatNode) {</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineplus">+        // Remove the listener only if the conversation was initialized.</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+        this.contentChatNode.removeEventListener(</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+          &quot;load&quot;,</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+          this.onChatNodeContentLoad,</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+          true</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+        );</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+      }</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineplus">+    }</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineplus">+    _updateConvScrollEnabled() {</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineplus">+      // Enable auto-scroll if the scrollbar is at the bottom.</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineplus">+      let body = this.contentDocument.querySelector(&quot;body&quot;);</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+      this._convScrollEnabled =</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+        body.scrollHeight &lt;= body.scrollTop + body.clientHeight + 10;</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+      return this._convScrollEnabled;</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+    }</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+    convScrollEnabled() {</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineplus">+      return this._convScrollEnabled || this._updateConvScrollEnabled();</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineplus">+    }</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+    _scrollToElement(aElt) {</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineplus">+      aElt.scrollIntoView(true);</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineplus">+      this._scrollingIntoView = true;</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineplus">+    }</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineplus">+</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineplus">+    _exposeMethodsToContent() {</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineplus">+      // Expose scrollToElement and convScrollEnabled to the message styles.</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineplus">+      this.contentWindow.scrollToElement = this._scrollToElement.bind(this);</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineplus">+      this.contentWindow.convScrollEnabled = this.convScrollEnabled.bind(this);</span>
<a href="#l16.468"></a><span id="l16.468" class="difflineplus">+    }</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineplus">+</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineplus">+    addTextModifier(aModifier) {</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineplus">+      if (!this._textModifiers.includes(aModifier)) {</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+        this._textModifiers.push(aModifier);</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+      }</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+    }</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+    set isActive(value) {</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineplus">+      this.docShell.isActive = value;</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineplus">+      if (value &amp;&amp; this._pendingMessages.length) {</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+        this.startDisplayingPendingMessages(false);</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+      }</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+    }</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+    appendMessage(aMsg, aContext, aFirstUnread) {</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+      this._pendingMessages.push({</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineplus">+        msg: aMsg,</span>
<a href="#l16.486"></a><span id="l16.486" class="difflineplus">+        context: aContext,</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineplus">+        firstUnread: aFirstUnread,</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineplus">+      });</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+      if (this.docShell.isActive) {</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineplus">+        this.startDisplayingPendingMessages(true);</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+      }</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+    }</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineplus">+    startDisplayingPendingMessages(delayed) {</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+      if (this._messageDisplayPending) {</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+        return;</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineplus">+      }</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+      this._messageDisplayPending = true;</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+      this.contentWindow.messageInsertPending = true;</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineplus">+      if (delayed) {</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineplus">+        requestIdleCallback(this.displayPendingMessages.bind(this));</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+      } else {</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineplus">+        // 200ms here is a generous amount of time. The conversation switch</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineplus">+        // should take no more than 100ms to feel 'immediate', but the perceived</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineplus">+        // performance if we flicker is likely even worse than having a barely</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineplus">+        // perceptible delay.</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineplus">+        let deadline = Cu.now() + 200;</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+        this.displayPendingMessages({</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+          timeRemaining() {</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+            return deadline - Cu.now();</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineplus">+          },</span>
<a href="#l16.512"></a><span id="l16.512" class="difflineplus">+        });</span>
<a href="#l16.513"></a><span id="l16.513" class="difflineplus">+      }</span>
<a href="#l16.514"></a><span id="l16.514" class="difflineplus">+    }</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineplus">+</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineplus">+    // getNextPendingMessage and getPendingMessagesCount are the</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineplus">+    // only 2 methods accessing the this._pendingMessages array</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineplus">+    // directly during the chunked display of messages. It is</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineplus">+    // possible to override these 2 methods to replace the array</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineplus">+    // with something else. The log viewer for example uses an</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+    // enumerator that creates message objects lazily to avoid</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+    // jank when displaying lots of messages.</span>
<a href="#l16.523"></a><span id="l16.523" class="difflineplus">+    getNextPendingMessage() {</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineplus">+      let length = this._pendingMessages.length;</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineplus">+      if (this._nextPendingMessageIndex == length) {</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineplus">+        return null;</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineplus">+      }</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineplus">+</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineplus">+      let result = this._pendingMessages[this._nextPendingMessageIndex++];</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineplus">+</span>
<a href="#l16.531"></a><span id="l16.531" class="difflineplus">+      if (this._nextPendingMessageIndex == length) {</span>
<a href="#l16.532"></a><span id="l16.532">         this._pendingMessages = [];</span>
<a href="#l16.533"></a><span id="l16.533">         this._nextPendingMessageIndex = 0;</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineminus">-        this._pendingMessagesDisplayed = 0;</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineminus">-        this._displayPendingMessagesCalls = 0;</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineminus">-        this._sessions = [];</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineminus">-        if (this.progressBar)</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineminus">-          this.progressBar.hidden = true;</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineplus">+      }</span>
<a href="#l16.540"></a><span id="l16.540"> </span>
<a href="#l16.541"></a><span id="l16.541" class="difflineminus">-        this.onChatNodeContentLoad = this.onContentElementLoad.bind(this);</span>
<a href="#l16.542"></a><span id="l16.542" class="difflineminus">-        this.contentChatNode.addEventListener(&quot;load&quot;, this.onChatNodeContentLoad, true);</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineplus">+      return result;</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineplus">+    }</span>
<a href="#l16.545"></a><span id="l16.545"> </span>
<a href="#l16.546"></a><span id="l16.546" class="difflineminus">-        // Notify observers to get the conversation shown.</span>
<a href="#l16.547"></a><span id="l16.547" class="difflineminus">-        Services.obs.notifyObservers(this, &quot;conversation-loaded&quot;);</span>
<a href="#l16.548"></a><span id="l16.548" class="difflineminus">-      },</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineminus">-      onProgressChange(progress, request, curSelf, maxSelf, curTotal, maxTotal) { },</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineminus">-      onLocationChange(aprogress, request, location) { },</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineminus">-      onStatusChange(progress, request, status, message) { },</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineminus">-      onSecurityChange(progress, request, state) { },</span>
<a href="#l16.553"></a><span id="l16.553" class="difflineminus">-      onContentBlockingEvent(progress, request, event) { },</span>
<a href="#l16.554"></a><span id="l16.554" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineminus">-        Ci.nsIWebProgressListener,</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineminus">-        Ci.nsISupportsWeakReference],</span>
<a href="#l16.557"></a><span id="l16.557" class="difflineminus">-      ),</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineminus">-    };</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+    getPendingMessagesCount() {</span>
<a href="#l16.560"></a><span id="l16.560" class="difflineplus">+      return this._pendingMessages.length;</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineplus">+    }</span>
<a href="#l16.562"></a><span id="l16.562"> </span>
<a href="#l16.563"></a><span id="l16.563" class="difflineminus">-    // Make sure to load URLs externally.</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineminus">-    this.addEventListener(&quot;click&quot;, (event) =&gt; {</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineminus">-      // Right click should open the context menu.</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineminus">-      if (event.button == 2)</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineminus">-        return;</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineminus">-</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineminus">-      // The 'click' event is fired even when the link is</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineminus">-      // activated with the keyboard.</span>
<a href="#l16.571"></a><span id="l16.571" class="difflineminus">-</span>
<a href="#l16.572"></a><span id="l16.572" class="difflineminus">-      // The event target may be a descendant of the actual link.</span>
<a href="#l16.573"></a><span id="l16.573" class="difflineminus">-      let url;</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineminus">-      for (let elem = event.target; elem; elem = elem.parentNode) {</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineminus">-        if (elem instanceof HTMLAnchorElement) {</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineminus">-          url = elem.href;</span>
<a href="#l16.577"></a><span id="l16.577" class="difflineminus">-          if (url)</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineminus">-            break;</span>
<a href="#l16.579"></a><span id="l16.579" class="difflineminus">-        }</span>
<a href="#l16.580"></a><span id="l16.580" class="difflineminus">-      }</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineminus">-      if (!url) {</span>
<a href="#l16.582"></a><span id="l16.582" class="difflineplus">+    displayPendingMessages(timing) {</span>
<a href="#l16.583"></a><span id="l16.583" class="difflineplus">+      if (!this._messageDisplayPending) {</span>
<a href="#l16.584"></a><span id="l16.584">         return;</span>
<a href="#l16.585"></a><span id="l16.585">       }</span>
<a href="#l16.586"></a><span id="l16.586"> </span>
<a href="#l16.587"></a><span id="l16.587" class="difflineminus">-      let uri = Services.io.newURI(url);</span>
<a href="#l16.588"></a><span id="l16.588" class="difflineminus">-</span>
<a href="#l16.589"></a><span id="l16.589" class="difflineminus">-      // http and https are the only schemes that are both</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineminus">-      // allowed by our IM filters and exposed.</span>
<a href="#l16.591"></a><span id="l16.591" class="difflineminus">-      if (!uri.schemeIs(&quot;http&quot;) &amp;&amp; !uri.schemeIs(&quot;https&quot;))</span>
<a href="#l16.592"></a><span id="l16.592" class="difflineminus">-        return;</span>
<a href="#l16.593"></a><span id="l16.593" class="difflineminus">-</span>
<a href="#l16.594"></a><span id="l16.594" class="difflineminus">-      event.preventDefault();</span>
<a href="#l16.595"></a><span id="l16.595" class="difflineminus">-      event.stopPropagation();</span>
<a href="#l16.596"></a><span id="l16.596" class="difflineminus">-</span>
<a href="#l16.597"></a><span id="l16.597" class="difflineminus">-      // loadURI can throw if the default browser is misconfigured.</span>
<a href="#l16.598"></a><span id="l16.598" class="difflineminus">-      Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l16.599"></a><span id="l16.599" class="difflineminus">-        .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l16.600"></a><span id="l16.600" class="difflineminus">-        .loadURI(uri);</span>
<a href="#l16.601"></a><span id="l16.601" class="difflineminus">-    });</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineminus">-</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineminus">-    this.addEventListener(&quot;keypress&quot;, (event) =&gt; {</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineminus">-      switch (event.keyCode) {</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineminus">-        case KeyEvent.DOM_VK_PAGE_UP: {</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineminus">-          if (event.shiftKey) {</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineminus">-            this.contentWindow.scrollByPages(-1);</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineminus">-          } else if (event.altKey) {</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineminus">-            this.scrollToPreviousSection();</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineminus">-          }</span>
<a href="#l16.611"></a><span id="l16.611" class="difflineplus">+      let max = this.getPendingMessagesCount();</span>
<a href="#l16.612"></a><span id="l16.612" class="difflineplus">+      do {</span>
<a href="#l16.613"></a><span id="l16.613" class="difflineplus">+        // One message takes less than 2ms on average.</span>
<a href="#l16.614"></a><span id="l16.614" class="difflineplus">+        let msg = this.getNextPendingMessage();</span>
<a href="#l16.615"></a><span id="l16.615" class="difflineplus">+        if (!msg) {</span>
<a href="#l16.616"></a><span id="l16.616">           break;</span>
<a href="#l16.617"></a><span id="l16.617">         }</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineminus">-        case KeyEvent.DOM_VK_PAGE_DOWN: {</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineminus">-          if (event.shiftKey) {</span>
<a href="#l16.620"></a><span id="l16.620" class="difflineminus">-            this.contentWindow.scrollByPages(1);</span>
<a href="#l16.621"></a><span id="l16.621" class="difflineminus">-          } else if (event.altKey) {</span>
<a href="#l16.622"></a><span id="l16.622" class="difflineminus">-            this.scrollToNextSection();</span>
<a href="#l16.623"></a><span id="l16.623" class="difflineplus">+        this.displayMessage(</span>
<a href="#l16.624"></a><span id="l16.624" class="difflineplus">+          msg.msg,</span>
<a href="#l16.625"></a><span id="l16.625" class="difflineplus">+          msg.context,</span>
<a href="#l16.626"></a><span id="l16.626" class="difflineplus">+          ++this._pendingMessagesDisplayed &lt; max,</span>
<a href="#l16.627"></a><span id="l16.627" class="difflineplus">+          msg.firstUnread</span>
<a href="#l16.628"></a><span id="l16.628" class="difflineplus">+        );</span>
<a href="#l16.629"></a><span id="l16.629" class="difflineplus">+      } while (timing.timeRemaining() &gt; 2);</span>
<a href="#l16.630"></a><span id="l16.630" class="difflineplus">+</span>
<a href="#l16.631"></a><span id="l16.631" class="difflineplus">+      let event = document.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineplus">+      event.initUIEvent(&quot;MessagesDisplayed&quot;, false, false, window, 0);</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineplus">+      if (this._pendingMessagesDisplayed &lt; max) {</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineplus">+        if (this.progressBar) {</span>
<a href="#l16.635"></a><span id="l16.635" class="difflineplus">+          // Show progress bar if after the third call (ca. 120ms)</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineplus">+          // less than half the messages have been displayed.</span>
<a href="#l16.637"></a><span id="l16.637" class="difflineplus">+          if (</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineplus">+            ++this._displayPendingMessagesCalls &gt; 2 &amp;&amp;</span>
<a href="#l16.639"></a><span id="l16.639" class="difflineplus">+            max &gt; 2 * this._pendingMessagesDisplayed</span>
<a href="#l16.640"></a><span id="l16.640" class="difflineplus">+          ) {</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineplus">+            this.progressBar.hidden = false;</span>
<a href="#l16.642"></a><span id="l16.642">           }</span>
<a href="#l16.643"></a><span id="l16.643" class="difflineminus">-          break;</span>
<a href="#l16.644"></a><span id="l16.644" class="difflineplus">+          this.progressBar.max = max;</span>
<a href="#l16.645"></a><span id="l16.645" class="difflineplus">+          this.progressBar.value = this._pendingMessagesDisplayed;</span>
<a href="#l16.646"></a><span id="l16.646" class="difflineplus">+        }</span>
<a href="#l16.647"></a><span id="l16.647" class="difflineplus">+        requestIdleCallback(this.displayPendingMessages.bind(this));</span>
<a href="#l16.648"></a><span id="l16.648" class="difflineplus">+        this.dispatchEvent(event);</span>
<a href="#l16.649"></a><span id="l16.649" class="difflineplus">+        return;</span>
<a href="#l16.650"></a><span id="l16.650" class="difflineplus">+      }</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineplus">+      this.contentWindow.messageInsertPending = false;</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineplus">+      this._messageDisplayPending = false;</span>
<a href="#l16.653"></a><span id="l16.653" class="difflineplus">+      this._pendingMessagesDisplayed = 0;</span>
<a href="#l16.654"></a><span id="l16.654" class="difflineplus">+      this._displayPendingMessagesCalls = 0;</span>
<a href="#l16.655"></a><span id="l16.655" class="difflineplus">+      if (this.progressBar) {</span>
<a href="#l16.656"></a><span id="l16.656" class="difflineplus">+        this.progressBar.hidden = true;</span>
<a href="#l16.657"></a><span id="l16.657" class="difflineplus">+      }</span>
<a href="#l16.658"></a><span id="l16.658" class="difflineplus">+      this.dispatchEvent(event);</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineplus">+    }</span>
<a href="#l16.660"></a><span id="l16.660" class="difflineplus">+</span>
<a href="#l16.661"></a><span id="l16.661" class="difflineplus">+    displayMessage(aMsg, aContext, aNoAutoScroll, aFirstUnread) {</span>
<a href="#l16.662"></a><span id="l16.662" class="difflineplus">+      let doc = this.contentDocument;</span>
<a href="#l16.663"></a><span id="l16.663" class="difflineplus">+</span>
<a href="#l16.664"></a><span id="l16.664" class="difflineplus">+      if (aMsg.noLog &amp;&amp; aMsg.notification &amp;&amp; aMsg.who == &quot;sessionstart&quot;) {</span>
<a href="#l16.665"></a><span id="l16.665" class="difflineplus">+        // New session log.</span>
<a href="#l16.666"></a><span id="l16.666" class="difflineplus">+        if (this._lastMessage) {</span>
<a href="#l16.667"></a><span id="l16.667" class="difflineplus">+          let ruler = doc.createElement(&quot;hr&quot;);</span>
<a href="#l16.668"></a><span id="l16.668" class="difflineplus">+          ruler.className = &quot;sessionstart-ruler&quot;;</span>
<a href="#l16.669"></a><span id="l16.669" class="difflineplus">+          this.contentChatNode.appendChild(ruler);</span>
<a href="#l16.670"></a><span id="l16.670" class="difflineplus">+          this._sessions.push(ruler);</span>
<a href="#l16.671"></a><span id="l16.671" class="difflineplus">+          // Close any open bubble.</span>
<a href="#l16.672"></a><span id="l16.672" class="difflineplus">+          this._lastMessage = null;</span>
<a href="#l16.673"></a><span id="l16.673" class="difflineplus">+        }</span>
<a href="#l16.674"></a><span id="l16.674" class="difflineplus">+        // Suppress this message unless it was an error message.</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineplus">+        if (!aMsg.error) {</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineplus">+          return;</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineplus">+        }</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineplus">+      }</span>
<a href="#l16.679"></a><span id="l16.679" class="difflineplus">+</span>
<a href="#l16.680"></a><span id="l16.680" class="difflineplus">+      let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(</span>
<a href="#l16.681"></a><span id="l16.681" class="difflineplus">+        Ci.mozITXTToHTMLConv</span>
<a href="#l16.682"></a><span id="l16.682" class="difflineplus">+      );</span>
<a href="#l16.683"></a><span id="l16.683" class="difflineplus">+</span>
<a href="#l16.684"></a><span id="l16.684" class="difflineplus">+      // kStructPhrase creates tags for plaintext-markup like *bold*,</span>
<a href="#l16.685"></a><span id="l16.685" class="difflineplus">+      // /italics/, etc. We always use this; the content filter will</span>
<a href="#l16.686"></a><span id="l16.686" class="difflineplus">+      // filter it out if the user does not want styling.</span>
<a href="#l16.687"></a><span id="l16.687" class="difflineplus">+      let csFlags = cs.kStructPhrase;</span>
<a href="#l16.688"></a><span id="l16.688" class="difflineplus">+      // Automatically find and link freetext URLs</span>
<a href="#l16.689"></a><span id="l16.689" class="difflineplus">+      if (!aMsg.noLinkification) {</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineplus">+        csFlags |= cs.kURLs;</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineplus">+      }</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineplus">+</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineplus">+      if (aFirstUnread) {</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineplus">+        this.setUnreadRuler();</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineplus">+      }</span>
<a href="#l16.696"></a><span id="l16.696" class="difflineplus">+</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineplus">+      // Right trim before displaying. This removes any OTR related</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineplus">+      // whitespace when the extension isn't enabled.</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineplus">+      let msg = aMsg.displayMessage.trimRight();</span>
<a href="#l16.700"></a><span id="l16.700" class="difflineplus">+</span>
<a href="#l16.701"></a><span id="l16.701" class="difflineplus">+      // The slash of a leading '/me' should not be used to</span>
<a href="#l16.702"></a><span id="l16.702" class="difflineplus">+      // format as italic, so we remove the '/me' text before</span>
<a href="#l16.703"></a><span id="l16.703" class="difflineplus">+      // scanning the HTML, and we add it back later.</span>
<a href="#l16.704"></a><span id="l16.704" class="difflineplus">+      let meRegExp = /^((&lt;[^&gt;]+&gt;)*)\/me /;</span>
<a href="#l16.705"></a><span id="l16.705" class="difflineplus">+      let me = false;</span>
<a href="#l16.706"></a><span id="l16.706" class="difflineplus">+      if (meRegExp.test(msg)) {</span>
<a href="#l16.707"></a><span id="l16.707" class="difflineplus">+        me = true;</span>
<a href="#l16.708"></a><span id="l16.708" class="difflineplus">+        msg = msg.replace(meRegExp, &quot;$1&quot;);</span>
<a href="#l16.709"></a><span id="l16.709" class="difflineplus">+      }</span>
<a href="#l16.710"></a><span id="l16.710" class="difflineplus">+</span>
<a href="#l16.711"></a><span id="l16.711" class="difflineplus">+      msg = cs</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineplus">+        .scanHTML(msg.replace(/&amp;/g, &quot;FROM-DTD-amp&quot;), csFlags)</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineplus">+        .replace(/FROM-DTD-amp/g, &quot;&amp;&quot;);</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineplus">+</span>
<a href="#l16.715"></a><span id="l16.715" class="difflineplus">+      if (me) {</span>
<a href="#l16.716"></a><span id="l16.716" class="difflineplus">+        msg = msg.replace(/^((&lt;[^&gt;]+&gt;)*)/, &quot;$1/me &quot;);</span>
<a href="#l16.717"></a><span id="l16.717" class="difflineplus">+      }</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineplus">+</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineplus">+      aMsg.message = cleanupImMarkup(</span>
<a href="#l16.720"></a><span id="l16.720" class="difflineplus">+        msg.replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;),</span>
<a href="#l16.721"></a><span id="l16.721" class="difflineplus">+        null,</span>
<a href="#l16.722"></a><span id="l16.722" class="difflineplus">+        this._textModifiers</span>
<a href="#l16.723"></a><span id="l16.723" class="difflineplus">+      );</span>
<a href="#l16.724"></a><span id="l16.724" class="difflineplus">+</span>
<a href="#l16.725"></a><span id="l16.725" class="difflineplus">+      let next =</span>
<a href="#l16.726"></a><span id="l16.726" class="difflineplus">+        (aContext == this._lastMessageIsContext || aMsg.system) &amp;&amp;</span>
<a href="#l16.727"></a><span id="l16.727" class="difflineplus">+        isNextMessage(this.theme, aMsg, this._lastMessage);</span>
<a href="#l16.728"></a><span id="l16.728" class="difflineplus">+      let newElt;</span>
<a href="#l16.729"></a><span id="l16.729" class="difflineplus">+      if (next &amp;&amp; aFirstUnread) {</span>
<a href="#l16.730"></a><span id="l16.730" class="difflineplus">+        // If there wasn't an unread ruler, this would be a Next message.</span>
<a href="#l16.731"></a><span id="l16.731" class="difflineplus">+        // Therefore, save that version for later.</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineplus">+        let html = getHTMLForMessage(aMsg, this.theme, next, aContext);</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineplus">+        let ruler = doc.getElementById(&quot;unread-ruler&quot;);</span>
<a href="#l16.734"></a><span id="l16.734" class="difflineplus">+        ruler.nextMsgHtml = html;</span>
<a href="#l16.735"></a><span id="l16.735" class="difflineplus">+        ruler._originalMsg = aMsg;</span>
<a href="#l16.736"></a><span id="l16.736" class="difflineplus">+</span>
<a href="#l16.737"></a><span id="l16.737" class="difflineplus">+        // Remember where the Next message(s) would have gone.</span>
<a href="#l16.738"></a><span id="l16.738" class="difflineplus">+        let insert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineplus">+        if (!insert) {</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineplus">+          insert = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineplus">+          ruler.parentNode.insertBefore(insert, ruler);</span>
<a href="#l16.742"></a><span id="l16.742">         }</span>
<a href="#l16.743"></a><span id="l16.743" class="difflineminus">-        case KeyEvent.DOM_VK_HOME: {</span>
<a href="#l16.744"></a><span id="l16.744" class="difflineminus">-          this.scrollToPreviousSection();</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineminus">-          event.preventDefault();</span>
<a href="#l16.746"></a><span id="l16.746" class="difflineminus">-          break;</span>
<a href="#l16.747"></a><span id="l16.747" class="difflineplus">+        insert.id = &quot;insert-before&quot;;</span>
<a href="#l16.748"></a><span id="l16.748" class="difflineplus">+</span>
<a href="#l16.749"></a><span id="l16.749" class="difflineplus">+        next = false;</span>
<a href="#l16.750"></a><span id="l16.750" class="difflineplus">+        html = getHTMLForMessage(aMsg, this.theme, next, aContext);</span>
<a href="#l16.751"></a><span id="l16.751" class="difflineplus">+        newElt = insertHTMLForMessage(aMsg, html, doc, next);</span>
<a href="#l16.752"></a><span id="l16.752" class="difflineplus">+        let marker = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.753"></a><span id="l16.753" class="difflineplus">+        marker.id = &quot;end-of-split-block&quot;;</span>
<a href="#l16.754"></a><span id="l16.754" class="difflineplus">+        newElt.parentNode.appendChild(marker);</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineplus">+</span>
<a href="#l16.756"></a><span id="l16.756" class="difflineplus">+        // Bracket the place where additional Next messages will be added,</span>
<a href="#l16.757"></a><span id="l16.757" class="difflineplus">+        // if that's not after the end-of-split-block element.</span>
<a href="#l16.758"></a><span id="l16.758" class="difflineplus">+        insert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.759"></a><span id="l16.759" class="difflineplus">+        if (insert) {</span>
<a href="#l16.760"></a><span id="l16.760" class="difflineplus">+          marker = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.761"></a><span id="l16.761" class="difflineplus">+          marker.id = &quot;next-messages-start&quot;;</span>
<a href="#l16.762"></a><span id="l16.762" class="difflineplus">+          insert.parentNode.insertBefore(marker, insert);</span>
<a href="#l16.763"></a><span id="l16.763" class="difflineplus">+          marker = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.764"></a><span id="l16.764" class="difflineplus">+          marker.id = &quot;next-messages-end&quot;;</span>
<a href="#l16.765"></a><span id="l16.765" class="difflineplus">+          insert.parentNode.insertBefore(marker, insert.nextSibling);</span>
<a href="#l16.766"></a><span id="l16.766" class="difflineplus">+        }</span>
<a href="#l16.767"></a><span id="l16.767" class="difflineplus">+      } else {</span>
<a href="#l16.768"></a><span id="l16.768" class="difflineplus">+        let html = getHTMLForMessage(aMsg, this.theme, next, aContext);</span>
<a href="#l16.769"></a><span id="l16.769" class="difflineplus">+        newElt = insertHTMLForMessage(aMsg, html, doc, next);</span>
<a href="#l16.770"></a><span id="l16.770" class="difflineplus">+      }</span>
<a href="#l16.771"></a><span id="l16.771" class="difflineplus">+</span>
<a href="#l16.772"></a><span id="l16.772" class="difflineplus">+      if (!aNoAutoScroll) {</span>
<a href="#l16.773"></a><span id="l16.773" class="difflineplus">+        newElt.getBoundingClientRect(); // avoid ireflow bugs</span>
<a href="#l16.774"></a><span id="l16.774" class="difflineplus">+        if (this.convScrollEnabled()) {</span>
<a href="#l16.775"></a><span id="l16.775" class="difflineplus">+          this._scrollToElement(newElt);</span>
<a href="#l16.776"></a><span id="l16.776" class="difflineplus">+        }</span>
<a href="#l16.777"></a><span id="l16.777" class="difflineplus">+      }</span>
<a href="#l16.778"></a><span id="l16.778" class="difflineplus">+      this._lastElement = newElt;</span>
<a href="#l16.779"></a><span id="l16.779" class="difflineplus">+      this._lastMessage = aMsg;</span>
<a href="#l16.780"></a><span id="l16.780" class="difflineplus">+      if (!aContext &amp;&amp; !this._firstNonContextElt &amp;&amp; !aMsg.system) {</span>
<a href="#l16.781"></a><span id="l16.781" class="difflineplus">+        this._firstNonContextElt = newElt;</span>
<a href="#l16.782"></a><span id="l16.782" class="difflineplus">+      }</span>
<a href="#l16.783"></a><span id="l16.783" class="difflineplus">+      this._lastMessageIsContext = aContext;</span>
<a href="#l16.784"></a><span id="l16.784" class="difflineplus">+    }</span>
<a href="#l16.785"></a><span id="l16.785" class="difflineplus">+</span>
<a href="#l16.786"></a><span id="l16.786" class="difflineplus">+    setUnreadRuler() {</span>
<a href="#l16.787"></a><span id="l16.787" class="difflineplus">+      // Remove any existing ruler (occurs when the window has lost focus).</span>
<a href="#l16.788"></a><span id="l16.788" class="difflineplus">+      this.removeUnreadRuler();</span>
<a href="#l16.789"></a><span id="l16.789" class="difflineplus">+</span>
<a href="#l16.790"></a><span id="l16.790" class="difflineplus">+      let ruler = this.contentDocument.createElement(&quot;hr&quot;);</span>
<a href="#l16.791"></a><span id="l16.791" class="difflineplus">+      ruler.id = &quot;unread-ruler&quot;;</span>
<a href="#l16.792"></a><span id="l16.792" class="difflineplus">+      this.contentChatNode.appendChild(ruler);</span>
<a href="#l16.793"></a><span id="l16.793" class="difflineplus">+    }</span>
<a href="#l16.794"></a><span id="l16.794" class="difflineplus">+</span>
<a href="#l16.795"></a><span id="l16.795" class="difflineplus">+    removeUnreadRuler() {</span>
<a href="#l16.796"></a><span id="l16.796" class="difflineplus">+      let doc = this.contentDocument;</span>
<a href="#l16.797"></a><span id="l16.797" class="difflineplus">+      let ruler = doc.getElementById(&quot;unread-ruler&quot;);</span>
<a href="#l16.798"></a><span id="l16.798" class="difflineplus">+      if (!ruler) {</span>
<a href="#l16.799"></a><span id="l16.799" class="difflineplus">+        return;</span>
<a href="#l16.800"></a><span id="l16.800" class="difflineplus">+      }</span>
<a href="#l16.801"></a><span id="l16.801" class="difflineplus">+</span>
<a href="#l16.802"></a><span id="l16.802" class="difflineplus">+      // If a message block was split by the ruler, rejoin it.</span>
<a href="#l16.803"></a><span id="l16.803" class="difflineplus">+      let moveTo = doc.getElementById(&quot;insert-before&quot;);</span>
<a href="#l16.804"></a><span id="l16.804" class="difflineplus">+      if (moveTo) {</span>
<a href="#l16.805"></a><span id="l16.805" class="difflineplus">+        // Protect an existing insert node.</span>
<a href="#l16.806"></a><span id="l16.806" class="difflineplus">+        let actualInsert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.807"></a><span id="l16.807" class="difflineplus">+        if (actualInsert) {</span>
<a href="#l16.808"></a><span id="l16.808" class="difflineplus">+          actualInsert.id = &quot;actual-insert&quot;;</span>
<a href="#l16.809"></a><span id="l16.809">         }</span>
<a href="#l16.810"></a><span id="l16.810" class="difflineminus">-        case KeyEvent.DOM_VK_END: {</span>
<a href="#l16.811"></a><span id="l16.811" class="difflineminus">-          this.scrollToNextSection();</span>
<a href="#l16.812"></a><span id="l16.812" class="difflineminus">-          event.preventDefault();</span>
<a href="#l16.813"></a><span id="l16.813" class="difflineplus">+</span>
<a href="#l16.814"></a><span id="l16.814" class="difflineplus">+        // Add first message following the ruler as a Next type message.</span>
<a href="#l16.815"></a><span id="l16.815" class="difflineplus">+        // Replicates the relevant parts of insertHTMLForMessage().</span>
<a href="#l16.816"></a><span id="l16.816" class="difflineplus">+        let range = doc.createRange();</span>
<a href="#l16.817"></a><span id="l16.817" class="difflineplus">+        let moveToParent = moveTo.parentNode;</span>
<a href="#l16.818"></a><span id="l16.818" class="difflineplus">+        range.selectNode(moveToParent);</span>
<a href="#l16.819"></a><span id="l16.819" class="difflineplus">+        // eslint-disable-next-line no-unsanitized/method</span>
<a href="#l16.820"></a><span id="l16.820" class="difflineplus">+        let documentFragment = range.createContextualFragment(</span>
<a href="#l16.821"></a><span id="l16.821" class="difflineplus">+          ruler.nextMsgHtml</span>
<a href="#l16.822"></a><span id="l16.822" class="difflineplus">+        );</span>
<a href="#l16.823"></a><span id="l16.823" class="difflineplus">+        for (</span>
<a href="#l16.824"></a><span id="l16.824" class="difflineplus">+          let root = documentFragment.firstChild;</span>
<a href="#l16.825"></a><span id="l16.825" class="difflineplus">+          root;</span>
<a href="#l16.826"></a><span id="l16.826" class="difflineplus">+          root = root.nextSibling</span>
<a href="#l16.827"></a><span id="l16.827" class="difflineplus">+        ) {</span>
<a href="#l16.828"></a><span id="l16.828" class="difflineplus">+          root._originalMsg = ruler._originalMsg;</span>
<a href="#l16.829"></a><span id="l16.829" class="difflineplus">+        }</span>
<a href="#l16.830"></a><span id="l16.830" class="difflineplus">+        moveToParent.insertBefore(documentFragment, moveTo);</span>
<a href="#l16.831"></a><span id="l16.831" class="difflineplus">+</span>
<a href="#l16.832"></a><span id="l16.832" class="difflineplus">+        // If this added an insert node, insert the next messages there.</span>
<a href="#l16.833"></a><span id="l16.833" class="difflineplus">+        let insert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.834"></a><span id="l16.834" class="difflineplus">+        if (insert) {</span>
<a href="#l16.835"></a><span id="l16.835" class="difflineplus">+          moveTo.remove();</span>
<a href="#l16.836"></a><span id="l16.836" class="difflineplus">+          moveTo = insert;</span>
<a href="#l16.837"></a><span id="l16.837" class="difflineplus">+          moveToParent = moveTo.parentNode;</span>
<a href="#l16.838"></a><span id="l16.838" class="difflineplus">+        }</span>
<a href="#l16.839"></a><span id="l16.839" class="difflineplus">+</span>
<a href="#l16.840"></a><span id="l16.840" class="difflineplus">+        // Move remaining messages from the message block following the ruler.</span>
<a href="#l16.841"></a><span id="l16.841" class="difflineplus">+        let nextMessagesStart = doc.getElementById(&quot;next-messages-start&quot;);</span>
<a href="#l16.842"></a><span id="l16.842" class="difflineplus">+        if (nextMessagesStart) {</span>
<a href="#l16.843"></a><span id="l16.843" class="difflineplus">+          range = doc.createRange();</span>
<a href="#l16.844"></a><span id="l16.844" class="difflineplus">+          range.setStartAfter(nextMessagesStart);</span>
<a href="#l16.845"></a><span id="l16.845" class="difflineplus">+          range.setEndBefore(doc.getElementById(&quot;next-messages-end&quot;));</span>
<a href="#l16.846"></a><span id="l16.846" class="difflineplus">+          moveToParent.insertBefore(range.extractContents(), moveTo);</span>
<a href="#l16.847"></a><span id="l16.847" class="difflineplus">+        }</span>
<a href="#l16.848"></a><span id="l16.848" class="difflineplus">+        moveTo.remove();</span>
<a href="#l16.849"></a><span id="l16.849" class="difflineplus">+</span>
<a href="#l16.850"></a><span id="l16.850" class="difflineplus">+        // Restore existing insert node.</span>
<a href="#l16.851"></a><span id="l16.851" class="difflineplus">+        if (actualInsert) {</span>
<a href="#l16.852"></a><span id="l16.852" class="difflineplus">+          actualInsert.id = &quot;insert&quot;;</span>
<a href="#l16.853"></a><span id="l16.853" class="difflineplus">+        }</span>
<a href="#l16.854"></a><span id="l16.854" class="difflineplus">+</span>
<a href="#l16.855"></a><span id="l16.855" class="difflineplus">+        // Delete surplus message block.</span>
<a href="#l16.856"></a><span id="l16.856" class="difflineplus">+        range = doc.createRange();</span>
<a href="#l16.857"></a><span id="l16.857" class="difflineplus">+        range.setStartAfter(ruler);</span>
<a href="#l16.858"></a><span id="l16.858" class="difflineplus">+        range.setEndAfter(doc.getElementById(&quot;end-of-split-block&quot;));</span>
<a href="#l16.859"></a><span id="l16.859" class="difflineplus">+        range.deleteContents();</span>
<a href="#l16.860"></a><span id="l16.860" class="difflineplus">+      }</span>
<a href="#l16.861"></a><span id="l16.861" class="difflineplus">+      ruler.remove();</span>
<a href="#l16.862"></a><span id="l16.862" class="difflineplus">+    }</span>
<a href="#l16.863"></a><span id="l16.863" class="difflineplus">+</span>
<a href="#l16.864"></a><span id="l16.864" class="difflineplus">+    _getSections() {</span>
<a href="#l16.865"></a><span id="l16.865" class="difflineplus">+      // If a section is displayed below this point, we assume not enough of</span>
<a href="#l16.866"></a><span id="l16.866" class="difflineplus">+      // it is visible, so we must scroll to it.</span>
<a href="#l16.867"></a><span id="l16.867" class="difflineplus">+      // The 3/4 constant is arbitrary, but it has to be greater than 1/2.</span>
<a href="#l16.868"></a><span id="l16.868" class="difflineplus">+      this._maximalSectionOffset = Math.round((this.clientHeight * 3) / 4);</span>
<a href="#l16.869"></a><span id="l16.869" class="difflineplus">+</span>
<a href="#l16.870"></a><span id="l16.870" class="difflineplus">+      // Get list of current section elements.</span>
<a href="#l16.871"></a><span id="l16.871" class="difflineplus">+      let sectionElements = [];</span>
<a href="#l16.872"></a><span id="l16.872" class="difflineplus">+      if (this._firstNonContextElt) {</span>
<a href="#l16.873"></a><span id="l16.873" class="difflineplus">+        sectionElements.push(this._firstNonContextElt);</span>
<a href="#l16.874"></a><span id="l16.874" class="difflineplus">+      }</span>
<a href="#l16.875"></a><span id="l16.875" class="difflineplus">+      let ruler = this.contentDocument.getElementById(&quot;unread-ruler&quot;);</span>
<a href="#l16.876"></a><span id="l16.876" class="difflineplus">+      if (ruler) {</span>
<a href="#l16.877"></a><span id="l16.877" class="difflineplus">+        sectionElements.push(ruler);</span>
<a href="#l16.878"></a><span id="l16.878" class="difflineplus">+      }</span>
<a href="#l16.879"></a><span id="l16.879" class="difflineplus">+      sectionElements = sectionElements.concat(this._sessions);</span>
<a href="#l16.880"></a><span id="l16.880" class="difflineplus">+</span>
<a href="#l16.881"></a><span id="l16.881" class="difflineplus">+      // Return ordered array of sections with entries</span>
<a href="#l16.882"></a><span id="l16.882" class="difflineplus">+      // [Y, scrollY such that Y is centered]</span>
<a href="#l16.883"></a><span id="l16.883" class="difflineplus">+      let sections = [];</span>
<a href="#l16.884"></a><span id="l16.884" class="difflineplus">+      let maxY = this.contentWindow.scrollMaxY;</span>
<a href="#l16.885"></a><span id="l16.885" class="difflineplus">+      for (let i = 0; i &lt; sectionElements.length; ++i) {</span>
<a href="#l16.886"></a><span id="l16.886" class="difflineplus">+        let y = sectionElements[i].offsetTop;</span>
<a href="#l16.887"></a><span id="l16.887" class="difflineplus">+        // The section is unnecessary if close to top/bottom of conversation.</span>
<a href="#l16.888"></a><span id="l16.888" class="difflineplus">+        if (y &lt; this._maximalSectionOffset || maxY &lt; y) {</span>
<a href="#l16.889"></a><span id="l16.889" class="difflineplus">+          continue;</span>
<a href="#l16.890"></a><span id="l16.890" class="difflineplus">+        }</span>
<a href="#l16.891"></a><span id="l16.891" class="difflineplus">+        sections.push([y, y - Math.round(this.clientHeight / 2)]);</span>
<a href="#l16.892"></a><span id="l16.892" class="difflineplus">+      }</span>
<a href="#l16.893"></a><span id="l16.893" class="difflineplus">+      sections.sort((a, b) =&gt; a[0] - b[0]);</span>
<a href="#l16.894"></a><span id="l16.894" class="difflineplus">+      return sections;</span>
<a href="#l16.895"></a><span id="l16.895" class="difflineplus">+    }</span>
<a href="#l16.896"></a><span id="l16.896" class="difflineplus">+</span>
<a href="#l16.897"></a><span id="l16.897" class="difflineplus">+    scrollToPreviousSection() {</span>
<a href="#l16.898"></a><span id="l16.898" class="difflineplus">+      let sections = this._getSections();</span>
<a href="#l16.899"></a><span id="l16.899" class="difflineplus">+      let y = this.contentWindow.scrollY;</span>
<a href="#l16.900"></a><span id="l16.900" class="difflineplus">+      let newY = 0;</span>
<a href="#l16.901"></a><span id="l16.901" class="difflineplus">+      for (let i = sections.length - 1; i &gt;= 0; --i) {</span>
<a href="#l16.902"></a><span id="l16.902" class="difflineplus">+        let section = sections[i];</span>
<a href="#l16.903"></a><span id="l16.903" class="difflineplus">+        if (y &gt; section[0]) {</span>
<a href="#l16.904"></a><span id="l16.904" class="difflineplus">+          newY = section[1];</span>
<a href="#l16.905"></a><span id="l16.905">           break;</span>
<a href="#l16.906"></a><span id="l16.906">         }</span>
<a href="#l16.907"></a><span id="l16.907">       }</span>
<a href="#l16.908"></a><span id="l16.908" class="difflineminus">-    });</span>
<a href="#l16.909"></a><span id="l16.909" class="difflineminus">-  }</span>
<a href="#l16.910"></a><span id="l16.910" class="difflineminus">-</span>
<a href="#l16.911"></a><span id="l16.911" class="difflineminus">-  connectedCallback() {</span>
<a href="#l16.912"></a><span id="l16.912" class="difflineminus">-    super.connectedCallback();</span>
<a href="#l16.913"></a><span id="l16.913" class="difflineminus">-</span>
<a href="#l16.914"></a><span id="l16.914" class="difflineminus">-    this._theme = null;</span>
<a href="#l16.915"></a><span id="l16.915" class="difflineminus">-</span>
<a href="#l16.916"></a><span id="l16.916" class="difflineminus">-    this._loadState = 0;</span>
<a href="#l16.917"></a><span id="l16.917" class="difflineminus">-</span>
<a href="#l16.918"></a><span id="l16.918" class="difflineminus">-    this.autoCopyEnabled = false;</span>
<a href="#l16.919"></a><span id="l16.919" class="difflineminus">-</span>
<a href="#l16.920"></a><span id="l16.920" class="difflineminus">-    this.magicCopyPref = &quot;messenger.conversations.selections.magicCopyEnabled&quot;;</span>
<a href="#l16.921"></a><span id="l16.921" class="difflineminus">-</span>
<a href="#l16.922"></a><span id="l16.922" class="difflineminus">-    this.magicCopyInitialized = false;</span>
<a href="#l16.923"></a><span id="l16.923" class="difflineminus">-</span>
<a href="#l16.924"></a><span id="l16.924" class="difflineminus">-    this._destroyed = false;</span>
<a href="#l16.925"></a><span id="l16.925" class="difflineminus">-</span>
<a href="#l16.926"></a><span id="l16.926" class="difflineminus">-    // Makes the chat browser scroll to the bottom automatically when we append</span>
<a href="#l16.927"></a><span id="l16.927" class="difflineminus">-    // a new message. This behavior gets disabled when the user scrolls up to</span>
<a href="#l16.928"></a><span id="l16.928" class="difflineminus">-    // look at the history, and we re-enable it when the user scrolls to</span>
<a href="#l16.929"></a><span id="l16.929" class="difflineminus">-    // (within 10px) of the bottom.</span>
<a href="#l16.930"></a><span id="l16.930" class="difflineminus">-    this._convScrollEnabled = true;</span>
<a href="#l16.931"></a><span id="l16.931" class="difflineminus">-</span>
<a href="#l16.932"></a><span id="l16.932" class="difflineminus">-    this._textModifiers = [smileTextNode];</span>
<a href="#l16.933"></a><span id="l16.933" class="difflineminus">-</span>
<a href="#l16.934"></a><span id="l16.934" class="difflineminus">-    // These variables are reset in onStateChange:</span>
<a href="#l16.935"></a><span id="l16.935" class="difflineminus">-    this._lastMessage = null;</span>
<a href="#l16.936"></a><span id="l16.936" class="difflineminus">-    this._lastMessageIsContext = true;</span>
<a href="#l16.937"></a><span id="l16.937" class="difflineminus">-    this._firstNonContextElt = null;</span>
<a href="#l16.938"></a><span id="l16.938" class="difflineminus">-    this._messageDisplayPending = false;</span>
<a href="#l16.939"></a><span id="l16.939" class="difflineminus">-    this._pendingMessages = [];</span>
<a href="#l16.940"></a><span id="l16.940" class="difflineminus">-    this._nextPendingMessageIndex = 0;</span>
<a href="#l16.941"></a><span id="l16.941" class="difflineminus">-    this._pendingMessagesDisplayed = 0;</span>
<a href="#l16.942"></a><span id="l16.942" class="difflineminus">-    this._displayPendingMessagesCalls = 0;</span>
<a href="#l16.943"></a><span id="l16.943" class="difflineminus">-    this._sessions = [];</span>
<a href="#l16.944"></a><span id="l16.944" class="difflineminus">-</span>
<a href="#l16.945"></a><span id="l16.945" class="difflineminus">-    this.progressBar = null;</span>
<a href="#l16.946"></a><span id="l16.946" class="difflineminus">-</span>
<a href="#l16.947"></a><span id="l16.947" class="difflineminus">-    this.addEventListener(&quot;scroll&quot;, this.browserScroll);</span>
<a href="#l16.948"></a><span id="l16.948" class="difflineminus">-    this.addEventListener(&quot;resize&quot;, this.browserResize);</span>
<a href="#l16.949"></a><span id="l16.949" class="difflineminus">-</span>
<a href="#l16.950"></a><span id="l16.950" class="difflineminus">-</span>
<a href="#l16.951"></a><span id="l16.951" class="difflineminus">-    // @implements {nsIObserver}</span>
<a href="#l16.952"></a><span id="l16.952" class="difflineminus">-    this.prefObserver = (subject, topic, data) =&gt; {</span>
<a href="#l16.953"></a><span id="l16.953" class="difflineminus">-      if (this.magicCopyEnabled) {</span>
<a href="#l16.954"></a><span id="l16.954" class="difflineminus">-        this.enableMagicCopy();</span>
<a href="#l16.955"></a><span id="l16.955" class="difflineminus">-      } else {</span>
<a href="#l16.956"></a><span id="l16.956" class="difflineminus">-        this.disableMagicCopy();</span>
<a href="#l16.957"></a><span id="l16.957" class="difflineminus">-      }</span>
<a href="#l16.958"></a><span id="l16.958" class="difflineminus">-    };</span>
<a href="#l16.959"></a><span id="l16.959" class="difflineminus">-</span>
<a href="#l16.960"></a><span id="l16.960" class="difflineminus">-    // @implements {nsIController}</span>
<a href="#l16.961"></a><span id="l16.961" class="difflineminus">-    this.copyController = {</span>
<a href="#l16.962"></a><span id="l16.962" class="difflineminus">-      supportsCommand(command) {</span>
<a href="#l16.963"></a><span id="l16.963" class="difflineminus">-        return command == &quot;cmd_copy&quot; || command == &quot;cmd_cut&quot;;</span>
<a href="#l16.964"></a><span id="l16.964" class="difflineminus">-      },</span>
<a href="#l16.965"></a><span id="l16.965" class="difflineminus">-      isCommandEnabled: command =&gt; {</span>
<a href="#l16.966"></a><span id="l16.966" class="difflineminus">-        return command == &quot;cmd_copy&quot; &amp;&amp;</span>
<a href="#l16.967"></a><span id="l16.967" class="difflineminus">-          !this.contentWindow.getSelection().isCollapsed;</span>
<a href="#l16.968"></a><span id="l16.968" class="difflineminus">-      },</span>
<a href="#l16.969"></a><span id="l16.969" class="difflineminus">-      doCommand: command =&gt; {</span>
<a href="#l16.970"></a><span id="l16.970" class="difflineminus">-        let selection = this.contentWindow.getSelection();</span>
<a href="#l16.971"></a><span id="l16.971" class="difflineminus">-        if (selection.isCollapsed)</span>
<a href="#l16.972"></a><span id="l16.972" class="difflineminus">-          return;</span>
<a href="#l16.973"></a><span id="l16.973" class="difflineminus">-</span>
<a href="#l16.974"></a><span id="l16.974" class="difflineminus">-        Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l16.975"></a><span id="l16.975" class="difflineminus">-          .getService(Ci.nsIClipboardHelper)</span>
<a href="#l16.976"></a><span id="l16.976" class="difflineminus">-          .copyString(serializeSelection(selection));</span>
<a href="#l16.977"></a><span id="l16.977" class="difflineminus">-      },</span>
<a href="#l16.978"></a><span id="l16.978" class="difflineminus">-      onEvent(command) { },</span>
<a href="#l16.979"></a><span id="l16.979" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsIController]),</span>
<a href="#l16.980"></a><span id="l16.980" class="difflineminus">-    };</span>
<a href="#l16.981"></a><span id="l16.981" class="difflineminus">-</span>
<a href="#l16.982"></a><span id="l16.982" class="difflineminus">-    // @implements {nsISelectionListener}</span>
<a href="#l16.983"></a><span id="l16.983" class="difflineminus">-    this.chatSelectionListener = {</span>
<a href="#l16.984"></a><span id="l16.984" class="difflineminus">-      notifySelectionChanged(document, selection, reason) {</span>
<a href="#l16.985"></a><span id="l16.985" class="difflineminus">-        if (!(reason &amp; Ci.nsISelectionListener.MOUSEUP_REASON ||</span>
<a href="#l16.986"></a><span id="l16.986" class="difflineminus">-              reason &amp; Ci.nsISelectionListener.SELECTALL_REASON ||</span>
<a href="#l16.987"></a><span id="l16.987" class="difflineminus">-              reason &amp; Ci.nsISelectionListener.KEYPRESS_REASON))</span>
<a href="#l16.988"></a><span id="l16.988" class="difflineminus">-          return; // we are still dragging, don't bother with the selection</span>
<a href="#l16.989"></a><span id="l16.989" class="difflineminus">-</span>
<a href="#l16.990"></a><span id="l16.990" class="difflineminus">-        Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l16.991"></a><span id="l16.991" class="difflineminus">-          .getService(Ci.nsIClipboardHelper)</span>
<a href="#l16.992"></a><span id="l16.992" class="difflineminus">-          .copyStringToClipboard(serializeSelection(selection),</span>
<a href="#l16.993"></a><span id="l16.993" class="difflineminus">-                                 Ci.nsIClipboard.kSelectionClipboard);</span>
<a href="#l16.994"></a><span id="l16.994" class="difflineminus">-      },</span>
<a href="#l16.995"></a><span id="l16.995" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsISelectionListener]),</span>
<a href="#l16.996"></a><span id="l16.996" class="difflineminus">-    };</span>
<a href="#l16.997"></a><span id="l16.997" class="difflineminus">-  }</span>
<a href="#l16.998"></a><span id="l16.998" class="difflineminus">-</span>
<a href="#l16.999"></a><span id="l16.999" class="difflineminus">-  init(conversation) {</span>
<a href="#l16.1000"></a><span id="l16.1000" class="difflineminus">-    // Magic Copy may be initialized if the convbrowser is already</span>
<a href="#l16.1001"></a><span id="l16.1001" class="difflineminus">-    // displaying a conversation.</span>
<a href="#l16.1002"></a><span id="l16.1002" class="difflineminus">-    this.uninitMagicCopy();</span>
<a href="#l16.1003"></a><span id="l16.1003" class="difflineminus">-</span>
<a href="#l16.1004"></a><span id="l16.1004" class="difflineminus">-    this._conv = conversation;</span>
<a href="#l16.1005"></a><span id="l16.1005" class="difflineminus">-</span>
<a href="#l16.1006"></a><span id="l16.1006" class="difflineminus">-    // init is called when the message style preview is</span>
<a href="#l16.1007"></a><span id="l16.1007" class="difflineminus">-    // reloaded so we need to reset _theme.</span>
<a href="#l16.1008"></a><span id="l16.1008" class="difflineminus">-    this._theme = null;</span>
<a href="#l16.1009"></a><span id="l16.1009" class="difflineminus">-</span>
<a href="#l16.1010"></a><span id="l16.1010" class="difflineminus">-    // Prevent ongoing asynchronous message display from continuing.</span>
<a href="#l16.1011"></a><span id="l16.1011" class="difflineminus">-    this._messageDisplayPending = false;</span>
<a href="#l16.1012"></a><span id="l16.1012" class="difflineminus">-</span>
<a href="#l16.1013"></a><span id="l16.1013" class="difflineminus">-    // _loadState is 0 while loading conv.html and 1 while</span>
<a href="#l16.1014"></a><span id="l16.1014" class="difflineminus">-    // loading the real conversation HTML.</span>
<a href="#l16.1015"></a><span id="l16.1015" class="difflineminus">-    this._loadState = 0;</span>
<a href="#l16.1016"></a><span id="l16.1016" class="difflineminus">-</span>
<a href="#l16.1017"></a><span id="l16.1017" class="difflineminus">-    this.docShell.charset = &quot;UTF-8&quot;;</span>
<a href="#l16.1018"></a><span id="l16.1018" class="difflineminus">-    const URI = &quot;chrome://chat/content/conv.html&quot;;</span>
<a href="#l16.1019"></a><span id="l16.1019" class="difflineminus">-    const loadURIOptions = {</span>
<a href="#l16.1020"></a><span id="l16.1020" class="difflineminus">-      triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l16.1021"></a><span id="l16.1021" class="difflineminus">-    };</span>
<a href="#l16.1022"></a><span id="l16.1022" class="difflineminus">-    this.webNavigation.loadURI(URI, loadURIOptions);</span>
<a href="#l16.1023"></a><span id="l16.1023" class="difflineminus">-    this.addProgressListener(this.progressListener);</span>
<a href="#l16.1024"></a><span id="l16.1024" class="difflineminus">-  }</span>
<a href="#l16.1025"></a><span id="l16.1025" class="difflineminus">-</span>
<a href="#l16.1026"></a><span id="l16.1026" class="difflineminus">-  get theme() {</span>
<a href="#l16.1027"></a><span id="l16.1027" class="difflineminus">-    return this._theme || (this._theme = getCurrentTheme());</span>
<a href="#l16.1028"></a><span id="l16.1028" class="difflineminus">-  }</span>
<a href="#l16.1029"></a><span id="l16.1029" class="difflineminus">-</span>
<a href="#l16.1030"></a><span id="l16.1030" class="difflineminus">-  get contentDocument() {</span>
<a href="#l16.1031"></a><span id="l16.1031" class="difflineminus">-    return this.webNavigation.document;</span>
<a href="#l16.1032"></a><span id="l16.1032" class="difflineminus">-  }</span>
<a href="#l16.1033"></a><span id="l16.1033" class="difflineminus">-</span>
<a href="#l16.1034"></a><span id="l16.1034" class="difflineminus">-  get contentChatNode() {</span>
<a href="#l16.1035"></a><span id="l16.1035" class="difflineminus">-    return this.contentDocument.getElementById(&quot;Chat&quot;);</span>
<a href="#l16.1036"></a><span id="l16.1036" class="difflineminus">-  }</span>
<a href="#l16.1037"></a><span id="l16.1037" class="difflineplus">+      this.contentWindow.scrollTo(0, newY);</span>
<a href="#l16.1038"></a><span id="l16.1038" class="difflineplus">+    }</span>
<a href="#l16.1039"></a><span id="l16.1039"> </span>
<a href="#l16.1040"></a><span id="l16.1040" class="difflineminus">-  get magicCopyEnabled() {</span>
<a href="#l16.1041"></a><span id="l16.1041" class="difflineminus">-    return Services.prefs.getBoolPref(this.magicCopyPref);</span>
<a href="#l16.1042"></a><span id="l16.1042" class="difflineminus">-  }</span>
<a href="#l16.1043"></a><span id="l16.1043" class="difflineminus">-</span>
<a href="#l16.1044"></a><span id="l16.1044" class="difflineminus">-  enableMagicCopy() {</span>
<a href="#l16.1045"></a><span id="l16.1045" class="difflineminus">-    this.contentWindow.controllers.insertControllerAt(0, this.copyController);</span>
<a href="#l16.1046"></a><span id="l16.1046" class="difflineminus">-    this.autoCopyEnabled = Services.clipboard.supportsSelectionClipboard() &amp;&amp;</span>
<a href="#l16.1047"></a><span id="l16.1047" class="difflineminus">-      Services.prefs.getBoolPref(&quot;clipboard.autocopy&quot;);</span>
<a href="#l16.1048"></a><span id="l16.1048" class="difflineminus">-    if (this.autoCopyEnabled) {</span>
<a href="#l16.1049"></a><span id="l16.1049" class="difflineminus">-      this.contentWindow.getSelection().addSelectionListener(this.chatSelectionListener);</span>
<a href="#l16.1050"></a><span id="l16.1050" class="difflineminus">-    }</span>
<a href="#l16.1051"></a><span id="l16.1051" class="difflineminus">-  }</span>
<a href="#l16.1052"></a><span id="l16.1052" class="difflineminus">-</span>
<a href="#l16.1053"></a><span id="l16.1053" class="difflineminus">-  disableMagicCopy() {</span>
<a href="#l16.1054"></a><span id="l16.1054" class="difflineminus">-    this.contentWindow.controllers.removeController(this.copyController);</span>
<a href="#l16.1055"></a><span id="l16.1055" class="difflineminus">-    if (this.autoCopyEnabled) {</span>
<a href="#l16.1056"></a><span id="l16.1056" class="difflineminus">-      this.contentWindow.getSelection().removeSelectionListener(this.chatSelectionListener);</span>
<a href="#l16.1057"></a><span id="l16.1057" class="difflineminus">-    }</span>
<a href="#l16.1058"></a><span id="l16.1058" class="difflineminus">-  }</span>
<a href="#l16.1059"></a><span id="l16.1059" class="difflineminus">-</span>
<a href="#l16.1060"></a><span id="l16.1060" class="difflineminus">-  initMagicCopy() {</span>
<a href="#l16.1061"></a><span id="l16.1061" class="difflineminus">-    if (this.magicCopyInitialized)</span>
<a href="#l16.1062"></a><span id="l16.1062" class="difflineminus">-      return;</span>
<a href="#l16.1063"></a><span id="l16.1063" class="difflineminus">-    Services.prefs.addObserver(this.magicCopyPref, this.prefObserver);</span>
<a href="#l16.1064"></a><span id="l16.1064" class="difflineminus">-    this.magicCopyInitialized = true;</span>
<a href="#l16.1065"></a><span id="l16.1065" class="difflineminus">-    if (this.magicCopyEnabled)</span>
<a href="#l16.1066"></a><span id="l16.1066" class="difflineminus">-      this.enableMagicCopy();</span>
<a href="#l16.1067"></a><span id="l16.1067" class="difflineminus">-  }</span>
<a href="#l16.1068"></a><span id="l16.1068" class="difflineminus">-</span>
<a href="#l16.1069"></a><span id="l16.1069" class="difflineminus">-  uninitMagicCopy() {</span>
<a href="#l16.1070"></a><span id="l16.1070" class="difflineminus">-    if (!this.magicCopyInitialized)</span>
<a href="#l16.1071"></a><span id="l16.1071" class="difflineminus">-      return;</span>
<a href="#l16.1072"></a><span id="l16.1072" class="difflineminus">-    Services.prefs.removeObserver(this.magicCopyPref, this.prefObserver);</span>
<a href="#l16.1073"></a><span id="l16.1073" class="difflineminus">-    if (this.magicCopyEnabled)</span>
<a href="#l16.1074"></a><span id="l16.1074" class="difflineminus">-      this.disableMagicCopy();</span>
<a href="#l16.1075"></a><span id="l16.1075" class="difflineminus">-    this.magicCopyInitialized = false;</span>
<a href="#l16.1076"></a><span id="l16.1076" class="difflineminus">-  }</span>
<a href="#l16.1077"></a><span id="l16.1077" class="difflineminus">-</span>
<a href="#l16.1078"></a><span id="l16.1078" class="difflineminus">-  destroy() {</span>
<a href="#l16.1079"></a><span id="l16.1079" class="difflineminus">-    super.destroy();</span>
<a href="#l16.1080"></a><span id="l16.1080" class="difflineminus">-    if (this._destroyed)</span>
<a href="#l16.1081"></a><span id="l16.1081" class="difflineminus">-      return;</span>
<a href="#l16.1082"></a><span id="l16.1082" class="difflineminus">-    this._destroyed = true;</span>
<a href="#l16.1083"></a><span id="l16.1083" class="difflineminus">-    this._messageDisplayPending = false;</span>
<a href="#l16.1084"></a><span id="l16.1084" class="difflineminus">-</span>
<a href="#l16.1085"></a><span id="l16.1085" class="difflineminus">-    this.uninitMagicCopy();</span>
<a href="#l16.1086"></a><span id="l16.1086" class="difflineminus">-</span>
<a href="#l16.1087"></a><span id="l16.1087" class="difflineminus">-    if (this.contentChatNode) {</span>
<a href="#l16.1088"></a><span id="l16.1088" class="difflineminus">-      // Remove the listener only if the conversation was initialized.</span>
<a href="#l16.1089"></a><span id="l16.1089" class="difflineminus">-      this.contentChatNode</span>
<a href="#l16.1090"></a><span id="l16.1090" class="difflineminus">-          .removeEventListener(&quot;load&quot;, this.onChatNodeContentLoad, true);</span>
<a href="#l16.1091"></a><span id="l16.1091" class="difflineminus">-    }</span>
<a href="#l16.1092"></a><span id="l16.1092" class="difflineminus">-  }</span>
<a href="#l16.1093"></a><span id="l16.1093" class="difflineminus">-</span>
<a href="#l16.1094"></a><span id="l16.1094" class="difflineminus">-  _updateConvScrollEnabled() {</span>
<a href="#l16.1095"></a><span id="l16.1095" class="difflineminus">-    // Enable auto-scroll if the scrollbar is at the bottom.</span>
<a href="#l16.1096"></a><span id="l16.1096" class="difflineminus">-    let body = this.contentDocument.querySelector(&quot;body&quot;);</span>
<a href="#l16.1097"></a><span id="l16.1097" class="difflineminus">-    this._convScrollEnabled =</span>
<a href="#l16.1098"></a><span id="l16.1098" class="difflineminus">-      body.scrollHeight &lt;= body.scrollTop + body.clientHeight + 10;</span>
<a href="#l16.1099"></a><span id="l16.1099" class="difflineminus">-    return this._convScrollEnabled;</span>
<a href="#l16.1100"></a><span id="l16.1100" class="difflineminus">-  }</span>
<a href="#l16.1101"></a><span id="l16.1101" class="difflineminus">-</span>
<a href="#l16.1102"></a><span id="l16.1102" class="difflineminus">-  convScrollEnabled() {</span>
<a href="#l16.1103"></a><span id="l16.1103" class="difflineminus">-    return this._convScrollEnabled || this._updateConvScrollEnabled();</span>
<a href="#l16.1104"></a><span id="l16.1104" class="difflineminus">-  }</span>
<a href="#l16.1105"></a><span id="l16.1105" class="difflineminus">-</span>
<a href="#l16.1106"></a><span id="l16.1106" class="difflineminus">-  _scrollToElement(aElt) {</span>
<a href="#l16.1107"></a><span id="l16.1107" class="difflineminus">-    aElt.scrollIntoView(true);</span>
<a href="#l16.1108"></a><span id="l16.1108" class="difflineminus">-    this._scrollingIntoView = true;</span>
<a href="#l16.1109"></a><span id="l16.1109" class="difflineminus">-  }</span>
<a href="#l16.1110"></a><span id="l16.1110" class="difflineminus">-</span>
<a href="#l16.1111"></a><span id="l16.1111" class="difflineminus">-  _exposeMethodsToContent() {</span>
<a href="#l16.1112"></a><span id="l16.1112" class="difflineminus">-    // Expose scrollToElement and convScrollEnabled to the message styles.</span>
<a href="#l16.1113"></a><span id="l16.1113" class="difflineminus">-    this.contentWindow.scrollToElement = this._scrollToElement.bind(this);</span>
<a href="#l16.1114"></a><span id="l16.1114" class="difflineminus">-    this.contentWindow.convScrollEnabled = this.convScrollEnabled.bind(this);</span>
<a href="#l16.1115"></a><span id="l16.1115" class="difflineminus">-  }</span>
<a href="#l16.1116"></a><span id="l16.1116" class="difflineminus">-</span>
<a href="#l16.1117"></a><span id="l16.1117" class="difflineminus">-  addTextModifier(aModifier) {</span>
<a href="#l16.1118"></a><span id="l16.1118" class="difflineminus">-    if (!this._textModifiers.includes(aModifier))</span>
<a href="#l16.1119"></a><span id="l16.1119" class="difflineminus">-      this._textModifiers.push(aModifier);</span>
<a href="#l16.1120"></a><span id="l16.1120" class="difflineminus">-  }</span>
<a href="#l16.1121"></a><span id="l16.1121" class="difflineminus">-</span>
<a href="#l16.1122"></a><span id="l16.1122" class="difflineminus">-  set isActive(value) {</span>
<a href="#l16.1123"></a><span id="l16.1123" class="difflineminus">-    this.docShell.isActive = value;</span>
<a href="#l16.1124"></a><span id="l16.1124" class="difflineminus">-    if (value &amp;&amp; this._pendingMessages.length)</span>
<a href="#l16.1125"></a><span id="l16.1125" class="difflineminus">-      this.startDisplayingPendingMessages(false);</span>
<a href="#l16.1126"></a><span id="l16.1126" class="difflineminus">-  }</span>
<a href="#l16.1127"></a><span id="l16.1127" class="difflineminus">-</span>
<a href="#l16.1128"></a><span id="l16.1128" class="difflineminus">-  appendMessage(aMsg, aContext, aFirstUnread) {</span>
<a href="#l16.1129"></a><span id="l16.1129" class="difflineminus">-    this._pendingMessages.push({</span>
<a href="#l16.1130"></a><span id="l16.1130" class="difflineminus">-      msg: aMsg,</span>
<a href="#l16.1131"></a><span id="l16.1131" class="difflineminus">-      context: aContext,</span>
<a href="#l16.1132"></a><span id="l16.1132" class="difflineminus">-      firstUnread: aFirstUnread,</span>
<a href="#l16.1133"></a><span id="l16.1133" class="difflineminus">-    });</span>
<a href="#l16.1134"></a><span id="l16.1134" class="difflineminus">-    if (this.docShell.isActive)</span>
<a href="#l16.1135"></a><span id="l16.1135" class="difflineminus">-      this.startDisplayingPendingMessages(true);</span>
<a href="#l16.1136"></a><span id="l16.1136" class="difflineminus">-  }</span>
<a href="#l16.1137"></a><span id="l16.1137" class="difflineminus">-</span>
<a href="#l16.1138"></a><span id="l16.1138" class="difflineminus">-  startDisplayingPendingMessages(delayed) {</span>
<a href="#l16.1139"></a><span id="l16.1139" class="difflineminus">-    if (this._messageDisplayPending)</span>
<a href="#l16.1140"></a><span id="l16.1140" class="difflineminus">-      return;</span>
<a href="#l16.1141"></a><span id="l16.1141" class="difflineminus">-    this._messageDisplayPending = true;</span>
<a href="#l16.1142"></a><span id="l16.1142" class="difflineminus">-    this.contentWindow.messageInsertPending = true;</span>
<a href="#l16.1143"></a><span id="l16.1143" class="difflineminus">-    if (delayed) {</span>
<a href="#l16.1144"></a><span id="l16.1144" class="difflineminus">-      requestIdleCallback(this.displayPendingMessages.bind(this));</span>
<a href="#l16.1145"></a><span id="l16.1145" class="difflineminus">-    } else {</span>
<a href="#l16.1146"></a><span id="l16.1146" class="difflineminus">-      // 200ms here is a generous amount of time. The conversation switch</span>
<a href="#l16.1147"></a><span id="l16.1147" class="difflineminus">-      // should take no more than 100ms to feel 'immediate', but the perceived</span>
<a href="#l16.1148"></a><span id="l16.1148" class="difflineminus">-      // performance if we flicker is likely even worse than having a barely</span>
<a href="#l16.1149"></a><span id="l16.1149" class="difflineminus">-      // perceptible delay.</span>
<a href="#l16.1150"></a><span id="l16.1150" class="difflineminus">-      let deadline = Cu.now() + 200;</span>
<a href="#l16.1151"></a><span id="l16.1151" class="difflineminus">-      this.displayPendingMessages({</span>
<a href="#l16.1152"></a><span id="l16.1152" class="difflineminus">-        timeRemaining() {</span>
<a href="#l16.1153"></a><span id="l16.1153" class="difflineminus">-          return deadline - Cu.now();</span>
<a href="#l16.1154"></a><span id="l16.1154" class="difflineminus">-        },</span>
<a href="#l16.1155"></a><span id="l16.1155" class="difflineminus">-      });</span>
<a href="#l16.1156"></a><span id="l16.1156" class="difflineminus">-    }</span>
<a href="#l16.1157"></a><span id="l16.1157" class="difflineminus">-  }</span>
<a href="#l16.1158"></a><span id="l16.1158" class="difflineminus">-</span>
<a href="#l16.1159"></a><span id="l16.1159" class="difflineminus">-  // getNextPendingMessage and getPendingMessagesCount are the</span>
<a href="#l16.1160"></a><span id="l16.1160" class="difflineminus">-  // only 2 methods accessing the this._pendingMessages array</span>
<a href="#l16.1161"></a><span id="l16.1161" class="difflineminus">-  // directly during the chunked display of messages. It is</span>
<a href="#l16.1162"></a><span id="l16.1162" class="difflineminus">-  // possible to override these 2 methods to replace the array</span>
<a href="#l16.1163"></a><span id="l16.1163" class="difflineminus">-  // with something else. The log viewer for example uses an</span>
<a href="#l16.1164"></a><span id="l16.1164" class="difflineminus">-  // enumerator that creates message objects lazily to avoid</span>
<a href="#l16.1165"></a><span id="l16.1165" class="difflineminus">-  // jank when displaying lots of messages.</span>
<a href="#l16.1166"></a><span id="l16.1166" class="difflineminus">-  getNextPendingMessage() {</span>
<a href="#l16.1167"></a><span id="l16.1167" class="difflineminus">-    let length = this._pendingMessages.length;</span>
<a href="#l16.1168"></a><span id="l16.1168" class="difflineminus">-    if (this._nextPendingMessageIndex == length)</span>
<a href="#l16.1169"></a><span id="l16.1169" class="difflineminus">-      return null;</span>
<a href="#l16.1170"></a><span id="l16.1170" class="difflineminus">-</span>
<a href="#l16.1171"></a><span id="l16.1171" class="difflineminus">-    let result = this._pendingMessages[this._nextPendingMessageIndex++];</span>
<a href="#l16.1172"></a><span id="l16.1172" class="difflineminus">-</span>
<a href="#l16.1173"></a><span id="l16.1173" class="difflineminus">-    if (this._nextPendingMessageIndex == length) {</span>
<a href="#l16.1174"></a><span id="l16.1174" class="difflineminus">-      this._pendingMessages = [];</span>
<a href="#l16.1175"></a><span id="l16.1175" class="difflineminus">-      this._nextPendingMessageIndex = 0;</span>
<a href="#l16.1176"></a><span id="l16.1176" class="difflineplus">+    scrollToNextSection() {</span>
<a href="#l16.1177"></a><span id="l16.1177" class="difflineplus">+      let sections = this._getSections();</span>
<a href="#l16.1178"></a><span id="l16.1178" class="difflineplus">+      let y = this.contentWindow.scrollY;</span>
<a href="#l16.1179"></a><span id="l16.1179" class="difflineplus">+      let newY = this.contentWindow.scrollMaxY;</span>
<a href="#l16.1180"></a><span id="l16.1180" class="difflineplus">+      for (let i = 0; i &lt; sections.length; ++i) {</span>
<a href="#l16.1181"></a><span id="l16.1181" class="difflineplus">+        let section = sections[i];</span>
<a href="#l16.1182"></a><span id="l16.1182" class="difflineplus">+        if (y + this._maximalSectionOffset &lt; section[0]) {</span>
<a href="#l16.1183"></a><span id="l16.1183" class="difflineplus">+          newY = section[1];</span>
<a href="#l16.1184"></a><span id="l16.1184" class="difflineplus">+          break;</span>
<a href="#l16.1185"></a><span id="l16.1185" class="difflineplus">+        }</span>
<a href="#l16.1186"></a><span id="l16.1186" class="difflineplus">+      }</span>
<a href="#l16.1187"></a><span id="l16.1187" class="difflineplus">+      this.contentWindow.scrollTo(0, newY);</span>
<a href="#l16.1188"></a><span id="l16.1188">     }</span>
<a href="#l16.1189"></a><span id="l16.1189"> </span>
<a href="#l16.1190"></a><span id="l16.1190" class="difflineminus">-    return result;</span>
<a href="#l16.1191"></a><span id="l16.1191" class="difflineminus">-  }</span>
<a href="#l16.1192"></a><span id="l16.1192" class="difflineminus">-</span>
<a href="#l16.1193"></a><span id="l16.1193" class="difflineminus">-  getPendingMessagesCount() {</span>
<a href="#l16.1194"></a><span id="l16.1194" class="difflineminus">-    return this._pendingMessages.length;</span>
<a href="#l16.1195"></a><span id="l16.1195" class="difflineminus">-  }</span>
<a href="#l16.1196"></a><span id="l16.1196" class="difflineminus">-</span>
<a href="#l16.1197"></a><span id="l16.1197" class="difflineminus">-  displayPendingMessages(timing) {</span>
<a href="#l16.1198"></a><span id="l16.1198" class="difflineminus">-    if (!this._messageDisplayPending)</span>
<a href="#l16.1199"></a><span id="l16.1199" class="difflineminus">-      return;</span>
<a href="#l16.1200"></a><span id="l16.1200" class="difflineminus">-</span>
<a href="#l16.1201"></a><span id="l16.1201" class="difflineminus">-    let max = this.getPendingMessagesCount();</span>
<a href="#l16.1202"></a><span id="l16.1202" class="difflineminus">-    do {</span>
<a href="#l16.1203"></a><span id="l16.1203" class="difflineminus">-      // One message takes less than 2ms on average.</span>
<a href="#l16.1204"></a><span id="l16.1204" class="difflineminus">-      let msg = this.getNextPendingMessage();</span>
<a href="#l16.1205"></a><span id="l16.1205" class="difflineminus">-      if (!msg)</span>
<a href="#l16.1206"></a><span id="l16.1206" class="difflineminus">-        break;</span>
<a href="#l16.1207"></a><span id="l16.1207" class="difflineminus">-      this.displayMessage(msg.msg, msg.context,</span>
<a href="#l16.1208"></a><span id="l16.1208" class="difflineminus">-        ++this._pendingMessagesDisplayed &lt; max,</span>
<a href="#l16.1209"></a><span id="l16.1209" class="difflineminus">-        msg.firstUnread);</span>
<a href="#l16.1210"></a><span id="l16.1210" class="difflineminus">-    } while (timing.timeRemaining() &gt; 2);</span>
<a href="#l16.1211"></a><span id="l16.1211" class="difflineminus">-</span>
<a href="#l16.1212"></a><span id="l16.1212" class="difflineminus">-    let event = document.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l16.1213"></a><span id="l16.1213" class="difflineminus">-    event.initUIEvent(&quot;MessagesDisplayed&quot;, false, false, window, 0);</span>
<a href="#l16.1214"></a><span id="l16.1214" class="difflineminus">-    if (this._pendingMessagesDisplayed &lt; max) {</span>
<a href="#l16.1215"></a><span id="l16.1215" class="difflineminus">-      if (this.progressBar) {</span>
<a href="#l16.1216"></a><span id="l16.1216" class="difflineminus">-        // Show progress bar if after the third call (ca. 120ms)</span>
<a href="#l16.1217"></a><span id="l16.1217" class="difflineminus">-        // less than half the messages have been displayed.</span>
<a href="#l16.1218"></a><span id="l16.1218" class="difflineminus">-        if (++this._displayPendingMessagesCalls &gt; 2 &amp;&amp;</span>
<a href="#l16.1219"></a><span id="l16.1219" class="difflineminus">-          max &gt; 2 * this._pendingMessagesDisplayed)</span>
<a href="#l16.1220"></a><span id="l16.1220" class="difflineminus">-          this.progressBar.hidden = false;</span>
<a href="#l16.1221"></a><span id="l16.1221" class="difflineminus">-        this.progressBar.max = max;</span>
<a href="#l16.1222"></a><span id="l16.1222" class="difflineminus">-        this.progressBar.value = this._pendingMessagesDisplayed;</span>
<a href="#l16.1223"></a><span id="l16.1223" class="difflineplus">+    browserScroll(event) {</span>
<a href="#l16.1224"></a><span id="l16.1224" class="difflineplus">+      if (this._scrollingIntoView) {</span>
<a href="#l16.1225"></a><span id="l16.1225" class="difflineplus">+        // We have explicitly requested a scrollIntoView, ignore the event.</span>
<a href="#l16.1226"></a><span id="l16.1226" class="difflineplus">+        this._scrollingIntoView = false;</span>
<a href="#l16.1227"></a><span id="l16.1227" class="difflineplus">+        this._lastScrollHeight = this.scrollHeight;</span>
<a href="#l16.1228"></a><span id="l16.1228" class="difflineplus">+        this._lastScrollWidth = this.scrollWidth;</span>
<a href="#l16.1229"></a><span id="l16.1229" class="difflineplus">+        return;</span>
<a href="#l16.1230"></a><span id="l16.1230">       }</span>
<a href="#l16.1231"></a><span id="l16.1231" class="difflineminus">-      requestIdleCallback(this.displayPendingMessages.bind(this));</span>
<a href="#l16.1232"></a><span id="l16.1232" class="difflineminus">-      this.dispatchEvent(event);</span>
<a href="#l16.1233"></a><span id="l16.1233" class="difflineminus">-      return;</span>
<a href="#l16.1234"></a><span id="l16.1234" class="difflineminus">-    }</span>
<a href="#l16.1235"></a><span id="l16.1235" class="difflineminus">-    this.contentWindow.messageInsertPending = false;</span>
<a href="#l16.1236"></a><span id="l16.1236" class="difflineminus">-    this._messageDisplayPending = false;</span>
<a href="#l16.1237"></a><span id="l16.1237" class="difflineminus">-    this._pendingMessagesDisplayed = 0;</span>
<a href="#l16.1238"></a><span id="l16.1238" class="difflineminus">-    this._displayPendingMessagesCalls = 0;</span>
<a href="#l16.1239"></a><span id="l16.1239" class="difflineminus">-    if (this.progressBar)</span>
<a href="#l16.1240"></a><span id="l16.1240" class="difflineminus">-      this.progressBar.hidden = true;</span>
<a href="#l16.1241"></a><span id="l16.1241" class="difflineminus">-    this.dispatchEvent(event);</span>
<a href="#l16.1242"></a><span id="l16.1242" class="difflineminus">-  }</span>
<a href="#l16.1243"></a><span id="l16.1243" class="difflineminus">-</span>
<a href="#l16.1244"></a><span id="l16.1244" class="difflineminus">-  displayMessage(aMsg, aContext, aNoAutoScroll, aFirstUnread) {</span>
<a href="#l16.1245"></a><span id="l16.1245" class="difflineminus">-    let doc = this.contentDocument;</span>
<a href="#l16.1246"></a><span id="l16.1246" class="difflineminus">-</span>
<a href="#l16.1247"></a><span id="l16.1247" class="difflineminus">-    if (aMsg.noLog &amp;&amp; aMsg.notification &amp;&amp;</span>
<a href="#l16.1248"></a><span id="l16.1248" class="difflineminus">-        aMsg.who == &quot;sessionstart&quot;) {</span>
<a href="#l16.1249"></a><span id="l16.1249" class="difflineminus">-      // New session log.</span>
<a href="#l16.1250"></a><span id="l16.1250" class="difflineminus">-      if (this._lastMessage) {</span>
<a href="#l16.1251"></a><span id="l16.1251" class="difflineminus">-        let ruler = doc.createElement(&quot;hr&quot;);</span>
<a href="#l16.1252"></a><span id="l16.1252" class="difflineminus">-        ruler.className = &quot;sessionstart-ruler&quot;;</span>
<a href="#l16.1253"></a><span id="l16.1253" class="difflineminus">-        this.contentChatNode.appendChild(ruler);</span>
<a href="#l16.1254"></a><span id="l16.1254" class="difflineminus">-        this._sessions.push(ruler);</span>
<a href="#l16.1255"></a><span id="l16.1255" class="difflineminus">-        // Close any open bubble.</span>
<a href="#l16.1256"></a><span id="l16.1256" class="difflineminus">-        this._lastMessage = null;</span>
<a href="#l16.1257"></a><span id="l16.1257" class="difflineminus">-      }</span>
<a href="#l16.1258"></a><span id="l16.1258" class="difflineminus">-      // Suppress this message unless it was an error message.</span>
<a href="#l16.1259"></a><span id="l16.1259" class="difflineminus">-      if (!aMsg.error)</span>
<a href="#l16.1260"></a><span id="l16.1260" class="difflineminus">-        return;</span>
<a href="#l16.1261"></a><span id="l16.1261" class="difflineminus">-    }</span>
<a href="#l16.1262"></a><span id="l16.1262" class="difflineminus">-</span>
<a href="#l16.1263"></a><span id="l16.1263" class="difflineminus">-    let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l16.1264"></a><span id="l16.1264" class="difflineminus">-      .getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l16.1265"></a><span id="l16.1265"> </span>
<a href="#l16.1266"></a><span id="l16.1266" class="difflineminus">-     // kStructPhrase creates tags for plaintext-markup like *bold*,</span>
<a href="#l16.1267"></a><span id="l16.1267" class="difflineminus">-     // /italics/, etc. We always use this; the content filter will</span>
<a href="#l16.1268"></a><span id="l16.1268" class="difflineminus">-     // filter it out if the user does not want styling.</span>
<a href="#l16.1269"></a><span id="l16.1269" class="difflineminus">-    let csFlags = cs.kStructPhrase;</span>
<a href="#l16.1270"></a><span id="l16.1270" class="difflineminus">-    // Automatically find and link freetext URLs</span>
<a href="#l16.1271"></a><span id="l16.1271" class="difflineminus">-    if (!aMsg.noLinkification)</span>
<a href="#l16.1272"></a><span id="l16.1272" class="difflineminus">-      csFlags |= cs.kURLs;</span>
<a href="#l16.1273"></a><span id="l16.1273" class="difflineminus">-</span>
<a href="#l16.1274"></a><span id="l16.1274" class="difflineminus">-    if (aFirstUnread)</span>
<a href="#l16.1275"></a><span id="l16.1275" class="difflineminus">-      this.setUnreadRuler();</span>
<a href="#l16.1276"></a><span id="l16.1276" class="difflineminus">-</span>
<a href="#l16.1277"></a><span id="l16.1277" class="difflineminus">-    // Right trim before displaying. This removes any OTR related</span>
<a href="#l16.1278"></a><span id="l16.1278" class="difflineminus">-    // whitespace when the extension isn't enabled.</span>
<a href="#l16.1279"></a><span id="l16.1279" class="difflineminus">-    let msg = aMsg.displayMessage.trimRight();</span>
<a href="#l16.1280"></a><span id="l16.1280" class="difflineminus">-</span>
<a href="#l16.1281"></a><span id="l16.1281" class="difflineminus">-    // The slash of a leading '/me' should not be used to</span>
<a href="#l16.1282"></a><span id="l16.1282" class="difflineminus">-    // format as italic, so we remove the '/me' text before</span>
<a href="#l16.1283"></a><span id="l16.1283" class="difflineminus">-    // scanning the HTML, and we add it back later.</span>
<a href="#l16.1284"></a><span id="l16.1284" class="difflineminus">-    let meRegExp = /^((&lt;[^&gt;]+&gt;)*)\/me /;</span>
<a href="#l16.1285"></a><span id="l16.1285" class="difflineminus">-    let me = false;</span>
<a href="#l16.1286"></a><span id="l16.1286" class="difflineminus">-    if (meRegExp.test(msg)) {</span>
<a href="#l16.1287"></a><span id="l16.1287" class="difflineminus">-      me = true;</span>
<a href="#l16.1288"></a><span id="l16.1288" class="difflineminus">-      msg = msg.replace(meRegExp, &quot;$1&quot;);</span>
<a href="#l16.1289"></a><span id="l16.1289" class="difflineminus">-    }</span>
<a href="#l16.1290"></a><span id="l16.1290" class="difflineminus">-</span>
<a href="#l16.1291"></a><span id="l16.1291" class="difflineminus">-    msg = cs.scanHTML(msg.replace(/&amp;/g, &quot;FROM-DTD-amp&quot;), csFlags)</span>
<a href="#l16.1292"></a><span id="l16.1292" class="difflineminus">-      .replace(/FROM-DTD-amp/g, &quot;&amp;&quot;);</span>
<a href="#l16.1293"></a><span id="l16.1293" class="difflineminus">-</span>
<a href="#l16.1294"></a><span id="l16.1294" class="difflineminus">-    if (me)</span>
<a href="#l16.1295"></a><span id="l16.1295" class="difflineminus">-      msg = msg.replace(/^((&lt;[^&gt;]+&gt;)*)/, &quot;$1/me &quot;);</span>
<a href="#l16.1296"></a><span id="l16.1296" class="difflineminus">-</span>
<a href="#l16.1297"></a><span id="l16.1297" class="difflineminus">-    aMsg.message = cleanupImMarkup(msg.replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;),</span>
<a href="#l16.1298"></a><span id="l16.1298" class="difflineminus">-      null, this._textModifiers);</span>
<a href="#l16.1299"></a><span id="l16.1299" class="difflineplus">+      if (</span>
<a href="#l16.1300"></a><span id="l16.1300" class="difflineplus">+        !(&quot;_lastScrollHeight&quot; in this) ||</span>
<a href="#l16.1301"></a><span id="l16.1301" class="difflineplus">+        this._lastScrollHeight != this.scrollHeight ||</span>
<a href="#l16.1302"></a><span id="l16.1302" class="difflineplus">+        this._lastScrollWidth != this.scrollWidth</span>
<a href="#l16.1303"></a><span id="l16.1303" class="difflineplus">+      ) {</span>
<a href="#l16.1304"></a><span id="l16.1304" class="difflineplus">+        // Ensure scroll events triggered by a change of the</span>
<a href="#l16.1305"></a><span id="l16.1305" class="difflineplus">+        // content area size (eg. resizing the window or moving the</span>
<a href="#l16.1306"></a><span id="l16.1306" class="difflineplus">+        // textbox splitter) don't affect the auto-scroll behavior.</span>
<a href="#l16.1307"></a><span id="l16.1307" class="difflineplus">+        this._lastScrollHeight = this.scrollHeight;</span>
<a href="#l16.1308"></a><span id="l16.1308" class="difflineplus">+        this._lastScrollWidth = this.scrollWidth;</span>
<a href="#l16.1309"></a><span id="l16.1309" class="difflineplus">+      }</span>
<a href="#l16.1310"></a><span id="l16.1310"> </span>
<a href="#l16.1311"></a><span id="l16.1311" class="difflineminus">-    let next = (aContext == this._lastMessageIsContext || aMsg.system) &amp;&amp;</span>
<a href="#l16.1312"></a><span id="l16.1312" class="difflineminus">-      isNextMessage(this.theme, aMsg, this._lastMessage);</span>
<a href="#l16.1313"></a><span id="l16.1313" class="difflineminus">-    let newElt;</span>
<a href="#l16.1314"></a><span id="l16.1314" class="difflineminus">-    if (next &amp;&amp; aFirstUnread) {</span>
<a href="#l16.1315"></a><span id="l16.1315" class="difflineminus">-      // If there wasn't an unread ruler, this would be a Next message.</span>
<a href="#l16.1316"></a><span id="l16.1316" class="difflineminus">-      // Therefore, save that version for later.</span>
<a href="#l16.1317"></a><span id="l16.1317" class="difflineminus">-      let html = getHTMLForMessage(aMsg, this.theme, next, aContext);</span>
<a href="#l16.1318"></a><span id="l16.1318" class="difflineminus">-      let ruler = doc.getElementById(&quot;unread-ruler&quot;);</span>
<a href="#l16.1319"></a><span id="l16.1319" class="difflineminus">-      ruler.nextMsgHtml = html;</span>
<a href="#l16.1320"></a><span id="l16.1320" class="difflineminus">-      ruler._originalMsg = aMsg;</span>
<a href="#l16.1321"></a><span id="l16.1321" class="difflineminus">-</span>
<a href="#l16.1322"></a><span id="l16.1322" class="difflineminus">-      // Remember where the Next message(s) would have gone.</span>
<a href="#l16.1323"></a><span id="l16.1323" class="difflineminus">-      let insert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.1324"></a><span id="l16.1324" class="difflineminus">-      if (!insert) {</span>
<a href="#l16.1325"></a><span id="l16.1325" class="difflineminus">-        insert = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.1326"></a><span id="l16.1326" class="difflineminus">-        ruler.parentNode.insertBefore(insert, ruler);</span>
<a href="#l16.1327"></a><span id="l16.1327" class="difflineplus">+      // If images higher than one line of text load they will trigger a</span>
<a href="#l16.1328"></a><span id="l16.1328" class="difflineplus">+      // scroll event, which shouldn't disable auto-scroll while messages</span>
<a href="#l16.1329"></a><span id="l16.1329" class="difflineplus">+      // are being appended without being scrolled.</span>
<a href="#l16.1330"></a><span id="l16.1330" class="difflineplus">+      if (this._messageDisplayPending) {</span>
<a href="#l16.1331"></a><span id="l16.1331" class="difflineplus">+        return;</span>
<a href="#l16.1332"></a><span id="l16.1332">       }</span>
<a href="#l16.1333"></a><span id="l16.1333" class="difflineminus">-      insert.id = &quot;insert-before&quot;;</span>
<a href="#l16.1334"></a><span id="l16.1334"> </span>
<a href="#l16.1335"></a><span id="l16.1335" class="difflineminus">-      next = false;</span>
<a href="#l16.1336"></a><span id="l16.1336" class="difflineminus">-      html = getHTMLForMessage(aMsg, this.theme, next, aContext);</span>
<a href="#l16.1337"></a><span id="l16.1337" class="difflineminus">-      newElt = insertHTMLForMessage(aMsg, html, doc, next);</span>
<a href="#l16.1338"></a><span id="l16.1338" class="difflineminus">-      let marker = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.1339"></a><span id="l16.1339" class="difflineminus">-      marker.id = &quot;end-of-split-block&quot;;</span>
<a href="#l16.1340"></a><span id="l16.1340" class="difflineminus">-      newElt.parentNode.appendChild(marker);</span>
<a href="#l16.1341"></a><span id="l16.1341" class="difflineminus">-</span>
<a href="#l16.1342"></a><span id="l16.1342" class="difflineminus">-      // Bracket the place where additional Next messages will be added,</span>
<a href="#l16.1343"></a><span id="l16.1343" class="difflineminus">-      // if that's not after the end-of-split-block element.</span>
<a href="#l16.1344"></a><span id="l16.1344" class="difflineminus">-      insert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.1345"></a><span id="l16.1345" class="difflineminus">-      if (insert) {</span>
<a href="#l16.1346"></a><span id="l16.1346" class="difflineminus">-        marker = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.1347"></a><span id="l16.1347" class="difflineminus">-        marker.id = &quot;next-messages-start&quot;;</span>
<a href="#l16.1348"></a><span id="l16.1348" class="difflineminus">-        insert.parentNode.insertBefore(marker, insert);</span>
<a href="#l16.1349"></a><span id="l16.1349" class="difflineminus">-        marker = doc.createElement(&quot;div&quot;);</span>
<a href="#l16.1350"></a><span id="l16.1350" class="difflineminus">-        marker.id = &quot;next-messages-end&quot;;</span>
<a href="#l16.1351"></a><span id="l16.1351" class="difflineminus">-        insert.parentNode.insertBefore(marker, insert.nextSibling);</span>
<a href="#l16.1352"></a><span id="l16.1352" class="difflineminus">-      }</span>
<a href="#l16.1353"></a><span id="l16.1353" class="difflineminus">-    } else {</span>
<a href="#l16.1354"></a><span id="l16.1354" class="difflineminus">-      let html = getHTMLForMessage(aMsg, this.theme, next, aContext);</span>
<a href="#l16.1355"></a><span id="l16.1355" class="difflineminus">-      newElt = insertHTMLForMessage(aMsg, html, doc, next);</span>
<a href="#l16.1356"></a><span id="l16.1356" class="difflineplus">+      // Enable or disable auto-scroll based on the scrollbar position.</span>
<a href="#l16.1357"></a><span id="l16.1357" class="difflineplus">+      this._updateConvScrollEnabled();</span>
<a href="#l16.1358"></a><span id="l16.1358">     }</span>
<a href="#l16.1359"></a><span id="l16.1359"> </span>
<a href="#l16.1360"></a><span id="l16.1360" class="difflineminus">-    if (!aNoAutoScroll) {</span>
<a href="#l16.1361"></a><span id="l16.1361" class="difflineminus">-      newElt.getBoundingClientRect(); // avoid ireflow bugs</span>
<a href="#l16.1362"></a><span id="l16.1362" class="difflineminus">-      if (this.convScrollEnabled())</span>
<a href="#l16.1363"></a><span id="l16.1363" class="difflineminus">-        this._scrollToElement(newElt);</span>
<a href="#l16.1364"></a><span id="l16.1364" class="difflineminus">-    }</span>
<a href="#l16.1365"></a><span id="l16.1365" class="difflineminus">-    this._lastElement = newElt;</span>
<a href="#l16.1366"></a><span id="l16.1366" class="difflineminus">-    this._lastMessage = aMsg;</span>
<a href="#l16.1367"></a><span id="l16.1367" class="difflineminus">-    if (!aContext &amp;&amp; !this._firstNonContextElt &amp;&amp; !aMsg.system)</span>
<a href="#l16.1368"></a><span id="l16.1368" class="difflineminus">-      this._firstNonContextElt = newElt;</span>
<a href="#l16.1369"></a><span id="l16.1369" class="difflineminus">-    this._lastMessageIsContext = aContext;</span>
<a href="#l16.1370"></a><span id="l16.1370" class="difflineminus">-  }</span>
<a href="#l16.1371"></a><span id="l16.1371" class="difflineminus">-</span>
<a href="#l16.1372"></a><span id="l16.1372" class="difflineminus">-  setUnreadRuler() {</span>
<a href="#l16.1373"></a><span id="l16.1373" class="difflineminus">-    // Remove any existing ruler (occurs when the window has lost focus).</span>
<a href="#l16.1374"></a><span id="l16.1374" class="difflineminus">-    this.removeUnreadRuler();</span>
<a href="#l16.1375"></a><span id="l16.1375" class="difflineminus">-</span>
<a href="#l16.1376"></a><span id="l16.1376" class="difflineminus">-    let ruler = this.contentDocument.createElement(&quot;hr&quot;);</span>
<a href="#l16.1377"></a><span id="l16.1377" class="difflineminus">-    ruler.id = &quot;unread-ruler&quot;;</span>
<a href="#l16.1378"></a><span id="l16.1378" class="difflineminus">-    this.contentChatNode.appendChild(ruler);</span>
<a href="#l16.1379"></a><span id="l16.1379" class="difflineminus">-  }</span>
<a href="#l16.1380"></a><span id="l16.1380" class="difflineminus">-</span>
<a href="#l16.1381"></a><span id="l16.1381" class="difflineminus">-  removeUnreadRuler() {</span>
<a href="#l16.1382"></a><span id="l16.1382" class="difflineminus">-    let doc = this.contentDocument;</span>
<a href="#l16.1383"></a><span id="l16.1383" class="difflineminus">-    let ruler = doc.getElementById(&quot;unread-ruler&quot;);</span>
<a href="#l16.1384"></a><span id="l16.1384" class="difflineminus">-    if (!ruler)</span>
<a href="#l16.1385"></a><span id="l16.1385" class="difflineminus">-      return;</span>
<a href="#l16.1386"></a><span id="l16.1386" class="difflineminus">-</span>
<a href="#l16.1387"></a><span id="l16.1387" class="difflineminus">-    // If a message block was split by the ruler, rejoin it.</span>
<a href="#l16.1388"></a><span id="l16.1388" class="difflineminus">-    let moveTo = doc.getElementById(&quot;insert-before&quot;);</span>
<a href="#l16.1389"></a><span id="l16.1389" class="difflineminus">-    if (moveTo) {</span>
<a href="#l16.1390"></a><span id="l16.1390" class="difflineminus">-      // Protect an existing insert node.</span>
<a href="#l16.1391"></a><span id="l16.1391" class="difflineminus">-      let actualInsert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.1392"></a><span id="l16.1392" class="difflineminus">-      if (actualInsert)</span>
<a href="#l16.1393"></a><span id="l16.1393" class="difflineminus">-        actualInsert.id = &quot;actual-insert&quot;;</span>
<a href="#l16.1394"></a><span id="l16.1394" class="difflineminus">-</span>
<a href="#l16.1395"></a><span id="l16.1395" class="difflineminus">-      // Add first message following the ruler as a Next type message.</span>
<a href="#l16.1396"></a><span id="l16.1396" class="difflineminus">-      // Replicates the relevant parts of insertHTMLForMessage().</span>
<a href="#l16.1397"></a><span id="l16.1397" class="difflineminus">-      let range = doc.createRange();</span>
<a href="#l16.1398"></a><span id="l16.1398" class="difflineminus">-      let moveToParent = moveTo.parentNode;</span>
<a href="#l16.1399"></a><span id="l16.1399" class="difflineminus">-      range.selectNode(moveToParent);</span>
<a href="#l16.1400"></a><span id="l16.1400" class="difflineminus">-      // eslint-disable-next-line no-unsanitized/method</span>
<a href="#l16.1401"></a><span id="l16.1401" class="difflineminus">-      let documentFragment = range.createContextualFragment(ruler.nextMsgHtml);</span>
<a href="#l16.1402"></a><span id="l16.1402" class="difflineminus">-      for (let root = documentFragment.firstChild; root; root = root.nextSibling)</span>
<a href="#l16.1403"></a><span id="l16.1403" class="difflineminus">-        root._originalMsg = ruler._originalMsg;</span>
<a href="#l16.1404"></a><span id="l16.1404" class="difflineminus">-      moveToParent.insertBefore(documentFragment, moveTo);</span>
<a href="#l16.1405"></a><span id="l16.1405" class="difflineminus">-</span>
<a href="#l16.1406"></a><span id="l16.1406" class="difflineminus">-      // If this added an insert node, insert the next messages there.</span>
<a href="#l16.1407"></a><span id="l16.1407" class="difflineminus">-      let insert = doc.getElementById(&quot;insert&quot;);</span>
<a href="#l16.1408"></a><span id="l16.1408" class="difflineminus">-      if (insert) {</span>
<a href="#l16.1409"></a><span id="l16.1409" class="difflineminus">-        moveTo.remove();</span>
<a href="#l16.1410"></a><span id="l16.1410" class="difflineminus">-        moveTo = insert;</span>
<a href="#l16.1411"></a><span id="l16.1411" class="difflineminus">-        moveToParent = moveTo.parentNode;</span>
<a href="#l16.1412"></a><span id="l16.1412" class="difflineminus">-      }</span>
<a href="#l16.1413"></a><span id="l16.1413" class="difflineminus">-</span>
<a href="#l16.1414"></a><span id="l16.1414" class="difflineminus">-      // Move remaining messages from the message block following the ruler.</span>
<a href="#l16.1415"></a><span id="l16.1415" class="difflineminus">-      let nextMessagesStart = doc.getElementById(&quot;next-messages-start&quot;);</span>
<a href="#l16.1416"></a><span id="l16.1416" class="difflineminus">-      if (nextMessagesStart) {</span>
<a href="#l16.1417"></a><span id="l16.1417" class="difflineminus">-        range = doc.createRange();</span>
<a href="#l16.1418"></a><span id="l16.1418" class="difflineminus">-        range.setStartAfter(nextMessagesStart);</span>
<a href="#l16.1419"></a><span id="l16.1419" class="difflineminus">-        range.setEndBefore(doc.getElementById(&quot;next-messages-end&quot;));</span>
<a href="#l16.1420"></a><span id="l16.1420" class="difflineminus">-        moveToParent.insertBefore(range.extractContents(), moveTo);</span>
<a href="#l16.1421"></a><span id="l16.1421" class="difflineminus">-      }</span>
<a href="#l16.1422"></a><span id="l16.1422" class="difflineminus">-      moveTo.remove();</span>
<a href="#l16.1423"></a><span id="l16.1423" class="difflineminus">-</span>
<a href="#l16.1424"></a><span id="l16.1424" class="difflineminus">-      // Restore existing insert node.</span>
<a href="#l16.1425"></a><span id="l16.1425" class="difflineminus">-      if (actualInsert)</span>
<a href="#l16.1426"></a><span id="l16.1426" class="difflineminus">-        actualInsert.id = &quot;insert&quot;;</span>
<a href="#l16.1427"></a><span id="l16.1427" class="difflineminus">-</span>
<a href="#l16.1428"></a><span id="l16.1428" class="difflineminus">-      // Delete surplus message block.</span>
<a href="#l16.1429"></a><span id="l16.1429" class="difflineminus">-      range = doc.createRange();</span>
<a href="#l16.1430"></a><span id="l16.1430" class="difflineminus">-      range.setStartAfter(ruler);</span>
<a href="#l16.1431"></a><span id="l16.1431" class="difflineminus">-      range.setEndAfter(doc.getElementById(&quot;end-of-split-block&quot;));</span>
<a href="#l16.1432"></a><span id="l16.1432" class="difflineminus">-      range.deleteContents();</span>
<a href="#l16.1433"></a><span id="l16.1433" class="difflineminus">-    }</span>
<a href="#l16.1434"></a><span id="l16.1434" class="difflineminus">-    ruler.remove();</span>
<a href="#l16.1435"></a><span id="l16.1435" class="difflineminus">-  }</span>
<a href="#l16.1436"></a><span id="l16.1436" class="difflineminus">-</span>
<a href="#l16.1437"></a><span id="l16.1437" class="difflineminus">-  _getSections() {</span>
<a href="#l16.1438"></a><span id="l16.1438" class="difflineminus">-    // If a section is displayed below this point, we assume not enough of</span>
<a href="#l16.1439"></a><span id="l16.1439" class="difflineminus">-    // it is visible, so we must scroll to it.</span>
<a href="#l16.1440"></a><span id="l16.1440" class="difflineminus">-    // The 3/4 constant is arbitrary, but it has to be greater than 1/2.</span>
<a href="#l16.1441"></a><span id="l16.1441" class="difflineminus">-    this._maximalSectionOffset = Math.round(this.clientHeight * 3 / 4);</span>
<a href="#l16.1442"></a><span id="l16.1442" class="difflineminus">-</span>
<a href="#l16.1443"></a><span id="l16.1443" class="difflineminus">-    // Get list of current section elements.</span>
<a href="#l16.1444"></a><span id="l16.1444" class="difflineminus">-    let sectionElements = [];</span>
<a href="#l16.1445"></a><span id="l16.1445" class="difflineminus">-    if (this._firstNonContextElt)</span>
<a href="#l16.1446"></a><span id="l16.1446" class="difflineminus">-      sectionElements.push(this._firstNonContextElt);</span>
<a href="#l16.1447"></a><span id="l16.1447" class="difflineminus">-    let ruler = this.contentDocument.getElementById(&quot;unread-ruler&quot;);</span>
<a href="#l16.1448"></a><span id="l16.1448" class="difflineminus">-    if (ruler)</span>
<a href="#l16.1449"></a><span id="l16.1449" class="difflineminus">-      sectionElements.push(ruler);</span>
<a href="#l16.1450"></a><span id="l16.1450" class="difflineminus">-    sectionElements = sectionElements.concat(this._sessions);</span>
<a href="#l16.1451"></a><span id="l16.1451" class="difflineminus">-</span>
<a href="#l16.1452"></a><span id="l16.1452" class="difflineminus">-    // Return ordered array of sections with entries</span>
<a href="#l16.1453"></a><span id="l16.1453" class="difflineminus">-    // [Y, scrollY such that Y is centered]</span>
<a href="#l16.1454"></a><span id="l16.1454" class="difflineminus">-    let sections = [];</span>
<a href="#l16.1455"></a><span id="l16.1455" class="difflineminus">-    let maxY = this.contentWindow.scrollMaxY;</span>
<a href="#l16.1456"></a><span id="l16.1456" class="difflineminus">-    for (let i = 0; i &lt; sectionElements.length; ++i) {</span>
<a href="#l16.1457"></a><span id="l16.1457" class="difflineminus">-      let y = sectionElements[i].offsetTop;</span>
<a href="#l16.1458"></a><span id="l16.1458" class="difflineminus">-      // The section is unnecessary if close to top/bottom of conversation.</span>
<a href="#l16.1459"></a><span id="l16.1459" class="difflineminus">-      if (y &lt; this._maximalSectionOffset || maxY &lt; y)</span>
<a href="#l16.1460"></a><span id="l16.1460" class="difflineminus">-        continue;</span>
<a href="#l16.1461"></a><span id="l16.1461" class="difflineminus">-      sections.push([y, y - Math.round(this.clientHeight / 2)]);</span>
<a href="#l16.1462"></a><span id="l16.1462" class="difflineminus">-    }</span>
<a href="#l16.1463"></a><span id="l16.1463" class="difflineminus">-    sections.sort((a, b) =&gt; a[0] - b[0]);</span>
<a href="#l16.1464"></a><span id="l16.1464" class="difflineminus">-    return sections;</span>
<a href="#l16.1465"></a><span id="l16.1465" class="difflineminus">-  }</span>
<a href="#l16.1466"></a><span id="l16.1466" class="difflineminus">-</span>
<a href="#l16.1467"></a><span id="l16.1467" class="difflineminus">-  scrollToPreviousSection() {</span>
<a href="#l16.1468"></a><span id="l16.1468" class="difflineminus">-    let sections = this._getSections();</span>
<a href="#l16.1469"></a><span id="l16.1469" class="difflineminus">-    let y = this.contentWindow.scrollY;</span>
<a href="#l16.1470"></a><span id="l16.1470" class="difflineminus">-    let newY = 0;</span>
<a href="#l16.1471"></a><span id="l16.1471" class="difflineminus">-    for (let i = sections.length - 1; i &gt;= 0; --i) {</span>
<a href="#l16.1472"></a><span id="l16.1472" class="difflineminus">-      let section = sections[i];</span>
<a href="#l16.1473"></a><span id="l16.1473" class="difflineminus">-      if (y &gt; section[0]) {</span>
<a href="#l16.1474"></a><span id="l16.1474" class="difflineminus">-        newY = section[1];</span>
<a href="#l16.1475"></a><span id="l16.1475" class="difflineminus">-        break;</span>
<a href="#l16.1476"></a><span id="l16.1476" class="difflineplus">+    browserResize(event) {</span>
<a href="#l16.1477"></a><span id="l16.1477" class="difflineplus">+      if (this._convScrollEnabled &amp;&amp; this._lastElement) {</span>
<a href="#l16.1478"></a><span id="l16.1478" class="difflineplus">+        // The content area was resized and auto-scroll is enabled,</span>
<a href="#l16.1479"></a><span id="l16.1479" class="difflineplus">+        // make sure the last inserted element is still visible</span>
<a href="#l16.1480"></a><span id="l16.1480" class="difflineplus">+        this._scrollToElement(this._lastElement);</span>
<a href="#l16.1481"></a><span id="l16.1481">       }</span>
<a href="#l16.1482"></a><span id="l16.1482">     }</span>
<a href="#l16.1483"></a><span id="l16.1483" class="difflineminus">-    this.contentWindow.scrollTo(0, newY);</span>
<a href="#l16.1484"></a><span id="l16.1484" class="difflineminus">-  }</span>
<a href="#l16.1485"></a><span id="l16.1485"> </span>
<a href="#l16.1486"></a><span id="l16.1486" class="difflineminus">-  scrollToNextSection() {</span>
<a href="#l16.1487"></a><span id="l16.1487" class="difflineminus">-    let sections = this._getSections();</span>
<a href="#l16.1488"></a><span id="l16.1488" class="difflineminus">-    let y = this.contentWindow.scrollY;</span>
<a href="#l16.1489"></a><span id="l16.1489" class="difflineminus">-    let newY = this.contentWindow.scrollMaxY;</span>
<a href="#l16.1490"></a><span id="l16.1490" class="difflineminus">-    for (let i = 0; i &lt; sections.length; ++i) {</span>
<a href="#l16.1491"></a><span id="l16.1491" class="difflineminus">-      let section = sections[i];</span>
<a href="#l16.1492"></a><span id="l16.1492" class="difflineminus">-      if (y + this._maximalSectionOffset &lt; section[0]) {</span>
<a href="#l16.1493"></a><span id="l16.1493" class="difflineminus">-        newY = section[1];</span>
<a href="#l16.1494"></a><span id="l16.1494" class="difflineminus">-        break;</span>
<a href="#l16.1495"></a><span id="l16.1495" class="difflineplus">+    onContentElementLoad(event) {</span>
<a href="#l16.1496"></a><span id="l16.1496" class="difflineplus">+      if (</span>
<a href="#l16.1497"></a><span id="l16.1497" class="difflineplus">+        event.target.localName == &quot;img&quot; &amp;&amp;</span>
<a href="#l16.1498"></a><span id="l16.1498" class="difflineplus">+        this._convScrollEnabled &amp;&amp;</span>
<a href="#l16.1499"></a><span id="l16.1499" class="difflineplus">+        !this._messageDisplayPending &amp;&amp;</span>
<a href="#l16.1500"></a><span id="l16.1500" class="difflineplus">+        this._lastElement</span>
<a href="#l16.1501"></a><span id="l16.1501" class="difflineplus">+      ) {</span>
<a href="#l16.1502"></a><span id="l16.1502" class="difflineplus">+        // An image loaded while auto-scroll is enabled and no further</span>
<a href="#l16.1503"></a><span id="l16.1503" class="difflineplus">+        // messages are currently being appended. So we need to scroll</span>
<a href="#l16.1504"></a><span id="l16.1504" class="difflineplus">+        // the last element fully back into view.</span>
<a href="#l16.1505"></a><span id="l16.1505" class="difflineplus">+        this._scrollToElement(this._lastElement);</span>
<a href="#l16.1506"></a><span id="l16.1506">       }</span>
<a href="#l16.1507"></a><span id="l16.1507">     }</span>
<a href="#l16.1508"></a><span id="l16.1508" class="difflineminus">-    this.contentWindow.scrollTo(0, newY);</span>
<a href="#l16.1509"></a><span id="l16.1509">   }</span>
<a href="#l16.1510"></a><span id="l16.1510" class="difflineminus">-</span>
<a href="#l16.1511"></a><span id="l16.1511" class="difflineminus">-  browserScroll(event) {</span>
<a href="#l16.1512"></a><span id="l16.1512" class="difflineminus">-    if (this._scrollingIntoView) {</span>
<a href="#l16.1513"></a><span id="l16.1513" class="difflineminus">-      // We have explicitly requested a scrollIntoView, ignore the event.</span>
<a href="#l16.1514"></a><span id="l16.1514" class="difflineminus">-      this._scrollingIntoView = false;</span>
<a href="#l16.1515"></a><span id="l16.1515" class="difflineminus">-      this._lastScrollHeight = this.scrollHeight;</span>
<a href="#l16.1516"></a><span id="l16.1516" class="difflineminus">-      this._lastScrollWidth = this.scrollWidth;</span>
<a href="#l16.1517"></a><span id="l16.1517" class="difflineminus">-      return;</span>
<a href="#l16.1518"></a><span id="l16.1518" class="difflineminus">-    }</span>
<a href="#l16.1519"></a><span id="l16.1519" class="difflineminus">-</span>
<a href="#l16.1520"></a><span id="l16.1520" class="difflineminus">-    if (!(&quot;_lastScrollHeight&quot; in this) ||</span>
<a href="#l16.1521"></a><span id="l16.1521" class="difflineminus">-      this._lastScrollHeight != this.scrollHeight ||</span>
<a href="#l16.1522"></a><span id="l16.1522" class="difflineminus">-      this._lastScrollWidth != this.scrollWidth) {</span>
<a href="#l16.1523"></a><span id="l16.1523" class="difflineminus">-      // Ensure scroll events triggered by a change of the</span>
<a href="#l16.1524"></a><span id="l16.1524" class="difflineminus">-      // content area size (eg. resizing the window or moving the</span>
<a href="#l16.1525"></a><span id="l16.1525" class="difflineminus">-      // textbox splitter) don't affect the auto-scroll behavior.</span>
<a href="#l16.1526"></a><span id="l16.1526" class="difflineminus">-      this._lastScrollHeight = this.scrollHeight;</span>
<a href="#l16.1527"></a><span id="l16.1527" class="difflineminus">-      this._lastScrollWidth = this.scrollWidth;</span>
<a href="#l16.1528"></a><span id="l16.1528" class="difflineminus">-    }</span>
<a href="#l16.1529"></a><span id="l16.1529" class="difflineminus">-</span>
<a href="#l16.1530"></a><span id="l16.1530" class="difflineminus">-    // If images higher than one line of text load they will trigger a</span>
<a href="#l16.1531"></a><span id="l16.1531" class="difflineminus">-    // scroll event, which shouldn't disable auto-scroll while messages</span>
<a href="#l16.1532"></a><span id="l16.1532" class="difflineminus">-    // are being appended without being scrolled.</span>
<a href="#l16.1533"></a><span id="l16.1533" class="difflineminus">-    if (this._messageDisplayPending) {</span>
<a href="#l16.1534"></a><span id="l16.1534" class="difflineminus">-      return;</span>
<a href="#l16.1535"></a><span id="l16.1535" class="difflineminus">-    }</span>
<a href="#l16.1536"></a><span id="l16.1536" class="difflineminus">-</span>
<a href="#l16.1537"></a><span id="l16.1537" class="difflineminus">-    // Enable or disable auto-scroll based on the scrollbar position.</span>
<a href="#l16.1538"></a><span id="l16.1538" class="difflineminus">-    this._updateConvScrollEnabled();</span>
<a href="#l16.1539"></a><span id="l16.1539" class="difflineminus">-  }</span>
<a href="#l16.1540"></a><span id="l16.1540" class="difflineminus">-</span>
<a href="#l16.1541"></a><span id="l16.1541" class="difflineminus">-  browserResize(event) {</span>
<a href="#l16.1542"></a><span id="l16.1542" class="difflineminus">-    if (this._convScrollEnabled &amp;&amp; this._lastElement) {</span>
<a href="#l16.1543"></a><span id="l16.1543" class="difflineminus">-      // The content area was resized and auto-scroll is enabled,</span>
<a href="#l16.1544"></a><span id="l16.1544" class="difflineminus">-      // make sure the last inserted element is still visible</span>
<a href="#l16.1545"></a><span id="l16.1545" class="difflineminus">-      this._scrollToElement(this._lastElement);</span>
<a href="#l16.1546"></a><span id="l16.1546" class="difflineminus">-    }</span>
<a href="#l16.1547"></a><span id="l16.1547" class="difflineminus">-  }</span>
<a href="#l16.1548"></a><span id="l16.1548" class="difflineminus">-</span>
<a href="#l16.1549"></a><span id="l16.1549" class="difflineminus">-  onContentElementLoad(event) {</span>
<a href="#l16.1550"></a><span id="l16.1550" class="difflineminus">-    if (event.target.localName == &quot;img&quot; &amp;&amp;</span>
<a href="#l16.1551"></a><span id="l16.1551" class="difflineminus">-      this._convScrollEnabled &amp;&amp; !this._messageDisplayPending &amp;&amp;</span>
<a href="#l16.1552"></a><span id="l16.1552" class="difflineminus">-      this._lastElement) {</span>
<a href="#l16.1553"></a><span id="l16.1553" class="difflineminus">-      // An image loaded while auto-scroll is enabled and no further</span>
<a href="#l16.1554"></a><span id="l16.1554" class="difflineminus">-      // messages are currently being appended. So we need to scroll</span>
<a href="#l16.1555"></a><span id="l16.1555" class="difflineminus">-      // the last element fully back into view.</span>
<a href="#l16.1556"></a><span id="l16.1556" class="difflineminus">-      this._scrollToElement(this._lastElement);</span>
<a href="#l16.1557"></a><span id="l16.1557" class="difflineminus">-    }</span>
<a href="#l16.1558"></a><span id="l16.1558" class="difflineminus">-  }</span>
<a href="#l16.1559"></a><span id="l16.1559" class="difflineplus">+  customElements.define(&quot;conversation-browser&quot;, MozConversationBrowser, {</span>
<a href="#l16.1560"></a><span id="l16.1560" class="difflineplus">+    extends: &quot;browser&quot;,</span>
<a href="#l16.1561"></a><span id="l16.1561" class="difflineplus">+  });</span>
<a href="#l16.1562"></a><span id="l16.1562"> }</span>
<a href="#l16.1563"></a><span id="l16.1563" class="difflineminus">-customElements.define(&quot;conversation-browser&quot;, MozConversationBrowser, { extends: &quot;browser&quot; });</span>
<a href="#l16.1564"></a><span id="l16.1564" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/content/imAccountOptionsHelper.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/content/imAccountOptionsHelper.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -10,18 +10,20 @@ var accountOptionsHelper = {</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">     let label = document.createXULElement(&quot;label&quot;);</span>
<a href="#l17.6"></a><span id="l17.6">     label.textContent = aLabel;</span>
<a href="#l17.7"></a><span id="l17.7">     label.setAttribute(&quot;control&quot;, aName);</span>
<a href="#l17.8"></a><span id="l17.8">     label.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l17.9"></a><span id="l17.9">     container.appendChild(label);</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11">     let hbox = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    let textbox = (aType != &quot;number&quot;) ? document.createXULElement(&quot;textbox&quot;) :</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-      document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;input&quot;);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+    let textbox =</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+      aType != &quot;number&quot;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+        ? document.createXULElement(&quot;textbox&quot;)</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+        : document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;input&quot;);</span>
<a href="#l17.18"></a><span id="l17.18">     if (aType == &quot;number&quot;) {</span>
<a href="#l17.19"></a><span id="l17.19">       textbox.style.width = &quot;100%&quot;;</span>
<a href="#l17.20"></a><span id="l17.20">     }</span>
<a href="#l17.21"></a><span id="l17.21">     if (aType) {</span>
<a href="#l17.22"></a><span id="l17.22">       textbox.setAttribute(&quot;type&quot;, aType);</span>
<a href="#l17.23"></a><span id="l17.23">     }</span>
<a href="#l17.24"></a><span id="l17.24">     textbox.setAttribute(&quot;value&quot;, aValue);</span>
<a href="#l17.25"></a><span id="l17.25">     textbox.setAttribute(&quot;id&quot;, aName);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineat">@@ -82,30 +84,35 @@ var accountOptionsHelper = {</span>
<a href="#l17.27"></a><span id="l17.27">           chk.setAttribute(&quot;id&quot;, name);</span>
<a href="#l17.28"></a><span id="l17.28">           if (opt.getBool()) {</span>
<a href="#l17.29"></a><span id="l17.29">             chk.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l17.30"></a><span id="l17.30">           }</span>
<a href="#l17.31"></a><span id="l17.31">           hbox.appendChild(chk);</span>
<a href="#l17.32"></a><span id="l17.32">           vbox.appendChild(hbox);</span>
<a href="#l17.33"></a><span id="l17.33">           break;</span>
<a href="#l17.34"></a><span id="l17.34">         case Ci.prplIPref.typeInt:</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-          vbox.appendChild(this.createTextbox(&quot;number&quot;, opt.getInt(), text, name));</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+          vbox.appendChild(</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+            this.createTextbox(&quot;number&quot;, opt.getInt(), text, name)</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+          );</span>
<a href="#l17.39"></a><span id="l17.39">           break;</span>
<a href="#l17.40"></a><span id="l17.40">         case Ci.prplIPref.typeString:</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-          vbox.appendChild(this.createTextbox(null, opt.getString(), text, name));</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+          vbox.appendChild(</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+            this.createTextbox(null, opt.getString(), text, name)</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+          );</span>
<a href="#l17.45"></a><span id="l17.45">           break;</span>
<a href="#l17.46"></a><span id="l17.46">         case Ci.prplIPref.typeList:</span>
<a href="#l17.47"></a><span id="l17.47">           vbox.appendChild(this.createMenulist(opt.getList(), text, name));</span>
<a href="#l17.48"></a><span id="l17.48">           document.getElementById(name).value = opt.getListDefault();</span>
<a href="#l17.49"></a><span id="l17.49">           break;</span>
<a href="#l17.50"></a><span id="l17.50">         default:</span>
<a href="#l17.51"></a><span id="l17.51">           throw new Error(&quot;unknown preference type &quot; + opt.type);</span>
<a href="#l17.52"></a><span id="l17.52">       }</span>
<a href="#l17.53"></a><span id="l17.53">       if (aAttributes &amp;&amp; aAttributes[opt.type]) {</span>
<a href="#l17.54"></a><span id="l17.54">         let element = document.getElementById(name);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-        for (let attr of aAttributes[opt.type])</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+        for (let attr of aAttributes[opt.type]) {</span>
<a href="#l17.57"></a><span id="l17.57">           element.setAttribute(attr.name, attr.value);</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+        }</span>
<a href="#l17.59"></a><span id="l17.59">       }</span>
<a href="#l17.60"></a><span id="l17.60">       haveOptions = true;</span>
<a href="#l17.61"></a><span id="l17.61">     }</span>
<a href="#l17.62"></a><span id="l17.62">     return haveOptions;</span>
<a href="#l17.63"></a><span id="l17.63">   },</span>
<a href="#l17.64"></a><span id="l17.64"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/content/otr-add-fingerprint.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/content/otr-add-fingerprint.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,32 +1,35 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-var {l10nHelper} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-var {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+var { l10nHelper } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+var { OTR } = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12"> </span>
<a href="#l18.13"></a><span id="l18.13"> var otrAddFinger = {</span>
<a href="#l18.14"></a><span id="l18.14">   async onload() {</span>
<a href="#l18.15"></a><span id="l18.15">     let args = window.arguments[0].wrappedJSObject;</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17">     this.fingerWarning = document.getElementById(&quot;fingerWarning&quot;);</span>
<a href="#l18.18"></a><span id="l18.18">     this.fingerError = document.getElementById(&quot;fingerError&quot;);</span>
<a href="#l18.19"></a><span id="l18.19">     this.keyCount = document.getElementById(&quot;keyCount&quot;);</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">     let description = await document.l10n.formatValue(</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-      &quot;otr-add-finger-description&quot;, { name: args.screenname });</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+      &quot;otr-add-finger-description&quot;,</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+      { name: args.screenname }</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+    );</span>
<a href="#l18.26"></a><span id="l18.26">     document.getElementById(&quot;otrDescription&quot;).textContent = description;</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-    let warningTooltip =</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-      await document.l10n.formatValue(&quot;otr-add-finger-tooltip-error&quot;);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+    let warningTooltip = await document.l10n.formatValue(</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+      &quot;otr-add-finger-tooltip-error&quot;</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+    );</span>
<a href="#l18.33"></a><span id="l18.33">     this.fingerWarning.setAttribute(&quot;tooltiptext&quot;, warningTooltip);</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-    document.addEventListener(&quot;dialogaccept&quot;, (event) =&gt; {</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+    document.addEventListener(&quot;dialogaccept&quot;, event =&gt; {</span>
<a href="#l18.37"></a><span id="l18.37">       let hex = document.getElementById(&quot;fingerprint&quot;).value;</span>
<a href="#l18.38"></a><span id="l18.38">       let context = OTR.getContextFromRecipient(</span>
<a href="#l18.39"></a><span id="l18.39">         args.account,</span>
<a href="#l18.40"></a><span id="l18.40">         args.protocol,</span>
<a href="#l18.41"></a><span id="l18.41">         args.screenname</span>
<a href="#l18.42"></a><span id="l18.42">       );</span>
<a href="#l18.43"></a><span id="l18.43">       let finger = OTR.addFingerprint(context, hex);</span>
<a href="#l18.44"></a><span id="l18.44">       if (finger.isNull()) {</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineat">@@ -42,23 +45,27 @@ var otrAddFinger = {</span>
<a href="#l18.46"></a><span id="l18.46">       }</span>
<a href="#l18.47"></a><span id="l18.47">       OTR.setTrust(finger, true, context);</span>
<a href="#l18.48"></a><span id="l18.48">     });</span>
<a href="#l18.49"></a><span id="l18.49"> </span>
<a href="#l18.50"></a><span id="l18.50">     window.sizeToContent();</span>
<a href="#l18.51"></a><span id="l18.51">   },</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53">   addBlankSpace(value) {</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-    return value.replace(/\s/g, &quot;&quot;).trim().replace(/(.{8})/g, &quot;$1 &quot;).trim();</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+    return value</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+      .replace(/\s/g, &quot;&quot;)</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+      .trim()</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+      .replace(/(.{8})/g, &quot;$1 &quot;)</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+      .trim();</span>
<a href="#l18.60"></a><span id="l18.60">   },</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62">   oninput(input) {</span>
<a href="#l18.63"></a><span id="l18.63">     let hex = input.value.replace(/\s/g, &quot;&quot;);</span>
<a href="#l18.64"></a><span id="l18.64"> </span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-    if ((/[^0-9A-F]/gi).test(hex)) {</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+    if (/[^0-9A-F]/gi.test(hex)) {</span>
<a href="#l18.67"></a><span id="l18.67">       this.keyCount.hidden = true;</span>
<a href="#l18.68"></a><span id="l18.68">       this.fingerWarning.hidden = false;</span>
<a href="#l18.69"></a><span id="l18.69">       this.fingerError.hidden = false;</span>
<a href="#l18.70"></a><span id="l18.70">     } else {</span>
<a href="#l18.71"></a><span id="l18.71">       this.keyCount.hidden = false;</span>
<a href="#l18.72"></a><span id="l18.72">       this.fingerWarning.hidden = true;</span>
<a href="#l18.73"></a><span id="l18.73">       this.fingerError.hidden = true;</span>
<a href="#l18.74"></a><span id="l18.74">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/content/otr-auth.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/content/otr-auth.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,54 +1,58 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.5"></a><span id="l19.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.6"></a><span id="l19.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-const {</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-  l10nHelper,</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-const {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+const { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+);</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+const { OTR } = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> var [mode, uiConv, contactInfo] = window.arguments;</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> function showSection(selected, hideMenu) {</span>
<a href="#l19.23"></a><span id="l19.23">   document.getElementById(&quot;how&quot;).hidden = !!hideMenu;</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-  [ &quot;questionAndAnswer&quot;,</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-    &quot;sharedSecret&quot;,</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-    &quot;manualVerification&quot;,</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-    &quot;ask&quot;,</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-  ].forEach(function(key) {</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-    document.getElementById(key).hidden = (key !== selected);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  });</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+  [&quot;questionAndAnswer&quot;, &quot;sharedSecret&quot;, &quot;manualVerification&quot;, &quot;ask&quot;].forEach(</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    function(key) {</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+      document.getElementById(key).hidden = key !== selected;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+    }</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+  );</span>
<a href="#l19.36"></a><span id="l19.36">   window.sizeToContent();</span>
<a href="#l19.37"></a><span id="l19.37"> }</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39"> function startSMP(context, answer, question) {</span>
<a href="#l19.40"></a><span id="l19.40">   OTR.sendSecret(context, answer, question);</span>
<a href="#l19.41"></a><span id="l19.41">   OTR.authUpdate(context, 10);</span>
<a href="#l19.42"></a><span id="l19.42"> }</span>
<a href="#l19.43"></a><span id="l19.43"> </span>
<a href="#l19.44"></a><span id="l19.44"> function manualVerification(fingerprint, context) {</span>
<a href="#l19.45"></a><span id="l19.45">   let opts = document.getElementById(&quot;verifiedOption&quot;);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-  let trust = (opts.selectedItem.value === &quot;yes&quot;);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+  let trust = opts.selectedItem.value === &quot;yes&quot;;</span>
<a href="#l19.48"></a><span id="l19.48">   OTR.setTrust(fingerprint, trust, context);</span>
<a href="#l19.49"></a><span id="l19.49"> }</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51"> async function populateFingers(context, theirs, trust) {</span>
<a href="#l19.52"></a><span id="l19.52">   let yours = OTR.privateKeyFingerprint(context.account, context.protocol);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-  if (!yours)</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+  if (!yours) {</span>
<a href="#l19.55"></a><span id="l19.55">     throw new Error(&quot;Fingerprint should already be generated.&quot;);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  }</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-  document.getElementById(&quot;yourFPLabel&quot;).value =</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-    await document.l10n.formatValue(&quot;auth-your-fp-value&quot;, {own_name: context.account});</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  document.getElementById(</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+    &quot;yourFPLabel&quot;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+  ).value = await document.l10n.formatValue(&quot;auth-your-fp-value&quot;, {</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+    own_name: context.account,</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  });</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-  document.getElementById(&quot;theirFPLabel&quot;).value =</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-    await document.l10n.formatValue(&quot;auth-their-fp-value&quot;, {their_name: context.username});</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+  document.getElementById(</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+    &quot;theirFPLabel&quot;</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+  ).value = await document.l10n.formatValue(&quot;auth-their-fp-value&quot;, {</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+    their_name: context.username,</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  });</span>
<a href="#l19.73"></a><span id="l19.73"> </span>
<a href="#l19.74"></a><span id="l19.74">   document.getElementById(&quot;yourFPValue&quot;).value = yours;</span>
<a href="#l19.75"></a><span id="l19.75">   document.getElementById(&quot;theirFPValue&quot;).value = theirs;</span>
<a href="#l19.76"></a><span id="l19.76"> </span>
<a href="#l19.77"></a><span id="l19.77">   let opts = document.getElementById(&quot;verifiedOption&quot;);</span>
<a href="#l19.78"></a><span id="l19.78">   let verified = trust ? &quot;yes&quot; : &quot;no&quot;;</span>
<a href="#l19.79"></a><span id="l19.79">   for (let item of opts.menupopup.childNodes) {</span>
<a href="#l19.80"></a><span id="l19.80">     if (verified === item.value) {</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineat">@@ -63,19 +67,20 @@ var otrAuth = {</span>
<a href="#l19.82"></a><span id="l19.82">     // This window implements the interactive authentication of a buddy's</span>
<a href="#l19.83"></a><span id="l19.83">     // key. At open time, we're given several parameters, and the &quot;mode&quot;</span>
<a href="#l19.84"></a><span id="l19.84">     // parameter tells us from where we've been called.</span>
<a href="#l19.85"></a><span id="l19.85">     // mode == &quot;pref&quot; means that we have been opened from the preferences,</span>
<a href="#l19.86"></a><span id="l19.86">     // and it means we cannot rely on the other user being online, and</span>
<a href="#l19.87"></a><span id="l19.87">     // we there might be no uiConv active currently, so we fall back.</span>
<a href="#l19.88"></a><span id="l19.88"> </span>
<a href="#l19.89"></a><span id="l19.89">     let nameSource =</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-      (mode === &quot;pref&quot;) ? contactInfo.screenname : uiConv.normalizedName;</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-    let title = await document.l10n.formatValue(</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-      &quot;auth-title&quot;, {name: nameSource});</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+      mode === &quot;pref&quot; ? contactInfo.screenname : uiConv.normalizedName;</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    let title = await document.l10n.formatValue(&quot;auth-title&quot;, {</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+      name: nameSource,</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+    });</span>
<a href="#l19.97"></a><span id="l19.97">     document.title = title;</span>
<a href="#l19.98"></a><span id="l19.98"> </span>
<a href="#l19.99"></a><span id="l19.99">     document.addEventListener(&quot;dialogaccept&quot;, () =&gt; {</span>
<a href="#l19.100"></a><span id="l19.100">       return this.accept();</span>
<a href="#l19.101"></a><span id="l19.101">     });</span>
<a href="#l19.102"></a><span id="l19.102"> </span>
<a href="#l19.103"></a><span id="l19.103">     document.addEventListener(&quot;dialogcancel&quot;, () =&gt; {</span>
<a href="#l19.104"></a><span id="l19.104">       return this.cancel();</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineat">@@ -100,33 +105,32 @@ var otrAuth = {</span>
<a href="#l19.106"></a><span id="l19.106">           contactInfo.screenname</span>
<a href="#l19.107"></a><span id="l19.107">         );</span>
<a href="#l19.108"></a><span id="l19.108">         theirs = contactInfo.fingerprint;</span>
<a href="#l19.109"></a><span id="l19.109">         populateFingers(context, theirs, contactInfo.trust);</span>
<a href="#l19.110"></a><span id="l19.110">         showSection(&quot;manualVerification&quot;, true);</span>
<a href="#l19.111"></a><span id="l19.111">         this.oninput({ value: true });</span>
<a href="#l19.112"></a><span id="l19.112">         break;</span>
<a href="#l19.113"></a><span id="l19.113">       case &quot;ask&quot;:</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-        let receivedQuestionLabel =</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-          document.getElementById(&quot;receivedQuestionLabel&quot;);</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-        let receivedQuestionDisplay =</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-          document.getElementById(&quot;receivedQuestion&quot;);</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-        let responseLabel =</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-          document.getElementById(&quot;responseLabel&quot;);</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+        let receivedQuestionLabel = document.getElementById(</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+          &quot;receivedQuestionLabel&quot;</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+        );</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+        let receivedQuestionDisplay = document.getElementById(</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+          &quot;receivedQuestion&quot;</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+        );</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+        let responseLabel = document.getElementById(&quot;responseLabel&quot;);</span>
<a href="#l19.127"></a><span id="l19.127">         if (contactInfo.question) {</span>
<a href="#l19.128"></a><span id="l19.128">           receivedQuestionLabel.hidden = false;</span>
<a href="#l19.129"></a><span id="l19.129">           receivedQuestionDisplay.hidden = false;</span>
<a href="#l19.130"></a><span id="l19.130">           receivedQuestionDisplay.value = contactInfo.question;</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-          responseLabel.value =</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-            await document.l10n.formatValue(&quot;auth-answer&quot;);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+          responseLabel.value = await document.l10n.formatValue(&quot;auth-answer&quot;);</span>
<a href="#l19.134"></a><span id="l19.134">         } else {</span>
<a href="#l19.135"></a><span id="l19.135">           receivedQuestionLabel.hidden = true;</span>
<a href="#l19.136"></a><span id="l19.136">           receivedQuestionDisplay.hidden = true;</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-          responseLabel.value =</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-            await document.l10n.formatValue(&quot;auth-secret&quot;);</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+          responseLabel.value = await document.l10n.formatValue(&quot;auth-secret&quot;);</span>
<a href="#l19.140"></a><span id="l19.140">         }</span>
<a href="#l19.141"></a><span id="l19.141">         showSection(&quot;ask&quot;, true);</span>
<a href="#l19.142"></a><span id="l19.142">         break;</span>
<a href="#l19.143"></a><span id="l19.143">     }</span>
<a href="#l19.144"></a><span id="l19.144">   },</span>
<a href="#l19.145"></a><span id="l19.145"> </span>
<a href="#l19.146"></a><span id="l19.146">   accept() {</span>
<a href="#l19.147"></a><span id="l19.147">     // uiConv may not be present in pref mode</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineat">@@ -170,25 +174,25 @@ var otrAuth = {</span>
<a href="#l19.149"></a><span id="l19.149"> </span>
<a href="#l19.150"></a><span id="l19.150">   oninput(e) {</span>
<a href="#l19.151"></a><span id="l19.151">     document.documentElement.getButton(&quot;accept&quot;).disabled = !e.value;</span>
<a href="#l19.152"></a><span id="l19.152">   },</span>
<a href="#l19.153"></a><span id="l19.153"> </span>
<a href="#l19.154"></a><span id="l19.154">   how() {</span>
<a href="#l19.155"></a><span id="l19.155">     let how = document.getElementById(&quot;howOption&quot;).selectedItem.value;</span>
<a href="#l19.156"></a><span id="l19.156">     switch (how) {</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-    case &quot;questionAndAnswer&quot;:</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-      this.oninput(document.getElementById(&quot;answer&quot;));</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-      break;</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-    case &quot;sharedSecret&quot;:</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-      this.oninput(document.getElementById(&quot;secret&quot;));</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-      break;</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-    case &quot;manualVerification&quot;:</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-      this.oninput({ value: true });</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-      break;</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+      case &quot;questionAndAnswer&quot;:</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+        this.oninput(document.getElementById(&quot;answer&quot;));</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+        break;</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineplus">+      case &quot;sharedSecret&quot;:</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+        this.oninput(document.getElementById(&quot;secret&quot;));</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+        break;</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+      case &quot;manualVerification&quot;:</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+        this.oninput({ value: true });</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+        break;</span>
<a href="#l19.175"></a><span id="l19.175">     }</span>
<a href="#l19.176"></a><span id="l19.176">     showSection(how);</span>
<a href="#l19.177"></a><span id="l19.177">   },</span>
<a href="#l19.178"></a><span id="l19.178"> </span>
<a href="#l19.179"></a><span id="l19.179">   async help() {</span>
<a href="#l19.180"></a><span id="l19.180">     let helpTitle = await document.l10n.formatValue(&quot;auth-helpTitle&quot;);</span>
<a href="#l19.181"></a><span id="l19.181">     let helpText = await document.l10n.formatValue(&quot;auth-help&quot;);</span>
<a href="#l19.182"></a><span id="l19.182">     Services.prompt.alert(window, helpTitle, helpText);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/chat/content/otr-finger.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/chat/content/otr-finger.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,19 +1,19 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-const {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-const {Localization} = ChromeUtils.import(&quot;resource://gre/modules/Localization.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+const { OTR } = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+const { Localization } = ChromeUtils.import(</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+  &quot;resource://gre/modules/Localization.jsm&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+);</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-const syncL10n = new Localization([</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-  &quot;messenger/otr/finger.ftl&quot;,</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-], true);</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+const syncL10n = new Localization([&quot;messenger/otr/finger.ftl&quot;], true);</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22"> var [account] = window.arguments;</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24"> var gFingers;</span>
<a href="#l20.25"></a><span id="l20.25"> var fingerTreeView = {</span>
<a href="#l20.26"></a><span id="l20.26">   selection: null,</span>
<a href="#l20.27"></a><span id="l20.27">   rowCount: 0,</span>
<a href="#l20.28"></a><span id="l20.28">   setTree(tree) {},</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineat">@@ -26,37 +26,50 @@ var fingerTreeView = {</span>
<a href="#l20.30"></a><span id="l20.30">       case &quot;verified&quot;: {</span>
<a href="#l20.31"></a><span id="l20.31">         let id = finger.trust ? &quot;finger-yes&quot; : &quot;finger-no&quot;;</span>
<a href="#l20.32"></a><span id="l20.32">         return syncL10n.formatValueSync(id);</span>
<a href="#l20.33"></a><span id="l20.33">       }</span>
<a href="#l20.34"></a><span id="l20.34">       default:</span>
<a href="#l20.35"></a><span id="l20.35">         return finger[column.id] || &quot;&quot;;</span>
<a href="#l20.36"></a><span id="l20.36">     }</span>
<a href="#l20.37"></a><span id="l20.37">   },</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-  isSeparator(index) { return false; },</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-  isSorted() { return false; },</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  isContainer(index) { return false; },</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  isSeparator(index) {</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+    return false;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  },</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+  isSorted() {</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+    return false;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  },</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+  isContainer(index) {</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+    return false;</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+  },</span>
<a href="#l20.50"></a><span id="l20.50">   cycleHeader(column) {},</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  getRowProperties(row) { return &quot;&quot;; },</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-  getColumnProperties(column) { return &quot;&quot;; },</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-  getCellProperties(row, column) { return &quot;&quot;; },</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  getRowProperties(row) {</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  },</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  getColumnProperties(column) {</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+  },</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+  getCellProperties(row, column) {</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+  },</span>
<a href="#l20.63"></a><span id="l20.63"> };</span>
<a href="#l20.64"></a><span id="l20.64"> </span>
<a href="#l20.65"></a><span id="l20.65"> function getSelections(tree) {</span>
<a href="#l20.66"></a><span id="l20.66">   let selections = [];</span>
<a href="#l20.67"></a><span id="l20.67">   let selection = tree.view.selection;</span>
<a href="#l20.68"></a><span id="l20.68">   if (selection) {</span>
<a href="#l20.69"></a><span id="l20.69">     let count = selection.getRangeCount();</span>
<a href="#l20.70"></a><span id="l20.70">     let min = {};</span>
<a href="#l20.71"></a><span id="l20.71">     let max = {};</span>
<a href="#l20.72"></a><span id="l20.72">     for (let i = 0; i &lt; count; i++) {</span>
<a href="#l20.73"></a><span id="l20.73">       selection.getRangeAt(i, min, max);</span>
<a href="#l20.74"></a><span id="l20.74">       for (let k = min.value; k &lt;= max.value; k++) {</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-        if (k != -1)</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+        if (k != -1) {</span>
<a href="#l20.77"></a><span id="l20.77">           selections[selections.length] = k;</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+        }</span>
<a href="#l20.79"></a><span id="l20.79">       }</span>
<a href="#l20.80"></a><span id="l20.80">     }</span>
<a href="#l20.81"></a><span id="l20.81">   }</span>
<a href="#l20.82"></a><span id="l20.82">   return selections;</span>
<a href="#l20.83"></a><span id="l20.83"> }</span>
<a href="#l20.84"></a><span id="l20.84"> </span>
<a href="#l20.85"></a><span id="l20.85"> var fingerTree;</span>
<a href="#l20.86"></a><span id="l20.86"> var otrFinger = {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineat">@@ -80,22 +93,29 @@ var otrFinger = {</span>
<a href="#l20.88"></a><span id="l20.88">     });</span>
<a href="#l20.89"></a><span id="l20.89">     this.commonRemove();</span>
<a href="#l20.90"></a><span id="l20.90">   },</span>
<a href="#l20.91"></a><span id="l20.91"> </span>
<a href="#l20.92"></a><span id="l20.92">   removeAll() {</span>
<a href="#l20.93"></a><span id="l20.93">     let confirmAllTitle = syncL10n.formatValueSync(&quot;finger-remove-all-title&quot;);</span>
<a href="#l20.94"></a><span id="l20.94">     let confirmAllText = syncL10n.formatValueSync(&quot;finger-remove-all-message&quot;);</span>
<a href="#l20.95"></a><span id="l20.95"> </span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-    let buttonPressed =</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-      Services.prompt.confirmEx(window, confirmAllTitle, confirmAllText,</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-        Services.prompt.BUTTON_POS_1_DEFAULT +</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-          Services.prompt.STD_OK_CANCEL_BUTTONS +</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-          Services.prompt.BUTTON_DELAY_ENABLE,</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-        0, 0, 0, null, {});</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+    let buttonPressed = Services.prompt.confirmEx(</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+      window,</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+      confirmAllTitle,</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+      confirmAllText,</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+      Services.prompt.BUTTON_POS_1_DEFAULT +</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+        Services.prompt.STD_OK_CANCEL_BUTTONS +</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+        Services.prompt.BUTTON_DELAY_ENABLE,</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+      0,</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+      0,</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+      0,</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+      null,</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+      {}</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+    );</span>
<a href="#l20.115"></a><span id="l20.115">     if (buttonPressed != 0) {</span>
<a href="#l20.116"></a><span id="l20.116">       return;</span>
<a href="#l20.117"></a><span id="l20.117">     }</span>
<a href="#l20.118"></a><span id="l20.118"> </span>
<a href="#l20.119"></a><span id="l20.119">     for (let j = 0; j &lt; gFingers.length; j++) {</span>
<a href="#l20.120"></a><span id="l20.120">       gFingers[j].purge = true;</span>
<a href="#l20.121"></a><span id="l20.121">     }</span>
<a href="#l20.122"></a><span id="l20.122">     this.commonRemove();</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineat">@@ -107,17 +127,17 @@ var otrFinger = {</span>
<a href="#l20.124"></a><span id="l20.124">     for (let j = 0; j &lt; gFingers.length; j++) {</span>
<a href="#l20.125"></a><span id="l20.125">       if (gFingers[j] === null) {</span>
<a href="#l20.126"></a><span id="l20.126">         let k = j;</span>
<a href="#l20.127"></a><span id="l20.127">         while (k &lt; gFingers.length &amp;&amp; gFingers[k] === null) {</span>
<a href="#l20.128"></a><span id="l20.128">           k++;</span>
<a href="#l20.129"></a><span id="l20.129">         }</span>
<a href="#l20.130"></a><span id="l20.130">         gFingers.splice(j, k - j);</span>
<a href="#l20.131"></a><span id="l20.131">         fingerTreeView.rowCount -= k - j;</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-        fingerTree.rowCountChanged(j, j - k);  // negative</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+        fingerTree.rowCountChanged(j, j - k); // negative</span>
<a href="#l20.134"></a><span id="l20.134">       }</span>
<a href="#l20.135"></a><span id="l20.135">     }</span>
<a href="#l20.136"></a><span id="l20.136">     fingerTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l20.137"></a><span id="l20.137">     if (!removalComplete) {</span>
<a href="#l20.138"></a><span id="l20.138">       let infoTitle = syncL10n.formatValueSync(&quot;finger-subset-title&quot;);</span>
<a href="#l20.139"></a><span id="l20.139">       let infoText = syncL10n.formatValueSync(&quot;finger-subset-message&quot;);</span>
<a href="#l20.140"></a><span id="l20.140">       Services.prompt.alert(window, infoTitle, infoText);</span>
<a href="#l20.141"></a><span id="l20.141">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/chat/content/otrWorker.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/chat/content/otrWorker.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -11,35 +11,42 @@ var Funcs = {};</span>
<a href="#l21.4"></a><span id="l21.4"> Funcs.generateKey = function(path, otrl_version, address) {</span>
<a href="#l21.5"></a><span id="l21.5">   let libotr = ctypes.open(path);</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7">   let abi = ctypes.default_abi;</span>
<a href="#l21.8"></a><span id="l21.8">   let gcry_error_t = ctypes.unsigned_int;</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   // Initialize the OTR library. Pass the version of the API you are using.</span>
<a href="#l21.11"></a><span id="l21.11">   let otrl_init = libotr.declare(</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    &quot;otrl_init&quot;, abi, gcry_error_t,</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-    ctypes.unsigned_int, ctypes.unsigned_int, ctypes.unsigned_int</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+    &quot;otrl_init&quot;,</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+    abi,</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+    gcry_error_t,</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    ctypes.unsigned_int,</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+    ctypes.unsigned_int,</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+    ctypes.unsigned_int</span>
<a href="#l21.20"></a><span id="l21.20">   );</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22">   // Do the private key generation calculation. You may call this from a</span>
<a href="#l21.23"></a><span id="l21.23">   // background thread.  When it completes, call</span>
<a href="#l21.24"></a><span id="l21.24">   // otrl_privkey_generate_finish from the _main_ thread.</span>
<a href="#l21.25"></a><span id="l21.25">   let otrl_privkey_generate_calculate = libotr.declare(</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-    &quot;otrl_privkey_generate_calculate&quot;, abi, gcry_error_t,</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+    &quot;otrl_privkey_generate_calculate&quot;,</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+    abi,</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+    gcry_error_t,</span>
<a href="#l21.30"></a><span id="l21.30">     ctypes.void_t.ptr</span>
<a href="#l21.31"></a><span id="l21.31">   );</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33">   otrl_init.apply(libotr, otrl_version);</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35">   let newkey = ctypes.voidptr_t(ctypes.UInt64(&quot;0x&quot; + address));</span>
<a href="#l21.36"></a><span id="l21.36">   let err = otrl_privkey_generate_calculate(newkey);</span>
<a href="#l21.37"></a><span id="l21.37">   libotr.close();</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  if (err)</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+  if (err) {</span>
<a href="#l21.40"></a><span id="l21.40">     throw new Error(&quot;otrl_privkey_generate_calculate (&quot; + err + &quot;)&quot;);</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+  }</span>
<a href="#l21.42"></a><span id="l21.42"> };</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44"> var worker = new PromiseWorker.AbstractWorker();</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46"> worker.dispatch = function(method, args = []) {</span>
<a href="#l21.47"></a><span id="l21.47">   return Funcs[method](...args);</span>
<a href="#l21.48"></a><span id="l21.48"> };</span>
<a href="#l21.49"></a><span id="l21.49"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/chat/modules/ArrayBufferUtils.jsm</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/chat/modules/ArrayBufferUtils.jsm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -2,28 +2,39 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.5"></a><span id="l22.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> /*</span>
<a href="#l22.8"></a><span id="l22.8">  * JavaScript ArrayBuffers are missing a variety of useful methods which are</span>
<a href="#l22.9"></a><span id="l22.9">  * provided by this module.</span>
<a href="#l22.10"></a><span id="l22.10">  */</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;copyBytes&quot;, &quot;ArrayBufferToBytes&quot;,</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-  &quot;BytesToArrayBuffer&quot;, &quot;StringToBytes&quot;, &quot;StringToArrayBuffer&quot;,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-  &quot;ArrayBufferToString&quot;, &quot;ArrayBufferToHexString&quot;];</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+this.EXPORTED_SYMBOLS = [</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+  &quot;copyBytes&quot;,</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+  &quot;ArrayBufferToBytes&quot;,</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+  &quot;BytesToArrayBuffer&quot;,</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+  &quot;StringToBytes&quot;,</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+  &quot;StringToArrayBuffer&quot;,</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+  &quot;ArrayBufferToString&quot;,</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+  &quot;ArrayBufferToHexString&quot;,</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+];</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25"> /*</span>
<a href="#l22.26"></a><span id="l22.26">  * aTarget / aSource are ArrayBuffers.</span>
<a href="#l22.27"></a><span id="l22.27">  *</span>
<a href="#l22.28"></a><span id="l22.28">  * Note that this is very similar to ArrayBuffer.slice except that it allows</span>
<a href="#l22.29"></a><span id="l22.29">  * for an offset in the target as well as the source.</span>
<a href="#l22.30"></a><span id="l22.30">  */</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-function copyBytes(aTarget, aSource, aTargetOffset = 0, aSourceOffset = 0,</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-                   aLength = aSource.byteLength) {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+function copyBytes(</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+  aTarget,</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+  aSource,</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+  aTargetOffset = 0,</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+  aSourceOffset = 0,</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+  aLength = aSource.byteLength</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+) {</span>
<a href="#l22.40"></a><span id="l22.40">   // The rest just gets the data copied into it.</span>
<a href="#l22.41"></a><span id="l22.41">   let view = new Uint8Array(aTarget, aTargetOffset);</span>
<a href="#l22.42"></a><span id="l22.42">   view.set(new Uint8Array(aSource, aSourceOffset, aLength));</span>
<a href="#l22.43"></a><span id="l22.43"> }</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45"> function ArrayBufferToBytes(aBuf) {</span>
<a href="#l22.46"></a><span id="l22.46">   return [...new Uint8Array(aBuf)];</span>
<a href="#l22.47"></a><span id="l22.47"> }</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineat">@@ -43,14 +54,21 @@ function StringToBytes(aString) {</span>
<a href="#l22.49"></a><span id="l22.49">   return bytes;</span>
<a href="#l22.50"></a><span id="l22.50"> }</span>
<a href="#l22.51"></a><span id="l22.51"> </span>
<a href="#l22.52"></a><span id="l22.52"> function StringToArrayBuffer(aString) {</span>
<a href="#l22.53"></a><span id="l22.53">   return BytesToArrayBuffer(StringToBytes(aString));</span>
<a href="#l22.54"></a><span id="l22.54"> }</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56"> function ArrayBufferToString(aData) {</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-  return Array.from(new Uint8Array(aData)).map(b =&gt; String.fromCharCode(b)).join(&quot;&quot;);</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+  return Array.from(new Uint8Array(aData))</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+    .map(b =&gt; String.fromCharCode(b))</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+    .join(&quot;&quot;);</span>
<a href="#l22.61"></a><span id="l22.61"> }</span>
<a href="#l22.62"></a><span id="l22.62"> </span>
<a href="#l22.63"></a><span id="l22.63"> function ArrayBufferToHexString(aData) {</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-  return &quot;0x&quot; + Array.from(new Uint8Array(aData)).map(b =&gt; (&quot;0&quot; + b.toString(16)).slice(-2)).join(&quot; &quot;);</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+  return (</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+    &quot;0x&quot; +</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+    Array.from(new Uint8Array(aData))</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+      .map(b =&gt; (&quot;0&quot; + b.toString(16)).slice(-2))</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+      .join(&quot; &quot;)</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+  );</span>
<a href="#l22.71"></a><span id="l22.71"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/chat/modules/CLib.jsm</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/chat/modules/CLib.jsm</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,74 +1,62 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.5"></a><span id="l23.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.6"></a><span id="l23.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">-const {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+const { ctypes } = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l23.12"></a><span id="l23.12"> </span>
<a href="#l23.13"></a><span id="l23.13"> var OS = Services.appinfo.OS.toLowerCase();</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15"> // type defs</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17"> var FILE = ctypes.StructType(&quot;FILE&quot;);</span>
<a href="#l23.18"></a><span id="l23.18"> var fname_t = ctypes.char.ptr;</span>
<a href="#l23.19"></a><span id="l23.19"> var wchar_t = ctypes.char16_t;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> // Set the abi and path to CLib based on the OS.</span>
<a href="#l23.22"></a><span id="l23.22"> var libcAbi, libcPath;</span>
<a href="#l23.23"></a><span id="l23.23"> var strdup = &quot;strdup&quot;;</span>
<a href="#l23.24"></a><span id="l23.24"> var fopen = &quot;fopen&quot;;</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26"> switch (OS) {</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-case &quot;win32&quot;:</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-case &quot;winnt&quot;:</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-  libcAbi = ctypes.winapi_abi;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-  libcPath = ctypes.libraryName(&quot;msvcrt&quot;);</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  strdup = &quot;_strdup&quot;;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-  fopen = &quot;_wfopen&quot;;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-  fname_t = wchar_t.ptr;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-  break;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-case &quot;darwin&quot;:</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-  libcAbi = ctypes.default_abi;</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-  libcPath = ctypes.libraryName(&quot;c&quot;);</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-  break;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-case &quot;linux&quot;:</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-  libcAbi = ctypes.default_abi;</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-  libcPath = &quot;libc.so.6&quot;;</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-  break;</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-default:</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  throw new Error(&quot;Unknown OS&quot;);</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+  case &quot;win32&quot;:</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+  case &quot;winnt&quot;:</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+    libcAbi = ctypes.winapi_abi;</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+    libcPath = ctypes.libraryName(&quot;msvcrt&quot;);</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+    strdup = &quot;_strdup&quot;;</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+    fopen = &quot;_wfopen&quot;;</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+    fname_t = wchar_t.ptr;</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+    break;</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+  case &quot;darwin&quot;:</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+    libcAbi = ctypes.default_abi;</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    libcPath = ctypes.libraryName(&quot;c&quot;);</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+    break;</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+  case &quot;linux&quot;:</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+    libcAbi = ctypes.default_abi;</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+    libcPath = &quot;libc.so.6&quot;;</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+    break;</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+  default:</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+    throw new Error(&quot;Unknown OS&quot;);</span>
<a href="#l23.63"></a><span id="l23.63"> }</span>
<a href="#l23.64"></a><span id="l23.64"> </span>
<a href="#l23.65"></a><span id="l23.65"> var libc = ctypes.open(libcPath);</span>
<a href="#l23.66"></a><span id="l23.66"> </span>
<a href="#l23.67"></a><span id="l23.67"> var CLib = {</span>
<a href="#l23.68"></a><span id="l23.68">   FILE,</span>
<a href="#l23.69"></a><span id="l23.69">   memcmp: libc.declare(</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-    &quot;memcmp&quot;, libcAbi, ctypes.int,</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+    &quot;memcmp&quot;,</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+    libcAbi,</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+    ctypes.int,</span>
<a href="#l23.74"></a><span id="l23.74">     ctypes.void_t.ptr,</span>
<a href="#l23.75"></a><span id="l23.75">     ctypes.void_t.ptr,</span>
<a href="#l23.76"></a><span id="l23.76">     ctypes.size_t</span>
<a href="#l23.77"></a><span id="l23.77">   ),</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-  free: libc.declare(</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-    &quot;free&quot;, libcAbi, ctypes.void_t,</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-    ctypes.void_t.ptr</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-  ),</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-  strdup: libc.declare(</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-    strdup, libcAbi, ctypes.char.ptr,</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-    ctypes.char.ptr</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-  ),</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-  fclose: libc.declare(</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-    &quot;fclose&quot;, libcAbi, ctypes.int,</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-    FILE.ptr</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-  ),</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-  fopen: libc.declare(</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-    fopen, libcAbi, FILE.ptr,</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-    fname_t,</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-    fname_t</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-  ),</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+  free: libc.declare(&quot;free&quot;, libcAbi, ctypes.void_t, ctypes.void_t.ptr),</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+  strdup: libc.declare(strdup, libcAbi, ctypes.char.ptr, ctypes.char.ptr),</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+  fclose: libc.declare(&quot;fclose&quot;, libcAbi, ctypes.int, FILE.ptr),</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+  fopen: libc.declare(fopen, libcAbi, FILE.ptr, fname_t, fname_t),</span>
<a href="#l23.99"></a><span id="l23.99"> };</span>
<a href="#l23.100"></a><span id="l23.100"> </span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-</span>
<a href="#l23.102"></a><span id="l23.102"> // exports</span>
<a href="#l23.103"></a><span id="l23.103"> </span>
<a href="#l23.104"></a><span id="l23.104"> this.EXPORTED_SYMBOLS = [&quot;CLib&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/modules/NormalizedMap.jsm</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/modules/NormalizedMap.jsm</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -12,30 +12,39 @@ this.EXPORTED_SYMBOLS = [&quot;NormalizedMap&quot;</span>
<a href="#l24.4"></a><span id="l24.4">  *                version of it.</span>
<a href="#l24.5"></a><span id="l24.5">  *  aIterable:    A iterable to prefill the map with, keys will be normalized.</span>
<a href="#l24.6"></a><span id="l24.6">  *</span>
<a href="#l24.7"></a><span id="l24.7">  * Returns a Map object that will automatically run aNormalize on any operations</span>
<a href="#l24.8"></a><span id="l24.8">  * involving keys.</span>
<a href="#l24.9"></a><span id="l24.9">  */</span>
<a href="#l24.10"></a><span id="l24.10"> class NormalizedMap extends Map {</span>
<a href="#l24.11"></a><span id="l24.11">   constructor(aNormalize, aIterable = []) {</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    if (typeof(aNormalize) != &quot;function&quot;)</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    if (typeof aNormalize != &quot;function&quot;) {</span>
<a href="#l24.14"></a><span id="l24.14">       throw new Error(&quot;NormalizedMap must have a normalize function!&quot;);</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+    }</span>
<a href="#l24.16"></a><span id="l24.16">     // Create the wrapped Map; use the provided iterable after normalizing the</span>
<a href="#l24.17"></a><span id="l24.17">     // keys.</span>
<a href="#l24.18"></a><span id="l24.18">     let entries = [...aIterable].map(([key, val]) =&gt; [aNormalize(key), val]);</span>
<a href="#l24.19"></a><span id="l24.19">     super(entries);</span>
<a href="#l24.20"></a><span id="l24.20">     // Note: In derived classes, super() must be called before using 'this'.</span>
<a href="#l24.21"></a><span id="l24.21">     this._normalize = aNormalize;</span>
<a href="#l24.22"></a><span id="l24.22">   }</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24">   // Dummy normalize function.</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-  _normalize(aKey) { return aKey; }</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+  _normalize(aKey) {</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+    return aKey;</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+  }</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30">   // Anything that accepts a key as an input needs to be manually overridden.</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-  delete(key) { return super.delete(this._normalize(key)); }</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-  get(key) { return super.get(this._normalize(key)); }</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-  has(key) { return super.has(this._normalize(key)); }</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+  delete(key) {</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+    return super.delete(this._normalize(key));</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  }</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+  get(key) {</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+    return super.get(this._normalize(key));</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+  }</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+  has(key) {</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+    return super.has(this._normalize(key));</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+  }</span>
<a href="#l24.43"></a><span id="l24.43">   set(key, val) {</span>
<a href="#l24.44"></a><span id="l24.44">     super.set(this._normalize(key), val);</span>
<a href="#l24.45"></a><span id="l24.45">     return this;</span>
<a href="#l24.46"></a><span id="l24.46">   }</span>
<a href="#l24.47"></a><span id="l24.47"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/chat/modules/OTR.jsm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/chat/modules/OTR.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,25 +1,27 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.6"></a><span id="l25.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">-const {Localization} = ChromeUtils.import(&quot;resource://gre/modules/Localization.jsm&quot;);</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-const {BasePromiseWorker} = ChromeUtils.import(&quot;resource://gre/modules/PromiseWorker.jsm&quot;);</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-const {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-const {CLib} = ChromeUtils.import(&quot;resource:///modules/CLib.jsm&quot;);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-const {OTRLibLoader} = ChromeUtils.import(&quot;resource:///modules/OTRLib.jsm&quot;);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+const { Localization } = ChromeUtils.import(</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+  &quot;resource://gre/modules/Localization.jsm&quot;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+);</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+const { BasePromiseWorker } = ChromeUtils.import(</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+  &quot;resource://gre/modules/PromiseWorker.jsm&quot;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+);</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+const { ctypes } = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+const { CLib } = ChromeUtils.import(&quot;resource:///modules/CLib.jsm&quot;);</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+const { OTRLibLoader } = ChromeUtils.import(&quot;resource:///modules/OTRLib.jsm&quot;);</span>
<a href="#l25.26"></a><span id="l25.26"> var workerPath = &quot;chrome://chat/content/otrWorker.js&quot;;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-const {OTRHelpers} = ChromeUtils.import(&quot;resource:///modules/OTRHelpers.jsm&quot;);</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+const { OTRHelpers } = ChromeUtils.import(&quot;resource:///modules/OTRHelpers.jsm&quot;);</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-const syncL10n = new Localization([</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  &quot;messenger/otr/otr.ftl&quot;,</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-], true);</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+const syncL10n = new Localization([&quot;messenger/otr/otr.ftl&quot;], true);</span>
<a href="#l25.34"></a><span id="l25.34"> </span>
<a href="#l25.35"></a><span id="l25.35"> function _str(id) {</span>
<a href="#l25.36"></a><span id="l25.36">   return syncL10n.formatValueSync(id);</span>
<a href="#l25.37"></a><span id="l25.37"> }</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39"> function _strArgs(id, args) {</span>
<a href="#l25.40"></a><span id="l25.40">   return syncL10n.formatValueSync(id, args);</span>
<a href="#l25.41"></a><span id="l25.41"> }</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineat">@@ -39,53 +41,66 @@ function clearInterval(timer) {</span>
<a href="#l25.43"></a><span id="l25.43"> // See: https://developer.mozilla.org/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Working_with_data#Determining_if_two_pointers_are_equal</span>
<a href="#l25.44"></a><span id="l25.44"> function comparePointers(p, q) {</span>
<a href="#l25.45"></a><span id="l25.45">   p = ctypes.cast(p, ctypes.uintptr_t).value.toString();</span>
<a href="#l25.46"></a><span id="l25.46">   q = ctypes.cast(q, ctypes.uintptr_t).value.toString();</span>
<a href="#l25.47"></a><span id="l25.47">   return p === q;</span>
<a href="#l25.48"></a><span id="l25.48"> }</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50"> function trustFingerprint(fingerprint) {</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-  return (!fingerprint.isNull() &amp;&amp;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+  return (</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+    !fingerprint.isNull() &amp;&amp;</span>
<a href="#l25.54"></a><span id="l25.54">     !fingerprint.contents.trust.isNull() &amp;&amp;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-    fingerprint.contents.trust.readString().length &gt; 0);</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+    fingerprint.contents.trust.readString().length &gt; 0</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+  );</span>
<a href="#l25.58"></a><span id="l25.58"> }</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60"> // Report whether you think the given user is online. Return 1 if you think</span>
<a href="#l25.61"></a><span id="l25.61"> // they are, 0 if you think they aren't, -1 if you're not sure.</span>
<a href="#l25.62"></a><span id="l25.62"> function isOnline(conv) {</span>
<a href="#l25.63"></a><span id="l25.63">   let ret = -1;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-  if (conv.buddy)</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+  if (conv.buddy) {</span>
<a href="#l25.66"></a><span id="l25.66">     ret = conv.buddy.online ? 1 : 0;</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+  }</span>
<a href="#l25.68"></a><span id="l25.68">   return ret;</span>
<a href="#l25.69"></a><span id="l25.69"> }</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71"> // OTRLib context wrapper</span>
<a href="#l25.72"></a><span id="l25.72"> </span>
<a href="#l25.73"></a><span id="l25.73"> function Context(context) {</span>
<a href="#l25.74"></a><span id="l25.74">   this._context = context;</span>
<a href="#l25.75"></a><span id="l25.75"> }</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77"> Context.prototype = {</span>
<a href="#l25.78"></a><span id="l25.78">   constructor: Context,</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-  get username() { return this._context.contents.username.readString(); },</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  get account() { return this._context.contents.accountname.readString(); },</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-  get protocol() { return this._context.contents.protocol.readString(); },</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-  get msgstate() { return this._context.contents.msgstate; },</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-  get fingerprint() { return this._context.contents.active_fingerprint; },</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-  get trust() { return trustFingerprint(this.fingerprint); },</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+  get username() {</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+    return this._context.contents.username.readString();</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+  },</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+  get account() {</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+    return this._context.contents.accountname.readString();</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+  },</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+  get protocol() {</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+    return this._context.contents.protocol.readString();</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+  },</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+  get msgstate() {</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+    return this._context.contents.msgstate;</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+  },</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+  get fingerprint() {</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+    return this._context.contents.active_fingerprint;</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+  },</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+  get trust() {</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+    return trustFingerprint(this.fingerprint);</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+  },</span>
<a href="#l25.103"></a><span id="l25.103"> };</span>
<a href="#l25.104"></a><span id="l25.104"> </span>
<a href="#l25.105"></a><span id="l25.105" class="difflineminus">-</span>
<a href="#l25.106"></a><span id="l25.106"> // otr module</span>
<a href="#l25.107"></a><span id="l25.107"> </span>
<a href="#l25.108"></a><span id="l25.108"> var OTRLib;</span>
<a href="#l25.109"></a><span id="l25.109"> </span>
<a href="#l25.110"></a><span id="l25.110"> var OTR = {</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-</span>
<a href="#l25.112"></a><span id="l25.112">   hasRan: false,</span>
<a href="#l25.113"></a><span id="l25.113">   libLoaded: false,</span>
<a href="#l25.114"></a><span id="l25.114">   once() {</span>
<a href="#l25.115"></a><span id="l25.115">     this.hasRan = true;</span>
<a href="#l25.116"></a><span id="l25.116">     try {</span>
<a href="#l25.117"></a><span id="l25.117">       OTRLib = OTRLibLoader.init();</span>
<a href="#l25.118"></a><span id="l25.118">       if (!OTRLib) {</span>
<a href="#l25.119"></a><span id="l25.119">         return;</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineat">@@ -101,37 +116,39 @@ var OTR = {</span>
<a href="#l25.121"></a><span id="l25.121"> </span>
<a href="#l25.122"></a><span id="l25.122">   privateKeyPath: OTRHelpers.profilePath(&quot;otr.private_key&quot;),</span>
<a href="#l25.123"></a><span id="l25.123">   fingerprintsPath: OTRHelpers.profilePath(&quot;otr.fingerprints&quot;),</span>
<a href="#l25.124"></a><span id="l25.124">   instanceTagsPath: OTRHelpers.profilePath(&quot;otr.instance_tags&quot;),</span>
<a href="#l25.125"></a><span id="l25.125"> </span>
<a href="#l25.126"></a><span id="l25.126">   init(opts) {</span>
<a href="#l25.127"></a><span id="l25.127">     opts = opts || {};</span>
<a href="#l25.128"></a><span id="l25.128"> </span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-    if (!this.hasRan)</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+    if (!this.hasRan) {</span>
<a href="#l25.131"></a><span id="l25.131">       this.once();</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+    }</span>
<a href="#l25.133"></a><span id="l25.133"> </span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-    if (!OTR.libLoaded)</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+    if (!OTR.libLoaded) {</span>
<a href="#l25.136"></a><span id="l25.136">       return;</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+    }</span>
<a href="#l25.138"></a><span id="l25.138"> </span>
<a href="#l25.139"></a><span id="l25.139">     this.userstate = OTRLib.otrl_userstate_create();</span>
<a href="#l25.140"></a><span id="l25.140"> </span>
<a href="#l25.141"></a><span id="l25.141">     // A map of UIConvs, keyed on the target.id</span>
<a href="#l25.142"></a><span id="l25.142">     this._convos = new Map();</span>
<a href="#l25.143"></a><span id="l25.143">     this._observers = [];</span>
<a href="#l25.144"></a><span id="l25.144">     this._buffer = [];</span>
<a href="#l25.145"></a><span id="l25.145">     this._poll_timer = null;</span>
<a href="#l25.146"></a><span id="l25.146"> </span>
<a href="#l25.147"></a><span id="l25.147">     // Async sending may fail in the transport protocols, so periodically</span>
<a href="#l25.148"></a><span id="l25.148">     // drop old messages from the internal buffer. Should be rare.</span>
<a href="#l25.149"></a><span id="l25.149">     const pluck_time = 1 * 60 * 1000;</span>
<a href="#l25.150"></a><span id="l25.150">     this._pluck_timer = setInterval(() =&gt; {</span>
<a href="#l25.151"></a><span id="l25.151">       let buf = this._buffer;</span>
<a href="#l25.152"></a><span id="l25.152">       for (let i = 0; i &lt; buf.length;) {</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineminus">-        if ((Date.now() - buf[i].time) &gt; pluck_time) {</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+        if (Date.now() - buf[i].time &gt; pluck_time) {</span>
<a href="#l25.155"></a><span id="l25.155">           this.log(&quot;dropping an old message: &quot; + buf[i].display);</span>
<a href="#l25.156"></a><span id="l25.156">           buf.splice(i, 1);</span>
<a href="#l25.157"></a><span id="l25.157">         } else {</span>
<a href="#l25.158"></a><span id="l25.158">           i += 1;</span>
<a href="#l25.159"></a><span id="l25.159">         }</span>
<a href="#l25.160"></a><span id="l25.160">       }</span>
<a href="#l25.161"></a><span id="l25.161">     }, pluck_time);</span>
<a href="#l25.162"></a><span id="l25.162">   },</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineat">@@ -150,137 +167,186 @@ var OTR = {</span>
<a href="#l25.164"></a><span id="l25.164"> </span>
<a href="#l25.165"></a><span id="l25.165">   log(msg) {</span>
<a href="#l25.166"></a><span id="l25.166">     this.notifyObservers(msg, &quot;otr:log&quot;);</span>
<a href="#l25.167"></a><span id="l25.167">   },</span>
<a href="#l25.168"></a><span id="l25.168"> </span>
<a href="#l25.169"></a><span id="l25.169">   // load stored files from my profile</span>
<a href="#l25.170"></a><span id="l25.170">   loadFiles() {</span>
<a href="#l25.171"></a><span id="l25.171">     return Promise.all([</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineminus">-      OS.File.exists(this.privateKeyPath).then((exists) =&gt; {</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineminus">-        if (exists &amp;&amp; OTRLib.otrl_privkey_read(</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-          this.userstate, this.privateKeyPath</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-        )) throw new Error(&quot;Failed to read private keys.&quot;);</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineplus">+      OS.File.exists(this.privateKeyPath).then(exists =&gt; {</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+        if (</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineplus">+          exists &amp;&amp;</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineplus">+          OTRLib.otrl_privkey_read(this.userstate, this.privateKeyPath)</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineplus">+        ) {</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+          throw new Error(&quot;Failed to read private keys.&quot;);</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineplus">+        }</span>
<a href="#l25.183"></a><span id="l25.183">       }),</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-      OS.File.exists(this.fingerprintsPath).then((exists) =&gt; {</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineminus">-        if (exists &amp;&amp; OTRLib.otrl_privkey_read_fingerprints(</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineminus">-          this.userstate, this.fingerprintsPath, null, null</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-        )) throw new Error(&quot;Failed to read fingerprints.&quot;);</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineplus">+      OS.File.exists(this.fingerprintsPath).then(exists =&gt; {</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineplus">+        if (</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineplus">+          exists &amp;&amp;</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+          OTRLib.otrl_privkey_read_fingerprints(</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+            this.userstate,</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+            this.fingerprintsPath,</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+            null,</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineplus">+            null</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineplus">+          )</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineplus">+        ) {</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineplus">+          throw new Error(&quot;Failed to read fingerprints.&quot;);</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineplus">+        }</span>
<a href="#l25.200"></a><span id="l25.200">       }),</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineminus">-      OS.File.exists(this.instanceTagsPath).then((exists) =&gt; {</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineminus">-        if (exists &amp;&amp; OTRLib.otrl_instag_read(</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineminus">-          this.userstate, this.instanceTagsPath</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineminus">-        )) throw new Error(&quot;Failed to read instance tags.&quot;);</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineplus">+      OS.File.exists(this.instanceTagsPath).then(exists =&gt; {</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineplus">+        if (</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineplus">+          exists &amp;&amp;</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineplus">+          OTRLib.otrl_instag_read(this.userstate, this.instanceTagsPath)</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineplus">+        ) {</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineplus">+          throw new Error(&quot;Failed to read instance tags.&quot;);</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineplus">+        }</span>
<a href="#l25.212"></a><span id="l25.212">       }),</span>
<a href="#l25.213"></a><span id="l25.213">     ]);</span>
<a href="#l25.214"></a><span id="l25.214">   },</span>
<a href="#l25.215"></a><span id="l25.215"> </span>
<a href="#l25.216"></a><span id="l25.216">   // generate a private key in a worker</span>
<a href="#l25.217"></a><span id="l25.217">   generatePrivateKey(account, protocol) {</span>
<a href="#l25.218"></a><span id="l25.218">     let newkey = new ctypes.void_t.ptr();</span>
<a href="#l25.219"></a><span id="l25.219">     let err = OTRLib.otrl_privkey_generate_start(</span>
<a href="#l25.220"></a><span id="l25.220" class="difflineminus">-      OTR.userstate, account, protocol, newkey.address()</span>
<a href="#l25.221"></a><span id="l25.221" class="difflineplus">+      OTR.userstate,</span>
<a href="#l25.222"></a><span id="l25.222" class="difflineplus">+      account,</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineplus">+      protocol,</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineplus">+      newkey.address()</span>
<a href="#l25.225"></a><span id="l25.225">     );</span>
<a href="#l25.226"></a><span id="l25.226" class="difflineminus">-    if (err || newkey.isNull())</span>
<a href="#l25.227"></a><span id="l25.227" class="difflineplus">+    if (err || newkey.isNull()) {</span>
<a href="#l25.228"></a><span id="l25.228">       return Promise.reject(&quot;otrl_privkey_generate_start (&quot; + err + &quot;)&quot;);</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineplus">+    }</span>
<a href="#l25.230"></a><span id="l25.230"> </span>
<a href="#l25.231"></a><span id="l25.231">     let keyPtrSrc = newkey.toSource();</span>
<a href="#l25.232"></a><span id="l25.232">     let re = new RegExp(</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineminus">-      &quot;^ctypes\\.voidptr_t\\(ctypes\\.UInt64\\(\&quot;0x([0-9a-fA-F]+)\&quot;\\)\\)$&quot;);</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineplus">+      '^ctypes\\.voidptr_t\\(ctypes\\.UInt64\\(&quot;0x([0-9a-fA-F]+)&quot;\\)\\)$'</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineplus">+    );</span>
<a href="#l25.236"></a><span id="l25.236">     let address;</span>
<a href="#l25.237"></a><span id="l25.237">     let match = re.exec(keyPtrSrc);</span>
<a href="#l25.238"></a><span id="l25.238">     if (match) {</span>
<a href="#l25.239"></a><span id="l25.239">       address = match[1];</span>
<a href="#l25.240"></a><span id="l25.240">     }</span>
<a href="#l25.241"></a><span id="l25.241"> </span>
<a href="#l25.242"></a><span id="l25.242">     if (!address) {</span>
<a href="#l25.243"></a><span id="l25.243">       OTRLib.otrl_privkey_generate_cancelled(OTR.userstate, newkey);</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineminus">-      throw new Error(&quot;generatePrivateKey failed to parse ptr.toSource(): &quot; + keyPtrSrc);</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineplus">+      throw new Error(</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineplus">+        &quot;generatePrivateKey failed to parse ptr.toSource(): &quot; + keyPtrSrc</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineplus">+      );</span>
<a href="#l25.248"></a><span id="l25.248">     }</span>
<a href="#l25.249"></a><span id="l25.249"> </span>
<a href="#l25.250"></a><span id="l25.250">     let worker = new BasePromiseWorker(workerPath);</span>
<a href="#l25.251"></a><span id="l25.251" class="difflineminus">-    return worker.post(&quot;generateKey&quot;, [</span>
<a href="#l25.252"></a><span id="l25.252" class="difflineminus">-      OTRLib.path, OTRLib.otrl_version, address,</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineminus">-    ]).then(function() {</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineminus">-      let err = OTRLib.otrl_privkey_generate_finish(</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineminus">-        OTR.userstate, newkey, OTR.privateKeyPath</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineminus">-      );</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineminus">-      if (err)</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineminus">-        throw new Error(&quot;otrl_privkey_generate_calculate (&quot; + err + &quot;)&quot;);</span>
<a href="#l25.259"></a><span id="l25.259" class="difflineminus">-    }).catch(function(err) {</span>
<a href="#l25.260"></a><span id="l25.260" class="difflineminus">-      if (!newkey.isNull())</span>
<a href="#l25.261"></a><span id="l25.261" class="difflineminus">-        OTRLib.otrl_privkey_generate_cancelled(OTR.userstate, newkey);</span>
<a href="#l25.262"></a><span id="l25.262" class="difflineminus">-      throw err;</span>
<a href="#l25.263"></a><span id="l25.263" class="difflineminus">-    });</span>
<a href="#l25.264"></a><span id="l25.264" class="difflineplus">+    return worker</span>
<a href="#l25.265"></a><span id="l25.265" class="difflineplus">+      .post(&quot;generateKey&quot;, [OTRLib.path, OTRLib.otrl_version, address])</span>
<a href="#l25.266"></a><span id="l25.266" class="difflineplus">+      .then(function() {</span>
<a href="#l25.267"></a><span id="l25.267" class="difflineplus">+        let err = OTRLib.otrl_privkey_generate_finish(</span>
<a href="#l25.268"></a><span id="l25.268" class="difflineplus">+          OTR.userstate,</span>
<a href="#l25.269"></a><span id="l25.269" class="difflineplus">+          newkey,</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineplus">+          OTR.privateKeyPath</span>
<a href="#l25.271"></a><span id="l25.271" class="difflineplus">+        );</span>
<a href="#l25.272"></a><span id="l25.272" class="difflineplus">+        if (err) {</span>
<a href="#l25.273"></a><span id="l25.273" class="difflineplus">+          throw new Error(&quot;otrl_privkey_generate_calculate (&quot; + err + &quot;)&quot;);</span>
<a href="#l25.274"></a><span id="l25.274" class="difflineplus">+        }</span>
<a href="#l25.275"></a><span id="l25.275" class="difflineplus">+      })</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineplus">+      .catch(function(err) {</span>
<a href="#l25.277"></a><span id="l25.277" class="difflineplus">+        if (!newkey.isNull()) {</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineplus">+          OTRLib.otrl_privkey_generate_cancelled(OTR.userstate, newkey);</span>
<a href="#l25.279"></a><span id="l25.279" class="difflineplus">+        }</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineplus">+        throw err;</span>
<a href="#l25.281"></a><span id="l25.281" class="difflineplus">+      });</span>
<a href="#l25.282"></a><span id="l25.282">   },</span>
<a href="#l25.283"></a><span id="l25.283"> </span>
<a href="#l25.284"></a><span id="l25.284">   generatePrivateKeySync(account, protocol) {</span>
<a href="#l25.285"></a><span id="l25.285">     let newkey = new ctypes.void_t.ptr();</span>
<a href="#l25.286"></a><span id="l25.286">     let err = OTRLib.otrl_privkey_generate_start(</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineminus">-      OTR.userstate, account, protocol, newkey.address()</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineplus">+      OTR.userstate,</span>
<a href="#l25.289"></a><span id="l25.289" class="difflineplus">+      account,</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineplus">+      protocol,</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineplus">+      newkey.address()</span>
<a href="#l25.292"></a><span id="l25.292">     );</span>
<a href="#l25.293"></a><span id="l25.293" class="difflineminus">-    if (err || newkey.isNull())</span>
<a href="#l25.294"></a><span id="l25.294" class="difflineplus">+    if (err || newkey.isNull()) {</span>
<a href="#l25.295"></a><span id="l25.295">       return &quot;otrl_privkey_generate_start (&quot; + err + &quot;)&quot;;</span>
<a href="#l25.296"></a><span id="l25.296" class="difflineplus">+    }</span>
<a href="#l25.297"></a><span id="l25.297"> </span>
<a href="#l25.298"></a><span id="l25.298">     err = OTRLib.otrl_privkey_generate_calculate(newkey);</span>
<a href="#l25.299"></a><span id="l25.299">     if (!err) {</span>
<a href="#l25.300"></a><span id="l25.300">       err = OTRLib.otrl_privkey_generate_finish(</span>
<a href="#l25.301"></a><span id="l25.301" class="difflineminus">-        OTR.userstate, newkey, OTR.privateKeyPath);</span>
<a href="#l25.302"></a><span id="l25.302" class="difflineplus">+        OTR.userstate,</span>
<a href="#l25.303"></a><span id="l25.303" class="difflineplus">+        newkey,</span>
<a href="#l25.304"></a><span id="l25.304" class="difflineplus">+        OTR.privateKeyPath</span>
<a href="#l25.305"></a><span id="l25.305" class="difflineplus">+      );</span>
<a href="#l25.306"></a><span id="l25.306">     }</span>
<a href="#l25.307"></a><span id="l25.307">     if (err &amp;&amp; !newkey.isNull()) {</span>
<a href="#l25.308"></a><span id="l25.308">       OTRLib.otrl_privkey_generate_cancelled(OTR.userstate, newkey);</span>
<a href="#l25.309"></a><span id="l25.309">     }</span>
<a href="#l25.310"></a><span id="l25.310"> </span>
<a href="#l25.311"></a><span id="l25.311">     if (err) {</span>
<a href="#l25.312"></a><span id="l25.312">       return &quot;otrl_privkey_generate_calculate (&quot; + err + &quot;)&quot;;</span>
<a href="#l25.313"></a><span id="l25.313">     }</span>
<a href="#l25.314"></a><span id="l25.314">     return null;</span>
<a href="#l25.315"></a><span id="l25.315">   },</span>
<a href="#l25.316"></a><span id="l25.316"> </span>
<a href="#l25.317"></a><span id="l25.317">   // write fingerprints to file synchronously</span>
<a href="#l25.318"></a><span id="l25.318">   writeFingerprints() {</span>
<a href="#l25.319"></a><span id="l25.319" class="difflineminus">-    if (OTRLib.otrl_privkey_write_fingerprints(</span>
<a href="#l25.320"></a><span id="l25.320" class="difflineminus">-      this.userstate, this.fingerprintsPath</span>
<a href="#l25.321"></a><span id="l25.321" class="difflineminus">-    )) throw new Error(&quot;Failed to write fingerprints.&quot;);</span>
<a href="#l25.322"></a><span id="l25.322" class="difflineplus">+    if (</span>
<a href="#l25.323"></a><span id="l25.323" class="difflineplus">+      OTRLib.otrl_privkey_write_fingerprints(</span>
<a href="#l25.324"></a><span id="l25.324" class="difflineplus">+        this.userstate,</span>
<a href="#l25.325"></a><span id="l25.325" class="difflineplus">+        this.fingerprintsPath</span>
<a href="#l25.326"></a><span id="l25.326" class="difflineplus">+      )</span>
<a href="#l25.327"></a><span id="l25.327" class="difflineplus">+    ) {</span>
<a href="#l25.328"></a><span id="l25.328" class="difflineplus">+      throw new Error(&quot;Failed to write fingerprints.&quot;);</span>
<a href="#l25.329"></a><span id="l25.329" class="difflineplus">+    }</span>
<a href="#l25.330"></a><span id="l25.330">   },</span>
<a href="#l25.331"></a><span id="l25.331"> </span>
<a href="#l25.332"></a><span id="l25.332">   // generate instance tag synchronously</span>
<a href="#l25.333"></a><span id="l25.333">   generateInstanceTag(account, protocol) {</span>
<a href="#l25.334"></a><span id="l25.334" class="difflineminus">-    if (OTRLib.otrl_instag_generate(</span>
<a href="#l25.335"></a><span id="l25.335" class="difflineminus">-      this.userstate, this.instanceTagsPath, account, protocol</span>
<a href="#l25.336"></a><span id="l25.336" class="difflineminus">-    )) throw new Error(&quot;Failed to generate instance tag.&quot;);</span>
<a href="#l25.337"></a><span id="l25.337" class="difflineplus">+    if (</span>
<a href="#l25.338"></a><span id="l25.338" class="difflineplus">+      OTRLib.otrl_instag_generate(</span>
<a href="#l25.339"></a><span id="l25.339" class="difflineplus">+        this.userstate,</span>
<a href="#l25.340"></a><span id="l25.340" class="difflineplus">+        this.instanceTagsPath,</span>
<a href="#l25.341"></a><span id="l25.341" class="difflineplus">+        account,</span>
<a href="#l25.342"></a><span id="l25.342" class="difflineplus">+        protocol</span>
<a href="#l25.343"></a><span id="l25.343" class="difflineplus">+      )</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineplus">+    ) {</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineplus">+      throw new Error(&quot;Failed to generate instance tag.&quot;);</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineplus">+    }</span>
<a href="#l25.347"></a><span id="l25.347">   },</span>
<a href="#l25.348"></a><span id="l25.348"> </span>
<a href="#l25.349"></a><span id="l25.349">   // get my fingerprint</span>
<a href="#l25.350"></a><span id="l25.350">   privateKeyFingerprint(account, protocol) {</span>
<a href="#l25.351"></a><span id="l25.351">     let fingerprint = OTRLib.otrl_privkey_fingerprint(</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineminus">-      this.userstate, new OTRLib.fingerprint_t(), account, protocol</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineplus">+      this.userstate,</span>
<a href="#l25.354"></a><span id="l25.354" class="difflineplus">+      new OTRLib.fingerprint_t(),</span>
<a href="#l25.355"></a><span id="l25.355" class="difflineplus">+      account,</span>
<a href="#l25.356"></a><span id="l25.356" class="difflineplus">+      protocol</span>
<a href="#l25.357"></a><span id="l25.357">     );</span>
<a href="#l25.358"></a><span id="l25.358">     return fingerprint.isNull() ? null : fingerprint.readString();</span>
<a href="#l25.359"></a><span id="l25.359">   },</span>
<a href="#l25.360"></a><span id="l25.360"> </span>
<a href="#l25.361"></a><span id="l25.361">   // return a human readable string for a fingerprint</span>
<a href="#l25.362"></a><span id="l25.362">   hashToHuman(fingerprint) {</span>
<a href="#l25.363"></a><span id="l25.363">     let hash;</span>
<a href="#l25.364"></a><span id="l25.364">     try {</span>
<a href="#l25.365"></a><span id="l25.365">       hash = fingerprint.contents.fingerprint;</span>
<a href="#l25.366"></a><span id="l25.366">     } catch (e) {}</span>
<a href="#l25.367"></a><span id="l25.367" class="difflineminus">-    if (!hash || hash.isNull())</span>
<a href="#l25.368"></a><span id="l25.368" class="difflineplus">+    if (!hash || hash.isNull()) {</span>
<a href="#l25.369"></a><span id="l25.369">       throw new Error(&quot;No fingerprint found.&quot;);</span>
<a href="#l25.370"></a><span id="l25.370" class="difflineplus">+    }</span>
<a href="#l25.371"></a><span id="l25.371">     let human = new OTRLib.fingerprint_t();</span>
<a href="#l25.372"></a><span id="l25.372">     OTRLib.otrl_privkey_hash_to_human(human, hash);</span>
<a href="#l25.373"></a><span id="l25.373">     return human.readString();</span>
<a href="#l25.374"></a><span id="l25.374">   },</span>
<a href="#l25.375"></a><span id="l25.375"> </span>
<a href="#l25.376"></a><span id="l25.376">   base64encode(data, dataLen) {</span>
<a href="#l25.377"></a><span id="l25.377">     // CData objects are initialized with zeroes.  The plus one gives us</span>
<a href="#l25.378"></a><span id="l25.378">     // our null byte so that readString below is safe.</span>
<a href="#l25.379"></a><span id="l25.379">     let buf = ctypes.char.array(Math.floor((dataLen + 2) / 3) * 4 + 1)();</span>
<a href="#l25.380"></a><span id="l25.380">     OTRLib.otrl_base64_encode(buf, data, dataLen); // ignore returned size</span>
<a href="#l25.381"></a><span id="l25.381" class="difflineminus">-    return buf.readString();  // str</span>
<a href="#l25.382"></a><span id="l25.382" class="difflineplus">+    return buf.readString(); // str</span>
<a href="#l25.383"></a><span id="l25.383">   },</span>
<a href="#l25.384"></a><span id="l25.384"> </span>
<a href="#l25.385"></a><span id="l25.385">   base64decode(str) {</span>
<a href="#l25.386"></a><span id="l25.386">     let size = str.length;</span>
<a href="#l25.387"></a><span id="l25.387">     // +1 here so that we're safe in calling readString on data in the tests.</span>
<a href="#l25.388"></a><span id="l25.388">     let data = ctypes.unsigned_char.array(Math.floor((size + 3) / 4) * 3 + 1)();</span>
<a href="#l25.389"></a><span id="l25.389">     OTRLib.otrl_base64_decode(data, str, size); // ignore returned len</span>
<a href="#l25.390"></a><span id="l25.390">     // We aren't returning the dataLen since we know the hash length in our</span>
<a href="#l25.391"></a><span id="l25.391" class="difflineat">@@ -305,23 +371,26 @@ var OTR = {</span>
<a href="#l25.392"></a><span id="l25.392">   knownFingerprints(forAccount) {</span>
<a href="#l25.393"></a><span id="l25.393">     let fps = [];</span>
<a href="#l25.394"></a><span id="l25.394">     for (</span>
<a href="#l25.395"></a><span id="l25.395">       let context = this.userstate.contents.context_root;</span>
<a href="#l25.396"></a><span id="l25.396">       !context.isNull();</span>
<a href="#l25.397"></a><span id="l25.397">       context = context.contents.next</span>
<a href="#l25.398"></a><span id="l25.398">     ) {</span>
<a href="#l25.399"></a><span id="l25.399">       // skip child contexts</span>
<a href="#l25.400"></a><span id="l25.400" class="difflineminus">-      if (!comparePointers(context.contents.m_context, context))</span>
<a href="#l25.401"></a><span id="l25.401" class="difflineplus">+      if (!comparePointers(context.contents.m_context, context)) {</span>
<a href="#l25.402"></a><span id="l25.402">         continue;</span>
<a href="#l25.403"></a><span id="l25.403" class="difflineplus">+      }</span>
<a href="#l25.404"></a><span id="l25.404">       let wContext = new Context(context);</span>
<a href="#l25.405"></a><span id="l25.405"> </span>
<a href="#l25.406"></a><span id="l25.406">       if (forAccount) {</span>
<a href="#l25.407"></a><span id="l25.407" class="difflineminus">-        if (forAccount.normalizedName != wContext.account ||</span>
<a href="#l25.408"></a><span id="l25.408" class="difflineminus">-            forAccount.protocol.normalizedName != wContext.protocol) {</span>
<a href="#l25.409"></a><span id="l25.409" class="difflineplus">+        if (</span>
<a href="#l25.410"></a><span id="l25.410" class="difflineplus">+          forAccount.normalizedName != wContext.account ||</span>
<a href="#l25.411"></a><span id="l25.411" class="difflineplus">+          forAccount.protocol.normalizedName != wContext.protocol</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineplus">+        ) {</span>
<a href="#l25.413"></a><span id="l25.413">           continue;</span>
<a href="#l25.414"></a><span id="l25.414">         }</span>
<a href="#l25.415"></a><span id="l25.415">       }</span>
<a href="#l25.416"></a><span id="l25.416"> </span>
<a href="#l25.417"></a><span id="l25.417">       for (</span>
<a href="#l25.418"></a><span id="l25.418">         let fingerprint = context.contents.fingerprint_root.next;</span>
<a href="#l25.419"></a><span id="l25.419">         !fingerprint.isNull();</span>
<a href="#l25.420"></a><span id="l25.420">         fingerprint = fingerprint.contents.next</span>
<a href="#l25.421"></a><span id="l25.421" class="difflineat">@@ -346,135 +415,166 @@ var OTR = {</span>
<a href="#l25.422"></a><span id="l25.422">    */</span>
<a href="#l25.423"></a><span id="l25.423">   forgetFingerprints(fps) {</span>
<a href="#l25.424"></a><span id="l25.424">     let result = true;</span>
<a href="#l25.425"></a><span id="l25.425">     let write = false;</span>
<a href="#l25.426"></a><span id="l25.426">     fps.forEach(function(obj, i) {</span>
<a href="#l25.427"></a><span id="l25.427">       if (!obj.purge) {</span>
<a href="#l25.428"></a><span id="l25.428">         return;</span>
<a href="#l25.429"></a><span id="l25.429">       }</span>
<a href="#l25.430"></a><span id="l25.430" class="difflineminus">-      obj.purge = false;  // reset early</span>
<a href="#l25.431"></a><span id="l25.431" class="difflineplus">+      obj.purge = false; // reset early</span>
<a href="#l25.432"></a><span id="l25.432">       let fingerprint = obj.fpointer;</span>
<a href="#l25.433"></a><span id="l25.433">       if (fingerprint.isNull()) {</span>
<a href="#l25.434"></a><span id="l25.434">         return;</span>
<a href="#l25.435"></a><span id="l25.435">       }</span>
<a href="#l25.436"></a><span id="l25.436">       // don't remove if fp is active and we're in an encrypted state</span>
<a href="#l25.437"></a><span id="l25.437">       let context = fingerprint.contents.context.contents.m_context;</span>
<a href="#l25.438"></a><span id="l25.438">       for (</span>
<a href="#l25.439"></a><span id="l25.439">         let context_itr = context;</span>
<a href="#l25.440"></a><span id="l25.440">         !context_itr.isNull() &amp;&amp;</span>
<a href="#l25.441"></a><span id="l25.441" class="difflineminus">-          comparePointers(context_itr.contents.m_context, context);</span>
<a href="#l25.442"></a><span id="l25.442" class="difflineplus">+        comparePointers(context_itr.contents.m_context, context);</span>
<a href="#l25.443"></a><span id="l25.443">         context_itr = context_itr.contents.next</span>
<a href="#l25.444"></a><span id="l25.444">       ) {</span>
<a href="#l25.445"></a><span id="l25.445">         if (</span>
<a href="#l25.446"></a><span id="l25.446" class="difflineminus">-          context_itr.contents.msgstate === OTRLib.messageState.OTRL_MSGSTATE_ENCRYPTED &amp;&amp;</span>
<a href="#l25.447"></a><span id="l25.447" class="difflineplus">+          context_itr.contents.msgstate ===</span>
<a href="#l25.448"></a><span id="l25.448" class="difflineplus">+            OTRLib.messageState.OTRL_MSGSTATE_ENCRYPTED &amp;&amp;</span>
<a href="#l25.449"></a><span id="l25.449">           comparePointers(context_itr.contents.active_fingerprint, fingerprint)</span>
<a href="#l25.450"></a><span id="l25.450">         ) {</span>
<a href="#l25.451"></a><span id="l25.451">           result = false;</span>
<a href="#l25.452"></a><span id="l25.452">           return;</span>
<a href="#l25.453"></a><span id="l25.453">         }</span>
<a href="#l25.454"></a><span id="l25.454">       }</span>
<a href="#l25.455"></a><span id="l25.455">       write = true;</span>
<a href="#l25.456"></a><span id="l25.456">       OTRLib.otrl_context_forget_fingerprint(fingerprint, 1);</span>
<a href="#l25.457"></a><span id="l25.457" class="difflineminus">-      fps[i] = null;  // null out removed fps</span>
<a href="#l25.458"></a><span id="l25.458" class="difflineplus">+      fps[i] = null; // null out removed fps</span>
<a href="#l25.459"></a><span id="l25.459">     });</span>
<a href="#l25.460"></a><span id="l25.460">     if (write) {</span>
<a href="#l25.461"></a><span id="l25.461">       OTR.writeFingerprints();</span>
<a href="#l25.462"></a><span id="l25.462">     }</span>
<a href="#l25.463"></a><span id="l25.463">     return result;</span>
<a href="#l25.464"></a><span id="l25.464">   },</span>
<a href="#l25.465"></a><span id="l25.465"> </span>
<a href="#l25.466"></a><span id="l25.466">   addFingerprint(context, hex) {</span>
<a href="#l25.467"></a><span id="l25.467">     let fingerprint = new OTRLib.hash_t();</span>
<a href="#l25.468"></a><span id="l25.468" class="difflineminus">-    if (hex.length != 40) throw new Error(&quot;Invalid fingerprint value.&quot;);</span>
<a href="#l25.469"></a><span id="l25.469" class="difflineplus">+    if (hex.length != 40) {</span>
<a href="#l25.470"></a><span id="l25.470" class="difflineplus">+      throw new Error(&quot;Invalid fingerprint value.&quot;);</span>
<a href="#l25.471"></a><span id="l25.471" class="difflineplus">+    }</span>
<a href="#l25.472"></a><span id="l25.472">     let bytes = hex.match(/.{1,2}/g);</span>
<a href="#l25.473"></a><span id="l25.473" class="difflineminus">-    for (let i = 0; i &lt; 20; i++)</span>
<a href="#l25.474"></a><span id="l25.474" class="difflineplus">+    for (let i = 0; i &lt; 20; i++) {</span>
<a href="#l25.475"></a><span id="l25.475">       fingerprint[i] = parseInt(bytes[i], 16);</span>
<a href="#l25.476"></a><span id="l25.476" class="difflineminus">-    return OTRLib.otrl_context_find_fingerprint(context._context, fingerprint, 1, null);</span>
<a href="#l25.477"></a><span id="l25.477" class="difflineplus">+    }</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineplus">+    return OTRLib.otrl_context_find_fingerprint(</span>
<a href="#l25.479"></a><span id="l25.479" class="difflineplus">+      context._context,</span>
<a href="#l25.480"></a><span id="l25.480" class="difflineplus">+      fingerprint,</span>
<a href="#l25.481"></a><span id="l25.481" class="difflineplus">+      1,</span>
<a href="#l25.482"></a><span id="l25.482" class="difflineplus">+      null</span>
<a href="#l25.483"></a><span id="l25.483" class="difflineplus">+    );</span>
<a href="#l25.484"></a><span id="l25.484">   },</span>
<a href="#l25.485"></a><span id="l25.485"> </span>
<a href="#l25.486"></a><span id="l25.486">   getFingerprintsForRecipient(account, protocol, recipient) {</span>
<a href="#l25.487"></a><span id="l25.487">     let fingers = OTR.knownFingerprints();</span>
<a href="#l25.488"></a><span id="l25.488">     return fingers.filter(function(fg) {</span>
<a href="#l25.489"></a><span id="l25.489" class="difflineminus">-      return fg.account == account &amp;&amp;</span>
<a href="#l25.490"></a><span id="l25.490" class="difflineminus">-             fg.protocol == protocol &amp;&amp;</span>
<a href="#l25.491"></a><span id="l25.491" class="difflineminus">-             fg.screenname == recipient;</span>
<a href="#l25.492"></a><span id="l25.492" class="difflineplus">+      return (</span>
<a href="#l25.493"></a><span id="l25.493" class="difflineplus">+        fg.account == account &amp;&amp;</span>
<a href="#l25.494"></a><span id="l25.494" class="difflineplus">+        fg.protocol == protocol &amp;&amp;</span>
<a href="#l25.495"></a><span id="l25.495" class="difflineplus">+        fg.screenname == recipient</span>
<a href="#l25.496"></a><span id="l25.496" class="difflineplus">+      );</span>
<a href="#l25.497"></a><span id="l25.497">     });</span>
<a href="#l25.498"></a><span id="l25.498">   },</span>
<a href="#l25.499"></a><span id="l25.499"> </span>
<a href="#l25.500"></a><span id="l25.500">   isFingerprintTrusted(fingerprint) {</span>
<a href="#l25.501"></a><span id="l25.501">     return !!OTRLib.otrl_context_is_fingerprint_trusted(fingerprint);</span>
<a href="#l25.502"></a><span id="l25.502">   },</span>
<a href="#l25.503"></a><span id="l25.503"> </span>
<a href="#l25.504"></a><span id="l25.504">   // update trust in fingerprint</span>
<a href="#l25.505"></a><span id="l25.505">   setTrust(fingerprint, trust, context) {</span>
<a href="#l25.506"></a><span id="l25.506">     // ignore if no change in trust</span>
<a href="#l25.507"></a><span id="l25.507" class="difflineminus">-    if (context &amp;&amp; (trust === context.trust))</span>
<a href="#l25.508"></a><span id="l25.508" class="difflineplus">+    if (context &amp;&amp; trust === context.trust) {</span>
<a href="#l25.509"></a><span id="l25.509">       return;</span>
<a href="#l25.510"></a><span id="l25.510" class="difflineplus">+    }</span>
<a href="#l25.511"></a><span id="l25.511">     OTRLib.otrl_context_set_trust(fingerprint, trust ? &quot;verified&quot; : &quot;&quot;);</span>
<a href="#l25.512"></a><span id="l25.512">     this.writeFingerprints();</span>
<a href="#l25.513"></a><span id="l25.513" class="difflineminus">-    if (context)</span>
<a href="#l25.514"></a><span id="l25.514" class="difflineplus">+    if (context) {</span>
<a href="#l25.515"></a><span id="l25.515">       this.notifyTrust(context);</span>
<a href="#l25.516"></a><span id="l25.516" class="difflineplus">+    }</span>
<a href="#l25.517"></a><span id="l25.517">   },</span>
<a href="#l25.518"></a><span id="l25.518"> </span>
<a href="#l25.519"></a><span id="l25.519">   notifyTrust(context) {</span>
<a href="#l25.520"></a><span id="l25.520">     this.notifyObservers(context, &quot;otr:msg-state&quot;);</span>
<a href="#l25.521"></a><span id="l25.521">     this.notifyObservers(context, &quot;otr:trust-state&quot;);</span>
<a href="#l25.522"></a><span id="l25.522">   },</span>
<a href="#l25.523"></a><span id="l25.523"> </span>
<a href="#l25.524"></a><span id="l25.524">   authUpdate(context, progress, success) {</span>
<a href="#l25.525"></a><span id="l25.525" class="difflineminus">-    this.notifyObservers({</span>
<a href="#l25.526"></a><span id="l25.526" class="difflineminus">-      context,</span>
<a href="#l25.527"></a><span id="l25.527" class="difflineminus">-      progress,</span>
<a href="#l25.528"></a><span id="l25.528" class="difflineminus">-      success,</span>
<a href="#l25.529"></a><span id="l25.529" class="difflineminus">-    }, &quot;otr:auth-update&quot;);</span>
<a href="#l25.530"></a><span id="l25.530" class="difflineplus">+    this.notifyObservers(</span>
<a href="#l25.531"></a><span id="l25.531" class="difflineplus">+      {</span>
<a href="#l25.532"></a><span id="l25.532" class="difflineplus">+        context,</span>
<a href="#l25.533"></a><span id="l25.533" class="difflineplus">+        progress,</span>
<a href="#l25.534"></a><span id="l25.534" class="difflineplus">+        success,</span>
<a href="#l25.535"></a><span id="l25.535" class="difflineplus">+      },</span>
<a href="#l25.536"></a><span id="l25.536" class="difflineplus">+      &quot;otr:auth-update&quot;</span>
<a href="#l25.537"></a><span id="l25.537" class="difflineplus">+    );</span>
<a href="#l25.538"></a><span id="l25.538">   },</span>
<a href="#l25.539"></a><span id="l25.539"> </span>
<a href="#l25.540"></a><span id="l25.540">   // expose message states</span>
<a href="#l25.541"></a><span id="l25.541">   getMessageState() {</span>
<a href="#l25.542"></a><span id="l25.542">     return OTRLib.messageState;</span>
<a href="#l25.543"></a><span id="l25.543">   },</span>
<a href="#l25.544"></a><span id="l25.544"> </span>
<a href="#l25.545"></a><span id="l25.545">   // get context from conv</span>
<a href="#l25.546"></a><span id="l25.546">   getContext(conv) {</span>
<a href="#l25.547"></a><span id="l25.547">     let context = OTRLib.otrl_context_find(</span>
<a href="#l25.548"></a><span id="l25.548">       this.userstate,</span>
<a href="#l25.549"></a><span id="l25.549">       conv.normalizedName,</span>
<a href="#l25.550"></a><span id="l25.550">       conv.account.normalizedName,</span>
<a href="#l25.551"></a><span id="l25.551">       // TODO: check why sometimes normalizedName is undefined, and if</span>
<a href="#l25.552"></a><span id="l25.552">       // that's ok. Fallback wasn't necessary in the original code.</span>
<a href="#l25.553"></a><span id="l25.553">       conv.account.protocol.normalizedName || &quot;&quot;,</span>
<a href="#l25.554"></a><span id="l25.554" class="difflineminus">-      OTRLib.instag.OTRL_INSTAG_BEST, 1, null, null, null</span>
<a href="#l25.555"></a><span id="l25.555" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_BEST,</span>
<a href="#l25.556"></a><span id="l25.556" class="difflineplus">+      1,</span>
<a href="#l25.557"></a><span id="l25.557" class="difflineplus">+      null,</span>
<a href="#l25.558"></a><span id="l25.558" class="difflineplus">+      null,</span>
<a href="#l25.559"></a><span id="l25.559" class="difflineplus">+      null</span>
<a href="#l25.560"></a><span id="l25.560">     );</span>
<a href="#l25.561"></a><span id="l25.561">     return new Context(context);</span>
<a href="#l25.562"></a><span id="l25.562">   },</span>
<a href="#l25.563"></a><span id="l25.563"> </span>
<a href="#l25.564"></a><span id="l25.564">   getContextFromRecipient(account, protocol, recipient) {</span>
<a href="#l25.565"></a><span id="l25.565">     let context = OTRLib.otrl_context_find(</span>
<a href="#l25.566"></a><span id="l25.566" class="difflineminus">-      this.userstate, recipient, account, protocol,</span>
<a href="#l25.567"></a><span id="l25.567" class="difflineminus">-      OTRLib.instag.OTRL_INSTAG_BEST, 1, null, null, null</span>
<a href="#l25.568"></a><span id="l25.568" class="difflineplus">+      this.userstate,</span>
<a href="#l25.569"></a><span id="l25.569" class="difflineplus">+      recipient,</span>
<a href="#l25.570"></a><span id="l25.570" class="difflineplus">+      account,</span>
<a href="#l25.571"></a><span id="l25.571" class="difflineplus">+      protocol,</span>
<a href="#l25.572"></a><span id="l25.572" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_BEST,</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineplus">+      1,</span>
<a href="#l25.574"></a><span id="l25.574" class="difflineplus">+      null,</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineplus">+      null,</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineplus">+      null</span>
<a href="#l25.577"></a><span id="l25.577">     );</span>
<a href="#l25.578"></a><span id="l25.578">     return new Context(context);</span>
<a href="#l25.579"></a><span id="l25.579">   },</span>
<a href="#l25.580"></a><span id="l25.580"> </span>
<a href="#l25.581"></a><span id="l25.581">   getUIConvFromContext(context) {</span>
<a href="#l25.582"></a><span id="l25.582">     return this.getUIConvForRecipient(</span>
<a href="#l25.583"></a><span id="l25.583" class="difflineminus">-      context.account, context.protocol, context.username</span>
<a href="#l25.584"></a><span id="l25.584" class="difflineplus">+      context.account,</span>
<a href="#l25.585"></a><span id="l25.585" class="difflineplus">+      context.protocol,</span>
<a href="#l25.586"></a><span id="l25.586" class="difflineplus">+      context.username</span>
<a href="#l25.587"></a><span id="l25.587">     );</span>
<a href="#l25.588"></a><span id="l25.588">   },</span>
<a href="#l25.589"></a><span id="l25.589"> </span>
<a href="#l25.590"></a><span id="l25.590">   getUIConvForRecipient(account, protocol, recipient) {</span>
<a href="#l25.591"></a><span id="l25.591">     let uiConvs = this._convos.values();</span>
<a href="#l25.592"></a><span id="l25.592">     let uiConv = uiConvs.next();</span>
<a href="#l25.593"></a><span id="l25.593">     while (!uiConv.done) {</span>
<a href="#l25.594"></a><span id="l25.594">       let conv = uiConv.value.target;</span>
<a href="#l25.595"></a><span id="l25.595" class="difflineminus">-      if (conv.account.normalizedName === account &amp;&amp;</span>
<a href="#l25.596"></a><span id="l25.596" class="difflineminus">-          conv.account.protocol.normalizedName === protocol &amp;&amp;</span>
<a href="#l25.597"></a><span id="l25.597" class="difflineminus">-          conv.normalizedName === recipient) {</span>
<a href="#l25.598"></a><span id="l25.598" class="difflineminus">-          // console.log(&quot;=== getUIConvForRecipient found, account: &quot; + account + &quot;  protocol: &quot; + protocol + &quot;  recip: &quot; + recipient);</span>
<a href="#l25.599"></a><span id="l25.599" class="difflineplus">+      if (</span>
<a href="#l25.600"></a><span id="l25.600" class="difflineplus">+        conv.account.normalizedName === account &amp;&amp;</span>
<a href="#l25.601"></a><span id="l25.601" class="difflineplus">+        conv.account.protocol.normalizedName === protocol &amp;&amp;</span>
<a href="#l25.602"></a><span id="l25.602" class="difflineplus">+        conv.normalizedName === recipient</span>
<a href="#l25.603"></a><span id="l25.603" class="difflineplus">+      ) {</span>
<a href="#l25.604"></a><span id="l25.604" class="difflineplus">+        // console.log(&quot;=== getUIConvForRecipient found, account: &quot; + account + &quot;  protocol: &quot; + protocol + &quot;  recip: &quot; + recipient);</span>
<a href="#l25.605"></a><span id="l25.605">         return uiConv.value;</span>
<a href="#l25.606"></a><span id="l25.606">       }</span>
<a href="#l25.607"></a><span id="l25.607">       uiConv = uiConvs.next();</span>
<a href="#l25.608"></a><span id="l25.608">     }</span>
<a href="#l25.609"></a><span id="l25.609">     throw new Error(&quot;Couldn't find conversation.&quot;);</span>
<a href="#l25.610"></a><span id="l25.610">   },</span>
<a href="#l25.611"></a><span id="l25.611"> </span>
<a href="#l25.612"></a><span id="l25.612">   getUIConvFromConv(conv) {</span>
<a href="#l25.613"></a><span id="l25.613" class="difflineat">@@ -489,48 +589,53 @@ var OTR = {</span>
<a href="#l25.614"></a><span id="l25.614">       null,</span>
<a href="#l25.615"></a><span id="l25.615">       conv.account.normalizedName,</span>
<a href="#l25.616"></a><span id="l25.616">       conv.account.protocol.normalizedName,</span>
<a href="#l25.617"></a><span id="l25.617">       conv.normalizedName,</span>
<a href="#l25.618"></a><span id="l25.618">       OTRLib.instag.OTRL_INSTAG_BEST</span>
<a href="#l25.619"></a><span id="l25.619">     );</span>
<a href="#l25.620"></a><span id="l25.620">     if (remove) {</span>
<a href="#l25.621"></a><span id="l25.621">       let uiConv = this.getUIConvFromConv(conv);</span>
<a href="#l25.622"></a><span id="l25.622" class="difflineminus">-      if (uiConv)</span>
<a href="#l25.623"></a><span id="l25.623" class="difflineplus">+      if (uiConv) {</span>
<a href="#l25.624"></a><span id="l25.624">         this.removeConversation(uiConv);</span>
<a href="#l25.625"></a><span id="l25.625" class="difflineminus">-    } else</span>
<a href="#l25.626"></a><span id="l25.626" class="difflineplus">+      }</span>
<a href="#l25.627"></a><span id="l25.627" class="difflineplus">+    } else {</span>
<a href="#l25.628"></a><span id="l25.628">       this.notifyObservers(this.getContext(conv), &quot;otr:disconnected&quot;);</span>
<a href="#l25.629"></a><span id="l25.629" class="difflineplus">+    }</span>
<a href="#l25.630"></a><span id="l25.630">   },</span>
<a href="#l25.631"></a><span id="l25.631"> </span>
<a href="#l25.632"></a><span id="l25.632">   getAccountPref(prefName, accountId, defaultVal) {</span>
<a href="#l25.633"></a><span id="l25.633">     return Services.prefs.getBoolPref(</span>
<a href="#l25.634"></a><span id="l25.634">       &quot;messenger.account.&quot; + accountId + &quot;.options.&quot; + prefName,</span>
<a href="#l25.635"></a><span id="l25.635" class="difflineminus">-      defaultVal);</span>
<a href="#l25.636"></a><span id="l25.636" class="difflineplus">+      defaultVal</span>
<a href="#l25.637"></a><span id="l25.637" class="difflineplus">+    );</span>
<a href="#l25.638"></a><span id="l25.638">   },</span>
<a href="#l25.639"></a><span id="l25.639"> </span>
<a href="#l25.640"></a><span id="l25.640">   sendQueryMsg(conv) {</span>
<a href="#l25.641"></a><span id="l25.641" class="difflineminus">-    let req = this.getAccountPref(&quot;otrRequireEncryption&quot;, conv.account.id,</span>
<a href="#l25.642"></a><span id="l25.642" class="difflineminus">-      Services.prefs.getBoolPref(&quot;chat.otr.default.requireEncryption&quot;));</span>
<a href="#l25.643"></a><span id="l25.643" class="difflineplus">+    let req = this.getAccountPref(</span>
<a href="#l25.644"></a><span id="l25.644" class="difflineplus">+      &quot;otrRequireEncryption&quot;,</span>
<a href="#l25.645"></a><span id="l25.645" class="difflineplus">+      conv.account.id,</span>
<a href="#l25.646"></a><span id="l25.646" class="difflineplus">+      Services.prefs.getBoolPref(&quot;chat.otr.default.requireEncryption&quot;)</span>
<a href="#l25.647"></a><span id="l25.647" class="difflineplus">+    );</span>
<a href="#l25.648"></a><span id="l25.648">     let query = OTRLib.otrl_proto_default_query_msg(</span>
<a href="#l25.649"></a><span id="l25.649">       conv.account.normalizedName,</span>
<a href="#l25.650"></a><span id="l25.650" class="difflineminus">-      req ?</span>
<a href="#l25.651"></a><span id="l25.651" class="difflineminus">-        OTRLib.OTRL_POLICY_ALWAYS : OTRLib.OTRL_POLICY_OPPORTUNISTIC</span>
<a href="#l25.652"></a><span id="l25.652" class="difflineplus">+      req ? OTRLib.OTRL_POLICY_ALWAYS : OTRLib.OTRL_POLICY_OPPORTUNISTIC</span>
<a href="#l25.653"></a><span id="l25.653">     );</span>
<a href="#l25.654"></a><span id="l25.654">     if (query.isNull()) {</span>
<a href="#l25.655"></a><span id="l25.655">       Cu.reportError(new Error(&quot;Sending query message failed.&quot;));</span>
<a href="#l25.656"></a><span id="l25.656">       return;</span>
<a href="#l25.657"></a><span id="l25.657">     }</span>
<a href="#l25.658"></a><span id="l25.658">     // Use the default msg to format the version.</span>
<a href="#l25.659"></a><span id="l25.659">     // We don't supprt v1 of the protocol so this should be fine.</span>
<a href="#l25.660"></a><span id="l25.660">     let queryMsg = /^\?OTR.*?\?/.exec(query.readString())[0] + &quot;\n&quot;;</span>
<a href="#l25.661"></a><span id="l25.661">     // Avoid sending any numbers in the query message, because receiving</span>
<a href="#l25.662"></a><span id="l25.662">     // software could misinterpret it as a protocol version.</span>
<a href="#l25.663"></a><span id="l25.663">     // See https://bugzilla.mozilla.org/show_bug.cgi?id=1536108</span>
<a href="#l25.664"></a><span id="l25.664">     let noNumbersName = conv.account.normalizedName.replace(/[0-9]/g, &quot;#&quot;);</span>
<a href="#l25.665"></a><span id="l25.665" class="difflineminus">-    queryMsg += _strArgs(&quot;query-msg&quot;, {name: noNumbersName});</span>
<a href="#l25.666"></a><span id="l25.666" class="difflineplus">+    queryMsg += _strArgs(&quot;query-msg&quot;, { name: noNumbersName });</span>
<a href="#l25.667"></a><span id="l25.667">     conv.sendMsg(queryMsg);</span>
<a href="#l25.668"></a><span id="l25.668">     OTRLib.otrl_message_free(query);</span>
<a href="#l25.669"></a><span id="l25.669">   },</span>
<a href="#l25.670"></a><span id="l25.670"> </span>
<a href="#l25.671"></a><span id="l25.671">   trustState: {</span>
<a href="#l25.672"></a><span id="l25.672">     TRUST_NOT_PRIVATE: 0,</span>
<a href="#l25.673"></a><span id="l25.673">     TRUST_UNVERIFIED: 1,</span>
<a href="#l25.674"></a><span id="l25.674">     TRUST_PRIVATE: 2,</span>
<a href="#l25.675"></a><span id="l25.675" class="difflineat">@@ -553,18 +658,20 @@ var OTR = {</span>
<a href="#l25.676"></a><span id="l25.676">         level = this.trustState.TRUST_FINISHED;</span>
<a href="#l25.677"></a><span id="l25.677">         break;</span>
<a href="#l25.678"></a><span id="l25.678">     }</span>
<a href="#l25.679"></a><span id="l25.679">     return level;</span>
<a href="#l25.680"></a><span id="l25.680">   },</span>
<a href="#l25.681"></a><span id="l25.681"> </span>
<a href="#l25.682"></a><span id="l25.682">   getPrefBranchFromWrappedContext(wContext) {</span>
<a href="#l25.683"></a><span id="l25.683">     for (let acc of Services.accounts.getAccounts()) {</span>
<a href="#l25.684"></a><span id="l25.684" class="difflineminus">-      if (wContext.account == acc.normalizedName &amp;&amp;</span>
<a href="#l25.685"></a><span id="l25.685" class="difflineminus">-          wContext.protocol == acc.protocol.normalizedName) {</span>
<a href="#l25.686"></a><span id="l25.686" class="difflineplus">+      if (</span>
<a href="#l25.687"></a><span id="l25.687" class="difflineplus">+        wContext.account == acc.normalizedName &amp;&amp;</span>
<a href="#l25.688"></a><span id="l25.688" class="difflineplus">+        wContext.protocol == acc.protocol.normalizedName</span>
<a href="#l25.689"></a><span id="l25.689" class="difflineplus">+      ) {</span>
<a href="#l25.690"></a><span id="l25.690">         return acc.prefBranch;</span>
<a href="#l25.691"></a><span id="l25.691">       }</span>
<a href="#l25.692"></a><span id="l25.692">     }</span>
<a href="#l25.693"></a><span id="l25.693">     return null;</span>
<a href="#l25.694"></a><span id="l25.694">   },</span>
<a href="#l25.695"></a><span id="l25.695"> </span>
<a href="#l25.696"></a><span id="l25.696">   // uiOps callbacks</span>
<a href="#l25.697"></a><span id="l25.697"> </span>
<a href="#l25.698"></a><span id="l25.698" class="difflineat">@@ -572,20 +679,23 @@ var OTR = {</span>
<a href="#l25.699"></a><span id="l25.699">    * Return the OTR policy for the given context.</span>
<a href="#l25.700"></a><span id="l25.700">    */</span>
<a href="#l25.701"></a><span id="l25.701">   policy_cb(opdata, context) {</span>
<a href="#l25.702"></a><span id="l25.702">     let wContext = new Context(context);</span>
<a href="#l25.703"></a><span id="l25.703">     let pb = OTR.getPrefBranchFromWrappedContext(wContext);</span>
<a href="#l25.704"></a><span id="l25.704">     if (!pb) {</span>
<a href="#l25.705"></a><span id="l25.705">       return new ctypes.unsigned_int(0);</span>
<a href="#l25.706"></a><span id="l25.706">     }</span>
<a href="#l25.707"></a><span id="l25.707" class="difflineminus">-    let prefRequire = pb.getBoolPref(&quot;options.otrRequireEncryption&quot;,</span>
<a href="#l25.708"></a><span id="l25.708" class="difflineminus">-      Services.prefs.getBoolPref(&quot;chat.otr.default.requireEncryption&quot;));</span>
<a href="#l25.709"></a><span id="l25.709" class="difflineminus">-    return prefRequire ? OTRLib.OTRL_POLICY_ALWAYS</span>
<a href="#l25.710"></a><span id="l25.710" class="difflineminus">-                       : OTRLib.OTRL_POLICY_OPPORTUNISTIC;</span>
<a href="#l25.711"></a><span id="l25.711" class="difflineplus">+    let prefRequire = pb.getBoolPref(</span>
<a href="#l25.712"></a><span id="l25.712" class="difflineplus">+      &quot;options.otrRequireEncryption&quot;,</span>
<a href="#l25.713"></a><span id="l25.713" class="difflineplus">+      Services.prefs.getBoolPref(&quot;chat.otr.default.requireEncryption&quot;)</span>
<a href="#l25.714"></a><span id="l25.714" class="difflineplus">+    );</span>
<a href="#l25.715"></a><span id="l25.715" class="difflineplus">+    return prefRequire</span>
<a href="#l25.716"></a><span id="l25.716" class="difflineplus">+      ? OTRLib.OTRL_POLICY_ALWAYS</span>
<a href="#l25.717"></a><span id="l25.717" class="difflineplus">+      : OTRLib.OTRL_POLICY_OPPORTUNISTIC;</span>
<a href="#l25.718"></a><span id="l25.718">   },</span>
<a href="#l25.719"></a><span id="l25.719"> </span>
<a href="#l25.720"></a><span id="l25.720">   /**</span>
<a href="#l25.721"></a><span id="l25.721">    * Create a private key for the given accountname/protocol if desired.</span>
<a href="#l25.722"></a><span id="l25.722">    */</span>
<a href="#l25.723"></a><span id="l25.723">   create_privkey_cb(opdata, accountname, protocol) {</span>
<a href="#l25.724"></a><span id="l25.724">     let args = {</span>
<a href="#l25.725"></a><span id="l25.725">       account: accountname.readString(),</span>
<a href="#l25.726"></a><span id="l25.726" class="difflineat">@@ -621,67 +731,86 @@ var OTR = {</span>
<a href="#l25.727"></a><span id="l25.727">     ).target.sendMsg(aMsg);</span>
<a href="#l25.728"></a><span id="l25.728">   },</span>
<a href="#l25.729"></a><span id="l25.729"> </span>
<a href="#l25.730"></a><span id="l25.730">   /**</span>
<a href="#l25.731"></a><span id="l25.731">    * new fingerprint for the given user has been received.</span>
<a href="#l25.732"></a><span id="l25.732">    */</span>
<a href="#l25.733"></a><span id="l25.733">   new_fingerprint_cb(opdata, us, accountname, protocol, username, fingerprint) {</span>
<a href="#l25.734"></a><span id="l25.734">     let context = OTRLib.otrl_context_find(</span>
<a href="#l25.735"></a><span id="l25.735" class="difflineminus">-      us, username, accountname, protocol,</span>
<a href="#l25.736"></a><span id="l25.736" class="difflineminus">-      OTRLib.instag.OTRL_INSTAG_MASTER, 1, null, null, null</span>
<a href="#l25.737"></a><span id="l25.737" class="difflineplus">+      us,</span>
<a href="#l25.738"></a><span id="l25.738" class="difflineplus">+      username,</span>
<a href="#l25.739"></a><span id="l25.739" class="difflineplus">+      accountname,</span>
<a href="#l25.740"></a><span id="l25.740" class="difflineplus">+      protocol,</span>
<a href="#l25.741"></a><span id="l25.741" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_MASTER,</span>
<a href="#l25.742"></a><span id="l25.742" class="difflineplus">+      1,</span>
<a href="#l25.743"></a><span id="l25.743" class="difflineplus">+      null,</span>
<a href="#l25.744"></a><span id="l25.744" class="difflineplus">+      null,</span>
<a href="#l25.745"></a><span id="l25.745" class="difflineplus">+      null</span>
<a href="#l25.746"></a><span id="l25.746">     );</span>
<a href="#l25.747"></a><span id="l25.747"> </span>
<a href="#l25.748"></a><span id="l25.748">     let seen = false;</span>
<a href="#l25.749"></a><span id="l25.749">     let fp = context.contents.fingerprint_root.next;</span>
<a href="#l25.750"></a><span id="l25.750">     while (!fp.isNull()) {</span>
<a href="#l25.751"></a><span id="l25.751" class="difflineminus">-      if (CLib.memcmp(fingerprint, fp.contents.fingerprint, new ctypes.size_t(20))) {</span>
<a href="#l25.752"></a><span id="l25.752" class="difflineplus">+      if (</span>
<a href="#l25.753"></a><span id="l25.753" class="difflineplus">+        CLib.memcmp(fingerprint, fp.contents.fingerprint, new ctypes.size_t(20))</span>
<a href="#l25.754"></a><span id="l25.754" class="difflineplus">+      ) {</span>
<a href="#l25.755"></a><span id="l25.755">         seen = true;</span>
<a href="#l25.756"></a><span id="l25.756">         break;</span>
<a href="#l25.757"></a><span id="l25.757">       }</span>
<a href="#l25.758"></a><span id="l25.758">       fp = fp.contents.next;</span>
<a href="#l25.759"></a><span id="l25.759">     }</span>
<a href="#l25.760"></a><span id="l25.760"> </span>
<a href="#l25.761"></a><span id="l25.761">     let wContext = new Context(context);</span>
<a href="#l25.762"></a><span id="l25.762" class="difflineminus">-    let defaultNudge = Services.prefs.getBoolPref(&quot;chat.otr.default.verifyNudge&quot;);</span>
<a href="#l25.763"></a><span id="l25.763" class="difflineplus">+    let defaultNudge = Services.prefs.getBoolPref(</span>
<a href="#l25.764"></a><span id="l25.764" class="difflineplus">+      &quot;chat.otr.default.verifyNudge&quot;</span>
<a href="#l25.765"></a><span id="l25.765" class="difflineplus">+    );</span>
<a href="#l25.766"></a><span id="l25.766">     let prefNudge = defaultNudge;</span>
<a href="#l25.767"></a><span id="l25.767">     let pb = OTR.getPrefBranchFromWrappedContext(wContext);</span>
<a href="#l25.768"></a><span id="l25.768">     if (pb) {</span>
<a href="#l25.769"></a><span id="l25.769">       prefNudge = pb.getBoolPref(&quot;options.otrVerifyNudge&quot;, defaultNudge);</span>
<a href="#l25.770"></a><span id="l25.770">     }</span>
<a href="#l25.771"></a><span id="l25.771"> </span>
<a href="#l25.772"></a><span id="l25.772">     // Only nudge on new fingerprint, as opposed to always.</span>
<a href="#l25.773"></a><span id="l25.773" class="difflineminus">-    if (!prefNudge)</span>
<a href="#l25.774"></a><span id="l25.774" class="difflineminus">-      this.notifyObservers(wContext, &quot;otr:unverified&quot;,</span>
<a href="#l25.775"></a><span id="l25.775" class="difflineminus">-        (seen ? &quot;seen&quot; : &quot;unseen&quot;));</span>
<a href="#l25.776"></a><span id="l25.776" class="difflineplus">+    if (!prefNudge) {</span>
<a href="#l25.777"></a><span id="l25.777" class="difflineplus">+      this.notifyObservers(</span>
<a href="#l25.778"></a><span id="l25.778" class="difflineplus">+        wContext,</span>
<a href="#l25.779"></a><span id="l25.779" class="difflineplus">+        &quot;otr:unverified&quot;,</span>
<a href="#l25.780"></a><span id="l25.780" class="difflineplus">+        seen ? &quot;seen&quot; : &quot;unseen&quot;</span>
<a href="#l25.781"></a><span id="l25.781" class="difflineplus">+      );</span>
<a href="#l25.782"></a><span id="l25.782" class="difflineplus">+    }</span>
<a href="#l25.783"></a><span id="l25.783">   },</span>
<a href="#l25.784"></a><span id="l25.784"> </span>
<a href="#l25.785"></a><span id="l25.785">   /**</span>
<a href="#l25.786"></a><span id="l25.786">    * The list of known fingerprints has changed.  Write them to disk.</span>
<a href="#l25.787"></a><span id="l25.787">    */</span>
<a href="#l25.788"></a><span id="l25.788">   write_fingerprint_cb(opdata) {</span>
<a href="#l25.789"></a><span id="l25.789">     this.writeFingerprints();</span>
<a href="#l25.790"></a><span id="l25.790">   },</span>
<a href="#l25.791"></a><span id="l25.791"> </span>
<a href="#l25.792"></a><span id="l25.792">   /**</span>
<a href="#l25.793"></a><span id="l25.793">    * A ConnContext has entered a secure state.</span>
<a href="#l25.794"></a><span id="l25.794">    */</span>
<a href="#l25.795"></a><span id="l25.795">   gone_secure_cb(opdata, context) {</span>
<a href="#l25.796"></a><span id="l25.796">     let wContext = new Context(context);</span>
<a href="#l25.797"></a><span id="l25.797" class="difflineminus">-    let defaultNudge = Services.prefs.getBoolPref(&quot;chat.otr.default.verifyNudge&quot;);</span>
<a href="#l25.798"></a><span id="l25.798" class="difflineplus">+    let defaultNudge = Services.prefs.getBoolPref(</span>
<a href="#l25.799"></a><span id="l25.799" class="difflineplus">+      &quot;chat.otr.default.verifyNudge&quot;</span>
<a href="#l25.800"></a><span id="l25.800" class="difflineplus">+    );</span>
<a href="#l25.801"></a><span id="l25.801">     let prefNudge = defaultNudge;</span>
<a href="#l25.802"></a><span id="l25.802">     let pb = OTR.getPrefBranchFromWrappedContext(wContext);</span>
<a href="#l25.803"></a><span id="l25.803">     if (pb) {</span>
<a href="#l25.804"></a><span id="l25.804">       prefNudge = pb.getBoolPref(&quot;options.otrVerifyNudge&quot;, defaultNudge);</span>
<a href="#l25.805"></a><span id="l25.805">     }</span>
<a href="#l25.806"></a><span id="l25.806" class="difflineminus">-    let strid = &quot;context-gone_secure_&quot; + (wContext.trust ? &quot;private&quot; : &quot;unverified&quot;);</span>
<a href="#l25.807"></a><span id="l25.807" class="difflineplus">+    let strid =</span>
<a href="#l25.808"></a><span id="l25.808" class="difflineplus">+      &quot;context-gone_secure_&quot; + (wContext.trust ? &quot;private&quot; : &quot;unverified&quot;);</span>
<a href="#l25.809"></a><span id="l25.809">     this.notifyObservers(wContext, &quot;otr:msg-state&quot;);</span>
<a href="#l25.810"></a><span id="l25.810" class="difflineminus">-    this.sendAlert(wContext, _strArgs(strid, {name: wContext.username}));</span>
<a href="#l25.811"></a><span id="l25.811" class="difflineminus">-    if (prefNudge &amp;&amp; !wContext.trust)</span>
<a href="#l25.812"></a><span id="l25.812" class="difflineplus">+    this.sendAlert(wContext, _strArgs(strid, { name: wContext.username }));</span>
<a href="#l25.813"></a><span id="l25.813" class="difflineplus">+    if (prefNudge &amp;&amp; !wContext.trust) {</span>
<a href="#l25.814"></a><span id="l25.814">       this.notifyObservers(wContext, &quot;otr:unverified&quot;, &quot;unseen&quot;);</span>
<a href="#l25.815"></a><span id="l25.815" class="difflineplus">+    }</span>
<a href="#l25.816"></a><span id="l25.816">   },</span>
<a href="#l25.817"></a><span id="l25.817"> </span>
<a href="#l25.818"></a><span id="l25.818">   /**</span>
<a href="#l25.819"></a><span id="l25.819">    * A ConnContext has left a secure state.</span>
<a href="#l25.820"></a><span id="l25.820">    */</span>
<a href="#l25.821"></a><span id="l25.821">   gone_insecure_cb(opdata, context) {</span>
<a href="#l25.822"></a><span id="l25.822">     // This isn't used. See: https://bugs.otr.im/lib/libotr/issues/48</span>
<a href="#l25.823"></a><span id="l25.823">   },</span>
<a href="#l25.824"></a><span id="l25.824" class="difflineat">@@ -692,51 +821,54 @@ var OTR = {</span>
<a href="#l25.825"></a><span id="l25.825">    *</span>
<a href="#l25.826"></a><span id="l25.826">    * @param is_reply    indicates whether we initiated the AKE.</span>
<a href="#l25.827"></a><span id="l25.827">    */</span>
<a href="#l25.828"></a><span id="l25.828">   still_secure_cb(opdata, context, is_reply) {</span>
<a href="#l25.829"></a><span id="l25.829">     // Indicate the private conversation was refreshed.</span>
<a href="#l25.830"></a><span id="l25.830">     if (!is_reply) {</span>
<a href="#l25.831"></a><span id="l25.831">       context = new Context(context);</span>
<a href="#l25.832"></a><span id="l25.832">       this.notifyObservers(context, &quot;otr:msg-state&quot;);</span>
<a href="#l25.833"></a><span id="l25.833" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;context-still_secure&quot;, {name: context.username}));</span>
<a href="#l25.834"></a><span id="l25.834" class="difflineplus">+      this.sendAlert(</span>
<a href="#l25.835"></a><span id="l25.835" class="difflineplus">+        context,</span>
<a href="#l25.836"></a><span id="l25.836" class="difflineplus">+        _strArgs(&quot;context-still_secure&quot;, { name: context.username })</span>
<a href="#l25.837"></a><span id="l25.837" class="difflineplus">+      );</span>
<a href="#l25.838"></a><span id="l25.838">     }</span>
<a href="#l25.839"></a><span id="l25.839">   },</span>
<a href="#l25.840"></a><span id="l25.840"> </span>
<a href="#l25.841"></a><span id="l25.841">   /**</span>
<a href="#l25.842"></a><span id="l25.842">    * Find the maximum message size supported by this protocol.</span>
<a href="#l25.843"></a><span id="l25.843">    */</span>
<a href="#l25.844"></a><span id="l25.844">   max_message_size_cb(opdata, context) {</span>
<a href="#l25.845"></a><span id="l25.845">     context = new Context(context);</span>
<a href="#l25.846"></a><span id="l25.846">     // These values are, for the most part, from pidgin-otr's mms_table.</span>
<a href="#l25.847"></a><span id="l25.847">     switch (context.protocol) {</span>
<a href="#l25.848"></a><span id="l25.848" class="difflineminus">-    case &quot;irc&quot;:</span>
<a href="#l25.849"></a><span id="l25.849" class="difflineminus">-    case &quot;prpl-irc&quot;:</span>
<a href="#l25.850"></a><span id="l25.850" class="difflineminus">-      return 417;</span>
<a href="#l25.851"></a><span id="l25.851" class="difflineminus">-    case &quot;facebook&quot;:</span>
<a href="#l25.852"></a><span id="l25.852" class="difflineminus">-    case &quot;gtalk&quot;:</span>
<a href="#l25.853"></a><span id="l25.853" class="difflineminus">-    case &quot;odnoklassniki&quot;:</span>
<a href="#l25.854"></a><span id="l25.854" class="difflineminus">-    case &quot;jabber&quot;:</span>
<a href="#l25.855"></a><span id="l25.855" class="difflineminus">-    case &quot;xmpp&quot;:</span>
<a href="#l25.856"></a><span id="l25.856" class="difflineminus">-      return 65536;</span>
<a href="#l25.857"></a><span id="l25.857" class="difflineminus">-    case &quot;prpl-yahoo&quot;:</span>
<a href="#l25.858"></a><span id="l25.858" class="difflineminus">-      return 799;</span>
<a href="#l25.859"></a><span id="l25.859" class="difflineminus">-    case &quot;prpl-msn&quot;:</span>
<a href="#l25.860"></a><span id="l25.860" class="difflineminus">-      return 1409;</span>
<a href="#l25.861"></a><span id="l25.861" class="difflineminus">-    case &quot;prpl-icq&quot;:</span>
<a href="#l25.862"></a><span id="l25.862" class="difflineminus">-      return 2346;</span>
<a href="#l25.863"></a><span id="l25.863" class="difflineminus">-    case &quot;prpl-gg&quot;:</span>
<a href="#l25.864"></a><span id="l25.864" class="difflineminus">-      return 1999;</span>
<a href="#l25.865"></a><span id="l25.865" class="difflineminus">-    case &quot;prpl-aim&quot;:</span>
<a href="#l25.866"></a><span id="l25.866" class="difflineminus">-    case &quot;prpl-oscar&quot;:</span>
<a href="#l25.867"></a><span id="l25.867" class="difflineminus">-      return 2343;</span>
<a href="#l25.868"></a><span id="l25.868" class="difflineminus">-    case &quot;prpl-novell&quot;:</span>
<a href="#l25.869"></a><span id="l25.869" class="difflineminus">-      return 1792;</span>
<a href="#l25.870"></a><span id="l25.870" class="difflineminus">-    default:</span>
<a href="#l25.871"></a><span id="l25.871" class="difflineminus">-      return 0;</span>
<a href="#l25.872"></a><span id="l25.872" class="difflineplus">+      case &quot;irc&quot;:</span>
<a href="#l25.873"></a><span id="l25.873" class="difflineplus">+      case &quot;prpl-irc&quot;:</span>
<a href="#l25.874"></a><span id="l25.874" class="difflineplus">+        return 417;</span>
<a href="#l25.875"></a><span id="l25.875" class="difflineplus">+      case &quot;facebook&quot;:</span>
<a href="#l25.876"></a><span id="l25.876" class="difflineplus">+      case &quot;gtalk&quot;:</span>
<a href="#l25.877"></a><span id="l25.877" class="difflineplus">+      case &quot;odnoklassniki&quot;:</span>
<a href="#l25.878"></a><span id="l25.878" class="difflineplus">+      case &quot;jabber&quot;:</span>
<a href="#l25.879"></a><span id="l25.879" class="difflineplus">+      case &quot;xmpp&quot;:</span>
<a href="#l25.880"></a><span id="l25.880" class="difflineplus">+        return 65536;</span>
<a href="#l25.881"></a><span id="l25.881" class="difflineplus">+      case &quot;prpl-yahoo&quot;:</span>
<a href="#l25.882"></a><span id="l25.882" class="difflineplus">+        return 799;</span>
<a href="#l25.883"></a><span id="l25.883" class="difflineplus">+      case &quot;prpl-msn&quot;:</span>
<a href="#l25.884"></a><span id="l25.884" class="difflineplus">+        return 1409;</span>
<a href="#l25.885"></a><span id="l25.885" class="difflineplus">+      case &quot;prpl-icq&quot;:</span>
<a href="#l25.886"></a><span id="l25.886" class="difflineplus">+        return 2346;</span>
<a href="#l25.887"></a><span id="l25.887" class="difflineplus">+      case &quot;prpl-gg&quot;:</span>
<a href="#l25.888"></a><span id="l25.888" class="difflineplus">+        return 1999;</span>
<a href="#l25.889"></a><span id="l25.889" class="difflineplus">+      case &quot;prpl-aim&quot;:</span>
<a href="#l25.890"></a><span id="l25.890" class="difflineplus">+      case &quot;prpl-oscar&quot;:</span>
<a href="#l25.891"></a><span id="l25.891" class="difflineplus">+        return 2343;</span>
<a href="#l25.892"></a><span id="l25.892" class="difflineplus">+      case &quot;prpl-novell&quot;:</span>
<a href="#l25.893"></a><span id="l25.893" class="difflineplus">+        return 1792;</span>
<a href="#l25.894"></a><span id="l25.894" class="difflineplus">+      default:</span>
<a href="#l25.895"></a><span id="l25.895" class="difflineplus">+        return 0;</span>
<a href="#l25.896"></a><span id="l25.896">     }</span>
<a href="#l25.897"></a><span id="l25.897">   },</span>
<a href="#l25.898"></a><span id="l25.898"> </span>
<a href="#l25.899"></a><span id="l25.899">   /**</span>
<a href="#l25.900"></a><span id="l25.900">    * We received a request from the buddy to use the current &quot;extra&quot;</span>
<a href="#l25.901"></a><span id="l25.901">    * symmetric key.</span>
<a href="#l25.902"></a><span id="l25.902">    */</span>
<a href="#l25.903"></a><span id="l25.903">   received_symkey_cb(opdata, context, use, usedata, usedatalen, symkey) {</span>
<a href="#l25.904"></a><span id="l25.904" class="difflineat">@@ -745,149 +877,196 @@ var OTR = {</span>
<a href="#l25.905"></a><span id="l25.905"> </span>
<a href="#l25.906"></a><span id="l25.906">   /**</span>
<a href="#l25.907"></a><span id="l25.907">    * Return a string according to the error event.</span>
<a href="#l25.908"></a><span id="l25.908">    */</span>
<a href="#l25.909"></a><span id="l25.909">   otr_error_message_cb(opdata, context, err_code) {</span>
<a href="#l25.910"></a><span id="l25.910">     context = new Context(context);</span>
<a href="#l25.911"></a><span id="l25.911">     let msg;</span>
<a href="#l25.912"></a><span id="l25.912">     switch (err_code) {</span>
<a href="#l25.913"></a><span id="l25.913" class="difflineminus">-    case OTRLib.errorCode.OTRL_ERRCODE_ENCRYPTION_ERROR:</span>
<a href="#l25.914"></a><span id="l25.914" class="difflineminus">-      msg = _str(&quot;error-enc&quot;);</span>
<a href="#l25.915"></a><span id="l25.915" class="difflineminus">-      break;</span>
<a href="#l25.916"></a><span id="l25.916" class="difflineminus">-    case OTRLib.errorCode.OTRL_ERRCODE_MSG_NOT_IN_PRIVATE:</span>
<a href="#l25.917"></a><span id="l25.917" class="difflineminus">-      msg = _strArgs(&quot;error-not_priv&quot;, context.username);</span>
<a href="#l25.918"></a><span id="l25.918" class="difflineminus">-      break;</span>
<a href="#l25.919"></a><span id="l25.919" class="difflineminus">-    case OTRLib.errorCode.OTRL_ERRCODE_MSG_UNREADABLE:</span>
<a href="#l25.920"></a><span id="l25.920" class="difflineminus">-      msg = _str(&quot;error-unreadable&quot;);</span>
<a href="#l25.921"></a><span id="l25.921" class="difflineminus">-      break;</span>
<a href="#l25.922"></a><span id="l25.922" class="difflineminus">-    case OTRLib.errorCode.OTRL_ERRCODE_MSG_MALFORMED:</span>
<a href="#l25.923"></a><span id="l25.923" class="difflineminus">-      msg = _str(&quot;error-malformed&quot;);</span>
<a href="#l25.924"></a><span id="l25.924" class="difflineminus">-      break;</span>
<a href="#l25.925"></a><span id="l25.925" class="difflineminus">-    default:</span>
<a href="#l25.926"></a><span id="l25.926" class="difflineminus">-      return null;</span>
<a href="#l25.927"></a><span id="l25.927" class="difflineplus">+      case OTRLib.errorCode.OTRL_ERRCODE_ENCRYPTION_ERROR:</span>
<a href="#l25.928"></a><span id="l25.928" class="difflineplus">+        msg = _str(&quot;error-enc&quot;);</span>
<a href="#l25.929"></a><span id="l25.929" class="difflineplus">+        break;</span>
<a href="#l25.930"></a><span id="l25.930" class="difflineplus">+      case OTRLib.errorCode.OTRL_ERRCODE_MSG_NOT_IN_PRIVATE:</span>
<a href="#l25.931"></a><span id="l25.931" class="difflineplus">+        msg = _strArgs(&quot;error-not_priv&quot;, context.username);</span>
<a href="#l25.932"></a><span id="l25.932" class="difflineplus">+        break;</span>
<a href="#l25.933"></a><span id="l25.933" class="difflineplus">+      case OTRLib.errorCode.OTRL_ERRCODE_MSG_UNREADABLE:</span>
<a href="#l25.934"></a><span id="l25.934" class="difflineplus">+        msg = _str(&quot;error-unreadable&quot;);</span>
<a href="#l25.935"></a><span id="l25.935" class="difflineplus">+        break;</span>
<a href="#l25.936"></a><span id="l25.936" class="difflineplus">+      case OTRLib.errorCode.OTRL_ERRCODE_MSG_MALFORMED:</span>
<a href="#l25.937"></a><span id="l25.937" class="difflineplus">+        msg = _str(&quot;error-malformed&quot;);</span>
<a href="#l25.938"></a><span id="l25.938" class="difflineplus">+        break;</span>
<a href="#l25.939"></a><span id="l25.939" class="difflineplus">+      default:</span>
<a href="#l25.940"></a><span id="l25.940" class="difflineplus">+        return null;</span>
<a href="#l25.941"></a><span id="l25.941">     }</span>
<a href="#l25.942"></a><span id="l25.942">     return CLib.strdup(msg);</span>
<a href="#l25.943"></a><span id="l25.943">   },</span>
<a href="#l25.944"></a><span id="l25.944"> </span>
<a href="#l25.945"></a><span id="l25.945">   /**</span>
<a href="#l25.946"></a><span id="l25.946">    * Deallocate a string returned by otr_error_message_cb.</span>
<a href="#l25.947"></a><span id="l25.947">    */</span>
<a href="#l25.948"></a><span id="l25.948">   otr_error_message_free_cb(opdata, err_msg) {</span>
<a href="#l25.949"></a><span id="l25.949" class="difflineminus">-    if (!err_msg.isNull())</span>
<a href="#l25.950"></a><span id="l25.950" class="difflineplus">+    if (!err_msg.isNull()) {</span>
<a href="#l25.951"></a><span id="l25.951">       CLib.free(err_msg);</span>
<a href="#l25.952"></a><span id="l25.952" class="difflineplus">+    }</span>
<a href="#l25.953"></a><span id="l25.953">   },</span>
<a href="#l25.954"></a><span id="l25.954"> </span>
<a href="#l25.955"></a><span id="l25.955">   /**</span>
<a href="#l25.956"></a><span id="l25.956">    * Return a string that will be prefixed to any resent message.</span>
<a href="#l25.957"></a><span id="l25.957">    */</span>
<a href="#l25.958"></a><span id="l25.958">   resent_msg_prefix_cb(opdata, context) {</span>
<a href="#l25.959"></a><span id="l25.959">     return CLib.strdup(_str(&quot;resent&quot;));</span>
<a href="#l25.960"></a><span id="l25.960">   },</span>
<a href="#l25.961"></a><span id="l25.961"> </span>
<a href="#l25.962"></a><span id="l25.962">   /**</span>
<a href="#l25.963"></a><span id="l25.963">    * Deallocate a string returned by resent_msg_prefix.</span>
<a href="#l25.964"></a><span id="l25.964">    */</span>
<a href="#l25.965"></a><span id="l25.965">   resent_msg_prefix_free_cb(opdata, prefix) {</span>
<a href="#l25.966"></a><span id="l25.966" class="difflineminus">-    if (!prefix.isNull())</span>
<a href="#l25.967"></a><span id="l25.967" class="difflineplus">+    if (!prefix.isNull()) {</span>
<a href="#l25.968"></a><span id="l25.968">       CLib.free(prefix);</span>
<a href="#l25.969"></a><span id="l25.969" class="difflineplus">+    }</span>
<a href="#l25.970"></a><span id="l25.970">   },</span>
<a href="#l25.971"></a><span id="l25.971"> </span>
<a href="#l25.972"></a><span id="l25.972">   /**</span>
<a href="#l25.973"></a><span id="l25.973">    * Update the authentication UI with respect to SMP events.</span>
<a href="#l25.974"></a><span id="l25.974">    */</span>
<a href="#l25.975"></a><span id="l25.975">   handle_smp_event_cb(opdata, smp_event, context, progress_percent, question) {</span>
<a href="#l25.976"></a><span id="l25.976">     context = new Context(context);</span>
<a href="#l25.977"></a><span id="l25.977">     switch (smp_event) {</span>
<a href="#l25.978"></a><span id="l25.978" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_NONE:</span>
<a href="#l25.979"></a><span id="l25.979" class="difflineminus">-      break;</span>
<a href="#l25.980"></a><span id="l25.980" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_ANSWER:</span>
<a href="#l25.981"></a><span id="l25.981" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_SECRET:</span>
<a href="#l25.982"></a><span id="l25.982" class="difflineminus">-      this.notifyObservers({</span>
<a href="#l25.983"></a><span id="l25.983" class="difflineminus">-        context,</span>
<a href="#l25.984"></a><span id="l25.984" class="difflineminus">-        progress: progress_percent,</span>
<a href="#l25.985"></a><span id="l25.985" class="difflineminus">-        question: question.isNull() ? null : question.readString(),</span>
<a href="#l25.986"></a><span id="l25.986" class="difflineminus">-      }, &quot;otr:auth-ask&quot;);</span>
<a href="#l25.987"></a><span id="l25.987" class="difflineminus">-      break;</span>
<a href="#l25.988"></a><span id="l25.988" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_CHEATED:</span>
<a href="#l25.989"></a><span id="l25.989" class="difflineminus">-      OTR.abortSMP(context);</span>
<a href="#l25.990"></a><span id="l25.990" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_NONE:</span>
<a href="#l25.991"></a><span id="l25.991" class="difflineplus">+        break;</span>
<a href="#l25.992"></a><span id="l25.992" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_ANSWER:</span>
<a href="#l25.993"></a><span id="l25.993" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_SECRET:</span>
<a href="#l25.994"></a><span id="l25.994" class="difflineplus">+        this.notifyObservers(</span>
<a href="#l25.995"></a><span id="l25.995" class="difflineplus">+          {</span>
<a href="#l25.996"></a><span id="l25.996" class="difflineplus">+            context,</span>
<a href="#l25.997"></a><span id="l25.997" class="difflineplus">+            progress: progress_percent,</span>
<a href="#l25.998"></a><span id="l25.998" class="difflineplus">+            question: question.isNull() ? null : question.readString(),</span>
<a href="#l25.999"></a><span id="l25.999" class="difflineplus">+          },</span>
<a href="#l25.1000"></a><span id="l25.1000" class="difflineplus">+          &quot;otr:auth-ask&quot;</span>
<a href="#l25.1001"></a><span id="l25.1001" class="difflineplus">+        );</span>
<a href="#l25.1002"></a><span id="l25.1002" class="difflineplus">+        break;</span>
<a href="#l25.1003"></a><span id="l25.1003" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_CHEATED:</span>
<a href="#l25.1004"></a><span id="l25.1004" class="difflineplus">+        OTR.abortSMP(context);</span>
<a href="#l25.1005"></a><span id="l25.1005">       /* falls through */</span>
<a href="#l25.1006"></a><span id="l25.1006" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_IN_PROGRESS:</span>
<a href="#l25.1007"></a><span id="l25.1007" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_SUCCESS:</span>
<a href="#l25.1008"></a><span id="l25.1008" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_FAILURE:</span>
<a href="#l25.1009"></a><span id="l25.1009" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_ABORT:</span>
<a href="#l25.1010"></a><span id="l25.1010" class="difflineminus">-      this.authUpdate(context, progress_percent,</span>
<a href="#l25.1011"></a><span id="l25.1011" class="difflineminus">-        (smp_event === OTRLib.smpEvent.OTRL_SMPEVENT_SUCCESS));</span>
<a href="#l25.1012"></a><span id="l25.1012" class="difflineminus">-      break;</span>
<a href="#l25.1013"></a><span id="l25.1013" class="difflineminus">-    case OTRLib.smpEvent.OTRL_SMPEVENT_ERROR:</span>
<a href="#l25.1014"></a><span id="l25.1014" class="difflineminus">-      OTR.abortSMP(context);</span>
<a href="#l25.1015"></a><span id="l25.1015" class="difflineminus">-      break;</span>
<a href="#l25.1016"></a><span id="l25.1016" class="difflineminus">-    default:</span>
<a href="#l25.1017"></a><span id="l25.1017" class="difflineminus">-      this.log(&quot;smp event: &quot; + smp_event);</span>
<a href="#l25.1018"></a><span id="l25.1018" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_IN_PROGRESS:</span>
<a href="#l25.1019"></a><span id="l25.1019" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_SUCCESS:</span>
<a href="#l25.1020"></a><span id="l25.1020" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_FAILURE:</span>
<a href="#l25.1021"></a><span id="l25.1021" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_ABORT:</span>
<a href="#l25.1022"></a><span id="l25.1022" class="difflineplus">+        this.authUpdate(</span>
<a href="#l25.1023"></a><span id="l25.1023" class="difflineplus">+          context,</span>
<a href="#l25.1024"></a><span id="l25.1024" class="difflineplus">+          progress_percent,</span>
<a href="#l25.1025"></a><span id="l25.1025" class="difflineplus">+          smp_event === OTRLib.smpEvent.OTRL_SMPEVENT_SUCCESS</span>
<a href="#l25.1026"></a><span id="l25.1026" class="difflineplus">+        );</span>
<a href="#l25.1027"></a><span id="l25.1027" class="difflineplus">+        break;</span>
<a href="#l25.1028"></a><span id="l25.1028" class="difflineplus">+      case OTRLib.smpEvent.OTRL_SMPEVENT_ERROR:</span>
<a href="#l25.1029"></a><span id="l25.1029" class="difflineplus">+        OTR.abortSMP(context);</span>
<a href="#l25.1030"></a><span id="l25.1030" class="difflineplus">+        break;</span>
<a href="#l25.1031"></a><span id="l25.1031" class="difflineplus">+      default:</span>
<a href="#l25.1032"></a><span id="l25.1032" class="difflineplus">+        this.log(&quot;smp event: &quot; + smp_event);</span>
<a href="#l25.1033"></a><span id="l25.1033">     }</span>
<a href="#l25.1034"></a><span id="l25.1034">   },</span>
<a href="#l25.1035"></a><span id="l25.1035"> </span>
<a href="#l25.1036"></a><span id="l25.1036">   /**</span>
<a href="#l25.1037"></a><span id="l25.1037">    * Handle and send the appropriate message(s) to the sender/recipient</span>
<a href="#l25.1038"></a><span id="l25.1038">    * depending on the message events.</span>
<a href="#l25.1039"></a><span id="l25.1039">    */</span>
<a href="#l25.1040"></a><span id="l25.1040">   handle_msg_event_cb(opdata, msg_event, context, message, err) {</span>
<a href="#l25.1041"></a><span id="l25.1041">     context = new Context(context);</span>
<a href="#l25.1042"></a><span id="l25.1042">     switch (msg_event) {</span>
<a href="#l25.1043"></a><span id="l25.1043" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_NONE:</span>
<a href="#l25.1044"></a><span id="l25.1044" class="difflineminus">-      break;</span>
<a href="#l25.1045"></a><span id="l25.1045" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_ENCRYPTION_REQUIRED:</span>
<a href="#l25.1046"></a><span id="l25.1046" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-encryption_required_part1&quot;, {name: context.username}));</span>
<a href="#l25.1047"></a><span id="l25.1047" class="difflineminus">-      this.sendAlert(context, _str(&quot;msgevent-encryption_required_part2&quot;));</span>
<a href="#l25.1048"></a><span id="l25.1048" class="difflineminus">-      break;</span>
<a href="#l25.1049"></a><span id="l25.1049" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_ENCRYPTION_ERROR:</span>
<a href="#l25.1050"></a><span id="l25.1050" class="difflineminus">-      this.sendAlert(context, _str(&quot;msgevent-encryption_error&quot;));</span>
<a href="#l25.1051"></a><span id="l25.1051" class="difflineminus">-      break;</span>
<a href="#l25.1052"></a><span id="l25.1052" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_CONNECTION_ENDED:</span>
<a href="#l25.1053"></a><span id="l25.1053" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-connection_ended&quot;, {name: context.username}));</span>
<a href="#l25.1054"></a><span id="l25.1054" class="difflineminus">-      break;</span>
<a href="#l25.1055"></a><span id="l25.1055" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_SETUP_ERROR:</span>
<a href="#l25.1056"></a><span id="l25.1056" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-setup_error&quot;, {name: context.username}));</span>
<a href="#l25.1057"></a><span id="l25.1057" class="difflineminus">-      break;</span>
<a href="#l25.1058"></a><span id="l25.1058" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_MSG_REFLECTED:</span>
<a href="#l25.1059"></a><span id="l25.1059" class="difflineminus">-      this.sendAlert(context, _str(&quot;msgevent-msg_reflected&quot;));</span>
<a href="#l25.1060"></a><span id="l25.1060" class="difflineminus">-      break;</span>
<a href="#l25.1061"></a><span id="l25.1061" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_MSG_RESENT:</span>
<a href="#l25.1062"></a><span id="l25.1062" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-msg_resent&quot;, {name: context.username}));</span>
<a href="#l25.1063"></a><span id="l25.1063" class="difflineminus">-      break;</span>
<a href="#l25.1064"></a><span id="l25.1064" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_NOT_IN_PRIVATE:</span>
<a href="#l25.1065"></a><span id="l25.1065" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-rcvdmsg_not_private&quot;, {name: context.username}));</span>
<a href="#l25.1066"></a><span id="l25.1066" class="difflineminus">-      break;</span>
<a href="#l25.1067"></a><span id="l25.1067" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNREADABLE:</span>
<a href="#l25.1068"></a><span id="l25.1068" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-rcvdmsg_unreadable&quot;, {name: context.username}));</span>
<a href="#l25.1069"></a><span id="l25.1069" class="difflineminus">-      break;</span>
<a href="#l25.1070"></a><span id="l25.1070" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_MALFORMED:</span>
<a href="#l25.1071"></a><span id="l25.1071" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-rcvdmsg_malformed&quot;, {name: context.username}));</span>
<a href="#l25.1072"></a><span id="l25.1072" class="difflineminus">-      break;</span>
<a href="#l25.1073"></a><span id="l25.1073" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_LOG_HEARTBEAT_RCVD:</span>
<a href="#l25.1074"></a><span id="l25.1074" class="difflineminus">-      this.log(_strArgs(&quot;msgevent-log_heartbeat_rcvd&quot;, {name: context.username}));</span>
<a href="#l25.1075"></a><span id="l25.1075" class="difflineminus">-      break;</span>
<a href="#l25.1076"></a><span id="l25.1076" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_LOG_HEARTBEAT_SENT:</span>
<a href="#l25.1077"></a><span id="l25.1077" class="difflineminus">-      this.log(_strArgs(&quot;msgevent-log_heartbeat_sent&quot;, {name: context.username}));</span>
<a href="#l25.1078"></a><span id="l25.1078" class="difflineminus">-      break;</span>
<a href="#l25.1079"></a><span id="l25.1079" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_GENERAL_ERR:</span>
<a href="#l25.1080"></a><span id="l25.1080" class="difflineminus">-      this.sendAlert(context, _str(&quot;msgevent-rcvdmsg_general_err&quot;));</span>
<a href="#l25.1081"></a><span id="l25.1081" class="difflineminus">-      break;</span>
<a href="#l25.1082"></a><span id="l25.1082" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNENCRYPTED:</span>
<a href="#l25.1083"></a><span id="l25.1083" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-rcvdmsg_unencrypted&quot;,</span>
<a href="#l25.1084"></a><span id="l25.1084" class="difflineminus">-        {name: context.username, msg: message.isNull() ? &quot;&quot; : message.readString()}));</span>
<a href="#l25.1085"></a><span id="l25.1085" class="difflineminus">-      break;</span>
<a href="#l25.1086"></a><span id="l25.1086" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNRECOGNIZED:</span>
<a href="#l25.1087"></a><span id="l25.1087" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;msgevent-rcvdmsg_unrecognized&quot;, {name: context.username}));</span>
<a href="#l25.1088"></a><span id="l25.1088" class="difflineminus">-      break;</span>
<a href="#l25.1089"></a><span id="l25.1089" class="difflineminus">-    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_FOR_OTHER_INSTANCE:</span>
<a href="#l25.1090"></a><span id="l25.1090" class="difflineminus">-      this.log(_strArgs(&quot;msgevent-rcvdmsg_for_other_instance&quot;, {name: context.username}));</span>
<a href="#l25.1091"></a><span id="l25.1091" class="difflineminus">-      break;</span>
<a href="#l25.1092"></a><span id="l25.1092" class="difflineminus">-    default:</span>
<a href="#l25.1093"></a><span id="l25.1093" class="difflineminus">-      this.log(&quot;msg event: &quot; + msg_event);</span>
<a href="#l25.1094"></a><span id="l25.1094" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_NONE:</span>
<a href="#l25.1095"></a><span id="l25.1095" class="difflineplus">+        break;</span>
<a href="#l25.1096"></a><span id="l25.1096" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_ENCRYPTION_REQUIRED:</span>
<a href="#l25.1097"></a><span id="l25.1097" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1098"></a><span id="l25.1098" class="difflineplus">+          context,</span>
<a href="#l25.1099"></a><span id="l25.1099" class="difflineplus">+          _strArgs(&quot;msgevent-encryption_required_part1&quot;, {</span>
<a href="#l25.1100"></a><span id="l25.1100" class="difflineplus">+            name: context.username,</span>
<a href="#l25.1101"></a><span id="l25.1101" class="difflineplus">+          })</span>
<a href="#l25.1102"></a><span id="l25.1102" class="difflineplus">+        );</span>
<a href="#l25.1103"></a><span id="l25.1103" class="difflineplus">+        this.sendAlert(context, _str(&quot;msgevent-encryption_required_part2&quot;));</span>
<a href="#l25.1104"></a><span id="l25.1104" class="difflineplus">+        break;</span>
<a href="#l25.1105"></a><span id="l25.1105" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_ENCRYPTION_ERROR:</span>
<a href="#l25.1106"></a><span id="l25.1106" class="difflineplus">+        this.sendAlert(context, _str(&quot;msgevent-encryption_error&quot;));</span>
<a href="#l25.1107"></a><span id="l25.1107" class="difflineplus">+        break;</span>
<a href="#l25.1108"></a><span id="l25.1108" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_CONNECTION_ENDED:</span>
<a href="#l25.1109"></a><span id="l25.1109" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1110"></a><span id="l25.1110" class="difflineplus">+          context,</span>
<a href="#l25.1111"></a><span id="l25.1111" class="difflineplus">+          _strArgs(&quot;msgevent-connection_ended&quot;, { name: context.username })</span>
<a href="#l25.1112"></a><span id="l25.1112" class="difflineplus">+        );</span>
<a href="#l25.1113"></a><span id="l25.1113" class="difflineplus">+        break;</span>
<a href="#l25.1114"></a><span id="l25.1114" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_SETUP_ERROR:</span>
<a href="#l25.1115"></a><span id="l25.1115" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1116"></a><span id="l25.1116" class="difflineplus">+          context,</span>
<a href="#l25.1117"></a><span id="l25.1117" class="difflineplus">+          _strArgs(&quot;msgevent-setup_error&quot;, { name: context.username })</span>
<a href="#l25.1118"></a><span id="l25.1118" class="difflineplus">+        );</span>
<a href="#l25.1119"></a><span id="l25.1119" class="difflineplus">+        break;</span>
<a href="#l25.1120"></a><span id="l25.1120" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_MSG_REFLECTED:</span>
<a href="#l25.1121"></a><span id="l25.1121" class="difflineplus">+        this.sendAlert(context, _str(&quot;msgevent-msg_reflected&quot;));</span>
<a href="#l25.1122"></a><span id="l25.1122" class="difflineplus">+        break;</span>
<a href="#l25.1123"></a><span id="l25.1123" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_MSG_RESENT:</span>
<a href="#l25.1124"></a><span id="l25.1124" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1125"></a><span id="l25.1125" class="difflineplus">+          context,</span>
<a href="#l25.1126"></a><span id="l25.1126" class="difflineplus">+          _strArgs(&quot;msgevent-msg_resent&quot;, { name: context.username })</span>
<a href="#l25.1127"></a><span id="l25.1127" class="difflineplus">+        );</span>
<a href="#l25.1128"></a><span id="l25.1128" class="difflineplus">+        break;</span>
<a href="#l25.1129"></a><span id="l25.1129" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_NOT_IN_PRIVATE:</span>
<a href="#l25.1130"></a><span id="l25.1130" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1131"></a><span id="l25.1131" class="difflineplus">+          context,</span>
<a href="#l25.1132"></a><span id="l25.1132" class="difflineplus">+          _strArgs(&quot;msgevent-rcvdmsg_not_private&quot;, { name: context.username })</span>
<a href="#l25.1133"></a><span id="l25.1133" class="difflineplus">+        );</span>
<a href="#l25.1134"></a><span id="l25.1134" class="difflineplus">+        break;</span>
<a href="#l25.1135"></a><span id="l25.1135" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNREADABLE:</span>
<a href="#l25.1136"></a><span id="l25.1136" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1137"></a><span id="l25.1137" class="difflineplus">+          context,</span>
<a href="#l25.1138"></a><span id="l25.1138" class="difflineplus">+          _strArgs(&quot;msgevent-rcvdmsg_unreadable&quot;, { name: context.username })</span>
<a href="#l25.1139"></a><span id="l25.1139" class="difflineplus">+        );</span>
<a href="#l25.1140"></a><span id="l25.1140" class="difflineplus">+        break;</span>
<a href="#l25.1141"></a><span id="l25.1141" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_MALFORMED:</span>
<a href="#l25.1142"></a><span id="l25.1142" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1143"></a><span id="l25.1143" class="difflineplus">+          context,</span>
<a href="#l25.1144"></a><span id="l25.1144" class="difflineplus">+          _strArgs(&quot;msgevent-rcvdmsg_malformed&quot;, { name: context.username })</span>
<a href="#l25.1145"></a><span id="l25.1145" class="difflineplus">+        );</span>
<a href="#l25.1146"></a><span id="l25.1146" class="difflineplus">+        break;</span>
<a href="#l25.1147"></a><span id="l25.1147" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_LOG_HEARTBEAT_RCVD:</span>
<a href="#l25.1148"></a><span id="l25.1148" class="difflineplus">+        this.log(</span>
<a href="#l25.1149"></a><span id="l25.1149" class="difflineplus">+          _strArgs(&quot;msgevent-log_heartbeat_rcvd&quot;, { name: context.username })</span>
<a href="#l25.1150"></a><span id="l25.1150" class="difflineplus">+        );</span>
<a href="#l25.1151"></a><span id="l25.1151" class="difflineplus">+        break;</span>
<a href="#l25.1152"></a><span id="l25.1152" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_LOG_HEARTBEAT_SENT:</span>
<a href="#l25.1153"></a><span id="l25.1153" class="difflineplus">+        this.log(</span>
<a href="#l25.1154"></a><span id="l25.1154" class="difflineplus">+          _strArgs(&quot;msgevent-log_heartbeat_sent&quot;, { name: context.username })</span>
<a href="#l25.1155"></a><span id="l25.1155" class="difflineplus">+        );</span>
<a href="#l25.1156"></a><span id="l25.1156" class="difflineplus">+        break;</span>
<a href="#l25.1157"></a><span id="l25.1157" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_GENERAL_ERR:</span>
<a href="#l25.1158"></a><span id="l25.1158" class="difflineplus">+        this.sendAlert(context, _str(&quot;msgevent-rcvdmsg_general_err&quot;));</span>
<a href="#l25.1159"></a><span id="l25.1159" class="difflineplus">+        break;</span>
<a href="#l25.1160"></a><span id="l25.1160" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNENCRYPTED:</span>
<a href="#l25.1161"></a><span id="l25.1161" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1162"></a><span id="l25.1162" class="difflineplus">+          context,</span>
<a href="#l25.1163"></a><span id="l25.1163" class="difflineplus">+          _strArgs(&quot;msgevent-rcvdmsg_unencrypted&quot;, {</span>
<a href="#l25.1164"></a><span id="l25.1164" class="difflineplus">+            name: context.username,</span>
<a href="#l25.1165"></a><span id="l25.1165" class="difflineplus">+            msg: message.isNull() ? &quot;&quot; : message.readString(),</span>
<a href="#l25.1166"></a><span id="l25.1166" class="difflineplus">+          })</span>
<a href="#l25.1167"></a><span id="l25.1167" class="difflineplus">+        );</span>
<a href="#l25.1168"></a><span id="l25.1168" class="difflineplus">+        break;</span>
<a href="#l25.1169"></a><span id="l25.1169" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNRECOGNIZED:</span>
<a href="#l25.1170"></a><span id="l25.1170" class="difflineplus">+        this.sendAlert(</span>
<a href="#l25.1171"></a><span id="l25.1171" class="difflineplus">+          context,</span>
<a href="#l25.1172"></a><span id="l25.1172" class="difflineplus">+          _strArgs(&quot;msgevent-rcvdmsg_unrecognized&quot;, { name: context.username })</span>
<a href="#l25.1173"></a><span id="l25.1173" class="difflineplus">+        );</span>
<a href="#l25.1174"></a><span id="l25.1174" class="difflineplus">+        break;</span>
<a href="#l25.1175"></a><span id="l25.1175" class="difflineplus">+      case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_FOR_OTHER_INSTANCE:</span>
<a href="#l25.1176"></a><span id="l25.1176" class="difflineplus">+        this.log(</span>
<a href="#l25.1177"></a><span id="l25.1177" class="difflineplus">+          _strArgs(&quot;msgevent-rcvdmsg_for_other_instance&quot;, {</span>
<a href="#l25.1178"></a><span id="l25.1178" class="difflineplus">+            name: context.username,</span>
<a href="#l25.1179"></a><span id="l25.1179" class="difflineplus">+          })</span>
<a href="#l25.1180"></a><span id="l25.1180" class="difflineplus">+        );</span>
<a href="#l25.1181"></a><span id="l25.1181" class="difflineplus">+        break;</span>
<a href="#l25.1182"></a><span id="l25.1182" class="difflineplus">+      default:</span>
<a href="#l25.1183"></a><span id="l25.1183" class="difflineplus">+        this.log(&quot;msg event: &quot; + msg_event);</span>
<a href="#l25.1184"></a><span id="l25.1184">     }</span>
<a href="#l25.1185"></a><span id="l25.1185">   },</span>
<a href="#l25.1186"></a><span id="l25.1186"> </span>
<a href="#l25.1187"></a><span id="l25.1187">   /**</span>
<a href="#l25.1188"></a><span id="l25.1188">    * Create an instance tag for the given accountname/protocol if</span>
<a href="#l25.1189"></a><span id="l25.1189">    * desired.</span>
<a href="#l25.1190"></a><span id="l25.1190">    */</span>
<a href="#l25.1191"></a><span id="l25.1191">   create_instag_cb(opdata, accountname, protocol) {</span>
<a href="#l25.1192"></a><span id="l25.1192" class="difflineat">@@ -916,35 +1095,35 @@ var OTR = {</span>
<a href="#l25.1193"></a><span id="l25.1193">   initUiOps() {</span>
<a href="#l25.1194"></a><span id="l25.1194">     this.uiOps = new OTRLib.OtrlMessageAppOps();</span>
<a href="#l25.1195"></a><span id="l25.1195"> </span>
<a href="#l25.1196"></a><span id="l25.1196">     let methods = [</span>
<a href="#l25.1197"></a><span id="l25.1197">       &quot;policy&quot;,</span>
<a href="#l25.1198"></a><span id="l25.1198">       &quot;create_privkey&quot;,</span>
<a href="#l25.1199"></a><span id="l25.1199">       &quot;is_logged_in&quot;,</span>
<a href="#l25.1200"></a><span id="l25.1200">       &quot;inject_message&quot;,</span>
<a href="#l25.1201"></a><span id="l25.1201" class="difflineminus">-      &quot;update_context_list&quot;,  // not implemented</span>
<a href="#l25.1202"></a><span id="l25.1202" class="difflineplus">+      &quot;update_context_list&quot;, // not implemented</span>
<a href="#l25.1203"></a><span id="l25.1203">       &quot;new_fingerprint&quot;,</span>
<a href="#l25.1204"></a><span id="l25.1204">       &quot;write_fingerprint&quot;,</span>
<a href="#l25.1205"></a><span id="l25.1205">       &quot;gone_secure&quot;,</span>
<a href="#l25.1206"></a><span id="l25.1206">       &quot;gone_insecure&quot;,</span>
<a href="#l25.1207"></a><span id="l25.1207">       &quot;still_secure&quot;,</span>
<a href="#l25.1208"></a><span id="l25.1208">       &quot;max_message_size&quot;,</span>
<a href="#l25.1209"></a><span id="l25.1209" class="difflineminus">-      &quot;account_name&quot;,  // not implemented</span>
<a href="#l25.1210"></a><span id="l25.1210" class="difflineminus">-      &quot;account_name_free&quot;,  // not implemented</span>
<a href="#l25.1211"></a><span id="l25.1211" class="difflineplus">+      &quot;account_name&quot;, // not implemented</span>
<a href="#l25.1212"></a><span id="l25.1212" class="difflineplus">+      &quot;account_name_free&quot;, // not implemented</span>
<a href="#l25.1213"></a><span id="l25.1213">       &quot;received_symkey&quot;,</span>
<a href="#l25.1214"></a><span id="l25.1214">       &quot;otr_error_message&quot;,</span>
<a href="#l25.1215"></a><span id="l25.1215">       &quot;otr_error_message_free&quot;,</span>
<a href="#l25.1216"></a><span id="l25.1216">       &quot;resent_msg_prefix&quot;,</span>
<a href="#l25.1217"></a><span id="l25.1217">       &quot;resent_msg_prefix_free&quot;,</span>
<a href="#l25.1218"></a><span id="l25.1218">       &quot;handle_smp_event&quot;,</span>
<a href="#l25.1219"></a><span id="l25.1219">       &quot;handle_msg_event&quot;,</span>
<a href="#l25.1220"></a><span id="l25.1220">       &quot;create_instag&quot;,</span>
<a href="#l25.1221"></a><span id="l25.1221" class="difflineminus">-      &quot;convert_msg&quot;,  // not implemented</span>
<a href="#l25.1222"></a><span id="l25.1222" class="difflineminus">-      &quot;convert_free&quot;,  // not implemented</span>
<a href="#l25.1223"></a><span id="l25.1223" class="difflineplus">+      &quot;convert_msg&quot;, // not implemented</span>
<a href="#l25.1224"></a><span id="l25.1224" class="difflineplus">+      &quot;convert_free&quot;, // not implemented</span>
<a href="#l25.1225"></a><span id="l25.1225">       &quot;timer_control&quot;,</span>
<a href="#l25.1226"></a><span id="l25.1226">     ];</span>
<a href="#l25.1227"></a><span id="l25.1227"> </span>
<a href="#l25.1228"></a><span id="l25.1228">     for (let i = 0; i &lt; methods.length; i++) {</span>
<a href="#l25.1229"></a><span id="l25.1229">       let m = methods[i];</span>
<a href="#l25.1230"></a><span id="l25.1230">       if (!this[m + &quot;_cb&quot;]) {</span>
<a href="#l25.1231"></a><span id="l25.1231">         this.uiOps[m] = null;</span>
<a href="#l25.1232"></a><span id="l25.1232">         continue;</span>
<a href="#l25.1233"></a><span id="l25.1233" class="difflineat">@@ -956,32 +1135,33 @@ var OTR = {</span>
<a href="#l25.1234"></a><span id="l25.1234">   },</span>
<a href="#l25.1235"></a><span id="l25.1235"> </span>
<a href="#l25.1236"></a><span id="l25.1236">   sendAlert(context, msg) {</span>
<a href="#l25.1237"></a><span id="l25.1237">     this.getUIConvFromContext(context).systemMessage(msg);</span>
<a href="#l25.1238"></a><span id="l25.1238">   },</span>
<a href="#l25.1239"></a><span id="l25.1239"> </span>
<a href="#l25.1240"></a><span id="l25.1240">   observe(aObject, aTopic, aMsg) {</span>
<a href="#l25.1241"></a><span id="l25.1241">     switch (aTopic) {</span>
<a href="#l25.1242"></a><span id="l25.1242" class="difflineminus">-    case &quot;sending-message&quot;:</span>
<a href="#l25.1243"></a><span id="l25.1243" class="difflineminus">-      this.onSend(aObject);</span>
<a href="#l25.1244"></a><span id="l25.1244" class="difflineminus">-      break;</span>
<a href="#l25.1245"></a><span id="l25.1245" class="difflineminus">-    case &quot;received-message&quot;:</span>
<a href="#l25.1246"></a><span id="l25.1246" class="difflineminus">-      this.onReceive(aObject);</span>
<a href="#l25.1247"></a><span id="l25.1247" class="difflineminus">-      break;</span>
<a href="#l25.1248"></a><span id="l25.1248" class="difflineminus">-    case &quot;new-ui-conversation&quot;:</span>
<a href="#l25.1249"></a><span id="l25.1249" class="difflineminus">-      this.addConversation(aObject);</span>
<a href="#l25.1250"></a><span id="l25.1250" class="difflineminus">-      break;</span>
<a href="#l25.1251"></a><span id="l25.1251" class="difflineplus">+      case &quot;sending-message&quot;:</span>
<a href="#l25.1252"></a><span id="l25.1252" class="difflineplus">+        this.onSend(aObject);</span>
<a href="#l25.1253"></a><span id="l25.1253" class="difflineplus">+        break;</span>
<a href="#l25.1254"></a><span id="l25.1254" class="difflineplus">+      case &quot;received-message&quot;:</span>
<a href="#l25.1255"></a><span id="l25.1255" class="difflineplus">+        this.onReceive(aObject);</span>
<a href="#l25.1256"></a><span id="l25.1256" class="difflineplus">+        break;</span>
<a href="#l25.1257"></a><span id="l25.1257" class="difflineplus">+      case &quot;new-ui-conversation&quot;:</span>
<a href="#l25.1258"></a><span id="l25.1258" class="difflineplus">+        this.addConversation(aObject);</span>
<a href="#l25.1259"></a><span id="l25.1259" class="difflineplus">+        break;</span>
<a href="#l25.1260"></a><span id="l25.1260">     }</span>
<a href="#l25.1261"></a><span id="l25.1261">   },</span>
<a href="#l25.1262"></a><span id="l25.1262"> </span>
<a href="#l25.1263"></a><span id="l25.1263">   addConversation(uiConv) {</span>
<a href="#l25.1264"></a><span id="l25.1264">     let conv = uiConv.target;</span>
<a href="#l25.1265"></a><span id="l25.1265" class="difflineminus">-    if (conv.isChat)</span>
<a href="#l25.1266"></a><span id="l25.1266" class="difflineplus">+    if (conv.isChat) {</span>
<a href="#l25.1267"></a><span id="l25.1267">       return;</span>
<a href="#l25.1268"></a><span id="l25.1268" class="difflineplus">+    }</span>
<a href="#l25.1269"></a><span id="l25.1269">     this._convos.set(conv.id, uiConv);</span>
<a href="#l25.1270"></a><span id="l25.1270">     uiConv.addObserver(this);</span>
<a href="#l25.1271"></a><span id="l25.1271">   },</span>
<a href="#l25.1272"></a><span id="l25.1272"> </span>
<a href="#l25.1273"></a><span id="l25.1273">   removeConversation(uiConv) {</span>
<a href="#l25.1274"></a><span id="l25.1274">     uiConv.removeObserver(this);</span>
<a href="#l25.1275"></a><span id="l25.1275">     this._convos.delete(uiConv.target.id);</span>
<a href="#l25.1276"></a><span id="l25.1276">     this.clearMsgs(uiConv.target.id);</span>
<a href="#l25.1277"></a><span id="l25.1277" class="difflineat">@@ -1019,29 +1199,32 @@ var OTR = {</span>
<a href="#l25.1278"></a><span id="l25.1278">       this.userstate,</span>
<a href="#l25.1279"></a><span id="l25.1279">       this.uiOps.address(),</span>
<a href="#l25.1280"></a><span id="l25.1280">       null,</span>
<a href="#l25.1281"></a><span id="l25.1281">       context._context</span>
<a href="#l25.1282"></a><span id="l25.1282">     );</span>
<a href="#l25.1283"></a><span id="l25.1283">   },</span>
<a href="#l25.1284"></a><span id="l25.1284"> </span>
<a href="#l25.1285"></a><span id="l25.1285">   onSend(om) {</span>
<a href="#l25.1286"></a><span id="l25.1286" class="difflineminus">-    if (om.cancelled)</span>
<a href="#l25.1287"></a><span id="l25.1287" class="difflineplus">+    if (om.cancelled) {</span>
<a href="#l25.1288"></a><span id="l25.1288">       return;</span>
<a href="#l25.1289"></a><span id="l25.1289" class="difflineplus">+    }</span>
<a href="#l25.1290"></a><span id="l25.1290"> </span>
<a href="#l25.1291"></a><span id="l25.1291">     let conv = om.conversation;</span>
<a href="#l25.1292"></a><span id="l25.1292" class="difflineminus">-    if (conv.isChat)</span>
<a href="#l25.1293"></a><span id="l25.1293" class="difflineplus">+    if (conv.isChat) {</span>
<a href="#l25.1294"></a><span id="l25.1294">       return;</span>
<a href="#l25.1295"></a><span id="l25.1295" class="difflineplus">+    }</span>
<a href="#l25.1296"></a><span id="l25.1296"> </span>
<a href="#l25.1297"></a><span id="l25.1297">     // check for irc action messages</span>
<a href="#l25.1298"></a><span id="l25.1298">     if (om.action) {</span>
<a href="#l25.1299"></a><span id="l25.1299">       om.cancelled = true;</span>
<a href="#l25.1300"></a><span id="l25.1300">       let uiConv = this.getUIConvFromConv(conv);</span>
<a href="#l25.1301"></a><span id="l25.1301" class="difflineminus">-      if (uiConv)</span>
<a href="#l25.1302"></a><span id="l25.1302" class="difflineplus">+      if (uiConv) {</span>
<a href="#l25.1303"></a><span id="l25.1303">         uiConv.sendMsg(&quot;/me &quot; + om.message);</span>
<a href="#l25.1304"></a><span id="l25.1304" class="difflineplus">+      }</span>
<a href="#l25.1305"></a><span id="l25.1305">       return;</span>
<a href="#l25.1306"></a><span id="l25.1306">     }</span>
<a href="#l25.1307"></a><span id="l25.1307"> </span>
<a href="#l25.1308"></a><span id="l25.1308">     let newMessage = new ctypes.char.ptr();</span>
<a href="#l25.1309"></a><span id="l25.1309"> </span>
<a href="#l25.1310"></a><span id="l25.1310">     this.log(&quot;pre sending: &quot; + om.message);</span>
<a href="#l25.1311"></a><span id="l25.1311"> </span>
<a href="#l25.1312"></a><span id="l25.1312">     let err = OTRLib.otrl_message_sending(</span>
<a href="#l25.1313"></a><span id="l25.1313" class="difflineat">@@ -1060,34 +1243,38 @@ var OTR = {</span>
<a href="#l25.1314"></a><span id="l25.1314">       null,</span>
<a href="#l25.1315"></a><span id="l25.1315">       null</span>
<a href="#l25.1316"></a><span id="l25.1316">     );</span>
<a href="#l25.1317"></a><span id="l25.1317"> </span>
<a href="#l25.1318"></a><span id="l25.1318">     let msg = om.message;</span>
<a href="#l25.1319"></a><span id="l25.1319"> </span>
<a href="#l25.1320"></a><span id="l25.1320">     if (err) {</span>
<a href="#l25.1321"></a><span id="l25.1321">       om.cancelled = true;</span>
<a href="#l25.1322"></a><span id="l25.1322" class="difflineminus">-      Cu.reportError(new Error(&quot;Failed to send message. Returned code: &quot; + err));</span>
<a href="#l25.1323"></a><span id="l25.1323" class="difflineplus">+      Cu.reportError(</span>
<a href="#l25.1324"></a><span id="l25.1324" class="difflineplus">+        new Error(&quot;Failed to send message. Returned code: &quot; + err)</span>
<a href="#l25.1325"></a><span id="l25.1325" class="difflineplus">+      );</span>
<a href="#l25.1326"></a><span id="l25.1326">     } else if (!newMessage.isNull()) {</span>
<a href="#l25.1327"></a><span id="l25.1327">       msg = newMessage.readString();</span>
<a href="#l25.1328"></a><span id="l25.1328">       // https://bugs.otr.im/lib/libotr/issues/52</span>
<a href="#l25.1329"></a><span id="l25.1329">       if (!msg) {</span>
<a href="#l25.1330"></a><span id="l25.1330">         om.cancelled = true;</span>
<a href="#l25.1331"></a><span id="l25.1331">       }</span>
<a href="#l25.1332"></a><span id="l25.1332">     }</span>
<a href="#l25.1333"></a><span id="l25.1333"> </span>
<a href="#l25.1334"></a><span id="l25.1334">     if (!om.cancelled) {</span>
<a href="#l25.1335"></a><span id="l25.1335">       // OTR handshakes only work while both peers are online.</span>
<a href="#l25.1336"></a><span id="l25.1336">       // Sometimes we want to include a special whitespace suffix,</span>
<a href="#l25.1337"></a><span id="l25.1337">       // which the OTR protocol uses to signal that the sender is willing</span>
<a href="#l25.1338"></a><span id="l25.1338">       // to start an OTR session. Don't do that for offline messages.</span>
<a href="#l25.1339"></a><span id="l25.1339">       // See: https://bugs.otr.im/lib/libotr/issues/102</span>
<a href="#l25.1340"></a><span id="l25.1340" class="difflineminus">-      if (isOnline(conv) === 0 ||</span>
<a href="#l25.1341"></a><span id="l25.1341" class="difflineminus">-          // Twitter trims tweets.</span>
<a href="#l25.1342"></a><span id="l25.1342" class="difflineminus">-          conv.account.protocol.normalizedName === &quot;twitter&quot;) {</span>
<a href="#l25.1343"></a><span id="l25.1343" class="difflineplus">+      if (</span>
<a href="#l25.1344"></a><span id="l25.1344" class="difflineplus">+        isOnline(conv) === 0 ||</span>
<a href="#l25.1345"></a><span id="l25.1345" class="difflineplus">+        // Twitter trims tweets.</span>
<a href="#l25.1346"></a><span id="l25.1346" class="difflineplus">+        conv.account.protocol.normalizedName === &quot;twitter&quot;</span>
<a href="#l25.1347"></a><span id="l25.1347" class="difflineplus">+      ) {</span>
<a href="#l25.1348"></a><span id="l25.1348">         let ind = msg.indexOf(OTRLib.OTRL_MESSAGE_TAG_BASE);</span>
<a href="#l25.1349"></a><span id="l25.1349">         if (ind &gt; -1) {</span>
<a href="#l25.1350"></a><span id="l25.1350">           msg = msg.substring(0, ind);</span>
<a href="#l25.1351"></a><span id="l25.1351">           let context = this.getContext(conv);</span>
<a href="#l25.1352"></a><span id="l25.1352">           context._context.contents.otr_offer = OTRLib.otr_offer.OFFER_NOT;</span>
<a href="#l25.1353"></a><span id="l25.1353">         }</span>
<a href="#l25.1354"></a><span id="l25.1354">       }</span>
<a href="#l25.1355"></a><span id="l25.1355"> </span>
<a href="#l25.1356"></a><span id="l25.1356" class="difflineat">@@ -1095,22 +1282,24 @@ var OTR = {</span>
<a href="#l25.1357"></a><span id="l25.1357">       om.message = msg;</span>
<a href="#l25.1358"></a><span id="l25.1358">     }</span>
<a href="#l25.1359"></a><span id="l25.1359"> </span>
<a href="#l25.1360"></a><span id="l25.1360">     this.log(&quot;post sending (&quot; + !om.cancelled + &quot;): &quot; + om.message);</span>
<a href="#l25.1361"></a><span id="l25.1361">     OTRLib.otrl_message_free(newMessage);</span>
<a href="#l25.1362"></a><span id="l25.1362">   },</span>
<a href="#l25.1363"></a><span id="l25.1363"> </span>
<a href="#l25.1364"></a><span id="l25.1364">   onReceive(im) {</span>
<a href="#l25.1365"></a><span id="l25.1365" class="difflineminus">-    if (im.cancelled || im.system)</span>
<a href="#l25.1366"></a><span id="l25.1366" class="difflineplus">+    if (im.cancelled || im.system) {</span>
<a href="#l25.1367"></a><span id="l25.1367">       return;</span>
<a href="#l25.1368"></a><span id="l25.1368" class="difflineplus">+    }</span>
<a href="#l25.1369"></a><span id="l25.1369"> </span>
<a href="#l25.1370"></a><span id="l25.1370">     let conv = im.conversation;</span>
<a href="#l25.1371"></a><span id="l25.1371" class="difflineminus">-    if (conv.isChat)</span>
<a href="#l25.1372"></a><span id="l25.1372" class="difflineplus">+    if (conv.isChat) {</span>
<a href="#l25.1373"></a><span id="l25.1373">       return;</span>
<a href="#l25.1374"></a><span id="l25.1374" class="difflineplus">+    }</span>
<a href="#l25.1375"></a><span id="l25.1375"> </span>
<a href="#l25.1376"></a><span id="l25.1376">     // After outgoing messages have been handled in onSend,</span>
<a href="#l25.1377"></a><span id="l25.1377">     // they are again passed back to us, here in onReceive.</span>
<a href="#l25.1378"></a><span id="l25.1378">     // This is our chance to prevent both outgoing and incoming OTR</span>
<a href="#l25.1379"></a><span id="l25.1379">     // messages from being logged here.</span>
<a href="#l25.1380"></a><span id="l25.1380">     if (im.originalMessage.startsWith(&quot;?OTR&quot;)) {</span>
<a href="#l25.1381"></a><span id="l25.1381">       im.encrypted = true;</span>
<a href="#l25.1382"></a><span id="l25.1382">     }</span>
<a href="#l25.1383"></a><span id="l25.1383" class="difflineat">@@ -1146,51 +1335,55 @@ var OTR = {</span>
<a href="#l25.1384"></a><span id="l25.1384">     }</span>
<a href="#l25.1385"></a><span id="l25.1385"> </span>
<a href="#l25.1386"></a><span id="l25.1386">     // search tlvs for a disconnect msg</span>
<a href="#l25.1387"></a><span id="l25.1387">     // https://bugs.otr.im/lib/libotr/issues/54</span>
<a href="#l25.1388"></a><span id="l25.1388">     let tlv = OTRLib.otrl_tlv_find(tlvs, OTRLib.tlvs.OTRL_TLV_DISCONNECTED);</span>
<a href="#l25.1389"></a><span id="l25.1389">     if (!tlv.isNull()) {</span>
<a href="#l25.1390"></a><span id="l25.1390">       let context = this.getContext(conv);</span>
<a href="#l25.1391"></a><span id="l25.1391">       this.notifyObservers(context, &quot;otr:disconnected&quot;);</span>
<a href="#l25.1392"></a><span id="l25.1392" class="difflineminus">-      this.sendAlert(context, _strArgs(&quot;tlv-disconnected&quot;, {name: conv.normalizedName}));</span>
<a href="#l25.1393"></a><span id="l25.1393" class="difflineplus">+      this.sendAlert(</span>
<a href="#l25.1394"></a><span id="l25.1394" class="difflineplus">+        context,</span>
<a href="#l25.1395"></a><span id="l25.1395" class="difflineplus">+        _strArgs(&quot;tlv-disconnected&quot;, { name: conv.normalizedName })</span>
<a href="#l25.1396"></a><span id="l25.1396" class="difflineplus">+      );</span>
<a href="#l25.1397"></a><span id="l25.1397">     }</span>
<a href="#l25.1398"></a><span id="l25.1398"> </span>
<a href="#l25.1399"></a><span id="l25.1399">     if (err) {</span>
<a href="#l25.1400"></a><span id="l25.1400">       this.log(&quot;error (&quot; + err + &quot;) ignoring: &quot; + im.displayMessage);</span>
<a href="#l25.1401"></a><span id="l25.1401" class="difflineminus">-      im.cancelled = true;  // ignore</span>
<a href="#l25.1402"></a><span id="l25.1402" class="difflineplus">+      im.cancelled = true; // ignore</span>
<a href="#l25.1403"></a><span id="l25.1403">     } else {</span>
<a href="#l25.1404"></a><span id="l25.1404">       this.log(&quot;post receiving: &quot; + im.displayMessage);</span>
<a href="#l25.1405"></a><span id="l25.1405">     }</span>
<a href="#l25.1406"></a><span id="l25.1406"> </span>
<a href="#l25.1407"></a><span id="l25.1407">     OTRLib.otrl_tlv_free(tlvs);</span>
<a href="#l25.1408"></a><span id="l25.1408">     OTRLib.otrl_message_free(newMessage);</span>
<a href="#l25.1409"></a><span id="l25.1409">   },</span>
<a href="#l25.1410"></a><span id="l25.1410"> </span>
<a href="#l25.1411"></a><span id="l25.1411">   // observer interface</span>
<a href="#l25.1412"></a><span id="l25.1412"> </span>
<a href="#l25.1413"></a><span id="l25.1413">   addObserver(observer) {</span>
<a href="#l25.1414"></a><span id="l25.1414" class="difflineminus">-    if (!this._observers.includes(observer))</span>
<a href="#l25.1415"></a><span id="l25.1415" class="difflineplus">+    if (!this._observers.includes(observer)) {</span>
<a href="#l25.1416"></a><span id="l25.1416">       this._observers.push(observer);</span>
<a href="#l25.1417"></a><span id="l25.1417" class="difflineplus">+    }</span>
<a href="#l25.1418"></a><span id="l25.1418">   },</span>
<a href="#l25.1419"></a><span id="l25.1419"> </span>
<a href="#l25.1420"></a><span id="l25.1420">   removeObserver(observer) {</span>
<a href="#l25.1421"></a><span id="l25.1421">     this._observers = this._observers.filter(o =&gt; o !== observer);</span>
<a href="#l25.1422"></a><span id="l25.1422">   },</span>
<a href="#l25.1423"></a><span id="l25.1423"> </span>
<a href="#l25.1424"></a><span id="l25.1424">   notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l25.1425"></a><span id="l25.1425">     for (let observer of this._observers) {</span>
<a href="#l25.1426"></a><span id="l25.1426">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l25.1427"></a><span id="l25.1427">     }</span>
<a href="#l25.1428"></a><span id="l25.1428">   },</span>
<a href="#l25.1429"></a><span id="l25.1429"> </span>
<a href="#l25.1430"></a><span id="l25.1430">   // buffer messages</span>
<a href="#l25.1431"></a><span id="l25.1431"> </span>
<a href="#l25.1432"></a><span id="l25.1432">   clearMsgs(convId) {</span>
<a href="#l25.1433"></a><span id="l25.1433" class="difflineminus">-    this._buffer = this._buffer.filter((msg) =&gt; msg.convId !== convId);</span>
<a href="#l25.1434"></a><span id="l25.1434" class="difflineplus">+    this._buffer = this._buffer.filter(msg =&gt; msg.convId !== convId);</span>
<a href="#l25.1435"></a><span id="l25.1435">   },</span>
<a href="#l25.1436"></a><span id="l25.1436"> </span>
<a href="#l25.1437"></a><span id="l25.1437">   bufferMsg(convId, display, sent) {</span>
<a href="#l25.1438"></a><span id="l25.1438">     this._buffer.push({</span>
<a href="#l25.1439"></a><span id="l25.1439">       convId,</span>
<a href="#l25.1440"></a><span id="l25.1440">       display,</span>
<a href="#l25.1441"></a><span id="l25.1441">       sent,</span>
<a href="#l25.1442"></a><span id="l25.1442">       time: Date.now(),</span>
<a href="#l25.1443"></a><span id="l25.1443" class="difflineat">@@ -1207,14 +1400,13 @@ var OTR = {</span>
<a href="#l25.1444"></a><span id="l25.1444">         this.log(&quot;displaying: &quot; + b.display);</span>
<a href="#l25.1445"></a><span id="l25.1445">         return;</span>
<a href="#l25.1446"></a><span id="l25.1446">       }</span>
<a href="#l25.1447"></a><span id="l25.1447">     }</span>
<a href="#l25.1448"></a><span id="l25.1448">     // don't display if it wasn't buffered</span>
<a href="#l25.1449"></a><span id="l25.1449">     im.cancelled = true;</span>
<a href="#l25.1450"></a><span id="l25.1450">     this.log(&quot;not displaying: &quot; + im.displayMessage);</span>
<a href="#l25.1451"></a><span id="l25.1451">   },</span>
<a href="#l25.1452"></a><span id="l25.1452" class="difflineminus">-</span>
<a href="#l25.1453"></a><span id="l25.1453"> };</span>
<a href="#l25.1454"></a><span id="l25.1454"> </span>
<a href="#l25.1455"></a><span id="l25.1455"> // exports</span>
<a href="#l25.1456"></a><span id="l25.1456"> </span>
<a href="#l25.1457"></a><span id="l25.1457"> this.EXPORTED_SYMBOLS = [&quot;OTR&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/chat/modules/OTRHelpers.jsm</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/chat/modules/OTRHelpers.jsm</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,38 +1,37 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.5"></a><span id="l26.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.6"></a><span id="l26.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8" class="difflineminus">-const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l26.12"></a><span id="l26.12"> </span>
<a href="#l26.13"></a><span id="l26.13"> var OTRHelpers = {</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-</span>
<a href="#l26.15"></a><span id="l26.15">   profilePath(filename) {</span>
<a href="#l26.16"></a><span id="l26.16">     return OS.Path.join(OS.Constants.Path.profileDir, filename);</span>
<a href="#l26.17"></a><span id="l26.17">   },</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-  * getAccounts() {</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+  *getAccounts() {</span>
<a href="#l26.21"></a><span id="l26.21">     let accounts = Services.accounts.getAccounts();</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-    while (accounts.hasMoreElements())</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+    while (accounts.hasMoreElements()) {</span>
<a href="#l26.24"></a><span id="l26.24">       yield accounts.getNext();</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+    }</span>
<a href="#l26.26"></a><span id="l26.26">   },</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28">   readTextFile(filename) {</span>
<a href="#l26.29"></a><span id="l26.29">     let decoder = new TextDecoder();</span>
<a href="#l26.30"></a><span id="l26.30">     return OS.File.read(filename).then(function(array) {</span>
<a href="#l26.31"></a><span id="l26.31">       return decoder.decode(array);</span>
<a href="#l26.32"></a><span id="l26.32">     });</span>
<a href="#l26.33"></a><span id="l26.33">   },</span>
<a href="#l26.34"></a><span id="l26.34"> </span>
<a href="#l26.35"></a><span id="l26.35">   writeTextFile(filename, data) {</span>
<a href="#l26.36"></a><span id="l26.36">     let encoder = new TextEncoder();</span>
<a href="#l26.37"></a><span id="l26.37">     let array = encoder.encode(data);</span>
<a href="#l26.38"></a><span id="l26.38">     // https://dutherenverseauborddelatable.wordpress.com/2014/02/05/is-my-data-on-the-disk-safety-properties-of-os-file-writeatomic/</span>
<a href="#l26.39"></a><span id="l26.39">     return OS.File.writeAtomic(filename, array, { tmpPath: `${filename}.tmp` });</span>
<a href="#l26.40"></a><span id="l26.40">   },</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-</span>
<a href="#l26.42"></a><span id="l26.42"> };</span>
<a href="#l26.43"></a><span id="l26.43"> </span>
<a href="#l26.44"></a><span id="l26.44"> // exports</span>
<a href="#l26.45"></a><span id="l26.45"> </span>
<a href="#l26.46"></a><span id="l26.46"> this.EXPORTED_SYMBOLS = [&quot;OTRHelpers&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/chat/modules/OTRLib.jsm</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/chat/modules/OTRLib.jsm</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,20 +1,20 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.5"></a><span id="l27.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.6"></a><span id="l27.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> const otrl_version = [4, 1, 1];</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-const {CLib} = ChromeUtils.import(&quot;resource:///modules/CLib.jsm&quot;);</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-const {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+const { CLib } = ChromeUtils.import(&quot;resource:///modules/CLib.jsm&quot;);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+const { ctypes } = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.16"></a><span id="l27.16"> var systemOS = Services.appinfo.OS.toLowerCase();</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21"> var abi = ctypes.default_abi;</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23"> // Open libotr. Determine the path to the chrome directory and look for it</span>
<a href="#l27.24"></a><span id="l27.24"> // there first. If not, fallback to searching the standard locations.</span>
<a href="#l27.25"></a><span id="l27.25"> var libotr, libotrPath;</span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27"> function tryLoadOTR(name, suffix) {</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineat">@@ -27,18 +27,21 @@ function tryLoadOTR(name, suffix) {</span>
<a href="#l27.29"></a><span id="l27.29">     console.log(&quot;===&gt; trying to load &quot; + libotrPath);</span>
<a href="#l27.30"></a><span id="l27.30">     libotr = ctypes.open(libotrPath);</span>
<a href="#l27.31"></a><span id="l27.31">   } catch (e) {}</span>
<a href="#l27.32"></a><span id="l27.32"> </span>
<a href="#l27.33"></a><span id="l27.33">   if (!libotr) {</span>
<a href="#l27.34"></a><span id="l27.34">     try {</span>
<a href="#l27.35"></a><span id="l27.35">       // look in standard locations</span>
<a href="#l27.36"></a><span id="l27.36">       libotrPath = filename;</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-      console.log(&quot;===&gt; trying to load &quot; +</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-        libotrPath + &quot; from system's standard locations&quot;);</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+      console.log(</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+        &quot;===&gt; trying to load &quot; +</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+          libotrPath +</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+          &quot; from system's standard locations&quot;</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+      );</span>
<a href="#l27.44"></a><span id="l27.44">       libotr = ctypes.open(libotrPath);</span>
<a href="#l27.45"></a><span id="l27.45">     } catch (e) {}</span>
<a href="#l27.46"></a><span id="l27.46">   }</span>
<a href="#l27.47"></a><span id="l27.47"> }</span>
<a href="#l27.48"></a><span id="l27.48"> </span>
<a href="#l27.49"></a><span id="l27.49"> function loadExternalOTRLib() {</span>
<a href="#l27.50"></a><span id="l27.50">   if (!libotr &amp;&amp; (systemOS === &quot;winnt&quot; || systemOS === &quot;darwin&quot;)) {</span>
<a href="#l27.51"></a><span id="l27.51">     // otr.5.dll or otr.5.dylib</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineat">@@ -73,27 +76,28 @@ var OTRLibLoader = {</span>
<a href="#l27.53"></a><span id="l27.53">     }</span>
<a href="#l27.54"></a><span id="l27.54">     return OTRLib;</span>
<a href="#l27.55"></a><span id="l27.55">   },</span>
<a href="#l27.56"></a><span id="l27.56"> };</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58"> // Helper function to open files with the path properly encoded.</span>
<a href="#l27.59"></a><span id="l27.59"> var callWithFILEp = function() {</span>
<a href="#l27.60"></a><span id="l27.60">   // Windows filenames are in UTF-16.</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-  let charType = (systemOS === &quot;winnt&quot;) ? &quot;jschar&quot; : &quot;char&quot;;</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+  let charType = systemOS === &quot;winnt&quot; ? &quot;jschar&quot; : &quot;char&quot;;</span>
<a href="#l27.63"></a><span id="l27.63"> </span>
<a href="#l27.64"></a><span id="l27.64">   let args = Array.from(arguments);</span>
<a href="#l27.65"></a><span id="l27.65">   let func = args.shift() + &quot;_FILEp&quot;;</span>
<a href="#l27.66"></a><span id="l27.66">   let mode = ctypes[charType].array()(args.shift());</span>
<a href="#l27.67"></a><span id="l27.67">   let ind = args.shift();</span>
<a href="#l27.68"></a><span id="l27.68">   let filename = ctypes[charType].array()(args[ind]);</span>
<a href="#l27.69"></a><span id="l27.69"> </span>
<a href="#l27.70"></a><span id="l27.70">   let file = CLib.fopen(filename, mode);</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-  if (file.isNull())</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+  if (file.isNull()) {</span>
<a href="#l27.73"></a><span id="l27.73">     return 1;</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+  }</span>
<a href="#l27.75"></a><span id="l27.75"> </span>
<a href="#l27.76"></a><span id="l27.76">   // Swap filename with file.</span>
<a href="#l27.77"></a><span id="l27.77">   args[ind] = file;</span>
<a href="#l27.78"></a><span id="l27.78"> </span>
<a href="#l27.79"></a><span id="l27.79">   let ret = OTRLib[func].apply(OTRLib, args);</span>
<a href="#l27.80"></a><span id="l27.80">   CLib.fclose(file);</span>
<a href="#l27.81"></a><span id="l27.81">   return ret;</span>
<a href="#l27.82"></a><span id="l27.82"> };</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineat">@@ -143,115 +147,159 @@ const OtrlMessageState = ctypes.int;</span>
<a href="#l27.84"></a><span id="l27.84"> const OtrlAuthState = ctypes.int;</span>
<a href="#l27.85"></a><span id="l27.85"> const OtrlSessionIdHalf = ctypes.int;</span>
<a href="#l27.86"></a><span id="l27.86"> const OtrlSMProgState = ctypes.int;</span>
<a href="#l27.87"></a><span id="l27.87"> const NextExpectedSMP = ctypes.int;</span>
<a href="#l27.88"></a><span id="l27.88"> </span>
<a href="#l27.89"></a><span id="l27.89"> // callback signatures</span>
<a href="#l27.90"></a><span id="l27.90"> </span>
<a href="#l27.91"></a><span id="l27.91"> const policy_cb_t = ctypes.FunctionType(abi, OtrlPolicy, [</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.95"></a><span id="l27.95"> ]).ptr;</span>
<a href="#l27.96"></a><span id="l27.96"> </span>
<a href="#l27.97"></a><span id="l27.97"> const create_privkey_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.102"></a><span id="l27.102"> ]).ptr;</span>
<a href="#l27.103"></a><span id="l27.103"> </span>
<a href="#l27.104"></a><span id="l27.104"> const is_logged_in_cb_t = ctypes.FunctionType(abi, ctypes.int, [</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.110"></a><span id="l27.110"> ]).ptr;</span>
<a href="#l27.111"></a><span id="l27.111"> </span>
<a href="#l27.112"></a><span id="l27.112"> const inject_message_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.118"></a><span id="l27.118">   ctypes.char.ptr,</span>
<a href="#l27.119"></a><span id="l27.119"> ]).ptr;</span>
<a href="#l27.120"></a><span id="l27.120"> </span>
<a href="#l27.121"></a><span id="l27.121"> const update_context_list_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.122"></a><span id="l27.122">   ctypes.void_t.ptr,</span>
<a href="#l27.123"></a><span id="l27.123"> ]).ptr;</span>
<a href="#l27.124"></a><span id="l27.124"> </span>
<a href="#l27.125"></a><span id="l27.125"> const new_fingerprint_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-  ctypes.void_t.ptr, OtrlUserState, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineminus">-  ctypes.char.ptr, ctypes.unsigned_char.array(20),</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineplus">+  OtrlUserState,</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+  ctypes.unsigned_char.array(20),</span>
<a href="#l27.134"></a><span id="l27.134"> ]).ptr;</span>
<a href="#l27.135"></a><span id="l27.135"> </span>
<a href="#l27.136"></a><span id="l27.136"> const write_fingerprint_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.137"></a><span id="l27.137">   ctypes.void_t.ptr,</span>
<a href="#l27.138"></a><span id="l27.138"> ]).ptr;</span>
<a href="#l27.139"></a><span id="l27.139"> </span>
<a href="#l27.140"></a><span id="l27.140"> const gone_secure_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.144"></a><span id="l27.144"> ]).ptr;</span>
<a href="#l27.145"></a><span id="l27.145"> </span>
<a href="#l27.146"></a><span id="l27.146"> const gone_insecure_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.150"></a><span id="l27.150"> ]).ptr;</span>
<a href="#l27.151"></a><span id="l27.151"> </span>
<a href="#l27.152"></a><span id="l27.152"> const still_secure_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr, ctypes.int,</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+  ctypes.int,</span>
<a href="#l27.157"></a><span id="l27.157"> ]).ptr;</span>
<a href="#l27.158"></a><span id="l27.158"> </span>
<a href="#l27.159"></a><span id="l27.159"> const max_message_size_cb_t = ctypes.FunctionType(abi, ctypes.int, [</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.163"></a><span id="l27.163"> ]).ptr;</span>
<a href="#l27.164"></a><span id="l27.164"> </span>
<a href="#l27.165"></a><span id="l27.165"> const account_name_cb_t = ctypes.FunctionType(abi, ctypes.char.ptr, [</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.170"></a><span id="l27.170"> ]).ptr;</span>
<a href="#l27.171"></a><span id="l27.171"> </span>
<a href="#l27.172"></a><span id="l27.172"> const account_name_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr,</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.176"></a><span id="l27.176"> ]).ptr;</span>
<a href="#l27.177"></a><span id="l27.177"> </span>
<a href="#l27.178"></a><span id="l27.178"> const received_symkey_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr, ctypes.unsigned_int,</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-  ctypes.unsigned_char.ptr, ctypes.size_t, ctypes.unsigned_char.ptr,</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineplus">+  ctypes.unsigned_int,</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineplus">+  ctypes.unsigned_char.ptr,</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineplus">+  ctypes.size_t,</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineplus">+  ctypes.unsigned_char.ptr,</span>
<a href="#l27.187"></a><span id="l27.187"> ]).ptr;</span>
<a href="#l27.188"></a><span id="l27.188"> </span>
<a href="#l27.189"></a><span id="l27.189"> const otr_error_message_cb_t = ctypes.FunctionType(abi, ctypes.char.ptr, [</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr, OtrlErrorCode,</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineplus">+  OtrlErrorCode,</span>
<a href="#l27.194"></a><span id="l27.194"> ]).ptr;</span>
<a href="#l27.195"></a><span id="l27.195"> </span>
<a href="#l27.196"></a><span id="l27.196"> const otr_error_message_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr,</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.200"></a><span id="l27.200"> ]).ptr;</span>
<a href="#l27.201"></a><span id="l27.201"> </span>
<a href="#l27.202"></a><span id="l27.202"> const resent_msg_prefix_cb_t = ctypes.FunctionType(abi, ctypes.char.ptr, [</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.206"></a><span id="l27.206"> ]).ptr;</span>
<a href="#l27.207"></a><span id="l27.207"> </span>
<a href="#l27.208"></a><span id="l27.208"> const resent_msg_prefix_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr,</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.212"></a><span id="l27.212"> ]).ptr;</span>
<a href="#l27.213"></a><span id="l27.213"> </span>
<a href="#l27.214"></a><span id="l27.214"> const handle_smp_event_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.215"></a><span id="l27.215" class="difflineminus">-  ctypes.void_t.ptr, OtrlSMPEvent, ConnContext.ptr, ctypes.unsigned_short,</span>
<a href="#l27.216"></a><span id="l27.216" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineplus">+  OtrlSMPEvent,</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineplus">+  ctypes.unsigned_short,</span>
<a href="#l27.220"></a><span id="l27.220">   ctypes.char.ptr,</span>
<a href="#l27.221"></a><span id="l27.221"> ]).ptr;</span>
<a href="#l27.222"></a><span id="l27.222"> </span>
<a href="#l27.223"></a><span id="l27.223"> const handle_msg_event_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineminus">-  ctypes.void_t.ptr, OtrlMessageEvent, ConnContext.ptr, ctypes.char.ptr,</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineplus">+  OtrlMessageEvent,</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.229"></a><span id="l27.229">   gcry_error_t,</span>
<a href="#l27.230"></a><span id="l27.230"> ]).ptr;</span>
<a href="#l27.231"></a><span id="l27.231"> </span>
<a href="#l27.232"></a><span id="l27.232"> const create_instag_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineminus">-  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.236"></a><span id="l27.236" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.237"></a><span id="l27.237"> ]).ptr;</span>
<a href="#l27.238"></a><span id="l27.238"> </span>
<a href="#l27.239"></a><span id="l27.239"> const convert_msg_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr, OtrlConvertType, ctypes.char.ptr.ptr,</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineplus">+  OtrlConvertType,</span>
<a href="#l27.244"></a><span id="l27.244" class="difflineplus">+  ctypes.char.ptr.ptr,</span>
<a href="#l27.245"></a><span id="l27.245">   ctypes.char.ptr,</span>
<a href="#l27.246"></a><span id="l27.246"> ]).ptr;</span>
<a href="#l27.247"></a><span id="l27.247"> </span>
<a href="#l27.248"></a><span id="l27.248"> const convert_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-  ctypes.void_t.ptr, ConnContext.ptr, ctypes.char.ptr,</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineplus">+  ConnContext.ptr,</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l27.253"></a><span id="l27.253"> ]).ptr;</span>
<a href="#l27.254"></a><span id="l27.254"> </span>
<a href="#l27.255"></a><span id="l27.255"> const timer_control_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-  ctypes.void_t.ptr, ctypes.unsigned_int,</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineplus">+  ctypes.unsigned_int,</span>
<a href="#l27.259"></a><span id="l27.259"> ]).ptr;</span>
<a href="#l27.260"></a><span id="l27.260"> </span>
<a href="#l27.261"></a><span id="l27.261"> // defines</span>
<a href="#l27.262"></a><span id="l27.262"> </span>
<a href="#l27.263"></a><span id="l27.263"> s_OtrlUserState.define([</span>
<a href="#l27.264"></a><span id="l27.264">   { context_root: ConnContext.ptr },</span>
<a href="#l27.265"></a><span id="l27.265">   { privkey_root: OtrlPrivKey.ptr },</span>
<a href="#l27.266"></a><span id="l27.266">   { instag_root: OtrlInsTag.ptr },</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineat">@@ -395,539 +443,671 @@ const OTRL_POLICY_WHITESPACE_START_AKE =</span>
<a href="#l27.268"></a><span id="l27.268"> // https://github.com/arlolra/ctypes-otr/issues/55</span>
<a href="#l27.269"></a><span id="l27.269"> </span>
<a href="#l27.270"></a><span id="l27.270"> var OTRLib;</span>
<a href="#l27.271"></a><span id="l27.271"> </span>
<a href="#l27.272"></a><span id="l27.272"> function enableOTRLibJS() {</span>
<a href="#l27.273"></a><span id="l27.273">   // this must be delayed until after &quot;libotr&quot; is initialized</span>
<a href="#l27.274"></a><span id="l27.274"> </span>
<a href="#l27.275"></a><span id="l27.275">   OTRLib = {</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineminus">-</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-  path: libotrPath,</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineplus">+    path: libotrPath,</span>
<a href="#l27.279"></a><span id="l27.279"> </span>
<a href="#l27.280"></a><span id="l27.280" class="difflineminus">-  // libotr API version</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineminus">-  otrl_version,</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineplus">+    // libotr API version</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineplus">+    otrl_version,</span>
<a href="#l27.284"></a><span id="l27.284"> </span>
<a href="#l27.285"></a><span id="l27.285" class="difflineminus">-  init() {</span>
<a href="#l27.286"></a><span id="l27.286" class="difflineminus">-    // console.log(&quot;===&gt; OTRLib.init()\n&quot;);</span>
<a href="#l27.287"></a><span id="l27.287" class="difflineminus">-    // apply version array as arguments to the init function</span>
<a href="#l27.288"></a><span id="l27.288" class="difflineminus">-    if (this.otrl_init.apply(this, this.otrl_version)) {</span>
<a href="#l27.289"></a><span id="l27.289" class="difflineminus">-      throw new Error(&quot;Couldn't initialize libotr.&quot;);</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineminus">-    }</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineminus">-    return true;</span>
<a href="#l27.292"></a><span id="l27.292" class="difflineminus">-  },</span>
<a href="#l27.293"></a><span id="l27.293" class="difflineplus">+    init() {</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineplus">+      // console.log(&quot;===&gt; OTRLib.init()\n&quot;);</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineplus">+      // apply version array as arguments to the init function</span>
<a href="#l27.296"></a><span id="l27.296" class="difflineplus">+      if (this.otrl_init.apply(this, this.otrl_version)) {</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineplus">+        throw new Error(&quot;Couldn't initialize libotr.&quot;);</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineplus">+      }</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineplus">+      return true;</span>
<a href="#l27.300"></a><span id="l27.300" class="difflineplus">+    },</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineplus">+</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineplus">+    // proto.h</span>
<a href="#l27.303"></a><span id="l27.303"> </span>
<a href="#l27.304"></a><span id="l27.304" class="difflineminus">-  // proto.h</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineminus">-  // If we ever see this sequence in a plaintext message, we'll assume the</span>
<a href="#l27.307"></a><span id="l27.307" class="difflineminus">-  // other side speaks OTR, and try to establish a connection.</span>
<a href="#l27.308"></a><span id="l27.308" class="difflineminus">-  OTRL_MESSAGE_TAG_BASE: &quot; \t  \t\t\t\t \t \t \t  &quot;,</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineplus">+    // If we ever see this sequence in a plaintext message, we'll assume the</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineplus">+    // other side speaks OTR, and try to establish a connection.</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineplus">+    OTRL_MESSAGE_TAG_BASE: &quot; \t  \t\t\t\t \t \t \t  &quot;,</span>
<a href="#l27.312"></a><span id="l27.312"> </span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-  OTRL_POLICY_OPPORTUNISTIC: new ctypes.unsigned_int(</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineminus">-    OTRL_POLICY_ALLOW_V2 |</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineminus">-    // OTRL_POLICY_ALLOW_V3 |</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineminus">-    OTRL_POLICY_SEND_WHITESPACE_TAG |</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-    OTRL_POLICY_WHITESPACE_START_AKE |</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineminus">-    // OTRL_POLICY_ERROR_START_AKE |</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineminus">-    0</span>
<a href="#l27.320"></a><span id="l27.320" class="difflineminus">-  ),</span>
<a href="#l27.321"></a><span id="l27.321" class="difflineplus">+    OTRL_POLICY_OPPORTUNISTIC: new ctypes.unsigned_int(</span>
<a href="#l27.322"></a><span id="l27.322" class="difflineplus">+      OTRL_POLICY_ALLOW_V2 |</span>
<a href="#l27.323"></a><span id="l27.323" class="difflineplus">+        // OTRL_POLICY_ALLOW_V3 |</span>
<a href="#l27.324"></a><span id="l27.324" class="difflineplus">+        OTRL_POLICY_SEND_WHITESPACE_TAG |</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineplus">+        OTRL_POLICY_WHITESPACE_START_AKE |</span>
<a href="#l27.326"></a><span id="l27.326" class="difflineplus">+        // OTRL_POLICY_ERROR_START_AKE |</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineplus">+        0</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineplus">+    ),</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineplus">+</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineplus">+    OTRL_POLICY_ALWAYS: new ctypes.unsigned_int(</span>
<a href="#l27.331"></a><span id="l27.331" class="difflineplus">+      OTRL_POLICY_ALLOW_V2 |</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineplus">+        // OTRL_POLICY_ALLOW_V3 |</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineplus">+        OTRL_POLICY_REQUIRE_ENCRYPTION |</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineplus">+        OTRL_POLICY_WHITESPACE_START_AKE |</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineplus">+        // OTRL_POLICY_ERROR_START_AKE |</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineplus">+        0</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineplus">+    ),</span>
<a href="#l27.338"></a><span id="l27.338"> </span>
<a href="#l27.339"></a><span id="l27.339" class="difflineminus">-  OTRL_POLICY_ALWAYS: new ctypes.unsigned_int(</span>
<a href="#l27.340"></a><span id="l27.340" class="difflineminus">-    OTRL_POLICY_ALLOW_V2 |</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineminus">-    // OTRL_POLICY_ALLOW_V3 |</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineminus">-    OTRL_POLICY_REQUIRE_ENCRYPTION |</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineminus">-    OTRL_POLICY_WHITESPACE_START_AKE |</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineminus">-    // OTRL_POLICY_ERROR_START_AKE |</span>
<a href="#l27.345"></a><span id="l27.345" class="difflineminus">-    0</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineminus">-  ),</span>
<a href="#l27.347"></a><span id="l27.347" class="difflineplus">+    fragPolicy: {</span>
<a href="#l27.348"></a><span id="l27.348" class="difflineplus">+      OTRL_FRAGMENT_SEND_SKIP: 0,</span>
<a href="#l27.349"></a><span id="l27.349" class="difflineplus">+      OTRL_FRAGMENT_SEND_ALL: 1,</span>
<a href="#l27.350"></a><span id="l27.350" class="difflineplus">+      OTRL_FRAGMENT_SEND_ALL_BUT_FIRST: 2,</span>
<a href="#l27.351"></a><span id="l27.351" class="difflineplus">+      OTRL_FRAGMENT_SEND_ALL_BUT_LAST: 3,</span>
<a href="#l27.352"></a><span id="l27.352" class="difflineplus">+    },</span>
<a href="#l27.353"></a><span id="l27.353"> </span>
<a href="#l27.354"></a><span id="l27.354" class="difflineminus">-  fragPolicy: {</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineminus">-    OTRL_FRAGMENT_SEND_SKIP: 0,</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineminus">-    OTRL_FRAGMENT_SEND_ALL: 1,</span>
<a href="#l27.357"></a><span id="l27.357" class="difflineminus">-    OTRL_FRAGMENT_SEND_ALL_BUT_FIRST: 2,</span>
<a href="#l27.358"></a><span id="l27.358" class="difflineminus">-    OTRL_FRAGMENT_SEND_ALL_BUT_LAST: 3,</span>
<a href="#l27.359"></a><span id="l27.359" class="difflineminus">-  },</span>
<a href="#l27.360"></a><span id="l27.360" class="difflineplus">+    // Return a pointer to a newly-allocated OTR query message, customized</span>
<a href="#l27.361"></a><span id="l27.361" class="difflineplus">+    // with our name.  The caller should free() the result when he's done</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineplus">+    // with it.</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineplus">+    otrl_proto_default_query_msg: libotr.declare(</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineplus">+      &quot;otrl_proto_default_query_msg&quot;,</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineplus">+      abi,</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+      OtrlPolicy</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineplus">+    ),</span>
<a href="#l27.370"></a><span id="l27.370"> </span>
<a href="#l27.371"></a><span id="l27.371" class="difflineminus">-  // Return a pointer to a newly-allocated OTR query message, customized</span>
<a href="#l27.372"></a><span id="l27.372" class="difflineminus">-  // with our name.  The caller should free() the result when he's done</span>
<a href="#l27.373"></a><span id="l27.373" class="difflineminus">-  // with it.</span>
<a href="#l27.374"></a><span id="l27.374" class="difflineminus">-  otrl_proto_default_query_msg: libotr.declare(</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineminus">-    &quot;otrl_proto_default_query_msg&quot;, abi, ctypes.char.ptr,</span>
<a href="#l27.376"></a><span id="l27.376" class="difflineminus">-    ctypes.char.ptr, OtrlPolicy</span>
<a href="#l27.377"></a><span id="l27.377" class="difflineminus">-  ),</span>
<a href="#l27.378"></a><span id="l27.378" class="difflineplus">+    // Initialize the OTR library. Pass the version of the API you are using.</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineplus">+    otrl_init: libotr.declare(</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineplus">+      &quot;otrl_init&quot;,</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineplus">+      abi,</span>
<a href="#l27.382"></a><span id="l27.382" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.383"></a><span id="l27.383" class="difflineplus">+      ctypes.unsigned_int,</span>
<a href="#l27.384"></a><span id="l27.384" class="difflineplus">+      ctypes.unsigned_int,</span>
<a href="#l27.385"></a><span id="l27.385" class="difflineplus">+      ctypes.unsigned_int</span>
<a href="#l27.386"></a><span id="l27.386" class="difflineplus">+    ),</span>
<a href="#l27.387"></a><span id="l27.387"> </span>
<a href="#l27.388"></a><span id="l27.388" class="difflineminus">-  // Initialize the OTR library. Pass the version of the API you are using.</span>
<a href="#l27.389"></a><span id="l27.389" class="difflineminus">-  otrl_init: libotr.declare(</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineminus">-    &quot;otrl_init&quot;, abi, gcry_error_t,</span>
<a href="#l27.391"></a><span id="l27.391" class="difflineminus">-    ctypes.unsigned_int, ctypes.unsigned_int, ctypes.unsigned_int</span>
<a href="#l27.392"></a><span id="l27.392" class="difflineminus">-  ),</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineplus">+    // instag.h</span>
<a href="#l27.394"></a><span id="l27.394"> </span>
<a href="#l27.395"></a><span id="l27.395" class="difflineminus">-  // instag.h</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineplus">+    instag: {</span>
<a href="#l27.397"></a><span id="l27.397" class="difflineplus">+      OTRL_INSTAG_MASTER: new ctypes.unsigned_int(0),</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineplus">+      OTRL_INSTAG_BEST: new ctypes.unsigned_int(1),</span>
<a href="#l27.399"></a><span id="l27.399" class="difflineplus">+      OTRL_INSTAG_RECENT: new ctypes.unsigned_int(2),</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineplus">+      OTRL_INSTAG_RECENT_RECEIVED: new ctypes.unsigned_int(3),</span>
<a href="#l27.401"></a><span id="l27.401" class="difflineplus">+      OTRL_INSTAG_RECENT_SENT: new ctypes.unsigned_int(4),</span>
<a href="#l27.402"></a><span id="l27.402" class="difflineplus">+      OTRL_MIN_VALID_INSTAG: new ctypes.unsigned_int(0x100),</span>
<a href="#l27.403"></a><span id="l27.403" class="difflineplus">+    },</span>
<a href="#l27.404"></a><span id="l27.404"> </span>
<a href="#l27.405"></a><span id="l27.405" class="difflineminus">-  instag: {</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineminus">-    OTRL_INSTAG_MASTER: new ctypes.unsigned_int(0),</span>
<a href="#l27.407"></a><span id="l27.407" class="difflineminus">-    OTRL_INSTAG_BEST: new ctypes.unsigned_int(1),</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineminus">-    OTRL_INSTAG_RECENT: new ctypes.unsigned_int(2),</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineminus">-    OTRL_INSTAG_RECENT_RECEIVED: new ctypes.unsigned_int(3),</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineminus">-    OTRL_INSTAG_RECENT_SENT: new ctypes.unsigned_int(4),</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineminus">-    OTRL_MIN_VALID_INSTAG: new ctypes.unsigned_int(0x100),</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineminus">-  },</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineplus">+    // Get a new instance tag for the given account and write to file.  The FILE*</span>
<a href="#l27.414"></a><span id="l27.414" class="difflineplus">+    // must be open for writing.</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineplus">+    otrl_instag_generate: callWithFILEp.bind(</span>
<a href="#l27.416"></a><span id="l27.416" class="difflineplus">+      null,</span>
<a href="#l27.417"></a><span id="l27.417" class="difflineplus">+      &quot;otrl_instag_generate&quot;,</span>
<a href="#l27.418"></a><span id="l27.418" class="difflineplus">+      &quot;wb&quot;,</span>
<a href="#l27.419"></a><span id="l27.419" class="difflineplus">+      1</span>
<a href="#l27.420"></a><span id="l27.420" class="difflineplus">+    ),</span>
<a href="#l27.421"></a><span id="l27.421" class="difflineplus">+    otrl_instag_generate_FILEp: libotr.declare(</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineplus">+      &quot;otrl_instag_generate_FILEp&quot;,</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineplus">+      abi,</span>
<a href="#l27.424"></a><span id="l27.424" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.425"></a><span id="l27.425" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.426"></a><span id="l27.426" class="difflineplus">+      FILE.ptr,</span>
<a href="#l27.427"></a><span id="l27.427" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.428"></a><span id="l27.428" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l27.429"></a><span id="l27.429" class="difflineplus">+    ),</span>
<a href="#l27.430"></a><span id="l27.430"> </span>
<a href="#l27.431"></a><span id="l27.431" class="difflineminus">-  // Get a new instance tag for the given account and write to file.  The FILE*</span>
<a href="#l27.432"></a><span id="l27.432" class="difflineminus">-  // must be open for writing.</span>
<a href="#l27.433"></a><span id="l27.433" class="difflineminus">-  otrl_instag_generate: callWithFILEp.bind(null, &quot;otrl_instag_generate&quot;, &quot;wb&quot;, 1),</span>
<a href="#l27.434"></a><span id="l27.434" class="difflineminus">-  otrl_instag_generate_FILEp: libotr.declare(</span>
<a href="#l27.435"></a><span id="l27.435" class="difflineminus">-    &quot;otrl_instag_generate_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.436"></a><span id="l27.436" class="difflineminus">-    OtrlUserState, FILE.ptr, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l27.437"></a><span id="l27.437" class="difflineminus">-  ),</span>
<a href="#l27.438"></a><span id="l27.438" class="difflineplus">+    // Read our instance tag from a file on disk into the given OtrlUserState.</span>
<a href="#l27.439"></a><span id="l27.439" class="difflineplus">+    // The FILE* must be open for reading.</span>
<a href="#l27.440"></a><span id="l27.440" class="difflineplus">+    otrl_instag_read: callWithFILEp.bind(null, &quot;otrl_instag_read&quot;, &quot;rb&quot;, 1),</span>
<a href="#l27.441"></a><span id="l27.441" class="difflineplus">+    otrl_instag_read_FILEp: libotr.declare(</span>
<a href="#l27.442"></a><span id="l27.442" class="difflineplus">+      &quot;otrl_instag_read_FILEp&quot;,</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineplus">+      abi,</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.445"></a><span id="l27.445" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.446"></a><span id="l27.446" class="difflineplus">+      FILE.ptr</span>
<a href="#l27.447"></a><span id="l27.447" class="difflineplus">+    ),</span>
<a href="#l27.448"></a><span id="l27.448"> </span>
<a href="#l27.449"></a><span id="l27.449" class="difflineminus">-  // Read our instance tag from a file on disk into the given OtrlUserState.</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineminus">-  // The FILE* must be open for reading.</span>
<a href="#l27.451"></a><span id="l27.451" class="difflineminus">-  otrl_instag_read: callWithFILEp.bind(null, &quot;otrl_instag_read&quot;, &quot;rb&quot;, 1),</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineminus">-  otrl_instag_read_FILEp: libotr.declare(</span>
<a href="#l27.453"></a><span id="l27.453" class="difflineminus">-    &quot;otrl_instag_read_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.454"></a><span id="l27.454" class="difflineminus">-    OtrlUserState, FILE.ptr</span>
<a href="#l27.455"></a><span id="l27.455" class="difflineminus">-  ),</span>
<a href="#l27.456"></a><span id="l27.456" class="difflineplus">+    // Write our instance tags to a file on disk.  The FILE* must be open for</span>
<a href="#l27.457"></a><span id="l27.457" class="difflineplus">+    // writing.</span>
<a href="#l27.458"></a><span id="l27.458" class="difflineplus">+    otrl_instag_write: callWithFILEp.bind(null, &quot;otrl_instag_write&quot;, &quot;wb&quot;, 1),</span>
<a href="#l27.459"></a><span id="l27.459" class="difflineplus">+    otrl_instag_write_FILEp: libotr.declare(</span>
<a href="#l27.460"></a><span id="l27.460" class="difflineplus">+      &quot;otrl_instag_write_FILEp&quot;,</span>
<a href="#l27.461"></a><span id="l27.461" class="difflineplus">+      abi,</span>
<a href="#l27.462"></a><span id="l27.462" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.463"></a><span id="l27.463" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.464"></a><span id="l27.464" class="difflineplus">+      FILE.ptr</span>
<a href="#l27.465"></a><span id="l27.465" class="difflineplus">+    ),</span>
<a href="#l27.466"></a><span id="l27.466"> </span>
<a href="#l27.467"></a><span id="l27.467" class="difflineminus">-  // Write our instance tags to a file on disk.  The FILE* must be open for</span>
<a href="#l27.468"></a><span id="l27.468" class="difflineminus">-  // writing.</span>
<a href="#l27.469"></a><span id="l27.469" class="difflineminus">-  otrl_instag_write: callWithFILEp.bind(null, &quot;otrl_instag_write&quot;, &quot;wb&quot;, 1),</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineminus">-  otrl_instag_write_FILEp: libotr.declare(</span>
<a href="#l27.471"></a><span id="l27.471" class="difflineminus">-    &quot;otrl_instag_write_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.472"></a><span id="l27.472" class="difflineminus">-    OtrlUserState, FILE.ptr</span>
<a href="#l27.473"></a><span id="l27.473" class="difflineminus">-  ),</span>
<a href="#l27.474"></a><span id="l27.474" class="difflineminus">-</span>
<a href="#l27.475"></a><span id="l27.475" class="difflineminus">-  // auth.h</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineplus">+    // auth.h</span>
<a href="#l27.477"></a><span id="l27.477"> </span>
<a href="#l27.478"></a><span id="l27.478" class="difflineminus">-  authState: {</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineminus">-    OTRL_AUTHSTATE_NONE: 0,</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineminus">-    OTRL_AUTHSTATE_AWAITING_DHKEY: 1,</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-    OTRL_AUTHSTATE_AWAITING_REVEALSIG: 2,</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineminus">-    OTRL_AUTHSTATE_AWAITING_SIG: 3,</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineminus">-    OTRL_AUTHSTATE_V1_SETUP: 4,</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineminus">-  },</span>
<a href="#l27.485"></a><span id="l27.485" class="difflineplus">+    authState: {</span>
<a href="#l27.486"></a><span id="l27.486" class="difflineplus">+      OTRL_AUTHSTATE_NONE: 0,</span>
<a href="#l27.487"></a><span id="l27.487" class="difflineplus">+      OTRL_AUTHSTATE_AWAITING_DHKEY: 1,</span>
<a href="#l27.488"></a><span id="l27.488" class="difflineplus">+      OTRL_AUTHSTATE_AWAITING_REVEALSIG: 2,</span>
<a href="#l27.489"></a><span id="l27.489" class="difflineplus">+      OTRL_AUTHSTATE_AWAITING_SIG: 3,</span>
<a href="#l27.490"></a><span id="l27.490" class="difflineplus">+      OTRL_AUTHSTATE_V1_SETUP: 4,</span>
<a href="#l27.491"></a><span id="l27.491" class="difflineplus">+    },</span>
<a href="#l27.492"></a><span id="l27.492"> </span>
<a href="#l27.493"></a><span id="l27.493" class="difflineminus">-  // b64.h</span>
<a href="#l27.494"></a><span id="l27.494" class="difflineplus">+    // b64.h</span>
<a href="#l27.495"></a><span id="l27.495"> </span>
<a href="#l27.496"></a><span id="l27.496" class="difflineminus">-  // base64 encode data.  Insert no linebreaks or whitespace.</span>
<a href="#l27.497"></a><span id="l27.497" class="difflineminus">-  // The buffer base64data must contain at least ((datalen+2)/3)*4 bytes of</span>
<a href="#l27.498"></a><span id="l27.498" class="difflineminus">-  // space. This function will return the number of bytes actually used.</span>
<a href="#l27.499"></a><span id="l27.499" class="difflineminus">-  otrl_base64_encode: libotr.declare(</span>
<a href="#l27.500"></a><span id="l27.500" class="difflineminus">-    &quot;otrl_base64_encode&quot;, abi, ctypes.size_t,</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineminus">-    ctypes.char.ptr, ctypes.unsigned_char.ptr, ctypes.size_t</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineminus">-  ),</span>
<a href="#l27.503"></a><span id="l27.503" class="difflineplus">+    // base64 encode data.  Insert no linebreaks or whitespace.</span>
<a href="#l27.504"></a><span id="l27.504" class="difflineplus">+    // The buffer base64data must contain at least ((datalen+2)/3)*4 bytes of</span>
<a href="#l27.505"></a><span id="l27.505" class="difflineplus">+    // space. This function will return the number of bytes actually used.</span>
<a href="#l27.506"></a><span id="l27.506" class="difflineplus">+    otrl_base64_encode: libotr.declare(</span>
<a href="#l27.507"></a><span id="l27.507" class="difflineplus">+      &quot;otrl_base64_encode&quot;,</span>
<a href="#l27.508"></a><span id="l27.508" class="difflineplus">+      abi,</span>
<a href="#l27.509"></a><span id="l27.509" class="difflineplus">+      ctypes.size_t,</span>
<a href="#l27.510"></a><span id="l27.510" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.511"></a><span id="l27.511" class="difflineplus">+      ctypes.unsigned_char.ptr,</span>
<a href="#l27.512"></a><span id="l27.512" class="difflineplus">+      ctypes.size_t</span>
<a href="#l27.513"></a><span id="l27.513" class="difflineplus">+    ),</span>
<a href="#l27.514"></a><span id="l27.514"> </span>
<a href="#l27.515"></a><span id="l27.515" class="difflineminus">-  // base64 decode data.  Skip non-base64 chars, and terminate at the</span>
<a href="#l27.516"></a><span id="l27.516" class="difflineminus">-  // first '=', or the end of the buffer.</span>
<a href="#l27.517"></a><span id="l27.517" class="difflineminus">-  // The buffer data must contain at least ((base64len+3) / 4) * 3 bytes</span>
<a href="#l27.518"></a><span id="l27.518" class="difflineminus">-  // of space. This function will return the number of bytes actually</span>
<a href="#l27.519"></a><span id="l27.519" class="difflineminus">-  // used.</span>
<a href="#l27.520"></a><span id="l27.520" class="difflineminus">-  otrl_base64_decode: libotr.declare(</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineminus">-    &quot;otrl_base64_decode&quot;, abi, ctypes.size_t,</span>
<a href="#l27.522"></a><span id="l27.522" class="difflineminus">-    ctypes.unsigned_char.ptr, ctypes.char.ptr, ctypes.size_t</span>
<a href="#l27.523"></a><span id="l27.523" class="difflineminus">-  ),</span>
<a href="#l27.524"></a><span id="l27.524" class="difflineplus">+    // base64 decode data.  Skip non-base64 chars, and terminate at the</span>
<a href="#l27.525"></a><span id="l27.525" class="difflineplus">+    // first '=', or the end of the buffer.</span>
<a href="#l27.526"></a><span id="l27.526" class="difflineplus">+    // The buffer data must contain at least ((base64len+3) / 4) * 3 bytes</span>
<a href="#l27.527"></a><span id="l27.527" class="difflineplus">+    // of space. This function will return the number of bytes actually</span>
<a href="#l27.528"></a><span id="l27.528" class="difflineplus">+    // used.</span>
<a href="#l27.529"></a><span id="l27.529" class="difflineplus">+    otrl_base64_decode: libotr.declare(</span>
<a href="#l27.530"></a><span id="l27.530" class="difflineplus">+      &quot;otrl_base64_decode&quot;,</span>
<a href="#l27.531"></a><span id="l27.531" class="difflineplus">+      abi,</span>
<a href="#l27.532"></a><span id="l27.532" class="difflineplus">+      ctypes.size_t,</span>
<a href="#l27.533"></a><span id="l27.533" class="difflineplus">+      ctypes.unsigned_char.ptr,</span>
<a href="#l27.534"></a><span id="l27.534" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.535"></a><span id="l27.535" class="difflineplus">+      ctypes.size_t</span>
<a href="#l27.536"></a><span id="l27.536" class="difflineplus">+    ),</span>
<a href="#l27.537"></a><span id="l27.537"> </span>
<a href="#l27.538"></a><span id="l27.538" class="difflineminus">-  // context.h</span>
<a href="#l27.539"></a><span id="l27.539" class="difflineplus">+    // context.h</span>
<a href="#l27.540"></a><span id="l27.540"> </span>
<a href="#l27.541"></a><span id="l27.541" class="difflineminus">-  otr_offer: {</span>
<a href="#l27.542"></a><span id="l27.542" class="difflineminus">-    OFFER_NOT: 0,</span>
<a href="#l27.543"></a><span id="l27.543" class="difflineminus">-    OFFER_SENT: 1,</span>
<a href="#l27.544"></a><span id="l27.544" class="difflineminus">-    OFFER_REJECTED: 2,</span>
<a href="#l27.545"></a><span id="l27.545" class="difflineminus">-    OFFER_ACCEPTED: 3,</span>
<a href="#l27.546"></a><span id="l27.546" class="difflineminus">-  },</span>
<a href="#l27.547"></a><span id="l27.547" class="difflineplus">+    otr_offer: {</span>
<a href="#l27.548"></a><span id="l27.548" class="difflineplus">+      OFFER_NOT: 0,</span>
<a href="#l27.549"></a><span id="l27.549" class="difflineplus">+      OFFER_SENT: 1,</span>
<a href="#l27.550"></a><span id="l27.550" class="difflineplus">+      OFFER_REJECTED: 2,</span>
<a href="#l27.551"></a><span id="l27.551" class="difflineplus">+      OFFER_ACCEPTED: 3,</span>
<a href="#l27.552"></a><span id="l27.552" class="difflineplus">+    },</span>
<a href="#l27.553"></a><span id="l27.553"> </span>
<a href="#l27.554"></a><span id="l27.554" class="difflineminus">-  messageState: {</span>
<a href="#l27.555"></a><span id="l27.555" class="difflineminus">-    OTRL_MSGSTATE_PLAINTEXT: 0,</span>
<a href="#l27.556"></a><span id="l27.556" class="difflineminus">-    OTRL_MSGSTATE_ENCRYPTED: 1,</span>
<a href="#l27.557"></a><span id="l27.557" class="difflineminus">-    OTRL_MSGSTATE_FINISHED: 2,</span>
<a href="#l27.558"></a><span id="l27.558" class="difflineminus">-  },</span>
<a href="#l27.559"></a><span id="l27.559" class="difflineplus">+    messageState: {</span>
<a href="#l27.560"></a><span id="l27.560" class="difflineplus">+      OTRL_MSGSTATE_PLAINTEXT: 0,</span>
<a href="#l27.561"></a><span id="l27.561" class="difflineplus">+      OTRL_MSGSTATE_ENCRYPTED: 1,</span>
<a href="#l27.562"></a><span id="l27.562" class="difflineplus">+      OTRL_MSGSTATE_FINISHED: 2,</span>
<a href="#l27.563"></a><span id="l27.563" class="difflineplus">+    },</span>
<a href="#l27.564"></a><span id="l27.564"> </span>
<a href="#l27.565"></a><span id="l27.565" class="difflineminus">-  // Look up a connection context by name/account/protocol/instance from the</span>
<a href="#l27.566"></a><span id="l27.566" class="difflineminus">-  // given OtrlUserState.</span>
<a href="#l27.567"></a><span id="l27.567" class="difflineminus">-  otrl_context_find: libotr.declare(</span>
<a href="#l27.568"></a><span id="l27.568" class="difflineminus">-    &quot;otrl_context_find&quot;, abi, ConnContext.ptr,</span>
<a href="#l27.569"></a><span id="l27.569" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.570"></a><span id="l27.570" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.571"></a><span id="l27.571" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.572"></a><span id="l27.572" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.573"></a><span id="l27.573" class="difflineminus">-    otrl_instag_t,</span>
<a href="#l27.574"></a><span id="l27.574" class="difflineminus">-    ctypes.int,</span>
<a href="#l27.575"></a><span id="l27.575" class="difflineminus">-    ctypes.int.ptr,</span>
<a href="#l27.576"></a><span id="l27.576" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.577"></a><span id="l27.577" class="difflineminus">-    ctypes.void_t.ptr</span>
<a href="#l27.578"></a><span id="l27.578" class="difflineminus">-  ),</span>
<a href="#l27.579"></a><span id="l27.579" class="difflineplus">+    // Look up a connection context by name/account/protocol/instance from the</span>
<a href="#l27.580"></a><span id="l27.580" class="difflineplus">+    // given OtrlUserState.</span>
<a href="#l27.581"></a><span id="l27.581" class="difflineplus">+    otrl_context_find: libotr.declare(</span>
<a href="#l27.582"></a><span id="l27.582" class="difflineplus">+      &quot;otrl_context_find&quot;,</span>
<a href="#l27.583"></a><span id="l27.583" class="difflineplus">+      abi,</span>
<a href="#l27.584"></a><span id="l27.584" class="difflineplus">+      ConnContext.ptr,</span>
<a href="#l27.585"></a><span id="l27.585" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.586"></a><span id="l27.586" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.587"></a><span id="l27.587" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.588"></a><span id="l27.588" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.589"></a><span id="l27.589" class="difflineplus">+      otrl_instag_t,</span>
<a href="#l27.590"></a><span id="l27.590" class="difflineplus">+      ctypes.int,</span>
<a href="#l27.591"></a><span id="l27.591" class="difflineplus">+      ctypes.int.ptr,</span>
<a href="#l27.592"></a><span id="l27.592" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.593"></a><span id="l27.593" class="difflineplus">+      ctypes.void_t.ptr</span>
<a href="#l27.594"></a><span id="l27.594" class="difflineplus">+    ),</span>
<a href="#l27.595"></a><span id="l27.595"> </span>
<a href="#l27.596"></a><span id="l27.596" class="difflineminus">-  // Set the trust level for a given fingerprint.</span>
<a href="#l27.597"></a><span id="l27.597" class="difflineminus">-  otrl_context_set_trust: libotr.declare(</span>
<a href="#l27.598"></a><span id="l27.598" class="difflineminus">-    &quot;otrl_context_set_trust&quot;, abi, ctypes.void_t,</span>
<a href="#l27.599"></a><span id="l27.599" class="difflineminus">-    Fingerprint.ptr, ctypes.char.ptr</span>
<a href="#l27.600"></a><span id="l27.600" class="difflineminus">-  ),</span>
<a href="#l27.601"></a><span id="l27.601" class="difflineplus">+    // Set the trust level for a given fingerprint.</span>
<a href="#l27.602"></a><span id="l27.602" class="difflineplus">+    otrl_context_set_trust: libotr.declare(</span>
<a href="#l27.603"></a><span id="l27.603" class="difflineplus">+      &quot;otrl_context_set_trust&quot;,</span>
<a href="#l27.604"></a><span id="l27.604" class="difflineplus">+      abi,</span>
<a href="#l27.605"></a><span id="l27.605" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.606"></a><span id="l27.606" class="difflineplus">+      Fingerprint.ptr,</span>
<a href="#l27.607"></a><span id="l27.607" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l27.608"></a><span id="l27.608" class="difflineplus">+    ),</span>
<a href="#l27.609"></a><span id="l27.609"> </span>
<a href="#l27.610"></a><span id="l27.610" class="difflineminus">-  // Find a fingerprint in a given context, perhaps adding it if not present.</span>
<a href="#l27.611"></a><span id="l27.611" class="difflineminus">-  otrl_context_find_fingerprint: libotr.declare(</span>
<a href="#l27.612"></a><span id="l27.612" class="difflineminus">-    &quot;otrl_context_find_fingerprint&quot;, abi, Fingerprint.ptr,</span>
<a href="#l27.613"></a><span id="l27.613" class="difflineminus">-    ConnContext.ptr, hash_t, ctypes.int, ctypes.int.ptr</span>
<a href="#l27.614"></a><span id="l27.614" class="difflineminus">-  ),</span>
<a href="#l27.615"></a><span id="l27.615" class="difflineplus">+    // Find a fingerprint in a given context, perhaps adding it if not present.</span>
<a href="#l27.616"></a><span id="l27.616" class="difflineplus">+    otrl_context_find_fingerprint: libotr.declare(</span>
<a href="#l27.617"></a><span id="l27.617" class="difflineplus">+      &quot;otrl_context_find_fingerprint&quot;,</span>
<a href="#l27.618"></a><span id="l27.618" class="difflineplus">+      abi,</span>
<a href="#l27.619"></a><span id="l27.619" class="difflineplus">+      Fingerprint.ptr,</span>
<a href="#l27.620"></a><span id="l27.620" class="difflineplus">+      ConnContext.ptr,</span>
<a href="#l27.621"></a><span id="l27.621" class="difflineplus">+      hash_t,</span>
<a href="#l27.622"></a><span id="l27.622" class="difflineplus">+      ctypes.int,</span>
<a href="#l27.623"></a><span id="l27.623" class="difflineplus">+      ctypes.int.ptr</span>
<a href="#l27.624"></a><span id="l27.624" class="difflineplus">+    ),</span>
<a href="#l27.625"></a><span id="l27.625"> </span>
<a href="#l27.626"></a><span id="l27.626" class="difflineminus">-  // Forget a fingerprint (and maybe the whole context).</span>
<a href="#l27.627"></a><span id="l27.627" class="difflineminus">-  otrl_context_forget_fingerprint: libotr.declare(</span>
<a href="#l27.628"></a><span id="l27.628" class="difflineminus">-    &quot;otrl_context_forget_fingerprint&quot;, abi, ctypes.void_t,</span>
<a href="#l27.629"></a><span id="l27.629" class="difflineminus">-    Fingerprint.ptr, ctypes.int</span>
<a href="#l27.630"></a><span id="l27.630" class="difflineminus">-  ),</span>
<a href="#l27.631"></a><span id="l27.631" class="difflineplus">+    // Forget a fingerprint (and maybe the whole context).</span>
<a href="#l27.632"></a><span id="l27.632" class="difflineplus">+    otrl_context_forget_fingerprint: libotr.declare(</span>
<a href="#l27.633"></a><span id="l27.633" class="difflineplus">+      &quot;otrl_context_forget_fingerprint&quot;,</span>
<a href="#l27.634"></a><span id="l27.634" class="difflineplus">+      abi,</span>
<a href="#l27.635"></a><span id="l27.635" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.636"></a><span id="l27.636" class="difflineplus">+      Fingerprint.ptr,</span>
<a href="#l27.637"></a><span id="l27.637" class="difflineplus">+      ctypes.int</span>
<a href="#l27.638"></a><span id="l27.638" class="difflineplus">+    ),</span>
<a href="#l27.639"></a><span id="l27.639"> </span>
<a href="#l27.640"></a><span id="l27.640" class="difflineminus">-  // Return true iff the given fingerprint is marked as trusted.</span>
<a href="#l27.641"></a><span id="l27.641" class="difflineminus">-  otrl_context_is_fingerprint_trusted: libotr.declare(</span>
<a href="#l27.642"></a><span id="l27.642" class="difflineminus">-    &quot;otrl_context_is_fingerprint_trusted&quot;, abi, ctypes.int,</span>
<a href="#l27.643"></a><span id="l27.643" class="difflineminus">-    Fingerprint.ptr</span>
<a href="#l27.644"></a><span id="l27.644" class="difflineminus">-  ),</span>
<a href="#l27.645"></a><span id="l27.645" class="difflineplus">+    // Return true iff the given fingerprint is marked as trusted.</span>
<a href="#l27.646"></a><span id="l27.646" class="difflineplus">+    otrl_context_is_fingerprint_trusted: libotr.declare(</span>
<a href="#l27.647"></a><span id="l27.647" class="difflineplus">+      &quot;otrl_context_is_fingerprint_trusted&quot;,</span>
<a href="#l27.648"></a><span id="l27.648" class="difflineplus">+      abi,</span>
<a href="#l27.649"></a><span id="l27.649" class="difflineplus">+      ctypes.int,</span>
<a href="#l27.650"></a><span id="l27.650" class="difflineplus">+      Fingerprint.ptr</span>
<a href="#l27.651"></a><span id="l27.651" class="difflineplus">+    ),</span>
<a href="#l27.652"></a><span id="l27.652"> </span>
<a href="#l27.653"></a><span id="l27.653" class="difflineminus">-  // dh.h</span>
<a href="#l27.654"></a><span id="l27.654" class="difflineplus">+    // dh.h</span>
<a href="#l27.655"></a><span id="l27.655"> </span>
<a href="#l27.656"></a><span id="l27.656" class="difflineminus">-  sessionIdHalf: {</span>
<a href="#l27.657"></a><span id="l27.657" class="difflineminus">-    OTRL_SESSIONID_FIRST_HALF_BOLD: 0,</span>
<a href="#l27.658"></a><span id="l27.658" class="difflineminus">-    OTRL_SESSIONID_SECOND_HALF_BOLD: 1,</span>
<a href="#l27.659"></a><span id="l27.659" class="difflineminus">-  },</span>
<a href="#l27.660"></a><span id="l27.660" class="difflineplus">+    sessionIdHalf: {</span>
<a href="#l27.661"></a><span id="l27.661" class="difflineplus">+      OTRL_SESSIONID_FIRST_HALF_BOLD: 0,</span>
<a href="#l27.662"></a><span id="l27.662" class="difflineplus">+      OTRL_SESSIONID_SECOND_HALF_BOLD: 1,</span>
<a href="#l27.663"></a><span id="l27.663" class="difflineplus">+    },</span>
<a href="#l27.664"></a><span id="l27.664"> </span>
<a href="#l27.665"></a><span id="l27.665" class="difflineminus">-  // sm.h</span>
<a href="#l27.666"></a><span id="l27.666" class="difflineplus">+    // sm.h</span>
<a href="#l27.667"></a><span id="l27.667"> </span>
<a href="#l27.668"></a><span id="l27.668" class="difflineminus">-  nextExpectedSMP: {</span>
<a href="#l27.669"></a><span id="l27.669" class="difflineminus">-    OTRL_SMP_EXPECT1: 0,</span>
<a href="#l27.670"></a><span id="l27.670" class="difflineminus">-    OTRL_SMP_EXPECT2: 1,</span>
<a href="#l27.671"></a><span id="l27.671" class="difflineminus">-    OTRL_SMP_EXPECT3: 2,</span>
<a href="#l27.672"></a><span id="l27.672" class="difflineminus">-    OTRL_SMP_EXPECT4: 3,</span>
<a href="#l27.673"></a><span id="l27.673" class="difflineminus">-    OTRL_SMP_EXPECT5: 4,</span>
<a href="#l27.674"></a><span id="l27.674" class="difflineminus">-  },</span>
<a href="#l27.675"></a><span id="l27.675" class="difflineminus">-</span>
<a href="#l27.676"></a><span id="l27.676" class="difflineminus">-  smProgState: {</span>
<a href="#l27.677"></a><span id="l27.677" class="difflineminus">-    OTRL_SMP_PROG_OK: 0,</span>
<a href="#l27.678"></a><span id="l27.678" class="difflineminus">-    OTRL_SMP_PROG_CHEATED: -2,</span>
<a href="#l27.679"></a><span id="l27.679" class="difflineminus">-    OTRL_SMP_PROG_FAILED: -1,</span>
<a href="#l27.680"></a><span id="l27.680" class="difflineminus">-    OTRL_SMP_PROG_SUCCEEDED: 1,</span>
<a href="#l27.681"></a><span id="l27.681" class="difflineminus">-  },</span>
<a href="#l27.682"></a><span id="l27.682" class="difflineplus">+    nextExpectedSMP: {</span>
<a href="#l27.683"></a><span id="l27.683" class="difflineplus">+      OTRL_SMP_EXPECT1: 0,</span>
<a href="#l27.684"></a><span id="l27.684" class="difflineplus">+      OTRL_SMP_EXPECT2: 1,</span>
<a href="#l27.685"></a><span id="l27.685" class="difflineplus">+      OTRL_SMP_EXPECT3: 2,</span>
<a href="#l27.686"></a><span id="l27.686" class="difflineplus">+      OTRL_SMP_EXPECT4: 3,</span>
<a href="#l27.687"></a><span id="l27.687" class="difflineplus">+      OTRL_SMP_EXPECT5: 4,</span>
<a href="#l27.688"></a><span id="l27.688" class="difflineplus">+    },</span>
<a href="#l27.689"></a><span id="l27.689"> </span>
<a href="#l27.690"></a><span id="l27.690" class="difflineminus">-  // userstate.h</span>
<a href="#l27.691"></a><span id="l27.691" class="difflineplus">+    smProgState: {</span>
<a href="#l27.692"></a><span id="l27.692" class="difflineplus">+      OTRL_SMP_PROG_OK: 0,</span>
<a href="#l27.693"></a><span id="l27.693" class="difflineplus">+      OTRL_SMP_PROG_CHEATED: -2,</span>
<a href="#l27.694"></a><span id="l27.694" class="difflineplus">+      OTRL_SMP_PROG_FAILED: -1,</span>
<a href="#l27.695"></a><span id="l27.695" class="difflineplus">+      OTRL_SMP_PROG_SUCCEEDED: 1,</span>
<a href="#l27.696"></a><span id="l27.696" class="difflineplus">+    },</span>
<a href="#l27.697"></a><span id="l27.697"> </span>
<a href="#l27.698"></a><span id="l27.698" class="difflineminus">-  // Create a new OtrlUserState.</span>
<a href="#l27.699"></a><span id="l27.699" class="difflineminus">-  otrl_userstate_create: libotr.declare(</span>
<a href="#l27.700"></a><span id="l27.700" class="difflineminus">-    &quot;otrl_userstate_create&quot;, abi, OtrlUserState</span>
<a href="#l27.701"></a><span id="l27.701" class="difflineminus">-  ),</span>
<a href="#l27.702"></a><span id="l27.702" class="difflineminus">-</span>
<a href="#l27.703"></a><span id="l27.703" class="difflineminus">-  // privkey.h</span>
<a href="#l27.704"></a><span id="l27.704" class="difflineplus">+    // userstate.h</span>
<a href="#l27.705"></a><span id="l27.705"> </span>
<a href="#l27.706"></a><span id="l27.706" class="difflineminus">-  // Generate a private DSA key for a given account, storing it into a file on</span>
<a href="#l27.707"></a><span id="l27.707" class="difflineminus">-  // disk, and loading it into the given OtrlUserState. Overwrite any</span>
<a href="#l27.708"></a><span id="l27.708" class="difflineminus">-  // previously generated keys for that account in that OtrlUserState.</span>
<a href="#l27.709"></a><span id="l27.709" class="difflineminus">-  otrl_privkey_generate: callWithFILEp.bind(null, &quot;otrl_privkey_generate&quot;, &quot;w+b&quot;, 1),</span>
<a href="#l27.710"></a><span id="l27.710" class="difflineminus">-  otrl_privkey_generate_FILEp: libotr.declare(</span>
<a href="#l27.711"></a><span id="l27.711" class="difflineminus">-    &quot;otrl_privkey_generate_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.712"></a><span id="l27.712" class="difflineminus">-    OtrlUserState, FILE.ptr, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l27.713"></a><span id="l27.713" class="difflineminus">-  ),</span>
<a href="#l27.714"></a><span id="l27.714" class="difflineplus">+    // Create a new OtrlUserState.</span>
<a href="#l27.715"></a><span id="l27.715" class="difflineplus">+    otrl_userstate_create: libotr.declare(</span>
<a href="#l27.716"></a><span id="l27.716" class="difflineplus">+      &quot;otrl_userstate_create&quot;,</span>
<a href="#l27.717"></a><span id="l27.717" class="difflineplus">+      abi,</span>
<a href="#l27.718"></a><span id="l27.718" class="difflineplus">+      OtrlUserState</span>
<a href="#l27.719"></a><span id="l27.719" class="difflineplus">+    ),</span>
<a href="#l27.720"></a><span id="l27.720" class="difflineplus">+</span>
<a href="#l27.721"></a><span id="l27.721" class="difflineplus">+    // privkey.h</span>
<a href="#l27.722"></a><span id="l27.722"> </span>
<a href="#l27.723"></a><span id="l27.723" class="difflineminus">-  // Begin a private key generation that will potentially take place in</span>
<a href="#l27.724"></a><span id="l27.724" class="difflineminus">-  // a background thread. This routine must be called from the main</span>
<a href="#l27.725"></a><span id="l27.725" class="difflineminus">-  // thread. It will set *newkeyp, which you can pass to</span>
<a href="#l27.726"></a><span id="l27.726" class="difflineminus">-  // otrl_privkey_generate_calculate in a background thread.  If it</span>
<a href="#l27.727"></a><span id="l27.727" class="difflineminus">-  // returns gcry_error(GPG_ERR_EEXIST), then a privkey creation for</span>
<a href="#l27.728"></a><span id="l27.728" class="difflineminus">-  // this accountname/protocol is already in progress, and *newkeyp will</span>
<a href="#l27.729"></a><span id="l27.729" class="difflineminus">-  // be set to NULL.</span>
<a href="#l27.730"></a><span id="l27.730" class="difflineminus">-  otrl_privkey_generate_start: libotr.declare(</span>
<a href="#l27.731"></a><span id="l27.731" class="difflineminus">-    &quot;otrl_privkey_generate_start&quot;, abi, gcry_error_t,</span>
<a href="#l27.732"></a><span id="l27.732" class="difflineminus">-    OtrlUserState, ctypes.char.ptr, ctypes.char.ptr, ctypes.void_t.ptr.ptr</span>
<a href="#l27.733"></a><span id="l27.733" class="difflineminus">-  ),</span>
<a href="#l27.734"></a><span id="l27.734" class="difflineplus">+    // Generate a private DSA key for a given account, storing it into a file on</span>
<a href="#l27.735"></a><span id="l27.735" class="difflineplus">+    // disk, and loading it into the given OtrlUserState. Overwrite any</span>
<a href="#l27.736"></a><span id="l27.736" class="difflineplus">+    // previously generated keys for that account in that OtrlUserState.</span>
<a href="#l27.737"></a><span id="l27.737" class="difflineplus">+    otrl_privkey_generate: callWithFILEp.bind(</span>
<a href="#l27.738"></a><span id="l27.738" class="difflineplus">+      null,</span>
<a href="#l27.739"></a><span id="l27.739" class="difflineplus">+      &quot;otrl_privkey_generate&quot;,</span>
<a href="#l27.740"></a><span id="l27.740" class="difflineplus">+      &quot;w+b&quot;,</span>
<a href="#l27.741"></a><span id="l27.741" class="difflineplus">+      1</span>
<a href="#l27.742"></a><span id="l27.742" class="difflineplus">+    ),</span>
<a href="#l27.743"></a><span id="l27.743" class="difflineplus">+    otrl_privkey_generate_FILEp: libotr.declare(</span>
<a href="#l27.744"></a><span id="l27.744" class="difflineplus">+      &quot;otrl_privkey_generate_FILEp&quot;,</span>
<a href="#l27.745"></a><span id="l27.745" class="difflineplus">+      abi,</span>
<a href="#l27.746"></a><span id="l27.746" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.747"></a><span id="l27.747" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.748"></a><span id="l27.748" class="difflineplus">+      FILE.ptr,</span>
<a href="#l27.749"></a><span id="l27.749" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.750"></a><span id="l27.750" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l27.751"></a><span id="l27.751" class="difflineplus">+    ),</span>
<a href="#l27.752"></a><span id="l27.752"> </span>
<a href="#l27.753"></a><span id="l27.753" class="difflineminus">-  // Do the private key generation calculation. You may call this from a</span>
<a href="#l27.754"></a><span id="l27.754" class="difflineminus">-  // background thread.  When it completes, call</span>
<a href="#l27.755"></a><span id="l27.755" class="difflineminus">-  // otrl_privkey_generate_finish from the _main_ thread.</span>
<a href="#l27.756"></a><span id="l27.756" class="difflineminus">-  otrl_privkey_generate_calculate: libotr.declare(</span>
<a href="#l27.757"></a><span id="l27.757" class="difflineminus">-    &quot;otrl_privkey_generate_calculate&quot;, abi, gcry_error_t,</span>
<a href="#l27.758"></a><span id="l27.758" class="difflineminus">-    ctypes.void_t.ptr</span>
<a href="#l27.759"></a><span id="l27.759" class="difflineminus">-  ),</span>
<a href="#l27.760"></a><span id="l27.760" class="difflineplus">+    // Begin a private key generation that will potentially take place in</span>
<a href="#l27.761"></a><span id="l27.761" class="difflineplus">+    // a background thread. This routine must be called from the main</span>
<a href="#l27.762"></a><span id="l27.762" class="difflineplus">+    // thread. It will set *newkeyp, which you can pass to</span>
<a href="#l27.763"></a><span id="l27.763" class="difflineplus">+    // otrl_privkey_generate_calculate in a background thread.  If it</span>
<a href="#l27.764"></a><span id="l27.764" class="difflineplus">+    // returns gcry_error(GPG_ERR_EEXIST), then a privkey creation for</span>
<a href="#l27.765"></a><span id="l27.765" class="difflineplus">+    // this accountname/protocol is already in progress, and *newkeyp will</span>
<a href="#l27.766"></a><span id="l27.766" class="difflineplus">+    // be set to NULL.</span>
<a href="#l27.767"></a><span id="l27.767" class="difflineplus">+    otrl_privkey_generate_start: libotr.declare(</span>
<a href="#l27.768"></a><span id="l27.768" class="difflineplus">+      &quot;otrl_privkey_generate_start&quot;,</span>
<a href="#l27.769"></a><span id="l27.769" class="difflineplus">+      abi,</span>
<a href="#l27.770"></a><span id="l27.770" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.771"></a><span id="l27.771" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.772"></a><span id="l27.772" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.773"></a><span id="l27.773" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.774"></a><span id="l27.774" class="difflineplus">+      ctypes.void_t.ptr.ptr</span>
<a href="#l27.775"></a><span id="l27.775" class="difflineplus">+    ),</span>
<a href="#l27.776"></a><span id="l27.776"> </span>
<a href="#l27.777"></a><span id="l27.777" class="difflineminus">-  // Call this from the main thread only. It will write the newly created</span>
<a href="#l27.778"></a><span id="l27.778" class="difflineminus">-  // private key into the given file and store it in the OtrlUserState.</span>
<a href="#l27.779"></a><span id="l27.779" class="difflineminus">-  otrl_privkey_generate_finish: callWithFILEp.bind(null, &quot;otrl_privkey_generate_finish&quot;, &quot;w+b&quot;, 2),</span>
<a href="#l27.780"></a><span id="l27.780" class="difflineminus">-  otrl_privkey_generate_finish_FILEp: libotr.declare(</span>
<a href="#l27.781"></a><span id="l27.781" class="difflineminus">-    &quot;otrl_privkey_generate_finish_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.782"></a><span id="l27.782" class="difflineminus">-    OtrlUserState, ctypes.void_t.ptr, FILE.ptr</span>
<a href="#l27.783"></a><span id="l27.783" class="difflineminus">-  ),</span>
<a href="#l27.784"></a><span id="l27.784" class="difflineplus">+    // Do the private key generation calculation. You may call this from a</span>
<a href="#l27.785"></a><span id="l27.785" class="difflineplus">+    // background thread.  When it completes, call</span>
<a href="#l27.786"></a><span id="l27.786" class="difflineplus">+    // otrl_privkey_generate_finish from the _main_ thread.</span>
<a href="#l27.787"></a><span id="l27.787" class="difflineplus">+    otrl_privkey_generate_calculate: libotr.declare(</span>
<a href="#l27.788"></a><span id="l27.788" class="difflineplus">+      &quot;otrl_privkey_generate_calculate&quot;,</span>
<a href="#l27.789"></a><span id="l27.789" class="difflineplus">+      abi,</span>
<a href="#l27.790"></a><span id="l27.790" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.791"></a><span id="l27.791" class="difflineplus">+      ctypes.void_t.ptr</span>
<a href="#l27.792"></a><span id="l27.792" class="difflineplus">+    ),</span>
<a href="#l27.793"></a><span id="l27.793"> </span>
<a href="#l27.794"></a><span id="l27.794" class="difflineminus">-  // Call this from the main thread only, in the event that the background</span>
<a href="#l27.795"></a><span id="l27.795" class="difflineminus">-  // thread generating the key is cancelled. The newkey is deallocated,</span>
<a href="#l27.796"></a><span id="l27.796" class="difflineminus">-  // and must not be used further.</span>
<a href="#l27.797"></a><span id="l27.797" class="difflineminus">-  otrl_privkey_generate_cancelled: libotr.declare(</span>
<a href="#l27.798"></a><span id="l27.798" class="difflineminus">-    &quot;otrl_privkey_generate_cancelled&quot;, abi, gcry_error_t,</span>
<a href="#l27.799"></a><span id="l27.799" class="difflineminus">-    OtrlUserState, ctypes.void_t.ptr</span>
<a href="#l27.800"></a><span id="l27.800" class="difflineminus">-  ),</span>
<a href="#l27.801"></a><span id="l27.801" class="difflineplus">+    // Call this from the main thread only. It will write the newly created</span>
<a href="#l27.802"></a><span id="l27.802" class="difflineplus">+    // private key into the given file and store it in the OtrlUserState.</span>
<a href="#l27.803"></a><span id="l27.803" class="difflineplus">+    otrl_privkey_generate_finish: callWithFILEp.bind(</span>
<a href="#l27.804"></a><span id="l27.804" class="difflineplus">+      null,</span>
<a href="#l27.805"></a><span id="l27.805" class="difflineplus">+      &quot;otrl_privkey_generate_finish&quot;,</span>
<a href="#l27.806"></a><span id="l27.806" class="difflineplus">+      &quot;w+b&quot;,</span>
<a href="#l27.807"></a><span id="l27.807" class="difflineplus">+      2</span>
<a href="#l27.808"></a><span id="l27.808" class="difflineplus">+    ),</span>
<a href="#l27.809"></a><span id="l27.809" class="difflineplus">+    otrl_privkey_generate_finish_FILEp: libotr.declare(</span>
<a href="#l27.810"></a><span id="l27.810" class="difflineplus">+      &quot;otrl_privkey_generate_finish_FILEp&quot;,</span>
<a href="#l27.811"></a><span id="l27.811" class="difflineplus">+      abi,</span>
<a href="#l27.812"></a><span id="l27.812" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.813"></a><span id="l27.813" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.814"></a><span id="l27.814" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.815"></a><span id="l27.815" class="difflineplus">+      FILE.ptr</span>
<a href="#l27.816"></a><span id="l27.816" class="difflineplus">+    ),</span>
<a href="#l27.817"></a><span id="l27.817"> </span>
<a href="#l27.818"></a><span id="l27.818" class="difflineminus">-  // Read a sets of private DSA keys from a file on disk into the given</span>
<a href="#l27.819"></a><span id="l27.819" class="difflineminus">-  // OtrlUserState.</span>
<a href="#l27.820"></a><span id="l27.820" class="difflineminus">-  otrl_privkey_read: callWithFILEp.bind(null, &quot;otrl_privkey_read&quot;, &quot;rb&quot;, 1),</span>
<a href="#l27.821"></a><span id="l27.821" class="difflineminus">-  otrl_privkey_read_FILEp: libotr.declare(</span>
<a href="#l27.822"></a><span id="l27.822" class="difflineminus">-    &quot;otrl_privkey_read_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.823"></a><span id="l27.823" class="difflineminus">-    OtrlUserState, FILE.ptr</span>
<a href="#l27.824"></a><span id="l27.824" class="difflineminus">-  ),</span>
<a href="#l27.825"></a><span id="l27.825" class="difflineplus">+    // Call this from the main thread only, in the event that the background</span>
<a href="#l27.826"></a><span id="l27.826" class="difflineplus">+    // thread generating the key is cancelled. The newkey is deallocated,</span>
<a href="#l27.827"></a><span id="l27.827" class="difflineplus">+    // and must not be used further.</span>
<a href="#l27.828"></a><span id="l27.828" class="difflineplus">+    otrl_privkey_generate_cancelled: libotr.declare(</span>
<a href="#l27.829"></a><span id="l27.829" class="difflineplus">+      &quot;otrl_privkey_generate_cancelled&quot;,</span>
<a href="#l27.830"></a><span id="l27.830" class="difflineplus">+      abi,</span>
<a href="#l27.831"></a><span id="l27.831" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.832"></a><span id="l27.832" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.833"></a><span id="l27.833" class="difflineplus">+      ctypes.void_t.ptr</span>
<a href="#l27.834"></a><span id="l27.834" class="difflineplus">+    ),</span>
<a href="#l27.835"></a><span id="l27.835"> </span>
<a href="#l27.836"></a><span id="l27.836" class="difflineminus">-  // Read the fingerprint store from a file on disk into the given</span>
<a href="#l27.837"></a><span id="l27.837" class="difflineminus">-  // OtrlUserState.</span>
<a href="#l27.838"></a><span id="l27.838" class="difflineminus">-  otrl_privkey_read_fingerprints: callWithFILEp.bind(null, &quot;otrl_privkey_read_fingerprints&quot;, &quot;rb&quot;, 1),</span>
<a href="#l27.839"></a><span id="l27.839" class="difflineminus">-  otrl_privkey_read_fingerprints_FILEp: libotr.declare(</span>
<a href="#l27.840"></a><span id="l27.840" class="difflineminus">-    &quot;otrl_privkey_read_fingerprints_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.841"></a><span id="l27.841" class="difflineminus">-    OtrlUserState, FILE.ptr, ctypes.void_t.ptr, ctypes.void_t.ptr</span>
<a href="#l27.842"></a><span id="l27.842" class="difflineminus">-  ),</span>
<a href="#l27.843"></a><span id="l27.843" class="difflineminus">-</span>
<a href="#l27.844"></a><span id="l27.844" class="difflineminus">-  // Write the fingerprint store from a given OtrlUserState to a file on disk.</span>
<a href="#l27.845"></a><span id="l27.845" class="difflineminus">-  otrl_privkey_write_fingerprints: callWithFILEp.bind(null, &quot;otrl_privkey_write_fingerprints&quot;, &quot;wb&quot;, 1),</span>
<a href="#l27.846"></a><span id="l27.846" class="difflineminus">-  otrl_privkey_write_fingerprints_FILEp: libotr.declare(</span>
<a href="#l27.847"></a><span id="l27.847" class="difflineminus">-    &quot;otrl_privkey_write_fingerprints_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l27.848"></a><span id="l27.848" class="difflineminus">-    OtrlUserState, FILE.ptr</span>
<a href="#l27.849"></a><span id="l27.849" class="difflineminus">-  ),</span>
<a href="#l27.850"></a><span id="l27.850" class="difflineminus">-</span>
<a href="#l27.851"></a><span id="l27.851" class="difflineminus">-  // The length of a string representing a human-readable version of a</span>
<a href="#l27.852"></a><span id="l27.852" class="difflineminus">-  // fingerprint (including the trailing NUL).</span>
<a href="#l27.853"></a><span id="l27.853" class="difflineminus">-  OTRL_PRIVKEY_FPRINT_HUMAN_LEN,</span>
<a href="#l27.854"></a><span id="l27.854" class="difflineplus">+    // Read a sets of private DSA keys from a file on disk into the given</span>
<a href="#l27.855"></a><span id="l27.855" class="difflineplus">+    // OtrlUserState.</span>
<a href="#l27.856"></a><span id="l27.856" class="difflineplus">+    otrl_privkey_read: callWithFILEp.bind(null, &quot;otrl_privkey_read&quot;, &quot;rb&quot;, 1),</span>
<a href="#l27.857"></a><span id="l27.857" class="difflineplus">+    otrl_privkey_read_FILEp: libotr.declare(</span>
<a href="#l27.858"></a><span id="l27.858" class="difflineplus">+      &quot;otrl_privkey_read_FILEp&quot;,</span>
<a href="#l27.859"></a><span id="l27.859" class="difflineplus">+      abi,</span>
<a href="#l27.860"></a><span id="l27.860" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.861"></a><span id="l27.861" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.862"></a><span id="l27.862" class="difflineplus">+      FILE.ptr</span>
<a href="#l27.863"></a><span id="l27.863" class="difflineplus">+    ),</span>
<a href="#l27.864"></a><span id="l27.864"> </span>
<a href="#l27.865"></a><span id="l27.865" class="difflineminus">-  // Human readable fingerprint type</span>
<a href="#l27.866"></a><span id="l27.866" class="difflineminus">-  fingerprint_t,</span>
<a href="#l27.867"></a><span id="l27.867" class="difflineminus">-</span>
<a href="#l27.868"></a><span id="l27.868" class="difflineminus">-  // fingerprint value</span>
<a href="#l27.869"></a><span id="l27.869" class="difflineminus">-  hash_t,</span>
<a href="#l27.870"></a><span id="l27.870" class="difflineminus">-</span>
<a href="#l27.871"></a><span id="l27.871" class="difflineminus">-  // Calculate a human-readable hash of our DSA public key. Return it in the</span>
<a href="#l27.872"></a><span id="l27.872" class="difflineminus">-  // passed fingerprint buffer. Return NULL on error, or a pointer to the given</span>
<a href="#l27.873"></a><span id="l27.873" class="difflineminus">-  // buffer on success.</span>
<a href="#l27.874"></a><span id="l27.874" class="difflineminus">-  otrl_privkey_fingerprint: libotr.declare(</span>
<a href="#l27.875"></a><span id="l27.875" class="difflineminus">-    &quot;otrl_privkey_fingerprint&quot;, abi, ctypes.char.ptr,</span>
<a href="#l27.876"></a><span id="l27.876" class="difflineminus">-    OtrlUserState, fingerprint_t, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l27.877"></a><span id="l27.877" class="difflineminus">-  ),</span>
<a href="#l27.878"></a><span id="l27.878" class="difflineplus">+    // Read the fingerprint store from a file on disk into the given</span>
<a href="#l27.879"></a><span id="l27.879" class="difflineplus">+    // OtrlUserState.</span>
<a href="#l27.880"></a><span id="l27.880" class="difflineplus">+    otrl_privkey_read_fingerprints: callWithFILEp.bind(</span>
<a href="#l27.881"></a><span id="l27.881" class="difflineplus">+      null,</span>
<a href="#l27.882"></a><span id="l27.882" class="difflineplus">+      &quot;otrl_privkey_read_fingerprints&quot;,</span>
<a href="#l27.883"></a><span id="l27.883" class="difflineplus">+      &quot;rb&quot;,</span>
<a href="#l27.884"></a><span id="l27.884" class="difflineplus">+      1</span>
<a href="#l27.885"></a><span id="l27.885" class="difflineplus">+    ),</span>
<a href="#l27.886"></a><span id="l27.886" class="difflineplus">+    otrl_privkey_read_fingerprints_FILEp: libotr.declare(</span>
<a href="#l27.887"></a><span id="l27.887" class="difflineplus">+      &quot;otrl_privkey_read_fingerprints_FILEp&quot;,</span>
<a href="#l27.888"></a><span id="l27.888" class="difflineplus">+      abi,</span>
<a href="#l27.889"></a><span id="l27.889" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.890"></a><span id="l27.890" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.891"></a><span id="l27.891" class="difflineplus">+      FILE.ptr,</span>
<a href="#l27.892"></a><span id="l27.892" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.893"></a><span id="l27.893" class="difflineplus">+      ctypes.void_t.ptr</span>
<a href="#l27.894"></a><span id="l27.894" class="difflineplus">+    ),</span>
<a href="#l27.895"></a><span id="l27.895"> </span>
<a href="#l27.896"></a><span id="l27.896" class="difflineminus">-  // Convert a 20-byte hash value to a 45-byte human-readable value.</span>
<a href="#l27.897"></a><span id="l27.897" class="difflineminus">-  otrl_privkey_hash_to_human: libotr.declare(</span>
<a href="#l27.898"></a><span id="l27.898" class="difflineminus">-    &quot;otrl_privkey_hash_to_human&quot;, abi, ctypes.void_t,</span>
<a href="#l27.899"></a><span id="l27.899" class="difflineminus">-    fingerprint_t, hash_t</span>
<a href="#l27.900"></a><span id="l27.900" class="difflineminus">-  ),</span>
<a href="#l27.901"></a><span id="l27.901" class="difflineplus">+    // Write the fingerprint store from a given OtrlUserState to a file on disk.</span>
<a href="#l27.902"></a><span id="l27.902" class="difflineplus">+    otrl_privkey_write_fingerprints: callWithFILEp.bind(</span>
<a href="#l27.903"></a><span id="l27.903" class="difflineplus">+      null,</span>
<a href="#l27.904"></a><span id="l27.904" class="difflineplus">+      &quot;otrl_privkey_write_fingerprints&quot;,</span>
<a href="#l27.905"></a><span id="l27.905" class="difflineplus">+      &quot;wb&quot;,</span>
<a href="#l27.906"></a><span id="l27.906" class="difflineplus">+      1</span>
<a href="#l27.907"></a><span id="l27.907" class="difflineplus">+    ),</span>
<a href="#l27.908"></a><span id="l27.908" class="difflineplus">+    otrl_privkey_write_fingerprints_FILEp: libotr.declare(</span>
<a href="#l27.909"></a><span id="l27.909" class="difflineplus">+      &quot;otrl_privkey_write_fingerprints_FILEp&quot;,</span>
<a href="#l27.910"></a><span id="l27.910" class="difflineplus">+      abi,</span>
<a href="#l27.911"></a><span id="l27.911" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.912"></a><span id="l27.912" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.913"></a><span id="l27.913" class="difflineplus">+      FILE.ptr</span>
<a href="#l27.914"></a><span id="l27.914" class="difflineplus">+    ),</span>
<a href="#l27.915"></a><span id="l27.915"> </span>
<a href="#l27.916"></a><span id="l27.916" class="difflineminus">-  // Calculate a raw hash of our DSA public key.  Return it in the passed</span>
<a href="#l27.917"></a><span id="l27.917" class="difflineminus">-  // fingerprint buffer.  Return NULL on error, or a pointer to the given</span>
<a href="#l27.918"></a><span id="l27.918" class="difflineminus">-  // buffer on success.</span>
<a href="#l27.919"></a><span id="l27.919" class="difflineminus">-  otrl_privkey_fingerprint_raw: libotr.declare(</span>
<a href="#l27.920"></a><span id="l27.920" class="difflineminus">-    &quot;otrl_privkey_fingerprint_raw&quot;, abi, ctypes.unsigned_char.ptr,</span>
<a href="#l27.921"></a><span id="l27.921" class="difflineminus">-    OtrlUserState, hash_t, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l27.922"></a><span id="l27.922" class="difflineminus">-  ),</span>
<a href="#l27.923"></a><span id="l27.923" class="difflineplus">+    // The length of a string representing a human-readable version of a</span>
<a href="#l27.924"></a><span id="l27.924" class="difflineplus">+    // fingerprint (including the trailing NUL).</span>
<a href="#l27.925"></a><span id="l27.925" class="difflineplus">+    OTRL_PRIVKEY_FPRINT_HUMAN_LEN,</span>
<a href="#l27.926"></a><span id="l27.926" class="difflineplus">+</span>
<a href="#l27.927"></a><span id="l27.927" class="difflineplus">+    // Human readable fingerprint type</span>
<a href="#l27.928"></a><span id="l27.928" class="difflineplus">+    fingerprint_t,</span>
<a href="#l27.929"></a><span id="l27.929" class="difflineplus">+</span>
<a href="#l27.930"></a><span id="l27.930" class="difflineplus">+    // fingerprint value</span>
<a href="#l27.931"></a><span id="l27.931" class="difflineplus">+    hash_t,</span>
<a href="#l27.932"></a><span id="l27.932"> </span>
<a href="#l27.933"></a><span id="l27.933" class="difflineminus">-  // uiOps callbacks</span>
<a href="#l27.934"></a><span id="l27.934" class="difflineminus">-  policy_cb_t,</span>
<a href="#l27.935"></a><span id="l27.935" class="difflineminus">-  create_privkey_cb_t,</span>
<a href="#l27.936"></a><span id="l27.936" class="difflineminus">-  is_logged_in_cb_t,</span>
<a href="#l27.937"></a><span id="l27.937" class="difflineminus">-  inject_message_cb_t,</span>
<a href="#l27.938"></a><span id="l27.938" class="difflineminus">-  update_context_list_cb_t,</span>
<a href="#l27.939"></a><span id="l27.939" class="difflineminus">-  new_fingerprint_cb_t,</span>
<a href="#l27.940"></a><span id="l27.940" class="difflineminus">-  write_fingerprint_cb_t,</span>
<a href="#l27.941"></a><span id="l27.941" class="difflineminus">-  gone_secure_cb_t,</span>
<a href="#l27.942"></a><span id="l27.942" class="difflineminus">-  gone_insecure_cb_t,</span>
<a href="#l27.943"></a><span id="l27.943" class="difflineminus">-  still_secure_cb_t,</span>
<a href="#l27.944"></a><span id="l27.944" class="difflineminus">-  max_message_size_cb_t,</span>
<a href="#l27.945"></a><span id="l27.945" class="difflineminus">-  account_name_cb_t,</span>
<a href="#l27.946"></a><span id="l27.946" class="difflineminus">-  account_name_free_cb_t,</span>
<a href="#l27.947"></a><span id="l27.947" class="difflineminus">-  received_symkey_cb_t,</span>
<a href="#l27.948"></a><span id="l27.948" class="difflineminus">-  otr_error_message_cb_t,</span>
<a href="#l27.949"></a><span id="l27.949" class="difflineminus">-  otr_error_message_free_cb_t,</span>
<a href="#l27.950"></a><span id="l27.950" class="difflineminus">-  resent_msg_prefix_cb_t,</span>
<a href="#l27.951"></a><span id="l27.951" class="difflineminus">-  resent_msg_prefix_free_cb_t,</span>
<a href="#l27.952"></a><span id="l27.952" class="difflineminus">-  handle_smp_event_cb_t,</span>
<a href="#l27.953"></a><span id="l27.953" class="difflineminus">-  handle_msg_event_cb_t,</span>
<a href="#l27.954"></a><span id="l27.954" class="difflineminus">-  create_instag_cb_t,</span>
<a href="#l27.955"></a><span id="l27.955" class="difflineminus">-  convert_msg_cb_t,</span>
<a href="#l27.956"></a><span id="l27.956" class="difflineminus">-  convert_free_cb_t,</span>
<a href="#l27.957"></a><span id="l27.957" class="difflineminus">-  timer_control_cb_t,</span>
<a href="#l27.958"></a><span id="l27.958" class="difflineplus">+    // Calculate a human-readable hash of our DSA public key. Return it in the</span>
<a href="#l27.959"></a><span id="l27.959" class="difflineplus">+    // passed fingerprint buffer. Return NULL on error, or a pointer to the given</span>
<a href="#l27.960"></a><span id="l27.960" class="difflineplus">+    // buffer on success.</span>
<a href="#l27.961"></a><span id="l27.961" class="difflineplus">+    otrl_privkey_fingerprint: libotr.declare(</span>
<a href="#l27.962"></a><span id="l27.962" class="difflineplus">+      &quot;otrl_privkey_fingerprint&quot;,</span>
<a href="#l27.963"></a><span id="l27.963" class="difflineplus">+      abi,</span>
<a href="#l27.964"></a><span id="l27.964" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.965"></a><span id="l27.965" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.966"></a><span id="l27.966" class="difflineplus">+      fingerprint_t,</span>
<a href="#l27.967"></a><span id="l27.967" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.968"></a><span id="l27.968" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l27.969"></a><span id="l27.969" class="difflineplus">+    ),</span>
<a href="#l27.970"></a><span id="l27.970"> </span>
<a href="#l27.971"></a><span id="l27.971" class="difflineminus">-  // message.h</span>
<a href="#l27.972"></a><span id="l27.972" class="difflineplus">+    // Convert a 20-byte hash value to a 45-byte human-readable value.</span>
<a href="#l27.973"></a><span id="l27.973" class="difflineplus">+    otrl_privkey_hash_to_human: libotr.declare(</span>
<a href="#l27.974"></a><span id="l27.974" class="difflineplus">+      &quot;otrl_privkey_hash_to_human&quot;,</span>
<a href="#l27.975"></a><span id="l27.975" class="difflineplus">+      abi,</span>
<a href="#l27.976"></a><span id="l27.976" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.977"></a><span id="l27.977" class="difflineplus">+      fingerprint_t,</span>
<a href="#l27.978"></a><span id="l27.978" class="difflineplus">+      hash_t</span>
<a href="#l27.979"></a><span id="l27.979" class="difflineplus">+    ),</span>
<a href="#l27.980"></a><span id="l27.980"> </span>
<a href="#l27.981"></a><span id="l27.981" class="difflineminus">-  OtrlMessageAppOps,</span>
<a href="#l27.982"></a><span id="l27.982" class="difflineplus">+    // Calculate a raw hash of our DSA public key.  Return it in the passed</span>
<a href="#l27.983"></a><span id="l27.983" class="difflineplus">+    // fingerprint buffer.  Return NULL on error, or a pointer to the given</span>
<a href="#l27.984"></a><span id="l27.984" class="difflineplus">+    // buffer on success.</span>
<a href="#l27.985"></a><span id="l27.985" class="difflineplus">+    otrl_privkey_fingerprint_raw: libotr.declare(</span>
<a href="#l27.986"></a><span id="l27.986" class="difflineplus">+      &quot;otrl_privkey_fingerprint_raw&quot;,</span>
<a href="#l27.987"></a><span id="l27.987" class="difflineplus">+      abi,</span>
<a href="#l27.988"></a><span id="l27.988" class="difflineplus">+      ctypes.unsigned_char.ptr,</span>
<a href="#l27.989"></a><span id="l27.989" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.990"></a><span id="l27.990" class="difflineplus">+      hash_t,</span>
<a href="#l27.991"></a><span id="l27.991" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.992"></a><span id="l27.992" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l27.993"></a><span id="l27.993" class="difflineplus">+    ),</span>
<a href="#l27.994"></a><span id="l27.994"> </span>
<a href="#l27.995"></a><span id="l27.995" class="difflineminus">-  errorCode: {</span>
<a href="#l27.996"></a><span id="l27.996" class="difflineminus">-    OTRL_ERRCODE_NONE: 0,</span>
<a href="#l27.997"></a><span id="l27.997" class="difflineminus">-    OTRL_ERRCODE_ENCRYPTION_ERROR: 1,</span>
<a href="#l27.998"></a><span id="l27.998" class="difflineminus">-    OTRL_ERRCODE_MSG_NOT_IN_PRIVATE: 2,</span>
<a href="#l27.999"></a><span id="l27.999" class="difflineminus">-    OTRL_ERRCODE_MSG_UNREADABLE: 3,</span>
<a href="#l27.1000"></a><span id="l27.1000" class="difflineminus">-    OTRL_ERRCODE_MSG_MALFORMED: 4,</span>
<a href="#l27.1001"></a><span id="l27.1001" class="difflineminus">-  },</span>
<a href="#l27.1002"></a><span id="l27.1002" class="difflineminus">-</span>
<a href="#l27.1003"></a><span id="l27.1003" class="difflineminus">-  smpEvent: {</span>
<a href="#l27.1004"></a><span id="l27.1004" class="difflineminus">-    OTRL_SMPEVENT_NONE: 0,</span>
<a href="#l27.1005"></a><span id="l27.1005" class="difflineminus">-    OTRL_SMPEVENT_ERROR: 1,</span>
<a href="#l27.1006"></a><span id="l27.1006" class="difflineminus">-    OTRL_SMPEVENT_ABORT: 2,</span>
<a href="#l27.1007"></a><span id="l27.1007" class="difflineminus">-    OTRL_SMPEVENT_CHEATED: 3,</span>
<a href="#l27.1008"></a><span id="l27.1008" class="difflineminus">-    OTRL_SMPEVENT_ASK_FOR_ANSWER: 4,</span>
<a href="#l27.1009"></a><span id="l27.1009" class="difflineminus">-    OTRL_SMPEVENT_ASK_FOR_SECRET: 5,</span>
<a href="#l27.1010"></a><span id="l27.1010" class="difflineminus">-    OTRL_SMPEVENT_IN_PROGRESS: 6,</span>
<a href="#l27.1011"></a><span id="l27.1011" class="difflineminus">-    OTRL_SMPEVENT_SUCCESS: 7,</span>
<a href="#l27.1012"></a><span id="l27.1012" class="difflineminus">-    OTRL_SMPEVENT_FAILURE: 8,</span>
<a href="#l27.1013"></a><span id="l27.1013" class="difflineminus">-  },</span>
<a href="#l27.1014"></a><span id="l27.1014" class="difflineplus">+    // uiOps callbacks</span>
<a href="#l27.1015"></a><span id="l27.1015" class="difflineplus">+    policy_cb_t,</span>
<a href="#l27.1016"></a><span id="l27.1016" class="difflineplus">+    create_privkey_cb_t,</span>
<a href="#l27.1017"></a><span id="l27.1017" class="difflineplus">+    is_logged_in_cb_t,</span>
<a href="#l27.1018"></a><span id="l27.1018" class="difflineplus">+    inject_message_cb_t,</span>
<a href="#l27.1019"></a><span id="l27.1019" class="difflineplus">+    update_context_list_cb_t,</span>
<a href="#l27.1020"></a><span id="l27.1020" class="difflineplus">+    new_fingerprint_cb_t,</span>
<a href="#l27.1021"></a><span id="l27.1021" class="difflineplus">+    write_fingerprint_cb_t,</span>
<a href="#l27.1022"></a><span id="l27.1022" class="difflineplus">+    gone_secure_cb_t,</span>
<a href="#l27.1023"></a><span id="l27.1023" class="difflineplus">+    gone_insecure_cb_t,</span>
<a href="#l27.1024"></a><span id="l27.1024" class="difflineplus">+    still_secure_cb_t,</span>
<a href="#l27.1025"></a><span id="l27.1025" class="difflineplus">+    max_message_size_cb_t,</span>
<a href="#l27.1026"></a><span id="l27.1026" class="difflineplus">+    account_name_cb_t,</span>
<a href="#l27.1027"></a><span id="l27.1027" class="difflineplus">+    account_name_free_cb_t,</span>
<a href="#l27.1028"></a><span id="l27.1028" class="difflineplus">+    received_symkey_cb_t,</span>
<a href="#l27.1029"></a><span id="l27.1029" class="difflineplus">+    otr_error_message_cb_t,</span>
<a href="#l27.1030"></a><span id="l27.1030" class="difflineplus">+    otr_error_message_free_cb_t,</span>
<a href="#l27.1031"></a><span id="l27.1031" class="difflineplus">+    resent_msg_prefix_cb_t,</span>
<a href="#l27.1032"></a><span id="l27.1032" class="difflineplus">+    resent_msg_prefix_free_cb_t,</span>
<a href="#l27.1033"></a><span id="l27.1033" class="difflineplus">+    handle_smp_event_cb_t,</span>
<a href="#l27.1034"></a><span id="l27.1034" class="difflineplus">+    handle_msg_event_cb_t,</span>
<a href="#l27.1035"></a><span id="l27.1035" class="difflineplus">+    create_instag_cb_t,</span>
<a href="#l27.1036"></a><span id="l27.1036" class="difflineplus">+    convert_msg_cb_t,</span>
<a href="#l27.1037"></a><span id="l27.1037" class="difflineplus">+    convert_free_cb_t,</span>
<a href="#l27.1038"></a><span id="l27.1038" class="difflineplus">+    timer_control_cb_t,</span>
<a href="#l27.1039"></a><span id="l27.1039"> </span>
<a href="#l27.1040"></a><span id="l27.1040" class="difflineminus">-  messageEvent: {</span>
<a href="#l27.1041"></a><span id="l27.1041" class="difflineminus">-    OTRL_MSGEVENT_NONE: 0,</span>
<a href="#l27.1042"></a><span id="l27.1042" class="difflineminus">-    OTRL_MSGEVENT_ENCRYPTION_REQUIRED: 1,</span>
<a href="#l27.1043"></a><span id="l27.1043" class="difflineminus">-    OTRL_MSGEVENT_ENCRYPTION_ERROR: 2,</span>
<a href="#l27.1044"></a><span id="l27.1044" class="difflineminus">-    OTRL_MSGEVENT_CONNECTION_ENDED: 3,</span>
<a href="#l27.1045"></a><span id="l27.1045" class="difflineminus">-    OTRL_MSGEVENT_SETUP_ERROR: 4,</span>
<a href="#l27.1046"></a><span id="l27.1046" class="difflineminus">-    OTRL_MSGEVENT_MSG_REFLECTED: 5,</span>
<a href="#l27.1047"></a><span id="l27.1047" class="difflineminus">-    OTRL_MSGEVENT_MSG_RESENT: 6,</span>
<a href="#l27.1048"></a><span id="l27.1048" class="difflineminus">-    OTRL_MSGEVENT_RCVDMSG_NOT_IN_PRIVATE: 7,</span>
<a href="#l27.1049"></a><span id="l27.1049" class="difflineminus">-    OTRL_MSGEVENT_RCVDMSG_UNREADABLE: 8,</span>
<a href="#l27.1050"></a><span id="l27.1050" class="difflineminus">-    OTRL_MSGEVENT_RCVDMSG_MALFORMED: 9,</span>
<a href="#l27.1051"></a><span id="l27.1051" class="difflineminus">-    OTRL_MSGEVENT_LOG_HEARTBEAT_RCVD: 10,</span>
<a href="#l27.1052"></a><span id="l27.1052" class="difflineminus">-    OTRL_MSGEVENT_LOG_HEARTBEAT_SENT: 11,</span>
<a href="#l27.1053"></a><span id="l27.1053" class="difflineminus">-    OTRL_MSGEVENT_RCVDMSG_GENERAL_ERR: 12,</span>
<a href="#l27.1054"></a><span id="l27.1054" class="difflineminus">-    OTRL_MSGEVENT_RCVDMSG_UNENCRYPTED: 13,</span>
<a href="#l27.1055"></a><span id="l27.1055" class="difflineminus">-    OTRL_MSGEVENT_RCVDMSG_UNRECOGNIZED: 14,</span>
<a href="#l27.1056"></a><span id="l27.1056" class="difflineminus">-    OTRL_MSGEVENT_RCVDMSG_FOR_OTHER_INSTANCE: 15,</span>
<a href="#l27.1057"></a><span id="l27.1057" class="difflineminus">-  },</span>
<a href="#l27.1058"></a><span id="l27.1058" class="difflineplus">+    // message.h</span>
<a href="#l27.1059"></a><span id="l27.1059" class="difflineplus">+</span>
<a href="#l27.1060"></a><span id="l27.1060" class="difflineplus">+    OtrlMessageAppOps,</span>
<a href="#l27.1061"></a><span id="l27.1061" class="difflineplus">+</span>
<a href="#l27.1062"></a><span id="l27.1062" class="difflineplus">+    errorCode: {</span>
<a href="#l27.1063"></a><span id="l27.1063" class="difflineplus">+      OTRL_ERRCODE_NONE: 0,</span>
<a href="#l27.1064"></a><span id="l27.1064" class="difflineplus">+      OTRL_ERRCODE_ENCRYPTION_ERROR: 1,</span>
<a href="#l27.1065"></a><span id="l27.1065" class="difflineplus">+      OTRL_ERRCODE_MSG_NOT_IN_PRIVATE: 2,</span>
<a href="#l27.1066"></a><span id="l27.1066" class="difflineplus">+      OTRL_ERRCODE_MSG_UNREADABLE: 3,</span>
<a href="#l27.1067"></a><span id="l27.1067" class="difflineplus">+      OTRL_ERRCODE_MSG_MALFORMED: 4,</span>
<a href="#l27.1068"></a><span id="l27.1068" class="difflineplus">+    },</span>
<a href="#l27.1069"></a><span id="l27.1069"> </span>
<a href="#l27.1070"></a><span id="l27.1070" class="difflineminus">-  convertType: {</span>
<a href="#l27.1071"></a><span id="l27.1071" class="difflineminus">-    OTRL_CONVERT_SENDING: 0,</span>
<a href="#l27.1072"></a><span id="l27.1072" class="difflineminus">-    OTRL_CONVERT_RECEIVING: 1,</span>
<a href="#l27.1073"></a><span id="l27.1073" class="difflineminus">-  },</span>
<a href="#l27.1074"></a><span id="l27.1074" class="difflineplus">+    smpEvent: {</span>
<a href="#l27.1075"></a><span id="l27.1075" class="difflineplus">+      OTRL_SMPEVENT_NONE: 0,</span>
<a href="#l27.1076"></a><span id="l27.1076" class="difflineplus">+      OTRL_SMPEVENT_ERROR: 1,</span>
<a href="#l27.1077"></a><span id="l27.1077" class="difflineplus">+      OTRL_SMPEVENT_ABORT: 2,</span>
<a href="#l27.1078"></a><span id="l27.1078" class="difflineplus">+      OTRL_SMPEVENT_CHEATED: 3,</span>
<a href="#l27.1079"></a><span id="l27.1079" class="difflineplus">+      OTRL_SMPEVENT_ASK_FOR_ANSWER: 4,</span>
<a href="#l27.1080"></a><span id="l27.1080" class="difflineplus">+      OTRL_SMPEVENT_ASK_FOR_SECRET: 5,</span>
<a href="#l27.1081"></a><span id="l27.1081" class="difflineplus">+      OTRL_SMPEVENT_IN_PROGRESS: 6,</span>
<a href="#l27.1082"></a><span id="l27.1082" class="difflineplus">+      OTRL_SMPEVENT_SUCCESS: 7,</span>
<a href="#l27.1083"></a><span id="l27.1083" class="difflineplus">+      OTRL_SMPEVENT_FAILURE: 8,</span>
<a href="#l27.1084"></a><span id="l27.1084" class="difflineplus">+    },</span>
<a href="#l27.1085"></a><span id="l27.1085"> </span>
<a href="#l27.1086"></a><span id="l27.1086" class="difflineminus">-  // Deallocate a message allocated by other otrl_message_* routines.</span>
<a href="#l27.1087"></a><span id="l27.1087" class="difflineminus">-  otrl_message_free: libotr.declare(</span>
<a href="#l27.1088"></a><span id="l27.1088" class="difflineminus">-    &quot;otrl_message_free&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1089"></a><span id="l27.1089" class="difflineminus">-    ctypes.char.ptr</span>
<a href="#l27.1090"></a><span id="l27.1090" class="difflineminus">-  ),</span>
<a href="#l27.1091"></a><span id="l27.1091" class="difflineplus">+    messageEvent: {</span>
<a href="#l27.1092"></a><span id="l27.1092" class="difflineplus">+      OTRL_MSGEVENT_NONE: 0,</span>
<a href="#l27.1093"></a><span id="l27.1093" class="difflineplus">+      OTRL_MSGEVENT_ENCRYPTION_REQUIRED: 1,</span>
<a href="#l27.1094"></a><span id="l27.1094" class="difflineplus">+      OTRL_MSGEVENT_ENCRYPTION_ERROR: 2,</span>
<a href="#l27.1095"></a><span id="l27.1095" class="difflineplus">+      OTRL_MSGEVENT_CONNECTION_ENDED: 3,</span>
<a href="#l27.1096"></a><span id="l27.1096" class="difflineplus">+      OTRL_MSGEVENT_SETUP_ERROR: 4,</span>
<a href="#l27.1097"></a><span id="l27.1097" class="difflineplus">+      OTRL_MSGEVENT_MSG_REFLECTED: 5,</span>
<a href="#l27.1098"></a><span id="l27.1098" class="difflineplus">+      OTRL_MSGEVENT_MSG_RESENT: 6,</span>
<a href="#l27.1099"></a><span id="l27.1099" class="difflineplus">+      OTRL_MSGEVENT_RCVDMSG_NOT_IN_PRIVATE: 7,</span>
<a href="#l27.1100"></a><span id="l27.1100" class="difflineplus">+      OTRL_MSGEVENT_RCVDMSG_UNREADABLE: 8,</span>
<a href="#l27.1101"></a><span id="l27.1101" class="difflineplus">+      OTRL_MSGEVENT_RCVDMSG_MALFORMED: 9,</span>
<a href="#l27.1102"></a><span id="l27.1102" class="difflineplus">+      OTRL_MSGEVENT_LOG_HEARTBEAT_RCVD: 10,</span>
<a href="#l27.1103"></a><span id="l27.1103" class="difflineplus">+      OTRL_MSGEVENT_LOG_HEARTBEAT_SENT: 11,</span>
<a href="#l27.1104"></a><span id="l27.1104" class="difflineplus">+      OTRL_MSGEVENT_RCVDMSG_GENERAL_ERR: 12,</span>
<a href="#l27.1105"></a><span id="l27.1105" class="difflineplus">+      OTRL_MSGEVENT_RCVDMSG_UNENCRYPTED: 13,</span>
<a href="#l27.1106"></a><span id="l27.1106" class="difflineplus">+      OTRL_MSGEVENT_RCVDMSG_UNRECOGNIZED: 14,</span>
<a href="#l27.1107"></a><span id="l27.1107" class="difflineplus">+      OTRL_MSGEVENT_RCVDMSG_FOR_OTHER_INSTANCE: 15,</span>
<a href="#l27.1108"></a><span id="l27.1108" class="difflineplus">+    },</span>
<a href="#l27.1109"></a><span id="l27.1109"> </span>
<a href="#l27.1110"></a><span id="l27.1110" class="difflineminus">-  // Handle a message about to be sent to the network.</span>
<a href="#l27.1111"></a><span id="l27.1111" class="difflineminus">-  otrl_message_sending: libotr.declare(</span>
<a href="#l27.1112"></a><span id="l27.1112" class="difflineminus">-    &quot;otrl_message_sending&quot;, abi, gcry_error_t,</span>
<a href="#l27.1113"></a><span id="l27.1113" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1114"></a><span id="l27.1114" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1115"></a><span id="l27.1115" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1116"></a><span id="l27.1116" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1117"></a><span id="l27.1117" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1118"></a><span id="l27.1118" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1119"></a><span id="l27.1119" class="difflineminus">-    otrl_instag_t,</span>
<a href="#l27.1120"></a><span id="l27.1120" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1121"></a><span id="l27.1121" class="difflineminus">-    OtrlTLV.ptr,</span>
<a href="#l27.1122"></a><span id="l27.1122" class="difflineminus">-    ctypes.char.ptr.ptr,</span>
<a href="#l27.1123"></a><span id="l27.1123" class="difflineminus">-    OtrlFragmentPolicy,</span>
<a href="#l27.1124"></a><span id="l27.1124" class="difflineminus">-    ConnContext.ptr.ptr,</span>
<a href="#l27.1125"></a><span id="l27.1125" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1126"></a><span id="l27.1126" class="difflineminus">-    ctypes.void_t.ptr</span>
<a href="#l27.1127"></a><span id="l27.1127" class="difflineminus">-  ),</span>
<a href="#l27.1128"></a><span id="l27.1128" class="difflineplus">+    convertType: {</span>
<a href="#l27.1129"></a><span id="l27.1129" class="difflineplus">+      OTRL_CONVERT_SENDING: 0,</span>
<a href="#l27.1130"></a><span id="l27.1130" class="difflineplus">+      OTRL_CONVERT_RECEIVING: 1,</span>
<a href="#l27.1131"></a><span id="l27.1131" class="difflineplus">+    },</span>
<a href="#l27.1132"></a><span id="l27.1132" class="difflineplus">+</span>
<a href="#l27.1133"></a><span id="l27.1133" class="difflineplus">+    // Deallocate a message allocated by other otrl_message_* routines.</span>
<a href="#l27.1134"></a><span id="l27.1134" class="difflineplus">+    otrl_message_free: libotr.declare(</span>
<a href="#l27.1135"></a><span id="l27.1135" class="difflineplus">+      &quot;otrl_message_free&quot;,</span>
<a href="#l27.1136"></a><span id="l27.1136" class="difflineplus">+      abi,</span>
<a href="#l27.1137"></a><span id="l27.1137" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1138"></a><span id="l27.1138" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l27.1139"></a><span id="l27.1139" class="difflineplus">+    ),</span>
<a href="#l27.1140"></a><span id="l27.1140"> </span>
<a href="#l27.1141"></a><span id="l27.1141" class="difflineminus">-  // Handle a message just received from the network.</span>
<a href="#l27.1142"></a><span id="l27.1142" class="difflineminus">-  otrl_message_receiving: libotr.declare(</span>
<a href="#l27.1143"></a><span id="l27.1143" class="difflineminus">-    &quot;otrl_message_receiving&quot;, abi, ctypes.int,</span>
<a href="#l27.1144"></a><span id="l27.1144" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1145"></a><span id="l27.1145" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1146"></a><span id="l27.1146" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1147"></a><span id="l27.1147" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1148"></a><span id="l27.1148" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1149"></a><span id="l27.1149" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1150"></a><span id="l27.1150" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1151"></a><span id="l27.1151" class="difflineminus">-    ctypes.char.ptr.ptr,</span>
<a href="#l27.1152"></a><span id="l27.1152" class="difflineminus">-    OtrlTLV.ptr.ptr,</span>
<a href="#l27.1153"></a><span id="l27.1153" class="difflineminus">-    ConnContext.ptr.ptr,</span>
<a href="#l27.1154"></a><span id="l27.1154" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1155"></a><span id="l27.1155" class="difflineminus">-    ctypes.void_t.ptr</span>
<a href="#l27.1156"></a><span id="l27.1156" class="difflineminus">-  ),</span>
<a href="#l27.1157"></a><span id="l27.1157" class="difflineplus">+    // Handle a message about to be sent to the network.</span>
<a href="#l27.1158"></a><span id="l27.1158" class="difflineplus">+    otrl_message_sending: libotr.declare(</span>
<a href="#l27.1159"></a><span id="l27.1159" class="difflineplus">+      &quot;otrl_message_sending&quot;,</span>
<a href="#l27.1160"></a><span id="l27.1160" class="difflineplus">+      abi,</span>
<a href="#l27.1161"></a><span id="l27.1161" class="difflineplus">+      gcry_error_t,</span>
<a href="#l27.1162"></a><span id="l27.1162" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1163"></a><span id="l27.1163" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1164"></a><span id="l27.1164" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1165"></a><span id="l27.1165" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1166"></a><span id="l27.1166" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1167"></a><span id="l27.1167" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1168"></a><span id="l27.1168" class="difflineplus">+      otrl_instag_t,</span>
<a href="#l27.1169"></a><span id="l27.1169" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1170"></a><span id="l27.1170" class="difflineplus">+      OtrlTLV.ptr,</span>
<a href="#l27.1171"></a><span id="l27.1171" class="difflineplus">+      ctypes.char.ptr.ptr,</span>
<a href="#l27.1172"></a><span id="l27.1172" class="difflineplus">+      OtrlFragmentPolicy,</span>
<a href="#l27.1173"></a><span id="l27.1173" class="difflineplus">+      ConnContext.ptr.ptr,</span>
<a href="#l27.1174"></a><span id="l27.1174" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1175"></a><span id="l27.1175" class="difflineplus">+      ctypes.void_t.ptr</span>
<a href="#l27.1176"></a><span id="l27.1176" class="difflineplus">+    ),</span>
<a href="#l27.1177"></a><span id="l27.1177"> </span>
<a href="#l27.1178"></a><span id="l27.1178" class="difflineminus">-  // Put a connection into the PLAINTEXT state, first sending the</span>
<a href="#l27.1179"></a><span id="l27.1179" class="difflineminus">-  // other side a notice that we're doing so if we're currently ENCRYPTED,</span>
<a href="#l27.1180"></a><span id="l27.1180" class="difflineminus">-  // and we think he's logged in. Affects only the specified instance.</span>
<a href="#l27.1181"></a><span id="l27.1181" class="difflineminus">-  otrl_message_disconnect: libotr.declare(</span>
<a href="#l27.1182"></a><span id="l27.1182" class="difflineminus">-    &quot;otrl_message_disconnect&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1183"></a><span id="l27.1183" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1184"></a><span id="l27.1184" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1185"></a><span id="l27.1185" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1186"></a><span id="l27.1186" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1187"></a><span id="l27.1187" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1188"></a><span id="l27.1188" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1189"></a><span id="l27.1189" class="difflineminus">-    otrl_instag_t</span>
<a href="#l27.1190"></a><span id="l27.1190" class="difflineminus">-  ),</span>
<a href="#l27.1191"></a><span id="l27.1191" class="difflineplus">+    // Handle a message just received from the network.</span>
<a href="#l27.1192"></a><span id="l27.1192" class="difflineplus">+    otrl_message_receiving: libotr.declare(</span>
<a href="#l27.1193"></a><span id="l27.1193" class="difflineplus">+      &quot;otrl_message_receiving&quot;,</span>
<a href="#l27.1194"></a><span id="l27.1194" class="difflineplus">+      abi,</span>
<a href="#l27.1195"></a><span id="l27.1195" class="difflineplus">+      ctypes.int,</span>
<a href="#l27.1196"></a><span id="l27.1196" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1197"></a><span id="l27.1197" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1198"></a><span id="l27.1198" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1199"></a><span id="l27.1199" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1200"></a><span id="l27.1200" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1201"></a><span id="l27.1201" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1202"></a><span id="l27.1202" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1203"></a><span id="l27.1203" class="difflineplus">+      ctypes.char.ptr.ptr,</span>
<a href="#l27.1204"></a><span id="l27.1204" class="difflineplus">+      OtrlTLV.ptr.ptr,</span>
<a href="#l27.1205"></a><span id="l27.1205" class="difflineplus">+      ConnContext.ptr.ptr,</span>
<a href="#l27.1206"></a><span id="l27.1206" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1207"></a><span id="l27.1207" class="difflineplus">+      ctypes.void_t.ptr</span>
<a href="#l27.1208"></a><span id="l27.1208" class="difflineplus">+    ),</span>
<a href="#l27.1209"></a><span id="l27.1209"> </span>
<a href="#l27.1210"></a><span id="l27.1210" class="difflineminus">-  // Call this function every so often, to clean up stale private state that</span>
<a href="#l27.1211"></a><span id="l27.1211" class="difflineminus">-  // may otherwise stick around in memory.</span>
<a href="#l27.1212"></a><span id="l27.1212" class="difflineminus">-  otrl_message_poll: libotr.declare(</span>
<a href="#l27.1213"></a><span id="l27.1213" class="difflineminus">-    &quot;otrl_message_poll&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1214"></a><span id="l27.1214" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1215"></a><span id="l27.1215" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1216"></a><span id="l27.1216" class="difflineminus">-    ctypes.void_t.ptr</span>
<a href="#l27.1217"></a><span id="l27.1217" class="difflineminus">-  ),</span>
<a href="#l27.1218"></a><span id="l27.1218" class="difflineplus">+    // Put a connection into the PLAINTEXT state, first sending the</span>
<a href="#l27.1219"></a><span id="l27.1219" class="difflineplus">+    // other side a notice that we're doing so if we're currently ENCRYPTED,</span>
<a href="#l27.1220"></a><span id="l27.1220" class="difflineplus">+    // and we think he's logged in. Affects only the specified instance.</span>
<a href="#l27.1221"></a><span id="l27.1221" class="difflineplus">+    otrl_message_disconnect: libotr.declare(</span>
<a href="#l27.1222"></a><span id="l27.1222" class="difflineplus">+      &quot;otrl_message_disconnect&quot;,</span>
<a href="#l27.1223"></a><span id="l27.1223" class="difflineplus">+      abi,</span>
<a href="#l27.1224"></a><span id="l27.1224" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1225"></a><span id="l27.1225" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1226"></a><span id="l27.1226" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1227"></a><span id="l27.1227" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1228"></a><span id="l27.1228" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1229"></a><span id="l27.1229" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1230"></a><span id="l27.1230" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1231"></a><span id="l27.1231" class="difflineplus">+      otrl_instag_t</span>
<a href="#l27.1232"></a><span id="l27.1232" class="difflineplus">+    ),</span>
<a href="#l27.1233"></a><span id="l27.1233"> </span>
<a href="#l27.1234"></a><span id="l27.1234" class="difflineminus">-  // Initiate the Socialist Millionaires' Protocol.</span>
<a href="#l27.1235"></a><span id="l27.1235" class="difflineminus">-  otrl_message_initiate_smp: libotr.declare(</span>
<a href="#l27.1236"></a><span id="l27.1236" class="difflineminus">-    &quot;otrl_message_initiate_smp&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1237"></a><span id="l27.1237" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1238"></a><span id="l27.1238" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1239"></a><span id="l27.1239" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1240"></a><span id="l27.1240" class="difflineminus">-    ConnContext.ptr,</span>
<a href="#l27.1241"></a><span id="l27.1241" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1242"></a><span id="l27.1242" class="difflineminus">-    ctypes.size_t</span>
<a href="#l27.1243"></a><span id="l27.1243" class="difflineminus">-  ),</span>
<a href="#l27.1244"></a><span id="l27.1244" class="difflineplus">+    // Call this function every so often, to clean up stale private state that</span>
<a href="#l27.1245"></a><span id="l27.1245" class="difflineplus">+    // may otherwise stick around in memory.</span>
<a href="#l27.1246"></a><span id="l27.1246" class="difflineplus">+    otrl_message_poll: libotr.declare(</span>
<a href="#l27.1247"></a><span id="l27.1247" class="difflineplus">+      &quot;otrl_message_poll&quot;,</span>
<a href="#l27.1248"></a><span id="l27.1248" class="difflineplus">+      abi,</span>
<a href="#l27.1249"></a><span id="l27.1249" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1250"></a><span id="l27.1250" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1251"></a><span id="l27.1251" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1252"></a><span id="l27.1252" class="difflineplus">+      ctypes.void_t.ptr</span>
<a href="#l27.1253"></a><span id="l27.1253" class="difflineplus">+    ),</span>
<a href="#l27.1254"></a><span id="l27.1254"> </span>
<a href="#l27.1255"></a><span id="l27.1255" class="difflineminus">-  // Initiate the Socialist Millionaires' Protocol and send a prompt</span>
<a href="#l27.1256"></a><span id="l27.1256" class="difflineminus">-  // question to the buddy.</span>
<a href="#l27.1257"></a><span id="l27.1257" class="difflineminus">-  otrl_message_initiate_smp_q: libotr.declare(</span>
<a href="#l27.1258"></a><span id="l27.1258" class="difflineminus">-    &quot;otrl_message_initiate_smp_q&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1259"></a><span id="l27.1259" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1260"></a><span id="l27.1260" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1261"></a><span id="l27.1261" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1262"></a><span id="l27.1262" class="difflineminus">-    ConnContext.ptr,</span>
<a href="#l27.1263"></a><span id="l27.1263" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1264"></a><span id="l27.1264" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1265"></a><span id="l27.1265" class="difflineminus">-    ctypes.size_t</span>
<a href="#l27.1266"></a><span id="l27.1266" class="difflineminus">-  ),</span>
<a href="#l27.1267"></a><span id="l27.1267" class="difflineplus">+    // Initiate the Socialist Millionaires' Protocol.</span>
<a href="#l27.1268"></a><span id="l27.1268" class="difflineplus">+    otrl_message_initiate_smp: libotr.declare(</span>
<a href="#l27.1269"></a><span id="l27.1269" class="difflineplus">+      &quot;otrl_message_initiate_smp&quot;,</span>
<a href="#l27.1270"></a><span id="l27.1270" class="difflineplus">+      abi,</span>
<a href="#l27.1271"></a><span id="l27.1271" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1272"></a><span id="l27.1272" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1273"></a><span id="l27.1273" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1274"></a><span id="l27.1274" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1275"></a><span id="l27.1275" class="difflineplus">+      ConnContext.ptr,</span>
<a href="#l27.1276"></a><span id="l27.1276" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1277"></a><span id="l27.1277" class="difflineplus">+      ctypes.size_t</span>
<a href="#l27.1278"></a><span id="l27.1278" class="difflineplus">+    ),</span>
<a href="#l27.1279"></a><span id="l27.1279"> </span>
<a href="#l27.1280"></a><span id="l27.1280" class="difflineminus">-  // Respond to a buddy initiating the Socialist Millionaires' Protocol.</span>
<a href="#l27.1281"></a><span id="l27.1281" class="difflineminus">-  otrl_message_respond_smp: libotr.declare(</span>
<a href="#l27.1282"></a><span id="l27.1282" class="difflineminus">-    &quot;otrl_message_respond_smp&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1283"></a><span id="l27.1283" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1284"></a><span id="l27.1284" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1285"></a><span id="l27.1285" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1286"></a><span id="l27.1286" class="difflineminus">-    ConnContext.ptr,</span>
<a href="#l27.1287"></a><span id="l27.1287" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l27.1288"></a><span id="l27.1288" class="difflineminus">-    ctypes.size_t</span>
<a href="#l27.1289"></a><span id="l27.1289" class="difflineminus">-  ),</span>
<a href="#l27.1290"></a><span id="l27.1290" class="difflineplus">+    // Initiate the Socialist Millionaires' Protocol and send a prompt</span>
<a href="#l27.1291"></a><span id="l27.1291" class="difflineplus">+    // question to the buddy.</span>
<a href="#l27.1292"></a><span id="l27.1292" class="difflineplus">+    otrl_message_initiate_smp_q: libotr.declare(</span>
<a href="#l27.1293"></a><span id="l27.1293" class="difflineplus">+      &quot;otrl_message_initiate_smp_q&quot;,</span>
<a href="#l27.1294"></a><span id="l27.1294" class="difflineplus">+      abi,</span>
<a href="#l27.1295"></a><span id="l27.1295" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1296"></a><span id="l27.1296" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1297"></a><span id="l27.1297" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1298"></a><span id="l27.1298" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1299"></a><span id="l27.1299" class="difflineplus">+      ConnContext.ptr,</span>
<a href="#l27.1300"></a><span id="l27.1300" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1301"></a><span id="l27.1301" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1302"></a><span id="l27.1302" class="difflineplus">+      ctypes.size_t</span>
<a href="#l27.1303"></a><span id="l27.1303" class="difflineplus">+    ),</span>
<a href="#l27.1304"></a><span id="l27.1304"> </span>
<a href="#l27.1305"></a><span id="l27.1305" class="difflineminus">-  // Abort the SMP. Called when an unexpected SMP message breaks the</span>
<a href="#l27.1306"></a><span id="l27.1306" class="difflineminus">-  // normal flow.</span>
<a href="#l27.1307"></a><span id="l27.1307" class="difflineminus">-  otrl_message_abort_smp: libotr.declare(</span>
<a href="#l27.1308"></a><span id="l27.1308" class="difflineminus">-    &quot;otrl_message_abort_smp&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1309"></a><span id="l27.1309" class="difflineminus">-    OtrlUserState,</span>
<a href="#l27.1310"></a><span id="l27.1310" class="difflineminus">-    OtrlMessageAppOps.ptr,</span>
<a href="#l27.1311"></a><span id="l27.1311" class="difflineminus">-    ctypes.void_t.ptr,</span>
<a href="#l27.1312"></a><span id="l27.1312" class="difflineminus">-    ConnContext.ptr</span>
<a href="#l27.1313"></a><span id="l27.1313" class="difflineminus">-  ),</span>
<a href="#l27.1314"></a><span id="l27.1314" class="difflineplus">+    // Respond to a buddy initiating the Socialist Millionaires' Protocol.</span>
<a href="#l27.1315"></a><span id="l27.1315" class="difflineplus">+    otrl_message_respond_smp: libotr.declare(</span>
<a href="#l27.1316"></a><span id="l27.1316" class="difflineplus">+      &quot;otrl_message_respond_smp&quot;,</span>
<a href="#l27.1317"></a><span id="l27.1317" class="difflineplus">+      abi,</span>
<a href="#l27.1318"></a><span id="l27.1318" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1319"></a><span id="l27.1319" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1320"></a><span id="l27.1320" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1321"></a><span id="l27.1321" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1322"></a><span id="l27.1322" class="difflineplus">+      ConnContext.ptr,</span>
<a href="#l27.1323"></a><span id="l27.1323" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l27.1324"></a><span id="l27.1324" class="difflineplus">+      ctypes.size_t</span>
<a href="#l27.1325"></a><span id="l27.1325" class="difflineplus">+    ),</span>
<a href="#l27.1326"></a><span id="l27.1326"> </span>
<a href="#l27.1327"></a><span id="l27.1327" class="difflineminus">-  // tlv.h</span>
<a href="#l27.1328"></a><span id="l27.1328" class="difflineplus">+    // Abort the SMP. Called when an unexpected SMP message breaks the</span>
<a href="#l27.1329"></a><span id="l27.1329" class="difflineplus">+    // normal flow.</span>
<a href="#l27.1330"></a><span id="l27.1330" class="difflineplus">+    otrl_message_abort_smp: libotr.declare(</span>
<a href="#l27.1331"></a><span id="l27.1331" class="difflineplus">+      &quot;otrl_message_abort_smp&quot;,</span>
<a href="#l27.1332"></a><span id="l27.1332" class="difflineplus">+      abi,</span>
<a href="#l27.1333"></a><span id="l27.1333" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1334"></a><span id="l27.1334" class="difflineplus">+      OtrlUserState,</span>
<a href="#l27.1335"></a><span id="l27.1335" class="difflineplus">+      OtrlMessageAppOps.ptr,</span>
<a href="#l27.1336"></a><span id="l27.1336" class="difflineplus">+      ctypes.void_t.ptr,</span>
<a href="#l27.1337"></a><span id="l27.1337" class="difflineplus">+      ConnContext.ptr</span>
<a href="#l27.1338"></a><span id="l27.1338" class="difflineplus">+    ),</span>
<a href="#l27.1339"></a><span id="l27.1339" class="difflineplus">+</span>
<a href="#l27.1340"></a><span id="l27.1340" class="difflineplus">+    // tlv.h</span>
<a href="#l27.1341"></a><span id="l27.1341"> </span>
<a href="#l27.1342"></a><span id="l27.1342" class="difflineminus">-  tlvs: {</span>
<a href="#l27.1343"></a><span id="l27.1343" class="difflineminus">-    OTRL_TLV_PADDING: new ctypes.unsigned_short(0x0000),</span>
<a href="#l27.1344"></a><span id="l27.1344" class="difflineminus">-    OTRL_TLV_DISCONNECTED: new ctypes.unsigned_short(0x0001),</span>
<a href="#l27.1345"></a><span id="l27.1345" class="difflineminus">-    OTRL_TLV_SMP1: new ctypes.unsigned_short(0x0002),</span>
<a href="#l27.1346"></a><span id="l27.1346" class="difflineminus">-    OTRL_TLV_SMP2: new ctypes.unsigned_short(0x0003),</span>
<a href="#l27.1347"></a><span id="l27.1347" class="difflineminus">-    OTRL_TLV_SMP3: new ctypes.unsigned_short(0x0004),</span>
<a href="#l27.1348"></a><span id="l27.1348" class="difflineminus">-    OTRL_TLV_SMP4: new ctypes.unsigned_short(0x0005),</span>
<a href="#l27.1349"></a><span id="l27.1349" class="difflineminus">-    OTRL_TLV_SMP_ABORT: new ctypes.unsigned_short(0x0006),</span>
<a href="#l27.1350"></a><span id="l27.1350" class="difflineminus">-    OTRL_TLV_SMP1Q: new ctypes.unsigned_short(0x0007),</span>
<a href="#l27.1351"></a><span id="l27.1351" class="difflineminus">-    OTRL_TLV_SYMKEY: new ctypes.unsigned_short(0x0008),</span>
<a href="#l27.1352"></a><span id="l27.1352" class="difflineminus">-  },</span>
<a href="#l27.1353"></a><span id="l27.1353" class="difflineplus">+    tlvs: {</span>
<a href="#l27.1354"></a><span id="l27.1354" class="difflineplus">+      OTRL_TLV_PADDING: new ctypes.unsigned_short(0x0000),</span>
<a href="#l27.1355"></a><span id="l27.1355" class="difflineplus">+      OTRL_TLV_DISCONNECTED: new ctypes.unsigned_short(0x0001),</span>
<a href="#l27.1356"></a><span id="l27.1356" class="difflineplus">+      OTRL_TLV_SMP1: new ctypes.unsigned_short(0x0002),</span>
<a href="#l27.1357"></a><span id="l27.1357" class="difflineplus">+      OTRL_TLV_SMP2: new ctypes.unsigned_short(0x0003),</span>
<a href="#l27.1358"></a><span id="l27.1358" class="difflineplus">+      OTRL_TLV_SMP3: new ctypes.unsigned_short(0x0004),</span>
<a href="#l27.1359"></a><span id="l27.1359" class="difflineplus">+      OTRL_TLV_SMP4: new ctypes.unsigned_short(0x0005),</span>
<a href="#l27.1360"></a><span id="l27.1360" class="difflineplus">+      OTRL_TLV_SMP_ABORT: new ctypes.unsigned_short(0x0006),</span>
<a href="#l27.1361"></a><span id="l27.1361" class="difflineplus">+      OTRL_TLV_SMP1Q: new ctypes.unsigned_short(0x0007),</span>
<a href="#l27.1362"></a><span id="l27.1362" class="difflineplus">+      OTRL_TLV_SYMKEY: new ctypes.unsigned_short(0x0008),</span>
<a href="#l27.1363"></a><span id="l27.1363" class="difflineplus">+    },</span>
<a href="#l27.1364"></a><span id="l27.1364"> </span>
<a href="#l27.1365"></a><span id="l27.1365" class="difflineminus">-  OtrlTLV,</span>
<a href="#l27.1366"></a><span id="l27.1366" class="difflineplus">+    OtrlTLV,</span>
<a href="#l27.1367"></a><span id="l27.1367"> </span>
<a href="#l27.1368"></a><span id="l27.1368" class="difflineminus">-  // Return the first TLV with the given type in the chain, or NULL if one</span>
<a href="#l27.1369"></a><span id="l27.1369" class="difflineminus">-  // isn't found.</span>
<a href="#l27.1370"></a><span id="l27.1370" class="difflineminus">-  otrl_tlv_find: libotr.declare(</span>
<a href="#l27.1371"></a><span id="l27.1371" class="difflineminus">-    &quot;otrl_tlv_find&quot;, abi, OtrlTLV.ptr,</span>
<a href="#l27.1372"></a><span id="l27.1372" class="difflineminus">-    OtrlTLV.ptr, ctypes.unsigned_short</span>
<a href="#l27.1373"></a><span id="l27.1373" class="difflineminus">-  ),</span>
<a href="#l27.1374"></a><span id="l27.1374" class="difflineplus">+    // Return the first TLV with the given type in the chain, or NULL if one</span>
<a href="#l27.1375"></a><span id="l27.1375" class="difflineplus">+    // isn't found.</span>
<a href="#l27.1376"></a><span id="l27.1376" class="difflineplus">+    otrl_tlv_find: libotr.declare(</span>
<a href="#l27.1377"></a><span id="l27.1377" class="difflineplus">+      &quot;otrl_tlv_find&quot;,</span>
<a href="#l27.1378"></a><span id="l27.1378" class="difflineplus">+      abi,</span>
<a href="#l27.1379"></a><span id="l27.1379" class="difflineplus">+      OtrlTLV.ptr,</span>
<a href="#l27.1380"></a><span id="l27.1380" class="difflineplus">+      OtrlTLV.ptr,</span>
<a href="#l27.1381"></a><span id="l27.1381" class="difflineplus">+      ctypes.unsigned_short</span>
<a href="#l27.1382"></a><span id="l27.1382" class="difflineplus">+    ),</span>
<a href="#l27.1383"></a><span id="l27.1383"> </span>
<a href="#l27.1384"></a><span id="l27.1384" class="difflineminus">-  // Deallocate a chain of TLVs.</span>
<a href="#l27.1385"></a><span id="l27.1385" class="difflineminus">-  otrl_tlv_free: libotr.declare(</span>
<a href="#l27.1386"></a><span id="l27.1386" class="difflineminus">-    &quot;otrl_tlv_free&quot;, abi, ctypes.void_t,</span>
<a href="#l27.1387"></a><span id="l27.1387" class="difflineminus">-    OtrlTLV.ptr</span>
<a href="#l27.1388"></a><span id="l27.1388" class="difflineminus">-  ),</span>
<a href="#l27.1389"></a><span id="l27.1389" class="difflineminus">-</span>
<a href="#l27.1390"></a><span id="l27.1390" class="difflineplus">+    // Deallocate a chain of TLVs.</span>
<a href="#l27.1391"></a><span id="l27.1391" class="difflineplus">+    otrl_tlv_free: libotr.declare(</span>
<a href="#l27.1392"></a><span id="l27.1392" class="difflineplus">+      &quot;otrl_tlv_free&quot;,</span>
<a href="#l27.1393"></a><span id="l27.1393" class="difflineplus">+      abi,</span>
<a href="#l27.1394"></a><span id="l27.1394" class="difflineplus">+      ctypes.void_t,</span>
<a href="#l27.1395"></a><span id="l27.1395" class="difflineplus">+      OtrlTLV.ptr</span>
<a href="#l27.1396"></a><span id="l27.1396" class="difflineplus">+    ),</span>
<a href="#l27.1397"></a><span id="l27.1397">   };</span>
<a href="#l27.1398"></a><span id="l27.1398"> }</span>
<a href="#l27.1399"></a><span id="l27.1399"> </span>
<a href="#l27.1400"></a><span id="l27.1400"> // exports</span>
<a href="#l27.1401"></a><span id="l27.1401"> </span>
<a href="#l27.1402"></a><span id="l27.1402"> this.EXPORTED_SYMBOLS = [&quot;OTRLibLoader&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/chat/modules/OTRUI.jsm</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/chat/modules/OTRUI.jsm</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,32 +1,33 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.5"></a><span id="l28.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.6"></a><span id="l28.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> this.EXPORTED_SYMBOLS = [&quot;OTRUI&quot;];</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-const {Localization} = ChromeUtils.import(&quot;resource://gre/modules/Localization.jsm&quot;);</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-const {OTR}  = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+const { Localization } = ChromeUtils.import(</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+  &quot;resource://gre/modules/Localization.jsm&quot;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+const { OTR } = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-const syncL10n = new Localization([</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-  &quot;messenger/otr/otrUI.ftl&quot;,</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-], true);</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+const syncL10n = new Localization([&quot;messenger/otr/otrUI.ftl&quot;], true);</span>
<a href="#l28.23"></a><span id="l28.23"> </span>
<a href="#l28.24"></a><span id="l28.24"> function _str(id) {</span>
<a href="#l28.25"></a><span id="l28.25">   return syncL10n.formatValueSync(id);</span>
<a href="#l28.26"></a><span id="l28.26"> }</span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28"> function _strArgs(id, args) {</span>
<a href="#l28.29"></a><span id="l28.29">   return syncL10n.formatValueSync(id, args);</span>
<a href="#l28.30"></a><span id="l28.30"> }</span>
<a href="#l28.31"></a><span id="l28.31"> </span>
<a href="#l28.32"></a><span id="l28.32"> const OTR_AUTH_DIALOG_URL = &quot;chrome://chat/content/otr-auth.xul&quot;;</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-const OTR_ADD_FINGER_DIALOG_URL = &quot;chrome://chat/content/otr-add-fingerprint.xul&quot;;</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+const OTR_ADD_FINGER_DIALOG_URL =</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+  &quot;chrome://chat/content/otr-add-fingerprint.xul&quot;;</span>
<a href="#l28.36"></a><span id="l28.36"> </span>
<a href="#l28.37"></a><span id="l28.37"> const AUTH_STATUS_UNVERIFIED = &quot;otr-auth-unverified&quot;;</span>
<a href="#l28.38"></a><span id="l28.38"> var authLabelMap;</span>
<a href="#l28.39"></a><span id="l28.39"> var authTitleMap;</span>
<a href="#l28.40"></a><span id="l28.40"> var trustMap;</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42"> function initStrings() {</span>
<a href="#l28.43"></a><span id="l28.43">   authLabelMap = new Map([</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineat">@@ -46,48 +47,60 @@ function initStrings() {</span>
<a href="#l28.45"></a><span id="l28.45">   ]);</span>
<a href="#l28.46"></a><span id="l28.46"> </span>
<a href="#l28.47"></a><span id="l28.47">   let sl = _str(&quot;start-label&quot;);</span>
<a href="#l28.48"></a><span id="l28.48">   let al = _str(&quot;auth-label&quot;);</span>
<a href="#l28.49"></a><span id="l28.49">   let rfl = _str(&quot;refresh-label&quot;);</span>
<a href="#l28.50"></a><span id="l28.50">   let ral = _str(&quot;reauth-label&quot;);</span>
<a href="#l28.51"></a><span id="l28.51"> </span>
<a href="#l28.52"></a><span id="l28.52">   trustMap = new Map([</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-    [OTR.trustState.TRUST_NOT_PRIVATE, {</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-      startLabel: sl,</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-      authLabel: al,</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-      disableStart: false,</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-      disableEnd: true,</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-      disableAuth: true,</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-      class: &quot;not_private&quot;,</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-    }],</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-    [OTR.trustState.TRUST_UNVERIFIED, {</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-      startLabel: rfl,</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-      authLabel: al,</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-      disableStart: false,</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-      disableEnd: false,</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-      disableAuth: false,</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-      class: &quot;unverified&quot;,</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-    }],</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-    [OTR.trustState.TRUST_PRIVATE, {</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineminus">-      startLabel: rfl,</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-      authLabel: ral,</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-      disableStart: false,</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-      disableEnd: false,</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-      disableAuth: false,</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineminus">-      class: &quot;private&quot;,</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineminus">-    }],</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-    [OTR.trustState.TRUST_FINISHED, {</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineminus">-      startLabel: sl,</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineminus">-      authLabel: al,</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-      disableStart: false,</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-      disableEnd: false,</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-      disableAuth: true,</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineminus">-      class: &quot;finished&quot;,</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineminus">-    }],</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+    [</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+      OTR.trustState.TRUST_NOT_PRIVATE,</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+      {</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+        startLabel: sl,</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+        authLabel: al,</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+        disableStart: false,</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+        disableEnd: true,</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+        disableAuth: true,</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+        class: &quot;not_private&quot;,</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+      },</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+    ],</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+    [</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+      OTR.trustState.TRUST_UNVERIFIED,</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineplus">+      {</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+        startLabel: rfl,</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineplus">+        authLabel: al,</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+        disableStart: false,</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+        disableEnd: false,</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+        disableAuth: false,</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+        class: &quot;unverified&quot;,</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+      },</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+    ],</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineplus">+    [</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineplus">+      OTR.trustState.TRUST_PRIVATE,</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+      {</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+        startLabel: rfl,</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+        authLabel: ral,</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+        disableStart: false,</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineplus">+        disableEnd: false,</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+        disableAuth: false,</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+        class: &quot;private&quot;,</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+      },</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+    ],</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+    [</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+      OTR.trustState.TRUST_FINISHED,</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+      {</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineplus">+        startLabel: sl,</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineplus">+        authLabel: al,</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+        disableStart: false,</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+        disableEnd: false,</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+        disableAuth: true,</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+        class: &quot;finished&quot;,</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+      },</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+    ],</span>
<a href="#l28.129"></a><span id="l28.129">   ]);</span>
<a href="#l28.130"></a><span id="l28.130"> }</span>
<a href="#l28.131"></a><span id="l28.131"> </span>
<a href="#l28.132"></a><span id="l28.132"> var windowRefs = new Map();</span>
<a href="#l28.133"></a><span id="l28.133"> </span>
<a href="#l28.134"></a><span id="l28.134"> var OTRUI = {</span>
<a href="#l28.135"></a><span id="l28.135">   enabled: false,</span>
<a href="#l28.136"></a><span id="l28.136">   stringsLoaded: false,</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineat">@@ -132,42 +145,49 @@ var OTRUI = {</span>
<a href="#l28.138"></a><span id="l28.138"> </span>
<a href="#l28.139"></a><span id="l28.139">   removeMenus(win) {</span>
<a href="#l28.140"></a><span id="l28.140">     let doc = win.document;</span>
<a href="#l28.141"></a><span id="l28.141">     OTRUI.removeBuddyContextMenu(doc);</span>
<a href="#l28.142"></a><span id="l28.142">   },</span>
<a href="#l28.143"></a><span id="l28.143"> </span>
<a href="#l28.144"></a><span id="l28.144">   addBuddyContextMenu(buddyContextMenu, doc) {</span>
<a href="#l28.145"></a><span id="l28.145">     if (!buddyContextMenu || !OTR.libLoaded) {</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-      return;  // Not the buddy list context menu</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineplus">+      return; // Not the buddy list context menu</span>
<a href="#l28.148"></a><span id="l28.148">     }</span>
<a href="#l28.149"></a><span id="l28.149">     OTRUI.removeBuddyContextMenu(doc);</span>
<a href="#l28.150"></a><span id="l28.150"> </span>
<a href="#l28.151"></a><span id="l28.151">     let sep = doc.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l28.152"></a><span id="l28.152">     sep.setAttribute(&quot;id&quot;, &quot;otrsep&quot;);</span>
<a href="#l28.153"></a><span id="l28.153">     let menuitem = doc.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l28.154"></a><span id="l28.154">     menuitem.setAttribute(&quot;label&quot;, _str(&quot;buddycontextmenu-label&quot;));</span>
<a href="#l28.155"></a><span id="l28.155">     menuitem.setAttribute(&quot;id&quot;, &quot;otrcont&quot;);</span>
<a href="#l28.156"></a><span id="l28.156">     menuitem.addEventListener(&quot;command&quot;, () =&gt; {</span>
<a href="#l28.157"></a><span id="l28.157">       let target = buddyContextMenu.triggerNode;</span>
<a href="#l28.158"></a><span id="l28.158">       if (target.localName == &quot;richlistitem&quot;) {</span>
<a href="#l28.159"></a><span id="l28.159">         let contact = target.contact;</span>
<a href="#l28.160"></a><span id="l28.160">         let args = OTRUI.contactWrapper(contact);</span>
<a href="#l28.161"></a><span id="l28.161">         args.wrappedJSObject = args;</span>
<a href="#l28.162"></a><span id="l28.162">         let features = &quot;chrome,modal,centerscreen,resizable=no,minimizable=no&quot;;</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-        Services.ww.openWindow(null, OTR_ADD_FINGER_DIALOG_URL, &quot;&quot;, features, args);</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineplus">+        Services.ww.openWindow(</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineplus">+          null,</span>
<a href="#l28.166"></a><span id="l28.166" class="difflineplus">+          OTR_ADD_FINGER_DIALOG_URL,</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineplus">+          &quot;&quot;,</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineplus">+          features,</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineplus">+          args</span>
<a href="#l28.170"></a><span id="l28.170" class="difflineplus">+        );</span>
<a href="#l28.171"></a><span id="l28.171">       }</span>
<a href="#l28.172"></a><span id="l28.172">     });</span>
<a href="#l28.173"></a><span id="l28.173"> </span>
<a href="#l28.174"></a><span id="l28.174" class="difflineminus">-    buddyContextMenu.addEventListener(&quot;popupshowing&quot;, (e) =&gt; {</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineplus">+    buddyContextMenu.addEventListener(&quot;popupshowing&quot;, e =&gt; {</span>
<a href="#l28.176"></a><span id="l28.176">       let target = e.target.triggerNode;</span>
<a href="#l28.177"></a><span id="l28.177">       if (target.localName == &quot;richlistitem&quot;) {</span>
<a href="#l28.178"></a><span id="l28.178">         menuitem.hidden = false;</span>
<a href="#l28.179"></a><span id="l28.179">         sep.hidden = false;</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-      } else { /* probably imconv */</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineplus">+      } else {</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineplus">+        /* probably imconv */</span>
<a href="#l28.183"></a><span id="l28.183">         menuitem.hidden = true;</span>
<a href="#l28.184"></a><span id="l28.184">         sep.hidden = true;</span>
<a href="#l28.185"></a><span id="l28.185">       }</span>
<a href="#l28.186"></a><span id="l28.186">     });</span>
<a href="#l28.187"></a><span id="l28.187"> </span>
<a href="#l28.188"></a><span id="l28.188">     buddyContextMenu.appendChild(sep);</span>
<a href="#l28.189"></a><span id="l28.189">     buddyContextMenu.appendChild(menuitem);</span>
<a href="#l28.190"></a><span id="l28.190">   },</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineat">@@ -188,31 +208,33 @@ var OTRUI = {</span>
<a href="#l28.192"></a><span id="l28.192">   },</span>
<a href="#l28.193"></a><span id="l28.193"> </span>
<a href="#l28.194"></a><span id="l28.194">   loopKeyGenFailure(param) {</span>
<a href="#l28.195"></a><span id="l28.195">     ChromeUtils.idleDispatch(OTRUI.genNextMissingKey);</span>
<a href="#l28.196"></a><span id="l28.196">     OTRUI.reportKeyGenFailure(param);</span>
<a href="#l28.197"></a><span id="l28.197">   },</span>
<a href="#l28.198"></a><span id="l28.198"> </span>
<a href="#l28.199"></a><span id="l28.199">   reportKeyGenFailure(param) {</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineminus">-    throw new Error(_strArgs(&quot;otr-genkey-failed&quot;, {error: String(param)}));</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineplus">+    throw new Error(_strArgs(&quot;otr-genkey-failed&quot;, { error: String(param) }));</span>
<a href="#l28.202"></a><span id="l28.202">   },</span>
<a href="#l28.203"></a><span id="l28.203"> </span>
<a href="#l28.204"></a><span id="l28.204">   accountsToGenKey: [],</span>
<a href="#l28.205"></a><span id="l28.205"> </span>
<a href="#l28.206"></a><span id="l28.206">   genNextMissingKey() {</span>
<a href="#l28.207"></a><span id="l28.207">     if (OTRUI.accountsToGenKey.length == 0) {</span>
<a href="#l28.208"></a><span id="l28.208">       return;</span>
<a href="#l28.209"></a><span id="l28.209">     }</span>
<a href="#l28.210"></a><span id="l28.210"> </span>
<a href="#l28.211"></a><span id="l28.211">     let acc = OTRUI.accountsToGenKey.pop();</span>
<a href="#l28.212"></a><span id="l28.212">     let fp = OTR.privateKeyFingerprint(acc.name, acc.prot);</span>
<a href="#l28.213"></a><span id="l28.213">     if (!fp) {</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineminus">-      OTR.generatePrivateKey(acc.name, acc.prot)</span>
<a href="#l28.215"></a><span id="l28.215" class="difflineminus">-      .then(OTRUI.loopKeyGenSuccess, OTRUI.loopKeyGenFailure);</span>
<a href="#l28.216"></a><span id="l28.216" class="difflineplus">+      OTR.generatePrivateKey(acc.name, acc.prot).then(</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineplus">+        OTRUI.loopKeyGenSuccess,</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineplus">+        OTRUI.loopKeyGenFailure</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineplus">+      );</span>
<a href="#l28.220"></a><span id="l28.220">     } else {</span>
<a href="#l28.221"></a><span id="l28.221">       ChromeUtils.idleDispatch(OTRUI.genNextMissingKey);</span>
<a href="#l28.222"></a><span id="l28.222">     }</span>
<a href="#l28.223"></a><span id="l28.223">   },</span>
<a href="#l28.224"></a><span id="l28.224"> </span>
<a href="#l28.225"></a><span id="l28.225">   genMissingKeys() {</span>
<a href="#l28.226"></a><span id="l28.226">     for (let acc of Services.accounts.getAccounts()) {</span>
<a href="#l28.227"></a><span id="l28.227">       OTRUI.accountsToGenKey.push({</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineat">@@ -234,38 +256,40 @@ var OTRUI = {</span>
<a href="#l28.229"></a><span id="l28.229">     OTR.init({});</span>
<a href="#l28.230"></a><span id="l28.230">     if (!OTR.libLoaded) {</span>
<a href="#l28.231"></a><span id="l28.231">       return;</span>
<a href="#l28.232"></a><span id="l28.232">     }</span>
<a href="#l28.233"></a><span id="l28.233"> </span>
<a href="#l28.234"></a><span id="l28.234">     this.enabled = true;</span>
<a href="#l28.235"></a><span id="l28.235"> </span>
<a href="#l28.236"></a><span id="l28.236">     OTR.addObserver(OTRUI);</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-    OTR.loadFiles().then(function() {</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-      Services.obs.addObserver(OTR, &quot;new-ui-conversation&quot;);</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineminus">-      // Disabled until #76 is resolved.</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineminus">-      // Services.obs.addObserver(OTRUI, &quot;contact-added&quot;, false);</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineminus">-      Services.obs.addObserver(OTRUI, &quot;account-added&quot;);</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineminus">-      // Services.obs.addObserver(OTRUI, &quot;contact-signed-off&quot;, false);</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineminus">-      Services.obs.addObserver(OTRUI, &quot;conversation-loaded&quot;);</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineminus">-      Services.obs.addObserver(OTRUI, &quot;conversation-closed&quot;);</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineminus">-      Services.obs.addObserver(OTRUI, &quot;prpl-quit&quot;);</span>
<a href="#l28.246"></a><span id="l28.246" class="difflineplus">+    OTR.loadFiles()</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineplus">+      .then(function() {</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineplus">+        Services.obs.addObserver(OTR, &quot;new-ui-conversation&quot;);</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineplus">+        // Disabled until #76 is resolved.</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineplus">+        // Services.obs.addObserver(OTRUI, &quot;contact-added&quot;, false);</span>
<a href="#l28.251"></a><span id="l28.251" class="difflineplus">+        Services.obs.addObserver(OTRUI, &quot;account-added&quot;);</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineplus">+        // Services.obs.addObserver(OTRUI, &quot;contact-signed-off&quot;, false);</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineplus">+        Services.obs.addObserver(OTRUI, &quot;conversation-loaded&quot;);</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineplus">+        Services.obs.addObserver(OTRUI, &quot;conversation-closed&quot;);</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineplus">+        Services.obs.addObserver(OTRUI, &quot;prpl-quit&quot;);</span>
<a href="#l28.256"></a><span id="l28.256"> </span>
<a href="#l28.257"></a><span id="l28.257" class="difflineminus">-      let conversations = Services.conversations.getConversations();</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineminus">-      while (conversations.hasMoreElements()) {</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineminus">-      let aConv = conversations.getNext();</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineminus">-      OTRUI.initConv(aConv);</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineminus">-      }</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineminus">-      OTRUI.addMenuObserver();</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineplus">+        let conversations = Services.conversations.getConversations();</span>
<a href="#l28.264"></a><span id="l28.264" class="difflineplus">+        while (conversations.hasMoreElements()) {</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineplus">+          let aConv = conversations.getNext();</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineplus">+          OTRUI.initConv(aConv);</span>
<a href="#l28.267"></a><span id="l28.267" class="difflineplus">+        }</span>
<a href="#l28.268"></a><span id="l28.268" class="difflineplus">+        OTRUI.addMenuObserver();</span>
<a href="#l28.269"></a><span id="l28.269"> </span>
<a href="#l28.270"></a><span id="l28.270" class="difflineminus">-      ChromeUtils.idleDispatch(OTRUI.genMissingKeys);</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineminus">-    }).catch(function(err) {</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineminus">-      // console.log(&quot;===&gt; &quot; + err + &quot;\n&quot;);</span>
<a href="#l28.273"></a><span id="l28.273" class="difflineminus">-      throw err;</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineminus">-    });</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineplus">+        ChromeUtils.idleDispatch(OTRUI.genMissingKeys);</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineplus">+      })</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineplus">+      .catch(function(err) {</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineplus">+        // console.log(&quot;===&gt; &quot; + err + &quot;\n&quot;);</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineplus">+        throw err;</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineplus">+      });</span>
<a href="#l28.281"></a><span id="l28.281">   },</span>
<a href="#l28.282"></a><span id="l28.282"> </span>
<a href="#l28.283"></a><span id="l28.283">   disconnect(aConv) {</span>
<a href="#l28.284"></a><span id="l28.284">     if (aConv) {</span>
<a href="#l28.285"></a><span id="l28.285">       return OTR.disconnect(aConv, true);</span>
<a href="#l28.286"></a><span id="l28.286">     }</span>
<a href="#l28.287"></a><span id="l28.287">     let allGood = true;</span>
<a href="#l28.288"></a><span id="l28.288">     let conversations = Services.conversations.getConversations();</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineat">@@ -312,35 +336,35 @@ var OTRUI = {</span>
<a href="#l28.290"></a><span id="l28.290">     if (context) {</span>
<a href="#l28.291"></a><span id="l28.291">       OTRUI.hideUserNotifications(context);</span>
<a href="#l28.292"></a><span id="l28.292">     } else {</span>
<a href="#l28.293"></a><span id="l28.293">       OTRUI.hideAllNotifications();</span>
<a href="#l28.294"></a><span id="l28.294">     }</span>
<a href="#l28.295"></a><span id="l28.295">   },</span>
<a href="#l28.296"></a><span id="l28.296"> </span>
<a href="#l28.297"></a><span id="l28.297">   sendSystemAlert(uiConv, conv, bundleId) {</span>
<a href="#l28.298"></a><span id="l28.298" class="difflineminus">-    uiConv.systemMessage(_strArgs(bundleId, {name: conv.normalizedName}));</span>
<a href="#l28.299"></a><span id="l28.299" class="difflineplus">+    uiConv.systemMessage(_strArgs(bundleId, { name: conv.normalizedName }));</span>
<a href="#l28.300"></a><span id="l28.300">   },</span>
<a href="#l28.301"></a><span id="l28.301"> </span>
<a href="#l28.302"></a><span id="l28.302">   setNotificationBox(notificationbox) {</span>
<a href="#l28.303"></a><span id="l28.303">     this.globalBox = notificationbox;</span>
<a href="#l28.304"></a><span id="l28.304">   },</span>
<a href="#l28.305"></a><span id="l28.305"> </span>
<a href="#l28.306"></a><span id="l28.306" class="difflineminus">-/*</span>
<a href="#l28.307"></a><span id="l28.307" class="difflineminus">- *  possible states:</span>
<a href="#l28.308"></a><span id="l28.308" class="difflineminus">- *    tab isn't a 1:1, isChat == true</span>
<a href="#l28.309"></a><span id="l28.309" class="difflineminus">- *      then OTR isn't possible, hide the button</span>
<a href="#l28.310"></a><span id="l28.310" class="difflineminus">- *    tab is a 1:1, isChat == false</span>
<a href="#l28.311"></a><span id="l28.311" class="difflineminus">- *      no conversation active, uiConv cannot be found</span>
<a href="#l28.312"></a><span id="l28.312" class="difflineminus">- *        then OTR isn't possible YET, hide the button</span>
<a href="#l28.313"></a><span id="l28.313" class="difflineminus">- *      conversation active, uiConv found</span>
<a href="#l28.314"></a><span id="l28.314" class="difflineminus">- *        disconnected?</span>
<a href="#l28.315"></a><span id="l28.315" class="difflineminus">- *          could the other side come back? should we keep the button?</span>
<a href="#l28.316"></a><span id="l28.316" class="difflineminus">- *        set the state based on the OTR library state</span>
<a href="#l28.317"></a><span id="l28.317" class="difflineminus">- */</span>
<a href="#l28.318"></a><span id="l28.318" class="difflineplus">+  /*</span>
<a href="#l28.319"></a><span id="l28.319" class="difflineplus">+   *  possible states:</span>
<a href="#l28.320"></a><span id="l28.320" class="difflineplus">+   *    tab isn't a 1:1, isChat == true</span>
<a href="#l28.321"></a><span id="l28.321" class="difflineplus">+   *      then OTR isn't possible, hide the button</span>
<a href="#l28.322"></a><span id="l28.322" class="difflineplus">+   *    tab is a 1:1, isChat == false</span>
<a href="#l28.323"></a><span id="l28.323" class="difflineplus">+   *      no conversation active, uiConv cannot be found</span>
<a href="#l28.324"></a><span id="l28.324" class="difflineplus">+   *        then OTR isn't possible YET, hide the button</span>
<a href="#l28.325"></a><span id="l28.325" class="difflineplus">+   *      conversation active, uiConv found</span>
<a href="#l28.326"></a><span id="l28.326" class="difflineplus">+   *        disconnected?</span>
<a href="#l28.327"></a><span id="l28.327" class="difflineplus">+   *          could the other side come back? should we keep the button?</span>
<a href="#l28.328"></a><span id="l28.328" class="difflineplus">+   *        set the state based on the OTR library state</span>
<a href="#l28.329"></a><span id="l28.329" class="difflineplus">+   */</span>
<a href="#l28.330"></a><span id="l28.330"> </span>
<a href="#l28.331"></a><span id="l28.331">   addButton(aObject) {</span>
<a href="#l28.332"></a><span id="l28.332">     this.globalDoc = aObject.ownerDocument;</span>
<a href="#l28.333"></a><span id="l28.333">     let _conv = aObject._conv;</span>
<a href="#l28.334"></a><span id="l28.334">     OTRUI.visibleConv = _conv;</span>
<a href="#l28.335"></a><span id="l28.335">     OTRUI.setMsgState(_conv, null, this.globalDoc, true);</span>
<a href="#l28.336"></a><span id="l28.336">   },</span>
<a href="#l28.337"></a><span id="l28.337"> </span>
<a href="#l28.338"></a><span id="l28.338" class="difflineat">@@ -359,18 +383,18 @@ var OTRUI = {</span>
<a href="#l28.339"></a><span id="l28.339">   updateOTRButton(_conv) {</span>
<a href="#l28.340"></a><span id="l28.340">     if (!OTR.libLoaded) {</span>
<a href="#l28.341"></a><span id="l28.341">       return;</span>
<a href="#l28.342"></a><span id="l28.342">     }</span>
<a href="#l28.343"></a><span id="l28.343">     if (!this.globalDoc) {</span>
<a href="#l28.344"></a><span id="l28.344">       return;</span>
<a href="#l28.345"></a><span id="l28.345">     }</span>
<a href="#l28.346"></a><span id="l28.346">     OTRUI.visibleConv = _conv;</span>
<a href="#l28.347"></a><span id="l28.347" class="difflineminus">-    let convBinding =</span>
<a href="#l28.348"></a><span id="l28.348" class="difflineminus">-      this.globalDoc.getElementById(&quot;conversationsDeck&quot;).selectedPanel;</span>
<a href="#l28.349"></a><span id="l28.349" class="difflineplus">+    let convBinding = this.globalDoc.getElementById(&quot;conversationsDeck&quot;)</span>
<a href="#l28.350"></a><span id="l28.350" class="difflineplus">+      .selectedPanel;</span>
<a href="#l28.351"></a><span id="l28.351">     if (convBinding &amp;&amp; convBinding._conv &amp;&amp; convBinding._conv.target) {</span>
<a href="#l28.352"></a><span id="l28.352">       OTRUI.setMsgState(_conv, null, this.globalDoc, false);</span>
<a href="#l28.353"></a><span id="l28.353">     } else {</span>
<a href="#l28.354"></a><span id="l28.354">       this.hideOTRButton();</span>
<a href="#l28.355"></a><span id="l28.355">     }</span>
<a href="#l28.356"></a><span id="l28.356">   },</span>
<a href="#l28.357"></a><span id="l28.357"> </span>
<a href="#l28.358"></a><span id="l28.358">   // set msg state on toolbar button</span>
<a href="#l28.359"></a><span id="l28.359" class="difflineat">@@ -408,49 +432,51 @@ var OTRUI = {</span>
<a href="#l28.360"></a><span id="l28.360">       }</span>
<a href="#l28.361"></a><span id="l28.361">       if (addSystemMessage) {</span>
<a href="#l28.362"></a><span id="l28.362">         let trust = OTRUI.getTrustSettings(context);</span>
<a href="#l28.363"></a><span id="l28.363">         let id = &quot;state-&quot; + trust.class;</span>
<a href="#l28.364"></a><span id="l28.364">         let msg;</span>
<a href="#l28.365"></a><span id="l28.365">         if (OTR.trust(context) == OTR.trustState.TRUST_NOT_PRIVATE) {</span>
<a href="#l28.366"></a><span id="l28.366">           msg = syncL10n.formatValueSync(id);</span>
<a href="#l28.367"></a><span id="l28.367">         } else {</span>
<a href="#l28.368"></a><span id="l28.368" class="difflineminus">-          msg = syncL10n.formatValueSync(id, {name: context.username});</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineplus">+          msg = syncL10n.formatValueSync(id, { name: context.username });</span>
<a href="#l28.370"></a><span id="l28.370">         }</span>
<a href="#l28.371"></a><span id="l28.371">         uiConv.systemMessage(msg);</span>
<a href="#l28.372"></a><span id="l28.372">       }</span>
<a href="#l28.373"></a><span id="l28.373">     } catch (e) {</span>
<a href="#l28.374"></a><span id="l28.374">       OTRUI.noOtrPossible(otrContainer, context);</span>
<a href="#l28.375"></a><span id="l28.375">       return;</span>
<a href="#l28.376"></a><span id="l28.376">     }</span>
<a href="#l28.377"></a><span id="l28.377"> </span>
<a href="#l28.378"></a><span id="l28.378">     otrContainer.hidden = false;</span>
<a href="#l28.379"></a><span id="l28.379">     let otrStart = doc.querySelector(&quot;.otr-start&quot;);</span>
<a href="#l28.380"></a><span id="l28.380">     let otrEnd = doc.querySelector(&quot;.otr-end&quot;);</span>
<a href="#l28.381"></a><span id="l28.381">     let otrAuth = doc.querySelector(&quot;.otr-auth&quot;);</span>
<a href="#l28.382"></a><span id="l28.382">     let trust = OTRUI.getTrustSettings(context);</span>
<a href="#l28.383"></a><span id="l28.383" class="difflineminus">-    otrButton.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l28.384"></a><span id="l28.384" class="difflineminus">-      _strArgs(&quot;state-&quot; + trust.class, {name: context.username}));</span>
<a href="#l28.385"></a><span id="l28.385" class="difflineminus">-    otrButton.setAttribute(&quot;label&quot;,</span>
<a href="#l28.386"></a><span id="l28.386" class="difflineminus">-      _str(&quot;state-&quot; + trust.class + &quot;-label&quot;));</span>
<a href="#l28.387"></a><span id="l28.387" class="difflineplus">+    otrButton.setAttribute(</span>
<a href="#l28.388"></a><span id="l28.388" class="difflineplus">+      &quot;tooltiptext&quot;,</span>
<a href="#l28.389"></a><span id="l28.389" class="difflineplus">+      _strArgs(&quot;state-&quot; + trust.class, { name: context.username })</span>
<a href="#l28.390"></a><span id="l28.390" class="difflineplus">+    );</span>
<a href="#l28.391"></a><span id="l28.391" class="difflineplus">+    otrButton.setAttribute(&quot;label&quot;, _str(&quot;state-&quot; + trust.class + &quot;-label&quot;));</span>
<a href="#l28.392"></a><span id="l28.392">     otrButton.className = &quot;otr-button otr-&quot; + trust.class;</span>
<a href="#l28.393"></a><span id="l28.393">     otrStart.setAttribute(&quot;label&quot;, trust.startLabel);</span>
<a href="#l28.394"></a><span id="l28.394">     otrStart.setAttribute(&quot;disabled&quot;, trust.disableStart);</span>
<a href="#l28.395"></a><span id="l28.395">     otrEnd.setAttribute(&quot;disabled&quot;, trust.disableEnd);</span>
<a href="#l28.396"></a><span id="l28.396">     otrAuth.setAttribute(&quot;label&quot;, trust.authLabel);</span>
<a href="#l28.397"></a><span id="l28.397">     otrAuth.setAttribute(&quot;disabled&quot;, trust.disableAuth);</span>
<a href="#l28.398"></a><span id="l28.398">     OTRUI.hideAllNotifications();</span>
<a href="#l28.399"></a><span id="l28.399">     OTRUI.showUserNotifications(context);</span>
<a href="#l28.400"></a><span id="l28.400">   },</span>
<a href="#l28.401"></a><span id="l28.401"> </span>
<a href="#l28.402"></a><span id="l28.402">   alertTrust(context) {</span>
<a href="#l28.403"></a><span id="l28.403">     let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l28.404"></a><span id="l28.404">     let trust = OTRUI.getTrustSettings(context);</span>
<a href="#l28.405"></a><span id="l28.405">     uiConv.systemMessage(</span>
<a href="#l28.406"></a><span id="l28.406" class="difflineminus">-      _strArgs(&quot;afterauth-&quot; + trust.class, {name: context.username}));</span>
<a href="#l28.407"></a><span id="l28.407" class="difflineplus">+      _strArgs(&quot;afterauth-&quot; + trust.class, { name: context.username })</span>
<a href="#l28.408"></a><span id="l28.408" class="difflineplus">+    );</span>
<a href="#l28.409"></a><span id="l28.409">   },</span>
<a href="#l28.410"></a><span id="l28.410"> </span>
<a href="#l28.411"></a><span id="l28.411">   getTrustSettings(context) {</span>
<a href="#l28.412"></a><span id="l28.412">     let result = trustMap.get(OTR.trust(context));</span>
<a href="#l28.413"></a><span id="l28.413">     return result;</span>
<a href="#l28.414"></a><span id="l28.414">   },</span>
<a href="#l28.415"></a><span id="l28.415"> </span>
<a href="#l28.416"></a><span id="l28.416">   askAuth(aObject) {</span>
<a href="#l28.417"></a><span id="l28.417" class="difflineat">@@ -467,18 +493,20 @@ var OTRUI = {</span>
<a href="#l28.418"></a><span id="l28.418">   closeUnverified(context) {</span>
<a href="#l28.419"></a><span id="l28.419">     let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l28.420"></a><span id="l28.420">     if (!uiConv) {</span>
<a href="#l28.421"></a><span id="l28.421">       return;</span>
<a href="#l28.422"></a><span id="l28.422">     }</span>
<a href="#l28.423"></a><span id="l28.423"> </span>
<a href="#l28.424"></a><span id="l28.424">     let notifications = this.globalBox.allNotifications;</span>
<a href="#l28.425"></a><span id="l28.425">     for (let i = notifications.length - 1; i &gt;= 0; i--) {</span>
<a href="#l28.426"></a><span id="l28.426" class="difflineminus">-      if (context.username == notifications[i].getAttribute(&quot;user&quot;) &amp;&amp;</span>
<a href="#l28.427"></a><span id="l28.427" class="difflineminus">-          notifications[i].getAttribute(&quot;value&quot;) == AUTH_STATUS_UNVERIFIED) {</span>
<a href="#l28.428"></a><span id="l28.428" class="difflineplus">+      if (</span>
<a href="#l28.429"></a><span id="l28.429" class="difflineplus">+        context.username == notifications[i].getAttribute(&quot;user&quot;) &amp;&amp;</span>
<a href="#l28.430"></a><span id="l28.430" class="difflineplus">+        notifications[i].getAttribute(&quot;value&quot;) == AUTH_STATUS_UNVERIFIED</span>
<a href="#l28.431"></a><span id="l28.431" class="difflineplus">+      ) {</span>
<a href="#l28.432"></a><span id="l28.432">         notifications[i].close();</span>
<a href="#l28.433"></a><span id="l28.433">       }</span>
<a href="#l28.434"></a><span id="l28.434">     }</span>
<a href="#l28.435"></a><span id="l28.435">   },</span>
<a href="#l28.436"></a><span id="l28.436"> </span>
<a href="#l28.437"></a><span id="l28.437">   hideUserNotifications(context) {</span>
<a href="#l28.438"></a><span id="l28.438">     let notifications = this.globalBox.allNotifications;</span>
<a href="#l28.439"></a><span id="l28.439">     for (let i = notifications.length - 1; i &gt;= 0; i--) {</span>
<a href="#l28.440"></a><span id="l28.440" class="difflineat">@@ -507,33 +535,47 @@ var OTRUI = {</span>
<a href="#l28.441"></a><span id="l28.441">   notifyUnverified(context, seen) {</span>
<a href="#l28.442"></a><span id="l28.442">     let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l28.443"></a><span id="l28.443">     if (!uiConv) {</span>
<a href="#l28.444"></a><span id="l28.444">       return;</span>
<a href="#l28.445"></a><span id="l28.445">     }</span>
<a href="#l28.446"></a><span id="l28.446"> </span>
<a href="#l28.447"></a><span id="l28.447">     let window = this.globalDoc.defaultView;</span>
<a href="#l28.448"></a><span id="l28.448"> </span>
<a href="#l28.449"></a><span id="l28.449" class="difflineminus">-    let msg = _strArgs(&quot;finger-&quot; + seen, {name: context.username});</span>
<a href="#l28.450"></a><span id="l28.450" class="difflineminus">-    let buttons = [{</span>
<a href="#l28.451"></a><span id="l28.451" class="difflineminus">-      label: _str(&quot;finger-verify&quot;),</span>
<a href="#l28.452"></a><span id="l28.452" class="difflineminus">-      accessKey: _str(&quot;finger-verify-accessKey&quot;),</span>
<a href="#l28.453"></a><span id="l28.453" class="difflineminus">-      callback() {</span>
<a href="#l28.454"></a><span id="l28.454" class="difflineminus">-        let name = uiConv.target.normalizedName;</span>
<a href="#l28.455"></a><span id="l28.455" class="difflineminus">-        OTRUI.openAuth(window, name, &quot;start&quot;, uiConv);</span>
<a href="#l28.456"></a><span id="l28.456" class="difflineminus">-        // prevent closing of notification bar when the button is hit</span>
<a href="#l28.457"></a><span id="l28.457" class="difflineminus">-        return true;</span>
<a href="#l28.458"></a><span id="l28.458" class="difflineplus">+    let msg = _strArgs(&quot;finger-&quot; + seen, { name: context.username });</span>
<a href="#l28.459"></a><span id="l28.459" class="difflineplus">+    let buttons = [</span>
<a href="#l28.460"></a><span id="l28.460" class="difflineplus">+      {</span>
<a href="#l28.461"></a><span id="l28.461" class="difflineplus">+        label: _str(&quot;finger-verify&quot;),</span>
<a href="#l28.462"></a><span id="l28.462" class="difflineplus">+        accessKey: _str(&quot;finger-verify-accessKey&quot;),</span>
<a href="#l28.463"></a><span id="l28.463" class="difflineplus">+        callback() {</span>
<a href="#l28.464"></a><span id="l28.464" class="difflineplus">+          let name = uiConv.target.normalizedName;</span>
<a href="#l28.465"></a><span id="l28.465" class="difflineplus">+          OTRUI.openAuth(window, name, &quot;start&quot;, uiConv);</span>
<a href="#l28.466"></a><span id="l28.466" class="difflineplus">+          // prevent closing of notification bar when the button is hit</span>
<a href="#l28.467"></a><span id="l28.467" class="difflineplus">+          return true;</span>
<a href="#l28.468"></a><span id="l28.468" class="difflineplus">+        },</span>
<a href="#l28.469"></a><span id="l28.469">       },</span>
<a href="#l28.470"></a><span id="l28.470" class="difflineminus">-    }];</span>
<a href="#l28.471"></a><span id="l28.471" class="difflineplus">+    ];</span>
<a href="#l28.472"></a><span id="l28.472"> </span>
<a href="#l28.473"></a><span id="l28.473">     let priority = this.globalBox.PRIORITY_WARNING_MEDIUM;</span>
<a href="#l28.474"></a><span id="l28.474" class="difflineminus">-    this.globalBox.appendNotification(msg, context.username, null, priority, buttons, null);</span>
<a href="#l28.475"></a><span id="l28.475" class="difflineplus">+    this.globalBox.appendNotification(</span>
<a href="#l28.476"></a><span id="l28.476" class="difflineplus">+      msg,</span>
<a href="#l28.477"></a><span id="l28.477" class="difflineplus">+      context.username,</span>
<a href="#l28.478"></a><span id="l28.478" class="difflineplus">+      null,</span>
<a href="#l28.479"></a><span id="l28.479" class="difflineplus">+      priority,</span>
<a href="#l28.480"></a><span id="l28.480" class="difflineplus">+      buttons,</span>
<a href="#l28.481"></a><span id="l28.481" class="difflineplus">+      null</span>
<a href="#l28.482"></a><span id="l28.482" class="difflineplus">+    );</span>
<a href="#l28.483"></a><span id="l28.483"> </span>
<a href="#l28.484"></a><span id="l28.484">     let verifyTitle = syncL10n.formatValueSync(&quot;verify-title&quot;);</span>
<a href="#l28.485"></a><span id="l28.485" class="difflineminus">-    this.updateNotificationUI(context, verifyTitle, context.username, AUTH_STATUS_UNVERIFIED);</span>
<a href="#l28.486"></a><span id="l28.486" class="difflineplus">+    this.updateNotificationUI(</span>
<a href="#l28.487"></a><span id="l28.487" class="difflineplus">+      context,</span>
<a href="#l28.488"></a><span id="l28.488" class="difflineplus">+      verifyTitle,</span>
<a href="#l28.489"></a><span id="l28.489" class="difflineplus">+      context.username,</span>
<a href="#l28.490"></a><span id="l28.490" class="difflineplus">+      AUTH_STATUS_UNVERIFIED</span>
<a href="#l28.491"></a><span id="l28.491" class="difflineplus">+    );</span>
<a href="#l28.492"></a><span id="l28.492"> </span>
<a href="#l28.493"></a><span id="l28.493">     if (!this.visibleConv) {</span>
<a href="#l28.494"></a><span id="l28.494">       return;</span>
<a href="#l28.495"></a><span id="l28.495">     }</span>
<a href="#l28.496"></a><span id="l28.496"> </span>
<a href="#l28.497"></a><span id="l28.497">     if (context.username !== this.visibleConv.normalizedName) {</span>
<a href="#l28.498"></a><span id="l28.498">       this.hideUserNotifications(context);</span>
<a href="#l28.499"></a><span id="l28.499">     }</span>
<a href="#l28.500"></a><span id="l28.500" class="difflineat">@@ -562,33 +604,38 @@ var OTRUI = {</span>
<a href="#l28.501"></a><span id="l28.501">     top.classList.add(&quot;otr-notification-header&quot;);</span>
<a href="#l28.502"></a><span id="l28.502">     top.appendChild(notification.messageImage);</span>
<a href="#l28.503"></a><span id="l28.503">     top.appendChild(title);</span>
<a href="#l28.504"></a><span id="l28.504">     top.appendChild(close);</span>
<a href="#l28.505"></a><span id="l28.505">     notification.insertBefore(top, notification.messageDetails);</span>
<a href="#l28.506"></a><span id="l28.506"> </span>
<a href="#l28.507"></a><span id="l28.507">     let bottom = this.globalDoc.createXULElement(&quot;hbox&quot;);</span>
<a href="#l28.508"></a><span id="l28.508">     bottom.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l28.509"></a><span id="l28.509" class="difflineminus">-    bottom.setAttribute(&quot;oncommand&quot;, &quot;this.parentNode._doButtonCommand(event);&quot;);</span>
<a href="#l28.510"></a><span id="l28.510" class="difflineplus">+    bottom.setAttribute(</span>
<a href="#l28.511"></a><span id="l28.511" class="difflineplus">+      &quot;oncommand&quot;,</span>
<a href="#l28.512"></a><span id="l28.512" class="difflineplus">+      &quot;this.parentNode._doButtonCommand(event);&quot;</span>
<a href="#l28.513"></a><span id="l28.513" class="difflineplus">+    );</span>
<a href="#l28.514"></a><span id="l28.514">     bottom.classList.add(&quot;otr-notification-footer&quot;);</span>
<a href="#l28.515"></a><span id="l28.515"> </span>
<a href="#l28.516"></a><span id="l28.516" class="difflineminus">-    notification.querySelectorAll(&quot;button&quot;).forEach((e) =&gt; {</span>
<a href="#l28.517"></a><span id="l28.517" class="difflineplus">+    notification.querySelectorAll(&quot;button&quot;).forEach(e =&gt; {</span>
<a href="#l28.518"></a><span id="l28.518">       bottom.appendChild(e);</span>
<a href="#l28.519"></a><span id="l28.519">     });</span>
<a href="#l28.520"></a><span id="l28.520"> </span>
<a href="#l28.521"></a><span id="l28.521">     notification.appendChild(bottom);</span>
<a href="#l28.522"></a><span id="l28.522">   },</span>
<a href="#l28.523"></a><span id="l28.523"> </span>
<a href="#l28.524"></a><span id="l28.524">   closeVerification(context) {</span>
<a href="#l28.525"></a><span id="l28.525">     let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l28.526"></a><span id="l28.526">     if (!uiConv) {</span>
<a href="#l28.527"></a><span id="l28.527">       return;</span>
<a href="#l28.528"></a><span id="l28.528">     }</span>
<a href="#l28.529"></a><span id="l28.529"> </span>
<a href="#l28.530"></a><span id="l28.530" class="difflineminus">-    let prevNotification = OTRUI.globalBox.getNotificationWithValue(context.username);</span>
<a href="#l28.531"></a><span id="l28.531" class="difflineplus">+    let prevNotification = OTRUI.globalBox.getNotificationWithValue(</span>
<a href="#l28.532"></a><span id="l28.532" class="difflineplus">+      context.username</span>
<a href="#l28.533"></a><span id="l28.533" class="difflineplus">+    );</span>
<a href="#l28.534"></a><span id="l28.534">     if (prevNotification) {</span>
<a href="#l28.535"></a><span id="l28.535">       prevNotification.close();</span>
<a href="#l28.536"></a><span id="l28.536">     }</span>
<a href="#l28.537"></a><span id="l28.537">   },</span>
<a href="#l28.538"></a><span id="l28.538"> </span>
<a href="#l28.539"></a><span id="l28.539">   notifyVerification(context, key, cancelable) {</span>
<a href="#l28.540"></a><span id="l28.540">     let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l28.541"></a><span id="l28.541">     if (!uiConv) {</span>
<a href="#l28.542"></a><span id="l28.542" class="difflineat">@@ -598,30 +645,39 @@ var OTRUI = {</span>
<a href="#l28.543"></a><span id="l28.543">     // TODO: maybe update the .label property on the notification instead</span>
<a href="#l28.544"></a><span id="l28.544">     // of closing it ... although, buttons need to be updated too.</span>
<a href="#l28.545"></a><span id="l28.545">     OTRUI.closeVerification(context);</span>
<a href="#l28.546"></a><span id="l28.546"> </span>
<a href="#l28.547"></a><span id="l28.547">     let msg = authLabelMap.get(key);</span>
<a href="#l28.548"></a><span id="l28.548">     let typeTitle = authTitleMap.get(key);</span>
<a href="#l28.549"></a><span id="l28.549">     let buttons = [];</span>
<a href="#l28.550"></a><span id="l28.550">     if (cancelable) {</span>
<a href="#l28.551"></a><span id="l28.551" class="difflineminus">-      buttons = [{</span>
<a href="#l28.552"></a><span id="l28.552" class="difflineminus">-        label: _str(&quot;auth-cancel&quot;),</span>
<a href="#l28.553"></a><span id="l28.553" class="difflineminus">-        accessKey: _str(&quot;auth-cancelAccessKey&quot;),</span>
<a href="#l28.554"></a><span id="l28.554" class="difflineminus">-        callback() {</span>
<a href="#l28.555"></a><span id="l28.555" class="difflineminus">-          let context = OTR.getContext(uiConv.target);</span>
<a href="#l28.556"></a><span id="l28.556" class="difflineminus">-          OTR.abortSMP(context);</span>
<a href="#l28.557"></a><span id="l28.557" class="difflineplus">+      buttons = [</span>
<a href="#l28.558"></a><span id="l28.558" class="difflineplus">+        {</span>
<a href="#l28.559"></a><span id="l28.559" class="difflineplus">+          label: _str(&quot;auth-cancel&quot;),</span>
<a href="#l28.560"></a><span id="l28.560" class="difflineplus">+          accessKey: _str(&quot;auth-cancelAccessKey&quot;),</span>
<a href="#l28.561"></a><span id="l28.561" class="difflineplus">+          callback() {</span>
<a href="#l28.562"></a><span id="l28.562" class="difflineplus">+            let context = OTR.getContext(uiConv.target);</span>
<a href="#l28.563"></a><span id="l28.563" class="difflineplus">+            OTR.abortSMP(context);</span>
<a href="#l28.564"></a><span id="l28.564" class="difflineplus">+          },</span>
<a href="#l28.565"></a><span id="l28.565">         },</span>
<a href="#l28.566"></a><span id="l28.566" class="difflineminus">-      }];</span>
<a href="#l28.567"></a><span id="l28.567" class="difflineplus">+      ];</span>
<a href="#l28.568"></a><span id="l28.568">     }</span>
<a href="#l28.569"></a><span id="l28.569"> </span>
<a href="#l28.570"></a><span id="l28.570">     // higher priority to overlay the current notifyUnverified</span>
<a href="#l28.571"></a><span id="l28.571">     let priority = this.globalBox.PRIORITY_WARNING_HIGH;</span>
<a href="#l28.572"></a><span id="l28.572">     OTRUI.closeUnverified(context);</span>
<a href="#l28.573"></a><span id="l28.573" class="difflineminus">-    this.globalBox.appendNotification(msg, context.username, null, priority, buttons, null);</span>
<a href="#l28.574"></a><span id="l28.574" class="difflineplus">+    this.globalBox.appendNotification(</span>
<a href="#l28.575"></a><span id="l28.575" class="difflineplus">+      msg,</span>
<a href="#l28.576"></a><span id="l28.576" class="difflineplus">+      context.username,</span>
<a href="#l28.577"></a><span id="l28.577" class="difflineplus">+      null,</span>
<a href="#l28.578"></a><span id="l28.578" class="difflineplus">+      priority,</span>
<a href="#l28.579"></a><span id="l28.579" class="difflineplus">+      buttons,</span>
<a href="#l28.580"></a><span id="l28.580" class="difflineplus">+      null</span>
<a href="#l28.581"></a><span id="l28.581" class="difflineplus">+    );</span>
<a href="#l28.582"></a><span id="l28.582"> </span>
<a href="#l28.583"></a><span id="l28.583">     this.updateNotificationUI(context, typeTitle, context.username, key);</span>
<a href="#l28.584"></a><span id="l28.584">   },</span>
<a href="#l28.585"></a><span id="l28.585"> </span>
<a href="#l28.586"></a><span id="l28.586">   updateAuth(aObj) {</span>
<a href="#l28.587"></a><span id="l28.587">     // let uiConv = OTR.getUIConvFromContext(aObj.context);</span>
<a href="#l28.588"></a><span id="l28.588">     if (!aObj.progress) {</span>
<a href="#l28.589"></a><span id="l28.589">       OTRUI.closeAuth(aObj.context);</span>
<a href="#l28.590"></a><span id="l28.590" class="difflineat">@@ -649,43 +705,50 @@ var OTRUI = {</span>
<a href="#l28.591"></a><span id="l28.591">     }</span>
<a href="#l28.592"></a><span id="l28.592">   },</span>
<a href="#l28.593"></a><span id="l28.593"> </span>
<a href="#l28.594"></a><span id="l28.594">   onAccountCreated(acc) {</span>
<a href="#l28.595"></a><span id="l28.595">     let account = acc.normalizedName;</span>
<a href="#l28.596"></a><span id="l28.596">     let protocol = acc.protocol.normalizedName;</span>
<a href="#l28.597"></a><span id="l28.597">     Promise.resolve();</span>
<a href="#l28.598"></a><span id="l28.598">     if (OTR.privateKeyFingerprint(account, protocol) === null) {</span>
<a href="#l28.599"></a><span id="l28.599" class="difflineminus">-      OTR.generatePrivateKey(account, protocol)</span>
<a href="#l28.600"></a><span id="l28.600" class="difflineminus">-         .catch(OTRUI.reportKeyGenFailure);</span>
<a href="#l28.601"></a><span id="l28.601" class="difflineplus">+      OTR.generatePrivateKey(account, protocol).catch(</span>
<a href="#l28.602"></a><span id="l28.602" class="difflineplus">+        OTRUI.reportKeyGenFailure</span>
<a href="#l28.603"></a><span id="l28.603" class="difflineplus">+      );</span>
<a href="#l28.604"></a><span id="l28.604">     }</span>
<a href="#l28.605"></a><span id="l28.605">   },</span>
<a href="#l28.606"></a><span id="l28.606"> </span>
<a href="#l28.607"></a><span id="l28.607">   contactWrapper(contact) {</span>
<a href="#l28.608"></a><span id="l28.608">     // If the conversation already started.</span>
<a href="#l28.609"></a><span id="l28.609">     if (contact.buddy) {</span>
<a href="#l28.610"></a><span id="l28.610">       return {</span>
<a href="#l28.611"></a><span id="l28.611">         account: contact.buddy.normalizedName,</span>
<a href="#l28.612"></a><span id="l28.612">         protocol: contact.buddy.buddy.protocol.normalizedName,</span>
<a href="#l28.613"></a><span id="l28.613">         screenname: contact.buddy.userName,</span>
<a href="#l28.614"></a><span id="l28.614">       };</span>
<a href="#l28.615"></a><span id="l28.615">     }</span>
<a href="#l28.616"></a><span id="l28.616"> </span>
<a href="#l28.617"></a><span id="l28.617">     // For online and offline contacts without an open conversation.</span>
<a href="#l28.618"></a><span id="l28.618">     return {</span>
<a href="#l28.619"></a><span id="l28.619" class="difflineminus">-      account: contact.preferredBuddy.preferredAccountBuddy.account.normalizedName,</span>
<a href="#l28.620"></a><span id="l28.620" class="difflineplus">+      account:</span>
<a href="#l28.621"></a><span id="l28.621" class="difflineplus">+        contact.preferredBuddy.preferredAccountBuddy.account.normalizedName,</span>
<a href="#l28.622"></a><span id="l28.622">       protocol: contact.preferredBuddy.protocol.normalizedName,</span>
<a href="#l28.623"></a><span id="l28.623">       screenname: contact.preferredBuddy.preferredAccountBuddy.userName,</span>
<a href="#l28.624"></a><span id="l28.624">     };</span>
<a href="#l28.625"></a><span id="l28.625">   },</span>
<a href="#l28.626"></a><span id="l28.626"> </span>
<a href="#l28.627"></a><span id="l28.627">   onContactAdded(contact) {</span>
<a href="#l28.628"></a><span id="l28.628">     let args = OTRUI.contactWrapper(contact);</span>
<a href="#l28.629"></a><span id="l28.629" class="difflineminus">-    if (OTR.getFingerprintsForRecipient(args.account,</span>
<a href="#l28.630"></a><span id="l28.630" class="difflineminus">-        args.protocol, args.screenname).length &gt; 0) {</span>
<a href="#l28.631"></a><span id="l28.631" class="difflineplus">+    if (</span>
<a href="#l28.632"></a><span id="l28.632" class="difflineplus">+      OTR.getFingerprintsForRecipient(</span>
<a href="#l28.633"></a><span id="l28.633" class="difflineplus">+        args.account,</span>
<a href="#l28.634"></a><span id="l28.634" class="difflineplus">+        args.protocol,</span>
<a href="#l28.635"></a><span id="l28.635" class="difflineplus">+        args.screenname</span>
<a href="#l28.636"></a><span id="l28.636" class="difflineplus">+      ).length &gt; 0</span>
<a href="#l28.637"></a><span id="l28.637" class="difflineplus">+    ) {</span>
<a href="#l28.638"></a><span id="l28.638">       return;</span>
<a href="#l28.639"></a><span id="l28.639">     }</span>
<a href="#l28.640"></a><span id="l28.640">     args.wrappedJSObject = args;</span>
<a href="#l28.641"></a><span id="l28.641">     let features = &quot;chrome,modal,centerscreen,resizable=no,minimizable=no&quot;;</span>
<a href="#l28.642"></a><span id="l28.642">     Services.ww.openWindow(null, OTR_ADD_FINGER_DIALOG_URL, &quot;&quot;, features, args);</span>
<a href="#l28.643"></a><span id="l28.643">   },</span>
<a href="#l28.644"></a><span id="l28.644"> </span>
<a href="#l28.645"></a><span id="l28.645">   observe(aObject, aTopic, aMsg) {</span>
<a href="#l28.646"></a><span id="l28.646" class="difflineat">@@ -716,27 +779,31 @@ var OTRUI = {</span>
<a href="#l28.647"></a><span id="l28.647">       //  break;</span>
<a href="#l28.648"></a><span id="l28.648">       case &quot;prpl-quit&quot;:</span>
<a href="#l28.649"></a><span id="l28.649">         OTRUI.disconnect(null);</span>
<a href="#l28.650"></a><span id="l28.650">         break;</span>
<a href="#l28.651"></a><span id="l28.651">       case &quot;domwindowopened&quot;:</span>
<a href="#l28.652"></a><span id="l28.652">         OTRUI.addMenus(aObject);</span>
<a href="#l28.653"></a><span id="l28.653">         break;</span>
<a href="#l28.654"></a><span id="l28.654">       case &quot;otr:generate&quot;: {</span>
<a href="#l28.655"></a><span id="l28.655" class="difflineminus">-        let result =</span>
<a href="#l28.656"></a><span id="l28.656" class="difflineminus">-          OTR.generatePrivateKeySync(aObject.account, aObject.protocol);</span>
<a href="#l28.657"></a><span id="l28.657" class="difflineplus">+        let result = OTR.generatePrivateKeySync(</span>
<a href="#l28.658"></a><span id="l28.658" class="difflineplus">+          aObject.account,</span>
<a href="#l28.659"></a><span id="l28.659" class="difflineplus">+          aObject.protocol</span>
<a href="#l28.660"></a><span id="l28.660" class="difflineplus">+        );</span>
<a href="#l28.661"></a><span id="l28.661">         if (result != null) {</span>
<a href="#l28.662"></a><span id="l28.662">           OTRUI.reportKeyGenFailure(result);</span>
<a href="#l28.663"></a><span id="l28.663">         }</span>
<a href="#l28.664"></a><span id="l28.664">         break;</span>
<a href="#l28.665"></a><span id="l28.665">       }</span>
<a href="#l28.666"></a><span id="l28.666">       case &quot;otr:disconnected&quot;:</span>
<a href="#l28.667"></a><span id="l28.667">       case &quot;otr:msg-state&quot;:</span>
<a href="#l28.668"></a><span id="l28.668" class="difflineminus">-        if (aTopic === &quot;otr:disconnected&quot; ||</span>
<a href="#l28.669"></a><span id="l28.669" class="difflineminus">-            OTR.trust(aObject) !== OTR.trustState.TRUST_UNVERIFIED) {</span>
<a href="#l28.670"></a><span id="l28.670" class="difflineplus">+        if (</span>
<a href="#l28.671"></a><span id="l28.671" class="difflineplus">+          aTopic === &quot;otr:disconnected&quot; ||</span>
<a href="#l28.672"></a><span id="l28.672" class="difflineplus">+          OTR.trust(aObject) !== OTR.trustState.TRUST_UNVERIFIED</span>
<a href="#l28.673"></a><span id="l28.673" class="difflineplus">+        ) {</span>
<a href="#l28.674"></a><span id="l28.674">           OTRUI.closeAuth(aObject);</span>
<a href="#l28.675"></a><span id="l28.675">           OTRUI.closeUnverified(aObject);</span>
<a href="#l28.676"></a><span id="l28.676">           OTRUI.closeVerification(aObject);</span>
<a href="#l28.677"></a><span id="l28.677">         }</span>
<a href="#l28.678"></a><span id="l28.678">         OTRUI.setMsgState(null, aObject, this.globalDoc, false);</span>
<a href="#l28.679"></a><span id="l28.679">         break;</span>
<a href="#l28.680"></a><span id="l28.680">       case &quot;otr:unverified&quot;:</span>
<a href="#l28.681"></a><span id="l28.681">         if (!this.globalDoc) {</span>
<a href="#l28.682"></a><span id="l28.682" class="difflineat">@@ -801,10 +868,9 @@ var OTRUI = {</span>
<a href="#l28.683"></a><span id="l28.683">     let conversations = Services.conversations.getConversations();</span>
<a href="#l28.684"></a><span id="l28.684">     while (conversations.hasMoreElements()) {</span>
<a href="#l28.685"></a><span id="l28.685">       OTRUI.resetConv(conversations.getNext());</span>
<a href="#l28.686"></a><span id="l28.686">     }</span>
<a href="#l28.687"></a><span id="l28.687">     OTR.removeObserver(OTRUI);</span>
<a href="#l28.688"></a><span id="l28.688">     OTR.close();</span>
<a href="#l28.689"></a><span id="l28.689">     OTRUI.removeMenuObserver();</span>
<a href="#l28.690"></a><span id="l28.690">   },</span>
<a href="#l28.691"></a><span id="l28.691" class="difflineminus">-</span>
<a href="#l28.692"></a><span id="l28.692"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/chat/modules/ToLocaleFormat.jsm</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/chat/modules/ToLocaleFormat.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,94 +1,102 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.5"></a><span id="l29.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.6"></a><span id="l29.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11"> this.EXPORTED_SYMBOLS = [&quot;ToLocaleFormat&quot;];</span>
<a href="#l29.12"></a><span id="l29.12"> </span>
<a href="#l29.13"></a><span id="l29.13"> // JS implementation of the deprecated Date.toLocaleFormat.</span>
<a href="#l29.14"></a><span id="l29.14"> // aFormat follows strftime syntax,</span>
<a href="#l29.15"></a><span id="l29.15"> // http://pubs.opengroup.org/onlinepubs/007908799/xsh/strftime.html</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17"> function Day(t) {</span>
<a href="#l29.18"></a><span id="l29.18">   return Math.floor(t.valueOf() / 86400000);</span>
<a href="#l29.19"></a><span id="l29.19"> }</span>
<a href="#l29.20"></a><span id="l29.20"> function DayFromYear(y) {</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-  return 365 * (y - 1970) +</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+  return (</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+    365 * (y - 1970) +</span>
<a href="#l29.24"></a><span id="l29.24">     Math.floor((y - 1969) / 4) -</span>
<a href="#l29.25"></a><span id="l29.25">     Math.floor((y - 1901) / 100) +</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-    Math.floor((y - 1601) / 400);</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+    Math.floor((y - 1601) / 400)</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+  );</span>
<a href="#l29.29"></a><span id="l29.29"> }</span>
<a href="#l29.30"></a><span id="l29.30"> function DayWithinYear(t) {</span>
<a href="#l29.31"></a><span id="l29.31">   return Day(t) - DayFromYear(t.getFullYear());</span>
<a href="#l29.32"></a><span id="l29.32"> }</span>
<a href="#l29.33"></a><span id="l29.33"> function weekday(aDate, option) {</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  return aDate.toLocaleString(undefined, {weekday: option});</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+  return aDate.toLocaleString(undefined, { weekday: option });</span>
<a href="#l29.36"></a><span id="l29.36"> }</span>
<a href="#l29.37"></a><span id="l29.37"> function month(aDate, option) {</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-  return aDate.toLocaleString(undefined, {month: option});</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+  return aDate.toLocaleString(undefined, { month: option });</span>
<a href="#l29.40"></a><span id="l29.40"> }</span>
<a href="#l29.41"></a><span id="l29.41"> function hourMinSecTwoDigits(aDate) {</span>
<a href="#l29.42"></a><span id="l29.42">   return aDate.toLocaleString(undefined, {</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-    hour: &quot;2-digit&quot;, minute: &quot;2-digit&quot;, second: &quot;2-digit&quot;,</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+    hour: &quot;2-digit&quot;,</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+    minute: &quot;2-digit&quot;,</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+    second: &quot;2-digit&quot;,</span>
<a href="#l29.47"></a><span id="l29.47">   });</span>
<a href="#l29.48"></a><span id="l29.48"> }</span>
<a href="#l29.49"></a><span id="l29.49"> function dayPeriod(aDate) {</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-  let dtf = Intl.DateTimeFormat(undefined, {hour: &quot;2-digit&quot;});</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+  let dtf = Intl.DateTimeFormat(undefined, { hour: &quot;2-digit&quot; });</span>
<a href="#l29.52"></a><span id="l29.52">   let dayPeriodPart =</span>
<a href="#l29.53"></a><span id="l29.53">     dtf.resolvedOptions().hour12 &amp;&amp;</span>
<a href="#l29.54"></a><span id="l29.54">     dtf.formatToParts(aDate).find(part =&gt; part.type === &quot;dayPeriod&quot;);</span>
<a href="#l29.55"></a><span id="l29.55">   return dayPeriodPart ? dayPeriodPart.value : &quot;&quot;;</span>
<a href="#l29.56"></a><span id="l29.56"> }</span>
<a href="#l29.57"></a><span id="l29.57"> function weekNumber(aDate, weekStart) {</span>
<a href="#l29.58"></a><span id="l29.58">   let day = aDate.getDay();</span>
<a href="#l29.59"></a><span id="l29.59">   if (weekStart) {</span>
<a href="#l29.60"></a><span id="l29.60">     day = (day || 7) - weekStart;</span>
<a href="#l29.61"></a><span id="l29.61">   }</span>
<a href="#l29.62"></a><span id="l29.62">   return Math.max(Math.floor((DayWithinYear(aDate) + 7 - day) / 7), 0);</span>
<a href="#l29.63"></a><span id="l29.63"> }</span>
<a href="#l29.64"></a><span id="l29.64"> function weekNumberISO(t) {</span>
<a href="#l29.65"></a><span id="l29.65">   let thisWeek = weekNumber(1, t);</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-  let firstDayOfYear =</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-    (new Date(t.getFullYear(), 0, 1).getDay() || 7) - 1;</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-  if (thisWeek === 0 &amp;&amp; firstDayOfYear &gt;= 4)</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+  let firstDayOfYear = (new Date(t.getFullYear(), 0, 1).getDay() || 7) - 1;</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+  if (thisWeek === 0 &amp;&amp; firstDayOfYear &gt;= 4) {</span>
<a href="#l29.71"></a><span id="l29.71">     return weekNumberISO(new Date(t.getFullYear() - 1, 11, 31));</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-  if (t.getMonth() === 11 &amp;&amp;</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-      (t.getDate() - ((t.getDay() || 7) - 1)) &gt;= 29)</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+  }</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+  if (t.getMonth() === 11 &amp;&amp; t.getDate() - ((t.getDay() || 7) - 1) &gt;= 29) {</span>
<a href="#l29.76"></a><span id="l29.76">     return 1;</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+  }</span>
<a href="#l29.78"></a><span id="l29.78">   return thisWeek + (firstDayOfYear &gt; 0 &amp;&amp; firstDayOfYear &lt; 4);</span>
<a href="#l29.79"></a><span id="l29.79"> }</span>
<a href="#l29.80"></a><span id="l29.80"> function weekYearISO(aDate) {</span>
<a href="#l29.81"></a><span id="l29.81">   let thisWeek = weekNumber(1, aDate);</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-  let firstDayOfYear =</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-    (new Date(aDate.getFullYear(), 0, 1).getDay() || 7) - 1;</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-  if (thisWeek === 0 &amp;&amp; firstDayOfYear &gt;= 4)</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+  let firstDayOfYear = (new Date(aDate.getFullYear(), 0, 1).getDay() || 7) - 1;</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+  if (thisWeek === 0 &amp;&amp; firstDayOfYear &gt;= 4) {</span>
<a href="#l29.87"></a><span id="l29.87">     return aDate.getFullYear() - 1;</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-  if (aDate.getMonth() === 11 &amp;&amp;</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-      (aDate.getDate() - ((aDate.getDay() || 7) - 1)) &gt;= 29)</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+  }</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+  if (</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+    aDate.getMonth() === 11 &amp;&amp;</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+    aDate.getDate() - ((aDate.getDay() || 7) - 1) &gt;= 29</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+  ) {</span>
<a href="#l29.95"></a><span id="l29.95">     return aDate.getFullYear() + 1;</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+  }</span>
<a href="#l29.97"></a><span id="l29.97">   return aDate.getFullYear();</span>
<a href="#l29.98"></a><span id="l29.98"> }</span>
<a href="#l29.99"></a><span id="l29.99"> function timeZoneOffset(aDate) {</span>
<a href="#l29.100"></a><span id="l29.100">   let offset = aDate.getTimezoneOffset();</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-  let tzoff =</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-    Math.floor(Math.abs(offset) / 60) * 100 + Math.abs(offset) % 60;</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+  let tzoff = Math.floor(Math.abs(offset) / 60) * 100 + (Math.abs(offset) % 60);</span>
<a href="#l29.104"></a><span id="l29.104">   return (offset &lt; 0 ? &quot;+&quot; : &quot;-&quot;) + String(tzoff).padStart(4, &quot;0&quot;);</span>
<a href="#l29.105"></a><span id="l29.105"> }</span>
<a href="#l29.106"></a><span id="l29.106"> function timeZone(aDate) {</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-  let dtf = Intl.DateTimeFormat(undefined, {timeZoneName: &quot;short&quot;});</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-  let timeZoneNamePart = dtf.formatToParts(aDate)</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineminus">-                            .find(part =&gt; part.type === &quot;timeZoneName&quot;);</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+  let dtf = Intl.DateTimeFormat(undefined, { timeZoneName: &quot;short&quot; });</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+  let timeZoneNamePart = dtf</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+    .formatToParts(aDate)</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+    .find(part =&gt; part.type === &quot;timeZoneName&quot;);</span>
<a href="#l29.114"></a><span id="l29.114">   return timeZoneNamePart ? timeZoneNamePart.value : &quot;&quot;;</span>
<a href="#l29.115"></a><span id="l29.115"> }</span>
<a href="#l29.116"></a><span id="l29.116"> </span>
<a href="#l29.117"></a><span id="l29.117"> const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineminus">-  dateStyle: &quot;full&quot;, timeStyle: &quot;long&quot;,</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+  dateStyle: &quot;full&quot;,</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+  timeStyle: &quot;long&quot;,</span>
<a href="#l29.121"></a><span id="l29.121"> });</span>
<a href="#l29.122"></a><span id="l29.122"> const dateFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l29.123"></a><span id="l29.123">   dateStyle: &quot;full&quot;,</span>
<a href="#l29.124"></a><span id="l29.124"> });</span>
<a href="#l29.125"></a><span id="l29.125"> const timeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l29.126"></a><span id="l29.126">   timeStyle: &quot;long&quot;,</span>
<a href="#l29.127"></a><span id="l29.127"> });</span>
<a href="#l29.128"></a><span id="l29.128"> </span>
<a href="#l29.129"></a><span id="l29.129" class="difflineat">@@ -131,52 +139,54 @@ const formatFunctions = {</span>
<a href="#l29.130"></a><span id="l29.130">   X: aDate =&gt; timeFormatter.format(aDate),</span>
<a href="#l29.131"></a><span id="l29.131">   y: aDate =&gt; String(aDate.getFullYear() % 100),</span>
<a href="#l29.132"></a><span id="l29.132">   Y: aDate =&gt; String(aDate.getFullYear()),</span>
<a href="#l29.133"></a><span id="l29.133">   z: aDate =&gt; timeZoneOffset(aDate),</span>
<a href="#l29.134"></a><span id="l29.134">   Z: aDate =&gt; timeZone(aDate),</span>
<a href="#l29.135"></a><span id="l29.135">   &quot;%&quot;: () =&gt; &quot;%&quot;,</span>
<a href="#l29.136"></a><span id="l29.136"> };</span>
<a href="#l29.137"></a><span id="l29.137"> const padding = {</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-  C: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-  d: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineminus">-  e: {fill: &quot; &quot;, width: 2},</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineminus">-  g: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineminus">-  H: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineminus">-  I: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineminus">-  j: {fill: &quot;0&quot;, width: 3},</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineminus">-  k: {fill: &quot; &quot;, width: 2},</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineminus">-  l: {fill: &quot; &quot;, width: 2},</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-  m: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-  M: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineminus">-  S: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineminus">-  U: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-  V: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-  W: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-  y: {fill: &quot;0&quot;, width: 2},</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineplus">+  C: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineplus">+  d: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineplus">+  e: { fill: &quot; &quot;, width: 2 },</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineplus">+  g: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineplus">+  H: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineplus">+  I: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineplus">+  j: { fill: &quot;0&quot;, width: 3 },</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineplus">+  k: { fill: &quot; &quot;, width: 2 },</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineplus">+  l: { fill: &quot; &quot;, width: 2 },</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineplus">+  m: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineplus">+  M: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineplus">+  S: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineplus">+  U: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineplus">+  V: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineplus">+  W: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineplus">+  y: { fill: &quot;0&quot;, width: 2 },</span>
<a href="#l29.170"></a><span id="l29.170"> };</span>
<a href="#l29.171"></a><span id="l29.171"> </span>
<a href="#l29.172"></a><span id="l29.172"> function ToLocaleFormat(aFormat, aDate) {</span>
<a href="#l29.173"></a><span id="l29.173">   // Modified conversion specifiers E and O are ignored.</span>
<a href="#l29.174"></a><span id="l29.174">   let specifiers = Object.keys(formatFunctions).join(&quot;&quot;);</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineminus">-  let pattern =</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-    RegExp(`%#?(\\^)?([0_-]\\d*)?(?:[EO])?([${specifiers}])`, &quot;g&quot;);</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineplus">+  let pattern = RegExp(`%#?(\\^)?([0_-]\\d*)?(?:[EO])?([${specifiers}])`, &quot;g&quot;);</span>
<a href="#l29.178"></a><span id="l29.178"> </span>
<a href="#l29.179"></a><span id="l29.179" class="difflineminus">-  return aFormat.replace(pattern,</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineplus">+  return aFormat.replace(</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineplus">+    pattern,</span>
<a href="#l29.182"></a><span id="l29.182">     (matched, upperCaseFlag, fillWidthFlags, specifier) =&gt; {</span>
<a href="#l29.183"></a><span id="l29.183">       let result = formatFunctions[specifier](aDate);</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineminus">-      if (upperCaseFlag)</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineplus">+      if (upperCaseFlag) {</span>
<a href="#l29.186"></a><span id="l29.186">         result = result.toLocaleUpperCase();</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineminus">-      let fill = (specifier in padding) ? padding[specifier].fill : &quot;&quot;;</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineminus">-      let width = (specifier in padding) ? padding[specifier].width : 0;</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineplus">+      }</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineplus">+      let fill = specifier in padding ? padding[specifier].fill : &quot;&quot;;</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineplus">+      let width = specifier in padding ? padding[specifier].width : 0;</span>
<a href="#l29.192"></a><span id="l29.192">       if (fillWidthFlags) {</span>
<a href="#l29.193"></a><span id="l29.193">         let newFill = fillWidthFlags[0];</span>
<a href="#l29.194"></a><span id="l29.194">         let newWidth = fillWidthFlags.match(/\d+/);</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineminus">-        if (newFill === &quot;-&quot; &amp;&amp; newWidth === null)</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineplus">+        if (newFill === &quot;-&quot; &amp;&amp; newWidth === null) {</span>
<a href="#l29.197"></a><span id="l29.197">           fill = &quot;&quot;;</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineminus">-        else {</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineplus">+        } else {</span>
<a href="#l29.200"></a><span id="l29.200">           fill = newFill === &quot;0&quot; ? &quot;0&quot; : &quot; &quot;;</span>
<a href="#l29.201"></a><span id="l29.201">           width = newWidth !== null ? Number(newWidth) : width;</span>
<a href="#l29.202"></a><span id="l29.202">         }</span>
<a href="#l29.203"></a><span id="l29.203">       }</span>
<a href="#l29.204"></a><span id="l29.204">       return result.padStart(width, fill);</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-    });</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+    }</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineplus">+  );</span>
<a href="#l29.208"></a><span id="l29.208"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/chat/modules/hiddenWindow.jsm</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/chat/modules/hiddenWindow.jsm</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,19 +1,23 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.5"></a><span id="l30.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.6"></a><span id="l30.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> this.EXPORTED_SYMBOLS = [&quot;getHiddenHTMLWindow&quot;];</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+);</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;hiddenWindow&quot;, () =&gt;</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-  Services.appShell.hiddenDOMWindow</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+XPCOMUtils.defineLazyGetter(</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  this,</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+  &quot;hiddenWindow&quot;,</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+  () =&gt; Services.appShell.hiddenDOMWindow</span>
<a href="#l30.23"></a><span id="l30.23"> );</span>
<a href="#l30.24"></a><span id="l30.24"> </span>
<a href="#l30.25"></a><span id="l30.25"> function getHiddenHTMLWindow() {</span>
<a href="#l30.26"></a><span id="l30.26">   if (Services.appinfo.OS == &quot;Darwin&quot;) {</span>
<a href="#l30.27"></a><span id="l30.27">     let browser = hiddenWindow.document.getElementById(&quot;hiddenBrowser&quot;);</span>
<a href="#l30.28"></a><span id="l30.28">     return browser.docShell ? browser.contentWindow : hiddenWindow;</span>
<a href="#l30.29"></a><span id="l30.29">   }</span>
<a href="#l30.30"></a><span id="l30.30">   return hiddenWindow;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/chat/modules/imContentSink.jsm</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/chat/modules/imContentSink.jsm</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,24 +1,24 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.5"></a><span id="l31.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.6"></a><span id="l31.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l31.12"></a><span id="l31.12">   &quot;cleanupImMarkup&quot;, // used to clean up incoming IMs.</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-                     // This will use the global ruleset of acceptable stuff</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-                     // except if another (custom one) is provided</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+  // This will use the global ruleset of acceptable stuff</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+  // except if another (custom one) is provided</span>
<a href="#l31.17"></a><span id="l31.17">   &quot;createDerivedRuleset&quot;, // used to create a ruleset that inherits from the</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-                          // default one</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-                          // useful if you want to allow or forbid</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-                          // an additional thing in a specific</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-                          // conversation but take into account all</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-                          // the other global settings.</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+  // default one</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+  // useful if you want to allow or forbid</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+  // an additional thing in a specific</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+  // conversation but take into account all</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+  // the other global settings.</span>
<a href="#l31.28"></a><span id="l31.28">   &quot;addGlobalAllowedTag&quot;,</span>
<a href="#l31.29"></a><span id="l31.29">   &quot;removeGlobalAllowedTag&quot;,</span>
<a href="#l31.30"></a><span id="l31.30">   &quot;addGlobalAllowedAttribute&quot;,</span>
<a href="#l31.31"></a><span id="l31.31">   &quot;removeGlobalAllowedAttribute&quot;,</span>
<a href="#l31.32"></a><span id="l31.32">   &quot;addGlobalAllowedStyleRule&quot;,</span>
<a href="#l31.33"></a><span id="l31.33">   &quot;removeGlobalAllowedStyleRule&quot;,</span>
<a href="#l31.34"></a><span id="l31.34"> ];</span>
<a href="#l31.35"></a><span id="l31.35"> </span>
<a href="#l31.36"></a><span id="l31.36" class="difflineat">@@ -38,235 +38,231 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l31.37"></a><span id="l31.37">  *  - styles: an object with the allowed CSS style rule.</span>
<a href="#l31.38"></a><span id="l31.38">  *      example: 'font-size': true</span>
<a href="#l31.39"></a><span id="l31.39">  *    FIXME: make this accept functions to filter the CSS values too.</span>
<a href="#l31.40"></a><span id="l31.40">  *</span>
<a href="#l31.41"></a><span id="l31.41">  *  See the 3 examples of rulesets below.</span>
<a href="#l31.42"></a><span id="l31.42">  */</span>
<a href="#l31.43"></a><span id="l31.43"> </span>
<a href="#l31.44"></a><span id="l31.44"> var kAllowedURLs = aValue =&gt; /^(https?|ftp|mailto):/.test(aValue);</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-var kAllowedMozClasses =</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineminus">-  aClassName =&gt; aClassName == &quot;moz-txt-underscore&quot; ||</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-                aClassName == &quot;moz-txt-tag&quot; ||</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-                aClassName == &quot;ib-person&quot;;</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+var kAllowedMozClasses = aClassName =&gt;</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+  aClassName == &quot;moz-txt-underscore&quot; ||</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+  aClassName == &quot;moz-txt-tag&quot; ||</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+  aClassName == &quot;ib-person&quot;;</span>
<a href="#l31.53"></a><span id="l31.53"> var kAllowedAnchorClasses = aClassName =&gt; aClassName == &quot;ib-person&quot;;</span>
<a href="#l31.54"></a><span id="l31.54"> </span>
<a href="#l31.55"></a><span id="l31.55"> /* Tags whose content should be fully removed, and reported in the Error Console. */</span>
<a href="#l31.56"></a><span id="l31.56"> var kForbiddenTags = {</span>
<a href="#l31.57"></a><span id="l31.57">   script: true,</span>
<a href="#l31.58"></a><span id="l31.58">   style: true,</span>
<a href="#l31.59"></a><span id="l31.59"> };</span>
<a href="#l31.60"></a><span id="l31.60"> </span>
<a href="#l31.61"></a><span id="l31.61"> // in strict mode, remove all formatings. Keep only links and line breaks.</span>
<a href="#l31.62"></a><span id="l31.62"> var kStrictMode = {</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-  attrs: { },</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+  attrs: {},</span>
<a href="#l31.65"></a><span id="l31.65"> </span>
<a href="#l31.66"></a><span id="l31.66">   tags: {</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-    &quot;a&quot;: {</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-      &quot;title&quot;: true,</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-      &quot;href&quot;: kAllowedURLs,</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-      &quot;class&quot;: kAllowedAnchorClasses,</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+    a: {</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+      title: true,</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+      href: kAllowedURLs,</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+      class: kAllowedAnchorClasses,</span>
<a href="#l31.75"></a><span id="l31.75">     },</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-    &quot;br&quot;: true,</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-    &quot;p&quot;: true,</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+    br: true,</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+    p: true,</span>
<a href="#l31.80"></a><span id="l31.80">   },</span>
<a href="#l31.81"></a><span id="l31.81"> </span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-  styles: { },</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+  styles: {},</span>
<a href="#l31.84"></a><span id="l31.84"> };</span>
<a href="#l31.85"></a><span id="l31.85"> </span>
<a href="#l31.86"></a><span id="l31.86"> // standard mode allows basic formattings (bold, italic, underlined)</span>
<a href="#l31.87"></a><span id="l31.87"> var kStandardMode = {</span>
<a href="#l31.88"></a><span id="l31.88">   attrs: {</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-    &quot;style&quot;: true,</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+    style: true,</span>
<a href="#l31.91"></a><span id="l31.91">   },</span>
<a href="#l31.92"></a><span id="l31.92"> </span>
<a href="#l31.93"></a><span id="l31.93">   tags: {</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineminus">-    &quot;div&quot;: true,</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-    &quot;a&quot;: {</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-      &quot;title&quot;: true,</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-      &quot;href&quot;: kAllowedURLs,</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-      &quot;class&quot;: kAllowedAnchorClasses,</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+    div: true,</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+    a: {</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+      title: true,</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+      href: kAllowedURLs,</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+      class: kAllowedAnchorClasses,</span>
<a href="#l31.104"></a><span id="l31.104">     },</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-    &quot;em&quot;: true,</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-    &quot;strong&quot;: true,</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-    &quot;b&quot;: true,</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-    &quot;i&quot;: true,</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-    &quot;u&quot;: true,</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-    &quot;span&quot;: {</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-      &quot;class&quot;: kAllowedMozClasses,</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+    em: true,</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+    strong: true,</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+    b: true,</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+    i: true,</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+    u: true,</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+    span: {</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+      class: kAllowedMozClasses,</span>
<a href="#l31.119"></a><span id="l31.119">     },</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-    &quot;br&quot;: true,</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-    &quot;code&quot;: true,</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-    &quot;ul&quot;: true,</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-    &quot;li&quot;: true,</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-    &quot;ol&quot;: true,</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-    &quot;cite&quot;: true,</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-    &quot;blockquote&quot;: true,</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-    &quot;p&quot;: true,</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+    br: true,</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+    code: true,</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+    ul: true,</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+    li: true,</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+    ol: true,</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+    cite: true,</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+    blockquote: true,</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+    p: true,</span>
<a href="#l31.136"></a><span id="l31.136">   },</span>
<a href="#l31.137"></a><span id="l31.137"> </span>
<a href="#l31.138"></a><span id="l31.138">   styles: {</span>
<a href="#l31.139"></a><span id="l31.139">     &quot;font-style&quot;: true,</span>
<a href="#l31.140"></a><span id="l31.140">     &quot;font-weight&quot;: true,</span>
<a href="#l31.141"></a><span id="l31.141">     &quot;text-decoration-line&quot;: true,</span>
<a href="#l31.142"></a><span id="l31.142">   },</span>
<a href="#l31.143"></a><span id="l31.143"> };</span>
<a href="#l31.144"></a><span id="l31.144"> </span>
<a href="#l31.145"></a><span id="l31.145"> // permissive mode allows about anything that isn't going to mess up the chat window</span>
<a href="#l31.146"></a><span id="l31.146"> var kPermissiveMode = {</span>
<a href="#l31.147"></a><span id="l31.147">   attrs: {</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineminus">-    &quot;style&quot;: true,</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineplus">+    style: true,</span>
<a href="#l31.150"></a><span id="l31.150">   },</span>
<a href="#l31.151"></a><span id="l31.151"> </span>
<a href="#l31.152"></a><span id="l31.152">   tags: {</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineminus">-    &quot;div&quot;: true,</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineminus">-    &quot;a&quot;: {</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-      &quot;title&quot;: true,</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineminus">-      &quot;href&quot;: kAllowedURLs,</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineminus">-      &quot;class&quot;: kAllowedAnchorClasses,</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineplus">+    div: true,</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+    a: {</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineplus">+      title: true,</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+      href: kAllowedURLs,</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineplus">+      class: kAllowedAnchorClasses,</span>
<a href="#l31.163"></a><span id="l31.163">     },</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineminus">-    &quot;font&quot;: {</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineminus">-      &quot;face&quot;: true,</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-      &quot;color&quot;: true,</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineminus">-      &quot;size&quot;: true,</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineplus">+    font: {</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+      face: true,</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+      color: true,</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineplus">+      size: true,</span>
<a href="#l31.172"></a><span id="l31.172">     },</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineminus">-    &quot;em&quot;: true,</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineminus">-    &quot;strong&quot;: true,</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineminus">-    &quot;b&quot;: true,</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineminus">-    &quot;i&quot;: true,</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineminus">-    &quot;u&quot;: true,</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineminus">-    &quot;span&quot;: {</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineminus">-      &quot;class&quot;: kAllowedMozClasses,</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineplus">+    em: true,</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineplus">+    strong: true,</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineplus">+    b: true,</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineplus">+    i: true,</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineplus">+    u: true,</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineplus">+    span: {</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineplus">+      class: kAllowedMozClasses,</span>
<a href="#l31.187"></a><span id="l31.187">     },</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineminus">-    &quot;br&quot;: true,</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineminus">-    &quot;hr&quot;: true,</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineminus">-    &quot;code&quot;: true,</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineminus">-    &quot;ul&quot;: true,</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineminus">-    &quot;li&quot;: true,</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineminus">-    &quot;ol&quot;: true,</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineminus">-    &quot;cite&quot;: true,</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineminus">-    &quot;blockquote&quot;: true,</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineminus">-    &quot;p&quot;: true,</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineplus">+    br: true,</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+    hr: true,</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineplus">+    code: true,</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineplus">+    ul: true,</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineplus">+    li: true,</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineplus">+    ol: true,</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineplus">+    cite: true,</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineplus">+    blockquote: true,</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineplus">+    p: true,</span>
<a href="#l31.206"></a><span id="l31.206">   },</span>
<a href="#l31.207"></a><span id="l31.207"> </span>
<a href="#l31.208"></a><span id="l31.208">   // FIXME: should be possible to use functions to filter values</span>
<a href="#l31.209"></a><span id="l31.209">   styles: {</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineminus">-    &quot;color&quot;: true,</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineminus">-    &quot;font&quot;: true,</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+    color: true,</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineplus">+    font: true,</span>
<a href="#l31.214"></a><span id="l31.214">     &quot;font-family&quot;: true,</span>
<a href="#l31.215"></a><span id="l31.215">     &quot;font-size&quot;: true,</span>
<a href="#l31.216"></a><span id="l31.216">     &quot;font-style&quot;: true,</span>
<a href="#l31.217"></a><span id="l31.217">     &quot;font-weight&quot;: true,</span>
<a href="#l31.218"></a><span id="l31.218">     &quot;text-decoration-color&quot;: true,</span>
<a href="#l31.219"></a><span id="l31.219">     &quot;text-decoration-style&quot;: true,</span>
<a href="#l31.220"></a><span id="l31.220">     &quot;text-decoration-line&quot;: true,</span>
<a href="#l31.221"></a><span id="l31.221">   },</span>
<a href="#l31.222"></a><span id="l31.222"> };</span>
<a href="#l31.223"></a><span id="l31.223"> </span>
<a href="#l31.224"></a><span id="l31.224"> var kModePref = &quot;messenger.options.filterMode&quot;;</span>
<a href="#l31.225"></a><span id="l31.225"> var kModes = [kStrictMode, kStandardMode, kPermissiveMode];</span>
<a href="#l31.226"></a><span id="l31.226"> </span>
<a href="#l31.227"></a><span id="l31.227"> var gGlobalRuleset = null;</span>
<a href="#l31.228"></a><span id="l31.228"> </span>
<a href="#l31.229"></a><span id="l31.229" class="difflineminus">-function initGlobalRuleset()</span>
<a href="#l31.230"></a><span id="l31.230" class="difflineminus">-{</span>
<a href="#l31.231"></a><span id="l31.231" class="difflineplus">+function initGlobalRuleset() {</span>
<a href="#l31.232"></a><span id="l31.232">   gGlobalRuleset = newRuleset();</span>
<a href="#l31.233"></a><span id="l31.233"> </span>
<a href="#l31.234"></a><span id="l31.234">   Services.prefs.addObserver(kModePref, styleObserver);</span>
<a href="#l31.235"></a><span id="l31.235"> }</span>
<a href="#l31.236"></a><span id="l31.236"> </span>
<a href="#l31.237"></a><span id="l31.237"> var styleObserver = {</span>
<a href="#l31.238"></a><span id="l31.238">   observe(aObject, aTopic, aMsg) {</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineminus">-    if (aTopic != &quot;nsPref:changed&quot; || aMsg != kModePref)</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineplus">+    if (aTopic != &quot;nsPref:changed&quot; || aMsg != kModePref) {</span>
<a href="#l31.241"></a><span id="l31.241">       throw new Error(&quot;bad notification&quot;);</span>
<a href="#l31.242"></a><span id="l31.242" class="difflineplus">+    }</span>
<a href="#l31.243"></a><span id="l31.243"> </span>
<a href="#l31.244"></a><span id="l31.244" class="difflineminus">-    if (!gGlobalRuleset)</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineplus">+    if (!gGlobalRuleset) {</span>
<a href="#l31.246"></a><span id="l31.246">       throw new Error(&quot;gGlobalRuleset not initialized&quot;);</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineplus">+    }</span>
<a href="#l31.248"></a><span id="l31.248"> </span>
<a href="#l31.249"></a><span id="l31.249">     setBaseRuleset(getModePref(), gGlobalRuleset);</span>
<a href="#l31.250"></a><span id="l31.250">   },</span>
<a href="#l31.251"></a><span id="l31.251"> };</span>
<a href="#l31.252"></a><span id="l31.252"> </span>
<a href="#l31.253"></a><span id="l31.253" class="difflineminus">-function getModePref()</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineminus">-{</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineplus">+function getModePref() {</span>
<a href="#l31.256"></a><span id="l31.256">   let baseNum = Services.prefs.getIntPref(kModePref);</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineminus">-  if (baseNum &lt; 0 || baseNum &gt; 2)</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineplus">+  if (baseNum &lt; 0 || baseNum &gt; 2) {</span>
<a href="#l31.259"></a><span id="l31.259">     baseNum = 1;</span>
<a href="#l31.260"></a><span id="l31.260" class="difflineplus">+  }</span>
<a href="#l31.261"></a><span id="l31.261"> </span>
<a href="#l31.262"></a><span id="l31.262">   return kModes[baseNum];</span>
<a href="#l31.263"></a><span id="l31.263"> }</span>
<a href="#l31.264"></a><span id="l31.264"> </span>
<a href="#l31.265"></a><span id="l31.265" class="difflineminus">-function setBaseRuleset(aBase, aResult)</span>
<a href="#l31.266"></a><span id="l31.266" class="difflineminus">-{</span>
<a href="#l31.267"></a><span id="l31.267" class="difflineminus">-  for (let property in aBase)</span>
<a href="#l31.268"></a><span id="l31.268" class="difflineplus">+function setBaseRuleset(aBase, aResult) {</span>
<a href="#l31.269"></a><span id="l31.269" class="difflineplus">+  for (let property in aBase) {</span>
<a href="#l31.270"></a><span id="l31.270">     aResult[property] = Object.create(aBase[property], aResult[property]);</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineplus">+  }</span>
<a href="#l31.272"></a><span id="l31.272"> }</span>
<a href="#l31.273"></a><span id="l31.273"> </span>
<a href="#l31.274"></a><span id="l31.274" class="difflineminus">-function newRuleset(aBase)</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineminus">-{</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineplus">+function newRuleset(aBase) {</span>
<a href="#l31.277"></a><span id="l31.277">   let result = {</span>
<a href="#l31.278"></a><span id="l31.278">     tags: {},</span>
<a href="#l31.279"></a><span id="l31.279">     attrs: {},</span>
<a href="#l31.280"></a><span id="l31.280">     styles: {},</span>
<a href="#l31.281"></a><span id="l31.281">   };</span>
<a href="#l31.282"></a><span id="l31.282">   setBaseRuleset(aBase || getModePref(), result);</span>
<a href="#l31.283"></a><span id="l31.283">   return result;</span>
<a href="#l31.284"></a><span id="l31.284"> }</span>
<a href="#l31.285"></a><span id="l31.285"> </span>
<a href="#l31.286"></a><span id="l31.286" class="difflineminus">-function createDerivedRuleset()</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineminus">-{</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineminus">-  if (!gGlobalRuleset)</span>
<a href="#l31.289"></a><span id="l31.289" class="difflineplus">+function createDerivedRuleset() {</span>
<a href="#l31.290"></a><span id="l31.290" class="difflineplus">+  if (!gGlobalRuleset) {</span>
<a href="#l31.291"></a><span id="l31.291">     initGlobalRuleset();</span>
<a href="#l31.292"></a><span id="l31.292" class="difflineplus">+  }</span>
<a href="#l31.293"></a><span id="l31.293">   return newRuleset(gGlobalRuleset);</span>
<a href="#l31.294"></a><span id="l31.294"> }</span>
<a href="#l31.295"></a><span id="l31.295"> </span>
<a href="#l31.296"></a><span id="l31.296" class="difflineminus">-function addGlobalAllowedTag(aTag, aAttrs = true)</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineminus">-{</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineplus">+function addGlobalAllowedTag(aTag, aAttrs = true) {</span>
<a href="#l31.299"></a><span id="l31.299">   gGlobalRuleset.tags[aTag] = aAttrs;</span>
<a href="#l31.300"></a><span id="l31.300"> }</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineminus">-function removeGlobalAllowedTag(aTag)</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineminus">-{</span>
<a href="#l31.303"></a><span id="l31.303" class="difflineplus">+function removeGlobalAllowedTag(aTag) {</span>
<a href="#l31.304"></a><span id="l31.304">   delete gGlobalRuleset.tags[aTag];</span>
<a href="#l31.305"></a><span id="l31.305"> }</span>
<a href="#l31.306"></a><span id="l31.306"> </span>
<a href="#l31.307"></a><span id="l31.307" class="difflineminus">-function addGlobalAllowedAttribute(aAttr, aRule = true)</span>
<a href="#l31.308"></a><span id="l31.308" class="difflineminus">-{</span>
<a href="#l31.309"></a><span id="l31.309" class="difflineplus">+function addGlobalAllowedAttribute(aAttr, aRule = true) {</span>
<a href="#l31.310"></a><span id="l31.310">   gGlobalRuleset.attrs[aAttr] = aRule;</span>
<a href="#l31.311"></a><span id="l31.311"> }</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineminus">-function removeGlobalAllowedAttribute(aAttr)</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineminus">-{</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineplus">+function removeGlobalAllowedAttribute(aAttr) {</span>
<a href="#l31.315"></a><span id="l31.315">   delete gGlobalRuleset.attrs[aAttr];</span>
<a href="#l31.316"></a><span id="l31.316"> }</span>
<a href="#l31.317"></a><span id="l31.317"> </span>
<a href="#l31.318"></a><span id="l31.318" class="difflineminus">-function addGlobalAllowedStyleRule(aStyle, aRule = true)</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineminus">-{</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineplus">+function addGlobalAllowedStyleRule(aStyle, aRule = true) {</span>
<a href="#l31.321"></a><span id="l31.321">   gGlobalRuleset.styles[aStyle] = aRule;</span>
<a href="#l31.322"></a><span id="l31.322"> }</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineminus">-function removeGlobalAllowedStyleRule(aStyle)</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineminus">-{</span>
<a href="#l31.325"></a><span id="l31.325" class="difflineplus">+function removeGlobalAllowedStyleRule(aStyle) {</span>
<a href="#l31.326"></a><span id="l31.326">   delete gGlobalRuleset.styles[aStyle];</span>
<a href="#l31.327"></a><span id="l31.327"> }</span>
<a href="#l31.328"></a><span id="l31.328"> </span>
<a href="#l31.329"></a><span id="l31.329" class="difflineminus">-function cleanupNode(aNode, aRules, aTextModifiers)</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineminus">-{</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineplus">+function cleanupNode(aNode, aRules, aTextModifiers) {</span>
<a href="#l31.332"></a><span id="l31.332">   for (let i = 0; i &lt; aNode.childNodes.length; ++i) {</span>
<a href="#l31.333"></a><span id="l31.333">     let node = aNode.childNodes[i];</span>
<a href="#l31.334"></a><span id="l31.334" class="difflineminus">-    if (node.nodeType == node.ELEMENT_NODE &amp;&amp;</span>
<a href="#l31.335"></a><span id="l31.335" class="difflineminus">-        node.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;) {</span>
<a href="#l31.336"></a><span id="l31.336" class="difflineplus">+    if (</span>
<a href="#l31.337"></a><span id="l31.337" class="difflineplus">+      node.nodeType == node.ELEMENT_NODE &amp;&amp;</span>
<a href="#l31.338"></a><span id="l31.338" class="difflineplus">+      node.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineplus">+    ) {</span>
<a href="#l31.340"></a><span id="l31.340">       // check if node allowed</span>
<a href="#l31.341"></a><span id="l31.341">       let nodeName = node.localName;</span>
<a href="#l31.342"></a><span id="l31.342">       if (!(nodeName in aRules.tags)) {</span>
<a href="#l31.343"></a><span id="l31.343">         if (nodeName in kForbiddenTags) {</span>
<a href="#l31.344"></a><span id="l31.344" class="difflineminus">-          Cu.reportError(&quot;removing a &quot; + nodeName +</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineminus">-                         &quot; tag from a message before display&quot;);</span>
<a href="#l31.346"></a><span id="l31.346" class="difflineminus">-        }</span>
<a href="#l31.347"></a><span id="l31.347" class="difflineminus">-        else {</span>
<a href="#l31.348"></a><span id="l31.348" class="difflineplus">+          Cu.reportError(</span>
<a href="#l31.349"></a><span id="l31.349" class="difflineplus">+            &quot;removing a &quot; + nodeName + &quot; tag from a message before display&quot;</span>
<a href="#l31.350"></a><span id="l31.350" class="difflineplus">+          );</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineplus">+        } else {</span>
<a href="#l31.352"></a><span id="l31.352">           // this node is not allowed, replace it with its children</span>
<a href="#l31.353"></a><span id="l31.353" class="difflineminus">-          while (node.hasChildNodes())</span>
<a href="#l31.354"></a><span id="l31.354" class="difflineplus">+          while (node.hasChildNodes()) {</span>
<a href="#l31.355"></a><span id="l31.355">             aNode.insertBefore(node.firstChild, node);</span>
<a href="#l31.356"></a><span id="l31.356" class="difflineplus">+          }</span>
<a href="#l31.357"></a><span id="l31.357">         }</span>
<a href="#l31.358"></a><span id="l31.358">         aNode.removeChild(node);</span>
<a href="#l31.359"></a><span id="l31.359">         // We want to process again the node at the index i which is</span>
<a href="#l31.360"></a><span id="l31.360">         // now the first child of the node we removed</span>
<a href="#l31.361"></a><span id="l31.361">         --i;</span>
<a href="#l31.362"></a><span id="l31.362">         continue;</span>
<a href="#l31.363"></a><span id="l31.363">       }</span>
<a href="#l31.364"></a><span id="l31.364"> </span>
<a href="#l31.365"></a><span id="l31.365" class="difflineat">@@ -274,28 +270,33 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l31.366"></a><span id="l31.366">       cleanupNode(node, aRules, aTextModifiers);</span>
<a href="#l31.367"></a><span id="l31.367"> </span>
<a href="#l31.368"></a><span id="l31.368">       // cleanup attributes</span>
<a href="#l31.369"></a><span id="l31.369">       let attrs = node.attributes;</span>
<a href="#l31.370"></a><span id="l31.370">       let acceptFunction = function(aAttrRules, aAttr) {</span>
<a href="#l31.371"></a><span id="l31.371">         // an attribute is always accepted if its rule is true, or conditionally</span>
<a href="#l31.372"></a><span id="l31.372">         // accepted if its rule is a function that evaluates to true</span>
<a href="#l31.373"></a><span id="l31.373">         // if its rule does not exist, it is refused</span>
<a href="#l31.374"></a><span id="l31.374" class="difflineminus">-          let localName = aAttr.localName;</span>
<a href="#l31.375"></a><span id="l31.375" class="difflineminus">-          let rule = localName in aAttrRules &amp;&amp; aAttrRules[localName];</span>
<a href="#l31.376"></a><span id="l31.376" class="difflineminus">-          return (rule === true ||</span>
<a href="#l31.377"></a><span id="l31.377" class="difflineminus">-                  (typeof rule == &quot;function&quot; &amp;&amp; rule(aAttr.value)));</span>
<a href="#l31.378"></a><span id="l31.378" class="difflineplus">+        let localName = aAttr.localName;</span>
<a href="#l31.379"></a><span id="l31.379" class="difflineplus">+        let rule = localName in aAttrRules &amp;&amp; aAttrRules[localName];</span>
<a href="#l31.380"></a><span id="l31.380" class="difflineplus">+        return (</span>
<a href="#l31.381"></a><span id="l31.381" class="difflineplus">+          rule === true || (typeof rule == &quot;function&quot; &amp;&amp; rule(aAttr.value))</span>
<a href="#l31.382"></a><span id="l31.382" class="difflineplus">+        );</span>
<a href="#l31.383"></a><span id="l31.383">       };</span>
<a href="#l31.384"></a><span id="l31.384">       for (let j = 0; j &lt; attrs.length; ++j) {</span>
<a href="#l31.385"></a><span id="l31.385">         let attr = attrs[j];</span>
<a href="#l31.386"></a><span id="l31.386">         // we check both the list of accepted attributes for all tags</span>
<a href="#l31.387"></a><span id="l31.387">         // and the list of accepted attributes for this specific tag.</span>
<a href="#l31.388"></a><span id="l31.388" class="difflineminus">-        if (!(acceptFunction(aRules.attrs, attr) ||</span>
<a href="#l31.389"></a><span id="l31.389" class="difflineminus">-              ((typeof aRules.tags[nodeName] == &quot;object&quot;) &amp;&amp;</span>
<a href="#l31.390"></a><span id="l31.390" class="difflineminus">-               acceptFunction(aRules.tags[nodeName], attr)))) {</span>
<a href="#l31.391"></a><span id="l31.391" class="difflineplus">+        if (</span>
<a href="#l31.392"></a><span id="l31.392" class="difflineplus">+          !(</span>
<a href="#l31.393"></a><span id="l31.393" class="difflineplus">+            acceptFunction(aRules.attrs, attr) ||</span>
<a href="#l31.394"></a><span id="l31.394" class="difflineplus">+            (typeof aRules.tags[nodeName] == &quot;object&quot; &amp;&amp;</span>
<a href="#l31.395"></a><span id="l31.395" class="difflineplus">+              acceptFunction(aRules.tags[nodeName], attr))</span>
<a href="#l31.396"></a><span id="l31.396" class="difflineplus">+          )</span>
<a href="#l31.397"></a><span id="l31.397" class="difflineplus">+        ) {</span>
<a href="#l31.398"></a><span id="l31.398">           node.removeAttribute(attr.name);</span>
<a href="#l31.399"></a><span id="l31.399">           --j;</span>
<a href="#l31.400"></a><span id="l31.400">         }</span>
<a href="#l31.401"></a><span id="l31.401">       }</span>
<a href="#l31.402"></a><span id="l31.402"> </span>
<a href="#l31.403"></a><span id="l31.403">       // cleanup style</span>
<a href="#l31.404"></a><span id="l31.404">       let style = node.style;</span>
<a href="#l31.405"></a><span id="l31.405">       for (let j = 0; j &lt; style.length; ++j) {</span>
<a href="#l31.406"></a><span id="l31.406" class="difflineat">@@ -303,74 +304,81 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l31.407"></a><span id="l31.407">           style.removeProperty(style[j]);</span>
<a href="#l31.408"></a><span id="l31.408">           --j;</span>
<a href="#l31.409"></a><span id="l31.409">         }</span>
<a href="#l31.410"></a><span id="l31.410">       }</span>
<a href="#l31.411"></a><span id="l31.411">       // If the removeProperty method wasn't called by the above loop, the</span>
<a href="#l31.412"></a><span id="l31.412">       // style attribute won't be re-generated, so it may still contain</span>
<a href="#l31.413"></a><span id="l31.413">       // unsupported or unparsable CSS. Let's drop &quot;style&quot; attributes that</span>
<a href="#l31.414"></a><span id="l31.414">       // don't contain any supported CSS.</span>
<a href="#l31.415"></a><span id="l31.415" class="difflineminus">-      if (!style.length)</span>
<a href="#l31.416"></a><span id="l31.416" class="difflineplus">+      if (!style.length) {</span>
<a href="#l31.417"></a><span id="l31.417">         node.removeAttribute(&quot;style&quot;);</span>
<a href="#l31.418"></a><span id="l31.418" class="difflineplus">+      }</span>
<a href="#l31.419"></a><span id="l31.419"> </span>
<a href="#l31.420"></a><span id="l31.420">       // Sort the style attributes for easier checking/comparing later.</span>
<a href="#l31.421"></a><span id="l31.421">       if (node.hasAttribute(&quot;style&quot;)) {</span>
<a href="#l31.422"></a><span id="l31.422">         let trailingSemi = false;</span>
<a href="#l31.423"></a><span id="l31.423">         let attrs = node.getAttribute(&quot;style&quot;).trim();</span>
<a href="#l31.424"></a><span id="l31.424">         if (attrs.endsWith(&quot;;&quot;)) {</span>
<a href="#l31.425"></a><span id="l31.425">           attrs = attrs.slice(0, -1);</span>
<a href="#l31.426"></a><span id="l31.426">           trailingSemi = true;</span>
<a href="#l31.427"></a><span id="l31.427">         }</span>
<a href="#l31.428"></a><span id="l31.428">         attrs = attrs.split(&quot;;&quot;).map(a =&gt; a.trim());</span>
<a href="#l31.429"></a><span id="l31.429">         attrs.sort();</span>
<a href="#l31.430"></a><span id="l31.430" class="difflineminus">-        node.setAttribute(&quot;style&quot;, attrs.join(&quot;; &quot;) + (trailingSemi ? &quot;;&quot; : &quot;&quot;));</span>
<a href="#l31.431"></a><span id="l31.431" class="difflineplus">+        node.setAttribute(</span>
<a href="#l31.432"></a><span id="l31.432" class="difflineplus">+          &quot;style&quot;,</span>
<a href="#l31.433"></a><span id="l31.433" class="difflineplus">+          attrs.join(&quot;; &quot;) + (trailingSemi ? &quot;;&quot; : &quot;&quot;)</span>
<a href="#l31.434"></a><span id="l31.434" class="difflineplus">+        );</span>
<a href="#l31.435"></a><span id="l31.435">       }</span>
<a href="#l31.436"></a><span id="l31.436" class="difflineminus">-    }</span>
<a href="#l31.437"></a><span id="l31.437" class="difflineminus">-    else {</span>
<a href="#l31.438"></a><span id="l31.438" class="difflineplus">+    } else {</span>
<a href="#l31.439"></a><span id="l31.439">       // We are on a text node, we need to apply the functions</span>
<a href="#l31.440"></a><span id="l31.440">       // provided in the aTextModifiers array.</span>
<a href="#l31.441"></a><span id="l31.441"> </span>
<a href="#l31.442"></a><span id="l31.442">       // Each of these function should return the number of nodes added:</span>
<a href="#l31.443"></a><span id="l31.443">       //  * -1 if the current textnode was deleted</span>
<a href="#l31.444"></a><span id="l31.444">       //  * 0 if the node count is unchanged</span>
<a href="#l31.445"></a><span id="l31.445">       //  * positive value if nodes were added.</span>
<a href="#l31.446"></a><span id="l31.446">       //     For instance, adding an &lt;img&gt; tag for a smiley adds 2 nodes:</span>
<a href="#l31.447"></a><span id="l31.447">       //      - the img tag</span>
<a href="#l31.448"></a><span id="l31.448">       //      - the new text node after the img tag.</span>
<a href="#l31.449"></a><span id="l31.449"> </span>
<a href="#l31.450"></a><span id="l31.450">       // This is the number of nodes we need to process. If new nodes</span>
<a href="#l31.451"></a><span id="l31.451">       // are created, the next text modifier functions have more nodes</span>
<a href="#l31.452"></a><span id="l31.452">       // to process.</span>
<a href="#l31.453"></a><span id="l31.453">       let textNodeCount = 1;</span>
<a href="#l31.454"></a><span id="l31.454" class="difflineminus">-      for (let modifier of aTextModifiers)</span>
<a href="#l31.455"></a><span id="l31.455" class="difflineplus">+      for (let modifier of aTextModifiers) {</span>
<a href="#l31.456"></a><span id="l31.456">         for (let n = 0; n &lt; textNodeCount; ++n) {</span>
<a href="#l31.457"></a><span id="l31.457">           let textNode = aNode.childNodes[i + n];</span>
<a href="#l31.458"></a><span id="l31.458"> </span>
<a href="#l31.459"></a><span id="l31.459">           // If we are processing nodes created by one of the previous</span>
<a href="#l31.460"></a><span id="l31.460">           // text modifier function, some of the nodes are likely not</span>
<a href="#l31.461"></a><span id="l31.461">           // text node, skip them.</span>
<a href="#l31.462"></a><span id="l31.462" class="difflineminus">-          if (textNode.nodeType != textNode.TEXT_NODE &amp;&amp;</span>
<a href="#l31.463"></a><span id="l31.463" class="difflineminus">-              textNode.nodeType != textNode.CDATA_SECTION_NODE)</span>
<a href="#l31.464"></a><span id="l31.464" class="difflineplus">+          if (</span>
<a href="#l31.465"></a><span id="l31.465" class="difflineplus">+            textNode.nodeType != textNode.TEXT_NODE &amp;&amp;</span>
<a href="#l31.466"></a><span id="l31.466" class="difflineplus">+            textNode.nodeType != textNode.CDATA_SECTION_NODE</span>
<a href="#l31.467"></a><span id="l31.467" class="difflineplus">+          ) {</span>
<a href="#l31.468"></a><span id="l31.468">             continue;</span>
<a href="#l31.469"></a><span id="l31.469" class="difflineplus">+          }</span>
<a href="#l31.470"></a><span id="l31.470"> </span>
<a href="#l31.471"></a><span id="l31.471">           let result = modifier(textNode);</span>
<a href="#l31.472"></a><span id="l31.472">           textNodeCount += result;</span>
<a href="#l31.473"></a><span id="l31.473">           n += result;</span>
<a href="#l31.474"></a><span id="l31.474">         }</span>
<a href="#l31.475"></a><span id="l31.475" class="difflineplus">+      }</span>
<a href="#l31.476"></a><span id="l31.476"> </span>
<a href="#l31.477"></a><span id="l31.477">       // newly created nodes should not be filtered, be sure we skip them!</span>
<a href="#l31.478"></a><span id="l31.478">       i += textNodeCount - 1;</span>
<a href="#l31.479"></a><span id="l31.479">     }</span>
<a href="#l31.480"></a><span id="l31.480">   }</span>
<a href="#l31.481"></a><span id="l31.481"> }</span>
<a href="#l31.482"></a><span id="l31.482"> </span>
<a href="#l31.483"></a><span id="l31.483" class="difflineminus">-function cleanupImMarkup(aText, aRuleset, aTextModifiers = [])</span>
<a href="#l31.484"></a><span id="l31.484" class="difflineminus">-{</span>
<a href="#l31.485"></a><span id="l31.485" class="difflineminus">-  if (!gGlobalRuleset)</span>
<a href="#l31.486"></a><span id="l31.486" class="difflineplus">+function cleanupImMarkup(aText, aRuleset, aTextModifiers = []) {</span>
<a href="#l31.487"></a><span id="l31.487" class="difflineplus">+  if (!gGlobalRuleset) {</span>
<a href="#l31.488"></a><span id="l31.488">     initGlobalRuleset();</span>
<a href="#l31.489"></a><span id="l31.489" class="difflineplus">+  }</span>
<a href="#l31.490"></a><span id="l31.490"> </span>
<a href="#l31.491"></a><span id="l31.491">   let parser = new DOMParser();</span>
<a href="#l31.492"></a><span id="l31.492">   // Wrap the text to be parsed in a &lt;span&gt; to avoid losing leading whitespace.</span>
<a href="#l31.493"></a><span id="l31.493">   let doc = parser.parseFromString(&quot;&lt;span&gt;&quot; + aText + &quot;&lt;/span&gt;&quot;, &quot;text/html&quot;);</span>
<a href="#l31.494"></a><span id="l31.494">   let span = doc.querySelector(&quot;span&quot;);</span>
<a href="#l31.495"></a><span id="l31.495">   cleanupNode(span, aRuleset || gGlobalRuleset, aTextModifiers);</span>
<a href="#l31.496"></a><span id="l31.496">   return span.innerHTML;</span>
<a href="#l31.497"></a><span id="l31.497"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/chat/modules/imServices.jsm</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/chat/modules/imServices.jsm</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,30 +1,53 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> this.EXPORTED_SYMBOLS = [&quot;Services&quot;];</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+);</span>
<a href="#l32.16"></a><span id="l32.16"> </span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(Services, &quot;accounts&quot;,</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-                                   &quot;@mozilla.org/chat/accounts-service;1&quot;,</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-                                   &quot;imIAccountsService&quot;);</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(Services, &quot;core&quot;,</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-                                   &quot;@mozilla.org/chat/core-service;1&quot;,</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-                                   &quot;imICoreService&quot;);</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(Services, &quot;cmd&quot;,</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-                                   &quot;@mozilla.org/chat/commands-service;1&quot;,</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-                                   &quot;imICommandsService&quot;);</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(Services, &quot;contacts&quot;,</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-                                   &quot;@mozilla.org/chat/contacts-service;1&quot;,</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-                                   &quot;imIContactsService&quot;);</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(Services, &quot;conversations&quot;,</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-                                   &quot;@mozilla.org/chat/conversations-service;1&quot;,</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-                                   &quot;imIConversationsService&quot;);</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(Services, &quot;tags&quot;,</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-                                   &quot;@mozilla.org/chat/tags-service;1&quot;,</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-                                   &quot;imITagsService&quot;);</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(Services, &quot;logs&quot;,</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-                                   &quot;@mozilla.org/chat/logger;1&quot;,</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-                                   &quot;imILogger&quot;);</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+  Services,</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+  &quot;accounts&quot;,</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+  &quot;@mozilla.org/chat/accounts-service;1&quot;,</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+  &quot;imIAccountsService&quot;</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+);</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+  Services,</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+  &quot;core&quot;,</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+  &quot;@mozilla.org/chat/core-service;1&quot;,</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+  &quot;imICoreService&quot;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+);</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+  Services,</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+  &quot;cmd&quot;,</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+  &quot;@mozilla.org/chat/commands-service;1&quot;,</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+  &quot;imICommandsService&quot;</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+);</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+  Services,</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+  &quot;contacts&quot;,</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+  &quot;@mozilla.org/chat/contacts-service;1&quot;,</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+  &quot;imIContactsService&quot;</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+);</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+  Services,</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+  &quot;conversations&quot;,</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+  &quot;@mozilla.org/chat/conversations-service;1&quot;,</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+  &quot;imIConversationsService&quot;</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+);</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+  Services,</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+  &quot;tags&quot;,</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+  &quot;@mozilla.org/chat/tags-service;1&quot;,</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+  &quot;imITagsService&quot;</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+);</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+  Services,</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+  &quot;logs&quot;,</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  &quot;@mozilla.org/chat/logger;1&quot;,</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+  &quot;imILogger&quot;</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/chat/modules/imSmileys.jsm</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/chat/modules/imSmileys.jsm</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,21 +1,26 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.5"></a><span id="l33.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.6"></a><span id="l33.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+);</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15"> XPCOMUtils.defineLazyGetter(this, &quot;gTextDecoder&quot;, () =&gt; {</span>
<a href="#l33.16"></a><span id="l33.16">   return new TextDecoder();</span>
<a href="#l33.17"></a><span id="l33.17"> });</span>
<a href="#l33.18"></a><span id="l33.18"> </span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-                               &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+  this,</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+  &quot;NetUtil&quot;,</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+  &quot;resource://gre/modules/NetUtil.jsm&quot;</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+);</span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l33.28"></a><span id="l33.28">   &quot;smileImMarkup&quot;, // used to add smile:// img tags into IM markup.</span>
<a href="#l33.29"></a><span id="l33.29">   &quot;smileTextNode&quot;, // used to add smile:// img tags to the content of a textnode</span>
<a href="#l33.30"></a><span id="l33.30">   &quot;smileString&quot;, // used to add smile:// img tags into a string without parsing it as HTML. Be sure the string doesn't contain HTML tags.</span>
<a href="#l33.31"></a><span id="l33.31">   &quot;getSmileRealURI&quot;, // used to retrieve the chrome URI for a smile:// URI</span>
<a href="#l33.32"></a><span id="l33.32">   &quot;getSmileyList&quot;, // used to display a list of smileys in the UI</span>
<a href="#l33.33"></a><span id="l33.33"> ];</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineat">@@ -25,165 +30,180 @@ var kThemeFile = &quot;theme.json&quot;;</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36"> Object.defineProperty(this, &quot;gTheme&quot;, {</span>
<a href="#l33.37"></a><span id="l33.37">   configurable: true,</span>
<a href="#l33.38"></a><span id="l33.38">   enumerable: true,</span>
<a href="#l33.39"></a><span id="l33.39"> </span>
<a href="#l33.40"></a><span id="l33.40">   get() {</span>
<a href="#l33.41"></a><span id="l33.41">     delete this.gTheme;</span>
<a href="#l33.42"></a><span id="l33.42">     gPrefObserver.init();</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-    return this.gTheme = getTheme();</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+    return (this.gTheme = getTheme());</span>
<a href="#l33.45"></a><span id="l33.45">   },</span>
<a href="#l33.46"></a><span id="l33.46"> });</span>
<a href="#l33.47"></a><span id="l33.47"> </span>
<a href="#l33.48"></a><span id="l33.48"> var gPrefObserver = {</span>
<a href="#l33.49"></a><span id="l33.49">   init() {</span>
<a href="#l33.50"></a><span id="l33.50">     Services.prefs.addObserver(kEmoticonsThemePref, gPrefObserver);</span>
<a href="#l33.51"></a><span id="l33.51">   },</span>
<a href="#l33.52"></a><span id="l33.52"> </span>
<a href="#l33.53"></a><span id="l33.53">   observe(aObject, aTopic, aMsg) {</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineminus">-    if (aTopic != &quot;nsPref:changed&quot; || aMsg != kEmoticonsThemePref)</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+    if (aTopic != &quot;nsPref:changed&quot; || aMsg != kEmoticonsThemePref) {</span>
<a href="#l33.56"></a><span id="l33.56">       throw new Error(&quot;bad notification&quot;);</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+    }</span>
<a href="#l33.58"></a><span id="l33.58"> </span>
<a href="#l33.59"></a><span id="l33.59">     gTheme = getTheme();</span>
<a href="#l33.60"></a><span id="l33.60">   },</span>
<a href="#l33.61"></a><span id="l33.61"> };</span>
<a href="#l33.62"></a><span id="l33.62"> </span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-function getSmileRealURI(aSmile)</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-{</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+function getSmileRealURI(aSmile) {</span>
<a href="#l33.66"></a><span id="l33.66">   aSmile = Services.textToSubURI.unEscapeURIForUI(&quot;UTF-8&quot;, aSmile);</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-  if (aSmile in gTheme.iconsHash)</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+  if (aSmile in gTheme.iconsHash) {</span>
<a href="#l33.69"></a><span id="l33.69">     return gTheme.baseUri + gTheme.iconsHash[aSmile].filename;</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+  }</span>
<a href="#l33.71"></a><span id="l33.71"> </span>
<a href="#l33.72"></a><span id="l33.72">   throw new Error(&quot;Invalid smile!&quot;);</span>
<a href="#l33.73"></a><span id="l33.73"> }</span>
<a href="#l33.74"></a><span id="l33.74"> </span>
<a href="#l33.75"></a><span id="l33.75" class="difflineminus">-function getSmileyList(aThemeName)</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-{</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+function getSmileyList(aThemeName) {</span>
<a href="#l33.78"></a><span id="l33.78">   let theme = aThemeName == gTheme.name ? gTheme : getTheme(aThemeName);</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-  if (!theme.json)</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+  if (!theme.json) {</span>
<a href="#l33.81"></a><span id="l33.81">     return null;</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+  }</span>
<a href="#l33.83"></a><span id="l33.83"> </span>
<a href="#l33.84"></a><span id="l33.84">   let addAbsoluteUrls = function(aSmiley) {</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-    return {filename: aSmiley.filename,</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-            src: theme.baseUri + aSmiley.filename,</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-            textCodes: aSmiley.textCodes};</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+    return {</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+      filename: aSmiley.filename,</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+      src: theme.baseUri + aSmiley.filename,</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+      textCodes: aSmiley.textCodes,</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+    };</span>
<a href="#l33.93"></a><span id="l33.93">   };</span>
<a href="#l33.94"></a><span id="l33.94">   return theme.json.smileys.map(addAbsoluteUrls);</span>
<a href="#l33.95"></a><span id="l33.95"> }</span>
<a href="#l33.96"></a><span id="l33.96"> </span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-function getTheme(aName)</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-{</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+function getTheme(aName) {</span>
<a href="#l33.100"></a><span id="l33.100">   let name = aName || Services.prefs.getCharPref(kEmoticonsThemePref);</span>
<a href="#l33.101"></a><span id="l33.101"> </span>
<a href="#l33.102"></a><span id="l33.102">   let theme = {</span>
<a href="#l33.103"></a><span id="l33.103">     name,</span>
<a href="#l33.104"></a><span id="l33.104">     iconsHash: null,</span>
<a href="#l33.105"></a><span id="l33.105">     json: null,</span>
<a href="#l33.106"></a><span id="l33.106">     regExp: null,</span>
<a href="#l33.107"></a><span id="l33.107">   };</span>
<a href="#l33.108"></a><span id="l33.108"> </span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-  if (name == &quot;none&quot;)</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+  if (name == &quot;none&quot;) {</span>
<a href="#l33.111"></a><span id="l33.111">     return theme;</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+  }</span>
<a href="#l33.113"></a><span id="l33.113"> </span>
<a href="#l33.114"></a><span id="l33.114" class="difflineminus">-  if (name == &quot;default&quot;)</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+  if (name == &quot;default&quot;) {</span>
<a href="#l33.116"></a><span id="l33.116">     theme.baseUri = &quot;chrome://instantbird-emoticons/skin/&quot;;</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineminus">-  else</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+  } else {</span>
<a href="#l33.119"></a><span id="l33.119">     theme.baseUri = &quot;chrome://&quot; + theme.name + &quot;/skin/&quot;;</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+  }</span>
<a href="#l33.121"></a><span id="l33.121">   try {</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineminus">-    let channel = Services.io.newChannel(theme.baseUri + kThemeFile, null, null, null,</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineminus">-                                         Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineminus">-                                         null,</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineminus">-                                         Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-                                         Ci.nsIContentPolicy.TYPE_IMAGE);</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+    let channel = Services.io.newChannel(</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+      theme.baseUri + kThemeFile,</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+      null,</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+      null,</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+      null,</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+      null,</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineplus">+      Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+      Ci.nsIContentPolicy.TYPE_IMAGE</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+    );</span>
<a href="#l33.137"></a><span id="l33.137">     let stream = channel.open();</span>
<a href="#l33.138"></a><span id="l33.138">     let bytes = NetUtil.readInputStream(stream, stream.available());</span>
<a href="#l33.139"></a><span id="l33.139">     theme.json = JSON.parse(gTextDecoder.decode(bytes));</span>
<a href="#l33.140"></a><span id="l33.140">     stream.close();</span>
<a href="#l33.141"></a><span id="l33.141">     theme.iconsHash = {};</span>
<a href="#l33.142"></a><span id="l33.142">     for (let smiley of theme.json.smileys) {</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-      for (let textCode of smiley.textCodes)</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+      for (let textCode of smiley.textCodes) {</span>
<a href="#l33.145"></a><span id="l33.145">         theme.iconsHash[textCode] = smiley;</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+      }</span>
<a href="#l33.147"></a><span id="l33.147">     }</span>
<a href="#l33.148"></a><span id="l33.148">   } catch (e) {</span>
<a href="#l33.149"></a><span id="l33.149">     Cu.reportError(e);</span>
<a href="#l33.150"></a><span id="l33.150">   }</span>
<a href="#l33.151"></a><span id="l33.151">   return theme;</span>
<a href="#l33.152"></a><span id="l33.152"> }</span>
<a href="#l33.153"></a><span id="l33.153"> </span>
<a href="#l33.154"></a><span id="l33.154" class="difflineminus">-function getRegexp()</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineminus">-{</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+function getRegexp() {</span>
<a href="#l33.157"></a><span id="l33.157">   if (gTheme.regExp) {</span>
<a href="#l33.158"></a><span id="l33.158">     gTheme.regExp.lastIndex = 0;</span>
<a href="#l33.159"></a><span id="l33.159">     return gTheme.regExp;</span>
<a href="#l33.160"></a><span id="l33.160">   }</span>
<a href="#l33.161"></a><span id="l33.161"> </span>
<a href="#l33.162"></a><span id="l33.162">   // return null if smileys are disabled</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineminus">-  if (!gTheme.iconsHash)</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+  if (!gTheme.iconsHash) {</span>
<a href="#l33.165"></a><span id="l33.165">     return null;</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineplus">+  }</span>
<a href="#l33.167"></a><span id="l33.167"> </span>
<a href="#l33.168"></a><span id="l33.168">   if (&quot;&quot; in gTheme.iconsHash) {</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-    Cu.reportError(&quot;Emoticon &quot; +</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineminus">-                   gTheme.iconsHash[&quot;&quot;].filename +</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineminus">-                   &quot; matches the empty string!&quot;);</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineplus">+    Cu.reportError(</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+      &quot;Emoticon &quot; + gTheme.iconsHash[&quot;&quot;].filename + &quot; matches the empty string!&quot;</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+    );</span>
<a href="#l33.175"></a><span id="l33.175">     delete gTheme.iconsHash[&quot;&quot;];</span>
<a href="#l33.176"></a><span id="l33.176">   }</span>
<a href="#l33.177"></a><span id="l33.177"> </span>
<a href="#l33.178"></a><span id="l33.178">   let emoticonList = [];</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineminus">-  for (let emoticon in gTheme.iconsHash)</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineplus">+  for (let emoticon in gTheme.iconsHash) {</span>
<a href="#l33.181"></a><span id="l33.181">     emoticonList.push(emoticon);</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+  }</span>
<a href="#l33.183"></a><span id="l33.183"> </span>
<a href="#l33.184"></a><span id="l33.184">   let exp = /[[\]{}()*+?.\\^$|]/g;</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineminus">-  emoticonList = emoticonList.sort()</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineminus">-                             .reverse()</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineminus">-                             .map(x =&gt; x.replace(exp, &quot;\\$&amp;&quot;));</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+  emoticonList = emoticonList</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineplus">+    .sort()</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineplus">+    .reverse()</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineplus">+    .map(x =&gt; x.replace(exp, &quot;\\$&amp;&quot;));</span>
<a href="#l33.192"></a><span id="l33.192"> </span>
<a href="#l33.193"></a><span id="l33.193">   if (!emoticonList.length) {</span>
<a href="#l33.194"></a><span id="l33.194">     // the theme contains no valid emoticon, make sure we will return</span>
<a href="#l33.195"></a><span id="l33.195">     // early next time</span>
<a href="#l33.196"></a><span id="l33.196">     gTheme.iconsHash = null;</span>
<a href="#l33.197"></a><span id="l33.197">     return null;</span>
<a href="#l33.198"></a><span id="l33.198">   }</span>
<a href="#l33.199"></a><span id="l33.199"> </span>
<a href="#l33.200"></a><span id="l33.200">   gTheme.regExp = new RegExp(emoticonList.join(&quot;|&quot;), &quot;g&quot;);</span>
<a href="#l33.201"></a><span id="l33.201">   return gTheme.regExp;</span>
<a href="#l33.202"></a><span id="l33.202"> }</span>
<a href="#l33.203"></a><span id="l33.203"> </span>
<a href="#l33.204"></a><span id="l33.204"> // unused. May be useful later to process a string instead of an HTML node</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineminus">-function smileString(aString)</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineminus">-{</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineminus">-  const kSmileFormat = '&lt;img class=&quot;ib-img-smile&quot; src=&quot;smile://$&amp;&quot; alt=&quot;$&amp;&quot; title=&quot;$&amp;&quot;/&gt;';</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineplus">+function smileString(aString) {</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+  const kSmileFormat =</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineplus">+    '&lt;img class=&quot;ib-img-smile&quot; src=&quot;smile://$&amp;&quot; alt=&quot;$&amp;&quot; title=&quot;$&amp;&quot;/&gt;';</span>
<a href="#l33.211"></a><span id="l33.211"> </span>
<a href="#l33.212"></a><span id="l33.212">   let exp = getRegexp();</span>
<a href="#l33.213"></a><span id="l33.213">   return exp ? aString.replace(exp, kSmileFormat) : aString;</span>
<a href="#l33.214"></a><span id="l33.214"> }</span>
<a href="#l33.215"></a><span id="l33.215"> </span>
<a href="#l33.216"></a><span id="l33.216" class="difflineminus">-function smileTextNode(aNode)</span>
<a href="#l33.217"></a><span id="l33.217" class="difflineminus">-{</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineplus">+function smileTextNode(aNode) {</span>
<a href="#l33.219"></a><span id="l33.219">   /*</span>
<a href="#l33.220"></a><span id="l33.220">    * Skip text nodes that contain the href in the child text node.</span>
<a href="#l33.221"></a><span id="l33.221">    * We must check both the testNode.textContent and the aNode.data since they</span>
<a href="#l33.222"></a><span id="l33.222">    * cover different cases:</span>
<a href="#l33.223"></a><span id="l33.223">    *   textContent: The URL is split over multiple nodes for some reason</span>
<a href="#l33.224"></a><span id="l33.224">    *   data: The URL is not the only content in the link, skip only the one node</span>
<a href="#l33.225"></a><span id="l33.225">    * Check the class name to skip any autolinked nodes from mozTXTToHTMLConv.</span>
<a href="#l33.226"></a><span id="l33.226">    */</span>
<a href="#l33.227"></a><span id="l33.227">   let testNode = aNode;</span>
<a href="#l33.228"></a><span id="l33.228">   while ((testNode = testNode.parentNode)) {</span>
<a href="#l33.229"></a><span id="l33.229" class="difflineminus">-    if (testNode.nodeName.toLowerCase() == &quot;a&quot; &amp;&amp;</span>
<a href="#l33.230"></a><span id="l33.230" class="difflineminus">-        (testNode.getAttribute(&quot;href&quot;) == testNode.textContent.trim() ||</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineminus">-         testNode.getAttribute(&quot;href&quot;) == aNode.data.trim() ||</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineminus">-         testNode.className.includes(&quot;moz-txt-link-&quot;)))</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineplus">+    if (</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineplus">+      testNode.nodeName.toLowerCase() == &quot;a&quot; &amp;&amp;</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineplus">+      (testNode.getAttribute(&quot;href&quot;) == testNode.textContent.trim() ||</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineplus">+        testNode.getAttribute(&quot;href&quot;) == aNode.data.trim() ||</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineplus">+        testNode.className.includes(&quot;moz-txt-link-&quot;))</span>
<a href="#l33.238"></a><span id="l33.238" class="difflineplus">+    ) {</span>
<a href="#l33.239"></a><span id="l33.239">       return 0;</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineplus">+    }</span>
<a href="#l33.241"></a><span id="l33.241">   }</span>
<a href="#l33.242"></a><span id="l33.242"> </span>
<a href="#l33.243"></a><span id="l33.243">   let result = 0;</span>
<a href="#l33.244"></a><span id="l33.244">   let exp = getRegexp();</span>
<a href="#l33.245"></a><span id="l33.245" class="difflineminus">-  if (!exp)</span>
<a href="#l33.246"></a><span id="l33.246" class="difflineplus">+  if (!exp) {</span>
<a href="#l33.247"></a><span id="l33.247">     return result;</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineplus">+  }</span>
<a href="#l33.249"></a><span id="l33.249"> </span>
<a href="#l33.250"></a><span id="l33.250">   let match;</span>
<a href="#l33.251"></a><span id="l33.251">   while ((match = exp.exec(aNode.data))) {</span>
<a href="#l33.252"></a><span id="l33.252">     let smileNode = aNode.splitText(match.index);</span>
<a href="#l33.253"></a><span id="l33.253">     aNode = smileNode.splitText(exp.lastIndex - match.index);</span>
<a href="#l33.254"></a><span id="l33.254">     // at this point, smileNode is a text node with only the text</span>
<a href="#l33.255"></a><span id="l33.255">     // of the smiley and aNode is a text node with the text after</span>
<a href="#l33.256"></a><span id="l33.256">     // the smiley. The text in aNode hasn't been processed yet.</span>
<a href="#l33.257"></a><span id="l33.257" class="difflineat">@@ -195,39 +215,43 @@ function smileTextNode(aNode)</span>
<a href="#l33.258"></a><span id="l33.258">     elt.setAttribute(&quot;class&quot;, &quot;ib-img-smile&quot;);</span>
<a href="#l33.259"></a><span id="l33.259">     smileNode.parentNode.replaceChild(elt, smileNode);</span>
<a href="#l33.260"></a><span id="l33.260">     result += 2;</span>
<a href="#l33.261"></a><span id="l33.261">     exp.lastIndex = 0;</span>
<a href="#l33.262"></a><span id="l33.262">   }</span>
<a href="#l33.263"></a><span id="l33.263">   return result;</span>
<a href="#l33.264"></a><span id="l33.264"> }</span>
<a href="#l33.265"></a><span id="l33.265"> </span>
<a href="#l33.266"></a><span id="l33.266" class="difflineminus">-function smileNode(aNode)</span>
<a href="#l33.267"></a><span id="l33.267" class="difflineminus">-{</span>
<a href="#l33.268"></a><span id="l33.268" class="difflineplus">+function smileNode(aNode) {</span>
<a href="#l33.269"></a><span id="l33.269">   for (let i = 0; i &lt; aNode.childNodes.length; ++i) {</span>
<a href="#l33.270"></a><span id="l33.270">     let node = aNode.childNodes[i];</span>
<a href="#l33.271"></a><span id="l33.271" class="difflineminus">-    if (node.nodeType == node.ELEMENT_NODE &amp;&amp;</span>
<a href="#l33.272"></a><span id="l33.272" class="difflineminus">-        node.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;) {</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineplus">+    if (</span>
<a href="#l33.274"></a><span id="l33.274" class="difflineplus">+      node.nodeType == node.ELEMENT_NODE &amp;&amp;</span>
<a href="#l33.275"></a><span id="l33.275" class="difflineplus">+      node.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineplus">+    ) {</span>
<a href="#l33.277"></a><span id="l33.277">       // we are on a tag, recurse to process its children</span>
<a href="#l33.278"></a><span id="l33.278">       smileNode(node);</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineminus">-    } else if (node.nodeType == node.TEXT_NODE ||</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineminus">-               node.nodeType == node.CDATA_SECTION_NODE) {</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineplus">+    } else if (</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineplus">+      node.nodeType == node.TEXT_NODE ||</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineplus">+      node.nodeType == node.CDATA_SECTION_NODE</span>
<a href="#l33.284"></a><span id="l33.284" class="difflineplus">+    ) {</span>
<a href="#l33.285"></a><span id="l33.285">       // we are on a text node, process it</span>
<a href="#l33.286"></a><span id="l33.286">       smileTextNode(node);</span>
<a href="#l33.287"></a><span id="l33.287">     }</span>
<a href="#l33.288"></a><span id="l33.288">   }</span>
<a href="#l33.289"></a><span id="l33.289"> }</span>
<a href="#l33.290"></a><span id="l33.290"> </span>
<a href="#l33.291"></a><span id="l33.291" class="difflineminus">-function smileImMarkup(aDocument, aText)</span>
<a href="#l33.292"></a><span id="l33.292" class="difflineminus">-{</span>
<a href="#l33.293"></a><span id="l33.293" class="difflineminus">-  if (!aDocument)</span>
<a href="#l33.294"></a><span id="l33.294" class="difflineplus">+function smileImMarkup(aDocument, aText) {</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineplus">+  if (!aDocument) {</span>
<a href="#l33.296"></a><span id="l33.296">     throw new Error(&quot;providing an HTML document is required&quot;);</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineplus">+  }</span>
<a href="#l33.298"></a><span id="l33.298"> </span>
<a href="#l33.299"></a><span id="l33.299">   // return early if smileys are disabled</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineminus">-  if (!gTheme.iconsHash)</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineplus">+  if (!gTheme.iconsHash) {</span>
<a href="#l33.302"></a><span id="l33.302">     return aText;</span>
<a href="#l33.303"></a><span id="l33.303" class="difflineplus">+  }</span>
<a href="#l33.304"></a><span id="l33.304"> </span>
<a href="#l33.305"></a><span id="l33.305">   let div = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l33.306"></a><span id="l33.306">   // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l33.307"></a><span id="l33.307">   div.innerHTML = aText;</span>
<a href="#l33.308"></a><span id="l33.308">   smileNode(div);</span>
<a href="#l33.309"></a><span id="l33.309">   return div.innerHTML;</span>
<a href="#l33.310"></a><span id="l33.310"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/chat/modules/imStatusUtils.jsm</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/chat/modules/imStatusUtils.jsm</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.5"></a><span id="l34.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.6"></a><span id="l34.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.7"></a><span id="l34.7"> </span>
<a href="#l34.8"></a><span id="l34.8"> this.EXPORTED_SYMBOLS = [&quot;Status&quot;];</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">-var {</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  l10nHelper,</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+);</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l34.19"></a><span id="l34.19">   l10nHelper(&quot;chrome://chat/locale/status.properties&quot;)</span>
<a href="#l34.20"></a><span id="l34.20"> );</span>
<a href="#l34.21"></a><span id="l34.21"> </span>
<a href="#l34.22"></a><span id="l34.22"> var imIStatusInfo = Ci.imIStatusInfo;</span>
<a href="#l34.23"></a><span id="l34.23"> var statusAttributes = {};</span>
<a href="#l34.24"></a><span id="l34.24"> statusAttributes[imIStatusInfo.STATUS_UNKNOWN] = &quot;unknown&quot;;</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineat">@@ -27,28 +26,33 @@ statusAttributes[imIStatusInfo.STATUS_AV</span>
<a href="#l34.26"></a><span id="l34.26"> var Status = {</span>
<a href="#l34.27"></a><span id="l34.27">   toAttribute: aStatusType =&gt;</span>
<a href="#l34.28"></a><span id="l34.28">     aStatusType in statusAttributes ? statusAttributes[aStatusType] : &quot;unknown&quot;,</span>
<a href="#l34.29"></a><span id="l34.29"> </span>
<a href="#l34.30"></a><span id="l34.30">   _labels: {},</span>
<a href="#l34.31"></a><span id="l34.31">   toLabel(aStatusType, aStatusText) {</span>
<a href="#l34.32"></a><span id="l34.32">     // aStatusType may be either one of the (integral) imIStatusInfo status</span>
<a href="#l34.33"></a><span id="l34.33">     // constants, or one of the statusAttributes.</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-    if (!(typeof aStatusType == &quot;string&quot;))</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+    if (!(typeof aStatusType == &quot;string&quot;)) {</span>
<a href="#l34.36"></a><span id="l34.36">       aStatusType = this.toAttribute(aStatusType);</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+    }</span>
<a href="#l34.38"></a><span id="l34.38"> </span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-    if (!(aStatusType in this._labels))</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+    if (!(aStatusType in this._labels)) {</span>
<a href="#l34.41"></a><span id="l34.41">       this._labels[aStatusType] = _(aStatusType + &quot;StatusType&quot;);</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+    }</span>
<a href="#l34.43"></a><span id="l34.43"> </span>
<a href="#l34.44"></a><span id="l34.44">     let label = this._labels[aStatusType];</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-    if (aStatusText)</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+    if (aStatusText) {</span>
<a href="#l34.47"></a><span id="l34.47">       label = _(&quot;statusWithStatusMessage&quot;, label, aStatusText);</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+    }</span>
<a href="#l34.49"></a><span id="l34.49"> </span>
<a href="#l34.50"></a><span id="l34.50">     return label;</span>
<a href="#l34.51"></a><span id="l34.51">   },</span>
<a href="#l34.52"></a><span id="l34.52"> </span>
<a href="#l34.53"></a><span id="l34.53">   toFlag(aAttribute) {</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-    for (let flag in statusAttributes)</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-      if (statusAttributes[flag] == aAttribute)</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+    for (let flag in statusAttributes) {</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+      if (statusAttributes[flag] == aAttribute) {</span>
<a href="#l34.58"></a><span id="l34.58">         return flag;</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+      }</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+    }</span>
<a href="#l34.61"></a><span id="l34.61">     return imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l34.62"></a><span id="l34.62">   },</span>
<a href="#l34.63"></a><span id="l34.63"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/chat/modules/imTextboxUtils.jsm</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/chat/modules/imTextboxUtils.jsm</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,121 +1,134 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.5"></a><span id="l35.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.6"></a><span id="l35.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8" class="difflineminus">-this.EXPORTED_SYMBOLS = [</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineminus">-  &quot;MessageFormat&quot;,</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineminus">-  &quot;TextboxSize&quot;,</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineminus">-];</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;MessageFormat&quot;, &quot;TextboxSize&quot;];</span>
<a href="#l35.13"></a><span id="l35.13"> </span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l35.16"></a><span id="l35.16"> </span>
<a href="#l35.17"></a><span id="l35.17"> var MessageFormat = {</span>
<a href="#l35.18"></a><span id="l35.18">   _observedPrefs: [],</span>
<a href="#l35.19"></a><span id="l35.19"> </span>
<a href="#l35.20"></a><span id="l35.20">   getValues() {</span>
<a href="#l35.21"></a><span id="l35.21">     this.unregisterObservers();</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-    let langGroup =</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-      Services.prefs.getComplexValue(&quot;font.language.group&quot;,</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-                                     Ci.nsIPrefLocalizedString).data;</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+    let langGroup = Services.prefs.getComplexValue(</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+      &quot;font.language.group&quot;,</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+      Ci.nsIPrefLocalizedString</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+    ).data;</span>
<a href="#l35.29"></a><span id="l35.29">     let fontGroup = Services.prefs.getCharPref(&quot;font.default.&quot; + langGroup);</span>
<a href="#l35.30"></a><span id="l35.30">     let fontPref = &quot;font.name.&quot; + fontGroup + &quot;.&quot; + langGroup;</span>
<a href="#l35.31"></a><span id="l35.31">     let fontSizePref = &quot;font.size.variable.&quot; + langGroup;</span>
<a href="#l35.32"></a><span id="l35.32">     this._values = {</span>
<a href="#l35.33"></a><span id="l35.33">       langGroup,</span>
<a href="#l35.34"></a><span id="l35.34">       fontGroup,</span>
<a href="#l35.35"></a><span id="l35.35">       font: Services.prefs.getCharPref(fontPref),</span>
<a href="#l35.36"></a><span id="l35.36">       fontIsDefault: !Services.prefs.prefHasUserValue(fontPref),</span>
<a href="#l35.37"></a><span id="l35.37">       fontSize: Services.prefs.getIntPref(fontSizePref),</span>
<a href="#l35.38"></a><span id="l35.38">       fontSizeIsDefault: !Services.prefs.prefHasUserValue(fontSizePref),</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-      defaultFontSize:</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineminus">-        Services.prefs.getDefaultBranch(null).getIntPref(fontSizePref),</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-      foregroundColor:</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-        Services.prefs.getCharPref(&quot;browser.display.foreground_color&quot;),</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineminus">-      foregroundColorIsDefault:</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-        !Services.prefs.prefHasUserValue(&quot;browser.display.foreground_color&quot;),</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-      useSystemColor:</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-        Services.prefs.getBoolPref(&quot;browser.display.use_system_colors&quot;),</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+      defaultFontSize: Services.prefs</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+        .getDefaultBranch(null)</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+        .getIntPref(fontSizePref),</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+      foregroundColor: Services.prefs.getCharPref(</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+        &quot;browser.display.foreground_color&quot;</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+      ),</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+      foregroundColorIsDefault: !Services.prefs.prefHasUserValue(</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+        &quot;browser.display.foreground_color&quot;</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+      ),</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+      useSystemColor: Services.prefs.getBoolPref(</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+        &quot;browser.display.use_system_colors&quot;</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+      ),</span>
<a href="#l35.59"></a><span id="l35.59">     };</span>
<a href="#l35.60"></a><span id="l35.60"> </span>
<a href="#l35.61"></a><span id="l35.61">     this._observedPrefs = [</span>
<a href="#l35.62"></a><span id="l35.62">       &quot;font.language.group&quot;,</span>
<a href="#l35.63"></a><span id="l35.63">       &quot;font.default.&quot; + langGroup,</span>
<a href="#l35.64"></a><span id="l35.64">       &quot;font.name.&quot; + fontGroup + &quot;.&quot; + langGroup,</span>
<a href="#l35.65"></a><span id="l35.65">       &quot;font.size.variable.&quot; + langGroup,</span>
<a href="#l35.66"></a><span id="l35.66">       &quot;browser.display.foreground_color&quot;,</span>
<a href="#l35.67"></a><span id="l35.67">       &quot;browser.display.use_system_colors&quot;,</span>
<a href="#l35.68"></a><span id="l35.68">     ];</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineminus">-    for (let name of this._observedPrefs)</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+    for (let name of this._observedPrefs) {</span>
<a href="#l35.71"></a><span id="l35.71">       Services.prefs.addObserver(name, this);</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+    }</span>
<a href="#l35.73"></a><span id="l35.73">   },</span>
<a href="#l35.74"></a><span id="l35.74">   unregisterObservers() {</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineminus">-    for (let name of this._observedPrefs)</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+    for (let name of this._observedPrefs) {</span>
<a href="#l35.77"></a><span id="l35.77">       Services.prefs.removeObserver(name, this);</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+    }</span>
<a href="#l35.79"></a><span id="l35.79">     this._observedPrefs = [];</span>
<a href="#l35.80"></a><span id="l35.80">   },</span>
<a href="#l35.81"></a><span id="l35.81">   observe(aSubject, aTopic, aMsg) {</span>
<a href="#l35.82"></a><span id="l35.82">     this.getValues();</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineminus">-    for (let textbox of this._textboxes)</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+    for (let textbox of this._textboxes) {</span>
<a href="#l35.85"></a><span id="l35.85">       this.styleTextbox(textbox);</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+    }</span>
<a href="#l35.87"></a><span id="l35.87">   },</span>
<a href="#l35.88"></a><span id="l35.88">   _getColor() {</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineminus">-    if (this._values.foregroundColorIsDefault || this._values.useSystemColor)</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+    if (this._values.foregroundColorIsDefault || this._values.useSystemColor) {</span>
<a href="#l35.91"></a><span id="l35.91">       return &quot;&quot;;</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+    }</span>
<a href="#l35.93"></a><span id="l35.93">     return this._values.foregroundColor;</span>
<a href="#l35.94"></a><span id="l35.94">   },</span>
<a href="#l35.95"></a><span id="l35.95">   styleTextbox(aTextbox) {</span>
<a href="#l35.96"></a><span id="l35.96">     aTextbox.style.color = this._getColor();</span>
<a href="#l35.97"></a><span id="l35.97">     aTextbox.style.fontSize = this._values.fontSize + &quot;px&quot;;</span>
<a href="#l35.98"></a><span id="l35.98">     aTextbox.style.fontFamily = this._values.font;</span>
<a href="#l35.99"></a><span id="l35.99">   },</span>
<a href="#l35.100"></a><span id="l35.100">   getMessageStyle() {</span>
<a href="#l35.101"></a><span id="l35.101">     let result = {};</span>
<a href="#l35.102"></a><span id="l35.102"> </span>
<a href="#l35.103"></a><span id="l35.103">     let color = this._getColor();</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineminus">-    if (color)</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+    if (color) {</span>
<a href="#l35.106"></a><span id="l35.106">       result.color = color;</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+    }</span>
<a href="#l35.108"></a><span id="l35.108"> </span>
<a href="#l35.109"></a><span id="l35.109">     if (!this._values.fontSizeIsDefault) {</span>
<a href="#l35.110"></a><span id="l35.110">       result.fontSize = this._values.fontSize;</span>
<a href="#l35.111"></a><span id="l35.111">       result.defaultFontSize = this._values.defaultFontSize;</span>
<a href="#l35.112"></a><span id="l35.112">     }</span>
<a href="#l35.113"></a><span id="l35.113"> </span>
<a href="#l35.114"></a><span id="l35.114" class="difflineminus">-    if (!this._values.fontIsDefault)</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+    if (!this._values.fontIsDefault) {</span>
<a href="#l35.116"></a><span id="l35.116">       result.fontFamily = this._values.font;</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+    }</span>
<a href="#l35.118"></a><span id="l35.118"> </span>
<a href="#l35.119"></a><span id="l35.119">     return result;</span>
<a href="#l35.120"></a><span id="l35.120">   },</span>
<a href="#l35.121"></a><span id="l35.121">   _textboxes: [],</span>
<a href="#l35.122"></a><span id="l35.122">   registerTextbox(aTextbox) {</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineminus">-    if (!this._textboxes.includes(aTextbox))</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+    if (!this._textboxes.includes(aTextbox)) {</span>
<a href="#l35.125"></a><span id="l35.125">       this._textboxes.push(aTextbox);</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+    }</span>
<a href="#l35.127"></a><span id="l35.127"> </span>
<a href="#l35.128"></a><span id="l35.128" class="difflineminus">-    if (this._textboxes.length == 1)</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+    if (this._textboxes.length == 1) {</span>
<a href="#l35.130"></a><span id="l35.130">       this.getValues();</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+    }</span>
<a href="#l35.132"></a><span id="l35.132"> </span>
<a href="#l35.133"></a><span id="l35.133">     this.styleTextbox(aTextbox);</span>
<a href="#l35.134"></a><span id="l35.134">   },</span>
<a href="#l35.135"></a><span id="l35.135">   unregisterTextbox(aTextbox) {</span>
<a href="#l35.136"></a><span id="l35.136">     let index = this._textboxes.indexOf(aTextbox);</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-    if (index != -1)</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+    if (index != -1) {</span>
<a href="#l35.139"></a><span id="l35.139">       this._textboxes.splice(index, 1);</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+    }</span>
<a href="#l35.141"></a><span id="l35.141"> </span>
<a href="#l35.142"></a><span id="l35.142" class="difflineminus">-    if (!this._textboxes.length)</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+    if (!this._textboxes.length) {</span>
<a href="#l35.144"></a><span id="l35.144">       this.unregisterObservers();</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+    }</span>
<a href="#l35.146"></a><span id="l35.146">   },</span>
<a href="#l35.147"></a><span id="l35.147"> };</span>
<a href="#l35.148"></a><span id="l35.148"> </span>
<a href="#l35.149"></a><span id="l35.149"> var TextboxSize = {</span>
<a href="#l35.150"></a><span id="l35.150">   _textboxAutoResizePrefName: &quot;messenger.conversations.textbox.autoResize&quot;,</span>
<a href="#l35.151"></a><span id="l35.151">   get autoResize() {</span>
<a href="#l35.152"></a><span id="l35.152">     delete this.autoResize;</span>
<a href="#l35.153"></a><span id="l35.153">     Services.prefs.addObserver(this._textboxAutoResizePrefName, this);</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineminus">-    return this.autoResize =</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineminus">-      Services.prefs.getBoolPref(this._textboxAutoResizePrefName);</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+    return (this.autoResize = Services.prefs.getBoolPref(</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+      this._textboxAutoResizePrefName</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+    ));</span>
<a href="#l35.159"></a><span id="l35.159">   },</span>
<a href="#l35.160"></a><span id="l35.160">   observe(aSubject, aTopic, aMsg) {</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineminus">-    if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aMsg == this._textboxAutoResizePrefName)</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+    if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aMsg == this._textboxAutoResizePrefName) {</span>
<a href="#l35.163"></a><span id="l35.163">       this.autoResize = Services.prefs.getBoolPref(aMsg);</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+    }</span>
<a href="#l35.165"></a><span id="l35.165">   },</span>
<a href="#l35.166"></a><span id="l35.166"> };</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/chat/modules/imThemes.jsm</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/chat/modules/imThemes.jsm</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -9,19 +9,23 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l36.4"></a><span id="l36.4">   &quot;getThemeVariants&quot;,</span>
<a href="#l36.5"></a><span id="l36.5">   &quot;isNextMessage&quot;,</span>
<a href="#l36.6"></a><span id="l36.6">   &quot;insertHTMLForMessage&quot;,</span>
<a href="#l36.7"></a><span id="l36.7">   &quot;initHTMLDocument&quot;,</span>
<a href="#l36.8"></a><span id="l36.8">   &quot;getMessagesForRange&quot;,</span>
<a href="#l36.9"></a><span id="l36.9">   &quot;serializeSelection&quot;,</span>
<a href="#l36.10"></a><span id="l36.10"> ];</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-const {DownloadUtils} = ChromeUtils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+const { DownloadUtils } = ChromeUtils.import(</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+  &quot;resource://gre/modules/DownloadUtils.jsm&quot;</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+);</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+);</span>
<a href="#l36.22"></a><span id="l36.22"> </span>
<a href="#l36.23"></a><span id="l36.23"> var kMessagesStylePrefBranch = &quot;messenger.options.messagesStyle.&quot;;</span>
<a href="#l36.24"></a><span id="l36.24"> var kThemePref = &quot;theme&quot;;</span>
<a href="#l36.25"></a><span id="l36.25"> var kVariantPref = &quot;variant&quot;;</span>
<a href="#l36.26"></a><span id="l36.26"> var kShowHeaderPref = &quot;showHeader&quot;;</span>
<a href="#l36.27"></a><span id="l36.27"> var kCombineConsecutivePref = &quot;combineConsecutive&quot;;</span>
<a href="#l36.28"></a><span id="l36.28"> var kCombineConsecutiveIntervalPref = &quot;combineConsecutiveInterval&quot;;</span>
<a href="#l36.29"></a><span id="l36.29"> </span>
<a href="#l36.30"></a><span id="l36.30" class="difflineat">@@ -42,45 +46,53 @@ XPCOMUtils.defineLazyGetter(this, &quot;TXTTo</span>
<a href="#l36.31"></a><span id="l36.31"> XPCOMUtils.defineLazyGetter(this, &quot;gTimeFormatter&quot;, () =&gt; {</span>
<a href="#l36.32"></a><span id="l36.32">   return new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l36.33"></a><span id="l36.33">     hour: &quot;2-digit&quot;,</span>
<a href="#l36.34"></a><span id="l36.34">     minute: &quot;2-digit&quot;,</span>
<a href="#l36.35"></a><span id="l36.35">     second: &quot;2-digit&quot;,</span>
<a href="#l36.36"></a><span id="l36.36">   });</span>
<a href="#l36.37"></a><span id="l36.37"> });</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-ChromeUtils.defineModuleGetter(this,</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-  &quot;ToLocaleFormat&quot;, &quot;resource:///modules/ToLocaleFormat.jsm&quot;);</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+  this,</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+  &quot;ToLocaleFormat&quot;,</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+  &quot;resource:///modules/ToLocaleFormat.jsm&quot;</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+);</span>
<a href="#l36.46"></a><span id="l36.46"> </span>
<a href="#l36.47"></a><span id="l36.47"> var gCurrentTheme = null;</span>
<a href="#l36.48"></a><span id="l36.48"> </span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-function getChromeFile(aURI)</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-{</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+function getChromeFile(aURI) {</span>
<a href="#l36.52"></a><span id="l36.52">   try {</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-    let channel = Services.io.newChannel(aURI, null, null, null,</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-                                         Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-                                         null,</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-                                         Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-                                         Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+    let channel = Services.io.newChannel(</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+      aURI,</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+      null,</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+      null,</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+      null,</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+      null,</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+      Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+      Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+    );</span>
<a href="#l36.68"></a><span id="l36.68">     let stream = channel.open();</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-    let sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-                    .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+    let sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+      Ci.nsIScriptableInputStream</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+    );</span>
<a href="#l36.74"></a><span id="l36.74">     sstream.init(stream);</span>
<a href="#l36.75"></a><span id="l36.75">     let text = sstream.read(sstream.available());</span>
<a href="#l36.76"></a><span id="l36.76">     sstream.close();</span>
<a href="#l36.77"></a><span id="l36.77">     return text;</span>
<a href="#l36.78"></a><span id="l36.78">   } catch (e) {</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-    if (e.result != Cr.NS_ERROR_FILE_NOT_FOUND)</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+    if (e.result != Cr.NS_ERROR_FILE_NOT_FOUND) {</span>
<a href="#l36.81"></a><span id="l36.81">       dump(&quot;Getting &quot; + aURI + &quot;: &quot; + e + &quot;\n&quot;);</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+    }</span>
<a href="#l36.83"></a><span id="l36.83">     return null;</span>
<a href="#l36.84"></a><span id="l36.84">   }</span>
<a href="#l36.85"></a><span id="l36.85"> }</span>
<a href="#l36.86"></a><span id="l36.86"> </span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-function HTMLTheme(aBaseURI)</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-{</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+function HTMLTheme(aBaseURI) {</span>
<a href="#l36.90"></a><span id="l36.90">   let files = {</span>
<a href="#l36.91"></a><span id="l36.91">     footer: &quot;Footer.html&quot;,</span>
<a href="#l36.92"></a><span id="l36.92">     header: &quot;Header.html&quot;,</span>
<a href="#l36.93"></a><span id="l36.93">     status: &quot;Status.html&quot;,</span>
<a href="#l36.94"></a><span id="l36.94">     statusNext: &quot;NextStatus.html&quot;,</span>
<a href="#l36.95"></a><span id="l36.95">     incomingContent: &quot;Incoming/Content.html&quot;,</span>
<a href="#l36.96"></a><span id="l36.96">     incomingContext: &quot;Incoming/Context.html&quot;,</span>
<a href="#l36.97"></a><span id="l36.97">     incomingNextContent: &quot;Incoming/NextContent.html&quot;,</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineat">@@ -88,43 +100,70 @@ function HTMLTheme(aBaseURI)</span>
<a href="#l36.99"></a><span id="l36.99">     outgoingContent: &quot;Outgoing/Content.html&quot;,</span>
<a href="#l36.100"></a><span id="l36.100">     outgoingContext: &quot;Outgoing/Context.html&quot;,</span>
<a href="#l36.101"></a><span id="l36.101">     outgoingNextContent: &quot;Outgoing/NextContent.html&quot;,</span>
<a href="#l36.102"></a><span id="l36.102">     outgoingNextContext: &quot;Outgoing/NextContext.html&quot;,</span>
<a href="#l36.103"></a><span id="l36.103">   };</span>
<a href="#l36.104"></a><span id="l36.104"> </span>
<a href="#l36.105"></a><span id="l36.105">   for (let id in files) {</span>
<a href="#l36.106"></a><span id="l36.106">     let html = getChromeFile(aBaseURI + files[id]);</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineminus">-    if (html)</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineminus">-      Object.defineProperty(this, id, {value: html});</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+    if (html) {</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+      Object.defineProperty(this, id, { value: html });</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+    }</span>
<a href="#l36.112"></a><span id="l36.112">   }</span>
<a href="#l36.113"></a><span id="l36.113"> </span>
<a href="#l36.114"></a><span id="l36.114" class="difflineminus">-  if (!(&quot;incomingContent&quot; in files))</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+  if (!(&quot;incomingContent&quot; in files)) {</span>
<a href="#l36.116"></a><span id="l36.116">     throw new Error(&quot;Invalid theme: Incoming/Content.html is missing!&quot;);</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+  }</span>
<a href="#l36.118"></a><span id="l36.118"> }</span>
<a href="#l36.119"></a><span id="l36.119"> </span>
<a href="#l36.120"></a><span id="l36.120"> HTMLTheme.prototype = {</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineminus">-  get footer() { return &quot;&quot;; },</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-  get header() { return &quot;&quot;; },</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineminus">-  get status() { return this.incomingContent; },</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineminus">-  get statusNext() { return this.status; },</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+  get footer() {</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+  },</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+  get header() {</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+  },</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+  get status() {</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+    return this.incomingContent;</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+  },</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+  get statusNext() {</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+    return this.status;</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineplus">+  },</span>
<a href="#l36.137"></a><span id="l36.137">   get incomingContent() {</span>
<a href="#l36.138"></a><span id="l36.138">     throw new Error(&quot;Incoming/Content.html is a required file&quot;);</span>
<a href="#l36.139"></a><span id="l36.139">   },</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineminus">-  get incomingNextContent() { return this.incomingContent; },</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-  get outgoingContent() { return this.incomingContent; },</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-  get outgoingNextContent() { return this.incomingNextContent; },</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-  get incomingContext() { return this.incomingContent; },</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-  get incomingNextContext() { return this.incomingNextContent; },</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-  get outgoingContext() { return this.hasOwnProperty(&quot;outgoingContent&quot;) ? this.outgoingContent : this.incomingContext; },</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineminus">-  get outgoingNextContext() { return this.hasOwnProperty(&quot;outgoingNextContent&quot;) ? this.outgoingNextContent : this.incomingNextContext; },</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+  get incomingNextContent() {</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+    return this.incomingContent;</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+  },</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+  get outgoingContent() {</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineplus">+    return this.incomingContent;</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+  },</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+  get outgoingNextContent() {</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+    return this.incomingNextContent;</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+  },</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+  get incomingContext() {</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+    return this.incomingContent;</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+  },</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+  get incomingNextContext() {</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+    return this.incomingNextContent;</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+  },</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+  get outgoingContext() {</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineplus">+    return this.hasOwnProperty(&quot;outgoingContent&quot;)</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+      ? this.outgoingContent</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineplus">+      : this.incomingContext;</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+  },</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineplus">+  get outgoingNextContext() {</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineplus">+    return this.hasOwnProperty(&quot;outgoingNextContent&quot;)</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineplus">+      ? this.outgoingNextContent</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineplus">+      : this.incomingNextContext;</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineplus">+  },</span>
<a href="#l36.172"></a><span id="l36.172"> };</span>
<a href="#l36.173"></a><span id="l36.173"> </span>
<a href="#l36.174"></a><span id="l36.174" class="difflineminus">-function plistToJSON(aElt)</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineminus">-{</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+function plistToJSON(aElt) {</span>
<a href="#l36.177"></a><span id="l36.177">   switch (aElt.localName) {</span>
<a href="#l36.178"></a><span id="l36.178">     case &quot;true&quot;:</span>
<a href="#l36.179"></a><span id="l36.179">       return true;</span>
<a href="#l36.180"></a><span id="l36.180">     case &quot;false&quot;:</span>
<a href="#l36.181"></a><span id="l36.181">       return false;</span>
<a href="#l36.182"></a><span id="l36.182">     case &quot;string&quot;:</span>
<a href="#l36.183"></a><span id="l36.183">     case &quot;data&quot;:</span>
<a href="#l36.184"></a><span id="l36.184">       return aElt.textContent;</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineat">@@ -135,296 +174,335 @@ function plistToJSON(aElt)</span>
<a href="#l36.186"></a><span id="l36.186"> </span>
<a href="#l36.187"></a><span id="l36.187">     case &quot;dict&quot;:</span>
<a href="#l36.188"></a><span id="l36.188">       let res = {};</span>
<a href="#l36.189"></a><span id="l36.189">       let nodes = aElt.childNodes;</span>
<a href="#l36.190"></a><span id="l36.190">       for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l36.191"></a><span id="l36.191">         if (nodes[i].nodeName == &quot;key&quot;) {</span>
<a href="#l36.192"></a><span id="l36.192">           let key = nodes[i].textContent;</span>
<a href="#l36.193"></a><span id="l36.193">           ++i;</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineminus">-          while (!Element.isInstance(nodes[i]))</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+          while (!Element.isInstance(nodes[i])) {</span>
<a href="#l36.196"></a><span id="l36.196">             ++i;</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+          }</span>
<a href="#l36.198"></a><span id="l36.198">           res[key] = plistToJSON(nodes[i]);</span>
<a href="#l36.199"></a><span id="l36.199">         }</span>
<a href="#l36.200"></a><span id="l36.200">       }</span>
<a href="#l36.201"></a><span id="l36.201">       return res;</span>
<a href="#l36.202"></a><span id="l36.202"> </span>
<a href="#l36.203"></a><span id="l36.203">     case &quot;array&quot;:</span>
<a href="#l36.204"></a><span id="l36.204">       let array = [];</span>
<a href="#l36.205"></a><span id="l36.205">       nodes = aElt.childNodes;</span>
<a href="#l36.206"></a><span id="l36.206">       for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineminus">-        if (Element.isInstance(nodes[i]))</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineplus">+        if (Element.isInstance(nodes[i])) {</span>
<a href="#l36.209"></a><span id="l36.209">           array.push(plistToJSON(nodes[i]));</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineplus">+        }</span>
<a href="#l36.211"></a><span id="l36.211">       }</span>
<a href="#l36.212"></a><span id="l36.212">       return array;</span>
<a href="#l36.213"></a><span id="l36.213"> </span>
<a href="#l36.214"></a><span id="l36.214">     default:</span>
<a href="#l36.215"></a><span id="l36.215">       throw new Error(&quot;Unknown tag in plist file&quot;);</span>
<a href="#l36.216"></a><span id="l36.216">   }</span>
<a href="#l36.217"></a><span id="l36.217"> }</span>
<a href="#l36.218"></a><span id="l36.218"> </span>
<a href="#l36.219"></a><span id="l36.219" class="difflineminus">-function getInfoPlistContent(aBaseURI)</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineminus">-{</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineplus">+function getInfoPlistContent(aBaseURI) {</span>
<a href="#l36.222"></a><span id="l36.222">   try {</span>
<a href="#l36.223"></a><span id="l36.223" class="difflineminus">-    let channel = Services.io.newChannel(aBaseURI + &quot;Info.plist&quot;, null, null, null,</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineminus">-                                         Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineminus">-                                         null,</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineminus">-                                         Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineminus">-                                         Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+    let channel = Services.io.newChannel(</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+      aBaseURI + &quot;Info.plist&quot;,</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+      null,</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineplus">+      null,</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineplus">+      null,</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineplus">+      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l36.234"></a><span id="l36.234" class="difflineplus">+      null,</span>
<a href="#l36.235"></a><span id="l36.235" class="difflineplus">+      Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineplus">+      Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineplus">+    );</span>
<a href="#l36.238"></a><span id="l36.238">     let stream = channel.open();</span>
<a href="#l36.239"></a><span id="l36.239">     let parser = new DOMParser();</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineminus">-    let doc = parser.parseFromStream(stream, null, stream.available(), &quot;text/xml&quot;);</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineminus">-    if (doc.documentElement.localName != &quot;plist&quot;)</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineplus">+    let doc = parser.parseFromStream(</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineplus">+      stream,</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineplus">+      null,</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineplus">+      stream.available(),</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineplus">+      &quot;text/xml&quot;</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineplus">+    );</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineplus">+    if (doc.documentElement.localName != &quot;plist&quot;) {</span>
<a href="#l36.249"></a><span id="l36.249">       throw new Error(&quot;Invalid Info.plist file&quot;);</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+    }</span>
<a href="#l36.251"></a><span id="l36.251">     let node = doc.documentElement.firstChild;</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineminus">-    while (node &amp;&amp; !Element.isInstance(node))</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineplus">+    while (node &amp;&amp; !Element.isInstance(node)) {</span>
<a href="#l36.254"></a><span id="l36.254">       node = node.nextSibling;</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineminus">-    if (!node || node.localName != &quot;dict&quot;)</span>
<a href="#l36.256"></a><span id="l36.256" class="difflineplus">+    }</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineplus">+    if (!node || node.localName != &quot;dict&quot;) {</span>
<a href="#l36.258"></a><span id="l36.258">       throw new Error(&quot;Empty or invalid Info.plist file&quot;);</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineplus">+    }</span>
<a href="#l36.260"></a><span id="l36.260">     return plistToJSON(node);</span>
<a href="#l36.261"></a><span id="l36.261">   } catch (e) {</span>
<a href="#l36.262"></a><span id="l36.262">     Cu.reportError(e);</span>
<a href="#l36.263"></a><span id="l36.263">     return null;</span>
<a href="#l36.264"></a><span id="l36.264">   }</span>
<a href="#l36.265"></a><span id="l36.265"> }</span>
<a href="#l36.266"></a><span id="l36.266"> </span>
<a href="#l36.267"></a><span id="l36.267" class="difflineminus">-function getChromeBaseURI(aThemeName)</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineminus">-{</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineminus">-  if (DEFAULT_THEMES.includes(aThemeName))</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineplus">+function getChromeBaseURI(aThemeName) {</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineplus">+  if (DEFAULT_THEMES.includes(aThemeName)) {</span>
<a href="#l36.272"></a><span id="l36.272">     return &quot;chrome://messenger-messagestyles/skin/&quot; + aThemeName + &quot;/&quot;;</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+  }</span>
<a href="#l36.274"></a><span id="l36.274">   return &quot;chrome://&quot; + aThemeName + &quot;/skin/&quot;;</span>
<a href="#l36.275"></a><span id="l36.275"> }</span>
<a href="#l36.276"></a><span id="l36.276"> </span>
<a href="#l36.277"></a><span id="l36.277" class="difflineminus">-function getThemeByName(aName)</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineminus">-{</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineplus">+function getThemeByName(aName) {</span>
<a href="#l36.280"></a><span id="l36.280">   let baseURI = getChromeBaseURI(aName);</span>
<a href="#l36.281"></a><span id="l36.281">   let metadata = getInfoPlistContent(baseURI);</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineminus">-  if (!metadata)</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineplus">+  if (!metadata) {</span>
<a href="#l36.284"></a><span id="l36.284">     throw new Error(&quot;Cannot load theme &quot; + aName);</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineplus">+  }</span>
<a href="#l36.286"></a><span id="l36.286"> </span>
<a href="#l36.287"></a><span id="l36.287">   return {</span>
<a href="#l36.288"></a><span id="l36.288">     name: aName,</span>
<a href="#l36.289"></a><span id="l36.289">     variant: &quot;default&quot;,</span>
<a href="#l36.290"></a><span id="l36.290">     baseURI,</span>
<a href="#l36.291"></a><span id="l36.291">     metadata,</span>
<a href="#l36.292"></a><span id="l36.292">     html: new HTMLTheme(baseURI),</span>
<a href="#l36.293"></a><span id="l36.293">     showHeader: gPrefBranch.getBoolPref(kShowHeaderPref),</span>
<a href="#l36.294"></a><span id="l36.294">     combineConsecutive: gPrefBranch.getBoolPref(kCombineConsecutivePref),</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineminus">-    combineConsecutiveInterval: gPrefBranch.getIntPref(kCombineConsecutiveIntervalPref),</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineplus">+    combineConsecutiveInterval: gPrefBranch.getIntPref(</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineplus">+      kCombineConsecutiveIntervalPref</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineplus">+    ),</span>
<a href="#l36.299"></a><span id="l36.299">   };</span>
<a href="#l36.300"></a><span id="l36.300"> }</span>
<a href="#l36.301"></a><span id="l36.301"> </span>
<a href="#l36.302"></a><span id="l36.302" class="difflineminus">-function getCurrentTheme()</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineminus">-{</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineplus">+function getCurrentTheme() {</span>
<a href="#l36.305"></a><span id="l36.305">   let name = gPrefBranch.getCharPref(kThemePref);</span>
<a href="#l36.306"></a><span id="l36.306">   let variant = gPrefBranch.getCharPref(kVariantPref);</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineminus">-  if (gCurrentTheme &amp;&amp; gCurrentTheme.name == name &amp;&amp;</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineminus">-      gCurrentTheme.variant == variant)</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineplus">+  if (</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineplus">+    gCurrentTheme &amp;&amp;</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineplus">+    gCurrentTheme.name == name &amp;&amp;</span>
<a href="#l36.312"></a><span id="l36.312" class="difflineplus">+    gCurrentTheme.variant == variant</span>
<a href="#l36.313"></a><span id="l36.313" class="difflineplus">+  ) {</span>
<a href="#l36.314"></a><span id="l36.314">     return gCurrentTheme;</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineplus">+  }</span>
<a href="#l36.316"></a><span id="l36.316"> </span>
<a href="#l36.317"></a><span id="l36.317">   try {</span>
<a href="#l36.318"></a><span id="l36.318">     gCurrentTheme = getThemeByName(name);</span>
<a href="#l36.319"></a><span id="l36.319">     gCurrentTheme.variant = variant;</span>
<a href="#l36.320"></a><span id="l36.320">   } catch (e) {</span>
<a href="#l36.321"></a><span id="l36.321">     Cu.reportError(e);</span>
<a href="#l36.322"></a><span id="l36.322">     gCurrentTheme = getThemeByName(DEFAULT_THEME);</span>
<a href="#l36.323"></a><span id="l36.323">     gCurrentTheme.variant = &quot;default&quot;;</span>
<a href="#l36.324"></a><span id="l36.324">   }</span>
<a href="#l36.325"></a><span id="l36.325"> </span>
<a href="#l36.326"></a><span id="l36.326">   return gCurrentTheme;</span>
<a href="#l36.327"></a><span id="l36.327"> }</span>
<a href="#l36.328"></a><span id="l36.328"> </span>
<a href="#l36.329"></a><span id="l36.329" class="difflineminus">-function getDirectoryEntries(aDir)</span>
<a href="#l36.330"></a><span id="l36.330" class="difflineminus">-{</span>
<a href="#l36.331"></a><span id="l36.331" class="difflineplus">+function getDirectoryEntries(aDir) {</span>
<a href="#l36.332"></a><span id="l36.332">   let ios = Services.io;</span>
<a href="#l36.333"></a><span id="l36.333">   let uri = ios.newURI(aDir);</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineminus">-  let cr = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineminus">-             .getService(Ci.nsIXULChromeRegistry);</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineminus">-  while (uri.scheme == &quot;chrome&quot;)</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineplus">+  let cr = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;].getService(</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineplus">+    Ci.nsIXULChromeRegistry</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineplus">+  );</span>
<a href="#l36.340"></a><span id="l36.340" class="difflineplus">+  while (uri.scheme == &quot;chrome&quot;) {</span>
<a href="#l36.341"></a><span id="l36.341">     uri = cr.convertChromeURL(uri);</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineplus">+  }</span>
<a href="#l36.343"></a><span id="l36.343"> </span>
<a href="#l36.344"></a><span id="l36.344">   // remove any trailing file name added by convertChromeURL</span>
<a href="#l36.345"></a><span id="l36.345">   let spec = uri.spec.replace(/[^\/]+$/, &quot;&quot;);</span>
<a href="#l36.346"></a><span id="l36.346">   uri = ios.newURI(spec);</span>
<a href="#l36.347"></a><span id="l36.347"> </span>
<a href="#l36.348"></a><span id="l36.348">   let results = [];</span>
<a href="#l36.349"></a><span id="l36.349">   if (uri.scheme == &quot;jar&quot;) {</span>
<a href="#l36.350"></a><span id="l36.350">     uri.QueryInterface(Ci.nsIJARURI);</span>
<a href="#l36.351"></a><span id="l36.351">     let strEntry = uri.JAREntry;</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineminus">-    if (!strEntry)</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineplus">+    if (!strEntry) {</span>
<a href="#l36.354"></a><span id="l36.354">       return [];</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineplus">+    }</span>
<a href="#l36.356"></a><span id="l36.356"> </span>
<a href="#l36.357"></a><span id="l36.357" class="difflineminus">-    let zr = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l36.358"></a><span id="l36.358" class="difflineminus">-               .createInstance(Ci.nsIZipReader);</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineplus">+    let zr = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;].createInstance(</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineplus">+      Ci.nsIZipReader</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineplus">+    );</span>
<a href="#l36.362"></a><span id="l36.362">     let jarFile = uri.JARFile;</span>
<a href="#l36.363"></a><span id="l36.363">     if (jarFile instanceof Ci.nsIJARURI) {</span>
<a href="#l36.364"></a><span id="l36.364" class="difflineminus">-      let innerZr = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l36.365"></a><span id="l36.365" class="difflineminus">-                      .createInstance(Ci.nsIZipReader);</span>
<a href="#l36.366"></a><span id="l36.366" class="difflineplus">+      let innerZr = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;].createInstance(</span>
<a href="#l36.367"></a><span id="l36.367" class="difflineplus">+        Ci.nsIZipReader</span>
<a href="#l36.368"></a><span id="l36.368" class="difflineplus">+      );</span>
<a href="#l36.369"></a><span id="l36.369">       innerZr.open(jarFile.JARFile.QueryInterface(Ci.nsIFileURL).file);</span>
<a href="#l36.370"></a><span id="l36.370">       zr.openInner(innerZr, jarFile.JAREntry);</span>
<a href="#l36.371"></a><span id="l36.371" class="difflineplus">+    } else {</span>
<a href="#l36.372"></a><span id="l36.372" class="difflineplus">+      zr.open(jarFile.QueryInterface(Ci.nsIFileURL).file);</span>
<a href="#l36.373"></a><span id="l36.373">     }</span>
<a href="#l36.374"></a><span id="l36.374" class="difflineminus">-    else</span>
<a href="#l36.375"></a><span id="l36.375" class="difflineminus">-      zr.open(jarFile.QueryInterface(Ci.nsIFileURL).file);</span>
<a href="#l36.376"></a><span id="l36.376"> </span>
<a href="#l36.377"></a><span id="l36.377">     if (!zr.hasEntry(strEntry) || !zr.getEntry(strEntry).isDirectory) {</span>
<a href="#l36.378"></a><span id="l36.378">       zr.close();</span>
<a href="#l36.379"></a><span id="l36.379">       return [];</span>
<a href="#l36.380"></a><span id="l36.380">     }</span>
<a href="#l36.381"></a><span id="l36.381"> </span>
<a href="#l36.382"></a><span id="l36.382">     let escapedEntry = strEntry.replace(/([*?$[\]^~()\\])/g, &quot;\\$1&quot;);</span>
<a href="#l36.383"></a><span id="l36.383">     let filter = escapedEntry + &quot;?*~&quot; + escapedEntry + &quot;?*/?*&quot;;</span>
<a href="#l36.384"></a><span id="l36.384">     let entries = zr.findEntries(filter);</span>
<a href="#l36.385"></a><span id="l36.385"> </span>
<a href="#l36.386"></a><span id="l36.386">     let parentLength = strEntry.length;</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineminus">-    while (entries.hasMore())</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineplus">+    while (entries.hasMore()) {</span>
<a href="#l36.389"></a><span id="l36.389">       results.push(entries.getNext().substring(parentLength));</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineplus">+    }</span>
<a href="#l36.391"></a><span id="l36.391">     zr.close();</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineminus">-  }</span>
<a href="#l36.393"></a><span id="l36.393" class="difflineminus">-  else if (uri.scheme == &quot;file&quot;) {</span>
<a href="#l36.394"></a><span id="l36.394" class="difflineplus">+  } else if (uri.scheme == &quot;file&quot;) {</span>
<a href="#l36.395"></a><span id="l36.395">     uri.QueryInterface(Ci.nsIFileURL);</span>
<a href="#l36.396"></a><span id="l36.396">     let dir = uri.file;</span>
<a href="#l36.397"></a><span id="l36.397"> </span>
<a href="#l36.398"></a><span id="l36.398" class="difflineminus">-    if (!dir.exists() || !dir.isDirectory())</span>
<a href="#l36.399"></a><span id="l36.399" class="difflineplus">+    if (!dir.exists() || !dir.isDirectory()) {</span>
<a href="#l36.400"></a><span id="l36.400">       return [];</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineplus">+    }</span>
<a href="#l36.402"></a><span id="l36.402"> </span>
<a href="#l36.403"></a><span id="l36.403">     let children = dir.directoryEntries;</span>
<a href="#l36.404"></a><span id="l36.404">     while (children.hasMoreElements()) {</span>
<a href="#l36.405"></a><span id="l36.405">       let file = children.nextFile;</span>
<a href="#l36.406"></a><span id="l36.406">       results.push(file.leafName);</span>
<a href="#l36.407"></a><span id="l36.407">     }</span>
<a href="#l36.408"></a><span id="l36.408">   }</span>
<a href="#l36.409"></a><span id="l36.409"> </span>
<a href="#l36.410"></a><span id="l36.410">   return results;</span>
<a href="#l36.411"></a><span id="l36.411"> }</span>
<a href="#l36.412"></a><span id="l36.412"> </span>
<a href="#l36.413"></a><span id="l36.413" class="difflineminus">-function getThemeVariants(aTheme)</span>
<a href="#l36.414"></a><span id="l36.414" class="difflineminus">-{</span>
<a href="#l36.415"></a><span id="l36.415" class="difflineplus">+function getThemeVariants(aTheme) {</span>
<a href="#l36.416"></a><span id="l36.416">   let variants = getDirectoryEntries(aTheme.baseURI + &quot;Variants/&quot;);</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineminus">-  return variants.filter(v =&gt; v.endsWith(&quot;.css&quot;))</span>
<a href="#l36.418"></a><span id="l36.418" class="difflineminus">-                 .map(v =&gt; v.substring(0, v.length - 4));</span>
<a href="#l36.419"></a><span id="l36.419" class="difflineplus">+  return variants</span>
<a href="#l36.420"></a><span id="l36.420" class="difflineplus">+    .filter(v =&gt; v.endsWith(&quot;.css&quot;))</span>
<a href="#l36.421"></a><span id="l36.421" class="difflineplus">+    .map(v =&gt; v.substring(0, v.length - 4));</span>
<a href="#l36.422"></a><span id="l36.422"> }</span>
<a href="#l36.423"></a><span id="l36.423"> </span>
<a href="#l36.424"></a><span id="l36.424"> /* helper function for replacements in messages */</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineminus">-function getBuddyFromMessage(aMsg)</span>
<a href="#l36.426"></a><span id="l36.426" class="difflineminus">-{</span>
<a href="#l36.427"></a><span id="l36.427" class="difflineplus">+function getBuddyFromMessage(aMsg) {</span>
<a href="#l36.428"></a><span id="l36.428">   if (aMsg.incoming) {</span>
<a href="#l36.429"></a><span id="l36.429">     let conv = aMsg.conversation;</span>
<a href="#l36.430"></a><span id="l36.430" class="difflineminus">-    if (!conv.isChat)</span>
<a href="#l36.431"></a><span id="l36.431" class="difflineplus">+    if (!conv.isChat) {</span>
<a href="#l36.432"></a><span id="l36.432">       return conv.buddy;</span>
<a href="#l36.433"></a><span id="l36.433" class="difflineplus">+    }</span>
<a href="#l36.434"></a><span id="l36.434">   }</span>
<a href="#l36.435"></a><span id="l36.435"> </span>
<a href="#l36.436"></a><span id="l36.436">   return null;</span>
<a href="#l36.437"></a><span id="l36.437"> }</span>
<a href="#l36.438"></a><span id="l36.438"> </span>
<a href="#l36.439"></a><span id="l36.439" class="difflineminus">-function getStatusIconFromBuddy(aBuddy)</span>
<a href="#l36.440"></a><span id="l36.440" class="difflineminus">-{</span>
<a href="#l36.441"></a><span id="l36.441" class="difflineplus">+function getStatusIconFromBuddy(aBuddy) {</span>
<a href="#l36.442"></a><span id="l36.442">   let status = &quot;unknown&quot;;</span>
<a href="#l36.443"></a><span id="l36.443">   if (aBuddy) {</span>
<a href="#l36.444"></a><span id="l36.444" class="difflineminus">-    if (!aBuddy.online)</span>
<a href="#l36.445"></a><span id="l36.445" class="difflineplus">+    if (!aBuddy.online) {</span>
<a href="#l36.446"></a><span id="l36.446">       status = &quot;offline&quot;;</span>
<a href="#l36.447"></a><span id="l36.447" class="difflineminus">-    else if (aBuddy.idle)</span>
<a href="#l36.448"></a><span id="l36.448" class="difflineplus">+    } else if (aBuddy.idle) {</span>
<a href="#l36.449"></a><span id="l36.449">       status = &quot;idle&quot;;</span>
<a href="#l36.450"></a><span id="l36.450" class="difflineminus">-    else if (!aBuddy.available)</span>
<a href="#l36.451"></a><span id="l36.451" class="difflineplus">+    } else if (!aBuddy.available) {</span>
<a href="#l36.452"></a><span id="l36.452">       status = &quot;away&quot;;</span>
<a href="#l36.453"></a><span id="l36.453" class="difflineminus">-    else</span>
<a href="#l36.454"></a><span id="l36.454" class="difflineplus">+    } else {</span>
<a href="#l36.455"></a><span id="l36.455">       status = &quot;available&quot;;</span>
<a href="#l36.456"></a><span id="l36.456" class="difflineplus">+    }</span>
<a href="#l36.457"></a><span id="l36.457">   }</span>
<a href="#l36.458"></a><span id="l36.458"> </span>
<a href="#l36.459"></a><span id="l36.459">   return &quot;chrome://chat/skin/&quot; + status + &quot;-16.png&quot;;</span>
<a href="#l36.460"></a><span id="l36.460"> }</span>
<a href="#l36.461"></a><span id="l36.461"> </span>
<a href="#l36.462"></a><span id="l36.462"> var headerFooterReplacements = {</span>
<a href="#l36.463"></a><span id="l36.463">   chatName: aConv =&gt; TXTToHTML(aConv.title),</span>
<a href="#l36.464"></a><span id="l36.464">   sourceName: aConv =&gt; TXTToHTML(aConv.account.alias || aConv.account.name),</span>
<a href="#l36.465"></a><span id="l36.465">   destinationName: aConv =&gt; TXTToHTML(aConv.name),</span>
<a href="#l36.466"></a><span id="l36.466">   destinationDisplayName: aConv =&gt; TXTToHTML(aConv.title),</span>
<a href="#l36.467"></a><span id="l36.467">   incomingIconPath(aConv) {</span>
<a href="#l36.468"></a><span id="l36.468">     let buddy;</span>
<a href="#l36.469"></a><span id="l36.469" class="difflineminus">-    return (!aConv.isChat &amp;&amp; (buddy = aConv.buddy) &amp;&amp;</span>
<a href="#l36.470"></a><span id="l36.470" class="difflineminus">-            buddy.buddyIconFilename) || &quot;incoming_icon.png&quot;;</span>
<a href="#l36.471"></a><span id="l36.471" class="difflineplus">+    return (</span>
<a href="#l36.472"></a><span id="l36.472" class="difflineplus">+      (!aConv.isChat &amp;&amp; (buddy = aConv.buddy) &amp;&amp; buddy.buddyIconFilename) ||</span>
<a href="#l36.473"></a><span id="l36.473" class="difflineplus">+      &quot;incoming_icon.png&quot;</span>
<a href="#l36.474"></a><span id="l36.474" class="difflineplus">+    );</span>
<a href="#l36.475"></a><span id="l36.475">   },</span>
<a href="#l36.476"></a><span id="l36.476">   outgoingIconPath: aConv =&gt; &quot;outgoing_icon.png&quot;,</span>
<a href="#l36.477"></a><span id="l36.477">   timeOpened(aConv, aFormat) {</span>
<a href="#l36.478"></a><span id="l36.478">     let date = new Date(aConv.startDate / 1000);</span>
<a href="#l36.479"></a><span id="l36.479" class="difflineminus">-    if (aFormat)</span>
<a href="#l36.480"></a><span id="l36.480" class="difflineplus">+    if (aFormat) {</span>
<a href="#l36.481"></a><span id="l36.481">       return ToLocaleFormat(aFormat, date);</span>
<a href="#l36.482"></a><span id="l36.482" class="difflineplus">+    }</span>
<a href="#l36.483"></a><span id="l36.483">     return gTimeFormatter.format(date);</span>
<a href="#l36.484"></a><span id="l36.484">   },</span>
<a href="#l36.485"></a><span id="l36.485"> };</span>
<a href="#l36.486"></a><span id="l36.486"> </span>
<a href="#l36.487"></a><span id="l36.487"> function formatAutoResponce(aTxt) {</span>
<a href="#l36.488"></a><span id="l36.488">   return Services.strings</span>
<a href="#l36.489"></a><span id="l36.489" class="difflineminus">-                 .createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l36.490"></a><span id="l36.490" class="difflineminus">-                 .formatStringFromName(&quot;autoReply&quot;, [aTxt]);</span>
<a href="#l36.491"></a><span id="l36.491" class="difflineplus">+    .createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l36.492"></a><span id="l36.492" class="difflineplus">+    .formatStringFromName(&quot;autoReply&quot;, [aTxt]);</span>
<a href="#l36.493"></a><span id="l36.493"> }</span>
<a href="#l36.494"></a><span id="l36.494"> </span>
<a href="#l36.495"></a><span id="l36.495"> var statusMessageReplacements = {</span>
<a href="#l36.496"></a><span id="l36.496" class="difflineminus">-  message: aMsg =&gt; &quot;&lt;span class=\&quot;ib-msg-txt\&quot;&gt;&quot; +</span>
<a href="#l36.497"></a><span id="l36.497" class="difflineminus">-                   (aMsg.autoResponse ? formatAutoResponce(aMsg.message) : aMsg.message) +</span>
<a href="#l36.498"></a><span id="l36.498" class="difflineminus">-                   &quot;&lt;/span&gt;&quot;,</span>
<a href="#l36.499"></a><span id="l36.499" class="difflineplus">+  message: aMsg =&gt;</span>
<a href="#l36.500"></a><span id="l36.500" class="difflineplus">+    '&lt;span class=&quot;ib-msg-txt&quot;&gt;' +</span>
<a href="#l36.501"></a><span id="l36.501" class="difflineplus">+    (aMsg.autoResponse ? formatAutoResponce(aMsg.message) : aMsg.message) +</span>
<a href="#l36.502"></a><span id="l36.502" class="difflineplus">+    &quot;&lt;/span&gt;&quot;,</span>
<a href="#l36.503"></a><span id="l36.503">   time(aMsg, aFormat) {</span>
<a href="#l36.504"></a><span id="l36.504">     let date = new Date(aMsg.time * 1000);</span>
<a href="#l36.505"></a><span id="l36.505" class="difflineminus">-    if (aFormat)</span>
<a href="#l36.506"></a><span id="l36.506" class="difflineplus">+    if (aFormat) {</span>
<a href="#l36.507"></a><span id="l36.507">       return ToLocaleFormat(aFormat, date);</span>
<a href="#l36.508"></a><span id="l36.508" class="difflineplus">+    }</span>
<a href="#l36.509"></a><span id="l36.509">     return gTimeFormatter.format(date);</span>
<a href="#l36.510"></a><span id="l36.510">   },</span>
<a href="#l36.511"></a><span id="l36.511">   timestamp: aMsg =&gt; aMsg.time,</span>
<a href="#l36.512"></a><span id="l36.512">   shortTime(aMsg) {</span>
<a href="#l36.513"></a><span id="l36.513">     return gTimeFormatter.format(new Date(aMsg.time * 1000));</span>
<a href="#l36.514"></a><span id="l36.514">   },</span>
<a href="#l36.515"></a><span id="l36.515">   messageClasses(aMsg) {</span>
<a href="#l36.516"></a><span id="l36.516">     let msgClass = [];</span>
<a href="#l36.517"></a><span id="l36.517"> </span>
<a href="#l36.518"></a><span id="l36.518" class="difflineminus">-    if (aMsg.system)</span>
<a href="#l36.519"></a><span id="l36.519" class="difflineplus">+    if (aMsg.system) {</span>
<a href="#l36.520"></a><span id="l36.520">       msgClass.push(&quot;event&quot;);</span>
<a href="#l36.521"></a><span id="l36.521" class="difflineminus">-    else {</span>
<a href="#l36.522"></a><span id="l36.522" class="difflineplus">+    } else {</span>
<a href="#l36.523"></a><span id="l36.523">       msgClass.push(&quot;message&quot;);</span>
<a href="#l36.524"></a><span id="l36.524"> </span>
<a href="#l36.525"></a><span id="l36.525" class="difflineminus">-      if (aMsg.incoming)</span>
<a href="#l36.526"></a><span id="l36.526" class="difflineplus">+      if (aMsg.incoming) {</span>
<a href="#l36.527"></a><span id="l36.527">         msgClass.push(&quot;incoming&quot;);</span>
<a href="#l36.528"></a><span id="l36.528" class="difflineminus">-      else if (aMsg.outgoing)</span>
<a href="#l36.529"></a><span id="l36.529" class="difflineplus">+      } else if (aMsg.outgoing) {</span>
<a href="#l36.530"></a><span id="l36.530">         msgClass.push(&quot;outgoing&quot;);</span>
<a href="#l36.531"></a><span id="l36.531" class="difflineplus">+      }</span>
<a href="#l36.532"></a><span id="l36.532"> </span>
<a href="#l36.533"></a><span id="l36.533" class="difflineminus">-      if (/^(&lt;[^&gt;]+&gt;)*\/me /.test(aMsg.displayMessage))</span>
<a href="#l36.534"></a><span id="l36.534" class="difflineplus">+      if (/^(&lt;[^&gt;]+&gt;)*\/me /.test(aMsg.displayMessage)) {</span>
<a href="#l36.535"></a><span id="l36.535">         msgClass.push(&quot;action&quot;);</span>
<a href="#l36.536"></a><span id="l36.536" class="difflineplus">+      }</span>
<a href="#l36.537"></a><span id="l36.537"> </span>
<a href="#l36.538"></a><span id="l36.538" class="difflineminus">-      if (aMsg.autoResponse)</span>
<a href="#l36.539"></a><span id="l36.539" class="difflineplus">+      if (aMsg.autoResponse) {</span>
<a href="#l36.540"></a><span id="l36.540">         msgClass.push(&quot;autoreply&quot;);</span>
<a href="#l36.541"></a><span id="l36.541" class="difflineplus">+      }</span>
<a href="#l36.542"></a><span id="l36.542">     }</span>
<a href="#l36.543"></a><span id="l36.543"> </span>
<a href="#l36.544"></a><span id="l36.544" class="difflineminus">-    if (aMsg.containsNick)</span>
<a href="#l36.545"></a><span id="l36.545" class="difflineplus">+    if (aMsg.containsNick) {</span>
<a href="#l36.546"></a><span id="l36.546">       msgClass.push(&quot;nick&quot;);</span>
<a href="#l36.547"></a><span id="l36.547" class="difflineminus">-    if (aMsg.error)</span>
<a href="#l36.548"></a><span id="l36.548" class="difflineplus">+    }</span>
<a href="#l36.549"></a><span id="l36.549" class="difflineplus">+    if (aMsg.error) {</span>
<a href="#l36.550"></a><span id="l36.550">       msgClass.push(&quot;error&quot;);</span>
<a href="#l36.551"></a><span id="l36.551" class="difflineminus">-    if (aMsg.delayed)</span>
<a href="#l36.552"></a><span id="l36.552" class="difflineplus">+    }</span>
<a href="#l36.553"></a><span id="l36.553" class="difflineplus">+    if (aMsg.delayed) {</span>
<a href="#l36.554"></a><span id="l36.554">       msgClass.push(&quot;delayed&quot;);</span>
<a href="#l36.555"></a><span id="l36.555" class="difflineminus">-    if (aMsg.notification)</span>
<a href="#l36.556"></a><span id="l36.556" class="difflineplus">+    }</span>
<a href="#l36.557"></a><span id="l36.557" class="difflineplus">+    if (aMsg.notification) {</span>
<a href="#l36.558"></a><span id="l36.558">       msgClass.push(&quot;notification&quot;);</span>
<a href="#l36.559"></a><span id="l36.559" class="difflineminus">-    if (aMsg.noFormat)</span>
<a href="#l36.560"></a><span id="l36.560" class="difflineplus">+    }</span>
<a href="#l36.561"></a><span id="l36.561" class="difflineplus">+    if (aMsg.noFormat) {</span>
<a href="#l36.562"></a><span id="l36.562">       msgClass.push(&quot;monospaced&quot;);</span>
<a href="#l36.563"></a><span id="l36.563" class="difflineplus">+    }</span>
<a href="#l36.564"></a><span id="l36.564"> </span>
<a href="#l36.565"></a><span id="l36.565">     return msgClass.join(&quot; &quot;);</span>
<a href="#l36.566"></a><span id="l36.566">   },</span>
<a href="#l36.567"></a><span id="l36.567"> };</span>
<a href="#l36.568"></a><span id="l36.568"> </span>
<a href="#l36.569"></a><span id="l36.569"> function formatSender(aName) {</span>
<a href="#l36.570"></a><span id="l36.570" class="difflineminus">-  return &quot;&lt;span class=\&quot;ib-sender\&quot;&gt;&quot; + TXTToHTML(aName) + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l36.571"></a><span id="l36.571" class="difflineplus">+  return '&lt;span class=&quot;ib-sender&quot;&gt;' + TXTToHTML(aName) + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l36.572"></a><span id="l36.572"> }</span>
<a href="#l36.573"></a><span id="l36.573"> var messageReplacements = {</span>
<a href="#l36.574"></a><span id="l36.574">   userIconPath(aMsg) {</span>
<a href="#l36.575"></a><span id="l36.575">     // If the protocol plugin provides an icon for the message, use it.</span>
<a href="#l36.576"></a><span id="l36.576">     let iconURL = aMsg.iconURL;</span>
<a href="#l36.577"></a><span id="l36.577" class="difflineminus">-    if (iconURL)</span>
<a href="#l36.578"></a><span id="l36.578" class="difflineplus">+    if (iconURL) {</span>
<a href="#l36.579"></a><span id="l36.579">       return iconURL;</span>
<a href="#l36.580"></a><span id="l36.580" class="difflineplus">+    }</span>
<a href="#l36.581"></a><span id="l36.581"> </span>
<a href="#l36.582"></a><span id="l36.582">     // For outgoing messages, use the current user icon.</span>
<a href="#l36.583"></a><span id="l36.583">     if (aMsg.outgoing) {</span>
<a href="#l36.584"></a><span id="l36.584">       iconURL = aMsg.conversation.account.statusInfo.getUserIcon();</span>
<a href="#l36.585"></a><span id="l36.585" class="difflineminus">-      if (iconURL)</span>
<a href="#l36.586"></a><span id="l36.586" class="difflineplus">+      if (iconURL) {</span>
<a href="#l36.587"></a><span id="l36.587">         return iconURL.spec;</span>
<a href="#l36.588"></a><span id="l36.588" class="difflineplus">+      }</span>
<a href="#l36.589"></a><span id="l36.589">     }</span>
<a href="#l36.590"></a><span id="l36.590"> </span>
<a href="#l36.591"></a><span id="l36.591">     // Fallback to the theme's default icons.</span>
<a href="#l36.592"></a><span id="l36.592">     return (aMsg.incoming ? &quot;Incoming&quot; : &quot;Outgoing&quot;) + &quot;/buddy_icon.png&quot;;</span>
<a href="#l36.593"></a><span id="l36.593">   },</span>
<a href="#l36.594"></a><span id="l36.594">   senderScreenName: aMsg =&gt; formatSender(aMsg.who),</span>
<a href="#l36.595"></a><span id="l36.595">   sender: aMsg =&gt; formatSender(aMsg.alias || aMsg.who),</span>
<a href="#l36.596"></a><span id="l36.596">   senderColor: aMsg =&gt; aMsg.color,</span>
<a href="#l36.597"></a><span id="l36.597" class="difflineat">@@ -438,101 +516,110 @@ var messageReplacements = {</span>
<a href="#l36.598"></a><span id="l36.598">   __proto__: statusMessageReplacements,</span>
<a href="#l36.599"></a><span id="l36.599"> };</span>
<a href="#l36.600"></a><span id="l36.600"> </span>
<a href="#l36.601"></a><span id="l36.601"> var statusReplacements = {</span>
<a href="#l36.602"></a><span id="l36.602">   status: aMsg =&gt; &quot;&quot;, // FIXME</span>
<a href="#l36.603"></a><span id="l36.603">   statusIcon(aMsg) {</span>
<a href="#l36.604"></a><span id="l36.604">     let conv = aMsg.conversation;</span>
<a href="#l36.605"></a><span id="l36.605">     let buddy = null;</span>
<a href="#l36.606"></a><span id="l36.606" class="difflineminus">-    if (!conv.isChat)</span>
<a href="#l36.607"></a><span id="l36.607" class="difflineplus">+    if (!conv.isChat) {</span>
<a href="#l36.608"></a><span id="l36.608">       buddy = conv.buddy;</span>
<a href="#l36.609"></a><span id="l36.609" class="difflineplus">+    }</span>
<a href="#l36.610"></a><span id="l36.610">     return getStatusIconFromBuddy(buddy);</span>
<a href="#l36.611"></a><span id="l36.611">   },</span>
<a href="#l36.612"></a><span id="l36.612">   __proto__: statusMessageReplacements,</span>
<a href="#l36.613"></a><span id="l36.613"> };</span>
<a href="#l36.614"></a><span id="l36.614"> </span>
<a href="#l36.615"></a><span id="l36.615"> var kReplacementRegExp = /%([a-zA-Z]*)(\{([^\}]*)\})?%/g;</span>
<a href="#l36.616"></a><span id="l36.616"> </span>
<a href="#l36.617"></a><span id="l36.617" class="difflineminus">-function replaceKeywordsInHTML(aHTML, aReplacements, aReplacementArg)</span>
<a href="#l36.618"></a><span id="l36.618" class="difflineminus">-{</span>
<a href="#l36.619"></a><span id="l36.619" class="difflineplus">+function replaceKeywordsInHTML(aHTML, aReplacements, aReplacementArg) {</span>
<a href="#l36.620"></a><span id="l36.620">   kReplacementRegExp.lastIndex = 0;</span>
<a href="#l36.621"></a><span id="l36.621">   let previousIndex = 0;</span>
<a href="#l36.622"></a><span id="l36.622">   let result = &quot;&quot;;</span>
<a href="#l36.623"></a><span id="l36.623">   let match;</span>
<a href="#l36.624"></a><span id="l36.624">   while ((match = kReplacementRegExp.exec(aHTML))) {</span>
<a href="#l36.625"></a><span id="l36.625">     let content = &quot;&quot;;</span>
<a href="#l36.626"></a><span id="l36.626" class="difflineminus">-    if (match[1] in aReplacements)</span>
<a href="#l36.627"></a><span id="l36.627" class="difflineplus">+    if (match[1] in aReplacements) {</span>
<a href="#l36.628"></a><span id="l36.628">       content = aReplacements[match[1]](aReplacementArg, match[3]);</span>
<a href="#l36.629"></a><span id="l36.629" class="difflineminus">-    else</span>
<a href="#l36.630"></a><span id="l36.630" class="difflineminus">-      Cu.reportError(&quot;Unknown replacement string %&quot; +</span>
<a href="#l36.631"></a><span id="l36.631" class="difflineminus">-                     match[1] + &quot;% in message styles.&quot;);</span>
<a href="#l36.632"></a><span id="l36.632" class="difflineplus">+    } else {</span>
<a href="#l36.633"></a><span id="l36.633" class="difflineplus">+      Cu.reportError(</span>
<a href="#l36.634"></a><span id="l36.634" class="difflineplus">+        &quot;Unknown replacement string %&quot; + match[1] + &quot;% in message styles.&quot;</span>
<a href="#l36.635"></a><span id="l36.635" class="difflineplus">+      );</span>
<a href="#l36.636"></a><span id="l36.636" class="difflineplus">+    }</span>
<a href="#l36.637"></a><span id="l36.637">     result += aHTML.substring(previousIndex, match.index) + content;</span>
<a href="#l36.638"></a><span id="l36.638">     previousIndex = kReplacementRegExp.lastIndex;</span>
<a href="#l36.639"></a><span id="l36.639">   }</span>
<a href="#l36.640"></a><span id="l36.640"> </span>
<a href="#l36.641"></a><span id="l36.641">   return result + aHTML.slice(previousIndex);</span>
<a href="#l36.642"></a><span id="l36.642"> }</span>
<a href="#l36.643"></a><span id="l36.643"> </span>
<a href="#l36.644"></a><span id="l36.644" class="difflineminus">-function isNextMessage(aTheme, aMsg, aPreviousMsg)</span>
<a href="#l36.645"></a><span id="l36.645" class="difflineminus">-{</span>
<a href="#l36.646"></a><span id="l36.646" class="difflineminus">-  if (!aTheme.combineConsecutive ||</span>
<a href="#l36.647"></a><span id="l36.647" class="difflineminus">-      (hasMetadataKey(aTheme, &quot;DisableCombineConsecutive&quot;) &amp;&amp;</span>
<a href="#l36.648"></a><span id="l36.648" class="difflineminus">-       getMetadata(aTheme, &quot;DisableCombineConsecutive&quot;)))</span>
<a href="#l36.649"></a><span id="l36.649" class="difflineplus">+function isNextMessage(aTheme, aMsg, aPreviousMsg) {</span>
<a href="#l36.650"></a><span id="l36.650" class="difflineplus">+  if (</span>
<a href="#l36.651"></a><span id="l36.651" class="difflineplus">+    !aTheme.combineConsecutive ||</span>
<a href="#l36.652"></a><span id="l36.652" class="difflineplus">+    (hasMetadataKey(aTheme, &quot;DisableCombineConsecutive&quot;) &amp;&amp;</span>
<a href="#l36.653"></a><span id="l36.653" class="difflineplus">+      getMetadata(aTheme, &quot;DisableCombineConsecutive&quot;))</span>
<a href="#l36.654"></a><span id="l36.654" class="difflineplus">+  ) {</span>
<a href="#l36.655"></a><span id="l36.655">     return false;</span>
<a href="#l36.656"></a><span id="l36.656" class="difflineplus">+  }</span>
<a href="#l36.657"></a><span id="l36.657"> </span>
<a href="#l36.658"></a><span id="l36.658" class="difflineminus">-  if (!aPreviousMsg)</span>
<a href="#l36.659"></a><span id="l36.659" class="difflineplus">+  if (!aPreviousMsg) {</span>
<a href="#l36.660"></a><span id="l36.660">     return false;</span>
<a href="#l36.661"></a><span id="l36.661" class="difflineplus">+  }</span>
<a href="#l36.662"></a><span id="l36.662"> </span>
<a href="#l36.663"></a><span id="l36.663" class="difflineminus">-  if (aMsg.system &amp;&amp; aPreviousMsg.system)</span>
<a href="#l36.664"></a><span id="l36.664" class="difflineplus">+  if (aMsg.system &amp;&amp; aPreviousMsg.system) {</span>
<a href="#l36.665"></a><span id="l36.665">     return true;</span>
<a href="#l36.666"></a><span id="l36.666" class="difflineplus">+  }</span>
<a href="#l36.667"></a><span id="l36.667"> </span>
<a href="#l36.668"></a><span id="l36.668" class="difflineminus">-  if (aMsg.who != aPreviousMsg.who ||</span>
<a href="#l36.669"></a><span id="l36.669" class="difflineminus">-      aMsg.outgoing != aPreviousMsg.outgoing ||</span>
<a href="#l36.670"></a><span id="l36.670" class="difflineminus">-      aMsg.incoming != aPreviousMsg.incoming)</span>
<a href="#l36.671"></a><span id="l36.671" class="difflineplus">+  if (</span>
<a href="#l36.672"></a><span id="l36.672" class="difflineplus">+    aMsg.who != aPreviousMsg.who ||</span>
<a href="#l36.673"></a><span id="l36.673" class="difflineplus">+    aMsg.outgoing != aPreviousMsg.outgoing ||</span>
<a href="#l36.674"></a><span id="l36.674" class="difflineplus">+    aMsg.incoming != aPreviousMsg.incoming</span>
<a href="#l36.675"></a><span id="l36.675" class="difflineplus">+  ) {</span>
<a href="#l36.676"></a><span id="l36.676">     return false;</span>
<a href="#l36.677"></a><span id="l36.677" class="difflineplus">+  }</span>
<a href="#l36.678"></a><span id="l36.678"> </span>
<a href="#l36.679"></a><span id="l36.679">   let timeDifference = aMsg.time - aPreviousMsg.time;</span>
<a href="#l36.680"></a><span id="l36.680" class="difflineminus">-  return (timeDifference &gt;= 0 &amp;&amp;</span>
<a href="#l36.681"></a><span id="l36.681" class="difflineminus">-          timeDifference &lt;= aTheme.combineConsecutiveInterval);</span>
<a href="#l36.682"></a><span id="l36.682" class="difflineplus">+  return (</span>
<a href="#l36.683"></a><span id="l36.683" class="difflineplus">+    timeDifference &gt;= 0 &amp;&amp; timeDifference &lt;= aTheme.combineConsecutiveInterval</span>
<a href="#l36.684"></a><span id="l36.684" class="difflineplus">+  );</span>
<a href="#l36.685"></a><span id="l36.685"> }</span>
<a href="#l36.686"></a><span id="l36.686"> </span>
<a href="#l36.687"></a><span id="l36.687" class="difflineminus">-function getHTMLForMessage(aMsg, aTheme, aIsNext, aIsContext)</span>
<a href="#l36.688"></a><span id="l36.688" class="difflineminus">-{</span>
<a href="#l36.689"></a><span id="l36.689" class="difflineplus">+function getHTMLForMessage(aMsg, aTheme, aIsNext, aIsContext) {</span>
<a href="#l36.690"></a><span id="l36.690">   let html, replacements;</span>
<a href="#l36.691"></a><span id="l36.691">   if (aMsg.system) {</span>
<a href="#l36.692"></a><span id="l36.692">     html = aIsNext ? aTheme.html.statusNext : aTheme.html.status;</span>
<a href="#l36.693"></a><span id="l36.693">     replacements = statusReplacements;</span>
<a href="#l36.694"></a><span id="l36.694" class="difflineminus">-  }</span>
<a href="#l36.695"></a><span id="l36.695" class="difflineminus">-  else {</span>
<a href="#l36.696"></a><span id="l36.696" class="difflineplus">+  } else {</span>
<a href="#l36.697"></a><span id="l36.697">     html = aMsg.incoming ? &quot;incoming&quot; : &quot;outgoing&quot;;</span>
<a href="#l36.698"></a><span id="l36.698" class="difflineminus">-    if (aIsNext)</span>
<a href="#l36.699"></a><span id="l36.699" class="difflineplus">+    if (aIsNext) {</span>
<a href="#l36.700"></a><span id="l36.700">       html += &quot;Next&quot;;</span>
<a href="#l36.701"></a><span id="l36.701" class="difflineplus">+    }</span>
<a href="#l36.702"></a><span id="l36.702">     html += aIsContext ? &quot;Context&quot; : &quot;Content&quot;;</span>
<a href="#l36.703"></a><span id="l36.703">     html = aTheme.html[html];</span>
<a href="#l36.704"></a><span id="l36.704">     replacements = messageReplacements;</span>
<a href="#l36.705"></a><span id="l36.705">     let meRegExp = /^((&lt;[^&gt;]+&gt;)*)\/me /;</span>
<a href="#l36.706"></a><span id="l36.706">     // We must test displayMessage here as aMsg.message loses its /me</span>
<a href="#l36.707"></a><span id="l36.707">     // in the following, so if getHTMLForMessage is called a second time for</span>
<a href="#l36.708"></a><span id="l36.708">     // the same aMsg (e.g. because it follows the unread ruler), the test</span>
<a href="#l36.709"></a><span id="l36.709">     // would fail otherwise.</span>
<a href="#l36.710"></a><span id="l36.710">     if (meRegExp.test(aMsg.displayMessage)) {</span>
<a href="#l36.711"></a><span id="l36.711">       aMsg.message = aMsg.message.replace(meRegExp, &quot;$1&quot;);</span>
<a href="#l36.712"></a><span id="l36.712">       let actionMessageTemplate = &quot;* %message% *&quot;;</span>
<a href="#l36.713"></a><span id="l36.713" class="difflineminus">-      if (hasMetadataKey(aTheme, &quot;ActionMessageTemplate&quot;))</span>
<a href="#l36.714"></a><span id="l36.714" class="difflineplus">+      if (hasMetadataKey(aTheme, &quot;ActionMessageTemplate&quot;)) {</span>
<a href="#l36.715"></a><span id="l36.715">         actionMessageTemplate = getMetadata(aTheme, &quot;ActionMessageTemplate&quot;);</span>
<a href="#l36.716"></a><span id="l36.716" class="difflineplus">+      }</span>
<a href="#l36.717"></a><span id="l36.717">       html = html.replace(/%message%/g, actionMessageTemplate);</span>
<a href="#l36.718"></a><span id="l36.718">     }</span>
<a href="#l36.719"></a><span id="l36.719">   }</span>
<a href="#l36.720"></a><span id="l36.720"> </span>
<a href="#l36.721"></a><span id="l36.721">   return replaceKeywordsInHTML(html, replacements, aMsg);</span>
<a href="#l36.722"></a><span id="l36.722"> }</span>
<a href="#l36.723"></a><span id="l36.723"> </span>
<a href="#l36.724"></a><span id="l36.724" class="difflineminus">-function insertHTMLForMessage(aMsg, aHTML, aDoc, aIsNext)</span>
<a href="#l36.725"></a><span id="l36.725" class="difflineminus">-{</span>
<a href="#l36.726"></a><span id="l36.726" class="difflineplus">+function insertHTMLForMessage(aMsg, aHTML, aDoc, aIsNext) {</span>
<a href="#l36.727"></a><span id="l36.727">   let insert = aDoc.getElementById(&quot;insert&quot;);</span>
<a href="#l36.728"></a><span id="l36.728">   if (insert &amp;&amp; !aIsNext) {</span>
<a href="#l36.729"></a><span id="l36.729">     insert.remove();</span>
<a href="#l36.730"></a><span id="l36.730">     insert = null;</span>
<a href="#l36.731"></a><span id="l36.731">   }</span>
<a href="#l36.732"></a><span id="l36.732"> </span>
<a href="#l36.733"></a><span id="l36.733">   let range = aDoc.createRange();</span>
<a href="#l36.734"></a><span id="l36.734">   let parent = insert ? insert.parentNode : aDoc.getElementById(&quot;Chat&quot;);</span>
<a href="#l36.735"></a><span id="l36.735" class="difflineat">@@ -540,145 +627,165 @@ function insertHTMLForMessage(aMsg, aHTM</span>
<a href="#l36.736"></a><span id="l36.736">   // eslint-disable-next-line no-unsanitized/method</span>
<a href="#l36.737"></a><span id="l36.737">   let documentFragment = range.createContextualFragment(aHTML);</span>
<a href="#l36.738"></a><span id="l36.738">   let result = documentFragment.firstChild;</span>
<a href="#l36.739"></a><span id="l36.739"> </span>
<a href="#l36.740"></a><span id="l36.740">   // store the prplIMessage object in each of the &quot;root&quot; node that</span>
<a href="#l36.741"></a><span id="l36.741">   // will be inserted into the document, so that selection code can</span>
<a href="#l36.742"></a><span id="l36.742">   // retrieve the message by just looking at the parent node until it</span>
<a href="#l36.743"></a><span id="l36.743">   // finds something.</span>
<a href="#l36.744"></a><span id="l36.744" class="difflineminus">-  for (let root = result; root; root = root.nextSibling)</span>
<a href="#l36.745"></a><span id="l36.745" class="difflineplus">+  for (let root = result; root; root = root.nextSibling) {</span>
<a href="#l36.746"></a><span id="l36.746">     root._originalMsg = aMsg;</span>
<a href="#l36.747"></a><span id="l36.747" class="difflineplus">+  }</span>
<a href="#l36.748"></a><span id="l36.748"> </span>
<a href="#l36.749"></a><span id="l36.749">   // make sure the result is an HTMLElement and not some text (whitespace)...</span>
<a href="#l36.750"></a><span id="l36.750" class="difflineminus">-  while (result &amp;&amp;</span>
<a href="#l36.751"></a><span id="l36.751" class="difflineminus">-         !(result.nodeType == result.ELEMENT_NODE &amp;&amp;</span>
<a href="#l36.752"></a><span id="l36.752" class="difflineminus">-           result.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;))</span>
<a href="#l36.753"></a><span id="l36.753" class="difflineplus">+  while (</span>
<a href="#l36.754"></a><span id="l36.754" class="difflineplus">+    result &amp;&amp;</span>
<a href="#l36.755"></a><span id="l36.755" class="difflineplus">+    !(</span>
<a href="#l36.756"></a><span id="l36.756" class="difflineplus">+      result.nodeType == result.ELEMENT_NODE &amp;&amp;</span>
<a href="#l36.757"></a><span id="l36.757" class="difflineplus">+      result.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l36.758"></a><span id="l36.758" class="difflineplus">+    )</span>
<a href="#l36.759"></a><span id="l36.759" class="difflineplus">+  ) {</span>
<a href="#l36.760"></a><span id="l36.760">     result = result.nextSibling;</span>
<a href="#l36.761"></a><span id="l36.761" class="difflineminus">-  if (insert)</span>
<a href="#l36.762"></a><span id="l36.762" class="difflineplus">+  }</span>
<a href="#l36.763"></a><span id="l36.763" class="difflineplus">+  if (insert) {</span>
<a href="#l36.764"></a><span id="l36.764">     parent.replaceChild(documentFragment, insert);</span>
<a href="#l36.765"></a><span id="l36.765" class="difflineminus">-  else</span>
<a href="#l36.766"></a><span id="l36.766" class="difflineplus">+  } else {</span>
<a href="#l36.767"></a><span id="l36.767">     parent.appendChild(documentFragment);</span>
<a href="#l36.768"></a><span id="l36.768" class="difflineplus">+  }</span>
<a href="#l36.769"></a><span id="l36.769">   return result;</span>
<a href="#l36.770"></a><span id="l36.770"> }</span>
<a href="#l36.771"></a><span id="l36.771"> </span>
<a href="#l36.772"></a><span id="l36.772" class="difflineminus">-function hasMetadataKey(aTheme, aKey)</span>
<a href="#l36.773"></a><span id="l36.773" class="difflineminus">-{</span>
<a href="#l36.774"></a><span id="l36.774" class="difflineminus">-  return (aKey in aTheme.metadata) ||</span>
<a href="#l36.775"></a><span id="l36.775" class="difflineminus">-         ((aTheme.variant != &quot;default&quot;) &amp;&amp;</span>
<a href="#l36.776"></a><span id="l36.776" class="difflineminus">-          (aKey + &quot;:&quot; + aTheme.variant) in aTheme.metadata) ||</span>
<a href="#l36.777"></a><span id="l36.777" class="difflineminus">-         ((&quot;DefaultVariant&quot; in aTheme.metadata) &amp;&amp;</span>
<a href="#l36.778"></a><span id="l36.778" class="difflineminus">-          ((aKey + &quot;:&quot; + aTheme.metadata.DefaultVariant) in aTheme.metadata));</span>
<a href="#l36.779"></a><span id="l36.779" class="difflineplus">+function hasMetadataKey(aTheme, aKey) {</span>
<a href="#l36.780"></a><span id="l36.780" class="difflineplus">+  return (</span>
<a href="#l36.781"></a><span id="l36.781" class="difflineplus">+    aKey in aTheme.metadata ||</span>
<a href="#l36.782"></a><span id="l36.782" class="difflineplus">+    (aTheme.variant != &quot;default&quot; &amp;&amp;</span>
<a href="#l36.783"></a><span id="l36.783" class="difflineplus">+      aKey + &quot;:&quot; + aTheme.variant in aTheme.metadata) ||</span>
<a href="#l36.784"></a><span id="l36.784" class="difflineplus">+    (&quot;DefaultVariant&quot; in aTheme.metadata &amp;&amp;</span>
<a href="#l36.785"></a><span id="l36.785" class="difflineplus">+      aKey + &quot;:&quot; + aTheme.metadata.DefaultVariant in aTheme.metadata)</span>
<a href="#l36.786"></a><span id="l36.786" class="difflineplus">+  );</span>
<a href="#l36.787"></a><span id="l36.787"> }</span>
<a href="#l36.788"></a><span id="l36.788"> </span>
<a href="#l36.789"></a><span id="l36.789" class="difflineminus">-function getMetadata(aTheme, aKey)</span>
<a href="#l36.790"></a><span id="l36.790" class="difflineminus">-{</span>
<a href="#l36.791"></a><span id="l36.791" class="difflineminus">-  if ((aTheme.variant != &quot;default&quot;) &amp;&amp;</span>
<a href="#l36.792"></a><span id="l36.792" class="difflineminus">-      (aKey + &quot;:&quot; + aTheme.variant) in aTheme.metadata)</span>
<a href="#l36.793"></a><span id="l36.793" class="difflineplus">+function getMetadata(aTheme, aKey) {</span>
<a href="#l36.794"></a><span id="l36.794" class="difflineplus">+  if (</span>
<a href="#l36.795"></a><span id="l36.795" class="difflineplus">+    aTheme.variant != &quot;default&quot; &amp;&amp;</span>
<a href="#l36.796"></a><span id="l36.796" class="difflineplus">+    aKey + &quot;:&quot; + aTheme.variant in aTheme.metadata</span>
<a href="#l36.797"></a><span id="l36.797" class="difflineplus">+  ) {</span>
<a href="#l36.798"></a><span id="l36.798">     return aTheme.metadata[aKey + &quot;:&quot; + aTheme.variant];</span>
<a href="#l36.799"></a><span id="l36.799" class="difflineplus">+  }</span>
<a href="#l36.800"></a><span id="l36.800"> </span>
<a href="#l36.801"></a><span id="l36.801" class="difflineminus">-  if ((&quot;DefaultVariant&quot; in aTheme.metadata) &amp;&amp;</span>
<a href="#l36.802"></a><span id="l36.802" class="difflineminus">-      ((aKey + &quot;:&quot; + aTheme.metadata.DefaultVariant) in aTheme.metadata))</span>
<a href="#l36.803"></a><span id="l36.803" class="difflineplus">+  if (</span>
<a href="#l36.804"></a><span id="l36.804" class="difflineplus">+    &quot;DefaultVariant&quot; in aTheme.metadata &amp;&amp;</span>
<a href="#l36.805"></a><span id="l36.805" class="difflineplus">+    aKey + &quot;:&quot; + aTheme.metadata.DefaultVariant in aTheme.metadata</span>
<a href="#l36.806"></a><span id="l36.806" class="difflineplus">+  ) {</span>
<a href="#l36.807"></a><span id="l36.807">     return aTheme.metadata[aKey + &quot;:&quot; + aTheme.metadata.DefaultVariant];</span>
<a href="#l36.808"></a><span id="l36.808" class="difflineplus">+  }</span>
<a href="#l36.809"></a><span id="l36.809"> </span>
<a href="#l36.810"></a><span id="l36.810">   return aTheme.metadata[aKey];</span>
<a href="#l36.811"></a><span id="l36.811"> }</span>
<a href="#l36.812"></a><span id="l36.812"> </span>
<a href="#l36.813"></a><span id="l36.813" class="difflineminus">-function initHTMLDocument(aConv, aTheme, aDoc)</span>
<a href="#l36.814"></a><span id="l36.814" class="difflineminus">-{</span>
<a href="#l36.815"></a><span id="l36.815" class="difflineminus">-  let HTML = &quot;&lt;html&gt;&lt;head&gt;&lt;base href=\&quot;&quot; + aTheme.baseURI + &quot;\&quot;/&gt;&quot;;</span>
<a href="#l36.816"></a><span id="l36.816" class="difflineplus">+function initHTMLDocument(aConv, aTheme, aDoc) {</span>
<a href="#l36.817"></a><span id="l36.817" class="difflineplus">+  let HTML = '&lt;html&gt;&lt;head&gt;&lt;base href=&quot;' + aTheme.baseURI + '&quot;/&gt;';</span>
<a href="#l36.818"></a><span id="l36.818"> </span>
<a href="#l36.819"></a><span id="l36.819">   // Screen readers may read the title of the document, so provide one</span>
<a href="#l36.820"></a><span id="l36.820">   // to avoid an ugly fallback to the URL (see bug 1165).</span>
<a href="#l36.821"></a><span id="l36.821">   HTML += &quot;&lt;title&gt;&quot; + aConv.title + &quot;&lt;/title&gt;&quot;;</span>
<a href="#l36.822"></a><span id="l36.822"> </span>
<a href="#l36.823"></a><span id="l36.823" class="difflineminus">-  function addCSS(aHref)</span>
<a href="#l36.824"></a><span id="l36.824" class="difflineminus">-  {</span>
<a href="#l36.825"></a><span id="l36.825" class="difflineminus">-    HTML += &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;&quot; + aHref + &quot;\&quot; type=\&quot;text/css\&quot;/&gt;&quot;;</span>
<a href="#l36.826"></a><span id="l36.826" class="difflineplus">+  function addCSS(aHref) {</span>
<a href="#l36.827"></a><span id="l36.827" class="difflineplus">+    HTML += '&lt;link rel=&quot;stylesheet&quot; href=&quot;' + aHref + '&quot; type=&quot;text/css&quot;/&gt;';</span>
<a href="#l36.828"></a><span id="l36.828">   }</span>
<a href="#l36.829"></a><span id="l36.829">   addCSS(&quot;chrome://chat/skin/conv.css&quot;);</span>
<a href="#l36.830"></a><span id="l36.830"> </span>
<a href="#l36.831"></a><span id="l36.831">   // add css to handle DefaultFontFamily and DefaultFontSize</span>
<a href="#l36.832"></a><span id="l36.832">   let cssText = &quot;&quot;;</span>
<a href="#l36.833"></a><span id="l36.833" class="difflineminus">-  if (hasMetadataKey(aTheme, &quot;DefaultFontFamily&quot;))</span>
<a href="#l36.834"></a><span id="l36.834" class="difflineplus">+  if (hasMetadataKey(aTheme, &quot;DefaultFontFamily&quot;)) {</span>
<a href="#l36.835"></a><span id="l36.835">     cssText += &quot;font-family: &quot; + getMetadata(aTheme, &quot;DefaultFontFamily&quot;) + &quot;;&quot;;</span>
<a href="#l36.836"></a><span id="l36.836" class="difflineminus">-  if (hasMetadataKey(aTheme, &quot;DefaultFontSize&quot;))</span>
<a href="#l36.837"></a><span id="l36.837" class="difflineplus">+  }</span>
<a href="#l36.838"></a><span id="l36.838" class="difflineplus">+  if (hasMetadataKey(aTheme, &quot;DefaultFontSize&quot;)) {</span>
<a href="#l36.839"></a><span id="l36.839">     cssText += &quot;font-size: &quot; + getMetadata(aTheme, &quot;DefaultFontSize&quot;) + &quot;;&quot;;</span>
<a href="#l36.840"></a><span id="l36.840" class="difflineminus">-  if (cssText)</span>
<a href="#l36.841"></a><span id="l36.841" class="difflineplus">+  }</span>
<a href="#l36.842"></a><span id="l36.842" class="difflineplus">+  if (cssText) {</span>
<a href="#l36.843"></a><span id="l36.843">     addCSS(&quot;data:text/css,*{ &quot; + cssText + &quot; }&quot;);</span>
<a href="#l36.844"></a><span id="l36.844" class="difflineplus">+  }</span>
<a href="#l36.845"></a><span id="l36.845"> </span>
<a href="#l36.846"></a><span id="l36.846">   // add the main CSS file of the theme</span>
<a href="#l36.847"></a><span id="l36.847" class="difflineminus">-  if (aTheme.metadata.MessageViewVersion &gt;= 3 || aTheme.variant == &quot;default&quot;)</span>
<a href="#l36.848"></a><span id="l36.848" class="difflineplus">+  if (aTheme.metadata.MessageViewVersion &gt;= 3 || aTheme.variant == &quot;default&quot;) {</span>
<a href="#l36.849"></a><span id="l36.849">     addCSS(&quot;main.css&quot;);</span>
<a href="#l36.850"></a><span id="l36.850" class="difflineplus">+  }</span>
<a href="#l36.851"></a><span id="l36.851"> </span>
<a href="#l36.852"></a><span id="l36.852">   // add the CSS file of the variant</span>
<a href="#l36.853"></a><span id="l36.853" class="difflineminus">-  if (aTheme.variant != &quot;default&quot;)</span>
<a href="#l36.854"></a><span id="l36.854" class="difflineplus">+  if (aTheme.variant != &quot;default&quot;) {</span>
<a href="#l36.855"></a><span id="l36.855">     addCSS(&quot;Variants/&quot; + aTheme.variant + &quot;.css&quot;);</span>
<a href="#l36.856"></a><span id="l36.856" class="difflineminus">-  else</span>
<a href="#l36.857"></a><span id="l36.857" class="difflineminus">-    if (&quot;DefaultVariant&quot; in aTheme.metadata)</span>
<a href="#l36.858"></a><span id="l36.858" class="difflineminus">-      addCSS(&quot;Variants/&quot; + aTheme.metadata.DefaultVariant + &quot;.css&quot;);</span>
<a href="#l36.859"></a><span id="l36.859" class="difflineplus">+  } else if (&quot;DefaultVariant&quot; in aTheme.metadata) {</span>
<a href="#l36.860"></a><span id="l36.860" class="difflineplus">+    addCSS(&quot;Variants/&quot; + aTheme.metadata.DefaultVariant + &quot;.css&quot;);</span>
<a href="#l36.861"></a><span id="l36.861" class="difflineplus">+  }</span>
<a href="#l36.862"></a><span id="l36.862"> </span>
<a href="#l36.863"></a><span id="l36.863" class="difflineminus">-  HTML += &quot;&lt;/head&gt;&lt;body id=\&quot;ibcontent\&quot;&gt;&quot;;</span>
<a href="#l36.864"></a><span id="l36.864" class="difflineplus">+  HTML += '&lt;/head&gt;&lt;body id=&quot;ibcontent&quot;&gt;';</span>
<a href="#l36.865"></a><span id="l36.865"> </span>
<a href="#l36.866"></a><span id="l36.866">   // We insert the whole content of body: header, chat div, footer</span>
<a href="#l36.867"></a><span id="l36.867">   if (aTheme.showHeader) {</span>
<a href="#l36.868"></a><span id="l36.868" class="difflineminus">-    HTML += replaceKeywordsInHTML(aTheme.html.header,</span>
<a href="#l36.869"></a><span id="l36.869" class="difflineminus">-                                  headerFooterReplacements, aConv);</span>
<a href="#l36.870"></a><span id="l36.870" class="difflineplus">+    HTML += replaceKeywordsInHTML(</span>
<a href="#l36.871"></a><span id="l36.871" class="difflineplus">+      aTheme.html.header,</span>
<a href="#l36.872"></a><span id="l36.872" class="difflineplus">+      headerFooterReplacements,</span>
<a href="#l36.873"></a><span id="l36.873" class="difflineplus">+      aConv</span>
<a href="#l36.874"></a><span id="l36.874" class="difflineplus">+    );</span>
<a href="#l36.875"></a><span id="l36.875">   }</span>
<a href="#l36.876"></a><span id="l36.876" class="difflineminus">-  HTML += &quot;&lt;div id=\&quot;Chat\&quot; aria-live=\&quot;polite\&quot;&gt;&lt;/div&gt;&quot;;</span>
<a href="#l36.877"></a><span id="l36.877" class="difflineminus">-  HTML += replaceKeywordsInHTML(aTheme.html.footer,</span>
<a href="#l36.878"></a><span id="l36.878" class="difflineminus">-                                headerFooterReplacements, aConv);</span>
<a href="#l36.879"></a><span id="l36.879" class="difflineplus">+  HTML += '&lt;div id=&quot;Chat&quot; aria-live=&quot;polite&quot;&gt;&lt;/div&gt;';</span>
<a href="#l36.880"></a><span id="l36.880" class="difflineplus">+  HTML += replaceKeywordsInHTML(</span>
<a href="#l36.881"></a><span id="l36.881" class="difflineplus">+    aTheme.html.footer,</span>
<a href="#l36.882"></a><span id="l36.882" class="difflineplus">+    headerFooterReplacements,</span>
<a href="#l36.883"></a><span id="l36.883" class="difflineplus">+    aConv</span>
<a href="#l36.884"></a><span id="l36.884" class="difflineplus">+  );</span>
<a href="#l36.885"></a><span id="l36.885">   aDoc.open();</span>
<a href="#l36.886"></a><span id="l36.886">   aDoc.write(HTML + &quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<a href="#l36.887"></a><span id="l36.887">   aDoc.close();</span>
<a href="#l36.888"></a><span id="l36.888">   aDoc.defaultView.convertTimeUnits = DownloadUtils.convertTimeUnits;</span>
<a href="#l36.889"></a><span id="l36.889"> }</span>
<a href="#l36.890"></a><span id="l36.890"> </span>
<a href="#l36.891"></a><span id="l36.891"> /* Selection stuff */</span>
<a href="#l36.892"></a><span id="l36.892" class="difflineminus">-function getEllipsis()</span>
<a href="#l36.893"></a><span id="l36.893" class="difflineminus">-{</span>
<a href="#l36.894"></a><span id="l36.894" class="difflineplus">+function getEllipsis() {</span>
<a href="#l36.895"></a><span id="l36.895">   let ellipsis = &quot;[\u2026]&quot;;</span>
<a href="#l36.896"></a><span id="l36.896"> </span>
<a href="#l36.897"></a><span id="l36.897">   try {</span>
<a href="#l36.898"></a><span id="l36.898" class="difflineminus">-    ellipsis =</span>
<a href="#l36.899"></a><span id="l36.899" class="difflineminus">-      Services.prefs</span>
<a href="#l36.900"></a><span id="l36.900" class="difflineminus">-              .getComplexValue(&quot;messenger.conversations.selections.ellipsis&quot;,</span>
<a href="#l36.901"></a><span id="l36.901" class="difflineminus">-                               Ci.nsIPrefLocalizedString).data;</span>
<a href="#l36.902"></a><span id="l36.902" class="difflineminus">-  } catch (e) { }</span>
<a href="#l36.903"></a><span id="l36.903" class="difflineplus">+    ellipsis = Services.prefs.getComplexValue(</span>
<a href="#l36.904"></a><span id="l36.904" class="difflineplus">+      &quot;messenger.conversations.selections.ellipsis&quot;,</span>
<a href="#l36.905"></a><span id="l36.905" class="difflineplus">+      Ci.nsIPrefLocalizedString</span>
<a href="#l36.906"></a><span id="l36.906" class="difflineplus">+    ).data;</span>
<a href="#l36.907"></a><span id="l36.907" class="difflineplus">+  } catch (e) {}</span>
<a href="#l36.908"></a><span id="l36.908">   return ellipsis;</span>
<a href="#l36.909"></a><span id="l36.909"> }</span>
<a href="#l36.910"></a><span id="l36.910"> </span>
<a href="#l36.911"></a><span id="l36.911" class="difflineminus">-function _serializeDOMObject(aDocument, aInitFunction)</span>
<a href="#l36.912"></a><span id="l36.912" class="difflineminus">-{</span>
<a href="#l36.913"></a><span id="l36.913" class="difflineplus">+function _serializeDOMObject(aDocument, aInitFunction) {</span>
<a href="#l36.914"></a><span id="l36.914">   // This shouldn't really be a constant, as we want to support</span>
<a href="#l36.915"></a><span id="l36.915">   // text/html too in the future.</span>
<a href="#l36.916"></a><span id="l36.916">   const type = &quot;text/plain&quot;;</span>
<a href="#l36.917"></a><span id="l36.917"> </span>
<a href="#l36.918"></a><span id="l36.918">   let encoder = Cu.createDocumentEncoder(type);</span>
<a href="#l36.919"></a><span id="l36.919">   encoder.init(aDocument, type, Ci.nsIDocumentEncoder.OutputPreformatted);</span>
<a href="#l36.920"></a><span id="l36.920">   aInitFunction(encoder);</span>
<a href="#l36.921"></a><span id="l36.921">   let result = encoder.encodeToString();</span>
<a href="#l36.922"></a><span id="l36.922">   return result;</span>
<a href="#l36.923"></a><span id="l36.923"> }</span>
<a href="#l36.924"></a><span id="l36.924"> </span>
<a href="#l36.925"></a><span id="l36.925" class="difflineminus">-function serializeRange(aRange)</span>
<a href="#l36.926"></a><span id="l36.926" class="difflineminus">-{</span>
<a href="#l36.927"></a><span id="l36.927" class="difflineminus">-  return _serializeDOMObject(aRange.startContainer.ownerDocument,</span>
<a href="#l36.928"></a><span id="l36.928" class="difflineminus">-                             function(aEncoder) { aEncoder.setRange(aRange); });</span>
<a href="#l36.929"></a><span id="l36.929" class="difflineplus">+function serializeRange(aRange) {</span>
<a href="#l36.930"></a><span id="l36.930" class="difflineplus">+  return _serializeDOMObject(aRange.startContainer.ownerDocument, function(</span>
<a href="#l36.931"></a><span id="l36.931" class="difflineplus">+    aEncoder</span>
<a href="#l36.932"></a><span id="l36.932" class="difflineplus">+  ) {</span>
<a href="#l36.933"></a><span id="l36.933" class="difflineplus">+    aEncoder.setRange(aRange);</span>
<a href="#l36.934"></a><span id="l36.934" class="difflineplus">+  });</span>
<a href="#l36.935"></a><span id="l36.935"> }</span>
<a href="#l36.936"></a><span id="l36.936"> </span>
<a href="#l36.937"></a><span id="l36.937" class="difflineminus">-function serializeNode(aNode)</span>
<a href="#l36.938"></a><span id="l36.938" class="difflineminus">-{</span>
<a href="#l36.939"></a><span id="l36.939" class="difflineminus">-  return _serializeDOMObject(aNode.ownerDocument,</span>
<a href="#l36.940"></a><span id="l36.940" class="difflineminus">-                             function(aEncoder) { aEncoder.setNode(aNode); });</span>
<a href="#l36.941"></a><span id="l36.941" class="difflineplus">+function serializeNode(aNode) {</span>
<a href="#l36.942"></a><span id="l36.942" class="difflineplus">+  return _serializeDOMObject(aNode.ownerDocument, function(aEncoder) {</span>
<a href="#l36.943"></a><span id="l36.943" class="difflineplus">+    aEncoder.setNode(aNode);</span>
<a href="#l36.944"></a><span id="l36.944" class="difflineplus">+  });</span>
<a href="#l36.945"></a><span id="l36.945"> }</span>
<a href="#l36.946"></a><span id="l36.946"> </span>
<a href="#l36.947"></a><span id="l36.947"> /* This function is used to pretty print a selection inside a conversation area */</span>
<a href="#l36.948"></a><span id="l36.948" class="difflineminus">-function serializeSelection(aSelection)</span>
<a href="#l36.949"></a><span id="l36.949" class="difflineminus">-{</span>
<a href="#l36.950"></a><span id="l36.950" class="difflineplus">+function serializeSelection(aSelection) {</span>
<a href="#l36.951"></a><span id="l36.951">   // We have two kinds of selection serialization:</span>
<a href="#l36.952"></a><span id="l36.952">   //  - The short version, used when only a part of message is</span>
<a href="#l36.953"></a><span id="l36.953">   //    selected, or if nothing interesting is selected</span>
<a href="#l36.954"></a><span id="l36.954">   let shortSelection = &quot;&quot;;</span>
<a href="#l36.955"></a><span id="l36.955"> </span>
<a href="#l36.956"></a><span id="l36.956">   //  - The long version, which is used:</span>
<a href="#l36.957"></a><span id="l36.957">   //      * when both some of the message text and some of the context</span>
<a href="#l36.958"></a><span id="l36.958">   //        (sender, time, ...) is selected;</span>
<a href="#l36.959"></a><span id="l36.959" class="difflineat">@@ -701,169 +808,192 @@ function serializeSelection(aSelection)</span>
<a href="#l36.960"></a><span id="l36.960">   for (let i = 0; i &lt; aSelection.rangeCount; ++i) {</span>
<a href="#l36.961"></a><span id="l36.961">     let range = aSelection.getRangeAt(i);</span>
<a href="#l36.962"></a><span id="l36.962">     let messages = getMessagesForRange(range);</span>
<a href="#l36.963"></a><span id="l36.963"> </span>
<a href="#l36.964"></a><span id="l36.964">     // If at least one selected message has some of its text selected,</span>
<a href="#l36.965"></a><span id="l36.965">     // remove from the selection all the messages that have no text</span>
<a href="#l36.966"></a><span id="l36.966">     // selected</span>
<a href="#l36.967"></a><span id="l36.967">     let testFunction = msg =&gt; msg.isTextSelected();</span>
<a href="#l36.968"></a><span id="l36.968" class="difflineminus">-    if (messages.some(testFunction))</span>
<a href="#l36.969"></a><span id="l36.969" class="difflineplus">+    if (messages.some(testFunction)) {</span>
<a href="#l36.970"></a><span id="l36.970">       messages = messages.filter(testFunction);</span>
<a href="#l36.971"></a><span id="l36.971" class="difflineplus">+    }</span>
<a href="#l36.972"></a><span id="l36.972"> </span>
<a href="#l36.973"></a><span id="l36.973">     if (!messages.length) {</span>
<a href="#l36.974"></a><span id="l36.974">       // Do it only if it wouldn't override a better already found selection</span>
<a href="#l36.975"></a><span id="l36.975" class="difflineminus">-      if (!shortSelection)</span>
<a href="#l36.976"></a><span id="l36.976" class="difflineplus">+      if (!shortSelection) {</span>
<a href="#l36.977"></a><span id="l36.977">         shortSelection = serializeRange(range);</span>
<a href="#l36.978"></a><span id="l36.978" class="difflineplus">+      }</span>
<a href="#l36.979"></a><span id="l36.979">       continue;</span>
<a href="#l36.980"></a><span id="l36.980">     }</span>
<a href="#l36.981"></a><span id="l36.981"> </span>
<a href="#l36.982"></a><span id="l36.982" class="difflineminus">-    if (shortVersionPossible &amp;&amp; messages.length == 1 &amp;&amp;</span>
<a href="#l36.983"></a><span id="l36.983" class="difflineminus">-        (!messages[0].isTextSelected() || messages[0].onlyTextSelected()) &amp;&amp;</span>
<a href="#l36.984"></a><span id="l36.984" class="difflineminus">-        (!lastMessage || lastMessage.msg == messages[0].msg ||</span>
<a href="#l36.985"></a><span id="l36.985" class="difflineminus">-         lastMessage.msg.who == messages[0].msg.who)) {</span>
<a href="#l36.986"></a><span id="l36.986" class="difflineplus">+    if (</span>
<a href="#l36.987"></a><span id="l36.987" class="difflineplus">+      shortVersionPossible &amp;&amp;</span>
<a href="#l36.988"></a><span id="l36.988" class="difflineplus">+      messages.length == 1 &amp;&amp;</span>
<a href="#l36.989"></a><span id="l36.989" class="difflineplus">+      (!messages[0].isTextSelected() || messages[0].onlyTextSelected()) &amp;&amp;</span>
<a href="#l36.990"></a><span id="l36.990" class="difflineplus">+      (!lastMessage ||</span>
<a href="#l36.991"></a><span id="l36.991" class="difflineplus">+        lastMessage.msg == messages[0].msg ||</span>
<a href="#l36.992"></a><span id="l36.992" class="difflineplus">+        lastMessage.msg.who == messages[0].msg.who)</span>
<a href="#l36.993"></a><span id="l36.993" class="difflineplus">+    ) {</span>
<a href="#l36.994"></a><span id="l36.994">       if (shortSelection) {</span>
<a href="#l36.995"></a><span id="l36.995">         if (lastMessage.msg != messages[0].msg) {</span>
<a href="#l36.996"></a><span id="l36.996">           // Add the ellipsis only if the previous message was cut</span>
<a href="#l36.997"></a><span id="l36.997" class="difflineminus">-          if (lastMessage.cutEnd)</span>
<a href="#l36.998"></a><span id="l36.998" class="difflineplus">+          if (lastMessage.cutEnd) {</span>
<a href="#l36.999"></a><span id="l36.999">             shortSelection += &quot; &quot; + getEllipsis();</span>
<a href="#l36.1000"></a><span id="l36.1000" class="difflineplus">+          }</span>
<a href="#l36.1001"></a><span id="l36.1001">           shortSelection += kLineBreak;</span>
<a href="#l36.1002"></a><span id="l36.1002" class="difflineplus">+        } else {</span>
<a href="#l36.1003"></a><span id="l36.1003" class="difflineplus">+          shortSelection += &quot; &quot; + getEllipsis() + &quot; &quot;;</span>
<a href="#l36.1004"></a><span id="l36.1004">         }</span>
<a href="#l36.1005"></a><span id="l36.1005" class="difflineminus">-        else</span>
<a href="#l36.1006"></a><span id="l36.1006" class="difflineminus">-          shortSelection += &quot; &quot; + getEllipsis() + &quot; &quot;;</span>
<a href="#l36.1007"></a><span id="l36.1007">       }</span>
<a href="#l36.1008"></a><span id="l36.1008">       shortSelection += serializeRange(range);</span>
<a href="#l36.1009"></a><span id="l36.1009">       longSelection.push(messages[0].getFormattedMessage());</span>
<a href="#l36.1010"></a><span id="l36.1010" class="difflineminus">-    }</span>
<a href="#l36.1011"></a><span id="l36.1011" class="difflineminus">-    else {</span>
<a href="#l36.1012"></a><span id="l36.1012" class="difflineplus">+    } else {</span>
<a href="#l36.1013"></a><span id="l36.1013">       shortVersionPossible = false;</span>
<a href="#l36.1014"></a><span id="l36.1014">       for (let m = 0; m &lt; messages.length; ++m) {</span>
<a href="#l36.1015"></a><span id="l36.1015">         let message = messages[m];</span>
<a href="#l36.1016"></a><span id="l36.1016">         if (m == 0 &amp;&amp; lastMessage &amp;&amp; lastMessage.msg == message.msg) {</span>
<a href="#l36.1017"></a><span id="l36.1017">           let text = message.getSelectedText();</span>
<a href="#l36.1018"></a><span id="l36.1018" class="difflineminus">-          if (message.cutEnd)</span>
<a href="#l36.1019"></a><span id="l36.1019" class="difflineplus">+          if (message.cutEnd) {</span>
<a href="#l36.1020"></a><span id="l36.1020">             text += &quot; &quot; + getEllipsis();</span>
<a href="#l36.1021"></a><span id="l36.1021" class="difflineplus">+          }</span>
<a href="#l36.1022"></a><span id="l36.1022">           longSelection[longSelection.length - 1] += &quot; &quot; + text;</span>
<a href="#l36.1023"></a><span id="l36.1023" class="difflineplus">+        } else {</span>
<a href="#l36.1024"></a><span id="l36.1024" class="difflineplus">+          longSelection.push(message.getFormattedMessage());</span>
<a href="#l36.1025"></a><span id="l36.1025">         }</span>
<a href="#l36.1026"></a><span id="l36.1026" class="difflineminus">-        else</span>
<a href="#l36.1027"></a><span id="l36.1027" class="difflineminus">-          longSelection.push(message.getFormattedMessage());</span>
<a href="#l36.1028"></a><span id="l36.1028">       }</span>
<a href="#l36.1029"></a><span id="l36.1029">     }</span>
<a href="#l36.1030"></a><span id="l36.1030">     lastMessage = messages[messages.length - 1];</span>
<a href="#l36.1031"></a><span id="l36.1031">   }</span>
<a href="#l36.1032"></a><span id="l36.1032"> </span>
<a href="#l36.1033"></a><span id="l36.1033" class="difflineminus">-  if (shortVersionPossible)</span>
<a href="#l36.1034"></a><span id="l36.1034" class="difflineplus">+  if (shortVersionPossible) {</span>
<a href="#l36.1035"></a><span id="l36.1035">     return shortSelection || aSelection.toString();</span>
<a href="#l36.1036"></a><span id="l36.1036" class="difflineplus">+  }</span>
<a href="#l36.1037"></a><span id="l36.1037">   return longSelection.join(kLineBreak);</span>
<a href="#l36.1038"></a><span id="l36.1038"> }</span>
<a href="#l36.1039"></a><span id="l36.1039"> </span>
<a href="#l36.1040"></a><span id="l36.1040" class="difflineminus">-function SelectedMessage(aRootNode, aRange)</span>
<a href="#l36.1041"></a><span id="l36.1041" class="difflineminus">-{</span>
<a href="#l36.1042"></a><span id="l36.1042" class="difflineplus">+function SelectedMessage(aRootNode, aRange) {</span>
<a href="#l36.1043"></a><span id="l36.1043">   this._rootNodes = [aRootNode];</span>
<a href="#l36.1044"></a><span id="l36.1044">   this._range = aRange;</span>
<a href="#l36.1045"></a><span id="l36.1045"> }</span>
<a href="#l36.1046"></a><span id="l36.1046"> </span>
<a href="#l36.1047"></a><span id="l36.1047"> SelectedMessage.prototype = {</span>
<a href="#l36.1048"></a><span id="l36.1048" class="difflineminus">-  get msg() { return this._rootNodes[0]._originalMsg; },</span>
<a href="#l36.1049"></a><span id="l36.1049" class="difflineplus">+  get msg() {</span>
<a href="#l36.1050"></a><span id="l36.1050" class="difflineplus">+    return this._rootNodes[0]._originalMsg;</span>
<a href="#l36.1051"></a><span id="l36.1051" class="difflineplus">+  },</span>
<a href="#l36.1052"></a><span id="l36.1052">   addRoot(aRootNode) {</span>
<a href="#l36.1053"></a><span id="l36.1053">     this._rootNodes.push(aRootNode);</span>
<a href="#l36.1054"></a><span id="l36.1054">   },</span>
<a href="#l36.1055"></a><span id="l36.1055"> </span>
<a href="#l36.1056"></a><span id="l36.1056">   // Helper function that returns the first span node of class</span>
<a href="#l36.1057"></a><span id="l36.1057">   // ib-msg-text under the rootNodes of the selected message.</span>
<a href="#l36.1058"></a><span id="l36.1058">   _getSpanNode() {</span>
<a href="#l36.1059"></a><span id="l36.1059">     // first use the cached value if any</span>
<a href="#l36.1060"></a><span id="l36.1060" class="difflineminus">-    if (this._spanNode)</span>
<a href="#l36.1061"></a><span id="l36.1061" class="difflineplus">+    if (this._spanNode) {</span>
<a href="#l36.1062"></a><span id="l36.1062">       return this._spanNode;</span>
<a href="#l36.1063"></a><span id="l36.1063" class="difflineplus">+    }</span>
<a href="#l36.1064"></a><span id="l36.1064"> </span>
<a href="#l36.1065"></a><span id="l36.1065">     let spanNode = null;</span>
<a href="#l36.1066"></a><span id="l36.1066">     // If we could use NodeFilter.webidl, we wouldn't have to make up our own</span>
<a href="#l36.1067"></a><span id="l36.1067">     // object. FILTER_REJECT is not used here, but included for completeness.</span>
<a href="#l36.1068"></a><span id="l36.1068" class="difflineminus">-    const NodeFilter = { SHOW_ELEMENT: 0x1, FILTER_ACCEPT: 1, FILTER_REJECT: 2, FILTER_SKIP: 3 };</span>
<a href="#l36.1069"></a><span id="l36.1069" class="difflineplus">+    const NodeFilter = {</span>
<a href="#l36.1070"></a><span id="l36.1070" class="difflineplus">+      SHOW_ELEMENT: 0x1,</span>
<a href="#l36.1071"></a><span id="l36.1071" class="difflineplus">+      FILTER_ACCEPT: 1,</span>
<a href="#l36.1072"></a><span id="l36.1072" class="difflineplus">+      FILTER_REJECT: 2,</span>
<a href="#l36.1073"></a><span id="l36.1073" class="difflineplus">+      FILTER_SKIP: 3,</span>
<a href="#l36.1074"></a><span id="l36.1074" class="difflineplus">+    };</span>
<a href="#l36.1075"></a><span id="l36.1075">     // helper filter function for the tree walker</span>
<a href="#l36.1076"></a><span id="l36.1076">     let filter = function(node) {</span>
<a href="#l36.1077"></a><span id="l36.1077" class="difflineminus">-      return node.className == &quot;ib-msg-txt&quot; ? NodeFilter.FILTER_ACCEPT</span>
<a href="#l36.1078"></a><span id="l36.1078" class="difflineminus">-                                            : NodeFilter.FILTER_SKIP;</span>
<a href="#l36.1079"></a><span id="l36.1079" class="difflineplus">+      return node.className == &quot;ib-msg-txt&quot;</span>
<a href="#l36.1080"></a><span id="l36.1080" class="difflineplus">+        ? NodeFilter.FILTER_ACCEPT</span>
<a href="#l36.1081"></a><span id="l36.1081" class="difflineplus">+        : NodeFilter.FILTER_SKIP;</span>
<a href="#l36.1082"></a><span id="l36.1082">     };</span>
<a href="#l36.1083"></a><span id="l36.1083">     // walk the DOM subtrees of each root, keep the first correct span node</span>
<a href="#l36.1084"></a><span id="l36.1084">     for (let i = 0; !spanNode &amp;&amp; i &lt; this._rootNodes.length; ++i) {</span>
<a href="#l36.1085"></a><span id="l36.1085">       let rootNode = this._rootNodes[i];</span>
<a href="#l36.1086"></a><span id="l36.1086">       // the TreeWalker doesn't test the root node, special case it first</span>
<a href="#l36.1087"></a><span id="l36.1087">       if (filter(rootNode) == NodeFilter.FILTER_ACCEPT) {</span>
<a href="#l36.1088"></a><span id="l36.1088">         spanNode = rootNode;</span>
<a href="#l36.1089"></a><span id="l36.1089">         break;</span>
<a href="#l36.1090"></a><span id="l36.1090">       }</span>
<a href="#l36.1091"></a><span id="l36.1091" class="difflineminus">-      let treeWalker =</span>
<a href="#l36.1092"></a><span id="l36.1092" class="difflineminus">-        rootNode.ownerDocument.createTreeWalker(rootNode,</span>
<a href="#l36.1093"></a><span id="l36.1093" class="difflineminus">-                                                NodeFilter.SHOW_ELEMENT,</span>
<a href="#l36.1094"></a><span id="l36.1094" class="difflineminus">-                                                {acceptNode: filter}, false);</span>
<a href="#l36.1095"></a><span id="l36.1095" class="difflineplus">+      let treeWalker = rootNode.ownerDocument.createTreeWalker(</span>
<a href="#l36.1096"></a><span id="l36.1096" class="difflineplus">+        rootNode,</span>
<a href="#l36.1097"></a><span id="l36.1097" class="difflineplus">+        NodeFilter.SHOW_ELEMENT,</span>
<a href="#l36.1098"></a><span id="l36.1098" class="difflineplus">+        { acceptNode: filter },</span>
<a href="#l36.1099"></a><span id="l36.1099" class="difflineplus">+        false</span>
<a href="#l36.1100"></a><span id="l36.1100" class="difflineplus">+      );</span>
<a href="#l36.1101"></a><span id="l36.1101">       spanNode = treeWalker.nextNode();</span>
<a href="#l36.1102"></a><span id="l36.1102">     }</span>
<a href="#l36.1103"></a><span id="l36.1103"> </span>
<a href="#l36.1104"></a><span id="l36.1104">     return (this._spanNode = spanNode);</span>
<a href="#l36.1105"></a><span id="l36.1105">   },</span>
<a href="#l36.1106"></a><span id="l36.1106"> </span>
<a href="#l36.1107"></a><span id="l36.1107">   // Initialize _textSelected and _otherSelected; if _textSelected is true,</span>
<a href="#l36.1108"></a><span id="l36.1108">   // also initialize _selectedText and _cutBegin/End.</span>
<a href="#l36.1109"></a><span id="l36.1109">   _initSelectedText() {</span>
<a href="#l36.1110"></a><span id="l36.1110" class="difflineminus">-    if (&quot;_textSelected&quot; in this)</span>
<a href="#l36.1111"></a><span id="l36.1111" class="difflineminus">-      return; // already initialized</span>
<a href="#l36.1112"></a><span id="l36.1112" class="difflineplus">+    if (&quot;_textSelected&quot; in this) {</span>
<a href="#l36.1113"></a><span id="l36.1113" class="difflineplus">+      return;</span>
<a href="#l36.1114"></a><span id="l36.1114" class="difflineplus">+    } // already initialized</span>
<a href="#l36.1115"></a><span id="l36.1115"> </span>
<a href="#l36.1116"></a><span id="l36.1116">     let spanNode = this._getSpanNode();</span>
<a href="#l36.1117"></a><span id="l36.1117">     if (!spanNode) {</span>
<a href="#l36.1118"></a><span id="l36.1118">       // can happen if the message text is under a separate root node</span>
<a href="#l36.1119"></a><span id="l36.1119">       // that isn't selected at all</span>
<a href="#l36.1120"></a><span id="l36.1120">       this._textSelected = false;</span>
<a href="#l36.1121"></a><span id="l36.1121">       this._otherSelected = true;</span>
<a href="#l36.1122"></a><span id="l36.1122">       return;</span>
<a href="#l36.1123"></a><span id="l36.1123">     }</span>
<a href="#l36.1124"></a><span id="l36.1124">     let startPoint = this._range.comparePoint(spanNode, 0);</span>
<a href="#l36.1125"></a><span id="l36.1125" class="difflineminus">-    let endPoint = this._range.comparePoint(spanNode,</span>
<a href="#l36.1126"></a><span id="l36.1126" class="difflineminus">-                                            spanNode.childNodes.length);</span>
<a href="#l36.1127"></a><span id="l36.1127" class="difflineplus">+    let endPoint = this._range.comparePoint(</span>
<a href="#l36.1128"></a><span id="l36.1128" class="difflineplus">+      spanNode,</span>
<a href="#l36.1129"></a><span id="l36.1129" class="difflineplus">+      spanNode.childNodes.length</span>
<a href="#l36.1130"></a><span id="l36.1130" class="difflineplus">+    );</span>
<a href="#l36.1131"></a><span id="l36.1131">     if (startPoint &lt;= 0 &amp;&amp; endPoint &gt;= 0) {</span>
<a href="#l36.1132"></a><span id="l36.1132">       let range = this._range.cloneRange();</span>
<a href="#l36.1133"></a><span id="l36.1133" class="difflineminus">-      if (startPoint &gt;= 0)</span>
<a href="#l36.1134"></a><span id="l36.1134" class="difflineplus">+      if (startPoint &gt;= 0) {</span>
<a href="#l36.1135"></a><span id="l36.1135">         range.setStart(spanNode, 0);</span>
<a href="#l36.1136"></a><span id="l36.1136" class="difflineminus">-      if (endPoint &lt;= 0)</span>
<a href="#l36.1137"></a><span id="l36.1137" class="difflineplus">+      }</span>
<a href="#l36.1138"></a><span id="l36.1138" class="difflineplus">+      if (endPoint &lt;= 0) {</span>
<a href="#l36.1139"></a><span id="l36.1139">         range.setEnd(spanNode, spanNode.childNodes.length);</span>
<a href="#l36.1140"></a><span id="l36.1140" class="difflineplus">+      }</span>
<a href="#l36.1141"></a><span id="l36.1141">       this._selectedText = serializeRange(range);</span>
<a href="#l36.1142"></a><span id="l36.1142"> </span>
<a href="#l36.1143"></a><span id="l36.1143">       // if the selected text is empty, set _selectedText to false</span>
<a href="#l36.1144"></a><span id="l36.1144">       // this happens if the carret is at the offset 0 in the span node</span>
<a href="#l36.1145"></a><span id="l36.1145">       this._textSelected = this._selectedText != &quot;&quot;;</span>
<a href="#l36.1146"></a><span id="l36.1146" class="difflineplus">+    } else {</span>
<a href="#l36.1147"></a><span id="l36.1147" class="difflineplus">+      this._textSelected = false;</span>
<a href="#l36.1148"></a><span id="l36.1148">     }</span>
<a href="#l36.1149"></a><span id="l36.1149" class="difflineminus">-    else</span>
<a href="#l36.1150"></a><span id="l36.1150" class="difflineminus">-      this._textSelected = false;</span>
<a href="#l36.1151"></a><span id="l36.1151">     if (this._textSelected) {</span>
<a href="#l36.1152"></a><span id="l36.1152">       // to check if the start or end is cut, the result of</span>
<a href="#l36.1153"></a><span id="l36.1153">       // comparePoint is not enough because the selection range may</span>
<a href="#l36.1154"></a><span id="l36.1154">       // start or end in a text node instead of the span node</span>
<a href="#l36.1155"></a><span id="l36.1155"> </span>
<a href="#l36.1156"></a><span id="l36.1156">       if (startPoint == -1) {</span>
<a href="#l36.1157"></a><span id="l36.1157">         let range = spanNode.ownerDocument.createRange();</span>
<a href="#l36.1158"></a><span id="l36.1158">         range.setStart(spanNode, 0);</span>
<a href="#l36.1159"></a><span id="l36.1159">         range.setEnd(this._range.startContainer, this._range.startOffset);</span>
<a href="#l36.1160"></a><span id="l36.1160">         this._cutBegin = serializeRange(range) != &quot;&quot;;</span>
<a href="#l36.1161"></a><span id="l36.1161" class="difflineplus">+      } else {</span>
<a href="#l36.1162"></a><span id="l36.1162" class="difflineplus">+        this._cutBegin = false;</span>
<a href="#l36.1163"></a><span id="l36.1163">       }</span>
<a href="#l36.1164"></a><span id="l36.1164" class="difflineminus">-      else</span>
<a href="#l36.1165"></a><span id="l36.1165" class="difflineminus">-        this._cutBegin = false;</span>
<a href="#l36.1166"></a><span id="l36.1166"> </span>
<a href="#l36.1167"></a><span id="l36.1167">       if (endPoint == 1) {</span>
<a href="#l36.1168"></a><span id="l36.1168">         let range = spanNode.ownerDocument.createRange();</span>
<a href="#l36.1169"></a><span id="l36.1169">         range.setStart(this._range.endContainer, this._range.endOffset);</span>
<a href="#l36.1170"></a><span id="l36.1170">         range.setEnd(spanNode, spanNode.childNodes.length);</span>
<a href="#l36.1171"></a><span id="l36.1171">         this._cutEnd = !/^(\r?\n)?$/.test(serializeRange(range));</span>
<a href="#l36.1172"></a><span id="l36.1172" class="difflineplus">+      } else {</span>
<a href="#l36.1173"></a><span id="l36.1173" class="difflineplus">+        this._cutEnd = false;</span>
<a href="#l36.1174"></a><span id="l36.1174">       }</span>
<a href="#l36.1175"></a><span id="l36.1175" class="difflineminus">-      else</span>
<a href="#l36.1176"></a><span id="l36.1176" class="difflineminus">-        this._cutEnd = false;</span>
<a href="#l36.1177"></a><span id="l36.1177">     }</span>
<a href="#l36.1178"></a><span id="l36.1178">     this._otherSelected =</span>
<a href="#l36.1179"></a><span id="l36.1179">       (startPoint &gt;= 0 || endPoint &lt;= 0) &amp;&amp; // eliminate most negative cases</span>
<a href="#l36.1180"></a><span id="l36.1180">       (!this._textSelected ||</span>
<a href="#l36.1181"></a><span id="l36.1181" class="difflineminus">-       serializeRange(this._range).length &gt; this._selectedText.length);</span>
<a href="#l36.1182"></a><span id="l36.1182" class="difflineplus">+        serializeRange(this._range).length &gt; this._selectedText.length);</span>
<a href="#l36.1183"></a><span id="l36.1183">   },</span>
<a href="#l36.1184"></a><span id="l36.1184">   get cutBegin() {</span>
<a href="#l36.1185"></a><span id="l36.1185">     this._initSelectedText();</span>
<a href="#l36.1186"></a><span id="l36.1186">     return this._textSelected &amp;&amp; this._cutBegin;</span>
<a href="#l36.1187"></a><span id="l36.1187">   },</span>
<a href="#l36.1188"></a><span id="l36.1188">   get cutEnd() {</span>
<a href="#l36.1189"></a><span id="l36.1189">     this._initSelectedText();</span>
<a href="#l36.1190"></a><span id="l36.1190">     return this._textSelected &amp;&amp; this._cutEnd;</span>
<a href="#l36.1191"></a><span id="l36.1191" class="difflineat">@@ -882,53 +1012,60 @@ SelectedMessage.prototype = {</span>
<a href="#l36.1192"></a><span id="l36.1192">   },</span>
<a href="#l36.1193"></a><span id="l36.1193">   getFormattedMessage() {</span>
<a href="#l36.1194"></a><span id="l36.1194">     // First, get the selected text</span>
<a href="#l36.1195"></a><span id="l36.1195">     this._initSelectedText();</span>
<a href="#l36.1196"></a><span id="l36.1196">     let msg = this.msg;</span>
<a href="#l36.1197"></a><span id="l36.1197">     let text;</span>
<a href="#l36.1198"></a><span id="l36.1198">     if (this._textSelected) {</span>
<a href="#l36.1199"></a><span id="l36.1199">       // Add ellipsis is needed</span>
<a href="#l36.1200"></a><span id="l36.1200" class="difflineminus">-      text = (this._cutBegin ? getEllipsis() + &quot; &quot; : &quot;&quot;) +</span>
<a href="#l36.1201"></a><span id="l36.1201" class="difflineminus">-             this._selectedText +</span>
<a href="#l36.1202"></a><span id="l36.1202" class="difflineminus">-             (this._cutEnd ? &quot; &quot; + getEllipsis() : &quot;&quot;);</span>
<a href="#l36.1203"></a><span id="l36.1203" class="difflineminus">-    }</span>
<a href="#l36.1204"></a><span id="l36.1204" class="difflineminus">-    else {</span>
<a href="#l36.1205"></a><span id="l36.1205" class="difflineplus">+      text =</span>
<a href="#l36.1206"></a><span id="l36.1206" class="difflineplus">+        (this._cutBegin ? getEllipsis() + &quot; &quot; : &quot;&quot;) +</span>
<a href="#l36.1207"></a><span id="l36.1207" class="difflineplus">+        this._selectedText +</span>
<a href="#l36.1208"></a><span id="l36.1208" class="difflineplus">+        (this._cutEnd ? &quot; &quot; + getEllipsis() : &quot;&quot;);</span>
<a href="#l36.1209"></a><span id="l36.1209" class="difflineplus">+    } else {</span>
<a href="#l36.1210"></a><span id="l36.1210">       let div = this._rootNodes[0].ownerDocument.createElement(&quot;div&quot;);</span>
<a href="#l36.1211"></a><span id="l36.1211">       // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l36.1212"></a><span id="l36.1212" class="difflineminus">-      div.innerHTML = msg.autoResponse ? formatAutoResponce(msg.message) : msg.message;</span>
<a href="#l36.1213"></a><span id="l36.1213" class="difflineplus">+      div.innerHTML = msg.autoResponse</span>
<a href="#l36.1214"></a><span id="l36.1214" class="difflineplus">+        ? formatAutoResponce(msg.message)</span>
<a href="#l36.1215"></a><span id="l36.1215" class="difflineplus">+        : msg.message;</span>
<a href="#l36.1216"></a><span id="l36.1216">       text = serializeNode(div);</span>
<a href="#l36.1217"></a><span id="l36.1217">     }</span>
<a href="#l36.1218"></a><span id="l36.1218"> </span>
<a href="#l36.1219"></a><span id="l36.1219">     // then get the suitable replacements and templates for this message</span>
<a href="#l36.1220"></a><span id="l36.1220">     let getLocalizedPrefWithDefault = function(aName, aDefault) {</span>
<a href="#l36.1221"></a><span id="l36.1221">       try {</span>
<a href="#l36.1222"></a><span id="l36.1222" class="difflineminus">-        let prefBranch =</span>
<a href="#l36.1223"></a><span id="l36.1223" class="difflineminus">-          Services.prefs.getBranch(&quot;messenger.conversations.selections.&quot;);</span>
<a href="#l36.1224"></a><span id="l36.1224" class="difflineminus">-        return prefBranch.getComplexValue(aName,</span>
<a href="#l36.1225"></a><span id="l36.1225" class="difflineminus">-                                          Ci.nsIPrefLocalizedString).data;</span>
<a href="#l36.1226"></a><span id="l36.1226" class="difflineplus">+        let prefBranch = Services.prefs.getBranch(</span>
<a href="#l36.1227"></a><span id="l36.1227" class="difflineplus">+          &quot;messenger.conversations.selections.&quot;</span>
<a href="#l36.1228"></a><span id="l36.1228" class="difflineplus">+        );</span>
<a href="#l36.1229"></a><span id="l36.1229" class="difflineplus">+        return prefBranch.getComplexValue(aName, Ci.nsIPrefLocalizedString)</span>
<a href="#l36.1230"></a><span id="l36.1230" class="difflineplus">+          .data;</span>
<a href="#l36.1231"></a><span id="l36.1231">       } catch (e) {</span>
<a href="#l36.1232"></a><span id="l36.1232">         return aDefault;</span>
<a href="#l36.1233"></a><span id="l36.1233">       }</span>
<a href="#l36.1234"></a><span id="l36.1234">     };</span>
<a href="#l36.1235"></a><span id="l36.1235">     let html, replacements;</span>
<a href="#l36.1236"></a><span id="l36.1236">     if (msg.system) {</span>
<a href="#l36.1237"></a><span id="l36.1237">       replacements = statusReplacements;</span>
<a href="#l36.1238"></a><span id="l36.1238" class="difflineminus">-      html = getLocalizedPrefWithDefault(&quot;systemMessagesTemplate&quot;,</span>
<a href="#l36.1239"></a><span id="l36.1239" class="difflineminus">-                                         &quot;%time% - %message%&quot;);</span>
<a href="#l36.1240"></a><span id="l36.1240" class="difflineminus">-    }</span>
<a href="#l36.1241"></a><span id="l36.1241" class="difflineminus">-    else {</span>
<a href="#l36.1242"></a><span id="l36.1242" class="difflineplus">+      html = getLocalizedPrefWithDefault(</span>
<a href="#l36.1243"></a><span id="l36.1243" class="difflineplus">+        &quot;systemMessagesTemplate&quot;,</span>
<a href="#l36.1244"></a><span id="l36.1244" class="difflineplus">+        &quot;%time% - %message%&quot;</span>
<a href="#l36.1245"></a><span id="l36.1245" class="difflineplus">+      );</span>
<a href="#l36.1246"></a><span id="l36.1246" class="difflineplus">+    } else {</span>
<a href="#l36.1247"></a><span id="l36.1247">       replacements = messageReplacements;</span>
<a href="#l36.1248"></a><span id="l36.1248">       if (/^(&lt;[^&gt;]+&gt;)*\/me /.test(msg.displayMessage)) {</span>
<a href="#l36.1249"></a><span id="l36.1249" class="difflineminus">-        html = getLocalizedPrefWithDefault(&quot;actionMessagesTemplate&quot;,</span>
<a href="#l36.1250"></a><span id="l36.1250" class="difflineminus">-                                           &quot;%time% * %sender% %message%&quot;);</span>
<a href="#l36.1251"></a><span id="l36.1251" class="difflineminus">-      }</span>
<a href="#l36.1252"></a><span id="l36.1252" class="difflineminus">-      else {</span>
<a href="#l36.1253"></a><span id="l36.1253" class="difflineminus">-        html = getLocalizedPrefWithDefault(&quot;contentMessagesTemplate&quot;,</span>
<a href="#l36.1254"></a><span id="l36.1254" class="difflineminus">-                                           &quot;%time% - %sender%: %message%&quot;);</span>
<a href="#l36.1255"></a><span id="l36.1255" class="difflineplus">+        html = getLocalizedPrefWithDefault(</span>
<a href="#l36.1256"></a><span id="l36.1256" class="difflineplus">+          &quot;actionMessagesTemplate&quot;,</span>
<a href="#l36.1257"></a><span id="l36.1257" class="difflineplus">+          &quot;%time% * %sender% %message%&quot;</span>
<a href="#l36.1258"></a><span id="l36.1258" class="difflineplus">+        );</span>
<a href="#l36.1259"></a><span id="l36.1259" class="difflineplus">+      } else {</span>
<a href="#l36.1260"></a><span id="l36.1260" class="difflineplus">+        html = getLocalizedPrefWithDefault(</span>
<a href="#l36.1261"></a><span id="l36.1261" class="difflineplus">+          &quot;contentMessagesTemplate&quot;,</span>
<a href="#l36.1262"></a><span id="l36.1262" class="difflineplus">+          &quot;%time% - %sender%: %message%&quot;</span>
<a href="#l36.1263"></a><span id="l36.1263" class="difflineplus">+        );</span>
<a href="#l36.1264"></a><span id="l36.1264">       }</span>
<a href="#l36.1265"></a><span id="l36.1265">     }</span>
<a href="#l36.1266"></a><span id="l36.1266"> </span>
<a href="#l36.1267"></a><span id="l36.1267">     // Overrides default replacements so that they don't add a span node.</span>
<a href="#l36.1268"></a><span id="l36.1268">     // Also, this uses directly the text variable so that we don't</span>
<a href="#l36.1269"></a><span id="l36.1269">     // have to change the content of msg.message and revert it</span>
<a href="#l36.1270"></a><span id="l36.1270">     // afterwards.</span>
<a href="#l36.1271"></a><span id="l36.1271">     replacements = {</span>
<a href="#l36.1272"></a><span id="l36.1272" class="difflineat">@@ -937,18 +1074,17 @@ SelectedMessage.prototype = {</span>
<a href="#l36.1273"></a><span id="l36.1273">       __proto__: replacements,</span>
<a href="#l36.1274"></a><span id="l36.1274">     };</span>
<a href="#l36.1275"></a><span id="l36.1275"> </span>
<a href="#l36.1276"></a><span id="l36.1276">     // Finally, let the theme system do the magic!</span>
<a href="#l36.1277"></a><span id="l36.1277">     return replaceKeywordsInHTML(html, replacements, msg);</span>
<a href="#l36.1278"></a><span id="l36.1278">   },</span>
<a href="#l36.1279"></a><span id="l36.1279"> };</span>
<a href="#l36.1280"></a><span id="l36.1280"> </span>
<a href="#l36.1281"></a><span id="l36.1281" class="difflineminus">-function getMessagesForRange(aRange)</span>
<a href="#l36.1282"></a><span id="l36.1282" class="difflineminus">-{</span>
<a href="#l36.1283"></a><span id="l36.1283" class="difflineplus">+function getMessagesForRange(aRange) {</span>
<a href="#l36.1284"></a><span id="l36.1284">   let result = []; // will hold the final result</span>
<a href="#l36.1285"></a><span id="l36.1285">   let messages = {}; // used to prevent duplicate messages in the result array</span>
<a href="#l36.1286"></a><span id="l36.1286"> </span>
<a href="#l36.1287"></a><span id="l36.1287">   // cache the range boundaries, they will be used a lot</span>
<a href="#l36.1288"></a><span id="l36.1288">   let endNode = aRange.endContainer;</span>
<a href="#l36.1289"></a><span id="l36.1289">   let startNode = aRange.startContainer;</span>
<a href="#l36.1290"></a><span id="l36.1290"> </span>
<a href="#l36.1291"></a><span id="l36.1291">   // Helper function to recursively look for _originalMsg JS</span>
<a href="#l36.1292"></a><span id="l36.1292" class="difflineat">@@ -957,78 +1093,89 @@ function getMessagesForRange(aRange)</span>
<a href="#l36.1293"></a><span id="l36.1293">   let processSubtree = function(aNode) {</span>
<a href="#l36.1294"></a><span id="l36.1294">     if (aNode._originalMsg) {</span>
<a href="#l36.1295"></a><span id="l36.1295">       // store the result</span>
<a href="#l36.1296"></a><span id="l36.1296">       if (!(aNode._originalMsg.id in messages)) {</span>
<a href="#l36.1297"></a><span id="l36.1297">         // we've found a new message!</span>
<a href="#l36.1298"></a><span id="l36.1298">         let newMessage = new SelectedMessage(aNode, aRange);</span>
<a href="#l36.1299"></a><span id="l36.1299">         messages[aNode._originalMsg.id] = newMessage;</span>
<a href="#l36.1300"></a><span id="l36.1300">         result.push(newMessage);</span>
<a href="#l36.1301"></a><span id="l36.1301" class="difflineminus">-      }</span>
<a href="#l36.1302"></a><span id="l36.1302" class="difflineminus">-      else {</span>
<a href="#l36.1303"></a><span id="l36.1303" class="difflineplus">+      } else {</span>
<a href="#l36.1304"></a><span id="l36.1304">         // we've found another root of an already known message</span>
<a href="#l36.1305"></a><span id="l36.1305">         messages[aNode._originalMsg.id].addRoot(aNode);</span>
<a href="#l36.1306"></a><span id="l36.1306">       }</span>
<a href="#l36.1307"></a><span id="l36.1307">     }</span>
<a href="#l36.1308"></a><span id="l36.1308"> </span>
<a href="#l36.1309"></a><span id="l36.1309">     // check if we have reached the end node</span>
<a href="#l36.1310"></a><span id="l36.1310" class="difflineminus">-    if (aNode == endNode)</span>
<a href="#l36.1311"></a><span id="l36.1311" class="difflineplus">+    if (aNode == endNode) {</span>
<a href="#l36.1312"></a><span id="l36.1312">       return true;</span>
<a href="#l36.1313"></a><span id="l36.1313" class="difflineplus">+    }</span>
<a href="#l36.1314"></a><span id="l36.1314"> </span>
<a href="#l36.1315"></a><span id="l36.1315">     // recurse through children</span>
<a href="#l36.1316"></a><span id="l36.1316" class="difflineminus">-    if (aNode.nodeType == aNode.ELEMENT_NODE &amp;&amp;</span>
<a href="#l36.1317"></a><span id="l36.1317" class="difflineminus">-        aNode.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;) {</span>
<a href="#l36.1318"></a><span id="l36.1318" class="difflineminus">-      for (let i = 0; i &lt; aNode.childNodes.length; ++i)</span>
<a href="#l36.1319"></a><span id="l36.1319" class="difflineminus">-        if (processSubtree(aNode.childNodes[i]))</span>
<a href="#l36.1320"></a><span id="l36.1320" class="difflineplus">+    if (</span>
<a href="#l36.1321"></a><span id="l36.1321" class="difflineplus">+      aNode.nodeType == aNode.ELEMENT_NODE &amp;&amp;</span>
<a href="#l36.1322"></a><span id="l36.1322" class="difflineplus">+      aNode.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l36.1323"></a><span id="l36.1323" class="difflineplus">+    ) {</span>
<a href="#l36.1324"></a><span id="l36.1324" class="difflineplus">+      for (let i = 0; i &lt; aNode.childNodes.length; ++i) {</span>
<a href="#l36.1325"></a><span id="l36.1325" class="difflineplus">+        if (processSubtree(aNode.childNodes[i])) {</span>
<a href="#l36.1326"></a><span id="l36.1326">           return true;</span>
<a href="#l36.1327"></a><span id="l36.1327" class="difflineplus">+        }</span>
<a href="#l36.1328"></a><span id="l36.1328" class="difflineplus">+      }</span>
<a href="#l36.1329"></a><span id="l36.1329">     }</span>
<a href="#l36.1330"></a><span id="l36.1330"> </span>
<a href="#l36.1331"></a><span id="l36.1331">     return false;</span>
<a href="#l36.1332"></a><span id="l36.1332">   };</span>
<a href="#l36.1333"></a><span id="l36.1333"> </span>
<a href="#l36.1334"></a><span id="l36.1334">   let currentNode = aRange.commonAncestorContainer;</span>
<a href="#l36.1335"></a><span id="l36.1335" class="difflineminus">-  if (currentNode.nodeType == currentNode.ELEMENT_NODE &amp;&amp;</span>
<a href="#l36.1336"></a><span id="l36.1336" class="difflineminus">-      currentNode.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;) {</span>
<a href="#l36.1337"></a><span id="l36.1337" class="difflineplus">+  if (</span>
<a href="#l36.1338"></a><span id="l36.1338" class="difflineplus">+    currentNode.nodeType == currentNode.ELEMENT_NODE &amp;&amp;</span>
<a href="#l36.1339"></a><span id="l36.1339" class="difflineplus">+    currentNode.namespaceURI == &quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l36.1340"></a><span id="l36.1340" class="difflineplus">+  ) {</span>
<a href="#l36.1341"></a><span id="l36.1341">     // Determine the index of the first and last children of currentNode</span>
<a href="#l36.1342"></a><span id="l36.1342">     // that we should process.</span>
<a href="#l36.1343"></a><span id="l36.1343">     let found = false;</span>
<a href="#l36.1344"></a><span id="l36.1344">     let start = 0;</span>
<a href="#l36.1345"></a><span id="l36.1345">     if (currentNode == startNode) {</span>
<a href="#l36.1346"></a><span id="l36.1346">       // we want to process all children</span>
<a href="#l36.1347"></a><span id="l36.1347">       found = true;</span>
<a href="#l36.1348"></a><span id="l36.1348">       start = aRange.startOffset;</span>
<a href="#l36.1349"></a><span id="l36.1349" class="difflineminus">-    }</span>
<a href="#l36.1350"></a><span id="l36.1350" class="difflineminus">-    else {</span>
<a href="#l36.1351"></a><span id="l36.1351" class="difflineplus">+    } else {</span>
<a href="#l36.1352"></a><span id="l36.1352">       // startNode needs to be a direct child of currentNode</span>
<a href="#l36.1353"></a><span id="l36.1353" class="difflineminus">-      while (startNode.parentNode != currentNode)</span>
<a href="#l36.1354"></a><span id="l36.1354" class="difflineplus">+      while (startNode.parentNode != currentNode) {</span>
<a href="#l36.1355"></a><span id="l36.1355">         startNode = startNode.parentNode;</span>
<a href="#l36.1356"></a><span id="l36.1356" class="difflineplus">+      }</span>
<a href="#l36.1357"></a><span id="l36.1357">     }</span>
<a href="#l36.1358"></a><span id="l36.1358">     let end;</span>
<a href="#l36.1359"></a><span id="l36.1359" class="difflineminus">-    if (currentNode == endNode)</span>
<a href="#l36.1360"></a><span id="l36.1360" class="difflineplus">+    if (currentNode == endNode) {</span>
<a href="#l36.1361"></a><span id="l36.1361">       end = aRange.endOffset;</span>
<a href="#l36.1362"></a><span id="l36.1362" class="difflineminus">-    else</span>
<a href="#l36.1363"></a><span id="l36.1363" class="difflineplus">+    } else {</span>
<a href="#l36.1364"></a><span id="l36.1364">       end = currentNode.childNodes.length;</span>
<a href="#l36.1365"></a><span id="l36.1365" class="difflineplus">+    }</span>
<a href="#l36.1366"></a><span id="l36.1366"> </span>
<a href="#l36.1367"></a><span id="l36.1367">     for (let i = start; i &lt; end; ++i) {</span>
<a href="#l36.1368"></a><span id="l36.1368">       let node = currentNode.childNodes[i];</span>
<a href="#l36.1369"></a><span id="l36.1369"> </span>
<a href="#l36.1370"></a><span id="l36.1370">       // don't do anything until we find the startNode</span>
<a href="#l36.1371"></a><span id="l36.1371">       found = found || node == startNode;</span>
<a href="#l36.1372"></a><span id="l36.1372" class="difflineminus">-      if (!found)</span>
<a href="#l36.1373"></a><span id="l36.1373" class="difflineplus">+      if (!found) {</span>
<a href="#l36.1374"></a><span id="l36.1374">         continue;</span>
<a href="#l36.1375"></a><span id="l36.1375" class="difflineplus">+      }</span>
<a href="#l36.1376"></a><span id="l36.1376"> </span>
<a href="#l36.1377"></a><span id="l36.1377" class="difflineminus">-      if (processSubtree(node))</span>
<a href="#l36.1378"></a><span id="l36.1378" class="difflineplus">+      if (processSubtree(node)) {</span>
<a href="#l36.1379"></a><span id="l36.1379">         break;</span>
<a href="#l36.1380"></a><span id="l36.1380" class="difflineplus">+      }</span>
<a href="#l36.1381"></a><span id="l36.1381">     }</span>
<a href="#l36.1382"></a><span id="l36.1382">   }</span>
<a href="#l36.1383"></a><span id="l36.1383"> </span>
<a href="#l36.1384"></a><span id="l36.1384">   // The selection may not include any root node of the first touched</span>
<a href="#l36.1385"></a><span id="l36.1385">   // message, in this case, the DOM traversal of the DOM range</span>
<a href="#l36.1386"></a><span id="l36.1386">   // couldn't give us the first message. Make sure we actually have</span>
<a href="#l36.1387"></a><span id="l36.1387">   // the message in which the range starts.</span>
<a href="#l36.1388"></a><span id="l36.1388">   let firstRoot = aRange.startContainer;</span>
<a href="#l36.1389"></a><span id="l36.1389" class="difflineminus">-  while (firstRoot &amp;&amp; !firstRoot._originalMsg)</span>
<a href="#l36.1390"></a><span id="l36.1390" class="difflineplus">+  while (firstRoot &amp;&amp; !firstRoot._originalMsg) {</span>
<a href="#l36.1391"></a><span id="l36.1391">     firstRoot = firstRoot.parentNode;</span>
<a href="#l36.1392"></a><span id="l36.1392" class="difflineminus">-  if (firstRoot &amp;&amp; !(firstRoot._originalMsg.id in messages))</span>
<a href="#l36.1393"></a><span id="l36.1393" class="difflineplus">+  }</span>
<a href="#l36.1394"></a><span id="l36.1394" class="difflineplus">+  if (firstRoot &amp;&amp; !(firstRoot._originalMsg.id in messages)) {</span>
<a href="#l36.1395"></a><span id="l36.1395">     result.unshift(new SelectedMessage(firstRoot, aRange));</span>
<a href="#l36.1396"></a><span id="l36.1396" class="difflineplus">+  }</span>
<a href="#l36.1397"></a><span id="l36.1397"> </span>
<a href="#l36.1398"></a><span id="l36.1398">   return result;</span>
<a href="#l36.1399"></a><span id="l36.1399"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -9,18 +9,20 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l37.4"></a><span id="l37.4">   &quot;executeSoon&quot;,</span>
<a href="#l37.5"></a><span id="l37.5">   &quot;nsSimpleEnumerator&quot;,</span>
<a href="#l37.6"></a><span id="l37.6">   &quot;EmptyEnumerator&quot;,</span>
<a href="#l37.7"></a><span id="l37.7">   &quot;ClassInfo&quot;,</span>
<a href="#l37.8"></a><span id="l37.8">   &quot;l10nHelper&quot;,</span>
<a href="#l37.9"></a><span id="l37.9">   &quot;initLogModule&quot;,</span>
<a href="#l37.10"></a><span id="l37.10"> ];</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+);</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19"> var kLogLevelPref = &quot;purple.debug.loglevel&quot;;</span>
<a href="#l37.20"></a><span id="l37.20"> </span>
<a href="#l37.21"></a><span id="l37.21"> /**</span>
<a href="#l37.22"></a><span id="l37.22">  * Creates an nsIScriptError instance and logs it.</span>
<a href="#l37.23"></a><span id="l37.23">  *</span>
<a href="#l37.24"></a><span id="l37.24">  * @param aModule</span>
<a href="#l37.25"></a><span id="l37.25">  *        string identifying the module within which the error occurred.</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineat">@@ -43,203 +45,238 @@ function scriptError(aModule, aLevel, aM</span>
<a href="#l37.27"></a><span id="l37.27">     let logKey = logKeys.join(&quot;.&quot;);</span>
<a href="#l37.28"></a><span id="l37.28">     if (logKey in gLogLevels) {</span>
<a href="#l37.29"></a><span id="l37.29">       logLevel = gLogLevels[logKey];</span>
<a href="#l37.30"></a><span id="l37.30">       break;</span>
<a href="#l37.31"></a><span id="l37.31">     }</span>
<a href="#l37.32"></a><span id="l37.32">   }</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34">   // Only continue if we will log this message.</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-  if (logLevel &gt; aLevel &amp;&amp; !(&quot;imAccount&quot; in this))</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+  if (logLevel &gt; aLevel &amp;&amp; !(&quot;imAccount&quot; in this)) {</span>
<a href="#l37.37"></a><span id="l37.37">     return;</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+  }</span>
<a href="#l37.39"></a><span id="l37.39"> </span>
<a href="#l37.40"></a><span id="l37.40">   let flag = Ci.nsIScriptError.warningFlag;</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-  if (aLevel &gt;= Ci.imIDebugMessage.LEVEL_ERROR)</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+  if (aLevel &gt;= Ci.imIDebugMessage.LEVEL_ERROR) {</span>
<a href="#l37.43"></a><span id="l37.43">     flag = Ci.nsIScriptError.errorFlag;</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+  }</span>
<a href="#l37.45"></a><span id="l37.45"> </span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-  let scriptError =</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-    Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(Ci.nsIScriptError);</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+  let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+    Ci.nsIScriptError</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+  );</span>
<a href="#l37.51"></a><span id="l37.51">   let caller = Components.stack.caller;</span>
<a href="#l37.52"></a><span id="l37.52">   let sourceLine = aModule || caller.sourceLine;</span>
<a href="#l37.53"></a><span id="l37.53">   if (caller.name) {</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-    if (sourceLine)</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+    if (sourceLine) {</span>
<a href="#l37.56"></a><span id="l37.56">       sourceLine += &quot;: &quot;;</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+    }</span>
<a href="#l37.58"></a><span id="l37.58">     sourceLine += caller.name;</span>
<a href="#l37.59"></a><span id="l37.59">   }</span>
<a href="#l37.60"></a><span id="l37.60">   let fileName = caller.filename;</span>
<a href="#l37.61"></a><span id="l37.61">   let lineNumber = caller.lineNumber;</span>
<a href="#l37.62"></a><span id="l37.62">   if (aOriginalError) {</span>
<a href="#l37.63"></a><span id="l37.63">     aMessage += &quot;\n&quot; + (aOriginalError.message || aOriginalError);</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-    if (aOriginalError.fileName)</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+    if (aOriginalError.fileName) {</span>
<a href="#l37.66"></a><span id="l37.66">       fileName = aOriginalError.fileName;</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineminus">-    if (aOriginalError.lineNumber)</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+    }</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+    if (aOriginalError.lineNumber) {</span>
<a href="#l37.70"></a><span id="l37.70">       lineNumber = aOriginalError.lineNumber;</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+    }</span>
<a href="#l37.72"></a><span id="l37.72">   }</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineminus">-  scriptError.init(aMessage, fileName, sourceLine, lineNumber, null, flag,</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineminus">-                   &quot;component javascript&quot;);</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+  scriptError.init(</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+    aMessage,</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+    fileName,</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+    sourceLine,</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+    lineNumber,</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+    null,</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+    flag,</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+    &quot;component javascript&quot;</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+  );</span>
<a href="#l37.84"></a><span id="l37.84"> </span>
<a href="#l37.85"></a><span id="l37.85">   if (logLevel &lt;= aLevel) {</span>
<a href="#l37.86"></a><span id="l37.86">     dump(aModule + &quot;: &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-    if (aLevel == Ci.imIDebugMessage.LEVEL_LOG &amp;&amp; logLevel == aLevel)</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+    if (aLevel == Ci.imIDebugMessage.LEVEL_LOG &amp;&amp; logLevel == aLevel) {</span>
<a href="#l37.89"></a><span id="l37.89">       Services.console.logStringMessage(aMessage);</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineminus">-    else</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+    } else {</span>
<a href="#l37.92"></a><span id="l37.92">       Services.console.logMessage(scriptError);</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+    }</span>
<a href="#l37.94"></a><span id="l37.94">   }</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineminus">-  if (&quot;imAccount&quot; in this)</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+  if (&quot;imAccount&quot; in this) {</span>
<a href="#l37.97"></a><span id="l37.97">     this.imAccount.logDebugMessage(scriptError, aLevel);</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+  }</span>
<a href="#l37.99"></a><span id="l37.99"> }</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-function initLogModule(aModule, aObj = {})</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-{</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+function initLogModule(aModule, aObj = {}) {</span>
<a href="#l37.103"></a><span id="l37.103">   aObj.DEBUG = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_DEBUG);</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineminus">-  aObj.LOG   = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_LOG);</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineminus">-  aObj.WARN  = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_WARNING);</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineplus">+  aObj.LOG = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_LOG);</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineplus">+  aObj.WARN = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_WARNING);</span>
<a href="#l37.108"></a><span id="l37.108">   aObj.ERROR = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_ERROR);</span>
<a href="#l37.109"></a><span id="l37.109">   return aObj;</span>
<a href="#l37.110"></a><span id="l37.110"> }</span>
<a href="#l37.111"></a><span id="l37.111"> XPCOMUtils.defineLazyGetter(this, &quot;gLogLevels&quot;, function() {</span>
<a href="#l37.112"></a><span id="l37.112">   // This object functions both as an obsever as well as a dict keeping the</span>
<a href="#l37.113"></a><span id="l37.113">   // log levels with prefs; the log levels all start with &quot;level&quot; (i.e. &quot;level&quot;</span>
<a href="#l37.114"></a><span id="l37.114">   // for the global level, &quot;level.irc&quot; for the IRC module).  The dual-purpose</span>
<a href="#l37.115"></a><span id="l37.115">   // is necessary to make sure the observe is left alive while being a weak ref</span>
<a href="#l37.116"></a><span id="l37.116">   // to avoid cycles with the pref service.</span>
<a href="#l37.117"></a><span id="l37.117">   let logLevels = {</span>
<a href="#l37.118"></a><span id="l37.118">     observe(aSubject, aTopic, aData) {</span>
<a href="#l37.119"></a><span id="l37.119">       let module = &quot;level&quot; + aData.substr(kLogLevelPref.length);</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-      if (Services.prefs.getPrefType(aData) == Services.prefs.PREF_INT)</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+      if (Services.prefs.getPrefType(aData) == Services.prefs.PREF_INT) {</span>
<a href="#l37.122"></a><span id="l37.122">         gLogLevels[module] = Services.prefs.getIntPref(aData);</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-      else</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+      } else {</span>
<a href="#l37.125"></a><span id="l37.125">         delete gLogLevels[module];</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+      }</span>
<a href="#l37.127"></a><span id="l37.127">     },</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineminus">-    QueryInterface: ChromeUtils.generateQI([&quot;nsIObserver&quot;,</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineminus">-                                            &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineplus">+    QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+      &quot;nsIObserver&quot;,</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineplus">+      &quot;nsISupportsWeakReference&quot;,</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+    ]),</span>
<a href="#l37.134"></a><span id="l37.134">   };</span>
<a href="#l37.135"></a><span id="l37.135"> </span>
<a href="#l37.136"></a><span id="l37.136">   // Add weak pref observer to see log level pref changes.</span>
<a href="#l37.137"></a><span id="l37.137">   Services.prefs.addObserver(kLogLevelPref, logLevels, true /* weak */);</span>
<a href="#l37.138"></a><span id="l37.138"> </span>
<a href="#l37.139"></a><span id="l37.139">   // Initialize with existing log level prefs.</span>
<a href="#l37.140"></a><span id="l37.140">   for (let pref of Services.prefs.getChildList(kLogLevelPref)) {</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineminus">-    if (Services.prefs.getPrefType(pref) == Services.prefs.PREF_INT)</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineminus">-      logLevels[&quot;level&quot; + pref.substr(kLogLevelPref.length)] = Services.prefs.getIntPref(pref);</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineplus">+    if (Services.prefs.getPrefType(pref) == Services.prefs.PREF_INT) {</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineplus">+      logLevels[</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+        &quot;level&quot; + pref.substr(kLogLevelPref.length)</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+      ] = Services.prefs.getIntPref(pref);</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineplus">+    }</span>
<a href="#l37.148"></a><span id="l37.148">   }</span>
<a href="#l37.149"></a><span id="l37.149"> </span>
<a href="#l37.150"></a><span id="l37.150">   // Let environment variables override prefs.</span>
<a href="#l37.151"></a><span id="l37.151">   Cc[&quot;@mozilla.org/process/environment;1&quot;]</span>
<a href="#l37.152"></a><span id="l37.152">     .getService(Ci.nsIEnvironment)</span>
<a href="#l37.153"></a><span id="l37.153">     .get(&quot;PRPL_LOG&quot;)</span>
<a href="#l37.154"></a><span id="l37.154">     .split(/[;,]/)</span>
<a href="#l37.155"></a><span id="l37.155">     .filter(n =&gt; n != &quot;&quot;)</span>
<a href="#l37.156"></a><span id="l37.156">     .forEach(function(env) {</span>
<a href="#l37.157"></a><span id="l37.157">       let [, module, level] = env.match(/(?:(.*?)[:=])?(\d+)/);</span>
<a href="#l37.158"></a><span id="l37.158">       logLevels[&quot;level&quot; + (module ? &quot;.&quot; + module : &quot;&quot;)] = parseInt(level, 10);</span>
<a href="#l37.159"></a><span id="l37.159">     });</span>
<a href="#l37.160"></a><span id="l37.160"> </span>
<a href="#l37.161"></a><span id="l37.161">   return logLevels;</span>
<a href="#l37.162"></a><span id="l37.162"> });</span>
<a href="#l37.163"></a><span id="l37.163"> </span>
<a href="#l37.164"></a><span id="l37.164" class="difflineminus">-function setTimeout(aFunction, aDelay)</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineminus">-{</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+function setTimeout(aFunction, aDelay) {</span>
<a href="#l37.167"></a><span id="l37.167">   let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l37.168"></a><span id="l37.168">   let args = Array.prototype.slice.call(arguments, 2);</span>
<a href="#l37.169"></a><span id="l37.169">   // A reference to the timer should be kept to ensure it won't be</span>
<a href="#l37.170"></a><span id="l37.170">   // GC'ed before firing the callback.</span>
<a href="#l37.171"></a><span id="l37.171">   let callback = {</span>
<a href="#l37.172"></a><span id="l37.172">     _timer: timer,</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineminus">-    notify(aTimer) { aFunction.apply(null, args); delete this._timer; },</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+    notify(aTimer) {</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineplus">+      aFunction.apply(null, args);</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+      delete this._timer;</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+    },</span>
<a href="#l37.178"></a><span id="l37.178">   };</span>
<a href="#l37.179"></a><span id="l37.179">   timer.initWithCallback(callback, aDelay, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l37.180"></a><span id="l37.180">   return timer;</span>
<a href="#l37.181"></a><span id="l37.181"> }</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineminus">-function clearTimeout(aTimer)</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineminus">-{</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineminus">-  if (aTimer)</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+function clearTimeout(aTimer) {</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+  if (aTimer) {</span>
<a href="#l37.187"></a><span id="l37.187">     aTimer.cancel();</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineplus">+  }</span>
<a href="#l37.189"></a><span id="l37.189"> }</span>
<a href="#l37.190"></a><span id="l37.190"> </span>
<a href="#l37.191"></a><span id="l37.191" class="difflineminus">-function executeSoon(aFunction)</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineminus">-{</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineplus">+function executeSoon(aFunction) {</span>
<a href="#l37.194"></a><span id="l37.194">   Services.tm.mainThread.dispatch(aFunction, Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l37.195"></a><span id="l37.195"> }</span>
<a href="#l37.196"></a><span id="l37.196"> </span>
<a href="#l37.197"></a><span id="l37.197"> /* Common nsIClassInfo and QueryInterface implementation</span>
<a href="#l37.198"></a><span id="l37.198">  * shared by all generic objects implemented in this file. */</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineminus">-function ClassInfo(aInterfaces, aDescription = &quot;JS Proto Object&quot;)</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineminus">-{</span>
<a href="#l37.201"></a><span id="l37.201" class="difflineminus">-  if (!(this instanceof ClassInfo))</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineplus">+function ClassInfo(aInterfaces, aDescription = &quot;JS Proto Object&quot;) {</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineplus">+  if (!(this instanceof ClassInfo)) {</span>
<a href="#l37.204"></a><span id="l37.204">     return new ClassInfo(aInterfaces, aDescription);</span>
<a href="#l37.205"></a><span id="l37.205" class="difflineplus">+  }</span>
<a href="#l37.206"></a><span id="l37.206"> </span>
<a href="#l37.207"></a><span id="l37.207" class="difflineminus">-  if (!Array.isArray(aInterfaces))</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineplus">+  if (!Array.isArray(aInterfaces)) {</span>
<a href="#l37.209"></a><span id="l37.209">     aInterfaces = [aInterfaces];</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineplus">+  }</span>
<a href="#l37.211"></a><span id="l37.211"> </span>
<a href="#l37.212"></a><span id="l37.212" class="difflineminus">-  for (let i of aInterfaces)</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineminus">-    if (typeof i == &quot;string&quot; &amp;&amp; !(i in Ci))</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineplus">+  for (let i of aInterfaces) {</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineplus">+    if (typeof i == &quot;string&quot; &amp;&amp; !(i in Ci)) {</span>
<a href="#l37.216"></a><span id="l37.216">       Services.console.logStringMessage(&quot;ClassInfo: unknown interface &quot; + i);</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineplus">+    }</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineplus">+  }</span>
<a href="#l37.219"></a><span id="l37.219"> </span>
<a href="#l37.220"></a><span id="l37.220" class="difflineminus">-  this._interfaces =</span>
<a href="#l37.221"></a><span id="l37.221" class="difflineminus">-    aInterfaces.map(i =&gt; typeof i == &quot;string&quot; ? Ci[i] : i);</span>
<a href="#l37.222"></a><span id="l37.222" class="difflineplus">+  this._interfaces = aInterfaces.map(i =&gt; (typeof i == &quot;string&quot; ? Ci[i] : i));</span>
<a href="#l37.223"></a><span id="l37.223"> </span>
<a href="#l37.224"></a><span id="l37.224">   this.classDescription = aDescription;</span>
<a href="#l37.225"></a><span id="l37.225"> }</span>
<a href="#l37.226"></a><span id="l37.226"> ClassInfo.prototype = {</span>
<a href="#l37.227"></a><span id="l37.227">   // eslint-disable-next-line mozilla/use-chromeutils-generateqi</span>
<a href="#l37.228"></a><span id="l37.228">   QueryInterface(iid) {</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineminus">-    if (iid.equals(Ci.nsISupports) || iid.equals(Ci.nsIClassInfo) ||</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineminus">-        this._interfaces.some(i =&gt; i.equals(iid)))</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineplus">+    if (</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineplus">+      iid.equals(Ci.nsISupports) ||</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineplus">+      iid.equals(Ci.nsIClassInfo) ||</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineplus">+      this._interfaces.some(i =&gt; i.equals(iid))</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineplus">+    ) {</span>
<a href="#l37.236"></a><span id="l37.236">       return this;</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineplus">+    }</span>
<a href="#l37.238"></a><span id="l37.238"> </span>
<a href="#l37.239"></a><span id="l37.239">     throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l37.240"></a><span id="l37.240">   },</span>
<a href="#l37.241"></a><span id="l37.241">   get interfaces() {</span>
<a href="#l37.242"></a><span id="l37.242">     return [Ci.nsIClassInfo, Ci.nsISupports].concat(this._interfaces);</span>
<a href="#l37.243"></a><span id="l37.243">   },</span>
<a href="#l37.244"></a><span id="l37.244">   getScriptableHelper: () =&gt; null,</span>
<a href="#l37.245"></a><span id="l37.245">   contractID: null,</span>
<a href="#l37.246"></a><span id="l37.246">   classID: null,</span>
<a href="#l37.247"></a><span id="l37.247">   flags: 0,</span>
<a href="#l37.248"></a><span id="l37.248"> };</span>
<a href="#l37.249"></a><span id="l37.249"> </span>
<a href="#l37.250"></a><span id="l37.250" class="difflineminus">-function l10nHelper(aChromeURL)</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineminus">-{</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineplus">+function l10nHelper(aChromeURL) {</span>
<a href="#l37.253"></a><span id="l37.253">   let bundle = Services.strings.createBundle(aChromeURL);</span>
<a href="#l37.254"></a><span id="l37.254">   return function(aStringId) {</span>
<a href="#l37.255"></a><span id="l37.255">     try {</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineminus">-      if (arguments.length == 1)</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineplus">+      if (arguments.length == 1) {</span>
<a href="#l37.258"></a><span id="l37.258">         return bundle.GetStringFromName(aStringId);</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineminus">-      return bundle.formatStringFromName(aStringId,</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineminus">-                                         Array.prototype.slice.call(arguments, 1));</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineplus">+      }</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineplus">+      return bundle.formatStringFromName(</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineplus">+        aStringId,</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineplus">+        Array.prototype.slice.call(arguments, 1)</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineplus">+      );</span>
<a href="#l37.266"></a><span id="l37.266">     } catch (e) {</span>
<a href="#l37.267"></a><span id="l37.267">       Cu.reportError(e);</span>
<a href="#l37.268"></a><span id="l37.268">       dump(&quot;Failed to get &quot; + aStringId + &quot;\n&quot;);</span>
<a href="#l37.269"></a><span id="l37.269">       return aStringId;</span>
<a href="#l37.270"></a><span id="l37.270">     }</span>
<a href="#l37.271"></a><span id="l37.271">   };</span>
<a href="#l37.272"></a><span id="l37.272"> }</span>
<a href="#l37.273"></a><span id="l37.273"> </span>
<a href="#l37.274"></a><span id="l37.274"> /**</span>
<a href="#l37.275"></a><span id="l37.275">  * Constructs an nsISimpleEnumerator for the given array of items.</span>
<a href="#l37.276"></a><span id="l37.276">  * Copied from netwerk/test/httpserver/httpd.js</span>
<a href="#l37.277"></a><span id="l37.277">  *</span>
<a href="#l37.278"></a><span id="l37.278">  * @param items : Array</span>
<a href="#l37.279"></a><span id="l37.279">  *   the items, which must all implement nsISupports</span>
<a href="#l37.280"></a><span id="l37.280">  */</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineminus">-function nsSimpleEnumerator(items)</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineminus">-{</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineplus">+function nsSimpleEnumerator(items) {</span>
<a href="#l37.284"></a><span id="l37.284">   this._items = items;</span>
<a href="#l37.285"></a><span id="l37.285">   this._nextIndex = 0;</span>
<a href="#l37.286"></a><span id="l37.286"> }</span>
<a href="#l37.287"></a><span id="l37.287"> nsSimpleEnumerator.prototype = {</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineminus">-  hasMoreElements() { return this._nextIndex &lt; this._items.length; },</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineplus">+  hasMoreElements() {</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+    return this._nextIndex &lt; this._items.length;</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineplus">+  },</span>
<a href="#l37.292"></a><span id="l37.292">   getNext() {</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineminus">-    if (!this.hasMoreElements())</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineplus">+    if (!this.hasMoreElements()) {</span>
<a href="#l37.295"></a><span id="l37.295">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineplus">+    }</span>
<a href="#l37.297"></a><span id="l37.297"> </span>
<a href="#l37.298"></a><span id="l37.298">     return this._items[this._nextIndex++];</span>
<a href="#l37.299"></a><span id="l37.299">   },</span>
<a href="#l37.300"></a><span id="l37.300">   QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineminus">-  [Symbol.iterator]() { return this._items.values(); },</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineplus">+  [Symbol.iterator]() {</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineplus">+    return this._items.values();</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineplus">+  },</span>
<a href="#l37.305"></a><span id="l37.305"> };</span>
<a href="#l37.306"></a><span id="l37.306"> </span>
<a href="#l37.307"></a><span id="l37.307"> var EmptyEnumerator = {</span>
<a href="#l37.308"></a><span id="l37.308">   hasMoreElements: () =&gt; false,</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineminus">-  getNext() { throw Cr.NS_ERROR_NOT_AVAILABLE; },</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineplus">+  getNext() {</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineplus">+    throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineplus">+  },</span>
<a href="#l37.313"></a><span id="l37.313">   QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineminus">-  * [Symbol.iterator]() {},</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineplus">+  *[Symbol.iterator]() {},</span>
<a href="#l37.316"></a><span id="l37.316"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -17,366 +17,521 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l38.4"></a><span id="l38.4"> </span>
<a href="#l38.5"></a><span id="l38.5"> const {</span>
<a href="#l38.6"></a><span id="l38.6">   EmptyEnumerator,</span>
<a href="#l38.7"></a><span id="l38.7">   initLogModule,</span>
<a href="#l38.8"></a><span id="l38.8">   XPCOMUtils,</span>
<a href="#l38.9"></a><span id="l38.9">   nsSimpleEnumerator,</span>
<a href="#l38.10"></a><span id="l38.10">   l10nHelper,</span>
<a href="#l38.11"></a><span id="l38.11"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-const {ClassInfo} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+const { ClassInfo } = ChromeUtils.import(</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+);</span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l38.20"></a><span id="l38.20">   l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l38.21"></a><span id="l38.21"> );</span>
<a href="#l38.22"></a><span id="l38.22"> </span>
<a href="#l38.23"></a><span id="l38.23"> var GenericAccountPrototype = {</span>
<a href="#l38.24"></a><span id="l38.24">   __proto__: ClassInfo(&quot;prplIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-  get wrappedJSObject() { return this; },</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+  get wrappedJSObject() {</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+    return this;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+  },</span>
<a href="#l38.29"></a><span id="l38.29">   _init(aProtocol, aImAccount) {</span>
<a href="#l38.30"></a><span id="l38.30">     this.protocol = aProtocol;</span>
<a href="#l38.31"></a><span id="l38.31">     this.imAccount = aImAccount;</span>
<a href="#l38.32"></a><span id="l38.32">     initLogModule(aProtocol.id, this);</span>
<a href="#l38.33"></a><span id="l38.33">   },</span>
<a href="#l38.34"></a><span id="l38.34">   observe(aSubject, aTopic, aData) {},</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-  remove() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineminus">-  unInit() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-  connect() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-  disconnect() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-  createConversation(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-  joinChat(aComponents) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+  remove() {</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+  },</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+  unInit() {</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+  },</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+  connect() {</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+  },</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+  disconnect() {</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+  },</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+  },</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+  joinChat(aComponents) {</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+  },</span>
<a href="#l38.59"></a><span id="l38.59">   setBool(aName, aVal) {},</span>
<a href="#l38.60"></a><span id="l38.60">   setInt(aName, aVal) {},</span>
<a href="#l38.61"></a><span id="l38.61">   setString(aName, aVal) {},</span>
<a href="#l38.62"></a><span id="l38.62"> </span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-  get name() { return this.imAccount.name; },</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-  get connected() { return this.imAccount.connected; },</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineminus">-  get connecting() { return this.imAccount.connecting; },</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineminus">-  get disconnected() { return this.imAccount.disconnected; },</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-  get disconnecting() { return this.imAccount.disconnecting; },</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+  get name() {</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+    return this.imAccount.name;</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+  },</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+  get connected() {</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+    return this.imAccount.connected;</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+  },</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+  get connecting() {</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+    return this.imAccount.connecting;</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+  },</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+  get disconnected() {</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+    return this.imAccount.disconnected;</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+  },</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+  get disconnecting() {</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+    return this.imAccount.disconnecting;</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+  },</span>
<a href="#l38.83"></a><span id="l38.83">   _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-  get connectionErrorReason() { return this._connectionErrorReason; },</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+  get connectionErrorReason() {</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+    return this._connectionErrorReason;</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+  },</span>
<a href="#l38.88"></a><span id="l38.88"> </span>
<a href="#l38.89"></a><span id="l38.89">   /*</span>
<a href="#l38.90"></a><span id="l38.90">    * Convert a socket's nsITransportSecurityInfo into a prplIAccount connection error. Store</span>
<a href="#l38.91"></a><span id="l38.91">    * the nsITransportSecurityInfo and the connection location on the account so the</span>
<a href="#l38.92"></a><span id="l38.92">    * certificate exception dialog can access the information.</span>
<a href="#l38.93"></a><span id="l38.93">    */</span>
<a href="#l38.94"></a><span id="l38.94">   handleBadCertificate(aSocket, aIsSslError) {</span>
<a href="#l38.95"></a><span id="l38.95">     this._connectionTarget = aSocket.host + &quot;:&quot; + aSocket.port;</span>
<a href="#l38.96"></a><span id="l38.96"> </span>
<a href="#l38.97"></a><span id="l38.97" class="difflineminus">-    if (aIsSslError)</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+    if (aIsSslError) {</span>
<a href="#l38.99"></a><span id="l38.99">       return Ci.prplIAccount.ERROR_ENCRYPTION_ERROR;</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+    }</span>
<a href="#l38.101"></a><span id="l38.101"> </span>
<a href="#l38.102"></a><span id="l38.102" class="difflineminus">-    let secInfo = this._secInfo = aSocket.secInfo;</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineminus">-    if (!secInfo)</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+    let secInfo = (this._secInfo = aSocket.secInfo);</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+    if (!secInfo) {</span>
<a href="#l38.106"></a><span id="l38.106">       return Ci.prplIAccount.ERROR_CERT_NOT_PROVIDED;</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+    }</span>
<a href="#l38.108"></a><span id="l38.108"> </span>
<a href="#l38.109"></a><span id="l38.109">     if (secInfo.isUntrusted) {</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineminus">-      if (secInfo.serverCert &amp;&amp;</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineminus">-          secInfo.serverCert.isSelfSigned)</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+      if (secInfo.serverCert &amp;&amp; secInfo.serverCert.isSelfSigned) {</span>
<a href="#l38.113"></a><span id="l38.113">         return Ci.prplIAccount.ERROR_CERT_SELF_SIGNED;</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+      }</span>
<a href="#l38.115"></a><span id="l38.115">       return Ci.prplIAccount.ERROR_CERT_UNTRUSTED;</span>
<a href="#l38.116"></a><span id="l38.116">     }</span>
<a href="#l38.117"></a><span id="l38.117"> </span>
<a href="#l38.118"></a><span id="l38.118">     if (secInfo.isNotValidAtThisTime) {</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineminus">-      if (secInfo.serverCert &amp;&amp;</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineminus">-          secInfo.serverCert.validity.notBefore &lt; Date.now() * 1000)</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+      if (</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+        secInfo.serverCert &amp;&amp;</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+        secInfo.serverCert.validity.notBefore &lt; Date.now() * 1000</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineplus">+      ) {</span>
<a href="#l38.125"></a><span id="l38.125">         return Ci.prplIAccount.ERROR_CERT_NOT_ACTIVATED;</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineplus">+      }</span>
<a href="#l38.127"></a><span id="l38.127">       return Ci.prplIAccount.ERROR_CERT_EXPIRED;</span>
<a href="#l38.128"></a><span id="l38.128">     }</span>
<a href="#l38.129"></a><span id="l38.129"> </span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-    if (secInfo.isDomainMismatch)</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineplus">+    if (secInfo.isDomainMismatch) {</span>
<a href="#l38.132"></a><span id="l38.132">       return Ci.prplIAccount.ERROR_CERT_HOSTNAME_MISMATCH;</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineplus">+    }</span>
<a href="#l38.134"></a><span id="l38.134"> </span>
<a href="#l38.135"></a><span id="l38.135">     // XXX ERROR_CERT_FINGERPRINT_MISMATCH</span>
<a href="#l38.136"></a><span id="l38.136"> </span>
<a href="#l38.137"></a><span id="l38.137">     return Ci.prplIAccount.ERROR_CERT_OTHER_ERROR;</span>
<a href="#l38.138"></a><span id="l38.138">   },</span>
<a href="#l38.139"></a><span id="l38.139">   _connectionTarget: &quot;&quot;,</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-  get connectionTarget() { return this._connectionTarget; },</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+  get connectionTarget() {</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+    return this._connectionTarget;</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+  },</span>
<a href="#l38.144"></a><span id="l38.144">   _secInfo: null,</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineminus">-  get secInfo() { return this._secInfo; },</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+  get secInfo() {</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineplus">+    return this._secInfo;</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineplus">+  },</span>
<a href="#l38.149"></a><span id="l38.149"> </span>
<a href="#l38.150"></a><span id="l38.150">   reportConnected() {</span>
<a href="#l38.151"></a><span id="l38.151">     this.imAccount.observe(this, &quot;account-connected&quot;, null);</span>
<a href="#l38.152"></a><span id="l38.152">   },</span>
<a href="#l38.153"></a><span id="l38.153">   reportConnecting(aConnectionStateMsg) {</span>
<a href="#l38.154"></a><span id="l38.154">     // Delete any leftover errors from the previous connection.</span>
<a href="#l38.155"></a><span id="l38.155">     delete this._connectionTarget;</span>
<a href="#l38.156"></a><span id="l38.156">     delete this._secInfo;</span>
<a href="#l38.157"></a><span id="l38.157"> </span>
<a href="#l38.158"></a><span id="l38.158" class="difflineminus">-    if (!this.connecting)</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+    if (!this.connecting) {</span>
<a href="#l38.160"></a><span id="l38.160">       this.imAccount.observe(this, &quot;account-connecting&quot;, null);</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineminus">-    if (aConnectionStateMsg)</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineminus">-      this.imAccount.observe(this, &quot;account-connect-progress&quot;, aConnectionStateMsg);</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineplus">+    }</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineplus">+    if (aConnectionStateMsg) {</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineplus">+      this.imAccount.observe(</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineplus">+        this,</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineplus">+        &quot;account-connect-progress&quot;,</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineplus">+        aConnectionStateMsg</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineplus">+      );</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineplus">+    }</span>
<a href="#l38.171"></a><span id="l38.171">   },</span>
<a href="#l38.172"></a><span id="l38.172">   reportDisconnected() {</span>
<a href="#l38.173"></a><span id="l38.173">     this.imAccount.observe(this, &quot;account-disconnected&quot;, null);</span>
<a href="#l38.174"></a><span id="l38.174">   },</span>
<a href="#l38.175"></a><span id="l38.175">   reportDisconnecting(aConnectionErrorReason, aConnectionErrorMessage) {</span>
<a href="#l38.176"></a><span id="l38.176">     this._connectionErrorReason = aConnectionErrorReason;</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineminus">-    this.imAccount.observe(this, &quot;account-disconnecting&quot;, aConnectionErrorMessage);</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineplus">+    this.imAccount.observe(</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineplus">+      this,</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineplus">+      &quot;account-disconnecting&quot;,</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineplus">+      aConnectionErrorMessage</span>
<a href="#l38.182"></a><span id="l38.182" class="difflineplus">+    );</span>
<a href="#l38.183"></a><span id="l38.183">     this.cancelPendingBuddyRequests();</span>
<a href="#l38.184"></a><span id="l38.184">   },</span>
<a href="#l38.185"></a><span id="l38.185"> </span>
<a href="#l38.186"></a><span id="l38.186">   // Called when the user adds a new buddy from the UI.</span>
<a href="#l38.187"></a><span id="l38.187">   addBuddy(aTag, aName) {</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineminus">-    Services.contacts</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineminus">-            .accountBuddyAdded(new AccountBuddy(this, null, aTag, aName));</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineplus">+    Services.contacts.accountBuddyAdded(</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineplus">+      new AccountBuddy(this, null, aTag, aName)</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineplus">+    );</span>
<a href="#l38.193"></a><span id="l38.193">   },</span>
<a href="#l38.194"></a><span id="l38.194">   // Called during startup for each of the buddies in the local buddy list.</span>
<a href="#l38.195"></a><span id="l38.195">   loadBuddy(aBuddy, aTag) {</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineminus">-   try {</span>
<a href="#l38.197"></a><span id="l38.197" class="difflineminus">-     return new AccountBuddy(this, aBuddy, aTag);</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineminus">-   } catch (x) {</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineminus">-     dump(x + &quot;\n&quot;);</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineminus">-     return null;</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineminus">-   }</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineplus">+    try {</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineplus">+      return new AccountBuddy(this, aBuddy, aTag);</span>
<a href="#l38.204"></a><span id="l38.204" class="difflineplus">+    } catch (x) {</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineplus">+      dump(x + &quot;\n&quot;);</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineplus">+      return null;</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineplus">+    }</span>
<a href="#l38.208"></a><span id="l38.208">   },</span>
<a href="#l38.209"></a><span id="l38.209"> </span>
<a href="#l38.210"></a><span id="l38.210">   _pendingBuddyRequests: null,</span>
<a href="#l38.211"></a><span id="l38.211">   addBuddyRequest(aUserName, aGrantCallback, aDenyCallback) {</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-    if (!this._pendingBuddyRequests)</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineplus">+    if (!this._pendingBuddyRequests) {</span>
<a href="#l38.214"></a><span id="l38.214">       this._pendingBuddyRequests = [];</span>
<a href="#l38.215"></a><span id="l38.215" class="difflineplus">+    }</span>
<a href="#l38.216"></a><span id="l38.216">     let buddyRequest = {</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineminus">-      get account() { return this._account.imAccount; },</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineminus">-      get userName() { return aUserName; },</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineplus">+      get account() {</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineplus">+        return this._account.imAccount;</span>
<a href="#l38.221"></a><span id="l38.221" class="difflineplus">+      },</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineplus">+      get userName() {</span>
<a href="#l38.223"></a><span id="l38.223" class="difflineplus">+        return aUserName;</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineplus">+      },</span>
<a href="#l38.225"></a><span id="l38.225">       _account: this,</span>
<a href="#l38.226"></a><span id="l38.226">       // Grant and deny callbacks both receive the auth request object as an</span>
<a href="#l38.227"></a><span id="l38.227">       // argument for further use.</span>
<a href="#l38.228"></a><span id="l38.228">       grant() {</span>
<a href="#l38.229"></a><span id="l38.229">         aGrantCallback(this);</span>
<a href="#l38.230"></a><span id="l38.230">         this._remove();</span>
<a href="#l38.231"></a><span id="l38.231">       },</span>
<a href="#l38.232"></a><span id="l38.232">       deny() {</span>
<a href="#l38.233"></a><span id="l38.233">         aDenyCallback(this);</span>
<a href="#l38.234"></a><span id="l38.234">         this._remove();</span>
<a href="#l38.235"></a><span id="l38.235">       },</span>
<a href="#l38.236"></a><span id="l38.236">       cancel() {</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineminus">-        Services.obs.notifyObservers(this,</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-                                     &quot;buddy-authorization-request-canceled&quot;);</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineplus">+        Services.obs.notifyObservers(</span>
<a href="#l38.240"></a><span id="l38.240" class="difflineplus">+          this,</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineplus">+          &quot;buddy-authorization-request-canceled&quot;</span>
<a href="#l38.242"></a><span id="l38.242" class="difflineplus">+        );</span>
<a href="#l38.243"></a><span id="l38.243">         this._remove();</span>
<a href="#l38.244"></a><span id="l38.244">       },</span>
<a href="#l38.245"></a><span id="l38.245">       _remove() {</span>
<a href="#l38.246"></a><span id="l38.246">         this._account.removeBuddyRequest(this);</span>
<a href="#l38.247"></a><span id="l38.247">       },</span>
<a href="#l38.248"></a><span id="l38.248">       QueryInterface: ChromeUtils.generateQI([Ci.prplIBuddyRequest]),</span>
<a href="#l38.249"></a><span id="l38.249">     };</span>
<a href="#l38.250"></a><span id="l38.250">     this._pendingBuddyRequests.push(buddyRequest);</span>
<a href="#l38.251"></a><span id="l38.251">     Services.obs.notifyObservers(buddyRequest, &quot;buddy-authorization-request&quot;);</span>
<a href="#l38.252"></a><span id="l38.252">   },</span>
<a href="#l38.253"></a><span id="l38.253">   removeBuddyRequest(aRequest) {</span>
<a href="#l38.254"></a><span id="l38.254" class="difflineminus">-    if (!this._pendingBuddyRequests)</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineplus">+    if (!this._pendingBuddyRequests) {</span>
<a href="#l38.256"></a><span id="l38.256">       return;</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineplus">+    }</span>
<a href="#l38.258"></a><span id="l38.258"> </span>
<a href="#l38.259"></a><span id="l38.259" class="difflineminus">-    this._pendingBuddyRequests =</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineminus">-      this._pendingBuddyRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineplus">+    this._pendingBuddyRequests = this._pendingBuddyRequests.filter(</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineplus">+      r =&gt; r !== aRequest</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineplus">+    );</span>
<a href="#l38.264"></a><span id="l38.264">   },</span>
<a href="#l38.265"></a><span id="l38.265">   cancelPendingBuddyRequests() {</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineminus">-    if (!this._pendingBuddyRequests)</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineplus">+    if (!this._pendingBuddyRequests) {</span>
<a href="#l38.268"></a><span id="l38.268">       return;</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineplus">+    }</span>
<a href="#l38.270"></a><span id="l38.270"> </span>
<a href="#l38.271"></a><span id="l38.271" class="difflineminus">-    for (let request of this._pendingBuddyRequests)</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineplus">+    for (let request of this._pendingBuddyRequests) {</span>
<a href="#l38.273"></a><span id="l38.273">       request.cancel();</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineplus">+    }</span>
<a href="#l38.275"></a><span id="l38.275">     delete this._pendingBuddyRequests;</span>
<a href="#l38.276"></a><span id="l38.276">   },</span>
<a href="#l38.277"></a><span id="l38.277"> </span>
<a href="#l38.278"></a><span id="l38.278">   requestBuddyInfo(aBuddyName) {},</span>
<a href="#l38.279"></a><span id="l38.279"> </span>
<a href="#l38.280"></a><span id="l38.280" class="difflineminus">-  get canJoinChat() { return false; },</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineplus">+    return false;</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineplus">+  },</span>
<a href="#l38.284"></a><span id="l38.284">   getChatRoomFields() {</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineminus">-    if (!this.chatRoomFields)</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineplus">+    if (!this.chatRoomFields) {</span>
<a href="#l38.287"></a><span id="l38.287">       return EmptyEnumerator;</span>
<a href="#l38.288"></a><span id="l38.288" class="difflineplus">+    }</span>
<a href="#l38.289"></a><span id="l38.289"> </span>
<a href="#l38.290"></a><span id="l38.290">     let fields = [];</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineminus">-    for (let fieldName in this.chatRoomFields)</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineplus">+    for (let fieldName in this.chatRoomFields) {</span>
<a href="#l38.293"></a><span id="l38.293">       fields.push(new ChatRoomField(fieldName, this.chatRoomFields[fieldName]));</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineplus">+    }</span>
<a href="#l38.295"></a><span id="l38.295">     return new nsSimpleEnumerator(fields);</span>
<a href="#l38.296"></a><span id="l38.296">   },</span>
<a href="#l38.297"></a><span id="l38.297">   getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineminus">-    if (!this.chatRoomFields)</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineplus">+    if (!this.chatRoomFields) {</span>
<a href="#l38.300"></a><span id="l38.300">       return EmptyEnumerator;</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineplus">+    }</span>
<a href="#l38.302"></a><span id="l38.302"> </span>
<a href="#l38.303"></a><span id="l38.303">     let defaultFieldValues = [];</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineminus">-    for (let fieldName in this.chatRoomFields)</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineplus">+    for (let fieldName in this.chatRoomFields) {</span>
<a href="#l38.306"></a><span id="l38.306">       defaultFieldValues[fieldName] = this.chatRoomFields[fieldName].default;</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineplus">+    }</span>
<a href="#l38.308"></a><span id="l38.308"> </span>
<a href="#l38.309"></a><span id="l38.309">     if (aDefaultChatName &amp;&amp; &quot;parseDefaultChatName&quot; in this) {</span>
<a href="#l38.310"></a><span id="l38.310">       let parsedDefaultChatName = this.parseDefaultChatName(aDefaultChatName);</span>
<a href="#l38.311"></a><span id="l38.311" class="difflineminus">-      for (let field in parsedDefaultChatName)</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineplus">+      for (let field in parsedDefaultChatName) {</span>
<a href="#l38.313"></a><span id="l38.313">         defaultFieldValues[field] = parsedDefaultChatName[field];</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineplus">+      }</span>
<a href="#l38.315"></a><span id="l38.315">     }</span>
<a href="#l38.316"></a><span id="l38.316"> </span>
<a href="#l38.317"></a><span id="l38.317">     return new ChatRoomFieldValues(defaultFieldValues);</span>
<a href="#l38.318"></a><span id="l38.318">   },</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-  requestRoomInfo(aCallback) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineminus">-  getRoomInfo(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineminus">-  get isRoomInfoStale() { return false; },</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineplus">+  requestRoomInfo(aCallback) {</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineplus">+  },</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineplus">+  getRoomInfo(aName) {</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineplus">+  },</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineplus">+  get isRoomInfoStale() {</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineplus">+    return false;</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineplus">+  },</span>
<a href="#l38.331"></a><span id="l38.331"> </span>
<a href="#l38.332"></a><span id="l38.332">   getPref(aName, aType) {</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineminus">-    return this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineminus">-           this.prefs[&quot;get&quot; + aType + &quot;Pref&quot;](aName) :</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineminus">-           this.protocol._getOptionDefault(aName);</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+    return this.prefs.prefHasUserValue(aName)</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineplus">+      ? this.prefs[&quot;get&quot; + aType + &quot;Pref&quot;](aName)</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineplus">+      : this.protocol._getOptionDefault(aName);</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineplus">+  },</span>
<a href="#l38.340"></a><span id="l38.340" class="difflineplus">+  getInt(aName) {</span>
<a href="#l38.341"></a><span id="l38.341" class="difflineplus">+    return this.getPref(aName, &quot;Int&quot;);</span>
<a href="#l38.342"></a><span id="l38.342">   },</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineminus">-  getInt(aName) { return this.getPref(aName, &quot;Int&quot;); },</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineminus">-  getBool(aName) { return this.getPref(aName, &quot;Bool&quot;); },</span>
<a href="#l38.345"></a><span id="l38.345" class="difflineplus">+  getBool(aName) {</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineplus">+    return this.getPref(aName, &quot;Bool&quot;);</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineplus">+  },</span>
<a href="#l38.348"></a><span id="l38.348">   getString(aName) {</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineminus">-    return this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineminus">-             this.prefs.getStringPref(aName) :</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineminus">-             this.protocol._getOptionDefault(aName);</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineplus">+    return this.prefs.prefHasUserValue(aName)</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineplus">+      ? this.prefs.getStringPref(aName)</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineplus">+      : this.protocol._getOptionDefault(aName);</span>
<a href="#l38.355"></a><span id="l38.355">   },</span>
<a href="#l38.356"></a><span id="l38.356"> </span>
<a href="#l38.357"></a><span id="l38.357">   get prefs() {</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineminus">-    return this._prefs ||</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineminus">-           (this._prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineminus">-                                                   this.imAccount.id + &quot;.options.&quot;));</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineplus">+    return (</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineplus">+      this._prefs ||</span>
<a href="#l38.363"></a><span id="l38.363" class="difflineplus">+      (this._prefs = Services.prefs.getBranch(</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineplus">+        &quot;messenger.account.&quot; + this.imAccount.id + &quot;.options.&quot;</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineplus">+      ))</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineplus">+    );</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineplus">+  },</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineplus">+</span>
<a href="#l38.369"></a><span id="l38.369" class="difflineplus">+  get normalizedName() {</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineplus">+    return this.normalize(this.name);</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineplus">+  },</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineplus">+  normalize(aName) {</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineplus">+    return aName.toLowerCase();</span>
<a href="#l38.374"></a><span id="l38.374">   },</span>
<a href="#l38.375"></a><span id="l38.375"> </span>
<a href="#l38.376"></a><span id="l38.376" class="difflineminus">-  get normalizedName() { return this.normalize(this.name); },</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineminus">-  normalize(aName) { return aName.toLowerCase(); },</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineminus">-</span>
<a href="#l38.379"></a><span id="l38.379" class="difflineminus">-  get HTMLEnabled() { return false; },</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-  get HTMLEscapePlainText() { return false; },</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineminus">-  get noBackgroundColors() { return true; },</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineminus">-  get autoResponses() { return false; },</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineminus">-  get singleFormatting() { return false; },</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineminus">-  get noFontSizes() { return false; },</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineminus">-  get noUrlDesc() { return false; },</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-  get noImages() { return true; },</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineplus">+  get HTMLEnabled() {</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineplus">+    return false;</span>
<a href="#l38.389"></a><span id="l38.389" class="difflineplus">+  },</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineplus">+  get HTMLEscapePlainText() {</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineplus">+    return false;</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineplus">+  },</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineplus">+  get noBackgroundColors() {</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineplus">+    return true;</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineplus">+  },</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineplus">+  get autoResponses() {</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineplus">+    return false;</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineplus">+  },</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineplus">+  get singleFormatting() {</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineplus">+    return false;</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineplus">+  },</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineplus">+  get noFontSizes() {</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineplus">+    return false;</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineplus">+  },</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineplus">+  get noUrlDesc() {</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineplus">+    return false;</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineplus">+  },</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineplus">+  get noImages() {</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineplus">+    return true;</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineplus">+  },</span>
<a href="#l38.411"></a><span id="l38.411"> };</span>
<a href="#l38.412"></a><span id="l38.412"> </span>
<a href="#l38.413"></a><span id="l38.413" class="difflineminus">-</span>
<a href="#l38.414"></a><span id="l38.414"> var GenericAccountBuddyPrototype = {</span>
<a href="#l38.415"></a><span id="l38.415">   __proto__: ClassInfo(&quot;prplIAccountBuddy&quot;, &quot;generic account buddy object&quot;),</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineminus">-  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineminus">-  get LOG() { return this._account.LOG; },</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineminus">-  get WARN() { return this._account.WARN; },</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineminus">-  get ERROR() { return this._account.ERROR; },</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineplus">+  get DEBUG() {</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineplus">+    return this._account.DEBUG;</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineplus">+  },</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineplus">+  get LOG() {</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineplus">+    return this._account.LOG;</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineplus">+  },</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineplus">+  get WARN() {</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineplus">+    return this._account.WARN;</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineplus">+  },</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineplus">+  get ERROR() {</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineplus">+    return this._account.ERROR;</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineplus">+  },</span>
<a href="#l38.432"></a><span id="l38.432"> </span>
<a href="#l38.433"></a><span id="l38.433">   _init(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineminus">-    if (!aBuddy &amp;&amp; !aUserName)</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineplus">+    if (!aBuddy &amp;&amp; !aUserName) {</span>
<a href="#l38.436"></a><span id="l38.436">       throw new Error(&quot;aUserName is required when aBuddy is null&quot;);</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineplus">+    }</span>
<a href="#l38.438"></a><span id="l38.438"> </span>
<a href="#l38.439"></a><span id="l38.439">     this._tag = aTag;</span>
<a href="#l38.440"></a><span id="l38.440">     this._account = aAccount;</span>
<a href="#l38.441"></a><span id="l38.441">     this._buddy = aBuddy;</span>
<a href="#l38.442"></a><span id="l38.442">     if (aBuddy) {</span>
<a href="#l38.443"></a><span id="l38.443">       let displayName = aBuddy.displayName;</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineminus">-      if (displayName != aUserName)</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineplus">+      if (displayName != aUserName) {</span>
<a href="#l38.446"></a><span id="l38.446">         this._serverAlias = displayName;</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineplus">+      }</span>
<a href="#l38.448"></a><span id="l38.448">     }</span>
<a href="#l38.449"></a><span id="l38.449">     this._userName = aUserName;</span>
<a href="#l38.450"></a><span id="l38.450">   },</span>
<a href="#l38.451"></a><span id="l38.451">   unInit() {</span>
<a href="#l38.452"></a><span id="l38.452">     delete this._tag;</span>
<a href="#l38.453"></a><span id="l38.453">     delete this._account;</span>
<a href="#l38.454"></a><span id="l38.454">     delete this._buddy;</span>
<a href="#l38.455"></a><span id="l38.455">   },</span>
<a href="#l38.456"></a><span id="l38.456"> </span>
<a href="#l38.457"></a><span id="l38.457" class="difflineminus">-  get account() { return this._account.imAccount; },</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineplus">+  get account() {</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineplus">+    return this._account.imAccount;</span>
<a href="#l38.460"></a><span id="l38.460" class="difflineplus">+  },</span>
<a href="#l38.461"></a><span id="l38.461">   set buddy(aBuddy) {</span>
<a href="#l38.462"></a><span id="l38.462" class="difflineminus">-    if (this._buddy)</span>
<a href="#l38.463"></a><span id="l38.463" class="difflineplus">+    if (this._buddy) {</span>
<a href="#l38.464"></a><span id="l38.464">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l38.465"></a><span id="l38.465" class="difflineplus">+    }</span>
<a href="#l38.466"></a><span id="l38.466">     this._buddy = aBuddy;</span>
<a href="#l38.467"></a><span id="l38.467">   },</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineminus">-  get buddy() { return this._buddy; },</span>
<a href="#l38.469"></a><span id="l38.469" class="difflineminus">-  get tag() { return this._tag; },</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineplus">+  get buddy() {</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineplus">+    return this._buddy;</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineplus">+  },</span>
<a href="#l38.473"></a><span id="l38.473" class="difflineplus">+  get tag() {</span>
<a href="#l38.474"></a><span id="l38.474" class="difflineplus">+    return this._tag;</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineplus">+  },</span>
<a href="#l38.476"></a><span id="l38.476">   set tag(aNewTag) {</span>
<a href="#l38.477"></a><span id="l38.477">     let oldTag = this._tag;</span>
<a href="#l38.478"></a><span id="l38.478">     this._tag = aNewTag;</span>
<a href="#l38.479"></a><span id="l38.479">     Services.contacts.accountBuddyMoved(this, oldTag, aNewTag);</span>
<a href="#l38.480"></a><span id="l38.480">   },</span>
<a href="#l38.481"></a><span id="l38.481"> </span>
<a href="#l38.482"></a><span id="l38.482">   _notifyObservers(aTopic, aData) {</span>
<a href="#l38.483"></a><span id="l38.483">     try {</span>
<a href="#l38.484"></a><span id="l38.484">       this._buddy.observe(this, &quot;account-buddy-&quot; + aTopic, aData);</span>
<a href="#l38.485"></a><span id="l38.485">     } catch (e) {</span>
<a href="#l38.486"></a><span id="l38.486">       this.ERROR(e);</span>
<a href="#l38.487"></a><span id="l38.487">     }</span>
<a href="#l38.488"></a><span id="l38.488">   },</span>
<a href="#l38.489"></a><span id="l38.489"> </span>
<a href="#l38.490"></a><span id="l38.490">   _userName: &quot;&quot;,</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-  get userName() { return this._userName || this._buddy.userName; },</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineminus">-  get normalizedName() { return this._account.normalize(this.userName); },</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineplus">+  get userName() {</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineplus">+    return this._userName || this._buddy.userName;</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineplus">+  },</span>
<a href="#l38.496"></a><span id="l38.496" class="difflineplus">+  get normalizedName() {</span>
<a href="#l38.497"></a><span id="l38.497" class="difflineplus">+    return this._account.normalize(this.userName);</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineplus">+  },</span>
<a href="#l38.499"></a><span id="l38.499">   _serverAlias: &quot;&quot;,</span>
<a href="#l38.500"></a><span id="l38.500" class="difflineminus">-  get serverAlias() { return this._serverAlias; },</span>
<a href="#l38.501"></a><span id="l38.501" class="difflineplus">+  get serverAlias() {</span>
<a href="#l38.502"></a><span id="l38.502" class="difflineplus">+    return this._serverAlias;</span>
<a href="#l38.503"></a><span id="l38.503" class="difflineplus">+  },</span>
<a href="#l38.504"></a><span id="l38.504">   set serverAlias(aNewAlias) {</span>
<a href="#l38.505"></a><span id="l38.505">     let old = this.displayName;</span>
<a href="#l38.506"></a><span id="l38.506">     this._serverAlias = aNewAlias;</span>
<a href="#l38.507"></a><span id="l38.507" class="difflineminus">-    if (old != this.displayName)</span>
<a href="#l38.508"></a><span id="l38.508" class="difflineplus">+    if (old != this.displayName) {</span>
<a href="#l38.509"></a><span id="l38.509">       this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineplus">+    }</span>
<a href="#l38.511"></a><span id="l38.511">   },</span>
<a href="#l38.512"></a><span id="l38.512"> </span>
<a href="#l38.513"></a><span id="l38.513">   remove() {</span>
<a href="#l38.514"></a><span id="l38.514">     Services.contacts.accountBuddyRemoved(this);</span>
<a href="#l38.515"></a><span id="l38.515">   },</span>
<a href="#l38.516"></a><span id="l38.516"> </span>
<a href="#l38.517"></a><span id="l38.517">   // imIStatusInfo implementation</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineminus">-  get displayName() { return this.serverAlias || this.userName; },</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineplus">+  get displayName() {</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineplus">+    return this.serverAlias || this.userName;</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineplus">+  },</span>
<a href="#l38.522"></a><span id="l38.522">   _buddyIconFileName: &quot;&quot;,</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-  get buddyIconFilename() { return this._buddyIconFileName; },</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineplus">+  get buddyIconFilename() {</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineplus">+    return this._buddyIconFileName;</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineplus">+  },</span>
<a href="#l38.527"></a><span id="l38.527">   set buddyIconFilename(aNewFileName) {</span>
<a href="#l38.528"></a><span id="l38.528">     this._buddyIconFileName = aNewFileName;</span>
<a href="#l38.529"></a><span id="l38.529">     this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l38.530"></a><span id="l38.530">   },</span>
<a href="#l38.531"></a><span id="l38.531">   _statusType: 0,</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-  get statusType() { return this._statusType; },</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineminus">-  get online() { return this._statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE; },</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineminus">-  get available() { return this._statusType == Ci.imIStatusInfo.STATUS_AVAILABLE; },</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineminus">-  get idle() { return this._statusType == Ci.imIStatusInfo.STATUS_IDLE; },</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineminus">-  get mobile() { return this._statusType == Ci.imIStatusInfo.STATUS_MOBILE; },</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineplus">+  get statusType() {</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineplus">+    return this._statusType;</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineplus">+  },</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineplus">+  get online() {</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineplus">+    return this._statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineplus">+  },</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineplus">+  get available() {</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineplus">+    return this._statusType == Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineplus">+  },</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineplus">+  get idle() {</span>
<a href="#l38.547"></a><span id="l38.547" class="difflineplus">+    return this._statusType == Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l38.548"></a><span id="l38.548" class="difflineplus">+  },</span>
<a href="#l38.549"></a><span id="l38.549" class="difflineplus">+  get mobile() {</span>
<a href="#l38.550"></a><span id="l38.550" class="difflineplus">+    return this._statusType == Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineplus">+  },</span>
<a href="#l38.552"></a><span id="l38.552">   _statusText: &quot;&quot;,</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-  get statusText() { return this._statusText; },</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineplus">+  get statusText() {</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineplus">+    return this._statusText;</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineplus">+  },</span>
<a href="#l38.557"></a><span id="l38.557"> </span>
<a href="#l38.558"></a><span id="l38.558">   // This is for use by the protocol plugin, it's not exposed in the</span>
<a href="#l38.559"></a><span id="l38.559">   // imIStatusInfo interface.</span>
<a href="#l38.560"></a><span id="l38.560">   // All parameters are optional and will be ignored if they are null</span>
<a href="#l38.561"></a><span id="l38.561">   // or undefined.</span>
<a href="#l38.562"></a><span id="l38.562">   setStatus(aStatusType, aStatusText, aAvailabilityDetails) {</span>
<a href="#l38.563"></a><span id="l38.563">     // Ignore omitted parameters.</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineminus">-    if (aStatusType === undefined || aStatusType === null)</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineplus">+    if (aStatusType === undefined || aStatusType === null) {</span>
<a href="#l38.566"></a><span id="l38.566">       aStatusType = this._statusType;</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineminus">-    if (aStatusText === undefined || aStatusText === null)</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineplus">+    }</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineplus">+    if (aStatusText === undefined || aStatusText === null) {</span>
<a href="#l38.570"></a><span id="l38.570">       aStatusText = this._statusText;</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineminus">-    if (aAvailabilityDetails === undefined || aAvailabilityDetails === null)</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineplus">+    }</span>
<a href="#l38.573"></a><span id="l38.573" class="difflineplus">+    if (aAvailabilityDetails === undefined || aAvailabilityDetails === null) {</span>
<a href="#l38.574"></a><span id="l38.574">       aAvailabilityDetails = this._availabilityDetails;</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineplus">+    }</span>
<a href="#l38.576"></a><span id="l38.576"> </span>
<a href="#l38.577"></a><span id="l38.577">     // Decide which notifications should be fired.</span>
<a href="#l38.578"></a><span id="l38.578">     let notifications = [];</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineminus">-    if (this._statusType != aStatusType ||</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineminus">-        this._availabilityDetails != aAvailabilityDetails)</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineplus">+    if (</span>
<a href="#l38.582"></a><span id="l38.582" class="difflineplus">+      this._statusType != aStatusType ||</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineplus">+      this._availabilityDetails != aAvailabilityDetails</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineplus">+    ) {</span>
<a href="#l38.585"></a><span id="l38.585">       notifications.push(&quot;availability-changed&quot;);</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineminus">-    if (this._statusType != aStatusType ||</span>
<a href="#l38.587"></a><span id="l38.587" class="difflineminus">-        this._statusText != aStatusText) {</span>
<a href="#l38.588"></a><span id="l38.588" class="difflineplus">+    }</span>
<a href="#l38.589"></a><span id="l38.589" class="difflineplus">+    if (this._statusType != aStatusType || this._statusText != aStatusText) {</span>
<a href="#l38.590"></a><span id="l38.590">       notifications.push(&quot;status-changed&quot;);</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineminus">-      if (this.online &amp;&amp; aStatusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineplus">+      if (this.online &amp;&amp; aStatusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l38.593"></a><span id="l38.593">         notifications.push(&quot;signed-off&quot;);</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineminus">-      if (!this.online &amp;&amp; aStatusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineplus">+      }</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineplus">+      if (!this.online &amp;&amp; aStatusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l38.597"></a><span id="l38.597">         notifications.push(&quot;signed-on&quot;);</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineplus">+      }</span>
<a href="#l38.599"></a><span id="l38.599">     }</span>
<a href="#l38.600"></a><span id="l38.600"> </span>
<a href="#l38.601"></a><span id="l38.601">     // Actually change the stored status.</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineminus">-    [this._statusType, this._statusText, this._availabilityDetails] =</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineminus">-      [aStatusType, aStatusText, aAvailabilityDetails];</span>
<a href="#l38.604"></a><span id="l38.604" class="difflineplus">+    [this._statusType, this._statusText, this._availabilityDetails] = [</span>
<a href="#l38.605"></a><span id="l38.605" class="difflineplus">+      aStatusType,</span>
<a href="#l38.606"></a><span id="l38.606" class="difflineplus">+      aStatusText,</span>
<a href="#l38.607"></a><span id="l38.607" class="difflineplus">+      aAvailabilityDetails,</span>
<a href="#l38.608"></a><span id="l38.608" class="difflineplus">+    ];</span>
<a href="#l38.609"></a><span id="l38.609"> </span>
<a href="#l38.610"></a><span id="l38.610">     // Fire the notifications.</span>
<a href="#l38.611"></a><span id="l38.611">     notifications.forEach(function(aTopic) {</span>
<a href="#l38.612"></a><span id="l38.612">       this._notifyObservers(aTopic);</span>
<a href="#l38.613"></a><span id="l38.613">     }, this);</span>
<a href="#l38.614"></a><span id="l38.614">   },</span>
<a href="#l38.615"></a><span id="l38.615"> </span>
<a href="#l38.616"></a><span id="l38.616">   _availabilityDetails: 0,</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineminus">-  get availabilityDetails() { return this._availabilityDetails; },</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineplus">+  get availabilityDetails() {</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineplus">+    return this._availabilityDetails;</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineplus">+  },</span>
<a href="#l38.621"></a><span id="l38.621"> </span>
<a href="#l38.622"></a><span id="l38.622" class="difflineminus">-  get canSendMessage() { return this.online; },</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineplus">+    return this.online;</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineplus">+  },</span>
<a href="#l38.626"></a><span id="l38.626"> </span>
<a href="#l38.627"></a><span id="l38.627">   getTooltipInfo: () =&gt; EmptyEnumerator,</span>
<a href="#l38.628"></a><span id="l38.628" class="difflineminus">-  createConversation() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.629"></a><span id="l38.629" class="difflineplus">+  createConversation() {</span>
<a href="#l38.630"></a><span id="l38.630" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineplus">+  },</span>
<a href="#l38.632"></a><span id="l38.632"> };</span>
<a href="#l38.633"></a><span id="l38.633"> </span>
<a href="#l38.634"></a><span id="l38.634"> // aUserName is required only if aBuddy is null, i.e., we are adding a buddy.</span>
<a href="#l38.635"></a><span id="l38.635"> function AccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l38.636"></a><span id="l38.636">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l38.637"></a><span id="l38.637"> }</span>
<a href="#l38.638"></a><span id="l38.638"> AccountBuddy.prototype = GenericAccountBuddyPrototype;</span>
<a href="#l38.639"></a><span id="l38.639"> </span>
<a href="#l38.640"></a><span id="l38.640" class="difflineat">@@ -386,38 +541,46 @@ var GenericMessagePrototype = {</span>
<a href="#l38.641"></a><span id="l38.641">   _lastId: 0,</span>
<a href="#l38.642"></a><span id="l38.642">   _init(aWho, aMessage, aObject) {</span>
<a href="#l38.643"></a><span id="l38.643">     this.id = ++GenericMessagePrototype._lastId;</span>
<a href="#l38.644"></a><span id="l38.644">     this.time = Math.floor(new Date() / 1000);</span>
<a href="#l38.645"></a><span id="l38.645">     this.who = aWho;</span>
<a href="#l38.646"></a><span id="l38.646">     this.message = aMessage;</span>
<a href="#l38.647"></a><span id="l38.647">     this.originalMessage = aMessage;</span>
<a href="#l38.648"></a><span id="l38.648"> </span>
<a href="#l38.649"></a><span id="l38.649" class="difflineminus">-    if (aObject)</span>
<a href="#l38.650"></a><span id="l38.650" class="difflineminus">-      for (let i in aObject)</span>
<a href="#l38.651"></a><span id="l38.651" class="difflineplus">+    if (aObject) {</span>
<a href="#l38.652"></a><span id="l38.652" class="difflineplus">+      for (let i in aObject) {</span>
<a href="#l38.653"></a><span id="l38.653">         this[i] = aObject[i];</span>
<a href="#l38.654"></a><span id="l38.654" class="difflineplus">+      }</span>
<a href="#l38.655"></a><span id="l38.655" class="difflineplus">+    }</span>
<a href="#l38.656"></a><span id="l38.656">   },</span>
<a href="#l38.657"></a><span id="l38.657">   _alias: &quot;&quot;,</span>
<a href="#l38.658"></a><span id="l38.658" class="difflineminus">-  get alias() { return this._alias || this.who; },</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineplus">+  get alias() {</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineplus">+    return this._alias || this.who;</span>
<a href="#l38.661"></a><span id="l38.661" class="difflineplus">+  },</span>
<a href="#l38.662"></a><span id="l38.662">   _iconURL: &quot;&quot;,</span>
<a href="#l38.663"></a><span id="l38.663">   get iconURL() {</span>
<a href="#l38.664"></a><span id="l38.664">     // If the protocol plugin has explicitly set an icon for the message, use it.</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineminus">-    if (this._iconURL)</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineplus">+    if (this._iconURL) {</span>
<a href="#l38.667"></a><span id="l38.667">       return this._iconURL;</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineplus">+    }</span>
<a href="#l38.669"></a><span id="l38.669"> </span>
<a href="#l38.670"></a><span id="l38.670">     // Otherwise, attempt to find a buddy for incoming messages, and forward the call.</span>
<a href="#l38.671"></a><span id="l38.671">     if (this.incoming &amp;&amp; this._conversation &amp;&amp; !this._conversation.isChat) {</span>
<a href="#l38.672"></a><span id="l38.672">       let buddy = this._conversation.buddy;</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineminus">-      if (buddy)</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineplus">+      if (buddy) {</span>
<a href="#l38.675"></a><span id="l38.675">         return buddy.buddyIconFilename;</span>
<a href="#l38.676"></a><span id="l38.676" class="difflineplus">+      }</span>
<a href="#l38.677"></a><span id="l38.677">     }</span>
<a href="#l38.678"></a><span id="l38.678">     return &quot;&quot;;</span>
<a href="#l38.679"></a><span id="l38.679">   },</span>
<a href="#l38.680"></a><span id="l38.680">   _conversation: null,</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineminus">-  get conversation() { return this._conversation; },</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineplus">+  get conversation() {</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineplus">+    return this._conversation;</span>
<a href="#l38.684"></a><span id="l38.684" class="difflineplus">+  },</span>
<a href="#l38.685"></a><span id="l38.685">   set conversation(aConv) {</span>
<a href="#l38.686"></a><span id="l38.686">     this._conversation = aConv;</span>
<a href="#l38.687"></a><span id="l38.687">     aConv.notifyObservers(this, &quot;new-text&quot;);</span>
<a href="#l38.688"></a><span id="l38.688">   },</span>
<a href="#l38.689"></a><span id="l38.689"> </span>
<a href="#l38.690"></a><span id="l38.690">   outgoing: false,</span>
<a href="#l38.691"></a><span id="l38.691">   incoming: false,</span>
<a href="#l38.692"></a><span id="l38.692">   system: false,</span>
<a href="#l38.693"></a><span id="l38.693" class="difflineat">@@ -427,56 +590,70 @@ var GenericMessagePrototype = {</span>
<a href="#l38.694"></a><span id="l38.694">   error: false,</span>
<a href="#l38.695"></a><span id="l38.695">   delayed: false,</span>
<a href="#l38.696"></a><span id="l38.696">   noFormat: false,</span>
<a href="#l38.697"></a><span id="l38.697">   containsImages: false,</span>
<a href="#l38.698"></a><span id="l38.698">   notification: false,</span>
<a href="#l38.699"></a><span id="l38.699">   noLinkification: false,</span>
<a href="#l38.700"></a><span id="l38.700"> </span>
<a href="#l38.701"></a><span id="l38.701">   getActions(aCount) {</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineminus">-    if (aCount)</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineplus">+    if (aCount) {</span>
<a href="#l38.704"></a><span id="l38.704">       aCount.value = 0;</span>
<a href="#l38.705"></a><span id="l38.705" class="difflineplus">+    }</span>
<a href="#l38.706"></a><span id="l38.706">     return [];</span>
<a href="#l38.707"></a><span id="l38.707">   },</span>
<a href="#l38.708"></a><span id="l38.708"> };</span>
<a href="#l38.709"></a><span id="l38.709"> </span>
<a href="#l38.710"></a><span id="l38.710"> function Message(aWho, aMessage, aObject) {</span>
<a href="#l38.711"></a><span id="l38.711">   this._init(aWho, aMessage, aObject);</span>
<a href="#l38.712"></a><span id="l38.712"> }</span>
<a href="#l38.713"></a><span id="l38.713"> Message.prototype = GenericMessagePrototype;</span>
<a href="#l38.714"></a><span id="l38.714"> </span>
<a href="#l38.715"></a><span id="l38.715" class="difflineminus">-</span>
<a href="#l38.716"></a><span id="l38.716"> var GenericConversationPrototype = {</span>
<a href="#l38.717"></a><span id="l38.717">   __proto__: ClassInfo(&quot;prplIConversation&quot;, &quot;generic conversation object&quot;),</span>
<a href="#l38.718"></a><span id="l38.718" class="difflineminus">-  get wrappedJSObject() { return this; },</span>
<a href="#l38.719"></a><span id="l38.719" class="difflineplus">+  get wrappedJSObject() {</span>
<a href="#l38.720"></a><span id="l38.720" class="difflineplus">+    return this;</span>
<a href="#l38.721"></a><span id="l38.721" class="difflineplus">+  },</span>
<a href="#l38.722"></a><span id="l38.722"> </span>
<a href="#l38.723"></a><span id="l38.723" class="difflineminus">-  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l38.724"></a><span id="l38.724" class="difflineminus">-  get LOG() { return this._account.LOG; },</span>
<a href="#l38.725"></a><span id="l38.725" class="difflineminus">-  get WARN() { return this._account.WARN; },</span>
<a href="#l38.726"></a><span id="l38.726" class="difflineminus">-  get ERROR() { return this._account.ERROR; },</span>
<a href="#l38.727"></a><span id="l38.727" class="difflineplus">+  get DEBUG() {</span>
<a href="#l38.728"></a><span id="l38.728" class="difflineplus">+    return this._account.DEBUG;</span>
<a href="#l38.729"></a><span id="l38.729" class="difflineplus">+  },</span>
<a href="#l38.730"></a><span id="l38.730" class="difflineplus">+  get LOG() {</span>
<a href="#l38.731"></a><span id="l38.731" class="difflineplus">+    return this._account.LOG;</span>
<a href="#l38.732"></a><span id="l38.732" class="difflineplus">+  },</span>
<a href="#l38.733"></a><span id="l38.733" class="difflineplus">+  get WARN() {</span>
<a href="#l38.734"></a><span id="l38.734" class="difflineplus">+    return this._account.WARN;</span>
<a href="#l38.735"></a><span id="l38.735" class="difflineplus">+  },</span>
<a href="#l38.736"></a><span id="l38.736" class="difflineplus">+  get ERROR() {</span>
<a href="#l38.737"></a><span id="l38.737" class="difflineplus">+    return this._account.ERROR;</span>
<a href="#l38.738"></a><span id="l38.738" class="difflineplus">+  },</span>
<a href="#l38.739"></a><span id="l38.739"> </span>
<a href="#l38.740"></a><span id="l38.740">   _init(aAccount, aName) {</span>
<a href="#l38.741"></a><span id="l38.741">     this._account = aAccount;</span>
<a href="#l38.742"></a><span id="l38.742">     this._name = aName;</span>
<a href="#l38.743"></a><span id="l38.743">     this._observers = [];</span>
<a href="#l38.744"></a><span id="l38.744">     this._date = new Date() * 1000;</span>
<a href="#l38.745"></a><span id="l38.745">     Services.conversations.addConversation(this);</span>
<a href="#l38.746"></a><span id="l38.746">   },</span>
<a href="#l38.747"></a><span id="l38.747"> </span>
<a href="#l38.748"></a><span id="l38.748">   _id: 0,</span>
<a href="#l38.749"></a><span id="l38.749" class="difflineminus">-  get id() { return this._id; },</span>
<a href="#l38.750"></a><span id="l38.750" class="difflineplus">+  get id() {</span>
<a href="#l38.751"></a><span id="l38.751" class="difflineplus">+    return this._id;</span>
<a href="#l38.752"></a><span id="l38.752" class="difflineplus">+  },</span>
<a href="#l38.753"></a><span id="l38.753">   set id(aId) {</span>
<a href="#l38.754"></a><span id="l38.754" class="difflineminus">-    if (this._id)</span>
<a href="#l38.755"></a><span id="l38.755" class="difflineplus">+    if (this._id) {</span>
<a href="#l38.756"></a><span id="l38.756">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l38.757"></a><span id="l38.757" class="difflineplus">+    }</span>
<a href="#l38.758"></a><span id="l38.758">     this._id = aId;</span>
<a href="#l38.759"></a><span id="l38.759">   },</span>
<a href="#l38.760"></a><span id="l38.760"> </span>
<a href="#l38.761"></a><span id="l38.761">   addObserver(aObserver) {</span>
<a href="#l38.762"></a><span id="l38.762" class="difflineminus">-    if (!this._observers.includes(aObserver))</span>
<a href="#l38.763"></a><span id="l38.763" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l38.764"></a><span id="l38.764">       this._observers.push(aObserver);</span>
<a href="#l38.765"></a><span id="l38.765" class="difflineplus">+    }</span>
<a href="#l38.766"></a><span id="l38.766">   },</span>
<a href="#l38.767"></a><span id="l38.767">   removeObserver(aObserver) {</span>
<a href="#l38.768"></a><span id="l38.768">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l38.769"></a><span id="l38.769">   },</span>
<a href="#l38.770"></a><span id="l38.770">   notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l38.771"></a><span id="l38.771">     for (let observer of this._observers) {</span>
<a href="#l38.772"></a><span id="l38.772">       try {</span>
<a href="#l38.773"></a><span id="l38.773">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l38.774"></a><span id="l38.774" class="difflineat">@@ -484,18 +661,22 @@ var GenericConversationPrototype = {</span>
<a href="#l38.775"></a><span id="l38.775">         this.ERROR(e);</span>
<a href="#l38.776"></a><span id="l38.776">       }</span>
<a href="#l38.777"></a><span id="l38.777">     }</span>
<a href="#l38.778"></a><span id="l38.778">   },</span>
<a href="#l38.779"></a><span id="l38.779"> </span>
<a href="#l38.780"></a><span id="l38.780">   prepareForSending: (aOutgoingMessage, aCount) =&gt; null,</span>
<a href="#l38.781"></a><span id="l38.781">   prepareForDisplaying(aImMessage) {</span>
<a href="#l38.782"></a><span id="l38.782">     if (aImMessage.displayMessage !== aImMessage.message) {</span>
<a href="#l38.783"></a><span id="l38.783" class="difflineminus">-      this.DEBUG(&quot;Preparing:\n&quot; + aImMessage.message + &quot;\nDisplaying:\n&quot; +</span>
<a href="#l38.784"></a><span id="l38.784" class="difflineminus">-                 aImMessage.displayMessage);</span>
<a href="#l38.785"></a><span id="l38.785" class="difflineplus">+      this.DEBUG(</span>
<a href="#l38.786"></a><span id="l38.786" class="difflineplus">+        &quot;Preparing:\n&quot; +</span>
<a href="#l38.787"></a><span id="l38.787" class="difflineplus">+          aImMessage.message +</span>
<a href="#l38.788"></a><span id="l38.788" class="difflineplus">+          &quot;\nDisplaying:\n&quot; +</span>
<a href="#l38.789"></a><span id="l38.789" class="difflineplus">+          aImMessage.displayMessage</span>
<a href="#l38.790"></a><span id="l38.790" class="difflineplus">+      );</span>
<a href="#l38.791"></a><span id="l38.791">     }</span>
<a href="#l38.792"></a><span id="l38.792">   },</span>
<a href="#l38.793"></a><span id="l38.793">   sendMsg(aMsg) {</span>
<a href="#l38.794"></a><span id="l38.794">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.795"></a><span id="l38.795">   },</span>
<a href="#l38.796"></a><span id="l38.796">   sendTyping: aString =&gt; Ci.prplIConversation.NO_TYPING_LIMIT,</span>
<a href="#l38.797"></a><span id="l38.797"> </span>
<a href="#l38.798"></a><span id="l38.798">   close() {</span>
<a href="#l38.799"></a><span id="l38.799" class="difflineat">@@ -503,242 +684,298 @@ var GenericConversationPrototype = {</span>
<a href="#l38.800"></a><span id="l38.800">     Services.conversations.removeConversation(this);</span>
<a href="#l38.801"></a><span id="l38.801">   },</span>
<a href="#l38.802"></a><span id="l38.802">   unInit() {</span>
<a href="#l38.803"></a><span id="l38.803">     delete this._account;</span>
<a href="#l38.804"></a><span id="l38.804">     delete this._observers;</span>
<a href="#l38.805"></a><span id="l38.805">   },</span>
<a href="#l38.806"></a><span id="l38.806"> </span>
<a href="#l38.807"></a><span id="l38.807">   writeMessage(aWho, aText, aProperties) {</span>
<a href="#l38.808"></a><span id="l38.808" class="difflineminus">-    (new Message(aWho, aText, aProperties)).conversation = this;</span>
<a href="#l38.809"></a><span id="l38.809" class="difflineplus">+    new Message(aWho, aText, aProperties).conversation = this;</span>
<a href="#l38.810"></a><span id="l38.810">   },</span>
<a href="#l38.811"></a><span id="l38.811"> </span>
<a href="#l38.812"></a><span id="l38.812" class="difflineminus">-  get account() { return this._account.imAccount; },</span>
<a href="#l38.813"></a><span id="l38.813" class="difflineminus">-  get name() { return this._name; },</span>
<a href="#l38.814"></a><span id="l38.814" class="difflineminus">-  get normalizedName() { return this._account.normalize(this.name); },</span>
<a href="#l38.815"></a><span id="l38.815" class="difflineminus">-  get title() { return this.name; },</span>
<a href="#l38.816"></a><span id="l38.816" class="difflineminus">-  get startDate() { return this._date; },</span>
<a href="#l38.817"></a><span id="l38.817" class="difflineplus">+  get account() {</span>
<a href="#l38.818"></a><span id="l38.818" class="difflineplus">+    return this._account.imAccount;</span>
<a href="#l38.819"></a><span id="l38.819" class="difflineplus">+  },</span>
<a href="#l38.820"></a><span id="l38.820" class="difflineplus">+  get name() {</span>
<a href="#l38.821"></a><span id="l38.821" class="difflineplus">+    return this._name;</span>
<a href="#l38.822"></a><span id="l38.822" class="difflineplus">+  },</span>
<a href="#l38.823"></a><span id="l38.823" class="difflineplus">+  get normalizedName() {</span>
<a href="#l38.824"></a><span id="l38.824" class="difflineplus">+    return this._account.normalize(this.name);</span>
<a href="#l38.825"></a><span id="l38.825" class="difflineplus">+  },</span>
<a href="#l38.826"></a><span id="l38.826" class="difflineplus">+  get title() {</span>
<a href="#l38.827"></a><span id="l38.827" class="difflineplus">+    return this.name;</span>
<a href="#l38.828"></a><span id="l38.828" class="difflineplus">+  },</span>
<a href="#l38.829"></a><span id="l38.829" class="difflineplus">+  get startDate() {</span>
<a href="#l38.830"></a><span id="l38.830" class="difflineplus">+    return this._date;</span>
<a href="#l38.831"></a><span id="l38.831" class="difflineplus">+  },</span>
<a href="#l38.832"></a><span id="l38.832"> };</span>
<a href="#l38.833"></a><span id="l38.833"> </span>
<a href="#l38.834"></a><span id="l38.834"> var GenericConvIMPrototype = {</span>
<a href="#l38.835"></a><span id="l38.835">   __proto__: GenericConversationPrototype,</span>
<a href="#l38.836"></a><span id="l38.836">   _interfaces: [Ci.prplIConversation, Ci.prplIConvIM],</span>
<a href="#l38.837"></a><span id="l38.837">   classDescription: &quot;generic ConvIM object&quot;,</span>
<a href="#l38.838"></a><span id="l38.838"> </span>
<a href="#l38.839"></a><span id="l38.839">   updateTyping(aState, aName) {</span>
<a href="#l38.840"></a><span id="l38.840" class="difflineminus">-    if (aState == this.typingState)</span>
<a href="#l38.841"></a><span id="l38.841" class="difflineplus">+    if (aState == this.typingState) {</span>
<a href="#l38.842"></a><span id="l38.842">       return;</span>
<a href="#l38.843"></a><span id="l38.843" class="difflineplus">+    }</span>
<a href="#l38.844"></a><span id="l38.844"> </span>
<a href="#l38.845"></a><span id="l38.845" class="difflineminus">-    if (aState == Ci.prplIConvIM.NOT_TYPING)</span>
<a href="#l38.846"></a><span id="l38.846" class="difflineplus">+    if (aState == Ci.prplIConvIM.NOT_TYPING) {</span>
<a href="#l38.847"></a><span id="l38.847">       delete this.typingState;</span>
<a href="#l38.848"></a><span id="l38.848" class="difflineminus">-    else</span>
<a href="#l38.849"></a><span id="l38.849" class="difflineplus">+    } else {</span>
<a href="#l38.850"></a><span id="l38.850">       this.typingState = aState;</span>
<a href="#l38.851"></a><span id="l38.851" class="difflineplus">+    }</span>
<a href="#l38.852"></a><span id="l38.852">     this.notifyObservers(null, &quot;update-typing&quot;, aName);</span>
<a href="#l38.853"></a><span id="l38.853">   },</span>
<a href="#l38.854"></a><span id="l38.854"> </span>
<a href="#l38.855"></a><span id="l38.855" class="difflineminus">-  get isChat() { return false; },</span>
<a href="#l38.856"></a><span id="l38.856" class="difflineplus">+  get isChat() {</span>
<a href="#l38.857"></a><span id="l38.857" class="difflineplus">+    return false;</span>
<a href="#l38.858"></a><span id="l38.858" class="difflineplus">+  },</span>
<a href="#l38.859"></a><span id="l38.859">   buddy: null,</span>
<a href="#l38.860"></a><span id="l38.860">   typingState: Ci.prplIConvIM.NOT_TYPING,</span>
<a href="#l38.861"></a><span id="l38.861"> };</span>
<a href="#l38.862"></a><span id="l38.862"> </span>
<a href="#l38.863"></a><span id="l38.863"> var GenericConvChatPrototype = {</span>
<a href="#l38.864"></a><span id="l38.864">   __proto__: GenericConversationPrototype,</span>
<a href="#l38.865"></a><span id="l38.865">   _interfaces: [Ci.prplIConversation, Ci.prplIConvChat],</span>
<a href="#l38.866"></a><span id="l38.866">   classDescription: &quot;generic ConvChat object&quot;,</span>
<a href="#l38.867"></a><span id="l38.867"> </span>
<a href="#l38.868"></a><span id="l38.868">   _init(aAccount, aName, aNick) {</span>
<a href="#l38.869"></a><span id="l38.869">     this._participants = new Map();</span>
<a href="#l38.870"></a><span id="l38.870">     this.nick = aNick;</span>
<a href="#l38.871"></a><span id="l38.871">     GenericConversationPrototype._init.call(this, aAccount, aName);</span>
<a href="#l38.872"></a><span id="l38.872">   },</span>
<a href="#l38.873"></a><span id="l38.873"> </span>
<a href="#l38.874"></a><span id="l38.874" class="difflineminus">-  get isChat() { return true; },</span>
<a href="#l38.875"></a><span id="l38.875" class="difflineplus">+  get isChat() {</span>
<a href="#l38.876"></a><span id="l38.876" class="difflineplus">+    return true;</span>
<a href="#l38.877"></a><span id="l38.877" class="difflineplus">+  },</span>
<a href="#l38.878"></a><span id="l38.878"> </span>
<a href="#l38.879"></a><span id="l38.879">   // Stores the prplIChatRoomFieldValues required to join this channel</span>
<a href="#l38.880"></a><span id="l38.880">   // to enable later reconnections. If null, the MUC will not be reconnected</span>
<a href="#l38.881"></a><span id="l38.881">   // automatically after disconnections.</span>
<a href="#l38.882"></a><span id="l38.882">   chatRoomFields: null,</span>
<a href="#l38.883"></a><span id="l38.883"> </span>
<a href="#l38.884"></a><span id="l38.884">   _topic: &quot;&quot;,</span>
<a href="#l38.885"></a><span id="l38.885">   _topicSetter: null,</span>
<a href="#l38.886"></a><span id="l38.886" class="difflineminus">-  get topic() { return this._topic; },</span>
<a href="#l38.887"></a><span id="l38.887" class="difflineminus">-  get topicSettable() { return false; },</span>
<a href="#l38.888"></a><span id="l38.888" class="difflineminus">-  get topicSetter() { return this._topicSetter; },</span>
<a href="#l38.889"></a><span id="l38.889" class="difflineplus">+  get topic() {</span>
<a href="#l38.890"></a><span id="l38.890" class="difflineplus">+    return this._topic;</span>
<a href="#l38.891"></a><span id="l38.891" class="difflineplus">+  },</span>
<a href="#l38.892"></a><span id="l38.892" class="difflineplus">+  get topicSettable() {</span>
<a href="#l38.893"></a><span id="l38.893" class="difflineplus">+    return false;</span>
<a href="#l38.894"></a><span id="l38.894" class="difflineplus">+  },</span>
<a href="#l38.895"></a><span id="l38.895" class="difflineplus">+  get topicSetter() {</span>
<a href="#l38.896"></a><span id="l38.896" class="difflineplus">+    return this._topicSetter;</span>
<a href="#l38.897"></a><span id="l38.897" class="difflineplus">+  },</span>
<a href="#l38.898"></a><span id="l38.898">   setTopic(aTopic, aTopicSetter, aQuiet) {</span>
<a href="#l38.899"></a><span id="l38.899">     // Only change the topic if the topic and/or topic setter has changed.</span>
<a href="#l38.900"></a><span id="l38.900" class="difflineminus">-    if (this._topic == aTopic &amp;&amp;</span>
<a href="#l38.901"></a><span id="l38.901" class="difflineminus">-        (!this._topicSetter || this._topicSetter == aTopicSetter))</span>
<a href="#l38.902"></a><span id="l38.902" class="difflineplus">+    if (</span>
<a href="#l38.903"></a><span id="l38.903" class="difflineplus">+      this._topic == aTopic &amp;&amp;</span>
<a href="#l38.904"></a><span id="l38.904" class="difflineplus">+      (!this._topicSetter || this._topicSetter == aTopicSetter)</span>
<a href="#l38.905"></a><span id="l38.905" class="difflineplus">+    ) {</span>
<a href="#l38.906"></a><span id="l38.906">       return;</span>
<a href="#l38.907"></a><span id="l38.907" class="difflineplus">+    }</span>
<a href="#l38.908"></a><span id="l38.908"> </span>
<a href="#l38.909"></a><span id="l38.909">     this._topic = aTopic;</span>
<a href="#l38.910"></a><span id="l38.910">     this._topicSetter = aTopicSetter;</span>
<a href="#l38.911"></a><span id="l38.911"> </span>
<a href="#l38.912"></a><span id="l38.912">     this.notifyObservers(null, &quot;chat-update-topic&quot;);</span>
<a href="#l38.913"></a><span id="l38.913"> </span>
<a href="#l38.914"></a><span id="l38.914" class="difflineminus">-    if (aQuiet)</span>
<a href="#l38.915"></a><span id="l38.915" class="difflineplus">+    if (aQuiet) {</span>
<a href="#l38.916"></a><span id="l38.916">       return;</span>
<a href="#l38.917"></a><span id="l38.917" class="difflineplus">+    }</span>
<a href="#l38.918"></a><span id="l38.918"> </span>
<a href="#l38.919"></a><span id="l38.919">     // Send the topic as a message.</span>
<a href="#l38.920"></a><span id="l38.920">     let message;</span>
<a href="#l38.921"></a><span id="l38.921">     if (aTopicSetter) {</span>
<a href="#l38.922"></a><span id="l38.922" class="difflineminus">-      if (aTopic)</span>
<a href="#l38.923"></a><span id="l38.923" class="difflineplus">+      if (aTopic) {</span>
<a href="#l38.924"></a><span id="l38.924">         message = _(&quot;topicChanged&quot;, aTopicSetter, aTopic);</span>
<a href="#l38.925"></a><span id="l38.925" class="difflineminus">-      else</span>
<a href="#l38.926"></a><span id="l38.926" class="difflineplus">+      } else {</span>
<a href="#l38.927"></a><span id="l38.927">         message = _(&quot;topicCleared&quot;, aTopicSetter);</span>
<a href="#l38.928"></a><span id="l38.928" class="difflineminus">-    }</span>
<a href="#l38.929"></a><span id="l38.929" class="difflineminus">-    else {</span>
<a href="#l38.930"></a><span id="l38.930" class="difflineplus">+      }</span>
<a href="#l38.931"></a><span id="l38.931" class="difflineplus">+    } else {</span>
<a href="#l38.932"></a><span id="l38.932">       aTopicSetter = null;</span>
<a href="#l38.933"></a><span id="l38.933" class="difflineminus">-      if (aTopic)</span>
<a href="#l38.934"></a><span id="l38.934" class="difflineplus">+      if (aTopic) {</span>
<a href="#l38.935"></a><span id="l38.935">         message = _(&quot;topicSet&quot;, this.name, aTopic);</span>
<a href="#l38.936"></a><span id="l38.936" class="difflineminus">-      else</span>
<a href="#l38.937"></a><span id="l38.937" class="difflineplus">+      } else {</span>
<a href="#l38.938"></a><span id="l38.938">         message = _(&quot;topicNotSet&quot;, this.name);</span>
<a href="#l38.939"></a><span id="l38.939" class="difflineplus">+      }</span>
<a href="#l38.940"></a><span id="l38.940">     }</span>
<a href="#l38.941"></a><span id="l38.941" class="difflineminus">-    this.writeMessage(aTopicSetter, message, {system: true});</span>
<a href="#l38.942"></a><span id="l38.942" class="difflineplus">+    this.writeMessage(aTopicSetter, message, { system: true });</span>
<a href="#l38.943"></a><span id="l38.943">   },</span>
<a href="#l38.944"></a><span id="l38.944"> </span>
<a href="#l38.945"></a><span id="l38.945" class="difflineminus">-  get nick() { return this._nick; },</span>
<a href="#l38.946"></a><span id="l38.946" class="difflineplus">+  get nick() {</span>
<a href="#l38.947"></a><span id="l38.947" class="difflineplus">+    return this._nick;</span>
<a href="#l38.948"></a><span id="l38.948" class="difflineplus">+  },</span>
<a href="#l38.949"></a><span id="l38.949">   set nick(aNick) {</span>
<a href="#l38.950"></a><span id="l38.950">     this._nick = aNick;</span>
<a href="#l38.951"></a><span id="l38.951">     let escapedNick = this._nick.replace(/[[\]{}()*+?.\\^$|]/g, &quot;\\$&amp;&quot;);</span>
<a href="#l38.952"></a><span id="l38.952">     this._pingRegexp = new RegExp(&quot;(?:^|\\W)&quot; + escapedNick + &quot;(?:\\W|$)&quot;, &quot;i&quot;);</span>
<a href="#l38.953"></a><span id="l38.953">   },</span>
<a href="#l38.954"></a><span id="l38.954"> </span>
<a href="#l38.955"></a><span id="l38.955">   _left: false,</span>
<a href="#l38.956"></a><span id="l38.956" class="difflineminus">-  get left() { return this._left; },</span>
<a href="#l38.957"></a><span id="l38.957" class="difflineplus">+  get left() {</span>
<a href="#l38.958"></a><span id="l38.958" class="difflineplus">+    return this._left;</span>
<a href="#l38.959"></a><span id="l38.959" class="difflineplus">+  },</span>
<a href="#l38.960"></a><span id="l38.960">   set left(aLeft) {</span>
<a href="#l38.961"></a><span id="l38.961" class="difflineminus">-    if (aLeft == this._left)</span>
<a href="#l38.962"></a><span id="l38.962" class="difflineplus">+    if (aLeft == this._left) {</span>
<a href="#l38.963"></a><span id="l38.963">       return;</span>
<a href="#l38.964"></a><span id="l38.964" class="difflineplus">+    }</span>
<a href="#l38.965"></a><span id="l38.965">     this._left = aLeft;</span>
<a href="#l38.966"></a><span id="l38.966">     this.notifyObservers(null, &quot;update-conv-chatleft&quot;);</span>
<a href="#l38.967"></a><span id="l38.967">   },</span>
<a href="#l38.968"></a><span id="l38.968"> </span>
<a href="#l38.969"></a><span id="l38.969">   _joining: false,</span>
<a href="#l38.970"></a><span id="l38.970" class="difflineminus">-  get joining() { return this._joining; },</span>
<a href="#l38.971"></a><span id="l38.971" class="difflineplus">+  get joining() {</span>
<a href="#l38.972"></a><span id="l38.972" class="difflineplus">+    return this._joining;</span>
<a href="#l38.973"></a><span id="l38.973" class="difflineplus">+  },</span>
<a href="#l38.974"></a><span id="l38.974">   set joining(aJoining) {</span>
<a href="#l38.975"></a><span id="l38.975" class="difflineminus">-    if (aJoining == this._joining)</span>
<a href="#l38.976"></a><span id="l38.976" class="difflineplus">+    if (aJoining == this._joining) {</span>
<a href="#l38.977"></a><span id="l38.977">       return;</span>
<a href="#l38.978"></a><span id="l38.978" class="difflineplus">+    }</span>
<a href="#l38.979"></a><span id="l38.979">     this._joining = aJoining;</span>
<a href="#l38.980"></a><span id="l38.980">     this.notifyObservers(null, &quot;update-conv-chatjoining&quot;);</span>
<a href="#l38.981"></a><span id="l38.981">   },</span>
<a href="#l38.982"></a><span id="l38.982"> </span>
<a href="#l38.983"></a><span id="l38.983">   getParticipant(aName) {</span>
<a href="#l38.984"></a><span id="l38.984">     return this._participants.has(aName) ? this._participants.get(aName) : null;</span>
<a href="#l38.985"></a><span id="l38.985">   },</span>
<a href="#l38.986"></a><span id="l38.986">   getParticipants() {</span>
<a href="#l38.987"></a><span id="l38.987">     // Convert the values of the Map into a nsSimpleEnumerator.</span>
<a href="#l38.988"></a><span id="l38.988" class="difflineminus">-    return new nsSimpleEnumerator(</span>
<a href="#l38.989"></a><span id="l38.989" class="difflineminus">-      Array.from(this._participants.values())</span>
<a href="#l38.990"></a><span id="l38.990" class="difflineminus">-    );</span>
<a href="#l38.991"></a><span id="l38.991" class="difflineplus">+    return new nsSimpleEnumerator(Array.from(this._participants.values()));</span>
<a href="#l38.992"></a><span id="l38.992">   },</span>
<a href="#l38.993"></a><span id="l38.993">   getNormalizedChatBuddyName: aChatBuddyName =&gt; aChatBuddyName,</span>
<a href="#l38.994"></a><span id="l38.994"> </span>
<a href="#l38.995"></a><span id="l38.995">   // Updates the nick of a participant in conversation to a new one.</span>
<a href="#l38.996"></a><span id="l38.996">   updateNick(aOldNick, aNewNick, isOwnNick) {</span>
<a href="#l38.997"></a><span id="l38.997">     let message;</span>
<a href="#l38.998"></a><span id="l38.998">     let isParticipant = this._participants.has(aOldNick);</span>
<a href="#l38.999"></a><span id="l38.999">     if (isOwnNick) {</span>
<a href="#l38.1000"></a><span id="l38.1000">       // If this is the user's nick, change it.</span>
<a href="#l38.1001"></a><span id="l38.1001">       this.nick = aNewNick;</span>
<a href="#l38.1002"></a><span id="l38.1002">       message = _(&quot;nickSet.you&quot;, aNewNick);</span>
<a href="#l38.1003"></a><span id="l38.1003"> </span>
<a href="#l38.1004"></a><span id="l38.1004">       // If the account was disconnected, it's OK the user is not a participant.</span>
<a href="#l38.1005"></a><span id="l38.1005" class="difflineminus">-      if (!isParticipant)</span>
<a href="#l38.1006"></a><span id="l38.1006" class="difflineplus">+      if (!isParticipant) {</span>
<a href="#l38.1007"></a><span id="l38.1007">         return;</span>
<a href="#l38.1008"></a><span id="l38.1008" class="difflineplus">+      }</span>
<a href="#l38.1009"></a><span id="l38.1009" class="difflineplus">+    } else if (!isParticipant) {</span>
<a href="#l38.1010"></a><span id="l38.1010" class="difflineplus">+      this.ERROR(</span>
<a href="#l38.1011"></a><span id="l38.1011" class="difflineplus">+        &quot;Trying to rename nick that doesn't exist! &quot; +</span>
<a href="#l38.1012"></a><span id="l38.1012" class="difflineplus">+          aOldNick +</span>
<a href="#l38.1013"></a><span id="l38.1013" class="difflineplus">+          &quot; to &quot; +</span>
<a href="#l38.1014"></a><span id="l38.1014" class="difflineplus">+          aNewNick</span>
<a href="#l38.1015"></a><span id="l38.1015" class="difflineplus">+      );</span>
<a href="#l38.1016"></a><span id="l38.1016" class="difflineplus">+      return;</span>
<a href="#l38.1017"></a><span id="l38.1017" class="difflineplus">+    } else {</span>
<a href="#l38.1018"></a><span id="l38.1018" class="difflineplus">+      message = _(&quot;nickSet&quot;, aOldNick, aNewNick);</span>
<a href="#l38.1019"></a><span id="l38.1019">     }</span>
<a href="#l38.1020"></a><span id="l38.1020" class="difflineminus">-    else if (!isParticipant) {</span>
<a href="#l38.1021"></a><span id="l38.1021" class="difflineminus">-      this.ERROR(&quot;Trying to rename nick that doesn't exist! &quot; + aOldNick +</span>
<a href="#l38.1022"></a><span id="l38.1022" class="difflineminus">-                 &quot; to &quot; + aNewNick);</span>
<a href="#l38.1023"></a><span id="l38.1023" class="difflineminus">-      return;</span>
<a href="#l38.1024"></a><span id="l38.1024" class="difflineminus">-    }</span>
<a href="#l38.1025"></a><span id="l38.1025" class="difflineminus">-    else</span>
<a href="#l38.1026"></a><span id="l38.1026" class="difflineminus">-      message = _(&quot;nickSet&quot;, aOldNick, aNewNick);</span>
<a href="#l38.1027"></a><span id="l38.1027"> </span>
<a href="#l38.1028"></a><span id="l38.1028">     // Get the original participant and then remove it.</span>
<a href="#l38.1029"></a><span id="l38.1029">     let participant = this._participants.get(aOldNick);</span>
<a href="#l38.1030"></a><span id="l38.1030">     this._participants.delete(aOldNick);</span>
<a href="#l38.1031"></a><span id="l38.1031"> </span>
<a href="#l38.1032"></a><span id="l38.1032">     // Update the nickname and add it under the new nick.</span>
<a href="#l38.1033"></a><span id="l38.1033">     participant.name = aNewNick;</span>
<a href="#l38.1034"></a><span id="l38.1034">     this._participants.set(aNewNick, participant);</span>
<a href="#l38.1035"></a><span id="l38.1035"> </span>
<a href="#l38.1036"></a><span id="l38.1036">     this.notifyObservers(participant, &quot;chat-buddy-update&quot;, aOldNick);</span>
<a href="#l38.1037"></a><span id="l38.1037" class="difflineminus">-    this.writeMessage(aOldNick, message, {system: true});</span>
<a href="#l38.1038"></a><span id="l38.1038" class="difflineplus">+    this.writeMessage(aOldNick, message, { system: true });</span>
<a href="#l38.1039"></a><span id="l38.1039">   },</span>
<a href="#l38.1040"></a><span id="l38.1040"> </span>
<a href="#l38.1041"></a><span id="l38.1041">   // Removes a participant from conversation.</span>
<a href="#l38.1042"></a><span id="l38.1042">   removeParticipant(aNick) {</span>
<a href="#l38.1043"></a><span id="l38.1043" class="difflineminus">-    if (!this._participants.has(aNick))</span>
<a href="#l38.1044"></a><span id="l38.1044" class="difflineplus">+    if (!this._participants.has(aNick)) {</span>
<a href="#l38.1045"></a><span id="l38.1045">       return;</span>
<a href="#l38.1046"></a><span id="l38.1046" class="difflineplus">+    }</span>
<a href="#l38.1047"></a><span id="l38.1047"> </span>
<a href="#l38.1048"></a><span id="l38.1048" class="difflineminus">-    let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l38.1049"></a><span id="l38.1049" class="difflineminus">-                           .createInstance(Ci.nsISupportsString);</span>
<a href="#l38.1050"></a><span id="l38.1050" class="difflineplus">+    let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;].createInstance(</span>
<a href="#l38.1051"></a><span id="l38.1051" class="difflineplus">+      Ci.nsISupportsString</span>
<a href="#l38.1052"></a><span id="l38.1052" class="difflineplus">+    );</span>
<a href="#l38.1053"></a><span id="l38.1053">     stringNickname.data = aNick;</span>
<a href="#l38.1054"></a><span id="l38.1054" class="difflineminus">-    this.notifyObservers(new nsSimpleEnumerator([stringNickname]),</span>
<a href="#l38.1055"></a><span id="l38.1055" class="difflineminus">-                         &quot;chat-buddy-remove&quot;);</span>
<a href="#l38.1056"></a><span id="l38.1056" class="difflineplus">+    this.notifyObservers(</span>
<a href="#l38.1057"></a><span id="l38.1057" class="difflineplus">+      new nsSimpleEnumerator([stringNickname]),</span>
<a href="#l38.1058"></a><span id="l38.1058" class="difflineplus">+      &quot;chat-buddy-remove&quot;</span>
<a href="#l38.1059"></a><span id="l38.1059" class="difflineplus">+    );</span>
<a href="#l38.1060"></a><span id="l38.1060">     this._participants.delete(aNick);</span>
<a href="#l38.1061"></a><span id="l38.1061">   },</span>
<a href="#l38.1062"></a><span id="l38.1062"> </span>
<a href="#l38.1063"></a><span id="l38.1063">   // Removes all participant in conversation.</span>
<a href="#l38.1064"></a><span id="l38.1064">   removeAllParticipants() {</span>
<a href="#l38.1065"></a><span id="l38.1065">     let stringNicknames = [];</span>
<a href="#l38.1066"></a><span id="l38.1066">     this._participants.forEach(function(aParticipant) {</span>
<a href="#l38.1067"></a><span id="l38.1067" class="difflineminus">-      let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l38.1068"></a><span id="l38.1068" class="difflineminus">-                              .createInstance(Ci.nsISupportsString);</span>
<a href="#l38.1069"></a><span id="l38.1069" class="difflineplus">+      let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;].createInstance(</span>
<a href="#l38.1070"></a><span id="l38.1070" class="difflineplus">+        Ci.nsISupportsString</span>
<a href="#l38.1071"></a><span id="l38.1071" class="difflineplus">+      );</span>
<a href="#l38.1072"></a><span id="l38.1072">       stringNickname.data = aParticipant.name;</span>
<a href="#l38.1073"></a><span id="l38.1073">       stringNicknames.push(stringNickname);</span>
<a href="#l38.1074"></a><span id="l38.1074">     });</span>
<a href="#l38.1075"></a><span id="l38.1075" class="difflineminus">-    this.notifyObservers(new nsSimpleEnumerator(stringNicknames),</span>
<a href="#l38.1076"></a><span id="l38.1076" class="difflineminus">-                         &quot;chat-buddy-remove&quot;);</span>
<a href="#l38.1077"></a><span id="l38.1077" class="difflineplus">+    this.notifyObservers(</span>
<a href="#l38.1078"></a><span id="l38.1078" class="difflineplus">+      new nsSimpleEnumerator(stringNicknames),</span>
<a href="#l38.1079"></a><span id="l38.1079" class="difflineplus">+      &quot;chat-buddy-remove&quot;</span>
<a href="#l38.1080"></a><span id="l38.1080" class="difflineplus">+    );</span>
<a href="#l38.1081"></a><span id="l38.1081">     this._participants.clear();</span>
<a href="#l38.1082"></a><span id="l38.1082">   },</span>
<a href="#l38.1083"></a><span id="l38.1083"> </span>
<a href="#l38.1084"></a><span id="l38.1084">   writeMessage(aWho, aText, aProperties) {</span>
<a href="#l38.1085"></a><span id="l38.1085">     aProperties.containsNick =</span>
<a href="#l38.1086"></a><span id="l38.1086">       &quot;incoming&quot; in aProperties &amp;&amp; this._pingRegexp.test(aText);</span>
<a href="#l38.1087"></a><span id="l38.1087">     GenericConversationPrototype.writeMessage.apply(this, arguments);</span>
<a href="#l38.1088"></a><span id="l38.1088">   },</span>
<a href="#l38.1089"></a><span id="l38.1089"> };</span>
<a href="#l38.1090"></a><span id="l38.1090"> </span>
<a href="#l38.1091"></a><span id="l38.1091"> var GenericConvChatBuddyPrototype = {</span>
<a href="#l38.1092"></a><span id="l38.1092">   __proto__: ClassInfo(&quot;prplIConvChatBuddy&quot;, &quot;generic ConvChatBuddy object&quot;),</span>
<a href="#l38.1093"></a><span id="l38.1093"> </span>
<a href="#l38.1094"></a><span id="l38.1094">   _name: &quot;&quot;,</span>
<a href="#l38.1095"></a><span id="l38.1095" class="difflineminus">-  get name() { return this._name; },</span>
<a href="#l38.1096"></a><span id="l38.1096" class="difflineminus">-  set name(aName) { this._name = aName; },</span>
<a href="#l38.1097"></a><span id="l38.1097" class="difflineplus">+  get name() {</span>
<a href="#l38.1098"></a><span id="l38.1098" class="difflineplus">+    return this._name;</span>
<a href="#l38.1099"></a><span id="l38.1099" class="difflineplus">+  },</span>
<a href="#l38.1100"></a><span id="l38.1100" class="difflineplus">+  set name(aName) {</span>
<a href="#l38.1101"></a><span id="l38.1101" class="difflineplus">+    this._name = aName;</span>
<a href="#l38.1102"></a><span id="l38.1102" class="difflineplus">+  },</span>
<a href="#l38.1103"></a><span id="l38.1103">   alias: &quot;&quot;,</span>
<a href="#l38.1104"></a><span id="l38.1104">   buddy: false,</span>
<a href="#l38.1105"></a><span id="l38.1105">   buddyIconFilename: &quot;&quot;,</span>
<a href="#l38.1106"></a><span id="l38.1106"> </span>
<a href="#l38.1107"></a><span id="l38.1107">   get noFlags() {</span>
<a href="#l38.1108"></a><span id="l38.1108" class="difflineminus">-    return !(this.voiced || this.halfOp || this.op ||</span>
<a href="#l38.1109"></a><span id="l38.1109" class="difflineminus">-             this.founder || this.typing);</span>
<a href="#l38.1110"></a><span id="l38.1110" class="difflineplus">+    return !(</span>
<a href="#l38.1111"></a><span id="l38.1111" class="difflineplus">+      this.voiced ||</span>
<a href="#l38.1112"></a><span id="l38.1112" class="difflineplus">+      this.halfOp ||</span>
<a href="#l38.1113"></a><span id="l38.1113" class="difflineplus">+      this.op ||</span>
<a href="#l38.1114"></a><span id="l38.1114" class="difflineplus">+      this.founder ||</span>
<a href="#l38.1115"></a><span id="l38.1115" class="difflineplus">+      this.typing</span>
<a href="#l38.1116"></a><span id="l38.1116" class="difflineplus">+    );</span>
<a href="#l38.1117"></a><span id="l38.1117">   },</span>
<a href="#l38.1118"></a><span id="l38.1118">   voiced: false,</span>
<a href="#l38.1119"></a><span id="l38.1119">   halfOp: false,</span>
<a href="#l38.1120"></a><span id="l38.1120">   op: false,</span>
<a href="#l38.1121"></a><span id="l38.1121">   founder: false,</span>
<a href="#l38.1122"></a><span id="l38.1122">   typing: false,</span>
<a href="#l38.1123"></a><span id="l38.1123"> };</span>
<a href="#l38.1124"></a><span id="l38.1124"> </span>
<a href="#l38.1125"></a><span id="l38.1125"> function TooltipInfo(aLabel, aValue, aType = Ci.prplITooltipInfo.pair) {</span>
<a href="#l38.1126"></a><span id="l38.1126">   this.type = aType;</span>
<a href="#l38.1127"></a><span id="l38.1127">   if (aType == Ci.prplITooltipInfo.status) {</span>
<a href="#l38.1128"></a><span id="l38.1128">     this.label = aLabel.toString();</span>
<a href="#l38.1129"></a><span id="l38.1129">     this.value = aValue || &quot;&quot;;</span>
<a href="#l38.1130"></a><span id="l38.1130" class="difflineminus">-  }</span>
<a href="#l38.1131"></a><span id="l38.1131" class="difflineminus">-  else if (aType == Ci.prplITooltipInfo.icon)</span>
<a href="#l38.1132"></a><span id="l38.1132" class="difflineplus">+  } else if (aType == Ci.prplITooltipInfo.icon) {</span>
<a href="#l38.1133"></a><span id="l38.1133">     this.value = aValue;</span>
<a href="#l38.1134"></a><span id="l38.1134" class="difflineminus">-  else if (aLabel === undefined || aType == Ci.prplITooltipInfo.sectionBreak)</span>
<a href="#l38.1135"></a><span id="l38.1135" class="difflineplus">+  } else if (</span>
<a href="#l38.1136"></a><span id="l38.1136" class="difflineplus">+    aLabel === undefined ||</span>
<a href="#l38.1137"></a><span id="l38.1137" class="difflineplus">+    aType == Ci.prplITooltipInfo.sectionBreak</span>
<a href="#l38.1138"></a><span id="l38.1138" class="difflineplus">+  ) {</span>
<a href="#l38.1139"></a><span id="l38.1139">     this.type = Ci.prplITooltipInfo.sectionBreak;</span>
<a href="#l38.1140"></a><span id="l38.1140" class="difflineminus">-  else {</span>
<a href="#l38.1141"></a><span id="l38.1141" class="difflineplus">+  } else {</span>
<a href="#l38.1142"></a><span id="l38.1142">     this.label = aLabel;</span>
<a href="#l38.1143"></a><span id="l38.1143" class="difflineminus">-    if (aValue === undefined)</span>
<a href="#l38.1144"></a><span id="l38.1144" class="difflineplus">+    if (aValue === undefined) {</span>
<a href="#l38.1145"></a><span id="l38.1145">       this.type = Ci.prplITooltipInfo.sectionHeader;</span>
<a href="#l38.1146"></a><span id="l38.1146" class="difflineminus">-    else</span>
<a href="#l38.1147"></a><span id="l38.1147" class="difflineplus">+    } else {</span>
<a href="#l38.1148"></a><span id="l38.1148">       this.value = aValue;</span>
<a href="#l38.1149"></a><span id="l38.1149" class="difflineplus">+    }</span>
<a href="#l38.1150"></a><span id="l38.1150">   }</span>
<a href="#l38.1151"></a><span id="l38.1151"> }</span>
<a href="#l38.1152"></a><span id="l38.1152"> TooltipInfo.prototype = ClassInfo(&quot;prplITooltipInfo&quot;, &quot;generic tooltip info&quot;);</span>
<a href="#l38.1153"></a><span id="l38.1153"> </span>
<a href="#l38.1154"></a><span id="l38.1154"> /* aOption is an object containing:</span>
<a href="#l38.1155"></a><span id="l38.1155">  *  - label: localized text to display (recommended: use a getter with _)</span>
<a href="#l38.1156"></a><span id="l38.1156">  *  - default: the default value for this option. The type of the</span>
<a href="#l38.1157"></a><span id="l38.1157">  *      option will be determined based on the type of the default value.</span>
<a href="#l38.1158"></a><span id="l38.1158" class="difflineat">@@ -751,173 +988,251 @@ TooltipInfo.prototype = ClassInfo(&quot;prplI</span>
<a href="#l38.1159"></a><span id="l38.1159">  *  - [optional] masked: boolean, if true the UI shouldn't display the value.</span>
<a href="#l38.1160"></a><span id="l38.1160">  *      This could typically be used for password field.</span>
<a href="#l38.1161"></a><span id="l38.1161">  *      Warning: The UI currently doesn't support this.</span>
<a href="#l38.1162"></a><span id="l38.1162">  */</span>
<a href="#l38.1163"></a><span id="l38.1163"> function purplePref(aName, aOption) {</span>
<a href="#l38.1164"></a><span id="l38.1164">   this.name = aName; // Preference name</span>
<a href="#l38.1165"></a><span id="l38.1165">   this.label = aOption.label; // Text to display</span>
<a href="#l38.1166"></a><span id="l38.1166"> </span>
<a href="#l38.1167"></a><span id="l38.1167" class="difflineminus">-  if (aOption.default === undefined || aOption.default === null)</span>
<a href="#l38.1168"></a><span id="l38.1168" class="difflineminus">-    throw new Error(&quot;A default value for the option is required to determine its type.&quot;);</span>
<a href="#l38.1169"></a><span id="l38.1169" class="difflineplus">+  if (aOption.default === undefined || aOption.default === null) {</span>
<a href="#l38.1170"></a><span id="l38.1170" class="difflineplus">+    throw new Error(</span>
<a href="#l38.1171"></a><span id="l38.1171" class="difflineplus">+      &quot;A default value for the option is required to determine its type.&quot;</span>
<a href="#l38.1172"></a><span id="l38.1172" class="difflineplus">+    );</span>
<a href="#l38.1173"></a><span id="l38.1173" class="difflineplus">+  }</span>
<a href="#l38.1174"></a><span id="l38.1174">   this._defaultValue = aOption.default;</span>
<a href="#l38.1175"></a><span id="l38.1175"> </span>
<a href="#l38.1176"></a><span id="l38.1176" class="difflineminus">-  const kTypes = {boolean: &quot;Bool&quot;, string: &quot;String&quot;, number: &quot;Int&quot;};</span>
<a href="#l38.1177"></a><span id="l38.1177" class="difflineplus">+  const kTypes = { boolean: &quot;Bool&quot;, string: &quot;String&quot;, number: &quot;Int&quot; };</span>
<a href="#l38.1178"></a><span id="l38.1178">   let type = kTypes[typeof aOption.default];</span>
<a href="#l38.1179"></a><span id="l38.1179" class="difflineminus">-  if (!type)</span>
<a href="#l38.1180"></a><span id="l38.1180" class="difflineplus">+  if (!type) {</span>
<a href="#l38.1181"></a><span id="l38.1181">     throw new Error(&quot;Invalid option type&quot;);</span>
<a href="#l38.1182"></a><span id="l38.1182" class="difflineplus">+  }</span>
<a href="#l38.1183"></a><span id="l38.1183"> </span>
<a href="#l38.1184"></a><span id="l38.1184" class="difflineminus">-  if (type == &quot;String&quot; &amp;&amp; (&quot;listValues&quot; in aOption)) {</span>
<a href="#l38.1185"></a><span id="l38.1185" class="difflineplus">+  if (type == &quot;String&quot; &amp;&amp; &quot;listValues&quot; in aOption) {</span>
<a href="#l38.1186"></a><span id="l38.1186">     type = &quot;List&quot;;</span>
<a href="#l38.1187"></a><span id="l38.1187">     this._listValues = aOption.listValues;</span>
<a href="#l38.1188"></a><span id="l38.1188">   }</span>
<a href="#l38.1189"></a><span id="l38.1189">   this.type = Ci.prplIPref[&quot;type&quot; + type];</span>
<a href="#l38.1190"></a><span id="l38.1190"> </span>
<a href="#l38.1191"></a><span id="l38.1191" class="difflineminus">-  if (&quot;masked&quot; in aOption &amp;&amp; aOption.masked)</span>
<a href="#l38.1192"></a><span id="l38.1192" class="difflineplus">+  if (&quot;masked&quot; in aOption &amp;&amp; aOption.masked) {</span>
<a href="#l38.1193"></a><span id="l38.1193">     this.masked = true;</span>
<a href="#l38.1194"></a><span id="l38.1194" class="difflineplus">+  }</span>
<a href="#l38.1195"></a><span id="l38.1195"> }</span>
<a href="#l38.1196"></a><span id="l38.1196"> purplePref.prototype = {</span>
<a href="#l38.1197"></a><span id="l38.1197">   __proto__: ClassInfo(&quot;prplIPref&quot;, &quot;generic account option preference&quot;),</span>
<a href="#l38.1198"></a><span id="l38.1198"> </span>
<a href="#l38.1199"></a><span id="l38.1199">   masked: false,</span>
<a href="#l38.1200"></a><span id="l38.1200"> </span>
<a href="#l38.1201"></a><span id="l38.1201">   // Default value</span>
<a href="#l38.1202"></a><span id="l38.1202" class="difflineminus">-  getBool() { return this._defaultValue; },</span>
<a href="#l38.1203"></a><span id="l38.1203" class="difflineminus">-  getInt() { return this._defaultValue; },</span>
<a href="#l38.1204"></a><span id="l38.1204" class="difflineminus">-  getString() { return this._defaultValue; },</span>
<a href="#l38.1205"></a><span id="l38.1205" class="difflineplus">+  getBool() {</span>
<a href="#l38.1206"></a><span id="l38.1206" class="difflineplus">+    return this._defaultValue;</span>
<a href="#l38.1207"></a><span id="l38.1207" class="difflineplus">+  },</span>
<a href="#l38.1208"></a><span id="l38.1208" class="difflineplus">+  getInt() {</span>
<a href="#l38.1209"></a><span id="l38.1209" class="difflineplus">+    return this._defaultValue;</span>
<a href="#l38.1210"></a><span id="l38.1210" class="difflineplus">+  },</span>
<a href="#l38.1211"></a><span id="l38.1211" class="difflineplus">+  getString() {</span>
<a href="#l38.1212"></a><span id="l38.1212" class="difflineplus">+    return this._defaultValue;</span>
<a href="#l38.1213"></a><span id="l38.1213" class="difflineplus">+  },</span>
<a href="#l38.1214"></a><span id="l38.1214">   getList() {</span>
<a href="#l38.1215"></a><span id="l38.1215">     // Convert a JavaScript object map {&quot;value 1&quot;: &quot;label 1&quot;, ...}</span>
<a href="#l38.1216"></a><span id="l38.1216">     let keys = Object.keys(this._listValues);</span>
<a href="#l38.1217"></a><span id="l38.1217" class="difflineminus">-    if (!keys.length)</span>
<a href="#l38.1218"></a><span id="l38.1218" class="difflineplus">+    if (!keys.length) {</span>
<a href="#l38.1219"></a><span id="l38.1219">       return EmptyEnumerator;</span>
<a href="#l38.1220"></a><span id="l38.1220" class="difflineplus">+    }</span>
<a href="#l38.1221"></a><span id="l38.1221"> </span>
<a href="#l38.1222"></a><span id="l38.1222">     return new nsSimpleEnumerator(</span>
<a href="#l38.1223"></a><span id="l38.1223">       keys.map(key =&gt; new purpleKeyValuePair(this._listValues[key], key))</span>
<a href="#l38.1224"></a><span id="l38.1224">     );</span>
<a href="#l38.1225"></a><span id="l38.1225">   },</span>
<a href="#l38.1226"></a><span id="l38.1226" class="difflineminus">-  getListDefault() { return this._defaultValue; },</span>
<a href="#l38.1227"></a><span id="l38.1227" class="difflineplus">+  getListDefault() {</span>
<a href="#l38.1228"></a><span id="l38.1228" class="difflineplus">+    return this._defaultValue;</span>
<a href="#l38.1229"></a><span id="l38.1229" class="difflineplus">+  },</span>
<a href="#l38.1230"></a><span id="l38.1230"> };</span>
<a href="#l38.1231"></a><span id="l38.1231"> </span>
<a href="#l38.1232"></a><span id="l38.1232"> function purpleKeyValuePair(aName, aValue) {</span>
<a href="#l38.1233"></a><span id="l38.1233">   this.name = aName;</span>
<a href="#l38.1234"></a><span id="l38.1234">   this.value = aValue;</span>
<a href="#l38.1235"></a><span id="l38.1235"> }</span>
<a href="#l38.1236"></a><span id="l38.1236" class="difflineminus">-purpleKeyValuePair.prototype =</span>
<a href="#l38.1237"></a><span id="l38.1237" class="difflineminus">-  ClassInfo(&quot;prplIKeyValuePair&quot;, &quot;generic Key Value Pair&quot;);</span>
<a href="#l38.1238"></a><span id="l38.1238" class="difflineplus">+purpleKeyValuePair.prototype = ClassInfo(</span>
<a href="#l38.1239"></a><span id="l38.1239" class="difflineplus">+  &quot;prplIKeyValuePair&quot;,</span>
<a href="#l38.1240"></a><span id="l38.1240" class="difflineplus">+  &quot;generic Key Value Pair&quot;</span>
<a href="#l38.1241"></a><span id="l38.1241" class="difflineplus">+);</span>
<a href="#l38.1242"></a><span id="l38.1242"> </span>
<a href="#l38.1243"></a><span id="l38.1243"> function UsernameSplit(aValues) {</span>
<a href="#l38.1244"></a><span id="l38.1244">   this._values = aValues;</span>
<a href="#l38.1245"></a><span id="l38.1245"> }</span>
<a href="#l38.1246"></a><span id="l38.1246"> UsernameSplit.prototype = {</span>
<a href="#l38.1247"></a><span id="l38.1247">   __proto__: ClassInfo(&quot;prplIUsernameSplit&quot;, &quot;username split object&quot;),</span>
<a href="#l38.1248"></a><span id="l38.1248"> </span>
<a href="#l38.1249"></a><span id="l38.1249" class="difflineminus">-  get label() { return this._values.label; },</span>
<a href="#l38.1250"></a><span id="l38.1250" class="difflineminus">-  get separator() { return this._values.separator; },</span>
<a href="#l38.1251"></a><span id="l38.1251" class="difflineminus">-  get defaultValue() { return this._values.defaultValue; },</span>
<a href="#l38.1252"></a><span id="l38.1252" class="difflineminus">-  get reverse() { return !!this._values.reverse; }, // Ensure boolean</span>
<a href="#l38.1253"></a><span id="l38.1253" class="difflineplus">+  get label() {</span>
<a href="#l38.1254"></a><span id="l38.1254" class="difflineplus">+    return this._values.label;</span>
<a href="#l38.1255"></a><span id="l38.1255" class="difflineplus">+  },</span>
<a href="#l38.1256"></a><span id="l38.1256" class="difflineplus">+  get separator() {</span>
<a href="#l38.1257"></a><span id="l38.1257" class="difflineplus">+    return this._values.separator;</span>
<a href="#l38.1258"></a><span id="l38.1258" class="difflineplus">+  },</span>
<a href="#l38.1259"></a><span id="l38.1259" class="difflineplus">+  get defaultValue() {</span>
<a href="#l38.1260"></a><span id="l38.1260" class="difflineplus">+    return this._values.defaultValue;</span>
<a href="#l38.1261"></a><span id="l38.1261" class="difflineplus">+  },</span>
<a href="#l38.1262"></a><span id="l38.1262" class="difflineplus">+  get reverse() {</span>
<a href="#l38.1263"></a><span id="l38.1263" class="difflineplus">+    return !!this._values.reverse;</span>
<a href="#l38.1264"></a><span id="l38.1264" class="difflineplus">+  }, // Ensure boolean</span>
<a href="#l38.1265"></a><span id="l38.1265"> };</span>
<a href="#l38.1266"></a><span id="l38.1266"> </span>
<a href="#l38.1267"></a><span id="l38.1267"> function ChatRoomField(aIdentifier, aField) {</span>
<a href="#l38.1268"></a><span id="l38.1268">   this.identifier = aIdentifier;</span>
<a href="#l38.1269"></a><span id="l38.1269">   this.label = aField.label;</span>
<a href="#l38.1270"></a><span id="l38.1270">   this.required = !!aField.required;</span>
<a href="#l38.1271"></a><span id="l38.1271"> </span>
<a href="#l38.1272"></a><span id="l38.1272">   let type = &quot;TEXT&quot;;</span>
<a href="#l38.1273"></a><span id="l38.1273" class="difflineminus">-  if ((typeof aField.default) == &quot;number&quot;) {</span>
<a href="#l38.1274"></a><span id="l38.1274" class="difflineplus">+  if (typeof aField.default == &quot;number&quot;) {</span>
<a href="#l38.1275"></a><span id="l38.1275">     type = &quot;INT&quot;;</span>
<a href="#l38.1276"></a><span id="l38.1276">     this.min = aField.min;</span>
<a href="#l38.1277"></a><span id="l38.1277">     this.max = aField.max;</span>
<a href="#l38.1278"></a><span id="l38.1278" class="difflineplus">+  } else if (aField.isPassword) {</span>
<a href="#l38.1279"></a><span id="l38.1279" class="difflineplus">+    type = &quot;PASSWORD&quot;;</span>
<a href="#l38.1280"></a><span id="l38.1280">   }</span>
<a href="#l38.1281"></a><span id="l38.1281" class="difflineminus">-  else if (aField.isPassword)</span>
<a href="#l38.1282"></a><span id="l38.1282" class="difflineminus">-    type = &quot;PASSWORD&quot;;</span>
<a href="#l38.1283"></a><span id="l38.1283">   this.type = Ci.prplIChatRoomField[&quot;TYPE_&quot; + type];</span>
<a href="#l38.1284"></a><span id="l38.1284"> }</span>
<a href="#l38.1285"></a><span id="l38.1285" class="difflineminus">-ChatRoomField.prototype =</span>
<a href="#l38.1286"></a><span id="l38.1286" class="difflineminus">-  ClassInfo(&quot;prplIChatRoomField&quot;, &quot;ChatRoomField object&quot;);</span>
<a href="#l38.1287"></a><span id="l38.1287" class="difflineplus">+ChatRoomField.prototype = ClassInfo(</span>
<a href="#l38.1288"></a><span id="l38.1288" class="difflineplus">+  &quot;prplIChatRoomField&quot;,</span>
<a href="#l38.1289"></a><span id="l38.1289" class="difflineplus">+  &quot;ChatRoomField object&quot;</span>
<a href="#l38.1290"></a><span id="l38.1290" class="difflineplus">+);</span>
<a href="#l38.1291"></a><span id="l38.1291"> </span>
<a href="#l38.1292"></a><span id="l38.1292"> function ChatRoomFieldValues(aMap) {</span>
<a href="#l38.1293"></a><span id="l38.1293">   this.values = aMap;</span>
<a href="#l38.1294"></a><span id="l38.1294"> }</span>
<a href="#l38.1295"></a><span id="l38.1295"> ChatRoomFieldValues.prototype = {</span>
<a href="#l38.1296"></a><span id="l38.1296">   __proto__: ClassInfo(&quot;prplIChatRoomFieldValues&quot;, &quot;ChatRoomFieldValues&quot;),</span>
<a href="#l38.1297"></a><span id="l38.1297"> </span>
<a href="#l38.1298"></a><span id="l38.1298">   getValue(aIdentifier) {</span>
<a href="#l38.1299"></a><span id="l38.1299" class="difflineminus">-    return this.values.hasOwnProperty(aIdentifier) ? this.values[aIdentifier] : null;</span>
<a href="#l38.1300"></a><span id="l38.1300" class="difflineplus">+    return this.values.hasOwnProperty(aIdentifier)</span>
<a href="#l38.1301"></a><span id="l38.1301" class="difflineplus">+      ? this.values[aIdentifier]</span>
<a href="#l38.1302"></a><span id="l38.1302" class="difflineplus">+      : null;</span>
<a href="#l38.1303"></a><span id="l38.1303">   },</span>
<a href="#l38.1304"></a><span id="l38.1304">   setValue(aIdentifier, aValue) {</span>
<a href="#l38.1305"></a><span id="l38.1305">     this.values[aIdentifier] = aValue;</span>
<a href="#l38.1306"></a><span id="l38.1306">   },</span>
<a href="#l38.1307"></a><span id="l38.1307"> };</span>
<a href="#l38.1308"></a><span id="l38.1308"> </span>
<a href="#l38.1309"></a><span id="l38.1309"> // the name getter and the getAccount method need to be implemented by</span>
<a href="#l38.1310"></a><span id="l38.1310"> // protocol plugins.</span>
<a href="#l38.1311"></a><span id="l38.1311"> var GenericProtocolPrototype = {</span>
<a href="#l38.1312"></a><span id="l38.1312">   __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Generic protocol object&quot;),</span>
<a href="#l38.1313"></a><span id="l38.1313"> </span>
<a href="#l38.1314"></a><span id="l38.1314">   init(aId) {</span>
<a href="#l38.1315"></a><span id="l38.1315" class="difflineminus">-    if (aId != this.id)</span>
<a href="#l38.1316"></a><span id="l38.1316" class="difflineminus">-      throw new Error(&quot;Creating an instance of &quot; + aId + &quot; but this object implements &quot; + this.id);</span>
<a href="#l38.1317"></a><span id="l38.1317" class="difflineplus">+    if (aId != this.id) {</span>
<a href="#l38.1318"></a><span id="l38.1318" class="difflineplus">+      throw new Error(</span>
<a href="#l38.1319"></a><span id="l38.1319" class="difflineplus">+        &quot;Creating an instance of &quot; +</span>
<a href="#l38.1320"></a><span id="l38.1320" class="difflineplus">+          aId +</span>
<a href="#l38.1321"></a><span id="l38.1321" class="difflineplus">+          &quot; but this object implements &quot; +</span>
<a href="#l38.1322"></a><span id="l38.1322" class="difflineplus">+          this.id</span>
<a href="#l38.1323"></a><span id="l38.1323" class="difflineplus">+      );</span>
<a href="#l38.1324"></a><span id="l38.1324" class="difflineplus">+    }</span>
<a href="#l38.1325"></a><span id="l38.1325">   },</span>
<a href="#l38.1326"></a><span id="l38.1326" class="difflineminus">-  get id() { return &quot;prpl-&quot; + this.normalizedName; },</span>
<a href="#l38.1327"></a><span id="l38.1327" class="difflineplus">+  get id() {</span>
<a href="#l38.1328"></a><span id="l38.1328" class="difflineplus">+    return &quot;prpl-&quot; + this.normalizedName;</span>
<a href="#l38.1329"></a><span id="l38.1329" class="difflineplus">+  },</span>
<a href="#l38.1330"></a><span id="l38.1330">   // This is more aggressive than the account normalization of just</span>
<a href="#l38.1331"></a><span id="l38.1331">   // toLowerCase() since prpl names must be only letters/numbers.</span>
<a href="#l38.1332"></a><span id="l38.1332" class="difflineminus">-  get normalizedName() { return this.name.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(); },</span>
<a href="#l38.1333"></a><span id="l38.1333" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://chat/skin/prpl-generic/&quot;; },</span>
<a href="#l38.1334"></a><span id="l38.1334" class="difflineplus">+  get normalizedName() {</span>
<a href="#l38.1335"></a><span id="l38.1335" class="difflineplus">+    return this.name.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase();</span>
<a href="#l38.1336"></a><span id="l38.1336" class="difflineplus">+  },</span>
<a href="#l38.1337"></a><span id="l38.1337" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l38.1338"></a><span id="l38.1338" class="difflineplus">+    return &quot;chrome://chat/skin/prpl-generic/&quot;;</span>
<a href="#l38.1339"></a><span id="l38.1339" class="difflineplus">+  },</span>
<a href="#l38.1340"></a><span id="l38.1340"> </span>
<a href="#l38.1341"></a><span id="l38.1341" class="difflineminus">-  getAccount(aImAccount) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l38.1342"></a><span id="l38.1342" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l38.1343"></a><span id="l38.1343" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.1344"></a><span id="l38.1344" class="difflineplus">+  },</span>
<a href="#l38.1345"></a><span id="l38.1345"> </span>
<a href="#l38.1346"></a><span id="l38.1346">   _getOptionDefault(aName) {</span>
<a href="#l38.1347"></a><span id="l38.1347" class="difflineminus">-    if (this.options &amp;&amp; this.options.hasOwnProperty(aName))</span>
<a href="#l38.1348"></a><span id="l38.1348" class="difflineplus">+    if (this.options &amp;&amp; this.options.hasOwnProperty(aName)) {</span>
<a href="#l38.1349"></a><span id="l38.1349">       return this.options[aName].default;</span>
<a href="#l38.1350"></a><span id="l38.1350" class="difflineplus">+    }</span>
<a href="#l38.1351"></a><span id="l38.1351">     throw new Error(aName + &quot; has no default value in &quot; + this.id + &quot;.&quot;);</span>
<a href="#l38.1352"></a><span id="l38.1352">   },</span>
<a href="#l38.1353"></a><span id="l38.1353">   getOptions() {</span>
<a href="#l38.1354"></a><span id="l38.1354" class="difflineminus">-    if (!this.options)</span>
<a href="#l38.1355"></a><span id="l38.1355" class="difflineplus">+    if (!this.options) {</span>
<a href="#l38.1356"></a><span id="l38.1356">       return EmptyEnumerator;</span>
<a href="#l38.1357"></a><span id="l38.1357" class="difflineplus">+    }</span>
<a href="#l38.1358"></a><span id="l38.1358"> </span>
<a href="#l38.1359"></a><span id="l38.1359">     let purplePrefs = [];</span>
<a href="#l38.1360"></a><span id="l38.1360" class="difflineminus">-    for (let [name, option] of Object.entries(this.options))</span>
<a href="#l38.1361"></a><span id="l38.1361" class="difflineplus">+    for (let [name, option] of Object.entries(this.options)) {</span>
<a href="#l38.1362"></a><span id="l38.1362">       purplePrefs.push(new purplePref(name, option));</span>
<a href="#l38.1363"></a><span id="l38.1363" class="difflineplus">+    }</span>
<a href="#l38.1364"></a><span id="l38.1364">     return new nsSimpleEnumerator(purplePrefs);</span>
<a href="#l38.1365"></a><span id="l38.1365">   },</span>
<a href="#l38.1366"></a><span id="l38.1366">   getUsernameSplit() {</span>
<a href="#l38.1367"></a><span id="l38.1367" class="difflineminus">-    if (!this.usernameSplits || !this.usernameSplits.length)</span>
<a href="#l38.1368"></a><span id="l38.1368" class="difflineplus">+    if (!this.usernameSplits || !this.usernameSplits.length) {</span>
<a href="#l38.1369"></a><span id="l38.1369">       return EmptyEnumerator;</span>
<a href="#l38.1370"></a><span id="l38.1370" class="difflineplus">+    }</span>
<a href="#l38.1371"></a><span id="l38.1371"> </span>
<a href="#l38.1372"></a><span id="l38.1372">     return new nsSimpleEnumerator(</span>
<a href="#l38.1373"></a><span id="l38.1373" class="difflineminus">-      this.usernameSplits.map(split =&gt; new UsernameSplit(split)));</span>
<a href="#l38.1374"></a><span id="l38.1374" class="difflineplus">+      this.usernameSplits.map(split =&gt; new UsernameSplit(split))</span>
<a href="#l38.1375"></a><span id="l38.1375" class="difflineplus">+    );</span>
<a href="#l38.1376"></a><span id="l38.1376">   },</span>
<a href="#l38.1377"></a><span id="l38.1377"> </span>
<a href="#l38.1378"></a><span id="l38.1378">   registerCommands() {</span>
<a href="#l38.1379"></a><span id="l38.1379" class="difflineminus">-    if (!this.commands)</span>
<a href="#l38.1380"></a><span id="l38.1380" class="difflineplus">+    if (!this.commands) {</span>
<a href="#l38.1381"></a><span id="l38.1381">       return;</span>
<a href="#l38.1382"></a><span id="l38.1382" class="difflineplus">+    }</span>
<a href="#l38.1383"></a><span id="l38.1383"> </span>
<a href="#l38.1384"></a><span id="l38.1384">     this.commands.forEach(function(command) {</span>
<a href="#l38.1385"></a><span id="l38.1385" class="difflineminus">-      if (!command.hasOwnProperty(&quot;name&quot;) || !command.hasOwnProperty(&quot;run&quot;))</span>
<a href="#l38.1386"></a><span id="l38.1386" class="difflineplus">+      if (!command.hasOwnProperty(&quot;name&quot;) || !command.hasOwnProperty(&quot;run&quot;)) {</span>
<a href="#l38.1387"></a><span id="l38.1387">         throw new Error(&quot;Every command must have a name and a run function.&quot;);</span>
<a href="#l38.1388"></a><span id="l38.1388" class="difflineminus">-      if (!(&quot;QueryInterface&quot; in command))</span>
<a href="#l38.1389"></a><span id="l38.1389" class="difflineplus">+      }</span>
<a href="#l38.1390"></a><span id="l38.1390" class="difflineplus">+      if (!(&quot;QueryInterface&quot; in command)) {</span>
<a href="#l38.1391"></a><span id="l38.1391">         command.QueryInterface = ChromeUtils.generateQI([Ci.imICommand]);</span>
<a href="#l38.1392"></a><span id="l38.1392" class="difflineminus">-      if (!command.hasOwnProperty(&quot;usageContext&quot;))</span>
<a href="#l38.1393"></a><span id="l38.1393" class="difflineplus">+      }</span>
<a href="#l38.1394"></a><span id="l38.1394" class="difflineplus">+      if (!command.hasOwnProperty(&quot;usageContext&quot;)) {</span>
<a href="#l38.1395"></a><span id="l38.1395">         command.usageContext = Ci.imICommand.CMD_CONTEXT_ALL;</span>
<a href="#l38.1396"></a><span id="l38.1396" class="difflineminus">-      if (!command.hasOwnProperty(&quot;priority&quot;))</span>
<a href="#l38.1397"></a><span id="l38.1397" class="difflineplus">+      }</span>
<a href="#l38.1398"></a><span id="l38.1398" class="difflineplus">+      if (!command.hasOwnProperty(&quot;priority&quot;)) {</span>
<a href="#l38.1399"></a><span id="l38.1399">         command.priority = Ci.imICommand.CMD_PRIORITY_PRPL;</span>
<a href="#l38.1400"></a><span id="l38.1400" class="difflineplus">+      }</span>
<a href="#l38.1401"></a><span id="l38.1401">       Services.cmd.registerCommand(command, this.id);</span>
<a href="#l38.1402"></a><span id="l38.1402">     }, this);</span>
<a href="#l38.1403"></a><span id="l38.1403">   },</span>
<a href="#l38.1404"></a><span id="l38.1404"> </span>
<a href="#l38.1405"></a><span id="l38.1405">   // NS_ERROR_XPC_JSOBJECT_HAS_NO_FUNCTION_NAMED errors are too noisy</span>
<a href="#l38.1406"></a><span id="l38.1406" class="difflineminus">-  get usernameEmptyText() { return &quot;&quot;; },</span>
<a href="#l38.1407"></a><span id="l38.1407" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l38.1408"></a><span id="l38.1408" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l38.1409"></a><span id="l38.1409" class="difflineplus">+  },</span>
<a href="#l38.1410"></a><span id="l38.1410">   accountExists: () =&gt; false, // FIXME</span>
<a href="#l38.1411"></a><span id="l38.1411"> </span>
<a href="#l38.1412"></a><span id="l38.1412" class="difflineminus">-  get uniqueChatName() { return false; },</span>
<a href="#l38.1413"></a><span id="l38.1413" class="difflineminus">-  get chatHasTopic() { return false; },</span>
<a href="#l38.1414"></a><span id="l38.1414" class="difflineminus">-  get noPassword() { return false; },</span>
<a href="#l38.1415"></a><span id="l38.1415" class="difflineminus">-  get newMailNotification() { return false; },</span>
<a href="#l38.1416"></a><span id="l38.1416" class="difflineminus">-  get imagesInIM() { return false; },</span>
<a href="#l38.1417"></a><span id="l38.1417" class="difflineminus">-  get passwordOptional() { return false; },</span>
<a href="#l38.1418"></a><span id="l38.1418" class="difflineminus">-  get usePointSize() { return true; },</span>
<a href="#l38.1419"></a><span id="l38.1419" class="difflineminus">-  get registerNoScreenName() { return false; },</span>
<a href="#l38.1420"></a><span id="l38.1420" class="difflineminus">-  get slashCommandsNative() { return false; },</span>
<a href="#l38.1421"></a><span id="l38.1421" class="difflineminus">-  get usePurpleProxy() { return false; },</span>
<a href="#l38.1422"></a><span id="l38.1422" class="difflineplus">+  get uniqueChatName() {</span>
<a href="#l38.1423"></a><span id="l38.1423" class="difflineplus">+    return false;</span>
<a href="#l38.1424"></a><span id="l38.1424" class="difflineplus">+  },</span>
<a href="#l38.1425"></a><span id="l38.1425" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l38.1426"></a><span id="l38.1426" class="difflineplus">+    return false;</span>
<a href="#l38.1427"></a><span id="l38.1427" class="difflineplus">+  },</span>
<a href="#l38.1428"></a><span id="l38.1428" class="difflineplus">+  get noPassword() {</span>
<a href="#l38.1429"></a><span id="l38.1429" class="difflineplus">+    return false;</span>
<a href="#l38.1430"></a><span id="l38.1430" class="difflineplus">+  },</span>
<a href="#l38.1431"></a><span id="l38.1431" class="difflineplus">+  get newMailNotification() {</span>
<a href="#l38.1432"></a><span id="l38.1432" class="difflineplus">+    return false;</span>
<a href="#l38.1433"></a><span id="l38.1433" class="difflineplus">+  },</span>
<a href="#l38.1434"></a><span id="l38.1434" class="difflineplus">+  get imagesInIM() {</span>
<a href="#l38.1435"></a><span id="l38.1435" class="difflineplus">+    return false;</span>
<a href="#l38.1436"></a><span id="l38.1436" class="difflineplus">+  },</span>
<a href="#l38.1437"></a><span id="l38.1437" class="difflineplus">+  get passwordOptional() {</span>
<a href="#l38.1438"></a><span id="l38.1438" class="difflineplus">+    return false;</span>
<a href="#l38.1439"></a><span id="l38.1439" class="difflineplus">+  },</span>
<a href="#l38.1440"></a><span id="l38.1440" class="difflineplus">+  get usePointSize() {</span>
<a href="#l38.1441"></a><span id="l38.1441" class="difflineplus">+    return true;</span>
<a href="#l38.1442"></a><span id="l38.1442" class="difflineplus">+  },</span>
<a href="#l38.1443"></a><span id="l38.1443" class="difflineplus">+  get registerNoScreenName() {</span>
<a href="#l38.1444"></a><span id="l38.1444" class="difflineplus">+    return false;</span>
<a href="#l38.1445"></a><span id="l38.1445" class="difflineplus">+  },</span>
<a href="#l38.1446"></a><span id="l38.1446" class="difflineplus">+  get slashCommandsNative() {</span>
<a href="#l38.1447"></a><span id="l38.1447" class="difflineplus">+    return false;</span>
<a href="#l38.1448"></a><span id="l38.1448" class="difflineplus">+  },</span>
<a href="#l38.1449"></a><span id="l38.1449" class="difflineplus">+  get usePurpleProxy() {</span>
<a href="#l38.1450"></a><span id="l38.1450" class="difflineplus">+    return false;</span>
<a href="#l38.1451"></a><span id="l38.1451" class="difflineplus">+  },</span>
<a href="#l38.1452"></a><span id="l38.1452"> </span>
<a href="#l38.1453"></a><span id="l38.1453" class="difflineminus">-  get classDescription() { return this.name + &quot; Protocol&quot;; },</span>
<a href="#l38.1454"></a><span id="l38.1454" class="difflineminus">-  get contractID() { return &quot;@mozilla.org/chat/&quot; + this.normalizedName + &quot;;1&quot;; },</span>
<a href="#l38.1455"></a><span id="l38.1455" class="difflineplus">+  get classDescription() {</span>
<a href="#l38.1456"></a><span id="l38.1456" class="difflineplus">+    return this.name + &quot; Protocol&quot;;</span>
<a href="#l38.1457"></a><span id="l38.1457" class="difflineplus">+  },</span>
<a href="#l38.1458"></a><span id="l38.1458" class="difflineplus">+  get contractID() {</span>
<a href="#l38.1459"></a><span id="l38.1459" class="difflineplus">+    return &quot;@mozilla.org/chat/&quot; + this.normalizedName + &quot;;1&quot;;</span>
<a href="#l38.1460"></a><span id="l38.1460" class="difflineplus">+  },</span>
<a href="#l38.1461"></a><span id="l38.1461"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/chat/modules/socket.jsm</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/chat/modules/socket.jsm</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -71,48 +71,56 @@</span>
<a href="#l39.4"></a><span id="l39.4">  * To Do:</span>
<a href="#l39.5"></a><span id="l39.5">  *   Add a message queue to keep from flooding a server (just an array, just</span>
<a href="#l39.6"></a><span id="l39.6">  *     keep shifting the first element off and calling as setTimeout for the</span>
<a href="#l39.7"></a><span id="l39.7">  *     desired flood time?).</span>
<a href="#l39.8"></a><span id="l39.8">  */</span>
<a href="#l39.9"></a><span id="l39.9"> </span>
<a href="#l39.10"></a><span id="l39.10"> this.EXPORTED_SYMBOLS = [&quot;Socket&quot;];</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-var {</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-  ArrayBufferToBytes,</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-  ArrayBufferToHexString,</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/ArrayBufferUtils.jsm&quot;);</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-var {</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-  setTimeout,</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-  clearTimeout,</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-  executeSoon,</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-var {getHiddenHTMLWindow} = ChromeUtils.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+var { ArrayBufferToBytes, ArrayBufferToHexString } = ChromeUtils.import(</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+  &quot;resource:///modules/ArrayBufferUtils.jsm&quot;</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+);</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+var { setTimeout, clearTimeout, executeSoon } = ChromeUtils.import(</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+);</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+var { getHiddenHTMLWindow } = ChromeUtils.import(</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+  &quot;resource:///modules/hiddenWindow.jsm&quot;</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+);</span>
<a href="#l39.33"></a><span id="l39.33"> </span>
<a href="#l39.34"></a><span id="l39.34"> // Network errors see: xpcom/base/nsError.h</span>
<a href="#l39.35"></a><span id="l39.35"> var NS_ERROR_MODULE_NETWORK = 2152398848;</span>
<a href="#l39.36"></a><span id="l39.36"> var NS_ERROR_NET_TIMEOUT = NS_ERROR_MODULE_NETWORK + 14;</span>
<a href="#l39.37"></a><span id="l39.37"> var NS_ERROR_NET_RESET = NS_ERROR_MODULE_NETWORK + 20;</span>
<a href="#l39.38"></a><span id="l39.38"> </span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-var BinaryInputStream =</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-  Components.Constructor(&quot;@mozilla.org/binaryinputstream;1&quot;,</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-                         &quot;nsIBinaryInputStream&quot;, &quot;setInputStream&quot;);</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-var BinaryOutputStream =</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-  Components.Constructor(&quot;@mozilla.org/binaryoutputstream;1&quot;,</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-                         &quot;nsIBinaryOutputStream&quot;, &quot;setOutputStream&quot;);</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-var ScriptableInputStream =</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-  Components.Constructor(&quot;@mozilla.org/scriptableinputstream;1&quot;,</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-                         &quot;nsIScriptableInputStream&quot;, &quot;init&quot;);</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-var InputStreamPump =</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">-  Components.Constructor(&quot;@mozilla.org/network/input-stream-pump;1&quot;,</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-                         &quot;nsIInputStreamPump&quot;, &quot;init&quot;);</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-var ScriptableUnicodeConverter =</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-  Components.Constructor(&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;,</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">-                         &quot;nsIScriptableUnicodeConverter&quot;);</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+var BinaryInputStream = Components.Constructor(</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+  &quot;@mozilla.org/binaryinputstream;1&quot;,</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+  &quot;nsIBinaryInputStream&quot;,</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+  &quot;setInputStream&quot;</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+);</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+var BinaryOutputStream = Components.Constructor(</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+  &quot;@mozilla.org/binaryoutputstream;1&quot;,</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+  &quot;nsIBinaryOutputStream&quot;,</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+  &quot;setOutputStream&quot;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+);</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+var ScriptableInputStream = Components.Constructor(</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+  &quot;@mozilla.org/scriptableinputstream;1&quot;,</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+  &quot;nsIScriptableInputStream&quot;,</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+  &quot;init&quot;</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+);</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+var InputStreamPump = Components.Constructor(</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+  &quot;@mozilla.org/network/input-stream-pump;1&quot;,</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+  &quot;nsIInputStreamPump&quot;,</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+  &quot;init&quot;</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+);</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+var ScriptableUnicodeConverter = Components.Constructor(</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+  &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;,</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+  &quot;nsIScriptableUnicodeConverter&quot;</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+);</span>
<a href="#l39.78"></a><span id="l39.78"> </span>
<a href="#l39.79"></a><span id="l39.79"> var Socket = {</span>
<a href="#l39.80"></a><span id="l39.80">   // Use this to use binary mode for the</span>
<a href="#l39.81"></a><span id="l39.81">   binaryMode: false,</span>
<a href="#l39.82"></a><span id="l39.82"> </span>
<a href="#l39.83"></a><span id="l39.83">   // Set this for non-binary mode to automatically parse the stream into chunks</span>
<a href="#l39.84"></a><span id="l39.84">   // separated by delimiter.</span>
<a href="#l39.85"></a><span id="l39.85">   delimiter: &quot;&quot;,</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineat">@@ -135,20 +143,27 @@ var Socket = {</span>
<a href="#l39.87"></a><span id="l39.87">    *****************************************************************************</span>
<a href="#l39.88"></a><span id="l39.88">    ******************************* Public methods ******************************</span>
<a href="#l39.89"></a><span id="l39.89">    *****************************************************************************</span>
<a href="#l39.90"></a><span id="l39.90">    */</span>
<a href="#l39.91"></a><span id="l39.91">   // Synchronously open a connection.</span>
<a href="#l39.92"></a><span id="l39.92">   // It connects to aHost and aPort, but uses aOriginHost and aOriginPort for</span>
<a href="#l39.93"></a><span id="l39.93">   // checking the certificate for them (see nsIRoutedSocketTransportService</span>
<a href="#l39.94"></a><span id="l39.94">   // in nsISocketTransportService.idl).</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineminus">-  connect(aOriginHost, aOriginPort, aSecurity, aProxy,</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineminus">-          aHost = aOriginHost, aPort = aOriginPort) {</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+  connect(</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+    aOriginHost,</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+    aOriginPort,</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+    aSecurity,</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+    aProxy,</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+    aHost = aOriginHost,</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+    aPort = aOriginPort</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+  ) {</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+    if (Services.io.offline) {</span>
<a href="#l39.107"></a><span id="l39.107">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+    }</span>
<a href="#l39.109"></a><span id="l39.109"> </span>
<a href="#l39.110"></a><span id="l39.110">     // This won't work for Linux due to bug 758848.</span>
<a href="#l39.111"></a><span id="l39.111">     Services.obs.addObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l39.112"></a><span id="l39.112"> </span>
<a href="#l39.113"></a><span id="l39.113">     this.LOG(&quot;Connecting to: &quot; + aHost + &quot;:&quot; + aPort);</span>
<a href="#l39.114"></a><span id="l39.114">     this.originHost = aOriginHost;</span>
<a href="#l39.115"></a><span id="l39.115">     this.originPort = aOriginPort;</span>
<a href="#l39.116"></a><span id="l39.116">     this.host = aHost;</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineat">@@ -159,30 +174,35 @@ var Socket = {</span>
<a href="#l39.118"></a><span id="l39.118">     this._pendingData = [];</span>
<a href="#l39.119"></a><span id="l39.119">     delete this._stopRequestStatus;</span>
<a href="#l39.120"></a><span id="l39.120"> </span>
<a href="#l39.121"></a><span id="l39.121">     // Array of security options</span>
<a href="#l39.122"></a><span id="l39.122">     this.security = aSecurity || [];</span>
<a href="#l39.123"></a><span id="l39.123"> </span>
<a href="#l39.124"></a><span id="l39.124">     // Choose a proxy, use the given one, otherwise get one from the proxy</span>
<a href="#l39.125"></a><span id="l39.125">     // service</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineminus">-    if (aProxy)</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+    if (aProxy) {</span>
<a href="#l39.128"></a><span id="l39.128">       this._createTransport(aProxy);</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineminus">-    else {</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+    } else {</span>
<a href="#l39.131"></a><span id="l39.131">       try {</span>
<a href="#l39.132"></a><span id="l39.132">         // Attempt to get a default proxy from the proxy service.</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineminus">-        let proxyService = Cc[&quot;@mozilla.org/network/protocol-proxy-service;1&quot;]</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineminus">-                              .getService(Ci.nsIProtocolProxyService);</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+        let proxyService = Cc[</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+          &quot;@mozilla.org/network/protocol-proxy-service;1&quot;</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+        ].getService(Ci.nsIProtocolProxyService);</span>
<a href="#l39.138"></a><span id="l39.138"> </span>
<a href="#l39.139"></a><span id="l39.139">         // Add a URI scheme since, by default, some protocols (i.e. IRC) don't</span>
<a href="#l39.140"></a><span id="l39.140">         // have a URI scheme before the host.</span>
<a href="#l39.141"></a><span id="l39.141">         let uri = Services.io.newURI(&quot;http://&quot; + this.host);</span>
<a href="#l39.142"></a><span id="l39.142">         // This will return null when the result is known immediately and</span>
<a href="#l39.143"></a><span id="l39.143">         // the callback will just be dispatched to the current thread.</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineminus">-        this._proxyCancel = proxyService.asyncResolve(uri, this.proxyFlags, this);</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineplus">+        this._proxyCancel = proxyService.asyncResolve(</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+          uri,</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+          this.proxyFlags,</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+          this</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineplus">+        );</span>
<a href="#l39.150"></a><span id="l39.150">       } catch (e) {</span>
<a href="#l39.151"></a><span id="l39.151">         Cu.reportError(e);</span>
<a href="#l39.152"></a><span id="l39.152">         // We had some error getting the proxy service, just don't use one.</span>
<a href="#l39.153"></a><span id="l39.153">         this._createTransport(null);</span>
<a href="#l39.154"></a><span id="l39.154">       }</span>
<a href="#l39.155"></a><span id="l39.155">     }</span>
<a href="#l39.156"></a><span id="l39.156">   },</span>
<a href="#l39.157"></a><span id="l39.157"> </span>
<a href="#l39.158"></a><span id="l39.158" class="difflineat">@@ -203,18 +223,19 @@ var Socket = {</span>
<a href="#l39.159"></a><span id="l39.159">       delete this._outputStream;</span>
<a href="#l39.160"></a><span id="l39.160">     }</span>
<a href="#l39.161"></a><span id="l39.161">     if (&quot;transport&quot; in this) {</span>
<a href="#l39.162"></a><span id="l39.162">       this.transport.close(Cr.NS_OK);</span>
<a href="#l39.163"></a><span id="l39.163">       delete this.transport;</span>
<a href="#l39.164"></a><span id="l39.164">     }</span>
<a href="#l39.165"></a><span id="l39.165"> </span>
<a href="#l39.166"></a><span id="l39.166">     if (&quot;_proxyCancel&quot; in this) {</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineminus">-      if (this._proxyCancel)</span>
<a href="#l39.168"></a><span id="l39.168" class="difflineminus">-        this._proxyCancel.cancel(Cr.NS_ERROR_ABORT); // Has to give a failure code</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineplus">+      if (this._proxyCancel) {</span>
<a href="#l39.170"></a><span id="l39.170" class="difflineplus">+        this._proxyCancel.cancel(Cr.NS_ERROR_ABORT);</span>
<a href="#l39.171"></a><span id="l39.171" class="difflineplus">+      } // Has to give a failure code</span>
<a href="#l39.172"></a><span id="l39.172">       delete this._proxyCancel;</span>
<a href="#l39.173"></a><span id="l39.173">     }</span>
<a href="#l39.174"></a><span id="l39.174"> </span>
<a href="#l39.175"></a><span id="l39.175">     if (this._pingTimer) {</span>
<a href="#l39.176"></a><span id="l39.176">       clearTimeout(this._pingTimer);</span>
<a href="#l39.177"></a><span id="l39.177">       delete this._pingTimer;</span>
<a href="#l39.178"></a><span id="l39.178">       delete this._resetPingTimerPending;</span>
<a href="#l39.179"></a><span id="l39.179">     }</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineat">@@ -249,83 +270,98 @@ var Socket = {</span>
<a href="#l39.181"></a><span id="l39.181">       let stream = converter.convertToInputStream(aString);</span>
<a href="#l39.182"></a><span id="l39.182">       this._outputStream.writeFrom(stream, stream.available());</span>
<a href="#l39.183"></a><span id="l39.183">     } catch (e) {</span>
<a href="#l39.184"></a><span id="l39.184">       Cu.reportError(e);</span>
<a href="#l39.185"></a><span id="l39.185">     }</span>
<a href="#l39.186"></a><span id="l39.186">   },</span>
<a href="#l39.187"></a><span id="l39.187"> </span>
<a href="#l39.188"></a><span id="l39.188">   sendBinaryData(/* ArrayBuffer */ aData, aLoggedData) {</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineminus">-    this.LOG(&quot;Sending binary data:\n&quot; + (aLoggedData ||</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineminus">-             &quot;&lt;&quot; + ArrayBufferToHexString(aData) + &quot;&gt;&quot;));</span>
<a href="#l39.191"></a><span id="l39.191" class="difflineplus">+    this.LOG(</span>
<a href="#l39.192"></a><span id="l39.192" class="difflineplus">+      &quot;Sending binary data:\n&quot; +</span>
<a href="#l39.193"></a><span id="l39.193" class="difflineplus">+        (aLoggedData || &quot;&lt;&quot; + ArrayBufferToHexString(aData) + &quot;&gt;&quot;)</span>
<a href="#l39.194"></a><span id="l39.194" class="difflineplus">+    );</span>
<a href="#l39.195"></a><span id="l39.195"> </span>
<a href="#l39.196"></a><span id="l39.196">     let byteArray = ArrayBufferToBytes(aData);</span>
<a href="#l39.197"></a><span id="l39.197">     try {</span>
<a href="#l39.198"></a><span id="l39.198">       // Send the data as a byte array</span>
<a href="#l39.199"></a><span id="l39.199">       this._binaryOutputStream.writeByteArray(byteArray, byteArray.length);</span>
<a href="#l39.200"></a><span id="l39.200">     } catch (e) {</span>
<a href="#l39.201"></a><span id="l39.201">       Cu.reportError(e);</span>
<a href="#l39.202"></a><span id="l39.202">     }</span>
<a href="#l39.203"></a><span id="l39.203">   },</span>
<a href="#l39.204"></a><span id="l39.204"> </span>
<a href="#l39.205"></a><span id="l39.205">   disconnected: true,</span>
<a href="#l39.206"></a><span id="l39.206"> </span>
<a href="#l39.207"></a><span id="l39.207">   startTLS() {</span>
<a href="#l39.208"></a><span id="l39.208" class="difflineminus">-    this.transport.securityInfo.QueryInterface(Ci.nsISSLSocketControl).StartTLS();</span>
<a href="#l39.209"></a><span id="l39.209" class="difflineplus">+    this.transport.securityInfo</span>
<a href="#l39.210"></a><span id="l39.210" class="difflineplus">+      .QueryInterface(Ci.nsISSLSocketControl)</span>
<a href="#l39.211"></a><span id="l39.211" class="difflineplus">+      .StartTLS();</span>
<a href="#l39.212"></a><span id="l39.212">   },</span>
<a href="#l39.213"></a><span id="l39.213"> </span>
<a href="#l39.214"></a><span id="l39.214">   // If using the ping functionality, this should be called whenever a message is</span>
<a href="#l39.215"></a><span id="l39.215">   // received (e.g. when it is known the socket is still open). Calling this for</span>
<a href="#l39.216"></a><span id="l39.216">   // the first time enables the ping functionality.</span>
<a href="#l39.217"></a><span id="l39.217">   resetPingTimer() {</span>
<a href="#l39.218"></a><span id="l39.218">     // Clearing and setting timeouts is expensive, so we do it at most</span>
<a href="#l39.219"></a><span id="l39.219">     // once per eventloop spin cycle.</span>
<a href="#l39.220"></a><span id="l39.220" class="difflineminus">-    if (this._resetPingTimerPending)</span>
<a href="#l39.221"></a><span id="l39.221" class="difflineplus">+    if (this._resetPingTimerPending) {</span>
<a href="#l39.222"></a><span id="l39.222">       return;</span>
<a href="#l39.223"></a><span id="l39.223" class="difflineplus">+    }</span>
<a href="#l39.224"></a><span id="l39.224">     this._resetPingTimerPending = true;</span>
<a href="#l39.225"></a><span id="l39.225">     executeSoon(this._delayedResetPingTimer.bind(this));</span>
<a href="#l39.226"></a><span id="l39.226">   },</span>
<a href="#l39.227"></a><span id="l39.227">   kTimeBeforePing: 120000, // 2 min</span>
<a href="#l39.228"></a><span id="l39.228">   kTimeAfterPingBeforeDisconnect: 30000, // 30 s</span>
<a href="#l39.229"></a><span id="l39.229">   _delayedResetPingTimer() {</span>
<a href="#l39.230"></a><span id="l39.230" class="difflineminus">-    if (!this._resetPingTimerPending)</span>
<a href="#l39.231"></a><span id="l39.231" class="difflineplus">+    if (!this._resetPingTimerPending) {</span>
<a href="#l39.232"></a><span id="l39.232">       return;</span>
<a href="#l39.233"></a><span id="l39.233" class="difflineplus">+    }</span>
<a href="#l39.234"></a><span id="l39.234">     delete this._resetPingTimerPending;</span>
<a href="#l39.235"></a><span id="l39.235" class="difflineminus">-    if (this._pingTimer)</span>
<a href="#l39.236"></a><span id="l39.236" class="difflineplus">+    if (this._pingTimer) {</span>
<a href="#l39.237"></a><span id="l39.237">       clearTimeout(this._pingTimer);</span>
<a href="#l39.238"></a><span id="l39.238" class="difflineplus">+    }</span>
<a href="#l39.239"></a><span id="l39.239">     // Send a ping every 2 minutes if there's no traffic on the socket.</span>
<a href="#l39.240"></a><span id="l39.240" class="difflineminus">-    this._pingTimer = setTimeout(this._sendPing.bind(this), this.kTimeBeforePing);</span>
<a href="#l39.241"></a><span id="l39.241" class="difflineplus">+    this._pingTimer = setTimeout(</span>
<a href="#l39.242"></a><span id="l39.242" class="difflineplus">+      this._sendPing.bind(this),</span>
<a href="#l39.243"></a><span id="l39.243" class="difflineplus">+      this.kTimeBeforePing</span>
<a href="#l39.244"></a><span id="l39.244" class="difflineplus">+    );</span>
<a href="#l39.245"></a><span id="l39.245">   },</span>
<a href="#l39.246"></a><span id="l39.246"> </span>
<a href="#l39.247"></a><span id="l39.247">   // If using the ping functionality, this should be called when a ping receives</span>
<a href="#l39.248"></a><span id="l39.248">   // a response.</span>
<a href="#l39.249"></a><span id="l39.249">   cancelDisconnectTimer() {</span>
<a href="#l39.250"></a><span id="l39.250" class="difflineminus">-    if (!this._disconnectTimer)</span>
<a href="#l39.251"></a><span id="l39.251" class="difflineplus">+    if (!this._disconnectTimer) {</span>
<a href="#l39.252"></a><span id="l39.252">       return;</span>
<a href="#l39.253"></a><span id="l39.253" class="difflineplus">+    }</span>
<a href="#l39.254"></a><span id="l39.254">     clearTimeout(this._disconnectTimer);</span>
<a href="#l39.255"></a><span id="l39.255">     delete this._disconnectTimer;</span>
<a href="#l39.256"></a><span id="l39.256">   },</span>
<a href="#l39.257"></a><span id="l39.257"> </span>
<a href="#l39.258"></a><span id="l39.258">   // Plenty of time may have elapsed if the computer wakes from sleep, so check</span>
<a href="#l39.259"></a><span id="l39.259">   // if we should reconnect immediately.</span>
<a href="#l39.260"></a><span id="l39.260">   _lastAliveTime: null,</span>
<a href="#l39.261"></a><span id="l39.261">   observe(aSubject, aTopic, aData) {</span>
<a href="#l39.262"></a><span id="l39.262" class="difflineminus">-    if (aTopic != &quot;wake_notification&quot;)</span>
<a href="#l39.263"></a><span id="l39.263" class="difflineplus">+    if (aTopic != &quot;wake_notification&quot;) {</span>
<a href="#l39.264"></a><span id="l39.264">       return;</span>
<a href="#l39.265"></a><span id="l39.265" class="difflineplus">+    }</span>
<a href="#l39.266"></a><span id="l39.266">     let elapsedTime = Date.now() - this._lastAliveTime;</span>
<a href="#l39.267"></a><span id="l39.267">     // If there never was any activity before we went to sleep,</span>
<a href="#l39.268"></a><span id="l39.268">     // or if we've been waiting for a ping response for over 30s,</span>
<a href="#l39.269"></a><span id="l39.269">     // or if the last activity on the socket is longer ago than we usually</span>
<a href="#l39.270"></a><span id="l39.270">     //   allow before we timeout,</span>
<a href="#l39.271"></a><span id="l39.271">     // declare the connection timed out immediately.</span>
<a href="#l39.272"></a><span id="l39.272" class="difflineminus">-    if (!this._lastAliveTime ||</span>
<a href="#l39.273"></a><span id="l39.273" class="difflineminus">-        (this._disconnectTimer &amp;&amp; elapsedTime &gt; this.kTimeAfterPingBeforeDisconnect) ||</span>
<a href="#l39.274"></a><span id="l39.274" class="difflineminus">-        elapsedTime &gt; this.kTimeBeforePing + this.kTimeAfterPingBeforeDisconnect)</span>
<a href="#l39.275"></a><span id="l39.275" class="difflineplus">+    if (</span>
<a href="#l39.276"></a><span id="l39.276" class="difflineplus">+      !this._lastAliveTime ||</span>
<a href="#l39.277"></a><span id="l39.277" class="difflineplus">+      (this._disconnectTimer &amp;&amp;</span>
<a href="#l39.278"></a><span id="l39.278" class="difflineplus">+        elapsedTime &gt; this.kTimeAfterPingBeforeDisconnect) ||</span>
<a href="#l39.279"></a><span id="l39.279" class="difflineplus">+      elapsedTime &gt; this.kTimeBeforePing + this.kTimeAfterPingBeforeDisconnect</span>
<a href="#l39.280"></a><span id="l39.280" class="difflineplus">+    ) {</span>
<a href="#l39.281"></a><span id="l39.281">       this.onConnectionTimedOut();</span>
<a href="#l39.282"></a><span id="l39.282" class="difflineminus">-    else if (this._pingTimer) {</span>
<a href="#l39.283"></a><span id="l39.283" class="difflineplus">+    } else if (this._pingTimer) {</span>
<a href="#l39.284"></a><span id="l39.284">       // If there was a ping timer running when the computer went to sleep,</span>
<a href="#l39.285"></a><span id="l39.285">       // ping immediately to discover if we are still connected.</span>
<a href="#l39.286"></a><span id="l39.286">       clearTimeout(this._pingTimer);</span>
<a href="#l39.287"></a><span id="l39.287">       this._sendPing();</span>
<a href="#l39.288"></a><span id="l39.288">     }</span>
<a href="#l39.289"></a><span id="l39.289">   },</span>
<a href="#l39.290"></a><span id="l39.290"> </span>
<a href="#l39.291"></a><span id="l39.291">   /*</span>
<a href="#l39.292"></a><span id="l39.292" class="difflineat">@@ -341,104 +377,114 @@ var Socket = {</span>
<a href="#l39.293"></a><span id="l39.293">       this.LOG(&quot;onProxyAvailable called, but disconnect() was called before.&quot;);</span>
<a href="#l39.294"></a><span id="l39.294">       return;</span>
<a href="#l39.295"></a><span id="l39.295">     }</span>
<a href="#l39.296"></a><span id="l39.296"> </span>
<a href="#l39.297"></a><span id="l39.297">     if (aProxyInfo) {</span>
<a href="#l39.298"></a><span id="l39.298">       if (aProxyInfo.type == &quot;http&quot;) {</span>
<a href="#l39.299"></a><span id="l39.299">         this.LOG(&quot;ignoring http proxy&quot;);</span>
<a href="#l39.300"></a><span id="l39.300">         aProxyInfo = null;</span>
<a href="#l39.301"></a><span id="l39.301" class="difflineminus">-      }</span>
<a href="#l39.302"></a><span id="l39.302" class="difflineminus">-      else {</span>
<a href="#l39.303"></a><span id="l39.303" class="difflineminus">-        this.LOG(&quot;using &quot; + aProxyInfo.type + &quot; proxy: &quot; +</span>
<a href="#l39.304"></a><span id="l39.304" class="difflineminus">-                 aProxyInfo.host + &quot;:&quot; + aProxyInfo.port);</span>
<a href="#l39.305"></a><span id="l39.305" class="difflineplus">+      } else {</span>
<a href="#l39.306"></a><span id="l39.306" class="difflineplus">+        this.LOG(</span>
<a href="#l39.307"></a><span id="l39.307" class="difflineplus">+          &quot;using &quot; +</span>
<a href="#l39.308"></a><span id="l39.308" class="difflineplus">+            aProxyInfo.type +</span>
<a href="#l39.309"></a><span id="l39.309" class="difflineplus">+            &quot; proxy: &quot; +</span>
<a href="#l39.310"></a><span id="l39.310" class="difflineplus">+            aProxyInfo.host +</span>
<a href="#l39.311"></a><span id="l39.311" class="difflineplus">+            &quot;:&quot; +</span>
<a href="#l39.312"></a><span id="l39.312" class="difflineplus">+            aProxyInfo.port</span>
<a href="#l39.313"></a><span id="l39.313" class="difflineplus">+        );</span>
<a href="#l39.314"></a><span id="l39.314">       }</span>
<a href="#l39.315"></a><span id="l39.315">     }</span>
<a href="#l39.316"></a><span id="l39.316">     this._createTransport(aProxyInfo);</span>
<a href="#l39.317"></a><span id="l39.317">     delete this._proxyCancel;</span>
<a href="#l39.318"></a><span id="l39.318">   },</span>
<a href="#l39.319"></a><span id="l39.319"> </span>
<a href="#l39.320"></a><span id="l39.320">   /*</span>
<a href="#l39.321"></a><span id="l39.321">    * nsIStreamListener methods</span>
<a href="#l39.322"></a><span id="l39.322">    */</span>
<a href="#l39.323"></a><span id="l39.323">   // onDataAvailable, called by Mozilla's networking code.</span>
<a href="#l39.324"></a><span id="l39.324">   // Buffers the data, and parses it into discrete messages.</span>
<a href="#l39.325"></a><span id="l39.325">   onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l39.326"></a><span id="l39.326" class="difflineminus">-    if (this.disconnected)</span>
<a href="#l39.327"></a><span id="l39.327" class="difflineplus">+    if (this.disconnected) {</span>
<a href="#l39.328"></a><span id="l39.328">       return;</span>
<a href="#l39.329"></a><span id="l39.329" class="difflineplus">+    }</span>
<a href="#l39.330"></a><span id="l39.330">     this._lastAliveTime = Date.now();</span>
<a href="#l39.331"></a><span id="l39.331">     if (this.binaryMode) {</span>
<a href="#l39.332"></a><span id="l39.332">       // Load the data from the stream</span>
<a href="#l39.333"></a><span id="l39.333" class="difflineminus">-      this._incomingDataBuffer = this._incomingDataBuffer</span>
<a href="#l39.334"></a><span id="l39.334" class="difflineminus">-                                     .concat(this._binaryInputStream</span>
<a href="#l39.335"></a><span id="l39.335" class="difflineminus">-                                                 .readByteArray(aCount));</span>
<a href="#l39.336"></a><span id="l39.336" class="difflineplus">+      this._incomingDataBuffer = this._incomingDataBuffer.concat(</span>
<a href="#l39.337"></a><span id="l39.337" class="difflineplus">+        this._binaryInputStream.readByteArray(aCount)</span>
<a href="#l39.338"></a><span id="l39.338" class="difflineplus">+      );</span>
<a href="#l39.339"></a><span id="l39.339"> </span>
<a href="#l39.340"></a><span id="l39.340">       let size = this._incomingDataBuffer.length;</span>
<a href="#l39.341"></a><span id="l39.341"> </span>
<a href="#l39.342"></a><span id="l39.342">       // Create a new ArrayBuffer.</span>
<a href="#l39.343"></a><span id="l39.343">       let buffer = new ArrayBuffer(size);</span>
<a href="#l39.344"></a><span id="l39.344">       let uintArray = new Uint8Array(buffer);</span>
<a href="#l39.345"></a><span id="l39.345"> </span>
<a href="#l39.346"></a><span id="l39.346">       // Set the data into the array while saving the extra data.</span>
<a href="#l39.347"></a><span id="l39.347">       uintArray.set(this._incomingDataBuffer);</span>
<a href="#l39.348"></a><span id="l39.348"> </span>
<a href="#l39.349"></a><span id="l39.349">       // Notify we've received data.</span>
<a href="#l39.350"></a><span id="l39.350">       // Variable data size, the callee must return how much data was handled.</span>
<a href="#l39.351"></a><span id="l39.351">       size = this.onBinaryDataReceived(buffer);</span>
<a href="#l39.352"></a><span id="l39.352"> </span>
<a href="#l39.353"></a><span id="l39.353">       // Remove the handled data.</span>
<a href="#l39.354"></a><span id="l39.354">       this._incomingDataBuffer.splice(0, size);</span>
<a href="#l39.355"></a><span id="l39.355" class="difflineminus">-    }</span>
<a href="#l39.356"></a><span id="l39.356" class="difflineminus">-    else {</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineplus">+    } else {</span>
<a href="#l39.358"></a><span id="l39.358">       if (this.delimiter) {</span>
<a href="#l39.359"></a><span id="l39.359">         // Load the data from the stream.</span>
<a href="#l39.360"></a><span id="l39.360">         this._incomingDataBuffer += this._scriptableInputStream.read(aCount);</span>
<a href="#l39.361"></a><span id="l39.361">         let data = this._incomingDataBuffer.split(this.delimiter);</span>
<a href="#l39.362"></a><span id="l39.362"> </span>
<a href="#l39.363"></a><span id="l39.363">         // Store the (possibly) incomplete part.</span>
<a href="#l39.364"></a><span id="l39.364">         this._incomingDataBuffer = data.pop();</span>
<a href="#l39.365"></a><span id="l39.365" class="difflineminus">-        if (!data.length)</span>
<a href="#l39.366"></a><span id="l39.366" class="difflineplus">+        if (!data.length) {</span>
<a href="#l39.367"></a><span id="l39.367">           return;</span>
<a href="#l39.368"></a><span id="l39.368" class="difflineplus">+        }</span>
<a href="#l39.369"></a><span id="l39.369"> </span>
<a href="#l39.370"></a><span id="l39.370">         // Add the strings to the queue.</span>
<a href="#l39.371"></a><span id="l39.371">         this._pendingData = this._pendingData.concat(data);</span>
<a href="#l39.372"></a><span id="l39.372" class="difflineminus">-      }</span>
<a href="#l39.373"></a><span id="l39.373" class="difflineminus">-      else {</span>
<a href="#l39.374"></a><span id="l39.374" class="difflineplus">+      } else {</span>
<a href="#l39.375"></a><span id="l39.375">         // Add the whole string to the queue.</span>
<a href="#l39.376"></a><span id="l39.376">         this._pendingData.push(this._scriptableInputStream.read(aCount));</span>
<a href="#l39.377"></a><span id="l39.377">       }</span>
<a href="#l39.378"></a><span id="l39.378">       this._activateQueue();</span>
<a href="#l39.379"></a><span id="l39.379">     }</span>
<a href="#l39.380"></a><span id="l39.380">   },</span>
<a href="#l39.381"></a><span id="l39.381"> </span>
<a href="#l39.382"></a><span id="l39.382">   _pendingData: [],</span>
<a href="#l39.383"></a><span id="l39.383">   _handlingQueue: false,</span>
<a href="#l39.384"></a><span id="l39.384">   _activateQueue() {</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineminus">-    if (this._handlingQueue)</span>
<a href="#l39.386"></a><span id="l39.386" class="difflineplus">+    if (this._handlingQueue) {</span>
<a href="#l39.387"></a><span id="l39.387">       return;</span>
<a href="#l39.388"></a><span id="l39.388" class="difflineminus">-    this._handlingQueue =</span>
<a href="#l39.389"></a><span id="l39.389" class="difflineminus">-      this.window.requestIdleCallback(this._handleQueue.bind(this));</span>
<a href="#l39.390"></a><span id="l39.390" class="difflineplus">+    }</span>
<a href="#l39.391"></a><span id="l39.391" class="difflineplus">+    this._handlingQueue = this.window.requestIdleCallback(</span>
<a href="#l39.392"></a><span id="l39.392" class="difflineplus">+      this._handleQueue.bind(this)</span>
<a href="#l39.393"></a><span id="l39.393" class="difflineplus">+    );</span>
<a href="#l39.394"></a><span id="l39.394">   },</span>
<a href="#l39.395"></a><span id="l39.395">   // Asynchronously send each string to the handle data function.</span>
<a href="#l39.396"></a><span id="l39.396">   _handleQueue(timing) {</span>
<a href="#l39.397"></a><span id="l39.397">     while (this._pendingData.length) {</span>
<a href="#l39.398"></a><span id="l39.398">       this.onDataReceived(this._pendingData.shift());</span>
<a href="#l39.399"></a><span id="l39.399">       // One pendingData entry generally takes less than 1ms to handle.</span>
<a href="#l39.400"></a><span id="l39.400" class="difflineminus">-      if (timing.timeRemaining() &lt; 1)</span>
<a href="#l39.401"></a><span id="l39.401" class="difflineplus">+      if (timing.timeRemaining() &lt; 1) {</span>
<a href="#l39.402"></a><span id="l39.402">         break;</span>
<a href="#l39.403"></a><span id="l39.403" class="difflineplus">+      }</span>
<a href="#l39.404"></a><span id="l39.404">     }</span>
<a href="#l39.405"></a><span id="l39.405">     if (this._pendingData.length) {</span>
<a href="#l39.406"></a><span id="l39.406" class="difflineminus">-      this._handlingQueue =</span>
<a href="#l39.407"></a><span id="l39.407" class="difflineminus">-        this.window.requestIdleCallback(this._handleQueue.bind(this));</span>
<a href="#l39.408"></a><span id="l39.408" class="difflineplus">+      this._handlingQueue = this.window.requestIdleCallback(</span>
<a href="#l39.409"></a><span id="l39.409" class="difflineplus">+        this._handleQueue.bind(this)</span>
<a href="#l39.410"></a><span id="l39.410" class="difflineplus">+      );</span>
<a href="#l39.411"></a><span id="l39.411">       return;</span>
<a href="#l39.412"></a><span id="l39.412">     }</span>
<a href="#l39.413"></a><span id="l39.413">     delete this._handlingQueue;</span>
<a href="#l39.414"></a><span id="l39.414">     // If there was a stop request, handle it.</span>
<a href="#l39.415"></a><span id="l39.415" class="difflineminus">-    if (&quot;_stopRequestStatus&quot; in this)</span>
<a href="#l39.416"></a><span id="l39.416" class="difflineplus">+    if (&quot;_stopRequestStatus&quot; in this) {</span>
<a href="#l39.417"></a><span id="l39.417">       this._handleStopRequest(this._stopRequestStatus);</span>
<a href="#l39.418"></a><span id="l39.418" class="difflineplus">+    }</span>
<a href="#l39.419"></a><span id="l39.419">   },</span>
<a href="#l39.420"></a><span id="l39.420"> </span>
<a href="#l39.421"></a><span id="l39.421">   /*</span>
<a href="#l39.422"></a><span id="l39.422">    * nsIRequestObserver methods</span>
<a href="#l39.423"></a><span id="l39.423">    */</span>
<a href="#l39.424"></a><span id="l39.424">   // Signifies the beginning of an async request</span>
<a href="#l39.425"></a><span id="l39.425">   onStartRequest(aRequest) {</span>
<a href="#l39.426"></a><span id="l39.426">     if (this.disconnected) {</span>
<a href="#l39.427"></a><span id="l39.427" class="difflineat">@@ -456,33 +502,51 @@ var Socket = {</span>
<a href="#l39.428"></a><span id="l39.428"> </span>
<a href="#l39.429"></a><span id="l39.429">     this.DEBUG(&quot;onStopRequest (&quot; + aStatus + &quot;)&quot;);</span>
<a href="#l39.430"></a><span id="l39.430">     this._stopRequestStatus = aStatus;</span>
<a href="#l39.431"></a><span id="l39.431">     // The stop request will be handled when the queue is next empty.</span>
<a href="#l39.432"></a><span id="l39.432">     this._activateQueue();</span>
<a href="#l39.433"></a><span id="l39.433">   },</span>
<a href="#l39.434"></a><span id="l39.434">   // Close the connection after receiving a stop request.</span>
<a href="#l39.435"></a><span id="l39.435">   _handleStopRequest(aStatus) {</span>
<a href="#l39.436"></a><span id="l39.436" class="difflineminus">-    if (this.disconnected)</span>
<a href="#l39.437"></a><span id="l39.437" class="difflineplus">+    if (this.disconnected) {</span>
<a href="#l39.438"></a><span id="l39.438">       return;</span>
<a href="#l39.439"></a><span id="l39.439" class="difflineplus">+    }</span>
<a href="#l39.440"></a><span id="l39.440">     this.disconnected = true;</span>
<a href="#l39.441"></a><span id="l39.441" class="difflineminus">-    if (aStatus == NS_ERROR_NET_RESET)</span>
<a href="#l39.442"></a><span id="l39.442" class="difflineplus">+    if (aStatus == NS_ERROR_NET_RESET) {</span>
<a href="#l39.443"></a><span id="l39.443">       this.onConnectionReset();</span>
<a href="#l39.444"></a><span id="l39.444" class="difflineminus">-    else if (aStatus == NS_ERROR_NET_TIMEOUT)</span>
<a href="#l39.445"></a><span id="l39.445" class="difflineplus">+    } else if (aStatus == NS_ERROR_NET_TIMEOUT) {</span>
<a href="#l39.446"></a><span id="l39.446">       this.onConnectionTimedOut();</span>
<a href="#l39.447"></a><span id="l39.447" class="difflineminus">-    else if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l39.448"></a><span id="l39.448" class="difflineminus">-      let nssErrorsService =</span>
<a href="#l39.449"></a><span id="l39.449" class="difflineminus">-        Cc[&quot;@mozilla.org/nss_errors_service;1&quot;].getService(Ci.nsINSSErrorsService);</span>
<a href="#l39.450"></a><span id="l39.450" class="difflineminus">-      if ((aStatus &lt;= nssErrorsService.getXPCOMFromNSSError(nssErrorsService.NSS_SEC_ERROR_BASE) &amp;&amp;</span>
<a href="#l39.451"></a><span id="l39.451" class="difflineminus">-           aStatus &gt;= nssErrorsService.getXPCOMFromNSSError(nssErrorsService.NSS_SEC_ERROR_LIMIT - 1)) ||</span>
<a href="#l39.452"></a><span id="l39.452" class="difflineminus">-          (aStatus &lt;= nssErrorsService.getXPCOMFromNSSError(nssErrorsService.NSS_SSL_ERROR_BASE) &amp;&amp;</span>
<a href="#l39.453"></a><span id="l39.453" class="difflineminus">-           aStatus &gt;= nssErrorsService.getXPCOMFromNSSError(nssErrorsService.NSS_SSL_ERROR_LIMIT - 1))) {</span>
<a href="#l39.454"></a><span id="l39.454" class="difflineminus">-        this.onBadCertificate(nssErrorsService.getErrorClass(aStatus) ==</span>
<a href="#l39.455"></a><span id="l39.455" class="difflineminus">-                              nssErrorsService.ERROR_CLASS_SSL_PROTOCOL,</span>
<a href="#l39.456"></a><span id="l39.456" class="difflineminus">-                              nssErrorsService.getErrorMessage(aStatus));</span>
<a href="#l39.457"></a><span id="l39.457" class="difflineplus">+    } else if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l39.458"></a><span id="l39.458" class="difflineplus">+      let nssErrorsService = Cc[&quot;@mozilla.org/nss_errors_service;1&quot;].getService(</span>
<a href="#l39.459"></a><span id="l39.459" class="difflineplus">+        Ci.nsINSSErrorsService</span>
<a href="#l39.460"></a><span id="l39.460" class="difflineplus">+      );</span>
<a href="#l39.461"></a><span id="l39.461" class="difflineplus">+      if (</span>
<a href="#l39.462"></a><span id="l39.462" class="difflineplus">+        (aStatus &lt;=</span>
<a href="#l39.463"></a><span id="l39.463" class="difflineplus">+          nssErrorsService.getXPCOMFromNSSError(</span>
<a href="#l39.464"></a><span id="l39.464" class="difflineplus">+            nssErrorsService.NSS_SEC_ERROR_BASE</span>
<a href="#l39.465"></a><span id="l39.465" class="difflineplus">+          ) &amp;&amp;</span>
<a href="#l39.466"></a><span id="l39.466" class="difflineplus">+          aStatus &gt;=</span>
<a href="#l39.467"></a><span id="l39.467" class="difflineplus">+            nssErrorsService.getXPCOMFromNSSError(</span>
<a href="#l39.468"></a><span id="l39.468" class="difflineplus">+              nssErrorsService.NSS_SEC_ERROR_LIMIT - 1</span>
<a href="#l39.469"></a><span id="l39.469" class="difflineplus">+            )) ||</span>
<a href="#l39.470"></a><span id="l39.470" class="difflineplus">+        (aStatus &lt;=</span>
<a href="#l39.471"></a><span id="l39.471" class="difflineplus">+          nssErrorsService.getXPCOMFromNSSError(</span>
<a href="#l39.472"></a><span id="l39.472" class="difflineplus">+            nssErrorsService.NSS_SSL_ERROR_BASE</span>
<a href="#l39.473"></a><span id="l39.473" class="difflineplus">+          ) &amp;&amp;</span>
<a href="#l39.474"></a><span id="l39.474" class="difflineplus">+          aStatus &gt;=</span>
<a href="#l39.475"></a><span id="l39.475" class="difflineplus">+            nssErrorsService.getXPCOMFromNSSError(</span>
<a href="#l39.476"></a><span id="l39.476" class="difflineplus">+              nssErrorsService.NSS_SSL_ERROR_LIMIT - 1</span>
<a href="#l39.477"></a><span id="l39.477" class="difflineplus">+            ))</span>
<a href="#l39.478"></a><span id="l39.478" class="difflineplus">+      ) {</span>
<a href="#l39.479"></a><span id="l39.479" class="difflineplus">+        this.onBadCertificate(</span>
<a href="#l39.480"></a><span id="l39.480" class="difflineplus">+          nssErrorsService.getErrorClass(aStatus) ==</span>
<a href="#l39.481"></a><span id="l39.481" class="difflineplus">+            nssErrorsService.ERROR_CLASS_SSL_PROTOCOL,</span>
<a href="#l39.482"></a><span id="l39.482" class="difflineplus">+          nssErrorsService.getErrorMessage(aStatus)</span>
<a href="#l39.483"></a><span id="l39.483" class="difflineplus">+        );</span>
<a href="#l39.484"></a><span id="l39.484">         return;</span>
<a href="#l39.485"></a><span id="l39.485">       }</span>
<a href="#l39.486"></a><span id="l39.486">     }</span>
<a href="#l39.487"></a><span id="l39.487">     this.onConnectionClosed();</span>
<a href="#l39.488"></a><span id="l39.488">   },</span>
<a href="#l39.489"></a><span id="l39.489"> </span>
<a href="#l39.490"></a><span id="l39.490">   /*</span>
<a href="#l39.491"></a><span id="l39.491">    * nsIBadCertListener2</span>
<a href="#l39.492"></a><span id="l39.492" class="difflineat">@@ -496,30 +560,33 @@ var Socket = {</span>
<a href="#l39.493"></a><span id="l39.493"> </span>
<a href="#l39.494"></a><span id="l39.494">   /*</span>
<a href="#l39.495"></a><span id="l39.495">    * nsITransportEventSink methods</span>
<a href="#l39.496"></a><span id="l39.496">    */</span>
<a href="#l39.497"></a><span id="l39.497">   onTransportStatus(aTransport, aStatus, aProgress, aProgressmax) {</span>
<a href="#l39.498"></a><span id="l39.498">     // Don't send status change notifications after the socket has been closed.</span>
<a href="#l39.499"></a><span id="l39.499">     // The event sink can't be removed after opening the transport, so we can't</span>
<a href="#l39.500"></a><span id="l39.500">     // do better than adding a null check here.</span>
<a href="#l39.501"></a><span id="l39.501" class="difflineminus">-    if (!this.transport)</span>
<a href="#l39.502"></a><span id="l39.502" class="difflineplus">+    if (!this.transport) {</span>
<a href="#l39.503"></a><span id="l39.503">       return;</span>
<a href="#l39.504"></a><span id="l39.504" class="difflineplus">+    }</span>
<a href="#l39.505"></a><span id="l39.505"> </span>
<a href="#l39.506"></a><span id="l39.506">     const nsITransportEventSinkStatus = {</span>
<a href="#l39.507"></a><span id="l39.507" class="difflineminus">-         0x804b0003: &quot;STATUS_RESOLVING&quot;,</span>
<a href="#l39.508"></a><span id="l39.508" class="difflineminus">-         0x804b000b: &quot;STATUS_RESOLVED&quot;,</span>
<a href="#l39.509"></a><span id="l39.509" class="difflineminus">-         0x804b0007: &quot;STATUS_CONNECTING_TO&quot;,</span>
<a href="#l39.510"></a><span id="l39.510" class="difflineminus">-         0x804b0004: &quot;STATUS_CONNECTED_TO&quot;,</span>
<a href="#l39.511"></a><span id="l39.511" class="difflineminus">-         0x804b0005: &quot;STATUS_SENDING_TO&quot;,</span>
<a href="#l39.512"></a><span id="l39.512" class="difflineminus">-         0x804b000a: &quot;STATUS_WAITING_FOR&quot;,</span>
<a href="#l39.513"></a><span id="l39.513" class="difflineminus">-         0x804b0006: &quot;STATUS_RECEIVING_FROM&quot;,</span>
<a href="#l39.514"></a><span id="l39.514" class="difflineplus">+      0x804b0003: &quot;STATUS_RESOLVING&quot;,</span>
<a href="#l39.515"></a><span id="l39.515" class="difflineplus">+      0x804b000b: &quot;STATUS_RESOLVED&quot;,</span>
<a href="#l39.516"></a><span id="l39.516" class="difflineplus">+      0x804b0007: &quot;STATUS_CONNECTING_TO&quot;,</span>
<a href="#l39.517"></a><span id="l39.517" class="difflineplus">+      0x804b0004: &quot;STATUS_CONNECTED_TO&quot;,</span>
<a href="#l39.518"></a><span id="l39.518" class="difflineplus">+      0x804b0005: &quot;STATUS_SENDING_TO&quot;,</span>
<a href="#l39.519"></a><span id="l39.519" class="difflineplus">+      0x804b000a: &quot;STATUS_WAITING_FOR&quot;,</span>
<a href="#l39.520"></a><span id="l39.520" class="difflineplus">+      0x804b0006: &quot;STATUS_RECEIVING_FROM&quot;,</span>
<a href="#l39.521"></a><span id="l39.521">     };</span>
<a href="#l39.522"></a><span id="l39.522">     let status = nsITransportEventSinkStatus[aStatus];</span>
<a href="#l39.523"></a><span id="l39.523" class="difflineminus">-    this.DEBUG(&quot;onTransportStatus(&quot; + (status || (&quot;0x&quot; + aStatus.toString(16))) + &quot;)&quot;);</span>
<a href="#l39.524"></a><span id="l39.524" class="difflineplus">+    this.DEBUG(</span>
<a href="#l39.525"></a><span id="l39.525" class="difflineplus">+      &quot;onTransportStatus(&quot; + (status || &quot;0x&quot; + aStatus.toString(16)) + &quot;)&quot;</span>
<a href="#l39.526"></a><span id="l39.526" class="difflineplus">+    );</span>
<a href="#l39.527"></a><span id="l39.527"> </span>
<a href="#l39.528"></a><span id="l39.528">     if (status == &quot;STATUS_CONNECTED_TO&quot;) {</span>
<a href="#l39.529"></a><span id="l39.529">       // Notify that the connection has been established.</span>
<a href="#l39.530"></a><span id="l39.530">       this.onConnection();</span>
<a href="#l39.531"></a><span id="l39.531">     }</span>
<a href="#l39.532"></a><span id="l39.532">   },</span>
<a href="#l39.533"></a><span id="l39.533"> </span>
<a href="#l39.534"></a><span id="l39.534">   /*</span>
<a href="#l39.535"></a><span id="l39.535" class="difflineat">@@ -536,115 +603,139 @@ var Socket = {</span>
<a href="#l39.536"></a><span id="l39.536">     this.proxy = aProxy;</span>
<a href="#l39.537"></a><span id="l39.537"> </span>
<a href="#l39.538"></a><span id="l39.538">     // Empty incoming and outgoing data storage buffers</span>
<a href="#l39.539"></a><span id="l39.539">     this._resetBuffers();</span>
<a href="#l39.540"></a><span id="l39.540"> </span>
<a href="#l39.541"></a><span id="l39.541">     // Create a routed socket transport</span>
<a href="#l39.542"></a><span id="l39.542">     // We connect to host and port, but the origin host and origin port are</span>
<a href="#l39.543"></a><span id="l39.543">     // given to PSM (e.g. check the certificate).</span>
<a href="#l39.544"></a><span id="l39.544" class="difflineminus">-    let socketTS = Cc[&quot;@mozilla.org/network/socket-transport-service;1&quot;]</span>
<a href="#l39.545"></a><span id="l39.545" class="difflineminus">-                      .getService(Ci.nsIRoutedSocketTransportService);</span>
<a href="#l39.546"></a><span id="l39.546" class="difflineminus">-    this.transport =</span>
<a href="#l39.547"></a><span id="l39.547" class="difflineminus">-      socketTS.createRoutedTransport(this.security,</span>
<a href="#l39.548"></a><span id="l39.548" class="difflineminus">-                                     this.originHost, this.originPort,</span>
<a href="#l39.549"></a><span id="l39.549" class="difflineminus">-                                     this.host, this.port,</span>
<a href="#l39.550"></a><span id="l39.550" class="difflineminus">-                                     this.proxy);</span>
<a href="#l39.551"></a><span id="l39.551" class="difflineplus">+    let socketTS = Cc[</span>
<a href="#l39.552"></a><span id="l39.552" class="difflineplus">+      &quot;@mozilla.org/network/socket-transport-service;1&quot;</span>
<a href="#l39.553"></a><span id="l39.553" class="difflineplus">+    ].getService(Ci.nsIRoutedSocketTransportService);</span>
<a href="#l39.554"></a><span id="l39.554" class="difflineplus">+    this.transport = socketTS.createRoutedTransport(</span>
<a href="#l39.555"></a><span id="l39.555" class="difflineplus">+      this.security,</span>
<a href="#l39.556"></a><span id="l39.556" class="difflineplus">+      this.originHost,</span>
<a href="#l39.557"></a><span id="l39.557" class="difflineplus">+      this.originPort,</span>
<a href="#l39.558"></a><span id="l39.558" class="difflineplus">+      this.host,</span>
<a href="#l39.559"></a><span id="l39.559" class="difflineplus">+      this.port,</span>
<a href="#l39.560"></a><span id="l39.560" class="difflineplus">+      this.proxy</span>
<a href="#l39.561"></a><span id="l39.561" class="difflineplus">+    );</span>
<a href="#l39.562"></a><span id="l39.562"> </span>
<a href="#l39.563"></a><span id="l39.563">     this._openStreams();</span>
<a href="#l39.564"></a><span id="l39.564">   },</span>
<a href="#l39.565"></a><span id="l39.565"> </span>
<a href="#l39.566"></a><span id="l39.566">   // Open the incoming and outgoing streams, and init the nsISocketTransport.</span>
<a href="#l39.567"></a><span id="l39.567">   _openStreams() {</span>
<a href="#l39.568"></a><span id="l39.568">     // Security notification callbacks (must support nsIBadCertListener2</span>
<a href="#l39.569"></a><span id="l39.569">     // for SSL connections, and possibly other interfaces).</span>
<a href="#l39.570"></a><span id="l39.570">     this.transport.securityCallbacks = this;</span>
<a href="#l39.571"></a><span id="l39.571"> </span>
<a href="#l39.572"></a><span id="l39.572">     // Set the timeouts for the nsISocketTransport for both a connect event and</span>
<a href="#l39.573"></a><span id="l39.573">     // a read/write. Only set them if the user has provided them.</span>
<a href="#l39.574"></a><span id="l39.574">     if (this.connectTimeout) {</span>
<a href="#l39.575"></a><span id="l39.575" class="difflineminus">-      this.transport.setTimeout(Ci.nsISocketTransport.TIMEOUT_CONNECT,</span>
<a href="#l39.576"></a><span id="l39.576" class="difflineminus">-                                this.connectTimeout);</span>
<a href="#l39.577"></a><span id="l39.577" class="difflineplus">+      this.transport.setTimeout(</span>
<a href="#l39.578"></a><span id="l39.578" class="difflineplus">+        Ci.nsISocketTransport.TIMEOUT_CONNECT,</span>
<a href="#l39.579"></a><span id="l39.579" class="difflineplus">+        this.connectTimeout</span>
<a href="#l39.580"></a><span id="l39.580" class="difflineplus">+      );</span>
<a href="#l39.581"></a><span id="l39.581">     }</span>
<a href="#l39.582"></a><span id="l39.582">     if (this.readWriteTimeout) {</span>
<a href="#l39.583"></a><span id="l39.583" class="difflineminus">-      this.transport.setTimeout(Ci.nsISocketTransport.TIMEOUT_READ_WRITE,</span>
<a href="#l39.584"></a><span id="l39.584" class="difflineminus">-                                this.readWriteTimeout);</span>
<a href="#l39.585"></a><span id="l39.585" class="difflineplus">+      this.transport.setTimeout(</span>
<a href="#l39.586"></a><span id="l39.586" class="difflineplus">+        Ci.nsISocketTransport.TIMEOUT_READ_WRITE,</span>
<a href="#l39.587"></a><span id="l39.587" class="difflineplus">+        this.readWriteTimeout</span>
<a href="#l39.588"></a><span id="l39.588" class="difflineplus">+      );</span>
<a href="#l39.589"></a><span id="l39.589">     }</span>
<a href="#l39.590"></a><span id="l39.590"> </span>
<a href="#l39.591"></a><span id="l39.591">     this.transport.setEventSink(this, Services.tm.currentThread);</span>
<a href="#l39.592"></a><span id="l39.592"> </span>
<a href="#l39.593"></a><span id="l39.593">     // No limit on the output stream buffer</span>
<a href="#l39.594"></a><span id="l39.594" class="difflineminus">-    this._outputStream =</span>
<a href="#l39.595"></a><span id="l39.595" class="difflineminus">-      this.transport.openOutputStream(0, this.outputSegmentSize, -1);</span>
<a href="#l39.596"></a><span id="l39.596" class="difflineminus">-    if (!this._outputStream)</span>
<a href="#l39.597"></a><span id="l39.597" class="difflineplus">+    this._outputStream = this.transport.openOutputStream(</span>
<a href="#l39.598"></a><span id="l39.598" class="difflineplus">+      0,</span>
<a href="#l39.599"></a><span id="l39.599" class="difflineplus">+      this.outputSegmentSize,</span>
<a href="#l39.600"></a><span id="l39.600" class="difflineplus">+      -1</span>
<a href="#l39.601"></a><span id="l39.601" class="difflineplus">+    );</span>
<a href="#l39.602"></a><span id="l39.602" class="difflineplus">+    if (!this._outputStream) {</span>
<a href="#l39.603"></a><span id="l39.603">       throw new Error(&quot;Error getting output stream.&quot;);</span>
<a href="#l39.604"></a><span id="l39.604" class="difflineplus">+    }</span>
<a href="#l39.605"></a><span id="l39.605"> </span>
<a href="#l39.606"></a><span id="l39.606" class="difflineminus">-    this._inputStream = this.transport.openInputStream(0, // flags</span>
<a href="#l39.607"></a><span id="l39.607" class="difflineminus">-                                                       0, // Use default segment size</span>
<a href="#l39.608"></a><span id="l39.608" class="difflineminus">-                                                       0); // Use default segment count</span>
<a href="#l39.609"></a><span id="l39.609" class="difflineminus">-    if (!this._inputStream)</span>
<a href="#l39.610"></a><span id="l39.610" class="difflineplus">+    this._inputStream = this.transport.openInputStream(</span>
<a href="#l39.611"></a><span id="l39.611" class="difflineplus">+      0, // flags</span>
<a href="#l39.612"></a><span id="l39.612" class="difflineplus">+      0, // Use default segment size</span>
<a href="#l39.613"></a><span id="l39.613" class="difflineplus">+      0</span>
<a href="#l39.614"></a><span id="l39.614" class="difflineplus">+    ); // Use default segment count</span>
<a href="#l39.615"></a><span id="l39.615" class="difflineplus">+    if (!this._inputStream) {</span>
<a href="#l39.616"></a><span id="l39.616">       throw new Error(&quot;Error getting input stream.&quot;);</span>
<a href="#l39.617"></a><span id="l39.617" class="difflineplus">+    }</span>
<a href="#l39.618"></a><span id="l39.618"> </span>
<a href="#l39.619"></a><span id="l39.619">     if (this.binaryMode) {</span>
<a href="#l39.620"></a><span id="l39.620">       // Handle binary mode</span>
<a href="#l39.621"></a><span id="l39.621">       this._binaryInputStream = new BinaryInputStream(this._inputStream);</span>
<a href="#l39.622"></a><span id="l39.622">       this._binaryOutputStream = new BinaryOutputStream(this._outputStream);</span>
<a href="#l39.623"></a><span id="l39.623">     } else {</span>
<a href="#l39.624"></a><span id="l39.624">       // Handle character mode</span>
<a href="#l39.625"></a><span id="l39.625" class="difflineminus">-      this._scriptableInputStream =</span>
<a href="#l39.626"></a><span id="l39.626" class="difflineminus">-        new ScriptableInputStream(this._inputStream);</span>
<a href="#l39.627"></a><span id="l39.627" class="difflineplus">+      this._scriptableInputStream = new ScriptableInputStream(</span>
<a href="#l39.628"></a><span id="l39.628" class="difflineplus">+        this._inputStream</span>
<a href="#l39.629"></a><span id="l39.629" class="difflineplus">+      );</span>
<a href="#l39.630"></a><span id="l39.630">     }</span>
<a href="#l39.631"></a><span id="l39.631"> </span>
<a href="#l39.632"></a><span id="l39.632" class="difflineminus">-    this.pump = new InputStreamPump(this._inputStream, // Data to read</span>
<a href="#l39.633"></a><span id="l39.633" class="difflineminus">-                                    0, // Use default segment size</span>
<a href="#l39.634"></a><span id="l39.634" class="difflineminus">-                                    0, // Use default segment length</span>
<a href="#l39.635"></a><span id="l39.635" class="difflineminus">-                                    false); // Do not close when done</span>
<a href="#l39.636"></a><span id="l39.636" class="difflineplus">+    this.pump = new InputStreamPump(</span>
<a href="#l39.637"></a><span id="l39.637" class="difflineplus">+      this._inputStream, // Data to read</span>
<a href="#l39.638"></a><span id="l39.638" class="difflineplus">+      0, // Use default segment size</span>
<a href="#l39.639"></a><span id="l39.639" class="difflineplus">+      0, // Use default segment length</span>
<a href="#l39.640"></a><span id="l39.640" class="difflineplus">+      false</span>
<a href="#l39.641"></a><span id="l39.641" class="difflineplus">+    ); // Do not close when done</span>
<a href="#l39.642"></a><span id="l39.642">     this.pump.asyncRead(this, null);</span>
<a href="#l39.643"></a><span id="l39.643">   },</span>
<a href="#l39.644"></a><span id="l39.644"> </span>
<a href="#l39.645"></a><span id="l39.645">   _pingTimer: null,</span>
<a href="#l39.646"></a><span id="l39.646">   _disconnectTimer: null,</span>
<a href="#l39.647"></a><span id="l39.647">   _sendPing() {</span>
<a href="#l39.648"></a><span id="l39.648">     delete this._pingTimer;</span>
<a href="#l39.649"></a><span id="l39.649">     this.sendPing();</span>
<a href="#l39.650"></a><span id="l39.650" class="difflineminus">-    this._disconnectTimer = setTimeout(this.onConnectionTimedOut.bind(this),</span>
<a href="#l39.651"></a><span id="l39.651" class="difflineminus">-                                       this.kTimeAfterPingBeforeDisconnect);</span>
<a href="#l39.652"></a><span id="l39.652" class="difflineplus">+    this._disconnectTimer = setTimeout(</span>
<a href="#l39.653"></a><span id="l39.653" class="difflineplus">+      this.onConnectionTimedOut.bind(this),</span>
<a href="#l39.654"></a><span id="l39.654" class="difflineplus">+      this.kTimeAfterPingBeforeDisconnect</span>
<a href="#l39.655"></a><span id="l39.655" class="difflineplus">+    );</span>
<a href="#l39.656"></a><span id="l39.656">   },</span>
<a href="#l39.657"></a><span id="l39.657"> </span>
<a href="#l39.658"></a><span id="l39.658">   /*</span>
<a href="#l39.659"></a><span id="l39.659">    *****************************************************************************</span>
<a href="#l39.660"></a><span id="l39.660">    ********************* Methods for subtypes to override **********************</span>
<a href="#l39.661"></a><span id="l39.661">    *****************************************************************************</span>
<a href="#l39.662"></a><span id="l39.662">    */</span>
<a href="#l39.663"></a><span id="l39.663" class="difflineminus">-  LOG(aString) { },</span>
<a href="#l39.664"></a><span id="l39.664" class="difflineminus">-  DEBUG(aString) { },</span>
<a href="#l39.665"></a><span id="l39.665" class="difflineplus">+  LOG(aString) {},</span>
<a href="#l39.666"></a><span id="l39.666" class="difflineplus">+  DEBUG(aString) {},</span>
<a href="#l39.667"></a><span id="l39.667">   // Called when a connection is established.</span>
<a href="#l39.668"></a><span id="l39.668" class="difflineminus">-  onConnection() { },</span>
<a href="#l39.669"></a><span id="l39.669" class="difflineplus">+  onConnection() {},</span>
<a href="#l39.670"></a><span id="l39.670">   // Called when a socket is accepted after listening.</span>
<a href="#l39.671"></a><span id="l39.671" class="difflineminus">-  onConnectionHeard() { },</span>
<a href="#l39.672"></a><span id="l39.672" class="difflineplus">+  onConnectionHeard() {},</span>
<a href="#l39.673"></a><span id="l39.673">   // Called when a connection times out.</span>
<a href="#l39.674"></a><span id="l39.674" class="difflineminus">-  onConnectionTimedOut() { },</span>
<a href="#l39.675"></a><span id="l39.675" class="difflineplus">+  onConnectionTimedOut() {},</span>
<a href="#l39.676"></a><span id="l39.676">   // Called when a socket request's network is reset.</span>
<a href="#l39.677"></a><span id="l39.677" class="difflineminus">-  onConnectionReset() { },</span>
<a href="#l39.678"></a><span id="l39.678" class="difflineplus">+  onConnectionReset() {},</span>
<a href="#l39.679"></a><span id="l39.679">   // Called when the certificate provided by the server didn't satisfy NSS.</span>
<a href="#l39.680"></a><span id="l39.680" class="difflineminus">-  onBadCertificate(aNSSErrorMessage) { },</span>
<a href="#l39.681"></a><span id="l39.681" class="difflineplus">+  onBadCertificate(aNSSErrorMessage) {},</span>
<a href="#l39.682"></a><span id="l39.682">   // Called when the other end has closed the connection.</span>
<a href="#l39.683"></a><span id="l39.683" class="difflineminus">-  onConnectionClosed() { },</span>
<a href="#l39.684"></a><span id="l39.684" class="difflineplus">+  onConnectionClosed() {},</span>
<a href="#l39.685"></a><span id="l39.685"> </span>
<a href="#l39.686"></a><span id="l39.686">   // Called when ASCII data is available.</span>
<a href="#l39.687"></a><span id="l39.687" class="difflineminus">-  onDataReceived(/* string */ aData) { },</span>
<a href="#l39.688"></a><span id="l39.688" class="difflineplus">+  onDataReceived(/* string */ aData) {},</span>
<a href="#l39.689"></a><span id="l39.689"> </span>
<a href="#l39.690"></a><span id="l39.690">   // Called when binary data is available.</span>
<a href="#l39.691"></a><span id="l39.691" class="difflineminus">-  onBinaryDataReceived(/* ArrayBuffer */ aData) { },</span>
<a href="#l39.692"></a><span id="l39.692" class="difflineplus">+  onBinaryDataReceived(/* ArrayBuffer */ aData) {},</span>
<a href="#l39.693"></a><span id="l39.693"> </span>
<a href="#l39.694"></a><span id="l39.694">   // If using the ping functionality, this is called when a new ping message</span>
<a href="#l39.695"></a><span id="l39.695">   // should be sent on the socket.</span>
<a href="#l39.696"></a><span id="l39.696" class="difflineminus">-  sendPing() { },</span>
<a href="#l39.697"></a><span id="l39.697" class="difflineplus">+  sendPing() {},</span>
<a href="#l39.698"></a><span id="l39.698"> </span>
<a href="#l39.699"></a><span id="l39.699">   /* QueryInterface and nsIInterfaceRequestor implementations */</span>
<a href="#l39.700"></a><span id="l39.700" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIStreamListener&quot;,</span>
<a href="#l39.701"></a><span id="l39.701" class="difflineminus">-                                          &quot;nsIRequestObserver&quot;,</span>
<a href="#l39.702"></a><span id="l39.702" class="difflineminus">-                                          &quot;nsITransportEventSink&quot;,</span>
<a href="#l39.703"></a><span id="l39.703" class="difflineminus">-                                          &quot;nsIBadCertListener2&quot;,</span>
<a href="#l39.704"></a><span id="l39.704" class="difflineminus">-                                          &quot;nsIProtocolProxyCallback&quot;]),</span>
<a href="#l39.705"></a><span id="l39.705" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l39.706"></a><span id="l39.706" class="difflineplus">+    &quot;nsIStreamListener&quot;,</span>
<a href="#l39.707"></a><span id="l39.707" class="difflineplus">+    &quot;nsIRequestObserver&quot;,</span>
<a href="#l39.708"></a><span id="l39.708" class="difflineplus">+    &quot;nsITransportEventSink&quot;,</span>
<a href="#l39.709"></a><span id="l39.709" class="difflineplus">+    &quot;nsIBadCertListener2&quot;,</span>
<a href="#l39.710"></a><span id="l39.710" class="difflineplus">+    &quot;nsIProtocolProxyCallback&quot;,</span>
<a href="#l39.711"></a><span id="l39.711" class="difflineplus">+  ]),</span>
<a href="#l39.712"></a><span id="l39.712"> </span>
<a href="#l39.713"></a><span id="l39.713" class="difflineminus">-  getInterface(iid) { return this.QueryInterface(iid); },</span>
<a href="#l39.714"></a><span id="l39.714" class="difflineplus">+  getInterface(iid) {</span>
<a href="#l39.715"></a><span id="l39.715" class="difflineplus">+    return this.QueryInterface(iid);</span>
<a href="#l39.716"></a><span id="l39.716" class="difflineplus">+  },</span>
<a href="#l39.717"></a><span id="l39.717"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/chat/modules/test/test_ArrayBufferUtils.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/chat/modules/test/test_ArrayBufferUtils.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -9,26 +9,28 @@ var {</span>
<a href="#l40.4"></a><span id="l40.4">   ArrayBufferToHexString,</span>
<a href="#l40.5"></a><span id="l40.5"> } = ChromeUtils.import(&quot;resource:///modules/ArrayBufferUtils.jsm&quot;);</span>
<a href="#l40.6"></a><span id="l40.6"> </span>
<a href="#l40.7"></a><span id="l40.7"> function do_check_arraybuffer_eq(a, b) {</span>
<a href="#l40.8"></a><span id="l40.8">   let viewA = new Uint8Array(a);</span>
<a href="#l40.9"></a><span id="l40.9">   let viewB = new Uint8Array(b);</span>
<a href="#l40.10"></a><span id="l40.10"> </span>
<a href="#l40.11"></a><span id="l40.11">   let res = a.byteLength == b.byteLength;</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  for (let i = 0; i &lt; viewA.byteLength; ++i)</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+  for (let i = 0; i &lt; viewA.byteLength; ++i) {</span>
<a href="#l40.14"></a><span id="l40.14">     res = res &amp;&amp; viewA[i] == viewB[i];</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+  }</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17">   Assert.ok(res);</span>
<a href="#l40.18"></a><span id="l40.18"> }</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20"> function do_check_array_eq(a, b) {</span>
<a href="#l40.21"></a><span id="l40.21">   let res = a.length == b.length;</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-  for (let i = 0; i &lt; a.length; ++i)</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+  for (let i = 0; i &lt; a.length; ++i) {</span>
<a href="#l40.24"></a><span id="l40.24">     res = res &amp;&amp; a[i] == b[i];</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+  }</span>
<a href="#l40.26"></a><span id="l40.26"> </span>
<a href="#l40.27"></a><span id="l40.27">   Assert.ok(res);</span>
<a href="#l40.28"></a><span id="l40.28"> }</span>
<a href="#l40.29"></a><span id="l40.29"> </span>
<a href="#l40.30"></a><span id="l40.30"> function test_ArrayBufferToBytes() {</span>
<a href="#l40.31"></a><span id="l40.31">   let expectedBytes = [0, 1, 0, 10, 0, 100, 3, 232];</span>
<a href="#l40.32"></a><span id="l40.32">   let expectedBuf = new ArrayBuffer(8);</span>
<a href="#l40.33"></a><span id="l40.33">   let view = new DataView(expectedBuf);</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineat">@@ -67,18 +69,19 @@ function test_StringToBytes() {</span>
<a href="#l40.35"></a><span id="l40.35"> }</span>
<a href="#l40.36"></a><span id="l40.36"> </span>
<a href="#l40.37"></a><span id="l40.37"> function test_ArrayBufferToString() {</span>
<a href="#l40.38"></a><span id="l40.38">   let testString = &quot;Hello world!&quot;;</span>
<a href="#l40.39"></a><span id="l40.39">   let byteString = StringToBytes(testString);</span>
<a href="#l40.40"></a><span id="l40.40"> </span>
<a href="#l40.41"></a><span id="l40.41">   let buf = new ArrayBuffer(byteString.length);</span>
<a href="#l40.42"></a><span id="l40.42">   let view = new DataView(buf);</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-  for (let i = 0; i &lt; byteString.length; ++i)</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+  for (let i = 0; i &lt; byteString.length; ++i) {</span>
<a href="#l40.45"></a><span id="l40.45">     view.setUint8(i, byteString[i]);</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+  }</span>
<a href="#l40.47"></a><span id="l40.47"> </span>
<a href="#l40.48"></a><span id="l40.48">   let str = ArrayBufferToString(buf);</span>
<a href="#l40.49"></a><span id="l40.49">   Assert.equal(str, testString);</span>
<a href="#l40.50"></a><span id="l40.50"> </span>
<a href="#l40.51"></a><span id="l40.51">   run_next_test();</span>
<a href="#l40.52"></a><span id="l40.52"> }</span>
<a href="#l40.53"></a><span id="l40.53"> </span>
<a href="#l40.54"></a><span id="l40.54"> function test_ArrayBufferToHexString() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/chat/modules/test/test_NormalizedMap.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/chat/modules/test/test_NormalizedMap.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l41.4"></a><span id="l41.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l41.5"></a><span id="l41.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7" class="difflineminus">-const {NormalizedMap} = ChromeUtils.import(&quot;resource:///modules/NormalizedMap.jsm&quot;);</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+const { NormalizedMap } = ChromeUtils.import(</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+  &quot;resource:///modules/NormalizedMap.jsm&quot;</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+);</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12"> function test_setter_getter() {</span>
<a href="#l41.13"></a><span id="l41.13">   let m = new NormalizedMap(aStr =&gt; aStr.toLowerCase());</span>
<a href="#l41.14"></a><span id="l41.14">   m.set(&quot;foo&quot;, &quot;bar&quot;);</span>
<a href="#l41.15"></a><span id="l41.15">   m.set(&quot;BaZ&quot;, &quot;blah&quot;);</span>
<a href="#l41.16"></a><span id="l41.16">   Assert.equal(m.has(&quot;FOO&quot;), true);</span>
<a href="#l41.17"></a><span id="l41.17">   Assert.equal(m.has(&quot;BaZ&quot;), true);</span>
<a href="#l41.18"></a><span id="l41.18">   Assert.equal(m.get(&quot;FOO&quot;), &quot;bar&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/chat/modules/test/test_filtering.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/chat/modules/test/test_filtering.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,25 +1,27 @@</span>
<a href="#l42.4"></a><span id="l42.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l42.5"></a><span id="l42.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l42.9"></a><span id="l42.9"> var {</span>
<a href="#l42.10"></a><span id="l42.10">   cleanupImMarkup,</span>
<a href="#l42.11"></a><span id="l42.11">   createDerivedRuleset,</span>
<a href="#l42.12"></a><span id="l42.12">   addGlobalAllowedTag,</span>
<a href="#l42.13"></a><span id="l42.13">   removeGlobalAllowedTag,</span>
<a href="#l42.14"></a><span id="l42.14">   addGlobalAllowedAttribute,</span>
<a href="#l42.15"></a><span id="l42.15">   removeGlobalAllowedAttribute,</span>
<a href="#l42.16"></a><span id="l42.16">   addGlobalAllowedStyleRule,</span>
<a href="#l42.17"></a><span id="l42.17">   removeGlobalAllowedStyleRule,</span>
<a href="#l42.18"></a><span id="l42.18"> } = ChromeUtils.import(&quot;resource:///modules/imContentSink.jsm&quot;);</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20"> var kModePref = &quot;messenger.options.filterMode&quot;;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-var kStrictMode = 0, kStandardMode = 1, kPermissiveMode = 2;</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+var kStrictMode = 0,</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+  kStandardMode = 1,</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+  kPermissiveMode = 2;</span>
<a href="#l42.25"></a><span id="l42.25"> </span>
<a href="#l42.26"></a><span id="l42.26"> function run_test() {</span>
<a href="#l42.27"></a><span id="l42.27">   let defaultMode = Services.prefs.getIntPref(kModePref);</span>
<a href="#l42.28"></a><span id="l42.28"> </span>
<a href="#l42.29"></a><span id="l42.29">   add_test(test_strictMode);</span>
<a href="#l42.30"></a><span id="l42.30">   add_test(test_standardMode);</span>
<a href="#l42.31"></a><span id="l42.31">   add_test(test_permissiveMode);</span>
<a href="#l42.32"></a><span id="l42.32">   add_test(test_addGlobalAllowedTag);</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineat">@@ -34,181 +36,225 @@ function run_test() {</span>
<a href="#l42.34"></a><span id="l42.34"> // Sanity check: a string without HTML markup shouldn't be modified.</span>
<a href="#l42.35"></a><span id="l42.35"> function test_plainText() {</span>
<a href="#l42.36"></a><span id="l42.36">   const strings = [</span>
<a href="#l42.37"></a><span id="l42.37">     &quot;foo&quot;,</span>
<a href="#l42.38"></a><span id="l42.38">     &quot;foo  &quot;, // preserve trailing whitespace</span>
<a href="#l42.39"></a><span id="l42.39">     &quot;  foo&quot;, // preserve leading indent</span>
<a href="#l42.40"></a><span id="l42.40">     &quot;&amp;lt;html&amp;gt;&amp;amp;&quot;, // keep escaped characters</span>
<a href="#l42.41"></a><span id="l42.41">   ];</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-  for (let string of strings)</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+  for (let string of strings) {</span>
<a href="#l42.44"></a><span id="l42.44">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+  }</span>
<a href="#l42.46"></a><span id="l42.46"> }</span>
<a href="#l42.47"></a><span id="l42.47"> </span>
<a href="#l42.48"></a><span id="l42.48"> function test_paragraphs() {</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineminus">-  const strings = [</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-    &quot;&lt;p&gt;foo&lt;/p&gt;&lt;p&gt;bar&lt;/p&gt;&quot;,</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-    &quot;&lt;p&gt;foo&lt;br&gt;bar&lt;/p&gt;&quot;,</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-    &quot;foo&lt;br&gt;bar&quot;,</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-  ];</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-  for (let string of strings)</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+  const strings = [&quot;&lt;p&gt;foo&lt;/p&gt;&lt;p&gt;bar&lt;/p&gt;&quot;, &quot;&lt;p&gt;foo&lt;br&gt;bar&lt;/p&gt;&quot;, &quot;foo&lt;br&gt;bar&quot;];</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+  for (let string of strings) {</span>
<a href="#l42.57"></a><span id="l42.57">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+  }</span>
<a href="#l42.59"></a><span id="l42.59"> }</span>
<a href="#l42.60"></a><span id="l42.60"> </span>
<a href="#l42.61"></a><span id="l42.61"> function test_stripScripts() {</span>
<a href="#l42.62"></a><span id="l42.62">   const strings = [</span>
<a href="#l42.63"></a><span id="l42.63">     [&quot;&lt;script&gt;alert('hey')&lt;/script&gt;&quot;, &quot;&quot;],</span>
<a href="#l42.64"></a><span id="l42.64">     [&quot;foo &lt;script&gt;alert('hey')&lt;/script&gt;&quot;, &quot;foo &quot;],</span>
<a href="#l42.65"></a><span id="l42.65">     [&quot;&lt;p onclick=\&quot;alert('hey')\&quot;&gt;foo&lt;/p&gt;&quot;, &quot;&lt;p&gt;foo&lt;/p&gt;&quot;],</span>
<a href="#l42.66"></a><span id="l42.66">     [&quot;&lt;p onmouseover=\&quot;alert('hey')\&quot;&gt;foo&lt;/p&gt;&quot;, &quot;&lt;p&gt;foo&lt;/p&gt;&quot;],</span>
<a href="#l42.67"></a><span id="l42.67">   ];</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-  for (let [input, expectedOutput] of strings)</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+  for (let [input, expectedOutput] of strings) {</span>
<a href="#l42.70"></a><span id="l42.70">     Assert.equal(expectedOutput, cleanupImMarkup(input));</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+  }</span>
<a href="#l42.72"></a><span id="l42.72"> }</span>
<a href="#l42.73"></a><span id="l42.73"> </span>
<a href="#l42.74"></a><span id="l42.74"> function test_links() {</span>
<a href="#l42.75"></a><span id="l42.75">   // http, https, ftp and mailto links should be preserved.</span>
<a href="#l42.76"></a><span id="l42.76">   const ok = [</span>
<a href="#l42.77"></a><span id="l42.77">     &quot;http://example.com/&quot;,</span>
<a href="#l42.78"></a><span id="l42.78">     &quot;https://example.com/&quot;,</span>
<a href="#l42.79"></a><span id="l42.79">     &quot;ftp://example.com/&quot;,</span>
<a href="#l42.80"></a><span id="l42.80">     &quot;mailto:foo@example.com&quot;,</span>
<a href="#l42.81"></a><span id="l42.81">   ];</span>
<a href="#l42.82"></a><span id="l42.82">   for (let string of ok) {</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-    string = &quot;&lt;a href=\&quot;&quot; + string + &quot;\&quot;&gt;foo&lt;/a&gt;&quot;;</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+    string = '&lt;a href=&quot;' + string + '&quot;&gt;foo&lt;/a&gt;';</span>
<a href="#l42.85"></a><span id="l42.85">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.86"></a><span id="l42.86">   }</span>
<a href="#l42.87"></a><span id="l42.87"> </span>
<a href="#l42.88"></a><span id="l42.88">   // other links should be removed</span>
<a href="#l42.89"></a><span id="l42.89">   const bad = [</span>
<a href="#l42.90"></a><span id="l42.90">     &quot;chrome://global/content/&quot;,</span>
<a href="#l42.91"></a><span id="l42.91">     &quot;about:&quot;,</span>
<a href="#l42.92"></a><span id="l42.92">     &quot;about:blank&quot;,</span>
<a href="#l42.93"></a><span id="l42.93">     &quot;foo://bar/&quot;,</span>
<a href="#l42.94"></a><span id="l42.94">     &quot;&quot;,</span>
<a href="#l42.95"></a><span id="l42.95">   ];</span>
<a href="#l42.96"></a><span id="l42.96">   for (let string of bad) {</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineminus">-    Assert.equal(&quot;&lt;a&gt;foo&lt;/a&gt;&quot;,</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineminus">-                 cleanupImMarkup(&quot;&lt;a href=\&quot;&quot; + string + &quot;\&quot;&gt;foo&lt;/a&gt;&quot;));</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+    Assert.equal(</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+      &quot;&lt;a&gt;foo&lt;/a&gt;&quot;,</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+      cleanupImMarkup('&lt;a href=&quot;' + string + '&quot;&gt;foo&lt;/a&gt;')</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineplus">+    );</span>
<a href="#l42.103"></a><span id="l42.103">   }</span>
<a href="#l42.104"></a><span id="l42.104"> </span>
<a href="#l42.105"></a><span id="l42.105">   // keep link titles</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineminus">-  let string = &quot;&lt;a title=\&quot;foo bar\&quot;&gt;foo&lt;/a&gt;&quot;;</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+  let string = '&lt;a title=&quot;foo bar&quot;&gt;foo&lt;/a&gt;';</span>
<a href="#l42.108"></a><span id="l42.108">   Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.109"></a><span id="l42.109"> }</span>
<a href="#l42.110"></a><span id="l42.110"> </span>
<a href="#l42.111"></a><span id="l42.111"> function test_allModes() {</span>
<a href="#l42.112"></a><span id="l42.112">   test_plainText();</span>
<a href="#l42.113"></a><span id="l42.113">   test_paragraphs();</span>
<a href="#l42.114"></a><span id="l42.114">   test_stripScripts();</span>
<a href="#l42.115"></a><span id="l42.115">   test_links();</span>
<a href="#l42.116"></a><span id="l42.116">   // Remove random classes.</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-  Assert.equal(&quot;&lt;p&gt;foo&lt;/p&gt;&quot;, cleanupImMarkup(&quot;&lt;p class=\&quot;foobar\&quot;&gt;foo&lt;/p&gt;&quot;));</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+  Assert.equal(&quot;&lt;p&gt;foo&lt;/p&gt;&quot;, cleanupImMarkup('&lt;p class=&quot;foobar&quot;&gt;foo&lt;/p&gt;'));</span>
<a href="#l42.119"></a><span id="l42.119"> }</span>
<a href="#l42.120"></a><span id="l42.120"> </span>
<a href="#l42.121"></a><span id="l42.121"> function test_strictMode() {</span>
<a href="#l42.122"></a><span id="l42.122">   Services.prefs.setIntPref(kModePref, kStrictMode);</span>
<a href="#l42.123"></a><span id="l42.123">   test_allModes();</span>
<a href="#l42.124"></a><span id="l42.124"> </span>
<a href="#l42.125"></a><span id="l42.125">   // check that basic formatting is stripped in strict mode.</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineminus">-  for (let tag of [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineminus">-                   &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;])</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineplus">+  for (let tag of [</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineplus">+    &quot;div&quot;,</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+    &quot;em&quot;,</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineplus">+    &quot;strong&quot;,</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineplus">+    &quot;b&quot;,</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineplus">+    &quot;i&quot;,</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineplus">+    &quot;u&quot;,</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineplus">+    &quot;span&quot;,</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+    &quot;code&quot;,</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineplus">+    &quot;ul&quot;,</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+    &quot;li&quot;,</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineplus">+    &quot;ol&quot;,</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineplus">+    &quot;cite&quot;,</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineplus">+    &quot;blockquote&quot;,</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+  ]) {</span>
<a href="#l42.143"></a><span id="l42.143">     Assert.equal(&quot;foo&quot;, cleanupImMarkup(&quot;&lt;&quot; + tag + &quot;&gt;foo&lt;/&quot; + tag + &quot;&gt;&quot;));</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineplus">+  }</span>
<a href="#l42.145"></a><span id="l42.145"> </span>
<a href="#l42.146"></a><span id="l42.146">   // check that font settings are removed.</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineminus">-  Assert.equal(&quot;foo&quot;,</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineminus">-               cleanupImMarkup(&quot;&lt;font face=\&quot;Times\&quot; color=\&quot;pink\&quot;&gt;foo&lt;/font&gt;&quot;));</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineminus">-  Assert.equal(&quot;&lt;p&gt;foo&lt;/p&gt;&quot;,</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineminus">-               cleanupImMarkup(&quot;&lt;p style=\&quot;font-weight: bold;\&quot;&gt;foo&lt;/p&gt;&quot;));</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineplus">+    &quot;foo&quot;,</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineplus">+    cleanupImMarkup('&lt;font face=&quot;Times&quot; color=&quot;pink&quot;&gt;foo&lt;/font&gt;')</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineplus">+  );</span>
<a href="#l42.155"></a><span id="l42.155" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.156"></a><span id="l42.156" class="difflineplus">+    &quot;&lt;p&gt;foo&lt;/p&gt;&quot;,</span>
<a href="#l42.157"></a><span id="l42.157" class="difflineplus">+    cleanupImMarkup('&lt;p style=&quot;font-weight: bold;&quot;&gt;foo&lt;/p&gt;')</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineplus">+  );</span>
<a href="#l42.159"></a><span id="l42.159"> </span>
<a href="#l42.160"></a><span id="l42.160">   // Discard hr</span>
<a href="#l42.161"></a><span id="l42.161">   Assert.equal(&quot;foobar&quot;, cleanupImMarkup(&quot;foo&lt;hr&gt;bar&quot;));</span>
<a href="#l42.162"></a><span id="l42.162"> </span>
<a href="#l42.163"></a><span id="l42.163">   run_next_test();</span>
<a href="#l42.164"></a><span id="l42.164"> }</span>
<a href="#l42.165"></a><span id="l42.165"> </span>
<a href="#l42.166"></a><span id="l42.166"> function test_standardMode() {</span>
<a href="#l42.167"></a><span id="l42.167">   Services.prefs.setIntPref(kModePref, kStandardMode);</span>
<a href="#l42.168"></a><span id="l42.168">   test_allModes();</span>
<a href="#l42.169"></a><span id="l42.169"> </span>
<a href="#l42.170"></a><span id="l42.170">   // check that basic formatting is kept in standard mode.</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineminus">-  for (let tag of [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineminus">-                   &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;]) {</span>
<a href="#l42.173"></a><span id="l42.173" class="difflineplus">+  for (let tag of [</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineplus">+    &quot;div&quot;,</span>
<a href="#l42.175"></a><span id="l42.175" class="difflineplus">+    &quot;em&quot;,</span>
<a href="#l42.176"></a><span id="l42.176" class="difflineplus">+    &quot;strong&quot;,</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineplus">+    &quot;b&quot;,</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineplus">+    &quot;i&quot;,</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineplus">+    &quot;u&quot;,</span>
<a href="#l42.180"></a><span id="l42.180" class="difflineplus">+    &quot;span&quot;,</span>
<a href="#l42.181"></a><span id="l42.181" class="difflineplus">+    &quot;code&quot;,</span>
<a href="#l42.182"></a><span id="l42.182" class="difflineplus">+    &quot;ul&quot;,</span>
<a href="#l42.183"></a><span id="l42.183" class="difflineplus">+    &quot;li&quot;,</span>
<a href="#l42.184"></a><span id="l42.184" class="difflineplus">+    &quot;ol&quot;,</span>
<a href="#l42.185"></a><span id="l42.185" class="difflineplus">+    &quot;cite&quot;,</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineplus">+    &quot;blockquote&quot;,</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineplus">+  ]) {</span>
<a href="#l42.188"></a><span id="l42.188">     let string = &quot;&lt;&quot; + tag + &quot;&gt;foo&lt;/&quot; + tag + &quot;&gt;&quot;;</span>
<a href="#l42.189"></a><span id="l42.189">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.190"></a><span id="l42.190">   }</span>
<a href="#l42.191"></a><span id="l42.191"> </span>
<a href="#l42.192"></a><span id="l42.192">   // Keep special allowed classes.</span>
<a href="#l42.193"></a><span id="l42.193">   for (let className of [&quot;moz-txt-underscore&quot;, &quot;moz-txt-tag&quot;]) {</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineminus">-    let string = &quot;&lt;span class=\&quot;&quot; + className + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineplus">+    let string = '&lt;span class=&quot;' + className + '&quot;&gt;foo&lt;/span&gt;';</span>
<a href="#l42.196"></a><span id="l42.196">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.197"></a><span id="l42.197">   }</span>
<a href="#l42.198"></a><span id="l42.198"> </span>
<a href="#l42.199"></a><span id="l42.199">   // Remove font settings</span>
<a href="#l42.200"></a><span id="l42.200" class="difflineminus">-  let font_string = &quot;&lt;font face=\&quot;Times\&quot; color=\&quot;pink\&quot; size=\&quot;3\&quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l42.201"></a><span id="l42.201" class="difflineplus">+  let font_string = '&lt;font face=&quot;Times&quot; color=&quot;pink&quot; size=&quot;3&quot;&gt;foo&lt;/font&gt;';</span>
<a href="#l42.202"></a><span id="l42.202">   Assert.equal(&quot;foo&quot;, cleanupImMarkup(font_string));</span>
<a href="#l42.203"></a><span id="l42.203"> </span>
<a href="#l42.204"></a><span id="l42.204">   // Discard hr</span>
<a href="#l42.205"></a><span id="l42.205">   Assert.equal(&quot;foobar&quot;, cleanupImMarkup(&quot;foo&lt;hr&gt;bar&quot;));</span>
<a href="#l42.206"></a><span id="l42.206"> </span>
<a href="#l42.207"></a><span id="l42.207" class="difflineminus">-  const okCSS = [</span>
<a href="#l42.208"></a><span id="l42.208" class="difflineminus">-    &quot;font-style: italic&quot;,</span>
<a href="#l42.209"></a><span id="l42.209" class="difflineminus">-    &quot;font-weight: bold&quot;,</span>
<a href="#l42.210"></a><span id="l42.210" class="difflineminus">-  ];</span>
<a href="#l42.211"></a><span id="l42.211" class="difflineplus">+  const okCSS = [&quot;font-style: italic&quot;, &quot;font-weight: bold&quot;];</span>
<a href="#l42.212"></a><span id="l42.212">   for (let css of okCSS) {</span>
<a href="#l42.213"></a><span id="l42.213" class="difflineminus">-    let string = &quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l42.214"></a><span id="l42.214" class="difflineplus">+    let string = '&lt;span style=&quot;' + css + '&quot;&gt;foo&lt;/span&gt;';</span>
<a href="#l42.215"></a><span id="l42.215">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.216"></a><span id="l42.216">   }</span>
<a href="#l42.217"></a><span id="l42.217">   // text-decoration is a shorthand for several text-decoration properties.</span>
<a href="#l42.218"></a><span id="l42.218" class="difflineminus">-  Assert.equal(&quot;&lt;span style=\&quot;text-decoration-line: underline;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineminus">-               cleanupImMarkup(&quot;&lt;span style=\&quot;text-decoration: underline\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l42.220"></a><span id="l42.220" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineplus">+    '&lt;span style=&quot;text-decoration-line: underline;&quot;&gt;foo&lt;/span&gt;',</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineplus">+    cleanupImMarkup('&lt;span style=&quot;text-decoration: underline&quot;&gt;foo&lt;/span&gt;')</span>
<a href="#l42.223"></a><span id="l42.223" class="difflineplus">+  );</span>
<a href="#l42.224"></a><span id="l42.224"> </span>
<a href="#l42.225"></a><span id="l42.225">   const badCSS = [</span>
<a href="#l42.226"></a><span id="l42.226">     &quot;color: pink;&quot;,</span>
<a href="#l42.227"></a><span id="l42.227">     &quot;font-family: Times&quot;,</span>
<a href="#l42.228"></a><span id="l42.228">     &quot;font-size: larger&quot;,</span>
<a href="#l42.229"></a><span id="l42.229">     &quot;display: none&quot;,</span>
<a href="#l42.230"></a><span id="l42.230">     &quot;visibility: hidden&quot;,</span>
<a href="#l42.231"></a><span id="l42.231">     &quot;unsupported-by-gecko: blah&quot;,</span>
<a href="#l42.232"></a><span id="l42.232">   ];</span>
<a href="#l42.233"></a><span id="l42.233">   for (let css of badCSS) {</span>
<a href="#l42.234"></a><span id="l42.234" class="difflineminus">-    Assert.equal(&quot;&lt;span&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l42.235"></a><span id="l42.235" class="difflineminus">-                 cleanupImMarkup(&quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l42.236"></a><span id="l42.236" class="difflineplus">+    Assert.equal(</span>
<a href="#l42.237"></a><span id="l42.237" class="difflineplus">+      &quot;&lt;span&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l42.238"></a><span id="l42.238" class="difflineplus">+      cleanupImMarkup('&lt;span style=&quot;' + css + '&quot;&gt;foo&lt;/span&gt;')</span>
<a href="#l42.239"></a><span id="l42.239" class="difflineplus">+    );</span>
<a href="#l42.240"></a><span id="l42.240">   }</span>
<a href="#l42.241"></a><span id="l42.241">   // The shorthand 'font' is decomposed to non-shorthand properties,</span>
<a href="#l42.242"></a><span id="l42.242">   // and not recomposed as some non-shorthand properties are filtered out.</span>
<a href="#l42.243"></a><span id="l42.243" class="difflineminus">-  Assert.equal(&quot;&lt;span style=\&quot;font-style: normal; font-weight: normal;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l42.244"></a><span id="l42.244" class="difflineminus">-               cleanupImMarkup(&quot;&lt;span style=\&quot;font: 15px normal\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l42.245"></a><span id="l42.245" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineplus">+    '&lt;span style=&quot;font-style: normal; font-weight: normal;&quot;&gt;foo&lt;/span&gt;',</span>
<a href="#l42.247"></a><span id="l42.247" class="difflineplus">+    cleanupImMarkup('&lt;span style=&quot;font: 15px normal&quot;&gt;foo&lt;/span&gt;')</span>
<a href="#l42.248"></a><span id="l42.248" class="difflineplus">+  );</span>
<a href="#l42.249"></a><span id="l42.249"> </span>
<a href="#l42.250"></a><span id="l42.250">   run_next_test();</span>
<a href="#l42.251"></a><span id="l42.251"> }</span>
<a href="#l42.252"></a><span id="l42.252"> </span>
<a href="#l42.253"></a><span id="l42.253"> function test_permissiveMode() {</span>
<a href="#l42.254"></a><span id="l42.254">   Services.prefs.setIntPref(kModePref, kPermissiveMode);</span>
<a href="#l42.255"></a><span id="l42.255">   test_allModes();</span>
<a href="#l42.256"></a><span id="l42.256"> </span>
<a href="#l42.257"></a><span id="l42.257">   // Check that all formatting is kept in permissive mode.</span>
<a href="#l42.258"></a><span id="l42.258" class="difflineminus">-  for (let tag of [&quot;div&quot;, &quot;em&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;span&quot;, &quot;code&quot;,</span>
<a href="#l42.259"></a><span id="l42.259" class="difflineminus">-                   &quot;ul&quot;, &quot;li&quot;, &quot;ol&quot;, &quot;cite&quot;, &quot;blockquote&quot;]) {</span>
<a href="#l42.260"></a><span id="l42.260" class="difflineplus">+  for (let tag of [</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineplus">+    &quot;div&quot;,</span>
<a href="#l42.262"></a><span id="l42.262" class="difflineplus">+    &quot;em&quot;,</span>
<a href="#l42.263"></a><span id="l42.263" class="difflineplus">+    &quot;strong&quot;,</span>
<a href="#l42.264"></a><span id="l42.264" class="difflineplus">+    &quot;b&quot;,</span>
<a href="#l42.265"></a><span id="l42.265" class="difflineplus">+    &quot;i&quot;,</span>
<a href="#l42.266"></a><span id="l42.266" class="difflineplus">+    &quot;u&quot;,</span>
<a href="#l42.267"></a><span id="l42.267" class="difflineplus">+    &quot;span&quot;,</span>
<a href="#l42.268"></a><span id="l42.268" class="difflineplus">+    &quot;code&quot;,</span>
<a href="#l42.269"></a><span id="l42.269" class="difflineplus">+    &quot;ul&quot;,</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineplus">+    &quot;li&quot;,</span>
<a href="#l42.271"></a><span id="l42.271" class="difflineplus">+    &quot;ol&quot;,</span>
<a href="#l42.272"></a><span id="l42.272" class="difflineplus">+    &quot;cite&quot;,</span>
<a href="#l42.273"></a><span id="l42.273" class="difflineplus">+    &quot;blockquote&quot;,</span>
<a href="#l42.274"></a><span id="l42.274" class="difflineplus">+  ]) {</span>
<a href="#l42.275"></a><span id="l42.275">     let string = &quot;&lt;&quot; + tag + &quot;&gt;foo&lt;/&quot; + tag + &quot;&gt;&quot;;</span>
<a href="#l42.276"></a><span id="l42.276">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.277"></a><span id="l42.277">   }</span>
<a href="#l42.278"></a><span id="l42.278"> </span>
<a href="#l42.279"></a><span id="l42.279">   // Keep special allowed classes.</span>
<a href="#l42.280"></a><span id="l42.280">   for (let className of [&quot;moz-txt-underscore&quot;, &quot;moz-txt-tag&quot;]) {</span>
<a href="#l42.281"></a><span id="l42.281" class="difflineminus">-    let string = &quot;&lt;span class=\&quot;&quot; + className + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l42.282"></a><span id="l42.282" class="difflineplus">+    let string = '&lt;span class=&quot;' + className + '&quot;&gt;foo&lt;/span&gt;';</span>
<a href="#l42.283"></a><span id="l42.283">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.284"></a><span id="l42.284">   }</span>
<a href="#l42.285"></a><span id="l42.285"> </span>
<a href="#l42.286"></a><span id="l42.286">   // Keep font settings</span>
<a href="#l42.287"></a><span id="l42.287" class="difflineminus">-  const fontAttributes = [</span>
<a href="#l42.288"></a><span id="l42.288" class="difflineminus">-    &quot;face=\&quot;Times\&quot;&quot;,</span>
<a href="#l42.289"></a><span id="l42.289" class="difflineminus">-    &quot;color=\&quot;pink\&quot;&quot;,</span>
<a href="#l42.290"></a><span id="l42.290" class="difflineminus">-    &quot;size=\&quot;3\&quot;&quot;,</span>
<a href="#l42.291"></a><span id="l42.291" class="difflineminus">-  ];</span>
<a href="#l42.292"></a><span id="l42.292" class="difflineplus">+  const fontAttributes = ['face=&quot;Times&quot;', 'color=&quot;pink&quot;', 'size=&quot;3&quot;'];</span>
<a href="#l42.293"></a><span id="l42.293">   for (let fontAttribute of fontAttributes) {</span>
<a href="#l42.294"></a><span id="l42.294">     let string = &quot;&lt;font &quot; + fontAttribute + &quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l42.295"></a><span id="l42.295">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.296"></a><span id="l42.296">   }</span>
<a href="#l42.297"></a><span id="l42.297"> </span>
<a href="#l42.298"></a><span id="l42.298">   // Allow hr</span>
<a href="#l42.299"></a><span id="l42.299">   let hr_string = &quot;foo&lt;hr&gt;bar&quot;;</span>
<a href="#l42.300"></a><span id="l42.300">   Assert.equal(hr_string, cleanupImMarkup(hr_string));</span>
<a href="#l42.301"></a><span id="l42.301" class="difflineat">@@ -218,127 +264,141 @@ function test_permissiveMode() {</span>
<a href="#l42.302"></a><span id="l42.302">     &quot;font-style: italic&quot;,</span>
<a href="#l42.303"></a><span id="l42.303">     &quot;font-weight: bold&quot;,</span>
<a href="#l42.304"></a><span id="l42.304">     &quot;text-decoration: underline&quot;,</span>
<a href="#l42.305"></a><span id="l42.305">     &quot;color: pink;&quot;,</span>
<a href="#l42.306"></a><span id="l42.306">     &quot;font-family: Times&quot;,</span>
<a href="#l42.307"></a><span id="l42.307">     &quot;font-size: larger&quot;,</span>
<a href="#l42.308"></a><span id="l42.308">   ];</span>
<a href="#l42.309"></a><span id="l42.309">   for (let css of okCSS) {</span>
<a href="#l42.310"></a><span id="l42.310" class="difflineminus">-    let string = &quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l42.311"></a><span id="l42.311" class="difflineplus">+    let string = '&lt;span style=&quot;' + css + '&quot;&gt;foo&lt;/span&gt;';</span>
<a href="#l42.312"></a><span id="l42.312">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l42.313"></a><span id="l42.313">   }</span>
<a href="#l42.314"></a><span id="l42.314"> </span>
<a href="#l42.315"></a><span id="l42.315">   // The shorthand 'font' is decomposed to non-shorthand properties,</span>
<a href="#l42.316"></a><span id="l42.316">   // and not recomposed as some non-shorthand properties are filtered out.</span>
<a href="#l42.317"></a><span id="l42.317" class="difflineminus">-  Assert.equal(&quot;&lt;span style=\&quot;font-family: normal; font-size: 15px; &quot; +</span>
<a href="#l42.318"></a><span id="l42.318" class="difflineminus">-               &quot;font-style: normal; font-weight: normal;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l42.319"></a><span id="l42.319" class="difflineminus">-               cleanupImMarkup(&quot;&lt;span style=\&quot;font: 15px normal\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l42.320"></a><span id="l42.320" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.321"></a><span id="l42.321" class="difflineplus">+    '&lt;span style=&quot;font-family: normal; font-size: 15px; ' +</span>
<a href="#l42.322"></a><span id="l42.322" class="difflineplus">+      'font-style: normal; font-weight: normal;&quot;&gt;foo&lt;/span&gt;',</span>
<a href="#l42.323"></a><span id="l42.323" class="difflineplus">+    cleanupImMarkup('&lt;span style=&quot;font: 15px normal&quot;&gt;foo&lt;/span&gt;')</span>
<a href="#l42.324"></a><span id="l42.324" class="difflineplus">+  );</span>
<a href="#l42.325"></a><span id="l42.325"> </span>
<a href="#l42.326"></a><span id="l42.326">   // But still filter out dangerous CSS rules.</span>
<a href="#l42.327"></a><span id="l42.327">   const badCSS = [</span>
<a href="#l42.328"></a><span id="l42.328">     &quot;display: none&quot;,</span>
<a href="#l42.329"></a><span id="l42.329">     &quot;visibility: hidden&quot;,</span>
<a href="#l42.330"></a><span id="l42.330">     &quot;unsupported-by-gecko: blah&quot;,</span>
<a href="#l42.331"></a><span id="l42.331">   ];</span>
<a href="#l42.332"></a><span id="l42.332">   for (let css of badCSS) {</span>
<a href="#l42.333"></a><span id="l42.333" class="difflineminus">-    Assert.equal(&quot;&lt;span&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l42.334"></a><span id="l42.334" class="difflineminus">-                 cleanupImMarkup(&quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l42.335"></a><span id="l42.335" class="difflineplus">+    Assert.equal(</span>
<a href="#l42.336"></a><span id="l42.336" class="difflineplus">+      &quot;&lt;span&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l42.337"></a><span id="l42.337" class="difflineplus">+      cleanupImMarkup('&lt;span style=&quot;' + css + '&quot;&gt;foo&lt;/span&gt;')</span>
<a href="#l42.338"></a><span id="l42.338" class="difflineplus">+    );</span>
<a href="#l42.339"></a><span id="l42.339">   }</span>
<a href="#l42.340"></a><span id="l42.340"> </span>
<a href="#l42.341"></a><span id="l42.341">   run_next_test();</span>
<a href="#l42.342"></a><span id="l42.342"> }</span>
<a href="#l42.343"></a><span id="l42.343"> </span>
<a href="#l42.344"></a><span id="l42.344"> function test_addGlobalAllowedTag() {</span>
<a href="#l42.345"></a><span id="l42.345">   Services.prefs.setIntPref(kModePref, kStrictMode);</span>
<a href="#l42.346"></a><span id="l42.346"> </span>
<a href="#l42.347"></a><span id="l42.347">   // Check that &lt;hr&gt; isn't allowed by default in strict mode.</span>
<a href="#l42.348"></a><span id="l42.348">   // Note: we use &lt;hr&gt; instead of &lt;img&gt; to avoid mailnews' content policy</span>
<a href="#l42.349"></a><span id="l42.349">   // messing things up.</span>
<a href="#l42.350"></a><span id="l42.350">   Assert.equal(&quot;&quot;, cleanupImMarkup(&quot;&lt;hr&gt;&quot;));</span>
<a href="#l42.351"></a><span id="l42.351"> </span>
<a href="#l42.352"></a><span id="l42.352">   // Allow &lt;hr&gt; without attributes.</span>
<a href="#l42.353"></a><span id="l42.353">   addGlobalAllowedTag(&quot;hr&quot;);</span>
<a href="#l42.354"></a><span id="l42.354">   Assert.equal(&quot;&lt;hr&gt;&quot;, cleanupImMarkup(&quot;&lt;hr&gt;&quot;));</span>
<a href="#l42.355"></a><span id="l42.355" class="difflineminus">-  Assert.equal(&quot;&lt;hr&gt;&quot;, cleanupImMarkup(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;));</span>
<a href="#l42.356"></a><span id="l42.356" class="difflineplus">+  Assert.equal(&quot;&lt;hr&gt;&quot;, cleanupImMarkup('&lt;hr src=&quot;http://example.com/&quot;&gt;'));</span>
<a href="#l42.357"></a><span id="l42.357">   removeGlobalAllowedTag(&quot;hr&quot;);</span>
<a href="#l42.358"></a><span id="l42.358"> </span>
<a href="#l42.359"></a><span id="l42.359">   // Allow &lt;hr&gt; with an unfiltered src attribute.</span>
<a href="#l42.360"></a><span id="l42.360" class="difflineminus">-  addGlobalAllowedTag(&quot;hr&quot;, {src: true});</span>
<a href="#l42.361"></a><span id="l42.361" class="difflineminus">-  Assert.equal(&quot;&lt;hr&gt;&quot;, cleanupImMarkup(&quot;&lt;hr alt=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l42.362"></a><span id="l42.362" class="difflineminus">-  Assert.equal(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;,</span>
<a href="#l42.363"></a><span id="l42.363" class="difflineminus">-               cleanupImMarkup(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;));</span>
<a href="#l42.364"></a><span id="l42.364" class="difflineminus">-  Assert.equal(&quot;&lt;hr src=\&quot;chrome://global/skin/img.png\&quot;&gt;&quot;,</span>
<a href="#l42.365"></a><span id="l42.365" class="difflineminus">-               cleanupImMarkup(&quot;&lt;hr src=\&quot;chrome://global/skin/img.png\&quot;&gt;&quot;));</span>
<a href="#l42.366"></a><span id="l42.366" class="difflineplus">+  addGlobalAllowedTag(&quot;hr&quot;, { src: true });</span>
<a href="#l42.367"></a><span id="l42.367" class="difflineplus">+  Assert.equal(&quot;&lt;hr&gt;&quot;, cleanupImMarkup('&lt;hr alt=&quot;foo&quot;&gt;'));</span>
<a href="#l42.368"></a><span id="l42.368" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.369"></a><span id="l42.369" class="difflineplus">+    '&lt;hr src=&quot;http://example.com/&quot;&gt;',</span>
<a href="#l42.370"></a><span id="l42.370" class="difflineplus">+    cleanupImMarkup('&lt;hr src=&quot;http://example.com/&quot;&gt;')</span>
<a href="#l42.371"></a><span id="l42.371" class="difflineplus">+  );</span>
<a href="#l42.372"></a><span id="l42.372" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.373"></a><span id="l42.373" class="difflineplus">+    '&lt;hr src=&quot;chrome://global/skin/img.png&quot;&gt;',</span>
<a href="#l42.374"></a><span id="l42.374" class="difflineplus">+    cleanupImMarkup('&lt;hr src=&quot;chrome://global/skin/img.png&quot;&gt;')</span>
<a href="#l42.375"></a><span id="l42.375" class="difflineplus">+  );</span>
<a href="#l42.376"></a><span id="l42.376">   removeGlobalAllowedTag(&quot;hr&quot;);</span>
<a href="#l42.377"></a><span id="l42.377"> </span>
<a href="#l42.378"></a><span id="l42.378">   // Allow &lt;hr&gt; with an src attribute taking only http(s) urls.</span>
<a href="#l42.379"></a><span id="l42.379" class="difflineminus">-  addGlobalAllowedTag(&quot;hr&quot;, {src: aValue =&gt; /^https?:/.test(aValue)});</span>
<a href="#l42.380"></a><span id="l42.380" class="difflineminus">-  Assert.equal(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;,</span>
<a href="#l42.381"></a><span id="l42.381" class="difflineminus">-               cleanupImMarkup(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;));</span>
<a href="#l42.382"></a><span id="l42.382" class="difflineminus">-  Assert.equal(&quot;&lt;hr&gt;&quot;,</span>
<a href="#l42.383"></a><span id="l42.383" class="difflineminus">-               cleanupImMarkup(&quot;&lt;hr src=\&quot;chrome://global/skin/img.png\&quot;&gt;&quot;));</span>
<a href="#l42.384"></a><span id="l42.384" class="difflineplus">+  addGlobalAllowedTag(&quot;hr&quot;, { src: aValue =&gt; /^https?:/.test(aValue) });</span>
<a href="#l42.385"></a><span id="l42.385" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.386"></a><span id="l42.386" class="difflineplus">+    '&lt;hr src=&quot;http://example.com/&quot;&gt;',</span>
<a href="#l42.387"></a><span id="l42.387" class="difflineplus">+    cleanupImMarkup('&lt;hr src=&quot;http://example.com/&quot;&gt;')</span>
<a href="#l42.388"></a><span id="l42.388" class="difflineplus">+  );</span>
<a href="#l42.389"></a><span id="l42.389" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.390"></a><span id="l42.390" class="difflineplus">+    &quot;&lt;hr&gt;&quot;,</span>
<a href="#l42.391"></a><span id="l42.391" class="difflineplus">+    cleanupImMarkup('&lt;hr src=&quot;chrome://global/skin/img.png&quot;&gt;')</span>
<a href="#l42.392"></a><span id="l42.392" class="difflineplus">+  );</span>
<a href="#l42.393"></a><span id="l42.393">   removeGlobalAllowedTag(&quot;hr&quot;);</span>
<a href="#l42.394"></a><span id="l42.394"> </span>
<a href="#l42.395"></a><span id="l42.395">   run_next_test();</span>
<a href="#l42.396"></a><span id="l42.396"> }</span>
<a href="#l42.397"></a><span id="l42.397"> </span>
<a href="#l42.398"></a><span id="l42.398"> function test_addGlobalAllowedAttribute() {</span>
<a href="#l42.399"></a><span id="l42.399">   Services.prefs.setIntPref(kModePref, kStrictMode);</span>
<a href="#l42.400"></a><span id="l42.400"> </span>
<a href="#l42.401"></a><span id="l42.401">   // Check that id isn't allowed by default in strict mode.</span>
<a href="#l42.402"></a><span id="l42.402" class="difflineminus">-  Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l42.403"></a><span id="l42.403" class="difflineplus">+  Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup('&lt;br id=&quot;foo&quot;&gt;'));</span>
<a href="#l42.404"></a><span id="l42.404"> </span>
<a href="#l42.405"></a><span id="l42.405">   // Allow id unconditionally.</span>
<a href="#l42.406"></a><span id="l42.406">   addGlobalAllowedAttribute(&quot;id&quot;);</span>
<a href="#l42.407"></a><span id="l42.407" class="difflineminus">-  Assert.equal(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l42.408"></a><span id="l42.408" class="difflineplus">+  Assert.equal('&lt;br id=&quot;foo&quot;&gt;', cleanupImMarkup('&lt;br id=&quot;foo&quot;&gt;'));</span>
<a href="#l42.409"></a><span id="l42.409">   removeGlobalAllowedAttribute(&quot;id&quot;);</span>
<a href="#l42.410"></a><span id="l42.410"> </span>
<a href="#l42.411"></a><span id="l42.411">   // Allow id only with numbers.</span>
<a href="#l42.412"></a><span id="l42.412">   addGlobalAllowedAttribute(&quot;id&quot;, aId =&gt; /^\d+$/.test(aId));</span>
<a href="#l42.413"></a><span id="l42.413" class="difflineminus">-  Assert.equal(&quot;&lt;br id=\&quot;123\&quot;&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;123\&quot;&gt;&quot;));</span>
<a href="#l42.414"></a><span id="l42.414" class="difflineminus">-  Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l42.415"></a><span id="l42.415" class="difflineplus">+  Assert.equal('&lt;br id=&quot;123&quot;&gt;', cleanupImMarkup('&lt;br id=&quot;123&quot;&gt;'));</span>
<a href="#l42.416"></a><span id="l42.416" class="difflineplus">+  Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup('&lt;br id=&quot;foo&quot;&gt;'));</span>
<a href="#l42.417"></a><span id="l42.417">   removeGlobalAllowedAttribute(&quot;id&quot;);</span>
<a href="#l42.418"></a><span id="l42.418"> </span>
<a href="#l42.419"></a><span id="l42.419">   run_next_test();</span>
<a href="#l42.420"></a><span id="l42.420"> }</span>
<a href="#l42.421"></a><span id="l42.421"> </span>
<a href="#l42.422"></a><span id="l42.422"> function test_addGlobalAllowedStyleRule() {</span>
<a href="#l42.423"></a><span id="l42.423">   // We need at least the standard mode to have the style attribute allowed.</span>
<a href="#l42.424"></a><span id="l42.424">   Services.prefs.setIntPref(kModePref, kStandardMode);</span>
<a href="#l42.425"></a><span id="l42.425"> </span>
<a href="#l42.426"></a><span id="l42.426">   // Check that clear isn't allowed by default in strict mode.</span>
<a href="#l42.427"></a><span id="l42.427" class="difflineminus">-  Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(&quot;&lt;br style=\&quot;clear: both;\&quot;&gt;&quot;));</span>
<a href="#l42.428"></a><span id="l42.428" class="difflineplus">+  Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup('&lt;br style=&quot;clear: both;&quot;&gt;'));</span>
<a href="#l42.429"></a><span id="l42.429"> </span>
<a href="#l42.430"></a><span id="l42.430">   // Allow clear.</span>
<a href="#l42.431"></a><span id="l42.431">   addGlobalAllowedStyleRule(&quot;clear&quot;);</span>
<a href="#l42.432"></a><span id="l42.432" class="difflineminus">-  Assert.equal(&quot;&lt;br style=\&quot;clear: both;\&quot;&gt;&quot;,</span>
<a href="#l42.433"></a><span id="l42.433" class="difflineminus">-               cleanupImMarkup(&quot;&lt;br style=\&quot;clear: both;\&quot;&gt;&quot;));</span>
<a href="#l42.434"></a><span id="l42.434" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.435"></a><span id="l42.435" class="difflineplus">+    '&lt;br style=&quot;clear: both;&quot;&gt;',</span>
<a href="#l42.436"></a><span id="l42.436" class="difflineplus">+    cleanupImMarkup('&lt;br style=&quot;clear: both;&quot;&gt;')</span>
<a href="#l42.437"></a><span id="l42.437" class="difflineplus">+  );</span>
<a href="#l42.438"></a><span id="l42.438">   removeGlobalAllowedStyleRule(&quot;clear&quot;);</span>
<a href="#l42.439"></a><span id="l42.439"> </span>
<a href="#l42.440"></a><span id="l42.440">   run_next_test();</span>
<a href="#l42.441"></a><span id="l42.441"> }</span>
<a href="#l42.442"></a><span id="l42.442"> </span>
<a href="#l42.443"></a><span id="l42.443"> function test_createDerivedRuleset() {</span>
<a href="#l42.444"></a><span id="l42.444">   Services.prefs.setIntPref(kModePref, kStandardMode);</span>
<a href="#l42.445"></a><span id="l42.445"> </span>
<a href="#l42.446"></a><span id="l42.446">   let rules = createDerivedRuleset();</span>
<a href="#l42.447"></a><span id="l42.447"> </span>
<a href="#l42.448"></a><span id="l42.448">   let string = &quot;&lt;hr&gt;&quot;;</span>
<a href="#l42.449"></a><span id="l42.449">   Assert.equal(&quot;&quot;, cleanupImMarkup(string));</span>
<a href="#l42.450"></a><span id="l42.450">   Assert.equal(&quot;&quot;, cleanupImMarkup(string, rules));</span>
<a href="#l42.451"></a><span id="l42.451">   rules.tags.hr = true;</span>
<a href="#l42.452"></a><span id="l42.452">   Assert.equal(string, cleanupImMarkup(string, rules));</span>
<a href="#l42.453"></a><span id="l42.453"> </span>
<a href="#l42.454"></a><span id="l42.454" class="difflineminus">-  string = &quot;&lt;br id=\&quot;123\&quot;&gt;&quot;;</span>
<a href="#l42.455"></a><span id="l42.455" class="difflineplus">+  string = '&lt;br id=&quot;123&quot;&gt;';</span>
<a href="#l42.456"></a><span id="l42.456">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string));</span>
<a href="#l42.457"></a><span id="l42.457">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string, rules));</span>
<a href="#l42.458"></a><span id="l42.458">   rules.attrs.id = true;</span>
<a href="#l42.459"></a><span id="l42.459">   Assert.equal(string, cleanupImMarkup(string, rules));</span>
<a href="#l42.460"></a><span id="l42.460"> </span>
<a href="#l42.461"></a><span id="l42.461" class="difflineminus">-  string = &quot;&lt;br style=\&quot;clear: both;\&quot;&gt;&quot;;</span>
<a href="#l42.462"></a><span id="l42.462" class="difflineplus">+  string = '&lt;br style=&quot;clear: both;&quot;&gt;';</span>
<a href="#l42.463"></a><span id="l42.463">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string));</span>
<a href="#l42.464"></a><span id="l42.464">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string, rules));</span>
<a href="#l42.465"></a><span id="l42.465">   rules.styles.clear = true;</span>
<a href="#l42.466"></a><span id="l42.466">   Assert.equal(string, cleanupImMarkup(string, rules));</span>
<a href="#l42.467"></a><span id="l42.467"> </span>
<a href="#l42.468"></a><span id="l42.468">   run_next_test();</span>
<a href="#l42.469"></a><span id="l42.469"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/chat/protocols/facebook/facebook.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/chat/protocols/facebook/facebook.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -32,27 +32,39 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, (</span>
<a href="#l43.4"></a><span id="l43.4"> </span>
<a href="#l43.5"></a><span id="l43.5"> function FacebookAccount(aProtoInstance, aImAccount) {</span>
<a href="#l43.6"></a><span id="l43.6">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l43.7"></a><span id="l43.7"> }</span>
<a href="#l43.8"></a><span id="l43.8"> FacebookAccount.prototype = {</span>
<a href="#l43.9"></a><span id="l43.9">   __proto__: GenericAccountPrototype,</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11">   connect() {</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-    this.WARN(&quot;As Facebook deprecated its XMPP gateway, it is currently not &quot; +</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-              &quot;possible to connect to Facebook Chat. See bug 1141674.&quot;);</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-    this.reportDisconnecting(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-                             _(&quot;facebook.disabled&quot;));</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+    this.WARN(</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+      &quot;As Facebook deprecated its XMPP gateway, it is currently not &quot; +</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+        &quot;possible to connect to Facebook Chat. See bug 1141674.&quot;</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+    );</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+    this.reportDisconnecting(</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+      Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+      _(&quot;facebook.disabled&quot;)</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+    );</span>
<a href="#l43.24"></a><span id="l43.24">     this.reportDisconnected();</span>
<a href="#l43.25"></a><span id="l43.25">   },</span>
<a href="#l43.26"></a><span id="l43.26"> };</span>
<a href="#l43.27"></a><span id="l43.27"> </span>
<a href="#l43.28"></a><span id="l43.28"> function FacebookProtocol() {}</span>
<a href="#l43.29"></a><span id="l43.29"> FacebookProtocol.prototype = {</span>
<a href="#l43.30"></a><span id="l43.30">   __proto__: GenericProtocolPrototype,</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-  get normalizedName() { return &quot;facebook&quot;; },</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineminus">-  get name() { return _(&quot;facebook.chat.name&quot;); },</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-facebook/skin/&quot;; },</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineminus">-  getAccount(aImAccount) { return new FacebookAccount(this, aImAccount); },</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+  get normalizedName() {</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+    return &quot;facebook&quot;;</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+  },</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+  get name() {</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+    return _(&quot;facebook.chat.name&quot;);</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+  },</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineplus">+    return &quot;chrome://prpl-facebook/skin/&quot;;</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+  },</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+    return new FacebookAccount(this, aImAccount);</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+  },</span>
<a href="#l43.47"></a><span id="l43.47">   classID: Components.ID(&quot;{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}&quot;),</span>
<a href="#l43.48"></a><span id="l43.48"> };</span>
<a href="#l43.49"></a><span id="l43.49"> </span>
<a href="#l43.50"></a><span id="l43.50"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([FacebookProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/chat/protocols/gtalk/gtalk.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -26,25 +26,22 @@ var {</span>
<a href="#l44.4"></a><span id="l44.4">   TooltipInfo,</span>
<a href="#l44.5"></a><span id="l44.5"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l44.6"></a><span id="l44.6"> var {</span>
<a href="#l44.7"></a><span id="l44.7">   XMPPConversationPrototype,</span>
<a href="#l44.8"></a><span id="l44.8">   XMPPMUCConversationPrototype,</span>
<a href="#l44.9"></a><span id="l44.9">   XMPPAccountBuddyPrototype,</span>
<a href="#l44.10"></a><span id="l44.10">   XMPPAccountPrototype,</span>
<a href="#l44.11"></a><span id="l44.11"> } = ChromeUtils.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-var {</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-  XMPPSession,</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-  XMPPDefaultResource,</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineminus">-var {</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineminus">-  Stanza,</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineminus">-  XMPPParser,</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineminus">-  SupportedFeatures,</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+var { XMPPSession, XMPPDefaultResource } = ChromeUtils.import(</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+);</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+var { Stanza, XMPPParser, SupportedFeatures } = ChromeUtils.import(</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+  &quot;resource:///modules/xmpp-xml.jsm&quot;</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+);</span>
<a href="#l44.27"></a><span id="l44.27"> </span>
<a href="#l44.28"></a><span id="l44.28"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l44.29"></a><span id="l44.29">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l44.30"></a><span id="l44.30"> );</span>
<a href="#l44.31"></a><span id="l44.31"> </span>
<a href="#l44.32"></a><span id="l44.32"> // PlainFullBindAuth is an authentication mechanism that works like</span>
<a href="#l44.33"></a><span id="l44.33"> // the standard PLAIN mechanism but adds a client-uses-full-bind-result</span>
<a href="#l44.34"></a><span id="l44.34"> // attribute to the auth stanza to tell the Google Talk servers that we</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineat">@@ -54,21 +51,23 @@ function* PlainFullBindAuth(aUsername, a</span>
<a href="#l44.36"></a><span id="l44.36">   let key = btoa(&quot;\0&quot; + aUsername + &quot;\0&quot; + aPassword);</span>
<a href="#l44.37"></a><span id="l44.37">   let attrs = {</span>
<a href="#l44.38"></a><span id="l44.38">     mechanism: &quot;PLAIN&quot;,</span>
<a href="#l44.39"></a><span id="l44.39">     &quot;xmlns:ga&quot;: &quot;http://www.google.com/talk/protocol/auth&quot;,</span>
<a href="#l44.40"></a><span id="l44.40">     &quot;ga:client-uses-full-bind-result&quot;: &quot;true&quot;,</span>
<a href="#l44.41"></a><span id="l44.41">   };</span>
<a href="#l44.42"></a><span id="l44.42">   let stanza = yield {</span>
<a href="#l44.43"></a><span id="l44.43">     send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, attrs, key),</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineminus">-    log: &quot;&lt;auth.../&gt; (PlainFullBindAuth base64 encoded username and password not logged)&quot;,</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+    log:</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+      &quot;&lt;auth.../&gt; (PlainFullBindAuth base64 encoded username and password not logged)&quot;,</span>
<a href="#l44.47"></a><span id="l44.47">   };</span>
<a href="#l44.48"></a><span id="l44.48"> </span>
<a href="#l44.49"></a><span id="l44.49" class="difflineminus">-  if (stanza.localName != &quot;success&quot;)</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+  if (stanza.localName != &quot;success&quot;) {</span>
<a href="#l44.51"></a><span id="l44.51">     throw new Error(&quot;Didn't receive the expected auth success stanza.&quot;);</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+  }</span>
<a href="#l44.53"></a><span id="l44.53"> }</span>
<a href="#l44.54"></a><span id="l44.54"> </span>
<a href="#l44.55"></a><span id="l44.55"> function GTalkAccount(aProtoInstance, aImAccount) {</span>
<a href="#l44.56"></a><span id="l44.56">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l44.57"></a><span id="l44.57"> }</span>
<a href="#l44.58"></a><span id="l44.58"> GTalkAccount.prototype = {</span>
<a href="#l44.59"></a><span id="l44.59">   __proto__: XMPPAccountPrototype,</span>
<a href="#l44.60"></a><span id="l44.60">   connect() {</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineat">@@ -78,43 +77,64 @@ GTalkAccount.prototype = {</span>
<a href="#l44.62"></a><span id="l44.62">     // doesn't contain an @, we prefer assuming that it's the domain</span>
<a href="#l44.63"></a><span id="l44.63">     // part that's been omitted.</span>
<a href="#l44.64"></a><span id="l44.64">     if (!this._jid.node) {</span>
<a href="#l44.65"></a><span id="l44.65">       // If the domain part was omitted, swap the node and domain parts,</span>
<a href="#l44.66"></a><span id="l44.66">       // use 'gmail.com' as the default domain, and tell the Google</span>
<a href="#l44.67"></a><span id="l44.67">       // Talk server that we will use the full bind result.</span>
<a href="#l44.68"></a><span id="l44.68">       this._jid.node = this._jid.domain;</span>
<a href="#l44.69"></a><span id="l44.69">       this._jid.domain = &quot;gmail.com&quot;;</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineminus">-      this.authMechanisms = {PLAIN: PlainFullBindAuth};</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+      this.authMechanisms = { PLAIN: PlainFullBindAuth };</span>
<a href="#l44.72"></a><span id="l44.72">     }</span>
<a href="#l44.73"></a><span id="l44.73"> </span>
<a href="#l44.74"></a><span id="l44.74">     // For the resource, if the user has edited the option, always use that.</span>
<a href="#l44.75"></a><span id="l44.75">     if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l44.76"></a><span id="l44.76">       let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l44.77"></a><span id="l44.77">       this._jid = this._setJID(this._jid.domain, this._jid.node, resource);</span>
<a href="#l44.78"></a><span id="l44.78">     }</span>
<a href="#l44.79"></a><span id="l44.79"> </span>
<a href="#l44.80"></a><span id="l44.80" class="difflineminus">-    this._connection =</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineminus">-      new XMPPSession(&quot;talk.google.com&quot;, 443,</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineminus">-                      &quot;require_tls&quot;, this._jid,</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineminus">-                      this.imAccount.password, this);</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+    this._connection = new XMPPSession(</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+      &quot;talk.google.com&quot;,</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+      443,</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineplus">+      &quot;require_tls&quot;,</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+      this._jid,</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineplus">+      this.imAccount.password,</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineplus">+      this</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+    );</span>
<a href="#l44.92"></a><span id="l44.92">   },</span>
<a href="#l44.93"></a><span id="l44.93"> };</span>
<a href="#l44.94"></a><span id="l44.94"> </span>
<a href="#l44.95"></a><span id="l44.95"> function GTalkProtocol() {</span>
<a href="#l44.96"></a><span id="l44.96">   ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l44.97"></a><span id="l44.97">   this.registerCommands();</span>
<a href="#l44.98"></a><span id="l44.98"> }</span>
<a href="#l44.99"></a><span id="l44.99"> GTalkProtocol.prototype = {</span>
<a href="#l44.100"></a><span id="l44.100">   __proto__: GenericProtocolPrototype,</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineminus">-  get normalizedName() { return &quot;gtalk&quot;; },</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineminus">-  get name() { return _(&quot;gtalk.protocolName&quot;); },</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-gtalk/skin/&quot;; },</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineminus">-  get usernameEmptyText() { return _(&quot;gtalk.usernameHint&quot;); },</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineminus">-  getAccount(aImAccount) { return new GTalkAccount(this, aImAccount); },</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+  get normalizedName() {</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+    return &quot;gtalk&quot;;</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+  },</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+  get name() {</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+    return _(&quot;gtalk.protocolName&quot;);</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+  },</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+    return &quot;chrome://prpl-gtalk/skin/&quot;;</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+  },</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+    return _(&quot;gtalk.usernameHint&quot;);</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+  },</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+    return new GTalkAccount(this, aImAccount);</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+  },</span>
<a href="#l44.121"></a><span id="l44.121">   options: {</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineminus">-    resource: {get label() { return _(&quot;options.resource&quot;); }, default: &quot;&quot;},</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineplus">+    resource: {</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineplus">+      get label() {</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+        return _(&quot;options.resource&quot;);</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+      },</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+    },</span>
<a href="#l44.129"></a><span id="l44.129">   },</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineminus">-  get chatHasTopic() { return true; },</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+    return true;</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineplus">+  },</span>
<a href="#l44.134"></a><span id="l44.134">   classID: Components.ID(&quot;{38a224c1-6748-49a9-8ab2-efc362b1000d}&quot;),</span>
<a href="#l44.135"></a><span id="l44.135"> };</span>
<a href="#l44.136"></a><span id="l44.136"> </span>
<a href="#l44.137"></a><span id="l44.137"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([GTalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/chat/protocols/irc/irc.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/chat/protocols/irc/irc.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -7,45 +7,53 @@ var {</span>
<a href="#l45.4"></a><span id="l45.4">   clearTimeout,</span>
<a href="#l45.5"></a><span id="l45.5">   EmptyEnumerator,</span>
<a href="#l45.6"></a><span id="l45.6">   setTimeout,</span>
<a href="#l45.7"></a><span id="l45.7">   executeSoon,</span>
<a href="#l45.8"></a><span id="l45.8">   l10nHelper,</span>
<a href="#l45.9"></a><span id="l45.9">   XPCOMUtils,</span>
<a href="#l45.10"></a><span id="l45.10">   nsSimpleEnumerator,</span>
<a href="#l45.11"></a><span id="l45.11"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l45.14"></a><span id="l45.14"> var {</span>
<a href="#l45.15"></a><span id="l45.15">   _,</span>
<a href="#l45.16"></a><span id="l45.16">   ctcpFormatToText,</span>
<a href="#l45.17"></a><span id="l45.17">   ctcpFormatToHTML,</span>
<a href="#l45.18"></a><span id="l45.18">   conversationErrorMessage,</span>
<a href="#l45.19"></a><span id="l45.19">   kListRefreshInterval,</span>
<a href="#l45.20"></a><span id="l45.20"> } = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineminus">-var {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+var { ircHandlers } = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l45.23"></a><span id="l45.23"> var {</span>
<a href="#l45.24"></a><span id="l45.24">   GenericAccountPrototype,</span>
<a href="#l45.25"></a><span id="l45.25">   GenericAccountBuddyPrototype,</span>
<a href="#l45.26"></a><span id="l45.26">   GenericConvIMPrototype,</span>
<a href="#l45.27"></a><span id="l45.27">   GenericConvChatPrototype,</span>
<a href="#l45.28"></a><span id="l45.28">   GenericConvChatBuddyPrototype,</span>
<a href="#l45.29"></a><span id="l45.29">   GenericConversationPrototype,</span>
<a href="#l45.30"></a><span id="l45.30">   GenericMessagePrototype,</span>
<a href="#l45.31"></a><span id="l45.31">   GenericProtocolPrototype,</span>
<a href="#l45.32"></a><span id="l45.32">   Message,</span>
<a href="#l45.33"></a><span id="l45.33">   TooltipInfo,</span>
<a href="#l45.34"></a><span id="l45.34"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-var {NormalizedMap} = ChromeUtils.import(&quot;resource:///modules/NormalizedMap.jsm&quot;);</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineminus">-var {Socket} = ChromeUtils.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+var { NormalizedMap } = ChromeUtils.import(</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+  &quot;resource:///modules/NormalizedMap.jsm&quot;</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+);</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+var { Socket } = ChromeUtils.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l45.41"></a><span id="l45.41"> </span>
<a href="#l45.42"></a><span id="l45.42" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;PluralForm&quot;,</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineminus">-  &quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+  this,</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+  &quot;PluralForm&quot;,</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineplus">+  &quot;resource://gre/modules/PluralForm.jsm&quot;</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+);</span>
<a href="#l45.49"></a><span id="l45.49"> </span>
<a href="#l45.50"></a><span id="l45.50" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;DownloadUtils&quot;,</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineminus">-  &quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineplus">+  this,</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineplus">+  &quot;DownloadUtils&quot;,</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+  &quot;resource://gre/modules/DownloadUtils.jsm&quot;</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+);</span>
<a href="#l45.57"></a><span id="l45.57"> </span>
<a href="#l45.58"></a><span id="l45.58"> XPCOMUtils.defineLazyGetter(this, &quot;_conv&quot;, () =&gt;</span>
<a href="#l45.59"></a><span id="l45.59">   l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l45.60"></a><span id="l45.60"> );</span>
<a href="#l45.61"></a><span id="l45.61"> </span>
<a href="#l45.62"></a><span id="l45.62"> /*</span>
<a href="#l45.63"></a><span id="l45.63">  * Parses a raw IRC message into an object (see section 2.3 of RFC 2812). This</span>
<a href="#l45.64"></a><span id="l45.64">  * returns an object with the following fields:</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineat">@@ -68,17 +76,17 @@ XPCOMUtils.defineLazyGetter(this, &quot;_conv</span>
<a href="#l45.66"></a><span id="l45.66">  * instead of &quot;nickname&quot; or &quot;servername&quot;.</span>
<a href="#l45.67"></a><span id="l45.67">  *</span>
<a href="#l45.68"></a><span id="l45.68">  * Inputs:</span>
<a href="#l45.69"></a><span id="l45.69">  *  aData       The raw string to parse, it should already have the \r\n</span>
<a href="#l45.70"></a><span id="l45.70">  *              stripped from the end.</span>
<a href="#l45.71"></a><span id="l45.71">  *  aOrigin     The default origin to use for unprefixed messages.</span>
<a href="#l45.72"></a><span id="l45.72">  */</span>
<a href="#l45.73"></a><span id="l45.73"> function ircMessage(aData, aOrigin) {</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineminus">-  let message = {rawMessage: aData};</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+  let message = { rawMessage: aData };</span>
<a href="#l45.76"></a><span id="l45.76">   let temp;</span>
<a href="#l45.77"></a><span id="l45.77"> </span>
<a href="#l45.78"></a><span id="l45.78">   // Splits the raw string into five parts. The third part, the command, is</span>
<a href="#l45.79"></a><span id="l45.79">   // required. A raw string looks like:</span>
<a href="#l45.80"></a><span id="l45.80">   //   [&quot;@&quot; &lt;tags&gt; &quot; &quot;] [&quot;:&quot; &lt;prefix&gt; &quot; &quot;] &lt;command&gt; [&quot; &quot; &lt;parameter&gt;]* [&quot;:&quot; &lt;last parameter&gt;]</span>
<a href="#l45.81"></a><span id="l45.81">   //     &lt;tags&gt;: /[^ ]+/</span>
<a href="#l45.82"></a><span id="l45.82">   //     &lt;prefix&gt;: :(&lt;server name&gt; | &lt;nickname&gt; [[&quot;!&quot; &lt;user&gt;] &quot;@&quot; &lt;host&gt;])</span>
<a href="#l45.83"></a><span id="l45.83">   //     &lt;command&gt;: /[^ ]+/</span>
<a href="#l45.84"></a><span id="l45.84" class="difflineat">@@ -86,149 +94,170 @@ function ircMessage(aData, aOrigin) {</span>
<a href="#l45.85"></a><span id="l45.85">   //     &lt;last parameter&gt;: /.+/</span>
<a href="#l45.86"></a><span id="l45.86">   // See http://joshualuckers.nl/2010/01/10/regular-expression-to-match-raw-irc-messages/</span>
<a href="#l45.87"></a><span id="l45.87">   // Note that this expression is slightly more aggressive in matching than RFC</span>
<a href="#l45.88"></a><span id="l45.88">   // 2812 would allow. It allows for empty parameters (besides the last</span>
<a href="#l45.89"></a><span id="l45.89">   // parameter, which can always be empty), by allowing multiple spaces.</span>
<a href="#l45.90"></a><span id="l45.90">   // (This is for compatibility with Unreal's 432 response, which returns an</span>
<a href="#l45.91"></a><span id="l45.91">   // empty first parameter.) It also allows a trailing space after the</span>
<a href="#l45.92"></a><span id="l45.92">   // &lt;parameter&gt;s when no &lt;last parameter&gt; is present (also occurs with Unreal).</span>
<a href="#l45.93"></a><span id="l45.93" class="difflineminus">-  if (!(temp = aData.match(/^(?:@([^ ]+) )?(?::([^ ]+) )?([^ ]+)((?: +[^: ][^ ]*)*)? *(?::([\s\S]*))?$/)))</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineminus">-    throw new Error(&quot;Couldn't parse message: \&quot;&quot; + aData + &quot;\&quot;&quot;);</span>
<a href="#l45.95"></a><span id="l45.95" class="difflineplus">+  if (</span>
<a href="#l45.96"></a><span id="l45.96" class="difflineplus">+    !(temp = aData.match(</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineplus">+      /^(?:@([^ ]+) )?(?::([^ ]+) )?([^ ]+)((?: +[^: ][^ ]*)*)? *(?::([\s\S]*))?$/</span>
<a href="#l45.98"></a><span id="l45.98" class="difflineplus">+    ))</span>
<a href="#l45.99"></a><span id="l45.99" class="difflineplus">+  ) {</span>
<a href="#l45.100"></a><span id="l45.100" class="difflineplus">+    throw new Error(&quot;Couldn't parse message: \&quot;&quot; + aData + '&quot;');</span>
<a href="#l45.101"></a><span id="l45.101" class="difflineplus">+  }</span>
<a href="#l45.102"></a><span id="l45.102"> </span>
<a href="#l45.103"></a><span id="l45.103">   message.command = temp[3];</span>
<a href="#l45.104"></a><span id="l45.104">   // Space separated parameters. Since we expect a space as the first thing</span>
<a href="#l45.105"></a><span id="l45.105">   // here, we want to ignore the first value (which is empty).</span>
<a href="#l45.106"></a><span id="l45.106">   message.params = temp[4] ? temp[4].split(&quot; &quot;).slice(1) : [];</span>
<a href="#l45.107"></a><span id="l45.107">   // Last parameter can contain spaces or be an empty string.</span>
<a href="#l45.108"></a><span id="l45.108" class="difflineminus">-  if (temp[5] !== undefined)</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineplus">+  if (temp[5] !== undefined) {</span>
<a href="#l45.110"></a><span id="l45.110">     message.params.push(temp[5]);</span>
<a href="#l45.111"></a><span id="l45.111" class="difflineplus">+  }</span>
<a href="#l45.112"></a><span id="l45.112"> </span>
<a href="#l45.113"></a><span id="l45.113">   // Handle the prefix part of the message per RFC 2812 Section 2.3.</span>
<a href="#l45.114"></a><span id="l45.114"> </span>
<a href="#l45.115"></a><span id="l45.115">   // If no prefix is given, assume the current server is the origin.</span>
<a href="#l45.116"></a><span id="l45.116" class="difflineminus">-  if (!temp[2])</span>
<a href="#l45.117"></a><span id="l45.117" class="difflineplus">+  if (!temp[2]) {</span>
<a href="#l45.118"></a><span id="l45.118">     temp[2] = aOrigin;</span>
<a href="#l45.119"></a><span id="l45.119" class="difflineplus">+  }</span>
<a href="#l45.120"></a><span id="l45.120"> </span>
<a href="#l45.121"></a><span id="l45.121">   // Split the prefix into separate nickname, username and hostname fields as:</span>
<a href="#l45.122"></a><span id="l45.122">   //   :(servername|(nickname[[!user]@host]))</span>
<a href="#l45.123"></a><span id="l45.123">   [message.origin, message.user, message.host] = temp[2].split(/[!@]/);</span>
<a href="#l45.124"></a><span id="l45.124"> </span>
<a href="#l45.125"></a><span id="l45.125">   // Store the tags in a Map, see IRCv3.2 Message Tags.</span>
<a href="#l45.126"></a><span id="l45.126">   message.tags = new Map();</span>
<a href="#l45.127"></a><span id="l45.127"> </span>
<a href="#l45.128"></a><span id="l45.128">   if (temp[1]) {</span>
<a href="#l45.129"></a><span id="l45.129">     let tags = temp[1].split(&quot;;&quot;);</span>
<a href="#l45.130"></a><span id="l45.130" class="difflineminus">-    tags.forEach((tag) =&gt; {</span>
<a href="#l45.131"></a><span id="l45.131" class="difflineplus">+    tags.forEach(tag =&gt; {</span>
<a href="#l45.132"></a><span id="l45.132">       let [key, value] = tag.split(&quot;=&quot;);</span>
<a href="#l45.133"></a><span id="l45.133"> </span>
<a href="#l45.134"></a><span id="l45.134">       if (value) {</span>
<a href="#l45.135"></a><span id="l45.135">         // Unescape tag values according to this mapping:</span>
<a href="#l45.136"></a><span id="l45.136">         // \\ = \</span>
<a href="#l45.137"></a><span id="l45.137">         // \n = LF</span>
<a href="#l45.138"></a><span id="l45.138">         // \r = CR</span>
<a href="#l45.139"></a><span id="l45.139">         // \s = SPACE</span>
<a href="#l45.140"></a><span id="l45.140">         // \: = ;</span>
<a href="#l45.141"></a><span id="l45.141">         // everything else stays identical.</span>
<a href="#l45.142"></a><span id="l45.142">         value = value.replace(/\\(.)/g, (str, type) =&gt; {</span>
<a href="#l45.143"></a><span id="l45.143" class="difflineminus">-          if (type == &quot;\\&quot;)</span>
<a href="#l45.144"></a><span id="l45.144" class="difflineplus">+          if (type == &quot;\\&quot;) {</span>
<a href="#l45.145"></a><span id="l45.145">             return &quot;\\&quot;;</span>
<a href="#l45.146"></a><span id="l45.146" class="difflineminus">-          else if (type == &quot;n&quot;)</span>
<a href="#l45.147"></a><span id="l45.147" class="difflineplus">+          } else if (type == &quot;n&quot;) {</span>
<a href="#l45.148"></a><span id="l45.148">             return &quot;\n&quot;;</span>
<a href="#l45.149"></a><span id="l45.149" class="difflineminus">-          else if (type == &quot;r&quot;)</span>
<a href="#l45.150"></a><span id="l45.150" class="difflineplus">+          } else if (type == &quot;r&quot;) {</span>
<a href="#l45.151"></a><span id="l45.151">             return &quot;\r&quot;;</span>
<a href="#l45.152"></a><span id="l45.152" class="difflineminus">-          else if (type == &quot;s&quot;)</span>
<a href="#l45.153"></a><span id="l45.153" class="difflineplus">+          } else if (type == &quot;s&quot;) {</span>
<a href="#l45.154"></a><span id="l45.154">             return &quot; &quot;;</span>
<a href="#l45.155"></a><span id="l45.155" class="difflineminus">-          else if (type == &quot;:&quot;)</span>
<a href="#l45.156"></a><span id="l45.156" class="difflineplus">+          } else if (type == &quot;:&quot;) {</span>
<a href="#l45.157"></a><span id="l45.157">             return &quot;;&quot;;</span>
<a href="#l45.158"></a><span id="l45.158" class="difflineplus">+          }</span>
<a href="#l45.159"></a><span id="l45.159">           // Ignore the backslash, not specified by the spec, but as it says</span>
<a href="#l45.160"></a><span id="l45.160">           // backslashes must be escaped this case should not occur in a valid</span>
<a href="#l45.161"></a><span id="l45.161">           // tag value.</span>
<a href="#l45.162"></a><span id="l45.162">           return type;</span>
<a href="#l45.163"></a><span id="l45.163">         });</span>
<a href="#l45.164"></a><span id="l45.164">       }</span>
<a href="#l45.165"></a><span id="l45.165">       // The tag key can typically have the form of example.com/aaa for vendor</span>
<a href="#l45.166"></a><span id="l45.166">       // defined tags. The spec wants any unicode characters in URLs to be</span>
<a href="#l45.167"></a><span id="l45.167">       // in punycode (xn--). These are not unescaped to their unicode value.</span>
<a href="#l45.168"></a><span id="l45.168">       message.tags.set(key, value);</span>
<a href="#l45.169"></a><span id="l45.169">     });</span>
<a href="#l45.170"></a><span id="l45.170">   }</span>
<a href="#l45.171"></a><span id="l45.171"> </span>
<a href="#l45.172"></a><span id="l45.172">   // It is occasionally useful to have a &quot;source&quot; which is a combination of</span>
<a href="#l45.173"></a><span id="l45.173">   // user@host.</span>
<a href="#l45.174"></a><span id="l45.174" class="difflineminus">-  if (message.user)</span>
<a href="#l45.175"></a><span id="l45.175" class="difflineplus">+  if (message.user) {</span>
<a href="#l45.176"></a><span id="l45.176">     message.source = message.user + &quot;@&quot; + message.host;</span>
<a href="#l45.177"></a><span id="l45.177" class="difflineminus">-  else if (message.host)</span>
<a href="#l45.178"></a><span id="l45.178" class="difflineplus">+  } else if (message.host) {</span>
<a href="#l45.179"></a><span id="l45.179">     message.source = message.host;</span>
<a href="#l45.180"></a><span id="l45.180" class="difflineminus">-  else</span>
<a href="#l45.181"></a><span id="l45.181" class="difflineplus">+  } else {</span>
<a href="#l45.182"></a><span id="l45.182">     message.source = &quot;&quot;;</span>
<a href="#l45.183"></a><span id="l45.183" class="difflineplus">+  }</span>
<a href="#l45.184"></a><span id="l45.184"> </span>
<a href="#l45.185"></a><span id="l45.185">   return message;</span>
<a href="#l45.186"></a><span id="l45.186"> }</span>
<a href="#l45.187"></a><span id="l45.187"> </span>
<a href="#l45.188"></a><span id="l45.188"> // This handles a mode change string for both channels and participants. A mode</span>
<a href="#l45.189"></a><span id="l45.189"> // change string is of the form:</span>
<a href="#l45.190"></a><span id="l45.190"> //   aAddNewMode is true if modes are being added, false otherwise.</span>
<a href="#l45.191"></a><span id="l45.191"> //   aNewModes is an array of mode characters.</span>
<a href="#l45.192"></a><span id="l45.192"> function _setMode(aAddNewMode, aNewModes) {</span>
<a href="#l45.193"></a><span id="l45.193">   // Check each mode being added/removed.</span>
<a href="#l45.194"></a><span id="l45.194">   for (let newMode of aNewModes) {</span>
<a href="#l45.195"></a><span id="l45.195">     let hasMode = this._modes.has(newMode);</span>
<a href="#l45.196"></a><span id="l45.196">     // If the mode is in the list of modes and we want to remove it.</span>
<a href="#l45.197"></a><span id="l45.197" class="difflineminus">-    if (hasMode &amp;&amp; !aAddNewMode)</span>
<a href="#l45.198"></a><span id="l45.198" class="difflineplus">+    if (hasMode &amp;&amp; !aAddNewMode) {</span>
<a href="#l45.199"></a><span id="l45.199">       this._modes.delete(newMode);</span>
<a href="#l45.200"></a><span id="l45.200" class="difflineplus">+    }</span>
<a href="#l45.201"></a><span id="l45.201">     // If the mode is not in the list of modes and we want to add it.</span>
<a href="#l45.202"></a><span id="l45.202" class="difflineminus">-    else if (!hasMode &amp;&amp; aAddNewMode)</span>
<a href="#l45.203"></a><span id="l45.203" class="difflineplus">+    else if (!hasMode &amp;&amp; aAddNewMode) {</span>
<a href="#l45.204"></a><span id="l45.204">       this._modes.add(newMode);</span>
<a href="#l45.205"></a><span id="l45.205" class="difflineplus">+    }</span>
<a href="#l45.206"></a><span id="l45.206">   }</span>
<a href="#l45.207"></a><span id="l45.207"> }</span>
<a href="#l45.208"></a><span id="l45.208"> </span>
<a href="#l45.209"></a><span id="l45.209"> function TagMessage(aMessage, aTagName) {</span>
<a href="#l45.210"></a><span id="l45.210" class="difflineminus">-    this.message = aMessage;</span>
<a href="#l45.211"></a><span id="l45.211" class="difflineminus">-    this.tagName = aTagName;</span>
<a href="#l45.212"></a><span id="l45.212" class="difflineminus">-    this.tagValue = aMessage.tags.get(aTagName);</span>
<a href="#l45.213"></a><span id="l45.213" class="difflineplus">+  this.message = aMessage;</span>
<a href="#l45.214"></a><span id="l45.214" class="difflineplus">+  this.tagName = aTagName;</span>
<a href="#l45.215"></a><span id="l45.215" class="difflineplus">+  this.tagValue = aMessage.tags.get(aTagName);</span>
<a href="#l45.216"></a><span id="l45.216"> }</span>
<a href="#l45.217"></a><span id="l45.217"> </span>
<a href="#l45.218"></a><span id="l45.218"> // Properties / methods shared by both ircChannel and ircConversation.</span>
<a href="#l45.219"></a><span id="l45.219"> var GenericIRCConversation = {</span>
<a href="#l45.220"></a><span id="l45.220">   _observedNicks: [],</span>
<a href="#l45.221"></a><span id="l45.221">   // This is set to true after a message is sent to notify the 401</span>
<a href="#l45.222"></a><span id="l45.222">   // ERR_NOSUCHNICK handler to write an error message to the conversation.</span>
<a href="#l45.223"></a><span id="l45.223">   _pendingMessage: false,</span>
<a href="#l45.224"></a><span id="l45.224">   _waitingForNick: false,</span>
<a href="#l45.225"></a><span id="l45.225"> </span>
<a href="#l45.226"></a><span id="l45.226" class="difflineminus">-  normalizeNick(aNick) { return this._account.normalizeNick(aNick); },</span>
<a href="#l45.227"></a><span id="l45.227" class="difflineplus">+  normalizeNick(aNick) {</span>
<a href="#l45.228"></a><span id="l45.228" class="difflineplus">+    return this._account.normalizeNick(aNick);</span>
<a href="#l45.229"></a><span id="l45.229" class="difflineplus">+  },</span>
<a href="#l45.230"></a><span id="l45.230"> </span>
<a href="#l45.231"></a><span id="l45.231">   // This will calculate the maximum number of bytes that are left for a message</span>
<a href="#l45.232"></a><span id="l45.232">   // typed by the user by calculate the amount of bytes that would be used by</span>
<a href="#l45.233"></a><span id="l45.233">   // the IRC messaging.</span>
<a href="#l45.234"></a><span id="l45.234">   getMaxMessageLength() {</span>
<a href="#l45.235"></a><span id="l45.235">     // Build the shortest possible message that could be sent to other users.</span>
<a href="#l45.236"></a><span id="l45.236" class="difflineminus">-    let baseMessage = &quot;:&quot; + this._account._nickname + this._account.prefix +</span>
<a href="#l45.237"></a><span id="l45.237" class="difflineminus">-                      &quot; &quot; + this._account.buildMessage(&quot;PRIVMSG&quot;, this.name) +</span>
<a href="#l45.238"></a><span id="l45.238" class="difflineminus">-                      &quot; :\r\n&quot;;</span>
<a href="#l45.239"></a><span id="l45.239" class="difflineminus">-    return this._account.maxMessageLength -</span>
<a href="#l45.240"></a><span id="l45.240" class="difflineminus">-           this._account.countBytes(baseMessage);</span>
<a href="#l45.241"></a><span id="l45.241" class="difflineplus">+    let baseMessage =</span>
<a href="#l45.242"></a><span id="l45.242" class="difflineplus">+      &quot;:&quot; +</span>
<a href="#l45.243"></a><span id="l45.243" class="difflineplus">+      this._account._nickname +</span>
<a href="#l45.244"></a><span id="l45.244" class="difflineplus">+      this._account.prefix +</span>
<a href="#l45.245"></a><span id="l45.245" class="difflineplus">+      &quot; &quot; +</span>
<a href="#l45.246"></a><span id="l45.246" class="difflineplus">+      this._account.buildMessage(&quot;PRIVMSG&quot;, this.name) +</span>
<a href="#l45.247"></a><span id="l45.247" class="difflineplus">+      &quot; :\r\n&quot;;</span>
<a href="#l45.248"></a><span id="l45.248" class="difflineplus">+    return (</span>
<a href="#l45.249"></a><span id="l45.249" class="difflineplus">+      this._account.maxMessageLength - this._account.countBytes(baseMessage)</span>
<a href="#l45.250"></a><span id="l45.250" class="difflineplus">+    );</span>
<a href="#l45.251"></a><span id="l45.251">   },</span>
<a href="#l45.252"></a><span id="l45.252">   /**</span>
<a href="#l45.253"></a><span id="l45.253">    * @param {string} aWho - Message author's username.</span>
<a href="#l45.254"></a><span id="l45.254">    * @param {string} aMessage - Message text.</span>
<a href="#l45.255"></a><span id="l45.255">    * @param {Object} aObject - Other properties to set on the imMessage.</span>
<a href="#l45.256"></a><span id="l45.256">    */</span>
<a href="#l45.257"></a><span id="l45.257">   handleTags(aWho, aMessage, aObject) {</span>
<a href="#l45.258"></a><span id="l45.258">     let messageProps = aObject;</span>
<a href="#l45.259"></a><span id="l45.259">     if (&quot;tags&quot; in aObject &amp;&amp; ircHandlers.hasTagHandlers) {</span>
<a href="#l45.260"></a><span id="l45.260">       // Merge extra info for the handler into the props.</span>
<a href="#l45.261"></a><span id="l45.261" class="difflineminus">-      messageProps = Object.assign({</span>
<a href="#l45.262"></a><span id="l45.262" class="difflineminus">-        who: aWho,</span>
<a href="#l45.263"></a><span id="l45.263" class="difflineminus">-        message: aMessage,</span>
<a href="#l45.264"></a><span id="l45.264" class="difflineminus">-        get originalMessage() {</span>
<a href="#l45.265"></a><span id="l45.265" class="difflineminus">-          return aMessage;</span>
<a href="#l45.266"></a><span id="l45.266" class="difflineplus">+      messageProps = Object.assign(</span>
<a href="#l45.267"></a><span id="l45.267" class="difflineplus">+        {</span>
<a href="#l45.268"></a><span id="l45.268" class="difflineplus">+          who: aWho,</span>
<a href="#l45.269"></a><span id="l45.269" class="difflineplus">+          message: aMessage,</span>
<a href="#l45.270"></a><span id="l45.270" class="difflineplus">+          get originalMessage() {</span>
<a href="#l45.271"></a><span id="l45.271" class="difflineplus">+            return aMessage;</span>
<a href="#l45.272"></a><span id="l45.272" class="difflineplus">+          },</span>
<a href="#l45.273"></a><span id="l45.273">         },</span>
<a href="#l45.274"></a><span id="l45.274" class="difflineminus">-      }, messageProps);</span>
<a href="#l45.275"></a><span id="l45.275" class="difflineplus">+        messageProps</span>
<a href="#l45.276"></a><span id="l45.276" class="difflineplus">+      );</span>
<a href="#l45.277"></a><span id="l45.277">       for (let tag of aObject.tags.keys()) {</span>
<a href="#l45.278"></a><span id="l45.278">         // Unhandled tags may be common, since a tag does not have to be handled</span>
<a href="#l45.279"></a><span id="l45.279">         // with a tag handler, it may also be handled by a message command handler.</span>
<a href="#l45.280"></a><span id="l45.280">         ircHandlers.handleTag(this._account, new TagMessage(messageProps, tag));</span>
<a href="#l45.281"></a><span id="l45.281">       }</span>
<a href="#l45.282"></a><span id="l45.282"> </span>
<a href="#l45.283"></a><span id="l45.283">       // Remove helper prop for tag handlers. We don't want to remove the other</span>
<a href="#l45.284"></a><span id="l45.284">       // ones, since they might have been changed and will override aWho and</span>
<a href="#l45.285"></a><span id="l45.285" class="difflineat">@@ -251,132 +280,154 @@ var GenericIRCConversation = {</span>
<a href="#l45.286"></a><span id="l45.286">     let maxLength = this.getMaxMessageLength();</span>
<a href="#l45.287"></a><span id="l45.287"> </span>
<a href="#l45.288"></a><span id="l45.288">     // Attempt to smartly split a string into multiple lines (based on the</span>
<a href="#l45.289"></a><span id="l45.289">     // maximum number of characters the message can contain).</span>
<a href="#l45.290"></a><span id="l45.290">     for (let i = 0; i &lt; messages.length; ++i) {</span>
<a href="#l45.291"></a><span id="l45.291">       let message = messages[i];</span>
<a href="#l45.292"></a><span id="l45.292">       let length = this._account.countBytes(message);</span>
<a href="#l45.293"></a><span id="l45.293">       // The message is short enough.</span>
<a href="#l45.294"></a><span id="l45.294" class="difflineminus">-      if (length &lt;= maxLength)</span>
<a href="#l45.295"></a><span id="l45.295" class="difflineplus">+      if (length &lt;= maxLength) {</span>
<a href="#l45.296"></a><span id="l45.296">         continue;</span>
<a href="#l45.297"></a><span id="l45.297" class="difflineplus">+      }</span>
<a href="#l45.298"></a><span id="l45.298"> </span>
<a href="#l45.299"></a><span id="l45.299">       // Find the location of a space before the maximum length.</span>
<a href="#l45.300"></a><span id="l45.300">       let index = message.lastIndexOf(&quot; &quot;, maxLength);</span>
<a href="#l45.301"></a><span id="l45.301"> </span>
<a href="#l45.302"></a><span id="l45.302">       // Remove the current message and insert the two new ones. If no space was</span>
<a href="#l45.303"></a><span id="l45.303">       // found, cut the first message to the maximum length and start the second</span>
<a href="#l45.304"></a><span id="l45.304">       // message one character after that. If a space was found, exclude it.</span>
<a href="#l45.305"></a><span id="l45.305" class="difflineminus">-      messages.splice(i, 1, message.substr(0, index == -1 ? maxLength : index),</span>
<a href="#l45.306"></a><span id="l45.306" class="difflineminus">-                      message.substr((index + 1) || maxLength));</span>
<a href="#l45.307"></a><span id="l45.307" class="difflineplus">+      messages.splice(</span>
<a href="#l45.308"></a><span id="l45.308" class="difflineplus">+        i,</span>
<a href="#l45.309"></a><span id="l45.309" class="difflineplus">+        1,</span>
<a href="#l45.310"></a><span id="l45.310" class="difflineplus">+        message.substr(0, index == -1 ? maxLength : index),</span>
<a href="#l45.311"></a><span id="l45.311" class="difflineplus">+        message.substr(index + 1 || maxLength)</span>
<a href="#l45.312"></a><span id="l45.312" class="difflineplus">+      );</span>
<a href="#l45.313"></a><span id="l45.313">     }</span>
<a href="#l45.314"></a><span id="l45.314"> </span>
<a href="#l45.315"></a><span id="l45.315" class="difflineminus">-    if (aCount)</span>
<a href="#l45.316"></a><span id="l45.316" class="difflineplus">+    if (aCount) {</span>
<a href="#l45.317"></a><span id="l45.317">       aCount.value = messages.length;</span>
<a href="#l45.318"></a><span id="l45.318" class="difflineplus">+    }</span>
<a href="#l45.319"></a><span id="l45.319"> </span>
<a href="#l45.320"></a><span id="l45.320">     return messages;</span>
<a href="#l45.321"></a><span id="l45.321">   },</span>
<a href="#l45.322"></a><span id="l45.322">   sendMsg(aMessage, aIsNotice) {</span>
<a href="#l45.323"></a><span id="l45.323" class="difflineminus">-    if (!aMessage.length)</span>
<a href="#l45.324"></a><span id="l45.324" class="difflineplus">+    if (!aMessage.length) {</span>
<a href="#l45.325"></a><span id="l45.325">       return;</span>
<a href="#l45.326"></a><span id="l45.326" class="difflineplus">+    }</span>
<a href="#l45.327"></a><span id="l45.327"> </span>
<a href="#l45.328"></a><span id="l45.328" class="difflineminus">-    if (!this._account.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;,</span>
<a href="#l45.329"></a><span id="l45.329" class="difflineminus">-                                   [this.name, aMessage])) {</span>
<a href="#l45.330"></a><span id="l45.330" class="difflineminus">-      this.writeMessage(this._account._currentServerName,</span>
<a href="#l45.331"></a><span id="l45.331" class="difflineminus">-                        _(&quot;error.sendMessageFailed&quot;),</span>
<a href="#l45.332"></a><span id="l45.332" class="difflineminus">-                        {error: true, system: true});</span>
<a href="#l45.333"></a><span id="l45.333" class="difflineplus">+    if (</span>
<a href="#l45.334"></a><span id="l45.334" class="difflineplus">+      !this._account.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [</span>
<a href="#l45.335"></a><span id="l45.335" class="difflineplus">+        this.name,</span>
<a href="#l45.336"></a><span id="l45.336" class="difflineplus">+        aMessage,</span>
<a href="#l45.337"></a><span id="l45.337" class="difflineplus">+      ])</span>
<a href="#l45.338"></a><span id="l45.338" class="difflineplus">+    ) {</span>
<a href="#l45.339"></a><span id="l45.339" class="difflineplus">+      this.writeMessage(</span>
<a href="#l45.340"></a><span id="l45.340" class="difflineplus">+        this._account._currentServerName,</span>
<a href="#l45.341"></a><span id="l45.341" class="difflineplus">+        _(&quot;error.sendMessageFailed&quot;),</span>
<a href="#l45.342"></a><span id="l45.342" class="difflineplus">+        { error: true, system: true }</span>
<a href="#l45.343"></a><span id="l45.343" class="difflineplus">+      );</span>
<a href="#l45.344"></a><span id="l45.344">       return;</span>
<a href="#l45.345"></a><span id="l45.345">     }</span>
<a href="#l45.346"></a><span id="l45.346"> </span>
<a href="#l45.347"></a><span id="l45.347">     // Since the server doesn't send us a message back, just assume the</span>
<a href="#l45.348"></a><span id="l45.348">     // message was received and immediately show it.</span>
<a href="#l45.349"></a><span id="l45.349" class="difflineminus">-    this.writeMessage(this._account._nickname, aMessage, {outgoing: true});</span>
<a href="#l45.350"></a><span id="l45.350" class="difflineplus">+    this.writeMessage(this._account._nickname, aMessage, { outgoing: true });</span>
<a href="#l45.351"></a><span id="l45.351"> </span>
<a href="#l45.352"></a><span id="l45.352">     this._pendingMessage = true;</span>
<a href="#l45.353"></a><span id="l45.353">   },</span>
<a href="#l45.354"></a><span id="l45.354">   // IRC doesn't support typing notifications, but it does have a maximum</span>
<a href="#l45.355"></a><span id="l45.355">   // message length.</span>
<a href="#l45.356"></a><span id="l45.356">   sendTyping(aString) {</span>
<a href="#l45.357"></a><span id="l45.357" class="difflineminus">-    let longestLineLength =</span>
<a href="#l45.358"></a><span id="l45.358" class="difflineminus">-      Math.max.apply(null, aString.split(&quot;\n&quot;).map(this._account.countBytes,</span>
<a href="#l45.359"></a><span id="l45.359" class="difflineminus">-                                                   this._account));</span>
<a href="#l45.360"></a><span id="l45.360" class="difflineplus">+    let longestLineLength = Math.max.apply(</span>
<a href="#l45.361"></a><span id="l45.361" class="difflineplus">+      null,</span>
<a href="#l45.362"></a><span id="l45.362" class="difflineplus">+      aString.split(&quot;\n&quot;).map(this._account.countBytes, this._account)</span>
<a href="#l45.363"></a><span id="l45.363" class="difflineplus">+    );</span>
<a href="#l45.364"></a><span id="l45.364">     return this.getMaxMessageLength() - longestLineLength;</span>
<a href="#l45.365"></a><span id="l45.365">   },</span>
<a href="#l45.366"></a><span id="l45.366"> </span>
<a href="#l45.367"></a><span id="l45.367">   requestCurrentWhois(aNick) {</span>
<a href="#l45.368"></a><span id="l45.368" class="difflineminus">-    if (!this._observedNicks.length)</span>
<a href="#l45.369"></a><span id="l45.369" class="difflineplus">+    if (!this._observedNicks.length) {</span>
<a href="#l45.370"></a><span id="l45.370">       Services.obs.addObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l45.371"></a><span id="l45.371" class="difflineplus">+    }</span>
<a href="#l45.372"></a><span id="l45.372">     this._observedNicks.push(this.normalizeNick(aNick));</span>
<a href="#l45.373"></a><span id="l45.373">     this._account.requestCurrentWhois(aNick);</span>
<a href="#l45.374"></a><span id="l45.374">   },</span>
<a href="#l45.375"></a><span id="l45.375"> </span>
<a href="#l45.376"></a><span id="l45.376">   observe(aSubject, aTopic, aData) {</span>
<a href="#l45.377"></a><span id="l45.377" class="difflineminus">-    if (aTopic != &quot;user-info-received&quot;)</span>
<a href="#l45.378"></a><span id="l45.378" class="difflineplus">+    if (aTopic != &quot;user-info-received&quot;) {</span>
<a href="#l45.379"></a><span id="l45.379">       return;</span>
<a href="#l45.380"></a><span id="l45.380" class="difflineplus">+    }</span>
<a href="#l45.381"></a><span id="l45.381"> </span>
<a href="#l45.382"></a><span id="l45.382">     let nick = this.normalizeNick(aData);</span>
<a href="#l45.383"></a><span id="l45.383">     let nickIndex = this._observedNicks.indexOf(nick);</span>
<a href="#l45.384"></a><span id="l45.384" class="difflineminus">-    if (nickIndex == -1)</span>
<a href="#l45.385"></a><span id="l45.385" class="difflineplus">+    if (nickIndex == -1) {</span>
<a href="#l45.386"></a><span id="l45.386">       return;</span>
<a href="#l45.387"></a><span id="l45.387" class="difflineplus">+    }</span>
<a href="#l45.388"></a><span id="l45.388"> </span>
<a href="#l45.389"></a><span id="l45.389">     // Remove the nick from the list of nicks that are being waited to received.</span>
<a href="#l45.390"></a><span id="l45.390">     this._observedNicks.splice(nickIndex, 1);</span>
<a href="#l45.391"></a><span id="l45.391"> </span>
<a href="#l45.392"></a><span id="l45.392">     // If this is the last nick, remove the observer.</span>
<a href="#l45.393"></a><span id="l45.393" class="difflineminus">-    if (!this._observedNicks.length)</span>
<a href="#l45.394"></a><span id="l45.394" class="difflineplus">+    if (!this._observedNicks.length) {</span>
<a href="#l45.395"></a><span id="l45.395">       Services.obs.removeObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l45.396"></a><span id="l45.396" class="difflineplus">+    }</span>
<a href="#l45.397"></a><span id="l45.397"> </span>
<a href="#l45.398"></a><span id="l45.398">     // If we are waiting for the conversation name, set it.</span>
<a href="#l45.399"></a><span id="l45.399">     let account = this._account;</span>
<a href="#l45.400"></a><span id="l45.400">     if (this._waitingForNick &amp;&amp; nick == this.normalizedName) {</span>
<a href="#l45.401"></a><span id="l45.401" class="difflineminus">-      if (account.whoisInformation.has(nick))</span>
<a href="#l45.402"></a><span id="l45.402" class="difflineplus">+      if (account.whoisInformation.has(nick)) {</span>
<a href="#l45.403"></a><span id="l45.403">         this.updateNick(account.whoisInformation.get(nick).nick);</span>
<a href="#l45.404"></a><span id="l45.404" class="difflineplus">+      }</span>
<a href="#l45.405"></a><span id="l45.405">       delete this._waitingForNick;</span>
<a href="#l45.406"></a><span id="l45.406">       return;</span>
<a href="#l45.407"></a><span id="l45.407">     }</span>
<a href="#l45.408"></a><span id="l45.408"> </span>
<a href="#l45.409"></a><span id="l45.409">     // Otherwise, print the requested whois information.</span>
<a href="#l45.410"></a><span id="l45.410" class="difflineminus">-    let type = {system: true, noLog: true};</span>
<a href="#l45.411"></a><span id="l45.411" class="difflineplus">+    let type = { system: true, noLog: true };</span>
<a href="#l45.412"></a><span id="l45.412">     // RFC 2812 errors 401 and 406 result in there being no entry for the nick.</span>
<a href="#l45.413"></a><span id="l45.413">     if (!account.whoisInformation.has(nick)) {</span>
<a href="#l45.414"></a><span id="l45.414">       this.writeMessage(null, _(&quot;message.unknownNick&quot;, nick), type);</span>
<a href="#l45.415"></a><span id="l45.415">       return;</span>
<a href="#l45.416"></a><span id="l45.416">     }</span>
<a href="#l45.417"></a><span id="l45.417">     // If the nick is offline, tell the user. In that case, it's WHOWAS info.</span>
<a href="#l45.418"></a><span id="l45.418">     let msgType = &quot;message.whois&quot;;</span>
<a href="#l45.419"></a><span id="l45.419" class="difflineminus">-    if (&quot;offline&quot; in account.whoisInformation.get(nick))</span>
<a href="#l45.420"></a><span id="l45.420" class="difflineplus">+    if (&quot;offline&quot; in account.whoisInformation.get(nick)) {</span>
<a href="#l45.421"></a><span id="l45.421">       msgType = &quot;message.whowas&quot;;</span>
<a href="#l45.422"></a><span id="l45.422" class="difflineplus">+    }</span>
<a href="#l45.423"></a><span id="l45.423">     let msg = _(msgType, account.whoisInformation.get(nick).nick);</span>
<a href="#l45.424"></a><span id="l45.424"> </span>
<a href="#l45.425"></a><span id="l45.425">     // Iterate over each field.</span>
<a href="#l45.426"></a><span id="l45.426">     let tooltipInfo = aSubject.QueryInterface(Ci.nsISimpleEnumerator);</span>
<a href="#l45.427"></a><span id="l45.427">     while (tooltipInfo.hasMoreElements()) {</span>
<a href="#l45.428"></a><span id="l45.428">       let elt = tooltipInfo.getNext().QueryInterface(Ci.prplITooltipInfo);</span>
<a href="#l45.429"></a><span id="l45.429">       switch (elt.type) {</span>
<a href="#l45.430"></a><span id="l45.430">         case Ci.prplITooltipInfo.pair:</span>
<a href="#l45.431"></a><span id="l45.431">         case Ci.prplITooltipInfo.sectionHeader:</span>
<a href="#l45.432"></a><span id="l45.432">           msg += &quot;\n&quot; + _(&quot;message.whoisEntry&quot;, elt.label, elt.value);</span>
<a href="#l45.433"></a><span id="l45.433">           break;</span>
<a href="#l45.434"></a><span id="l45.434">         case Ci.prplITooltipInfo.sectionBreak:</span>
<a href="#l45.435"></a><span id="l45.435">           break;</span>
<a href="#l45.436"></a><span id="l45.436">         case Ci.prplITooltipInfo.status:</span>
<a href="#l45.437"></a><span id="l45.437" class="difflineminus">-          if (elt.label != Ci.imIStatusInfo.STATUS_AWAY)</span>
<a href="#l45.438"></a><span id="l45.438" class="difflineplus">+          if (elt.label != Ci.imIStatusInfo.STATUS_AWAY) {</span>
<a href="#l45.439"></a><span id="l45.439">             break;</span>
<a href="#l45.440"></a><span id="l45.440" class="difflineplus">+          }</span>
<a href="#l45.441"></a><span id="l45.441">           // The away message has no tooltipInfo.pair entry.</span>
<a href="#l45.442"></a><span id="l45.442">           msg += &quot;\n&quot; + _(&quot;message.whoisEntry&quot;, _(&quot;tooltip.away&quot;), elt.value);</span>
<a href="#l45.443"></a><span id="l45.443">           break;</span>
<a href="#l45.444"></a><span id="l45.444">       }</span>
<a href="#l45.445"></a><span id="l45.445">     }</span>
<a href="#l45.446"></a><span id="l45.446">     this.writeMessage(null, msg, type);</span>
<a href="#l45.447"></a><span id="l45.447">   },</span>
<a href="#l45.448"></a><span id="l45.448"> </span>
<a href="#l45.449"></a><span id="l45.449">   unInitIRCConversation() {</span>
<a href="#l45.450"></a><span id="l45.450">     this._account.removeConversation(this.name);</span>
<a href="#l45.451"></a><span id="l45.451" class="difflineminus">-    if (this._observedNicks.length)</span>
<a href="#l45.452"></a><span id="l45.452" class="difflineplus">+    if (this._observedNicks.length) {</span>
<a href="#l45.453"></a><span id="l45.453">       Services.obs.removeObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l45.454"></a><span id="l45.454" class="difflineplus">+    }</span>
<a href="#l45.455"></a><span id="l45.455">   },</span>
<a href="#l45.456"></a><span id="l45.456"> };</span>
<a href="#l45.457"></a><span id="l45.457"> </span>
<a href="#l45.458"></a><span id="l45.458"> function ircChannel(aAccount, aName, aNick) {</span>
<a href="#l45.459"></a><span id="l45.459">   this._init(aAccount, aName, aNick);</span>
<a href="#l45.460"></a><span id="l45.460">   this._participants = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l45.461"></a><span id="l45.461">   this._modes = new Set();</span>
<a href="#l45.462"></a><span id="l45.462">   this._observedNicks = [];</span>
<a href="#l45.463"></a><span id="l45.463" class="difflineat">@@ -395,53 +446,60 @@ ircChannel.prototype = {</span>
<a href="#l45.464"></a><span id="l45.464"> </span>
<a href="#l45.465"></a><span id="l45.465">   // Section 3.2.2 of RFC 2812.</span>
<a href="#l45.466"></a><span id="l45.466">   part(aMessage) {</span>
<a href="#l45.467"></a><span id="l45.467">     let params = [this.name];</span>
<a href="#l45.468"></a><span id="l45.468"> </span>
<a href="#l45.469"></a><span id="l45.469">     // If a valid message was given, use it as the part message.</span>
<a href="#l45.470"></a><span id="l45.470">     // Otherwise, fall back to the default part message, if it exists.</span>
<a href="#l45.471"></a><span id="l45.471">     let msg = aMessage || this._account.getString(&quot;partmsg&quot;);</span>
<a href="#l45.472"></a><span id="l45.472" class="difflineminus">-    if (msg)</span>
<a href="#l45.473"></a><span id="l45.473" class="difflineplus">+    if (msg) {</span>
<a href="#l45.474"></a><span id="l45.474">       params.push(msg);</span>
<a href="#l45.475"></a><span id="l45.475" class="difflineplus">+    }</span>
<a href="#l45.476"></a><span id="l45.476"> </span>
<a href="#l45.477"></a><span id="l45.477">     this._account.sendMessage(&quot;PART&quot;, params);</span>
<a href="#l45.478"></a><span id="l45.478"> </span>
<a href="#l45.479"></a><span id="l45.479">     // Remove reconnection information.</span>
<a href="#l45.480"></a><span id="l45.480">     delete this.chatRoomFields;</span>
<a href="#l45.481"></a><span id="l45.481">   },</span>
<a href="#l45.482"></a><span id="l45.482"> </span>
<a href="#l45.483"></a><span id="l45.483">   close() {</span>
<a href="#l45.484"></a><span id="l45.484">     // Part the room if we're connected.</span>
<a href="#l45.485"></a><span id="l45.485" class="difflineminus">-    if (this._account.connected &amp;&amp; !this.left)</span>
<a href="#l45.486"></a><span id="l45.486" class="difflineplus">+    if (this._account.connected &amp;&amp; !this.left) {</span>
<a href="#l45.487"></a><span id="l45.487">       this.part();</span>
<a href="#l45.488"></a><span id="l45.488" class="difflineplus">+    }</span>
<a href="#l45.489"></a><span id="l45.489">     GenericConvChatPrototype.close.call(this);</span>
<a href="#l45.490"></a><span id="l45.490">   },</span>
<a href="#l45.491"></a><span id="l45.491"> </span>
<a href="#l45.492"></a><span id="l45.492">   unInit() {</span>
<a href="#l45.493"></a><span id="l45.493">     this.unInitIRCConversation();</span>
<a href="#l45.494"></a><span id="l45.494">     GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l45.495"></a><span id="l45.495">   },</span>
<a href="#l45.496"></a><span id="l45.496"> </span>
<a href="#l45.497"></a><span id="l45.497">   // Use the normalized nick in order to properly notify the observers.</span>
<a href="#l45.498"></a><span id="l45.498" class="difflineminus">-  getNormalizedChatBuddyName(aNick) { return this.normalizeNick(aNick); },</span>
<a href="#l45.499"></a><span id="l45.499" class="difflineplus">+  getNormalizedChatBuddyName(aNick) {</span>
<a href="#l45.500"></a><span id="l45.500" class="difflineplus">+    return this.normalizeNick(aNick);</span>
<a href="#l45.501"></a><span id="l45.501" class="difflineplus">+  },</span>
<a href="#l45.502"></a><span id="l45.502"> </span>
<a href="#l45.503"></a><span id="l45.503">   getParticipant(aNick, aNotifyObservers) {</span>
<a href="#l45.504"></a><span id="l45.504" class="difflineminus">-    if (this._participants.has(aNick))</span>
<a href="#l45.505"></a><span id="l45.505" class="difflineplus">+    if (this._participants.has(aNick)) {</span>
<a href="#l45.506"></a><span id="l45.506">       return this._participants.get(aNick);</span>
<a href="#l45.507"></a><span id="l45.507" class="difflineplus">+    }</span>
<a href="#l45.508"></a><span id="l45.508"> </span>
<a href="#l45.509"></a><span id="l45.509">     let participant = new ircParticipant(aNick, this);</span>
<a href="#l45.510"></a><span id="l45.510">     this._participants.set(aNick, participant);</span>
<a href="#l45.511"></a><span id="l45.511"> </span>
<a href="#l45.512"></a><span id="l45.512">     // Add the participant to the whois table if it is not already there.</span>
<a href="#l45.513"></a><span id="l45.513">     this._account.setWhois(participant._name);</span>
<a href="#l45.514"></a><span id="l45.514"> </span>
<a href="#l45.515"></a><span id="l45.515">     if (aNotifyObservers) {</span>
<a href="#l45.516"></a><span id="l45.516" class="difflineminus">-      this.notifyObservers(new nsSimpleEnumerator([participant]),</span>
<a href="#l45.517"></a><span id="l45.517" class="difflineminus">-                           &quot;chat-buddy-add&quot;);</span>
<a href="#l45.518"></a><span id="l45.518" class="difflineplus">+      this.notifyObservers(</span>
<a href="#l45.519"></a><span id="l45.519" class="difflineplus">+        new nsSimpleEnumerator([participant]),</span>
<a href="#l45.520"></a><span id="l45.520" class="difflineplus">+        &quot;chat-buddy-add&quot;</span>
<a href="#l45.521"></a><span id="l45.521" class="difflineplus">+      );</span>
<a href="#l45.522"></a><span id="l45.522">     }</span>
<a href="#l45.523"></a><span id="l45.523">     return participant;</span>
<a href="#l45.524"></a><span id="l45.524">   },</span>
<a href="#l45.525"></a><span id="l45.525"> </span>
<a href="#l45.526"></a><span id="l45.526">   /*</span>
<a href="#l45.527"></a><span id="l45.527">    * Add/remove modes from this channel.</span>
<a href="#l45.528"></a><span id="l45.528">    *</span>
<a href="#l45.529"></a><span id="l45.529">    * aNewMode is the new mode string, it MUST begin with + or -.</span>
<a href="#l45.530"></a><span id="l45.530" class="difflineat">@@ -458,18 +516,19 @@ ircChannel.prototype = {</span>
<a href="#l45.531"></a><span id="l45.531">       if (!aModeParams.length) {</span>
<a href="#l45.532"></a><span id="l45.532">         this.WARN(&quot;Mode parameter expected!&quot;);</span>
<a href="#l45.533"></a><span id="l45.533">         return undefined;</span>
<a href="#l45.534"></a><span id="l45.534">       }</span>
<a href="#l45.535"></a><span id="l45.535">       return aModeParams.pop();</span>
<a href="#l45.536"></a><span id="l45.536">     }</span>
<a href="#l45.537"></a><span id="l45.537">     function peekNextParam() {</span>
<a href="#l45.538"></a><span id="l45.538">       // Non-destructively gets the next param.</span>
<a href="#l45.539"></a><span id="l45.539" class="difflineminus">-      if (!aModeParams.length)</span>
<a href="#l45.540"></a><span id="l45.540" class="difflineplus">+      if (!aModeParams.length) {</span>
<a href="#l45.541"></a><span id="l45.541">         return undefined;</span>
<a href="#l45.542"></a><span id="l45.542" class="difflineplus">+      }</span>
<a href="#l45.543"></a><span id="l45.543">       return aModeParams.slice(-1)[0];</span>
<a href="#l45.544"></a><span id="l45.544">     }</span>
<a href="#l45.545"></a><span id="l45.545"> </span>
<a href="#l45.546"></a><span id="l45.546">     // Are modes being added or removed?</span>
<a href="#l45.547"></a><span id="l45.547">     if (aNewMode[0] != &quot;+&quot; &amp;&amp; aNewMode[0] != &quot;-&quot;) {</span>
<a href="#l45.548"></a><span id="l45.548">       this.WARN(&quot;Invalid mode string: &quot; + aNewMode);</span>
<a href="#l45.549"></a><span id="l45.549">       return;</span>
<a href="#l45.550"></a><span id="l45.550">     }</span>
<a href="#l45.551"></a><span id="l45.551" class="difflineat">@@ -479,138 +538,155 @@ ircChannel.prototype = {</span>
<a href="#l45.552"></a><span id="l45.552">     let channelModes = [];</span>
<a href="#l45.553"></a><span id="l45.553">     let userModes = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l45.554"></a><span id="l45.554">     let msg;</span>
<a href="#l45.555"></a><span id="l45.555"> </span>
<a href="#l45.556"></a><span id="l45.556">     for (let i = aNewMode.length - 1; i &gt; 0; --i) {</span>
<a href="#l45.557"></a><span id="l45.557">       // Since some modes are conflicted between different server</span>
<a href="#l45.558"></a><span id="l45.558">       // implementations, check if a participant with that name exists. If this</span>
<a href="#l45.559"></a><span id="l45.559">       // is true, then update the mode of the ConvChatBuddy.</span>
<a href="#l45.560"></a><span id="l45.560" class="difflineminus">-      if (this._account.memberStatuses.includes(aNewMode[i]) &amp;&amp;</span>
<a href="#l45.561"></a><span id="l45.561" class="difflineminus">-          aModeParams.length &amp;&amp; this._participants.has(peekNextParam())) {</span>
<a href="#l45.562"></a><span id="l45.562" class="difflineplus">+      if (</span>
<a href="#l45.563"></a><span id="l45.563" class="difflineplus">+        this._account.memberStatuses.includes(aNewMode[i]) &amp;&amp;</span>
<a href="#l45.564"></a><span id="l45.564" class="difflineplus">+        aModeParams.length &amp;&amp;</span>
<a href="#l45.565"></a><span id="l45.565" class="difflineplus">+        this._participants.has(peekNextParam())</span>
<a href="#l45.566"></a><span id="l45.566" class="difflineplus">+      ) {</span>
<a href="#l45.567"></a><span id="l45.567">         // Store the new modes for this nick (so each participant's mode is only</span>
<a href="#l45.568"></a><span id="l45.568">         // updated once).</span>
<a href="#l45.569"></a><span id="l45.569">         let nick = getNextParam();</span>
<a href="#l45.570"></a><span id="l45.570" class="difflineminus">-        if (!userModes.has(nick))</span>
<a href="#l45.571"></a><span id="l45.571" class="difflineplus">+        if (!userModes.has(nick)) {</span>
<a href="#l45.572"></a><span id="l45.572">           userModes.set(nick, []);</span>
<a href="#l45.573"></a><span id="l45.573" class="difflineplus">+        }</span>
<a href="#l45.574"></a><span id="l45.574">         userModes.get(nick).push(aNewMode[i]);</span>
<a href="#l45.575"></a><span id="l45.575"> </span>
<a href="#l45.576"></a><span id="l45.576">         // Don't use this mode as a channel mode.</span>
<a href="#l45.577"></a><span id="l45.577">         continue;</span>
<a href="#l45.578"></a><span id="l45.578" class="difflineminus">-      }</span>
<a href="#l45.579"></a><span id="l45.579" class="difflineminus">-      else if (aNewMode[i] == &quot;k&quot;) {</span>
<a href="#l45.580"></a><span id="l45.580" class="difflineplus">+      } else if (aNewMode[i] == &quot;k&quot;) {</span>
<a href="#l45.581"></a><span id="l45.581">         // Channel key.</span>
<a href="#l45.582"></a><span id="l45.582">         let newFields = this.name;</span>
<a href="#l45.583"></a><span id="l45.583">         if (addNewMode) {</span>
<a href="#l45.584"></a><span id="l45.584">           let key = getNextParam();</span>
<a href="#l45.585"></a><span id="l45.585">           // A new channel key was set, display a message if this key is not</span>
<a href="#l45.586"></a><span id="l45.586">           // already known.</span>
<a href="#l45.587"></a><span id="l45.587" class="difflineminus">-          if (this.chatRoomFields &amp;&amp;</span>
<a href="#l45.588"></a><span id="l45.588" class="difflineminus">-              this.chatRoomFields.getValue(&quot;password&quot;) == key) {</span>
<a href="#l45.589"></a><span id="l45.589" class="difflineplus">+          if (</span>
<a href="#l45.590"></a><span id="l45.590" class="difflineplus">+            this.chatRoomFields &amp;&amp;</span>
<a href="#l45.591"></a><span id="l45.591" class="difflineplus">+            this.chatRoomFields.getValue(&quot;password&quot;) == key</span>
<a href="#l45.592"></a><span id="l45.592" class="difflineplus">+          ) {</span>
<a href="#l45.593"></a><span id="l45.593">             continue;</span>
<a href="#l45.594"></a><span id="l45.594">           }</span>
<a href="#l45.595"></a><span id="l45.595">           msg = _(&quot;message.channelKeyAdded&quot;, aSetter, key);</span>
<a href="#l45.596"></a><span id="l45.596">           newFields += &quot; &quot; + key;</span>
<a href="#l45.597"></a><span id="l45.597" class="difflineplus">+        } else {</span>
<a href="#l45.598"></a><span id="l45.598" class="difflineplus">+          msg = _(&quot;message.channelKeyRemoved&quot;, aSetter);</span>
<a href="#l45.599"></a><span id="l45.599">         }</span>
<a href="#l45.600"></a><span id="l45.600" class="difflineminus">-        else</span>
<a href="#l45.601"></a><span id="l45.601" class="difflineminus">-          msg = _(&quot;message.channelKeyRemoved&quot;, aSetter);</span>
<a href="#l45.602"></a><span id="l45.602"> </span>
<a href="#l45.603"></a><span id="l45.603" class="difflineminus">-        this.writeMessage(aSetter, msg, {system: true});</span>
<a href="#l45.604"></a><span id="l45.604" class="difflineplus">+        this.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l45.605"></a><span id="l45.605">         // Store the new fields for reconnect.</span>
<a href="#l45.606"></a><span id="l45.606" class="difflineminus">-        this.chatRoomFields =</span>
<a href="#l45.607"></a><span id="l45.607" class="difflineminus">-          this._account.getChatRoomDefaultFieldValues(newFields);</span>
<a href="#l45.608"></a><span id="l45.608" class="difflineminus">-      }</span>
<a href="#l45.609"></a><span id="l45.609" class="difflineminus">-      else if (aNewMode[i] == &quot;b&quot;) {</span>
<a href="#l45.610"></a><span id="l45.610" class="difflineplus">+        this.chatRoomFields = this._account.getChatRoomDefaultFieldValues(</span>
<a href="#l45.611"></a><span id="l45.611" class="difflineplus">+          newFields</span>
<a href="#l45.612"></a><span id="l45.612" class="difflineplus">+        );</span>
<a href="#l45.613"></a><span id="l45.613" class="difflineplus">+      } else if (aNewMode[i] == &quot;b&quot;) {</span>
<a href="#l45.614"></a><span id="l45.614">         // A banmask was added or removed.</span>
<a href="#l45.615"></a><span id="l45.615">         let banMask = getNextParam();</span>
<a href="#l45.616"></a><span id="l45.616">         let msgKey = &quot;message.banMask&quot;;</span>
<a href="#l45.617"></a><span id="l45.617">         if (addNewMode) {</span>
<a href="#l45.618"></a><span id="l45.618">           this.banMasks.push(banMask);</span>
<a href="#l45.619"></a><span id="l45.619">           msgKey += &quot;Added&quot;;</span>
<a href="#l45.620"></a><span id="l45.620" class="difflineminus">-        }</span>
<a href="#l45.621"></a><span id="l45.621" class="difflineminus">-        else {</span>
<a href="#l45.622"></a><span id="l45.622" class="difflineminus">-          this.banMasks =</span>
<a href="#l45.623"></a><span id="l45.623" class="difflineminus">-            this.banMasks.filter(aBanMask =&gt; banMask != aBanMask);</span>
<a href="#l45.624"></a><span id="l45.624" class="difflineplus">+        } else {</span>
<a href="#l45.625"></a><span id="l45.625" class="difflineplus">+          this.banMasks = this.banMasks.filter(aBanMask =&gt; banMask != aBanMask);</span>
<a href="#l45.626"></a><span id="l45.626">           msgKey += &quot;Removed&quot;;</span>
<a href="#l45.627"></a><span id="l45.627">         }</span>
<a href="#l45.628"></a><span id="l45.628" class="difflineminus">-        this.writeMessage(aSetter, _(msgKey, banMask, aSetter), {system: true});</span>
<a href="#l45.629"></a><span id="l45.629" class="difflineminus">-      }</span>
<a href="#l45.630"></a><span id="l45.630" class="difflineminus">-      else if ([&quot;e&quot;, &quot;I&quot;, &quot;l&quot;].includes(aNewMode[i])) {</span>
<a href="#l45.631"></a><span id="l45.631" class="difflineplus">+        this.writeMessage(aSetter, _(msgKey, banMask, aSetter), {</span>
<a href="#l45.632"></a><span id="l45.632" class="difflineplus">+          system: true,</span>
<a href="#l45.633"></a><span id="l45.633" class="difflineplus">+        });</span>
<a href="#l45.634"></a><span id="l45.634" class="difflineplus">+      } else if ([&quot;e&quot;, &quot;I&quot;, &quot;l&quot;].includes(aNewMode[i])) {</span>
<a href="#l45.635"></a><span id="l45.635">         // TODO The following have parameters that must be accounted for.</span>
<a href="#l45.636"></a><span id="l45.636">         getNextParam();</span>
<a href="#l45.637"></a><span id="l45.637" class="difflineminus">-      }</span>
<a href="#l45.638"></a><span id="l45.638" class="difflineminus">-      else if (aNewMode[i] == &quot;R&quot; &amp;&amp; aModeParams.length &amp;&amp;</span>
<a href="#l45.639"></a><span id="l45.639" class="difflineminus">-               peekNextParam().match(hostMaskExp)) {</span>
<a href="#l45.640"></a><span id="l45.640" class="difflineplus">+      } else if (</span>
<a href="#l45.641"></a><span id="l45.641" class="difflineplus">+        aNewMode[i] == &quot;R&quot; &amp;&amp;</span>
<a href="#l45.642"></a><span id="l45.642" class="difflineplus">+        aModeParams.length &amp;&amp;</span>
<a href="#l45.643"></a><span id="l45.643" class="difflineplus">+        peekNextParam().match(hostMaskExp)</span>
<a href="#l45.644"></a><span id="l45.644" class="difflineplus">+      ) {</span>
<a href="#l45.645"></a><span id="l45.645">         // REOP_LIST takes a mask as a parameter, since R is a conflicted mode,</span>
<a href="#l45.646"></a><span id="l45.646">         // try to match the parameter. Implemented by IRCNet.</span>
<a href="#l45.647"></a><span id="l45.647">         // TODO The parameter must be acounted for.</span>
<a href="#l45.648"></a><span id="l45.648">         getNextParam();</span>
<a href="#l45.649"></a><span id="l45.649">       }</span>
<a href="#l45.650"></a><span id="l45.650">       // TODO From RFC 2811: a, i, m, n, q, p, s, r, t, l, e, I.</span>
<a href="#l45.651"></a><span id="l45.651"> </span>
<a href="#l45.652"></a><span id="l45.652">       // Keep track of the channel modes in the order they were received.</span>
<a href="#l45.653"></a><span id="l45.653">       channelModes.unshift(aNewMode[i]);</span>
<a href="#l45.654"></a><span id="l45.654">     }</span>
<a href="#l45.655"></a><span id="l45.655"> </span>
<a href="#l45.656"></a><span id="l45.656" class="difflineminus">-    if (aModeParams.length)</span>
<a href="#l45.657"></a><span id="l45.657" class="difflineplus">+    if (aModeParams.length) {</span>
<a href="#l45.658"></a><span id="l45.658">       this.WARN(&quot;Unused mode parameters: &quot; + aModeParams.join(&quot;, &quot;));</span>
<a href="#l45.659"></a><span id="l45.659" class="difflineplus">+    }</span>
<a href="#l45.660"></a><span id="l45.660"> </span>
<a href="#l45.661"></a><span id="l45.661">     // Update the mode of each participant.</span>
<a href="#l45.662"></a><span id="l45.662" class="difflineminus">-    for (let [nick, mode] of userModes.entries())</span>
<a href="#l45.663"></a><span id="l45.663" class="difflineplus">+    for (let [nick, mode] of userModes.entries()) {</span>
<a href="#l45.664"></a><span id="l45.664">       this.getParticipant(nick).setMode(addNewMode, mode, aSetter);</span>
<a href="#l45.665"></a><span id="l45.665" class="difflineplus">+    }</span>
<a href="#l45.666"></a><span id="l45.666"> </span>
<a href="#l45.667"></a><span id="l45.667">     // If the topic can now be set (and it couldn't previously) or vice versa,</span>
<a href="#l45.668"></a><span id="l45.668">     // notify the UI. Note that this status can change by either a channel mode</span>
<a href="#l45.669"></a><span id="l45.669">     // or a user mode changing.</span>
<a href="#l45.670"></a><span id="l45.670" class="difflineminus">-    if (this.topicSettable != previousTopicSettable)</span>
<a href="#l45.671"></a><span id="l45.671" class="difflineplus">+    if (this.topicSettable != previousTopicSettable) {</span>
<a href="#l45.672"></a><span id="l45.672">       this.notifyObservers(this, &quot;chat-update-topic&quot;);</span>
<a href="#l45.673"></a><span id="l45.673" class="difflineplus">+    }</span>
<a href="#l45.674"></a><span id="l45.674"> </span>
<a href="#l45.675"></a><span id="l45.675">     // If no channel modes were being set, don't display a message for it.</span>
<a href="#l45.676"></a><span id="l45.676" class="difflineminus">-    if (!channelModes.length)</span>
<a href="#l45.677"></a><span id="l45.677" class="difflineplus">+    if (!channelModes.length) {</span>
<a href="#l45.678"></a><span id="l45.678">       return;</span>
<a href="#l45.679"></a><span id="l45.679" class="difflineplus">+    }</span>
<a href="#l45.680"></a><span id="l45.680"> </span>
<a href="#l45.681"></a><span id="l45.681">     // Store the channel modes.</span>
<a href="#l45.682"></a><span id="l45.682">     _setMode.call(this, addNewMode, channelModes);</span>
<a href="#l45.683"></a><span id="l45.683"> </span>
<a href="#l45.684"></a><span id="l45.684">     // Notify the UI of changes.</span>
<a href="#l45.685"></a><span id="l45.685" class="difflineminus">-    msg = _(&quot;message.channelmode&quot;, aNewMode[0] + channelModes.join(&quot;&quot;),</span>
<a href="#l45.686"></a><span id="l45.686" class="difflineminus">-            aSetter);</span>
<a href="#l45.687"></a><span id="l45.687" class="difflineminus">-    this.writeMessage(aSetter, msg, {system: true});</span>
<a href="#l45.688"></a><span id="l45.688" class="difflineplus">+    msg = _(</span>
<a href="#l45.689"></a><span id="l45.689" class="difflineplus">+      &quot;message.channelmode&quot;,</span>
<a href="#l45.690"></a><span id="l45.690" class="difflineplus">+      aNewMode[0] + channelModes.join(&quot;&quot;),</span>
<a href="#l45.691"></a><span id="l45.691" class="difflineplus">+      aSetter</span>
<a href="#l45.692"></a><span id="l45.692" class="difflineplus">+    );</span>
<a href="#l45.693"></a><span id="l45.693" class="difflineplus">+    this.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l45.694"></a><span id="l45.694"> </span>
<a href="#l45.695"></a><span id="l45.695">     this._receivedInitialMode = true;</span>
<a href="#l45.696"></a><span id="l45.696">   },</span>
<a href="#l45.697"></a><span id="l45.697"> </span>
<a href="#l45.698"></a><span id="l45.698">   setModesFromRestriction(aRestriction) {</span>
<a href="#l45.699"></a><span id="l45.699">     // First remove all types from the list of modes.</span>
<a href="#l45.700"></a><span id="l45.700">     for (let key in this._account.channelRestrictionToModeMap) {</span>
<a href="#l45.701"></a><span id="l45.701">       let mode = this._account.channelRestrictionToModeMap[key];</span>
<a href="#l45.702"></a><span id="l45.702">       this._modes.delete(mode);</span>
<a href="#l45.703"></a><span id="l45.703">     }</span>
<a href="#l45.704"></a><span id="l45.704"> </span>
<a href="#l45.705"></a><span id="l45.705">     // Add the new mode onto the list.</span>
<a href="#l45.706"></a><span id="l45.706">     if (aRestriction in this._account.channelRestrictionToModeMap) {</span>
<a href="#l45.707"></a><span id="l45.707">       let mode = this._account.channelRestrictionToModeMap[aRestriction];</span>
<a href="#l45.708"></a><span id="l45.708" class="difflineminus">-      if (mode)</span>
<a href="#l45.709"></a><span id="l45.709" class="difflineplus">+      if (mode) {</span>
<a href="#l45.710"></a><span id="l45.710">         this._modes.add(mode);</span>
<a href="#l45.711"></a><span id="l45.711" class="difflineplus">+      }</span>
<a href="#l45.712"></a><span id="l45.712">     }</span>
<a href="#l45.713"></a><span id="l45.713">   },</span>
<a href="#l45.714"></a><span id="l45.714"> </span>
<a href="#l45.715"></a><span id="l45.715" class="difflineminus">-  get topic() { return this._topic; }, // can't add a setter without redefining the getter</span>
<a href="#l45.716"></a><span id="l45.716" class="difflineplus">+  get topic() {</span>
<a href="#l45.717"></a><span id="l45.717" class="difflineplus">+    return this._topic;</span>
<a href="#l45.718"></a><span id="l45.718" class="difflineplus">+  }, // can't add a setter without redefining the getter</span>
<a href="#l45.719"></a><span id="l45.719">   set topic(aTopic) {</span>
<a href="#l45.720"></a><span id="l45.720">     // Note that the UI isn't updated here because the server will echo back the</span>
<a href="#l45.721"></a><span id="l45.721">     // TOPIC to us and we'll set it on receive.</span>
<a href="#l45.722"></a><span id="l45.722">     this._account.sendMessage(&quot;TOPIC&quot;, [this.name, aTopic]);</span>
<a href="#l45.723"></a><span id="l45.723">   },</span>
<a href="#l45.724"></a><span id="l45.724">   get topicSettable() {</span>
<a href="#l45.725"></a><span id="l45.725">     // Don't use getParticipant since we don't want to lazily create it!</span>
<a href="#l45.726"></a><span id="l45.726">     let participant = this._participants.get(this.nick);</span>
<a href="#l45.727"></a><span id="l45.727"> </span>
<a href="#l45.728"></a><span id="l45.728">     // We must be in the room to set the topic.</span>
<a href="#l45.729"></a><span id="l45.729" class="difflineminus">-    if (!participant)</span>
<a href="#l45.730"></a><span id="l45.730" class="difflineplus">+    if (!participant) {</span>
<a href="#l45.731"></a><span id="l45.731">       return false;</span>
<a href="#l45.732"></a><span id="l45.732" class="difflineplus">+    }</span>
<a href="#l45.733"></a><span id="l45.733"> </span>
<a href="#l45.734"></a><span id="l45.734">     // If the channel mode is +t, hops and ops can set the topic; otherwise</span>
<a href="#l45.735"></a><span id="l45.735">     // everyone can.</span>
<a href="#l45.736"></a><span id="l45.736">     return !this._modes.has(&quot;t&quot;) || participant.op || participant.halfOp;</span>
<a href="#l45.737"></a><span id="l45.737">   },</span>
<a href="#l45.738"></a><span id="l45.738">   writeMessage(aMsg, aWho, aObject) {</span>
<a href="#l45.739"></a><span id="l45.739">     const messageProps = this.handleTags(aMsg, aWho, aObject);</span>
<a href="#l45.740"></a><span id="l45.740">     GenericConvChatPrototype.writeMessage.call(this, aMsg, aWho, messageProps);</span>
<a href="#l45.741"></a><span id="l45.741" class="difflineat">@@ -621,60 +697,81 @@ Object.assign(ircChannel.prototype, Gene</span>
<a href="#l45.742"></a><span id="l45.742"> function ircParticipant(aName, aConv) {</span>
<a href="#l45.743"></a><span id="l45.743">   this._name = aName;</span>
<a href="#l45.744"></a><span id="l45.744">   this._conv = aConv;</span>
<a href="#l45.745"></a><span id="l45.745">   this._account = aConv._account;</span>
<a href="#l45.746"></a><span id="l45.746">   this._modes = new Set();</span>
<a href="#l45.747"></a><span id="l45.747"> </span>
<a href="#l45.748"></a><span id="l45.748">   // Handle multi-prefix modes.</span>
<a href="#l45.749"></a><span id="l45.749">   let i;</span>
<a href="#l45.750"></a><span id="l45.750" class="difflineminus">-  for (i = 0; i &lt; this._name.length &amp;&amp;</span>
<a href="#l45.751"></a><span id="l45.751" class="difflineminus">-              this._name[i] in this._account.userPrefixToModeMap; ++i) {</span>
<a href="#l45.752"></a><span id="l45.752" class="difflineplus">+  for (</span>
<a href="#l45.753"></a><span id="l45.753" class="difflineplus">+    i = 0;</span>
<a href="#l45.754"></a><span id="l45.754" class="difflineplus">+    i &lt; this._name.length &amp;&amp; this._name[i] in this._account.userPrefixToModeMap;</span>
<a href="#l45.755"></a><span id="l45.755" class="difflineplus">+    ++i</span>
<a href="#l45.756"></a><span id="l45.756" class="difflineplus">+  ) {</span>
<a href="#l45.757"></a><span id="l45.757">     let mode = this._account.userPrefixToModeMap[this._name[i]];</span>
<a href="#l45.758"></a><span id="l45.758" class="difflineminus">-    if (mode)</span>
<a href="#l45.759"></a><span id="l45.759" class="difflineplus">+    if (mode) {</span>
<a href="#l45.760"></a><span id="l45.760">       this._modes.add(mode);</span>
<a href="#l45.761"></a><span id="l45.761" class="difflineplus">+    }</span>
<a href="#l45.762"></a><span id="l45.762">   }</span>
<a href="#l45.763"></a><span id="l45.763">   this._name = this._name.slice(i);</span>
<a href="#l45.764"></a><span id="l45.764"> }</span>
<a href="#l45.765"></a><span id="l45.765"> ircParticipant.prototype = {</span>
<a href="#l45.766"></a><span id="l45.766">   __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l45.767"></a><span id="l45.767"> </span>
<a href="#l45.768"></a><span id="l45.768">   setMode(aAddNewMode, aNewModes, aSetter) {</span>
<a href="#l45.769"></a><span id="l45.769">     _setMode.call(this, aAddNewMode, aNewModes);</span>
<a href="#l45.770"></a><span id="l45.770"> </span>
<a href="#l45.771"></a><span id="l45.771">     // Notify the UI of changes.</span>
<a href="#l45.772"></a><span id="l45.772" class="difflineminus">-    let msg = _(&quot;message.usermode&quot;, (aAddNewMode ? &quot;+&quot; : &quot;-&quot;) + aNewModes.join(&quot;&quot;),</span>
<a href="#l45.773"></a><span id="l45.773" class="difflineminus">-                this.name, aSetter);</span>
<a href="#l45.774"></a><span id="l45.774" class="difflineminus">-    this._conv.writeMessage(aSetter, msg, {system: true});</span>
<a href="#l45.775"></a><span id="l45.775" class="difflineplus">+    let msg = _(</span>
<a href="#l45.776"></a><span id="l45.776" class="difflineplus">+      &quot;message.usermode&quot;,</span>
<a href="#l45.777"></a><span id="l45.777" class="difflineplus">+      (aAddNewMode ? &quot;+&quot; : &quot;-&quot;) + aNewModes.join(&quot;&quot;),</span>
<a href="#l45.778"></a><span id="l45.778" class="difflineplus">+      this.name,</span>
<a href="#l45.779"></a><span id="l45.779" class="difflineplus">+      aSetter</span>
<a href="#l45.780"></a><span id="l45.780" class="difflineplus">+    );</span>
<a href="#l45.781"></a><span id="l45.781" class="difflineplus">+    this._conv.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l45.782"></a><span id="l45.782">     this._conv.notifyObservers(this, &quot;chat-buddy-update&quot;);</span>
<a href="#l45.783"></a><span id="l45.783">   },</span>
<a href="#l45.784"></a><span id="l45.784"> </span>
<a href="#l45.785"></a><span id="l45.785" class="difflineminus">-  get voiced() { return this._modes.has(&quot;v&quot;); },</span>
<a href="#l45.786"></a><span id="l45.786" class="difflineminus">-  get halfOp() { return this._modes.has(&quot;h&quot;); },</span>
<a href="#l45.787"></a><span id="l45.787" class="difflineminus">-  get op() { return this._modes.has(&quot;o&quot;); },</span>
<a href="#l45.788"></a><span id="l45.788" class="difflineminus">-  get founder() { return this._modes.has(&quot;O&quot;) || this._modes.has(&quot;q&quot;); },</span>
<a href="#l45.789"></a><span id="l45.789" class="difflineminus">-  get typing() { return false; },</span>
<a href="#l45.790"></a><span id="l45.790" class="difflineplus">+  get voiced() {</span>
<a href="#l45.791"></a><span id="l45.791" class="difflineplus">+    return this._modes.has(&quot;v&quot;);</span>
<a href="#l45.792"></a><span id="l45.792" class="difflineplus">+  },</span>
<a href="#l45.793"></a><span id="l45.793" class="difflineplus">+  get halfOp() {</span>
<a href="#l45.794"></a><span id="l45.794" class="difflineplus">+    return this._modes.has(&quot;h&quot;);</span>
<a href="#l45.795"></a><span id="l45.795" class="difflineplus">+  },</span>
<a href="#l45.796"></a><span id="l45.796" class="difflineplus">+  get op() {</span>
<a href="#l45.797"></a><span id="l45.797" class="difflineplus">+    return this._modes.has(&quot;o&quot;);</span>
<a href="#l45.798"></a><span id="l45.798" class="difflineplus">+  },</span>
<a href="#l45.799"></a><span id="l45.799" class="difflineplus">+  get founder() {</span>
<a href="#l45.800"></a><span id="l45.800" class="difflineplus">+    return this._modes.has(&quot;O&quot;) || this._modes.has(&quot;q&quot;);</span>
<a href="#l45.801"></a><span id="l45.801" class="difflineplus">+  },</span>
<a href="#l45.802"></a><span id="l45.802" class="difflineplus">+  get typing() {</span>
<a href="#l45.803"></a><span id="l45.803" class="difflineplus">+    return false;</span>
<a href="#l45.804"></a><span id="l45.804" class="difflineplus">+  },</span>
<a href="#l45.805"></a><span id="l45.805"> };</span>
<a href="#l45.806"></a><span id="l45.806"> </span>
<a href="#l45.807"></a><span id="l45.807"> function ircConversation(aAccount, aName) {</span>
<a href="#l45.808"></a><span id="l45.808">   let nick = aAccount.normalize(aName);</span>
<a href="#l45.809"></a><span id="l45.809" class="difflineminus">-  if (aAccount.whoisInformation.has(nick))</span>
<a href="#l45.810"></a><span id="l45.810" class="difflineplus">+  if (aAccount.whoisInformation.has(nick)) {</span>
<a href="#l45.811"></a><span id="l45.811">     aName = aAccount.whoisInformation.get(nick).nick;</span>
<a href="#l45.812"></a><span id="l45.812" class="difflineplus">+  }</span>
<a href="#l45.813"></a><span id="l45.813"> </span>
<a href="#l45.814"></a><span id="l45.814">   this._init(aAccount, aName);</span>
<a href="#l45.815"></a><span id="l45.815">   this._observedNicks = [];</span>
<a href="#l45.816"></a><span id="l45.816"> </span>
<a href="#l45.817"></a><span id="l45.817">   // Fetch correctly capitalized name.</span>
<a href="#l45.818"></a><span id="l45.818">   // Always request the info as it may be out of date.</span>
<a href="#l45.819"></a><span id="l45.819">   this._waitingForNick = true;</span>
<a href="#l45.820"></a><span id="l45.820">   this.requestCurrentWhois(aName);</span>
<a href="#l45.821"></a><span id="l45.821"> }</span>
<a href="#l45.822"></a><span id="l45.822"> ircConversation.prototype = {</span>
<a href="#l45.823"></a><span id="l45.823">   __proto__: GenericConvIMPrototype,</span>
<a href="#l45.824"></a><span id="l45.824" class="difflineminus">-  get buddy() { return this._account.buddies.get(this.name); },</span>
<a href="#l45.825"></a><span id="l45.825" class="difflineplus">+  get buddy() {</span>
<a href="#l45.826"></a><span id="l45.826" class="difflineplus">+    return this._account.buddies.get(this.name);</span>
<a href="#l45.827"></a><span id="l45.827" class="difflineplus">+  },</span>
<a href="#l45.828"></a><span id="l45.828"> </span>
<a href="#l45.829"></a><span id="l45.829">   unInit() {</span>
<a href="#l45.830"></a><span id="l45.830">     this.unInitIRCConversation();</span>
<a href="#l45.831"></a><span id="l45.831">     GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l45.832"></a><span id="l45.832">   },</span>
<a href="#l45.833"></a><span id="l45.833"> </span>
<a href="#l45.834"></a><span id="l45.834">   updateNick(aNewNick) {</span>
<a href="#l45.835"></a><span id="l45.835">     this._name = aNewNick;</span>
<a href="#l45.836"></a><span id="l45.836" class="difflineat">@@ -703,57 +800,70 @@ ircSocket.prototype = {</span>
<a href="#l45.837"></a><span id="l45.837">   sendPing() {</span>
<a href="#l45.838"></a><span id="l45.838">     // Send a ping using the current timestamp as a payload prefixed with</span>
<a href="#l45.839"></a><span id="l45.839">     // an underscore to signify this was an &quot;automatic&quot; PING (used to avoid</span>
<a href="#l45.840"></a><span id="l45.840">     // socket timeouts).</span>
<a href="#l45.841"></a><span id="l45.841">     this._account.sendMessage(&quot;PING&quot;, &quot;_&quot; + Date.now());</span>
<a href="#l45.842"></a><span id="l45.842">   },</span>
<a href="#l45.843"></a><span id="l45.843"> </span>
<a href="#l45.844"></a><span id="l45.844">   _initCharsetConverter() {</span>
<a href="#l45.845"></a><span id="l45.845" class="difflineminus">-    this._converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l45.846"></a><span id="l45.846" class="difflineminus">-                        .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l45.847"></a><span id="l45.847" class="difflineplus">+    this._converter = Cc[</span>
<a href="#l45.848"></a><span id="l45.848" class="difflineplus">+      &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l45.849"></a><span id="l45.849" class="difflineplus">+    ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l45.850"></a><span id="l45.850">     try {</span>
<a href="#l45.851"></a><span id="l45.851">       this._converter.charset = this._account._encoding;</span>
<a href="#l45.852"></a><span id="l45.852">     } catch (e) {</span>
<a href="#l45.853"></a><span id="l45.853">       delete this._converter;</span>
<a href="#l45.854"></a><span id="l45.854" class="difflineminus">-      this.ERROR(&quot;Failed to set character set to: &quot; + this._account._encoding +</span>
<a href="#l45.855"></a><span id="l45.855" class="difflineminus">-                 &quot; for &quot; + this._account.name + &quot;.&quot;);</span>
<a href="#l45.856"></a><span id="l45.856" class="difflineplus">+      this.ERROR(</span>
<a href="#l45.857"></a><span id="l45.857" class="difflineplus">+        &quot;Failed to set character set to: &quot; +</span>
<a href="#l45.858"></a><span id="l45.858" class="difflineplus">+          this._account._encoding +</span>
<a href="#l45.859"></a><span id="l45.859" class="difflineplus">+          &quot; for &quot; +</span>
<a href="#l45.860"></a><span id="l45.860" class="difflineplus">+          this._account.name +</span>
<a href="#l45.861"></a><span id="l45.861" class="difflineplus">+          &quot;.&quot;</span>
<a href="#l45.862"></a><span id="l45.862" class="difflineplus">+      );</span>
<a href="#l45.863"></a><span id="l45.863">     }</span>
<a href="#l45.864"></a><span id="l45.864">   },</span>
<a href="#l45.865"></a><span id="l45.865"> </span>
<a href="#l45.866"></a><span id="l45.866">   // Implement Section 5 of RFC 2812.</span>
<a href="#l45.867"></a><span id="l45.867">   onDataReceived(aRawMessage) {</span>
<a href="#l45.868"></a><span id="l45.868">     let conversionWarning = &quot;&quot;;</span>
<a href="#l45.869"></a><span id="l45.869">     if (this._converter) {</span>
<a href="#l45.870"></a><span id="l45.870">       try {</span>
<a href="#l45.871"></a><span id="l45.871">         aRawMessage = this._converter.ConvertToUnicode(aRawMessage);</span>
<a href="#l45.872"></a><span id="l45.872">       } catch (e) {</span>
<a href="#l45.873"></a><span id="l45.873" class="difflineminus">-        conversionWarning = &quot;\nThis message doesn't seem to be &quot; +</span>
<a href="#l45.874"></a><span id="l45.874" class="difflineminus">-                            this._account._encoding + &quot; encoded.&quot;;</span>
<a href="#l45.875"></a><span id="l45.875" class="difflineplus">+        conversionWarning =</span>
<a href="#l45.876"></a><span id="l45.876" class="difflineplus">+          &quot;\nThis message doesn't seem to be &quot; +</span>
<a href="#l45.877"></a><span id="l45.877" class="difflineplus">+          this._account._encoding +</span>
<a href="#l45.878"></a><span id="l45.878" class="difflineplus">+          &quot; encoded.&quot;;</span>
<a href="#l45.879"></a><span id="l45.879">         // Unfortunately, if the unicode converter failed once,</span>
<a href="#l45.880"></a><span id="l45.880">         // it will keep failing so we need to reinitialize it.</span>
<a href="#l45.881"></a><span id="l45.881">         this._initCharsetConverter();</span>
<a href="#l45.882"></a><span id="l45.882">       }</span>
<a href="#l45.883"></a><span id="l45.883">     }</span>
<a href="#l45.884"></a><span id="l45.884"> </span>
<a href="#l45.885"></a><span id="l45.885">     // We've received data and are past the authentication stage.</span>
<a href="#l45.886"></a><span id="l45.886" class="difflineminus">-    if (this._account.connected)</span>
<a href="#l45.887"></a><span id="l45.887" class="difflineplus">+    if (this._account.connected) {</span>
<a href="#l45.888"></a><span id="l45.888">       this.resetPingTimer();</span>
<a href="#l45.889"></a><span id="l45.889" class="difflineplus">+    }</span>
<a href="#l45.890"></a><span id="l45.890"> </span>
<a href="#l45.891"></a><span id="l45.891">     // Low level dequote: replace quote character \020 followed by 0, n, r or</span>
<a href="#l45.892"></a><span id="l45.892">     // \020 with a \0, \n, \r or \020, respectively. Any other character is</span>
<a href="#l45.893"></a><span id="l45.893">     // replaced with itself.</span>
<a href="#l45.894"></a><span id="l45.894" class="difflineminus">-    const lowDequote = {&quot;0&quot;: &quot;\0&quot;, &quot;n&quot;: &quot;\n&quot;, &quot;r&quot;: &quot;\r&quot;, &quot;\x10&quot;: &quot;\x10&quot;};</span>
<a href="#l45.895"></a><span id="l45.895" class="difflineplus">+    const lowDequote = { &quot;0&quot;: &quot;\0&quot;, n: &quot;\n&quot;, r: &quot;\r&quot;, &quot;\x10&quot;: &quot;\x10&quot; };</span>
<a href="#l45.896"></a><span id="l45.896">     // eslint-disable-next-line no-control-regex</span>
<a href="#l45.897"></a><span id="l45.897" class="difflineminus">-    let dequotedMessage = aRawMessage.replace(/\x10./g,</span>
<a href="#l45.898"></a><span id="l45.898" class="difflineminus">-      aStr =&gt; lowDequote[aStr[1]] || aStr[1]);</span>
<a href="#l45.899"></a><span id="l45.899" class="difflineplus">+    let dequotedMessage = aRawMessage.replace(</span>
<a href="#l45.900"></a><span id="l45.900" class="difflineplus">+      /\x10./g,</span>
<a href="#l45.901"></a><span id="l45.901" class="difflineplus">+      aStr =&gt; lowDequote[aStr[1]] || aStr[1]</span>
<a href="#l45.902"></a><span id="l45.902" class="difflineplus">+    );</span>
<a href="#l45.903"></a><span id="l45.903"> </span>
<a href="#l45.904"></a><span id="l45.904">     try {</span>
<a href="#l45.905"></a><span id="l45.905" class="difflineminus">-      let message = new ircMessage(dequotedMessage,</span>
<a href="#l45.906"></a><span id="l45.906" class="difflineminus">-                                   this._account._currentServerName);</span>
<a href="#l45.907"></a><span id="l45.907" class="difflineplus">+      let message = new ircMessage(</span>
<a href="#l45.908"></a><span id="l45.908" class="difflineplus">+        dequotedMessage,</span>
<a href="#l45.909"></a><span id="l45.909" class="difflineplus">+        this._account._currentServerName</span>
<a href="#l45.910"></a><span id="l45.910" class="difflineplus">+      );</span>
<a href="#l45.911"></a><span id="l45.911">       this.DEBUG(JSON.stringify(message) + conversionWarning);</span>
<a href="#l45.912"></a><span id="l45.912">       if (!ircHandlers.handleMessage(this._account, message)) {</span>
<a href="#l45.913"></a><span id="l45.913">         // If the message was not handled, throw a warning containing</span>
<a href="#l45.914"></a><span id="l45.914">         // the original quoted message.</span>
<a href="#l45.915"></a><span id="l45.915">         this.WARN(&quot;Unhandled IRC message:\n&quot; + aRawMessage);</span>
<a href="#l45.916"></a><span id="l45.916">       }</span>
<a href="#l45.917"></a><span id="l45.917">     } catch (e) {</span>
<a href="#l45.918"></a><span id="l45.918">       // Catch the error, display it and hope the connection can continue with</span>
<a href="#l45.919"></a><span id="l45.919" class="difflineat">@@ -762,95 +872,122 @@ ircSocket.prototype = {</span>
<a href="#l45.920"></a><span id="l45.920">       this.DEBUG(aRawMessage + conversionWarning);</span>
<a href="#l45.921"></a><span id="l45.921">       this.ERROR(e);</span>
<a href="#l45.922"></a><span id="l45.922">     }</span>
<a href="#l45.923"></a><span id="l45.923">   },</span>
<a href="#l45.924"></a><span id="l45.924">   onConnection() {</span>
<a href="#l45.925"></a><span id="l45.925">     this._account._connectionRegistration();</span>
<a href="#l45.926"></a><span id="l45.926">   },</span>
<a href="#l45.927"></a><span id="l45.927">   disconnect() {</span>
<a href="#l45.928"></a><span id="l45.928" class="difflineminus">-    if (!this._account)</span>
<a href="#l45.929"></a><span id="l45.929" class="difflineplus">+    if (!this._account) {</span>
<a href="#l45.930"></a><span id="l45.930">       return;</span>
<a href="#l45.931"></a><span id="l45.931" class="difflineplus">+    }</span>
<a href="#l45.932"></a><span id="l45.932">     Socket.disconnect.call(this);</span>
<a href="#l45.933"></a><span id="l45.933">     delete this._account;</span>
<a href="#l45.934"></a><span id="l45.934">   },</span>
<a href="#l45.935"></a><span id="l45.935"> </span>
<a href="#l45.936"></a><span id="l45.936">   // Throw errors if the socket has issues.</span>
<a href="#l45.937"></a><span id="l45.937">   onConnectionClosed() {</span>
<a href="#l45.938"></a><span id="l45.938">     // If the account was already disconnected, e.g. in response to</span>
<a href="#l45.939"></a><span id="l45.939">     // onConnectionReset, do nothing.</span>
<a href="#l45.940"></a><span id="l45.940" class="difflineminus">-    if (!this._account)</span>
<a href="#l45.941"></a><span id="l45.941" class="difflineplus">+    if (!this._account) {</span>
<a href="#l45.942"></a><span id="l45.942">       return;</span>
<a href="#l45.943"></a><span id="l45.943" class="difflineplus">+    }</span>
<a href="#l45.944"></a><span id="l45.944">     const msg = &quot;Connection closed by server.&quot;;</span>
<a href="#l45.945"></a><span id="l45.945">     if (this._account.disconnecting) {</span>
<a href="#l45.946"></a><span id="l45.946">       // The server closed the connection before we handled the ERROR</span>
<a href="#l45.947"></a><span id="l45.947">       // response to QUIT.</span>
<a href="#l45.948"></a><span id="l45.948">       this.LOG(msg);</span>
<a href="#l45.949"></a><span id="l45.949">       this._account.gotDisconnected();</span>
<a href="#l45.950"></a><span id="l45.950" class="difflineminus">-    }</span>
<a href="#l45.951"></a><span id="l45.951" class="difflineminus">-    else {</span>
<a href="#l45.952"></a><span id="l45.952" class="difflineplus">+    } else {</span>
<a href="#l45.953"></a><span id="l45.953">       this.WARN(msg);</span>
<a href="#l45.954"></a><span id="l45.954" class="difflineminus">-      this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.955"></a><span id="l45.955" class="difflineminus">-                                    _(&quot;connection.error.lost&quot;));</span>
<a href="#l45.956"></a><span id="l45.956" class="difflineplus">+      this._account.gotDisconnected(</span>
<a href="#l45.957"></a><span id="l45.957" class="difflineplus">+        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.958"></a><span id="l45.958" class="difflineplus">+        _(&quot;connection.error.lost&quot;)</span>
<a href="#l45.959"></a><span id="l45.959" class="difflineplus">+      );</span>
<a href="#l45.960"></a><span id="l45.960">     }</span>
<a href="#l45.961"></a><span id="l45.961">   },</span>
<a href="#l45.962"></a><span id="l45.962">   onConnectionReset() {</span>
<a href="#l45.963"></a><span id="l45.963">     this.WARN(&quot;Connection reset.&quot;);</span>
<a href="#l45.964"></a><span id="l45.964" class="difflineminus">-    this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.965"></a><span id="l45.965" class="difflineminus">-                                  _(&quot;connection.error.lost&quot;));</span>
<a href="#l45.966"></a><span id="l45.966" class="difflineplus">+    this._account.gotDisconnected(</span>
<a href="#l45.967"></a><span id="l45.967" class="difflineplus">+      Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.968"></a><span id="l45.968" class="difflineplus">+      _(&quot;connection.error.lost&quot;)</span>
<a href="#l45.969"></a><span id="l45.969" class="difflineplus">+    );</span>
<a href="#l45.970"></a><span id="l45.970">   },</span>
<a href="#l45.971"></a><span id="l45.971">   onConnectionTimedOut() {</span>
<a href="#l45.972"></a><span id="l45.972">     this.WARN(&quot;Connection timed out.&quot;);</span>
<a href="#l45.973"></a><span id="l45.973" class="difflineminus">-    this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.974"></a><span id="l45.974" class="difflineminus">-                                  _(&quot;connection.error.timeOut&quot;));</span>
<a href="#l45.975"></a><span id="l45.975" class="difflineplus">+    this._account.gotDisconnected(</span>
<a href="#l45.976"></a><span id="l45.976" class="difflineplus">+      Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.977"></a><span id="l45.977" class="difflineplus">+      _(&quot;connection.error.timeOut&quot;)</span>
<a href="#l45.978"></a><span id="l45.978" class="difflineplus">+    );</span>
<a href="#l45.979"></a><span id="l45.979">   },</span>
<a href="#l45.980"></a><span id="l45.980">   onBadCertificate(aIsSslError, aNSSErrorMessage) {</span>
<a href="#l45.981"></a><span id="l45.981" class="difflineminus">-    this.WARN(&quot;Bad certificate or SSL connection for &quot; + this._account.name +</span>
<a href="#l45.982"></a><span id="l45.982" class="difflineminus">-               &quot;:\n&quot; + aNSSErrorMessage);</span>
<a href="#l45.983"></a><span id="l45.983" class="difflineplus">+    this.WARN(</span>
<a href="#l45.984"></a><span id="l45.984" class="difflineplus">+      &quot;Bad certificate or SSL connection for &quot; +</span>
<a href="#l45.985"></a><span id="l45.985" class="difflineplus">+        this._account.name +</span>
<a href="#l45.986"></a><span id="l45.986" class="difflineplus">+        &quot;:\n&quot; +</span>
<a href="#l45.987"></a><span id="l45.987" class="difflineplus">+        aNSSErrorMessage</span>
<a href="#l45.988"></a><span id="l45.988" class="difflineplus">+    );</span>
<a href="#l45.989"></a><span id="l45.989">     let error = this._account.handleBadCertificate(this, aIsSslError);</span>
<a href="#l45.990"></a><span id="l45.990">     this._account.gotDisconnected(error, aNSSErrorMessage);</span>
<a href="#l45.991"></a><span id="l45.991">   },</span>
<a href="#l45.992"></a><span id="l45.992"> </span>
<a href="#l45.993"></a><span id="l45.993" class="difflineminus">-  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l45.994"></a><span id="l45.994" class="difflineminus">-  get LOG() { return this._account.LOG; },</span>
<a href="#l45.995"></a><span id="l45.995" class="difflineminus">-  get WARN() { return this._account.WARN; },</span>
<a href="#l45.996"></a><span id="l45.996" class="difflineminus">-  get ERROR() { return this._account.ERROR; },</span>
<a href="#l45.997"></a><span id="l45.997" class="difflineplus">+  get DEBUG() {</span>
<a href="#l45.998"></a><span id="l45.998" class="difflineplus">+    return this._account.DEBUG;</span>
<a href="#l45.999"></a><span id="l45.999" class="difflineplus">+  },</span>
<a href="#l45.1000"></a><span id="l45.1000" class="difflineplus">+  get LOG() {</span>
<a href="#l45.1001"></a><span id="l45.1001" class="difflineplus">+    return this._account.LOG;</span>
<a href="#l45.1002"></a><span id="l45.1002" class="difflineplus">+  },</span>
<a href="#l45.1003"></a><span id="l45.1003" class="difflineplus">+  get WARN() {</span>
<a href="#l45.1004"></a><span id="l45.1004" class="difflineplus">+    return this._account.WARN;</span>
<a href="#l45.1005"></a><span id="l45.1005" class="difflineplus">+  },</span>
<a href="#l45.1006"></a><span id="l45.1006" class="difflineplus">+  get ERROR() {</span>
<a href="#l45.1007"></a><span id="l45.1007" class="difflineplus">+    return this._account.ERROR;</span>
<a href="#l45.1008"></a><span id="l45.1008" class="difflineplus">+  },</span>
<a href="#l45.1009"></a><span id="l45.1009"> };</span>
<a href="#l45.1010"></a><span id="l45.1010"> </span>
<a href="#l45.1011"></a><span id="l45.1011"> function ircAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l45.1012"></a><span id="l45.1012">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l45.1013"></a><span id="l45.1013"> }</span>
<a href="#l45.1014"></a><span id="l45.1014"> ircAccountBuddy.prototype = {</span>
<a href="#l45.1015"></a><span id="l45.1015">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l45.1016"></a><span id="l45.1016"> </span>
<a href="#l45.1017"></a><span id="l45.1017">   // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l45.1018"></a><span id="l45.1018">   // hovers over the buddy.</span>
<a href="#l45.1019"></a><span id="l45.1019" class="difflineminus">-  getTooltipInfo() { return this._account.getBuddyInfo(this.normalizedName); },</span>
<a href="#l45.1020"></a><span id="l45.1020" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l45.1021"></a><span id="l45.1021" class="difflineplus">+    return this._account.getBuddyInfo(this.normalizedName);</span>
<a href="#l45.1022"></a><span id="l45.1022" class="difflineplus">+  },</span>
<a href="#l45.1023"></a><span id="l45.1023"> </span>
<a href="#l45.1024"></a><span id="l45.1024">   // Allow sending of messages to buddies even if they are not online since IRC</span>
<a href="#l45.1025"></a><span id="l45.1025">   // does not always provide status information in a timely fashion. (Note that</span>
<a href="#l45.1026"></a><span id="l45.1026">   // this is OK since the server will throw an error if the user is not online.)</span>
<a href="#l45.1027"></a><span id="l45.1027" class="difflineminus">-  get canSendMessage() { return this.account.connected; },</span>
<a href="#l45.1028"></a><span id="l45.1028" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l45.1029"></a><span id="l45.1029" class="difflineplus">+    return this.account.connected;</span>
<a href="#l45.1030"></a><span id="l45.1030" class="difflineplus">+  },</span>
<a href="#l45.1031"></a><span id="l45.1031"> </span>
<a href="#l45.1032"></a><span id="l45.1032">   // Called when the user wants to chat with the buddy.</span>
<a href="#l45.1033"></a><span id="l45.1033" class="difflineminus">-  createConversation() { return this._account.createConversation(this.userName); },</span>
<a href="#l45.1034"></a><span id="l45.1034" class="difflineplus">+  createConversation() {</span>
<a href="#l45.1035"></a><span id="l45.1035" class="difflineplus">+    return this._account.createConversation(this.userName);</span>
<a href="#l45.1036"></a><span id="l45.1036" class="difflineplus">+  },</span>
<a href="#l45.1037"></a><span id="l45.1037"> </span>
<a href="#l45.1038"></a><span id="l45.1038">   remove() {</span>
<a href="#l45.1039"></a><span id="l45.1039">     this._account.removeBuddy(this);</span>
<a href="#l45.1040"></a><span id="l45.1040">     GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l45.1041"></a><span id="l45.1041">   },</span>
<a href="#l45.1042"></a><span id="l45.1042"> };</span>
<a href="#l45.1043"></a><span id="l45.1043"> </span>
<a href="#l45.1044"></a><span id="l45.1044"> function ircRoomInfo(aName, aAccount) {</span>
<a href="#l45.1045"></a><span id="l45.1045">   this.name = aName;</span>
<a href="#l45.1046"></a><span id="l45.1046">   this._account = aAccount;</span>
<a href="#l45.1047"></a><span id="l45.1047"> }</span>
<a href="#l45.1048"></a><span id="l45.1048"> ircRoomInfo.prototype = {</span>
<a href="#l45.1049"></a><span id="l45.1049">   __proto__: ClassInfo(&quot;prplIRoomInfo&quot;, &quot;IRC RoomInfo Object&quot;),</span>
<a href="#l45.1050"></a><span id="l45.1050" class="difflineminus">-  get topic() { return this._account._channelList.get(this.name).topic; },</span>
<a href="#l45.1051"></a><span id="l45.1051" class="difflineplus">+  get topic() {</span>
<a href="#l45.1052"></a><span id="l45.1052" class="difflineplus">+    return this._account._channelList.get(this.name).topic;</span>
<a href="#l45.1053"></a><span id="l45.1053" class="difflineplus">+  },</span>
<a href="#l45.1054"></a><span id="l45.1054">   get participantCount() {</span>
<a href="#l45.1055"></a><span id="l45.1055">     return this._account._channelList.get(this.name).participantCount;</span>
<a href="#l45.1056"></a><span id="l45.1056">   },</span>
<a href="#l45.1057"></a><span id="l45.1057">   get chatRoomFieldValues() {</span>
<a href="#l45.1058"></a><span id="l45.1058">     return this._account.getChatRoomDefaultFieldValues(this.name);</span>
<a href="#l45.1059"></a><span id="l45.1059">   },</span>
<a href="#l45.1060"></a><span id="l45.1060"> };</span>
<a href="#l45.1061"></a><span id="l45.1061"> </span>
<a href="#l45.1062"></a><span id="l45.1062" class="difflineat">@@ -879,17 +1016,19 @@ function ircAccount(aProtocol, aImAccoun</span>
<a href="#l45.1063"></a><span id="l45.1063">   this._commandBuffers = new Map();</span>
<a href="#l45.1064"></a><span id="l45.1064">   this._roomInfoCallbacks = new Set();</span>
<a href="#l45.1065"></a><span id="l45.1065"> }</span>
<a href="#l45.1066"></a><span id="l45.1066"> ircAccount.prototype = {</span>
<a href="#l45.1067"></a><span id="l45.1067">   __proto__: GenericAccountPrototype,</span>
<a href="#l45.1068"></a><span id="l45.1068">   _socket: null,</span>
<a href="#l45.1069"></a><span id="l45.1069">   _MODE_WALLOPS: 1 &lt;&lt; 2, // mode 'w'</span>
<a href="#l45.1070"></a><span id="l45.1070">   _MODE_INVISIBLE: 1 &lt;&lt; 3, // mode 'i'</span>
<a href="#l45.1071"></a><span id="l45.1071" class="difflineminus">-  get _mode() { return 0; },</span>
<a href="#l45.1072"></a><span id="l45.1072" class="difflineplus">+  get _mode() {</span>
<a href="#l45.1073"></a><span id="l45.1073" class="difflineplus">+    return 0;</span>
<a href="#l45.1074"></a><span id="l45.1074" class="difflineplus">+  },</span>
<a href="#l45.1075"></a><span id="l45.1075"> </span>
<a href="#l45.1076"></a><span id="l45.1076">   // The name of the server we last connected to.</span>
<a href="#l45.1077"></a><span id="l45.1077">   _currentServerName: null,</span>
<a href="#l45.1078"></a><span id="l45.1078">   // Whether to attempt authenticating with NickServ.</span>
<a href="#l45.1079"></a><span id="l45.1079">   shouldAuthenticate: true,</span>
<a href="#l45.1080"></a><span id="l45.1080">   // Whether the user has successfully authenticated with NickServ.</span>
<a href="#l45.1081"></a><span id="l45.1081">   isAuthenticated: false,</span>
<a href="#l45.1082"></a><span id="l45.1082">   // The current in use nickname.</span>
<a href="#l45.1083"></a><span id="l45.1083" class="difflineat">@@ -903,99 +1042,111 @@ ircAccount.prototype = {</span>
<a href="#l45.1084"></a><span id="l45.1084">   // adding digits).</span>
<a href="#l45.1085"></a><span id="l45.1085">   _sentNickname: null,</span>
<a href="#l45.1086"></a><span id="l45.1086">   // If we don't get the desired nick on connect, we try again a bit later,</span>
<a href="#l45.1087"></a><span id="l45.1087">   // to see if it wasn't just our nick not having timed out yet.</span>
<a href="#l45.1088"></a><span id="l45.1088">   _nickInUseTimeout: null,</span>
<a href="#l45.1089"></a><span id="l45.1089">   get username() {</span>
<a href="#l45.1090"></a><span id="l45.1090">     let username;</span>
<a href="#l45.1091"></a><span id="l45.1091">     // Use a custom username in a hidden preference.</span>
<a href="#l45.1092"></a><span id="l45.1092" class="difflineminus">-    if (this.prefs.prefHasUserValue(&quot;username&quot;))</span>
<a href="#l45.1093"></a><span id="l45.1093" class="difflineplus">+    if (this.prefs.prefHasUserValue(&quot;username&quot;)) {</span>
<a href="#l45.1094"></a><span id="l45.1094">       username = this.getString(&quot;username&quot;);</span>
<a href="#l45.1095"></a><span id="l45.1095" class="difflineplus">+    }</span>
<a href="#l45.1096"></a><span id="l45.1096">     // But fallback to brandShortName if no username is provided (or is empty).</span>
<a href="#l45.1097"></a><span id="l45.1097" class="difflineminus">-    if (!username)</span>
<a href="#l45.1098"></a><span id="l45.1098" class="difflineplus">+    if (!username) {</span>
<a href="#l45.1099"></a><span id="l45.1099">       username = Services.appinfo.name;</span>
<a href="#l45.1100"></a><span id="l45.1100" class="difflineplus">+    }</span>
<a href="#l45.1101"></a><span id="l45.1101"> </span>
<a href="#l45.1102"></a><span id="l45.1102">     return username;</span>
<a href="#l45.1103"></a><span id="l45.1103">   },</span>
<a href="#l45.1104"></a><span id="l45.1104">   // The prefix minus the nick (!user@host) as returned by the server, this is</span>
<a href="#l45.1105"></a><span id="l45.1105">   // necessary for guessing message lengths.</span>
<a href="#l45.1106"></a><span id="l45.1106">   prefix: null,</span>
<a href="#l45.1107"></a><span id="l45.1107"> </span>
<a href="#l45.1108"></a><span id="l45.1108">   // Parts of the specification give max lengths, keep track of them since a</span>
<a href="#l45.1109"></a><span id="l45.1109">   // server can overwrite them. The defaults given here are from RFC 2812.</span>
<a href="#l45.1110"></a><span id="l45.1110">   maxNicknameLength: 9, // 1.2.1 Users</span>
<a href="#l45.1111"></a><span id="l45.1111">   maxChannelLength: 50, // 1.3 Channels</span>
<a href="#l45.1112"></a><span id="l45.1112">   maxMessageLength: 512, // 2.3 Messages</span>
<a href="#l45.1113"></a><span id="l45.1113">   maxHostnameLength: 63, // 2.3.1 Message format in Augmented BNF</span>
<a href="#l45.1114"></a><span id="l45.1114"> </span>
<a href="#l45.1115"></a><span id="l45.1115">   // The default prefixes to modes.</span>
<a href="#l45.1116"></a><span id="l45.1116" class="difflineminus">-  userPrefixToModeMap: {&quot;@&quot;: &quot;o&quot;, &quot;!&quot;: &quot;n&quot;, &quot;%&quot;: &quot;h&quot;, &quot;+&quot;: &quot;v&quot;},</span>
<a href="#l45.1117"></a><span id="l45.1117" class="difflineminus">-  get userPrefixes() { return Object.keys(this.userPrefixToModeMap); },</span>
<a href="#l45.1118"></a><span id="l45.1118" class="difflineplus">+  userPrefixToModeMap: { &quot;@&quot;: &quot;o&quot;, &quot;!&quot;: &quot;n&quot;, &quot;%&quot;: &quot;h&quot;, &quot;+&quot;: &quot;v&quot; },</span>
<a href="#l45.1119"></a><span id="l45.1119" class="difflineplus">+  get userPrefixes() {</span>
<a href="#l45.1120"></a><span id="l45.1120" class="difflineplus">+    return Object.keys(this.userPrefixToModeMap);</span>
<a href="#l45.1121"></a><span id="l45.1121" class="difflineplus">+  },</span>
<a href="#l45.1122"></a><span id="l45.1122">   // Modes that have a nickname parameter and affect a participant. See 4.1</span>
<a href="#l45.1123"></a><span id="l45.1123">   // Member Status of RFC 2811.</span>
<a href="#l45.1124"></a><span id="l45.1124">   memberStatuses: [&quot;a&quot;, &quot;h&quot;, &quot;o&quot;, &quot;O&quot;, &quot;q&quot;, &quot;v&quot;, &quot;!&quot;],</span>
<a href="#l45.1125"></a><span id="l45.1125">   channelPrefixes: [&quot;&amp;&quot;, &quot;#&quot;, &quot;+&quot;, &quot;!&quot;], // 1.3 Channels</span>
<a href="#l45.1126"></a><span id="l45.1126" class="difflineminus">-  channelRestrictionToModeMap: {&quot;@&quot;: &quot;s&quot;, &quot;*&quot;: &quot;p&quot;, &quot;=&quot;: null}, // 353 RPL_NAMREPLY</span>
<a href="#l45.1127"></a><span id="l45.1127" class="difflineplus">+  channelRestrictionToModeMap: { &quot;@&quot;: &quot;s&quot;, &quot;*&quot;: &quot;p&quot;, &quot;=&quot;: null }, // 353 RPL_NAMREPLY</span>
<a href="#l45.1128"></a><span id="l45.1128"> </span>
<a href="#l45.1129"></a><span id="l45.1129">   // Handle Scandanavian lower case (optionally remove status indicators).</span>
<a href="#l45.1130"></a><span id="l45.1130">   // See Section 2.2 of RFC 2812: the characters {}|^ are considered to be the</span>
<a href="#l45.1131"></a><span id="l45.1131">   // lower case equivalents of the characters []\~, respectively.</span>
<a href="#l45.1132"></a><span id="l45.1132">   normalizeExpression: /[\x41-\x5E]/g,</span>
<a href="#l45.1133"></a><span id="l45.1133">   normalize(aStr, aPrefixes) {</span>
<a href="#l45.1134"></a><span id="l45.1134">     let str = aStr;</span>
<a href="#l45.1135"></a><span id="l45.1135"> </span>
<a href="#l45.1136"></a><span id="l45.1136">     if (aPrefixes) {</span>
<a href="#l45.1137"></a><span id="l45.1137" class="difflineminus">-      while (aPrefixes.includes(str[0]))</span>
<a href="#l45.1138"></a><span id="l45.1138" class="difflineplus">+      while (aPrefixes.includes(str[0])) {</span>
<a href="#l45.1139"></a><span id="l45.1139">         str = str.slice(1);</span>
<a href="#l45.1140"></a><span id="l45.1140" class="difflineplus">+      }</span>
<a href="#l45.1141"></a><span id="l45.1141">     }</span>
<a href="#l45.1142"></a><span id="l45.1142"> </span>
<a href="#l45.1143"></a><span id="l45.1143" class="difflineminus">-    return str.replace(this.normalizeExpression,</span>
<a href="#l45.1144"></a><span id="l45.1144" class="difflineminus">-                       c =&gt; String.fromCharCode(c.charCodeAt(0) + 0x20));</span>
<a href="#l45.1145"></a><span id="l45.1145" class="difflineplus">+    return str.replace(this.normalizeExpression, c =&gt;</span>
<a href="#l45.1146"></a><span id="l45.1146" class="difflineplus">+      String.fromCharCode(c.charCodeAt(0) + 0x20)</span>
<a href="#l45.1147"></a><span id="l45.1147" class="difflineplus">+    );</span>
<a href="#l45.1148"></a><span id="l45.1148">   },</span>
<a href="#l45.1149"></a><span id="l45.1149" class="difflineminus">-  normalizeNick(aNick) { return this.normalize(aNick, this.userPrefixes); },</span>
<a href="#l45.1150"></a><span id="l45.1150" class="difflineplus">+  normalizeNick(aNick) {</span>
<a href="#l45.1151"></a><span id="l45.1151" class="difflineplus">+    return this.normalize(aNick, this.userPrefixes);</span>
<a href="#l45.1152"></a><span id="l45.1152" class="difflineplus">+  },</span>
<a href="#l45.1153"></a><span id="l45.1153"> </span>
<a href="#l45.1154"></a><span id="l45.1154">   isMUCName(aStr) {</span>
<a href="#l45.1155"></a><span id="l45.1155">     return this.channelPrefixes.includes(aStr[0]);</span>
<a href="#l45.1156"></a><span id="l45.1156">   },</span>
<a href="#l45.1157"></a><span id="l45.1157"> </span>
<a href="#l45.1158"></a><span id="l45.1158">   // Tell the server about status changes. IRC is only away or not away;</span>
<a href="#l45.1159"></a><span id="l45.1159">   // consider the away, idle and unavailable status type to be away.</span>
<a href="#l45.1160"></a><span id="l45.1160">   isAway: false,</span>
<a href="#l45.1161"></a><span id="l45.1161">   observe(aSubject, aTopic, aData) {</span>
<a href="#l45.1162"></a><span id="l45.1162" class="difflineminus">-    if (aTopic != &quot;status-changed&quot;)</span>
<a href="#l45.1163"></a><span id="l45.1163" class="difflineplus">+    if (aTopic != &quot;status-changed&quot;) {</span>
<a href="#l45.1164"></a><span id="l45.1164">       return;</span>
<a href="#l45.1165"></a><span id="l45.1165" class="difflineplus">+    }</span>
<a href="#l45.1166"></a><span id="l45.1166"> </span>
<a href="#l45.1167"></a><span id="l45.1167" class="difflineminus">-    let {statusType: type, statusText: text} = this.imAccount.statusInfo;</span>
<a href="#l45.1168"></a><span id="l45.1168" class="difflineplus">+    let { statusType: type, statusText: text } = this.imAccount.statusInfo;</span>
<a href="#l45.1169"></a><span id="l45.1169">     this.DEBUG(&quot;New status received:\ntype = &quot; + type + &quot;\ntext = &quot; + text);</span>
<a href="#l45.1170"></a><span id="l45.1170"> </span>
<a href="#l45.1171"></a><span id="l45.1171">     // Tell the server to mark us as away.</span>
<a href="#l45.1172"></a><span id="l45.1172">     if (type &lt; Ci.imIStatusInfo.STATUS_AVAILABLE) {</span>
<a href="#l45.1173"></a><span id="l45.1173">       // We have to have a string in order to set IRC as AWAY.</span>
<a href="#l45.1174"></a><span id="l45.1174">       if (!text) {</span>
<a href="#l45.1175"></a><span id="l45.1175">         // If no status is given, use the the default idle/away message.</span>
<a href="#l45.1176"></a><span id="l45.1176">         const IDLE_PREF_BRANCH = &quot;messenger.status.&quot;;</span>
<a href="#l45.1177"></a><span id="l45.1177">         const IDLE_PREF = &quot;defaultIdleAwayMessage&quot;;</span>
<a href="#l45.1178"></a><span id="l45.1178" class="difflineminus">-        text = Services.prefs.getComplexValue(IDLE_PREF_BRANCH + IDLE_PREF,</span>
<a href="#l45.1179"></a><span id="l45.1179" class="difflineminus">-                                              Ci.nsIPrefLocalizedString).data;</span>
<a href="#l45.1180"></a><span id="l45.1180" class="difflineplus">+        text = Services.prefs.getComplexValue(</span>
<a href="#l45.1181"></a><span id="l45.1181" class="difflineplus">+          IDLE_PREF_BRANCH + IDLE_PREF,</span>
<a href="#l45.1182"></a><span id="l45.1182" class="difflineplus">+          Ci.nsIPrefLocalizedString</span>
<a href="#l45.1183"></a><span id="l45.1183" class="difflineplus">+        ).data;</span>
<a href="#l45.1184"></a><span id="l45.1184"> </span>
<a href="#l45.1185"></a><span id="l45.1185">         if (!text) {</span>
<a href="#l45.1186"></a><span id="l45.1186">           // Get the default value of the localized preference.</span>
<a href="#l45.1187"></a><span id="l45.1187" class="difflineminus">-          text = Services.prefs.getDefaultBranch(IDLE_PREF_BRANCH)</span>
<a href="#l45.1188"></a><span id="l45.1188" class="difflineminus">-                         .getComplexValue(IDLE_PREF,</span>
<a href="#l45.1189"></a><span id="l45.1189" class="difflineminus">-                                          Ci.nsIPrefLocalizedString).data;</span>
<a href="#l45.1190"></a><span id="l45.1190" class="difflineplus">+          text = Services.prefs</span>
<a href="#l45.1191"></a><span id="l45.1191" class="difflineplus">+            .getDefaultBranch(IDLE_PREF_BRANCH)</span>
<a href="#l45.1192"></a><span id="l45.1192" class="difflineplus">+            .getComplexValue(IDLE_PREF, Ci.nsIPrefLocalizedString).data;</span>
<a href="#l45.1193"></a><span id="l45.1193">         }</span>
<a href="#l45.1194"></a><span id="l45.1194">         // The last resort, fallback to a non-localized string.</span>
<a href="#l45.1195"></a><span id="l45.1195" class="difflineminus">-        if (!text)</span>
<a href="#l45.1196"></a><span id="l45.1196" class="difflineplus">+        if (!text) {</span>
<a href="#l45.1197"></a><span id="l45.1197">           text = &quot;Away&quot;;</span>
<a href="#l45.1198"></a><span id="l45.1198" class="difflineplus">+        }</span>
<a href="#l45.1199"></a><span id="l45.1199">       }</span>
<a href="#l45.1200"></a><span id="l45.1200">       this.sendMessage(&quot;AWAY&quot;, text); // Mark as away.</span>
<a href="#l45.1201"></a><span id="l45.1201" class="difflineminus">-    }</span>
<a href="#l45.1202"></a><span id="l45.1202" class="difflineminus">-    else if (type == Ci.imIStatusInfo.STATUS_AVAILABLE &amp;&amp; this.isAway)</span>
<a href="#l45.1203"></a><span id="l45.1203" class="difflineminus">-      this.sendMessage(&quot;AWAY&quot;); // Mark as back.</span>
<a href="#l45.1204"></a><span id="l45.1204" class="difflineplus">+    } else if (type == Ci.imIStatusInfo.STATUS_AVAILABLE &amp;&amp; this.isAway) {</span>
<a href="#l45.1205"></a><span id="l45.1205" class="difflineplus">+      this.sendMessage(&quot;AWAY&quot;);</span>
<a href="#l45.1206"></a><span id="l45.1206" class="difflineplus">+    } // Mark as back.</span>
<a href="#l45.1207"></a><span id="l45.1207">   },</span>
<a href="#l45.1208"></a><span id="l45.1208"> </span>
<a href="#l45.1209"></a><span id="l45.1209">   // The user's user mode.</span>
<a href="#l45.1210"></a><span id="l45.1210">   _modes: null,</span>
<a href="#l45.1211"></a><span id="l45.1211">   _userModeReceived: false,</span>
<a href="#l45.1212"></a><span id="l45.1212">   setUserMode(aNick, aNewModes, aSetter, aDisplayFullMode) {</span>
<a href="#l45.1213"></a><span id="l45.1213">     if (this.normalizeNick(aNick) != this.normalizeNick(this._nickname)) {</span>
<a href="#l45.1214"></a><span id="l45.1214">       this.WARN(&quot;Received unexpected mode for &quot; + aNick);</span>
<a href="#l45.1215"></a><span id="l45.1215" class="difflineat">@@ -1013,71 +1164,89 @@ ircAccount.prototype = {</span>
<a href="#l45.1216"></a><span id="l45.1216">     // The server informs us of the user's mode when connecting.</span>
<a href="#l45.1217"></a><span id="l45.1217">     // We should not report this initial mode message as a mode change</span>
<a href="#l45.1218"></a><span id="l45.1218">     // initiated by the user, but instead display the full mode</span>
<a href="#l45.1219"></a><span id="l45.1219">     // and then remember we have done so.</span>
<a href="#l45.1220"></a><span id="l45.1220">     this._userModeReceived = true;</span>
<a href="#l45.1221"></a><span id="l45.1221"> </span>
<a href="#l45.1222"></a><span id="l45.1222">     if (this._showServerTab) {</span>
<a href="#l45.1223"></a><span id="l45.1223">       let msg;</span>
<a href="#l45.1224"></a><span id="l45.1224" class="difflineminus">-      if (aDisplayFullMode)</span>
<a href="#l45.1225"></a><span id="l45.1225" class="difflineplus">+      if (aDisplayFullMode) {</span>
<a href="#l45.1226"></a><span id="l45.1226">         msg = _(&quot;message.yourmode&quot;, Array.from(this._modes).join(&quot;&quot;));</span>
<a href="#l45.1227"></a><span id="l45.1227" class="difflineminus">-      else {</span>
<a href="#l45.1228"></a><span id="l45.1228" class="difflineminus">-        msg = _(&quot;message.usermode&quot;, aNewModes, aNick,</span>
<a href="#l45.1229"></a><span id="l45.1229" class="difflineminus">-                aSetter || this._currentServerName);</span>
<a href="#l45.1230"></a><span id="l45.1230" class="difflineplus">+      } else {</span>
<a href="#l45.1231"></a><span id="l45.1231" class="difflineplus">+        msg = _(</span>
<a href="#l45.1232"></a><span id="l45.1232" class="difflineplus">+          &quot;message.usermode&quot;,</span>
<a href="#l45.1233"></a><span id="l45.1233" class="difflineplus">+          aNewModes,</span>
<a href="#l45.1234"></a><span id="l45.1234" class="difflineplus">+          aNick,</span>
<a href="#l45.1235"></a><span id="l45.1235" class="difflineplus">+          aSetter || this._currentServerName</span>
<a href="#l45.1236"></a><span id="l45.1236" class="difflineplus">+        );</span>
<a href="#l45.1237"></a><span id="l45.1237">       }</span>
<a href="#l45.1238"></a><span id="l45.1238" class="difflineminus">-      this.getConversation(this._currentServerName)</span>
<a href="#l45.1239"></a><span id="l45.1239" class="difflineminus">-          .writeMessage(this._currentServerName, msg, {system: true});</span>
<a href="#l45.1240"></a><span id="l45.1240" class="difflineplus">+      this.getConversation(this._currentServerName).writeMessage(</span>
<a href="#l45.1241"></a><span id="l45.1241" class="difflineplus">+        this._currentServerName,</span>
<a href="#l45.1242"></a><span id="l45.1242" class="difflineplus">+        msg,</span>
<a href="#l45.1243"></a><span id="l45.1243" class="difflineplus">+        { system: true }</span>
<a href="#l45.1244"></a><span id="l45.1244" class="difflineplus">+      );</span>
<a href="#l45.1245"></a><span id="l45.1245">     }</span>
<a href="#l45.1246"></a><span id="l45.1246">     return true;</span>
<a href="#l45.1247"></a><span id="l45.1247">   },</span>
<a href="#l45.1248"></a><span id="l45.1248"> </span>
<a href="#l45.1249"></a><span id="l45.1249">   // Room info: maps channel names to {topic, participantCount}.</span>
<a href="#l45.1250"></a><span id="l45.1250">   _channelList: new Map(),</span>
<a href="#l45.1251"></a><span id="l45.1251">   _roomInfoCallbacks: new Set(),</span>
<a href="#l45.1252"></a><span id="l45.1252">   // If true, we have sent the LIST request and are waiting for replies.</span>
<a href="#l45.1253"></a><span id="l45.1253">   _pendingList: false,</span>
<a href="#l45.1254"></a><span id="l45.1254">   // Callbacks receive this many channels per call while results are incoming.</span>
<a href="#l45.1255"></a><span id="l45.1255">   _channelsPerBatch: 50,</span>
<a href="#l45.1256"></a><span id="l45.1256">   _currentBatch: [],</span>
<a href="#l45.1257"></a><span id="l45.1257">   _lastListTime: 0,</span>
<a href="#l45.1258"></a><span id="l45.1258" class="difflineminus">-  get isRoomInfoStale() { return Date.now() - this._lastListTime &gt; kListRefreshInterval; },</span>
<a href="#l45.1259"></a><span id="l45.1259" class="difflineplus">+  get isRoomInfoStale() {</span>
<a href="#l45.1260"></a><span id="l45.1260" class="difflineplus">+    return Date.now() - this._lastListTime &gt; kListRefreshInterval;</span>
<a href="#l45.1261"></a><span id="l45.1261" class="difflineplus">+  },</span>
<a href="#l45.1262"></a><span id="l45.1262">   // Called by consumers that want a list of available channels, which are</span>
<a href="#l45.1263"></a><span id="l45.1263">   // provided through the callback (prplIRoomInfoCallback instance).</span>
<a href="#l45.1264"></a><span id="l45.1264">   requestRoomInfo(aCallback, aIsUserRequest) {</span>
<a href="#l45.1265"></a><span id="l45.1265">     // Ignore the automaticList pref if the user explicitly requests /list.</span>
<a href="#l45.1266"></a><span id="l45.1266" class="difflineminus">-    if (!aIsUserRequest &amp;&amp;</span>
<a href="#l45.1267"></a><span id="l45.1267" class="difflineminus">-        !Services.prefs.getBoolPref(&quot;chat.irc.automaticList&quot;))</span>
<a href="#l45.1268"></a><span id="l45.1268" class="difflineminus">-      throw Cr.NS_ERROR_NOT_IMPLEMENTED; // Pretend we can't return roomInfo.</span>
<a href="#l45.1269"></a><span id="l45.1269" class="difflineminus">-    if (this._roomInfoCallbacks.has(aCallback)) // Callback is not new.</span>
<a href="#l45.1270"></a><span id="l45.1270" class="difflineplus">+    if (</span>
<a href="#l45.1271"></a><span id="l45.1271" class="difflineplus">+      !aIsUserRequest &amp;&amp;</span>
<a href="#l45.1272"></a><span id="l45.1272" class="difflineplus">+      !Services.prefs.getBoolPref(&quot;chat.irc.automaticList&quot;)</span>
<a href="#l45.1273"></a><span id="l45.1273" class="difflineplus">+    ) {</span>
<a href="#l45.1274"></a><span id="l45.1274" class="difflineplus">+      throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l45.1275"></a><span id="l45.1275" class="difflineplus">+    } // Pretend we can't return roomInfo.</span>
<a href="#l45.1276"></a><span id="l45.1276" class="difflineplus">+    if (this._roomInfoCallbacks.has(aCallback)) {</span>
<a href="#l45.1277"></a><span id="l45.1277" class="difflineplus">+      // Callback is not new.</span>
<a href="#l45.1278"></a><span id="l45.1278">       return;</span>
<a href="#l45.1279"></a><span id="l45.1279" class="difflineplus">+    }</span>
<a href="#l45.1280"></a><span id="l45.1280">     // Send a LIST request if the channel list is stale and a current request</span>
<a href="#l45.1281"></a><span id="l45.1281">     // has not been sent.</span>
<a href="#l45.1282"></a><span id="l45.1282">     if (this.isRoomInfoStale &amp;&amp; !this._pendingList) {</span>
<a href="#l45.1283"></a><span id="l45.1283">       this._channelList = new Map();</span>
<a href="#l45.1284"></a><span id="l45.1284">       this._currentBatch = [];</span>
<a href="#l45.1285"></a><span id="l45.1285">       this._pendingList = true;</span>
<a href="#l45.1286"></a><span id="l45.1286">       this._lastListTime = Date.now();</span>
<a href="#l45.1287"></a><span id="l45.1287">       this.sendMessage(&quot;LIST&quot;);</span>
<a href="#l45.1288"></a><span id="l45.1288">     }</span>
<a href="#l45.1289"></a><span id="l45.1289">     // Otherwise, pass channels that have already been received to the callback.</span>
<a href="#l45.1290"></a><span id="l45.1290">     else {</span>
<a href="#l45.1291"></a><span id="l45.1291">       let rooms = [...this._channelList.keys()];</span>
<a href="#l45.1292"></a><span id="l45.1292">       aCallback.onRoomInfoAvailable(rooms, !this._pendingList, rooms.length);</span>
<a href="#l45.1293"></a><span id="l45.1293">     }</span>
<a href="#l45.1294"></a><span id="l45.1294"> </span>
<a href="#l45.1295"></a><span id="l45.1295" class="difflineminus">-    if (this._pendingList)</span>
<a href="#l45.1296"></a><span id="l45.1296" class="difflineplus">+    if (this._pendingList) {</span>
<a href="#l45.1297"></a><span id="l45.1297">       this._roomInfoCallbacks.add(aCallback);</span>
<a href="#l45.1298"></a><span id="l45.1298" class="difflineplus">+    }</span>
<a href="#l45.1299"></a><span id="l45.1299">   },</span>
<a href="#l45.1300"></a><span id="l45.1300">   // Pass room info for any remaining channels to callbacks and clean up.</span>
<a href="#l45.1301"></a><span id="l45.1301">   _sendRemainingRoomInfo() {</span>
<a href="#l45.1302"></a><span id="l45.1302">     if (this._currentBatch.length) {</span>
<a href="#l45.1303"></a><span id="l45.1303">       for (let callback of this._roomInfoCallbacks) {</span>
<a href="#l45.1304"></a><span id="l45.1304" class="difflineminus">-        callback.onRoomInfoAvailable(this._currentBatch, true,</span>
<a href="#l45.1305"></a><span id="l45.1305" class="difflineminus">-                                     this._currentBatch.length);</span>
<a href="#l45.1306"></a><span id="l45.1306" class="difflineplus">+        callback.onRoomInfoAvailable(</span>
<a href="#l45.1307"></a><span id="l45.1307" class="difflineplus">+          this._currentBatch,</span>
<a href="#l45.1308"></a><span id="l45.1308" class="difflineplus">+          true,</span>
<a href="#l45.1309"></a><span id="l45.1309" class="difflineplus">+          this._currentBatch.length</span>
<a href="#l45.1310"></a><span id="l45.1310" class="difflineplus">+        );</span>
<a href="#l45.1311"></a><span id="l45.1311">       }</span>
<a href="#l45.1312"></a><span id="l45.1312">     }</span>
<a href="#l45.1313"></a><span id="l45.1313">     this._roomInfoCallbacks.clear();</span>
<a href="#l45.1314"></a><span id="l45.1314">     delete this._pendingList;</span>
<a href="#l45.1315"></a><span id="l45.1315">     delete this._currentBatch;</span>
<a href="#l45.1316"></a><span id="l45.1316">   },</span>
<a href="#l45.1317"></a><span id="l45.1317">   getRoomInfo(aName) {</span>
<a href="#l45.1318"></a><span id="l45.1318">     return new ircRoomInfo(aName, this);</span>
<a href="#l45.1319"></a><span id="l45.1319" class="difflineat">@@ -1086,62 +1255,72 @@ ircAccount.prototype = {</span>
<a href="#l45.1320"></a><span id="l45.1320">   // The last time a buffered command was sent.</span>
<a href="#l45.1321"></a><span id="l45.1321">   _lastCommandSendTime: 0,</span>
<a href="#l45.1322"></a><span id="l45.1322">   // A map from command names to the parameter buffer for that command.</span>
<a href="#l45.1323"></a><span id="l45.1323">   // This buffer is a map from first parameter to the corresponding (optional)</span>
<a href="#l45.1324"></a><span id="l45.1324">   // second parameter, to ensure automatic deduplication.</span>
<a href="#l45.1325"></a><span id="l45.1325">   _commandBuffers: new Map(),</span>
<a href="#l45.1326"></a><span id="l45.1326">   _handleCommandBuffer(aCommand) {</span>
<a href="#l45.1327"></a><span id="l45.1327">     let buffer = this._commandBuffers.get(aCommand);</span>
<a href="#l45.1328"></a><span id="l45.1328" class="difflineminus">-    if (!buffer || !buffer.size)</span>
<a href="#l45.1329"></a><span id="l45.1329" class="difflineplus">+    if (!buffer || !buffer.size) {</span>
<a href="#l45.1330"></a><span id="l45.1330">       return;</span>
<a href="#l45.1331"></a><span id="l45.1331" class="difflineplus">+    }</span>
<a href="#l45.1332"></a><span id="l45.1332">     // This short delay should usually not affect commands triggered by</span>
<a href="#l45.1333"></a><span id="l45.1333">     // user action, but helps gather commands together which are sent</span>
<a href="#l45.1334"></a><span id="l45.1334">     // by the prpl on connection (e.g. WHOIS sent in response to incoming</span>
<a href="#l45.1335"></a><span id="l45.1335">     // WATCH results).</span>
<a href="#l45.1336"></a><span id="l45.1336">     const kInterval = 1000;</span>
<a href="#l45.1337"></a><span id="l45.1337">     let delay = kInterval - (Date.now() - this._lastCommandSendTime);</span>
<a href="#l45.1338"></a><span id="l45.1338">     if (delay &gt; 0) {</span>
<a href="#l45.1339"></a><span id="l45.1339">       setTimeout(() =&gt; this._handleCommandBuffer(aCommand), delay);</span>
<a href="#l45.1340"></a><span id="l45.1340">       return;</span>
<a href="#l45.1341"></a><span id="l45.1341">     }</span>
<a href="#l45.1342"></a><span id="l45.1342">     this._lastCommandSendTime = Date.now();</span>
<a href="#l45.1343"></a><span id="l45.1343"> </span>
<a href="#l45.1344"></a><span id="l45.1344" class="difflineminus">-    let getParams = (aItems) =&gt; {</span>
<a href="#l45.1345"></a><span id="l45.1345" class="difflineplus">+    let getParams = aItems =&gt; {</span>
<a href="#l45.1346"></a><span id="l45.1346">       // Taking the JOIN use case as an example, aItems is an array</span>
<a href="#l45.1347"></a><span id="l45.1347">       // of [channel, key] pairs.</span>
<a href="#l45.1348"></a><span id="l45.1348">       // To work around an inspircd bug (bug 1108596), we reorder</span>
<a href="#l45.1349"></a><span id="l45.1349">       // the list so that entries with keys appear first.</span>
<a href="#l45.1350"></a><span id="l45.1350">       let items = aItems.slice().sort(([c1, k1], [c2, k2]) =&gt; {</span>
<a href="#l45.1351"></a><span id="l45.1351" class="difflineminus">-        if (!k1 &amp;&amp; k2)</span>
<a href="#l45.1352"></a><span id="l45.1352" class="difflineplus">+        if (!k1 &amp;&amp; k2) {</span>
<a href="#l45.1353"></a><span id="l45.1353">           return 1;</span>
<a href="#l45.1354"></a><span id="l45.1354" class="difflineminus">-        if (k1 &amp;&amp; !k2)</span>
<a href="#l45.1355"></a><span id="l45.1355" class="difflineplus">+        }</span>
<a href="#l45.1356"></a><span id="l45.1356" class="difflineplus">+        if (k1 &amp;&amp; !k2) {</span>
<a href="#l45.1357"></a><span id="l45.1357">           return -1;</span>
<a href="#l45.1358"></a><span id="l45.1358" class="difflineplus">+        }</span>
<a href="#l45.1359"></a><span id="l45.1359">         return 0;</span>
<a href="#l45.1360"></a><span id="l45.1360">       });</span>
<a href="#l45.1361"></a><span id="l45.1361">       // To send the command, we have to group all the channels and keys</span>
<a href="#l45.1362"></a><span id="l45.1362">       // together, i.e. grab the columns of this matrix, and build the two</span>
<a href="#l45.1363"></a><span id="l45.1363">       // parameters of the command from that.</span>
<a href="#l45.1364"></a><span id="l45.1364">       let channels = items.map(([channel, key]) =&gt; channel);</span>
<a href="#l45.1365"></a><span id="l45.1365">       let keys = items.map(([channel, key]) =&gt; key).filter(key =&gt; !!key);</span>
<a href="#l45.1366"></a><span id="l45.1366">       let params = [channels.join(&quot;,&quot;)];</span>
<a href="#l45.1367"></a><span id="l45.1367" class="difflineminus">-      if (keys.length)</span>
<a href="#l45.1368"></a><span id="l45.1368" class="difflineplus">+      if (keys.length) {</span>
<a href="#l45.1369"></a><span id="l45.1369">         params.push(keys.join(&quot;,&quot;));</span>
<a href="#l45.1370"></a><span id="l45.1370" class="difflineplus">+      }</span>
<a href="#l45.1371"></a><span id="l45.1371">       return params;</span>
<a href="#l45.1372"></a><span id="l45.1372">     };</span>
<a href="#l45.1373"></a><span id="l45.1373" class="difflineminus">-    let tooMany = (aItems) =&gt; {</span>
<a href="#l45.1374"></a><span id="l45.1374" class="difflineplus">+    let tooMany = aItems =&gt; {</span>
<a href="#l45.1375"></a><span id="l45.1375">       let params = getParams(aItems);</span>
<a href="#l45.1376"></a><span id="l45.1376">       let length = this.countBytes(this.buildMessage(aCommand, params)) + 2;</span>
<a href="#l45.1377"></a><span id="l45.1377">       return this.maxMessageLength &lt; length;</span>
<a href="#l45.1378"></a><span id="l45.1378">     };</span>
<a href="#l45.1379"></a><span id="l45.1379" class="difflineminus">-    let send = (aItems) =&gt; {</span>
<a href="#l45.1380"></a><span id="l45.1380" class="difflineplus">+    let send = aItems =&gt; {</span>
<a href="#l45.1381"></a><span id="l45.1381">       let params = getParams(aItems);</span>
<a href="#l45.1382"></a><span id="l45.1382">       // Send the command, but don't log the keys.</span>
<a href="#l45.1383"></a><span id="l45.1383" class="difflineminus">-      this.sendMessage(aCommand, params, aCommand + &quot; &quot; + params[0] +</span>
<a href="#l45.1384"></a><span id="l45.1384" class="difflineminus">-                       (params.length &gt; 1 ? &quot; &lt;keys not logged&gt;&quot; : &quot;&quot;));</span>
<a href="#l45.1385"></a><span id="l45.1385" class="difflineplus">+      this.sendMessage(</span>
<a href="#l45.1386"></a><span id="l45.1386" class="difflineplus">+        aCommand,</span>
<a href="#l45.1387"></a><span id="l45.1387" class="difflineplus">+        params,</span>
<a href="#l45.1388"></a><span id="l45.1388" class="difflineplus">+        aCommand +</span>
<a href="#l45.1389"></a><span id="l45.1389" class="difflineplus">+          &quot; &quot; +</span>
<a href="#l45.1390"></a><span id="l45.1390" class="difflineplus">+          params[0] +</span>
<a href="#l45.1391"></a><span id="l45.1391" class="difflineplus">+          (params.length &gt; 1 ? &quot; &lt;keys not logged&gt;&quot; : &quot;&quot;)</span>
<a href="#l45.1392"></a><span id="l45.1392" class="difflineplus">+      );</span>
<a href="#l45.1393"></a><span id="l45.1393">     };</span>
<a href="#l45.1394"></a><span id="l45.1394"> </span>
<a href="#l45.1395"></a><span id="l45.1395">     let items = [];</span>
<a href="#l45.1396"></a><span id="l45.1396">     for (let item of buffer) {</span>
<a href="#l45.1397"></a><span id="l45.1397">       items.push(item);</span>
<a href="#l45.1398"></a><span id="l45.1398">       if (tooMany(items)) {</span>
<a href="#l45.1399"></a><span id="l45.1399">         items.pop();</span>
<a href="#l45.1400"></a><span id="l45.1400">         send(items);</span>
<a href="#l45.1401"></a><span id="l45.1401" class="difflineat">@@ -1155,101 +1334,118 @@ ircAccount.prototype = {</span>
<a href="#l45.1402"></a><span id="l45.1402">   // buffer to send as few commands as possible, by gathering the parameters.</span>
<a href="#l45.1403"></a><span id="l45.1403">   // On servers which impose command penalties (e.g. inspircd) this helps</span>
<a href="#l45.1404"></a><span id="l45.1404">   // avoid triggering fakelags by minimizing the command penalty.</span>
<a href="#l45.1405"></a><span id="l45.1405">   // aParam is the first and aKey the optional second parameter of a command</span>
<a href="#l45.1406"></a><span id="l45.1406">   // with the syntax &lt;param&gt; *(&quot;,&quot; &lt;param&gt;) [&lt;key&gt; *(&quot;,&quot; &lt;key&gt;)]</span>
<a href="#l45.1407"></a><span id="l45.1407">   // While this code is mostly abstracted, it is currently assumed the second</span>
<a href="#l45.1408"></a><span id="l45.1408">   // parameter is only used for JOIN.</span>
<a href="#l45.1409"></a><span id="l45.1409">   sendBufferedCommand(aCommand, aParam, aKey = &quot;&quot;) {</span>
<a href="#l45.1410"></a><span id="l45.1410" class="difflineminus">-    if (!this._commandBuffers.has(aCommand))</span>
<a href="#l45.1411"></a><span id="l45.1411" class="difflineplus">+    if (!this._commandBuffers.has(aCommand)) {</span>
<a href="#l45.1412"></a><span id="l45.1412">       this._commandBuffers.set(aCommand, new Map());</span>
<a href="#l45.1413"></a><span id="l45.1413" class="difflineplus">+    }</span>
<a href="#l45.1414"></a><span id="l45.1414">     let buffer = this._commandBuffers.get(aCommand);</span>
<a href="#l45.1415"></a><span id="l45.1415">     // If the buffer is empty, schedule sending the command, otherwise</span>
<a href="#l45.1416"></a><span id="l45.1416">     // we just need to add the parameter to the buffer.</span>
<a href="#l45.1417"></a><span id="l45.1417">     // We use executeSoon so as to not delay the sending of these</span>
<a href="#l45.1418"></a><span id="l45.1418">     // commands when it is not necessary.</span>
<a href="#l45.1419"></a><span id="l45.1419" class="difflineminus">-    if (!buffer.size)</span>
<a href="#l45.1420"></a><span id="l45.1420" class="difflineplus">+    if (!buffer.size) {</span>
<a href="#l45.1421"></a><span id="l45.1421">       executeSoon(() =&gt; this._handleCommandBuffer(aCommand));</span>
<a href="#l45.1422"></a><span id="l45.1422" class="difflineplus">+    }</span>
<a href="#l45.1423"></a><span id="l45.1423">     buffer.set(aParam, aKey);</span>
<a href="#l45.1424"></a><span id="l45.1424">   },</span>
<a href="#l45.1425"></a><span id="l45.1425"> </span>
<a href="#l45.1426"></a><span id="l45.1426">   // The whois information: nicks are used as keys and refer to a map of field</span>
<a href="#l45.1427"></a><span id="l45.1427">   // to value.</span>
<a href="#l45.1428"></a><span id="l45.1428">   whoisInformation: null,</span>
<a href="#l45.1429"></a><span id="l45.1429">   // Request WHOIS information on a buddy when the user requests more</span>
<a href="#l45.1430"></a><span id="l45.1430">   // information. If we already have some WHOIS information stored for this</span>
<a href="#l45.1431"></a><span id="l45.1431">   // nick, a notification with this (potentially out-of-date) information</span>
<a href="#l45.1432"></a><span id="l45.1432">   // is sent out immediately. It is followed by another notification when</span>
<a href="#l45.1433"></a><span id="l45.1433">   // the current WHOIS data is returned by the server.</span>
<a href="#l45.1434"></a><span id="l45.1434">   // If you are only interested in the current WHOIS, requestCurrentWhois</span>
<a href="#l45.1435"></a><span id="l45.1435">   // should be used instead.</span>
<a href="#l45.1436"></a><span id="l45.1436">   requestBuddyInfo(aBuddyName) {</span>
<a href="#l45.1437"></a><span id="l45.1437" class="difflineminus">-    if (!this.connected)</span>
<a href="#l45.1438"></a><span id="l45.1438" class="difflineplus">+    if (!this.connected) {</span>
<a href="#l45.1439"></a><span id="l45.1439">       return;</span>
<a href="#l45.1440"></a><span id="l45.1440" class="difflineplus">+    }</span>
<a href="#l45.1441"></a><span id="l45.1441"> </span>
<a href="#l45.1442"></a><span id="l45.1442">     // Return what we have stored immediately.</span>
<a href="#l45.1443"></a><span id="l45.1443" class="difflineminus">-    if (this.whoisInformation.has(aBuddyName))</span>
<a href="#l45.1444"></a><span id="l45.1444" class="difflineplus">+    if (this.whoisInformation.has(aBuddyName)) {</span>
<a href="#l45.1445"></a><span id="l45.1445">       this.notifyWhois(aBuddyName);</span>
<a href="#l45.1446"></a><span id="l45.1446" class="difflineplus">+    }</span>
<a href="#l45.1447"></a><span id="l45.1447"> </span>
<a href="#l45.1448"></a><span id="l45.1448">     // Request the current whois and update.</span>
<a href="#l45.1449"></a><span id="l45.1449">     this.requestCurrentWhois(aBuddyName);</span>
<a href="#l45.1450"></a><span id="l45.1450">   },</span>
<a href="#l45.1451"></a><span id="l45.1451">   // Request fresh WHOIS information on a nick.</span>
<a href="#l45.1452"></a><span id="l45.1452">   requestCurrentWhois(aNick) {</span>
<a href="#l45.1453"></a><span id="l45.1453" class="difflineminus">-    if (!this.connected)</span>
<a href="#l45.1454"></a><span id="l45.1454" class="difflineplus">+    if (!this.connected) {</span>
<a href="#l45.1455"></a><span id="l45.1455">       return;</span>
<a href="#l45.1456"></a><span id="l45.1456" class="difflineplus">+    }</span>
<a href="#l45.1457"></a><span id="l45.1457"> </span>
<a href="#l45.1458"></a><span id="l45.1458">     this.removeBuddyInfo(aNick);</span>
<a href="#l45.1459"></a><span id="l45.1459">     this.sendBufferedCommand(&quot;WHOIS&quot;, aNick);</span>
<a href="#l45.1460"></a><span id="l45.1460">   },</span>
<a href="#l45.1461"></a><span id="l45.1461">   notifyWhois(aNick) {</span>
<a href="#l45.1462"></a><span id="l45.1462" class="difflineminus">-    Services.obs.notifyObservers(this.getBuddyInfo(aNick), &quot;user-info-received&quot;,</span>
<a href="#l45.1463"></a><span id="l45.1463" class="difflineminus">-                                 this.normalizeNick(aNick));</span>
<a href="#l45.1464"></a><span id="l45.1464" class="difflineplus">+    Services.obs.notifyObservers(</span>
<a href="#l45.1465"></a><span id="l45.1465" class="difflineplus">+      this.getBuddyInfo(aNick),</span>
<a href="#l45.1466"></a><span id="l45.1466" class="difflineplus">+      &quot;user-info-received&quot;,</span>
<a href="#l45.1467"></a><span id="l45.1467" class="difflineplus">+      this.normalizeNick(aNick)</span>
<a href="#l45.1468"></a><span id="l45.1468" class="difflineplus">+    );</span>
<a href="#l45.1469"></a><span id="l45.1469">   },</span>
<a href="#l45.1470"></a><span id="l45.1470">   // Request WHOWAS information on a buddy when the user requests more</span>
<a href="#l45.1471"></a><span id="l45.1471">   // information.</span>
<a href="#l45.1472"></a><span id="l45.1472">   requestOfflineBuddyInfo(aBuddyName) {</span>
<a href="#l45.1473"></a><span id="l45.1473">     this.removeBuddyInfo(aBuddyName);</span>
<a href="#l45.1474"></a><span id="l45.1474">     this.sendMessage(&quot;WHOWAS&quot;, aBuddyName);</span>
<a href="#l45.1475"></a><span id="l45.1475">   },</span>
<a href="#l45.1476"></a><span id="l45.1476">   // Return an nsISimpleEnumerator of imITooltipInfo for a given nick.</span>
<a href="#l45.1477"></a><span id="l45.1477">   getBuddyInfo(aNick) {</span>
<a href="#l45.1478"></a><span id="l45.1478" class="difflineminus">-    if (!this.whoisInformation.has(aNick))</span>
<a href="#l45.1479"></a><span id="l45.1479" class="difflineplus">+    if (!this.whoisInformation.has(aNick)) {</span>
<a href="#l45.1480"></a><span id="l45.1480">       return EmptyEnumerator;</span>
<a href="#l45.1481"></a><span id="l45.1481" class="difflineplus">+    }</span>
<a href="#l45.1482"></a><span id="l45.1482"> </span>
<a href="#l45.1483"></a><span id="l45.1483">     let whoisInformation = this.whoisInformation.get(aNick);</span>
<a href="#l45.1484"></a><span id="l45.1484">     if (whoisInformation.serverName &amp;&amp; whoisInformation.serverInfo) {</span>
<a href="#l45.1485"></a><span id="l45.1485" class="difflineminus">-      whoisInformation.server =</span>
<a href="#l45.1486"></a><span id="l45.1486" class="difflineminus">-        _(&quot;tooltip.serverValue&quot;, whoisInformation.serverName,</span>
<a href="#l45.1487"></a><span id="l45.1487" class="difflineminus">-          whoisInformation.serverInfo);</span>
<a href="#l45.1488"></a><span id="l45.1488" class="difflineplus">+      whoisInformation.server = _(</span>
<a href="#l45.1489"></a><span id="l45.1489" class="difflineplus">+        &quot;tooltip.serverValue&quot;,</span>
<a href="#l45.1490"></a><span id="l45.1490" class="difflineplus">+        whoisInformation.serverName,</span>
<a href="#l45.1491"></a><span id="l45.1491" class="difflineplus">+        whoisInformation.serverInfo</span>
<a href="#l45.1492"></a><span id="l45.1492" class="difflineplus">+      );</span>
<a href="#l45.1493"></a><span id="l45.1493">     }</span>
<a href="#l45.1494"></a><span id="l45.1494"> </span>
<a href="#l45.1495"></a><span id="l45.1495">     // Sort the list of channels, ignoring the prefixes of channel and user.</span>
<a href="#l45.1496"></a><span id="l45.1496">     let prefixes = this.userPrefixes.concat(this.channelPrefixes);</span>
<a href="#l45.1497"></a><span id="l45.1497">     let sortWithoutPrefix = function(a, b) {</span>
<a href="#l45.1498"></a><span id="l45.1498">       a = this.normalize(a, prefixes);</span>
<a href="#l45.1499"></a><span id="l45.1499">       b = this.normalize(b, prefixes);</span>
<a href="#l45.1500"></a><span id="l45.1500" class="difflineminus">-      if (a &lt; b)</span>
<a href="#l45.1501"></a><span id="l45.1501" class="difflineplus">+      if (a &lt; b) {</span>
<a href="#l45.1502"></a><span id="l45.1502">         return -1;</span>
<a href="#l45.1503"></a><span id="l45.1503" class="difflineplus">+      }</span>
<a href="#l45.1504"></a><span id="l45.1504">       return a &gt; b ? 1 : 0;</span>
<a href="#l45.1505"></a><span id="l45.1505">     }.bind(this);</span>
<a href="#l45.1506"></a><span id="l45.1506">     let sortChannels = channels =&gt;</span>
<a href="#l45.1507"></a><span id="l45.1507" class="difflineminus">-      channels.trim().split(/\s+/).sort(sortWithoutPrefix).join(&quot; &quot;);</span>
<a href="#l45.1508"></a><span id="l45.1508" class="difflineplus">+      channels</span>
<a href="#l45.1509"></a><span id="l45.1509" class="difflineplus">+        .trim()</span>
<a href="#l45.1510"></a><span id="l45.1510" class="difflineplus">+        .split(/\s+/)</span>
<a href="#l45.1511"></a><span id="l45.1511" class="difflineplus">+        .sort(sortWithoutPrefix)</span>
<a href="#l45.1512"></a><span id="l45.1512" class="difflineplus">+        .join(&quot; &quot;);</span>
<a href="#l45.1513"></a><span id="l45.1513"> </span>
<a href="#l45.1514"></a><span id="l45.1514">     // Convert booleans into a human-readable form.</span>
<a href="#l45.1515"></a><span id="l45.1515">     let normalizeBool = aBool =&gt; _(aBool ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l45.1516"></a><span id="l45.1516"> </span>
<a href="#l45.1517"></a><span id="l45.1517">     // Convert timespan in seconds into a human-readable form.</span>
<a href="#l45.1518"></a><span id="l45.1518">     let normalizeTime = function(aTime) {</span>
<a href="#l45.1519"></a><span id="l45.1519">       let valuesAndUnits = DownloadUtils.convertTimeUnits(aTime);</span>
<a href="#l45.1520"></a><span id="l45.1520">       // If the time is exact to the first set of units, trim off</span>
<a href="#l45.1521"></a><span id="l45.1521">       // the subsequent zeroes.</span>
<a href="#l45.1522"></a><span id="l45.1522" class="difflineminus">-      if (!valuesAndUnits[2])</span>
<a href="#l45.1523"></a><span id="l45.1523" class="difflineplus">+      if (!valuesAndUnits[2]) {</span>
<a href="#l45.1524"></a><span id="l45.1524">         valuesAndUnits.splice(2, 2);</span>
<a href="#l45.1525"></a><span id="l45.1525" class="difflineplus">+      }</span>
<a href="#l45.1526"></a><span id="l45.1526">       return _(&quot;tooltip.timespan&quot;, valuesAndUnits.join(&quot; &quot;));</span>
<a href="#l45.1527"></a><span id="l45.1527">     };</span>
<a href="#l45.1528"></a><span id="l45.1528"> </span>
<a href="#l45.1529"></a><span id="l45.1529">     // List of the names of the info to actually show in the tooltip and</span>
<a href="#l45.1530"></a><span id="l45.1530">     // optionally a transform function to apply to the value. Each field here</span>
<a href="#l45.1531"></a><span id="l45.1531">     // maps to tooltip.&lt;fieldname&gt; in irc.properties.</span>
<a href="#l45.1532"></a><span id="l45.1532">     // See the various RPL_WHOIS* results for the options.</span>
<a href="#l45.1533"></a><span id="l45.1533">     const kFields = {</span>
<a href="#l45.1534"></a><span id="l45.1534" class="difflineat">@@ -1264,72 +1460,82 @@ ircAccount.prototype = {</span>
<a href="#l45.1535"></a><span id="l45.1535">       lastActivity: normalizeTime,</span>
<a href="#l45.1536"></a><span id="l45.1536">       channels: sortChannels,</span>
<a href="#l45.1537"></a><span id="l45.1537">     };</span>
<a href="#l45.1538"></a><span id="l45.1538"> </span>
<a href="#l45.1539"></a><span id="l45.1539">     let tooltipInfo = [];</span>
<a href="#l45.1540"></a><span id="l45.1540">     for (let field in kFields) {</span>
<a href="#l45.1541"></a><span id="l45.1541">       if (whoisInformation.hasOwnProperty(field) &amp;&amp; whoisInformation[field]) {</span>
<a href="#l45.1542"></a><span id="l45.1542">         let value = whoisInformation[field];</span>
<a href="#l45.1543"></a><span id="l45.1543" class="difflineminus">-        if (kFields[field])</span>
<a href="#l45.1544"></a><span id="l45.1544" class="difflineplus">+        if (kFields[field]) {</span>
<a href="#l45.1545"></a><span id="l45.1545">           value = kFields[field](value);</span>
<a href="#l45.1546"></a><span id="l45.1546" class="difflineplus">+        }</span>
<a href="#l45.1547"></a><span id="l45.1547">         tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l45.1548"></a><span id="l45.1548">       }</span>
<a href="#l45.1549"></a><span id="l45.1549">     }</span>
<a href="#l45.1550"></a><span id="l45.1550"> </span>
<a href="#l45.1551"></a><span id="l45.1551">     const kSetIdleStatusAfterSeconds = 3600;</span>
<a href="#l45.1552"></a><span id="l45.1552">     let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l45.1553"></a><span id="l45.1553">     let statusText = &quot;&quot;;</span>
<a href="#l45.1554"></a><span id="l45.1554">     if (&quot;away&quot; in whoisInformation) {</span>
<a href="#l45.1555"></a><span id="l45.1555">       statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l45.1556"></a><span id="l45.1556">       statusText = whoisInformation.away;</span>
<a href="#l45.1557"></a><span id="l45.1557" class="difflineminus">-    }</span>
<a href="#l45.1558"></a><span id="l45.1558" class="difflineminus">-    else if (&quot;offline&quot; in whoisInformation)</span>
<a href="#l45.1559"></a><span id="l45.1559" class="difflineplus">+    } else if (&quot;offline&quot; in whoisInformation) {</span>
<a href="#l45.1560"></a><span id="l45.1560">       statusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l45.1561"></a><span id="l45.1561" class="difflineminus">-    else if (&quot;lastActivity&quot; in whoisInformation &amp;&amp;</span>
<a href="#l45.1562"></a><span id="l45.1562" class="difflineminus">-             whoisInformation.lastActivity &gt; kSetIdleStatusAfterSeconds)</span>
<a href="#l45.1563"></a><span id="l45.1563" class="difflineplus">+    } else if (</span>
<a href="#l45.1564"></a><span id="l45.1564" class="difflineplus">+      &quot;lastActivity&quot; in whoisInformation &amp;&amp;</span>
<a href="#l45.1565"></a><span id="l45.1565" class="difflineplus">+      whoisInformation.lastActivity &gt; kSetIdleStatusAfterSeconds</span>
<a href="#l45.1566"></a><span id="l45.1566" class="difflineplus">+    ) {</span>
<a href="#l45.1567"></a><span id="l45.1567">       statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l45.1568"></a><span id="l45.1568" class="difflineminus">-    tooltipInfo.push(new TooltipInfo(statusType, statusText,</span>
<a href="#l45.1569"></a><span id="l45.1569" class="difflineminus">-                                     Ci.prplITooltipInfo.status));</span>
<a href="#l45.1570"></a><span id="l45.1570" class="difflineplus">+    }</span>
<a href="#l45.1571"></a><span id="l45.1571" class="difflineplus">+    tooltipInfo.push(</span>
<a href="#l45.1572"></a><span id="l45.1572" class="difflineplus">+      new TooltipInfo(statusType, statusText, Ci.prplITooltipInfo.status)</span>
<a href="#l45.1573"></a><span id="l45.1573" class="difflineplus">+    );</span>
<a href="#l45.1574"></a><span id="l45.1574"> </span>
<a href="#l45.1575"></a><span id="l45.1575">     return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l45.1576"></a><span id="l45.1576">   },</span>
<a href="#l45.1577"></a><span id="l45.1577">   // Remove a WHOIS entry.</span>
<a href="#l45.1578"></a><span id="l45.1578" class="difflineminus">-  removeBuddyInfo(aNick) { return this.whoisInformation.delete(aNick); },</span>
<a href="#l45.1579"></a><span id="l45.1579" class="difflineplus">+  removeBuddyInfo(aNick) {</span>
<a href="#l45.1580"></a><span id="l45.1580" class="difflineplus">+    return this.whoisInformation.delete(aNick);</span>
<a href="#l45.1581"></a><span id="l45.1581" class="difflineplus">+  },</span>
<a href="#l45.1582"></a><span id="l45.1582">   // Copies the fields of aFields into the whois table. If the field already</span>
<a href="#l45.1583"></a><span id="l45.1583">   // exists, that field is ignored (it is assumed that the first server response</span>
<a href="#l45.1584"></a><span id="l45.1584">   // is the most up to date information, as is the case for 312/314). Note that</span>
<a href="#l45.1585"></a><span id="l45.1585">   // the whois info for a nick is reset whenever whois information is requested,</span>
<a href="#l45.1586"></a><span id="l45.1586">   // so the first response from each whois is recorded.</span>
<a href="#l45.1587"></a><span id="l45.1587">   setWhois(aNick, aFields = {}) {</span>
<a href="#l45.1588"></a><span id="l45.1588">     // If the nickname isn't in the list yet, add it.</span>
<a href="#l45.1589"></a><span id="l45.1589" class="difflineminus">-    if (!this.whoisInformation.has(aNick))</span>
<a href="#l45.1590"></a><span id="l45.1590" class="difflineplus">+    if (!this.whoisInformation.has(aNick)) {</span>
<a href="#l45.1591"></a><span id="l45.1591">       this.whoisInformation.set(aNick, {});</span>
<a href="#l45.1592"></a><span id="l45.1592" class="difflineplus">+    }</span>
<a href="#l45.1593"></a><span id="l45.1593"> </span>
<a href="#l45.1594"></a><span id="l45.1594">     // Set non-normalized nickname field.</span>
<a href="#l45.1595"></a><span id="l45.1595">     let whoisInfo = this.whoisInformation.get(aNick);</span>
<a href="#l45.1596"></a><span id="l45.1596">     whoisInfo.nick = aNick;</span>
<a href="#l45.1597"></a><span id="l45.1597"> </span>
<a href="#l45.1598"></a><span id="l45.1598">     // Set the WHOIS fields, but only the first time a field is set.</span>
<a href="#l45.1599"></a><span id="l45.1599">     for (let field in aFields) {</span>
<a href="#l45.1600"></a><span id="l45.1600" class="difflineminus">-      if (!whoisInfo.hasOwnProperty(field))</span>
<a href="#l45.1601"></a><span id="l45.1601" class="difflineplus">+      if (!whoisInfo.hasOwnProperty(field)) {</span>
<a href="#l45.1602"></a><span id="l45.1602">         whoisInfo[field] = aFields[field];</span>
<a href="#l45.1603"></a><span id="l45.1603" class="difflineplus">+      }</span>
<a href="#l45.1604"></a><span id="l45.1604">     }</span>
<a href="#l45.1605"></a><span id="l45.1605"> </span>
<a href="#l45.1606"></a><span id="l45.1606">     return true;</span>
<a href="#l45.1607"></a><span id="l45.1607">   },</span>
<a href="#l45.1608"></a><span id="l45.1608"> </span>
<a href="#l45.1609"></a><span id="l45.1609">   trackBuddy(aNick) {</span>
<a href="#l45.1610"></a><span id="l45.1610">     // Put the username as the first to be checked on the next ISON call.</span>
<a href="#l45.1611"></a><span id="l45.1611">     this.trackQueue.unshift(aNick);</span>
<a href="#l45.1612"></a><span id="l45.1612">   },</span>
<a href="#l45.1613"></a><span id="l45.1613">   untrackBuddy(aNick) {</span>
<a href="#l45.1614"></a><span id="l45.1614">     let index = this.trackQueue.indexOf(aNick);</span>
<a href="#l45.1615"></a><span id="l45.1615">     if (index &lt; 0) {</span>
<a href="#l45.1616"></a><span id="l45.1616" class="difflineminus">-      this.ERROR(&quot;Trying to untrack a nick that was not being tracked: &quot; + aNick);</span>
<a href="#l45.1617"></a><span id="l45.1617" class="difflineplus">+      this.ERROR(</span>
<a href="#l45.1618"></a><span id="l45.1618" class="difflineplus">+        &quot;Trying to untrack a nick that was not being tracked: &quot; + aNick</span>
<a href="#l45.1619"></a><span id="l45.1619" class="difflineplus">+      );</span>
<a href="#l45.1620"></a><span id="l45.1620">       return;</span>
<a href="#l45.1621"></a><span id="l45.1621">     }</span>
<a href="#l45.1622"></a><span id="l45.1622">     this.trackQueue.splice(index, 1);</span>
<a href="#l45.1623"></a><span id="l45.1623">   },</span>
<a href="#l45.1624"></a><span id="l45.1624">   addBuddy(aTag, aName) {</span>
<a href="#l45.1625"></a><span id="l45.1625">     let buddy = new ircAccountBuddy(this, null, aTag, aName);</span>
<a href="#l45.1626"></a><span id="l45.1626">     this.buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l45.1627"></a><span id="l45.1627">     this.trackBuddy(buddy.userName);</span>
<a href="#l45.1628"></a><span id="l45.1628" class="difflineat">@@ -1350,25 +1556,25 @@ ircAccount.prototype = {</span>
<a href="#l45.1629"></a><span id="l45.1629">     return buddy;</span>
<a href="#l45.1630"></a><span id="l45.1630">   },</span>
<a href="#l45.1631"></a><span id="l45.1631">   changeBuddyNick(aOldNick, aNewNick) {</span>
<a href="#l45.1632"></a><span id="l45.1632">     if (this.normalizeNick(aOldNick) == this.normalizeNick(this._nickname)) {</span>
<a href="#l45.1633"></a><span id="l45.1633">       // Your nickname changed!</span>
<a href="#l45.1634"></a><span id="l45.1634">       this._nickname = aNewNick;</span>
<a href="#l45.1635"></a><span id="l45.1635">       this.conversations.forEach(conversation =&gt; {</span>
<a href="#l45.1636"></a><span id="l45.1636">         // Update the nick for chats, and inform the user in every conversation.</span>
<a href="#l45.1637"></a><span id="l45.1637" class="difflineminus">-        if (conversation.isChat)</span>
<a href="#l45.1638"></a><span id="l45.1638" class="difflineplus">+        if (conversation.isChat) {</span>
<a href="#l45.1639"></a><span id="l45.1639">           conversation.updateNick(aOldNick, aNewNick, true);</span>
<a href="#l45.1640"></a><span id="l45.1640" class="difflineminus">-        else {</span>
<a href="#l45.1641"></a><span id="l45.1641" class="difflineminus">-          conversation.writeMessage(aOldNick, _conv(&quot;nickSet.you&quot;, aNewNick),</span>
<a href="#l45.1642"></a><span id="l45.1642" class="difflineminus">-                                    {system: true});</span>
<a href="#l45.1643"></a><span id="l45.1643" class="difflineplus">+        } else {</span>
<a href="#l45.1644"></a><span id="l45.1644" class="difflineplus">+          conversation.writeMessage(aOldNick, _conv(&quot;nickSet.you&quot;, aNewNick), {</span>
<a href="#l45.1645"></a><span id="l45.1645" class="difflineplus">+            system: true,</span>
<a href="#l45.1646"></a><span id="l45.1646" class="difflineplus">+          });</span>
<a href="#l45.1647"></a><span id="l45.1647">         }</span>
<a href="#l45.1648"></a><span id="l45.1648">       });</span>
<a href="#l45.1649"></a><span id="l45.1649" class="difflineminus">-    }</span>
<a href="#l45.1650"></a><span id="l45.1650" class="difflineminus">-    else {</span>
<a href="#l45.1651"></a><span id="l45.1651" class="difflineplus">+    } else {</span>
<a href="#l45.1652"></a><span id="l45.1652">       this.conversations.forEach(conversation =&gt; {</span>
<a href="#l45.1653"></a><span id="l45.1653">         if (conversation.isChat &amp;&amp; conversation._participants.has(aOldNick)) {</span>
<a href="#l45.1654"></a><span id="l45.1654">           // Update the nick in every chat conversation it is in.</span>
<a href="#l45.1655"></a><span id="l45.1655">           conversation.updateNick(aOldNick, aNewNick, false);</span>
<a href="#l45.1656"></a><span id="l45.1656">         }</span>
<a href="#l45.1657"></a><span id="l45.1657">       });</span>
<a href="#l45.1658"></a><span id="l45.1658">     }</span>
<a href="#l45.1659"></a><span id="l45.1659"> </span>
<a href="#l45.1660"></a><span id="l45.1660" class="difflineat">@@ -1381,18 +1587,21 @@ ircAccount.prototype = {</span>
<a href="#l45.1661"></a><span id="l45.1661">       // Get the current conversation and rename it.</span>
<a href="#l45.1662"></a><span id="l45.1662">       let conversation = this.getConversation(aOldNick);</span>
<a href="#l45.1663"></a><span id="l45.1663"> </span>
<a href="#l45.1664"></a><span id="l45.1664">       // Remove the old reference to the conversation and create a new one.</span>
<a href="#l45.1665"></a><span id="l45.1665">       this.removeConversation(aOldNick);</span>
<a href="#l45.1666"></a><span id="l45.1666">       this.conversations.set(aNewNick, conversation);</span>
<a href="#l45.1667"></a><span id="l45.1667"> </span>
<a href="#l45.1668"></a><span id="l45.1668">       conversation.updateNick(aNewNick);</span>
<a href="#l45.1669"></a><span id="l45.1669" class="difflineminus">-      conversation.writeMessage(aOldNick, _conv(&quot;nickSet&quot;, aOldNick, aNewNick),</span>
<a href="#l45.1670"></a><span id="l45.1670" class="difflineminus">-                                {system: true});</span>
<a href="#l45.1671"></a><span id="l45.1671" class="difflineplus">+      conversation.writeMessage(</span>
<a href="#l45.1672"></a><span id="l45.1672" class="difflineplus">+        aOldNick,</span>
<a href="#l45.1673"></a><span id="l45.1673" class="difflineplus">+        _conv(&quot;nickSet&quot;, aOldNick, aNewNick),</span>
<a href="#l45.1674"></a><span id="l45.1674" class="difflineplus">+        { system: true }</span>
<a href="#l45.1675"></a><span id="l45.1675" class="difflineplus">+      );</span>
<a href="#l45.1676"></a><span id="l45.1676">     }</span>
<a href="#l45.1677"></a><span id="l45.1677">   },</span>
<a href="#l45.1678"></a><span id="l45.1678"> </span>
<a href="#l45.1679"></a><span id="l45.1679">   /*</span>
<a href="#l45.1680"></a><span id="l45.1680">    * Ask the server to change the user's nick.</span>
<a href="#l45.1681"></a><span id="l45.1681">    */</span>
<a href="#l45.1682"></a><span id="l45.1682">   changeNick(aNewNick) {</span>
<a href="#l45.1683"></a><span id="l45.1683">     this._sentNickname = aNewNick;</span>
<a href="#l45.1684"></a><span id="l45.1684" class="difflineat">@@ -1407,18 +1616,20 @@ ircAccount.prototype = {</span>
<a href="#l45.1685"></a><span id="l45.1685">    *  1. If there was not a digit at the end of the nick, append a 1.</span>
<a href="#l45.1686"></a><span id="l45.1686">    *  2. If there was a digit, then increment the number.</span>
<a href="#l45.1687"></a><span id="l45.1687">    *  3. Add leading 0s back on.</span>
<a href="#l45.1688"></a><span id="l45.1688">    *  4. Ensure the nick is an appropriate length.</span>
<a href="#l45.1689"></a><span id="l45.1689">    */</span>
<a href="#l45.1690"></a><span id="l45.1690">   tryNewNick(aOldNick) {</span>
<a href="#l45.1691"></a><span id="l45.1691">     // Split the string on commas, remove whitespace around the nicks and</span>
<a href="#l45.1692"></a><span id="l45.1692">     // remove empty nicks.</span>
<a href="#l45.1693"></a><span id="l45.1693" class="difflineminus">-    let allNicks = this.getString(&quot;alternateNicks&quot;).split(&quot;,&quot;)</span>
<a href="#l45.1694"></a><span id="l45.1694" class="difflineminus">-                       .map(n =&gt; n.trim()).filter(n =&gt; !!n);</span>
<a href="#l45.1695"></a><span id="l45.1695" class="difflineplus">+    let allNicks = this.getString(&quot;alternateNicks&quot;)</span>
<a href="#l45.1696"></a><span id="l45.1696" class="difflineplus">+      .split(&quot;,&quot;)</span>
<a href="#l45.1697"></a><span id="l45.1697" class="difflineplus">+      .map(n =&gt; n.trim())</span>
<a href="#l45.1698"></a><span id="l45.1698" class="difflineplus">+      .filter(n =&gt; !!n);</span>
<a href="#l45.1699"></a><span id="l45.1699">     allNicks.unshift(this._accountNickname);</span>
<a href="#l45.1700"></a><span id="l45.1700"> </span>
<a href="#l45.1701"></a><span id="l45.1701">     // If the previously tried nick is in the array and not the last</span>
<a href="#l45.1702"></a><span id="l45.1702">     // element, try the next nick in the array.</span>
<a href="#l45.1703"></a><span id="l45.1703">     let oldIndex = allNicks.indexOf(aOldNick);</span>
<a href="#l45.1704"></a><span id="l45.1704">     if (oldIndex != -1 &amp;&amp; oldIndex &lt; allNicks.length - 1) {</span>
<a href="#l45.1705"></a><span id="l45.1705">       let newNick = allNicks[oldIndex + 1];</span>
<a href="#l45.1706"></a><span id="l45.1706">       this.LOG(aOldNick + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l45.1707"></a><span id="l45.1707" class="difflineat">@@ -1435,107 +1646,117 @@ ircAccount.prototype = {</span>
<a href="#l45.1708"></a><span id="l45.1708">     // If there is not a digit at the end of the nick, just append 1.</span>
<a href="#l45.1709"></a><span id="l45.1709">     let newDigits = &quot;1&quot;;</span>
<a href="#l45.1710"></a><span id="l45.1710">     // If there is a digit at the end of the nick, increment it.</span>
<a href="#l45.1711"></a><span id="l45.1711">     if (nickParts[2]) {</span>
<a href="#l45.1712"></a><span id="l45.1712">       newDigits = (parseInt(nickParts[2], 10) + 1).toString();</span>
<a href="#l45.1713"></a><span id="l45.1713">       // If there are leading 0s, add them back on, after we've incremented (e.g.</span>
<a href="#l45.1714"></a><span id="l45.1714">       // 009 --&gt; 010).</span>
<a href="#l45.1715"></a><span id="l45.1715">       let numLeadingZeros = nickParts[2].length - newDigits.length;</span>
<a href="#l45.1716"></a><span id="l45.1716" class="difflineminus">-      if (numLeadingZeros &gt; 0)</span>
<a href="#l45.1717"></a><span id="l45.1717" class="difflineplus">+      if (numLeadingZeros &gt; 0) {</span>
<a href="#l45.1718"></a><span id="l45.1718">         newDigits = &quot;0&quot;.repeat(numLeadingZeros) + newDigits;</span>
<a href="#l45.1719"></a><span id="l45.1719" class="difflineplus">+      }</span>
<a href="#l45.1720"></a><span id="l45.1720">     }</span>
<a href="#l45.1721"></a><span id="l45.1721"> </span>
<a href="#l45.1722"></a><span id="l45.1722">     // Servers truncate nicks that are too long, compare the previously sent</span>
<a href="#l45.1723"></a><span id="l45.1723">     // nickname with the returned nickname and check for truncation.</span>
<a href="#l45.1724"></a><span id="l45.1724">     if (aOldNick.length &lt; this._sentNickname.length) {</span>
<a href="#l45.1725"></a><span id="l45.1725">       // The nick will be too long, overwrite the end of the nick instead of</span>
<a href="#l45.1726"></a><span id="l45.1726">       // appending.</span>
<a href="#l45.1727"></a><span id="l45.1727">       let maxLength = aOldNick.length;</span>
<a href="#l45.1728"></a><span id="l45.1728"> </span>
<a href="#l45.1729"></a><span id="l45.1729">       let sentNickParts = kNickPattern.exec(this._sentNickname);</span>
<a href="#l45.1730"></a><span id="l45.1730">       // Resend the same digits as last time, but overwrite part of the nick</span>
<a href="#l45.1731"></a><span id="l45.1731">       // this time.</span>
<a href="#l45.1732"></a><span id="l45.1732" class="difflineminus">-      if (nickParts[2] &amp;&amp; sentNickParts[2])</span>
<a href="#l45.1733"></a><span id="l45.1733" class="difflineplus">+      if (nickParts[2] &amp;&amp; sentNickParts[2]) {</span>
<a href="#l45.1734"></a><span id="l45.1734">         newDigits = sentNickParts[2];</span>
<a href="#l45.1735"></a><span id="l45.1735" class="difflineplus">+      }</span>
<a href="#l45.1736"></a><span id="l45.1736"> </span>
<a href="#l45.1737"></a><span id="l45.1737">       // Handle the silly case of a single letter followed by all nines.</span>
<a href="#l45.1738"></a><span id="l45.1738" class="difflineminus">-      if (newDigits.length == this.maxNicknameLength)</span>
<a href="#l45.1739"></a><span id="l45.1739" class="difflineplus">+      if (newDigits.length == this.maxNicknameLength) {</span>
<a href="#l45.1740"></a><span id="l45.1740">         newDigits = newDigits.slice(1);</span>
<a href="#l45.1741"></a><span id="l45.1741" class="difflineplus">+      }</span>
<a href="#l45.1742"></a><span id="l45.1742">       newNick = newNick.slice(0, maxLength - newDigits.length);</span>
<a href="#l45.1743"></a><span id="l45.1743">     }</span>
<a href="#l45.1744"></a><span id="l45.1744">     // Append the digits.</span>
<a href="#l45.1745"></a><span id="l45.1745">     newNick += newDigits;</span>
<a href="#l45.1746"></a><span id="l45.1746"> </span>
<a href="#l45.1747"></a><span id="l45.1747">     if (this.normalize(newNick) == this.normalize(this._nickname)) {</span>
<a href="#l45.1748"></a><span id="l45.1748">       // The nick we were about to try next is our current nick. This means</span>
<a href="#l45.1749"></a><span id="l45.1749">       // the user attempted to change to a version of the nick with a lower or</span>
<a href="#l45.1750"></a><span id="l45.1750">       // absent number suffix, and this failed.</span>
<a href="#l45.1751"></a><span id="l45.1751">       let msg = _(&quot;message.nick.fail&quot;, this._nickname);</span>
<a href="#l45.1752"></a><span id="l45.1752">       this.conversations.forEach(conversation =&gt;</span>
<a href="#l45.1753"></a><span id="l45.1753" class="difflineminus">-        conversation.writeMessage(this._nickname, msg, {system: true}));</span>
<a href="#l45.1754"></a><span id="l45.1754" class="difflineplus">+        conversation.writeMessage(this._nickname, msg, { system: true })</span>
<a href="#l45.1755"></a><span id="l45.1755" class="difflineplus">+      );</span>
<a href="#l45.1756"></a><span id="l45.1756">       return true;</span>
<a href="#l45.1757"></a><span id="l45.1757">     }</span>
<a href="#l45.1758"></a><span id="l45.1758"> </span>
<a href="#l45.1759"></a><span id="l45.1759">     this.LOG(aOldNick + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l45.1760"></a><span id="l45.1760">     this.changeNick(newNick);</span>
<a href="#l45.1761"></a><span id="l45.1761">     return true;</span>
<a href="#l45.1762"></a><span id="l45.1762">   },</span>
<a href="#l45.1763"></a><span id="l45.1763"> </span>
<a href="#l45.1764"></a><span id="l45.1764">   handlePingReply(aSource, aPongTime) {</span>
<a href="#l45.1765"></a><span id="l45.1765">     // Received PING response, display to the user.</span>
<a href="#l45.1766"></a><span id="l45.1766">     let sentTime = new Date(parseInt(aPongTime, 10));</span>
<a href="#l45.1767"></a><span id="l45.1767"> </span>
<a href="#l45.1768"></a><span id="l45.1768">     // The received timestamp is invalid.</span>
<a href="#l45.1769"></a><span id="l45.1769">     if (isNaN(sentTime)) {</span>
<a href="#l45.1770"></a><span id="l45.1770" class="difflineminus">-      this.WARN(aSource +</span>
<a href="#l45.1771"></a><span id="l45.1771" class="difflineminus">-                &quot; returned an invalid timestamp from a PING: &quot; + aPongTime);</span>
<a href="#l45.1772"></a><span id="l45.1772" class="difflineplus">+      this.WARN(</span>
<a href="#l45.1773"></a><span id="l45.1773" class="difflineplus">+        aSource + &quot; returned an invalid timestamp from a PING: &quot; + aPongTime</span>
<a href="#l45.1774"></a><span id="l45.1774" class="difflineplus">+      );</span>
<a href="#l45.1775"></a><span id="l45.1775">       return false;</span>
<a href="#l45.1776"></a><span id="l45.1776">     }</span>
<a href="#l45.1777"></a><span id="l45.1777"> </span>
<a href="#l45.1778"></a><span id="l45.1778">     // Find the delay in milliseconds.</span>
<a href="#l45.1779"></a><span id="l45.1779">     let delay = Date.now() - sentTime;</span>
<a href="#l45.1780"></a><span id="l45.1780"> </span>
<a href="#l45.1781"></a><span id="l45.1781">     // If the delay is negative or greater than 1 minute, something is</span>
<a href="#l45.1782"></a><span id="l45.1782">     // feeding us a crazy value. Don't display this to the user.</span>
<a href="#l45.1783"></a><span id="l45.1783">     if (delay &lt; 0 || 60 * 1000 &lt; delay) {</span>
<a href="#l45.1784"></a><span id="l45.1784" class="difflineminus">-      this.WARN(aSource + &quot; returned an invalid delay from a PING: &quot; +</span>
<a href="#l45.1785"></a><span id="l45.1785" class="difflineminus">-                delay);</span>
<a href="#l45.1786"></a><span id="l45.1786" class="difflineplus">+      this.WARN(aSource + &quot; returned an invalid delay from a PING: &quot; + delay);</span>
<a href="#l45.1787"></a><span id="l45.1787">       return false;</span>
<a href="#l45.1788"></a><span id="l45.1788">     }</span>
<a href="#l45.1789"></a><span id="l45.1789"> </span>
<a href="#l45.1790"></a><span id="l45.1790" class="difflineminus">-    let msg = PluralForm.get(delay, _(&quot;message.ping&quot;, aSource))</span>
<a href="#l45.1791"></a><span id="l45.1791" class="difflineminus">-                        .replace(&quot;#2&quot;, delay);</span>
<a href="#l45.1792"></a><span id="l45.1792" class="difflineminus">-    this.getConversation(aSource).writeMessage(aSource, msg, {system: true});</span>
<a href="#l45.1793"></a><span id="l45.1793" class="difflineplus">+    let msg = PluralForm.get(delay, _(&quot;message.ping&quot;, aSource)).replace(</span>
<a href="#l45.1794"></a><span id="l45.1794" class="difflineplus">+      &quot;#2&quot;,</span>
<a href="#l45.1795"></a><span id="l45.1795" class="difflineplus">+      delay</span>
<a href="#l45.1796"></a><span id="l45.1796" class="difflineplus">+    );</span>
<a href="#l45.1797"></a><span id="l45.1797" class="difflineplus">+    this.getConversation(aSource).writeMessage(aSource, msg, { system: true });</span>
<a href="#l45.1798"></a><span id="l45.1798">     return true;</span>
<a href="#l45.1799"></a><span id="l45.1799">   },</span>
<a href="#l45.1800"></a><span id="l45.1800"> </span>
<a href="#l45.1801"></a><span id="l45.1801">   countBytes(aStr) {</span>
<a href="#l45.1802"></a><span id="l45.1802">     // Assume that if it's not UTF-8 then each character is 1 byte.</span>
<a href="#l45.1803"></a><span id="l45.1803" class="difflineminus">-    if (this._encoding != &quot;UTF-8&quot;)</span>
<a href="#l45.1804"></a><span id="l45.1804" class="difflineplus">+    if (this._encoding != &quot;UTF-8&quot;) {</span>
<a href="#l45.1805"></a><span id="l45.1805">       return aStr.length;</span>
<a href="#l45.1806"></a><span id="l45.1806" class="difflineplus">+    }</span>
<a href="#l45.1807"></a><span id="l45.1807"> </span>
<a href="#l45.1808"></a><span id="l45.1808">     // Count the number of bytes in a UTF-8 encoded string.</span>
<a href="#l45.1809"></a><span id="l45.1809">     function charCodeToByteCount(c) {</span>
<a href="#l45.1810"></a><span id="l45.1810">       // UTF-8 stores:</span>
<a href="#l45.1811"></a><span id="l45.1811">       // - code points below U+0080 are 1 byte,</span>
<a href="#l45.1812"></a><span id="l45.1812">       // - code points below U+0800 are 2 bytes,</span>
<a href="#l45.1813"></a><span id="l45.1813">       // - code points U+D800 through U+DFFF are UTF-16 surrogate halves</span>
<a href="#l45.1814"></a><span id="l45.1814">       // (they indicate that JS has split a 4 bytes UTF-8 character</span>
<a href="#l45.1815"></a><span id="l45.1815">       // in two halves of 2 bytes each),</span>
<a href="#l45.1816"></a><span id="l45.1816">       // - other code points are 3 bytes.</span>
<a href="#l45.1817"></a><span id="l45.1817" class="difflineminus">-      if (c &lt; 0x80)</span>
<a href="#l45.1818"></a><span id="l45.1818" class="difflineplus">+      if (c &lt; 0x80) {</span>
<a href="#l45.1819"></a><span id="l45.1819">         return 1;</span>
<a href="#l45.1820"></a><span id="l45.1820" class="difflineminus">-      if (c &lt; 0x800 || (c &gt;= 0xD800 &amp;&amp; c &lt;= 0xDFFF))</span>
<a href="#l45.1821"></a><span id="l45.1821" class="difflineplus">+      }</span>
<a href="#l45.1822"></a><span id="l45.1822" class="difflineplus">+      if (c &lt; 0x800 || (c &gt;= 0xd800 &amp;&amp; c &lt;= 0xdfff)) {</span>
<a href="#l45.1823"></a><span id="l45.1823">         return 2;</span>
<a href="#l45.1824"></a><span id="l45.1824" class="difflineplus">+      }</span>
<a href="#l45.1825"></a><span id="l45.1825">       return 3;</span>
<a href="#l45.1826"></a><span id="l45.1826">     }</span>
<a href="#l45.1827"></a><span id="l45.1827">     let bytes = 0;</span>
<a href="#l45.1828"></a><span id="l45.1828" class="difflineminus">-    for (let i = 0; i &lt; aStr.length; i++)</span>
<a href="#l45.1829"></a><span id="l45.1829" class="difflineplus">+    for (let i = 0; i &lt; aStr.length; i++) {</span>
<a href="#l45.1830"></a><span id="l45.1830">       bytes += charCodeToByteCount(aStr.charCodeAt(i));</span>
<a href="#l45.1831"></a><span id="l45.1831" class="difflineplus">+    }</span>
<a href="#l45.1832"></a><span id="l45.1832">     return bytes;</span>
<a href="#l45.1833"></a><span id="l45.1833">   },</span>
<a href="#l45.1834"></a><span id="l45.1834"> </span>
<a href="#l45.1835"></a><span id="l45.1835">   // To check if users are online, we need to queue multiple messages.</span>
<a href="#l45.1836"></a><span id="l45.1836">   // An internal queue of all nicks that we wish to know the status of.</span>
<a href="#l45.1837"></a><span id="l45.1837">   trackQueue: [],</span>
<a href="#l45.1838"></a><span id="l45.1838">   // The nicks that were last sent to the server that we're waiting for a</span>
<a href="#l45.1839"></a><span id="l45.1839">   // response about.</span>
<a href="#l45.1840"></a><span id="l45.1840" class="difflineat">@@ -1561,27 +1782,31 @@ ircAccount.prototype = {</span>
<a href="#l45.1841"></a><span id="l45.1841">       // message length.</span>
<a href="#l45.1842"></a><span id="l45.1842">       this.pendingIsOnQueue = [this.trackQueue.shift()];</span>
<a href="#l45.1843"></a><span id="l45.1843"> </span>
<a href="#l45.1844"></a><span id="l45.1844">       // Attempt to maximize the characters used in each message, this may mean</span>
<a href="#l45.1845"></a><span id="l45.1845">       // that a specific user gets sent very often since they have a short name!</span>
<a href="#l45.1846"></a><span id="l45.1846">       let buddiesLength = this.countBytes(this.pendingIsOnQueue[0]);</span>
<a href="#l45.1847"></a><span id="l45.1847">       for (let i = 0; i &lt; this.trackQueue.length; ++i) {</span>
<a href="#l45.1848"></a><span id="l45.1848">         // If we can fit the nick, add it to the current buffer.</span>
<a href="#l45.1849"></a><span id="l45.1849" class="difflineminus">-        if ((buddiesLength + this.countBytes(this.trackQueue[i])) &lt; this._isOnLength) {</span>
<a href="#l45.1850"></a><span id="l45.1850" class="difflineplus">+        if (</span>
<a href="#l45.1851"></a><span id="l45.1851" class="difflineplus">+          buddiesLength + this.countBytes(this.trackQueue[i]) &lt;</span>
<a href="#l45.1852"></a><span id="l45.1852" class="difflineplus">+          this._isOnLength</span>
<a href="#l45.1853"></a><span id="l45.1853" class="difflineplus">+        ) {</span>
<a href="#l45.1854"></a><span id="l45.1854">           // Remove the name from the list and add it to the pending queue.</span>
<a href="#l45.1855"></a><span id="l45.1855">           let nick = this.trackQueue.splice(i--, 1)[0];</span>
<a href="#l45.1856"></a><span id="l45.1856">           this.pendingIsOnQueue.push(nick);</span>
<a href="#l45.1857"></a><span id="l45.1857"> </span>
<a href="#l45.1858"></a><span id="l45.1858">           // Keep track of the length of the string, the + 1 is for the spaces.</span>
<a href="#l45.1859"></a><span id="l45.1859">           buddiesLength += this.countBytes(nick) + 1;</span>
<a href="#l45.1860"></a><span id="l45.1860"> </span>
<a href="#l45.1861"></a><span id="l45.1861">           // If we've filled up the message, stop looking for more nicks.</span>
<a href="#l45.1862"></a><span id="l45.1862" class="difflineminus">-          if (buddiesLength &gt;= this._isOnLength)</span>
<a href="#l45.1863"></a><span id="l45.1863" class="difflineplus">+          if (buddiesLength &gt;= this._isOnLength) {</span>
<a href="#l45.1864"></a><span id="l45.1864">             break;</span>
<a href="#l45.1865"></a><span id="l45.1865" class="difflineplus">+          }</span>
<a href="#l45.1866"></a><span id="l45.1866">         }</span>
<a href="#l45.1867"></a><span id="l45.1867">       }</span>
<a href="#l45.1868"></a><span id="l45.1868"> </span>
<a href="#l45.1869"></a><span id="l45.1869">       // Send the message.</span>
<a href="#l45.1870"></a><span id="l45.1870">       this.sendMessage(&quot;ISON&quot;, this.pendingIsOnQueue.join(&quot; &quot;));</span>
<a href="#l45.1871"></a><span id="l45.1871"> </span>
<a href="#l45.1872"></a><span id="l45.1872">       // Append the pending nicks so trackQueue contains all the nicks.</span>
<a href="#l45.1873"></a><span id="l45.1873">       this.trackQueue = this.trackQueue.concat(this.pendingIsOnQueue);</span>
<a href="#l45.1874"></a><span id="l45.1874" class="difflineat">@@ -1597,18 +1822,19 @@ ircAccount.prototype = {</span>
<a href="#l45.1875"></a><span id="l45.1875">   _motd: null,</span>
<a href="#l45.1876"></a><span id="l45.1876">   _motdTimer: null,</span>
<a href="#l45.1877"></a><span id="l45.1877"> </span>
<a href="#l45.1878"></a><span id="l45.1878">   connect() {</span>
<a href="#l45.1879"></a><span id="l45.1879">     this.reportConnecting();</span>
<a href="#l45.1880"></a><span id="l45.1880"> </span>
<a href="#l45.1881"></a><span id="l45.1881">     // Mark existing MUCs as joining if they will be rejoined.</span>
<a href="#l45.1882"></a><span id="l45.1882">     this.conversations.forEach(conversation =&gt; {</span>
<a href="#l45.1883"></a><span id="l45.1883" class="difflineminus">-      if (conversation.isChat &amp;&amp; conversation.chatRoomFields)</span>
<a href="#l45.1884"></a><span id="l45.1884" class="difflineplus">+      if (conversation.isChat &amp;&amp; conversation.chatRoomFields) {</span>
<a href="#l45.1885"></a><span id="l45.1885">         conversation.joining = true;</span>
<a href="#l45.1886"></a><span id="l45.1886" class="difflineplus">+      }</span>
<a href="#l45.1887"></a><span id="l45.1887">     });</span>
<a href="#l45.1888"></a><span id="l45.1888"> </span>
<a href="#l45.1889"></a><span id="l45.1889">     // Load preferences.</span>
<a href="#l45.1890"></a><span id="l45.1890">     this._port = this.getInt(&quot;port&quot;);</span>
<a href="#l45.1891"></a><span id="l45.1891">     this._ssl = this.getBool(&quot;ssl&quot;);</span>
<a href="#l45.1892"></a><span id="l45.1892"> </span>
<a href="#l45.1893"></a><span id="l45.1893">     // Use the display name as the user's real name.</span>
<a href="#l45.1894"></a><span id="l45.1894">     this._realname = this.imAccount.statusInfo.displayName;</span>
<a href="#l45.1895"></a><span id="l45.1895" class="difflineat">@@ -1631,45 +1857,51 @@ ircAccount.prototype = {</span>
<a href="#l45.1896"></a><span id="l45.1896">       this.ERROR(&quot;Trying to add CAP &quot; + aCAP + &quot; after connection.&quot;);</span>
<a href="#l45.1897"></a><span id="l45.1897">       return;</span>
<a href="#l45.1898"></a><span id="l45.1898">     }</span>
<a href="#l45.1899"></a><span id="l45.1899"> </span>
<a href="#l45.1900"></a><span id="l45.1900">     this._caps.add(aCAP);</span>
<a href="#l45.1901"></a><span id="l45.1901">   },</span>
<a href="#l45.1902"></a><span id="l45.1902">   removeCAP(aDoneCAP) {</span>
<a href="#l45.1903"></a><span id="l45.1903">     if (!this._caps.has(aDoneCAP)) {</span>
<a href="#l45.1904"></a><span id="l45.1904" class="difflineminus">-      this.ERROR(&quot;Trying to remove a CAP (&quot; + aDoneCAP + &quot;) which isn't added.&quot;);</span>
<a href="#l45.1905"></a><span id="l45.1905" class="difflineplus">+      this.ERROR(</span>
<a href="#l45.1906"></a><span id="l45.1906" class="difflineplus">+        &quot;Trying to remove a CAP (&quot; + aDoneCAP + &quot;) which isn't added.&quot;</span>
<a href="#l45.1907"></a><span id="l45.1907" class="difflineplus">+      );</span>
<a href="#l45.1908"></a><span id="l45.1908">       return;</span>
<a href="#l45.1909"></a><span id="l45.1909">     }</span>
<a href="#l45.1910"></a><span id="l45.1910">     if (this.connected) {</span>
<a href="#l45.1911"></a><span id="l45.1911">       this.ERROR(&quot;Trying to remove CAP &quot; + aDoneCAP + &quot; after connection.&quot;);</span>
<a href="#l45.1912"></a><span id="l45.1912">       return;</span>
<a href="#l45.1913"></a><span id="l45.1913">     }</span>
<a href="#l45.1914"></a><span id="l45.1914"> </span>
<a href="#l45.1915"></a><span id="l45.1915">     // Remove any reference to the given capability.</span>
<a href="#l45.1916"></a><span id="l45.1916">     this._caps.delete(aDoneCAP);</span>
<a href="#l45.1917"></a><span id="l45.1917"> </span>
<a href="#l45.1918"></a><span id="l45.1918">     // If no more CAP messages are being handled, notify the server.</span>
<a href="#l45.1919"></a><span id="l45.1919" class="difflineminus">-    if (!this._caps.size)</span>
<a href="#l45.1920"></a><span id="l45.1920" class="difflineplus">+    if (!this._caps.size) {</span>
<a href="#l45.1921"></a><span id="l45.1921">       this.sendMessage(&quot;CAP&quot;, &quot;END&quot;);</span>
<a href="#l45.1922"></a><span id="l45.1922" class="difflineplus">+    }</span>
<a href="#l45.1923"></a><span id="l45.1923">   },</span>
<a href="#l45.1924"></a><span id="l45.1924"> </span>
<a href="#l45.1925"></a><span id="l45.1925">   // Used to wait for a response from the server.</span>
<a href="#l45.1926"></a><span id="l45.1926">   _quitTimer: null,</span>
<a href="#l45.1927"></a><span id="l45.1927">   // RFC 2812 Section 3.1.7.</span>
<a href="#l45.1928"></a><span id="l45.1928">   quit(aMessage) {</span>
<a href="#l45.1929"></a><span id="l45.1929">     this._reportDisconnecting(Ci.prplIAccount.NO_ERROR);</span>
<a href="#l45.1930"></a><span id="l45.1930" class="difflineminus">-    this.sendMessage(&quot;QUIT&quot;,</span>
<a href="#l45.1931"></a><span id="l45.1931" class="difflineminus">-                     aMessage || this.getString(&quot;quitmsg&quot;) || undefined);</span>
<a href="#l45.1932"></a><span id="l45.1932" class="difflineplus">+    this.sendMessage(</span>
<a href="#l45.1933"></a><span id="l45.1933" class="difflineplus">+      &quot;QUIT&quot;,</span>
<a href="#l45.1934"></a><span id="l45.1934" class="difflineplus">+      aMessage || this.getString(&quot;quitmsg&quot;) || undefined</span>
<a href="#l45.1935"></a><span id="l45.1935" class="difflineplus">+    );</span>
<a href="#l45.1936"></a><span id="l45.1936">   },</span>
<a href="#l45.1937"></a><span id="l45.1937">   // When the user clicks &quot;Disconnect&quot; in account manager, or uses /quit.</span>
<a href="#l45.1938"></a><span id="l45.1938">   // aMessage is an optional parameter containing the quit message.</span>
<a href="#l45.1939"></a><span id="l45.1939">   disconnect(aMessage) {</span>
<a href="#l45.1940"></a><span id="l45.1940" class="difflineminus">-    if (this.disconnected || this.disconnecting)</span>
<a href="#l45.1941"></a><span id="l45.1941" class="difflineplus">+    if (this.disconnected || this.disconnecting) {</span>
<a href="#l45.1942"></a><span id="l45.1942">       return;</span>
<a href="#l45.1943"></a><span id="l45.1943" class="difflineplus">+    }</span>
<a href="#l45.1944"></a><span id="l45.1944"> </span>
<a href="#l45.1945"></a><span id="l45.1945">     // If there's no socket, disconnect immediately to avoid waiting 2 seconds.</span>
<a href="#l45.1946"></a><span id="l45.1946">     if (!this._socket || this._socket.disconnected) {</span>
<a href="#l45.1947"></a><span id="l45.1947">       this.gotDisconnected();</span>
<a href="#l45.1948"></a><span id="l45.1948">       return;</span>
<a href="#l45.1949"></a><span id="l45.1949">     }</span>
<a href="#l45.1950"></a><span id="l45.1950"> </span>
<a href="#l45.1951"></a><span id="l45.1951">     // Let the server know we're going to disconnect.</span>
<a href="#l45.1952"></a><span id="l45.1952" class="difflineat">@@ -1679,41 +1911,46 @@ ircAccount.prototype = {</span>
<a href="#l45.1953"></a><span id="l45.1953">     this._requestedNickname = this._accountNickname;</span>
<a href="#l45.1954"></a><span id="l45.1954"> </span>
<a href="#l45.1955"></a><span id="l45.1955">     // Give the server 2 seconds to respond, otherwise just forcefully</span>
<a href="#l45.1956"></a><span id="l45.1956">     // disconnect the socket. This will be cancelled if a response is heard from</span>
<a href="#l45.1957"></a><span id="l45.1957">     // the server.</span>
<a href="#l45.1958"></a><span id="l45.1958">     this._quitTimer = setTimeout(this.gotDisconnected.bind(this), 2 * 1000);</span>
<a href="#l45.1959"></a><span id="l45.1959">   },</span>
<a href="#l45.1960"></a><span id="l45.1960"> </span>
<a href="#l45.1961"></a><span id="l45.1961" class="difflineminus">-  createConversation(aName) { return this.getConversation(aName); },</span>
<a href="#l45.1962"></a><span id="l45.1962" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l45.1963"></a><span id="l45.1963" class="difflineplus">+    return this.getConversation(aName);</span>
<a href="#l45.1964"></a><span id="l45.1964" class="difflineplus">+  },</span>
<a href="#l45.1965"></a><span id="l45.1965"> </span>
<a href="#l45.1966"></a><span id="l45.1966">   // aComponents implements prplIChatRoomFieldValues.</span>
<a href="#l45.1967"></a><span id="l45.1967">   joinChat(aComponents) {</span>
<a href="#l45.1968"></a><span id="l45.1968">     let channel = aComponents.getValue(&quot;channel&quot;);</span>
<a href="#l45.1969"></a><span id="l45.1969">     // Mildly sanitize input.</span>
<a href="#l45.1970"></a><span id="l45.1970" class="difflineminus">-    channel = channel.trimLeft().split(&quot;,&quot;)[0].split(&quot; &quot;)[0];</span>
<a href="#l45.1971"></a><span id="l45.1971" class="difflineplus">+    channel = channel</span>
<a href="#l45.1972"></a><span id="l45.1972" class="difflineplus">+      .trimLeft()</span>
<a href="#l45.1973"></a><span id="l45.1973" class="difflineplus">+      .split(&quot;,&quot;)[0]</span>
<a href="#l45.1974"></a><span id="l45.1974" class="difflineplus">+      .split(&quot; &quot;)[0];</span>
<a href="#l45.1975"></a><span id="l45.1975">     if (!channel) {</span>
<a href="#l45.1976"></a><span id="l45.1976">       this.ERROR(&quot;joinChat called without a valid channel name.&quot;);</span>
<a href="#l45.1977"></a><span id="l45.1977">       return null;</span>
<a href="#l45.1978"></a><span id="l45.1978">     }</span>
<a href="#l45.1979"></a><span id="l45.1979"> </span>
<a href="#l45.1980"></a><span id="l45.1980">     // A channel prefix is required. If the user didn't include one,</span>
<a href="#l45.1981"></a><span id="l45.1981">     // we prepend # automatically to match the behavior of other</span>
<a href="#l45.1982"></a><span id="l45.1982">     // clients. Not doing it used to cause user confusion.</span>
<a href="#l45.1983"></a><span id="l45.1983" class="difflineminus">-    if (!this.channelPrefixes.includes(channel[0]))</span>
<a href="#l45.1984"></a><span id="l45.1984" class="difflineplus">+    if (!this.channelPrefixes.includes(channel[0])) {</span>
<a href="#l45.1985"></a><span id="l45.1985">       channel = &quot;#&quot; + channel;</span>
<a href="#l45.1986"></a><span id="l45.1986" class="difflineplus">+    }</span>
<a href="#l45.1987"></a><span id="l45.1987"> </span>
<a href="#l45.1988"></a><span id="l45.1988">     if (this.conversations.has(channel)) {</span>
<a href="#l45.1989"></a><span id="l45.1989">       let conv = this.getConversation(channel);</span>
<a href="#l45.1990"></a><span id="l45.1990">       if (!conv.left) {</span>
<a href="#l45.1991"></a><span id="l45.1991">         // No need to join a channel we are already in.</span>
<a href="#l45.1992"></a><span id="l45.1992">         return conv;</span>
<a href="#l45.1993"></a><span id="l45.1993" class="difflineminus">-      }</span>
<a href="#l45.1994"></a><span id="l45.1994" class="difflineminus">-      else if (!conv.chatRoomFields) {</span>
<a href="#l45.1995"></a><span id="l45.1995" class="difflineplus">+      } else if (!conv.chatRoomFields) {</span>
<a href="#l45.1996"></a><span id="l45.1996">         // We are rejoining a channel that was parted by the user.</span>
<a href="#l45.1997"></a><span id="l45.1997">         conv._rejoined = true;</span>
<a href="#l45.1998"></a><span id="l45.1998">       }</span>
<a href="#l45.1999"></a><span id="l45.1999">     }</span>
<a href="#l45.2000"></a><span id="l45.2000"> </span>
<a href="#l45.2001"></a><span id="l45.2001">     let key = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l45.2002"></a><span id="l45.2002">     this.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l45.2003"></a><span id="l45.2003"> </span>
<a href="#l45.2004"></a><span id="l45.2004" class="difflineat">@@ -1724,47 +1961,62 @@ ircAccount.prototype = {</span>
<a href="#l45.2005"></a><span id="l45.2005">     // Store the prplIChatRoomFieldValues to enable later reconnections.</span>
<a href="#l45.2006"></a><span id="l45.2006">     let defaultName = key ? channel + &quot; &quot; + key : channel;</span>
<a href="#l45.2007"></a><span id="l45.2007">     conv.chatRoomFields = this.getChatRoomDefaultFieldValues(defaultName);</span>
<a href="#l45.2008"></a><span id="l45.2008"> </span>
<a href="#l45.2009"></a><span id="l45.2009">     return conv;</span>
<a href="#l45.2010"></a><span id="l45.2010">   },</span>
<a href="#l45.2011"></a><span id="l45.2011"> </span>
<a href="#l45.2012"></a><span id="l45.2012">   chatRoomFields: {</span>
<a href="#l45.2013"></a><span id="l45.2013" class="difflineminus">-    &quot;channel&quot;: {get label() { return _(&quot;joinChat.channel&quot;); }, required: true},</span>
<a href="#l45.2014"></a><span id="l45.2014" class="difflineminus">-    &quot;password&quot;: {get label() { return _(&quot;joinChat.password&quot;); }, isPassword: true},</span>
<a href="#l45.2015"></a><span id="l45.2015" class="difflineplus">+    channel: {</span>
<a href="#l45.2016"></a><span id="l45.2016" class="difflineplus">+      get label() {</span>
<a href="#l45.2017"></a><span id="l45.2017" class="difflineplus">+        return _(&quot;joinChat.channel&quot;);</span>
<a href="#l45.2018"></a><span id="l45.2018" class="difflineplus">+      },</span>
<a href="#l45.2019"></a><span id="l45.2019" class="difflineplus">+      required: true,</span>
<a href="#l45.2020"></a><span id="l45.2020" class="difflineplus">+    },</span>
<a href="#l45.2021"></a><span id="l45.2021" class="difflineplus">+    password: {</span>
<a href="#l45.2022"></a><span id="l45.2022" class="difflineplus">+      get label() {</span>
<a href="#l45.2023"></a><span id="l45.2023" class="difflineplus">+        return _(&quot;joinChat.password&quot;);</span>
<a href="#l45.2024"></a><span id="l45.2024" class="difflineplus">+      },</span>
<a href="#l45.2025"></a><span id="l45.2025" class="difflineplus">+      isPassword: true,</span>
<a href="#l45.2026"></a><span id="l45.2026" class="difflineplus">+    },</span>
<a href="#l45.2027"></a><span id="l45.2027">   },</span>
<a href="#l45.2028"></a><span id="l45.2028"> </span>
<a href="#l45.2029"></a><span id="l45.2029">   parseDefaultChatName(aDefaultName) {</span>
<a href="#l45.2030"></a><span id="l45.2030">     let params = aDefaultName.trim().split(/\s+/);</span>
<a href="#l45.2031"></a><span id="l45.2031" class="difflineminus">-    let chatFields = {channel: params[0]};</span>
<a href="#l45.2032"></a><span id="l45.2032" class="difflineminus">-    if (params.length &gt; 1)</span>
<a href="#l45.2033"></a><span id="l45.2033" class="difflineplus">+    let chatFields = { channel: params[0] };</span>
<a href="#l45.2034"></a><span id="l45.2034" class="difflineplus">+    if (params.length &gt; 1) {</span>
<a href="#l45.2035"></a><span id="l45.2035">       chatFields.password = params[1];</span>
<a href="#l45.2036"></a><span id="l45.2036" class="difflineplus">+    }</span>
<a href="#l45.2037"></a><span id="l45.2037">     return chatFields;</span>
<a href="#l45.2038"></a><span id="l45.2038">   },</span>
<a href="#l45.2039"></a><span id="l45.2039"> </span>
<a href="#l45.2040"></a><span id="l45.2040">   // Attributes</span>
<a href="#l45.2041"></a><span id="l45.2041" class="difflineminus">-  get canJoinChat() { return true; },</span>
<a href="#l45.2042"></a><span id="l45.2042" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l45.2043"></a><span id="l45.2043" class="difflineplus">+    return true;</span>
<a href="#l45.2044"></a><span id="l45.2044" class="difflineplus">+  },</span>
<a href="#l45.2045"></a><span id="l45.2045"> </span>
<a href="#l45.2046"></a><span id="l45.2046">   // Returns a conversation (creates it if it doesn't exist)</span>
<a href="#l45.2047"></a><span id="l45.2047">   getConversation(aName) {</span>
<a href="#l45.2048"></a><span id="l45.2048">     if (!this.conversations.has(aName)) {</span>
<a href="#l45.2049"></a><span id="l45.2049">       // If the whois information has been received, we have the proper nick</span>
<a href="#l45.2050"></a><span id="l45.2050">       // capitalization.</span>
<a href="#l45.2051"></a><span id="l45.2051" class="difflineminus">-      if (this.whoisInformation.has(aName))</span>
<a href="#l45.2052"></a><span id="l45.2052" class="difflineplus">+      if (this.whoisInformation.has(aName)) {</span>
<a href="#l45.2053"></a><span id="l45.2053">         aName = this.whoisInformation.get(aName).nick;</span>
<a href="#l45.2054"></a><span id="l45.2054" class="difflineplus">+      }</span>
<a href="#l45.2055"></a><span id="l45.2055">       let convClass = this.isMUCName(aName) ? ircChannel : ircConversation;</span>
<a href="#l45.2056"></a><span id="l45.2056">       this.conversations.set(aName, new convClass(this, aName, this._nickname));</span>
<a href="#l45.2057"></a><span id="l45.2057">     }</span>
<a href="#l45.2058"></a><span id="l45.2058">     return this.conversations.get(aName);</span>
<a href="#l45.2059"></a><span id="l45.2059">   },</span>
<a href="#l45.2060"></a><span id="l45.2060"> </span>
<a href="#l45.2061"></a><span id="l45.2061">   removeConversation(aConversationName) {</span>
<a href="#l45.2062"></a><span id="l45.2062" class="difflineminus">-    if (this.conversations.has(aConversationName))</span>
<a href="#l45.2063"></a><span id="l45.2063" class="difflineplus">+    if (this.conversations.has(aConversationName)) {</span>
<a href="#l45.2064"></a><span id="l45.2064">       this.conversations.delete(aConversationName);</span>
<a href="#l45.2065"></a><span id="l45.2065" class="difflineplus">+    }</span>
<a href="#l45.2066"></a><span id="l45.2066">   },</span>
<a href="#l45.2067"></a><span id="l45.2067"> </span>
<a href="#l45.2068"></a><span id="l45.2068">   // This builds the message string that will be sent to the server.</span>
<a href="#l45.2069"></a><span id="l45.2069">   buildMessage(aCommand, aParams = []) {</span>
<a href="#l45.2070"></a><span id="l45.2070">     if (!aCommand) {</span>
<a href="#l45.2071"></a><span id="l45.2071">       this.ERROR(&quot;IRC messages must have a command.&quot;);</span>
<a href="#l45.2072"></a><span id="l45.2072">       return null;</span>
<a href="#l45.2073"></a><span id="l45.2073">     }</span>
<a href="#l45.2074"></a><span id="l45.2074" class="difflineat">@@ -1785,137 +2037,178 @@ ircAccount.prototype = {</span>
<a href="#l45.2075"></a><span id="l45.2075">         return null;</span>
<a href="#l45.2076"></a><span id="l45.2076">       }</span>
<a href="#l45.2077"></a><span id="l45.2077">       // Join the parameters with spaces. There are three cases in which the</span>
<a href="#l45.2078"></a><span id="l45.2078">       // last parameter (&quot;trailing&quot; in RFC 2812) must be prepended with a colon:</span>
<a href="#l45.2079"></a><span id="l45.2079">       //  1. If the last parameter contains a space.</span>
<a href="#l45.2080"></a><span id="l45.2080">       //  2. If the first character of the last parameter is a colon.</span>
<a href="#l45.2081"></a><span id="l45.2081">       //  3. If the last parameter is an empty string.</span>
<a href="#l45.2082"></a><span id="l45.2082">       let trailing = params.slice(-1)[0];</span>
<a href="#l45.2083"></a><span id="l45.2083" class="difflineminus">-      if (!trailing.length || trailing.includes(&quot; &quot;) || trailing.startsWith(&quot;:&quot;))</span>
<a href="#l45.2084"></a><span id="l45.2084" class="difflineplus">+      if (</span>
<a href="#l45.2085"></a><span id="l45.2085" class="difflineplus">+        !trailing.length ||</span>
<a href="#l45.2086"></a><span id="l45.2086" class="difflineplus">+        trailing.includes(&quot; &quot;) ||</span>
<a href="#l45.2087"></a><span id="l45.2087" class="difflineplus">+        trailing.startsWith(&quot;:&quot;)</span>
<a href="#l45.2088"></a><span id="l45.2088" class="difflineplus">+      ) {</span>
<a href="#l45.2089"></a><span id="l45.2089">         params.push(&quot;:&quot; + params.pop());</span>
<a href="#l45.2090"></a><span id="l45.2090" class="difflineplus">+      }</span>
<a href="#l45.2091"></a><span id="l45.2091">       message += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l45.2092"></a><span id="l45.2092">     }</span>
<a href="#l45.2093"></a><span id="l45.2093"> </span>
<a href="#l45.2094"></a><span id="l45.2094">     return message;</span>
<a href="#l45.2095"></a><span id="l45.2095">   },</span>
<a href="#l45.2096"></a><span id="l45.2096"> </span>
<a href="#l45.2097"></a><span id="l45.2097">   // Shortcut method to build &amp; send a message at once. Use aLoggedData to log</span>
<a href="#l45.2098"></a><span id="l45.2098">   // something different than what is actually sent.</span>
<a href="#l45.2099"></a><span id="l45.2099">   // Returns false if the message could not be sent.</span>
<a href="#l45.2100"></a><span id="l45.2100">   sendMessage(aCommand, aParams, aLoggedData) {</span>
<a href="#l45.2101"></a><span id="l45.2101" class="difflineminus">-    return this.sendRawMessage(this.buildMessage(aCommand, aParams), aLoggedData);</span>
<a href="#l45.2102"></a><span id="l45.2102" class="difflineplus">+    return this.sendRawMessage(</span>
<a href="#l45.2103"></a><span id="l45.2103" class="difflineplus">+      this.buildMessage(aCommand, aParams),</span>
<a href="#l45.2104"></a><span id="l45.2104" class="difflineplus">+      aLoggedData</span>
<a href="#l45.2105"></a><span id="l45.2105" class="difflineplus">+    );</span>
<a href="#l45.2106"></a><span id="l45.2106">   },</span>
<a href="#l45.2107"></a><span id="l45.2107"> </span>
<a href="#l45.2108"></a><span id="l45.2108">   // This sends a message over the socket and catches any errors. Use</span>
<a href="#l45.2109"></a><span id="l45.2109">   // aLoggedData to log something different than what is actually sent.</span>
<a href="#l45.2110"></a><span id="l45.2110">   // Returns false if the message could not be sent.</span>
<a href="#l45.2111"></a><span id="l45.2111">   sendRawMessage(aMessage, aLoggedData) {</span>
<a href="#l45.2112"></a><span id="l45.2112">     // Low level quoting, replace \0, \n, \r or \020 with \0200, \020n, \020r or</span>
<a href="#l45.2113"></a><span id="l45.2113">     // \020\020, respectively.</span>
<a href="#l45.2114"></a><span id="l45.2114" class="difflineminus">-    const lowQuote = {&quot;\0&quot;: &quot;0&quot;, &quot;\n&quot;: &quot;n&quot;, &quot;\r&quot;: &quot;r&quot;, &quot;\x10&quot;: &quot;\x10&quot;};</span>
<a href="#l45.2115"></a><span id="l45.2115" class="difflineminus">-    const lowRegex = new RegExp(&quot;[&quot; + Object.keys(lowQuote).join(&quot;&quot;) + &quot;]&quot;, &quot;g&quot;);</span>
<a href="#l45.2116"></a><span id="l45.2116" class="difflineplus">+    const lowQuote = { &quot;\0&quot;: &quot;0&quot;, &quot;\n&quot;: &quot;n&quot;, &quot;\r&quot;: &quot;r&quot;, &quot;\x10&quot;: &quot;\x10&quot; };</span>
<a href="#l45.2117"></a><span id="l45.2117" class="difflineplus">+    const lowRegex = new RegExp(</span>
<a href="#l45.2118"></a><span id="l45.2118" class="difflineplus">+      &quot;[&quot; + Object.keys(lowQuote).join(&quot;&quot;) + &quot;]&quot;,</span>
<a href="#l45.2119"></a><span id="l45.2119" class="difflineplus">+      &quot;g&quot;</span>
<a href="#l45.2120"></a><span id="l45.2120" class="difflineplus">+    );</span>
<a href="#l45.2121"></a><span id="l45.2121">     aMessage = aMessage.replace(lowRegex, aChar =&gt; &quot;\x10&quot; + lowQuote[aChar]);</span>
<a href="#l45.2122"></a><span id="l45.2122"> </span>
<a href="#l45.2123"></a><span id="l45.2123">     if (!this._socket || this._socket.disconnected) {</span>
<a href="#l45.2124"></a><span id="l45.2124" class="difflineminus">-      this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.2125"></a><span id="l45.2125" class="difflineminus">-                           _(&quot;connection.error.lost&quot;));</span>
<a href="#l45.2126"></a><span id="l45.2126" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l45.2127"></a><span id="l45.2127" class="difflineplus">+        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.2128"></a><span id="l45.2128" class="difflineplus">+        _(&quot;connection.error.lost&quot;)</span>
<a href="#l45.2129"></a><span id="l45.2129" class="difflineplus">+      );</span>
<a href="#l45.2130"></a><span id="l45.2130">     }</span>
<a href="#l45.2131"></a><span id="l45.2131"> </span>
<a href="#l45.2132"></a><span id="l45.2132">     let length = this.countBytes(aMessage) + 2;</span>
<a href="#l45.2133"></a><span id="l45.2133">     if (length &gt; this.maxMessageLength) {</span>
<a href="#l45.2134"></a><span id="l45.2134">       // Log if the message is too long, but try to send it anyway.</span>
<a href="#l45.2135"></a><span id="l45.2135" class="difflineminus">-      this.WARN(&quot;Message length too long (&quot; + length + &quot; &gt; &quot; +</span>
<a href="#l45.2136"></a><span id="l45.2136" class="difflineminus">-                this.maxMessageLength + &quot;\n&quot; + aMessage);</span>
<a href="#l45.2137"></a><span id="l45.2137" class="difflineplus">+      this.WARN(</span>
<a href="#l45.2138"></a><span id="l45.2138" class="difflineplus">+        &quot;Message length too long (&quot; +</span>
<a href="#l45.2139"></a><span id="l45.2139" class="difflineplus">+          length +</span>
<a href="#l45.2140"></a><span id="l45.2140" class="difflineplus">+          &quot; &gt; &quot; +</span>
<a href="#l45.2141"></a><span id="l45.2141" class="difflineplus">+          this.maxMessageLength +</span>
<a href="#l45.2142"></a><span id="l45.2142" class="difflineplus">+          &quot;\n&quot; +</span>
<a href="#l45.2143"></a><span id="l45.2143" class="difflineplus">+          aMessage</span>
<a href="#l45.2144"></a><span id="l45.2144" class="difflineplus">+      );</span>
<a href="#l45.2145"></a><span id="l45.2145">     }</span>
<a href="#l45.2146"></a><span id="l45.2146"> </span>
<a href="#l45.2147"></a><span id="l45.2147">     aMessage += &quot;\r\n&quot;;</span>
<a href="#l45.2148"></a><span id="l45.2148"> </span>
<a href="#l45.2149"></a><span id="l45.2149">     try {</span>
<a href="#l45.2150"></a><span id="l45.2150">       this._socket.sendString(aMessage, this._encoding, aLoggedData);</span>
<a href="#l45.2151"></a><span id="l45.2151">       return true;</span>
<a href="#l45.2152"></a><span id="l45.2152">     } catch (e) {</span>
<a href="#l45.2153"></a><span id="l45.2153">       try {</span>
<a href="#l45.2154"></a><span id="l45.2154">         this._socket.sendData(aMessage, aLoggedData);</span>
<a href="#l45.2155"></a><span id="l45.2155" class="difflineminus">-        this.WARN(&quot;Failed to convert &quot; + aMessage + &quot; from Unicode to &quot; +</span>
<a href="#l45.2156"></a><span id="l45.2156" class="difflineminus">-                  this._encoding + &quot;.&quot;);</span>
<a href="#l45.2157"></a><span id="l45.2157" class="difflineplus">+        this.WARN(</span>
<a href="#l45.2158"></a><span id="l45.2158" class="difflineplus">+          &quot;Failed to convert &quot; +</span>
<a href="#l45.2159"></a><span id="l45.2159" class="difflineplus">+            aMessage +</span>
<a href="#l45.2160"></a><span id="l45.2160" class="difflineplus">+            &quot; from Unicode to &quot; +</span>
<a href="#l45.2161"></a><span id="l45.2161" class="difflineplus">+            this._encoding +</span>
<a href="#l45.2162"></a><span id="l45.2162" class="difflineplus">+            &quot;.&quot;</span>
<a href="#l45.2163"></a><span id="l45.2163" class="difflineplus">+        );</span>
<a href="#l45.2164"></a><span id="l45.2164">         return true;</span>
<a href="#l45.2165"></a><span id="l45.2165">       } catch (e) {</span>
<a href="#l45.2166"></a><span id="l45.2166">         this.ERROR(&quot;Socket error:&quot;, e);</span>
<a href="#l45.2167"></a><span id="l45.2167" class="difflineminus">-        this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.2168"></a><span id="l45.2168" class="difflineminus">-                             _(&quot;connection.error.lost&quot;));</span>
<a href="#l45.2169"></a><span id="l45.2169" class="difflineplus">+        this.gotDisconnected(</span>
<a href="#l45.2170"></a><span id="l45.2170" class="difflineplus">+          Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l45.2171"></a><span id="l45.2171" class="difflineplus">+          _(&quot;connection.error.lost&quot;)</span>
<a href="#l45.2172"></a><span id="l45.2172" class="difflineplus">+        );</span>
<a href="#l45.2173"></a><span id="l45.2173">         return false;</span>
<a href="#l45.2174"></a><span id="l45.2174">       }</span>
<a href="#l45.2175"></a><span id="l45.2175">     }</span>
<a href="#l45.2176"></a><span id="l45.2176">   },</span>
<a href="#l45.2177"></a><span id="l45.2177"> </span>
<a href="#l45.2178"></a><span id="l45.2178">   // CTCP messages are \001&lt;COMMAND&gt; [&lt;parameters&gt;]*\001.</span>
<a href="#l45.2179"></a><span id="l45.2179">   // Returns false if the message could not be sent.</span>
<a href="#l45.2180"></a><span id="l45.2180">   sendCTCPMessage(aTarget, aIsNotice, aCtcpCommand, aParams = []) {</span>
<a href="#l45.2181"></a><span id="l45.2181">     // Combine the CTCP command and parameters into the single IRC param.</span>
<a href="#l45.2182"></a><span id="l45.2182">     let ircParam = aCtcpCommand;</span>
<a href="#l45.2183"></a><span id="l45.2183">     // If aParams is not an array, consider it to be a single parameter and put</span>
<a href="#l45.2184"></a><span id="l45.2184">     // it into an array.</span>
<a href="#l45.2185"></a><span id="l45.2185">     let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l45.2186"></a><span id="l45.2186" class="difflineminus">-    if (params.length)</span>
<a href="#l45.2187"></a><span id="l45.2187" class="difflineplus">+    if (params.length) {</span>
<a href="#l45.2188"></a><span id="l45.2188">       ircParam += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l45.2189"></a><span id="l45.2189" class="difflineplus">+    }</span>
<a href="#l45.2190"></a><span id="l45.2190"> </span>
<a href="#l45.2191"></a><span id="l45.2191">     // High/CTCP level quoting, replace \134 or \001 with \134\134 or \134a,</span>
<a href="#l45.2192"></a><span id="l45.2192">     // respectively. This is only done inside the extended data message.</span>
<a href="#l45.2193"></a><span id="l45.2193">     // eslint-disable-next-line no-control-regex</span>
<a href="#l45.2194"></a><span id="l45.2194">     const highRegex = /\\|\x01/g;</span>
<a href="#l45.2195"></a><span id="l45.2195" class="difflineminus">-    ircParam = ircParam.replace(highRegex,</span>
<a href="#l45.2196"></a><span id="l45.2196" class="difflineminus">-      aChar =&gt; &quot;\\&quot; + (aChar == &quot;\\&quot; ? &quot;\\&quot; : &quot;a&quot;));</span>
<a href="#l45.2197"></a><span id="l45.2197" class="difflineplus">+    ircParam = ircParam.replace(</span>
<a href="#l45.2198"></a><span id="l45.2198" class="difflineplus">+      highRegex,</span>
<a href="#l45.2199"></a><span id="l45.2199" class="difflineplus">+      aChar =&gt; &quot;\\&quot; + (aChar == &quot;\\&quot; ? &quot;\\&quot; : &quot;a&quot;)</span>
<a href="#l45.2200"></a><span id="l45.2200" class="difflineplus">+    );</span>
<a href="#l45.2201"></a><span id="l45.2201"> </span>
<a href="#l45.2202"></a><span id="l45.2202">     // Add the CTCP tagging.</span>
<a href="#l45.2203"></a><span id="l45.2203">     ircParam = &quot;\x01&quot; + ircParam + &quot;\x01&quot;;</span>
<a href="#l45.2204"></a><span id="l45.2204"> </span>
<a href="#l45.2205"></a><span id="l45.2205">     // Send the IRC message as a NOTICE or PRIVMSG.</span>
<a href="#l45.2206"></a><span id="l45.2206" class="difflineminus">-    return this.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [aTarget, ircParam]);</span>
<a href="#l45.2207"></a><span id="l45.2207" class="difflineplus">+    return this.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [</span>
<a href="#l45.2208"></a><span id="l45.2208" class="difflineplus">+      aTarget,</span>
<a href="#l45.2209"></a><span id="l45.2209" class="difflineplus">+      ircParam,</span>
<a href="#l45.2210"></a><span id="l45.2210" class="difflineplus">+    ]);</span>
<a href="#l45.2211"></a><span id="l45.2211">   },</span>
<a href="#l45.2212"></a><span id="l45.2212"> </span>
<a href="#l45.2213"></a><span id="l45.2213">   // Implement section 3.1 of RFC 2812</span>
<a href="#l45.2214"></a><span id="l45.2214">   _connectionRegistration() {</span>
<a href="#l45.2215"></a><span id="l45.2215">     // Send the Client Capabilities list command.</span>
<a href="#l45.2216"></a><span id="l45.2216">     this.sendMessage(&quot;CAP&quot;, &quot;LS&quot;);</span>
<a href="#l45.2217"></a><span id="l45.2217"> </span>
<a href="#l45.2218"></a><span id="l45.2218">     if (this.prefs.prefHasUserValue(&quot;serverPassword&quot;)) {</span>
<a href="#l45.2219"></a><span id="l45.2219" class="difflineminus">-      this.sendMessage(&quot;PASS&quot;, this.getString(&quot;serverPassword&quot;),</span>
<a href="#l45.2220"></a><span id="l45.2220" class="difflineminus">-                       &quot;PASS &lt;password not logged&gt;&quot;);</span>
<a href="#l45.2221"></a><span id="l45.2221" class="difflineplus">+      this.sendMessage(</span>
<a href="#l45.2222"></a><span id="l45.2222" class="difflineplus">+        &quot;PASS&quot;,</span>
<a href="#l45.2223"></a><span id="l45.2223" class="difflineplus">+        this.getString(&quot;serverPassword&quot;),</span>
<a href="#l45.2224"></a><span id="l45.2224" class="difflineplus">+        &quot;PASS &lt;password not logged&gt;&quot;</span>
<a href="#l45.2225"></a><span id="l45.2225" class="difflineplus">+      );</span>
<a href="#l45.2226"></a><span id="l45.2226">     }</span>
<a href="#l45.2227"></a><span id="l45.2227"> </span>
<a href="#l45.2228"></a><span id="l45.2228">     // Send the nick message (section 3.1.2).</span>
<a href="#l45.2229"></a><span id="l45.2229">     this.changeNick(this._requestedNickname);</span>
<a href="#l45.2230"></a><span id="l45.2230"> </span>
<a href="#l45.2231"></a><span id="l45.2231">     // Send the user message (section 3.1.3).</span>
<a href="#l45.2232"></a><span id="l45.2232" class="difflineminus">-    this.sendMessage(&quot;USER&quot;, [this.username, this._mode.toString(), &quot;*&quot;,</span>
<a href="#l45.2233"></a><span id="l45.2233" class="difflineminus">-                              this._realname || this._requestedNickname]);</span>
<a href="#l45.2234"></a><span id="l45.2234" class="difflineplus">+    this.sendMessage(&quot;USER&quot;, [</span>
<a href="#l45.2235"></a><span id="l45.2235" class="difflineplus">+      this.username,</span>
<a href="#l45.2236"></a><span id="l45.2236" class="difflineplus">+      this._mode.toString(),</span>
<a href="#l45.2237"></a><span id="l45.2237" class="difflineplus">+      &quot;*&quot;,</span>
<a href="#l45.2238"></a><span id="l45.2238" class="difflineplus">+      this._realname || this._requestedNickname,</span>
<a href="#l45.2239"></a><span id="l45.2239" class="difflineplus">+    ]);</span>
<a href="#l45.2240"></a><span id="l45.2240">   },</span>
<a href="#l45.2241"></a><span id="l45.2241"> </span>
<a href="#l45.2242"></a><span id="l45.2242">   _reportDisconnecting(aErrorReason, aErrorMessage) {</span>
<a href="#l45.2243"></a><span id="l45.2243">     this.reportDisconnecting(aErrorReason, aErrorMessage);</span>
<a href="#l45.2244"></a><span id="l45.2244"> </span>
<a href="#l45.2245"></a><span id="l45.2245">     // Cancel any pending buffered commands.</span>
<a href="#l45.2246"></a><span id="l45.2246">     this._commandBuffers.clear();</span>
<a href="#l45.2247"></a><span id="l45.2247"> </span>
<a href="#l45.2248"></a><span id="l45.2248">     // Mark all contacts on the account as having an unknown status.</span>
<a href="#l45.2249"></a><span id="l45.2249">     this.buddies.forEach(aBuddy =&gt;</span>
<a href="#l45.2250"></a><span id="l45.2250" class="difflineminus">-      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;));</span>
<a href="#l45.2251"></a><span id="l45.2251" class="difflineplus">+      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;)</span>
<a href="#l45.2252"></a><span id="l45.2252" class="difflineplus">+    );</span>
<a href="#l45.2253"></a><span id="l45.2253">   },</span>
<a href="#l45.2254"></a><span id="l45.2254"> </span>
<a href="#l45.2255"></a><span id="l45.2255" class="difflineminus">-  gotDisconnected(aError = Ci.prplIAccount.NO_ERROR,</span>
<a href="#l45.2256"></a><span id="l45.2256" class="difflineminus">-                            aErrorMessage = &quot;&quot;) {</span>
<a href="#l45.2257"></a><span id="l45.2257" class="difflineminus">-    if (!this.imAccount || this.disconnected)</span>
<a href="#l45.2258"></a><span id="l45.2258" class="difflineminus">-       return;</span>
<a href="#l45.2259"></a><span id="l45.2259" class="difflineplus">+  gotDisconnected(aError = Ci.prplIAccount.NO_ERROR, aErrorMessage = &quot;&quot;) {</span>
<a href="#l45.2260"></a><span id="l45.2260" class="difflineplus">+    if (!this.imAccount || this.disconnected) {</span>
<a href="#l45.2261"></a><span id="l45.2261" class="difflineplus">+      return;</span>
<a href="#l45.2262"></a><span id="l45.2262" class="difflineplus">+    }</span>
<a href="#l45.2263"></a><span id="l45.2263"> </span>
<a href="#l45.2264"></a><span id="l45.2264">     // If we are already disconnecting, this call to gotDisconnected</span>
<a href="#l45.2265"></a><span id="l45.2265">     // is when the server acknowledges our disconnection.</span>
<a href="#l45.2266"></a><span id="l45.2266">     // Otherwise it's because we lost the connection.</span>
<a href="#l45.2267"></a><span id="l45.2267" class="difflineminus">-    if (!this.disconnecting)</span>
<a href="#l45.2268"></a><span id="l45.2268" class="difflineplus">+    if (!this.disconnecting) {</span>
<a href="#l45.2269"></a><span id="l45.2269">       this._reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l45.2270"></a><span id="l45.2270" class="difflineplus">+    }</span>
<a href="#l45.2271"></a><span id="l45.2271">     this._socket.disconnect();</span>
<a href="#l45.2272"></a><span id="l45.2272">     delete this._socket;</span>
<a href="#l45.2273"></a><span id="l45.2273"> </span>
<a href="#l45.2274"></a><span id="l45.2274">     this._caps.clear();</span>
<a href="#l45.2275"></a><span id="l45.2275"> </span>
<a href="#l45.2276"></a><span id="l45.2276">     clearTimeout(this._isOnTimer);</span>
<a href="#l45.2277"></a><span id="l45.2277">     delete this._isOnTimer;</span>
<a href="#l45.2278"></a><span id="l45.2278"> </span>
<a href="#l45.2279"></a><span id="l45.2279" class="difflineat">@@ -1945,18 +2238,19 @@ ircAccount.prototype = {</span>
<a href="#l45.2280"></a><span id="l45.2280">           conversation.removeParticipant(this._nickname);</span>
<a href="#l45.2281"></a><span id="l45.2281">           conversation.left = true;</span>
<a href="#l45.2282"></a><span id="l45.2282">         }</span>
<a href="#l45.2283"></a><span id="l45.2283">       }</span>
<a href="#l45.2284"></a><span id="l45.2284">     });</span>
<a href="#l45.2285"></a><span id="l45.2285"> </span>
<a href="#l45.2286"></a><span id="l45.2286">     // If we disconnected during a pending LIST request, make sure callbacks</span>
<a href="#l45.2287"></a><span id="l45.2287">     // receive any remaining channels.</span>
<a href="#l45.2288"></a><span id="l45.2288" class="difflineminus">-    if (this._pendingList)</span>
<a href="#l45.2289"></a><span id="l45.2289" class="difflineplus">+    if (this._pendingList) {</span>
<a href="#l45.2290"></a><span id="l45.2290">       this._sendRemainingRoomInfo();</span>
<a href="#l45.2291"></a><span id="l45.2291" class="difflineplus">+    }</span>
<a href="#l45.2292"></a><span id="l45.2292"> </span>
<a href="#l45.2293"></a><span id="l45.2293">     // Clear whois table.</span>
<a href="#l45.2294"></a><span id="l45.2294">     this.whoisInformation.clear();</span>
<a href="#l45.2295"></a><span id="l45.2295"> </span>
<a href="#l45.2296"></a><span id="l45.2296">     this.reportDisconnected();</span>
<a href="#l45.2297"></a><span id="l45.2297">   },</span>
<a href="#l45.2298"></a><span id="l45.2298"> </span>
<a href="#l45.2299"></a><span id="l45.2299">   remove() {</span>
<a href="#l45.2300"></a><span id="l45.2300" class="difflineat">@@ -1964,18 +2258,19 @@ ircAccount.prototype = {</span>
<a href="#l45.2301"></a><span id="l45.2301">     delete this.conversations;</span>
<a href="#l45.2302"></a><span id="l45.2302">     this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l45.2303"></a><span id="l45.2303">     delete this.buddies;</span>
<a href="#l45.2304"></a><span id="l45.2304">   },</span>
<a href="#l45.2305"></a><span id="l45.2305"> </span>
<a href="#l45.2306"></a><span id="l45.2306">   unInit() {</span>
<a href="#l45.2307"></a><span id="l45.2307">     // Disconnect if we're online while this gets called.</span>
<a href="#l45.2308"></a><span id="l45.2308">     if (this._socket) {</span>
<a href="#l45.2309"></a><span id="l45.2309" class="difflineminus">-      if (!this.disconnecting)</span>
<a href="#l45.2310"></a><span id="l45.2310" class="difflineplus">+      if (!this.disconnecting) {</span>
<a href="#l45.2311"></a><span id="l45.2311">         this.quit();</span>
<a href="#l45.2312"></a><span id="l45.2312" class="difflineplus">+      }</span>
<a href="#l45.2313"></a><span id="l45.2313">       this._socket.disconnect();</span>
<a href="#l45.2314"></a><span id="l45.2314">     }</span>
<a href="#l45.2315"></a><span id="l45.2315">     delete this.imAccount;</span>
<a href="#l45.2316"></a><span id="l45.2316">     clearTimeout(this._isOnTimer);</span>
<a href="#l45.2317"></a><span id="l45.2317">     clearTimeout(this._quitTimer);</span>
<a href="#l45.2318"></a><span id="l45.2318">   },</span>
<a href="#l45.2319"></a><span id="l45.2319"> };</span>
<a href="#l45.2320"></a><span id="l45.2320"> </span>
<a href="#l45.2321"></a><span id="l45.2321" class="difflineat">@@ -2025,40 +2320,98 @@ function ircProtocol() {</span>
<a href="#l45.2322"></a><span id="l45.2322">   ircHandlers.registerISUPPORTHandler(tempScope.isupportMONITOR);</span>
<a href="#l45.2323"></a><span id="l45.2323">   ircHandlers.registerHandler(tempScope.ircSASL);</span>
<a href="#l45.2324"></a><span id="l45.2324">   ircHandlers.registerCAPHandler(tempScope.capSASL);</span>
<a href="#l45.2325"></a><span id="l45.2325">   ircHandlers.registerCAPHandler(tempScope.capServerTime);</span>
<a href="#l45.2326"></a><span id="l45.2326">   ircHandlers.registerTagHandler(tempScope.tagServerTime);</span>
<a href="#l45.2327"></a><span id="l45.2327"> }</span>
<a href="#l45.2328"></a><span id="l45.2328"> ircProtocol.prototype = {</span>
<a href="#l45.2329"></a><span id="l45.2329">   __proto__: GenericProtocolPrototype,</span>
<a href="#l45.2330"></a><span id="l45.2330" class="difflineminus">-  get name() { return &quot;IRC&quot;; },</span>
<a href="#l45.2331"></a><span id="l45.2331" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-irc/skin/&quot;; },</span>
<a href="#l45.2332"></a><span id="l45.2332" class="difflineminus">-  get usernameEmptyText() { return _(&quot;irc.usernameHint&quot;); },</span>
<a href="#l45.2333"></a><span id="l45.2333" class="difflineminus">-  get baseId() { return &quot;prpl-irc&quot;; },</span>
<a href="#l45.2334"></a><span id="l45.2334" class="difflineplus">+  get name() {</span>
<a href="#l45.2335"></a><span id="l45.2335" class="difflineplus">+    return &quot;IRC&quot;;</span>
<a href="#l45.2336"></a><span id="l45.2336" class="difflineplus">+  },</span>
<a href="#l45.2337"></a><span id="l45.2337" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l45.2338"></a><span id="l45.2338" class="difflineplus">+    return &quot;chrome://prpl-irc/skin/&quot;;</span>
<a href="#l45.2339"></a><span id="l45.2339" class="difflineplus">+  },</span>
<a href="#l45.2340"></a><span id="l45.2340" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l45.2341"></a><span id="l45.2341" class="difflineplus">+    return _(&quot;irc.usernameHint&quot;);</span>
<a href="#l45.2342"></a><span id="l45.2342" class="difflineplus">+  },</span>
<a href="#l45.2343"></a><span id="l45.2343" class="difflineplus">+  get baseId() {</span>
<a href="#l45.2344"></a><span id="l45.2344" class="difflineplus">+    return &quot;prpl-irc&quot;;</span>
<a href="#l45.2345"></a><span id="l45.2345" class="difflineplus">+  },</span>
<a href="#l45.2346"></a><span id="l45.2346"> </span>
<a href="#l45.2347"></a><span id="l45.2347">   usernameSplits: [</span>
<a href="#l45.2348"></a><span id="l45.2348" class="difflineminus">-    {get label() { return _(&quot;options.server&quot;); }, separator: &quot;@&quot;,</span>
<a href="#l45.2349"></a><span id="l45.2349" class="difflineminus">-     defaultValue: &quot;chat.freenode.net&quot;, reverse: true},</span>
<a href="#l45.2350"></a><span id="l45.2350" class="difflineplus">+    {</span>
<a href="#l45.2351"></a><span id="l45.2351" class="difflineplus">+      get label() {</span>
<a href="#l45.2352"></a><span id="l45.2352" class="difflineplus">+        return _(&quot;options.server&quot;);</span>
<a href="#l45.2353"></a><span id="l45.2353" class="difflineplus">+      },</span>
<a href="#l45.2354"></a><span id="l45.2354" class="difflineplus">+      separator: &quot;@&quot;,</span>
<a href="#l45.2355"></a><span id="l45.2355" class="difflineplus">+      defaultValue: &quot;chat.freenode.net&quot;,</span>
<a href="#l45.2356"></a><span id="l45.2356" class="difflineplus">+      reverse: true,</span>
<a href="#l45.2357"></a><span id="l45.2357" class="difflineplus">+    },</span>
<a href="#l45.2358"></a><span id="l45.2358">   ],</span>
<a href="#l45.2359"></a><span id="l45.2359"> </span>
<a href="#l45.2360"></a><span id="l45.2360">   options: {</span>
<a href="#l45.2361"></a><span id="l45.2361" class="difflineminus">-    &quot;port&quot;: {get label() { return _(&quot;options.port&quot;); }, default: 6697},</span>
<a href="#l45.2362"></a><span id="l45.2362" class="difflineminus">-    &quot;ssl&quot;: {get label() { return _(&quot;options.ssl&quot;); }, default: true},</span>
<a href="#l45.2363"></a><span id="l45.2363" class="difflineplus">+    port: {</span>
<a href="#l45.2364"></a><span id="l45.2364" class="difflineplus">+      get label() {</span>
<a href="#l45.2365"></a><span id="l45.2365" class="difflineplus">+        return _(&quot;options.port&quot;);</span>
<a href="#l45.2366"></a><span id="l45.2366" class="difflineplus">+      },</span>
<a href="#l45.2367"></a><span id="l45.2367" class="difflineplus">+      default: 6697,</span>
<a href="#l45.2368"></a><span id="l45.2368" class="difflineplus">+    },</span>
<a href="#l45.2369"></a><span id="l45.2369" class="difflineplus">+    ssl: {</span>
<a href="#l45.2370"></a><span id="l45.2370" class="difflineplus">+      get label() {</span>
<a href="#l45.2371"></a><span id="l45.2371" class="difflineplus">+        return _(&quot;options.ssl&quot;);</span>
<a href="#l45.2372"></a><span id="l45.2372" class="difflineplus">+      },</span>
<a href="#l45.2373"></a><span id="l45.2373" class="difflineplus">+      default: true,</span>
<a href="#l45.2374"></a><span id="l45.2374" class="difflineplus">+    },</span>
<a href="#l45.2375"></a><span id="l45.2375">     // TODO We should attempt to auto-detect encoding instead.</span>
<a href="#l45.2376"></a><span id="l45.2376" class="difflineminus">-    &quot;encoding&quot;: {get label() { return _(&quot;options.encoding&quot;); }, default: &quot;UTF-8&quot;},</span>
<a href="#l45.2377"></a><span id="l45.2377" class="difflineminus">-    &quot;quitmsg&quot;: {get label() { return _(&quot;options.quitMessage&quot;); },</span>
<a href="#l45.2378"></a><span id="l45.2378" class="difflineminus">-                get default() { return Services.prefs.getCharPref(&quot;chat.irc.defaultQuitMessage&quot;); }},</span>
<a href="#l45.2379"></a><span id="l45.2379" class="difflineminus">-    &quot;partmsg&quot;: {get label() { return _(&quot;options.partMessage&quot;); }, default: &quot;&quot;},</span>
<a href="#l45.2380"></a><span id="l45.2380" class="difflineminus">-    &quot;showServerTab&quot;: {get label() { return _(&quot;options.showServerTab&quot;); }, default: false},</span>
<a href="#l45.2381"></a><span id="l45.2381" class="difflineminus">-    &quot;alternateNicks&quot;: {get label() { return _(&quot;options.alternateNicks&quot;); }, default: &quot;&quot;},</span>
<a href="#l45.2382"></a><span id="l45.2382" class="difflineplus">+    encoding: {</span>
<a href="#l45.2383"></a><span id="l45.2383" class="difflineplus">+      get label() {</span>
<a href="#l45.2384"></a><span id="l45.2384" class="difflineplus">+        return _(&quot;options.encoding&quot;);</span>
<a href="#l45.2385"></a><span id="l45.2385" class="difflineplus">+      },</span>
<a href="#l45.2386"></a><span id="l45.2386" class="difflineplus">+      default: &quot;UTF-8&quot;,</span>
<a href="#l45.2387"></a><span id="l45.2387" class="difflineplus">+    },</span>
<a href="#l45.2388"></a><span id="l45.2388" class="difflineplus">+    quitmsg: {</span>
<a href="#l45.2389"></a><span id="l45.2389" class="difflineplus">+      get label() {</span>
<a href="#l45.2390"></a><span id="l45.2390" class="difflineplus">+        return _(&quot;options.quitMessage&quot;);</span>
<a href="#l45.2391"></a><span id="l45.2391" class="difflineplus">+      },</span>
<a href="#l45.2392"></a><span id="l45.2392" class="difflineplus">+      get default() {</span>
<a href="#l45.2393"></a><span id="l45.2393" class="difflineplus">+        return Services.prefs.getCharPref(&quot;chat.irc.defaultQuitMessage&quot;);</span>
<a href="#l45.2394"></a><span id="l45.2394" class="difflineplus">+      },</span>
<a href="#l45.2395"></a><span id="l45.2395" class="difflineplus">+    },</span>
<a href="#l45.2396"></a><span id="l45.2396" class="difflineplus">+    partmsg: {</span>
<a href="#l45.2397"></a><span id="l45.2397" class="difflineplus">+      get label() {</span>
<a href="#l45.2398"></a><span id="l45.2398" class="difflineplus">+        return _(&quot;options.partMessage&quot;);</span>
<a href="#l45.2399"></a><span id="l45.2399" class="difflineplus">+      },</span>
<a href="#l45.2400"></a><span id="l45.2400" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l45.2401"></a><span id="l45.2401" class="difflineplus">+    },</span>
<a href="#l45.2402"></a><span id="l45.2402" class="difflineplus">+    showServerTab: {</span>
<a href="#l45.2403"></a><span id="l45.2403" class="difflineplus">+      get label() {</span>
<a href="#l45.2404"></a><span id="l45.2404" class="difflineplus">+        return _(&quot;options.showServerTab&quot;);</span>
<a href="#l45.2405"></a><span id="l45.2405" class="difflineplus">+      },</span>
<a href="#l45.2406"></a><span id="l45.2406" class="difflineplus">+      default: false,</span>
<a href="#l45.2407"></a><span id="l45.2407" class="difflineplus">+    },</span>
<a href="#l45.2408"></a><span id="l45.2408" class="difflineplus">+    alternateNicks: {</span>
<a href="#l45.2409"></a><span id="l45.2409" class="difflineplus">+      get label() {</span>
<a href="#l45.2410"></a><span id="l45.2410" class="difflineplus">+        return _(&quot;options.alternateNicks&quot;);</span>
<a href="#l45.2411"></a><span id="l45.2411" class="difflineplus">+      },</span>
<a href="#l45.2412"></a><span id="l45.2412" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l45.2413"></a><span id="l45.2413" class="difflineplus">+    },</span>
<a href="#l45.2414"></a><span id="l45.2414">   },</span>
<a href="#l45.2415"></a><span id="l45.2415"> </span>
<a href="#l45.2416"></a><span id="l45.2416" class="difflineminus">-  get chatHasTopic() { return true; },</span>
<a href="#l45.2417"></a><span id="l45.2417" class="difflineminus">-  get slashCommandsNative() { return true; },</span>
<a href="#l45.2418"></a><span id="l45.2418" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l45.2419"></a><span id="l45.2419" class="difflineplus">+    return true;</span>
<a href="#l45.2420"></a><span id="l45.2420" class="difflineplus">+  },</span>
<a href="#l45.2421"></a><span id="l45.2421" class="difflineplus">+  get slashCommandsNative() {</span>
<a href="#l45.2422"></a><span id="l45.2422" class="difflineplus">+    return true;</span>
<a href="#l45.2423"></a><span id="l45.2423" class="difflineplus">+  },</span>
<a href="#l45.2424"></a><span id="l45.2424">   //  Passwords in IRC are optional, and are needed for certain functionality.</span>
<a href="#l45.2425"></a><span id="l45.2425" class="difflineminus">-  get passwordOptional() { return true; },</span>
<a href="#l45.2426"></a><span id="l45.2426" class="difflineplus">+  get passwordOptional() {</span>
<a href="#l45.2427"></a><span id="l45.2427" class="difflineplus">+    return true;</span>
<a href="#l45.2428"></a><span id="l45.2428" class="difflineplus">+  },</span>
<a href="#l45.2429"></a><span id="l45.2429"> </span>
<a href="#l45.2430"></a><span id="l45.2430" class="difflineminus">-  getAccount(aImAccount) { return new ircAccount(this, aImAccount); },</span>
<a href="#l45.2431"></a><span id="l45.2431" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l45.2432"></a><span id="l45.2432" class="difflineplus">+    return new ircAccount(this, aImAccount);</span>
<a href="#l45.2433"></a><span id="l45.2433" class="difflineplus">+  },</span>
<a href="#l45.2434"></a><span id="l45.2434">   classID: Components.ID(&quot;{607b2c0b-9504-483f-ad62-41de09238aec}&quot;),</span>
<a href="#l45.2435"></a><span id="l45.2435"> };</span>
<a href="#l45.2436"></a><span id="l45.2436"> </span>
<a href="#l45.2437"></a><span id="l45.2437"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([ircProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/chat/protocols/irc/ircBase.jsm</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/chat/protocols/irc/ircBase.jsm</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -14,1431 +14,1754 @@</span>
<a href="#l46.4"></a><span id="l46.4">  *     http://tools.ietf.org/html/rfc2812</span>
<a href="#l46.5"></a><span id="l46.5">  *   RFC 2813: Internet Relay Chat: Server Protocol</span>
<a href="#l46.6"></a><span id="l46.6">  *     http://tools.ietf.org/html/rfc2813</span>
<a href="#l46.7"></a><span id="l46.7">  *   RFC 1459: Internet Relay Chat Protocol</span>
<a href="#l46.8"></a><span id="l46.8">  *     http://tools.ietf.org/html/rfc1459</span>
<a href="#l46.9"></a><span id="l46.9">  */</span>
<a href="#l46.10"></a><span id="l46.10"> this.EXPORTED_SYMBOLS = [&quot;ircBase&quot;];</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-var {</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-  setTimeout,</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-  clearTimeout,</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineminus">-var {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+var { setTimeout, clearTimeout, nsSimpleEnumerator } = ChromeUtils.import(</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+);</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineplus">+var { ircHandlers } = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l46.24"></a><span id="l46.24"> var {</span>
<a href="#l46.25"></a><span id="l46.25">   _,</span>
<a href="#l46.26"></a><span id="l46.26">   ctcpFormatToText,</span>
<a href="#l46.27"></a><span id="l46.27">   conversationErrorMessage,</span>
<a href="#l46.28"></a><span id="l46.28">   kListRefreshInterval,</span>
<a href="#l46.29"></a><span id="l46.29"> } = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l46.30"></a><span id="l46.30"> </span>
<a href="#l46.31"></a><span id="l46.31"> function privmsg(aAccount, aMessage, aIsNotification) {</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineminus">-  let params = {incoming: true, tags: aMessage.tags};</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineminus">-  if (aIsNotification)</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+  let params = { incoming: true, tags: aMessage.tags };</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+  if (aIsNotification) {</span>
<a href="#l46.36"></a><span id="l46.36">     params.notification = true;</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-  aAccount.getConversation(aAccount.isMUCName(aMessage.params[0]) ?</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineminus">-                             aMessage.params[0] : aMessage.origin)</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-          .writeMessage(aMessage.origin, aMessage.params[1], params);</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+  }</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+  aAccount</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+    .getConversation(</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineplus">+      aAccount.isMUCName(aMessage.params[0])</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineplus">+        ? aMessage.params[0]</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineplus">+        : aMessage.origin</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+    )</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineplus">+    .writeMessage(aMessage.origin, aMessage.params[1], params);</span>
<a href="#l46.48"></a><span id="l46.48">   return true;</span>
<a href="#l46.49"></a><span id="l46.49"> }</span>
<a href="#l46.50"></a><span id="l46.50"> </span>
<a href="#l46.51"></a><span id="l46.51"> // Display the message and remove them from the rooms they're in.</span>
<a href="#l46.52"></a><span id="l46.52"> function leftRoom(aAccount, aNicks, aChannels, aSource, aReason, aKicked) {</span>
<a href="#l46.53"></a><span id="l46.53">   let msgId = &quot;message.&quot; + (aKicked ? &quot;kicked&quot; : &quot;parted&quot;);</span>
<a href="#l46.54"></a><span id="l46.54">   // If a part message was included, include it.</span>
<a href="#l46.55"></a><span id="l46.55">   let reason = aReason ? _(msgId + &quot;.reason&quot;, aReason) : &quot;&quot;;</span>
<a href="#l46.56"></a><span id="l46.56">   function __(aNick, aYou) {</span>
<a href="#l46.57"></a><span id="l46.57">     // If the user is kicked, we need to say who kicked them.</span>
<a href="#l46.58"></a><span id="l46.58">     let msgId2 = msgId + (aYou ? &quot;.you&quot; : &quot;&quot;);</span>
<a href="#l46.59"></a><span id="l46.59">     if (aKicked) {</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineminus">-      if (aYou)</span>
<a href="#l46.61"></a><span id="l46.61" class="difflineplus">+      if (aYou) {</span>
<a href="#l46.62"></a><span id="l46.62">         return _(msgId2, aSource, reason);</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineplus">+      }</span>
<a href="#l46.64"></a><span id="l46.64">       return _(msgId2, aNick, aSource, reason);</span>
<a href="#l46.65"></a><span id="l46.65">     }</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineminus">-    if (aYou)</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineplus">+    if (aYou) {</span>
<a href="#l46.68"></a><span id="l46.68">       return _(msgId2, reason);</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineplus">+    }</span>
<a href="#l46.70"></a><span id="l46.70">     return _(msgId2, aNick, reason);</span>
<a href="#l46.71"></a><span id="l46.71">   }</span>
<a href="#l46.72"></a><span id="l46.72"> </span>
<a href="#l46.73"></a><span id="l46.73">   for (let channelName of aChannels) {</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineminus">-    if (!aAccount.conversations.has(channelName))</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineminus">-      continue; // Handle when we closed the window</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineplus">+    if (!aAccount.conversations.has(channelName)) {</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineplus">+      continue;</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineplus">+    } // Handle when we closed the window</span>
<a href="#l46.79"></a><span id="l46.79">     let conversation = aAccount.getConversation(channelName);</span>
<a href="#l46.80"></a><span id="l46.80">     for (let nick of aNicks) {</span>
<a href="#l46.81"></a><span id="l46.81">       let msg;</span>
<a href="#l46.82"></a><span id="l46.82">       if (aAccount.normalize(nick) == aAccount.normalize(aAccount._nickname)) {</span>
<a href="#l46.83"></a><span id="l46.83">         msg = __(nick, true);</span>
<a href="#l46.84"></a><span id="l46.84">         // If the user left, mark the conversation as no longer being active.</span>
<a href="#l46.85"></a><span id="l46.85">         conversation.left = true;</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineminus">-      }</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineminus">-      else</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+      } else {</span>
<a href="#l46.89"></a><span id="l46.89">         msg = __(nick);</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineplus">+      }</span>
<a href="#l46.91"></a><span id="l46.91"> </span>
<a href="#l46.92"></a><span id="l46.92" class="difflineminus">-      conversation.writeMessage(aSource, msg, {system: true});</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineplus">+      conversation.writeMessage(aSource, msg, { system: true });</span>
<a href="#l46.94"></a><span id="l46.94">       conversation.removeParticipant(nick);</span>
<a href="#l46.95"></a><span id="l46.95">     }</span>
<a href="#l46.96"></a><span id="l46.96">   }</span>
<a href="#l46.97"></a><span id="l46.97">   return true;</span>
<a href="#l46.98"></a><span id="l46.98"> }</span>
<a href="#l46.99"></a><span id="l46.99"> </span>
<a href="#l46.100"></a><span id="l46.100"> function writeMessage(aAccount, aMessage, aString, aType) {</span>
<a href="#l46.101"></a><span id="l46.101">   let type = {};</span>
<a href="#l46.102"></a><span id="l46.102">   type[aType] = true;</span>
<a href="#l46.103"></a><span id="l46.103">   type.tags = aMessage.tags;</span>
<a href="#l46.104"></a><span id="l46.104" class="difflineminus">-  aAccount.getConversation(aMessage.origin)</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineminus">-          .writeMessage(aMessage.origin, aString, type);</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineplus">+  aAccount</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+    .getConversation(aMessage.origin)</span>
<a href="#l46.108"></a><span id="l46.108" class="difflineplus">+    .writeMessage(aMessage.origin, aString, type);</span>
<a href="#l46.109"></a><span id="l46.109">   return true;</span>
<a href="#l46.110"></a><span id="l46.110"> }</span>
<a href="#l46.111"></a><span id="l46.111"> </span>
<a href="#l46.112"></a><span id="l46.112"> // If aNoLastParam is true, the last parameter is not printed out.</span>
<a href="#l46.113"></a><span id="l46.113"> function serverMessage(aAccount, aMsg, aNoLastParam) {</span>
<a href="#l46.114"></a><span id="l46.114">   // If we don't want to show messages from the server, just mark it as handled.</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineminus">-  if (!aAccount._showServerTab)</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineplus">+  if (!aAccount._showServerTab) {</span>
<a href="#l46.117"></a><span id="l46.117">     return true;</span>
<a href="#l46.118"></a><span id="l46.118" class="difflineplus">+  }</span>
<a href="#l46.119"></a><span id="l46.119"> </span>
<a href="#l46.120"></a><span id="l46.120" class="difflineminus">-  return writeMessage(aAccount, aMsg,</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineminus">-                      aMsg.params.slice(1, aNoLastParam ? -1 : undefined).join(&quot; &quot;),</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineminus">-                      &quot;system&quot;);</span>
<a href="#l46.123"></a><span id="l46.123" class="difflineplus">+  return writeMessage(</span>
<a href="#l46.124"></a><span id="l46.124" class="difflineplus">+    aAccount,</span>
<a href="#l46.125"></a><span id="l46.125" class="difflineplus">+    aMsg,</span>
<a href="#l46.126"></a><span id="l46.126" class="difflineplus">+    aMsg.params.slice(1, aNoLastParam ? -1 : undefined).join(&quot; &quot;),</span>
<a href="#l46.127"></a><span id="l46.127" class="difflineplus">+    &quot;system&quot;</span>
<a href="#l46.128"></a><span id="l46.128" class="difflineplus">+  );</span>
<a href="#l46.129"></a><span id="l46.129"> }</span>
<a href="#l46.130"></a><span id="l46.130"> </span>
<a href="#l46.131"></a><span id="l46.131"> function serverErrorMessage(aAccount, aMessage, aError) {</span>
<a href="#l46.132"></a><span id="l46.132">   // If we don't want to show messages from the server, just mark it as handled.</span>
<a href="#l46.133"></a><span id="l46.133" class="difflineminus">-  if (!aAccount._showServerTab)</span>
<a href="#l46.134"></a><span id="l46.134" class="difflineplus">+  if (!aAccount._showServerTab) {</span>
<a href="#l46.135"></a><span id="l46.135">     return true;</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineplus">+  }</span>
<a href="#l46.137"></a><span id="l46.137"> </span>
<a href="#l46.138"></a><span id="l46.138">   return writeMessage(aAccount, aMessage, aError, &quot;error&quot;);</span>
<a href="#l46.139"></a><span id="l46.139"> }</span>
<a href="#l46.140"></a><span id="l46.140"> </span>
<a href="#l46.141"></a><span id="l46.141"> function addMotd(aAccount, aMessage) {</span>
<a href="#l46.142"></a><span id="l46.142">   // If there is no current MOTD to append to, start a new one.</span>
<a href="#l46.143"></a><span id="l46.143" class="difflineminus">-  if (!aAccount._motd)</span>
<a href="#l46.144"></a><span id="l46.144" class="difflineplus">+  if (!aAccount._motd) {</span>
<a href="#l46.145"></a><span id="l46.145">     aAccount._motd = [];</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+  }</span>
<a href="#l46.147"></a><span id="l46.147"> </span>
<a href="#l46.148"></a><span id="l46.148">   // Traditionally, MOTD messages start with &quot;- &quot;, but this is not always</span>
<a href="#l46.149"></a><span id="l46.149">   // true, try to handle that sanely.</span>
<a href="#l46.150"></a><span id="l46.150">   let message = aMessage.params[1];</span>
<a href="#l46.151"></a><span id="l46.151" class="difflineminus">-  if (message.startsWith(&quot;-&quot;))</span>
<a href="#l46.152"></a><span id="l46.152" class="difflineplus">+  if (message.startsWith(&quot;-&quot;)) {</span>
<a href="#l46.153"></a><span id="l46.153">     message = message.slice(1).trim();</span>
<a href="#l46.154"></a><span id="l46.154" class="difflineplus">+  }</span>
<a href="#l46.155"></a><span id="l46.155">   // And traditionally, the initial message ends in &quot; -&quot;, remove that.</span>
<a href="#l46.156"></a><span id="l46.156" class="difflineminus">-  if (message.endsWith(&quot;-&quot;))</span>
<a href="#l46.157"></a><span id="l46.157" class="difflineplus">+  if (message.endsWith(&quot;-&quot;)) {</span>
<a href="#l46.158"></a><span id="l46.158">     message = message.slice(0, -1).trim();</span>
<a href="#l46.159"></a><span id="l46.159" class="difflineplus">+  }</span>
<a href="#l46.160"></a><span id="l46.160"> </span>
<a href="#l46.161"></a><span id="l46.161">   // Actually add the message (if it still exists).</span>
<a href="#l46.162"></a><span id="l46.162" class="difflineminus">-  if (message)</span>
<a href="#l46.163"></a><span id="l46.163" class="difflineplus">+  if (message) {</span>
<a href="#l46.164"></a><span id="l46.164">     aAccount._motd.push(message);</span>
<a href="#l46.165"></a><span id="l46.165" class="difflineplus">+  }</span>
<a href="#l46.166"></a><span id="l46.166"> </span>
<a href="#l46.167"></a><span id="l46.167">   // Oh, also some servers don't send a RPL_ENDOFMOTD (e.g. irc.ppy.sh), so if</span>
<a href="#l46.168"></a><span id="l46.168">   // we don't receive another MOTD message after 1 second, consider it to be</span>
<a href="#l46.169"></a><span id="l46.169">   // RPL_ENDOFMOTD.</span>
<a href="#l46.170"></a><span id="l46.170">   clearTimeout(aAccount._motdTimer);</span>
<a href="#l46.171"></a><span id="l46.171" class="difflineminus">-  aAccount._motdTimer = setTimeout(ircBase.commands[&quot;376&quot;].bind(aAccount),</span>
<a href="#l46.172"></a><span id="l46.172" class="difflineminus">-                                   1000, aMessage);</span>
<a href="#l46.173"></a><span id="l46.173" class="difflineplus">+  aAccount._motdTimer = setTimeout(</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineplus">+    ircBase.commands[&quot;376&quot;].bind(aAccount),</span>
<a href="#l46.175"></a><span id="l46.175" class="difflineplus">+    1000,</span>
<a href="#l46.176"></a><span id="l46.176" class="difflineplus">+    aMessage</span>
<a href="#l46.177"></a><span id="l46.177" class="difflineplus">+  );</span>
<a href="#l46.178"></a><span id="l46.178"> </span>
<a href="#l46.179"></a><span id="l46.179">   return true;</span>
<a href="#l46.180"></a><span id="l46.180"> }</span>
<a href="#l46.181"></a><span id="l46.181"> </span>
<a href="#l46.182"></a><span id="l46.182"> // See RFCs 2811 &amp; 2812 (which obsoletes RFC 1459) for a description of these</span>
<a href="#l46.183"></a><span id="l46.183"> // commands.</span>
<a href="#l46.184"></a><span id="l46.184"> var ircBase = {</span>
<a href="#l46.185"></a><span id="l46.185">   // Parameters</span>
<a href="#l46.186"></a><span id="l46.186">   name: &quot;RFC 2812&quot;, // Name identifier</span>
<a href="#l46.187"></a><span id="l46.187">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l46.188"></a><span id="l46.188">   isEnabled: () =&gt; true,</span>
<a href="#l46.189"></a><span id="l46.189"> </span>
<a href="#l46.190"></a><span id="l46.190">   // The IRC commands that can be handled.</span>
<a href="#l46.191"></a><span id="l46.191">   commands: {</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineminus">-    &quot;ERROR&quot;: function(aMessage) {</span>
<a href="#l46.193"></a><span id="l46.193" class="difflineplus">+    ERROR(aMessage) {</span>
<a href="#l46.194"></a><span id="l46.194">       // ERROR &lt;error message&gt;</span>
<a href="#l46.195"></a><span id="l46.195">       // Client connection has been terminated.</span>
<a href="#l46.196"></a><span id="l46.196">       if (!this.disconnecting) {</span>
<a href="#l46.197"></a><span id="l46.197">         // We received an ERROR message when we weren't expecting it, this is</span>
<a href="#l46.198"></a><span id="l46.198">         // probably the server giving us a ping timeout.</span>
<a href="#l46.199"></a><span id="l46.199" class="difflineminus">-        this.WARN(&quot;Received unexpected ERROR response:\n&quot; +</span>
<a href="#l46.200"></a><span id="l46.200" class="difflineminus">-                  aMessage.params[0]);</span>
<a href="#l46.201"></a><span id="l46.201" class="difflineminus">-        this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l46.202"></a><span id="l46.202" class="difflineminus">-                             _(&quot;connection.error.lost&quot;));</span>
<a href="#l46.203"></a><span id="l46.203" class="difflineminus">-      }</span>
<a href="#l46.204"></a><span id="l46.204" class="difflineminus">-      else {</span>
<a href="#l46.205"></a><span id="l46.205" class="difflineplus">+        this.WARN(&quot;Received unexpected ERROR response:\n&quot; + aMessage.params[0]);</span>
<a href="#l46.206"></a><span id="l46.206" class="difflineplus">+        this.gotDisconnected(</span>
<a href="#l46.207"></a><span id="l46.207" class="difflineplus">+          Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l46.208"></a><span id="l46.208" class="difflineplus">+          _(&quot;connection.error.lost&quot;)</span>
<a href="#l46.209"></a><span id="l46.209" class="difflineplus">+        );</span>
<a href="#l46.210"></a><span id="l46.210" class="difflineplus">+      } else {</span>
<a href="#l46.211"></a><span id="l46.211">         // We received an ERROR message when expecting it (i.e. we've sent a</span>
<a href="#l46.212"></a><span id="l46.212">         // QUIT command). Notify account manager.</span>
<a href="#l46.213"></a><span id="l46.213">         this.gotDisconnected();</span>
<a href="#l46.214"></a><span id="l46.214">       }</span>
<a href="#l46.215"></a><span id="l46.215">       return true;</span>
<a href="#l46.216"></a><span id="l46.216">     },</span>
<a href="#l46.217"></a><span id="l46.217" class="difflineminus">-    &quot;INVITE&quot;: function(aMessage) {</span>
<a href="#l46.218"></a><span id="l46.218" class="difflineplus">+    INVITE(aMessage) {</span>
<a href="#l46.219"></a><span id="l46.219">       // INVITE &lt;nickname&gt; &lt;channel&gt;</span>
<a href="#l46.220"></a><span id="l46.220" class="difflineminus">-      if (Services.prefs.getIntPref(&quot;messenger.conversations.autoAcceptChatInvitations&quot;) == 1) {</span>
<a href="#l46.221"></a><span id="l46.221" class="difflineplus">+      if (</span>
<a href="#l46.222"></a><span id="l46.222" class="difflineplus">+        Services.prefs.getIntPref(</span>
<a href="#l46.223"></a><span id="l46.223" class="difflineplus">+          &quot;messenger.conversations.autoAcceptChatInvitations&quot;</span>
<a href="#l46.224"></a><span id="l46.224" class="difflineplus">+        ) == 1</span>
<a href="#l46.225"></a><span id="l46.225" class="difflineplus">+      ) {</span>
<a href="#l46.226"></a><span id="l46.226">         // Auto-accept the invite.</span>
<a href="#l46.227"></a><span id="l46.227">         this.joinChat(this.getChatRoomDefaultFieldValues(aMessage.params[1]));</span>
<a href="#l46.228"></a><span id="l46.228" class="difflineminus">-        this.LOG(&quot;Received invite for &quot; + aMessage.params[1] +</span>
<a href="#l46.229"></a><span id="l46.229" class="difflineminus">-                 &quot;, auto-accepting.&quot;);</span>
<a href="#l46.230"></a><span id="l46.230" class="difflineplus">+        this.LOG(</span>
<a href="#l46.231"></a><span id="l46.231" class="difflineplus">+          &quot;Received invite for &quot; + aMessage.params[1] + &quot;, auto-accepting.&quot;</span>
<a href="#l46.232"></a><span id="l46.232" class="difflineplus">+        );</span>
<a href="#l46.233"></a><span id="l46.233">       }</span>
<a href="#l46.234"></a><span id="l46.234">       // Otherwise, just notify the user.</span>
<a href="#l46.235"></a><span id="l46.235" class="difflineminus">-      this.getConversation(aMessage.params[1])</span>
<a href="#l46.236"></a><span id="l46.236" class="difflineminus">-          .writeMessage(aMessage.origin,</span>
<a href="#l46.237"></a><span id="l46.237" class="difflineminus">-                        _(&quot;message.inviteReceived&quot;, aMessage.origin,</span>
<a href="#l46.238"></a><span id="l46.238" class="difflineminus">-                          aMessage.params[1]), {system: true});</span>
<a href="#l46.239"></a><span id="l46.239" class="difflineplus">+      this.getConversation(aMessage.params[1]).writeMessage(</span>
<a href="#l46.240"></a><span id="l46.240" class="difflineplus">+        aMessage.origin,</span>
<a href="#l46.241"></a><span id="l46.241" class="difflineplus">+        _(&quot;message.inviteReceived&quot;, aMessage.origin, aMessage.params[1]),</span>
<a href="#l46.242"></a><span id="l46.242" class="difflineplus">+        { system: true }</span>
<a href="#l46.243"></a><span id="l46.243" class="difflineplus">+      );</span>
<a href="#l46.244"></a><span id="l46.244">       return true;</span>
<a href="#l46.245"></a><span id="l46.245">     },</span>
<a href="#l46.246"></a><span id="l46.246" class="difflineminus">-    &quot;JOIN&quot;: function(aMessage) {</span>
<a href="#l46.247"></a><span id="l46.247" class="difflineplus">+    JOIN(aMessage) {</span>
<a href="#l46.248"></a><span id="l46.248">       // JOIN ( &lt;channel&gt; *( &quot;,&quot; &lt;channel&gt; ) [ &lt;key&gt; *( &quot;,&quot; &lt;key&gt; ) ] ) / &quot;0&quot;</span>
<a href="#l46.249"></a><span id="l46.249">       // Iterate over each channel.</span>
<a href="#l46.250"></a><span id="l46.250">       for (let channelName of aMessage.params[0].split(&quot;,&quot;)) {</span>
<a href="#l46.251"></a><span id="l46.251">         let conversation = this.getConversation(channelName);</span>
<a href="#l46.252"></a><span id="l46.252"> </span>
<a href="#l46.253"></a><span id="l46.253">         // Check whether we joined the channel or if someone else did.</span>
<a href="#l46.254"></a><span id="l46.254" class="difflineminus">-        if (this.normalize(aMessage.origin, this.userPrefixes) ==</span>
<a href="#l46.255"></a><span id="l46.255" class="difflineminus">-            this.normalize(this._nickname)) {</span>
<a href="#l46.256"></a><span id="l46.256" class="difflineplus">+        if (</span>
<a href="#l46.257"></a><span id="l46.257" class="difflineplus">+          this.normalize(aMessage.origin, this.userPrefixes) ==</span>
<a href="#l46.258"></a><span id="l46.258" class="difflineplus">+          this.normalize(this._nickname)</span>
<a href="#l46.259"></a><span id="l46.259" class="difflineplus">+        ) {</span>
<a href="#l46.260"></a><span id="l46.260">           // If we join, clear the participants list to avoid errors with</span>
<a href="#l46.261"></a><span id="l46.261">           // repeated participants.</span>
<a href="#l46.262"></a><span id="l46.262">           conversation.removeAllParticipants();</span>
<a href="#l46.263"></a><span id="l46.263">           conversation.left = false;</span>
<a href="#l46.264"></a><span id="l46.264">           conversation.joining = false;</span>
<a href="#l46.265"></a><span id="l46.265"> </span>
<a href="#l46.266"></a><span id="l46.266">           // Update the channel name if it has improper capitalization.</span>
<a href="#l46.267"></a><span id="l46.267">           if (channelName != conversation.name) {</span>
<a href="#l46.268"></a><span id="l46.268">             conversation._name = channelName;</span>
<a href="#l46.269"></a><span id="l46.269">             conversation.notifyObservers(null, &quot;update-conv-title&quot;);</span>
<a href="#l46.270"></a><span id="l46.270">           }</span>
<a href="#l46.271"></a><span id="l46.271"> </span>
<a href="#l46.272"></a><span id="l46.272">           // If the user parted from this room earlier, confirm the rejoin.</span>
<a href="#l46.273"></a><span id="l46.273">           if (conversation._rejoined) {</span>
<a href="#l46.274"></a><span id="l46.274" class="difflineminus">-            conversation.writeMessage(aMessage.origin, _(&quot;message.rejoined&quot;),</span>
<a href="#l46.275"></a><span id="l46.275" class="difflineminus">-                                      {system: true});</span>
<a href="#l46.276"></a><span id="l46.276" class="difflineplus">+            conversation.writeMessage(aMessage.origin, _(&quot;message.rejoined&quot;), {</span>
<a href="#l46.277"></a><span id="l46.277" class="difflineplus">+              system: true,</span>
<a href="#l46.278"></a><span id="l46.278" class="difflineplus">+            });</span>
<a href="#l46.279"></a><span id="l46.279">             delete conversation._rejoined;</span>
<a href="#l46.280"></a><span id="l46.280">           }</span>
<a href="#l46.281"></a><span id="l46.281"> </span>
<a href="#l46.282"></a><span id="l46.282">           // Ensure chatRoomFields information is available for reconnection.</span>
<a href="#l46.283"></a><span id="l46.283">           if (!conversation.chatRoomFields) {</span>
<a href="#l46.284"></a><span id="l46.284" class="difflineminus">-            this.WARN(&quot;Opening a MUC without storing its &quot; +</span>
<a href="#l46.285"></a><span id="l46.285" class="difflineminus">-                      &quot;prplIChatRoomFieldValues first.&quot;);</span>
<a href="#l46.286"></a><span id="l46.286" class="difflineminus">-            conversation.chatRoomFields =</span>
<a href="#l46.287"></a><span id="l46.287" class="difflineminus">-              this.getChatRoomDefaultFieldValues(channelName);</span>
<a href="#l46.288"></a><span id="l46.288" class="difflineplus">+            this.WARN(</span>
<a href="#l46.289"></a><span id="l46.289" class="difflineplus">+              &quot;Opening a MUC without storing its &quot; +</span>
<a href="#l46.290"></a><span id="l46.290" class="difflineplus">+                &quot;prplIChatRoomFieldValues first.&quot;</span>
<a href="#l46.291"></a><span id="l46.291" class="difflineplus">+            );</span>
<a href="#l46.292"></a><span id="l46.292" class="difflineplus">+            conversation.chatRoomFields = this.getChatRoomDefaultFieldValues(</span>
<a href="#l46.293"></a><span id="l46.293" class="difflineplus">+              channelName</span>
<a href="#l46.294"></a><span id="l46.294" class="difflineplus">+            );</span>
<a href="#l46.295"></a><span id="l46.295">           }</span>
<a href="#l46.296"></a><span id="l46.296" class="difflineminus">-        }</span>
<a href="#l46.297"></a><span id="l46.297" class="difflineminus">-        else {</span>
<a href="#l46.298"></a><span id="l46.298" class="difflineplus">+        } else {</span>
<a href="#l46.299"></a><span id="l46.299">           // Don't worry about adding ourself, RPL_NAMREPLY takes care of that</span>
<a href="#l46.300"></a><span id="l46.300">           // case.</span>
<a href="#l46.301"></a><span id="l46.301">           conversation.getParticipant(aMessage.origin, true);</span>
<a href="#l46.302"></a><span id="l46.302">           let msg = _(&quot;message.join&quot;, aMessage.origin, aMessage.source);</span>
<a href="#l46.303"></a><span id="l46.303" class="difflineminus">-          conversation.writeMessage(aMessage.origin, msg, {system: true,</span>
<a href="#l46.304"></a><span id="l46.304" class="difflineminus">-                                                           noLinkification: true});</span>
<a href="#l46.305"></a><span id="l46.305" class="difflineplus">+          conversation.writeMessage(aMessage.origin, msg, {</span>
<a href="#l46.306"></a><span id="l46.306" class="difflineplus">+            system: true,</span>
<a href="#l46.307"></a><span id="l46.307" class="difflineplus">+            noLinkification: true,</span>
<a href="#l46.308"></a><span id="l46.308" class="difflineplus">+          });</span>
<a href="#l46.309"></a><span id="l46.309">         }</span>
<a href="#l46.310"></a><span id="l46.310">       }</span>
<a href="#l46.311"></a><span id="l46.311">       // If the joiner is a buddy, mark as online.</span>
<a href="#l46.312"></a><span id="l46.312">       let buddy = this.buddies.get(aMessage.origin);</span>
<a href="#l46.313"></a><span id="l46.313" class="difflineminus">-      if (buddy)</span>
<a href="#l46.314"></a><span id="l46.314" class="difflineplus">+      if (buddy) {</span>
<a href="#l46.315"></a><span id="l46.315">         buddy.setStatus(Ci.imIStatusInfo.STATUS_AVAILABLE, &quot;&quot;);</span>
<a href="#l46.316"></a><span id="l46.316" class="difflineplus">+      }</span>
<a href="#l46.317"></a><span id="l46.317">       return true;</span>
<a href="#l46.318"></a><span id="l46.318">     },</span>
<a href="#l46.319"></a><span id="l46.319" class="difflineminus">-    &quot;KICK&quot;: function(aMessage) {</span>
<a href="#l46.320"></a><span id="l46.320" class="difflineplus">+    KICK(aMessage) {</span>
<a href="#l46.321"></a><span id="l46.321">       // KICK &lt;channel&gt; *( &quot;,&quot; &lt;channel&gt; ) &lt;user&gt; *( &quot;,&quot; &lt;user&gt; ) [&lt;comment&gt;]</span>
<a href="#l46.322"></a><span id="l46.322">       let comment = aMessage.params.length == 3 ? aMessage.params[2] : null;</span>
<a href="#l46.323"></a><span id="l46.323">       // Some servers (moznet) send the kicker as the comment.</span>
<a href="#l46.324"></a><span id="l46.324" class="difflineminus">-      if (comment == aMessage.origin)</span>
<a href="#l46.325"></a><span id="l46.325" class="difflineplus">+      if (comment == aMessage.origin) {</span>
<a href="#l46.326"></a><span id="l46.326">         comment = null;</span>
<a href="#l46.327"></a><span id="l46.327" class="difflineminus">-      return leftRoom(this, aMessage.params[1].split(&quot;,&quot;),</span>
<a href="#l46.328"></a><span id="l46.328" class="difflineminus">-                      aMessage.params[0].split(&quot;,&quot;), aMessage.origin, comment,</span>
<a href="#l46.329"></a><span id="l46.329" class="difflineminus">-                      true);</span>
<a href="#l46.330"></a><span id="l46.330" class="difflineplus">+      }</span>
<a href="#l46.331"></a><span id="l46.331" class="difflineplus">+      return leftRoom(</span>
<a href="#l46.332"></a><span id="l46.332" class="difflineplus">+        this,</span>
<a href="#l46.333"></a><span id="l46.333" class="difflineplus">+        aMessage.params[1].split(&quot;,&quot;),</span>
<a href="#l46.334"></a><span id="l46.334" class="difflineplus">+        aMessage.params[0].split(&quot;,&quot;),</span>
<a href="#l46.335"></a><span id="l46.335" class="difflineplus">+        aMessage.origin,</span>
<a href="#l46.336"></a><span id="l46.336" class="difflineplus">+        comment,</span>
<a href="#l46.337"></a><span id="l46.337" class="difflineplus">+        true</span>
<a href="#l46.338"></a><span id="l46.338" class="difflineplus">+      );</span>
<a href="#l46.339"></a><span id="l46.339">     },</span>
<a href="#l46.340"></a><span id="l46.340" class="difflineminus">-    &quot;MODE&quot;: function(aMessage) {</span>
<a href="#l46.341"></a><span id="l46.341" class="difflineplus">+    MODE(aMessage) {</span>
<a href="#l46.342"></a><span id="l46.342">       // MODE &lt;nickname&gt; *( ( &quot;+&quot; / &quot;-&quot;) *( &quot;i&quot; / &quot;w&quot; / &quot;o&quot; / &quot;O&quot; / &quot;r&quot; ) )</span>
<a href="#l46.343"></a><span id="l46.343">       // MODE &lt;channel&gt; *( ( &quot;-&quot; / &quot;+&quot; ) *&lt;modes&gt; *&lt;modeparams&gt; )</span>
<a href="#l46.344"></a><span id="l46.344">       if (this.isMUCName(aMessage.params[0])) {</span>
<a href="#l46.345"></a><span id="l46.345">         // If the first parameter is a channel name, a channel/participant mode</span>
<a href="#l46.346"></a><span id="l46.346">         // was updated.</span>
<a href="#l46.347"></a><span id="l46.347" class="difflineminus">-        this.getConversation(aMessage.params[0])</span>
<a href="#l46.348"></a><span id="l46.348" class="difflineminus">-            .setMode(aMessage.params[1], aMessage.params.slice(2),</span>
<a href="#l46.349"></a><span id="l46.349" class="difflineminus">-                     aMessage.origin);</span>
<a href="#l46.350"></a><span id="l46.350" class="difflineplus">+        this.getConversation(aMessage.params[0]).setMode(</span>
<a href="#l46.351"></a><span id="l46.351" class="difflineplus">+          aMessage.params[1],</span>
<a href="#l46.352"></a><span id="l46.352" class="difflineplus">+          aMessage.params.slice(2),</span>
<a href="#l46.353"></a><span id="l46.353" class="difflineplus">+          aMessage.origin</span>
<a href="#l46.354"></a><span id="l46.354" class="difflineplus">+        );</span>
<a href="#l46.355"></a><span id="l46.355"> </span>
<a href="#l46.356"></a><span id="l46.356">         return true;</span>
<a href="#l46.357"></a><span id="l46.357">       }</span>
<a href="#l46.358"></a><span id="l46.358"> </span>
<a href="#l46.359"></a><span id="l46.359">       // Otherwise the user's own mode is being returned to them.</span>
<a href="#l46.360"></a><span id="l46.360" class="difflineminus">-      return this.setUserMode(aMessage.params[0], aMessage.params[1],</span>
<a href="#l46.361"></a><span id="l46.361" class="difflineminus">-                              aMessage.origin, !this._userModeReceived);</span>
<a href="#l46.362"></a><span id="l46.362" class="difflineplus">+      return this.setUserMode(</span>
<a href="#l46.363"></a><span id="l46.363" class="difflineplus">+        aMessage.params[0],</span>
<a href="#l46.364"></a><span id="l46.364" class="difflineplus">+        aMessage.params[1],</span>
<a href="#l46.365"></a><span id="l46.365" class="difflineplus">+        aMessage.origin,</span>
<a href="#l46.366"></a><span id="l46.366" class="difflineplus">+        !this._userModeReceived</span>
<a href="#l46.367"></a><span id="l46.367" class="difflineplus">+      );</span>
<a href="#l46.368"></a><span id="l46.368">     },</span>
<a href="#l46.369"></a><span id="l46.369" class="difflineminus">-    &quot;NICK&quot;: function(aMessage) {</span>
<a href="#l46.370"></a><span id="l46.370" class="difflineplus">+    NICK(aMessage) {</span>
<a href="#l46.371"></a><span id="l46.371">       // NICK &lt;nickname&gt;</span>
<a href="#l46.372"></a><span id="l46.372">       this.changeBuddyNick(aMessage.origin, aMessage.params[0]);</span>
<a href="#l46.373"></a><span id="l46.373">       return true;</span>
<a href="#l46.374"></a><span id="l46.374">     },</span>
<a href="#l46.375"></a><span id="l46.375" class="difflineminus">-    &quot;NOTICE&quot;: function(aMessage) {</span>
<a href="#l46.376"></a><span id="l46.376" class="difflineplus">+    NOTICE(aMessage) {</span>
<a href="#l46.377"></a><span id="l46.377">       // NOTICE &lt;msgtarget&gt; &lt;text&gt;</span>
<a href="#l46.378"></a><span id="l46.378">       // If the message is from the server, don't show it unless the user wants</span>
<a href="#l46.379"></a><span id="l46.379">       // to see it.</span>
<a href="#l46.380"></a><span id="l46.380" class="difflineminus">-      if (!this.connected || aMessage.origin == this._currentServerName)</span>
<a href="#l46.381"></a><span id="l46.381" class="difflineplus">+      if (!this.connected || aMessage.origin == this._currentServerName) {</span>
<a href="#l46.382"></a><span id="l46.382">         return serverMessage(this, aMessage);</span>
<a href="#l46.383"></a><span id="l46.383" class="difflineplus">+      }</span>
<a href="#l46.384"></a><span id="l46.384">       return privmsg(this, aMessage, true);</span>
<a href="#l46.385"></a><span id="l46.385">     },</span>
<a href="#l46.386"></a><span id="l46.386" class="difflineminus">-    &quot;PART&quot;: function(aMessage) {</span>
<a href="#l46.387"></a><span id="l46.387" class="difflineplus">+    PART(aMessage) {</span>
<a href="#l46.388"></a><span id="l46.388">       // PART &lt;channel&gt; *( &quot;,&quot; &lt;channel&gt; ) [ &lt;Part Message&gt; ]</span>
<a href="#l46.389"></a><span id="l46.389" class="difflineminus">-      return leftRoom(this, [aMessage.origin], aMessage.params[0].split(&quot;,&quot;),</span>
<a href="#l46.390"></a><span id="l46.390" class="difflineminus">-                      aMessage.source,</span>
<a href="#l46.391"></a><span id="l46.391" class="difflineminus">-                      aMessage.params.length == 2 ? aMessage.params[1] : null);</span>
<a href="#l46.392"></a><span id="l46.392" class="difflineplus">+      return leftRoom(</span>
<a href="#l46.393"></a><span id="l46.393" class="difflineplus">+        this,</span>
<a href="#l46.394"></a><span id="l46.394" class="difflineplus">+        [aMessage.origin],</span>
<a href="#l46.395"></a><span id="l46.395" class="difflineplus">+        aMessage.params[0].split(&quot;,&quot;),</span>
<a href="#l46.396"></a><span id="l46.396" class="difflineplus">+        aMessage.source,</span>
<a href="#l46.397"></a><span id="l46.397" class="difflineplus">+        aMessage.params.length == 2 ? aMessage.params[1] : null</span>
<a href="#l46.398"></a><span id="l46.398" class="difflineplus">+      );</span>
<a href="#l46.399"></a><span id="l46.399">     },</span>
<a href="#l46.400"></a><span id="l46.400" class="difflineminus">-    &quot;PING&quot;: function(aMessage) {</span>
<a href="#l46.401"></a><span id="l46.401" class="difflineplus">+    PING(aMessage) {</span>
<a href="#l46.402"></a><span id="l46.402">       // PING &lt;server1&gt; [ &lt;server2&gt; ]</span>
<a href="#l46.403"></a><span id="l46.403">       // Keep the connection alive.</span>
<a href="#l46.404"></a><span id="l46.404">       this.sendMessage(&quot;PONG&quot;, aMessage.params[0]);</span>
<a href="#l46.405"></a><span id="l46.405">       return true;</span>
<a href="#l46.406"></a><span id="l46.406">     },</span>
<a href="#l46.407"></a><span id="l46.407" class="difflineminus">-    &quot;PONG&quot;: function(aMessage) {</span>
<a href="#l46.408"></a><span id="l46.408" class="difflineplus">+    PONG(aMessage) {</span>
<a href="#l46.409"></a><span id="l46.409">       // PONG &lt;server&gt; [ &lt;server2&gt; ]</span>
<a href="#l46.410"></a><span id="l46.410">       let pongTime = aMessage.params[1];</span>
<a href="#l46.411"></a><span id="l46.411"> </span>
<a href="#l46.412"></a><span id="l46.412">       // Ping to keep the connection alive.</span>
<a href="#l46.413"></a><span id="l46.413">       if (pongTime.startsWith(&quot;_&quot;)) {</span>
<a href="#l46.414"></a><span id="l46.414">         this._socket.cancelDisconnectTimer();</span>
<a href="#l46.415"></a><span id="l46.415">         return true;</span>
<a href="#l46.416"></a><span id="l46.416">       }</span>
<a href="#l46.417"></a><span id="l46.417">       // Otherwise, the ping was from a user command.</span>
<a href="#l46.418"></a><span id="l46.418">       return this.handlePingReply(aMessage.origin, pongTime);</span>
<a href="#l46.419"></a><span id="l46.419">     },</span>
<a href="#l46.420"></a><span id="l46.420" class="difflineminus">-    &quot;PRIVMSG&quot;: function(aMessage) {</span>
<a href="#l46.421"></a><span id="l46.421" class="difflineplus">+    PRIVMSG(aMessage) {</span>
<a href="#l46.422"></a><span id="l46.422">       // PRIVMSG &lt;msgtarget&gt; &lt;text to be sent&gt;</span>
<a href="#l46.423"></a><span id="l46.423">       // Display message in conversation</span>
<a href="#l46.424"></a><span id="l46.424">       return privmsg(this, aMessage);</span>
<a href="#l46.425"></a><span id="l46.425">     },</span>
<a href="#l46.426"></a><span id="l46.426" class="difflineminus">-    &quot;QUIT&quot;: function(aMessage) {</span>
<a href="#l46.427"></a><span id="l46.427" class="difflineplus">+    QUIT(aMessage) {</span>
<a href="#l46.428"></a><span id="l46.428">       // QUIT [ &lt; Quit Message&gt; ]</span>
<a href="#l46.429"></a><span id="l46.429">       // Some IRC servers automatically prefix a &quot;Quit: &quot; string. Remove the</span>
<a href="#l46.430"></a><span id="l46.430">       // duplication and use a localized version.</span>
<a href="#l46.431"></a><span id="l46.431">       let quitMsg = aMessage.params[0] || &quot;&quot;;</span>
<a href="#l46.432"></a><span id="l46.432" class="difflineminus">-      if (quitMsg.startsWith(&quot;Quit: &quot;))</span>
<a href="#l46.433"></a><span id="l46.433" class="difflineminus">-        quitMsg = quitMsg.slice(6); // &quot;Quit: &quot;.length</span>
<a href="#l46.434"></a><span id="l46.434" class="difflineplus">+      if (quitMsg.startsWith(&quot;Quit: &quot;)) {</span>
<a href="#l46.435"></a><span id="l46.435" class="difflineplus">+        quitMsg = quitMsg.slice(6);</span>
<a href="#l46.436"></a><span id="l46.436" class="difflineplus">+      } // &quot;Quit: &quot;.length</span>
<a href="#l46.437"></a><span id="l46.437">       // If a quit message was included, show it.</span>
<a href="#l46.438"></a><span id="l46.438">       let nick = aMessage.origin;</span>
<a href="#l46.439"></a><span id="l46.439" class="difflineminus">-      let msg = _(&quot;message.quit&quot;, nick,</span>
<a href="#l46.440"></a><span id="l46.440" class="difflineminus">-                  quitMsg.length ? _(&quot;message.quit2&quot;, quitMsg) : &quot;&quot;);</span>
<a href="#l46.441"></a><span id="l46.441" class="difflineplus">+      let msg = _(</span>
<a href="#l46.442"></a><span id="l46.442" class="difflineplus">+        &quot;message.quit&quot;,</span>
<a href="#l46.443"></a><span id="l46.443" class="difflineplus">+        nick,</span>
<a href="#l46.444"></a><span id="l46.444" class="difflineplus">+        quitMsg.length ? _(&quot;message.quit2&quot;, quitMsg) : &quot;&quot;</span>
<a href="#l46.445"></a><span id="l46.445" class="difflineplus">+      );</span>
<a href="#l46.446"></a><span id="l46.446">       // Loop over every conversation with the user and display that they quit.</span>
<a href="#l46.447"></a><span id="l46.447">       this.conversations.forEach(conversation =&gt; {</span>
<a href="#l46.448"></a><span id="l46.448">         if (conversation.isChat &amp;&amp; conversation._participants.has(nick)) {</span>
<a href="#l46.449"></a><span id="l46.449" class="difflineminus">-          conversation.writeMessage(nick, msg, {system: true});</span>
<a href="#l46.450"></a><span id="l46.450" class="difflineplus">+          conversation.writeMessage(nick, msg, { system: true });</span>
<a href="#l46.451"></a><span id="l46.451">           conversation.removeParticipant(nick);</span>
<a href="#l46.452"></a><span id="l46.452">         }</span>
<a href="#l46.453"></a><span id="l46.453">       });</span>
<a href="#l46.454"></a><span id="l46.454"> </span>
<a href="#l46.455"></a><span id="l46.455">       // Remove from the whois table.</span>
<a href="#l46.456"></a><span id="l46.456">       this.removeBuddyInfo(nick);</span>
<a href="#l46.457"></a><span id="l46.457"> </span>
<a href="#l46.458"></a><span id="l46.458">       // If the leaver is a buddy, mark as offline.</span>
<a href="#l46.459"></a><span id="l46.459">       let buddy = this.buddies.get(nick);</span>
<a href="#l46.460"></a><span id="l46.460" class="difflineminus">-      if (buddy)</span>
<a href="#l46.461"></a><span id="l46.461" class="difflineplus">+      if (buddy) {</span>
<a href="#l46.462"></a><span id="l46.462">         buddy.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l46.463"></a><span id="l46.463" class="difflineplus">+      }</span>
<a href="#l46.464"></a><span id="l46.464"> </span>
<a href="#l46.465"></a><span id="l46.465">       // If we wanted this nickname, grab it.</span>
<a href="#l46.466"></a><span id="l46.466">       if (nick == this._requestedNickname &amp;&amp; nick != this._nickname) {</span>
<a href="#l46.467"></a><span id="l46.467">         this.changeNick(this._requestedNickname);</span>
<a href="#l46.468"></a><span id="l46.468">         clearTimeout(this._nickInUseTimeout);</span>
<a href="#l46.469"></a><span id="l46.469">         delete this._nickInUseTimeout;</span>
<a href="#l46.470"></a><span id="l46.470">       }</span>
<a href="#l46.471"></a><span id="l46.471">       return true;</span>
<a href="#l46.472"></a><span id="l46.472">     },</span>
<a href="#l46.473"></a><span id="l46.473" class="difflineminus">-    &quot;SQUIT&quot;: function(aMessage) {</span>
<a href="#l46.474"></a><span id="l46.474" class="difflineplus">+    SQUIT(aMessage) {</span>
<a href="#l46.475"></a><span id="l46.475">       // &lt;server&gt; &lt;comment&gt;</span>
<a href="#l46.476"></a><span id="l46.476">       return true;</span>
<a href="#l46.477"></a><span id="l46.477">     },</span>
<a href="#l46.478"></a><span id="l46.478" class="difflineminus">-    &quot;TOPIC&quot;: function(aMessage) {</span>
<a href="#l46.479"></a><span id="l46.479" class="difflineplus">+    TOPIC(aMessage) {</span>
<a href="#l46.480"></a><span id="l46.480">       // TOPIC &lt;channel&gt; [ &lt;topic&gt; ]</span>
<a href="#l46.481"></a><span id="l46.481">       // Show topic as a message.</span>
<a href="#l46.482"></a><span id="l46.482">       let conversation = this.getConversation(aMessage.params[0]);</span>
<a href="#l46.483"></a><span id="l46.483">       let topic = aMessage.params[1];</span>
<a href="#l46.484"></a><span id="l46.484">       // Set the topic in the conversation and update the UI.</span>
<a href="#l46.485"></a><span id="l46.485" class="difflineminus">-      conversation.setTopic(topic ? ctcpFormatToText(topic) : &quot;&quot;,</span>
<a href="#l46.486"></a><span id="l46.486" class="difflineminus">-                            aMessage.origin);</span>
<a href="#l46.487"></a><span id="l46.487" class="difflineplus">+      conversation.setTopic(</span>
<a href="#l46.488"></a><span id="l46.488" class="difflineplus">+        topic ? ctcpFormatToText(topic) : &quot;&quot;,</span>
<a href="#l46.489"></a><span id="l46.489" class="difflineplus">+        aMessage.origin</span>
<a href="#l46.490"></a><span id="l46.490" class="difflineplus">+      );</span>
<a href="#l46.491"></a><span id="l46.491">       return true;</span>
<a href="#l46.492"></a><span id="l46.492">     },</span>
<a href="#l46.493"></a><span id="l46.493" class="difflineminus">-    &quot;001&quot;: function(aMessage) { // RPL_WELCOME</span>
<a href="#l46.494"></a><span id="l46.494" class="difflineplus">+    &quot;001&quot;: function(aMessage) {</span>
<a href="#l46.495"></a><span id="l46.495" class="difflineplus">+      // RPL_WELCOME</span>
<a href="#l46.496"></a><span id="l46.496">       // Welcome to the Internet Relay Network &lt;nick&gt;!&lt;user&gt;@&lt;host&gt;</span>
<a href="#l46.497"></a><span id="l46.497">       this._socket.resetPingTimer();</span>
<a href="#l46.498"></a><span id="l46.498">       // This seems a little strange, but we don't differentiate between a</span>
<a href="#l46.499"></a><span id="l46.499">       // nickname and the servername since it can be ambiguous.</span>
<a href="#l46.500"></a><span id="l46.500">       this._currentServerName = aMessage.origin;</span>
<a href="#l46.501"></a><span id="l46.501"> </span>
<a href="#l46.502"></a><span id="l46.502">       // Clear user mode.</span>
<a href="#l46.503"></a><span id="l46.503">       this._modes = new Set();</span>
<a href="#l46.504"></a><span id="l46.504">       this._userModeReceived = false;</span>
<a href="#l46.505"></a><span id="l46.505"> </span>
<a href="#l46.506"></a><span id="l46.506">       // Check if autoUserMode is set in the account preferences. If it is set,</span>
<a href="#l46.507"></a><span id="l46.507">       // then notify the server that the user wants a specific mode.</span>
<a href="#l46.508"></a><span id="l46.508">       if (this.prefs.prefHasUserValue(&quot;autoUserMode&quot;)) {</span>
<a href="#l46.509"></a><span id="l46.509" class="difflineminus">-        this.sendMessage(&quot;MODE&quot;,</span>
<a href="#l46.510"></a><span id="l46.510" class="difflineminus">-                         [this._nickname, this.getString(&quot;autoUserMode&quot;)]);</span>
<a href="#l46.511"></a><span id="l46.511" class="difflineplus">+        this.sendMessage(&quot;MODE&quot;, [</span>
<a href="#l46.512"></a><span id="l46.512" class="difflineplus">+          this._nickname,</span>
<a href="#l46.513"></a><span id="l46.513" class="difflineplus">+          this.getString(&quot;autoUserMode&quot;),</span>
<a href="#l46.514"></a><span id="l46.514" class="difflineplus">+        ]);</span>
<a href="#l46.515"></a><span id="l46.515">       }</span>
<a href="#l46.516"></a><span id="l46.516"> </span>
<a href="#l46.517"></a><span id="l46.517">       // Check if our nick has changed.</span>
<a href="#l46.518"></a><span id="l46.518" class="difflineminus">-      if (aMessage.params[0] != this._nickname)</span>
<a href="#l46.519"></a><span id="l46.519" class="difflineplus">+      if (aMessage.params[0] != this._nickname) {</span>
<a href="#l46.520"></a><span id="l46.520">         this.changeBuddyNick(this._nickname, aMessage.params[0]);</span>
<a href="#l46.521"></a><span id="l46.521" class="difflineplus">+      }</span>
<a href="#l46.522"></a><span id="l46.522"> </span>
<a href="#l46.523"></a><span id="l46.523">       // Request our own whois entry so we can set the prefix.</span>
<a href="#l46.524"></a><span id="l46.524">       this.requestCurrentWhois(this._nickname);</span>
<a href="#l46.525"></a><span id="l46.525"> </span>
<a href="#l46.526"></a><span id="l46.526">       // If our status is Unavailable, tell the server.</span>
<a href="#l46.527"></a><span id="l46.527" class="difflineminus">-      if (this.imAccount.statusInfo.statusType &lt; Ci.imIStatusInfo.STATUS_AVAILABLE)</span>
<a href="#l46.528"></a><span id="l46.528" class="difflineplus">+      if (</span>
<a href="#l46.529"></a><span id="l46.529" class="difflineplus">+        this.imAccount.statusInfo.statusType &lt; Ci.imIStatusInfo.STATUS_AVAILABLE</span>
<a href="#l46.530"></a><span id="l46.530" class="difflineplus">+      ) {</span>
<a href="#l46.531"></a><span id="l46.531">         this.observe(null, &quot;status-changed&quot;);</span>
<a href="#l46.532"></a><span id="l46.532" class="difflineplus">+      }</span>
<a href="#l46.533"></a><span id="l46.533"> </span>
<a href="#l46.534"></a><span id="l46.534">       // Check if any of our buddies are online!</span>
<a href="#l46.535"></a><span id="l46.535">       const kInitialIsOnDelay = 1000;</span>
<a href="#l46.536"></a><span id="l46.536">       this._isOnTimer = setTimeout(this.sendIsOn.bind(this), kInitialIsOnDelay);</span>
<a href="#l46.537"></a><span id="l46.537"> </span>
<a href="#l46.538"></a><span id="l46.538">       // If we didn't handle all the CAPs we added, something is wrong.</span>
<a href="#l46.539"></a><span id="l46.539" class="difflineminus">-      if (this._caps.size)</span>
<a href="#l46.540"></a><span id="l46.540" class="difflineplus">+      if (this._caps.size) {</span>
<a href="#l46.541"></a><span id="l46.541">         this.ERROR(&quot;Connected without removing CAPs: &quot; + [...this._caps]);</span>
<a href="#l46.542"></a><span id="l46.542" class="difflineplus">+      }</span>
<a href="#l46.543"></a><span id="l46.543"> </span>
<a href="#l46.544"></a><span id="l46.544">       // Done!</span>
<a href="#l46.545"></a><span id="l46.545">       this.reportConnected();</span>
<a href="#l46.546"></a><span id="l46.546">       return serverMessage(this, aMessage);</span>
<a href="#l46.547"></a><span id="l46.547">     },</span>
<a href="#l46.548"></a><span id="l46.548" class="difflineminus">-    &quot;002&quot;: function(aMessage) { // RPL_YOURHOST</span>
<a href="#l46.549"></a><span id="l46.549" class="difflineplus">+    &quot;002&quot;: function(aMessage) {</span>
<a href="#l46.550"></a><span id="l46.550" class="difflineplus">+      // RPL_YOURHOST</span>
<a href="#l46.551"></a><span id="l46.551">       // Your host is &lt;servername&gt;, running version &lt;ver&gt;</span>
<a href="#l46.552"></a><span id="l46.552">       return serverMessage(this, aMessage);</span>
<a href="#l46.553"></a><span id="l46.553">     },</span>
<a href="#l46.554"></a><span id="l46.554" class="difflineminus">-    &quot;003&quot;: function(aMessage) { // RPL_CREATED</span>
<a href="#l46.555"></a><span id="l46.555" class="difflineplus">+    &quot;003&quot;: function(aMessage) {</span>
<a href="#l46.556"></a><span id="l46.556" class="difflineplus">+      // RPL_CREATED</span>
<a href="#l46.557"></a><span id="l46.557">       // This server was created &lt;date&gt;</span>
<a href="#l46.558"></a><span id="l46.558">       // TODO parse this date and keep it for some reason? Do we care?</span>
<a href="#l46.559"></a><span id="l46.559">       return serverMessage(this, aMessage);</span>
<a href="#l46.560"></a><span id="l46.560">     },</span>
<a href="#l46.561"></a><span id="l46.561" class="difflineminus">-    &quot;004&quot;: function(aMessage) { // RPL_MYINFO</span>
<a href="#l46.562"></a><span id="l46.562" class="difflineplus">+    &quot;004&quot;: function(aMessage) {</span>
<a href="#l46.563"></a><span id="l46.563" class="difflineplus">+      // RPL_MYINFO</span>
<a href="#l46.564"></a><span id="l46.564">       // &lt;servername&gt; &lt;version&gt; &lt;available user modes&gt; &lt;available channel modes&gt;</span>
<a href="#l46.565"></a><span id="l46.565">       // TODO parse the available modes, let the UI respond and inform the user</span>
<a href="#l46.566"></a><span id="l46.566">       return serverMessage(this, aMessage);</span>
<a href="#l46.567"></a><span id="l46.567">     },</span>
<a href="#l46.568"></a><span id="l46.568" class="difflineminus">-    &quot;005&quot;: function(aMessage) { // RPL_BOUNCE</span>
<a href="#l46.569"></a><span id="l46.569" class="difflineplus">+    &quot;005&quot;: function(aMessage) {</span>
<a href="#l46.570"></a><span id="l46.570" class="difflineplus">+      // RPL_BOUNCE</span>
<a href="#l46.571"></a><span id="l46.571">       // Try server &lt;server name&gt;, port &lt;port number&gt;</span>
<a href="#l46.572"></a><span id="l46.572">       return serverMessage(this, aMessage);</span>
<a href="#l46.573"></a><span id="l46.573">     },</span>
<a href="#l46.574"></a><span id="l46.574"> </span>
<a href="#l46.575"></a><span id="l46.575">     /*</span>
<a href="#l46.576"></a><span id="l46.576">      * Handle response to TRACE message</span>
<a href="#l46.577"></a><span id="l46.577">      */</span>
<a href="#l46.578"></a><span id="l46.578" class="difflineminus">-    &quot;200&quot;: function(aMessage) { // RPL_TRACELINK</span>
<a href="#l46.579"></a><span id="l46.579" class="difflineplus">+    &quot;200&quot;: function(aMessage) {</span>
<a href="#l46.580"></a><span id="l46.580" class="difflineplus">+      // RPL_TRACELINK</span>
<a href="#l46.581"></a><span id="l46.581">       // Link &lt;version &amp; debug level&gt; &lt;destination&gt; &lt;next server&gt;</span>
<a href="#l46.582"></a><span id="l46.582">       // V&lt;protocol version&gt; &lt;link updateime in seconds&gt; &lt;backstream sendq&gt;</span>
<a href="#l46.583"></a><span id="l46.583">       // &lt;upstream sendq&gt;</span>
<a href="#l46.584"></a><span id="l46.584">       return serverMessage(this, aMessage);</span>
<a href="#l46.585"></a><span id="l46.585">     },</span>
<a href="#l46.586"></a><span id="l46.586" class="difflineminus">-    &quot;201&quot;: function(aMessage) { // RPL_TRACECONNECTING</span>
<a href="#l46.587"></a><span id="l46.587" class="difflineplus">+    &quot;201&quot;: function(aMessage) {</span>
<a href="#l46.588"></a><span id="l46.588" class="difflineplus">+      // RPL_TRACECONNECTING</span>
<a href="#l46.589"></a><span id="l46.589">       // Try. &lt;class&gt; &lt;server&gt;</span>
<a href="#l46.590"></a><span id="l46.590">       return serverMessage(this, aMessage);</span>
<a href="#l46.591"></a><span id="l46.591">     },</span>
<a href="#l46.592"></a><span id="l46.592" class="difflineminus">-    &quot;202&quot;: function(aMessage) { // RPL_TRACEHANDSHAKE</span>
<a href="#l46.593"></a><span id="l46.593" class="difflineplus">+    &quot;202&quot;: function(aMessage) {</span>
<a href="#l46.594"></a><span id="l46.594" class="difflineplus">+      // RPL_TRACEHANDSHAKE</span>
<a href="#l46.595"></a><span id="l46.595">       // H.S. &lt;class&gt; &lt;server&gt;</span>
<a href="#l46.596"></a><span id="l46.596">       return serverMessage(this, aMessage);</span>
<a href="#l46.597"></a><span id="l46.597">     },</span>
<a href="#l46.598"></a><span id="l46.598" class="difflineminus">-    &quot;203&quot;: function(aMessage) { // RPL_TRACEUNKNOWN</span>
<a href="#l46.599"></a><span id="l46.599" class="difflineplus">+    &quot;203&quot;: function(aMessage) {</span>
<a href="#l46.600"></a><span id="l46.600" class="difflineplus">+      // RPL_TRACEUNKNOWN</span>
<a href="#l46.601"></a><span id="l46.601">       // ???? &lt;class&gt; [&lt;client IP address in dot form&gt;]</span>
<a href="#l46.602"></a><span id="l46.602">       return serverMessage(this, aMessage);</span>
<a href="#l46.603"></a><span id="l46.603">     },</span>
<a href="#l46.604"></a><span id="l46.604" class="difflineminus">-    &quot;204&quot;: function(aMessage) { // RPL_TRACEOPERATOR</span>
<a href="#l46.605"></a><span id="l46.605" class="difflineplus">+    &quot;204&quot;: function(aMessage) {</span>
<a href="#l46.606"></a><span id="l46.606" class="difflineplus">+      // RPL_TRACEOPERATOR</span>
<a href="#l46.607"></a><span id="l46.607">       // Oper &lt;class&gt; &lt;nick&gt;</span>
<a href="#l46.608"></a><span id="l46.608">       return serverMessage(this, aMessage);</span>
<a href="#l46.609"></a><span id="l46.609">     },</span>
<a href="#l46.610"></a><span id="l46.610" class="difflineminus">-    &quot;205&quot;: function(aMessage) { // RPL_TRACEUSER</span>
<a href="#l46.611"></a><span id="l46.611" class="difflineplus">+    &quot;205&quot;: function(aMessage) {</span>
<a href="#l46.612"></a><span id="l46.612" class="difflineplus">+      // RPL_TRACEUSER</span>
<a href="#l46.613"></a><span id="l46.613">       // User &lt;class&gt; &lt;nick&gt;</span>
<a href="#l46.614"></a><span id="l46.614">       return serverMessage(this, aMessage);</span>
<a href="#l46.615"></a><span id="l46.615">     },</span>
<a href="#l46.616"></a><span id="l46.616" class="difflineminus">-    &quot;206&quot;: function(aMessage) { // RPL_TRACESERVER</span>
<a href="#l46.617"></a><span id="l46.617" class="difflineplus">+    &quot;206&quot;: function(aMessage) {</span>
<a href="#l46.618"></a><span id="l46.618" class="difflineplus">+      // RPL_TRACESERVER</span>
<a href="#l46.619"></a><span id="l46.619">       // Serv &lt;class&gt; &lt;int&gt;S &lt;int&gt;C &lt;server&gt; &lt;nick!user|*!*&gt;@&lt;host|server&gt;</span>
<a href="#l46.620"></a><span id="l46.620">       // V&lt;protocol version&gt;</span>
<a href="#l46.621"></a><span id="l46.621">       return serverMessage(this, aMessage);</span>
<a href="#l46.622"></a><span id="l46.622">     },</span>
<a href="#l46.623"></a><span id="l46.623" class="difflineminus">-    &quot;207&quot;: function(aMessage) { // RPL_TRACESERVICE</span>
<a href="#l46.624"></a><span id="l46.624" class="difflineplus">+    &quot;207&quot;: function(aMessage) {</span>
<a href="#l46.625"></a><span id="l46.625" class="difflineplus">+      // RPL_TRACESERVICE</span>
<a href="#l46.626"></a><span id="l46.626">       // Service &lt;class&gt; &lt;name&gt; &lt;type&gt; &lt;active type&gt;</span>
<a href="#l46.627"></a><span id="l46.627">       return serverMessage(this, aMessage);</span>
<a href="#l46.628"></a><span id="l46.628">     },</span>
<a href="#l46.629"></a><span id="l46.629" class="difflineminus">-    &quot;208&quot;: function(aMessage) { // RPL_TRACENEWTYPE</span>
<a href="#l46.630"></a><span id="l46.630" class="difflineplus">+    &quot;208&quot;: function(aMessage) {</span>
<a href="#l46.631"></a><span id="l46.631" class="difflineplus">+      // RPL_TRACENEWTYPE</span>
<a href="#l46.632"></a><span id="l46.632">       // &lt;newtype&gt; 0 &lt;client name&gt;</span>
<a href="#l46.633"></a><span id="l46.633">       return serverMessage(this, aMessage);</span>
<a href="#l46.634"></a><span id="l46.634">     },</span>
<a href="#l46.635"></a><span id="l46.635" class="difflineminus">-    &quot;209&quot;: function(aMessage) { // RPL_TRACECLASS</span>
<a href="#l46.636"></a><span id="l46.636" class="difflineplus">+    &quot;209&quot;: function(aMessage) {</span>
<a href="#l46.637"></a><span id="l46.637" class="difflineplus">+      // RPL_TRACECLASS</span>
<a href="#l46.638"></a><span id="l46.638">       // Class &lt;class&gt; &lt;count&gt;</span>
<a href="#l46.639"></a><span id="l46.639">       return serverMessage(this, aMessage);</span>
<a href="#l46.640"></a><span id="l46.640">     },</span>
<a href="#l46.641"></a><span id="l46.641" class="difflineminus">-    &quot;210&quot;: function(aMessage) { // RPL_TRACERECONNECTION</span>
<a href="#l46.642"></a><span id="l46.642" class="difflineplus">+    &quot;210&quot;: function(aMessage) {</span>
<a href="#l46.643"></a><span id="l46.643" class="difflineplus">+      // RPL_TRACERECONNECTION</span>
<a href="#l46.644"></a><span id="l46.644">       // Unused.</span>
<a href="#l46.645"></a><span id="l46.645">       return serverMessage(this, aMessage);</span>
<a href="#l46.646"></a><span id="l46.646">     },</span>
<a href="#l46.647"></a><span id="l46.647"> </span>
<a href="#l46.648"></a><span id="l46.648">     /*</span>
<a href="#l46.649"></a><span id="l46.649">      * Handle stats messages.</span>
<a href="#l46.650"></a><span id="l46.650">      **/</span>
<a href="#l46.651"></a><span id="l46.651" class="difflineminus">-    &quot;211&quot;: function(aMessage) { // RPL_STATSLINKINFO</span>
<a href="#l46.652"></a><span id="l46.652" class="difflineplus">+    &quot;211&quot;: function(aMessage) {</span>
<a href="#l46.653"></a><span id="l46.653" class="difflineplus">+      // RPL_STATSLINKINFO</span>
<a href="#l46.654"></a><span id="l46.654">       // &lt;linkname&gt; &lt;sendq&gt; &lt;sent messages&gt; &lt;sent Kbytes&gt; &lt;received messages&gt;</span>
<a href="#l46.655"></a><span id="l46.655">       // &lt;received Kbytes&gt; &lt;time open&gt;</span>
<a href="#l46.656"></a><span id="l46.656">       return serverMessage(this, aMessage);</span>
<a href="#l46.657"></a><span id="l46.657">     },</span>
<a href="#l46.658"></a><span id="l46.658" class="difflineminus">-    &quot;212&quot;: function(aMessage) { // RPL_STATSCOMMAND</span>
<a href="#l46.659"></a><span id="l46.659" class="difflineplus">+    &quot;212&quot;: function(aMessage) {</span>
<a href="#l46.660"></a><span id="l46.660" class="difflineplus">+      // RPL_STATSCOMMAND</span>
<a href="#l46.661"></a><span id="l46.661">       // &lt;command&gt; &lt;count&gt; &lt;byte count&gt; &lt;remote count&gt;</span>
<a href="#l46.662"></a><span id="l46.662">       return serverMessage(this, aMessage);</span>
<a href="#l46.663"></a><span id="l46.663">     },</span>
<a href="#l46.664"></a><span id="l46.664" class="difflineminus">-    &quot;213&quot;: function(aMessage) { // RPL_STATSCLINE</span>
<a href="#l46.665"></a><span id="l46.665" class="difflineplus">+    &quot;213&quot;: function(aMessage) {</span>
<a href="#l46.666"></a><span id="l46.666" class="difflineplus">+      // RPL_STATSCLINE</span>
<a href="#l46.667"></a><span id="l46.667">       // Non-generic</span>
<a href="#l46.668"></a><span id="l46.668">       return serverMessage(this, aMessage);</span>
<a href="#l46.669"></a><span id="l46.669">     },</span>
<a href="#l46.670"></a><span id="l46.670" class="difflineminus">-    &quot;214&quot;: function(aMessage) { // RPL_STATSNLINE</span>
<a href="#l46.671"></a><span id="l46.671" class="difflineplus">+    &quot;214&quot;: function(aMessage) {</span>
<a href="#l46.672"></a><span id="l46.672" class="difflineplus">+      // RPL_STATSNLINE</span>
<a href="#l46.673"></a><span id="l46.673">       // Non-generic</span>
<a href="#l46.674"></a><span id="l46.674">       return serverMessage(this, aMessage);</span>
<a href="#l46.675"></a><span id="l46.675">     },</span>
<a href="#l46.676"></a><span id="l46.676" class="difflineminus">-    &quot;215&quot;: function(aMessage) { // RPL_STATSILINE</span>
<a href="#l46.677"></a><span id="l46.677" class="difflineplus">+    &quot;215&quot;: function(aMessage) {</span>
<a href="#l46.678"></a><span id="l46.678" class="difflineplus">+      // RPL_STATSILINE</span>
<a href="#l46.679"></a><span id="l46.679">       // Non-generic</span>
<a href="#l46.680"></a><span id="l46.680">       return serverMessage(this, aMessage);</span>
<a href="#l46.681"></a><span id="l46.681">     },</span>
<a href="#l46.682"></a><span id="l46.682" class="difflineminus">-    &quot;216&quot;: function(aMessage) { // RPL_STATSKLINE</span>
<a href="#l46.683"></a><span id="l46.683" class="difflineplus">+    &quot;216&quot;: function(aMessage) {</span>
<a href="#l46.684"></a><span id="l46.684" class="difflineplus">+      // RPL_STATSKLINE</span>
<a href="#l46.685"></a><span id="l46.685">       // Non-generic</span>
<a href="#l46.686"></a><span id="l46.686">       return serverMessage(this, aMessage);</span>
<a href="#l46.687"></a><span id="l46.687">     },</span>
<a href="#l46.688"></a><span id="l46.688" class="difflineminus">-    &quot;217&quot;: function(aMessage) { // RPL_STATSQLINE</span>
<a href="#l46.689"></a><span id="l46.689" class="difflineplus">+    &quot;217&quot;: function(aMessage) {</span>
<a href="#l46.690"></a><span id="l46.690" class="difflineplus">+      // RPL_STATSQLINE</span>
<a href="#l46.691"></a><span id="l46.691">       // Non-generic</span>
<a href="#l46.692"></a><span id="l46.692">       return serverMessage(this, aMessage);</span>
<a href="#l46.693"></a><span id="l46.693">     },</span>
<a href="#l46.694"></a><span id="l46.694" class="difflineminus">-    &quot;218&quot;: function(aMessage) { // RPL_STATSYLINE</span>
<a href="#l46.695"></a><span id="l46.695" class="difflineplus">+    &quot;218&quot;: function(aMessage) {</span>
<a href="#l46.696"></a><span id="l46.696" class="difflineplus">+      // RPL_STATSYLINE</span>
<a href="#l46.697"></a><span id="l46.697">       // Non-generic</span>
<a href="#l46.698"></a><span id="l46.698">       return serverMessage(this, aMessage);</span>
<a href="#l46.699"></a><span id="l46.699">     },</span>
<a href="#l46.700"></a><span id="l46.700" class="difflineminus">-    &quot;219&quot;: function(aMessage) { // RPL_ENDOFSTATS</span>
<a href="#l46.701"></a><span id="l46.701" class="difflineplus">+    &quot;219&quot;: function(aMessage) {</span>
<a href="#l46.702"></a><span id="l46.702" class="difflineplus">+      // RPL_ENDOFSTATS</span>
<a href="#l46.703"></a><span id="l46.703">       // &lt;stats letter&gt; :End of STATS report</span>
<a href="#l46.704"></a><span id="l46.704">       return serverMessage(this, aMessage);</span>
<a href="#l46.705"></a><span id="l46.705">     },</span>
<a href="#l46.706"></a><span id="l46.706"> </span>
<a href="#l46.707"></a><span id="l46.707" class="difflineminus">-    &quot;221&quot;: function(aMessage) { // RPL_UMODEIS</span>
<a href="#l46.708"></a><span id="l46.708" class="difflineplus">+    &quot;221&quot;: function(aMessage) {</span>
<a href="#l46.709"></a><span id="l46.709" class="difflineplus">+      // RPL_UMODEIS</span>
<a href="#l46.710"></a><span id="l46.710">       // &lt;user mode string&gt;</span>
<a href="#l46.711"></a><span id="l46.711" class="difflineminus">-      return this.setUserMode(aMessage.params[0], aMessage.params[1],</span>
<a href="#l46.712"></a><span id="l46.712" class="difflineminus">-                              aMessage.origin, true);</span>
<a href="#l46.713"></a><span id="l46.713" class="difflineplus">+      return this.setUserMode(</span>
<a href="#l46.714"></a><span id="l46.714" class="difflineplus">+        aMessage.params[0],</span>
<a href="#l46.715"></a><span id="l46.715" class="difflineplus">+        aMessage.params[1],</span>
<a href="#l46.716"></a><span id="l46.716" class="difflineplus">+        aMessage.origin,</span>
<a href="#l46.717"></a><span id="l46.717" class="difflineplus">+        true</span>
<a href="#l46.718"></a><span id="l46.718" class="difflineplus">+      );</span>
<a href="#l46.719"></a><span id="l46.719">     },</span>
<a href="#l46.720"></a><span id="l46.720"> </span>
<a href="#l46.721"></a><span id="l46.721">     /*</span>
<a href="#l46.722"></a><span id="l46.722">      * Services</span>
<a href="#l46.723"></a><span id="l46.723">      */</span>
<a href="#l46.724"></a><span id="l46.724" class="difflineminus">-    &quot;231&quot;: function(aMessage) { // RPL_SERVICEINFO</span>
<a href="#l46.725"></a><span id="l46.725" class="difflineplus">+    &quot;231&quot;: function(aMessage) {</span>
<a href="#l46.726"></a><span id="l46.726" class="difflineplus">+      // RPL_SERVICEINFO</span>
<a href="#l46.727"></a><span id="l46.727">       // Non-generic</span>
<a href="#l46.728"></a><span id="l46.728">       return serverMessage(this, aMessage);</span>
<a href="#l46.729"></a><span id="l46.729">     },</span>
<a href="#l46.730"></a><span id="l46.730" class="difflineminus">-    &quot;232&quot;: function(aMessage) { // RPL_ENDOFSERVICES</span>
<a href="#l46.731"></a><span id="l46.731" class="difflineplus">+    &quot;232&quot;: function(aMessage) {</span>
<a href="#l46.732"></a><span id="l46.732" class="difflineplus">+      // RPL_ENDOFSERVICES</span>
<a href="#l46.733"></a><span id="l46.733">       // Non-generic</span>
<a href="#l46.734"></a><span id="l46.734">       return serverMessage(this, aMessage);</span>
<a href="#l46.735"></a><span id="l46.735">     },</span>
<a href="#l46.736"></a><span id="l46.736" class="difflineminus">-    &quot;233&quot;: function(aMessage) { // RPL_SERVICE</span>
<a href="#l46.737"></a><span id="l46.737" class="difflineplus">+    &quot;233&quot;: function(aMessage) {</span>
<a href="#l46.738"></a><span id="l46.738" class="difflineplus">+      // RPL_SERVICE</span>
<a href="#l46.739"></a><span id="l46.739">       // Non-generic</span>
<a href="#l46.740"></a><span id="l46.740">       return serverMessage(this, aMessage);</span>
<a href="#l46.741"></a><span id="l46.741">     },</span>
<a href="#l46.742"></a><span id="l46.742"> </span>
<a href="#l46.743"></a><span id="l46.743">     /*</span>
<a href="#l46.744"></a><span id="l46.744">      * Server</span>
<a href="#l46.745"></a><span id="l46.745">      */</span>
<a href="#l46.746"></a><span id="l46.746" class="difflineminus">-    &quot;234&quot;: function(aMessage) { // RPL_SERVLIST</span>
<a href="#l46.747"></a><span id="l46.747" class="difflineplus">+    &quot;234&quot;: function(aMessage) {</span>
<a href="#l46.748"></a><span id="l46.748" class="difflineplus">+      // RPL_SERVLIST</span>
<a href="#l46.749"></a><span id="l46.749">       // &lt;name&gt; &lt;server&gt; &lt;mask&gt; &lt;type&gt; &lt;hopcount&gt; &lt;info&gt;</span>
<a href="#l46.750"></a><span id="l46.750">       return serverMessage(this, aMessage);</span>
<a href="#l46.751"></a><span id="l46.751">     },</span>
<a href="#l46.752"></a><span id="l46.752" class="difflineminus">-    &quot;235&quot;: function(aMessage) { // RPL_SERVLISTEND</span>
<a href="#l46.753"></a><span id="l46.753" class="difflineplus">+    &quot;235&quot;: function(aMessage) {</span>
<a href="#l46.754"></a><span id="l46.754" class="difflineplus">+      // RPL_SERVLISTEND</span>
<a href="#l46.755"></a><span id="l46.755">       // &lt;mask&gt; &lt;type&gt; :End of service listing</span>
<a href="#l46.756"></a><span id="l46.756">       return serverMessage(this, aMessage, true);</span>
<a href="#l46.757"></a><span id="l46.757">     },</span>
<a href="#l46.758"></a><span id="l46.758"> </span>
<a href="#l46.759"></a><span id="l46.759">     /*</span>
<a href="#l46.760"></a><span id="l46.760">      * Stats</span>
<a href="#l46.761"></a><span id="l46.761">      * TODO some of these have real information we could try to parse.</span>
<a href="#l46.762"></a><span id="l46.762">      */</span>
<a href="#l46.763"></a><span id="l46.763" class="difflineminus">-    &quot;240&quot;: function(aMessage) { // RPL_STATSVLINE</span>
<a href="#l46.764"></a><span id="l46.764" class="difflineplus">+    &quot;240&quot;: function(aMessage) {</span>
<a href="#l46.765"></a><span id="l46.765" class="difflineplus">+      // RPL_STATSVLINE</span>
<a href="#l46.766"></a><span id="l46.766">       // Non-generic</span>
<a href="#l46.767"></a><span id="l46.767">       return serverMessage(this, aMessage);</span>
<a href="#l46.768"></a><span id="l46.768">     },</span>
<a href="#l46.769"></a><span id="l46.769" class="difflineminus">-    &quot;241&quot;: function(aMessage) { // RPL_STATSLLINE</span>
<a href="#l46.770"></a><span id="l46.770" class="difflineplus">+    &quot;241&quot;: function(aMessage) {</span>
<a href="#l46.771"></a><span id="l46.771" class="difflineplus">+      // RPL_STATSLLINE</span>
<a href="#l46.772"></a><span id="l46.772">       // Non-generic</span>
<a href="#l46.773"></a><span id="l46.773">       return serverMessage(this, aMessage);</span>
<a href="#l46.774"></a><span id="l46.774">     },</span>
<a href="#l46.775"></a><span id="l46.775" class="difflineminus">-    &quot;242&quot;: function(aMessage) { // RPL_STATSUPTIME</span>
<a href="#l46.776"></a><span id="l46.776" class="difflineplus">+    &quot;242&quot;: function(aMessage) {</span>
<a href="#l46.777"></a><span id="l46.777" class="difflineplus">+      // RPL_STATSUPTIME</span>
<a href="#l46.778"></a><span id="l46.778">       // :Server Up %d days %d:%02d:%02d</span>
<a href="#l46.779"></a><span id="l46.779">       return serverMessage(this, aMessage);</span>
<a href="#l46.780"></a><span id="l46.780">     },</span>
<a href="#l46.781"></a><span id="l46.781" class="difflineminus">-    &quot;243&quot;: function(aMessage) { // RPL_STATSOLINE</span>
<a href="#l46.782"></a><span id="l46.782" class="difflineplus">+    &quot;243&quot;: function(aMessage) {</span>
<a href="#l46.783"></a><span id="l46.783" class="difflineplus">+      // RPL_STATSOLINE</span>
<a href="#l46.784"></a><span id="l46.784">       // O &lt;hostmask&gt; * &lt;name&gt;</span>
<a href="#l46.785"></a><span id="l46.785">       return serverMessage(this, aMessage);</span>
<a href="#l46.786"></a><span id="l46.786">     },</span>
<a href="#l46.787"></a><span id="l46.787" class="difflineminus">-    &quot;244&quot;: function(aMessage) { // RPL_STATSHLINE</span>
<a href="#l46.788"></a><span id="l46.788" class="difflineplus">+    &quot;244&quot;: function(aMessage) {</span>
<a href="#l46.789"></a><span id="l46.789" class="difflineplus">+      // RPL_STATSHLINE</span>
<a href="#l46.790"></a><span id="l46.790">       // Non-generic</span>
<a href="#l46.791"></a><span id="l46.791">       return serverMessage(this, aMessage);</span>
<a href="#l46.792"></a><span id="l46.792">     },</span>
<a href="#l46.793"></a><span id="l46.793" class="difflineminus">-    &quot;245&quot;: function(aMessage) { // RPL_STATSSLINE</span>
<a href="#l46.794"></a><span id="l46.794" class="difflineplus">+    &quot;245&quot;: function(aMessage) {</span>
<a href="#l46.795"></a><span id="l46.795" class="difflineplus">+      // RPL_STATSSLINE</span>
<a href="#l46.796"></a><span id="l46.796">       // Non-generic</span>
<a href="#l46.797"></a><span id="l46.797">       // Note that this is given as 244 in RFC 2812, this seems to be incorrect.</span>
<a href="#l46.798"></a><span id="l46.798">       return serverMessage(this, aMessage);</span>
<a href="#l46.799"></a><span id="l46.799">     },</span>
<a href="#l46.800"></a><span id="l46.800" class="difflineminus">-    &quot;246&quot;: function(aMessage) { // RPL_STATSPING</span>
<a href="#l46.801"></a><span id="l46.801" class="difflineplus">+    &quot;246&quot;: function(aMessage) {</span>
<a href="#l46.802"></a><span id="l46.802" class="difflineplus">+      // RPL_STATSPING</span>
<a href="#l46.803"></a><span id="l46.803">       // Non-generic</span>
<a href="#l46.804"></a><span id="l46.804">       return serverMessage(this, aMessage);</span>
<a href="#l46.805"></a><span id="l46.805">     },</span>
<a href="#l46.806"></a><span id="l46.806" class="difflineminus">-    &quot;247&quot;: function(aMessage) { // RPL_STATSBLINE</span>
<a href="#l46.807"></a><span id="l46.807" class="difflineplus">+    &quot;247&quot;: function(aMessage) {</span>
<a href="#l46.808"></a><span id="l46.808" class="difflineplus">+      // RPL_STATSBLINE</span>
<a href="#l46.809"></a><span id="l46.809">       // Non-generic</span>
<a href="#l46.810"></a><span id="l46.810">       return serverMessage(this, aMessage);</span>
<a href="#l46.811"></a><span id="l46.811">     },</span>
<a href="#l46.812"></a><span id="l46.812" class="difflineminus">-    &quot;250&quot;: function(aMessage) { // RPL_STATSDLINE</span>
<a href="#l46.813"></a><span id="l46.813" class="difflineplus">+    &quot;250&quot;: function(aMessage) {</span>
<a href="#l46.814"></a><span id="l46.814" class="difflineplus">+      // RPL_STATSDLINE</span>
<a href="#l46.815"></a><span id="l46.815">       // Non-generic</span>
<a href="#l46.816"></a><span id="l46.816">       return serverMessage(this, aMessage);</span>
<a href="#l46.817"></a><span id="l46.817">     },</span>
<a href="#l46.818"></a><span id="l46.818"> </span>
<a href="#l46.819"></a><span id="l46.819">     /*</span>
<a href="#l46.820"></a><span id="l46.820">      * LUSER messages</span>
<a href="#l46.821"></a><span id="l46.821">      */</span>
<a href="#l46.822"></a><span id="l46.822" class="difflineminus">-    &quot;251&quot;: function(aMessage) { // RPL_LUSERCLIENT</span>
<a href="#l46.823"></a><span id="l46.823" class="difflineplus">+    &quot;251&quot;: function(aMessage) {</span>
<a href="#l46.824"></a><span id="l46.824" class="difflineplus">+      // RPL_LUSERCLIENT</span>
<a href="#l46.825"></a><span id="l46.825">       // :There are &lt;integer&gt; users and &lt;integer&gt; services on &lt;integer&gt; servers</span>
<a href="#l46.826"></a><span id="l46.826">       return serverMessage(this, aMessage);</span>
<a href="#l46.827"></a><span id="l46.827">     },</span>
<a href="#l46.828"></a><span id="l46.828" class="difflineminus">-    &quot;252&quot;: function(aMessage) { // RPL_LUSEROP, 0 if not sent</span>
<a href="#l46.829"></a><span id="l46.829" class="difflineplus">+    &quot;252&quot;: function(aMessage) {</span>
<a href="#l46.830"></a><span id="l46.830" class="difflineplus">+      // RPL_LUSEROP, 0 if not sent</span>
<a href="#l46.831"></a><span id="l46.831">       // &lt;integer&gt; :operator(s) online</span>
<a href="#l46.832"></a><span id="l46.832">       return serverMessage(this, aMessage);</span>
<a href="#l46.833"></a><span id="l46.833">     },</span>
<a href="#l46.834"></a><span id="l46.834" class="difflineminus">-    &quot;253&quot;: function(aMessage) { // RPL_LUSERUNKNOWN, 0 if not sent</span>
<a href="#l46.835"></a><span id="l46.835" class="difflineplus">+    &quot;253&quot;: function(aMessage) {</span>
<a href="#l46.836"></a><span id="l46.836" class="difflineplus">+      // RPL_LUSERUNKNOWN, 0 if not sent</span>
<a href="#l46.837"></a><span id="l46.837">       // &lt;integer&gt; :unknown connection(s)</span>
<a href="#l46.838"></a><span id="l46.838">       return serverMessage(this, aMessage);</span>
<a href="#l46.839"></a><span id="l46.839">     },</span>
<a href="#l46.840"></a><span id="l46.840" class="difflineminus">-    &quot;254&quot;: function(aMessage) { // RPL_LUSERCHANNELS, 0 if not sent</span>
<a href="#l46.841"></a><span id="l46.841" class="difflineplus">+    &quot;254&quot;: function(aMessage) {</span>
<a href="#l46.842"></a><span id="l46.842" class="difflineplus">+      // RPL_LUSERCHANNELS, 0 if not sent</span>
<a href="#l46.843"></a><span id="l46.843">       // &lt;integer&gt; :channels formed</span>
<a href="#l46.844"></a><span id="l46.844">       return serverMessage(this, aMessage);</span>
<a href="#l46.845"></a><span id="l46.845">     },</span>
<a href="#l46.846"></a><span id="l46.846" class="difflineminus">-    &quot;255&quot;: function(aMessage) { // RPL_LUSERME</span>
<a href="#l46.847"></a><span id="l46.847" class="difflineplus">+    &quot;255&quot;: function(aMessage) {</span>
<a href="#l46.848"></a><span id="l46.848" class="difflineplus">+      // RPL_LUSERME</span>
<a href="#l46.849"></a><span id="l46.849">       // :I have &lt;integer&gt; clients and &lt;integer&gt; servers</span>
<a href="#l46.850"></a><span id="l46.850">       return serverMessage(this, aMessage);</span>
<a href="#l46.851"></a><span id="l46.851">     },</span>
<a href="#l46.852"></a><span id="l46.852"> </span>
<a href="#l46.853"></a><span id="l46.853">     /*</span>
<a href="#l46.854"></a><span id="l46.854">      * ADMIN messages</span>
<a href="#l46.855"></a><span id="l46.855">      */</span>
<a href="#l46.856"></a><span id="l46.856" class="difflineminus">-    &quot;256&quot;: function(aMessage) { // RPL_ADMINME</span>
<a href="#l46.857"></a><span id="l46.857" class="difflineplus">+    &quot;256&quot;: function(aMessage) {</span>
<a href="#l46.858"></a><span id="l46.858" class="difflineplus">+      // RPL_ADMINME</span>
<a href="#l46.859"></a><span id="l46.859">       // &lt;server&gt; :Administrative info</span>
<a href="#l46.860"></a><span id="l46.860">       return serverMessage(this, aMessage);</span>
<a href="#l46.861"></a><span id="l46.861">     },</span>
<a href="#l46.862"></a><span id="l46.862" class="difflineminus">-    &quot;257&quot;: function(aMessage) { // RPL_ADMINLOC1</span>
<a href="#l46.863"></a><span id="l46.863" class="difflineplus">+    &quot;257&quot;: function(aMessage) {</span>
<a href="#l46.864"></a><span id="l46.864" class="difflineplus">+      // RPL_ADMINLOC1</span>
<a href="#l46.865"></a><span id="l46.865">       // :&lt;admin info&gt;</span>
<a href="#l46.866"></a><span id="l46.866">       // City, state &amp; country</span>
<a href="#l46.867"></a><span id="l46.867">       return serverMessage(this, aMessage);</span>
<a href="#l46.868"></a><span id="l46.868">     },</span>
<a href="#l46.869"></a><span id="l46.869" class="difflineminus">-    &quot;258&quot;: function(aMessage) { // RPL_ADMINLOC2</span>
<a href="#l46.870"></a><span id="l46.870" class="difflineplus">+    &quot;258&quot;: function(aMessage) {</span>
<a href="#l46.871"></a><span id="l46.871" class="difflineplus">+      // RPL_ADMINLOC2</span>
<a href="#l46.872"></a><span id="l46.872">       // :&lt;admin info&gt;</span>
<a href="#l46.873"></a><span id="l46.873">       // Institution details</span>
<a href="#l46.874"></a><span id="l46.874">       return serverMessage(this, aMessage);</span>
<a href="#l46.875"></a><span id="l46.875">     },</span>
<a href="#l46.876"></a><span id="l46.876" class="difflineminus">-    &quot;259&quot;: function(aMessage) { // RPL_ADMINEMAIL</span>
<a href="#l46.877"></a><span id="l46.877" class="difflineplus">+    &quot;259&quot;: function(aMessage) {</span>
<a href="#l46.878"></a><span id="l46.878" class="difflineplus">+      // RPL_ADMINEMAIL</span>
<a href="#l46.879"></a><span id="l46.879">       // :&lt;admin info&gt;</span>
<a href="#l46.880"></a><span id="l46.880">       // TODO We could parse this for a contact email.</span>
<a href="#l46.881"></a><span id="l46.881">       return serverMessage(this, aMessage);</span>
<a href="#l46.882"></a><span id="l46.882">     },</span>
<a href="#l46.883"></a><span id="l46.883"> </span>
<a href="#l46.884"></a><span id="l46.884">     /*</span>
<a href="#l46.885"></a><span id="l46.885">      * TRACELOG</span>
<a href="#l46.886"></a><span id="l46.886">      */</span>
<a href="#l46.887"></a><span id="l46.887" class="difflineminus">-    &quot;261&quot;: function(aMessage) { // RPL_TRACELOG</span>
<a href="#l46.888"></a><span id="l46.888" class="difflineplus">+    &quot;261&quot;: function(aMessage) {</span>
<a href="#l46.889"></a><span id="l46.889" class="difflineplus">+      // RPL_TRACELOG</span>
<a href="#l46.890"></a><span id="l46.890">       // File &lt;logfile&gt; &lt;debug level&gt;</span>
<a href="#l46.891"></a><span id="l46.891">       return serverMessage(this, aMessage);</span>
<a href="#l46.892"></a><span id="l46.892">     },</span>
<a href="#l46.893"></a><span id="l46.893" class="difflineminus">-    &quot;262&quot;: function(aMessage) { // RPL_TRACEEND</span>
<a href="#l46.894"></a><span id="l46.894" class="difflineplus">+    &quot;262&quot;: function(aMessage) {</span>
<a href="#l46.895"></a><span id="l46.895" class="difflineplus">+      // RPL_TRACEEND</span>
<a href="#l46.896"></a><span id="l46.896">       // &lt;server name&gt; &lt;version &amp; debug level&gt; :End of TRACE</span>
<a href="#l46.897"></a><span id="l46.897">       return serverMessage(this, aMessage, true);</span>
<a href="#l46.898"></a><span id="l46.898">     },</span>
<a href="#l46.899"></a><span id="l46.899"> </span>
<a href="#l46.900"></a><span id="l46.900">     /*</span>
<a href="#l46.901"></a><span id="l46.901">      * Try again.</span>
<a href="#l46.902"></a><span id="l46.902">      */</span>
<a href="#l46.903"></a><span id="l46.903" class="difflineminus">-    &quot;263&quot;: function(aMessage) { // RPL_TRYAGAIN</span>
<a href="#l46.904"></a><span id="l46.904" class="difflineplus">+    &quot;263&quot;: function(aMessage) {</span>
<a href="#l46.905"></a><span id="l46.905" class="difflineplus">+      // RPL_TRYAGAIN</span>
<a href="#l46.906"></a><span id="l46.906">       // &lt;command&gt; :Please wait a while and try again.</span>
<a href="#l46.907"></a><span id="l46.907">       if (aMessage.params[1] == &quot;LIST&quot; &amp;&amp; this._pendingList) {</span>
<a href="#l46.908"></a><span id="l46.908">         // We may receive this from servers which rate-limit LIST if the</span>
<a href="#l46.909"></a><span id="l46.909">         // server believes us to be asking for LIST data too soon after the</span>
<a href="#l46.910"></a><span id="l46.910">         // previous request.</span>
<a href="#l46.911"></a><span id="l46.911">         // Tidy up as we won't be receiving any more channels.</span>
<a href="#l46.912"></a><span id="l46.912">         this._sendRemainingRoomInfo();</span>
<a href="#l46.913"></a><span id="l46.913">         // Fake the last LIST time so that we may try again in one hour.</span>
<a href="#l46.914"></a><span id="l46.914">         const kHour = 60 * 60 * 1000;</span>
<a href="#l46.915"></a><span id="l46.915">         this._lastListTime = Date.now() - kListRefreshInterval + kHour;</span>
<a href="#l46.916"></a><span id="l46.916">         return true;</span>
<a href="#l46.917"></a><span id="l46.917">       }</span>
<a href="#l46.918"></a><span id="l46.918">       return serverMessage(this, aMessage);</span>
<a href="#l46.919"></a><span id="l46.919">     },</span>
<a href="#l46.920"></a><span id="l46.920"> </span>
<a href="#l46.921"></a><span id="l46.921" class="difflineminus">-    &quot;265&quot;: function(aMessage) { // nonstandard</span>
<a href="#l46.922"></a><span id="l46.922" class="difflineplus">+    &quot;265&quot;: function(aMessage) {</span>
<a href="#l46.923"></a><span id="l46.923" class="difflineplus">+      // nonstandard</span>
<a href="#l46.924"></a><span id="l46.924">       // :Current Local Users: &lt;integer&gt;  Max: &lt;integer&gt;</span>
<a href="#l46.925"></a><span id="l46.925">       return serverMessage(this, aMessage);</span>
<a href="#l46.926"></a><span id="l46.926">     },</span>
<a href="#l46.927"></a><span id="l46.927" class="difflineminus">-    &quot;266&quot;: function(aMessage) { // nonstandard</span>
<a href="#l46.928"></a><span id="l46.928" class="difflineplus">+    &quot;266&quot;: function(aMessage) {</span>
<a href="#l46.929"></a><span id="l46.929" class="difflineplus">+      // nonstandard</span>
<a href="#l46.930"></a><span id="l46.930">       // :Current Global Users: &lt;integer&gt;  Max: &lt;integer&gt;</span>
<a href="#l46.931"></a><span id="l46.931">       return serverMessage(this, aMessage);</span>
<a href="#l46.932"></a><span id="l46.932">     },</span>
<a href="#l46.933"></a><span id="l46.933" class="difflineminus">-    &quot;300&quot;: function(aMessage) { // RPL_NONE</span>
<a href="#l46.934"></a><span id="l46.934" class="difflineplus">+    &quot;300&quot;: function(aMessage) {</span>
<a href="#l46.935"></a><span id="l46.935" class="difflineplus">+      // RPL_NONE</span>
<a href="#l46.936"></a><span id="l46.936">       // Non-generic</span>
<a href="#l46.937"></a><span id="l46.937">       return serverMessage(this, aMessage);</span>
<a href="#l46.938"></a><span id="l46.938">     },</span>
<a href="#l46.939"></a><span id="l46.939"> </span>
<a href="#l46.940"></a><span id="l46.940">     /*</span>
<a href="#l46.941"></a><span id="l46.941">      * Status messages</span>
<a href="#l46.942"></a><span id="l46.942">      */</span>
<a href="#l46.943"></a><span id="l46.943" class="difflineminus">-    &quot;301&quot;: function(aMessage) { // RPL_AWAY</span>
<a href="#l46.944"></a><span id="l46.944" class="difflineplus">+    &quot;301&quot;: function(aMessage) {</span>
<a href="#l46.945"></a><span id="l46.945" class="difflineplus">+      // RPL_AWAY</span>
<a href="#l46.946"></a><span id="l46.946">       // &lt;nick&gt; :&lt;away message&gt;</span>
<a href="#l46.947"></a><span id="l46.947">       // TODO set user as away on buddy list / conversation lists</span>
<a href="#l46.948"></a><span id="l46.948">       // TODO Display an autoResponse if this is after sending a private message</span>
<a href="#l46.949"></a><span id="l46.949">       // If the conversation is waiting for a response, it's received one.</span>
<a href="#l46.950"></a><span id="l46.950" class="difflineminus">-      if (this.conversations.has(aMessage.params[1]))</span>
<a href="#l46.951"></a><span id="l46.951" class="difflineplus">+      if (this.conversations.has(aMessage.params[1])) {</span>
<a href="#l46.952"></a><span id="l46.952">         delete this.getConversation(aMessage.params[1])._pendingMessage;</span>
<a href="#l46.953"></a><span id="l46.953" class="difflineminus">-      return this.setWhois(aMessage.params[1], {away: aMessage.params[2]});</span>
<a href="#l46.954"></a><span id="l46.954" class="difflineplus">+      }</span>
<a href="#l46.955"></a><span id="l46.955" class="difflineplus">+      return this.setWhois(aMessage.params[1], { away: aMessage.params[2] });</span>
<a href="#l46.956"></a><span id="l46.956">     },</span>
<a href="#l46.957"></a><span id="l46.957" class="difflineminus">-    &quot;302&quot;: function(aMessage) { // RPL_USERHOST</span>
<a href="#l46.958"></a><span id="l46.958" class="difflineplus">+    &quot;302&quot;: function(aMessage) {</span>
<a href="#l46.959"></a><span id="l46.959" class="difflineplus">+      // RPL_USERHOST</span>
<a href="#l46.960"></a><span id="l46.960">       // :*1&lt;reply&gt; *( &quot; &quot; &lt;reply )&quot;</span>
<a href="#l46.961"></a><span id="l46.961">       // reply = nickname [ &quot;*&quot; ] &quot;=&quot; ( &quot;+&quot; / &quot;-&quot; ) hostname</span>
<a href="#l46.962"></a><span id="l46.962">       // TODO Can tell op / away from this</span>
<a href="#l46.963"></a><span id="l46.963">       return false;</span>
<a href="#l46.964"></a><span id="l46.964">     },</span>
<a href="#l46.965"></a><span id="l46.965" class="difflineminus">-    &quot;303&quot;: function(aMessage) { // RPL_ISON</span>
<a href="#l46.966"></a><span id="l46.966" class="difflineplus">+    &quot;303&quot;: function(aMessage) {</span>
<a href="#l46.967"></a><span id="l46.967" class="difflineplus">+      // RPL_ISON</span>
<a href="#l46.968"></a><span id="l46.968">       // :*1&lt;nick&gt; *( &quot; &quot; &lt;nick&gt; )&quot;</span>
<a href="#l46.969"></a><span id="l46.969">       // Set the status of the buddies based the lastest ISON response.</span>
<a href="#l46.970"></a><span id="l46.970">       let receivedBuddyNames = [];</span>
<a href="#l46.971"></a><span id="l46.971">       // The buddy names as returned by the server.</span>
<a href="#l46.972"></a><span id="l46.972" class="difflineminus">-      if (aMessage.params.length &gt; 1)</span>
<a href="#l46.973"></a><span id="l46.973" class="difflineplus">+      if (aMessage.params.length &gt; 1) {</span>
<a href="#l46.974"></a><span id="l46.974">         receivedBuddyNames = aMessage.params[1].trim().split(&quot; &quot;);</span>
<a href="#l46.975"></a><span id="l46.975" class="difflineplus">+      }</span>
<a href="#l46.976"></a><span id="l46.976"> </span>
<a href="#l46.977"></a><span id="l46.977">       // This was received in response to the last ISON message sent.</span>
<a href="#l46.978"></a><span id="l46.978">       for (let buddyName of this.pendingIsOnQueue) {</span>
<a href="#l46.979"></a><span id="l46.979">         // If the buddy name is in the list returned from the server, they're</span>
<a href="#l46.980"></a><span id="l46.980">         // online.</span>
<a href="#l46.981"></a><span id="l46.981" class="difflineminus">-        let status = !receivedBuddyNames.includes(buddyName) ?</span>
<a href="#l46.982"></a><span id="l46.982" class="difflineminus">-                       Ci.imIStatusInfo.STATUS_OFFLINE :</span>
<a href="#l46.983"></a><span id="l46.983" class="difflineminus">-                       Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l46.984"></a><span id="l46.984" class="difflineplus">+        let status = !receivedBuddyNames.includes(buddyName)</span>
<a href="#l46.985"></a><span id="l46.985" class="difflineplus">+          ? Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l46.986"></a><span id="l46.986" class="difflineplus">+          : Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l46.987"></a><span id="l46.987"> </span>
<a href="#l46.988"></a><span id="l46.988">         // Set the status with no status message, only if the buddy actually</span>
<a href="#l46.989"></a><span id="l46.989">         // exists in the buddy list.</span>
<a href="#l46.990"></a><span id="l46.990">         let buddy = this.buddies.get(buddyName);</span>
<a href="#l46.991"></a><span id="l46.991" class="difflineminus">-        if (buddy)</span>
<a href="#l46.992"></a><span id="l46.992" class="difflineplus">+        if (buddy) {</span>
<a href="#l46.993"></a><span id="l46.993">           buddy.setStatus(status, &quot;&quot;);</span>
<a href="#l46.994"></a><span id="l46.994" class="difflineplus">+        }</span>
<a href="#l46.995"></a><span id="l46.995">       }</span>
<a href="#l46.996"></a><span id="l46.996">       return true;</span>
<a href="#l46.997"></a><span id="l46.997">     },</span>
<a href="#l46.998"></a><span id="l46.998" class="difflineminus">-    &quot;305&quot;: function(aMessage) { // RPL_UNAWAY</span>
<a href="#l46.999"></a><span id="l46.999" class="difflineplus">+    &quot;305&quot;: function(aMessage) {</span>
<a href="#l46.1000"></a><span id="l46.1000" class="difflineplus">+      // RPL_UNAWAY</span>
<a href="#l46.1001"></a><span id="l46.1001">       // :You are no longer marked as being away</span>
<a href="#l46.1002"></a><span id="l46.1002">       this.isAway = false;</span>
<a href="#l46.1003"></a><span id="l46.1003">       return true;</span>
<a href="#l46.1004"></a><span id="l46.1004">     },</span>
<a href="#l46.1005"></a><span id="l46.1005" class="difflineminus">-    &quot;306&quot;: function(aMessage) { // RPL_NOWAWAY</span>
<a href="#l46.1006"></a><span id="l46.1006" class="difflineplus">+    &quot;306&quot;: function(aMessage) {</span>
<a href="#l46.1007"></a><span id="l46.1007" class="difflineplus">+      // RPL_NOWAWAY</span>
<a href="#l46.1008"></a><span id="l46.1008">       // :You have been marked as away</span>
<a href="#l46.1009"></a><span id="l46.1009">       this.isAway = true;</span>
<a href="#l46.1010"></a><span id="l46.1010">       return true;</span>
<a href="#l46.1011"></a><span id="l46.1011">     },</span>
<a href="#l46.1012"></a><span id="l46.1012"> </span>
<a href="#l46.1013"></a><span id="l46.1013">     /*</span>
<a href="#l46.1014"></a><span id="l46.1014">      * WHOIS</span>
<a href="#l46.1015"></a><span id="l46.1015">      */</span>
<a href="#l46.1016"></a><span id="l46.1016" class="difflineminus">-    &quot;311&quot;: function(aMessage) { // RPL_WHOISUSER</span>
<a href="#l46.1017"></a><span id="l46.1017" class="difflineplus">+    &quot;311&quot;: function(aMessage) {</span>
<a href="#l46.1018"></a><span id="l46.1018" class="difflineplus">+      // RPL_WHOISUSER</span>
<a href="#l46.1019"></a><span id="l46.1019">       // &lt;nick&gt; &lt;user&gt; &lt;host&gt; * :&lt;real name&gt;</span>
<a href="#l46.1020"></a><span id="l46.1020">       // &lt;username&gt;@&lt;hostname&gt;</span>
<a href="#l46.1021"></a><span id="l46.1021">       let nick = aMessage.params[1];</span>
<a href="#l46.1022"></a><span id="l46.1022">       let source = aMessage.params[2] + &quot;@&quot; + aMessage.params[3];</span>
<a href="#l46.1023"></a><span id="l46.1023">       // Some servers obfuscate the host when sending messages. Therefore,</span>
<a href="#l46.1024"></a><span id="l46.1024">       // we set the account prefix by using the host from this response.</span>
<a href="#l46.1025"></a><span id="l46.1025">       // We store it separately to avoid glitches due to the whois entry</span>
<a href="#l46.1026"></a><span id="l46.1026">       // being temporarily deleted during future updates of the entry.</span>
<a href="#l46.1027"></a><span id="l46.1027" class="difflineminus">-      if (this.normalize(nick) == this.normalize(this._nickname))</span>
<a href="#l46.1028"></a><span id="l46.1028" class="difflineplus">+      if (this.normalize(nick) == this.normalize(this._nickname)) {</span>
<a href="#l46.1029"></a><span id="l46.1029">         this.prefix = &quot;!&quot; + source;</span>
<a href="#l46.1030"></a><span id="l46.1030" class="difflineminus">-      return this.setWhois(nick, {realname: aMessage.params[5],</span>
<a href="#l46.1031"></a><span id="l46.1031" class="difflineminus">-                                  connectedFrom: source});</span>
<a href="#l46.1032"></a><span id="l46.1032" class="difflineplus">+      }</span>
<a href="#l46.1033"></a><span id="l46.1033" class="difflineplus">+      return this.setWhois(nick, {</span>
<a href="#l46.1034"></a><span id="l46.1034" class="difflineplus">+        realname: aMessage.params[5],</span>
<a href="#l46.1035"></a><span id="l46.1035" class="difflineplus">+        connectedFrom: source,</span>
<a href="#l46.1036"></a><span id="l46.1036" class="difflineplus">+      });</span>
<a href="#l46.1037"></a><span id="l46.1037">     },</span>
<a href="#l46.1038"></a><span id="l46.1038" class="difflineminus">-    &quot;312&quot;: function(aMessage) { // RPL_WHOISSERVER</span>
<a href="#l46.1039"></a><span id="l46.1039" class="difflineplus">+    &quot;312&quot;: function(aMessage) {</span>
<a href="#l46.1040"></a><span id="l46.1040" class="difflineplus">+      // RPL_WHOISSERVER</span>
<a href="#l46.1041"></a><span id="l46.1041">       // &lt;nick&gt; &lt;server&gt; :&lt;server info&gt;</span>
<a href="#l46.1042"></a><span id="l46.1042" class="difflineminus">-      return this.setWhois(aMessage.params[1],</span>
<a href="#l46.1043"></a><span id="l46.1043" class="difflineminus">-                           {serverName: aMessage.params[2],</span>
<a href="#l46.1044"></a><span id="l46.1044" class="difflineminus">-                            serverInfo: aMessage.params[3]});</span>
<a href="#l46.1045"></a><span id="l46.1045" class="difflineplus">+      return this.setWhois(aMessage.params[1], {</span>
<a href="#l46.1046"></a><span id="l46.1046" class="difflineplus">+        serverName: aMessage.params[2],</span>
<a href="#l46.1047"></a><span id="l46.1047" class="difflineplus">+        serverInfo: aMessage.params[3],</span>
<a href="#l46.1048"></a><span id="l46.1048" class="difflineplus">+      });</span>
<a href="#l46.1049"></a><span id="l46.1049">     },</span>
<a href="#l46.1050"></a><span id="l46.1050" class="difflineminus">-    &quot;313&quot;: function(aMessage) { // RPL_WHOISOPERATOR</span>
<a href="#l46.1051"></a><span id="l46.1051" class="difflineplus">+    &quot;313&quot;: function(aMessage) {</span>
<a href="#l46.1052"></a><span id="l46.1052" class="difflineplus">+      // RPL_WHOISOPERATOR</span>
<a href="#l46.1053"></a><span id="l46.1053">       // &lt;nick&gt; :is an IRC operator</span>
<a href="#l46.1054"></a><span id="l46.1054" class="difflineminus">-      return this.setWhois(aMessage.params[1], {ircOp: true});</span>
<a href="#l46.1055"></a><span id="l46.1055" class="difflineplus">+      return this.setWhois(aMessage.params[1], { ircOp: true });</span>
<a href="#l46.1056"></a><span id="l46.1056">     },</span>
<a href="#l46.1057"></a><span id="l46.1057" class="difflineminus">-    &quot;314&quot;: function(aMessage) { // RPL_WHOWASUSER</span>
<a href="#l46.1058"></a><span id="l46.1058" class="difflineplus">+    &quot;314&quot;: function(aMessage) {</span>
<a href="#l46.1059"></a><span id="l46.1059" class="difflineplus">+      // RPL_WHOWASUSER</span>
<a href="#l46.1060"></a><span id="l46.1060">       // &lt;nick&gt; &lt;user&gt; &lt;host&gt; * :&lt;real name&gt;</span>
<a href="#l46.1061"></a><span id="l46.1061">       let source = aMessage.params[2] + &quot;@&quot; + aMessage.params[3];</span>
<a href="#l46.1062"></a><span id="l46.1062" class="difflineminus">-      return this.setWhois(aMessage.params[1], {offline: true,</span>
<a href="#l46.1063"></a><span id="l46.1063" class="difflineminus">-                                                realname: aMessage.params[5],</span>
<a href="#l46.1064"></a><span id="l46.1064" class="difflineminus">-                                                connectedFrom: source});</span>
<a href="#l46.1065"></a><span id="l46.1065" class="difflineplus">+      return this.setWhois(aMessage.params[1], {</span>
<a href="#l46.1066"></a><span id="l46.1066" class="difflineplus">+        offline: true,</span>
<a href="#l46.1067"></a><span id="l46.1067" class="difflineplus">+        realname: aMessage.params[5],</span>
<a href="#l46.1068"></a><span id="l46.1068" class="difflineplus">+        connectedFrom: source,</span>
<a href="#l46.1069"></a><span id="l46.1069" class="difflineplus">+      });</span>
<a href="#l46.1070"></a><span id="l46.1070">     },</span>
<a href="#l46.1071"></a><span id="l46.1071" class="difflineminus">-    &quot;315&quot;: function(aMessage) { // RPL_ENDOFWHO</span>
<a href="#l46.1072"></a><span id="l46.1072" class="difflineplus">+    &quot;315&quot;: function(aMessage) {</span>
<a href="#l46.1073"></a><span id="l46.1073" class="difflineplus">+      // RPL_ENDOFWHO</span>
<a href="#l46.1074"></a><span id="l46.1074">       // &lt;name&gt; :End of WHO list</span>
<a href="#l46.1075"></a><span id="l46.1075">       return false;</span>
<a href="#l46.1076"></a><span id="l46.1076">     },</span>
<a href="#l46.1077"></a><span id="l46.1077" class="difflineminus">-    &quot;316&quot;: function(aMessage) { // RPL_WHOISCHANOP</span>
<a href="#l46.1078"></a><span id="l46.1078" class="difflineplus">+    &quot;316&quot;: function(aMessage) {</span>
<a href="#l46.1079"></a><span id="l46.1079" class="difflineplus">+      // RPL_WHOISCHANOP</span>
<a href="#l46.1080"></a><span id="l46.1080">       // Non-generic</span>
<a href="#l46.1081"></a><span id="l46.1081">       return false;</span>
<a href="#l46.1082"></a><span id="l46.1082">     },</span>
<a href="#l46.1083"></a><span id="l46.1083" class="difflineminus">-    &quot;317&quot;: function(aMessage) { // RPL_WHOISIDLE</span>
<a href="#l46.1084"></a><span id="l46.1084" class="difflineplus">+    &quot;317&quot;: function(aMessage) {</span>
<a href="#l46.1085"></a><span id="l46.1085" class="difflineplus">+      // RPL_WHOISIDLE</span>
<a href="#l46.1086"></a><span id="l46.1086">       // &lt;nick&gt; &lt;integer&gt; :seconds idle</span>
<a href="#l46.1087"></a><span id="l46.1087" class="difflineminus">-      return this.setWhois(aMessage.params[1],</span>
<a href="#l46.1088"></a><span id="l46.1088" class="difflineminus">-                           {lastActivity: parseInt(aMessage.params[2])});</span>
<a href="#l46.1089"></a><span id="l46.1089" class="difflineplus">+      return this.setWhois(aMessage.params[1], {</span>
<a href="#l46.1090"></a><span id="l46.1090" class="difflineplus">+        lastActivity: parseInt(aMessage.params[2]),</span>
<a href="#l46.1091"></a><span id="l46.1091" class="difflineplus">+      });</span>
<a href="#l46.1092"></a><span id="l46.1092">     },</span>
<a href="#l46.1093"></a><span id="l46.1093" class="difflineminus">-    &quot;318&quot;: function(aMessage) { // RPL_ENDOFWHOIS</span>
<a href="#l46.1094"></a><span id="l46.1094" class="difflineplus">+    &quot;318&quot;: function(aMessage) {</span>
<a href="#l46.1095"></a><span id="l46.1095" class="difflineplus">+      // RPL_ENDOFWHOIS</span>
<a href="#l46.1096"></a><span id="l46.1096">       // &lt;nick&gt; :End of WHOIS list</span>
<a href="#l46.1097"></a><span id="l46.1097">       // We've received everything about WHOIS, tell the tooltip that is waiting</span>
<a href="#l46.1098"></a><span id="l46.1098">       // for this information.</span>
<a href="#l46.1099"></a><span id="l46.1099">       let nick = aMessage.params[1];</span>
<a href="#l46.1100"></a><span id="l46.1100"> </span>
<a href="#l46.1101"></a><span id="l46.1101" class="difflineminus">-      if (this.whoisInformation.has(nick))</span>
<a href="#l46.1102"></a><span id="l46.1102" class="difflineplus">+      if (this.whoisInformation.has(nick)) {</span>
<a href="#l46.1103"></a><span id="l46.1103">         this.notifyWhois(nick);</span>
<a href="#l46.1104"></a><span id="l46.1104" class="difflineminus">-      else {</span>
<a href="#l46.1105"></a><span id="l46.1105" class="difflineplus">+      } else {</span>
<a href="#l46.1106"></a><span id="l46.1106">         // If there is no whois information stored at this point, the nick</span>
<a href="#l46.1107"></a><span id="l46.1107">         // is either offline or does not exist, so we run WHOWAS.</span>
<a href="#l46.1108"></a><span id="l46.1108">         this.requestOfflineBuddyInfo(nick);</span>
<a href="#l46.1109"></a><span id="l46.1109">       }</span>
<a href="#l46.1110"></a><span id="l46.1110">       return true;</span>
<a href="#l46.1111"></a><span id="l46.1111">     },</span>
<a href="#l46.1112"></a><span id="l46.1112" class="difflineminus">-    &quot;319&quot;: function(aMessage) { // RPL_WHOISCHANNELS</span>
<a href="#l46.1113"></a><span id="l46.1113" class="difflineplus">+    &quot;319&quot;: function(aMessage) {</span>
<a href="#l46.1114"></a><span id="l46.1114" class="difflineplus">+      // RPL_WHOISCHANNELS</span>
<a href="#l46.1115"></a><span id="l46.1115">       // &lt;nick&gt; :*( ( &quot;@&quot; / &quot;+&quot; ) &lt;channel&gt; &quot; &quot; )</span>
<a href="#l46.1116"></a><span id="l46.1116" class="difflineminus">-      return this.setWhois(aMessage.params[1], {channels: aMessage.params[2]});</span>
<a href="#l46.1117"></a><span id="l46.1117" class="difflineplus">+      return this.setWhois(aMessage.params[1], {</span>
<a href="#l46.1118"></a><span id="l46.1118" class="difflineplus">+        channels: aMessage.params[2],</span>
<a href="#l46.1119"></a><span id="l46.1119" class="difflineplus">+      });</span>
<a href="#l46.1120"></a><span id="l46.1120">     },</span>
<a href="#l46.1121"></a><span id="l46.1121"> </span>
<a href="#l46.1122"></a><span id="l46.1122">     /*</span>
<a href="#l46.1123"></a><span id="l46.1123">      * LIST</span>
<a href="#l46.1124"></a><span id="l46.1124">      */</span>
<a href="#l46.1125"></a><span id="l46.1125" class="difflineminus">-    &quot;321&quot;: function(aMessage) { // RPL_LISTSTART</span>
<a href="#l46.1126"></a><span id="l46.1126" class="difflineplus">+    &quot;321&quot;: function(aMessage) {</span>
<a href="#l46.1127"></a><span id="l46.1127" class="difflineplus">+      // RPL_LISTSTART</span>
<a href="#l46.1128"></a><span id="l46.1128">       // Channel :Users Name</span>
<a href="#l46.1129"></a><span id="l46.1129">       // Obsolete. Not used.</span>
<a href="#l46.1130"></a><span id="l46.1130">       return true;</span>
<a href="#l46.1131"></a><span id="l46.1131">     },</span>
<a href="#l46.1132"></a><span id="l46.1132" class="difflineminus">-    &quot;322&quot;: function(aMessage) { // RPL_LIST</span>
<a href="#l46.1133"></a><span id="l46.1133" class="difflineplus">+    &quot;322&quot;: function(aMessage) {</span>
<a href="#l46.1134"></a><span id="l46.1134" class="difflineplus">+      // RPL_LIST</span>
<a href="#l46.1135"></a><span id="l46.1135">       // &lt;channel&gt; &lt;# visible&gt; :&lt;topic&gt;</span>
<a href="#l46.1136"></a><span id="l46.1136">       let name = aMessage.params[1];</span>
<a href="#l46.1137"></a><span id="l46.1137">       let participantCount = aMessage.params[2];</span>
<a href="#l46.1138"></a><span id="l46.1138">       let topic = aMessage.params[3];</span>
<a href="#l46.1139"></a><span id="l46.1139">       // Some servers (e.g. Unreal) include the channel's modes before the topic.</span>
<a href="#l46.1140"></a><span id="l46.1140">       // Omit this.</span>
<a href="#l46.1141"></a><span id="l46.1141">       topic = topic.replace(/^\[\+[a-zA-Z]*\] /, &quot;&quot;);</span>
<a href="#l46.1142"></a><span id="l46.1142">       // Force the allocation of a new copy of the string so as to prevent</span>
<a href="#l46.1143"></a><span id="l46.1143">       // the JS engine from retaining the whole original socket string. See bug</span>
<a href="#l46.1144"></a><span id="l46.1144">       // 1058584. This hack can be removed when bug 1058653 is fixed.</span>
<a href="#l46.1145"></a><span id="l46.1145">       topic = topic ? topic.normalize() : &quot;&quot;;</span>
<a href="#l46.1146"></a><span id="l46.1146"> </span>
<a href="#l46.1147"></a><span id="l46.1147" class="difflineminus">-      this._channelList.set(name,</span>
<a href="#l46.1148"></a><span id="l46.1148" class="difflineminus">-                            {topic, participantCount});</span>
<a href="#l46.1149"></a><span id="l46.1149" class="difflineplus">+      this._channelList.set(name, { topic, participantCount });</span>
<a href="#l46.1150"></a><span id="l46.1150">       this._currentBatch.push(name);</span>
<a href="#l46.1151"></a><span id="l46.1151">       // Give callbacks a batch of channels of length _channelsPerBatch.</span>
<a href="#l46.1152"></a><span id="l46.1152">       if (this._currentBatch.length == this._channelsPerBatch) {</span>
<a href="#l46.1153"></a><span id="l46.1153">         for (let callback of this._roomInfoCallbacks) {</span>
<a href="#l46.1154"></a><span id="l46.1154" class="difflineminus">-          callback.onRoomInfoAvailable(this._currentBatch, false,</span>
<a href="#l46.1155"></a><span id="l46.1155" class="difflineminus">-                                       this._channelsPerBatch);</span>
<a href="#l46.1156"></a><span id="l46.1156" class="difflineplus">+          callback.onRoomInfoAvailable(</span>
<a href="#l46.1157"></a><span id="l46.1157" class="difflineplus">+            this._currentBatch,</span>
<a href="#l46.1158"></a><span id="l46.1158" class="difflineplus">+            false,</span>
<a href="#l46.1159"></a><span id="l46.1159" class="difflineplus">+            this._channelsPerBatch</span>
<a href="#l46.1160"></a><span id="l46.1160" class="difflineplus">+          );</span>
<a href="#l46.1161"></a><span id="l46.1161">         }</span>
<a href="#l46.1162"></a><span id="l46.1162">         this._currentBatch = [];</span>
<a href="#l46.1163"></a><span id="l46.1163">       }</span>
<a href="#l46.1164"></a><span id="l46.1164">       return true;</span>
<a href="#l46.1165"></a><span id="l46.1165">     },</span>
<a href="#l46.1166"></a><span id="l46.1166" class="difflineminus">-    &quot;323&quot;: function(aMessage) { // RPL_LISTEND</span>
<a href="#l46.1167"></a><span id="l46.1167" class="difflineplus">+    &quot;323&quot;: function(aMessage) {</span>
<a href="#l46.1168"></a><span id="l46.1168" class="difflineplus">+      // RPL_LISTEND</span>
<a href="#l46.1169"></a><span id="l46.1169">       // :End of LIST</span>
<a href="#l46.1170"></a><span id="l46.1170">       this._sendRemainingRoomInfo();</span>
<a href="#l46.1171"></a><span id="l46.1171">       return true;</span>
<a href="#l46.1172"></a><span id="l46.1172">     },</span>
<a href="#l46.1173"></a><span id="l46.1173"> </span>
<a href="#l46.1174"></a><span id="l46.1174">     /*</span>
<a href="#l46.1175"></a><span id="l46.1175">      * Channel functions</span>
<a href="#l46.1176"></a><span id="l46.1176">      */</span>
<a href="#l46.1177"></a><span id="l46.1177" class="difflineminus">-    &quot;324&quot;: function(aMessage) { // RPL_CHANNELMODEIS</span>
<a href="#l46.1178"></a><span id="l46.1178" class="difflineplus">+    &quot;324&quot;: function(aMessage) {</span>
<a href="#l46.1179"></a><span id="l46.1179" class="difflineplus">+      // RPL_CHANNELMODEIS</span>
<a href="#l46.1180"></a><span id="l46.1180">       // &lt;channel&gt; &lt;mode&gt; &lt;mode params&gt;</span>
<a href="#l46.1181"></a><span id="l46.1181" class="difflineminus">-      this.getConversation(aMessage.params[1])</span>
<a href="#l46.1182"></a><span id="l46.1182" class="difflineminus">-          .setMode(aMessage.params[2], aMessage.params.slice(3),</span>
<a href="#l46.1183"></a><span id="l46.1183" class="difflineminus">-                   aMessage.origin);</span>
<a href="#l46.1184"></a><span id="l46.1184" class="difflineplus">+      this.getConversation(aMessage.params[1]).setMode(</span>
<a href="#l46.1185"></a><span id="l46.1185" class="difflineplus">+        aMessage.params[2],</span>
<a href="#l46.1186"></a><span id="l46.1186" class="difflineplus">+        aMessage.params.slice(3),</span>
<a href="#l46.1187"></a><span id="l46.1187" class="difflineplus">+        aMessage.origin</span>
<a href="#l46.1188"></a><span id="l46.1188" class="difflineplus">+      );</span>
<a href="#l46.1189"></a><span id="l46.1189"> </span>
<a href="#l46.1190"></a><span id="l46.1190">       return true;</span>
<a href="#l46.1191"></a><span id="l46.1191">     },</span>
<a href="#l46.1192"></a><span id="l46.1192" class="difflineminus">-    &quot;325&quot;: function(aMessage) { // RPL_UNIQOPIS</span>
<a href="#l46.1193"></a><span id="l46.1193" class="difflineplus">+    &quot;325&quot;: function(aMessage) {</span>
<a href="#l46.1194"></a><span id="l46.1194" class="difflineplus">+      // RPL_UNIQOPIS</span>
<a href="#l46.1195"></a><span id="l46.1195">       // &lt;channel&gt; &lt;nickname&gt;</span>
<a href="#l46.1196"></a><span id="l46.1196">       // TODO parse this and have the UI respond accordingly.</span>
<a href="#l46.1197"></a><span id="l46.1197">       return false;</span>
<a href="#l46.1198"></a><span id="l46.1198">     },</span>
<a href="#l46.1199"></a><span id="l46.1199" class="difflineminus">-    &quot;331&quot;: function(aMessage) { // RPL_NOTOPIC</span>
<a href="#l46.1200"></a><span id="l46.1200" class="difflineplus">+    &quot;331&quot;: function(aMessage) {</span>
<a href="#l46.1201"></a><span id="l46.1201" class="difflineplus">+      // RPL_NOTOPIC</span>
<a href="#l46.1202"></a><span id="l46.1202">       // &lt;channel&gt; :No topic is set</span>
<a href="#l46.1203"></a><span id="l46.1203">       let conversation = this.getConversation(aMessage.params[1]);</span>
<a href="#l46.1204"></a><span id="l46.1204" class="difflineminus">-       // Clear the topic.</span>
<a href="#l46.1205"></a><span id="l46.1205" class="difflineplus">+      // Clear the topic.</span>
<a href="#l46.1206"></a><span id="l46.1206">       conversation.setTopic(&quot;&quot;);</span>
<a href="#l46.1207"></a><span id="l46.1207">       return true;</span>
<a href="#l46.1208"></a><span id="l46.1208">     },</span>
<a href="#l46.1209"></a><span id="l46.1209" class="difflineminus">-    &quot;332&quot;: function(aMessage) { // RPL_TOPIC</span>
<a href="#l46.1210"></a><span id="l46.1210" class="difflineplus">+    &quot;332&quot;: function(aMessage) {</span>
<a href="#l46.1211"></a><span id="l46.1211" class="difflineplus">+      // RPL_TOPIC</span>
<a href="#l46.1212"></a><span id="l46.1212">       // &lt;channel&gt; :&lt;topic&gt;</span>
<a href="#l46.1213"></a><span id="l46.1213">       // Update the topic UI</span>
<a href="#l46.1214"></a><span id="l46.1214">       let conversation = this.getConversation(aMessage.params[1]);</span>
<a href="#l46.1215"></a><span id="l46.1215">       let topic = aMessage.params[2];</span>
<a href="#l46.1216"></a><span id="l46.1216">       conversation.setTopic(topic ? ctcpFormatToText(topic) : &quot;&quot;);</span>
<a href="#l46.1217"></a><span id="l46.1217">       return true;</span>
<a href="#l46.1218"></a><span id="l46.1218">     },</span>
<a href="#l46.1219"></a><span id="l46.1219" class="difflineminus">-    &quot;333&quot;: function(aMessage) { // nonstandard</span>
<a href="#l46.1220"></a><span id="l46.1220" class="difflineplus">+    &quot;333&quot;: function(aMessage) {</span>
<a href="#l46.1221"></a><span id="l46.1221" class="difflineplus">+      // nonstandard</span>
<a href="#l46.1222"></a><span id="l46.1222">       // &lt;channel&gt; &lt;nickname&gt; &lt;time&gt;</span>
<a href="#l46.1223"></a><span id="l46.1223">       return true;</span>
<a href="#l46.1224"></a><span id="l46.1224">     },</span>
<a href="#l46.1225"></a><span id="l46.1225"> </span>
<a href="#l46.1226"></a><span id="l46.1226">     /*</span>
<a href="#l46.1227"></a><span id="l46.1227">      * Invitations</span>
<a href="#l46.1228"></a><span id="l46.1228">      */</span>
<a href="#l46.1229"></a><span id="l46.1229" class="difflineminus">-    &quot;341&quot;: function(aMessage) { // RPL_INVITING</span>
<a href="#l46.1230"></a><span id="l46.1230" class="difflineplus">+    &quot;341&quot;: function(aMessage) {</span>
<a href="#l46.1231"></a><span id="l46.1231" class="difflineplus">+      // RPL_INVITING</span>
<a href="#l46.1232"></a><span id="l46.1232">       // &lt;channel&gt; &lt;nick&gt;</span>
<a href="#l46.1233"></a><span id="l46.1233">       // Note that servers reply with parameters in the reverse order from the</span>
<a href="#l46.1234"></a><span id="l46.1234">       // above (which is as specified by RFC 2812).</span>
<a href="#l46.1235"></a><span id="l46.1235" class="difflineminus">-      this.getConversation(aMessage.params[2])</span>
<a href="#l46.1236"></a><span id="l46.1236" class="difflineminus">-          .writeMessage(aMessage.origin,</span>
<a href="#l46.1237"></a><span id="l46.1237" class="difflineminus">-                        _(&quot;message.invited&quot;, aMessage.params[1],</span>
<a href="#l46.1238"></a><span id="l46.1238" class="difflineminus">-                          aMessage.params[2]), {system: true});</span>
<a href="#l46.1239"></a><span id="l46.1239" class="difflineplus">+      this.getConversation(aMessage.params[2]).writeMessage(</span>
<a href="#l46.1240"></a><span id="l46.1240" class="difflineplus">+        aMessage.origin,</span>
<a href="#l46.1241"></a><span id="l46.1241" class="difflineplus">+        _(&quot;message.invited&quot;, aMessage.params[1], aMessage.params[2]),</span>
<a href="#l46.1242"></a><span id="l46.1242" class="difflineplus">+        { system: true }</span>
<a href="#l46.1243"></a><span id="l46.1243" class="difflineplus">+      );</span>
<a href="#l46.1244"></a><span id="l46.1244">       return true;</span>
<a href="#l46.1245"></a><span id="l46.1245">     },</span>
<a href="#l46.1246"></a><span id="l46.1246" class="difflineminus">-    &quot;342&quot;: function(aMessage) { // RPL_SUMMONING</span>
<a href="#l46.1247"></a><span id="l46.1247" class="difflineplus">+    &quot;342&quot;: function(aMessage) {</span>
<a href="#l46.1248"></a><span id="l46.1248" class="difflineplus">+      // RPL_SUMMONING</span>
<a href="#l46.1249"></a><span id="l46.1249">       // &lt;user&gt; :Summoning user to IRC</span>
<a href="#l46.1250"></a><span id="l46.1250" class="difflineminus">-      return writeMessage(this, aMessage,</span>
<a href="#l46.1251"></a><span id="l46.1251" class="difflineminus">-                          _(&quot;message.summoned&quot;, aMessage.params[0]));</span>
<a href="#l46.1252"></a><span id="l46.1252" class="difflineplus">+      return writeMessage(</span>
<a href="#l46.1253"></a><span id="l46.1253" class="difflineplus">+        this,</span>
<a href="#l46.1254"></a><span id="l46.1254" class="difflineplus">+        aMessage,</span>
<a href="#l46.1255"></a><span id="l46.1255" class="difflineplus">+        _(&quot;message.summoned&quot;, aMessage.params[0])</span>
<a href="#l46.1256"></a><span id="l46.1256" class="difflineplus">+      );</span>
<a href="#l46.1257"></a><span id="l46.1257">     },</span>
<a href="#l46.1258"></a><span id="l46.1258" class="difflineminus">-    &quot;346&quot;: function(aMessage) { // RPL_INVITELIST</span>
<a href="#l46.1259"></a><span id="l46.1259" class="difflineplus">+    &quot;346&quot;: function(aMessage) {</span>
<a href="#l46.1260"></a><span id="l46.1260" class="difflineplus">+      // RPL_INVITELIST</span>
<a href="#l46.1261"></a><span id="l46.1261">       // &lt;channel&gt; &lt;invitemask&gt;</span>
<a href="#l46.1262"></a><span id="l46.1262">       // TODO what do we do?</span>
<a href="#l46.1263"></a><span id="l46.1263">       return false;</span>
<a href="#l46.1264"></a><span id="l46.1264">     },</span>
<a href="#l46.1265"></a><span id="l46.1265" class="difflineminus">-    &quot;347&quot;: function(aMessage) { // RPL_ENDOFINVITELIST</span>
<a href="#l46.1266"></a><span id="l46.1266" class="difflineplus">+    &quot;347&quot;: function(aMessage) {</span>
<a href="#l46.1267"></a><span id="l46.1267" class="difflineplus">+      // RPL_ENDOFINVITELIST</span>
<a href="#l46.1268"></a><span id="l46.1268">       // &lt;channel&gt; :End of channel invite list</span>
<a href="#l46.1269"></a><span id="l46.1269">       // TODO what do we do?</span>
<a href="#l46.1270"></a><span id="l46.1270">       return false;</span>
<a href="#l46.1271"></a><span id="l46.1271">     },</span>
<a href="#l46.1272"></a><span id="l46.1272" class="difflineminus">-    &quot;348&quot;: function(aMessage) { // RPL_EXCEPTLIST</span>
<a href="#l46.1273"></a><span id="l46.1273" class="difflineplus">+    &quot;348&quot;: function(aMessage) {</span>
<a href="#l46.1274"></a><span id="l46.1274" class="difflineplus">+      // RPL_EXCEPTLIST</span>
<a href="#l46.1275"></a><span id="l46.1275">       // &lt;channel&gt; &lt;exceptionmask&gt;</span>
<a href="#l46.1276"></a><span id="l46.1276">       // TODO what do we do?</span>
<a href="#l46.1277"></a><span id="l46.1277">       return false;</span>
<a href="#l46.1278"></a><span id="l46.1278">     },</span>
<a href="#l46.1279"></a><span id="l46.1279" class="difflineminus">-    &quot;349&quot;: function(aMessage) { // RPL_ENDOFEXCEPTIONLIST</span>
<a href="#l46.1280"></a><span id="l46.1280" class="difflineplus">+    &quot;349&quot;: function(aMessage) {</span>
<a href="#l46.1281"></a><span id="l46.1281" class="difflineplus">+      // RPL_ENDOFEXCEPTIONLIST</span>
<a href="#l46.1282"></a><span id="l46.1282">       // &lt;channel&gt; :End of channel exception list</span>
<a href="#l46.1283"></a><span id="l46.1283">       // TODO update UI?</span>
<a href="#l46.1284"></a><span id="l46.1284">       return false;</span>
<a href="#l46.1285"></a><span id="l46.1285">     },</span>
<a href="#l46.1286"></a><span id="l46.1286"> </span>
<a href="#l46.1287"></a><span id="l46.1287">     /*</span>
<a href="#l46.1288"></a><span id="l46.1288">      * Version</span>
<a href="#l46.1289"></a><span id="l46.1289">      */</span>
<a href="#l46.1290"></a><span id="l46.1290" class="difflineminus">-    &quot;351&quot;: function(aMessage) { // RPL_VERSION</span>
<a href="#l46.1291"></a><span id="l46.1291" class="difflineplus">+    &quot;351&quot;: function(aMessage) {</span>
<a href="#l46.1292"></a><span id="l46.1292" class="difflineplus">+      // RPL_VERSION</span>
<a href="#l46.1293"></a><span id="l46.1293">       // &lt;version&gt;.&lt;debuglevel&gt; &lt;server&gt; :&lt;comments&gt;</span>
<a href="#l46.1294"></a><span id="l46.1294">       return serverMessage(this, aMessage);</span>
<a href="#l46.1295"></a><span id="l46.1295">     },</span>
<a href="#l46.1296"></a><span id="l46.1296"> </span>
<a href="#l46.1297"></a><span id="l46.1297">     /*</span>
<a href="#l46.1298"></a><span id="l46.1298">      * WHO</span>
<a href="#l46.1299"></a><span id="l46.1299">      */</span>
<a href="#l46.1300"></a><span id="l46.1300" class="difflineminus">-    &quot;352&quot;: function(aMessage) { // RPL_WHOREPLY</span>
<a href="#l46.1301"></a><span id="l46.1301" class="difflineplus">+    &quot;352&quot;: function(aMessage) {</span>
<a href="#l46.1302"></a><span id="l46.1302" class="difflineplus">+      // RPL_WHOREPLY</span>
<a href="#l46.1303"></a><span id="l46.1303">       // &lt;channel&gt; &lt;user&gt; &lt;host&gt; &lt;server&gt; &lt;nick&gt; ( &quot;H&quot; / &quot;G&quot; ) [&quot;*&quot;] [ (&quot;@&quot; / &quot;+&quot; ) ] :&lt;hopcount&gt; &lt;real name&gt;</span>
<a href="#l46.1304"></a><span id="l46.1304">       // TODO parse and display this?</span>
<a href="#l46.1305"></a><span id="l46.1305">       return false;</span>
<a href="#l46.1306"></a><span id="l46.1306">     },</span>
<a href="#l46.1307"></a><span id="l46.1307"> </span>
<a href="#l46.1308"></a><span id="l46.1308">     /*</span>
<a href="#l46.1309"></a><span id="l46.1309">      * NAMREPLY</span>
<a href="#l46.1310"></a><span id="l46.1310">      */</span>
<a href="#l46.1311"></a><span id="l46.1311" class="difflineminus">-    &quot;353&quot;: function(aMessage) { // RPL_NAMREPLY</span>
<a href="#l46.1312"></a><span id="l46.1312" class="difflineplus">+    &quot;353&quot;: function(aMessage) {</span>
<a href="#l46.1313"></a><span id="l46.1313" class="difflineplus">+      // RPL_NAMREPLY</span>
<a href="#l46.1314"></a><span id="l46.1314">       // &lt;target&gt; ( &quot;=&quot; / &quot;*&quot; / &quot;@&quot; ) &lt;channel&gt; :[ &quot;@&quot; / &quot;+&quot; ] &lt;nick&gt; *( &quot; &quot; [ &quot;@&quot; / &quot;+&quot; ] &lt;nick&gt; )</span>
<a href="#l46.1315"></a><span id="l46.1315">       let conversation = this.getConversation(aMessage.params[2]);</span>
<a href="#l46.1316"></a><span id="l46.1316">       // Keep if this is secret (@), private (*) or public (=).</span>
<a href="#l46.1317"></a><span id="l46.1317">       conversation.setModesFromRestriction(aMessage.params[1]);</span>
<a href="#l46.1318"></a><span id="l46.1318">       // Add the participants.</span>
<a href="#l46.1319"></a><span id="l46.1319">       let newParticipants = [];</span>
<a href="#l46.1320"></a><span id="l46.1320" class="difflineminus">-      aMessage.params[3].trim().split(&quot; &quot;).forEach(aNick =&gt;</span>
<a href="#l46.1321"></a><span id="l46.1321" class="difflineminus">-        newParticipants.push(conversation.getParticipant(aNick, false)));</span>
<a href="#l46.1322"></a><span id="l46.1322" class="difflineminus">-      conversation.notifyObservers(new nsSimpleEnumerator(newParticipants),</span>
<a href="#l46.1323"></a><span id="l46.1323" class="difflineminus">-                                   &quot;chat-buddy-add&quot;);</span>
<a href="#l46.1324"></a><span id="l46.1324" class="difflineplus">+      aMessage.params[3]</span>
<a href="#l46.1325"></a><span id="l46.1325" class="difflineplus">+        .trim()</span>
<a href="#l46.1326"></a><span id="l46.1326" class="difflineplus">+        .split(&quot; &quot;)</span>
<a href="#l46.1327"></a><span id="l46.1327" class="difflineplus">+        .forEach(aNick =&gt;</span>
<a href="#l46.1328"></a><span id="l46.1328" class="difflineplus">+          newParticipants.push(conversation.getParticipant(aNick, false))</span>
<a href="#l46.1329"></a><span id="l46.1329" class="difflineplus">+        );</span>
<a href="#l46.1330"></a><span id="l46.1330" class="difflineplus">+      conversation.notifyObservers(</span>
<a href="#l46.1331"></a><span id="l46.1331" class="difflineplus">+        new nsSimpleEnumerator(newParticipants),</span>
<a href="#l46.1332"></a><span id="l46.1332" class="difflineplus">+        &quot;chat-buddy-add&quot;</span>
<a href="#l46.1333"></a><span id="l46.1333" class="difflineplus">+      );</span>
<a href="#l46.1334"></a><span id="l46.1334">       return true;</span>
<a href="#l46.1335"></a><span id="l46.1335">     },</span>
<a href="#l46.1336"></a><span id="l46.1336"> </span>
<a href="#l46.1337"></a><span id="l46.1337" class="difflineminus">-    &quot;361&quot;: function(aMessage) { // RPL_KILLDONE</span>
<a href="#l46.1338"></a><span id="l46.1338" class="difflineplus">+    &quot;361&quot;: function(aMessage) {</span>
<a href="#l46.1339"></a><span id="l46.1339" class="difflineplus">+      // RPL_KILLDONE</span>
<a href="#l46.1340"></a><span id="l46.1340">       // Non-generic</span>
<a href="#l46.1341"></a><span id="l46.1341">       // TODO What is this?</span>
<a href="#l46.1342"></a><span id="l46.1342">       return false;</span>
<a href="#l46.1343"></a><span id="l46.1343">     },</span>
<a href="#l46.1344"></a><span id="l46.1344" class="difflineminus">-    &quot;362&quot;: function(aMessage) { // RPL_CLOSING</span>
<a href="#l46.1345"></a><span id="l46.1345" class="difflineplus">+    &quot;362&quot;: function(aMessage) {</span>
<a href="#l46.1346"></a><span id="l46.1346" class="difflineplus">+      // RPL_CLOSING</span>
<a href="#l46.1347"></a><span id="l46.1347">       // Non-generic</span>
<a href="#l46.1348"></a><span id="l46.1348">       // TODO What is this?</span>
<a href="#l46.1349"></a><span id="l46.1349">       return false;</span>
<a href="#l46.1350"></a><span id="l46.1350">     },</span>
<a href="#l46.1351"></a><span id="l46.1351" class="difflineminus">-    &quot;363&quot;: function(aMessage) { // RPL_CLOSEEND</span>
<a href="#l46.1352"></a><span id="l46.1352" class="difflineplus">+    &quot;363&quot;: function(aMessage) {</span>
<a href="#l46.1353"></a><span id="l46.1353" class="difflineplus">+      // RPL_CLOSEEND</span>
<a href="#l46.1354"></a><span id="l46.1354">       // Non-generic</span>
<a href="#l46.1355"></a><span id="l46.1355">       // TODO What is this?</span>
<a href="#l46.1356"></a><span id="l46.1356">       return false;</span>
<a href="#l46.1357"></a><span id="l46.1357">     },</span>
<a href="#l46.1358"></a><span id="l46.1358"> </span>
<a href="#l46.1359"></a><span id="l46.1359">     /*</span>
<a href="#l46.1360"></a><span id="l46.1360">      * Links.</span>
<a href="#l46.1361"></a><span id="l46.1361">      */</span>
<a href="#l46.1362"></a><span id="l46.1362" class="difflineminus">-    &quot;364&quot;: function(aMessage) { // RPL_LINKS</span>
<a href="#l46.1363"></a><span id="l46.1363" class="difflineplus">+    &quot;364&quot;: function(aMessage) {</span>
<a href="#l46.1364"></a><span id="l46.1364" class="difflineplus">+      // RPL_LINKS</span>
<a href="#l46.1365"></a><span id="l46.1365">       // &lt;mask&gt; &lt;server&gt; :&lt;hopcount&gt; &lt;server info&gt;</span>
<a href="#l46.1366"></a><span id="l46.1366">       return serverMessage(this, aMessage);</span>
<a href="#l46.1367"></a><span id="l46.1367">     },</span>
<a href="#l46.1368"></a><span id="l46.1368" class="difflineminus">-    &quot;365&quot;: function(aMessage) { // RPL_ENDOFLINKS</span>
<a href="#l46.1369"></a><span id="l46.1369" class="difflineplus">+    &quot;365&quot;: function(aMessage) {</span>
<a href="#l46.1370"></a><span id="l46.1370" class="difflineplus">+      // RPL_ENDOFLINKS</span>
<a href="#l46.1371"></a><span id="l46.1371">       // &lt;mask&gt; :End of LINKS list</span>
<a href="#l46.1372"></a><span id="l46.1372">       return true;</span>
<a href="#l46.1373"></a><span id="l46.1373">     },</span>
<a href="#l46.1374"></a><span id="l46.1374"> </span>
<a href="#l46.1375"></a><span id="l46.1375">     /*</span>
<a href="#l46.1376"></a><span id="l46.1376">      * Names</span>
<a href="#l46.1377"></a><span id="l46.1377">      */</span>
<a href="#l46.1378"></a><span id="l46.1378" class="difflineminus">-    &quot;366&quot;: function(aMessage) { // RPL_ENDOFNAMES</span>
<a href="#l46.1379"></a><span id="l46.1379" class="difflineplus">+    &quot;366&quot;: function(aMessage) {</span>
<a href="#l46.1380"></a><span id="l46.1380" class="difflineplus">+      // RPL_ENDOFNAMES</span>
<a href="#l46.1381"></a><span id="l46.1381">       // &lt;target&gt; &lt;channel&gt; :End of NAMES list</span>
<a href="#l46.1382"></a><span id="l46.1382">       // All participants have already been added by the 353 handler.</span>
<a href="#l46.1383"></a><span id="l46.1383"> </span>
<a href="#l46.1384"></a><span id="l46.1384">       // This assumes that this is the last message received when joining a</span>
<a href="#l46.1385"></a><span id="l46.1385">       // channel, so a few &quot;clean up&quot; tasks are done here.</span>
<a href="#l46.1386"></a><span id="l46.1386">       let conversation = this.getConversation(aMessage.params[1]);</span>
<a href="#l46.1387"></a><span id="l46.1387"> </span>
<a href="#l46.1388"></a><span id="l46.1388">       // Update the topic as we may have added the participant for</span>
<a href="#l46.1389"></a><span id="l46.1389">       // the user after the mode message was handled, and so</span>
<a href="#l46.1390"></a><span id="l46.1390">       // topicSettable may have changed.</span>
<a href="#l46.1391"></a><span id="l46.1391">       conversation.notifyObservers(this, &quot;chat-update-topic&quot;);</span>
<a href="#l46.1392"></a><span id="l46.1392"> </span>
<a href="#l46.1393"></a><span id="l46.1393">       // If we haven't received the MODE yet, request it.</span>
<a href="#l46.1394"></a><span id="l46.1394" class="difflineminus">-      if (!conversation._receivedInitialMode)</span>
<a href="#l46.1395"></a><span id="l46.1395" class="difflineplus">+      if (!conversation._receivedInitialMode) {</span>
<a href="#l46.1396"></a><span id="l46.1396">         this.sendMessage(&quot;MODE&quot;, aMessage.params[1]);</span>
<a href="#l46.1397"></a><span id="l46.1397" class="difflineplus">+      }</span>
<a href="#l46.1398"></a><span id="l46.1398"> </span>
<a href="#l46.1399"></a><span id="l46.1399">       return true;</span>
<a href="#l46.1400"></a><span id="l46.1400">     },</span>
<a href="#l46.1401"></a><span id="l46.1401">     /*</span>
<a href="#l46.1402"></a><span id="l46.1402">      * End of a bunch of lists</span>
<a href="#l46.1403"></a><span id="l46.1403">      */</span>
<a href="#l46.1404"></a><span id="l46.1404" class="difflineminus">-    &quot;367&quot;: function(aMessage) { // RPL_BANLIST</span>
<a href="#l46.1405"></a><span id="l46.1405" class="difflineplus">+    &quot;367&quot;: function(aMessage) {</span>
<a href="#l46.1406"></a><span id="l46.1406" class="difflineplus">+      // RPL_BANLIST</span>
<a href="#l46.1407"></a><span id="l46.1407">       // &lt;channel&gt; &lt;banmask&gt;</span>
<a href="#l46.1408"></a><span id="l46.1408">       let conv = this.getConversation(aMessage.params[1]);</span>
<a href="#l46.1409"></a><span id="l46.1409" class="difflineminus">-      if (!conv.banMasks.includes(aMessage.params[2]))</span>
<a href="#l46.1410"></a><span id="l46.1410" class="difflineplus">+      if (!conv.banMasks.includes(aMessage.params[2])) {</span>
<a href="#l46.1411"></a><span id="l46.1411">         conv.banMasks.push(aMessage.params[2]);</span>
<a href="#l46.1412"></a><span id="l46.1412" class="difflineplus">+      }</span>
<a href="#l46.1413"></a><span id="l46.1413">       return true;</span>
<a href="#l46.1414"></a><span id="l46.1414">     },</span>
<a href="#l46.1415"></a><span id="l46.1415" class="difflineminus">-    &quot;368&quot;: function(aMessage) { // RPL_ENDOFBANLIST</span>
<a href="#l46.1416"></a><span id="l46.1416" class="difflineplus">+    &quot;368&quot;: function(aMessage) {</span>
<a href="#l46.1417"></a><span id="l46.1417" class="difflineplus">+      // RPL_ENDOFBANLIST</span>
<a href="#l46.1418"></a><span id="l46.1418">       // &lt;channel&gt; :End of channel ban list</span>
<a href="#l46.1419"></a><span id="l46.1419">       let conv = this.getConversation(aMessage.params[1]);</span>
<a href="#l46.1420"></a><span id="l46.1420">       let msg;</span>
<a href="#l46.1421"></a><span id="l46.1421">       if (conv.banMasks.length) {</span>
<a href="#l46.1422"></a><span id="l46.1422">         msg = [_(&quot;message.banMasks&quot;, aMessage.params[1])]</span>
<a href="#l46.1423"></a><span id="l46.1423" class="difflineminus">-               .concat(conv.banMasks).join(&quot;\n&quot;);</span>
<a href="#l46.1424"></a><span id="l46.1424" class="difflineplus">+          .concat(conv.banMasks)</span>
<a href="#l46.1425"></a><span id="l46.1425" class="difflineplus">+          .join(&quot;\n&quot;);</span>
<a href="#l46.1426"></a><span id="l46.1426" class="difflineplus">+      } else {</span>
<a href="#l46.1427"></a><span id="l46.1427" class="difflineplus">+        msg = _(&quot;message.noBanMasks&quot;, aMessage.params[1]);</span>
<a href="#l46.1428"></a><span id="l46.1428">       }</span>
<a href="#l46.1429"></a><span id="l46.1429" class="difflineminus">-      else</span>
<a href="#l46.1430"></a><span id="l46.1430" class="difflineminus">-        msg = _(&quot;message.noBanMasks&quot;, aMessage.params[1]);</span>
<a href="#l46.1431"></a><span id="l46.1431" class="difflineminus">-      conv.writeMessage(aMessage.origin, msg, {system: true});</span>
<a href="#l46.1432"></a><span id="l46.1432" class="difflineplus">+      conv.writeMessage(aMessage.origin, msg, { system: true });</span>
<a href="#l46.1433"></a><span id="l46.1433">       return true;</span>
<a href="#l46.1434"></a><span id="l46.1434">     },</span>
<a href="#l46.1435"></a><span id="l46.1435" class="difflineminus">-    &quot;369&quot;: function(aMessage) { // RPL_ENDOFWHOWAS</span>
<a href="#l46.1436"></a><span id="l46.1436" class="difflineplus">+    &quot;369&quot;: function(aMessage) {</span>
<a href="#l46.1437"></a><span id="l46.1437" class="difflineplus">+      // RPL_ENDOFWHOWAS</span>
<a href="#l46.1438"></a><span id="l46.1438">       // &lt;nick&gt; :End of WHOWAS</span>
<a href="#l46.1439"></a><span id="l46.1439">       // We've received everything about WHOWAS, tell the tooltip that is waiting</span>
<a href="#l46.1440"></a><span id="l46.1440">       // for this information.</span>
<a href="#l46.1441"></a><span id="l46.1441">       this.notifyWhois(aMessage.params[1]);</span>
<a href="#l46.1442"></a><span id="l46.1442">       return true;</span>
<a href="#l46.1443"></a><span id="l46.1443">     },</span>
<a href="#l46.1444"></a><span id="l46.1444"> </span>
<a href="#l46.1445"></a><span id="l46.1445">     /*</span>
<a href="#l46.1446"></a><span id="l46.1446">      * Server info</span>
<a href="#l46.1447"></a><span id="l46.1447">      */</span>
<a href="#l46.1448"></a><span id="l46.1448" class="difflineminus">-    &quot;371&quot;: function(aMessage) { // RPL_INFO</span>
<a href="#l46.1449"></a><span id="l46.1449" class="difflineplus">+    &quot;371&quot;: function(aMessage) {</span>
<a href="#l46.1450"></a><span id="l46.1450" class="difflineplus">+      // RPL_INFO</span>
<a href="#l46.1451"></a><span id="l46.1451">       // :&lt;string&gt;</span>
<a href="#l46.1452"></a><span id="l46.1452">       return serverMessage(this, aMessage);</span>
<a href="#l46.1453"></a><span id="l46.1453">     },</span>
<a href="#l46.1454"></a><span id="l46.1454" class="difflineminus">-    &quot;372&quot;: function(aMessage) { // RPL_MOTD</span>
<a href="#l46.1455"></a><span id="l46.1455" class="difflineplus">+    &quot;372&quot;: function(aMessage) {</span>
<a href="#l46.1456"></a><span id="l46.1456" class="difflineplus">+      // RPL_MOTD</span>
<a href="#l46.1457"></a><span id="l46.1457">       // :- &lt;text&gt;</span>
<a href="#l46.1458"></a><span id="l46.1458">       return addMotd(this, aMessage);</span>
<a href="#l46.1459"></a><span id="l46.1459">     },</span>
<a href="#l46.1460"></a><span id="l46.1460" class="difflineminus">-    &quot;373&quot;: function(aMessage) { // RPL_INFOSTART</span>
<a href="#l46.1461"></a><span id="l46.1461" class="difflineplus">+    &quot;373&quot;: function(aMessage) {</span>
<a href="#l46.1462"></a><span id="l46.1462" class="difflineplus">+      // RPL_INFOSTART</span>
<a href="#l46.1463"></a><span id="l46.1463">       // Non-generic</span>
<a href="#l46.1464"></a><span id="l46.1464">       // This is unnecessary and servers just send RPL_INFO.</span>
<a href="#l46.1465"></a><span id="l46.1465">       return true;</span>
<a href="#l46.1466"></a><span id="l46.1466">     },</span>
<a href="#l46.1467"></a><span id="l46.1467" class="difflineminus">-    &quot;374&quot;: function(aMessage) { // RPL_ENDOFINFO</span>
<a href="#l46.1468"></a><span id="l46.1468" class="difflineplus">+    &quot;374&quot;: function(aMessage) {</span>
<a href="#l46.1469"></a><span id="l46.1469" class="difflineplus">+      // RPL_ENDOFINFO</span>
<a href="#l46.1470"></a><span id="l46.1470">       // :End of INFO list</span>
<a href="#l46.1471"></a><span id="l46.1471">       return true;</span>
<a href="#l46.1472"></a><span id="l46.1472">     },</span>
<a href="#l46.1473"></a><span id="l46.1473" class="difflineminus">-    &quot;375&quot;: function(aMessage) { // RPL_MOTDSTART</span>
<a href="#l46.1474"></a><span id="l46.1474" class="difflineplus">+    &quot;375&quot;: function(aMessage) {</span>
<a href="#l46.1475"></a><span id="l46.1475" class="difflineplus">+      // RPL_MOTDSTART</span>
<a href="#l46.1476"></a><span id="l46.1476">       // :- &lt;server&gt; Message of the day -</span>
<a href="#l46.1477"></a><span id="l46.1477">       return addMotd(this, aMessage);</span>
<a href="#l46.1478"></a><span id="l46.1478">     },</span>
<a href="#l46.1479"></a><span id="l46.1479" class="difflineminus">-    &quot;376&quot;: function(aMessage) { // RPL_ENDOFMOTD</span>
<a href="#l46.1480"></a><span id="l46.1480" class="difflineplus">+    &quot;376&quot;: function(aMessage) {</span>
<a href="#l46.1481"></a><span id="l46.1481" class="difflineplus">+      // RPL_ENDOFMOTD</span>
<a href="#l46.1482"></a><span id="l46.1482">       // :End of MOTD command</span>
<a href="#l46.1483"></a><span id="l46.1483">       // Show the MOTD if the user wants to see server messages or if</span>
<a href="#l46.1484"></a><span id="l46.1484">       // RPL_WELCOME has not been received since some servers (e.g. irc.ppy.sh)</span>
<a href="#l46.1485"></a><span id="l46.1485">       // use this as a CAPTCHA like mechanism before login can occur.</span>
<a href="#l46.1486"></a><span id="l46.1486" class="difflineminus">-      if (this._showServerTab || !this.connected)</span>
<a href="#l46.1487"></a><span id="l46.1487" class="difflineplus">+      if (this._showServerTab || !this.connected) {</span>
<a href="#l46.1488"></a><span id="l46.1488">         writeMessage(this, aMessage, this._motd.join(&quot;\n&quot;), &quot;incoming&quot;);</span>
<a href="#l46.1489"></a><span id="l46.1489" class="difflineplus">+      }</span>
<a href="#l46.1490"></a><span id="l46.1490">       // No reason to keep the MOTD in memory.</span>
<a href="#l46.1491"></a><span id="l46.1491">       delete this._motd;</span>
<a href="#l46.1492"></a><span id="l46.1492">       // Clear the MOTD timer.</span>
<a href="#l46.1493"></a><span id="l46.1493">       clearTimeout(this._motdTimer);</span>
<a href="#l46.1494"></a><span id="l46.1494">       delete this._motdTimer;</span>
<a href="#l46.1495"></a><span id="l46.1495"> </span>
<a href="#l46.1496"></a><span id="l46.1496">       return true;</span>
<a href="#l46.1497"></a><span id="l46.1497">     },</span>
<a href="#l46.1498"></a><span id="l46.1498"> </span>
<a href="#l46.1499"></a><span id="l46.1499">     /*</span>
<a href="#l46.1500"></a><span id="l46.1500">      * OPER</span>
<a href="#l46.1501"></a><span id="l46.1501">      */</span>
<a href="#l46.1502"></a><span id="l46.1502" class="difflineminus">-    &quot;381&quot;: function(aMessage) { // RPL_YOUREOPER</span>
<a href="#l46.1503"></a><span id="l46.1503" class="difflineplus">+    &quot;381&quot;: function(aMessage) {</span>
<a href="#l46.1504"></a><span id="l46.1504" class="difflineplus">+      // RPL_YOUREOPER</span>
<a href="#l46.1505"></a><span id="l46.1505">       // :You are now an IRC operator</span>
<a href="#l46.1506"></a><span id="l46.1506">       // TODO update UI accordingly to show oper status</span>
<a href="#l46.1507"></a><span id="l46.1507">       return serverMessage(this, aMessage);</span>
<a href="#l46.1508"></a><span id="l46.1508">     },</span>
<a href="#l46.1509"></a><span id="l46.1509" class="difflineminus">-    &quot;382&quot;: function(aMessage) { // RPL_REHASHING</span>
<a href="#l46.1510"></a><span id="l46.1510" class="difflineplus">+    &quot;382&quot;: function(aMessage) {</span>
<a href="#l46.1511"></a><span id="l46.1511" class="difflineplus">+      // RPL_REHASHING</span>
<a href="#l46.1512"></a><span id="l46.1512">       // &lt;config file&gt; :Rehashing</span>
<a href="#l46.1513"></a><span id="l46.1513">       return serverMessage(this, aMessage);</span>
<a href="#l46.1514"></a><span id="l46.1514">     },</span>
<a href="#l46.1515"></a><span id="l46.1515" class="difflineminus">-    &quot;383&quot;: function(aMessage) { // RPL_YOURESERVICE</span>
<a href="#l46.1516"></a><span id="l46.1516" class="difflineplus">+    &quot;383&quot;: function(aMessage) {</span>
<a href="#l46.1517"></a><span id="l46.1517" class="difflineplus">+      // RPL_YOURESERVICE</span>
<a href="#l46.1518"></a><span id="l46.1518">       // You are service &lt;servicename&gt;</span>
<a href="#l46.1519"></a><span id="l46.1519" class="difflineminus">-      this.WARN(&quot;Received \&quot;You are a service\&quot; message.&quot;);</span>
<a href="#l46.1520"></a><span id="l46.1520" class="difflineplus">+      this.WARN('Received &quot;You are a service&quot; message.');</span>
<a href="#l46.1521"></a><span id="l46.1521">       return true;</span>
<a href="#l46.1522"></a><span id="l46.1522">     },</span>
<a href="#l46.1523"></a><span id="l46.1523"> </span>
<a href="#l46.1524"></a><span id="l46.1524">     /*</span>
<a href="#l46.1525"></a><span id="l46.1525">      * Info</span>
<a href="#l46.1526"></a><span id="l46.1526">      */</span>
<a href="#l46.1527"></a><span id="l46.1527" class="difflineminus">-    &quot;384&quot;: function(aMessage) { // RPL_MYPORTIS</span>
<a href="#l46.1528"></a><span id="l46.1528" class="difflineplus">+    &quot;384&quot;: function(aMessage) {</span>
<a href="#l46.1529"></a><span id="l46.1529" class="difflineplus">+      // RPL_MYPORTIS</span>
<a href="#l46.1530"></a><span id="l46.1530">       // Non-generic</span>
<a href="#l46.1531"></a><span id="l46.1531">       // TODO Parse and display?</span>
<a href="#l46.1532"></a><span id="l46.1532">       return false;</span>
<a href="#l46.1533"></a><span id="l46.1533">     },</span>
<a href="#l46.1534"></a><span id="l46.1534" class="difflineminus">-    &quot;391&quot;: function(aMessage) { // RPL_TIME</span>
<a href="#l46.1535"></a><span id="l46.1535" class="difflineplus">+    &quot;391&quot;: function(aMessage) {</span>
<a href="#l46.1536"></a><span id="l46.1536" class="difflineplus">+      // RPL_TIME</span>
<a href="#l46.1537"></a><span id="l46.1537">       // &lt;server&gt; :&lt;string showing server's local time&gt;</span>
<a href="#l46.1538"></a><span id="l46.1538"> </span>
<a href="#l46.1539"></a><span id="l46.1539">       let msg = _(&quot;ctcp.time&quot;, aMessage.params[1], aMessage.params[2]);</span>
<a href="#l46.1540"></a><span id="l46.1540">       // Show the date returned from the server, note that this doesn't use</span>
<a href="#l46.1541"></a><span id="l46.1541">       // the serverMessage function: since this is in response to a command, it</span>
<a href="#l46.1542"></a><span id="l46.1542">       // should always be shown.</span>
<a href="#l46.1543"></a><span id="l46.1543">       return writeMessage(this, aMessage, msg, &quot;system&quot;);</span>
<a href="#l46.1544"></a><span id="l46.1544">     },</span>
<a href="#l46.1545"></a><span id="l46.1545" class="difflineminus">-    &quot;392&quot;: function(aMessage) { // RPL_USERSSTART</span>
<a href="#l46.1546"></a><span id="l46.1546" class="difflineplus">+    &quot;392&quot;: function(aMessage) {</span>
<a href="#l46.1547"></a><span id="l46.1547" class="difflineplus">+      // RPL_USERSSTART</span>
<a href="#l46.1548"></a><span id="l46.1548">       // :UserID   Terminal  Host</span>
<a href="#l46.1549"></a><span id="l46.1549">       // TODO</span>
<a href="#l46.1550"></a><span id="l46.1550">       return false;</span>
<a href="#l46.1551"></a><span id="l46.1551">     },</span>
<a href="#l46.1552"></a><span id="l46.1552" class="difflineminus">-    &quot;393&quot;: function(aMessage) { // RPL_USERS</span>
<a href="#l46.1553"></a><span id="l46.1553" class="difflineplus">+    &quot;393&quot;: function(aMessage) {</span>
<a href="#l46.1554"></a><span id="l46.1554" class="difflineplus">+      // RPL_USERS</span>
<a href="#l46.1555"></a><span id="l46.1555">       // :&lt;username&gt; &lt;ttyline&gt; &lt;hostname&gt;</span>
<a href="#l46.1556"></a><span id="l46.1556">       // TODO store into buddy list? List out?</span>
<a href="#l46.1557"></a><span id="l46.1557">       return false;</span>
<a href="#l46.1558"></a><span id="l46.1558">     },</span>
<a href="#l46.1559"></a><span id="l46.1559" class="difflineminus">-    &quot;394&quot;: function(aMessage) { // RPL_ENDOFUSERS</span>
<a href="#l46.1560"></a><span id="l46.1560" class="difflineplus">+    &quot;394&quot;: function(aMessage) {</span>
<a href="#l46.1561"></a><span id="l46.1561" class="difflineplus">+      // RPL_ENDOFUSERS</span>
<a href="#l46.1562"></a><span id="l46.1562">       // :End of users</span>
<a href="#l46.1563"></a><span id="l46.1563">       // TODO Notify observers of the buddy list?</span>
<a href="#l46.1564"></a><span id="l46.1564">       return false;</span>
<a href="#l46.1565"></a><span id="l46.1565">     },</span>
<a href="#l46.1566"></a><span id="l46.1566" class="difflineminus">-    &quot;395&quot;: function(aMessage) { // RPL_NOUSERS</span>
<a href="#l46.1567"></a><span id="l46.1567" class="difflineplus">+    &quot;395&quot;: function(aMessage) {</span>
<a href="#l46.1568"></a><span id="l46.1568" class="difflineplus">+      // RPL_NOUSERS</span>
<a href="#l46.1569"></a><span id="l46.1569">       // :Nobody logged in</span>
<a href="#l46.1570"></a><span id="l46.1570">       // TODO clear buddy list?</span>
<a href="#l46.1571"></a><span id="l46.1571">       return false;</span>
<a href="#l46.1572"></a><span id="l46.1572">     },</span>
<a href="#l46.1573"></a><span id="l46.1573"> </span>
<a href="#l46.1574"></a><span id="l46.1574" class="difflineminus">-      // Error messages, Implement Section 5.2 of RFC 2812</span>
<a href="#l46.1575"></a><span id="l46.1575" class="difflineminus">-    &quot;401&quot;: function(aMessage) { // ERR_NOSUCHNICK</span>
<a href="#l46.1576"></a><span id="l46.1576" class="difflineplus">+    // Error messages, Implement Section 5.2 of RFC 2812</span>
<a href="#l46.1577"></a><span id="l46.1577" class="difflineplus">+    &quot;401&quot;: function(aMessage) {</span>
<a href="#l46.1578"></a><span id="l46.1578" class="difflineplus">+      // ERR_NOSUCHNICK</span>
<a href="#l46.1579"></a><span id="l46.1579">       // &lt;nickname&gt; :No such nick/channel</span>
<a href="#l46.1580"></a><span id="l46.1580">       // Can arise in response to /mode, /invite, /kill, /msg, /whois.</span>
<a href="#l46.1581"></a><span id="l46.1581">       // TODO Handled in the conversation for /whois and /mgs so far.</span>
<a href="#l46.1582"></a><span id="l46.1582" class="difflineminus">-      let msgId = &quot;error.noSuch&quot; +</span>
<a href="#l46.1583"></a><span id="l46.1583" class="difflineplus">+      let msgId =</span>
<a href="#l46.1584"></a><span id="l46.1584" class="difflineplus">+        &quot;error.noSuch&quot; +</span>
<a href="#l46.1585"></a><span id="l46.1585">         (this.isMUCName(aMessage.params[1]) ? &quot;Channel&quot; : &quot;Nick&quot;);</span>
<a href="#l46.1586"></a><span id="l46.1586">       if (this.conversations.has(aMessage.params[1])) {</span>
<a href="#l46.1587"></a><span id="l46.1587">         // If the conversation exists and we just sent a message from it, then</span>
<a href="#l46.1588"></a><span id="l46.1588">         // notify that the user is offline.</span>
<a href="#l46.1589"></a><span id="l46.1589" class="difflineminus">-        if (this.getConversation(aMessage.params[1])._pendingMessage)</span>
<a href="#l46.1590"></a><span id="l46.1590" class="difflineplus">+        if (this.getConversation(aMessage.params[1])._pendingMessage) {</span>
<a href="#l46.1591"></a><span id="l46.1591">           conversationErrorMessage(this, aMessage, msgId);</span>
<a href="#l46.1592"></a><span id="l46.1592" class="difflineplus">+        }</span>
<a href="#l46.1593"></a><span id="l46.1593">       }</span>
<a href="#l46.1594"></a><span id="l46.1594"> </span>
<a href="#l46.1595"></a><span id="l46.1595">       return serverErrorMessage(this, aMessage, _(msgId, aMessage.params[1]));</span>
<a href="#l46.1596"></a><span id="l46.1596">     },</span>
<a href="#l46.1597"></a><span id="l46.1597" class="difflineminus">-    &quot;402&quot;: function(aMessage) { // ERR_NOSUCHSERVER</span>
<a href="#l46.1598"></a><span id="l46.1598" class="difflineplus">+    &quot;402&quot;: function(aMessage) {</span>
<a href="#l46.1599"></a><span id="l46.1599" class="difflineplus">+      // ERR_NOSUCHSERVER</span>
<a href="#l46.1600"></a><span id="l46.1600">       // &lt;server name&gt; :No such server</span>
<a href="#l46.1601"></a><span id="l46.1601">       // TODO Parse &amp; display an error to the user.</span>
<a href="#l46.1602"></a><span id="l46.1602">       return false;</span>
<a href="#l46.1603"></a><span id="l46.1603">     },</span>
<a href="#l46.1604"></a><span id="l46.1604" class="difflineminus">-    &quot;403&quot;: function(aMessage) { // ERR_NOSUCHCHANNEL</span>
<a href="#l46.1605"></a><span id="l46.1605" class="difflineplus">+    &quot;403&quot;: function(aMessage) {</span>
<a href="#l46.1606"></a><span id="l46.1606" class="difflineplus">+      // ERR_NOSUCHCHANNEL</span>
<a href="#l46.1607"></a><span id="l46.1607">       // &lt;channel name&gt; :No such channel</span>
<a href="#l46.1608"></a><span id="l46.1608" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.noChannel&quot;, true,</span>
<a href="#l46.1609"></a><span id="l46.1609" class="difflineminus">-                                      false);</span>
<a href="#l46.1610"></a><span id="l46.1610" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.1611"></a><span id="l46.1611" class="difflineplus">+        this,</span>
<a href="#l46.1612"></a><span id="l46.1612" class="difflineplus">+        aMessage,</span>
<a href="#l46.1613"></a><span id="l46.1613" class="difflineplus">+        &quot;error.noChannel&quot;,</span>
<a href="#l46.1614"></a><span id="l46.1614" class="difflineplus">+        true,</span>
<a href="#l46.1615"></a><span id="l46.1615" class="difflineplus">+        false</span>
<a href="#l46.1616"></a><span id="l46.1616" class="difflineplus">+      );</span>
<a href="#l46.1617"></a><span id="l46.1617">     },</span>
<a href="#l46.1618"></a><span id="l46.1618" class="difflineminus">-    &quot;404&quot;: function(aMessage) { // ERR_CANNOTSENDTOCHAN</span>
<a href="#l46.1619"></a><span id="l46.1619" class="difflineplus">+    &quot;404&quot;: function(aMessage) {</span>
<a href="#l46.1620"></a><span id="l46.1620" class="difflineplus">+      // ERR_CANNOTSENDTOCHAN</span>
<a href="#l46.1621"></a><span id="l46.1621">       // &lt;channel name&gt; :Cannot send to channel</span>
<a href="#l46.1622"></a><span id="l46.1622">       // Notify the user that they can't send to that channel.</span>
<a href="#l46.1623"></a><span id="l46.1623" class="difflineminus">-      return conversationErrorMessage(this, aMessage,</span>
<a href="#l46.1624"></a><span id="l46.1624" class="difflineminus">-                                      &quot;error.cannotSendToChannel&quot;);</span>
<a href="#l46.1625"></a><span id="l46.1625" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.1626"></a><span id="l46.1626" class="difflineplus">+        this,</span>
<a href="#l46.1627"></a><span id="l46.1627" class="difflineplus">+        aMessage,</span>
<a href="#l46.1628"></a><span id="l46.1628" class="difflineplus">+        &quot;error.cannotSendToChannel&quot;</span>
<a href="#l46.1629"></a><span id="l46.1629" class="difflineplus">+      );</span>
<a href="#l46.1630"></a><span id="l46.1630">     },</span>
<a href="#l46.1631"></a><span id="l46.1631" class="difflineminus">-    &quot;405&quot;: function(aMessage) { // ERR_TOOMANYCHANNELS</span>
<a href="#l46.1632"></a><span id="l46.1632" class="difflineplus">+    &quot;405&quot;: function(aMessage) {</span>
<a href="#l46.1633"></a><span id="l46.1633" class="difflineplus">+      // ERR_TOOMANYCHANNELS</span>
<a href="#l46.1634"></a><span id="l46.1634">       // &lt;channel name&gt; :You have joined too many channels</span>
<a href="#l46.1635"></a><span id="l46.1635" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.tooManyChannels&quot;,</span>
<a href="#l46.1636"></a><span id="l46.1636" class="difflineminus">-                                      true);</span>
<a href="#l46.1637"></a><span id="l46.1637" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.1638"></a><span id="l46.1638" class="difflineplus">+        this,</span>
<a href="#l46.1639"></a><span id="l46.1639" class="difflineplus">+        aMessage,</span>
<a href="#l46.1640"></a><span id="l46.1640" class="difflineplus">+        &quot;error.tooManyChannels&quot;,</span>
<a href="#l46.1641"></a><span id="l46.1641" class="difflineplus">+        true</span>
<a href="#l46.1642"></a><span id="l46.1642" class="difflineplus">+      );</span>
<a href="#l46.1643"></a><span id="l46.1643">     },</span>
<a href="#l46.1644"></a><span id="l46.1644" class="difflineminus">-    &quot;406&quot;: function(aMessage) { // ERR_WASNOSUCHNICK</span>
<a href="#l46.1645"></a><span id="l46.1645" class="difflineplus">+    &quot;406&quot;: function(aMessage) {</span>
<a href="#l46.1646"></a><span id="l46.1646" class="difflineplus">+      // ERR_WASNOSUCHNICK</span>
<a href="#l46.1647"></a><span id="l46.1647">       // &lt;nickname&gt; :There was no such nickname</span>
<a href="#l46.1648"></a><span id="l46.1648">       // Can arise in response to WHOWAS.</span>
<a href="#l46.1649"></a><span id="l46.1649" class="difflineminus">-      return serverErrorMessage(this, aMessage,</span>
<a href="#l46.1650"></a><span id="l46.1650" class="difflineminus">-                                _(&quot;error.wasNoSuchNick&quot;, aMessage.params[1]));</span>
<a href="#l46.1651"></a><span id="l46.1651" class="difflineplus">+      return serverErrorMessage(</span>
<a href="#l46.1652"></a><span id="l46.1652" class="difflineplus">+        this,</span>
<a href="#l46.1653"></a><span id="l46.1653" class="difflineplus">+        aMessage,</span>
<a href="#l46.1654"></a><span id="l46.1654" class="difflineplus">+        _(&quot;error.wasNoSuchNick&quot;, aMessage.params[1])</span>
<a href="#l46.1655"></a><span id="l46.1655" class="difflineplus">+      );</span>
<a href="#l46.1656"></a><span id="l46.1656">     },</span>
<a href="#l46.1657"></a><span id="l46.1657" class="difflineminus">-    &quot;407&quot;: function(aMessage) { // ERR_TOOMANYTARGETS</span>
<a href="#l46.1658"></a><span id="l46.1658" class="difflineplus">+    &quot;407&quot;: function(aMessage) {</span>
<a href="#l46.1659"></a><span id="l46.1659" class="difflineplus">+      // ERR_TOOMANYTARGETS</span>
<a href="#l46.1660"></a><span id="l46.1660">       // &lt;target&gt; :&lt;error code&gt; recipients. &lt;abort message&gt;</span>
<a href="#l46.1661"></a><span id="l46.1661" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.nonUniqueTarget&quot;,</span>
<a href="#l46.1662"></a><span id="l46.1662" class="difflineminus">-                                      false, false);</span>
<a href="#l46.1663"></a><span id="l46.1663" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.1664"></a><span id="l46.1664" class="difflineplus">+        this,</span>
<a href="#l46.1665"></a><span id="l46.1665" class="difflineplus">+        aMessage,</span>
<a href="#l46.1666"></a><span id="l46.1666" class="difflineplus">+        &quot;error.nonUniqueTarget&quot;,</span>
<a href="#l46.1667"></a><span id="l46.1667" class="difflineplus">+        false,</span>
<a href="#l46.1668"></a><span id="l46.1668" class="difflineplus">+        false</span>
<a href="#l46.1669"></a><span id="l46.1669" class="difflineplus">+      );</span>
<a href="#l46.1670"></a><span id="l46.1670">     },</span>
<a href="#l46.1671"></a><span id="l46.1671" class="difflineminus">-    &quot;408&quot;: function(aMessage) { // ERR_NOSUCHSERVICE</span>
<a href="#l46.1672"></a><span id="l46.1672" class="difflineplus">+    &quot;408&quot;: function(aMessage) {</span>
<a href="#l46.1673"></a><span id="l46.1673" class="difflineplus">+      // ERR_NOSUCHSERVICE</span>
<a href="#l46.1674"></a><span id="l46.1674">       // &lt;service name&gt; :No such service</span>
<a href="#l46.1675"></a><span id="l46.1675">       // TODO</span>
<a href="#l46.1676"></a><span id="l46.1676">       return false;</span>
<a href="#l46.1677"></a><span id="l46.1677">     },</span>
<a href="#l46.1678"></a><span id="l46.1678" class="difflineminus">-    &quot;409&quot;: function(aMessage) { // ERR_NOORIGIN</span>
<a href="#l46.1679"></a><span id="l46.1679" class="difflineplus">+    &quot;409&quot;: function(aMessage) {</span>
<a href="#l46.1680"></a><span id="l46.1680" class="difflineplus">+      // ERR_NOORIGIN</span>
<a href="#l46.1681"></a><span id="l46.1681">       // :No origin specified</span>
<a href="#l46.1682"></a><span id="l46.1682">       // TODO failed PING/PONG message, this should never occur?</span>
<a href="#l46.1683"></a><span id="l46.1683">       return false;</span>
<a href="#l46.1684"></a><span id="l46.1684">     },</span>
<a href="#l46.1685"></a><span id="l46.1685" class="difflineminus">-    &quot;411&quot;: function(aMessage) { // ERR_NORECIPIENT</span>
<a href="#l46.1686"></a><span id="l46.1686" class="difflineplus">+    &quot;411&quot;: function(aMessage) {</span>
<a href="#l46.1687"></a><span id="l46.1687" class="difflineplus">+      // ERR_NORECIPIENT</span>
<a href="#l46.1688"></a><span id="l46.1688">       // :No recipient given (&lt;command&gt;)</span>
<a href="#l46.1689"></a><span id="l46.1689">       // If this happens a real error with the protocol occurred.</span>
<a href="#l46.1690"></a><span id="l46.1690">       this.ERROR(&quot;ERR_NORECIPIENT: No recipient given for PRIVMSG.&quot;);</span>
<a href="#l46.1691"></a><span id="l46.1691">       return true;</span>
<a href="#l46.1692"></a><span id="l46.1692">     },</span>
<a href="#l46.1693"></a><span id="l46.1693" class="difflineminus">-    &quot;412&quot;: function(aMessage) { // ERR_NOTEXTTOSEND</span>
<a href="#l46.1694"></a><span id="l46.1694" class="difflineplus">+    &quot;412&quot;: function(aMessage) {</span>
<a href="#l46.1695"></a><span id="l46.1695" class="difflineplus">+      // ERR_NOTEXTTOSEND</span>
<a href="#l46.1696"></a><span id="l46.1696">       // :No text to send</span>
<a href="#l46.1697"></a><span id="l46.1697">       // If this happens a real error with the protocol occurred: we should</span>
<a href="#l46.1698"></a><span id="l46.1698">       // always block the user from sending empty messages.</span>
<a href="#l46.1699"></a><span id="l46.1699">       this.ERROR(&quot;ERR_NOTEXTTOSEND: No text to send for PRIVMSG.&quot;);</span>
<a href="#l46.1700"></a><span id="l46.1700">       return true;</span>
<a href="#l46.1701"></a><span id="l46.1701">     },</span>
<a href="#l46.1702"></a><span id="l46.1702" class="difflineminus">-    &quot;413&quot;: function(aMessage) { // ERR_NOTOPLEVEL</span>
<a href="#l46.1703"></a><span id="l46.1703" class="difflineplus">+    &quot;413&quot;: function(aMessage) {</span>
<a href="#l46.1704"></a><span id="l46.1704" class="difflineplus">+      // ERR_NOTOPLEVEL</span>
<a href="#l46.1705"></a><span id="l46.1705">       // &lt;mask&gt; :No toplevel domain specified</span>
<a href="#l46.1706"></a><span id="l46.1706">       // If this response is received, a real error occurred in the protocol.</span>
<a href="#l46.1707"></a><span id="l46.1707">       this.ERROR(&quot;ERR_NOTOPLEVEL: Toplevel domain not specified.&quot;);</span>
<a href="#l46.1708"></a><span id="l46.1708">       return true;</span>
<a href="#l46.1709"></a><span id="l46.1709">     },</span>
<a href="#l46.1710"></a><span id="l46.1710" class="difflineminus">-    &quot;414&quot;: function(aMessage) { // ERR_WILDTOPLEVEL</span>
<a href="#l46.1711"></a><span id="l46.1711" class="difflineplus">+    &quot;414&quot;: function(aMessage) {</span>
<a href="#l46.1712"></a><span id="l46.1712" class="difflineplus">+      // ERR_WILDTOPLEVEL</span>
<a href="#l46.1713"></a><span id="l46.1713">       // &lt;mask&gt; :Wildcard in toplevel domain</span>
<a href="#l46.1714"></a><span id="l46.1714">       // If this response is received, a real error occurred in the protocol.</span>
<a href="#l46.1715"></a><span id="l46.1715">       this.ERROR(&quot;ERR_WILDTOPLEVEL: Wildcard toplevel domain specified.&quot;);</span>
<a href="#l46.1716"></a><span id="l46.1716">       return true;</span>
<a href="#l46.1717"></a><span id="l46.1717">     },</span>
<a href="#l46.1718"></a><span id="l46.1718" class="difflineminus">-    &quot;415&quot;: function(aMessage) { // ERR_BADMASK</span>
<a href="#l46.1719"></a><span id="l46.1719" class="difflineplus">+    &quot;415&quot;: function(aMessage) {</span>
<a href="#l46.1720"></a><span id="l46.1720" class="difflineplus">+      // ERR_BADMASK</span>
<a href="#l46.1721"></a><span id="l46.1721">       // &lt;mask&gt; :Bad Server/host mask</span>
<a href="#l46.1722"></a><span id="l46.1722">       // If this response is received, a real error occurred in the protocol.</span>
<a href="#l46.1723"></a><span id="l46.1723">       this.ERROR(&quot;ERR_BADMASK: Bad server/host mask specified.&quot;);</span>
<a href="#l46.1724"></a><span id="l46.1724">       return true;</span>
<a href="#l46.1725"></a><span id="l46.1725">     },</span>
<a href="#l46.1726"></a><span id="l46.1726" class="difflineminus">-    &quot;421&quot;: function(aMessage) { // ERR_UNKNOWNCOMMAND</span>
<a href="#l46.1727"></a><span id="l46.1727" class="difflineplus">+    &quot;421&quot;: function(aMessage) {</span>
<a href="#l46.1728"></a><span id="l46.1728" class="difflineplus">+      // ERR_UNKNOWNCOMMAND</span>
<a href="#l46.1729"></a><span id="l46.1729">       // &lt;command&gt; :Unknown command</span>
<a href="#l46.1730"></a><span id="l46.1730">       // TODO This shouldn't occur.</span>
<a href="#l46.1731"></a><span id="l46.1731">       return false;</span>
<a href="#l46.1732"></a><span id="l46.1732">     },</span>
<a href="#l46.1733"></a><span id="l46.1733" class="difflineminus">-    &quot;422&quot;: function(aMessage) { // ERR_NOMOTD</span>
<a href="#l46.1734"></a><span id="l46.1734" class="difflineplus">+    &quot;422&quot;: function(aMessage) {</span>
<a href="#l46.1735"></a><span id="l46.1735" class="difflineplus">+      // ERR_NOMOTD</span>
<a href="#l46.1736"></a><span id="l46.1736">       // :MOTD File is missing</span>
<a href="#l46.1737"></a><span id="l46.1737">       // No message of the day to display.</span>
<a href="#l46.1738"></a><span id="l46.1738">       return true;</span>
<a href="#l46.1739"></a><span id="l46.1739">     },</span>
<a href="#l46.1740"></a><span id="l46.1740" class="difflineminus">-    &quot;423&quot;: function(aMessage) { // ERR_NOADMININFO</span>
<a href="#l46.1741"></a><span id="l46.1741" class="difflineplus">+    &quot;423&quot;: function(aMessage) {</span>
<a href="#l46.1742"></a><span id="l46.1742" class="difflineplus">+      // ERR_NOADMININFO</span>
<a href="#l46.1743"></a><span id="l46.1743">       // &lt;server&gt; :No administrative info available</span>
<a href="#l46.1744"></a><span id="l46.1744">       // TODO</span>
<a href="#l46.1745"></a><span id="l46.1745">       return false;</span>
<a href="#l46.1746"></a><span id="l46.1746">     },</span>
<a href="#l46.1747"></a><span id="l46.1747" class="difflineminus">-    &quot;424&quot;: function(aMessage) { // ERR_FILEERROR</span>
<a href="#l46.1748"></a><span id="l46.1748" class="difflineplus">+    &quot;424&quot;: function(aMessage) {</span>
<a href="#l46.1749"></a><span id="l46.1749" class="difflineplus">+      // ERR_FILEERROR</span>
<a href="#l46.1750"></a><span id="l46.1750">       // :File error doing &lt;file op&gt; on &lt;file&gt;</span>
<a href="#l46.1751"></a><span id="l46.1751">       // TODO</span>
<a href="#l46.1752"></a><span id="l46.1752">       return false;</span>
<a href="#l46.1753"></a><span id="l46.1753">     },</span>
<a href="#l46.1754"></a><span id="l46.1754" class="difflineminus">-    &quot;431&quot;: function(aMessage) { // ERR_NONICKNAMEGIVEN</span>
<a href="#l46.1755"></a><span id="l46.1755" class="difflineplus">+    &quot;431&quot;: function(aMessage) {</span>
<a href="#l46.1756"></a><span id="l46.1756" class="difflineplus">+      // ERR_NONICKNAMEGIVEN</span>
<a href="#l46.1757"></a><span id="l46.1757">       // :No nickname given</span>
<a href="#l46.1758"></a><span id="l46.1758">       // TODO</span>
<a href="#l46.1759"></a><span id="l46.1759">       return false;</span>
<a href="#l46.1760"></a><span id="l46.1760">     },</span>
<a href="#l46.1761"></a><span id="l46.1761" class="difflineminus">-    &quot;432&quot;: function(aMessage) { // ERR_ERRONEUSNICKNAME</span>
<a href="#l46.1762"></a><span id="l46.1762" class="difflineplus">+    &quot;432&quot;: function(aMessage) {</span>
<a href="#l46.1763"></a><span id="l46.1763" class="difflineplus">+      // ERR_ERRONEUSNICKNAME</span>
<a href="#l46.1764"></a><span id="l46.1764">       // &lt;nick&gt; :Erroneous nickname</span>
<a href="#l46.1765"></a><span id="l46.1765">       let msg = _(&quot;error.erroneousNickname&quot;, this._requestedNickname);</span>
<a href="#l46.1766"></a><span id="l46.1766">       serverErrorMessage(this, aMessage, msg);</span>
<a href="#l46.1767"></a><span id="l46.1767">       if (this._requestedNickname == this._accountNickname) {</span>
<a href="#l46.1768"></a><span id="l46.1768">         // The account has been set up with an illegal nickname.</span>
<a href="#l46.1769"></a><span id="l46.1769" class="difflineminus">-        this.ERROR(&quot;Erroneous nickname &quot; + this._requestedNickname + &quot;: &quot; +</span>
<a href="#l46.1770"></a><span id="l46.1770" class="difflineminus">-                   aMessage.params.slice(1).join(&quot; &quot;));</span>
<a href="#l46.1771"></a><span id="l46.1771" class="difflineplus">+        this.ERROR(</span>
<a href="#l46.1772"></a><span id="l46.1772" class="difflineplus">+          &quot;Erroneous nickname &quot; +</span>
<a href="#l46.1773"></a><span id="l46.1773" class="difflineplus">+            this._requestedNickname +</span>
<a href="#l46.1774"></a><span id="l46.1774" class="difflineplus">+            &quot;: &quot; +</span>
<a href="#l46.1775"></a><span id="l46.1775" class="difflineplus">+            aMessage.params.slice(1).join(&quot; &quot;)</span>
<a href="#l46.1776"></a><span id="l46.1776" class="difflineplus">+        );</span>
<a href="#l46.1777"></a><span id="l46.1777">         this.gotDisconnected(Ci.prplIAccount.ERROR_INVALID_USERNAME, msg);</span>
<a href="#l46.1778"></a><span id="l46.1778" class="difflineminus">-      }</span>
<a href="#l46.1779"></a><span id="l46.1779" class="difflineminus">-      else {</span>
<a href="#l46.1780"></a><span id="l46.1780" class="difflineplus">+      } else {</span>
<a href="#l46.1781"></a><span id="l46.1781">         // Reset original nickname to the account nickname in case of</span>
<a href="#l46.1782"></a><span id="l46.1782">         // later reconnections.</span>
<a href="#l46.1783"></a><span id="l46.1783">         this._requestedNickname = this._accountNickname;</span>
<a href="#l46.1784"></a><span id="l46.1784">       }</span>
<a href="#l46.1785"></a><span id="l46.1785">       return true;</span>
<a href="#l46.1786"></a><span id="l46.1786">     },</span>
<a href="#l46.1787"></a><span id="l46.1787" class="difflineminus">-    &quot;433&quot;: function(aMessage) { // ERR_NICKNAMEINUSE</span>
<a href="#l46.1788"></a><span id="l46.1788" class="difflineplus">+    &quot;433&quot;: function(aMessage) {</span>
<a href="#l46.1789"></a><span id="l46.1789" class="difflineplus">+      // ERR_NICKNAMEINUSE</span>
<a href="#l46.1790"></a><span id="l46.1790">       // &lt;nick&gt; :Nickname is already in use</span>
<a href="#l46.1791"></a><span id="l46.1791">       // Try to get the desired nick back in 2.5 minutes if this happens when</span>
<a href="#l46.1792"></a><span id="l46.1792">       // connecting, in case it was just due to the user's nick not having</span>
<a href="#l46.1793"></a><span id="l46.1793">       // timed out yet on the server.</span>
<a href="#l46.1794"></a><span id="l46.1794">       if (this.connecting &amp;&amp; aMessage.params[1] == this._requestedNickname) {</span>
<a href="#l46.1795"></a><span id="l46.1795">         this._nickInUseTimeout = setTimeout(() =&gt; {</span>
<a href="#l46.1796"></a><span id="l46.1796" class="difflineminus">-            this.changeNick(this._requestedNickname);</span>
<a href="#l46.1797"></a><span id="l46.1797" class="difflineminus">-            delete this._nickInUseTimeout;</span>
<a href="#l46.1798"></a><span id="l46.1798" class="difflineminus">-          }, 150000);</span>
<a href="#l46.1799"></a><span id="l46.1799" class="difflineplus">+          this.changeNick(this._requestedNickname);</span>
<a href="#l46.1800"></a><span id="l46.1800" class="difflineplus">+          delete this._nickInUseTimeout;</span>
<a href="#l46.1801"></a><span id="l46.1801" class="difflineplus">+        }, 150000);</span>
<a href="#l46.1802"></a><span id="l46.1802">       }</span>
<a href="#l46.1803"></a><span id="l46.1803">       return this.tryNewNick(aMessage.params[1]);</span>
<a href="#l46.1804"></a><span id="l46.1804">     },</span>
<a href="#l46.1805"></a><span id="l46.1805" class="difflineminus">-    &quot;436&quot;: function(aMessage) { // ERR_NICKCOLLISION</span>
<a href="#l46.1806"></a><span id="l46.1806" class="difflineplus">+    &quot;436&quot;: function(aMessage) {</span>
<a href="#l46.1807"></a><span id="l46.1807" class="difflineplus">+      // ERR_NICKCOLLISION</span>
<a href="#l46.1808"></a><span id="l46.1808">       // &lt;nick&gt; :Nickname collision KILL from &lt;user&gt;@&lt;host&gt;</span>
<a href="#l46.1809"></a><span id="l46.1809">       return this.tryNewNick(aMessage.params[1]);</span>
<a href="#l46.1810"></a><span id="l46.1810">     },</span>
<a href="#l46.1811"></a><span id="l46.1811" class="difflineminus">-    &quot;437&quot;: function(aMessage) { // ERR_UNAVAILRESOURCE</span>
<a href="#l46.1812"></a><span id="l46.1812" class="difflineplus">+    &quot;437&quot;: function(aMessage) {</span>
<a href="#l46.1813"></a><span id="l46.1813" class="difflineplus">+      // ERR_UNAVAILRESOURCE</span>
<a href="#l46.1814"></a><span id="l46.1814">       // &lt;nick/channel&gt; :Nick/channel is temporarily unavailable</span>
<a href="#l46.1815"></a><span id="l46.1815" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.unavailable&quot;,</span>
<a href="#l46.1816"></a><span id="l46.1816" class="difflineminus">-                                      true);</span>
<a href="#l46.1817"></a><span id="l46.1817" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.1818"></a><span id="l46.1818" class="difflineplus">+        this,</span>
<a href="#l46.1819"></a><span id="l46.1819" class="difflineplus">+        aMessage,</span>
<a href="#l46.1820"></a><span id="l46.1820" class="difflineplus">+        &quot;error.unavailable&quot;,</span>
<a href="#l46.1821"></a><span id="l46.1821" class="difflineplus">+        true</span>
<a href="#l46.1822"></a><span id="l46.1822" class="difflineplus">+      );</span>
<a href="#l46.1823"></a><span id="l46.1823">     },</span>
<a href="#l46.1824"></a><span id="l46.1824" class="difflineminus">-    &quot;441&quot;: function(aMessage) { // ERR_USERNOTINCHANNEL</span>
<a href="#l46.1825"></a><span id="l46.1825" class="difflineplus">+    &quot;441&quot;: function(aMessage) {</span>
<a href="#l46.1826"></a><span id="l46.1826" class="difflineplus">+      // ERR_USERNOTINCHANNEL</span>
<a href="#l46.1827"></a><span id="l46.1827">       // &lt;nick&gt; &lt;channel&gt; :They aren't on that channel</span>
<a href="#l46.1828"></a><span id="l46.1828">       // TODO</span>
<a href="#l46.1829"></a><span id="l46.1829">       return false;</span>
<a href="#l46.1830"></a><span id="l46.1830">     },</span>
<a href="#l46.1831"></a><span id="l46.1831" class="difflineminus">-    &quot;442&quot;: function(aMessage) { // ERR_NOTONCHANNEL</span>
<a href="#l46.1832"></a><span id="l46.1832" class="difflineplus">+    &quot;442&quot;: function(aMessage) {</span>
<a href="#l46.1833"></a><span id="l46.1833" class="difflineplus">+      // ERR_NOTONCHANNEL</span>
<a href="#l46.1834"></a><span id="l46.1834">       // &lt;channel&gt; :You're not on that channel</span>
<a href="#l46.1835"></a><span id="l46.1835" class="difflineminus">-      this.ERROR(&quot;A command affecting &quot; + aMessage.params[1] +</span>
<a href="#l46.1836"></a><span id="l46.1836" class="difflineminus">-                 &quot; failed because you aren't in that channel.&quot;);</span>
<a href="#l46.1837"></a><span id="l46.1837" class="difflineplus">+      this.ERROR(</span>
<a href="#l46.1838"></a><span id="l46.1838" class="difflineplus">+        &quot;A command affecting &quot; +</span>
<a href="#l46.1839"></a><span id="l46.1839" class="difflineplus">+          aMessage.params[1] +</span>
<a href="#l46.1840"></a><span id="l46.1840" class="difflineplus">+          &quot; failed because you aren't in that channel.&quot;</span>
<a href="#l46.1841"></a><span id="l46.1841" class="difflineplus">+      );</span>
<a href="#l46.1842"></a><span id="l46.1842">       return true;</span>
<a href="#l46.1843"></a><span id="l46.1843">     },</span>
<a href="#l46.1844"></a><span id="l46.1844" class="difflineminus">-    &quot;443&quot;: function(aMessage) { // ERR_USERONCHANNEL</span>
<a href="#l46.1845"></a><span id="l46.1845" class="difflineplus">+    &quot;443&quot;: function(aMessage) {</span>
<a href="#l46.1846"></a><span id="l46.1846" class="difflineplus">+      // ERR_USERONCHANNEL</span>
<a href="#l46.1847"></a><span id="l46.1847">       // &lt;user&gt; &lt;channel&gt; :is already on channel</span>
<a href="#l46.1848"></a><span id="l46.1848" class="difflineminus">-      this.getConversation(aMessage.params[2])</span>
<a href="#l46.1849"></a><span id="l46.1849" class="difflineminus">-          .writeMessage(aMessage.origin,</span>
<a href="#l46.1850"></a><span id="l46.1850" class="difflineminus">-                        _(&quot;message.alreadyInChannel&quot;, aMessage.params[1],</span>
<a href="#l46.1851"></a><span id="l46.1851" class="difflineminus">-                          aMessage.params[2]), {system: true});</span>
<a href="#l46.1852"></a><span id="l46.1852" class="difflineplus">+      this.getConversation(aMessage.params[2]).writeMessage(</span>
<a href="#l46.1853"></a><span id="l46.1853" class="difflineplus">+        aMessage.origin,</span>
<a href="#l46.1854"></a><span id="l46.1854" class="difflineplus">+        _(&quot;message.alreadyInChannel&quot;, aMessage.params[1], aMessage.params[2]),</span>
<a href="#l46.1855"></a><span id="l46.1855" class="difflineplus">+        { system: true }</span>
<a href="#l46.1856"></a><span id="l46.1856" class="difflineplus">+      );</span>
<a href="#l46.1857"></a><span id="l46.1857">       return true;</span>
<a href="#l46.1858"></a><span id="l46.1858">     },</span>
<a href="#l46.1859"></a><span id="l46.1859" class="difflineminus">-    &quot;444&quot;: function(aMessage) { // ERR_NOLOGIN</span>
<a href="#l46.1860"></a><span id="l46.1860" class="difflineplus">+    &quot;444&quot;: function(aMessage) {</span>
<a href="#l46.1861"></a><span id="l46.1861" class="difflineplus">+      // ERR_NOLOGIN</span>
<a href="#l46.1862"></a><span id="l46.1862">       // &lt;user&gt; :User not logged in</span>
<a href="#l46.1863"></a><span id="l46.1863">       // TODO</span>
<a href="#l46.1864"></a><span id="l46.1864">       return false;</span>
<a href="#l46.1865"></a><span id="l46.1865">     },</span>
<a href="#l46.1866"></a><span id="l46.1866" class="difflineminus">-    &quot;445&quot;: function(aMessage) { // ERR_SUMMONDISABLED</span>
<a href="#l46.1867"></a><span id="l46.1867" class="difflineplus">+    &quot;445&quot;: function(aMessage) {</span>
<a href="#l46.1868"></a><span id="l46.1868" class="difflineplus">+      // ERR_SUMMONDISABLED</span>
<a href="#l46.1869"></a><span id="l46.1869">       // :SUMMON has been disabled</span>
<a href="#l46.1870"></a><span id="l46.1870">       // TODO keep track of this and disable UI associated?</span>
<a href="#l46.1871"></a><span id="l46.1871">       return false;</span>
<a href="#l46.1872"></a><span id="l46.1872">     },</span>
<a href="#l46.1873"></a><span id="l46.1873" class="difflineminus">-    &quot;446&quot;: function(aMessage) { // ERR_USERSDISABLED</span>
<a href="#l46.1874"></a><span id="l46.1874" class="difflineplus">+    &quot;446&quot;: function(aMessage) {</span>
<a href="#l46.1875"></a><span id="l46.1875" class="difflineplus">+      // ERR_USERSDISABLED</span>
<a href="#l46.1876"></a><span id="l46.1876">       // :USERS has been disabled</span>
<a href="#l46.1877"></a><span id="l46.1877">       // TODO Disabled all buddy list etc.</span>
<a href="#l46.1878"></a><span id="l46.1878">       return false;</span>
<a href="#l46.1879"></a><span id="l46.1879">     },</span>
<a href="#l46.1880"></a><span id="l46.1880" class="difflineminus">-    &quot;451&quot;: function(aMessage) { // ERR_NOTREGISTERED</span>
<a href="#l46.1881"></a><span id="l46.1881" class="difflineplus">+    &quot;451&quot;: function(aMessage) {</span>
<a href="#l46.1882"></a><span id="l46.1882" class="difflineplus">+      // ERR_NOTREGISTERED</span>
<a href="#l46.1883"></a><span id="l46.1883">       // :You have not registered</span>
<a href="#l46.1884"></a><span id="l46.1884">       // If the server doesn't understand CAP it might return this error.</span>
<a href="#l46.1885"></a><span id="l46.1885">       if (aMessage.params[0] == &quot;CAP&quot;) {</span>
<a href="#l46.1886"></a><span id="l46.1886">         this.LOG(&quot;Server doesn't support CAP.&quot;);</span>
<a href="#l46.1887"></a><span id="l46.1887">         return true;</span>
<a href="#l46.1888"></a><span id="l46.1888">       }</span>
<a href="#l46.1889"></a><span id="l46.1889">       // TODO</span>
<a href="#l46.1890"></a><span id="l46.1890">       return false;</span>
<a href="#l46.1891"></a><span id="l46.1891">     },</span>
<a href="#l46.1892"></a><span id="l46.1892" class="difflineminus">-    &quot;461&quot;: function(aMessage) { // ERR_NEEDMOREPARAMS</span>
<a href="#l46.1893"></a><span id="l46.1893" class="difflineplus">+    &quot;461&quot;: function(aMessage) {</span>
<a href="#l46.1894"></a><span id="l46.1894" class="difflineplus">+      // ERR_NEEDMOREPARAMS</span>
<a href="#l46.1895"></a><span id="l46.1895">       // &lt;command&gt; :Not enough parameters</span>
<a href="#l46.1896"></a><span id="l46.1896"> </span>
<a href="#l46.1897"></a><span id="l46.1897">       if (!this.connected) {</span>
<a href="#l46.1898"></a><span id="l46.1898">         // The account has been set up with an illegal username.</span>
<a href="#l46.1899"></a><span id="l46.1899">         this.ERROR(&quot;Erroneous username: &quot; + this.username);</span>
<a href="#l46.1900"></a><span id="l46.1900" class="difflineminus">-        this.gotDisconnected(Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l46.1901"></a><span id="l46.1901" class="difflineminus">-                             _(&quot;connection.error.invalidUsername&quot;, this.user));</span>
<a href="#l46.1902"></a><span id="l46.1902" class="difflineplus">+        this.gotDisconnected(</span>
<a href="#l46.1903"></a><span id="l46.1903" class="difflineplus">+          Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l46.1904"></a><span id="l46.1904" class="difflineplus">+          _(&quot;connection.error.invalidUsername&quot;, this.user)</span>
<a href="#l46.1905"></a><span id="l46.1905" class="difflineplus">+        );</span>
<a href="#l46.1906"></a><span id="l46.1906">         return true;</span>
<a href="#l46.1907"></a><span id="l46.1907">       }</span>
<a href="#l46.1908"></a><span id="l46.1908"> </span>
<a href="#l46.1909"></a><span id="l46.1909">       return false;</span>
<a href="#l46.1910"></a><span id="l46.1910">     },</span>
<a href="#l46.1911"></a><span id="l46.1911" class="difflineminus">-    &quot;462&quot;: function(aMessage) { // ERR_ALREADYREGISTERED</span>
<a href="#l46.1912"></a><span id="l46.1912" class="difflineplus">+    &quot;462&quot;: function(aMessage) {</span>
<a href="#l46.1913"></a><span id="l46.1913" class="difflineplus">+      // ERR_ALREADYREGISTERED</span>
<a href="#l46.1914"></a><span id="l46.1914">       // :Unauthorized command (already registered)</span>
<a href="#l46.1915"></a><span id="l46.1915">       // TODO</span>
<a href="#l46.1916"></a><span id="l46.1916">       return false;</span>
<a href="#l46.1917"></a><span id="l46.1917">     },</span>
<a href="#l46.1918"></a><span id="l46.1918" class="difflineminus">-    &quot;463&quot;: function(aMessage) { // ERR_NOPERMFORHOST</span>
<a href="#l46.1919"></a><span id="l46.1919" class="difflineplus">+    &quot;463&quot;: function(aMessage) {</span>
<a href="#l46.1920"></a><span id="l46.1920" class="difflineplus">+      // ERR_NOPERMFORHOST</span>
<a href="#l46.1921"></a><span id="l46.1921">       // :Your host isn't among the privileged</span>
<a href="#l46.1922"></a><span id="l46.1922">       // TODO</span>
<a href="#l46.1923"></a><span id="l46.1923">       return false;</span>
<a href="#l46.1924"></a><span id="l46.1924">     },</span>
<a href="#l46.1925"></a><span id="l46.1925" class="difflineminus">-    &quot;464&quot;: function(aMessage) { // ERR_PASSWDMISMATCH</span>
<a href="#l46.1926"></a><span id="l46.1926" class="difflineplus">+    &quot;464&quot;: function(aMessage) {</span>
<a href="#l46.1927"></a><span id="l46.1927" class="difflineplus">+      // ERR_PASSWDMISMATCH</span>
<a href="#l46.1928"></a><span id="l46.1928">       // :Password incorrect</span>
<a href="#l46.1929"></a><span id="l46.1929" class="difflineminus">-      this.gotDisconnected(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l46.1930"></a><span id="l46.1930" class="difflineminus">-                           _(&quot;connection.error.invalidPassword&quot;));</span>
<a href="#l46.1931"></a><span id="l46.1931" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l46.1932"></a><span id="l46.1932" class="difflineplus">+        Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l46.1933"></a><span id="l46.1933" class="difflineplus">+        _(&quot;connection.error.invalidPassword&quot;)</span>
<a href="#l46.1934"></a><span id="l46.1934" class="difflineplus">+      );</span>
<a href="#l46.1935"></a><span id="l46.1935">       return true;</span>
<a href="#l46.1936"></a><span id="l46.1936">     },</span>
<a href="#l46.1937"></a><span id="l46.1937" class="difflineminus">-    &quot;465&quot;: function(aMessage) { // ERR_YOUREBANEDCREEP</span>
<a href="#l46.1938"></a><span id="l46.1938" class="difflineplus">+    &quot;465&quot;: function(aMessage) {</span>
<a href="#l46.1939"></a><span id="l46.1939" class="difflineplus">+      // ERR_YOUREBANEDCREEP</span>
<a href="#l46.1940"></a><span id="l46.1940">       // :You are banned from this server</span>
<a href="#l46.1941"></a><span id="l46.1941">       serverErrorMessage(this, aMessage, _(&quot;error.banned&quot;));</span>
<a href="#l46.1942"></a><span id="l46.1942" class="difflineminus">-      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l46.1943"></a><span id="l46.1943" class="difflineminus">-                           _(&quot;error.banned&quot;)); // Notify account manager.</span>
<a href="#l46.1944"></a><span id="l46.1944" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l46.1945"></a><span id="l46.1945" class="difflineplus">+        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l46.1946"></a><span id="l46.1946" class="difflineplus">+        _(&quot;error.banned&quot;)</span>
<a href="#l46.1947"></a><span id="l46.1947" class="difflineplus">+      ); // Notify account manager.</span>
<a href="#l46.1948"></a><span id="l46.1948">       return true;</span>
<a href="#l46.1949"></a><span id="l46.1949">     },</span>
<a href="#l46.1950"></a><span id="l46.1950" class="difflineminus">-    &quot;466&quot;: function(aMessage) { // ERR_YOUWILLBEBANNED</span>
<a href="#l46.1951"></a><span id="l46.1951" class="difflineplus">+    &quot;466&quot;: function(aMessage) {</span>
<a href="#l46.1952"></a><span id="l46.1952" class="difflineplus">+      // ERR_YOUWILLBEBANNED</span>
<a href="#l46.1953"></a><span id="l46.1953">       return serverErrorMessage(this, aMessage, _(&quot;error.bannedSoon&quot;));</span>
<a href="#l46.1954"></a><span id="l46.1954">     },</span>
<a href="#l46.1955"></a><span id="l46.1955" class="difflineminus">-    &quot;467&quot;: function(aMessage) { // ERR_KEYSET</span>
<a href="#l46.1956"></a><span id="l46.1956" class="difflineplus">+    &quot;467&quot;: function(aMessage) {</span>
<a href="#l46.1957"></a><span id="l46.1957" class="difflineplus">+      // ERR_KEYSET</span>
<a href="#l46.1958"></a><span id="l46.1958">       // &lt;channel&gt; :Channel key already set</span>
<a href="#l46.1959"></a><span id="l46.1959">       // TODO</span>
<a href="#l46.1960"></a><span id="l46.1960">       return false;</span>
<a href="#l46.1961"></a><span id="l46.1961">     },</span>
<a href="#l46.1962"></a><span id="l46.1962" class="difflineminus">-    &quot;471&quot;: function(aMessage) { // ERR_CHANNELISFULL</span>
<a href="#l46.1963"></a><span id="l46.1963" class="difflineplus">+    &quot;471&quot;: function(aMessage) {</span>
<a href="#l46.1964"></a><span id="l46.1964" class="difflineplus">+      // ERR_CHANNELISFULL</span>
<a href="#l46.1965"></a><span id="l46.1965">       // &lt;channel&gt; :Cannot join channel (+l)</span>
<a href="#l46.1966"></a><span id="l46.1966" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.channelFull&quot;,</span>
<a href="#l46.1967"></a><span id="l46.1967" class="difflineminus">-                                      true);</span>
<a href="#l46.1968"></a><span id="l46.1968" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.1969"></a><span id="l46.1969" class="difflineplus">+        this,</span>
<a href="#l46.1970"></a><span id="l46.1970" class="difflineplus">+        aMessage,</span>
<a href="#l46.1971"></a><span id="l46.1971" class="difflineplus">+        &quot;error.channelFull&quot;,</span>
<a href="#l46.1972"></a><span id="l46.1972" class="difflineplus">+        true</span>
<a href="#l46.1973"></a><span id="l46.1973" class="difflineplus">+      );</span>
<a href="#l46.1974"></a><span id="l46.1974">     },</span>
<a href="#l46.1975"></a><span id="l46.1975" class="difflineminus">-    &quot;472&quot;: function(aMessage) { // ERR_UNKNOWNMODE</span>
<a href="#l46.1976"></a><span id="l46.1976" class="difflineplus">+    &quot;472&quot;: function(aMessage) {</span>
<a href="#l46.1977"></a><span id="l46.1977" class="difflineplus">+      // ERR_UNKNOWNMODE</span>
<a href="#l46.1978"></a><span id="l46.1978">       // &lt;char&gt; :is unknown mode char to me for &lt;channel&gt;</span>
<a href="#l46.1979"></a><span id="l46.1979">       // TODO</span>
<a href="#l46.1980"></a><span id="l46.1980">       return false;</span>
<a href="#l46.1981"></a><span id="l46.1981">     },</span>
<a href="#l46.1982"></a><span id="l46.1982" class="difflineminus">-    &quot;473&quot;: function(aMessage) { // ERR_INVITEONLYCHAN</span>
<a href="#l46.1983"></a><span id="l46.1983" class="difflineplus">+    &quot;473&quot;: function(aMessage) {</span>
<a href="#l46.1984"></a><span id="l46.1984" class="difflineplus">+      // ERR_INVITEONLYCHAN</span>
<a href="#l46.1985"></a><span id="l46.1985">       // &lt;channel&gt; :Cannot join channel (+i)</span>
<a href="#l46.1986"></a><span id="l46.1986" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.inviteOnly&quot;,</span>
<a href="#l46.1987"></a><span id="l46.1987" class="difflineminus">-                                      true, false);</span>
<a href="#l46.1988"></a><span id="l46.1988" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.1989"></a><span id="l46.1989" class="difflineplus">+        this,</span>
<a href="#l46.1990"></a><span id="l46.1990" class="difflineplus">+        aMessage,</span>
<a href="#l46.1991"></a><span id="l46.1991" class="difflineplus">+        &quot;error.inviteOnly&quot;,</span>
<a href="#l46.1992"></a><span id="l46.1992" class="difflineplus">+        true,</span>
<a href="#l46.1993"></a><span id="l46.1993" class="difflineplus">+        false</span>
<a href="#l46.1994"></a><span id="l46.1994" class="difflineplus">+      );</span>
<a href="#l46.1995"></a><span id="l46.1995">     },</span>
<a href="#l46.1996"></a><span id="l46.1996" class="difflineminus">-    &quot;474&quot;: function(aMessage) { // ERR_BANNEDFROMCHAN</span>
<a href="#l46.1997"></a><span id="l46.1997" class="difflineplus">+    &quot;474&quot;: function(aMessage) {</span>
<a href="#l46.1998"></a><span id="l46.1998" class="difflineplus">+      // ERR_BANNEDFROMCHAN</span>
<a href="#l46.1999"></a><span id="l46.1999">       // &lt;channel&gt; :Cannot join channel (+b)</span>
<a href="#l46.2000"></a><span id="l46.2000" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.channelBanned&quot;,</span>
<a href="#l46.2001"></a><span id="l46.2001" class="difflineminus">-                                      true, false);</span>
<a href="#l46.2002"></a><span id="l46.2002" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.2003"></a><span id="l46.2003" class="difflineplus">+        this,</span>
<a href="#l46.2004"></a><span id="l46.2004" class="difflineplus">+        aMessage,</span>
<a href="#l46.2005"></a><span id="l46.2005" class="difflineplus">+        &quot;error.channelBanned&quot;,</span>
<a href="#l46.2006"></a><span id="l46.2006" class="difflineplus">+        true,</span>
<a href="#l46.2007"></a><span id="l46.2007" class="difflineplus">+        false</span>
<a href="#l46.2008"></a><span id="l46.2008" class="difflineplus">+      );</span>
<a href="#l46.2009"></a><span id="l46.2009">     },</span>
<a href="#l46.2010"></a><span id="l46.2010" class="difflineminus">-    &quot;475&quot;: function(aMessage) { // ERR_BADCHANNELKEY</span>
<a href="#l46.2011"></a><span id="l46.2011" class="difflineplus">+    &quot;475&quot;: function(aMessage) {</span>
<a href="#l46.2012"></a><span id="l46.2012" class="difflineplus">+      // ERR_BADCHANNELKEY</span>
<a href="#l46.2013"></a><span id="l46.2013">       // &lt;channel&gt; :Cannot join channel (+k)</span>
<a href="#l46.2014"></a><span id="l46.2014" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.wrongKey&quot;,</span>
<a href="#l46.2015"></a><span id="l46.2015" class="difflineminus">-                                      true, false);</span>
<a href="#l46.2016"></a><span id="l46.2016" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l46.2017"></a><span id="l46.2017" class="difflineplus">+        this,</span>
<a href="#l46.2018"></a><span id="l46.2018" class="difflineplus">+        aMessage,</span>
<a href="#l46.2019"></a><span id="l46.2019" class="difflineplus">+        &quot;error.wrongKey&quot;,</span>
<a href="#l46.2020"></a><span id="l46.2020" class="difflineplus">+        true,</span>
<a href="#l46.2021"></a><span id="l46.2021" class="difflineplus">+        false</span>
<a href="#l46.2022"></a><span id="l46.2022" class="difflineplus">+      );</span>
<a href="#l46.2023"></a><span id="l46.2023">     },</span>
<a href="#l46.2024"></a><span id="l46.2024" class="difflineminus">-    &quot;476&quot;: function(aMessage) { // ERR_BADCHANMASK</span>
<a href="#l46.2025"></a><span id="l46.2025" class="difflineplus">+    &quot;476&quot;: function(aMessage) {</span>
<a href="#l46.2026"></a><span id="l46.2026" class="difflineplus">+      // ERR_BADCHANMASK</span>
<a href="#l46.2027"></a><span id="l46.2027">       // &lt;channel&gt; :Bad Channel Mask</span>
<a href="#l46.2028"></a><span id="l46.2028">       // TODO</span>
<a href="#l46.2029"></a><span id="l46.2029">       return false;</span>
<a href="#l46.2030"></a><span id="l46.2030">     },</span>
<a href="#l46.2031"></a><span id="l46.2031" class="difflineminus">-    &quot;477&quot;: function(aMessage) { // ERR_NOCHANMODES</span>
<a href="#l46.2032"></a><span id="l46.2032" class="difflineplus">+    &quot;477&quot;: function(aMessage) {</span>
<a href="#l46.2033"></a><span id="l46.2033" class="difflineplus">+      // ERR_NOCHANMODES</span>
<a href="#l46.2034"></a><span id="l46.2034">       // &lt;channel&gt; :Channel doesn't support modes</span>
<a href="#l46.2035"></a><span id="l46.2035">       // TODO</span>
<a href="#l46.2036"></a><span id="l46.2036">       return false;</span>
<a href="#l46.2037"></a><span id="l46.2037">     },</span>
<a href="#l46.2038"></a><span id="l46.2038" class="difflineminus">-    &quot;478&quot;: function(aMessage) { // ERR_BANLISTFULL</span>
<a href="#l46.2039"></a><span id="l46.2039" class="difflineplus">+    &quot;478&quot;: function(aMessage) {</span>
<a href="#l46.2040"></a><span id="l46.2040" class="difflineplus">+      // ERR_BANLISTFULL</span>
<a href="#l46.2041"></a><span id="l46.2041">       // &lt;channel&gt; &lt;char&gt; :Channel list is full</span>
<a href="#l46.2042"></a><span id="l46.2042">       // TODO</span>
<a href="#l46.2043"></a><span id="l46.2043">       return false;</span>
<a href="#l46.2044"></a><span id="l46.2044">     },</span>
<a href="#l46.2045"></a><span id="l46.2045" class="difflineminus">-    &quot;481&quot;: function(aMessage) { // ERR_NOPRIVILEGES</span>
<a href="#l46.2046"></a><span id="l46.2046" class="difflineplus">+    &quot;481&quot;: function(aMessage) {</span>
<a href="#l46.2047"></a><span id="l46.2047" class="difflineplus">+      // ERR_NOPRIVILEGES</span>
<a href="#l46.2048"></a><span id="l46.2048">       // :Permission Denied- You're not an IRC operator</span>
<a href="#l46.2049"></a><span id="l46.2049">       // TODO ask to auth?</span>
<a href="#l46.2050"></a><span id="l46.2050">       return false;</span>
<a href="#l46.2051"></a><span id="l46.2051">     },</span>
<a href="#l46.2052"></a><span id="l46.2052" class="difflineminus">-    &quot;482&quot;: function(aMessage) { // ERR_CHANOPRIVSNEEDED</span>
<a href="#l46.2053"></a><span id="l46.2053" class="difflineplus">+    &quot;482&quot;: function(aMessage) {</span>
<a href="#l46.2054"></a><span id="l46.2054" class="difflineplus">+      // ERR_CHANOPRIVSNEEDED</span>
<a href="#l46.2055"></a><span id="l46.2055">       // &lt;channel&gt; :You're not channel operator</span>
<a href="#l46.2056"></a><span id="l46.2056">       return conversationErrorMessage(this, aMessage, &quot;error.notChannelOp&quot;);</span>
<a href="#l46.2057"></a><span id="l46.2057">     },</span>
<a href="#l46.2058"></a><span id="l46.2058" class="difflineminus">-    &quot;483&quot;: function(aMessage) { // ERR_CANTKILLSERVER</span>
<a href="#l46.2059"></a><span id="l46.2059" class="difflineplus">+    &quot;483&quot;: function(aMessage) {</span>
<a href="#l46.2060"></a><span id="l46.2060" class="difflineplus">+      // ERR_CANTKILLSERVER</span>
<a href="#l46.2061"></a><span id="l46.2061">       // :You can't kill a server!</span>
<a href="#l46.2062"></a><span id="l46.2062">       // TODO Display error?</span>
<a href="#l46.2063"></a><span id="l46.2063">       return false;</span>
<a href="#l46.2064"></a><span id="l46.2064">     },</span>
<a href="#l46.2065"></a><span id="l46.2065" class="difflineminus">-    &quot;484&quot;: function(aMessage) { // ERR_RESTRICTED</span>
<a href="#l46.2066"></a><span id="l46.2066" class="difflineplus">+    &quot;484&quot;: function(aMessage) {</span>
<a href="#l46.2067"></a><span id="l46.2067" class="difflineplus">+      // ERR_RESTRICTED</span>
<a href="#l46.2068"></a><span id="l46.2068">       // :Your connection is restricted!</span>
<a href="#l46.2069"></a><span id="l46.2069">       // Indicates user mode +r</span>
<a href="#l46.2070"></a><span id="l46.2070">       // TODO</span>
<a href="#l46.2071"></a><span id="l46.2071">       return false;</span>
<a href="#l46.2072"></a><span id="l46.2072">     },</span>
<a href="#l46.2073"></a><span id="l46.2073" class="difflineminus">-    &quot;485&quot;: function(aMessage) { // ERR_UNIQOPPRIVSNEEDED</span>
<a href="#l46.2074"></a><span id="l46.2074" class="difflineplus">+    &quot;485&quot;: function(aMessage) {</span>
<a href="#l46.2075"></a><span id="l46.2075" class="difflineplus">+      // ERR_UNIQOPPRIVSNEEDED</span>
<a href="#l46.2076"></a><span id="l46.2076">       // :You're not the original channel operator</span>
<a href="#l46.2077"></a><span id="l46.2077">       // TODO ask to auth?</span>
<a href="#l46.2078"></a><span id="l46.2078">       return false;</span>
<a href="#l46.2079"></a><span id="l46.2079">     },</span>
<a href="#l46.2080"></a><span id="l46.2080" class="difflineminus">-    &quot;491&quot;: function(aMessage) { // ERR_NOOPERHOST</span>
<a href="#l46.2081"></a><span id="l46.2081" class="difflineplus">+    &quot;491&quot;: function(aMessage) {</span>
<a href="#l46.2082"></a><span id="l46.2082" class="difflineplus">+      // ERR_NOOPERHOST</span>
<a href="#l46.2083"></a><span id="l46.2083">       // :No O-lines for your host</span>
<a href="#l46.2084"></a><span id="l46.2084">       // TODO</span>
<a href="#l46.2085"></a><span id="l46.2085">       return false;</span>
<a href="#l46.2086"></a><span id="l46.2086">     },</span>
<a href="#l46.2087"></a><span id="l46.2087" class="difflineminus">-    &quot;492&quot;: function(aMessage) { // ERR_NOSERVICEHOST</span>
<a href="#l46.2088"></a><span id="l46.2088" class="difflineplus">+    &quot;492&quot;: function(aMessage) {</span>
<a href="#l46.2089"></a><span id="l46.2089" class="difflineplus">+      // ERR_NOSERVICEHOST</span>
<a href="#l46.2090"></a><span id="l46.2090">       // Non-generic</span>
<a href="#l46.2091"></a><span id="l46.2091">       // TODO</span>
<a href="#l46.2092"></a><span id="l46.2092">       return false;</span>
<a href="#l46.2093"></a><span id="l46.2093">     },</span>
<a href="#l46.2094"></a><span id="l46.2094" class="difflineminus">-    &quot;501&quot;: function(aMessage) { // ERR_UMODEUNKNOWNFLAGS</span>
<a href="#l46.2095"></a><span id="l46.2095" class="difflineplus">+    &quot;501&quot;: function(aMessage) {</span>
<a href="#l46.2096"></a><span id="l46.2096" class="difflineplus">+      // ERR_UMODEUNKNOWNFLAGS</span>
<a href="#l46.2097"></a><span id="l46.2097">       // :Unknown MODE flag</span>
<a href="#l46.2098"></a><span id="l46.2098" class="difflineminus">-      return serverErrorMessage(this, aMessage,</span>
<a href="#l46.2099"></a><span id="l46.2099" class="difflineminus">-                                _(&quot;error.unknownMode&quot;, aMessage.params[1]));</span>
<a href="#l46.2100"></a><span id="l46.2100" class="difflineplus">+      return serverErrorMessage(</span>
<a href="#l46.2101"></a><span id="l46.2101" class="difflineplus">+        this,</span>
<a href="#l46.2102"></a><span id="l46.2102" class="difflineplus">+        aMessage,</span>
<a href="#l46.2103"></a><span id="l46.2103" class="difflineplus">+        _(&quot;error.unknownMode&quot;, aMessage.params[1])</span>
<a href="#l46.2104"></a><span id="l46.2104" class="difflineplus">+      );</span>
<a href="#l46.2105"></a><span id="l46.2105">     },</span>
<a href="#l46.2106"></a><span id="l46.2106" class="difflineminus">-    &quot;502&quot;: function(aMessage) { // ERR_USERSDONTMATCH</span>
<a href="#l46.2107"></a><span id="l46.2107" class="difflineplus">+    &quot;502&quot;: function(aMessage) {</span>
<a href="#l46.2108"></a><span id="l46.2108" class="difflineplus">+      // ERR_USERSDONTMATCH</span>
<a href="#l46.2109"></a><span id="l46.2109">       // :Cannot change mode for other users</span>
<a href="#l46.2110"></a><span id="l46.2110">       return serverErrorMessage(this, aMessage, _(&quot;error.mode.wrongUser&quot;));</span>
<a href="#l46.2111"></a><span id="l46.2111">     },</span>
<a href="#l46.2112"></a><span id="l46.2112">   },</span>
<a href="#l46.2113"></a><span id="l46.2113"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/chat/protocols/irc/ircCAP.jsm</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/chat/protocols/irc/ircCAP.jsm</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -14,46 +14,52 @@</span>
<a href="#l47.4"></a><span id="l47.4">  *     http://ircv3.net/specs/core/capability-negotiation-3.2.html</span>
<a href="#l47.5"></a><span id="l47.5">  *</span>
<a href="#l47.6"></a><span id="l47.6">  * Note that this doesn't include any implementation as these RFCs do not even</span>
<a href="#l47.7"></a><span id="l47.7">  * include example parameters.</span>
<a href="#l47.8"></a><span id="l47.8">  */</span>
<a href="#l47.9"></a><span id="l47.9"> </span>
<a href="#l47.10"></a><span id="l47.10"> this.EXPORTED_SYMBOLS = [&quot;ircCAP&quot;];</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+);</span>
<a href="#l47.16"></a><span id="l47.16"> </span>
<a href="#l47.17"></a><span id="l47.17"> /*</span>
<a href="#l47.18"></a><span id="l47.18">  * Parses a CAP message of the form:</span>
<a href="#l47.19"></a><span id="l47.19">  *   CAP &lt;subcommand&gt; [&lt;parameters&gt;]</span>
<a href="#l47.20"></a><span id="l47.20">  * The cap field is added to the message and it has the following fields:</span>
<a href="#l47.21"></a><span id="l47.21">  *   subcommand</span>
<a href="#l47.22"></a><span id="l47.22">  *   parameters A list of capabilities.</span>
<a href="#l47.23"></a><span id="l47.23">  */</span>
<a href="#l47.24"></a><span id="l47.24"> function capMessage(aMessage) {</span>
<a href="#l47.25"></a><span id="l47.25">   // The CAP parameters are space separated as the last parameter.</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-  let parameters = aMessage.params.slice(-1)[0].trim().split(&quot; &quot;);</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineplus">+  let parameters = aMessage.params</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+    .slice(-1)[0]</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineplus">+    .trim()</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineplus">+    .split(&quot; &quot;);</span>
<a href="#l47.31"></a><span id="l47.31">   // The subcommand is the second parameter...although sometimes it's the first</span>
<a href="#l47.32"></a><span id="l47.32">   // parameter.</span>
<a href="#l47.33"></a><span id="l47.33">   aMessage.cap = {</span>
<a href="#l47.34"></a><span id="l47.34">     subcommand: aMessage.params[aMessage.params.length == 3 ? 1 : 0],</span>
<a href="#l47.35"></a><span id="l47.35">   };</span>
<a href="#l47.36"></a><span id="l47.36"> </span>
<a href="#l47.37"></a><span id="l47.37">   return parameters.map(function(aParameter) {</span>
<a href="#l47.38"></a><span id="l47.38">     // Clone the original object.</span>
<a href="#l47.39"></a><span id="l47.39">     let message = Object.assign({}, aMessage);</span>
<a href="#l47.40"></a><span id="l47.40">     message.cap = Object.assign({}, aMessage.cap);</span>
<a href="#l47.41"></a><span id="l47.41"> </span>
<a href="#l47.42"></a><span id="l47.42">     // If there's a modifier...pull it off. (This is pretty much unused, but we</span>
<a href="#l47.43"></a><span id="l47.43">     // have to pull it off for backward compatibility.)</span>
<a href="#l47.44"></a><span id="l47.44">     if (&quot;-=~&quot;.includes(aParameter[0])) {</span>
<a href="#l47.45"></a><span id="l47.45">       message.cap.modifier = aParameter[0];</span>
<a href="#l47.46"></a><span id="l47.46">       aParameter = aParameter.substr(1);</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-    } else</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+    } else {</span>
<a href="#l47.49"></a><span id="l47.49">       message.cap.modifier = undefined;</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+    }</span>
<a href="#l47.51"></a><span id="l47.51"> </span>
<a href="#l47.52"></a><span id="l47.52">     // The names are case insensitive, arbitrarily choose lowercase.</span>
<a href="#l47.53"></a><span id="l47.53">     message.cap.parameter = aParameter.toLowerCase();</span>
<a href="#l47.54"></a><span id="l47.54">     message.cap.disable = message.cap.modifier == &quot;-&quot;;</span>
<a href="#l47.55"></a><span id="l47.55">     message.cap.sticky = message.cap.modifier == &quot;=&quot;;</span>
<a href="#l47.56"></a><span id="l47.56">     message.cap.ack = message.cap.modifier == &quot;~&quot;;</span>
<a href="#l47.57"></a><span id="l47.57"> </span>
<a href="#l47.58"></a><span id="l47.58">     return message;</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineat">@@ -62,35 +68,43 @@ function capMessage(aMessage) {</span>
<a href="#l47.60"></a><span id="l47.60"> </span>
<a href="#l47.61"></a><span id="l47.61"> var ircCAP = {</span>
<a href="#l47.62"></a><span id="l47.62">   name: &quot;Client Capabilities&quot;,</span>
<a href="#l47.63"></a><span id="l47.63">   // Slightly above default RFC 2812 priority.</span>
<a href="#l47.64"></a><span id="l47.64">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l47.65"></a><span id="l47.65">   isEnabled: () =&gt; true,</span>
<a href="#l47.66"></a><span id="l47.66"> </span>
<a href="#l47.67"></a><span id="l47.67">   commands: {</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineminus">-    &quot;CAP&quot;: function(aMessage) {</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+    CAP(aMessage) {</span>
<a href="#l47.70"></a><span id="l47.70">       // [* | &lt;nick&gt;] &lt;subcommand&gt; :&lt;parameters&gt;</span>
<a href="#l47.71"></a><span id="l47.71">       let messages = capMessage(aMessage);</span>
<a href="#l47.72"></a><span id="l47.72"> </span>
<a href="#l47.73"></a><span id="l47.73" class="difflineminus">-      messages = messages.filter(aMessage =&gt;</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineminus">-        !ircHandlers.handleCAPMessage(this, aMessage));</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineplus">+      messages = messages.filter(</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+        aMessage =&gt; !ircHandlers.handleCAPMessage(this, aMessage)</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+      );</span>
<a href="#l47.78"></a><span id="l47.78">       if (messages.length) {</span>
<a href="#l47.79"></a><span id="l47.79">         // Display the list of unhandled CAP messages.</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineminus">-        let unhandledMessages =</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineminus">-          messages.map(aMsg =&gt; aMsg.cap.parameter).join(&quot; &quot;);</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineminus">-        this.LOG(&quot;Unhandled CAP messages: &quot; + unhandledMessages +</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineminus">-                 &quot;\nRaw message: &quot; + aMessage.rawMessage);</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+        let unhandledMessages = messages</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineplus">+          .map(aMsg =&gt; aMsg.cap.parameter)</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineplus">+          .join(&quot; &quot;);</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineplus">+        this.LOG(</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+          &quot;Unhandled CAP messages: &quot; +</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+            unhandledMessages +</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineplus">+            &quot;\nRaw message: &quot; +</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineplus">+            aMessage.rawMessage</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineplus">+        );</span>
<a href="#l47.93"></a><span id="l47.93">       }</span>
<a href="#l47.94"></a><span id="l47.94"> </span>
<a href="#l47.95"></a><span id="l47.95">       // If no CAP handlers were added, just tell the server we're done.</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineminus">-      if (aMessage.cap.subcommand == &quot;LS&quot; &amp;&amp; !this._caps.size)</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineplus">+      if (aMessage.cap.subcommand == &quot;LS&quot; &amp;&amp; !this._caps.size) {</span>
<a href="#l47.98"></a><span id="l47.98">         this.sendMessage(&quot;CAP&quot;, &quot;END&quot;);</span>
<a href="#l47.99"></a><span id="l47.99" class="difflineplus">+      }</span>
<a href="#l47.100"></a><span id="l47.100">       return true;</span>
<a href="#l47.101"></a><span id="l47.101">     },</span>
<a href="#l47.102"></a><span id="l47.102"> </span>
<a href="#l47.103"></a><span id="l47.103" class="difflineminus">-    &quot;410&quot;: function(aMessage) { // ERR_INVALIDCAPCMD</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineplus">+    &quot;410&quot;: function(aMessage) {</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineplus">+      // ERR_INVALIDCAPCMD</span>
<a href="#l47.106"></a><span id="l47.106">       // &lt;unrecognized subcommand&gt; :Invalid CAP subcommand</span>
<a href="#l47.107"></a><span id="l47.107">       this.WARN(&quot;Invalid subcommand: &quot; + aMessage.params[1]);</span>
<a href="#l47.108"></a><span id="l47.108">       return true;</span>
<a href="#l47.109"></a><span id="l47.109">     },</span>
<a href="#l47.110"></a><span id="l47.110">   },</span>
<a href="#l47.111"></a><span id="l47.111"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -5,241 +5,286 @@</span>
<a href="#l48.4"></a><span id="l48.4"> /*</span>
<a href="#l48.5"></a><span id="l48.5">  * This implements the Client-to-Client Protocol (CTCP), a subprotocol of IRC.</span>
<a href="#l48.6"></a><span id="l48.6">  *   REVISED AND UPDATED CTCP SPECIFICATION</span>
<a href="#l48.7"></a><span id="l48.7">  *     http://www.alien.net.au/irc/ctcp.txt</span>
<a href="#l48.8"></a><span id="l48.8">  */</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> this.EXPORTED_SYMBOLS = [&quot;ircCTCP&quot;, &quot;ctcpBase&quot;];</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-var {_} = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+);</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+var { _ } = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l48.20"></a><span id="l48.20"> </span>
<a href="#l48.21"></a><span id="l48.21"> // Split into a CTCP message which is a single command and a single parameter:</span>
<a href="#l48.22"></a><span id="l48.22"> //   &lt;command&gt; &quot; &quot; &lt;parameter&gt;</span>
<a href="#l48.23"></a><span id="l48.23"> // The high level dequote is to unescape \001 in the message content.</span>
<a href="#l48.24"></a><span id="l48.24"> function CTCPMessage(aMessage, aRawCTCPMessage) {</span>
<a href="#l48.25"></a><span id="l48.25">   let message = Object.assign({}, aMessage);</span>
<a href="#l48.26"></a><span id="l48.26">   message.ctcp = {};</span>
<a href="#l48.27"></a><span id="l48.27">   message.ctcp.rawMessage = aRawCTCPMessage;</span>
<a href="#l48.28"></a><span id="l48.28"> </span>
<a href="#l48.29"></a><span id="l48.29">   // High/CTCP level dequote: replace the quote char \134 followed by a or \134</span>
<a href="#l48.30"></a><span id="l48.30">   // with \001 or \134, respectively. Any other character after \134 is replaced</span>
<a href="#l48.31"></a><span id="l48.31">   // with itself.</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineminus">-  let dequotedCTCPMessage = message.ctcp.rawMessage.replace(/\\(.|$)/g,</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+  let dequotedCTCPMessage = message.ctcp.rawMessage.replace(</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+    /\\(.|$)/g,</span>
<a href="#l48.35"></a><span id="l48.35">     aStr =&gt; {</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineminus">-      if (aStr[1])</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+      if (aStr[1]) {</span>
<a href="#l48.38"></a><span id="l48.38">         return aStr[1] == &quot;a&quot; ? &quot;\x01&quot; : aStr[1];</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+      }</span>
<a href="#l48.40"></a><span id="l48.40">       return &quot;&quot;;</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineminus">-    });</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineplus">+    }</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineplus">+  );</span>
<a href="#l48.44"></a><span id="l48.44"> </span>
<a href="#l48.45"></a><span id="l48.45">   let separator = dequotedCTCPMessage.indexOf(&quot; &quot;);</span>
<a href="#l48.46"></a><span id="l48.46">   // If there's no space, then only a command is given.</span>
<a href="#l48.47"></a><span id="l48.47">   // Do not capitalize the command, case sensitive</span>
<a href="#l48.48"></a><span id="l48.48">   if (separator == -1) {</span>
<a href="#l48.49"></a><span id="l48.49">     message.ctcp.command = dequotedCTCPMessage;</span>
<a href="#l48.50"></a><span id="l48.50">     message.ctcp.param = &quot;&quot;;</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-  }</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-  else {</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+  } else {</span>
<a href="#l48.54"></a><span id="l48.54">     message.ctcp.command = dequotedCTCPMessage.slice(0, separator);</span>
<a href="#l48.55"></a><span id="l48.55">     message.ctcp.param = dequotedCTCPMessage.slice(separator + 1);</span>
<a href="#l48.56"></a><span id="l48.56">   }</span>
<a href="#l48.57"></a><span id="l48.57">   return message;</span>
<a href="#l48.58"></a><span id="l48.58"> }</span>
<a href="#l48.59"></a><span id="l48.59"> </span>
<a href="#l48.60"></a><span id="l48.60" class="difflineminus">-</span>
<a href="#l48.61"></a><span id="l48.61"> // This is the CTCP handler for IRC protocol, it will call each CTCP handler.</span>
<a href="#l48.62"></a><span id="l48.62"> var ircCTCP = {</span>
<a href="#l48.63"></a><span id="l48.63">   name: &quot;CTCP&quot;,</span>
<a href="#l48.64"></a><span id="l48.64">   // Slightly above default RFC 2812 priority.</span>
<a href="#l48.65"></a><span id="l48.65">   priority: ircHandlers.HIGH_PRIORITY,</span>
<a href="#l48.66"></a><span id="l48.66">   isEnabled: () =&gt; true,</span>
<a href="#l48.67"></a><span id="l48.67"> </span>
<a href="#l48.68"></a><span id="l48.68">   // CTCP uses only PRIVMSG and NOTICE commands.</span>
<a href="#l48.69"></a><span id="l48.69">   commands: {</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineminus">-    &quot;PRIVMSG&quot;: ctcpHandleMessage,</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineminus">-    &quot;NOTICE&quot;: ctcpHandleMessage,</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineplus">+    PRIVMSG: ctcpHandleMessage,</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+    NOTICE: ctcpHandleMessage,</span>
<a href="#l48.74"></a><span id="l48.74">   },</span>
<a href="#l48.75"></a><span id="l48.75"> };</span>
<a href="#l48.76"></a><span id="l48.76"> // Parse the message and call all CTCP handlers on the message.</span>
<a href="#l48.77"></a><span id="l48.77"> function ctcpHandleMessage(aMessage) {</span>
<a href="#l48.78"></a><span id="l48.78">   // If there are no CTCP handlers, then don't parse the CTCP message.</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineminus">-  if (!ircHandlers.hasCTCPHandlers)</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+  if (!ircHandlers.hasCTCPHandlers) {</span>
<a href="#l48.81"></a><span id="l48.81">     return false;</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+  }</span>
<a href="#l48.83"></a><span id="l48.83"> </span>
<a href="#l48.84"></a><span id="l48.84">   // The raw CTCP message is in the last parameter of the IRC message.</span>
<a href="#l48.85"></a><span id="l48.85">   let rawCTCPParam = aMessage.params.slice(-1)[0];</span>
<a href="#l48.86"></a><span id="l48.86"> </span>
<a href="#l48.87"></a><span id="l48.87">   // Split the raw message into the multiple CTCP messages and pull out the</span>
<a href="#l48.88"></a><span id="l48.88">   // command and parameters.</span>
<a href="#l48.89"></a><span id="l48.89">   let ctcpMessages = [];</span>
<a href="#l48.90"></a><span id="l48.90">   // eslint-disable-next-line no-control-regex</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineminus">-  let otherMessage = rawCTCPParam.replace(/\x01([^\x01]*)\x01/g,</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineminus">-    function(aMatch, aMsg) {</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineminus">-      if (aMsg)</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineminus">-        ctcpMessages.push(new CTCPMessage(aMessage, aMsg));</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineminus">-    });</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+  let otherMessage = rawCTCPParam.replace(/\x01([^\x01]*)\x01/g, function(</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+    aMatch,</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+    aMsg</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+  ) {</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineplus">+    if (aMsg) {</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineplus">+      ctcpMessages.push(new CTCPMessage(aMessage, aMsg));</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineplus">+    }</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineplus">+  });</span>
<a href="#l48.106"></a><span id="l48.106"> </span>
<a href="#l48.107"></a><span id="l48.107">   // If no CTCP messages were found, return false.</span>
<a href="#l48.108"></a><span id="l48.108" class="difflineminus">-  if (!ctcpMessages.length)</span>
<a href="#l48.109"></a><span id="l48.109" class="difflineplus">+  if (!ctcpMessages.length) {</span>
<a href="#l48.110"></a><span id="l48.110">     return false;</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineplus">+  }</span>
<a href="#l48.112"></a><span id="l48.112"> </span>
<a href="#l48.113"></a><span id="l48.113">   // If there's some message left, send it back through the IRC handlers after</span>
<a href="#l48.114"></a><span id="l48.114">   // stripping out the CTCP information. I highly doubt this will ever happen,</span>
<a href="#l48.115"></a><span id="l48.115">   // but just in case. ;)</span>
<a href="#l48.116"></a><span id="l48.116">   if (otherMessage) {</span>
<a href="#l48.117"></a><span id="l48.117">     let message = aMessage;</span>
<a href="#l48.118"></a><span id="l48.118">     message.params.pop();</span>
<a href="#l48.119"></a><span id="l48.119">     message.params.push(otherMessage);</span>
<a href="#l48.120"></a><span id="l48.120">     ircHandlers.handleMessage(this, message);</span>
<a href="#l48.121"></a><span id="l48.121">   }</span>
<a href="#l48.122"></a><span id="l48.122"> </span>
<a href="#l48.123"></a><span id="l48.123">   // Loop over each raw CTCP message.</span>
<a href="#l48.124"></a><span id="l48.124">   for (let message of ctcpMessages) {</span>
<a href="#l48.125"></a><span id="l48.125">     if (!ircHandlers.handleCTCPMessage(this, message)) {</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineminus">-      this.WARN(&quot;Unhandled CTCP message: &quot; + message.ctcp.rawMessage +</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineminus">-                &quot;\nin IRC message: &quot; + message.rawMessage);</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineplus">+      this.WARN(</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineplus">+        &quot;Unhandled CTCP message: &quot; +</span>
<a href="#l48.130"></a><span id="l48.130" class="difflineplus">+          message.ctcp.rawMessage +</span>
<a href="#l48.131"></a><span id="l48.131" class="difflineplus">+          &quot;\nin IRC message: &quot; +</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineplus">+          message.rawMessage</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineplus">+      );</span>
<a href="#l48.134"></a><span id="l48.134">       // For unhandled CTCP message, respond with a NOTICE ERRMSG that echoes</span>
<a href="#l48.135"></a><span id="l48.135">       // back the original command.</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineminus">-      this.sendCTCPMessage(message.origin, true, &quot;ERRMSG&quot;,</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineminus">-                           [message.ctcp.rawMessage, &quot;:Unhandled CTCP command&quot;]);</span>
<a href="#l48.138"></a><span id="l48.138" class="difflineplus">+      this.sendCTCPMessage(message.origin, true, &quot;ERRMSG&quot;, [</span>
<a href="#l48.139"></a><span id="l48.139" class="difflineplus">+        message.ctcp.rawMessage,</span>
<a href="#l48.140"></a><span id="l48.140" class="difflineplus">+        &quot;:Unhandled CTCP command&quot;,</span>
<a href="#l48.141"></a><span id="l48.141" class="difflineplus">+      ]);</span>
<a href="#l48.142"></a><span id="l48.142">     }</span>
<a href="#l48.143"></a><span id="l48.143">   }</span>
<a href="#l48.144"></a><span id="l48.144"> </span>
<a href="#l48.145"></a><span id="l48.145">   // We have handled this message as much as we can.</span>
<a href="#l48.146"></a><span id="l48.146">   return true;</span>
<a href="#l48.147"></a><span id="l48.147"> }</span>
<a href="#l48.148"></a><span id="l48.148"> </span>
<a href="#l48.149"></a><span id="l48.149"> // This is the the basic CTCP protocol.</span>
<a href="#l48.150"></a><span id="l48.150"> var ctcpBase = {</span>
<a href="#l48.151"></a><span id="l48.151">   // Parameters</span>
<a href="#l48.152"></a><span id="l48.152">   name: &quot;CTCP&quot;,</span>
<a href="#l48.153"></a><span id="l48.153">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l48.154"></a><span id="l48.154">   isEnabled: () =&gt; true,</span>
<a href="#l48.155"></a><span id="l48.155"> </span>
<a href="#l48.156"></a><span id="l48.156">   // These represent CTCP commands.</span>
<a href="#l48.157"></a><span id="l48.157">   commands: {</span>
<a href="#l48.158"></a><span id="l48.158" class="difflineminus">-    &quot;ACTION&quot;: function(aMessage) {</span>
<a href="#l48.159"></a><span id="l48.159" class="difflineplus">+    ACTION(aMessage) {</span>
<a href="#l48.160"></a><span id="l48.160">       // ACTION &lt;text&gt;</span>
<a href="#l48.161"></a><span id="l48.161">       // Display message in conversation</span>
<a href="#l48.162"></a><span id="l48.162" class="difflineminus">-      this.getConversation(this.isMUCName(aMessage.params[0]) ?</span>
<a href="#l48.163"></a><span id="l48.163" class="difflineminus">-                             aMessage.params[0] : aMessage.origin)</span>
<a href="#l48.164"></a><span id="l48.164" class="difflineminus">-          .writeMessage(aMessage.origin, &quot;/me &quot; + aMessage.ctcp.param,</span>
<a href="#l48.165"></a><span id="l48.165" class="difflineminus">-                        {incoming: true, tags: aMessage.tags});</span>
<a href="#l48.166"></a><span id="l48.166" class="difflineplus">+      this.getConversation(</span>
<a href="#l48.167"></a><span id="l48.167" class="difflineplus">+        this.isMUCName(aMessage.params[0])</span>
<a href="#l48.168"></a><span id="l48.168" class="difflineplus">+          ? aMessage.params[0]</span>
<a href="#l48.169"></a><span id="l48.169" class="difflineplus">+          : aMessage.origin</span>
<a href="#l48.170"></a><span id="l48.170" class="difflineplus">+      ).writeMessage(aMessage.origin, &quot;/me &quot; + aMessage.ctcp.param, {</span>
<a href="#l48.171"></a><span id="l48.171" class="difflineplus">+        incoming: true,</span>
<a href="#l48.172"></a><span id="l48.172" class="difflineplus">+        tags: aMessage.tags,</span>
<a href="#l48.173"></a><span id="l48.173" class="difflineplus">+      });</span>
<a href="#l48.174"></a><span id="l48.174">       return true;</span>
<a href="#l48.175"></a><span id="l48.175">     },</span>
<a href="#l48.176"></a><span id="l48.176"> </span>
<a href="#l48.177"></a><span id="l48.177">     // Used when an error needs to be replied with.</span>
<a href="#l48.178"></a><span id="l48.178" class="difflineminus">-    &quot;ERRMSG&quot;: function(aMessage) {</span>
<a href="#l48.179"></a><span id="l48.179" class="difflineminus">-      this.WARN(aMessage.origin + &quot; failed to handle CTCP message: &quot; +</span>
<a href="#l48.180"></a><span id="l48.180" class="difflineminus">-                aMessage.ctcp.param);</span>
<a href="#l48.181"></a><span id="l48.181" class="difflineplus">+    ERRMSG(aMessage) {</span>
<a href="#l48.182"></a><span id="l48.182" class="difflineplus">+      this.WARN(</span>
<a href="#l48.183"></a><span id="l48.183" class="difflineplus">+        aMessage.origin +</span>
<a href="#l48.184"></a><span id="l48.184" class="difflineplus">+          &quot; failed to handle CTCP message: &quot; +</span>
<a href="#l48.185"></a><span id="l48.185" class="difflineplus">+          aMessage.ctcp.param</span>
<a href="#l48.186"></a><span id="l48.186" class="difflineplus">+      );</span>
<a href="#l48.187"></a><span id="l48.187">       return true;</span>
<a href="#l48.188"></a><span id="l48.188">     },</span>
<a href="#l48.189"></a><span id="l48.189"> </span>
<a href="#l48.190"></a><span id="l48.190">     // This is commented out since CLIENTINFO automatically returns the</span>
<a href="#l48.191"></a><span id="l48.191">     // supported CTCP parameters and this is not supported.</span>
<a href="#l48.192"></a><span id="l48.192"> </span>
<a href="#l48.193"></a><span id="l48.193">     // Returns the user's full name, and idle time.</span>
<a href="#l48.194"></a><span id="l48.194">     // &quot;FINGER&quot;: function(aMessage) { return false; },</span>
<a href="#l48.195"></a><span id="l48.195"> </span>
<a href="#l48.196"></a><span id="l48.196">     // Dynamic master index of what a client knows.</span>
<a href="#l48.197"></a><span id="l48.197" class="difflineminus">-    &quot;CLIENTINFO&quot;: function(aMessage) {</span>
<a href="#l48.198"></a><span id="l48.198" class="difflineplus">+    CLIENTINFO(aMessage) {</span>
<a href="#l48.199"></a><span id="l48.199">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l48.200"></a><span id="l48.200">         // Received a CLIENTINFO request, respond with the support CTCP</span>
<a href="#l48.201"></a><span id="l48.201">         // messages.</span>
<a href="#l48.202"></a><span id="l48.202">         let info = new Set();</span>
<a href="#l48.203"></a><span id="l48.203">         for (let handler of ircHandlers._ctcpHandlers) {</span>
<a href="#l48.204"></a><span id="l48.204" class="difflineminus">-          for (let command in handler.commands)</span>
<a href="#l48.205"></a><span id="l48.205" class="difflineplus">+          for (let command in handler.commands) {</span>
<a href="#l48.206"></a><span id="l48.206">             info.add(command);</span>
<a href="#l48.207"></a><span id="l48.207" class="difflineplus">+          }</span>
<a href="#l48.208"></a><span id="l48.208">         }</span>
<a href="#l48.209"></a><span id="l48.209"> </span>
<a href="#l48.210"></a><span id="l48.210">         let supportedCtcp = [...info].join(&quot; &quot;);</span>
<a href="#l48.211"></a><span id="l48.211" class="difflineminus">-        this.LOG(&quot;Reporting support for the following CTCP messages: &quot; +</span>
<a href="#l48.212"></a><span id="l48.212" class="difflineminus">-                 supportedCtcp);</span>
<a href="#l48.213"></a><span id="l48.213" class="difflineminus">-        this.sendCTCPMessage(aMessage.origin, true, &quot;CLIENTINFO&quot;,</span>
<a href="#l48.214"></a><span id="l48.214" class="difflineminus">-                             supportedCtcp);</span>
<a href="#l48.215"></a><span id="l48.215" class="difflineminus">-      }</span>
<a href="#l48.216"></a><span id="l48.216" class="difflineminus">-      else {</span>
<a href="#l48.217"></a><span id="l48.217" class="difflineplus">+        this.LOG(</span>
<a href="#l48.218"></a><span id="l48.218" class="difflineplus">+          &quot;Reporting support for the following CTCP messages: &quot; + supportedCtcp</span>
<a href="#l48.219"></a><span id="l48.219" class="difflineplus">+        );</span>
<a href="#l48.220"></a><span id="l48.220" class="difflineplus">+        this.sendCTCPMessage(</span>
<a href="#l48.221"></a><span id="l48.221" class="difflineplus">+          aMessage.origin,</span>
<a href="#l48.222"></a><span id="l48.222" class="difflineplus">+          true,</span>
<a href="#l48.223"></a><span id="l48.223" class="difflineplus">+          &quot;CLIENTINFO&quot;,</span>
<a href="#l48.224"></a><span id="l48.224" class="difflineplus">+          supportedCtcp</span>
<a href="#l48.225"></a><span id="l48.225" class="difflineplus">+        );</span>
<a href="#l48.226"></a><span id="l48.226" class="difflineplus">+      } else {</span>
<a href="#l48.227"></a><span id="l48.227">         // Received a CLIENTINFO response, store the information for future</span>
<a href="#l48.228"></a><span id="l48.228">         // use.</span>
<a href="#l48.229"></a><span id="l48.229">         let info = aMessage.ctcp.param.split(&quot; &quot;);</span>
<a href="#l48.230"></a><span id="l48.230" class="difflineminus">-        this.setWhois(aMessage.origin, {clientInfo: info});</span>
<a href="#l48.231"></a><span id="l48.231" class="difflineplus">+        this.setWhois(aMessage.origin, { clientInfo: info });</span>
<a href="#l48.232"></a><span id="l48.232">       }</span>
<a href="#l48.233"></a><span id="l48.233">       return true;</span>
<a href="#l48.234"></a><span id="l48.234">     },</span>
<a href="#l48.235"></a><span id="l48.235"> </span>
<a href="#l48.236"></a><span id="l48.236">     // Used to measure the delay of the IRC network between clients.</span>
<a href="#l48.237"></a><span id="l48.237" class="difflineminus">-    &quot;PING&quot;: function(aMessage) {</span>
<a href="#l48.238"></a><span id="l48.238" class="difflineplus">+    PING(aMessage) {</span>
<a href="#l48.239"></a><span id="l48.239">       // PING timestamp</span>
<a href="#l48.240"></a><span id="l48.240">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l48.241"></a><span id="l48.241">         // Received PING request, send PING response.</span>
<a href="#l48.242"></a><span id="l48.242" class="difflineminus">-        this.LOG(&quot;Received PING request from &quot; + aMessage.origin +</span>
<a href="#l48.243"></a><span id="l48.243" class="difflineminus">-                 &quot;. Sending PING response: \&quot;&quot; + aMessage.ctcp.param + &quot;\&quot;.&quot;);</span>
<a href="#l48.244"></a><span id="l48.244" class="difflineminus">-        this.sendCTCPMessage(aMessage.origin, true, &quot;PING&quot;,</span>
<a href="#l48.245"></a><span id="l48.245" class="difflineminus">-                             aMessage.ctcp.param);</span>
<a href="#l48.246"></a><span id="l48.246" class="difflineplus">+        this.LOG(</span>
<a href="#l48.247"></a><span id="l48.247" class="difflineplus">+          &quot;Received PING request from &quot; +</span>
<a href="#l48.248"></a><span id="l48.248" class="difflineplus">+            aMessage.origin +</span>
<a href="#l48.249"></a><span id="l48.249" class="difflineplus">+            '. Sending PING response: &quot;' +</span>
<a href="#l48.250"></a><span id="l48.250" class="difflineplus">+            aMessage.ctcp.param +</span>
<a href="#l48.251"></a><span id="l48.251" class="difflineplus">+            '&quot;.'</span>
<a href="#l48.252"></a><span id="l48.252" class="difflineplus">+        );</span>
<a href="#l48.253"></a><span id="l48.253" class="difflineplus">+        this.sendCTCPMessage(</span>
<a href="#l48.254"></a><span id="l48.254" class="difflineplus">+          aMessage.origin,</span>
<a href="#l48.255"></a><span id="l48.255" class="difflineplus">+          true,</span>
<a href="#l48.256"></a><span id="l48.256" class="difflineplus">+          &quot;PING&quot;,</span>
<a href="#l48.257"></a><span id="l48.257" class="difflineplus">+          aMessage.ctcp.param</span>
<a href="#l48.258"></a><span id="l48.258" class="difflineplus">+        );</span>
<a href="#l48.259"></a><span id="l48.259">         return true;</span>
<a href="#l48.260"></a><span id="l48.260">       }</span>
<a href="#l48.261"></a><span id="l48.261">       return this.handlePingReply(aMessage.origin, aMessage.ctcp.param);</span>
<a href="#l48.262"></a><span id="l48.262">     },</span>
<a href="#l48.263"></a><span id="l48.263"> </span>
<a href="#l48.264"></a><span id="l48.264">     // These are commented out since CLIENTINFO automatically returns the</span>
<a href="#l48.265"></a><span id="l48.265">     // supported CTCP parameters and this is not supported.</span>
<a href="#l48.266"></a><span id="l48.266"> </span>
<a href="#l48.267"></a><span id="l48.267">     // An encryption protocol between clients without any known reference.</span>
<a href="#l48.268"></a><span id="l48.268">     // &quot;SED&quot;: function(aMessage) { return false; },</span>
<a href="#l48.269"></a><span id="l48.269"> </span>
<a href="#l48.270"></a><span id="l48.270">     // Where to obtain a copy of a client.</span>
<a href="#l48.271"></a><span id="l48.271">     // &quot;SOURCE&quot;: function(aMessage) { return false; },</span>
<a href="#l48.272"></a><span id="l48.272"> </span>
<a href="#l48.273"></a><span id="l48.273">     // Gets the local date and time from other clients.</span>
<a href="#l48.274"></a><span id="l48.274" class="difflineminus">-    &quot;TIME&quot;: function(aMessage) {</span>
<a href="#l48.275"></a><span id="l48.275" class="difflineplus">+    TIME(aMessage) {</span>
<a href="#l48.276"></a><span id="l48.276">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l48.277"></a><span id="l48.277">         // TIME</span>
<a href="#l48.278"></a><span id="l48.278">         // Received a TIME request, send a human readable response.</span>
<a href="#l48.279"></a><span id="l48.279" class="difflineminus">-        let now = (new Date()).toString();</span>
<a href="#l48.280"></a><span id="l48.280" class="difflineminus">-        this.LOG(&quot;Received TIME request from &quot; + aMessage.origin +</span>
<a href="#l48.281"></a><span id="l48.281" class="difflineminus">-                 &quot;. Sending TIME response: \&quot;&quot; + now + &quot;\&quot;.&quot;);</span>
<a href="#l48.282"></a><span id="l48.282" class="difflineplus">+        let now = new Date().toString();</span>
<a href="#l48.283"></a><span id="l48.283" class="difflineplus">+        this.LOG(</span>
<a href="#l48.284"></a><span id="l48.284" class="difflineplus">+          &quot;Received TIME request from &quot; +</span>
<a href="#l48.285"></a><span id="l48.285" class="difflineplus">+            aMessage.origin +</span>
<a href="#l48.286"></a><span id="l48.286" class="difflineplus">+            '. Sending TIME response: &quot;' +</span>
<a href="#l48.287"></a><span id="l48.287" class="difflineplus">+            now +</span>
<a href="#l48.288"></a><span id="l48.288" class="difflineplus">+            '&quot;.'</span>
<a href="#l48.289"></a><span id="l48.289" class="difflineplus">+        );</span>
<a href="#l48.290"></a><span id="l48.290">         this.sendCTCPMessage(aMessage.origin, true, &quot;TIME&quot;, &quot;:&quot; + now);</span>
<a href="#l48.291"></a><span id="l48.291" class="difflineminus">-      }</span>
<a href="#l48.292"></a><span id="l48.292" class="difflineminus">-      else {</span>
<a href="#l48.293"></a><span id="l48.293" class="difflineplus">+      } else {</span>
<a href="#l48.294"></a><span id="l48.294">         // TIME :&lt;human-readable-time-string&gt;</span>
<a href="#l48.295"></a><span id="l48.295">         // Received a TIME reply, display it.</span>
<a href="#l48.296"></a><span id="l48.296">         // Remove the : prefix, if it exists and display the result.</span>
<a href="#l48.297"></a><span id="l48.297">         let time = aMessage.ctcp.param.slice(aMessage.ctcp.param[0] == &quot;:&quot;);</span>
<a href="#l48.298"></a><span id="l48.298" class="difflineminus">-        this.getConversation(aMessage.origin)</span>
<a href="#l48.299"></a><span id="l48.299" class="difflineminus">-            .writeMessage(aMessage.origin,</span>
<a href="#l48.300"></a><span id="l48.300" class="difflineminus">-                          _(&quot;ctcp.time&quot;, aMessage.origin, time),</span>
<a href="#l48.301"></a><span id="l48.301" class="difflineminus">-                          {system: true, tags: aMessage.tags});</span>
<a href="#l48.302"></a><span id="l48.302" class="difflineplus">+        this.getConversation(aMessage.origin).writeMessage(</span>
<a href="#l48.303"></a><span id="l48.303" class="difflineplus">+          aMessage.origin,</span>
<a href="#l48.304"></a><span id="l48.304" class="difflineplus">+          _(&quot;ctcp.time&quot;, aMessage.origin, time),</span>
<a href="#l48.305"></a><span id="l48.305" class="difflineplus">+          { system: true, tags: aMessage.tags }</span>
<a href="#l48.306"></a><span id="l48.306" class="difflineplus">+        );</span>
<a href="#l48.307"></a><span id="l48.307">       }</span>
<a href="#l48.308"></a><span id="l48.308">       return true;</span>
<a href="#l48.309"></a><span id="l48.309">     },</span>
<a href="#l48.310"></a><span id="l48.310"> </span>
<a href="#l48.311"></a><span id="l48.311">     // This is commented out since CLIENTINFO automatically returns the</span>
<a href="#l48.312"></a><span id="l48.312">     // supported CTCP parameters and this is not supported.</span>
<a href="#l48.313"></a><span id="l48.313"> </span>
<a href="#l48.314"></a><span id="l48.314">     // A string set by the user (never the client coder)</span>
<a href="#l48.315"></a><span id="l48.315">     // &quot;USERINFO&quot;: function(aMessage) { return false; },</span>
<a href="#l48.316"></a><span id="l48.316"> </span>
<a href="#l48.317"></a><span id="l48.317">     // The version and type of the client.</span>
<a href="#l48.318"></a><span id="l48.318" class="difflineminus">-    &quot;VERSION&quot;: function(aMessage) {</span>
<a href="#l48.319"></a><span id="l48.319" class="difflineplus">+    VERSION(aMessage) {</span>
<a href="#l48.320"></a><span id="l48.320">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l48.321"></a><span id="l48.321">         // VERSION</span>
<a href="#l48.322"></a><span id="l48.322">         // Received VERSION request, send VERSION response.</span>
<a href="#l48.323"></a><span id="l48.323">         let version = Services.appinfo.name + &quot; &quot; + Services.appinfo.version;</span>
<a href="#l48.324"></a><span id="l48.324" class="difflineminus">-        this.LOG(&quot;Received VERSION request from &quot; + aMessage.origin +</span>
<a href="#l48.325"></a><span id="l48.325" class="difflineminus">-                 &quot;. Sending VERSION response: \&quot;&quot; + version + &quot;\&quot;.&quot;);</span>
<a href="#l48.326"></a><span id="l48.326" class="difflineplus">+        this.LOG(</span>
<a href="#l48.327"></a><span id="l48.327" class="difflineplus">+          &quot;Received VERSION request from &quot; +</span>
<a href="#l48.328"></a><span id="l48.328" class="difflineplus">+            aMessage.origin +</span>
<a href="#l48.329"></a><span id="l48.329" class="difflineplus">+            '. Sending VERSION response: &quot;' +</span>
<a href="#l48.330"></a><span id="l48.330" class="difflineplus">+            version +</span>
<a href="#l48.331"></a><span id="l48.331" class="difflineplus">+            '&quot;.'</span>
<a href="#l48.332"></a><span id="l48.332" class="difflineplus">+        );</span>
<a href="#l48.333"></a><span id="l48.333">         this.sendCTCPMessage(aMessage.origin, true, &quot;VERSION&quot;, version);</span>
<a href="#l48.334"></a><span id="l48.334" class="difflineminus">-      }</span>
<a href="#l48.335"></a><span id="l48.335" class="difflineminus">-      else if (aMessage.command == &quot;NOTICE&quot; &amp;&amp; aMessage.ctcp.param.length) {</span>
<a href="#l48.336"></a><span id="l48.336" class="difflineplus">+      } else if (aMessage.command == &quot;NOTICE&quot; &amp;&amp; aMessage.ctcp.param.length) {</span>
<a href="#l48.337"></a><span id="l48.337">         // VERSION #:#:#</span>
<a href="#l48.338"></a><span id="l48.338">         // Received VERSION response, display to the user.</span>
<a href="#l48.339"></a><span id="l48.339" class="difflineminus">-        let response = _(&quot;ctcp.version&quot;, aMessage.origin,</span>
<a href="#l48.340"></a><span id="l48.340" class="difflineminus">-                         aMessage.ctcp.param);</span>
<a href="#l48.341"></a><span id="l48.341" class="difflineminus">-        this.getConversation(aMessage.origin)</span>
<a href="#l48.342"></a><span id="l48.342" class="difflineminus">-            .writeMessage(aMessage.origin, response,</span>
<a href="#l48.343"></a><span id="l48.343" class="difflineminus">-                          {system: true, tags: aMessage.tags});</span>
<a href="#l48.344"></a><span id="l48.344" class="difflineplus">+        let response = _(&quot;ctcp.version&quot;, aMessage.origin, aMessage.ctcp.param);</span>
<a href="#l48.345"></a><span id="l48.345" class="difflineplus">+        this.getConversation(aMessage.origin).writeMessage(</span>
<a href="#l48.346"></a><span id="l48.346" class="difflineplus">+          aMessage.origin,</span>
<a href="#l48.347"></a><span id="l48.347" class="difflineplus">+          response,</span>
<a href="#l48.348"></a><span id="l48.348" class="difflineplus">+          { system: true, tags: aMessage.tags }</span>
<a href="#l48.349"></a><span id="l48.349" class="difflineplus">+        );</span>
<a href="#l48.350"></a><span id="l48.350">       }</span>
<a href="#l48.351"></a><span id="l48.351">       return true;</span>
<a href="#l48.352"></a><span id="l48.352">     },</span>
<a href="#l48.353"></a><span id="l48.353">   },</span>
<a href="#l48.354"></a><span id="l48.354"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/chat/protocols/irc/ircCommands.jsm</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/chat/protocols/irc/ircCommands.jsm</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,53 +1,60 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.5"></a><span id="l49.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.6"></a><span id="l49.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> // This is to be exported directly onto the IRC prplIProtocol object, directly</span>
<a href="#l49.9"></a><span id="l49.9"> // implementing the commands field before we register them.</span>
<a href="#l49.10"></a><span id="l49.10"> this.EXPORTED_SYMBOLS = [&quot;commands&quot;];</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-var {ClassInfo} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-var {_} = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+var { ClassInfo } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+var { _ } = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19"> // Shortcut to get the JavaScript conversation object.</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-function getConv(aConv) { return aConv.wrappedJSObject; }</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+function getConv(aConv) {</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+  return aConv.wrappedJSObject;</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+}</span>
<a href="#l49.24"></a><span id="l49.24"> </span>
<a href="#l49.25"></a><span id="l49.25"> // Shortcut to get the JavaScript account object.</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineminus">-function getAccount(aConv) { return getConv(aConv)._account; }</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+function getAccount(aConv) {</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+  return getConv(aConv)._account;</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+}</span>
<a href="#l49.30"></a><span id="l49.30"> </span>
<a href="#l49.31"></a><span id="l49.31"> // Trim leading and trailing spaces and split a string by any type of space.</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-function splitInput(aString) { return aString.trim().split(/\s+/); }</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+function splitInput(aString) {</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+  return aString.trim().split(/\s+/);</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineplus">+}</span>
<a href="#l49.36"></a><span id="l49.36"> </span>
<a href="#l49.37"></a><span id="l49.37"> function OutgoingMessage(aMsg, aConversation, aAction) {</span>
<a href="#l49.38"></a><span id="l49.38">   this.message = aMsg;</span>
<a href="#l49.39"></a><span id="l49.39">   this.conversation = aConversation;</span>
<a href="#l49.40"></a><span id="l49.40">   this.action = !!aAction;</span>
<a href="#l49.41"></a><span id="l49.41"> }</span>
<a href="#l49.42"></a><span id="l49.42"> OutgoingMessage.prototype = {</span>
<a href="#l49.43"></a><span id="l49.43">   __proto__: ClassInfo(&quot;imIOutgoingMessage&quot;, &quot;Outgoing Message&quot;),</span>
<a href="#l49.44"></a><span id="l49.44">   cancelled: false,</span>
<a href="#l49.45"></a><span id="l49.45"> };</span>
<a href="#l49.46"></a><span id="l49.46"> </span>
<a href="#l49.47"></a><span id="l49.47"> // Kick a user from a channel</span>
<a href="#l49.48"></a><span id="l49.48"> // aMsg is &lt;user&gt; [comment]</span>
<a href="#l49.49"></a><span id="l49.49"> function kickCommand(aMsg, aConv) {</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineminus">-  if (!aMsg.length)</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+  if (!aMsg.length) {</span>
<a href="#l49.52"></a><span id="l49.52">     return false;</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+  }</span>
<a href="#l49.54"></a><span id="l49.54"> </span>
<a href="#l49.55"></a><span id="l49.55">   let params = [aConv.name];</span>
<a href="#l49.56"></a><span id="l49.56">   let offset = aMsg.indexOf(&quot; &quot;);</span>
<a href="#l49.57"></a><span id="l49.57">   if (offset != -1) {</span>
<a href="#l49.58"></a><span id="l49.58">     params.push(aMsg.slice(0, offset));</span>
<a href="#l49.59"></a><span id="l49.59">     params.push(aMsg.slice(offset + 1));</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineplus">+  } else {</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+    params.push(aMsg);</span>
<a href="#l49.62"></a><span id="l49.62">   }</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineminus">-  else</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineminus">-    params.push(aMsg);</span>
<a href="#l49.65"></a><span id="l49.65"> </span>
<a href="#l49.66"></a><span id="l49.66">   getAccount(aConv).sendMessage(&quot;KICK&quot;, params);</span>
<a href="#l49.67"></a><span id="l49.67">   return true;</span>
<a href="#l49.68"></a><span id="l49.68"> }</span>
<a href="#l49.69"></a><span id="l49.69"> </span>
<a href="#l49.70"></a><span id="l49.70"> // Send a message directly to a user.</span>
<a href="#l49.71"></a><span id="l49.71"> // aMsg is &lt;user&gt; &lt;message&gt;</span>
<a href="#l49.72"></a><span id="l49.72"> // aReturnedConv is optional and returns the resulting conversation.</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineat">@@ -58,455 +65,565 @@ function messageCommand(aMsg, aConv, aRe</span>
<a href="#l49.74"></a><span id="l49.74">   let nickname = aMsg;</span>
<a href="#l49.75"></a><span id="l49.75">   let message = &quot;&quot;;</span>
<a href="#l49.76"></a><span id="l49.76"> </span>
<a href="#l49.77"></a><span id="l49.77">   let sep = aMsg.indexOf(&quot; &quot;);</span>
<a href="#l49.78"></a><span id="l49.78">   if (sep &gt; -1) {</span>
<a href="#l49.79"></a><span id="l49.79">     nickname = aMsg.slice(0, sep);</span>
<a href="#l49.80"></a><span id="l49.80">     message = aMsg.slice(sep + 1);</span>
<a href="#l49.81"></a><span id="l49.81">   }</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineminus">-  if (!nickname.length)</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+  if (!nickname.length) {</span>
<a href="#l49.84"></a><span id="l49.84">     return false;</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+  }</span>
<a href="#l49.86"></a><span id="l49.86"> </span>
<a href="#l49.87"></a><span id="l49.87">   let conv = getAccount(aConv).getConversation(nickname);</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineminus">-  if (aReturnedConv)</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+  if (aReturnedConv) {</span>
<a href="#l49.90"></a><span id="l49.90">     aReturnedConv.value = conv;</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineplus">+  }</span>
<a href="#l49.92"></a><span id="l49.92"> </span>
<a href="#l49.93"></a><span id="l49.93" class="difflineminus">-  if (!message.length)</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineplus">+  if (!message.length) {</span>
<a href="#l49.95"></a><span id="l49.95">     return true;</span>
<a href="#l49.96"></a><span id="l49.96" class="difflineplus">+  }</span>
<a href="#l49.97"></a><span id="l49.97"> </span>
<a href="#l49.98"></a><span id="l49.98">   // Give add-ons an opportunity to tweak or cancel the message.</span>
<a href="#l49.99"></a><span id="l49.99">   let om = new OutgoingMessage(message, conv);</span>
<a href="#l49.100"></a><span id="l49.100">   conv.notifyObservers(om, &quot;sending-message&quot;);</span>
<a href="#l49.101"></a><span id="l49.101">   // If a NOTICE is cancelled and resent, it will end up being sent as PRIVMSG.</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineminus">-  if (om.cancelled)</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+  if (om.cancelled) {</span>
<a href="#l49.104"></a><span id="l49.104">     return true;</span>
<a href="#l49.105"></a><span id="l49.105" class="difflineplus">+  }</span>
<a href="#l49.106"></a><span id="l49.106"> </span>
<a href="#l49.107"></a><span id="l49.107">   return privateMessage(aConv, om.message, nickname, aReturnedConv, aIsNotice);</span>
<a href="#l49.108"></a><span id="l49.108"> }</span>
<a href="#l49.109"></a><span id="l49.109"> </span>
<a href="#l49.110"></a><span id="l49.110"> // aAdd is true to add a mode, false to remove a mode.</span>
<a href="#l49.111"></a><span id="l49.111"> function setMode(aNickname, aConv, aMode, aAdd) {</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineminus">-  if (!aNickname.length)</span>
<a href="#l49.113"></a><span id="l49.113" class="difflineplus">+  if (!aNickname.length) {</span>
<a href="#l49.114"></a><span id="l49.114">     return false;</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineplus">+  }</span>
<a href="#l49.116"></a><span id="l49.116"> </span>
<a href="#l49.117"></a><span id="l49.117">   // Change the mode for each nick, as separator by spaces.</span>
<a href="#l49.118"></a><span id="l49.118">   return splitInput(aNickname).every(aNick =&gt;</span>
<a href="#l49.119"></a><span id="l49.119" class="difflineminus">-    simpleCommand(aConv, &quot;MODE&quot;,</span>
<a href="#l49.120"></a><span id="l49.120" class="difflineminus">-                  [aConv.name, (aAdd ? &quot;+&quot; : &quot;-&quot;) + aMode, aNick]));</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineplus">+    simpleCommand(aConv, &quot;MODE&quot;, [</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineplus">+      aConv.name,</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineplus">+      (aAdd ? &quot;+&quot; : &quot;-&quot;) + aMode,</span>
<a href="#l49.124"></a><span id="l49.124" class="difflineplus">+      aNick,</span>
<a href="#l49.125"></a><span id="l49.125" class="difflineplus">+    ])</span>
<a href="#l49.126"></a><span id="l49.126" class="difflineplus">+  );</span>
<a href="#l49.127"></a><span id="l49.127"> }</span>
<a href="#l49.128"></a><span id="l49.128"> </span>
<a href="#l49.129"></a><span id="l49.129"> function actionCommand(aMsg, aConv) {</span>
<a href="#l49.130"></a><span id="l49.130">   // Don't try to send an empty action.</span>
<a href="#l49.131"></a><span id="l49.131" class="difflineminus">-  if (!aMsg || !aMsg.trim().length)</span>
<a href="#l49.132"></a><span id="l49.132" class="difflineplus">+  if (!aMsg || !aMsg.trim().length) {</span>
<a href="#l49.133"></a><span id="l49.133">     return false;</span>
<a href="#l49.134"></a><span id="l49.134" class="difflineplus">+  }</span>
<a href="#l49.135"></a><span id="l49.135"> </span>
<a href="#l49.136"></a><span id="l49.136">   let conv = getConv(aConv);</span>
<a href="#l49.137"></a><span id="l49.137"> </span>
<a href="#l49.138"></a><span id="l49.138">   // Give add-ons an opportunity to tweak or cancel the action.</span>
<a href="#l49.139"></a><span id="l49.139">   let om = new OutgoingMessage(aMsg, aConv, true);</span>
<a href="#l49.140"></a><span id="l49.140">   conv.notifyObservers(om, &quot;sending-message&quot;);</span>
<a href="#l49.141"></a><span id="l49.141" class="difflineminus">-  if (om.cancelled)</span>
<a href="#l49.142"></a><span id="l49.142" class="difflineplus">+  if (om.cancelled) {</span>
<a href="#l49.143"></a><span id="l49.143">     return true;</span>
<a href="#l49.144"></a><span id="l49.144" class="difflineplus">+  }</span>
<a href="#l49.145"></a><span id="l49.145"> </span>
<a href="#l49.146"></a><span id="l49.146">   let account = getAccount(aConv);</span>
<a href="#l49.147"></a><span id="l49.147">   if (!ctcpCommand(aConv, aConv.name, &quot;ACTION&quot;, om.message)) {</span>
<a href="#l49.148"></a><span id="l49.148" class="difflineminus">-    conv.writeMessage(account._currentServerName, _(&quot;error.sendMessageFailed&quot;),</span>
<a href="#l49.149"></a><span id="l49.149" class="difflineminus">-                      {error: true, system: true});</span>
<a href="#l49.150"></a><span id="l49.150" class="difflineplus">+    conv.writeMessage(</span>
<a href="#l49.151"></a><span id="l49.151" class="difflineplus">+      account._currentServerName,</span>
<a href="#l49.152"></a><span id="l49.152" class="difflineplus">+      _(&quot;error.sendMessageFailed&quot;),</span>
<a href="#l49.153"></a><span id="l49.153" class="difflineplus">+      { error: true, system: true }</span>
<a href="#l49.154"></a><span id="l49.154" class="difflineplus">+    );</span>
<a href="#l49.155"></a><span id="l49.155">     return true;</span>
<a href="#l49.156"></a><span id="l49.156">   }</span>
<a href="#l49.157"></a><span id="l49.157"> </span>
<a href="#l49.158"></a><span id="l49.158">   // Show the action on our conversation.</span>
<a href="#l49.159"></a><span id="l49.159" class="difflineminus">-  conv.writeMessage(account._nickname, &quot;/me &quot; + om.message, {outgoing: true});</span>
<a href="#l49.160"></a><span id="l49.160" class="difflineplus">+  conv.writeMessage(account._nickname, &quot;/me &quot; + om.message, { outgoing: true });</span>
<a href="#l49.161"></a><span id="l49.161">   return true;</span>
<a href="#l49.162"></a><span id="l49.162"> }</span>
<a href="#l49.163"></a><span id="l49.163"> </span>
<a href="#l49.164"></a><span id="l49.164"> // This will open the conversation, and send and display the text.</span>
<a href="#l49.165"></a><span id="l49.165"> // aReturnedConv is optional and returns the resulting conversation.</span>
<a href="#l49.166"></a><span id="l49.166"> // aIsNotice is optional and sends a NOTICE instead of a PRIVMSG.</span>
<a href="#l49.167"></a><span id="l49.167"> function privateMessage(aConv, aMsg, aNickname, aReturnedConv, aIsNotice) {</span>
<a href="#l49.168"></a><span id="l49.168" class="difflineminus">-  if (!aMsg.length)</span>
<a href="#l49.169"></a><span id="l49.169" class="difflineplus">+  if (!aMsg.length) {</span>
<a href="#l49.170"></a><span id="l49.170">     return false;</span>
<a href="#l49.171"></a><span id="l49.171" class="difflineplus">+  }</span>
<a href="#l49.172"></a><span id="l49.172"> </span>
<a href="#l49.173"></a><span id="l49.173">   let conv = getAccount(aConv).getConversation(aNickname);</span>
<a href="#l49.174"></a><span id="l49.174">   conv.sendMsg(aMsg, aIsNotice);</span>
<a href="#l49.175"></a><span id="l49.175" class="difflineminus">-  if (aReturnedConv)</span>
<a href="#l49.176"></a><span id="l49.176" class="difflineplus">+  if (aReturnedConv) {</span>
<a href="#l49.177"></a><span id="l49.177">     aReturnedConv.value = conv;</span>
<a href="#l49.178"></a><span id="l49.178" class="difflineplus">+  }</span>
<a href="#l49.179"></a><span id="l49.179">   return true;</span>
<a href="#l49.180"></a><span id="l49.180"> }</span>
<a href="#l49.181"></a><span id="l49.181"> </span>
<a href="#l49.182"></a><span id="l49.182"> // This will send a command to the server, if no parameters are given, it is</span>
<a href="#l49.183"></a><span id="l49.183"> // assumed that the command takes no parameters. aParams can be either a single</span>
<a href="#l49.184"></a><span id="l49.184"> // string or an array of parameters.</span>
<a href="#l49.185"></a><span id="l49.185"> function simpleCommand(aConv, aCommand, aParams) {</span>
<a href="#l49.186"></a><span id="l49.186" class="difflineminus">-  if (!aParams || !aParams.length)</span>
<a href="#l49.187"></a><span id="l49.187" class="difflineplus">+  if (!aParams || !aParams.length) {</span>
<a href="#l49.188"></a><span id="l49.188">     getAccount(aConv).sendMessage(aCommand);</span>
<a href="#l49.189"></a><span id="l49.189" class="difflineminus">-  else</span>
<a href="#l49.190"></a><span id="l49.190" class="difflineplus">+  } else {</span>
<a href="#l49.191"></a><span id="l49.191">     getAccount(aConv).sendMessage(aCommand, aParams);</span>
<a href="#l49.192"></a><span id="l49.192" class="difflineplus">+  }</span>
<a href="#l49.193"></a><span id="l49.193">   return true;</span>
<a href="#l49.194"></a><span id="l49.194"> }</span>
<a href="#l49.195"></a><span id="l49.195"> </span>
<a href="#l49.196"></a><span id="l49.196"> // Sends a CTCP message to aTarget using the CTCP command aCommand and aMsg as</span>
<a href="#l49.197"></a><span id="l49.197"> // a CTCP parameter.</span>
<a href="#l49.198"></a><span id="l49.198"> function ctcpCommand(aConv, aTarget, aCommand, aParams) {</span>
<a href="#l49.199"></a><span id="l49.199">   return getAccount(aConv).sendCTCPMessage(aTarget, false, aCommand, aParams);</span>
<a href="#l49.200"></a><span id="l49.200"> }</span>
<a href="#l49.201"></a><span id="l49.201"> </span>
<a href="#l49.202"></a><span id="l49.202"> // Replace the command name in the help string so translators do not attempt to</span>
<a href="#l49.203"></a><span id="l49.203"> // translate it.</span>
<a href="#l49.204"></a><span id="l49.204"> var commands = [</span>
<a href="#l49.205"></a><span id="l49.205">   {</span>
<a href="#l49.206"></a><span id="l49.206">     name: &quot;action&quot;,</span>
<a href="#l49.207"></a><span id="l49.207" class="difflineminus">-    get helpString() { return _(&quot;command.action&quot;, &quot;action&quot;); },</span>
<a href="#l49.208"></a><span id="l49.208" class="difflineplus">+    get helpString() {</span>
<a href="#l49.209"></a><span id="l49.209" class="difflineplus">+      return _(&quot;command.action&quot;, &quot;action&quot;);</span>
<a href="#l49.210"></a><span id="l49.210" class="difflineplus">+    },</span>
<a href="#l49.211"></a><span id="l49.211">     run: actionCommand,</span>
<a href="#l49.212"></a><span id="l49.212">   },</span>
<a href="#l49.213"></a><span id="l49.213">   {</span>
<a href="#l49.214"></a><span id="l49.214">     name: &quot;ban&quot;,</span>
<a href="#l49.215"></a><span id="l49.215" class="difflineminus">-    get helpString() { return _(&quot;command.ban&quot;, &quot;ban&quot;); },</span>
<a href="#l49.216"></a><span id="l49.216" class="difflineplus">+    get helpString() {</span>
<a href="#l49.217"></a><span id="l49.217" class="difflineplus">+      return _(&quot;command.ban&quot;, &quot;ban&quot;);</span>
<a href="#l49.218"></a><span id="l49.218" class="difflineplus">+    },</span>
<a href="#l49.219"></a><span id="l49.219">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.220"></a><span id="l49.220">     run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;b&quot;, true),</span>
<a href="#l49.221"></a><span id="l49.221">   },</span>
<a href="#l49.222"></a><span id="l49.222">   {</span>
<a href="#l49.223"></a><span id="l49.223">     name: &quot;ctcp&quot;,</span>
<a href="#l49.224"></a><span id="l49.224" class="difflineminus">-    get helpString() { return _(&quot;command.ctcp&quot;, &quot;ctcp&quot;); },</span>
<a href="#l49.225"></a><span id="l49.225" class="difflineplus">+    get helpString() {</span>
<a href="#l49.226"></a><span id="l49.226" class="difflineplus">+      return _(&quot;command.ctcp&quot;, &quot;ctcp&quot;);</span>
<a href="#l49.227"></a><span id="l49.227" class="difflineplus">+    },</span>
<a href="#l49.228"></a><span id="l49.228">     run(aMsg, aConv) {</span>
<a href="#l49.229"></a><span id="l49.229">       let separator = aMsg.indexOf(&quot; &quot;);</span>
<a href="#l49.230"></a><span id="l49.230">       // Ensure we have two non-empty parameters.</span>
<a href="#l49.231"></a><span id="l49.231" class="difflineminus">-      if (separator &lt; 1 || (separator + 1) == aMsg.length)</span>
<a href="#l49.232"></a><span id="l49.232" class="difflineplus">+      if (separator &lt; 1 || separator + 1 == aMsg.length) {</span>
<a href="#l49.233"></a><span id="l49.233">         return false;</span>
<a href="#l49.234"></a><span id="l49.234" class="difflineplus">+      }</span>
<a href="#l49.235"></a><span id="l49.235"> </span>
<a href="#l49.236"></a><span id="l49.236">       // The first word is used as the target, the rest is used as CTCP command</span>
<a href="#l49.237"></a><span id="l49.237">       // and parameters.</span>
<a href="#l49.238"></a><span id="l49.238">       ctcpCommand(aConv, aMsg.slice(0, separator), aMsg.slice(separator + 1));</span>
<a href="#l49.239"></a><span id="l49.239">       return true;</span>
<a href="#l49.240"></a><span id="l49.240">     },</span>
<a href="#l49.241"></a><span id="l49.241">   },</span>
<a href="#l49.242"></a><span id="l49.242">   {</span>
<a href="#l49.243"></a><span id="l49.243">     name: &quot;chanserv&quot;,</span>
<a href="#l49.244"></a><span id="l49.244" class="difflineminus">-    get helpString() { return _(&quot;command.chanserv&quot;, &quot;chanserv&quot;); },</span>
<a href="#l49.245"></a><span id="l49.245" class="difflineplus">+    get helpString() {</span>
<a href="#l49.246"></a><span id="l49.246" class="difflineplus">+      return _(&quot;command.chanserv&quot;, &quot;chanserv&quot;);</span>
<a href="#l49.247"></a><span id="l49.247" class="difflineplus">+    },</span>
<a href="#l49.248"></a><span id="l49.248">     run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;ChanServ&quot;),</span>
<a href="#l49.249"></a><span id="l49.249">   },</span>
<a href="#l49.250"></a><span id="l49.250">   {</span>
<a href="#l49.251"></a><span id="l49.251">     name: &quot;deop&quot;,</span>
<a href="#l49.252"></a><span id="l49.252" class="difflineminus">-    get helpString() { return _(&quot;command.deop&quot;, &quot;deop&quot;); },</span>
<a href="#l49.253"></a><span id="l49.253" class="difflineplus">+    get helpString() {</span>
<a href="#l49.254"></a><span id="l49.254" class="difflineplus">+      return _(&quot;command.deop&quot;, &quot;deop&quot;);</span>
<a href="#l49.255"></a><span id="l49.255" class="difflineplus">+    },</span>
<a href="#l49.256"></a><span id="l49.256">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.257"></a><span id="l49.257">     run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;o&quot;, false),</span>
<a href="#l49.258"></a><span id="l49.258">   },</span>
<a href="#l49.259"></a><span id="l49.259">   {</span>
<a href="#l49.260"></a><span id="l49.260">     name: &quot;devoice&quot;,</span>
<a href="#l49.261"></a><span id="l49.261" class="difflineminus">-    get helpString() { return _(&quot;command.devoice&quot;, &quot;devoice&quot;); },</span>
<a href="#l49.262"></a><span id="l49.262" class="difflineplus">+    get helpString() {</span>
<a href="#l49.263"></a><span id="l49.263" class="difflineplus">+      return _(&quot;command.devoice&quot;, &quot;devoice&quot;);</span>
<a href="#l49.264"></a><span id="l49.264" class="difflineplus">+    },</span>
<a href="#l49.265"></a><span id="l49.265">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.266"></a><span id="l49.266">     run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;v&quot;, false),</span>
<a href="#l49.267"></a><span id="l49.267">   },</span>
<a href="#l49.268"></a><span id="l49.268">   {</span>
<a href="#l49.269"></a><span id="l49.269">     name: &quot;invite&quot;,</span>
<a href="#l49.270"></a><span id="l49.270" class="difflineminus">-    get helpString() { return _(&quot;command.invite2&quot;, &quot;invite&quot;); },</span>
<a href="#l49.271"></a><span id="l49.271" class="difflineplus">+    get helpString() {</span>
<a href="#l49.272"></a><span id="l49.272" class="difflineplus">+      return _(&quot;command.invite2&quot;, &quot;invite&quot;);</span>
<a href="#l49.273"></a><span id="l49.273" class="difflineplus">+    },</span>
<a href="#l49.274"></a><span id="l49.274">     run(aMsg, aConv) {</span>
<a href="#l49.275"></a><span id="l49.275">       let params = splitInput(aMsg);</span>
<a href="#l49.276"></a><span id="l49.276"> </span>
<a href="#l49.277"></a><span id="l49.277">       // Try to find one, and only one, channel in the list of parameters.</span>
<a href="#l49.278"></a><span id="l49.278">       let channel;</span>
<a href="#l49.279"></a><span id="l49.279">       let account = getAccount(aConv);</span>
<a href="#l49.280"></a><span id="l49.280">       // Find the first param that could be a channel name.</span>
<a href="#l49.281"></a><span id="l49.281">       for (let i = 0; i &lt; params.length; ++i) {</span>
<a href="#l49.282"></a><span id="l49.282">         if (account.isMUCName(params[i])) {</span>
<a href="#l49.283"></a><span id="l49.283">           // If channel is set, two channel names have been found.</span>
<a href="#l49.284"></a><span id="l49.284" class="difflineminus">-          if (channel)</span>
<a href="#l49.285"></a><span id="l49.285" class="difflineplus">+          if (channel) {</span>
<a href="#l49.286"></a><span id="l49.286">             return false;</span>
<a href="#l49.287"></a><span id="l49.287" class="difflineplus">+          }</span>
<a href="#l49.288"></a><span id="l49.288"> </span>
<a href="#l49.289"></a><span id="l49.289">           // Remove that parameter and store it.</span>
<a href="#l49.290"></a><span id="l49.290">           channel = params.splice(i, 1)[0];</span>
<a href="#l49.291"></a><span id="l49.291">         }</span>
<a href="#l49.292"></a><span id="l49.292">       }</span>
<a href="#l49.293"></a><span id="l49.293"> </span>
<a href="#l49.294"></a><span id="l49.294">       // If no parameters or only a channel are given.</span>
<a href="#l49.295"></a><span id="l49.295" class="difflineminus">-      if (!params[0].length)</span>
<a href="#l49.296"></a><span id="l49.296" class="difflineplus">+      if (!params[0].length) {</span>
<a href="#l49.297"></a><span id="l49.297">         return false;</span>
<a href="#l49.298"></a><span id="l49.298" class="difflineplus">+      }</span>
<a href="#l49.299"></a><span id="l49.299"> </span>
<a href="#l49.300"></a><span id="l49.300">       // Default to using the current conversation as the channel to invite to.</span>
<a href="#l49.301"></a><span id="l49.301" class="difflineminus">-      if (!channel)</span>
<a href="#l49.302"></a><span id="l49.302" class="difflineplus">+      if (!channel) {</span>
<a href="#l49.303"></a><span id="l49.303">         channel = aConv.name;</span>
<a href="#l49.304"></a><span id="l49.304" class="difflineplus">+      }</span>
<a href="#l49.305"></a><span id="l49.305"> </span>
<a href="#l49.306"></a><span id="l49.306" class="difflineminus">-      params.forEach(p =&gt;</span>
<a href="#l49.307"></a><span id="l49.307" class="difflineminus">-        simpleCommand(aConv, &quot;INVITE&quot;, [p, channel]));</span>
<a href="#l49.308"></a><span id="l49.308" class="difflineplus">+      params.forEach(p =&gt; simpleCommand(aConv, &quot;INVITE&quot;, [p, channel]));</span>
<a href="#l49.309"></a><span id="l49.309">       return true;</span>
<a href="#l49.310"></a><span id="l49.310">     },</span>
<a href="#l49.311"></a><span id="l49.311">   },</span>
<a href="#l49.312"></a><span id="l49.312">   {</span>
<a href="#l49.313"></a><span id="l49.313">     name: &quot;join&quot;,</span>
<a href="#l49.314"></a><span id="l49.314" class="difflineminus">-    get helpString() { return _(&quot;command.join&quot;, &quot;join&quot;); },</span>
<a href="#l49.315"></a><span id="l49.315" class="difflineplus">+    get helpString() {</span>
<a href="#l49.316"></a><span id="l49.316" class="difflineplus">+      return _(&quot;command.join&quot;, &quot;join&quot;);</span>
<a href="#l49.317"></a><span id="l49.317" class="difflineplus">+    },</span>
<a href="#l49.318"></a><span id="l49.318">     run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l49.319"></a><span id="l49.319">       let params = aMsg.trim().split(/,\s*/);</span>
<a href="#l49.320"></a><span id="l49.320">       let account = getAccount(aConv);</span>
<a href="#l49.321"></a><span id="l49.321">       let conv;</span>
<a href="#l49.322"></a><span id="l49.322">       if (!params[0]) {</span>
<a href="#l49.323"></a><span id="l49.323">         conv = getConv(aConv);</span>
<a href="#l49.324"></a><span id="l49.324" class="difflineminus">-        if (!conv.isChat || !conv.left)</span>
<a href="#l49.325"></a><span id="l49.325" class="difflineplus">+        if (!conv.isChat || !conv.left) {</span>
<a href="#l49.326"></a><span id="l49.326">           return false;</span>
<a href="#l49.327"></a><span id="l49.327" class="difflineplus">+        }</span>
<a href="#l49.328"></a><span id="l49.328">         // Rejoin the current channel. If the channel was explicitly parted</span>
<a href="#l49.329"></a><span id="l49.329">         // by the user, chatRoomFields will have been deleted.</span>
<a href="#l49.330"></a><span id="l49.330">         // Otherwise, make use of it (e.g. if the user was kicked).</span>
<a href="#l49.331"></a><span id="l49.331">         if (conv.chatRoomFields) {</span>
<a href="#l49.332"></a><span id="l49.332">           account.joinChat(conv.chatRoomFields);</span>
<a href="#l49.333"></a><span id="l49.333">           return true;</span>
<a href="#l49.334"></a><span id="l49.334">         }</span>
<a href="#l49.335"></a><span id="l49.335">         params = [conv.name];</span>
<a href="#l49.336"></a><span id="l49.336">       }</span>
<a href="#l49.337"></a><span id="l49.337">       params.forEach(function(joinParam) {</span>
<a href="#l49.338"></a><span id="l49.338">         if (joinParam) {</span>
<a href="#l49.339"></a><span id="l49.339">           let chatroomfields = account.getChatRoomDefaultFieldValues(joinParam);</span>
<a href="#l49.340"></a><span id="l49.340">           conv = account.joinChat(chatroomfields);</span>
<a href="#l49.341"></a><span id="l49.341">         }</span>
<a href="#l49.342"></a><span id="l49.342">       });</span>
<a href="#l49.343"></a><span id="l49.343" class="difflineminus">-      if (aReturnedConv)</span>
<a href="#l49.344"></a><span id="l49.344" class="difflineplus">+      if (aReturnedConv) {</span>
<a href="#l49.345"></a><span id="l49.345">         aReturnedConv.value = conv;</span>
<a href="#l49.346"></a><span id="l49.346" class="difflineplus">+      }</span>
<a href="#l49.347"></a><span id="l49.347">       return true;</span>
<a href="#l49.348"></a><span id="l49.348">     },</span>
<a href="#l49.349"></a><span id="l49.349">   },</span>
<a href="#l49.350"></a><span id="l49.350">   {</span>
<a href="#l49.351"></a><span id="l49.351">     name: &quot;kick&quot;,</span>
<a href="#l49.352"></a><span id="l49.352" class="difflineminus">-    get helpString() { return _(&quot;command.kick&quot;, &quot;kick&quot;); },</span>
<a href="#l49.353"></a><span id="l49.353" class="difflineplus">+    get helpString() {</span>
<a href="#l49.354"></a><span id="l49.354" class="difflineplus">+      return _(&quot;command.kick&quot;, &quot;kick&quot;);</span>
<a href="#l49.355"></a><span id="l49.355" class="difflineplus">+    },</span>
<a href="#l49.356"></a><span id="l49.356">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.357"></a><span id="l49.357">     run: kickCommand,</span>
<a href="#l49.358"></a><span id="l49.358">   },</span>
<a href="#l49.359"></a><span id="l49.359">   {</span>
<a href="#l49.360"></a><span id="l49.360">     name: &quot;list&quot;,</span>
<a href="#l49.361"></a><span id="l49.361" class="difflineminus">-    get helpString() { return _(&quot;command.list&quot;, &quot;list&quot;); },</span>
<a href="#l49.362"></a><span id="l49.362" class="difflineplus">+    get helpString() {</span>
<a href="#l49.363"></a><span id="l49.363" class="difflineplus">+      return _(&quot;command.list&quot;, &quot;list&quot;);</span>
<a href="#l49.364"></a><span id="l49.364" class="difflineplus">+    },</span>
<a href="#l49.365"></a><span id="l49.365">     run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l49.366"></a><span id="l49.366">       let account = getAccount(aConv);</span>
<a href="#l49.367"></a><span id="l49.367">       let serverName = account._currentServerName;</span>
<a href="#l49.368"></a><span id="l49.368">       let serverConv = account.getConversation(serverName);</span>
<a href="#l49.369"></a><span id="l49.369">       let pendingChats = [];</span>
<a href="#l49.370"></a><span id="l49.370" class="difflineminus">-      account.requestRoomInfo({onRoomInfoAvailable(aRooms) {</span>
<a href="#l49.371"></a><span id="l49.371" class="difflineminus">-        if (!pendingChats.length) {</span>
<a href="#l49.372"></a><span id="l49.372" class="difflineminus">-          (async function() {</span>
<a href="#l49.373"></a><span id="l49.373" class="difflineminus">-            // pendingChats has no rooms added yet, so ensure we wait a tick.</span>
<a href="#l49.374"></a><span id="l49.374" class="difflineminus">-            let t = 0;</span>
<a href="#l49.375"></a><span id="l49.375" class="difflineminus">-            const kMaxBlockTime = 10; // Unblock every 10ms.</span>
<a href="#l49.376"></a><span id="l49.376" class="difflineminus">-            do {</span>
<a href="#l49.377"></a><span id="l49.377" class="difflineminus">-              if (Date.now() &gt; t) {</span>
<a href="#l49.378"></a><span id="l49.378" class="difflineminus">-                await new Promise(resolve =&gt; Services.tm.dispatchToMainThread(resolve));</span>
<a href="#l49.379"></a><span id="l49.379" class="difflineminus">-                t = Date.now() + kMaxBlockTime;</span>
<a href="#l49.380"></a><span id="l49.380" class="difflineminus">-              }</span>
<a href="#l49.381"></a><span id="l49.381" class="difflineminus">-              let name = pendingChats.pop();</span>
<a href="#l49.382"></a><span id="l49.382" class="difflineminus">-              let roomInfo = account.getRoomInfo(name);</span>
<a href="#l49.383"></a><span id="l49.383" class="difflineminus">-              serverConv.writeMessage(serverName,</span>
<a href="#l49.384"></a><span id="l49.384" class="difflineminus">-                name + &quot; (&quot; + roomInfo.participantCount + &quot;) &quot; + roomInfo.topic,</span>
<a href="#l49.385"></a><span id="l49.385" class="difflineminus">-                {incoming: true, noLog: true});</span>
<a href="#l49.386"></a><span id="l49.386" class="difflineminus">-            } while (pendingChats.length);</span>
<a href="#l49.387"></a><span id="l49.387" class="difflineminus">-          })();</span>
<a href="#l49.388"></a><span id="l49.388" class="difflineminus">-        }</span>
<a href="#l49.389"></a><span id="l49.389" class="difflineminus">-        pendingChats = pendingChats.concat(aRooms);</span>
<a href="#l49.390"></a><span id="l49.390" class="difflineminus">-      }}, true);</span>
<a href="#l49.391"></a><span id="l49.391" class="difflineminus">-      if (aReturnedConv)</span>
<a href="#l49.392"></a><span id="l49.392" class="difflineplus">+      account.requestRoomInfo(</span>
<a href="#l49.393"></a><span id="l49.393" class="difflineplus">+        {</span>
<a href="#l49.394"></a><span id="l49.394" class="difflineplus">+          onRoomInfoAvailable(aRooms) {</span>
<a href="#l49.395"></a><span id="l49.395" class="difflineplus">+            if (!pendingChats.length) {</span>
<a href="#l49.396"></a><span id="l49.396" class="difflineplus">+              (async function() {</span>
<a href="#l49.397"></a><span id="l49.397" class="difflineplus">+                // pendingChats has no rooms added yet, so ensure we wait a tick.</span>
<a href="#l49.398"></a><span id="l49.398" class="difflineplus">+                let t = 0;</span>
<a href="#l49.399"></a><span id="l49.399" class="difflineplus">+                const kMaxBlockTime = 10; // Unblock every 10ms.</span>
<a href="#l49.400"></a><span id="l49.400" class="difflineplus">+                do {</span>
<a href="#l49.401"></a><span id="l49.401" class="difflineplus">+                  if (Date.now() &gt; t) {</span>
<a href="#l49.402"></a><span id="l49.402" class="difflineplus">+                    await new Promise(resolve =&gt;</span>
<a href="#l49.403"></a><span id="l49.403" class="difflineplus">+                      Services.tm.dispatchToMainThread(resolve)</span>
<a href="#l49.404"></a><span id="l49.404" class="difflineplus">+                    );</span>
<a href="#l49.405"></a><span id="l49.405" class="difflineplus">+                    t = Date.now() + kMaxBlockTime;</span>
<a href="#l49.406"></a><span id="l49.406" class="difflineplus">+                  }</span>
<a href="#l49.407"></a><span id="l49.407" class="difflineplus">+                  let name = pendingChats.pop();</span>
<a href="#l49.408"></a><span id="l49.408" class="difflineplus">+                  let roomInfo = account.getRoomInfo(name);</span>
<a href="#l49.409"></a><span id="l49.409" class="difflineplus">+                  serverConv.writeMessage(</span>
<a href="#l49.410"></a><span id="l49.410" class="difflineplus">+                    serverName,</span>
<a href="#l49.411"></a><span id="l49.411" class="difflineplus">+                    name +</span>
<a href="#l49.412"></a><span id="l49.412" class="difflineplus">+                      &quot; (&quot; +</span>
<a href="#l49.413"></a><span id="l49.413" class="difflineplus">+                      roomInfo.participantCount +</span>
<a href="#l49.414"></a><span id="l49.414" class="difflineplus">+                      &quot;) &quot; +</span>
<a href="#l49.415"></a><span id="l49.415" class="difflineplus">+                      roomInfo.topic,</span>
<a href="#l49.416"></a><span id="l49.416" class="difflineplus">+                    { incoming: true, noLog: true }</span>
<a href="#l49.417"></a><span id="l49.417" class="difflineplus">+                  );</span>
<a href="#l49.418"></a><span id="l49.418" class="difflineplus">+                } while (pendingChats.length);</span>
<a href="#l49.419"></a><span id="l49.419" class="difflineplus">+              })();</span>
<a href="#l49.420"></a><span id="l49.420" class="difflineplus">+            }</span>
<a href="#l49.421"></a><span id="l49.421" class="difflineplus">+            pendingChats = pendingChats.concat(aRooms);</span>
<a href="#l49.422"></a><span id="l49.422" class="difflineplus">+          },</span>
<a href="#l49.423"></a><span id="l49.423" class="difflineplus">+        },</span>
<a href="#l49.424"></a><span id="l49.424" class="difflineplus">+        true</span>
<a href="#l49.425"></a><span id="l49.425" class="difflineplus">+      );</span>
<a href="#l49.426"></a><span id="l49.426" class="difflineplus">+      if (aReturnedConv) {</span>
<a href="#l49.427"></a><span id="l49.427">         aReturnedConv.value = serverConv;</span>
<a href="#l49.428"></a><span id="l49.428" class="difflineplus">+      }</span>
<a href="#l49.429"></a><span id="l49.429">       return true;</span>
<a href="#l49.430"></a><span id="l49.430">     },</span>
<a href="#l49.431"></a><span id="l49.431">   },</span>
<a href="#l49.432"></a><span id="l49.432">   {</span>
<a href="#l49.433"></a><span id="l49.433">     name: &quot;me&quot;,</span>
<a href="#l49.434"></a><span id="l49.434" class="difflineminus">-    get helpString() { return _(&quot;command.action&quot;, &quot;me&quot;); },</span>
<a href="#l49.435"></a><span id="l49.435" class="difflineplus">+    get helpString() {</span>
<a href="#l49.436"></a><span id="l49.436" class="difflineplus">+      return _(&quot;command.action&quot;, &quot;me&quot;);</span>
<a href="#l49.437"></a><span id="l49.437" class="difflineplus">+    },</span>
<a href="#l49.438"></a><span id="l49.438">     run: actionCommand,</span>
<a href="#l49.439"></a><span id="l49.439">   },</span>
<a href="#l49.440"></a><span id="l49.440">   {</span>
<a href="#l49.441"></a><span id="l49.441">     name: &quot;memoserv&quot;,</span>
<a href="#l49.442"></a><span id="l49.442" class="difflineminus">-    get helpString() { return _(&quot;command.memoserv&quot;, &quot;memoserv&quot;); },</span>
<a href="#l49.443"></a><span id="l49.443" class="difflineplus">+    get helpString() {</span>
<a href="#l49.444"></a><span id="l49.444" class="difflineplus">+      return _(&quot;command.memoserv&quot;, &quot;memoserv&quot;);</span>
<a href="#l49.445"></a><span id="l49.445" class="difflineplus">+    },</span>
<a href="#l49.446"></a><span id="l49.446">     run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;MemoServ&quot;),</span>
<a href="#l49.447"></a><span id="l49.447">   },</span>
<a href="#l49.448"></a><span id="l49.448">   {</span>
<a href="#l49.449"></a><span id="l49.449">     name: &quot;mode&quot;,</span>
<a href="#l49.450"></a><span id="l49.450">     get helpString() {</span>
<a href="#l49.451"></a><span id="l49.451" class="difflineminus">-      return _(&quot;command.modeUser2&quot;, &quot;mode&quot;) + &quot;\n&quot; +</span>
<a href="#l49.452"></a><span id="l49.452" class="difflineminus">-             _(&quot;command.modeChannel2&quot;, &quot;mode&quot;);</span>
<a href="#l49.453"></a><span id="l49.453" class="difflineplus">+      return (</span>
<a href="#l49.454"></a><span id="l49.454" class="difflineplus">+        _(&quot;command.modeUser2&quot;, &quot;mode&quot;) +</span>
<a href="#l49.455"></a><span id="l49.455" class="difflineplus">+        &quot;\n&quot; +</span>
<a href="#l49.456"></a><span id="l49.456" class="difflineplus">+        _(&quot;command.modeChannel2&quot;, &quot;mode&quot;)</span>
<a href="#l49.457"></a><span id="l49.457" class="difflineplus">+      );</span>
<a href="#l49.458"></a><span id="l49.458">     },</span>
<a href="#l49.459"></a><span id="l49.459">     run(aMsg, aConv) {</span>
<a href="#l49.460"></a><span id="l49.460" class="difflineminus">-      function isMode(aString) { return &quot;+-&quot;.includes(aString[0]); }</span>
<a href="#l49.461"></a><span id="l49.461" class="difflineplus">+      function isMode(aString) {</span>
<a href="#l49.462"></a><span id="l49.462" class="difflineplus">+        return &quot;+-&quot;.includes(aString[0]);</span>
<a href="#l49.463"></a><span id="l49.463" class="difflineplus">+      }</span>
<a href="#l49.464"></a><span id="l49.464">       let params = splitInput(aMsg);</span>
<a href="#l49.465"></a><span id="l49.465">       let channel = aConv.name;</span>
<a href="#l49.466"></a><span id="l49.466">       // Add the channel as parameter when the target is not specified. i.e</span>
<a href="#l49.467"></a><span id="l49.467">       // 1. message is empty.</span>
<a href="#l49.468"></a><span id="l49.468">       // 2. the first parameter is a mode.</span>
<a href="#l49.469"></a><span id="l49.469" class="difflineminus">-      if (!aMsg)</span>
<a href="#l49.470"></a><span id="l49.470" class="difflineplus">+      if (!aMsg) {</span>
<a href="#l49.471"></a><span id="l49.471">         params = [channel];</span>
<a href="#l49.472"></a><span id="l49.472" class="difflineminus">-      else if (isMode(params[0]))</span>
<a href="#l49.473"></a><span id="l49.473" class="difflineplus">+      } else if (isMode(params[0])) {</span>
<a href="#l49.474"></a><span id="l49.474">         params.unshift(channel);</span>
<a href="#l49.475"></a><span id="l49.475" class="difflineplus">+      }</span>
<a href="#l49.476"></a><span id="l49.476"> </span>
<a href="#l49.477"></a><span id="l49.477">       // Ensure mode string to be the second argument.</span>
<a href="#l49.478"></a><span id="l49.478" class="difflineminus">-      if (params.length &gt;= 2 &amp;&amp; !isMode(params[1]))</span>
<a href="#l49.479"></a><span id="l49.479" class="difflineplus">+      if (params.length &gt;= 2 &amp;&amp; !isMode(params[1])) {</span>
<a href="#l49.480"></a><span id="l49.480">         return false;</span>
<a href="#l49.481"></a><span id="l49.481" class="difflineplus">+      }</span>
<a href="#l49.482"></a><span id="l49.482"> </span>
<a href="#l49.483"></a><span id="l49.483">       return simpleCommand(aConv, &quot;MODE&quot;, params);</span>
<a href="#l49.484"></a><span id="l49.484">     },</span>
<a href="#l49.485"></a><span id="l49.485">   },</span>
<a href="#l49.486"></a><span id="l49.486">   {</span>
<a href="#l49.487"></a><span id="l49.487">     name: &quot;msg&quot;,</span>
<a href="#l49.488"></a><span id="l49.488" class="difflineminus">-    get helpString() { return _(&quot;command.msg&quot;, &quot;msg&quot;); },</span>
<a href="#l49.489"></a><span id="l49.489" class="difflineplus">+    get helpString() {</span>
<a href="#l49.490"></a><span id="l49.490" class="difflineplus">+      return _(&quot;command.msg&quot;, &quot;msg&quot;);</span>
<a href="#l49.491"></a><span id="l49.491" class="difflineplus">+    },</span>
<a href="#l49.492"></a><span id="l49.492">     run: messageCommand,</span>
<a href="#l49.493"></a><span id="l49.493">   },</span>
<a href="#l49.494"></a><span id="l49.494">   {</span>
<a href="#l49.495"></a><span id="l49.495">     name: &quot;nick&quot;,</span>
<a href="#l49.496"></a><span id="l49.496" class="difflineminus">-    get helpString() { return _(&quot;command.nick&quot;, &quot;nick&quot;); },</span>
<a href="#l49.497"></a><span id="l49.497" class="difflineplus">+    get helpString() {</span>
<a href="#l49.498"></a><span id="l49.498" class="difflineplus">+      return _(&quot;command.nick&quot;, &quot;nick&quot;);</span>
<a href="#l49.499"></a><span id="l49.499" class="difflineplus">+    },</span>
<a href="#l49.500"></a><span id="l49.500">     run(aMsg, aConv) {</span>
<a href="#l49.501"></a><span id="l49.501">       let newNick = aMsg.trim();</span>
<a href="#l49.502"></a><span id="l49.502">       // eslint-disable-next-line mozilla/use-includes-instead-of-indexOf</span>
<a href="#l49.503"></a><span id="l49.503" class="difflineminus">-      if (newNick.indexOf(/\s+/) != -1)</span>
<a href="#l49.504"></a><span id="l49.504" class="difflineplus">+      if (newNick.indexOf(/\s+/) != -1) {</span>
<a href="#l49.505"></a><span id="l49.505">         return false;</span>
<a href="#l49.506"></a><span id="l49.506" class="difflineplus">+      }</span>
<a href="#l49.507"></a><span id="l49.507"> </span>
<a href="#l49.508"></a><span id="l49.508">       let account = getAccount(aConv);</span>
<a href="#l49.509"></a><span id="l49.509">       // The user wants to change their nick, so overwrite the account</span>
<a href="#l49.510"></a><span id="l49.510">       // nickname for this session.</span>
<a href="#l49.511"></a><span id="l49.511">       account._requestedNickname = newNick;</span>
<a href="#l49.512"></a><span id="l49.512">       account.changeNick(newNick);</span>
<a href="#l49.513"></a><span id="l49.513"> </span>
<a href="#l49.514"></a><span id="l49.514">       return true;</span>
<a href="#l49.515"></a><span id="l49.515">     },</span>
<a href="#l49.516"></a><span id="l49.516">   },</span>
<a href="#l49.517"></a><span id="l49.517">   {</span>
<a href="#l49.518"></a><span id="l49.518">     name: &quot;nickserv&quot;,</span>
<a href="#l49.519"></a><span id="l49.519" class="difflineminus">-    get helpString() { return _(&quot;command.nickserv&quot;, &quot;nickserv&quot;); },</span>
<a href="#l49.520"></a><span id="l49.520" class="difflineplus">+    get helpString() {</span>
<a href="#l49.521"></a><span id="l49.521" class="difflineplus">+      return _(&quot;command.nickserv&quot;, &quot;nickserv&quot;);</span>
<a href="#l49.522"></a><span id="l49.522" class="difflineplus">+    },</span>
<a href="#l49.523"></a><span id="l49.523">     run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;NickServ&quot;),</span>
<a href="#l49.524"></a><span id="l49.524">   },</span>
<a href="#l49.525"></a><span id="l49.525">   {</span>
<a href="#l49.526"></a><span id="l49.526">     name: &quot;notice&quot;,</span>
<a href="#l49.527"></a><span id="l49.527" class="difflineminus">-    get helpString() { return _(&quot;command.notice&quot;, &quot;notice&quot;); },</span>
<a href="#l49.528"></a><span id="l49.528" class="difflineplus">+    get helpString() {</span>
<a href="#l49.529"></a><span id="l49.529" class="difflineplus">+      return _(&quot;command.notice&quot;, &quot;notice&quot;);</span>
<a href="#l49.530"></a><span id="l49.530" class="difflineplus">+    },</span>
<a href="#l49.531"></a><span id="l49.531">     run: (aMsg, aConv, aReturnedConv) =&gt;</span>
<a href="#l49.532"></a><span id="l49.532">       messageCommand(aMsg, aConv, aReturnedConv, true),</span>
<a href="#l49.533"></a><span id="l49.533">   },</span>
<a href="#l49.534"></a><span id="l49.534">   {</span>
<a href="#l49.535"></a><span id="l49.535">     name: &quot;op&quot;,</span>
<a href="#l49.536"></a><span id="l49.536" class="difflineminus">-    get helpString() { return _(&quot;command.op&quot;, &quot;op&quot;); },</span>
<a href="#l49.537"></a><span id="l49.537" class="difflineplus">+    get helpString() {</span>
<a href="#l49.538"></a><span id="l49.538" class="difflineplus">+      return _(&quot;command.op&quot;, &quot;op&quot;);</span>
<a href="#l49.539"></a><span id="l49.539" class="difflineplus">+    },</span>
<a href="#l49.540"></a><span id="l49.540">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.541"></a><span id="l49.541">     run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;o&quot;, true),</span>
<a href="#l49.542"></a><span id="l49.542">   },</span>
<a href="#l49.543"></a><span id="l49.543">   {</span>
<a href="#l49.544"></a><span id="l49.544">     name: &quot;operserv&quot;,</span>
<a href="#l49.545"></a><span id="l49.545" class="difflineminus">-    get helpString() { return _(&quot;command.operserv&quot;, &quot;operserv&quot;); },</span>
<a href="#l49.546"></a><span id="l49.546" class="difflineplus">+    get helpString() {</span>
<a href="#l49.547"></a><span id="l49.547" class="difflineplus">+      return _(&quot;command.operserv&quot;, &quot;operserv&quot;);</span>
<a href="#l49.548"></a><span id="l49.548" class="difflineplus">+    },</span>
<a href="#l49.549"></a><span id="l49.549">     run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;OperServ&quot;),</span>
<a href="#l49.550"></a><span id="l49.550">   },</span>
<a href="#l49.551"></a><span id="l49.551">   {</span>
<a href="#l49.552"></a><span id="l49.552">     name: &quot;part&quot;,</span>
<a href="#l49.553"></a><span id="l49.553" class="difflineminus">-    get helpString() { return _(&quot;command.part&quot;, &quot;part&quot;); },</span>
<a href="#l49.554"></a><span id="l49.554" class="difflineplus">+    get helpString() {</span>
<a href="#l49.555"></a><span id="l49.555" class="difflineplus">+      return _(&quot;command.part&quot;, &quot;part&quot;);</span>
<a href="#l49.556"></a><span id="l49.556" class="difflineplus">+    },</span>
<a href="#l49.557"></a><span id="l49.557">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.558"></a><span id="l49.558">     run(aMsg, aConv) {</span>
<a href="#l49.559"></a><span id="l49.559">       getConv(aConv).part(aMsg);</span>
<a href="#l49.560"></a><span id="l49.560">       return true;</span>
<a href="#l49.561"></a><span id="l49.561">     },</span>
<a href="#l49.562"></a><span id="l49.562">   },</span>
<a href="#l49.563"></a><span id="l49.563">   {</span>
<a href="#l49.564"></a><span id="l49.564">     name: &quot;ping&quot;,</span>
<a href="#l49.565"></a><span id="l49.565" class="difflineminus">-    get helpString() { return _(&quot;command.ping&quot;, &quot;ping&quot;); },</span>
<a href="#l49.566"></a><span id="l49.566" class="difflineplus">+    get helpString() {</span>
<a href="#l49.567"></a><span id="l49.567" class="difflineplus">+      return _(&quot;command.ping&quot;, &quot;ping&quot;);</span>
<a href="#l49.568"></a><span id="l49.568" class="difflineplus">+    },</span>
<a href="#l49.569"></a><span id="l49.569">     run(aMsg, aConv) {</span>
<a href="#l49.570"></a><span id="l49.570">       // Send a ping to the entered nick using the current time (in</span>
<a href="#l49.571"></a><span id="l49.571">       // milliseconds) as the param. If no nick is entered, ping the</span>
<a href="#l49.572"></a><span id="l49.572">       // server.</span>
<a href="#l49.573"></a><span id="l49.573" class="difflineminus">-      if (aMsg &amp;&amp; aMsg.trim().length)</span>
<a href="#l49.574"></a><span id="l49.574" class="difflineplus">+      if (aMsg &amp;&amp; aMsg.trim().length) {</span>
<a href="#l49.575"></a><span id="l49.575">         ctcpCommand(aConv, aMsg, &quot;PING&quot;, Date.now());</span>
<a href="#l49.576"></a><span id="l49.576" class="difflineminus">-      else</span>
<a href="#l49.577"></a><span id="l49.577" class="difflineplus">+      } else {</span>
<a href="#l49.578"></a><span id="l49.578">         getAccount(aConv).sendMessage(&quot;PING&quot;, Date.now());</span>
<a href="#l49.579"></a><span id="l49.579" class="difflineplus">+      }</span>
<a href="#l49.580"></a><span id="l49.580"> </span>
<a href="#l49.581"></a><span id="l49.581">       return true;</span>
<a href="#l49.582"></a><span id="l49.582">     },</span>
<a href="#l49.583"></a><span id="l49.583">   },</span>
<a href="#l49.584"></a><span id="l49.584">   {</span>
<a href="#l49.585"></a><span id="l49.585">     name: &quot;query&quot;,</span>
<a href="#l49.586"></a><span id="l49.586" class="difflineminus">-    get helpString() { return _(&quot;command.msg&quot;, &quot;query&quot;); },</span>
<a href="#l49.587"></a><span id="l49.587" class="difflineplus">+    get helpString() {</span>
<a href="#l49.588"></a><span id="l49.588" class="difflineplus">+      return _(&quot;command.msg&quot;, &quot;query&quot;);</span>
<a href="#l49.589"></a><span id="l49.589" class="difflineplus">+    },</span>
<a href="#l49.590"></a><span id="l49.590">     run: messageCommand,</span>
<a href="#l49.591"></a><span id="l49.591">   },</span>
<a href="#l49.592"></a><span id="l49.592">   {</span>
<a href="#l49.593"></a><span id="l49.593">     name: &quot;quit&quot;,</span>
<a href="#l49.594"></a><span id="l49.594" class="difflineminus">-    get helpString() { return _(&quot;command.quit&quot;, &quot;quit&quot;); },</span>
<a href="#l49.595"></a><span id="l49.595" class="difflineplus">+    get helpString() {</span>
<a href="#l49.596"></a><span id="l49.596" class="difflineplus">+      return _(&quot;command.quit&quot;, &quot;quit&quot;);</span>
<a href="#l49.597"></a><span id="l49.597" class="difflineplus">+    },</span>
<a href="#l49.598"></a><span id="l49.598">     run(aMsg, aConv) {</span>
<a href="#l49.599"></a><span id="l49.599">       let account = getAccount(aConv);</span>
<a href="#l49.600"></a><span id="l49.600">       account.disconnect(aMsg);</span>
<a href="#l49.601"></a><span id="l49.601">       // While prpls shouldn't usually touch imAccount, this disconnection</span>
<a href="#l49.602"></a><span id="l49.602">       // is an action the user requested via the UI. Without this call,</span>
<a href="#l49.603"></a><span id="l49.603">       // the imAccount would immediately reconnect the account.</span>
<a href="#l49.604"></a><span id="l49.604">       account.imAccount.disconnect();</span>
<a href="#l49.605"></a><span id="l49.605">       return true;</span>
<a href="#l49.606"></a><span id="l49.606">     },</span>
<a href="#l49.607"></a><span id="l49.607">   },</span>
<a href="#l49.608"></a><span id="l49.608">   {</span>
<a href="#l49.609"></a><span id="l49.609">     name: &quot;quote&quot;,</span>
<a href="#l49.610"></a><span id="l49.610" class="difflineminus">-    get helpString() { return _(&quot;command.quote&quot;, &quot;quote&quot;); },</span>
<a href="#l49.611"></a><span id="l49.611" class="difflineplus">+    get helpString() {</span>
<a href="#l49.612"></a><span id="l49.612" class="difflineplus">+      return _(&quot;command.quote&quot;, &quot;quote&quot;);</span>
<a href="#l49.613"></a><span id="l49.613" class="difflineplus">+    },</span>
<a href="#l49.614"></a><span id="l49.614">     run(aMsg, aConv) {</span>
<a href="#l49.615"></a><span id="l49.615" class="difflineminus">-      if (!aMsg.length)</span>
<a href="#l49.616"></a><span id="l49.616" class="difflineplus">+      if (!aMsg.length) {</span>
<a href="#l49.617"></a><span id="l49.617">         return false;</span>
<a href="#l49.618"></a><span id="l49.618" class="difflineplus">+      }</span>
<a href="#l49.619"></a><span id="l49.619"> </span>
<a href="#l49.620"></a><span id="l49.620">       getAccount(aConv).sendRawMessage(aMsg);</span>
<a href="#l49.621"></a><span id="l49.621">       return true;</span>
<a href="#l49.622"></a><span id="l49.622">     },</span>
<a href="#l49.623"></a><span id="l49.623">   },</span>
<a href="#l49.624"></a><span id="l49.624">   {</span>
<a href="#l49.625"></a><span id="l49.625">     name: &quot;remove&quot;,</span>
<a href="#l49.626"></a><span id="l49.626" class="difflineminus">-    get helpString() { return _(&quot;command.kick&quot;, &quot;remove&quot;); },</span>
<a href="#l49.627"></a><span id="l49.627" class="difflineplus">+    get helpString() {</span>
<a href="#l49.628"></a><span id="l49.628" class="difflineplus">+      return _(&quot;command.kick&quot;, &quot;remove&quot;);</span>
<a href="#l49.629"></a><span id="l49.629" class="difflineplus">+    },</span>
<a href="#l49.630"></a><span id="l49.630">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.631"></a><span id="l49.631">     run: kickCommand,</span>
<a href="#l49.632"></a><span id="l49.632">   },</span>
<a href="#l49.633"></a><span id="l49.633">   {</span>
<a href="#l49.634"></a><span id="l49.634">     name: &quot;time&quot;,</span>
<a href="#l49.635"></a><span id="l49.635" class="difflineminus">-    get helpString() { return _(&quot;command.time&quot;, &quot;time&quot;); },</span>
<a href="#l49.636"></a><span id="l49.636" class="difflineplus">+    get helpString() {</span>
<a href="#l49.637"></a><span id="l49.637" class="difflineplus">+      return _(&quot;command.time&quot;, &quot;time&quot;);</span>
<a href="#l49.638"></a><span id="l49.638" class="difflineplus">+    },</span>
<a href="#l49.639"></a><span id="l49.639">     run(aMsg, aConv) {</span>
<a href="#l49.640"></a><span id="l49.640">       // Send a time command to the entered nick using the current time (in</span>
<a href="#l49.641"></a><span id="l49.641">       // milliseconds) as the param. If no nick is entered, get the current</span>
<a href="#l49.642"></a><span id="l49.642">       // server time.</span>
<a href="#l49.643"></a><span id="l49.643" class="difflineminus">-      if (aMsg &amp;&amp; aMsg.trim().length)</span>
<a href="#l49.644"></a><span id="l49.644" class="difflineplus">+      if (aMsg &amp;&amp; aMsg.trim().length) {</span>
<a href="#l49.645"></a><span id="l49.645">         ctcpCommand(aConv, aMsg, &quot;TIME&quot;);</span>
<a href="#l49.646"></a><span id="l49.646" class="difflineminus">-      else</span>
<a href="#l49.647"></a><span id="l49.647" class="difflineplus">+      } else {</span>
<a href="#l49.648"></a><span id="l49.648">         getAccount(aConv).sendMessage(&quot;TIME&quot;);</span>
<a href="#l49.649"></a><span id="l49.649" class="difflineplus">+      }</span>
<a href="#l49.650"></a><span id="l49.650"> </span>
<a href="#l49.651"></a><span id="l49.651">       return true;</span>
<a href="#l49.652"></a><span id="l49.652">     },</span>
<a href="#l49.653"></a><span id="l49.653">   },</span>
<a href="#l49.654"></a><span id="l49.654">   {</span>
<a href="#l49.655"></a><span id="l49.655">     name: &quot;topic&quot;,</span>
<a href="#l49.656"></a><span id="l49.656" class="difflineminus">-    get helpString() { return _(&quot;command.topic&quot;, &quot;topic&quot;); },</span>
<a href="#l49.657"></a><span id="l49.657" class="difflineplus">+    get helpString() {</span>
<a href="#l49.658"></a><span id="l49.658" class="difflineplus">+      return _(&quot;command.topic&quot;, &quot;topic&quot;);</span>
<a href="#l49.659"></a><span id="l49.659" class="difflineplus">+    },</span>
<a href="#l49.660"></a><span id="l49.660">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.661"></a><span id="l49.661">     run(aMsg, aConv) {</span>
<a href="#l49.662"></a><span id="l49.662">       aConv.topic = aMsg;</span>
<a href="#l49.663"></a><span id="l49.663">       return true;</span>
<a href="#l49.664"></a><span id="l49.664">     },</span>
<a href="#l49.665"></a><span id="l49.665">   },</span>
<a href="#l49.666"></a><span id="l49.666">   {</span>
<a href="#l49.667"></a><span id="l49.667">     name: &quot;umode&quot;,</span>
<a href="#l49.668"></a><span id="l49.668" class="difflineminus">-    get helpString() { return _(&quot;command.umode&quot;, &quot;umode&quot;); },</span>
<a href="#l49.669"></a><span id="l49.669" class="difflineplus">+    get helpString() {</span>
<a href="#l49.670"></a><span id="l49.670" class="difflineplus">+      return _(&quot;command.umode&quot;, &quot;umode&quot;);</span>
<a href="#l49.671"></a><span id="l49.671" class="difflineplus">+    },</span>
<a href="#l49.672"></a><span id="l49.672">     run(aMsg, aConv) {</span>
<a href="#l49.673"></a><span id="l49.673">       let params = aMsg ? splitInput(aMsg) : [];</span>
<a href="#l49.674"></a><span id="l49.674">       params.unshift(getAccount(aConv)._nickname);</span>
<a href="#l49.675"></a><span id="l49.675">       return simpleCommand(aConv, &quot;MODE&quot;, params);</span>
<a href="#l49.676"></a><span id="l49.676">     },</span>
<a href="#l49.677"></a><span id="l49.677">   },</span>
<a href="#l49.678"></a><span id="l49.678">   {</span>
<a href="#l49.679"></a><span id="l49.679">     name: &quot;version&quot;,</span>
<a href="#l49.680"></a><span id="l49.680" class="difflineminus">-    get helpString() { return _(&quot;command.version&quot;, &quot;version&quot;); },</span>
<a href="#l49.681"></a><span id="l49.681" class="difflineplus">+    get helpString() {</span>
<a href="#l49.682"></a><span id="l49.682" class="difflineplus">+      return _(&quot;command.version&quot;, &quot;version&quot;);</span>
<a href="#l49.683"></a><span id="l49.683" class="difflineplus">+    },</span>
<a href="#l49.684"></a><span id="l49.684">     run(aMsg, aConv) {</span>
<a href="#l49.685"></a><span id="l49.685" class="difflineminus">-      if (!aMsg || !aMsg.trim().length)</span>
<a href="#l49.686"></a><span id="l49.686" class="difflineplus">+      if (!aMsg || !aMsg.trim().length) {</span>
<a href="#l49.687"></a><span id="l49.687">         return false;</span>
<a href="#l49.688"></a><span id="l49.688" class="difflineplus">+      }</span>
<a href="#l49.689"></a><span id="l49.689">       ctcpCommand(aConv, aMsg, &quot;VERSION&quot;);</span>
<a href="#l49.690"></a><span id="l49.690">       return true;</span>
<a href="#l49.691"></a><span id="l49.691">     },</span>
<a href="#l49.692"></a><span id="l49.692">   },</span>
<a href="#l49.693"></a><span id="l49.693">   {</span>
<a href="#l49.694"></a><span id="l49.694">     name: &quot;voice&quot;,</span>
<a href="#l49.695"></a><span id="l49.695" class="difflineminus">-    get helpString() { return _(&quot;command.voice&quot;, &quot;voice&quot;); },</span>
<a href="#l49.696"></a><span id="l49.696" class="difflineplus">+    get helpString() {</span>
<a href="#l49.697"></a><span id="l49.697" class="difflineplus">+      return _(&quot;command.voice&quot;, &quot;voice&quot;);</span>
<a href="#l49.698"></a><span id="l49.698" class="difflineplus">+    },</span>
<a href="#l49.699"></a><span id="l49.699">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l49.700"></a><span id="l49.700">     run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;v&quot;, true),</span>
<a href="#l49.701"></a><span id="l49.701">   },</span>
<a href="#l49.702"></a><span id="l49.702">   {</span>
<a href="#l49.703"></a><span id="l49.703">     name: &quot;whois&quot;,</span>
<a href="#l49.704"></a><span id="l49.704" class="difflineminus">-    get helpString() { return _(&quot;command.whois2&quot;, &quot;whois&quot;); },</span>
<a href="#l49.705"></a><span id="l49.705" class="difflineplus">+    get helpString() {</span>
<a href="#l49.706"></a><span id="l49.706" class="difflineplus">+      return _(&quot;command.whois2&quot;, &quot;whois&quot;);</span>
<a href="#l49.707"></a><span id="l49.707" class="difflineplus">+    },</span>
<a href="#l49.708"></a><span id="l49.708">     run(aMsg, aConv) {</span>
<a href="#l49.709"></a><span id="l49.709">       // Note that this will automatically run whowas if the nick is offline.</span>
<a href="#l49.710"></a><span id="l49.710">       aMsg = aMsg.trim();</span>
<a href="#l49.711"></a><span id="l49.711">       // If multiple parameters are given, this is an error.</span>
<a href="#l49.712"></a><span id="l49.712" class="difflineminus">-      if (aMsg.includes(&quot; &quot;))</span>
<a href="#l49.713"></a><span id="l49.713" class="difflineplus">+      if (aMsg.includes(&quot; &quot;)) {</span>
<a href="#l49.714"></a><span id="l49.714">         return false;</span>
<a href="#l49.715"></a><span id="l49.715" class="difflineplus">+      }</span>
<a href="#l49.716"></a><span id="l49.716">       // If the user does not provide a nick, but is in a private conversation,</span>
<a href="#l49.717"></a><span id="l49.717">       // assume the user is trying to whois the person they are talking to.</span>
<a href="#l49.718"></a><span id="l49.718">       if (!aMsg) {</span>
<a href="#l49.719"></a><span id="l49.719" class="difflineminus">-        if (aConv.isChat)</span>
<a href="#l49.720"></a><span id="l49.720" class="difflineplus">+        if (aConv.isChat) {</span>
<a href="#l49.721"></a><span id="l49.721">           return false;</span>
<a href="#l49.722"></a><span id="l49.722" class="difflineplus">+        }</span>
<a href="#l49.723"></a><span id="l49.723">         aMsg = aConv.name;</span>
<a href="#l49.724"></a><span id="l49.724">       }</span>
<a href="#l49.725"></a><span id="l49.725">       getConv(aConv).requestCurrentWhois(aMsg);</span>
<a href="#l49.726"></a><span id="l49.726">       return true;</span>
<a href="#l49.727"></a><span id="l49.727">     },</span>
<a href="#l49.728"></a><span id="l49.728">   },</span>
<a href="#l49.729"></a><span id="l49.729"> ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/chat/protocols/irc/ircDCC.jsm</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/chat/protocols/irc/ircDCC.jsm</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -4,19 +4,21 @@</span>
<a href="#l50.4"></a><span id="l50.4"> </span>
<a href="#l50.5"></a><span id="l50.5"> /*</span>
<a href="#l50.6"></a><span id="l50.6">  * This contains an implementation of the Direct Client-to-Client (DCC)</span>
<a href="#l50.7"></a><span id="l50.7">  * protocol.</span>
<a href="#l50.8"></a><span id="l50.8">  *   A description of the DCC protocol</span>
<a href="#l50.9"></a><span id="l50.9">  *     http://www.irchelp.org/irchelp/rfc/dccspec.html</span>
<a href="#l50.10"></a><span id="l50.10">  */</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;ctcpDCC&quot;/* , &quot;dccBase&quot;*/];</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;ctcpDCC&quot; /* , &quot;dccBase&quot;*/];</span>
<a href="#l50.14"></a><span id="l50.14"> </span>
<a href="#l50.15"></a><span id="l50.15" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+);</span>
<a href="#l50.19"></a><span id="l50.19"> </span>
<a href="#l50.20"></a><span id="l50.20"> // Parse a CTCP message into a DCC message. A DCC message is a CTCP message of</span>
<a href="#l50.21"></a><span id="l50.21"> // the form:</span>
<a href="#l50.22"></a><span id="l50.22"> //   DCC &lt;type&gt; &lt;argument&gt; &lt;address&gt; &lt;port&gt; [&lt;size&gt;]</span>
<a href="#l50.23"></a><span id="l50.23"> function DCCMessage(aMessage, aAccount) {</span>
<a href="#l50.24"></a><span id="l50.24">   let message = aMessage;</span>
<a href="#l50.25"></a><span id="l50.25">   let params = message.ctcp.param.split(&quot; &quot;);</span>
<a href="#l50.26"></a><span id="l50.26">   if (params.length &lt; 4) {</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineat">@@ -32,35 +34,37 @@ function DCCMessage(aMessage, aAccount) </span>
<a href="#l50.28"></a><span id="l50.28">       type: params[0],</span>
<a href="#l50.29"></a><span id="l50.29">       argument: params[1],</span>
<a href="#l50.30"></a><span id="l50.30">       address: Number(params[2]),</span>
<a href="#l50.31"></a><span id="l50.31">       port: Number(params[3]),</span>
<a href="#l50.32"></a><span id="l50.32">       size: params.length == 5 ? Number(params[4]) : null,</span>
<a href="#l50.33"></a><span id="l50.33">       furtherArguments: params.length &gt; 5 ? params.slice(5) : [],</span>
<a href="#l50.34"></a><span id="l50.34">     };</span>
<a href="#l50.35"></a><span id="l50.35">   } catch (e) {</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineminus">-    aAccount.ERROR(&quot;Error parsing DCC parameters:\n&quot; +</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineminus">-                   JSON.stringify(aMessage));</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineplus">+    aAccount.ERROR(</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineplus">+      &quot;Error parsing DCC parameters:\n&quot; + JSON.stringify(aMessage)</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineplus">+    );</span>
<a href="#l50.41"></a><span id="l50.41">     return null;</span>
<a href="#l50.42"></a><span id="l50.42">   }</span>
<a href="#l50.43"></a><span id="l50.43"> </span>
<a href="#l50.44"></a><span id="l50.44">   return message;</span>
<a href="#l50.45"></a><span id="l50.45"> }</span>
<a href="#l50.46"></a><span id="l50.46"> </span>
<a href="#l50.47"></a><span id="l50.47"> // This is the DCC handler for CTCP, it will call each DCC handler.</span>
<a href="#l50.48"></a><span id="l50.48"> var ctcpDCC = {</span>
<a href="#l50.49"></a><span id="l50.49">   name: &quot;DCC&quot;,</span>
<a href="#l50.50"></a><span id="l50.50">   // Slightly above default CTCP priority.</span>
<a href="#l50.51"></a><span id="l50.51">   priority: ircHandlers.HIGH_PRIORITY + 10,</span>
<a href="#l50.52"></a><span id="l50.52">   isEnabled: () =&gt; true,</span>
<a href="#l50.53"></a><span id="l50.53"> </span>
<a href="#l50.54"></a><span id="l50.54">   commands: {</span>
<a href="#l50.55"></a><span id="l50.55">     // Handle a DCC message by parsing the message and executing any handlers.</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineminus">-    &quot;DCC&quot;: function(aMessage) {</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineplus">+    DCC(aMessage) {</span>
<a href="#l50.58"></a><span id="l50.58">       // If there are no DCC handlers, then don't parse the DCC message.</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineminus">-      if (!ircHandlers.hasDCCHandlers)</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineplus">+      if (!ircHandlers.hasDCCHandlers) {</span>
<a href="#l50.61"></a><span id="l50.61">         return false;</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineplus">+      }</span>
<a href="#l50.63"></a><span id="l50.63"> </span>
<a href="#l50.64"></a><span id="l50.64">       // Parse the message and attempt to handle it.</span>
<a href="#l50.65"></a><span id="l50.65">       return ircHandlers.handleDCCMessage(this, DCCMessage(aMessage, this));</span>
<a href="#l50.66"></a><span id="l50.66">     },</span>
<a href="#l50.67"></a><span id="l50.67">   },</span>
<a href="#l50.68"></a><span id="l50.68"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -34,23 +34,29 @@ var ircHandlers = {</span>
<a href="#l51.4"></a><span id="l51.4">   _servicesHandlers: [],</span>
<a href="#l51.5"></a><span id="l51.5">   // Object to hold irc message tag handlers, expects the same fields as</span>
<a href="#l51.6"></a><span id="l51.6">   // _ircHandlers.</span>
<a href="#l51.7"></a><span id="l51.7">   _tagHandlers: [],</span>
<a href="#l51.8"></a><span id="l51.8"> </span>
<a href="#l51.9"></a><span id="l51.9">   _registerHandler(aArray, aHandler) {</span>
<a href="#l51.10"></a><span id="l51.10">     // Protect ourselves from adding broken handlers.</span>
<a href="#l51.11"></a><span id="l51.11">     if (!(&quot;commands&quot; in aHandler)) {</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-      Cu.reportError(new Error(&quot;IRC handlers must have a \&quot;commands\&quot; &quot; +</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-                               &quot;property: &quot; + aHandler.name));</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+      Cu.reportError(</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+        new Error(</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+          'IRC handlers must have a &quot;commands&quot; ' + &quot;property: &quot; + aHandler.name</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+        )</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+      );</span>
<a href="#l51.19"></a><span id="l51.19">       return false;</span>
<a href="#l51.20"></a><span id="l51.20">     }</span>
<a href="#l51.21"></a><span id="l51.21">     if (!(&quot;isEnabled&quot; in aHandler)) {</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineminus">-      Cu.reportError(new Error(&quot;IRC handlers must have a \&quot;isEnabled\&quot; &quot; +</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineminus">-                               &quot;property: &quot; + aHandler.name));</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineplus">+      Cu.reportError(</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineplus">+        new Error(</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineplus">+          'IRC handlers must have a &quot;isEnabled&quot; ' + &quot;property: &quot; + aHandler.name</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineplus">+        )</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineplus">+      );</span>
<a href="#l51.29"></a><span id="l51.29">       return false;</span>
<a href="#l51.30"></a><span id="l51.30">     }</span>
<a href="#l51.31"></a><span id="l51.31"> </span>
<a href="#l51.32"></a><span id="l51.32">     aArray.push(aHandler);</span>
<a href="#l51.33"></a><span id="l51.33">     aArray.sort((a, b) =&gt; b.priority - a.priority);</span>
<a href="#l51.34"></a><span id="l51.34">     return true;</span>
<a href="#l51.35"></a><span id="l51.35">   },</span>
<a href="#l51.36"></a><span id="l51.36"> </span>
<a href="#l51.37"></a><span id="l51.37" class="difflineat">@@ -64,18 +70,20 @@ var ircHandlers = {</span>
<a href="#l51.38"></a><span id="l51.38">   unregisterHandler(aHandler) {</span>
<a href="#l51.39"></a><span id="l51.39">     this._ircHandlers = this._unregisterHandler(this._ircHandlers, aHandler);</span>
<a href="#l51.40"></a><span id="l51.40">   },</span>
<a href="#l51.41"></a><span id="l51.41"> </span>
<a href="#l51.42"></a><span id="l51.42">   registerISUPPORTHandler(aHandler) {</span>
<a href="#l51.43"></a><span id="l51.43">     return this._registerHandler(this._isupportHandlers, aHandler);</span>
<a href="#l51.44"></a><span id="l51.44">   },</span>
<a href="#l51.45"></a><span id="l51.45">   unregisterISUPPORTHandler(aHandler) {</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineminus">-    this._isupportHandlers = this._unregisterHandler(this._isupportHandlers,</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineminus">-                                                     aHandler);</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineplus">+    this._isupportHandlers = this._unregisterHandler(</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+      this._isupportHandlers,</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineplus">+      aHandler</span>
<a href="#l51.51"></a><span id="l51.51" class="difflineplus">+    );</span>
<a href="#l51.52"></a><span id="l51.52">   },</span>
<a href="#l51.53"></a><span id="l51.53"> </span>
<a href="#l51.54"></a><span id="l51.54">   registerCAPHandler(aHandler) {</span>
<a href="#l51.55"></a><span id="l51.55">     return this._registerHandler(this._capHandlers, aHandler);</span>
<a href="#l51.56"></a><span id="l51.56">   },</span>
<a href="#l51.57"></a><span id="l51.57">   unregisterCAPHandler(aHandler) {</span>
<a href="#l51.58"></a><span id="l51.58">     this._capHandlers = this._unregisterHandler(this._capHandlers, aHandler);</span>
<a href="#l51.59"></a><span id="l51.59">   },</span>
<a href="#l51.60"></a><span id="l51.60" class="difflineat">@@ -93,18 +101,20 @@ var ircHandlers = {</span>
<a href="#l51.61"></a><span id="l51.61">   unregisterDCCHandler(aHandler) {</span>
<a href="#l51.62"></a><span id="l51.62">     this._dccHandlers = this._unregisterHandler(this._dccHandlers, aHandler);</span>
<a href="#l51.63"></a><span id="l51.63">   },</span>
<a href="#l51.64"></a><span id="l51.64"> </span>
<a href="#l51.65"></a><span id="l51.65">   registerServicesHandler(aHandler) {</span>
<a href="#l51.66"></a><span id="l51.66">     return this._registerHandler(this._servicesHandlers, aHandler);</span>
<a href="#l51.67"></a><span id="l51.67">   },</span>
<a href="#l51.68"></a><span id="l51.68">   unregisterServicesHandler(aHandler) {</span>
<a href="#l51.69"></a><span id="l51.69" class="difflineminus">-    this._servicesHandlers = this._unregisterHandler(this._servicesHandlers,</span>
<a href="#l51.70"></a><span id="l51.70" class="difflineminus">-                                                     aHandler);</span>
<a href="#l51.71"></a><span id="l51.71" class="difflineplus">+    this._servicesHandlers = this._unregisterHandler(</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineplus">+      this._servicesHandlers,</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineplus">+      aHandler</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineplus">+    );</span>
<a href="#l51.75"></a><span id="l51.75">   },</span>
<a href="#l51.76"></a><span id="l51.76"> </span>
<a href="#l51.77"></a><span id="l51.77">   registerTagHandler(aHandler) {</span>
<a href="#l51.78"></a><span id="l51.78">     return this._registerHandler(this._tagHandlers, aHandler);</span>
<a href="#l51.79"></a><span id="l51.79">   },</span>
<a href="#l51.80"></a><span id="l51.80">   unregisterTagHandler(aHandler) {</span>
<a href="#l51.81"></a><span id="l51.81">     this._tagHandlers = this._unregisterHandler(this._tagHandlers, aHandler);</span>
<a href="#l51.82"></a><span id="l51.82">   },</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineat">@@ -112,75 +122,134 @@ var ircHandlers = {</span>
<a href="#l51.84"></a><span id="l51.84">   // Handle a message based on a set of handlers.</span>
<a href="#l51.85"></a><span id="l51.85">   _handleMessage(aHandlers, aAccount, aMessage, aCommand) {</span>
<a href="#l51.86"></a><span id="l51.86">     // Loop over each handler and run the command until one handles the message.</span>
<a href="#l51.87"></a><span id="l51.87">     for (let handler of aHandlers) {</span>
<a href="#l51.88"></a><span id="l51.88">       try {</span>
<a href="#l51.89"></a><span id="l51.89">         // Attempt to execute the command, by checking if the handler has the</span>
<a href="#l51.90"></a><span id="l51.90">         // command.</span>
<a href="#l51.91"></a><span id="l51.91">         // Parse the command with the JavaScript account object as &quot;this&quot;.</span>
<a href="#l51.92"></a><span id="l51.92" class="difflineminus">-        if (handler.isEnabled.call(aAccount) &amp;&amp; aCommand in handler.commands &amp;&amp;</span>
<a href="#l51.93"></a><span id="l51.93" class="difflineminus">-            handler.commands[aCommand].call(aAccount, aMessage))</span>
<a href="#l51.94"></a><span id="l51.94" class="difflineplus">+        if (</span>
<a href="#l51.95"></a><span id="l51.95" class="difflineplus">+          handler.isEnabled.call(aAccount) &amp;&amp;</span>
<a href="#l51.96"></a><span id="l51.96" class="difflineplus">+          aCommand in handler.commands &amp;&amp;</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineplus">+          handler.commands[aCommand].call(aAccount, aMessage)</span>
<a href="#l51.98"></a><span id="l51.98" class="difflineplus">+        ) {</span>
<a href="#l51.99"></a><span id="l51.99">           return true;</span>
<a href="#l51.100"></a><span id="l51.100" class="difflineplus">+        }</span>
<a href="#l51.101"></a><span id="l51.101">       } catch (e) {</span>
<a href="#l51.102"></a><span id="l51.102">         // We want to catch an error here because one of our handlers are</span>
<a href="#l51.103"></a><span id="l51.103">         // broken, if we don't catch the error, the whole IRC plug-in will die.</span>
<a href="#l51.104"></a><span id="l51.104" class="difflineminus">-        aAccount.ERROR(&quot;Error running command &quot; + aCommand + &quot; with handler &quot; +</span>
<a href="#l51.105"></a><span id="l51.105" class="difflineminus">-                       handler.name + &quot;:\n&quot; + JSON.stringify(aMessage), e);</span>
<a href="#l51.106"></a><span id="l51.106" class="difflineplus">+        aAccount.ERROR(</span>
<a href="#l51.107"></a><span id="l51.107" class="difflineplus">+          &quot;Error running command &quot; +</span>
<a href="#l51.108"></a><span id="l51.108" class="difflineplus">+            aCommand +</span>
<a href="#l51.109"></a><span id="l51.109" class="difflineplus">+            &quot; with handler &quot; +</span>
<a href="#l51.110"></a><span id="l51.110" class="difflineplus">+            handler.name +</span>
<a href="#l51.111"></a><span id="l51.111" class="difflineplus">+            &quot;:\n&quot; +</span>
<a href="#l51.112"></a><span id="l51.112" class="difflineplus">+            JSON.stringify(aMessage),</span>
<a href="#l51.113"></a><span id="l51.113" class="difflineplus">+          e</span>
<a href="#l51.114"></a><span id="l51.114" class="difflineplus">+        );</span>
<a href="#l51.115"></a><span id="l51.115">       }</span>
<a href="#l51.116"></a><span id="l51.116">     }</span>
<a href="#l51.117"></a><span id="l51.117"> </span>
<a href="#l51.118"></a><span id="l51.118">     return false;</span>
<a href="#l51.119"></a><span id="l51.119">   },</span>
<a href="#l51.120"></a><span id="l51.120"> </span>
<a href="#l51.121"></a><span id="l51.121">   handleMessage(aAccount, aMessage) {</span>
<a href="#l51.122"></a><span id="l51.122" class="difflineminus">-    return this._handleMessage(this._ircHandlers, aAccount, aMessage,</span>
<a href="#l51.123"></a><span id="l51.123" class="difflineminus">-                               aMessage.command.toUpperCase());</span>
<a href="#l51.124"></a><span id="l51.124" class="difflineplus">+    return this._handleMessage(</span>
<a href="#l51.125"></a><span id="l51.125" class="difflineplus">+      this._ircHandlers,</span>
<a href="#l51.126"></a><span id="l51.126" class="difflineplus">+      aAccount,</span>
<a href="#l51.127"></a><span id="l51.127" class="difflineplus">+      aMessage,</span>
<a href="#l51.128"></a><span id="l51.128" class="difflineplus">+      aMessage.command.toUpperCase()</span>
<a href="#l51.129"></a><span id="l51.129" class="difflineplus">+    );</span>
<a href="#l51.130"></a><span id="l51.130">   },</span>
<a href="#l51.131"></a><span id="l51.131"> </span>
<a href="#l51.132"></a><span id="l51.132">   handleISUPPORTMessage(aAccount, aMessage) {</span>
<a href="#l51.133"></a><span id="l51.133" class="difflineminus">-    return this._handleMessage(this._isupportHandlers, aAccount, aMessage,</span>
<a href="#l51.134"></a><span id="l51.134" class="difflineminus">-                               aMessage.isupport.parameter);</span>
<a href="#l51.135"></a><span id="l51.135" class="difflineplus">+    return this._handleMessage(</span>
<a href="#l51.136"></a><span id="l51.136" class="difflineplus">+      this._isupportHandlers,</span>
<a href="#l51.137"></a><span id="l51.137" class="difflineplus">+      aAccount,</span>
<a href="#l51.138"></a><span id="l51.138" class="difflineplus">+      aMessage,</span>
<a href="#l51.139"></a><span id="l51.139" class="difflineplus">+      aMessage.isupport.parameter</span>
<a href="#l51.140"></a><span id="l51.140" class="difflineplus">+    );</span>
<a href="#l51.141"></a><span id="l51.141">   },</span>
<a href="#l51.142"></a><span id="l51.142"> </span>
<a href="#l51.143"></a><span id="l51.143">   handleCAPMessage(aAccount, aMessage) {</span>
<a href="#l51.144"></a><span id="l51.144" class="difflineminus">-    return this._handleMessage(this._capHandlers, aAccount, aMessage,</span>
<a href="#l51.145"></a><span id="l51.145" class="difflineminus">-                               aMessage.cap.parameter);</span>
<a href="#l51.146"></a><span id="l51.146" class="difflineplus">+    return this._handleMessage(</span>
<a href="#l51.147"></a><span id="l51.147" class="difflineplus">+      this._capHandlers,</span>
<a href="#l51.148"></a><span id="l51.148" class="difflineplus">+      aAccount,</span>
<a href="#l51.149"></a><span id="l51.149" class="difflineplus">+      aMessage,</span>
<a href="#l51.150"></a><span id="l51.150" class="difflineplus">+      aMessage.cap.parameter</span>
<a href="#l51.151"></a><span id="l51.151" class="difflineplus">+    );</span>
<a href="#l51.152"></a><span id="l51.152">   },</span>
<a href="#l51.153"></a><span id="l51.153"> </span>
<a href="#l51.154"></a><span id="l51.154">   // aMessage is a CTCP Message, which inherits from an IRC Message.</span>
<a href="#l51.155"></a><span id="l51.155">   handleCTCPMessage(aAccount, aMessage) {</span>
<a href="#l51.156"></a><span id="l51.156" class="difflineminus">-    return this._handleMessage(this._ctcpHandlers, aAccount, aMessage,</span>
<a href="#l51.157"></a><span id="l51.157" class="difflineminus">-                               aMessage.ctcp.command);</span>
<a href="#l51.158"></a><span id="l51.158" class="difflineplus">+    return this._handleMessage(</span>
<a href="#l51.159"></a><span id="l51.159" class="difflineplus">+      this._ctcpHandlers,</span>
<a href="#l51.160"></a><span id="l51.160" class="difflineplus">+      aAccount,</span>
<a href="#l51.161"></a><span id="l51.161" class="difflineplus">+      aMessage,</span>
<a href="#l51.162"></a><span id="l51.162" class="difflineplus">+      aMessage.ctcp.command</span>
<a href="#l51.163"></a><span id="l51.163" class="difflineplus">+    );</span>
<a href="#l51.164"></a><span id="l51.164">   },</span>
<a href="#l51.165"></a><span id="l51.165"> </span>
<a href="#l51.166"></a><span id="l51.166">   // aMessage is a DCC Message, which inherits from a CTCP Message.</span>
<a href="#l51.167"></a><span id="l51.167">   handleDCCMessage(aAccount, aMessage) {</span>
<a href="#l51.168"></a><span id="l51.168" class="difflineminus">-    return this._handleMessage(this._dccHandlers, aAccount, aMessage,</span>
<a href="#l51.169"></a><span id="l51.169" class="difflineminus">-                               aMessage.ctcp.dcc.type);</span>
<a href="#l51.170"></a><span id="l51.170" class="difflineplus">+    return this._handleMessage(</span>
<a href="#l51.171"></a><span id="l51.171" class="difflineplus">+      this._dccHandlers,</span>
<a href="#l51.172"></a><span id="l51.172" class="difflineplus">+      aAccount,</span>
<a href="#l51.173"></a><span id="l51.173" class="difflineplus">+      aMessage,</span>
<a href="#l51.174"></a><span id="l51.174" class="difflineplus">+      aMessage.ctcp.dcc.type</span>
<a href="#l51.175"></a><span id="l51.175" class="difflineplus">+    );</span>
<a href="#l51.176"></a><span id="l51.176">   },</span>
<a href="#l51.177"></a><span id="l51.177"> </span>
<a href="#l51.178"></a><span id="l51.178">   // aMessage is a Services Message.</span>
<a href="#l51.179"></a><span id="l51.179">   handleServicesMessage(aAccount, aMessage) {</span>
<a href="#l51.180"></a><span id="l51.180" class="difflineminus">-    return this._handleMessage(this._servicesHandlers, aAccount, aMessage,</span>
<a href="#l51.181"></a><span id="l51.181" class="difflineminus">-                               aMessage.serviceName);</span>
<a href="#l51.182"></a><span id="l51.182" class="difflineplus">+    return this._handleMessage(</span>
<a href="#l51.183"></a><span id="l51.183" class="difflineplus">+      this._servicesHandlers,</span>
<a href="#l51.184"></a><span id="l51.184" class="difflineplus">+      aAccount,</span>
<a href="#l51.185"></a><span id="l51.185" class="difflineplus">+      aMessage,</span>
<a href="#l51.186"></a><span id="l51.186" class="difflineplus">+      aMessage.serviceName</span>
<a href="#l51.187"></a><span id="l51.187" class="difflineplus">+    );</span>
<a href="#l51.188"></a><span id="l51.188">   },</span>
<a href="#l51.189"></a><span id="l51.189"> </span>
<a href="#l51.190"></a><span id="l51.190">   // aMessage is a Tag Message.</span>
<a href="#l51.191"></a><span id="l51.191">   handleTag(aAccount, aMessage) {</span>
<a href="#l51.192"></a><span id="l51.192" class="difflineminus">-    return this._handleMessage(this._tagHandlers, aAccount, aMessage,</span>
<a href="#l51.193"></a><span id="l51.193" class="difflineminus">-                               aMessage.tagName);</span>
<a href="#l51.194"></a><span id="l51.194" class="difflineplus">+    return this._handleMessage(</span>
<a href="#l51.195"></a><span id="l51.195" class="difflineplus">+      this._tagHandlers,</span>
<a href="#l51.196"></a><span id="l51.196" class="difflineplus">+      aAccount,</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineplus">+      aMessage,</span>
<a href="#l51.198"></a><span id="l51.198" class="difflineplus">+      aMessage.tagName</span>
<a href="#l51.199"></a><span id="l51.199" class="difflineplus">+    );</span>
<a href="#l51.200"></a><span id="l51.200">   },</span>
<a href="#l51.201"></a><span id="l51.201"> </span>
<a href="#l51.202"></a><span id="l51.202">   // Checking if handlers exist.</span>
<a href="#l51.203"></a><span id="l51.203" class="difflineminus">-  get hasHandlers() { return this._ircHandlers.length &gt; 0; },</span>
<a href="#l51.204"></a><span id="l51.204" class="difflineminus">-  get hasISUPPORTHandlers() { return this._isupportHandlers.length &gt; 0; },</span>
<a href="#l51.205"></a><span id="l51.205" class="difflineminus">-  get hasCAPHandlers() { return this._capHandlers.length &gt; 0; },</span>
<a href="#l51.206"></a><span id="l51.206" class="difflineminus">-  get hasCTCPHandlers() { return this._ctcpHandlers.length &gt; 0; },</span>
<a href="#l51.207"></a><span id="l51.207" class="difflineminus">-  get hasDCCHandlers() { return this._dccHandlers.length &gt; 0; },</span>
<a href="#l51.208"></a><span id="l51.208" class="difflineminus">-  get hasServicesHandlers() { return this._servicesHandlers.length &gt; 0; },</span>
<a href="#l51.209"></a><span id="l51.209" class="difflineminus">-  get hasTagHandlers() { return this._tagHandlers.length &gt; 0; },</span>
<a href="#l51.210"></a><span id="l51.210" class="difflineplus">+  get hasHandlers() {</span>
<a href="#l51.211"></a><span id="l51.211" class="difflineplus">+    return this._ircHandlers.length &gt; 0;</span>
<a href="#l51.212"></a><span id="l51.212" class="difflineplus">+  },</span>
<a href="#l51.213"></a><span id="l51.213" class="difflineplus">+  get hasISUPPORTHandlers() {</span>
<a href="#l51.214"></a><span id="l51.214" class="difflineplus">+    return this._isupportHandlers.length &gt; 0;</span>
<a href="#l51.215"></a><span id="l51.215" class="difflineplus">+  },</span>
<a href="#l51.216"></a><span id="l51.216" class="difflineplus">+  get hasCAPHandlers() {</span>
<a href="#l51.217"></a><span id="l51.217" class="difflineplus">+    return this._capHandlers.length &gt; 0;</span>
<a href="#l51.218"></a><span id="l51.218" class="difflineplus">+  },</span>
<a href="#l51.219"></a><span id="l51.219" class="difflineplus">+  get hasCTCPHandlers() {</span>
<a href="#l51.220"></a><span id="l51.220" class="difflineplus">+    return this._ctcpHandlers.length &gt; 0;</span>
<a href="#l51.221"></a><span id="l51.221" class="difflineplus">+  },</span>
<a href="#l51.222"></a><span id="l51.222" class="difflineplus">+  get hasDCCHandlers() {</span>
<a href="#l51.223"></a><span id="l51.223" class="difflineplus">+    return this._dccHandlers.length &gt; 0;</span>
<a href="#l51.224"></a><span id="l51.224" class="difflineplus">+  },</span>
<a href="#l51.225"></a><span id="l51.225" class="difflineplus">+  get hasServicesHandlers() {</span>
<a href="#l51.226"></a><span id="l51.226" class="difflineplus">+    return this._servicesHandlers.length &gt; 0;</span>
<a href="#l51.227"></a><span id="l51.227" class="difflineplus">+  },</span>
<a href="#l51.228"></a><span id="l51.228" class="difflineplus">+  get hasTagHandlers() {</span>
<a href="#l51.229"></a><span id="l51.229" class="difflineplus">+    return this._tagHandlers.length &gt; 0;</span>
<a href="#l51.230"></a><span id="l51.230" class="difflineplus">+  },</span>
<a href="#l51.231"></a><span id="l51.231"> </span>
<a href="#l51.232"></a><span id="l51.232">   // Some constant priorities.</span>
<a href="#l51.233"></a><span id="l51.233" class="difflineminus">-  get LOW_PRIORITY() { return -100; },</span>
<a href="#l51.234"></a><span id="l51.234" class="difflineminus">-  get DEFAULT_PRIORITY() { return 0; },</span>
<a href="#l51.235"></a><span id="l51.235" class="difflineminus">-  get HIGH_PRIORITY() { return 100; },</span>
<a href="#l51.236"></a><span id="l51.236" class="difflineplus">+  get LOW_PRIORITY() {</span>
<a href="#l51.237"></a><span id="l51.237" class="difflineplus">+    return -100;</span>
<a href="#l51.238"></a><span id="l51.238" class="difflineplus">+  },</span>
<a href="#l51.239"></a><span id="l51.239" class="difflineplus">+  get DEFAULT_PRIORITY() {</span>
<a href="#l51.240"></a><span id="l51.240" class="difflineplus">+    return 0;</span>
<a href="#l51.241"></a><span id="l51.241" class="difflineplus">+  },</span>
<a href="#l51.242"></a><span id="l51.242" class="difflineplus">+  get HIGH_PRIORITY() {</span>
<a href="#l51.243"></a><span id="l51.243" class="difflineplus">+    return 100;</span>
<a href="#l51.244"></a><span id="l51.244" class="difflineplus">+  },</span>
<a href="#l51.245"></a><span id="l51.245"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -9,17 +9,19 @@</span>
<a href="#l52.4"></a><span id="l52.4">  *     http://www.irc.org/tech_docs/005.html</span>
<a href="#l52.5"></a><span id="l52.5">  *   RFC Drafts: IRC RPL_ISUPPORT Numeric Definition</span>
<a href="#l52.6"></a><span id="l52.6">  *     http://tools.ietf.org/html/draft-brocklesby-irc-isupport-03</span>
<a href="#l52.7"></a><span id="l52.7">  *     http://tools.ietf.org/html/draft-hardy-irc-isupport-00</span>
<a href="#l52.8"></a><span id="l52.8">  */</span>
<a href="#l52.9"></a><span id="l52.9"> </span>
<a href="#l52.10"></a><span id="l52.10"> this.EXPORTED_SYMBOLS = [&quot;ircISUPPORT&quot;, &quot;isupportBase&quot;];</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+);</span>
<a href="#l52.16"></a><span id="l52.16"> </span>
<a href="#l52.17"></a><span id="l52.17"> /*</span>
<a href="#l52.18"></a><span id="l52.18">  * Parses an ircMessage into an ISUPPORT message for each token of the form:</span>
<a href="#l52.19"></a><span id="l52.19">  *   &lt;parameter&gt;=&lt;value&gt; or -&lt;value&gt;</span>
<a href="#l52.20"></a><span id="l52.20">  * The isupport field is added to the message and it has the following fields:</span>
<a href="#l52.21"></a><span id="l52.21">  *   parameter  What is being configured by this ISUPPORT token.</span>
<a href="#l52.22"></a><span id="l52.22">  *   useDefault Whether this parameter should be reset to the default value, as</span>
<a href="#l52.23"></a><span id="l52.23">  *              defined by the RFC.</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineat">@@ -30,18 +32,20 @@ function isupportMessage(aMessage) {</span>
<a href="#l52.25"></a><span id="l52.25">   let tokens = aMessage.params.slice(1, -1);</span>
<a href="#l52.26"></a><span id="l52.26"> </span>
<a href="#l52.27"></a><span id="l52.27">   let message = aMessage;</span>
<a href="#l52.28"></a><span id="l52.28">   message.isupport = {};</span>
<a href="#l52.29"></a><span id="l52.29"> </span>
<a href="#l52.30"></a><span id="l52.30">   return tokens.map(function(aToken) {</span>
<a href="#l52.31"></a><span id="l52.31">     let newMessage = JSON.parse(JSON.stringify(message));</span>
<a href="#l52.32"></a><span id="l52.32">     newMessage.isupport.useDefault = aToken[0] == &quot;-&quot;;</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineminus">-    let token =</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineminus">-      (newMessage.isupport.useDefault ? aToken.slice(1) : aToken).split(&quot;=&quot;);</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineplus">+    let token = (newMessage.isupport.useDefault</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineplus">+      ? aToken.slice(1)</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineplus">+      : aToken</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineplus">+    ).split(&quot;=&quot;);</span>
<a href="#l52.39"></a><span id="l52.39">     newMessage.isupport.parameter = token[0];</span>
<a href="#l52.40"></a><span id="l52.40">     newMessage.isupport.value = token[1] || null;</span>
<a href="#l52.41"></a><span id="l52.41">     return newMessage;</span>
<a href="#l52.42"></a><span id="l52.42">   });</span>
<a href="#l52.43"></a><span id="l52.43"> }</span>
<a href="#l52.44"></a><span id="l52.44"> </span>
<a href="#l52.45"></a><span id="l52.45"> var ircISUPPORT = {</span>
<a href="#l52.46"></a><span id="l52.46">   name: &quot;ISUPPORT&quot;,</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineat">@@ -50,160 +54,172 @@ var ircISUPPORT = {</span>
<a href="#l52.48"></a><span id="l52.48">   isEnabled: () =&gt; true,</span>
<a href="#l52.49"></a><span id="l52.49"> </span>
<a href="#l52.50"></a><span id="l52.50">   commands: {</span>
<a href="#l52.51"></a><span id="l52.51">     // RPL_ISUPPORT</span>
<a href="#l52.52"></a><span id="l52.52">     // [-]&lt;parameter&gt;[=&lt;value&gt;] :are supported by this server</span>
<a href="#l52.53"></a><span id="l52.53">     &quot;005&quot;: function(aMessage) {</span>
<a href="#l52.54"></a><span id="l52.54">       let messages = isupportMessage(aMessage);</span>
<a href="#l52.55"></a><span id="l52.55"> </span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-      messages = messages.filter(aMessage =&gt;</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineminus">-        !ircHandlers.handleISUPPORTMessage(this, aMessage));</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineplus">+      messages = messages.filter(</span>
<a href="#l52.59"></a><span id="l52.59" class="difflineplus">+        aMessage =&gt; !ircHandlers.handleISUPPORTMessage(this, aMessage)</span>
<a href="#l52.60"></a><span id="l52.60" class="difflineplus">+      );</span>
<a href="#l52.61"></a><span id="l52.61">       if (messages.length) {</span>
<a href="#l52.62"></a><span id="l52.62">         // Display the list of unhandled ISUPPORT messages.</span>
<a href="#l52.63"></a><span id="l52.63" class="difflineminus">-        let unhandledMessages =</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineminus">-          messages.map(aMsg =&gt; aMsg.isupport.parameter).join(&quot; &quot;);</span>
<a href="#l52.65"></a><span id="l52.65" class="difflineminus">-        this.LOG(&quot;Unhandled ISUPPORT messages: &quot; + unhandledMessages +</span>
<a href="#l52.66"></a><span id="l52.66" class="difflineminus">-                 &quot;\nRaw message: &quot; + aMessage.rawMessage);</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineplus">+        let unhandledMessages = messages</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineplus">+          .map(aMsg =&gt; aMsg.isupport.parameter)</span>
<a href="#l52.69"></a><span id="l52.69" class="difflineplus">+          .join(&quot; &quot;);</span>
<a href="#l52.70"></a><span id="l52.70" class="difflineplus">+        this.LOG(</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineplus">+          &quot;Unhandled ISUPPORT messages: &quot; +</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+            unhandledMessages +</span>
<a href="#l52.73"></a><span id="l52.73" class="difflineplus">+            &quot;\nRaw message: &quot; +</span>
<a href="#l52.74"></a><span id="l52.74" class="difflineplus">+            aMessage.rawMessage</span>
<a href="#l52.75"></a><span id="l52.75" class="difflineplus">+        );</span>
<a href="#l52.76"></a><span id="l52.76">       }</span>
<a href="#l52.77"></a><span id="l52.77"> </span>
<a href="#l52.78"></a><span id="l52.78">       return true;</span>
<a href="#l52.79"></a><span id="l52.79">     },</span>
<a href="#l52.80"></a><span id="l52.80">   },</span>
<a href="#l52.81"></a><span id="l52.81"> };</span>
<a href="#l52.82"></a><span id="l52.82"> </span>
<a href="#l52.83"></a><span id="l52.83"> function setSimpleNumber(aAccount, aField, aMessage, aDefaultValue) {</span>
<a href="#l52.84"></a><span id="l52.84" class="difflineminus">-  let value =</span>
<a href="#l52.85"></a><span id="l52.85" class="difflineminus">-    aMessage.isupport.value ? Number(aMessage.isupport.value) : null;</span>
<a href="#l52.86"></a><span id="l52.86" class="difflineminus">-  aAccount[aField] = (value &amp;&amp; !isNaN(value)) ? value : aDefaultValue;</span>
<a href="#l52.87"></a><span id="l52.87" class="difflineplus">+  let value = aMessage.isupport.value ? Number(aMessage.isupport.value) : null;</span>
<a href="#l52.88"></a><span id="l52.88" class="difflineplus">+  aAccount[aField] = value &amp;&amp; !isNaN(value) ? value : aDefaultValue;</span>
<a href="#l52.89"></a><span id="l52.89">   return true;</span>
<a href="#l52.90"></a><span id="l52.90"> }</span>
<a href="#l52.91"></a><span id="l52.91"> </span>
<a href="#l52.92"></a><span id="l52.92"> // Generates an expression to search for the ASCII range of a-b.</span>
<a href="#l52.93"></a><span id="l52.93"> function generateNormalize(a, b) {</span>
<a href="#l52.94"></a><span id="l52.94" class="difflineminus">-  return new RegExp(&quot;[\\x&quot; + a.toString(16) + &quot;-\\x&quot; + b.toString(16) + &quot;]&quot;, &quot;g&quot;);</span>
<a href="#l52.95"></a><span id="l52.95" class="difflineplus">+  return new RegExp(</span>
<a href="#l52.96"></a><span id="l52.96" class="difflineplus">+    &quot;[\\x&quot; + a.toString(16) + &quot;-\\x&quot; + b.toString(16) + &quot;]&quot;,</span>
<a href="#l52.97"></a><span id="l52.97" class="difflineplus">+    &quot;g&quot;</span>
<a href="#l52.98"></a><span id="l52.98" class="difflineplus">+  );</span>
<a href="#l52.99"></a><span id="l52.99"> }</span>
<a href="#l52.100"></a><span id="l52.100"> </span>
<a href="#l52.101"></a><span id="l52.101"> var isupportBase = {</span>
<a href="#l52.102"></a><span id="l52.102">   name: &quot;ISUPPORT&quot;,</span>
<a href="#l52.103"></a><span id="l52.103">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l52.104"></a><span id="l52.104">   isEnabled: () =&gt; true,</span>
<a href="#l52.105"></a><span id="l52.105"> </span>
<a href="#l52.106"></a><span id="l52.106">   commands: {</span>
<a href="#l52.107"></a><span id="l52.107" class="difflineminus">-    &quot;CASEMAPPING&quot;: function(aMessage) {</span>
<a href="#l52.108"></a><span id="l52.108" class="difflineplus">+    CASEMAPPING(aMessage) {</span>
<a href="#l52.109"></a><span id="l52.109">       // CASEMAPPING=&lt;mapping&gt;</span>
<a href="#l52.110"></a><span id="l52.110">       // Allows the server to specify which method it uses to compare equality</span>
<a href="#l52.111"></a><span id="l52.111">       // of case-insensitive strings.</span>
<a href="#l52.112"></a><span id="l52.112"> </span>
<a href="#l52.113"></a><span id="l52.113">       // By default, use rfc1459 type case mapping.</span>
<a href="#l52.114"></a><span id="l52.114" class="difflineminus">-      let value = aMessage.isupport.useDefault ?</span>
<a href="#l52.115"></a><span id="l52.115" class="difflineminus">-        &quot;rfc1493&quot; : aMessage.isupport.value;</span>
<a href="#l52.116"></a><span id="l52.116" class="difflineplus">+      let value = aMessage.isupport.useDefault</span>
<a href="#l52.117"></a><span id="l52.117" class="difflineplus">+        ? &quot;rfc1493&quot;</span>
<a href="#l52.118"></a><span id="l52.118" class="difflineplus">+        : aMessage.isupport.value;</span>
<a href="#l52.119"></a><span id="l52.119"> </span>
<a href="#l52.120"></a><span id="l52.120">       // Set the normalize function of the account to use the proper case</span>
<a href="#l52.121"></a><span id="l52.121">       // mapping.</span>
<a href="#l52.122"></a><span id="l52.122">       if (value == &quot;ascii&quot;) {</span>
<a href="#l52.123"></a><span id="l52.123">         // The ASCII characters 97 to 122 (decimal) are the lower-case</span>
<a href="#l52.124"></a><span id="l52.124">         // characters of ASCII 65 to 90 (decimal).</span>
<a href="#l52.125"></a><span id="l52.125">         this.normalizeExpression = generateNormalize(65, 90);</span>
<a href="#l52.126"></a><span id="l52.126" class="difflineminus">-      }</span>
<a href="#l52.127"></a><span id="l52.127" class="difflineminus">-      else if (value == &quot;rfc1493&quot;) {</span>
<a href="#l52.128"></a><span id="l52.128" class="difflineplus">+      } else if (value == &quot;rfc1493&quot;) {</span>
<a href="#l52.129"></a><span id="l52.129">         // The ASCII characters 97 to 126 (decimal) are the lower-case</span>
<a href="#l52.130"></a><span id="l52.130">         // characters of ASCII 65 to 94 (decimal).</span>
<a href="#l52.131"></a><span id="l52.131">         this.normalizeExpression = generateNormalize(65, 94);</span>
<a href="#l52.132"></a><span id="l52.132" class="difflineminus">-      }</span>
<a href="#l52.133"></a><span id="l52.133" class="difflineminus">-      else if (value == &quot;strict-rfc1459&quot;) {</span>
<a href="#l52.134"></a><span id="l52.134" class="difflineplus">+      } else if (value == &quot;strict-rfc1459&quot;) {</span>
<a href="#l52.135"></a><span id="l52.135">         // The ASCII characters 97 to 125 (decimal) are the lower-case</span>
<a href="#l52.136"></a><span id="l52.136">         // characters of ASCII 65 to 93 (decimal).</span>
<a href="#l52.137"></a><span id="l52.137">         this.normalizeExpression = generateNormalize(65, 93);</span>
<a href="#l52.138"></a><span id="l52.138">       }</span>
<a href="#l52.139"></a><span id="l52.139">       return true;</span>
<a href="#l52.140"></a><span id="l52.140">     },</span>
<a href="#l52.141"></a><span id="l52.141" class="difflineminus">-    &quot;CHANLIMIT&quot;: function(aMessage) {</span>
<a href="#l52.142"></a><span id="l52.142" class="difflineplus">+    CHANLIMIT(aMessage) {</span>
<a href="#l52.143"></a><span id="l52.143">       // CHANLIMIT=&lt;prefix&gt;:&lt;number&gt;[,&lt;prefix&gt;:&lt;number&gt;]*</span>
<a href="#l52.144"></a><span id="l52.144">       // Note that each &lt;prefix&gt; can actually contain multiple prefixes, this</span>
<a href="#l52.145"></a><span id="l52.145">       // means the sum of those prefixes is given.</span>
<a href="#l52.146"></a><span id="l52.146">       this.maxChannels = {};</span>
<a href="#l52.147"></a><span id="l52.147"> </span>
<a href="#l52.148"></a><span id="l52.148">       let pairs = aMessage.isupport.value.split(&quot;,&quot;);</span>
<a href="#l52.149"></a><span id="l52.149">       for (let pair of pairs) {</span>
<a href="#l52.150"></a><span id="l52.150">         let [prefix, num] = pair.split(&quot;:&quot;);</span>
<a href="#l52.151"></a><span id="l52.151">         this.maxChannels[prefix] = num;</span>
<a href="#l52.152"></a><span id="l52.152">       }</span>
<a href="#l52.153"></a><span id="l52.153">       return true;</span>
<a href="#l52.154"></a><span id="l52.154">     },</span>
<a href="#l52.155"></a><span id="l52.155" class="difflineminus">-    &quot;CHANMODES&quot;: aMessage =&gt; false,</span>
<a href="#l52.156"></a><span id="l52.156" class="difflineminus">-    &quot;CHANNELLEN&quot;: function(aMessage) {</span>
<a href="#l52.157"></a><span id="l52.157" class="difflineplus">+    CHANMODES: aMessage =&gt; false,</span>
<a href="#l52.158"></a><span id="l52.158" class="difflineplus">+    CHANNELLEN(aMessage) {</span>
<a href="#l52.159"></a><span id="l52.159">       // CHANNELLEN=&lt;number&gt;</span>
<a href="#l52.160"></a><span id="l52.160">       // Default is from RFC 1493.</span>
<a href="#l52.161"></a><span id="l52.161">       return setSimpleNumber(this, &quot;maxChannelLength&quot;, aMessage, 200);</span>
<a href="#l52.162"></a><span id="l52.162">     },</span>
<a href="#l52.163"></a><span id="l52.163" class="difflineminus">-    &quot;CHANTYPES&quot;: function(aMessage) {</span>
<a href="#l52.164"></a><span id="l52.164" class="difflineplus">+    CHANTYPES(aMessage) {</span>
<a href="#l52.165"></a><span id="l52.165">       // CHANTYPES=[&lt;channel prefix&gt;]*</span>
<a href="#l52.166"></a><span id="l52.166">       let value = aMessage.isupport.useDefault ? &quot;#&amp;&quot; : aMessage.isupport.value;</span>
<a href="#l52.167"></a><span id="l52.167">       this.channelPrefixes = value.split(&quot;&quot;);</span>
<a href="#l52.168"></a><span id="l52.168">       return true;</span>
<a href="#l52.169"></a><span id="l52.169">     },</span>
<a href="#l52.170"></a><span id="l52.170" class="difflineminus">-    &quot;EXCEPTS&quot;: aMessage =&gt; false,</span>
<a href="#l52.171"></a><span id="l52.171" class="difflineminus">-    &quot;IDCHAN&quot;: aMessage =&gt; false,</span>
<a href="#l52.172"></a><span id="l52.172" class="difflineminus">-    &quot;INVEX&quot;: aMessage =&gt; false,</span>
<a href="#l52.173"></a><span id="l52.173" class="difflineminus">-    &quot;KICKLEN&quot;: function(aMessage) {</span>
<a href="#l52.174"></a><span id="l52.174" class="difflineplus">+    EXCEPTS: aMessage =&gt; false,</span>
<a href="#l52.175"></a><span id="l52.175" class="difflineplus">+    IDCHAN: aMessage =&gt; false,</span>
<a href="#l52.176"></a><span id="l52.176" class="difflineplus">+    INVEX: aMessage =&gt; false,</span>
<a href="#l52.177"></a><span id="l52.177" class="difflineplus">+    KICKLEN(aMessage) {</span>
<a href="#l52.178"></a><span id="l52.178">       // KICKLEN=&lt;number&gt;</span>
<a href="#l52.179"></a><span id="l52.179">       // Default value is Infinity.</span>
<a href="#l52.180"></a><span id="l52.180">       return setSimpleNumber(this, &quot;maxKickLength&quot;, aMessage, Infinity);</span>
<a href="#l52.181"></a><span id="l52.181">     },</span>
<a href="#l52.182"></a><span id="l52.182" class="difflineminus">-    &quot;MAXLIST&quot;: aMessage =&gt; false,</span>
<a href="#l52.183"></a><span id="l52.183" class="difflineminus">-    &quot;MODES&quot;: aMessage =&gt; false,</span>
<a href="#l52.184"></a><span id="l52.184" class="difflineminus">-    &quot;NETWORK&quot;: aMessage =&gt; false,</span>
<a href="#l52.185"></a><span id="l52.185" class="difflineminus">-    &quot;NICKLEN&quot;: function(aMessage) {</span>
<a href="#l52.186"></a><span id="l52.186" class="difflineplus">+    MAXLIST: aMessage =&gt; false,</span>
<a href="#l52.187"></a><span id="l52.187" class="difflineplus">+    MODES: aMessage =&gt; false,</span>
<a href="#l52.188"></a><span id="l52.188" class="difflineplus">+    NETWORK: aMessage =&gt; false,</span>
<a href="#l52.189"></a><span id="l52.189" class="difflineplus">+    NICKLEN(aMessage) {</span>
<a href="#l52.190"></a><span id="l52.190">       // NICKLEN=&lt;number&gt;</span>
<a href="#l52.191"></a><span id="l52.191">       // Default value is from RFC 1493.</span>
<a href="#l52.192"></a><span id="l52.192">       return setSimpleNumber(this, &quot;maxNicknameLength&quot;, aMessage, 9);</span>
<a href="#l52.193"></a><span id="l52.193">     },</span>
<a href="#l52.194"></a><span id="l52.194" class="difflineminus">-    &quot;PREFIX&quot;: function(aMessage) {</span>
<a href="#l52.195"></a><span id="l52.195" class="difflineplus">+    PREFIX(aMessage) {</span>
<a href="#l52.196"></a><span id="l52.196">       // PREFIX=[(&lt;mode character&gt;*)&lt;prefix&gt;*]</span>
<a href="#l52.197"></a><span id="l52.197" class="difflineminus">-      let value =</span>
<a href="#l52.198"></a><span id="l52.198" class="difflineminus">-        aMessage.isupport.useDefault ? &quot;(ov)@+&quot; : aMessage.isupport.value;</span>
<a href="#l52.199"></a><span id="l52.199" class="difflineplus">+      let value = aMessage.isupport.useDefault</span>
<a href="#l52.200"></a><span id="l52.200" class="difflineplus">+        ? &quot;(ov)@+&quot;</span>
<a href="#l52.201"></a><span id="l52.201" class="difflineplus">+        : aMessage.isupport.value;</span>
<a href="#l52.202"></a><span id="l52.202"> </span>
<a href="#l52.203"></a><span id="l52.203">       this.userPrefixToModeMap = {};</span>
<a href="#l52.204"></a><span id="l52.204">       // A null value specifier indicates that no prefixes are supported.</span>
<a href="#l52.205"></a><span id="l52.205" class="difflineminus">-      if (!value.length)</span>
<a href="#l52.206"></a><span id="l52.206" class="difflineplus">+      if (!value.length) {</span>
<a href="#l52.207"></a><span id="l52.207">         return true;</span>
<a href="#l52.208"></a><span id="l52.208" class="difflineplus">+      }</span>
<a href="#l52.209"></a><span id="l52.209"> </span>
<a href="#l52.210"></a><span id="l52.210">       let matches = /\(([a-z]*)\)(.*)/i.exec(value);</span>
<a href="#l52.211"></a><span id="l52.211">       if (!matches) {</span>
<a href="#l52.212"></a><span id="l52.212">         // The pattern doesn't match.</span>
<a href="#l52.213"></a><span id="l52.213">         this.WARN(&quot;Invalid PREFIX value: &quot; + value);</span>
<a href="#l52.214"></a><span id="l52.214">         return false;</span>
<a href="#l52.215"></a><span id="l52.215">       }</span>
<a href="#l52.216"></a><span id="l52.216">       if (matches[1].length != matches[2].length) {</span>
<a href="#l52.217"></a><span id="l52.217" class="difflineminus">-        this.WARN(&quot;Invalid PREFIX value, does not provide one-to-one mapping:&quot; +</span>
<a href="#l52.218"></a><span id="l52.218" class="difflineminus">-                  value);</span>
<a href="#l52.219"></a><span id="l52.219" class="difflineplus">+        this.WARN(</span>
<a href="#l52.220"></a><span id="l52.220" class="difflineplus">+          &quot;Invalid PREFIX value, does not provide one-to-one mapping:&quot; + value</span>
<a href="#l52.221"></a><span id="l52.221" class="difflineplus">+        );</span>
<a href="#l52.222"></a><span id="l52.222">         return false;</span>
<a href="#l52.223"></a><span id="l52.223">       }</span>
<a href="#l52.224"></a><span id="l52.224"> </span>
<a href="#l52.225"></a><span id="l52.225" class="difflineminus">-      for (let i = 0; i &lt; matches[2].length; i++)</span>
<a href="#l52.226"></a><span id="l52.226" class="difflineplus">+      for (let i = 0; i &lt; matches[2].length; i++) {</span>
<a href="#l52.227"></a><span id="l52.227">         this.userPrefixToModeMap[matches[2][i]] = matches[1][i];</span>
<a href="#l52.228"></a><span id="l52.228" class="difflineplus">+      }</span>
<a href="#l52.229"></a><span id="l52.229">       return true;</span>
<a href="#l52.230"></a><span id="l52.230">     },</span>
<a href="#l52.231"></a><span id="l52.231">     // SAFELIST allows the client to request the server buffer LIST responses to</span>
<a href="#l52.232"></a><span id="l52.232">     // avoid flooding the client. This is not an issue for us, so just ignore</span>
<a href="#l52.233"></a><span id="l52.233">     // it.</span>
<a href="#l52.234"></a><span id="l52.234" class="difflineminus">-    &quot;SAFELIST&quot;: aMessage =&gt; true,</span>
<a href="#l52.235"></a><span id="l52.235" class="difflineplus">+    SAFELIST: aMessage =&gt; true,</span>
<a href="#l52.236"></a><span id="l52.236">     // SECURELIST tells us that the server won't send LIST data directly after</span>
<a href="#l52.237"></a><span id="l52.237">     // connection. Unfortunately, the exact time the client has to wait is</span>
<a href="#l52.238"></a><span id="l52.238">     // configurable, so we can't do anything with this information.</span>
<a href="#l52.239"></a><span id="l52.239" class="difflineminus">-    &quot;SECURELIST&quot;: aMessage =&gt; true,</span>
<a href="#l52.240"></a><span id="l52.240" class="difflineminus">-    &quot;STATUSMSG&quot;: aMessage =&gt; false,</span>
<a href="#l52.241"></a><span id="l52.241" class="difflineminus">-    &quot;STD&quot;: function(aMessage) {</span>
<a href="#l52.242"></a><span id="l52.242" class="difflineplus">+    SECURELIST: aMessage =&gt; true,</span>
<a href="#l52.243"></a><span id="l52.243" class="difflineplus">+    STATUSMSG: aMessage =&gt; false,</span>
<a href="#l52.244"></a><span id="l52.244" class="difflineplus">+    STD(aMessage) {</span>
<a href="#l52.245"></a><span id="l52.245">       // This was never updated as the RFC was never formalized.</span>
<a href="#l52.246"></a><span id="l52.246" class="difflineminus">-      if (aMessage.isupport.value != &quot;rfcnnnn&quot;)</span>
<a href="#l52.247"></a><span id="l52.247" class="difflineplus">+      if (aMessage.isupport.value != &quot;rfcnnnn&quot;) {</span>
<a href="#l52.248"></a><span id="l52.248">         this.WARN(&quot;Unknown ISUPPORT numeric form: &quot; + aMessage.isupport.value);</span>
<a href="#l52.249"></a><span id="l52.249" class="difflineplus">+      }</span>
<a href="#l52.250"></a><span id="l52.250">       return true;</span>
<a href="#l52.251"></a><span id="l52.251">     },</span>
<a href="#l52.252"></a><span id="l52.252" class="difflineminus">-    &quot;TARGMAX&quot;: function(aMessage) {</span>
<a href="#l52.253"></a><span id="l52.253" class="difflineplus">+    TARGMAX(aMessage) {</span>
<a href="#l52.254"></a><span id="l52.254">       // TARGMAX=&lt;command&gt;:&lt;max targets&gt;[,&lt;command&gt;:&lt;max targets&gt;]*</span>
<a href="#l52.255"></a><span id="l52.255">       if (aMessage.isupport.useDefault) {</span>
<a href="#l52.256"></a><span id="l52.256">         this.maxTargets = 1;</span>
<a href="#l52.257"></a><span id="l52.257">         return true;</span>
<a href="#l52.258"></a><span id="l52.258">       }</span>
<a href="#l52.259"></a><span id="l52.259"> </span>
<a href="#l52.260"></a><span id="l52.260">       this.maxTargets = {};</span>
<a href="#l52.261"></a><span id="l52.261">       let commands = aMessage.isupport.value.split(&quot;,&quot;);</span>
<a href="#l52.262"></a><span id="l52.262" class="difflineat">@@ -213,23 +229,23 @@ var isupportBase = {</span>
<a href="#l52.263"></a><span id="l52.263">         if (isNaN(limit)) {</span>
<a href="#l52.264"></a><span id="l52.264">           this.WARN(&quot;Invalid maximum number of targets: &quot; + limitStr);</span>
<a href="#l52.265"></a><span id="l52.265">           continue;</span>
<a href="#l52.266"></a><span id="l52.266">         }</span>
<a href="#l52.267"></a><span id="l52.267">         this.maxTargets[command] = limit;</span>
<a href="#l52.268"></a><span id="l52.268">       }</span>
<a href="#l52.269"></a><span id="l52.269">       return true;</span>
<a href="#l52.270"></a><span id="l52.270">     },</span>
<a href="#l52.271"></a><span id="l52.271" class="difflineminus">-    &quot;TOPICLEN&quot;: function(aMessage) {</span>
<a href="#l52.272"></a><span id="l52.272" class="difflineplus">+    TOPICLEN(aMessage) {</span>
<a href="#l52.273"></a><span id="l52.273">       // TOPICLEN=&lt;number&gt;</span>
<a href="#l52.274"></a><span id="l52.274">       // Default value is Infinity.</span>
<a href="#l52.275"></a><span id="l52.275">       return setSimpleNumber(this, &quot;maxTopicLength&quot;, aMessage, Infinity);</span>
<a href="#l52.276"></a><span id="l52.276">     },</span>
<a href="#l52.277"></a><span id="l52.277"> </span>
<a href="#l52.278"></a><span id="l52.278">     // The following are considered &quot;obsolete&quot; by the RFC, but are still in use.</span>
<a href="#l52.279"></a><span id="l52.279" class="difflineminus">-    &quot;CHARSET&quot;: aMessage =&gt; false,</span>
<a href="#l52.280"></a><span id="l52.280" class="difflineminus">-    &quot;MAXBANS&quot;: aMessage =&gt; false,</span>
<a href="#l52.281"></a><span id="l52.281" class="difflineminus">-    &quot;MAXCHANNELS&quot;: aMessage =&gt; false,</span>
<a href="#l52.282"></a><span id="l52.282" class="difflineminus">-    &quot;MAXTARGETS&quot;: function(aMessage) {</span>
<a href="#l52.283"></a><span id="l52.283" class="difflineplus">+    CHARSET: aMessage =&gt; false,</span>
<a href="#l52.284"></a><span id="l52.284" class="difflineplus">+    MAXBANS: aMessage =&gt; false,</span>
<a href="#l52.285"></a><span id="l52.285" class="difflineplus">+    MAXCHANNELS: aMessage =&gt; false,</span>
<a href="#l52.286"></a><span id="l52.286" class="difflineplus">+    MAXTARGETS(aMessage) {</span>
<a href="#l52.287"></a><span id="l52.287">       return setSimpleNumber(this, &quot;maxTargets&quot;, aMessage, 1);</span>
<a href="#l52.288"></a><span id="l52.288">     },</span>
<a href="#l52.289"></a><span id="l52.289">   },</span>
<a href="#l52.290"></a><span id="l52.290"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/chat/protocols/irc/ircMultiPrefix.jsm</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/chat/protocols/irc/ircMultiPrefix.jsm</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -12,26 +12,28 @@</span>
<a href="#l53.4"></a><span id="l53.4">  * foo knows that it has mode +h, but bar does not know foo has +h set.</span>
<a href="#l53.5"></a><span id="l53.5">  *</span>
<a href="#l53.6"></a><span id="l53.6">  *   http://wiki.inspircd.org/Modules/2.1/namesx</span>
<a href="#l53.7"></a><span id="l53.7">  *   http://ircv3.atheme.org/extensions/multi-prefix-3.1</span>
<a href="#l53.8"></a><span id="l53.8">  */</span>
<a href="#l53.9"></a><span id="l53.9"> </span>
<a href="#l53.10"></a><span id="l53.10"> this.EXPORTED_SYMBOLS = [&quot;isupportNAMESX&quot;, &quot;capMultiPrefix&quot;];</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+);</span>
<a href="#l53.16"></a><span id="l53.16"> </span>
<a href="#l53.17"></a><span id="l53.17"> var isupportNAMESX = {</span>
<a href="#l53.18"></a><span id="l53.18">   name: &quot;ISUPPORT NAMESX&quot;,</span>
<a href="#l53.19"></a><span id="l53.19">   // Slightly above default ISUPPORT priority.</span>
<a href="#l53.20"></a><span id="l53.20">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l53.21"></a><span id="l53.21">   isEnabled: () =&gt; true,</span>
<a href="#l53.22"></a><span id="l53.22"> </span>
<a href="#l53.23"></a><span id="l53.23">   commands: {</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineminus">-    &quot;NAMESX&quot;: function(aMessage) {</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+    NAMESX(aMessage) {</span>
<a href="#l53.26"></a><span id="l53.26">       this.sendMessage(&quot;PROTOCTL&quot;, &quot;NAMESX&quot;);</span>
<a href="#l53.27"></a><span id="l53.27">       return true;</span>
<a href="#l53.28"></a><span id="l53.28">     },</span>
<a href="#l53.29"></a><span id="l53.29">   },</span>
<a href="#l53.30"></a><span id="l53.30"> };</span>
<a href="#l53.31"></a><span id="l53.31"> </span>
<a href="#l53.32"></a><span id="l53.32"> var capMultiPrefix = {</span>
<a href="#l53.33"></a><span id="l53.33">   name: &quot;CAP multi-prefix&quot;,</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineat">@@ -40,17 +42,17 @@ var capMultiPrefix = {</span>
<a href="#l53.35"></a><span id="l53.35">   isEnabled: () =&gt; true,</span>
<a href="#l53.36"></a><span id="l53.36"> </span>
<a href="#l53.37"></a><span id="l53.37">   commands: {</span>
<a href="#l53.38"></a><span id="l53.38">     &quot;multi-prefix&quot;: function(aMessage) {</span>
<a href="#l53.39"></a><span id="l53.39">       // Request to use multi-prefix if it is supported.</span>
<a href="#l53.40"></a><span id="l53.40">       if (aMessage.cap.subcommand == &quot;LS&quot;) {</span>
<a href="#l53.41"></a><span id="l53.41">         this.addCAP(&quot;multi-prefix&quot;);</span>
<a href="#l53.42"></a><span id="l53.42">         this.sendMessage(&quot;CAP&quot;, [&quot;REQ&quot;, &quot;multi-prefix&quot;]);</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineminus">-      }</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineminus">-      else if (aMessage.cap.subcommand == &quot;ACK&quot;)</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+      } else if (aMessage.cap.subcommand == &quot;ACK&quot;) {</span>
<a href="#l53.46"></a><span id="l53.46">         this.removeCAP(&quot;multi-prefix&quot;);</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-      else</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+      } else {</span>
<a href="#l53.49"></a><span id="l53.49">         return false;</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineplus">+      }</span>
<a href="#l53.51"></a><span id="l53.51">       return true;</span>
<a href="#l53.52"></a><span id="l53.52">     },</span>
<a href="#l53.53"></a><span id="l53.53">   },</span>
<a href="#l53.54"></a><span id="l53.54"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/chat/protocols/irc/ircNonStandard.jsm</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/chat/protocols/irc/ircNonStandard.jsm</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -9,163 +9,184 @@</span>
<a href="#l54.4"></a><span id="l54.4">  * listing the known servers that support this extension.</span>
<a href="#l54.5"></a><span id="l54.5">  *</span>
<a href="#l54.6"></a><span id="l54.6">  * Resources for these commands include:</span>
<a href="#l54.7"></a><span id="l54.7">  *  https://github.com/atheme/charybdis/blob/master/include/numeric.h</span>
<a href="#l54.8"></a><span id="l54.8">  *  http://hg.unrealircd.com/hg/unreal/raw-file/tip/include/numeric.h</span>
<a href="#l54.9"></a><span id="l54.9">  */</span>
<a href="#l54.10"></a><span id="l54.10"> this.EXPORTED_SYMBOLS = [&quot;ircNonStandard&quot;];</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-var {</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-  _,</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-  conversationErrorMessage,</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-  kListRefreshInterval,</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineplus">+);</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineplus">+var { _, conversationErrorMessage, kListRefreshInterval } = ChromeUtils.import(</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+  &quot;resource:///modules/ircUtils.jsm&quot;</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+);</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25"> var ircNonStandard = {</span>
<a href="#l54.26"></a><span id="l54.26">   name: &quot;Non-Standard IRC Extensions&quot;,</span>
<a href="#l54.27"></a><span id="l54.27">   priority: ircHandlers.DEFAULT_PRIORITY + 1,</span>
<a href="#l54.28"></a><span id="l54.28">   isEnabled: () =&gt; true,</span>
<a href="#l54.29"></a><span id="l54.29"> </span>
<a href="#l54.30"></a><span id="l54.30">   commands: {</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-    &quot;NOTICE&quot;: function(aMessage) {</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineplus">+    NOTICE(aMessage) {</span>
<a href="#l54.33"></a><span id="l54.33">       // NOTICE &lt;msgtarget&gt; &lt;text&gt;</span>
<a href="#l54.34"></a><span id="l54.34"> </span>
<a href="#l54.35"></a><span id="l54.35" class="difflineminus">-      if (aMessage.params[1].startsWith(&quot;*** You cannot list within the first&quot;)) {</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+      if (</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineplus">+        aMessage.params[1].startsWith(&quot;*** You cannot list within the first&quot;)</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+      ) {</span>
<a href="#l54.39"></a><span id="l54.39">         // SECURELIST: &quot;You cannot list within the first N seconds of connecting.</span>
<a href="#l54.40"></a><span id="l54.40">         // Please try again later.&quot; This NOTICE will be followed by a 321/323</span>
<a href="#l54.41"></a><span id="l54.41">         // pair, but no list data.</span>
<a href="#l54.42"></a><span id="l54.42">         // We fake the last LIST time so that we will retry LIST the next time</span>
<a href="#l54.43"></a><span id="l54.43">         // the user requires it after the interval specified.</span>
<a href="#l54.44"></a><span id="l54.44">         const kMinute = 60000;</span>
<a href="#l54.45"></a><span id="l54.45" class="difflineminus">-        let waitTime = (aMessage.params[1].split(&quot; &quot;)[7] * 1000) || kMinute;</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineplus">+        let waitTime = aMessage.params[1].split(&quot; &quot;)[7] * 1000 || kMinute;</span>
<a href="#l54.47"></a><span id="l54.47">         this._lastListTime = Date.now() + waitTime - kListRefreshInterval;</span>
<a href="#l54.48"></a><span id="l54.48">         return true;</span>
<a href="#l54.49"></a><span id="l54.49">       }</span>
<a href="#l54.50"></a><span id="l54.50"> </span>
<a href="#l54.51"></a><span id="l54.51">       // If the user is connected, fallback to normal processing, everything</span>
<a href="#l54.52"></a><span id="l54.52">       // past this points deals with NOTICE messages that occur before 001 is</span>
<a href="#l54.53"></a><span id="l54.53">       // received.</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineminus">-      if (this.connected)</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineplus">+      if (this.connected) {</span>
<a href="#l54.56"></a><span id="l54.56">         return false;</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineplus">+      }</span>
<a href="#l54.58"></a><span id="l54.58"> </span>
<a href="#l54.59"></a><span id="l54.59">       let target = aMessage.params[0].toLowerCase();</span>
<a href="#l54.60"></a><span id="l54.60"> </span>
<a href="#l54.61"></a><span id="l54.61">       // If we receive a ZNC error message requesting a password, the</span>
<a href="#l54.62"></a><span id="l54.62">       // serverPassword preference was not set by the user. Attempt to log into</span>
<a href="#l54.63"></a><span id="l54.63">       // ZNC using the account password.</span>
<a href="#l54.64"></a><span id="l54.64" class="difflineminus">-      if (target == &quot;auth&quot; &amp;&amp;</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineminus">-          aMessage.params[1].startsWith(&quot;*** You need to send your password.&quot;)) {</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineplus">+      if (</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineplus">+        target == &quot;auth&quot; &amp;&amp;</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineplus">+        aMessage.params[1].startsWith(&quot;*** You need to send your password.&quot;)</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineplus">+      ) {</span>
<a href="#l54.70"></a><span id="l54.70">         if (this.imAccount.password) {</span>
<a href="#l54.71"></a><span id="l54.71">           // Send the password now, if it is available.</span>
<a href="#l54.72"></a><span id="l54.72">           this.shouldAuthenticate = false;</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineminus">-          this.sendMessage(&quot;PASS&quot;, this.imAccount.password,</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineminus">-                           &quot;PASS &lt;password not logged&gt;&quot;);</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineminus">-        }</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineminus">-        else {</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineplus">+          this.sendMessage(</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+            &quot;PASS&quot;,</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineplus">+            this.imAccount.password,</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineplus">+            &quot;PASS &lt;password not logged&gt;&quot;</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineplus">+          );</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineplus">+        } else {</span>
<a href="#l54.83"></a><span id="l54.83">           // Otherwise, put the account in an error state.</span>
<a href="#l54.84"></a><span id="l54.84" class="difflineminus">-          this.gotDisconnected(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineminus">-                               _(&quot;connection.error.passwordRequired&quot;));</span>
<a href="#l54.86"></a><span id="l54.86" class="difflineplus">+          this.gotDisconnected(</span>
<a href="#l54.87"></a><span id="l54.87" class="difflineplus">+            Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineplus">+            _(&quot;connection.error.passwordRequired&quot;)</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineplus">+          );</span>
<a href="#l54.90"></a><span id="l54.90">         }</span>
<a href="#l54.91"></a><span id="l54.91"> </span>
<a href="#l54.92"></a><span id="l54.92">         // All done for ZNC.</span>
<a href="#l54.93"></a><span id="l54.93">         return true;</span>
<a href="#l54.94"></a><span id="l54.94">       }</span>
<a href="#l54.95"></a><span id="l54.95"> </span>
<a href="#l54.96"></a><span id="l54.96">       // Some servers, e.g. irc.umich.edu, use NOTICE during connection</span>
<a href="#l54.97"></a><span id="l54.97">       // negotiation to give directions to users, these MUST be shown to the</span>
<a href="#l54.98"></a><span id="l54.98">       // user. If the message starts with ***, we assume it is probably an AUTH</span>
<a href="#l54.99"></a><span id="l54.99">       // message, which falls through to normal NOTICE processing.</span>
<a href="#l54.100"></a><span id="l54.100">       // Note that if the user's nick is auth this COULD be a notice directed at</span>
<a href="#l54.101"></a><span id="l54.101">       // them. For reference: moznet sends Auth (previously sent AUTH), freenode</span>
<a href="#l54.102"></a><span id="l54.102">       // sends *.</span>
<a href="#l54.103"></a><span id="l54.103">       let isAuth = target == &quot;auth&quot; &amp;&amp; this._nickname.toLowerCase() != &quot;auth&quot;;</span>
<a href="#l54.104"></a><span id="l54.104">       if (!aMessage.params[1].startsWith(&quot;***&quot;) &amp;&amp; !isAuth) {</span>
<a href="#l54.105"></a><span id="l54.105" class="difflineminus">-        this.getConversation(aMessage.origin)</span>
<a href="#l54.106"></a><span id="l54.106" class="difflineminus">-            .writeMessage(aMessage.origin, aMessage.params[1],</span>
<a href="#l54.107"></a><span id="l54.107" class="difflineminus">-                          {incoming: true, tags: aMessage.tags});</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineplus">+        this.getConversation(aMessage.origin).writeMessage(</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineplus">+          aMessage.origin,</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineplus">+          aMessage.params[1],</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineplus">+          { incoming: true, tags: aMessage.tags }</span>
<a href="#l54.112"></a><span id="l54.112" class="difflineplus">+        );</span>
<a href="#l54.113"></a><span id="l54.113">         return true;</span>
<a href="#l54.114"></a><span id="l54.114">       }</span>
<a href="#l54.115"></a><span id="l54.115"> </span>
<a href="#l54.116"></a><span id="l54.116">       return false;</span>
<a href="#l54.117"></a><span id="l54.117">     },</span>
<a href="#l54.118"></a><span id="l54.118"> </span>
<a href="#l54.119"></a><span id="l54.119" class="difflineminus">-    &quot;042&quot;: function(aMessage) { // RPL_YOURID (IRCnet)</span>
<a href="#l54.120"></a><span id="l54.120" class="difflineplus">+    &quot;042&quot;: function(aMessage) {</span>
<a href="#l54.121"></a><span id="l54.121" class="difflineplus">+      // RPL_YOURID (IRCnet)</span>
<a href="#l54.122"></a><span id="l54.122">       // &lt;nick&gt; &lt;id&gt; :your unique ID</span>
<a href="#l54.123"></a><span id="l54.123">       return true;</span>
<a href="#l54.124"></a><span id="l54.124">     },</span>
<a href="#l54.125"></a><span id="l54.125"> </span>
<a href="#l54.126"></a><span id="l54.126">     &quot;307&quot;: function(aMessage) {</span>
<a href="#l54.127"></a><span id="l54.127">       // TODO RPL_SUSERHOST (AustHex)</span>
<a href="#l54.128"></a><span id="l54.128">       // TODO RPL_USERIP (Undernet)</span>
<a href="#l54.129"></a><span id="l54.129">       // &lt;user ips&gt;</span>
<a href="#l54.130"></a><span id="l54.130"> </span>
<a href="#l54.131"></a><span id="l54.131">       // RPL_WHOISREGNICK (Unreal &amp; Bahamut)</span>
<a href="#l54.132"></a><span id="l54.132">       // &lt;nick&gt; :is a registered nick</span>
<a href="#l54.133"></a><span id="l54.133" class="difflineminus">-      if (aMessage.params.length == 3)</span>
<a href="#l54.134"></a><span id="l54.134" class="difflineminus">-        return this.setWhois(aMessage.params[1], {registered: true});</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineplus">+      if (aMessage.params.length == 3) {</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineplus">+        return this.setWhois(aMessage.params[1], { registered: true });</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineplus">+      }</span>
<a href="#l54.138"></a><span id="l54.138"> </span>
<a href="#l54.139"></a><span id="l54.139">       return false;</span>
<a href="#l54.140"></a><span id="l54.140">     },</span>
<a href="#l54.141"></a><span id="l54.141"> </span>
<a href="#l54.142"></a><span id="l54.142" class="difflineminus">-    &quot;317&quot;: function(aMessage) { // RPL_WHOISIDLE (Unreal &amp; Charybdis)</span>
<a href="#l54.143"></a><span id="l54.143" class="difflineplus">+    &quot;317&quot;: function(aMessage) {</span>
<a href="#l54.144"></a><span id="l54.144" class="difflineplus">+      // RPL_WHOISIDLE (Unreal &amp; Charybdis)</span>
<a href="#l54.145"></a><span id="l54.145">       // &lt;nick&gt; &lt;integer&gt; &lt;integer&gt; :seconds idle, signon time</span>
<a href="#l54.146"></a><span id="l54.146">       // This is a non-standard extension to RPL_WHOISIDLE which includes the</span>
<a href="#l54.147"></a><span id="l54.147">       // sign-on time.</span>
<a href="#l54.148"></a><span id="l54.148" class="difflineminus">-      if (aMessage.params.length == 5)</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineminus">-        this.setWhois(aMessage.params[1], {signonTime: aMessage.params[3]});</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineplus">+      if (aMessage.params.length == 5) {</span>
<a href="#l54.151"></a><span id="l54.151" class="difflineplus">+        this.setWhois(aMessage.params[1], { signonTime: aMessage.params[3] });</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineplus">+      }</span>
<a href="#l54.153"></a><span id="l54.153"> </span>
<a href="#l54.154"></a><span id="l54.154">       return false;</span>
<a href="#l54.155"></a><span id="l54.155">     },</span>
<a href="#l54.156"></a><span id="l54.156"> </span>
<a href="#l54.157"></a><span id="l54.157" class="difflineminus">-    &quot;328&quot;: function(aMessage) { // RPL_CHANNEL_URL (Bahamut &amp; Austhex)</span>
<a href="#l54.158"></a><span id="l54.158" class="difflineplus">+    &quot;328&quot;: function(aMessage) {</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineplus">+      // RPL_CHANNEL_URL (Bahamut &amp; Austhex)</span>
<a href="#l54.160"></a><span id="l54.160">       // &lt;channel&gt; :&lt;URL&gt;</span>
<a href="#l54.161"></a><span id="l54.161">       return true;</span>
<a href="#l54.162"></a><span id="l54.162">     },</span>
<a href="#l54.163"></a><span id="l54.163"> </span>
<a href="#l54.164"></a><span id="l54.164" class="difflineminus">-    &quot;329&quot;: function(aMessage) { // RPL_CREATIONTIME (Bahamut &amp; Unreal)</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineplus">+    &quot;329&quot;: function(aMessage) {</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineplus">+      // RPL_CREATIONTIME (Bahamut &amp; Unreal)</span>
<a href="#l54.167"></a><span id="l54.167">       // &lt;channel&gt; &lt;creation time&gt;</span>
<a href="#l54.168"></a><span id="l54.168">       return true;</span>
<a href="#l54.169"></a><span id="l54.169">     },</span>
<a href="#l54.170"></a><span id="l54.170"> </span>
<a href="#l54.171"></a><span id="l54.171">     &quot;330&quot;: function(aMessage) {</span>
<a href="#l54.172"></a><span id="l54.172">       // TODO RPL_WHOWAS_TIME</span>
<a href="#l54.173"></a><span id="l54.173"> </span>
<a href="#l54.174"></a><span id="l54.174">       // RPL_WHOISACCOUNT (Charybdis, ircu &amp; Quakenet)</span>
<a href="#l54.175"></a><span id="l54.175">       // &lt;nick&gt; &lt;authname&gt; :is logged in as</span>
<a href="#l54.176"></a><span id="l54.176">       if (aMessage.params.length == 4) {</span>
<a href="#l54.177"></a><span id="l54.177">         let [, nick, authname] = aMessage.params;</span>
<a href="#l54.178"></a><span id="l54.178">         // If the authname differs from the nickname, add it to the WHOIS</span>
<a href="#l54.179"></a><span id="l54.179">         // information; otherwise, ignore it.</span>
<a href="#l54.180"></a><span id="l54.180" class="difflineminus">-        if (this.normalize(nick) != this.normalize(authname))</span>
<a href="#l54.181"></a><span id="l54.181" class="difflineminus">-          this.setWhois(nick, {registeredAs: authname});</span>
<a href="#l54.182"></a><span id="l54.182" class="difflineplus">+        if (this.normalize(nick) != this.normalize(authname)) {</span>
<a href="#l54.183"></a><span id="l54.183" class="difflineplus">+          this.setWhois(nick, { registeredAs: authname });</span>
<a href="#l54.184"></a><span id="l54.184" class="difflineplus">+        }</span>
<a href="#l54.185"></a><span id="l54.185">       }</span>
<a href="#l54.186"></a><span id="l54.186">       return true;</span>
<a href="#l54.187"></a><span id="l54.187">     },</span>
<a href="#l54.188"></a><span id="l54.188"> </span>
<a href="#l54.189"></a><span id="l54.189" class="difflineminus">-    &quot;335&quot;: function(aMessage) { // RPL_WHOISBOT (Unreal)</span>
<a href="#l54.190"></a><span id="l54.190" class="difflineplus">+    &quot;335&quot;: function(aMessage) {</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineplus">+      // RPL_WHOISBOT (Unreal)</span>
<a href="#l54.192"></a><span id="l54.192">       // &lt;nick&gt; :is a \002Bot\002 on &lt;network&gt;</span>
<a href="#l54.193"></a><span id="l54.193" class="difflineminus">-      return this.setWhois(aMessage.params[1], {bot: true});</span>
<a href="#l54.194"></a><span id="l54.194" class="difflineplus">+      return this.setWhois(aMessage.params[1], { bot: true });</span>
<a href="#l54.195"></a><span id="l54.195">     },</span>
<a href="#l54.196"></a><span id="l54.196"> </span>
<a href="#l54.197"></a><span id="l54.197">     &quot;338&quot;: function(aMessage) {</span>
<a href="#l54.198"></a><span id="l54.198">       // RPL_CHANPASSOK</span>
<a href="#l54.199"></a><span id="l54.199">       // RPL_WHOISACTUALLY (ircu, Bahamut, Charybdis)</span>
<a href="#l54.200"></a><span id="l54.200">       // &lt;nick&gt; &lt;user&gt; &lt;ip&gt; :actually using host</span>
<a href="#l54.201"></a><span id="l54.201">       return true;</span>
<a href="#l54.202"></a><span id="l54.202">     },</span>
<a href="#l54.203"></a><span id="l54.203"> </span>
<a href="#l54.204"></a><span id="l54.204" class="difflineminus">-    &quot;378&quot;: function(aMessage) { // RPL_WHOISHOST (Unreal &amp; Charybdis)</span>
<a href="#l54.205"></a><span id="l54.205" class="difflineplus">+    &quot;378&quot;: function(aMessage) {</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineplus">+      // RPL_WHOISHOST (Unreal &amp; Charybdis)</span>
<a href="#l54.207"></a><span id="l54.207">       // &lt;nick&gt; :is connecting from &lt;host&gt; &lt;ip&gt;</span>
<a href="#l54.208"></a><span id="l54.208">       let [host, ip] = aMessage.params[2].split(&quot; &quot;).slice(-2);</span>
<a href="#l54.209"></a><span id="l54.209" class="difflineminus">-      return this.setWhois(aMessage.params[1], {host, ip});</span>
<a href="#l54.210"></a><span id="l54.210" class="difflineplus">+      return this.setWhois(aMessage.params[1], { host, ip });</span>
<a href="#l54.211"></a><span id="l54.211">     },</span>
<a href="#l54.212"></a><span id="l54.212"> </span>
<a href="#l54.213"></a><span id="l54.213" class="difflineminus">-    &quot;379&quot;: function(aMessage) { // RPL_WHOISMODES (Unreal, Inspircd)</span>
<a href="#l54.214"></a><span id="l54.214" class="difflineplus">+    &quot;379&quot;: function(aMessage) {</span>
<a href="#l54.215"></a><span id="l54.215" class="difflineplus">+      // RPL_WHOISMODES (Unreal, Inspircd)</span>
<a href="#l54.216"></a><span id="l54.216">       // &lt;nick&gt; :is using modes &lt;modes&gt;</span>
<a href="#l54.217"></a><span id="l54.217">       // Sent in response to a WHOIS on the user.</span>
<a href="#l54.218"></a><span id="l54.218">       return true;</span>
<a href="#l54.219"></a><span id="l54.219">     },</span>
<a href="#l54.220"></a><span id="l54.220"> </span>
<a href="#l54.221"></a><span id="l54.221">     &quot;396&quot;: function(aMessage) {</span>
<a href="#l54.222"></a><span id="l54.222">       // RPL_HOSTHIDDEN (Charybdis, Hybrid, ircu, etc.)</span>
<a href="#l54.223"></a><span id="l54.223">       // RPL_VISIBLEHOST (Plexus)</span>
<a href="#l54.224"></a><span id="l54.224" class="difflineat">@@ -178,42 +199,54 @@ var ircNonStandard = {</span>
<a href="#l54.225"></a><span id="l54.225">     },</span>
<a href="#l54.226"></a><span id="l54.226"> </span>
<a href="#l54.227"></a><span id="l54.227">     &quot;464&quot;: function(aMessage) {</span>
<a href="#l54.228"></a><span id="l54.228">       // :Password required</span>
<a href="#l54.229"></a><span id="l54.229">       // If we receive a ZNC error message requesting a password, eat it since</span>
<a href="#l54.230"></a><span id="l54.230">       // a NOTICE AUTH will follow causing us to send the password. This numeric</span>
<a href="#l54.231"></a><span id="l54.231">       // is, unfortunately, also sent if you give a wrong password. The</span>
<a href="#l54.232"></a><span id="l54.232">       // parameter in that case is &quot;Invalid Password&quot;.</span>
<a href="#l54.233"></a><span id="l54.233" class="difflineminus">-      return aMessage.origin == &quot;irc.znc.in&quot; &amp;&amp;</span>
<a href="#l54.234"></a><span id="l54.234" class="difflineminus">-             aMessage.params[1] == &quot;Password required&quot;;</span>
<a href="#l54.235"></a><span id="l54.235" class="difflineplus">+      return (</span>
<a href="#l54.236"></a><span id="l54.236" class="difflineplus">+        aMessage.origin == &quot;irc.znc.in&quot; &amp;&amp;</span>
<a href="#l54.237"></a><span id="l54.237" class="difflineplus">+        aMessage.params[1] == &quot;Password required&quot;</span>
<a href="#l54.238"></a><span id="l54.238" class="difflineplus">+      );</span>
<a href="#l54.239"></a><span id="l54.239">     },</span>
<a href="#l54.240"></a><span id="l54.240"> </span>
<a href="#l54.241"></a><span id="l54.241" class="difflineminus">-    &quot;470&quot;: function(aMessage) { // Channel forward (Unreal, inspircd)</span>
<a href="#l54.242"></a><span id="l54.242" class="difflineplus">+    &quot;470&quot;: function(aMessage) {</span>
<a href="#l54.243"></a><span id="l54.243" class="difflineplus">+      // Channel forward (Unreal, inspircd)</span>
<a href="#l54.244"></a><span id="l54.244">       // &lt;requested channel&gt; &lt;redirect channel&gt;: You may not join this channel,</span>
<a href="#l54.245"></a><span id="l54.245">       // so you are automatically being transferred to the redirect channel.</span>
<a href="#l54.246"></a><span id="l54.246">       // Join redirect channel so when the automatic join happens, we are</span>
<a href="#l54.247"></a><span id="l54.247">       // not surprised.</span>
<a href="#l54.248"></a><span id="l54.248">       this.joinChat(this.getChatRoomDefaultFieldValues(aMessage.params[2]));</span>
<a href="#l54.249"></a><span id="l54.249">       // Mark requested channel as left and add a system message.</span>
<a href="#l54.250"></a><span id="l54.250" class="difflineminus">-      return conversationErrorMessage(this, aMessage, &quot;error.channelForward&quot;,</span>
<a href="#l54.251"></a><span id="l54.251" class="difflineminus">-        true, false);</span>
<a href="#l54.252"></a><span id="l54.252" class="difflineplus">+      return conversationErrorMessage(</span>
<a href="#l54.253"></a><span id="l54.253" class="difflineplus">+        this,</span>
<a href="#l54.254"></a><span id="l54.254" class="difflineplus">+        aMessage,</span>
<a href="#l54.255"></a><span id="l54.255" class="difflineplus">+        &quot;error.channelForward&quot;,</span>
<a href="#l54.256"></a><span id="l54.256" class="difflineplus">+        true,</span>
<a href="#l54.257"></a><span id="l54.257" class="difflineplus">+        false</span>
<a href="#l54.258"></a><span id="l54.258" class="difflineplus">+      );</span>
<a href="#l54.259"></a><span id="l54.259">     },</span>
<a href="#l54.260"></a><span id="l54.260"> </span>
<a href="#l54.261"></a><span id="l54.261" class="difflineminus">-    &quot;499&quot;: function(aMessage) { // ERR_CHANOWNPRIVNEEDED (Unreal)</span>
<a href="#l54.262"></a><span id="l54.262" class="difflineplus">+    &quot;499&quot;: function(aMessage) {</span>
<a href="#l54.263"></a><span id="l54.263" class="difflineplus">+      // ERR_CHANOWNPRIVNEEDED (Unreal)</span>
<a href="#l54.264"></a><span id="l54.264">       // &lt;channel&gt; :You're not the channel owner (status +q is needed)</span>
<a href="#l54.265"></a><span id="l54.265">       return conversationErrorMessage(this, aMessage, &quot;error.notChannelOwner&quot;);</span>
<a href="#l54.266"></a><span id="l54.266">     },</span>
<a href="#l54.267"></a><span id="l54.267"> </span>
<a href="#l54.268"></a><span id="l54.268" class="difflineminus">-    &quot;671&quot;: function(aMessage) { // RPL_WHOISSECURE (Unreal &amp; Charybdis)</span>
<a href="#l54.269"></a><span id="l54.269" class="difflineplus">+    &quot;671&quot;: function(aMessage) {</span>
<a href="#l54.270"></a><span id="l54.270" class="difflineplus">+      // RPL_WHOISSECURE (Unreal &amp; Charybdis)</span>
<a href="#l54.271"></a><span id="l54.271">       // &lt;nick&gt; :is using a Secure connection</span>
<a href="#l54.272"></a><span id="l54.272" class="difflineminus">-      return this.setWhois(aMessage.params[1], {secure: true});</span>
<a href="#l54.273"></a><span id="l54.273" class="difflineplus">+      return this.setWhois(aMessage.params[1], { secure: true });</span>
<a href="#l54.274"></a><span id="l54.274">     },</span>
<a href="#l54.275"></a><span id="l54.275"> </span>
<a href="#l54.276"></a><span id="l54.276">     &quot;998&quot;: function(aMessage) {</span>
<a href="#l54.277"></a><span id="l54.277">       // irc.umich.edu shows an ASCII captcha that must be typed in by the user.</span>
<a href="#l54.278"></a><span id="l54.278" class="difflineminus">-      this.getConversation(aMessage.origin)</span>
<a href="#l54.279"></a><span id="l54.279" class="difflineminus">-          .writeMessage(aMessage.origin, aMessage.params[1],</span>
<a href="#l54.280"></a><span id="l54.280" class="difflineminus">-                        {incoming: true, noFormat: true});</span>
<a href="#l54.281"></a><span id="l54.281" class="difflineplus">+      this.getConversation(aMessage.origin).writeMessage(</span>
<a href="#l54.282"></a><span id="l54.282" class="difflineplus">+        aMessage.origin,</span>
<a href="#l54.283"></a><span id="l54.283" class="difflineplus">+        aMessage.params[1],</span>
<a href="#l54.284"></a><span id="l54.284" class="difflineplus">+        { incoming: true, noFormat: true }</span>
<a href="#l54.285"></a><span id="l54.285" class="difflineplus">+      );</span>
<a href="#l54.286"></a><span id="l54.286">       return true;</span>
<a href="#l54.287"></a><span id="l54.287">     },</span>
<a href="#l54.288"></a><span id="l54.288">   },</span>
<a href="#l54.289"></a><span id="l54.289"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/chat/protocols/irc/ircSASL.jsm</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/chat/protocols/irc/ircSASL.jsm</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -5,41 +5,52 @@</span>
<a href="#l55.4"></a><span id="l55.4"> /*</span>
<a href="#l55.5"></a><span id="l55.5">  * This implements SASL for IRC.</span>
<a href="#l55.6"></a><span id="l55.6">  *   https://raw.github.com/atheme/atheme/master/doc/SASL</span>
<a href="#l55.7"></a><span id="l55.7">  *   https://github.com/ircv3/ircv3-specifications/blob/master/extensions/sasl-3.1</span>
<a href="#l55.8"></a><span id="l55.8">  */</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10"> this.EXPORTED_SYMBOLS = [&quot;ircSASL&quot;, &quot;capSASL&quot;];</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+);</span>
<a href="#l55.16"></a><span id="l55.16"> </span>
<a href="#l55.17"></a><span id="l55.17"> var ircSASL = {</span>
<a href="#l55.18"></a><span id="l55.18">   name: &quot;SASL AUTHENTICATE&quot;,</span>
<a href="#l55.19"></a><span id="l55.19">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l55.20"></a><span id="l55.20">   isEnabled: () =&gt; true,</span>
<a href="#l55.21"></a><span id="l55.21"> </span>
<a href="#l55.22"></a><span id="l55.22">   commands: {</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-    &quot;AUTHENTICATE&quot;: function(aMessage) {</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineplus">+    AUTHENTICATE(aMessage) {</span>
<a href="#l55.25"></a><span id="l55.25">       // Expect an empty response, if something different is received abort.</span>
<a href="#l55.26"></a><span id="l55.26">       if (aMessage.params[0] != &quot;+&quot;) {</span>
<a href="#l55.27"></a><span id="l55.27">         this.sendMessage(&quot;AUTHENTICATE&quot;, &quot;*&quot;);</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineminus">-        this.WARN(&quot;Aborting SASL authentication, unexpected message &quot; +</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineminus">-                  &quot;received:\n&quot; + aMessage.rawMessage);</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineplus">+        this.WARN(</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineplus">+          &quot;Aborting SASL authentication, unexpected message &quot; +</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+            &quot;received:\n&quot; +</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineplus">+            aMessage.rawMessage</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineplus">+        );</span>
<a href="#l55.35"></a><span id="l55.35">         return true;</span>
<a href="#l55.36"></a><span id="l55.36">       }</span>
<a href="#l55.37"></a><span id="l55.37"> </span>
<a href="#l55.38"></a><span id="l55.38">       // An authentication identity, authorization identity and password are</span>
<a href="#l55.39"></a><span id="l55.39">       // used, separated by null.</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineminus">-      let data = [this._requestedNickname, this._requestedNickname,</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineminus">-                  this.imAccount.password].join(&quot;\0&quot;);</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+      let data = [</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineplus">+        this._requestedNickname,</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineplus">+        this._requestedNickname,</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+        this.imAccount.password,</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+      ].join(&quot;\0&quot;);</span>
<a href="#l55.47"></a><span id="l55.47">       // btoa for Unicode, see https://developer.mozilla.org/en-US/docs/DOM/window.btoa</span>
<a href="#l55.48"></a><span id="l55.48">       let base64Data = btoa(unescape(encodeURIComponent(data)));</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineminus">-      this.sendMessage(&quot;AUTHENTICATE&quot;, base64Data,</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineminus">-                       &quot;AUTHENTICATE &lt;base64 encoded nick, user and password not logged&gt;&quot;);</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+      this.sendMessage(</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineplus">+        &quot;AUTHENTICATE&quot;,</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+        base64Data,</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineplus">+        &quot;AUTHENTICATE &lt;base64 encoded nick, user and password not logged&gt;&quot;</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+      );</span>
<a href="#l55.56"></a><span id="l55.56">       return true;</span>
<a href="#l55.57"></a><span id="l55.57">     },</span>
<a href="#l55.58"></a><span id="l55.58"> </span>
<a href="#l55.59"></a><span id="l55.59">     &quot;900&quot;: function(aMessage) {</span>
<a href="#l55.60"></a><span id="l55.60">       // RPL_LOGGEDIN</span>
<a href="#l55.61"></a><span id="l55.61">       // &lt;nick&gt;!&lt;ident&gt;@&lt;host&gt; &lt;account&gt; :You are now logged in as &lt;user&gt;</span>
<a href="#l55.62"></a><span id="l55.62">       // Now logged in (&quot;whether by SASL or otherwise&quot;).</span>
<a href="#l55.63"></a><span id="l55.63">       this.isAuthenticated = true;</span>
<a href="#l55.64"></a><span id="l55.64" class="difflineat">@@ -52,30 +63,33 @@ var ircSASL = {</span>
<a href="#l55.65"></a><span id="l55.65">       this.isAuthenticated = false;</span>
<a href="#l55.66"></a><span id="l55.66">       return true;</span>
<a href="#l55.67"></a><span id="l55.67">     },</span>
<a href="#l55.68"></a><span id="l55.68"> </span>
<a href="#l55.69"></a><span id="l55.69">     &quot;902&quot;: function(aMessage) {</span>
<a href="#l55.70"></a><span id="l55.70">       // ERR_NICKLOCKED</span>
<a href="#l55.71"></a><span id="l55.71">       // Authentication failed because the account is currently locked out,</span>
<a href="#l55.72"></a><span id="l55.72">       // held, or otherwise administratively made unavailable.</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineminus">-      this.WARN(&quot;You must use a nick assigned to you. SASL authentication failed.&quot;);</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineplus">+      this.WARN(</span>
<a href="#l55.75"></a><span id="l55.75" class="difflineplus">+        &quot;You must use a nick assigned to you. SASL authentication failed.&quot;</span>
<a href="#l55.76"></a><span id="l55.76" class="difflineplus">+      );</span>
<a href="#l55.77"></a><span id="l55.77">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l55.78"></a><span id="l55.78">       return true;</span>
<a href="#l55.79"></a><span id="l55.79">     },</span>
<a href="#l55.80"></a><span id="l55.80"> </span>
<a href="#l55.81"></a><span id="l55.81">     &quot;903&quot;: function(aMessage) {</span>
<a href="#l55.82"></a><span id="l55.82">       // RPL_SASLSUCCESS</span>
<a href="#l55.83"></a><span id="l55.83">       // Authentication was successful.</span>
<a href="#l55.84"></a><span id="l55.84">       this.isAuthenticated = true;</span>
<a href="#l55.85"></a><span id="l55.85">       this.LOG(&quot;SASL authentication successful.&quot;);</span>
<a href="#l55.86"></a><span id="l55.86">       // We may receive this again while already connected if the user manually</span>
<a href="#l55.87"></a><span id="l55.87">       // identifies with Nickserv.</span>
<a href="#l55.88"></a><span id="l55.88" class="difflineminus">-      if (!this.connected)</span>
<a href="#l55.89"></a><span id="l55.89" class="difflineplus">+      if (!this.connected) {</span>
<a href="#l55.90"></a><span id="l55.90">         this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l55.91"></a><span id="l55.91" class="difflineplus">+      }</span>
<a href="#l55.92"></a><span id="l55.92">       return true;</span>
<a href="#l55.93"></a><span id="l55.93">     },</span>
<a href="#l55.94"></a><span id="l55.94"> </span>
<a href="#l55.95"></a><span id="l55.95">     &quot;904&quot;: function(aMessage) {</span>
<a href="#l55.96"></a><span id="l55.96">       // ERR_SASLFAIL</span>
<a href="#l55.97"></a><span id="l55.97">       // Sent when the SASL authentication fails because of invalid credentials</span>
<a href="#l55.98"></a><span id="l55.98">       // or other errors not explicitly mentioned by other numerics.</span>
<a href="#l55.99"></a><span id="l55.99">       this.WARN(&quot;Authentication with SASL failed.&quot;);</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineat">@@ -91,17 +105,19 @@ var ircSASL = {</span>
<a href="#l55.101"></a><span id="l55.101">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l55.102"></a><span id="l55.102">       return true;</span>
<a href="#l55.103"></a><span id="l55.103">     },</span>
<a href="#l55.104"></a><span id="l55.104"> </span>
<a href="#l55.105"></a><span id="l55.105">     &quot;906&quot;: function(aMessage) {</span>
<a href="#l55.106"></a><span id="l55.106">       // ERR_SASLABORTED</span>
<a href="#l55.107"></a><span id="l55.107">       // The client completed registration before SASL authentication completed,</span>
<a href="#l55.108"></a><span id="l55.108">       // or because we sent `AUTHENTICATE` with `*` as the parameter.</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineminus">-      this.ERROR(&quot;Registration completed before SASL authentication completed.&quot;);</span>
<a href="#l55.110"></a><span id="l55.110" class="difflineplus">+      this.ERROR(</span>
<a href="#l55.111"></a><span id="l55.111" class="difflineplus">+        &quot;Registration completed before SASL authentication completed.&quot;</span>
<a href="#l55.112"></a><span id="l55.112" class="difflineplus">+      );</span>
<a href="#l55.113"></a><span id="l55.113">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l55.114"></a><span id="l55.114">       return true;</span>
<a href="#l55.115"></a><span id="l55.115">     },</span>
<a href="#l55.116"></a><span id="l55.116"> </span>
<a href="#l55.117"></a><span id="l55.117">     &quot;907&quot;: function(aMessage) {</span>
<a href="#l55.118"></a><span id="l55.118">       // ERR_SASLALREADY</span>
<a href="#l55.119"></a><span id="l55.119">       // Response if client attempts to AUTHENTICATE after successful</span>
<a href="#l55.120"></a><span id="l55.120">       // authentication.</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineat">@@ -121,23 +137,22 @@ var ircSASL = {</span>
<a href="#l55.122"></a><span id="l55.122"> };</span>
<a href="#l55.123"></a><span id="l55.123"> </span>
<a href="#l55.124"></a><span id="l55.124"> var capSASL = {</span>
<a href="#l55.125"></a><span id="l55.125">   name: &quot;SASL CAP&quot;,</span>
<a href="#l55.126"></a><span id="l55.126">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l55.127"></a><span id="l55.127">   isEnabled: () =&gt; true,</span>
<a href="#l55.128"></a><span id="l55.128"> </span>
<a href="#l55.129"></a><span id="l55.129">   commands: {</span>
<a href="#l55.130"></a><span id="l55.130" class="difflineminus">-    &quot;sasl&quot;: function(aMessage) {</span>
<a href="#l55.131"></a><span id="l55.131" class="difflineplus">+    sasl(aMessage) {</span>
<a href="#l55.132"></a><span id="l55.132">       if (aMessage.cap.subcommand == &quot;LS&quot; &amp;&amp; this.imAccount.password) {</span>
<a href="#l55.133"></a><span id="l55.133">         // If it supports SASL, let the server know we're requiring SASL.</span>
<a href="#l55.134"></a><span id="l55.134">         this.sendMessage(&quot;CAP&quot;, [&quot;REQ&quot;, &quot;sasl&quot;]);</span>
<a href="#l55.135"></a><span id="l55.135">         this.addCAP(&quot;sasl&quot;);</span>
<a href="#l55.136"></a><span id="l55.136" class="difflineminus">-      }</span>
<a href="#l55.137"></a><span id="l55.137" class="difflineminus">-      else if (aMessage.cap.subcommand == &quot;ACK&quot;) {</span>
<a href="#l55.138"></a><span id="l55.138" class="difflineplus">+      } else if (aMessage.cap.subcommand == &quot;ACK&quot;) {</span>
<a href="#l55.139"></a><span id="l55.139">         // The server acknowledges our choice to use SASL, send the first</span>
<a href="#l55.140"></a><span id="l55.140">         // message.</span>
<a href="#l55.141"></a><span id="l55.141">         this.sendMessage(&quot;AUTHENTICATE&quot;, &quot;PLAIN&quot;);</span>
<a href="#l55.142"></a><span id="l55.142">       }</span>
<a href="#l55.143"></a><span id="l55.143"> </span>
<a href="#l55.144"></a><span id="l55.144">       return true;</span>
<a href="#l55.145"></a><span id="l55.145">     },</span>
<a href="#l55.146"></a><span id="l55.146">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/chat/protocols/irc/ircServerTime.jsm</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/chat/protocols/irc/ircServerTime.jsm</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -4,34 +4,36 @@</span>
<a href="#l56.4"></a><span id="l56.4"> </span>
<a href="#l56.5"></a><span id="l56.5"> /*</span>
<a href="#l56.6"></a><span id="l56.6">  * This implements server-time for IRC.</span>
<a href="#l56.7"></a><span id="l56.7">  *   http://ircv3.net/specs/extensions/server-time-3.2.html</span>
<a href="#l56.8"></a><span id="l56.8">  */</span>
<a href="#l56.9"></a><span id="l56.9"> </span>
<a href="#l56.10"></a><span id="l56.10"> this.EXPORTED_SYMBOLS = [&quot;capServerTime&quot;, &quot;tagServerTime&quot;];</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+);</span>
<a href="#l56.16"></a><span id="l56.16"> </span>
<a href="#l56.17"></a><span id="l56.17"> function handleServerTimeTag(aMsg) {</span>
<a href="#l56.18"></a><span id="l56.18">   if (aMsg.tagValue) {</span>
<a href="#l56.19"></a><span id="l56.19">     // Normalize leap seconds to the next second before it.</span>
<a href="#l56.20"></a><span id="l56.20">     const time = aMsg.tagValue.replace(/60.\d{3}(?=Z$)/, &quot;59.999&quot;);</span>
<a href="#l56.21"></a><span id="l56.21">     aMsg.message.time = Math.floor(Date.parse(time) / 1000);</span>
<a href="#l56.22"></a><span id="l56.22">     aMsg.message.delayed = true;</span>
<a href="#l56.23"></a><span id="l56.23">   }</span>
<a href="#l56.24"></a><span id="l56.24"> }</span>
<a href="#l56.25"></a><span id="l56.25"> </span>
<a href="#l56.26"></a><span id="l56.26"> var tagServerTime = {</span>
<a href="#l56.27"></a><span id="l56.27">   name: &quot;server-time Tags&quot;,</span>
<a href="#l56.28"></a><span id="l56.28">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l56.29"></a><span id="l56.29">   isEnabled: () =&gt; true,</span>
<a href="#l56.30"></a><span id="l56.30"> </span>
<a href="#l56.31"></a><span id="l56.31">   commands: {</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineminus">-    &quot;time&quot;: handleServerTimeTag,</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineplus">+    time: handleServerTimeTag,</span>
<a href="#l56.34"></a><span id="l56.34">     &quot;znc.in/server-time-iso&quot;: handleServerTimeTag,</span>
<a href="#l56.35"></a><span id="l56.35">   },</span>
<a href="#l56.36"></a><span id="l56.36"> };</span>
<a href="#l56.37"></a><span id="l56.37"> </span>
<a href="#l56.38"></a><span id="l56.38"> var capServerTime = {</span>
<a href="#l56.39"></a><span id="l56.39">   name: &quot;server-time CAP&quot;,</span>
<a href="#l56.40"></a><span id="l56.40">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l56.41"></a><span id="l56.41">   isEnabled: () =&gt; true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/chat/protocols/irc/ircServices.jsm</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/chat/protocols/irc/ircServices.jsm</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -13,106 +13,127 @@</span>
<a href="#l57.4"></a><span id="l57.4">  * showing the message to the user if we're unsure what to do.</span>
<a href="#l57.5"></a><span id="l57.5">  *</span>
<a href="#l57.6"></a><span id="l57.6">  * Anope</span>
<a href="#l57.7"></a><span id="l57.7">  *  http://www.anope.org/docgen/1.8/</span>
<a href="#l57.8"></a><span id="l57.8">  */</span>
<a href="#l57.9"></a><span id="l57.9"> </span>
<a href="#l57.10"></a><span id="l57.10"> this.EXPORTED_SYMBOLS = [&quot;ircServices&quot;, &quot;servicesBase&quot;];</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-var {</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-  setTimeout,</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineminus">-  clearTimeout,</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l57.16"></a><span id="l57.16" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l57.17"></a><span id="l57.17" class="difflineplus">+var { setTimeout, clearTimeout } = ChromeUtils.import(</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineplus">+);</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+);</span>
<a href="#l57.23"></a><span id="l57.23"> </span>
<a href="#l57.24"></a><span id="l57.24"> /*</span>
<a href="#l57.25"></a><span id="l57.25">  * If a service is found, an extra field (serviceName) is added with the</span>
<a href="#l57.26"></a><span id="l57.26">  * &quot;generic&quot; service name (e.g. a bot which performs NickServ like functionality</span>
<a href="#l57.27"></a><span id="l57.27">  * will be mapped to NickServ).</span>
<a href="#l57.28"></a><span id="l57.28">  */</span>
<a href="#l57.29"></a><span id="l57.29"> function ServiceMessage(aAccount, aMessage) {</span>
<a href="#l57.30"></a><span id="l57.30">   // This should be a property of the account or configurable somehow, it maps</span>
<a href="#l57.31"></a><span id="l57.31">   // from server specific service names to our generic service names (e.g. if</span>
<a href="#l57.32"></a><span id="l57.32">   // irc.foo.net has a service called bar, which acts as a NickServ, we would</span>
<a href="#l57.33"></a><span id="l57.33">   // map &quot;bar&quot;: &quot;NickServ&quot;). Note that the keys of this map should be</span>
<a href="#l57.34"></a><span id="l57.34">   // normalized.</span>
<a href="#l57.35"></a><span id="l57.35">   let nicknameToServiceName = {</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineminus">-    &quot;chanserv&quot;: &quot;ChanServ&quot;,</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineminus">-    &quot;infoserv&quot;: &quot;InfoServ&quot;,</span>
<a href="#l57.38"></a><span id="l57.38" class="difflineminus">-    &quot;nickserv&quot;: &quot;NickServ&quot;,</span>
<a href="#l57.39"></a><span id="l57.39" class="difflineplus">+    chanserv: &quot;ChanServ&quot;,</span>
<a href="#l57.40"></a><span id="l57.40" class="difflineplus">+    infoserv: &quot;InfoServ&quot;,</span>
<a href="#l57.41"></a><span id="l57.41" class="difflineplus">+    nickserv: &quot;NickServ&quot;,</span>
<a href="#l57.42"></a><span id="l57.42">     &quot;freenode-connect&quot;: &quot;freenode-connect&quot;,</span>
<a href="#l57.43"></a><span id="l57.43">   };</span>
<a href="#l57.44"></a><span id="l57.44"> </span>
<a href="#l57.45"></a><span id="l57.45">   let nickname = aAccount.normalize(aMessage.origin);</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-  if (nicknameToServiceName.hasOwnProperty(nickname))</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineplus">+  if (nicknameToServiceName.hasOwnProperty(nickname)) {</span>
<a href="#l57.48"></a><span id="l57.48">     aMessage.serviceName = nicknameToServiceName[nickname];</span>
<a href="#l57.49"></a><span id="l57.49" class="difflineplus">+  }</span>
<a href="#l57.50"></a><span id="l57.50"> </span>
<a href="#l57.51"></a><span id="l57.51">   return aMessage;</span>
<a href="#l57.52"></a><span id="l57.52"> }</span>
<a href="#l57.53"></a><span id="l57.53"> </span>
<a href="#l57.54"></a><span id="l57.54"> var ircServices = {</span>
<a href="#l57.55"></a><span id="l57.55">   name: &quot;IRC Services&quot;,</span>
<a href="#l57.56"></a><span id="l57.56">   priority: ircHandlers.HIGH_PRIORITY,</span>
<a href="#l57.57"></a><span id="l57.57">   isEnabled: () =&gt; true,</span>
<a href="#l57.58"></a><span id="l57.58">   sendIdentify(aAccount) {</span>
<a href="#l57.59"></a><span id="l57.59" class="difflineminus">-    if (aAccount.imAccount.password &amp;&amp; aAccount.shouldAuthenticate &amp;&amp;</span>
<a href="#l57.60"></a><span id="l57.60" class="difflineminus">-        !aAccount.isAuthenticated) {</span>
<a href="#l57.61"></a><span id="l57.61" class="difflineminus">-      aAccount.sendMessage(&quot;IDENTIFY&quot;, aAccount.imAccount.password,</span>
<a href="#l57.62"></a><span id="l57.62" class="difflineminus">-                           &quot;IDENTIFY &lt;password not logged&gt;&quot;);</span>
<a href="#l57.63"></a><span id="l57.63" class="difflineplus">+    if (</span>
<a href="#l57.64"></a><span id="l57.64" class="difflineplus">+      aAccount.imAccount.password &amp;&amp;</span>
<a href="#l57.65"></a><span id="l57.65" class="difflineplus">+      aAccount.shouldAuthenticate &amp;&amp;</span>
<a href="#l57.66"></a><span id="l57.66" class="difflineplus">+      !aAccount.isAuthenticated</span>
<a href="#l57.67"></a><span id="l57.67" class="difflineplus">+    ) {</span>
<a href="#l57.68"></a><span id="l57.68" class="difflineplus">+      aAccount.sendMessage(</span>
<a href="#l57.69"></a><span id="l57.69" class="difflineplus">+        &quot;IDENTIFY&quot;,</span>
<a href="#l57.70"></a><span id="l57.70" class="difflineplus">+        aAccount.imAccount.password,</span>
<a href="#l57.71"></a><span id="l57.71" class="difflineplus">+        &quot;IDENTIFY &lt;password not logged&gt;&quot;</span>
<a href="#l57.72"></a><span id="l57.72" class="difflineplus">+      );</span>
<a href="#l57.73"></a><span id="l57.73">     }</span>
<a href="#l57.74"></a><span id="l57.74">   },</span>
<a href="#l57.75"></a><span id="l57.75"> </span>
<a href="#l57.76"></a><span id="l57.76">   commands: {</span>
<a href="#l57.77"></a><span id="l57.77">     // If we automatically reply to a NOTICE message this does not abide by RFC</span>
<a href="#l57.78"></a><span id="l57.78">     // 2812. Oh well.</span>
<a href="#l57.79"></a><span id="l57.79" class="difflineminus">-    &quot;NOTICE&quot;: function(aMessage) {</span>
<a href="#l57.80"></a><span id="l57.80" class="difflineminus">-      if (!ircHandlers.hasServicesHandlers)</span>
<a href="#l57.81"></a><span id="l57.81" class="difflineplus">+    NOTICE(aMessage) {</span>
<a href="#l57.82"></a><span id="l57.82" class="difflineplus">+      if (!ircHandlers.hasServicesHandlers) {</span>
<a href="#l57.83"></a><span id="l57.83">         return false;</span>
<a href="#l57.84"></a><span id="l57.84" class="difflineplus">+      }</span>
<a href="#l57.85"></a><span id="l57.85"> </span>
<a href="#l57.86"></a><span id="l57.86">       let message = ServiceMessage(this, aMessage);</span>
<a href="#l57.87"></a><span id="l57.87"> </span>
<a href="#l57.88"></a><span id="l57.88">       // If no service was found, return early.</span>
<a href="#l57.89"></a><span id="l57.89" class="difflineminus">-      if (!message.hasOwnProperty(&quot;serviceName&quot;))</span>
<a href="#l57.90"></a><span id="l57.90" class="difflineplus">+      if (!message.hasOwnProperty(&quot;serviceName&quot;)) {</span>
<a href="#l57.91"></a><span id="l57.91">         return false;</span>
<a href="#l57.92"></a><span id="l57.92" class="difflineplus">+      }</span>
<a href="#l57.93"></a><span id="l57.93"> </span>
<a href="#l57.94"></a><span id="l57.94">       // If the name is recognized as a service name, add the service name field</span>
<a href="#l57.95"></a><span id="l57.95">       // and run it through the handlers.</span>
<a href="#l57.96"></a><span id="l57.96">       return ircHandlers.handleServicesMessage(this, message);</span>
<a href="#l57.97"></a><span id="l57.97">     },</span>
<a href="#l57.98"></a><span id="l57.98"> </span>
<a href="#l57.99"></a><span id="l57.99" class="difflineminus">-    &quot;NICK&quot;: function(aMessage) {</span>
<a href="#l57.100"></a><span id="l57.100" class="difflineplus">+    NICK(aMessage) {</span>
<a href="#l57.101"></a><span id="l57.101">       let newNick = aMessage.params[0];</span>
<a href="#l57.102"></a><span id="l57.102">       // We only auto-authenticate for the account nickname.</span>
<a href="#l57.103"></a><span id="l57.103" class="difflineminus">-      if (this.normalize(newNick) != this.normalize(this._accountNickname))</span>
<a href="#l57.104"></a><span id="l57.104" class="difflineplus">+      if (this.normalize(newNick) != this.normalize(this._accountNickname)) {</span>
<a href="#l57.105"></a><span id="l57.105">         return false;</span>
<a href="#l57.106"></a><span id="l57.106" class="difflineplus">+      }</span>
<a href="#l57.107"></a><span id="l57.107"> </span>
<a href="#l57.108"></a><span id="l57.108">       // If we're not identified already, try to identify.</span>
<a href="#l57.109"></a><span id="l57.109" class="difflineminus">-      if (!this.isAuthenticated)</span>
<a href="#l57.110"></a><span id="l57.110" class="difflineplus">+      if (!this.isAuthenticated) {</span>
<a href="#l57.111"></a><span id="l57.111">         ircServices.sendIdentify(this);</span>
<a href="#l57.112"></a><span id="l57.112" class="difflineplus">+      }</span>
<a href="#l57.113"></a><span id="l57.113"> </span>
<a href="#l57.114"></a><span id="l57.114">       // We always want the RFC 2812 handler to handle NICK, so return false.</span>
<a href="#l57.115"></a><span id="l57.115">       return false;</span>
<a href="#l57.116"></a><span id="l57.116">     },</span>
<a href="#l57.117"></a><span id="l57.117"> </span>
<a href="#l57.118"></a><span id="l57.118" class="difflineminus">-    &quot;001&quot;: function(aMessage) { // RPL_WELCOME</span>
<a href="#l57.119"></a><span id="l57.119" class="difflineplus">+    &quot;001&quot;: function(aMessage) {</span>
<a href="#l57.120"></a><span id="l57.120" class="difflineplus">+      // RPL_WELCOME</span>
<a href="#l57.121"></a><span id="l57.121">       // If SASL authentication failed, attempt IDENTIFY.</span>
<a href="#l57.122"></a><span id="l57.122">       ircServices.sendIdentify(this);</span>
<a href="#l57.123"></a><span id="l57.123"> </span>
<a href="#l57.124"></a><span id="l57.124">       // We always want the RFC 2812 handler to handle 001, so return false.</span>
<a href="#l57.125"></a><span id="l57.125">       return false;</span>
<a href="#l57.126"></a><span id="l57.126">     },</span>
<a href="#l57.127"></a><span id="l57.127"> </span>
<a href="#l57.128"></a><span id="l57.128" class="difflineminus">-    &quot;421&quot;: function(aMessage) { // ERR_UNKNOWNCOMMAND</span>
<a href="#l57.129"></a><span id="l57.129" class="difflineplus">+    &quot;421&quot;: function(aMessage) {</span>
<a href="#l57.130"></a><span id="l57.130" class="difflineplus">+      // ERR_UNKNOWNCOMMAND</span>
<a href="#l57.131"></a><span id="l57.131">       // &lt;command&gt; :Unknown command</span>
<a href="#l57.132"></a><span id="l57.132">       // IDENTIFY failed, try NICKSERV IDENTIFY.</span>
<a href="#l57.133"></a><span id="l57.133" class="difflineminus">-      if (aMessage.params[1] == &quot;IDENTIFY&quot; &amp;&amp; this.imAccount.password &amp;&amp;</span>
<a href="#l57.134"></a><span id="l57.134" class="difflineminus">-          this.shouldAuthenticate &amp;&amp; !this.isAuthenticated) {</span>
<a href="#l57.135"></a><span id="l57.135" class="difflineminus">-        this.sendMessage(&quot;NICKSERV&quot;, [&quot;IDENTIFY&quot;, this.imAccount.password],</span>
<a href="#l57.136"></a><span id="l57.136" class="difflineminus">-                         &quot;NICKSERV IDENTIFY &lt;password not logged&gt;&quot;);</span>
<a href="#l57.137"></a><span id="l57.137" class="difflineplus">+      if (</span>
<a href="#l57.138"></a><span id="l57.138" class="difflineplus">+        aMessage.params[1] == &quot;IDENTIFY&quot; &amp;&amp;</span>
<a href="#l57.139"></a><span id="l57.139" class="difflineplus">+        this.imAccount.password &amp;&amp;</span>
<a href="#l57.140"></a><span id="l57.140" class="difflineplus">+        this.shouldAuthenticate &amp;&amp;</span>
<a href="#l57.141"></a><span id="l57.141" class="difflineplus">+        !this.isAuthenticated</span>
<a href="#l57.142"></a><span id="l57.142" class="difflineplus">+      ) {</span>
<a href="#l57.143"></a><span id="l57.143" class="difflineplus">+        this.sendMessage(</span>
<a href="#l57.144"></a><span id="l57.144" class="difflineplus">+          &quot;NICKSERV&quot;,</span>
<a href="#l57.145"></a><span id="l57.145" class="difflineplus">+          [&quot;IDENTIFY&quot;, this.imAccount.password],</span>
<a href="#l57.146"></a><span id="l57.146" class="difflineplus">+          &quot;NICKSERV IDENTIFY &lt;password not logged&gt;&quot;</span>
<a href="#l57.147"></a><span id="l57.147" class="difflineplus">+        );</span>
<a href="#l57.148"></a><span id="l57.148">         return true;</span>
<a href="#l57.149"></a><span id="l57.149">       }</span>
<a href="#l57.150"></a><span id="l57.150">       if (aMessage.params[1] == &quot;NICKSERV&quot;) {</span>
<a href="#l57.151"></a><span id="l57.151">         this.WARN(&quot;NICKSERV command does not exist.&quot;);</span>
<a href="#l57.152"></a><span id="l57.152">         return true;</span>
<a href="#l57.153"></a><span id="l57.153">       }</span>
<a href="#l57.154"></a><span id="l57.154">       return false;</span>
<a href="#l57.155"></a><span id="l57.155">     },</span>
<a href="#l57.156"></a><span id="l57.156" class="difflineat">@@ -120,135 +141,160 @@ var ircServices = {</span>
<a href="#l57.157"></a><span id="l57.157"> };</span>
<a href="#l57.158"></a><span id="l57.158"> </span>
<a href="#l57.159"></a><span id="l57.159"> var servicesBase = {</span>
<a href="#l57.160"></a><span id="l57.160">   name: &quot;IRC Services&quot;,</span>
<a href="#l57.161"></a><span id="l57.161">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l57.162"></a><span id="l57.162">   isEnabled: () =&gt; true,</span>
<a href="#l57.163"></a><span id="l57.163"> </span>
<a href="#l57.164"></a><span id="l57.164">   commands: {</span>
<a href="#l57.165"></a><span id="l57.165" class="difflineminus">-    &quot;ChanServ&quot;: function(aMessage) {</span>
<a href="#l57.166"></a><span id="l57.166" class="difflineplus">+    ChanServ(aMessage) {</span>
<a href="#l57.167"></a><span id="l57.167">       // [&lt;channel name&gt;] &lt;message&gt;</span>
<a href="#l57.168"></a><span id="l57.168">       let channel = aMessage.params[1].split(&quot; &quot;, 1)[0];</span>
<a href="#l57.169"></a><span id="l57.169" class="difflineminus">-      if (!channel || channel[0] != &quot;[&quot; || channel.slice(-1)[0] != &quot;]&quot;)</span>
<a href="#l57.170"></a><span id="l57.170" class="difflineplus">+      if (!channel || channel[0] != &quot;[&quot; || channel.slice(-1)[0] != &quot;]&quot;) {</span>
<a href="#l57.171"></a><span id="l57.171">         return false;</span>
<a href="#l57.172"></a><span id="l57.172" class="difflineplus">+      }</span>
<a href="#l57.173"></a><span id="l57.173"> </span>
<a href="#l57.174"></a><span id="l57.174">       // Remove the [ and ].</span>
<a href="#l57.175"></a><span id="l57.175">       channel = channel.slice(1, -1);</span>
<a href="#l57.176"></a><span id="l57.176">       // If it isn't a channel or doesn't exist, return early.</span>
<a href="#l57.177"></a><span id="l57.177" class="difflineminus">-      if (!this.isMUCName(channel) || !this.conversations.has(channel))</span>
<a href="#l57.178"></a><span id="l57.178" class="difflineplus">+      if (!this.isMUCName(channel) || !this.conversations.has(channel)) {</span>
<a href="#l57.179"></a><span id="l57.179">         return false;</span>
<a href="#l57.180"></a><span id="l57.180" class="difflineplus">+      }</span>
<a href="#l57.181"></a><span id="l57.181"> </span>
<a href="#l57.182"></a><span id="l57.182">       // Otherwise, display the message in that conversation.</span>
<a href="#l57.183"></a><span id="l57.183" class="difflineminus">-      let params = {incoming: true};</span>
<a href="#l57.184"></a><span id="l57.184" class="difflineminus">-      if (aMessage.command == &quot;NOTICE&quot;)</span>
<a href="#l57.185"></a><span id="l57.185" class="difflineplus">+      let params = { incoming: true };</span>
<a href="#l57.186"></a><span id="l57.186" class="difflineplus">+      if (aMessage.command == &quot;NOTICE&quot;) {</span>
<a href="#l57.187"></a><span id="l57.187">         params.notification = true;</span>
<a href="#l57.188"></a><span id="l57.188" class="difflineplus">+      }</span>
<a href="#l57.189"></a><span id="l57.189"> </span>
<a href="#l57.190"></a><span id="l57.190">       // The message starts after the channel name, plus [, ] and a space.</span>
<a href="#l57.191"></a><span id="l57.191">       let message = aMessage.params[1].slice(channel.length + 3);</span>
<a href="#l57.192"></a><span id="l57.192" class="difflineminus">-      this.getConversation(channel)</span>
<a href="#l57.193"></a><span id="l57.193" class="difflineminus">-          .writeMessage(aMessage.origin, message, params);</span>
<a href="#l57.194"></a><span id="l57.194" class="difflineplus">+      this.getConversation(channel).writeMessage(</span>
<a href="#l57.195"></a><span id="l57.195" class="difflineplus">+        aMessage.origin,</span>
<a href="#l57.196"></a><span id="l57.196" class="difflineplus">+        message,</span>
<a href="#l57.197"></a><span id="l57.197" class="difflineplus">+        params</span>
<a href="#l57.198"></a><span id="l57.198" class="difflineplus">+      );</span>
<a href="#l57.199"></a><span id="l57.199">       return true;</span>
<a href="#l57.200"></a><span id="l57.200">     },</span>
<a href="#l57.201"></a><span id="l57.201"> </span>
<a href="#l57.202"></a><span id="l57.202" class="difflineminus">-    &quot;InfoServ&quot;: function(aMessage) {</span>
<a href="#l57.203"></a><span id="l57.203" class="difflineplus">+    InfoServ(aMessage) {</span>
<a href="#l57.204"></a><span id="l57.204">       let text = aMessage.params[1];</span>
<a href="#l57.205"></a><span id="l57.205"> </span>
<a href="#l57.206"></a><span id="l57.206">       // Show the message of the day in the server tab.</span>
<a href="#l57.207"></a><span id="l57.207">       if (text == &quot;*** \u0002Message(s) of the Day\u0002 ***&quot;) {</span>
<a href="#l57.208"></a><span id="l57.208">         this._infoServMotd = [text];</span>
<a href="#l57.209"></a><span id="l57.209">         return true;</span>
<a href="#l57.210"></a><span id="l57.210" class="difflineminus">-      }</span>
<a href="#l57.211"></a><span id="l57.211" class="difflineminus">-      else if (text == &quot;*** \u0002End of Message(s) of the Day\u0002 ***&quot;) {</span>
<a href="#l57.212"></a><span id="l57.212" class="difflineplus">+      } else if (text == &quot;*** \u0002End of Message(s) of the Day\u0002 ***&quot;) {</span>
<a href="#l57.213"></a><span id="l57.213">         if (this._showServerTab &amp;&amp; this._infoServMotd) {</span>
<a href="#l57.214"></a><span id="l57.214">           this._infoServMotd.push(text);</span>
<a href="#l57.215"></a><span id="l57.215" class="difflineminus">-          this.getConversation(aMessage.origin)</span>
<a href="#l57.216"></a><span id="l57.216" class="difflineminus">-              .writeMessage(aMessage.origin, this._infoServMotd.join(&quot;\n&quot;),</span>
<a href="#l57.217"></a><span id="l57.217" class="difflineminus">-                            {incoming: true});</span>
<a href="#l57.218"></a><span id="l57.218" class="difflineplus">+          this.getConversation(aMessage.origin).writeMessage(</span>
<a href="#l57.219"></a><span id="l57.219" class="difflineplus">+            aMessage.origin,</span>
<a href="#l57.220"></a><span id="l57.220" class="difflineplus">+            this._infoServMotd.join(&quot;\n&quot;),</span>
<a href="#l57.221"></a><span id="l57.221" class="difflineplus">+            { incoming: true }</span>
<a href="#l57.222"></a><span id="l57.222" class="difflineplus">+          );</span>
<a href="#l57.223"></a><span id="l57.223">           delete this._infoServMotd;</span>
<a href="#l57.224"></a><span id="l57.224">         }</span>
<a href="#l57.225"></a><span id="l57.225">         return true;</span>
<a href="#l57.226"></a><span id="l57.226" class="difflineminus">-      }</span>
<a href="#l57.227"></a><span id="l57.227" class="difflineminus">-      else if (this.hasOwnProperty(&quot;_infoServMotd&quot;)) {</span>
<a href="#l57.228"></a><span id="l57.228" class="difflineplus">+      } else if (this.hasOwnProperty(&quot;_infoServMotd&quot;)) {</span>
<a href="#l57.229"></a><span id="l57.229">         this._infoServMotd.push(text);</span>
<a href="#l57.230"></a><span id="l57.230">         return true;</span>
<a href="#l57.231"></a><span id="l57.231">       }</span>
<a href="#l57.232"></a><span id="l57.232"> </span>
<a href="#l57.233"></a><span id="l57.233">       return false;</span>
<a href="#l57.234"></a><span id="l57.234">     },</span>
<a href="#l57.235"></a><span id="l57.235"> </span>
<a href="#l57.236"></a><span id="l57.236" class="difflineminus">-    &quot;NickServ&quot;: function(aMessage) {</span>
<a href="#l57.237"></a><span id="l57.237" class="difflineplus">+    NickServ(aMessage) {</span>
<a href="#l57.238"></a><span id="l57.238">       let text = aMessage.params[1];</span>
<a href="#l57.239"></a><span id="l57.239"> </span>
<a href="#l57.240"></a><span id="l57.240">       // Since we feed the messages back through the system at the end of the</span>
<a href="#l57.241"></a><span id="l57.241">       // timeout when waiting for a log-in, we need to NOT try to handle them</span>
<a href="#l57.242"></a><span id="l57.242">       // here and let them fall through to the default handler.</span>
<a href="#l57.243"></a><span id="l57.243" class="difflineminus">-      if (this.isHandlingQueuedMessages)</span>
<a href="#l57.244"></a><span id="l57.244" class="difflineplus">+      if (this.isHandlingQueuedMessages) {</span>
<a href="#l57.245"></a><span id="l57.245">         return false;</span>
<a href="#l57.246"></a><span id="l57.246" class="difflineplus">+      }</span>
<a href="#l57.247"></a><span id="l57.247"> </span>
<a href="#l57.248"></a><span id="l57.248">       // If we have a queue of messages, we're waiting for authentication.</span>
<a href="#l57.249"></a><span id="l57.249">       if (this.nickservMessageQueue) {</span>
<a href="#l57.250"></a><span id="l57.250" class="difflineminus">-        if (text == &quot;Password accepted - you are now recognized.&quot; || // Anope.</span>
<a href="#l57.251"></a><span id="l57.251" class="difflineminus">-            text.slice(0, 28) == &quot;You are now identified for \x02&quot;) { // Atheme.</span>
<a href="#l57.252"></a><span id="l57.252" class="difflineplus">+        if (</span>
<a href="#l57.253"></a><span id="l57.253" class="difflineplus">+          text == &quot;Password accepted - you are now recognized.&quot; || // Anope.</span>
<a href="#l57.254"></a><span id="l57.254" class="difflineplus">+          text.slice(0, 28) == &quot;You are now identified for \x02&quot;</span>
<a href="#l57.255"></a><span id="l57.255" class="difflineplus">+        ) {</span>
<a href="#l57.256"></a><span id="l57.256" class="difflineplus">+          // Atheme.</span>
<a href="#l57.257"></a><span id="l57.257">           // Password successfully accepted by NickServ, don't display the</span>
<a href="#l57.258"></a><span id="l57.258">           // queued messages.</span>
<a href="#l57.259"></a><span id="l57.259">           this.LOG(&quot;Successfully authenticated with NickServ.&quot;);</span>
<a href="#l57.260"></a><span id="l57.260">           this.isAuthenticated = true;</span>
<a href="#l57.261"></a><span id="l57.261">           clearTimeout(this.nickservAuthTimeout);</span>
<a href="#l57.262"></a><span id="l57.262">           delete this.nickservAuthTimeout;</span>
<a href="#l57.263"></a><span id="l57.263">           delete this.nickservMessageQueue;</span>
<a href="#l57.264"></a><span id="l57.264" class="difflineminus">-        }</span>
<a href="#l57.265"></a><span id="l57.265" class="difflineminus">-        else {</span>
<a href="#l57.266"></a><span id="l57.266" class="difflineplus">+        } else {</span>
<a href="#l57.267"></a><span id="l57.267">           // Queue any other messages that occur during the timeout so they</span>
<a href="#l57.268"></a><span id="l57.268">           // appear in the proper order.</span>
<a href="#l57.269"></a><span id="l57.269">           this.nickservMessageQueue.push(aMessage);</span>
<a href="#l57.270"></a><span id="l57.270">         }</span>
<a href="#l57.271"></a><span id="l57.271">         return true;</span>
<a href="#l57.272"></a><span id="l57.272">       }</span>
<a href="#l57.273"></a><span id="l57.273"> </span>
<a href="#l57.274"></a><span id="l57.274">       // NickServ wants us to identify.</span>
<a href="#l57.275"></a><span id="l57.275" class="difflineminus">-      if (text == &quot;This nick is owned by someone else.  Please choose another.&quot; || // Anope.</span>
<a href="#l57.276"></a><span id="l57.276" class="difflineminus">-          text == &quot;This nickname is registered and protected.  If it is your&quot; || // Anope (SECURE enabled).</span>
<a href="#l57.277"></a><span id="l57.277" class="difflineminus">-          text == &quot;This nickname is registered. Please choose a different nickname, or identify via \x02/msg NickServ identify &lt;password&gt;\x02.&quot;) { // Atheme.</span>
<a href="#l57.278"></a><span id="l57.278" class="difflineplus">+      if (</span>
<a href="#l57.279"></a><span id="l57.279" class="difflineplus">+        text == &quot;This nick is owned by someone else.  Please choose another.&quot; || // Anope.</span>
<a href="#l57.280"></a><span id="l57.280" class="difflineplus">+        text == &quot;This nickname is registered and protected.  If it is your&quot; || // Anope (SECURE enabled).</span>
<a href="#l57.281"></a><span id="l57.281" class="difflineplus">+        text ==</span>
<a href="#l57.282"></a><span id="l57.282" class="difflineplus">+          &quot;This nickname is registered. Please choose a different nickname, or identify via \x02/msg NickServ identify &lt;password&gt;\x02.&quot;</span>
<a href="#l57.283"></a><span id="l57.283" class="difflineplus">+      ) {</span>
<a href="#l57.284"></a><span id="l57.284" class="difflineplus">+        // Atheme.</span>
<a href="#l57.285"></a><span id="l57.285">         this.LOG(&quot;Authentication requested by NickServ.&quot;);</span>
<a href="#l57.286"></a><span id="l57.286"> </span>
<a href="#l57.287"></a><span id="l57.287">         // Wait one second before showing the message to the user (giving the</span>
<a href="#l57.288"></a><span id="l57.288">         // the server time to process the log-in).</span>
<a href="#l57.289"></a><span id="l57.289">         this.nickservMessageQueue = [aMessage];</span>
<a href="#l57.290"></a><span id="l57.290" class="difflineminus">-        this.nickservAuthTimeout = setTimeout(function() {</span>
<a href="#l57.291"></a><span id="l57.291" class="difflineminus">-          this.isHandlingQueuedMessages = true;</span>
<a href="#l57.292"></a><span id="l57.292" class="difflineminus">-          this.nickservMessageQueue.every(aMessage =&gt;</span>
<a href="#l57.293"></a><span id="l57.293" class="difflineminus">-            ircHandlers.handleMessage(this, aMessage));</span>
<a href="#l57.294"></a><span id="l57.294" class="difflineminus">-          delete this.isHandlingQueuedMessages;</span>
<a href="#l57.295"></a><span id="l57.295" class="difflineminus">-          delete this.nickservMessageQueue;</span>
<a href="#l57.296"></a><span id="l57.296" class="difflineminus">-        }.bind(this), 10000);</span>
<a href="#l57.297"></a><span id="l57.297" class="difflineplus">+        this.nickservAuthTimeout = setTimeout(</span>
<a href="#l57.298"></a><span id="l57.298" class="difflineplus">+          function() {</span>
<a href="#l57.299"></a><span id="l57.299" class="difflineplus">+            this.isHandlingQueuedMessages = true;</span>
<a href="#l57.300"></a><span id="l57.300" class="difflineplus">+            this.nickservMessageQueue.every(aMessage =&gt;</span>
<a href="#l57.301"></a><span id="l57.301" class="difflineplus">+              ircHandlers.handleMessage(this, aMessage)</span>
<a href="#l57.302"></a><span id="l57.302" class="difflineplus">+            );</span>
<a href="#l57.303"></a><span id="l57.303" class="difflineplus">+            delete this.isHandlingQueuedMessages;</span>
<a href="#l57.304"></a><span id="l57.304" class="difflineplus">+            delete this.nickservMessageQueue;</span>
<a href="#l57.305"></a><span id="l57.305" class="difflineplus">+          }.bind(this),</span>
<a href="#l57.306"></a><span id="l57.306" class="difflineplus">+          10000</span>
<a href="#l57.307"></a><span id="l57.307" class="difflineplus">+        );</span>
<a href="#l57.308"></a><span id="l57.308">         return true;</span>
<a href="#l57.309"></a><span id="l57.309">       }</span>
<a href="#l57.310"></a><span id="l57.310"> </span>
<a href="#l57.311"></a><span id="l57.311" class="difflineminus">-      if (!this.isAuthenticated &amp;&amp;</span>
<a href="#l57.312"></a><span id="l57.312" class="difflineminus">-          (text == &quot;You are already identified.&quot; || // Anope.</span>
<a href="#l57.313"></a><span id="l57.313" class="difflineminus">-           text.slice(0, 30) == &quot;You are already logged in as \x02&quot;)) { // Atheme.</span>
<a href="#l57.314"></a><span id="l57.314" class="difflineplus">+      if (</span>
<a href="#l57.315"></a><span id="l57.315" class="difflineplus">+        !this.isAuthenticated &amp;&amp;</span>
<a href="#l57.316"></a><span id="l57.316" class="difflineplus">+        (text == &quot;You are already identified.&quot; || // Anope.</span>
<a href="#l57.317"></a><span id="l57.317" class="difflineplus">+          text.slice(0, 30) == &quot;You are already logged in as \x02&quot;)</span>
<a href="#l57.318"></a><span id="l57.318" class="difflineplus">+      ) {</span>
<a href="#l57.319"></a><span id="l57.319" class="difflineplus">+        // Atheme.</span>
<a href="#l57.320"></a><span id="l57.320">         // Do not show the message if caused by the automatic reauthentication.</span>
<a href="#l57.321"></a><span id="l57.321">         this.isAuthenticated = true;</span>
<a href="#l57.322"></a><span id="l57.322">         return true;</span>
<a href="#l57.323"></a><span id="l57.323">       }</span>
<a href="#l57.324"></a><span id="l57.324"> </span>
<a href="#l57.325"></a><span id="l57.325">       return false;</span>
<a href="#l57.326"></a><span id="l57.326">     },</span>
<a href="#l57.327"></a><span id="l57.327"> </span>
<a href="#l57.328"></a><span id="l57.328">     /*</span>
<a href="#l57.329"></a><span id="l57.329">      * freenode sends some annoying messages on start-up from a freenode-connect</span>
<a href="#l57.330"></a><span id="l57.330">      * bot. Only show these if the user wants to see server messages. See bug</span>
<a href="#l57.331"></a><span id="l57.331">      * 1521761.</span>
<a href="#l57.332"></a><span id="l57.332">      */</span>
<a href="#l57.333"></a><span id="l57.333">     &quot;freenode-connect&quot;: function(aMessage) {</span>
<a href="#l57.334"></a><span id="l57.334">       // If the user would like to see server messages, fall through to the</span>
<a href="#l57.335"></a><span id="l57.335">       // standard handler.</span>
<a href="#l57.336"></a><span id="l57.336" class="difflineminus">-      if (this._showServerTab)</span>
<a href="#l57.337"></a><span id="l57.337" class="difflineplus">+      if (this._showServerTab) {</span>
<a href="#l57.338"></a><span id="l57.338">         return false;</span>
<a href="#l57.339"></a><span id="l57.339" class="difflineplus">+      }</span>
<a href="#l57.340"></a><span id="l57.340"> </span>
<a href="#l57.341"></a><span id="l57.341">       // Only ignore the message notifying of scanning (and include additional</span>
<a href="#l57.342"></a><span id="l57.342">       // checking of the hostname).</span>
<a href="#l57.343"></a><span id="l57.343" class="difflineminus">-      return (aMessage.host.startsWith(&quot;freenode/utility-bot/&quot;) &amp;&amp;</span>
<a href="#l57.344"></a><span id="l57.344" class="difflineminus">-              aMessage.params[1].includes(&quot;connections will be scanned for vulnerabilities&quot;));</span>
<a href="#l57.345"></a><span id="l57.345" class="difflineplus">+      return (</span>
<a href="#l57.346"></a><span id="l57.346" class="difflineplus">+        aMessage.host.startsWith(&quot;freenode/utility-bot/&quot;) &amp;&amp;</span>
<a href="#l57.347"></a><span id="l57.347" class="difflineplus">+        aMessage.params[1].includes(</span>
<a href="#l57.348"></a><span id="l57.348" class="difflineplus">+          &quot;connections will be scanned for vulnerabilities&quot;</span>
<a href="#l57.349"></a><span id="l57.349" class="difflineplus">+        )</span>
<a href="#l57.350"></a><span id="l57.350" class="difflineplus">+      );</span>
<a href="#l57.351"></a><span id="l57.351">     },</span>
<a href="#l57.352"></a><span id="l57.352">   },</span>
<a href="#l57.353"></a><span id="l57.353"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -1,19 +1,23 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.5"></a><span id="l58.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l58.6"></a><span id="l58.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;_&quot;, &quot;ctcpFormatToText&quot;, &quot;ctcpFormatToHTML&quot;,</span>
<a href="#l58.9"></a><span id="l58.9" class="difflineminus">-                          &quot;conversationErrorMessage&quot;, &quot;kListRefreshInterval&quot;];</span>
<a href="#l58.10"></a><span id="l58.10" class="difflineplus">+this.EXPORTED_SYMBOLS = [</span>
<a href="#l58.11"></a><span id="l58.11" class="difflineplus">+  &quot;_&quot;,</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineplus">+  &quot;ctcpFormatToText&quot;,</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+  &quot;ctcpFormatToHTML&quot;,</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+  &quot;conversationErrorMessage&quot;,</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+  &quot;kListRefreshInterval&quot;,</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineplus">+];</span>
<a href="#l58.17"></a><span id="l58.17"> </span>
<a href="#l58.18"></a><span id="l58.18" class="difflineminus">-var {</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineminus">-  l10nHelper,</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineplus">+);</span>
<a href="#l58.25"></a><span id="l58.25"> </span>
<a href="#l58.26"></a><span id="l58.26"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l58.27"></a><span id="l58.27">   l10nHelper(&quot;chrome://chat/locale/irc.properties&quot;)</span>
<a href="#l58.28"></a><span id="l58.28"> );</span>
<a href="#l58.29"></a><span id="l58.29"> </span>
<a href="#l58.30"></a><span id="l58.30"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l58.31"></a><span id="l58.31">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l58.32"></a><span id="l58.32">   return aTXT =&gt; cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineat">@@ -46,83 +50,86 @@ var CTCP_TAGS = {</span>
<a href="#l58.34"></a><span id="l58.34"> };</span>
<a href="#l58.35"></a><span id="l58.35"> </span>
<a href="#l58.36"></a><span id="l58.36"> // Generate an expression that will search for any of the control characters.</span>
<a href="#l58.37"></a><span id="l58.37"> var CTCP_TAGS_EXP = new RegExp(&quot;[&quot; + Object.keys(CTCP_TAGS).join(&quot;&quot;) + &quot;]&quot;);</span>
<a href="#l58.38"></a><span id="l58.38"> </span>
<a href="#l58.39"></a><span id="l58.39"> // Remove all CTCP formatting characters.</span>
<a href="#l58.40"></a><span id="l58.40"> function ctcpFormatToText(aString) {</span>
<a href="#l58.41"></a><span id="l58.41">   let next,</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineminus">-      input = aString,</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineminus">-      output = &quot;&quot;,</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineminus">-      length;</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineplus">+    input = aString,</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineplus">+    output = &quot;&quot;,</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineplus">+    length;</span>
<a href="#l58.48"></a><span id="l58.48"> </span>
<a href="#l58.49"></a><span id="l58.49">   while ((next = CTCP_TAGS_EXP.exec(input))) {</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineminus">-    if (next.index &gt; 0)</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineplus">+    if (next.index &gt; 0) {</span>
<a href="#l58.52"></a><span id="l58.52">       output += input.substr(0, next.index);</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineplus">+    }</span>
<a href="#l58.54"></a><span id="l58.54">     // We assume one character will be stripped.</span>
<a href="#l58.55"></a><span id="l58.55">     length = 1;</span>
<a href="#l58.56"></a><span id="l58.56">     let tag = CTCP_TAGS[input[next.index]];</span>
<a href="#l58.57"></a><span id="l58.57">     // If the tag is a function, calculate how many characters are handled.</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-    if (typeof tag == &quot;function&quot;)</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineplus">+    if (typeof tag == &quot;function&quot;) {</span>
<a href="#l58.60"></a><span id="l58.60">       [, , length] = tag([], input.substr(next.index));</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineplus">+    }</span>
<a href="#l58.62"></a><span id="l58.62"> </span>
<a href="#l58.63"></a><span id="l58.63">     // Avoid infinite loops.</span>
<a href="#l58.64"></a><span id="l58.64">     length = Math.max(1, length);</span>
<a href="#l58.65"></a><span id="l58.65">     // Skip to after the last match.</span>
<a href="#l58.66"></a><span id="l58.66">     input = input.substr(next.index + length);</span>
<a href="#l58.67"></a><span id="l58.67">   }</span>
<a href="#l58.68"></a><span id="l58.68">   // Append the unmatched bits before returning the output.</span>
<a href="#l58.69"></a><span id="l58.69">   return output + input;</span>
<a href="#l58.70"></a><span id="l58.70"> }</span>
<a href="#l58.71"></a><span id="l58.71"> </span>
<a href="#l58.72"></a><span id="l58.72"> function openStack(aStack) {</span>
<a href="#l58.73"></a><span id="l58.73">   return aStack.map(aTag =&gt; &quot;&lt;&quot; + aTag + &quot;&gt;&quot;).join(&quot;&quot;);</span>
<a href="#l58.74"></a><span id="l58.74"> }</span>
<a href="#l58.75"></a><span id="l58.75"> </span>
<a href="#l58.76"></a><span id="l58.76"> // Close the tags in the opposite order they were opened.</span>
<a href="#l58.77"></a><span id="l58.77"> function closeStack(aStack) {</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineminus">-  return aStack.reverse().map(aTag =&gt; &quot;&lt;/&quot; + aTag.split(&quot; &quot;, 1) + &quot;&gt;&quot;).join(&quot;&quot;);</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineplus">+  return aStack</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineplus">+    .reverse()</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineplus">+    .map(aTag =&gt; &quot;&lt;/&quot; + aTag.split(&quot; &quot;, 1) + &quot;&gt;&quot;)</span>
<a href="#l58.82"></a><span id="l58.82" class="difflineplus">+    .join(&quot;&quot;);</span>
<a href="#l58.83"></a><span id="l58.83"> }</span>
<a href="#l58.84"></a><span id="l58.84"> </span>
<a href="#l58.85"></a><span id="l58.85"> /**</span>
<a href="#l58.86"></a><span id="l58.86">  * Convert a string from CTCP escaped formatting to HTML markup.</span>
<a href="#l58.87"></a><span id="l58.87">  * @param aString the string with CTCP formatting to parse</span>
<a href="#l58.88"></a><span id="l58.88">  * @return The HTML output string</span>
<a href="#l58.89"></a><span id="l58.89">  */</span>
<a href="#l58.90"></a><span id="l58.90"> function ctcpFormatToHTML(aString) {</span>
<a href="#l58.91"></a><span id="l58.91">   let next,</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">-      stack = [],</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineminus">-      input = TXTToHTML(aString),</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineminus">-      output = &quot;&quot;,</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineminus">-      newOutput,</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineminus">-      length;</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineplus">+    stack = [],</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineplus">+    input = TXTToHTML(aString),</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineplus">+    output = &quot;&quot;,</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineplus">+    newOutput,</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineplus">+    length;</span>
<a href="#l58.102"></a><span id="l58.102"> </span>
<a href="#l58.103"></a><span id="l58.103">   while ((next = CTCP_TAGS_EXP.exec(input))) {</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineminus">-    if (next.index &gt; 0)</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineplus">+    if (next.index &gt; 0) {</span>
<a href="#l58.106"></a><span id="l58.106">       output += input.substr(0, next.index);</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineplus">+    }</span>
<a href="#l58.108"></a><span id="l58.108">     length = 1;</span>
<a href="#l58.109"></a><span id="l58.109">     let tag = CTCP_TAGS[input[next.index]];</span>
<a href="#l58.110"></a><span id="l58.110">     if (tag === null) {</span>
<a href="#l58.111"></a><span id="l58.111">       // Clear all formatting.</span>
<a href="#l58.112"></a><span id="l58.112">       output += closeStack(stack);</span>
<a href="#l58.113"></a><span id="l58.113">       stack = [];</span>
<a href="#l58.114"></a><span id="l58.114" class="difflineminus">-    }</span>
<a href="#l58.115"></a><span id="l58.115" class="difflineminus">-    else if (typeof tag == &quot;function&quot;) {</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineplus">+    } else if (typeof tag == &quot;function&quot;) {</span>
<a href="#l58.117"></a><span id="l58.117">       [stack, newOutput, length] = tag(stack, input.substr(next.index));</span>
<a href="#l58.118"></a><span id="l58.118">       output += newOutput;</span>
<a href="#l58.119"></a><span id="l58.119" class="difflineminus">-    }</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineminus">-    else {</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineplus">+    } else {</span>
<a href="#l58.122"></a><span id="l58.122">       let offset = stack.indexOf(tag);</span>
<a href="#l58.123"></a><span id="l58.123">       if (offset == -1) {</span>
<a href="#l58.124"></a><span id="l58.124">         // Tag not found; open new tag.</span>
<a href="#l58.125"></a><span id="l58.125">         output += &quot;&lt;&quot; + tag + &quot;&gt;&quot;;</span>
<a href="#l58.126"></a><span id="l58.126">         stack.push(tag);</span>
<a href="#l58.127"></a><span id="l58.127" class="difflineminus">-      }</span>
<a href="#l58.128"></a><span id="l58.128" class="difflineminus">-      else {</span>
<a href="#l58.129"></a><span id="l58.129" class="difflineplus">+      } else {</span>
<a href="#l58.130"></a><span id="l58.130">         // Tag found; close existing tag (and all tags after it).</span>
<a href="#l58.131"></a><span id="l58.131">         output += closeStack(stack.slice(offset));</span>
<a href="#l58.132"></a><span id="l58.132">         // Reopen the tags that came after it.</span>
<a href="#l58.133"></a><span id="l58.133">         output += openStack(stack.slice(offset + 1));</span>
<a href="#l58.134"></a><span id="l58.134">         // Remove the tag from the stack.</span>
<a href="#l58.135"></a><span id="l58.135">         stack.splice(offset, 1);</span>
<a href="#l58.136"></a><span id="l58.136">       }</span>
<a href="#l58.137"></a><span id="l58.137">     }</span>
<a href="#l58.138"></a><span id="l58.138" class="difflineat">@@ -159,89 +166,100 @@ var M_IRC_COLOR_MAP = {</span>
<a href="#l58.139"></a><span id="l58.139">   &quot;15&quot;: &quot;silver&quot;, // light grey (silver)</span>
<a href="#l58.140"></a><span id="l58.140">   &quot;99&quot;: &quot;transparent&quot;,</span>
<a href="#l58.141"></a><span id="l58.141"> };</span>
<a href="#l58.142"></a><span id="l58.142"> </span>
<a href="#l58.143"></a><span id="l58.143"> function mIRCColoring(aStack, aInput) {</span>
<a href="#l58.144"></a><span id="l58.144">   function getColor(aKey) {</span>
<a href="#l58.145"></a><span id="l58.145">     let key = aKey;</span>
<a href="#l58.146"></a><span id="l58.146">     // Single digit numbers can (must?) be prefixed by a zero.</span>
<a href="#l58.147"></a><span id="l58.147" class="difflineminus">-    if (key.length == 2 &amp;&amp; key[0] == &quot;0&quot;)</span>
<a href="#l58.148"></a><span id="l58.148" class="difflineplus">+    if (key.length == 2 &amp;&amp; key[0] == &quot;0&quot;) {</span>
<a href="#l58.149"></a><span id="l58.149">       key = key[1];</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineplus">+    }</span>
<a href="#l58.151"></a><span id="l58.151"> </span>
<a href="#l58.152"></a><span id="l58.152" class="difflineminus">-    if (M_IRC_COLOR_MAP.hasOwnProperty(key))</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineplus">+    if (M_IRC_COLOR_MAP.hasOwnProperty(key)) {</span>
<a href="#l58.154"></a><span id="l58.154">       return M_IRC_COLOR_MAP[key];</span>
<a href="#l58.155"></a><span id="l58.155" class="difflineplus">+    }</span>
<a href="#l58.156"></a><span id="l58.156"> </span>
<a href="#l58.157"></a><span id="l58.157">     return null;</span>
<a href="#l58.158"></a><span id="l58.158">   }</span>
<a href="#l58.159"></a><span id="l58.159"> </span>
<a href="#l58.160"></a><span id="l58.160">   let matches,</span>
<a href="#l58.161"></a><span id="l58.161" class="difflineminus">-      stack = aStack,</span>
<a href="#l58.162"></a><span id="l58.162" class="difflineminus">-      input = aInput,</span>
<a href="#l58.163"></a><span id="l58.163" class="difflineminus">-      output = &quot;&quot;,</span>
<a href="#l58.164"></a><span id="l58.164" class="difflineminus">-      length = 1;</span>
<a href="#l58.165"></a><span id="l58.165" class="difflineplus">+    stack = aStack,</span>
<a href="#l58.166"></a><span id="l58.166" class="difflineplus">+    input = aInput,</span>
<a href="#l58.167"></a><span id="l58.167" class="difflineplus">+    output = &quot;&quot;,</span>
<a href="#l58.168"></a><span id="l58.168" class="difflineplus">+    length = 1;</span>
<a href="#l58.169"></a><span id="l58.169"> </span>
<a href="#l58.170"></a><span id="l58.170">   if ((matches = M_IRC_COLORS_EXP.exec(input))) {</span>
<a href="#l58.171"></a><span id="l58.171">     let format = [&quot;font&quot;];</span>
<a href="#l58.172"></a><span id="l58.172"> </span>
<a href="#l58.173"></a><span id="l58.173">     // Only \003 was found with no formatting digits after it, close the</span>
<a href="#l58.174"></a><span id="l58.174">     // first open font tag.</span>
<a href="#l58.175"></a><span id="l58.175">     if (!matches[1]) {</span>
<a href="#l58.176"></a><span id="l58.176">       // Find the first font tag.</span>
<a href="#l58.177"></a><span id="l58.177" class="difflineminus">-      let offset = stack.map(aTag =&gt; aTag.indexOf(&quot;font&quot;) === 0)</span>
<a href="#l58.178"></a><span id="l58.178" class="difflineminus">-                        .indexOf(true);</span>
<a href="#l58.179"></a><span id="l58.179" class="difflineplus">+      let offset = stack.map(aTag =&gt; aTag.indexOf(&quot;font&quot;) === 0).indexOf(true);</span>
<a href="#l58.180"></a><span id="l58.180"> </span>
<a href="#l58.181"></a><span id="l58.181">       // Close all tags from the first font tag on.</span>
<a href="#l58.182"></a><span id="l58.182">       output = closeStack(stack.slice(offset));</span>
<a href="#l58.183"></a><span id="l58.183">       // Remove the font tags from the stack.</span>
<a href="#l58.184"></a><span id="l58.184">       stack = stack.filter(aTag =&gt; aTag.indexOf(&quot;font&quot;));</span>
<a href="#l58.185"></a><span id="l58.185">       // Reopen the other tags.</span>
<a href="#l58.186"></a><span id="l58.186">       output += openStack(stack.slice(offset));</span>
<a href="#l58.187"></a><span id="l58.187" class="difflineminus">-    }</span>
<a href="#l58.188"></a><span id="l58.188" class="difflineminus">-    else {</span>
<a href="#l58.189"></a><span id="l58.189" class="difflineplus">+    } else {</span>
<a href="#l58.190"></a><span id="l58.190">       // Otherwise we have a match and are setting new colors.</span>
<a href="#l58.191"></a><span id="l58.191">       // The foreground color.</span>
<a href="#l58.192"></a><span id="l58.192">       let color = getColor(matches[1]);</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineminus">-      if (color)</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineminus">-        format.push(&quot;color=\&quot;&quot; + color + &quot;\&quot;&quot;);</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineplus">+      if (color) {</span>
<a href="#l58.196"></a><span id="l58.196" class="difflineplus">+        format.push('color=&quot;' + color + '&quot;');</span>
<a href="#l58.197"></a><span id="l58.197" class="difflineplus">+      }</span>
<a href="#l58.198"></a><span id="l58.198"> </span>
<a href="#l58.199"></a><span id="l58.199">       // The background color.</span>
<a href="#l58.200"></a><span id="l58.200">       if (matches[2]) {</span>
<a href="#l58.201"></a><span id="l58.201">         let color = getColor(matches[2]);</span>
<a href="#l58.202"></a><span id="l58.202" class="difflineminus">-        if (color)</span>
<a href="#l58.203"></a><span id="l58.203" class="difflineminus">-          format.push(&quot;background=\&quot;&quot; + color + &quot;\&quot;&quot;);</span>
<a href="#l58.204"></a><span id="l58.204" class="difflineplus">+        if (color) {</span>
<a href="#l58.205"></a><span id="l58.205" class="difflineplus">+          format.push('background=&quot;' + color + '&quot;');</span>
<a href="#l58.206"></a><span id="l58.206" class="difflineplus">+        }</span>
<a href="#l58.207"></a><span id="l58.207">       }</span>
<a href="#l58.208"></a><span id="l58.208"> </span>
<a href="#l58.209"></a><span id="l58.209">       if (format.length &gt; 1) {</span>
<a href="#l58.210"></a><span id="l58.210">         let tag = format.join(&quot; &quot;);</span>
<a href="#l58.211"></a><span id="l58.211">         output = &quot;&lt;&quot; + tag + &quot;&gt;&quot;;</span>
<a href="#l58.212"></a><span id="l58.212">         stack.push(tag);</span>
<a href="#l58.213"></a><span id="l58.213">         length = matches[0].length;</span>
<a href="#l58.214"></a><span id="l58.214">       }</span>
<a href="#l58.215"></a><span id="l58.215">     }</span>
<a href="#l58.216"></a><span id="l58.216">   }</span>
<a href="#l58.217"></a><span id="l58.217"> </span>
<a href="#l58.218"></a><span id="l58.218">   return [stack, output, length];</span>
<a href="#l58.219"></a><span id="l58.219"> }</span>
<a href="#l58.220"></a><span id="l58.220"> </span>
<a href="#l58.221"></a><span id="l58.221"> // Print an error message into a conversation, optionally mark the conversation</span>
<a href="#l58.222"></a><span id="l58.222"> // as not joined and/or not rejoinable.</span>
<a href="#l58.223"></a><span id="l58.223" class="difflineminus">-function conversationErrorMessage(aAccount, aMessage, aError,</span>
<a href="#l58.224"></a><span id="l58.224" class="difflineminus">-                                  aJoinFailed = false, aRejoinable = true) {</span>
<a href="#l58.225"></a><span id="l58.225" class="difflineplus">+function conversationErrorMessage(</span>
<a href="#l58.226"></a><span id="l58.226" class="difflineplus">+  aAccount,</span>
<a href="#l58.227"></a><span id="l58.227" class="difflineplus">+  aMessage,</span>
<a href="#l58.228"></a><span id="l58.228" class="difflineplus">+  aError,</span>
<a href="#l58.229"></a><span id="l58.229" class="difflineplus">+  aJoinFailed = false,</span>
<a href="#l58.230"></a><span id="l58.230" class="difflineplus">+  aRejoinable = true</span>
<a href="#l58.231"></a><span id="l58.231" class="difflineplus">+) {</span>
<a href="#l58.232"></a><span id="l58.232">   let conv = aAccount.getConversation(aMessage.params[1]);</span>
<a href="#l58.233"></a><span id="l58.233" class="difflineminus">-  conv.writeMessage(aMessage.origin, _(aError, aMessage.params[1],</span>
<a href="#l58.234"></a><span id="l58.234" class="difflineminus">-                                       aMessage.params[2] || undefined),</span>
<a href="#l58.235"></a><span id="l58.235" class="difflineminus">-                    {error: true, system: true});</span>
<a href="#l58.236"></a><span id="l58.236" class="difflineplus">+  conv.writeMessage(</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineplus">+    aMessage.origin,</span>
<a href="#l58.238"></a><span id="l58.238" class="difflineplus">+    _(aError, aMessage.params[1], aMessage.params[2] || undefined),</span>
<a href="#l58.239"></a><span id="l58.239" class="difflineplus">+    { error: true, system: true }</span>
<a href="#l58.240"></a><span id="l58.240" class="difflineplus">+  );</span>
<a href="#l58.241"></a><span id="l58.241">   delete conv._pendingMessage;</span>
<a href="#l58.242"></a><span id="l58.242"> </span>
<a href="#l58.243"></a><span id="l58.243">   // Channels have a couple extra things that can be done to them.</span>
<a href="#l58.244"></a><span id="l58.244">   if (aAccount.isMUCName(aMessage.params[1])) {</span>
<a href="#l58.245"></a><span id="l58.245">     // If a value for joining is explicitly given, mark it.</span>
<a href="#l58.246"></a><span id="l58.246" class="difflineminus">-    if (aJoinFailed)</span>
<a href="#l58.247"></a><span id="l58.247" class="difflineplus">+    if (aJoinFailed) {</span>
<a href="#l58.248"></a><span id="l58.248">       conv.joining = false;</span>
<a href="#l58.249"></a><span id="l58.249" class="difflineplus">+    }</span>
<a href="#l58.250"></a><span id="l58.250">     // If the conversation cannot be rejoined automatically, delete</span>
<a href="#l58.251"></a><span id="l58.251">     // chatRoomFields.</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineminus">-    if (!aRejoinable)</span>
<a href="#l58.253"></a><span id="l58.253" class="difflineplus">+    if (!aRejoinable) {</span>
<a href="#l58.254"></a><span id="l58.254">       delete conv.chatRoomFields;</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineplus">+    }</span>
<a href="#l58.256"></a><span id="l58.256">   }</span>
<a href="#l58.257"></a><span id="l58.257"> </span>
<a href="#l58.258"></a><span id="l58.258">   return true;</span>
<a href="#l58.259"></a><span id="l58.259"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -7,80 +7,99 @@</span>
<a href="#l59.4"></a><span id="l59.4">  * (compared to ISON) keep track of a user's status.</span>
<a href="#l59.5"></a><span id="l59.5">  *</span>
<a href="#l59.6"></a><span id="l59.6">  *   MONITOR (supported by Charybdis)</span>
<a href="#l59.7"></a><span id="l59.7">  *     https://github.com/atheme/charybdis/blob/master/doc/monitor.txt</span>
<a href="#l59.8"></a><span id="l59.8">  *   WATCH (supported by Bahamut and UnrealIRCd)</span>
<a href="#l59.9"></a><span id="l59.9">  *     http://www.stack.nl/~jilles/cgi-bin/hgwebdir.cgi/irc-documentation-jilles/raw-file/tip/reference/draft-meglio-irc-watch-00.txt</span>
<a href="#l59.10"></a><span id="l59.10">  */</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;ircWATCH&quot;, &quot;isupportWATCH&quot;, &quot;ircMONITOR&quot;,</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-                          &quot;isupportMONITOR&quot;];</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+this.EXPORTED_SYMBOLS = [</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+  &quot;ircWATCH&quot;,</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+  &quot;isupportWATCH&quot;,</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+  &quot;ircMONITOR&quot;,</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+  &quot;isupportMONITOR&quot;,</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+];</span>
<a href="#l59.20"></a><span id="l59.20"> </span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-var {clearTimeout} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineminus">-const {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineplus">+var { clearTimeout } = ChromeUtils.import(</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineplus">+);</span>
<a href="#l59.26"></a><span id="l59.26" class="difflineplus">+const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineplus">+  &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineplus">+);</span>
<a href="#l59.29"></a><span id="l59.29"> </span>
<a href="#l59.30"></a><span id="l59.30"> function setStatus(aAccount, aNick, aStatus) {</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineminus">-  if (!aAccount.watchEnabled &amp;&amp; !aAccount.monitorEnabled)</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineplus">+  if (!aAccount.watchEnabled &amp;&amp; !aAccount.monitorEnabled) {</span>
<a href="#l59.33"></a><span id="l59.33">     return false;</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+  }</span>
<a href="#l59.35"></a><span id="l59.35"> </span>
<a href="#l59.36"></a><span id="l59.36">   if (aStatus == &quot;AWAY&quot;) {</span>
<a href="#l59.37"></a><span id="l59.37">     // We need to request the away message.</span>
<a href="#l59.38"></a><span id="l59.38">     aAccount.requestCurrentWhois(aNick);</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineminus">-  }</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineminus">-  else {</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineplus">+  } else {</span>
<a href="#l59.42"></a><span id="l59.42">     // Clear the WHOIS information.</span>
<a href="#l59.43"></a><span id="l59.43">     aAccount.removeBuddyInfo(aNick);</span>
<a href="#l59.44"></a><span id="l59.44">   }</span>
<a href="#l59.45"></a><span id="l59.45"> </span>
<a href="#l59.46"></a><span id="l59.46">   let buddy = aAccount.buddies.get(aNick);</span>
<a href="#l59.47"></a><span id="l59.47" class="difflineminus">-  if (!buddy)</span>
<a href="#l59.48"></a><span id="l59.48" class="difflineplus">+  if (!buddy) {</span>
<a href="#l59.49"></a><span id="l59.49">     return false;</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineplus">+  }</span>
<a href="#l59.51"></a><span id="l59.51">   buddy.setStatus(Ci.imIStatusInfo[&quot;STATUS_&quot; + aStatus], &quot;&quot;);</span>
<a href="#l59.52"></a><span id="l59.52">   return true;</span>
<a href="#l59.53"></a><span id="l59.53"> }</span>
<a href="#l59.54"></a><span id="l59.54"> </span>
<a href="#l59.55"></a><span id="l59.55"> function trackBuddyWatch(aNicks) {</span>
<a href="#l59.56"></a><span id="l59.56">   // aNicks is an array when WATCH is initialized, and a single nick</span>
<a href="#l59.57"></a><span id="l59.57">   // in all later calls.</span>
<a href="#l59.58"></a><span id="l59.58">   if (!Array.isArray(aNicks)) {</span>
<a href="#l59.59"></a><span id="l59.59">     // We update the trackQueue if an individual nick is being added,</span>
<a href="#l59.60"></a><span id="l59.60">     // so the nick will also be monitored after a reconnect.</span>
<a href="#l59.61"></a><span id="l59.61">     Object.getPrototypeOf(this).trackBuddy.call(this, aNicks);</span>
<a href="#l59.62"></a><span id="l59.62">     aNicks = [aNicks];</span>
<a href="#l59.63"></a><span id="l59.63">   }</span>
<a href="#l59.64"></a><span id="l59.64"> </span>
<a href="#l59.65"></a><span id="l59.65">   let nicks = aNicks.map(aNick =&gt; &quot;+&quot; + aNick);</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineminus">-  if (!nicks.length)</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineplus">+  if (!nicks.length) {</span>
<a href="#l59.68"></a><span id="l59.68">     return;</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineplus">+  }</span>
<a href="#l59.70"></a><span id="l59.70"> </span>
<a href="#l59.71"></a><span id="l59.71">   let newWatchLength = this.watchLength + nicks.length;</span>
<a href="#l59.72"></a><span id="l59.72">   if (newWatchLength &gt; this.maxWatchLength) {</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineminus">-    this.WARN(&quot;Attempting to WATCH &quot; + newWatchLength +</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineminus">-              &quot; nicks; maximum size is &quot; + this.maxWatchLength + &quot;.&quot;);</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineplus">+    this.WARN(</span>
<a href="#l59.76"></a><span id="l59.76" class="difflineplus">+      &quot;Attempting to WATCH &quot; +</span>
<a href="#l59.77"></a><span id="l59.77" class="difflineplus">+        newWatchLength +</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+        &quot; nicks; maximum size is &quot; +</span>
<a href="#l59.79"></a><span id="l59.79" class="difflineplus">+        this.maxWatchLength +</span>
<a href="#l59.80"></a><span id="l59.80" class="difflineplus">+        &quot;.&quot;</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineplus">+    );</span>
<a href="#l59.82"></a><span id="l59.82">     // TODO We should trim the list and add the extra users to an ISON queue,</span>
<a href="#l59.83"></a><span id="l59.83">     // but that's not currently implemented, so just hope the server doesn't</span>
<a href="#l59.84"></a><span id="l59.84">     // enforce it's own limit.</span>
<a href="#l59.85"></a><span id="l59.85">   }</span>
<a href="#l59.86"></a><span id="l59.86">   this.watchLength = newWatchLength;</span>
<a href="#l59.87"></a><span id="l59.87"> </span>
<a href="#l59.88"></a><span id="l59.88">   // Watch away as well as online.</span>
<a href="#l59.89"></a><span id="l59.89">   let params = [];</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineminus">-  if (this.watchAwayEnabled)</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+  if (this.watchAwayEnabled) {</span>
<a href="#l59.92"></a><span id="l59.92">     params.push(&quot;A&quot;);</span>
<a href="#l59.93"></a><span id="l59.93" class="difflineminus">-  let maxLength = this.maxMessageLength - 2 -</span>
<a href="#l59.94"></a><span id="l59.94" class="difflineminus">-                  this.countBytes(this.buildMessage(&quot;WATCH&quot;, params));</span>
<a href="#l59.95"></a><span id="l59.95" class="difflineplus">+  }</span>
<a href="#l59.96"></a><span id="l59.96" class="difflineplus">+  let maxLength =</span>
<a href="#l59.97"></a><span id="l59.97" class="difflineplus">+    this.maxMessageLength -</span>
<a href="#l59.98"></a><span id="l59.98" class="difflineplus">+    2 -</span>
<a href="#l59.99"></a><span id="l59.99" class="difflineplus">+    this.countBytes(this.buildMessage(&quot;WATCH&quot;, params));</span>
<a href="#l59.100"></a><span id="l59.100">   for (let nick of nicks) {</span>
<a href="#l59.101"></a><span id="l59.101">     if (this.countBytes(params + &quot; &quot; + nick) &gt;= maxLength) {</span>
<a href="#l59.102"></a><span id="l59.102">       // If the message would be too long, first send this message.</span>
<a href="#l59.103"></a><span id="l59.103">       this.sendMessage(&quot;WATCH&quot;, params);</span>
<a href="#l59.104"></a><span id="l59.104">       // Reset for the next message.</span>
<a href="#l59.105"></a><span id="l59.105">       params = [];</span>
<a href="#l59.106"></a><span id="l59.106" class="difflineminus">-      if (this.watchAwayEnabled)</span>
<a href="#l59.107"></a><span id="l59.107" class="difflineplus">+      if (this.watchAwayEnabled) {</span>
<a href="#l59.108"></a><span id="l59.108">         params.push(&quot;A&quot;);</span>
<a href="#l59.109"></a><span id="l59.109" class="difflineplus">+      }</span>
<a href="#l59.110"></a><span id="l59.110">     }</span>
<a href="#l59.111"></a><span id="l59.111">     params.push(nick);</span>
<a href="#l59.112"></a><span id="l59.112">   }</span>
<a href="#l59.113"></a><span id="l59.113">   this.sendMessage(&quot;WATCH&quot;, params);</span>
<a href="#l59.114"></a><span id="l59.114"> }</span>
<a href="#l59.115"></a><span id="l59.115"> function untrackBuddyWatch(aNick) {</span>
<a href="#l59.116"></a><span id="l59.116">   --this.watchLength;</span>
<a href="#l59.117"></a><span id="l59.117">   this.sendMessage(&quot;WATCH&quot;, &quot;-&quot; + aNick);</span>
<a href="#l59.118"></a><span id="l59.118" class="difflineat">@@ -89,64 +108,69 @@ function untrackBuddyWatch(aNick) {</span>
<a href="#l59.119"></a><span id="l59.119"> </span>
<a href="#l59.120"></a><span id="l59.120"> var isupportWATCH = {</span>
<a href="#l59.121"></a><span id="l59.121">   name: &quot;WATCH&quot;,</span>
<a href="#l59.122"></a><span id="l59.122">   // Slightly above default ISUPPORT priority.</span>
<a href="#l59.123"></a><span id="l59.123">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l59.124"></a><span id="l59.124">   isEnabled: () =&gt; true,</span>
<a href="#l59.125"></a><span id="l59.125"> </span>
<a href="#l59.126"></a><span id="l59.126">   commands: {</span>
<a href="#l59.127"></a><span id="l59.127" class="difflineminus">-    &quot;WATCH&quot;: function(aMessage) {</span>
<a href="#l59.128"></a><span id="l59.128" class="difflineminus">-      if (!aMessage.isupport.useDefault)</span>
<a href="#l59.129"></a><span id="l59.129" class="difflineplus">+    WATCH(aMessage) {</span>
<a href="#l59.130"></a><span id="l59.130" class="difflineplus">+      if (!aMessage.isupport.useDefault) {</span>
<a href="#l59.131"></a><span id="l59.131">         this.maxWatchLength = 128;</span>
<a href="#l59.132"></a><span id="l59.132" class="difflineminus">-      else {</span>
<a href="#l59.133"></a><span id="l59.133" class="difflineplus">+      } else {</span>
<a href="#l59.134"></a><span id="l59.134">         let size = parseInt(aMessage.isupport.value, 10);</span>
<a href="#l59.135"></a><span id="l59.135" class="difflineminus">-        if (isNaN(size))</span>
<a href="#l59.136"></a><span id="l59.136" class="difflineplus">+        if (isNaN(size)) {</span>
<a href="#l59.137"></a><span id="l59.137">           return false;</span>
<a href="#l59.138"></a><span id="l59.138" class="difflineplus">+        }</span>
<a href="#l59.139"></a><span id="l59.139">         this.maxWatchLength = size;</span>
<a href="#l59.140"></a><span id="l59.140">       }</span>
<a href="#l59.141"></a><span id="l59.141"> </span>
<a href="#l59.142"></a><span id="l59.142">       this.watchEnabled = true;</span>
<a href="#l59.143"></a><span id="l59.143"> </span>
<a href="#l59.144"></a><span id="l59.144">       // Clear our watchlist in case there is garbage in it.</span>
<a href="#l59.145"></a><span id="l59.145">       this.sendMessage(&quot;WATCH&quot;, &quot;C&quot;);</span>
<a href="#l59.146"></a><span id="l59.146">       this.watchLength = 0;</span>
<a href="#l59.147"></a><span id="l59.147"> </span>
<a href="#l59.148"></a><span id="l59.148">       // Kill the ISON polling loop.</span>
<a href="#l59.149"></a><span id="l59.149">       clearTimeout(this._isOnTimer);</span>
<a href="#l59.150"></a><span id="l59.150"> </span>
<a href="#l59.151"></a><span id="l59.151">       return true;</span>
<a href="#l59.152"></a><span id="l59.152">     },</span>
<a href="#l59.153"></a><span id="l59.153"> </span>
<a href="#l59.154"></a><span id="l59.154" class="difflineminus">-    &quot;WATCHOPTS&quot;: function(aMessage) {</span>
<a href="#l59.155"></a><span id="l59.155" class="difflineplus">+    WATCHOPTS(aMessage) {</span>
<a href="#l59.156"></a><span id="l59.156">       const watchOptToOption = {</span>
<a href="#l59.157"></a><span id="l59.157" class="difflineminus">-        &quot;H&quot;: &quot;watchMasksEnabled&quot;,</span>
<a href="#l59.158"></a><span id="l59.158" class="difflineminus">-        &quot;A&quot;: &quot;watchAwayEnabled&quot;,</span>
<a href="#l59.159"></a><span id="l59.159" class="difflineplus">+        H: &quot;watchMasksEnabled&quot;,</span>
<a href="#l59.160"></a><span id="l59.160" class="difflineplus">+        A: &quot;watchAwayEnabled&quot;,</span>
<a href="#l59.161"></a><span id="l59.161">       };</span>
<a href="#l59.162"></a><span id="l59.162"> </span>
<a href="#l59.163"></a><span id="l59.163">       // For each option, mark it as supported.</span>
<a href="#l59.164"></a><span id="l59.164">       aMessage.isupport.value.split(&quot;&quot;).forEach(function(aWatchOpt) {</span>
<a href="#l59.165"></a><span id="l59.165" class="difflineminus">-        if (watchOptToOption.hasOwnProperty(aWatchOpt))</span>
<a href="#l59.166"></a><span id="l59.166" class="difflineplus">+        if (watchOptToOption.hasOwnProperty(aWatchOpt)) {</span>
<a href="#l59.167"></a><span id="l59.167">           this[watchOptToOption[aWatchOpt]] = true;</span>
<a href="#l59.168"></a><span id="l59.168" class="difflineplus">+        }</span>
<a href="#l59.169"></a><span id="l59.169">       }, this);</span>
<a href="#l59.170"></a><span id="l59.170"> </span>
<a href="#l59.171"></a><span id="l59.171">       return true;</span>
<a href="#l59.172"></a><span id="l59.172">     },</span>
<a href="#l59.173"></a><span id="l59.173">   },</span>
<a href="#l59.174"></a><span id="l59.174"> };</span>
<a href="#l59.175"></a><span id="l59.175"> </span>
<a href="#l59.176"></a><span id="l59.176"> var ircWATCH = {</span>
<a href="#l59.177"></a><span id="l59.177">   name: &quot;WATCH&quot;,</span>
<a href="#l59.178"></a><span id="l59.178">   // Slightly above default IRC priority.</span>
<a href="#l59.179"></a><span id="l59.179">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l59.180"></a><span id="l59.180">   // Use WATCH if it is supported.</span>
<a href="#l59.181"></a><span id="l59.181" class="difflineminus">-  isEnabled() { return !!this.watchEnabled; },</span>
<a href="#l59.182"></a><span id="l59.182" class="difflineplus">+  isEnabled() {</span>
<a href="#l59.183"></a><span id="l59.183" class="difflineplus">+    return !!this.watchEnabled;</span>
<a href="#l59.184"></a><span id="l59.184" class="difflineplus">+  },</span>
<a href="#l59.185"></a><span id="l59.185"> </span>
<a href="#l59.186"></a><span id="l59.186">   commands: {</span>
<a href="#l59.187"></a><span id="l59.187" class="difflineminus">-    &quot;251&quot;: function(aMessage) { // RPL_LUSERCLIENT</span>
<a href="#l59.188"></a><span id="l59.188" class="difflineplus">+    &quot;251&quot;: function(aMessage) {</span>
<a href="#l59.189"></a><span id="l59.189" class="difflineplus">+      // RPL_LUSERCLIENT</span>
<a href="#l59.190"></a><span id="l59.190">       // &quot;:There are &lt;integer&gt; users and &lt;integer&gt; services on &lt;integer&gt; servers&quot;</span>
<a href="#l59.191"></a><span id="l59.191">       // Assume that this will always be sent after the 005 handler on</span>
<a href="#l59.192"></a><span id="l59.192">       // connection registration. If WATCH is enabled, then set the new function</span>
<a href="#l59.193"></a><span id="l59.193">       // to keep track of nicks and send the messages to watch the nicks.</span>
<a href="#l59.194"></a><span id="l59.194"> </span>
<a href="#l59.195"></a><span id="l59.195">       // Ensure that any new buddies are set to be watched, and removed buddies</span>
<a href="#l59.196"></a><span id="l59.196">       // are no longer watched.</span>
<a href="#l59.197"></a><span id="l59.197">       this.trackBuddy = trackBuddyWatch;</span>
<a href="#l59.198"></a><span id="l59.198" class="difflineat">@@ -155,131 +179,158 @@ var ircWATCH = {</span>
<a href="#l59.199"></a><span id="l59.199">       // Build the watchlist from the current list of nicks.</span>
<a href="#l59.200"></a><span id="l59.200">       this.trackBuddy(this.trackQueue);</span>
<a href="#l59.201"></a><span id="l59.201"> </span>
<a href="#l59.202"></a><span id="l59.202">       // Fall through to other handlers since we're only using this as an entry</span>
<a href="#l59.203"></a><span id="l59.203">       // point and not actually handling the message.</span>
<a href="#l59.204"></a><span id="l59.204">       return false;</span>
<a href="#l59.205"></a><span id="l59.205">     },</span>
<a href="#l59.206"></a><span id="l59.206"> </span>
<a href="#l59.207"></a><span id="l59.207" class="difflineminus">-    &quot;301&quot;: function(aMessage) { // RPL_AWAY</span>
<a href="#l59.208"></a><span id="l59.208" class="difflineplus">+    &quot;301&quot;: function(aMessage) {</span>
<a href="#l59.209"></a><span id="l59.209" class="difflineplus">+      // RPL_AWAY</span>
<a href="#l59.210"></a><span id="l59.210">       // &lt;nick&gt; :&lt;away message&gt;</span>
<a href="#l59.211"></a><span id="l59.211">       // Set the received away message.</span>
<a href="#l59.212"></a><span id="l59.212">       let buddy = this.buddies.get(aMessage.params[1]);</span>
<a href="#l59.213"></a><span id="l59.213" class="difflineminus">-      if (buddy)</span>
<a href="#l59.214"></a><span id="l59.214" class="difflineplus">+      if (buddy) {</span>
<a href="#l59.215"></a><span id="l59.215">         buddy.setStatus(Ci.imIStatusInfo.STATUS_AWAY, aMessage.params[2]);</span>
<a href="#l59.216"></a><span id="l59.216" class="difflineplus">+      }</span>
<a href="#l59.217"></a><span id="l59.217"> </span>
<a href="#l59.218"></a><span id="l59.218">       // Fall through to the other implementations after setting the status</span>
<a href="#l59.219"></a><span id="l59.219">       // message.</span>
<a href="#l59.220"></a><span id="l59.220">       return false;</span>
<a href="#l59.221"></a><span id="l59.221">     },</span>
<a href="#l59.222"></a><span id="l59.222"> </span>
<a href="#l59.223"></a><span id="l59.223" class="difflineminus">-    &quot;303&quot;: function(aMessage) { // RPL_ISON</span>
<a href="#l59.224"></a><span id="l59.224" class="difflineplus">+    &quot;303&quot;: function(aMessage) {</span>
<a href="#l59.225"></a><span id="l59.225" class="difflineplus">+      // RPL_ISON</span>
<a href="#l59.226"></a><span id="l59.226">       // :*1&lt;nick&gt; *( &quot; &quot; &lt;nick&gt; )</span>
<a href="#l59.227"></a><span id="l59.227">       // We don't want ircBase to interfere with us, so override the ISON</span>
<a href="#l59.228"></a><span id="l59.228">       // handler to do nothing.</span>
<a href="#l59.229"></a><span id="l59.229">       return true;</span>
<a href="#l59.230"></a><span id="l59.230">     },</span>
<a href="#l59.231"></a><span id="l59.231"> </span>
<a href="#l59.232"></a><span id="l59.232" class="difflineminus">-    &quot;512&quot;: function(aMessage) { // ERR_TOOMANYWATCH</span>
<a href="#l59.233"></a><span id="l59.233" class="difflineplus">+    &quot;512&quot;: function(aMessage) {</span>
<a href="#l59.234"></a><span id="l59.234" class="difflineplus">+      // ERR_TOOMANYWATCH</span>
<a href="#l59.235"></a><span id="l59.235">       // Maximum size for WATCH-list is &lt;watchlimit&gt; entries</span>
<a href="#l59.236"></a><span id="l59.236" class="difflineminus">-      this.ERROR(&quot;Maximum size for WATCH list exceeded (&quot; + this.watchLength +</span>
<a href="#l59.237"></a><span id="l59.237" class="difflineminus">-                 &quot;).&quot;);</span>
<a href="#l59.238"></a><span id="l59.238" class="difflineplus">+      this.ERROR(</span>
<a href="#l59.239"></a><span id="l59.239" class="difflineplus">+        &quot;Maximum size for WATCH list exceeded (&quot; + this.watchLength + &quot;).&quot;</span>
<a href="#l59.240"></a><span id="l59.240" class="difflineplus">+      );</span>
<a href="#l59.241"></a><span id="l59.241">       return true;</span>
<a href="#l59.242"></a><span id="l59.242">     },</span>
<a href="#l59.243"></a><span id="l59.243"> </span>
<a href="#l59.244"></a><span id="l59.244" class="difflineminus">-    &quot;597&quot;: function(aMessage) { // RPL_REAWAY</span>
<a href="#l59.245"></a><span id="l59.245" class="difflineplus">+    &quot;597&quot;: function(aMessage) {</span>
<a href="#l59.246"></a><span id="l59.246" class="difflineplus">+      // RPL_REAWAY</span>
<a href="#l59.247"></a><span id="l59.247">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;awaysince&gt; :&lt;away reason&gt;</span>
<a href="#l59.248"></a><span id="l59.248">       return setStatus(this, aMessage.params[1], &quot;AWAY&quot;);</span>
<a href="#l59.249"></a><span id="l59.249">     },</span>
<a href="#l59.250"></a><span id="l59.250"> </span>
<a href="#l59.251"></a><span id="l59.251" class="difflineminus">-    &quot;598&quot;: function(aMessage) { // RPL_GONEAWAY</span>
<a href="#l59.252"></a><span id="l59.252" class="difflineplus">+    &quot;598&quot;: function(aMessage) {</span>
<a href="#l59.253"></a><span id="l59.253" class="difflineplus">+      // RPL_GONEAWAY</span>
<a href="#l59.254"></a><span id="l59.254">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;awaysince&gt; :&lt;away reason&gt;</span>
<a href="#l59.255"></a><span id="l59.255">       // We use a negative index as inspircd versions &lt; 2.0.18 don't send</span>
<a href="#l59.256"></a><span id="l59.256">       // the user's nick as the first parameter (see bug 1078223).</span>
<a href="#l59.257"></a><span id="l59.257" class="difflineminus">-      return setStatus(this, aMessage.params[aMessage.params.length - 5], &quot;AWAY&quot;);</span>
<a href="#l59.258"></a><span id="l59.258" class="difflineplus">+      return setStatus(</span>
<a href="#l59.259"></a><span id="l59.259" class="difflineplus">+        this,</span>
<a href="#l59.260"></a><span id="l59.260" class="difflineplus">+        aMessage.params[aMessage.params.length - 5],</span>
<a href="#l59.261"></a><span id="l59.261" class="difflineplus">+        &quot;AWAY&quot;</span>
<a href="#l59.262"></a><span id="l59.262" class="difflineplus">+      );</span>
<a href="#l59.263"></a><span id="l59.263">     },</span>
<a href="#l59.264"></a><span id="l59.264"> </span>
<a href="#l59.265"></a><span id="l59.265" class="difflineminus">-    &quot;599&quot;: function(aMessage) { // RPL_NOTAWAY</span>
<a href="#l59.266"></a><span id="l59.266" class="difflineplus">+    &quot;599&quot;: function(aMessage) {</span>
<a href="#l59.267"></a><span id="l59.267" class="difflineplus">+      // RPL_NOTAWAY</span>
<a href="#l59.268"></a><span id="l59.268">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;awaysince&gt; :is no longer away</span>
<a href="#l59.269"></a><span id="l59.269">       // We use a negative index as inspircd versions &lt; 2.0.18 don't send</span>
<a href="#l59.270"></a><span id="l59.270">       // the user's nick as the first parameter (see bug 1078223).</span>
<a href="#l59.271"></a><span id="l59.271" class="difflineminus">-      return setStatus(this, aMessage.params[aMessage.params.length - 5], &quot;AVAILABLE&quot;);</span>
<a href="#l59.272"></a><span id="l59.272" class="difflineplus">+      return setStatus(</span>
<a href="#l59.273"></a><span id="l59.273" class="difflineplus">+        this,</span>
<a href="#l59.274"></a><span id="l59.274" class="difflineplus">+        aMessage.params[aMessage.params.length - 5],</span>
<a href="#l59.275"></a><span id="l59.275" class="difflineplus">+        &quot;AVAILABLE&quot;</span>
<a href="#l59.276"></a><span id="l59.276" class="difflineplus">+      );</span>
<a href="#l59.277"></a><span id="l59.277">     },</span>
<a href="#l59.278"></a><span id="l59.278"> </span>
<a href="#l59.279"></a><span id="l59.279" class="difflineminus">-    &quot;600&quot;: function(aMessage) { // RPL_LOGON</span>
<a href="#l59.280"></a><span id="l59.280" class="difflineplus">+    &quot;600&quot;: function(aMessage) {</span>
<a href="#l59.281"></a><span id="l59.281" class="difflineplus">+      // RPL_LOGON</span>
<a href="#l59.282"></a><span id="l59.282">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;signontime&gt; :logged on</span>
<a href="#l59.283"></a><span id="l59.283">       return setStatus(this, aMessage.params[1], &quot;AVAILABLE&quot;);</span>
<a href="#l59.284"></a><span id="l59.284">     },</span>
<a href="#l59.285"></a><span id="l59.285"> </span>
<a href="#l59.286"></a><span id="l59.286" class="difflineminus">-    &quot;601&quot;: function(aMessage) { // RPL_LOGOFF</span>
<a href="#l59.287"></a><span id="l59.287" class="difflineplus">+    &quot;601&quot;: function(aMessage) {</span>
<a href="#l59.288"></a><span id="l59.288" class="difflineplus">+      // RPL_LOGOFF</span>
<a href="#l59.289"></a><span id="l59.289">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;lastnickchange&gt; :logged off</span>
<a href="#l59.290"></a><span id="l59.290">       return setStatus(this, aMessage.params[1], &quot;OFFLINE&quot;);</span>
<a href="#l59.291"></a><span id="l59.291">     },</span>
<a href="#l59.292"></a><span id="l59.292"> </span>
<a href="#l59.293"></a><span id="l59.293" class="difflineminus">-    &quot;602&quot;: function(aMessage) { // RPL_WATCHOFF</span>
<a href="#l59.294"></a><span id="l59.294" class="difflineplus">+    &quot;602&quot;: function(aMessage) {</span>
<a href="#l59.295"></a><span id="l59.295" class="difflineplus">+      // RPL_WATCHOFF</span>
<a href="#l59.296"></a><span id="l59.296">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;lastnickchange&gt; :stopped watching</span>
<a href="#l59.297"></a><span id="l59.297">       return true;</span>
<a href="#l59.298"></a><span id="l59.298">     },</span>
<a href="#l59.299"></a><span id="l59.299"> </span>
<a href="#l59.300"></a><span id="l59.300" class="difflineminus">-    &quot;603&quot;: function(aMessage) { // RPL_WATCHSTAT</span>
<a href="#l59.301"></a><span id="l59.301" class="difflineplus">+    &quot;603&quot;: function(aMessage) {</span>
<a href="#l59.302"></a><span id="l59.302" class="difflineplus">+      // RPL_WATCHSTAT</span>
<a href="#l59.303"></a><span id="l59.303">       // You have &lt;entrycount&gt; and are on &lt;onlistcount&gt; WATCH entries</span>
<a href="#l59.304"></a><span id="l59.304">       // TODO I don't think we really need to care about this.</span>
<a href="#l59.305"></a><span id="l59.305">       return false;</span>
<a href="#l59.306"></a><span id="l59.306">     },</span>
<a href="#l59.307"></a><span id="l59.307"> </span>
<a href="#l59.308"></a><span id="l59.308" class="difflineminus">-    &quot;604&quot;: function(aMessage) { // RPL_NOWON</span>
<a href="#l59.309"></a><span id="l59.309" class="difflineplus">+    &quot;604&quot;: function(aMessage) {</span>
<a href="#l59.310"></a><span id="l59.310" class="difflineplus">+      // RPL_NOWON</span>
<a href="#l59.311"></a><span id="l59.311">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;lastnickchange&gt; :is online</span>
<a href="#l59.312"></a><span id="l59.312">       return setStatus(this, aMessage.params[1], &quot;AVAILABLE&quot;);</span>
<a href="#l59.313"></a><span id="l59.313">     },</span>
<a href="#l59.314"></a><span id="l59.314"> </span>
<a href="#l59.315"></a><span id="l59.315" class="difflineminus">-    &quot;605&quot;: function(aMessage) { // RPL_NOWOFF</span>
<a href="#l59.316"></a><span id="l59.316" class="difflineplus">+    &quot;605&quot;: function(aMessage) {</span>
<a href="#l59.317"></a><span id="l59.317" class="difflineplus">+      // RPL_NOWOFF</span>
<a href="#l59.318"></a><span id="l59.318">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;lastnickchange&gt; :is offline</span>
<a href="#l59.319"></a><span id="l59.319">       return setStatus(this, aMessage.params[1], &quot;OFFLINE&quot;);</span>
<a href="#l59.320"></a><span id="l59.320">     },</span>
<a href="#l59.321"></a><span id="l59.321"> </span>
<a href="#l59.322"></a><span id="l59.322" class="difflineminus">-    &quot;606&quot;: function(aMessage) { // RPL_WATCHLIST</span>
<a href="#l59.323"></a><span id="l59.323" class="difflineplus">+    &quot;606&quot;: function(aMessage) {</span>
<a href="#l59.324"></a><span id="l59.324" class="difflineplus">+      // RPL_WATCHLIST</span>
<a href="#l59.325"></a><span id="l59.325">       // &lt;entrylist&gt;</span>
<a href="#l59.326"></a><span id="l59.326">       // TODO</span>
<a href="#l59.327"></a><span id="l59.327">       return false;</span>
<a href="#l59.328"></a><span id="l59.328">     },</span>
<a href="#l59.329"></a><span id="l59.329"> </span>
<a href="#l59.330"></a><span id="l59.330" class="difflineminus">-    &quot;607&quot;: function(aMessage) { // RPL_ENDOFWATCHLIST</span>
<a href="#l59.331"></a><span id="l59.331" class="difflineplus">+    &quot;607&quot;: function(aMessage) {</span>
<a href="#l59.332"></a><span id="l59.332" class="difflineplus">+      // RPL_ENDOFWATCHLIST</span>
<a href="#l59.333"></a><span id="l59.333">       // End of WATCH &lt;parameter&gt;</span>
<a href="#l59.334"></a><span id="l59.334">       // TODO</span>
<a href="#l59.335"></a><span id="l59.335">       return false;</span>
<a href="#l59.336"></a><span id="l59.336">     },</span>
<a href="#l59.337"></a><span id="l59.337"> </span>
<a href="#l59.338"></a><span id="l59.338" class="difflineminus">-    &quot;608&quot;: function(aMessage) { // RPL_CLEARWATCH</span>
<a href="#l59.339"></a><span id="l59.339" class="difflineplus">+    &quot;608&quot;: function(aMessage) {</span>
<a href="#l59.340"></a><span id="l59.340" class="difflineplus">+      // RPL_CLEARWATCH</span>
<a href="#l59.341"></a><span id="l59.341">       // Your WATCH list is now empty</span>
<a href="#l59.342"></a><span id="l59.342">       // Note that this is optional for servers to send, so ignore it.</span>
<a href="#l59.343"></a><span id="l59.343">       return true;</span>
<a href="#l59.344"></a><span id="l59.344">     },</span>
<a href="#l59.345"></a><span id="l59.345"> </span>
<a href="#l59.346"></a><span id="l59.346" class="difflineminus">-    &quot;609&quot;: function(aMessage) { // RPL_NOWISAWAY</span>
<a href="#l59.347"></a><span id="l59.347" class="difflineplus">+    &quot;609&quot;: function(aMessage) {</span>
<a href="#l59.348"></a><span id="l59.348" class="difflineplus">+      // RPL_NOWISAWAY</span>
<a href="#l59.349"></a><span id="l59.349">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;awaysince&gt; :&lt;away reason&gt;</span>
<a href="#l59.350"></a><span id="l59.350">       return setStatus(this, aMessage.params[1], &quot;AWAY&quot;);</span>
<a href="#l59.351"></a><span id="l59.351">     },</span>
<a href="#l59.352"></a><span id="l59.352">   },</span>
<a href="#l59.353"></a><span id="l59.353"> };</span>
<a href="#l59.354"></a><span id="l59.354"> </span>
<a href="#l59.355"></a><span id="l59.355"> var isupportMONITOR = {</span>
<a href="#l59.356"></a><span id="l59.356">   name: &quot;MONITOR&quot;,</span>
<a href="#l59.357"></a><span id="l59.357">   // Slightly above default ISUPPORT priority.</span>
<a href="#l59.358"></a><span id="l59.358">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l59.359"></a><span id="l59.359">   isEnabled: () =&gt; true,</span>
<a href="#l59.360"></a><span id="l59.360"> </span>
<a href="#l59.361"></a><span id="l59.361">   commands: {</span>
<a href="#l59.362"></a><span id="l59.362" class="difflineminus">-    &quot;MONITOR&quot;: function(aMessage) {</span>
<a href="#l59.363"></a><span id="l59.363" class="difflineminus">-      if (!aMessage.isupport.useDefault)</span>
<a href="#l59.364"></a><span id="l59.364" class="difflineplus">+    MONITOR(aMessage) {</span>
<a href="#l59.365"></a><span id="l59.365" class="difflineplus">+      if (!aMessage.isupport.useDefault) {</span>
<a href="#l59.366"></a><span id="l59.366">         this.maxMonitorLength = Infinity;</span>
<a href="#l59.367"></a><span id="l59.367" class="difflineminus">-      else {</span>
<a href="#l59.368"></a><span id="l59.368" class="difflineplus">+      } else {</span>
<a href="#l59.369"></a><span id="l59.369">         let size = parseInt(aMessage.isupport.value, 10);</span>
<a href="#l59.370"></a><span id="l59.370" class="difflineminus">-        if (isNaN(size))</span>
<a href="#l59.371"></a><span id="l59.371" class="difflineplus">+        if (isNaN(size)) {</span>
<a href="#l59.372"></a><span id="l59.372">           return false;</span>
<a href="#l59.373"></a><span id="l59.373" class="difflineplus">+        }</span>
<a href="#l59.374"></a><span id="l59.374">         this.maxMonitorLength = size;</span>
<a href="#l59.375"></a><span id="l59.375">       }</span>
<a href="#l59.376"></a><span id="l59.376"> </span>
<a href="#l59.377"></a><span id="l59.377">       this.monitorEnabled = true;</span>
<a href="#l59.378"></a><span id="l59.378"> </span>
<a href="#l59.379"></a><span id="l59.379">       // Clear our monitor list in case there is garbage in it.</span>
<a href="#l59.380"></a><span id="l59.380">       this.sendMessage(&quot;MONITOR&quot;, &quot;C&quot;);</span>
<a href="#l59.381"></a><span id="l59.381">       this.monitorLength = 0;</span>
<a href="#l59.382"></a><span id="l59.382" class="difflineat">@@ -298,32 +349,40 @@ function trackBuddyMonitor(aNicks) {</span>
<a href="#l59.383"></a><span id="l59.383">   if (!Array.isArray(aNicks)) {</span>
<a href="#l59.384"></a><span id="l59.384">     // We update the trackQueue if an individual nick is being added,</span>
<a href="#l59.385"></a><span id="l59.385">     // so the nick will also be monitored after a reconnect.</span>
<a href="#l59.386"></a><span id="l59.386">     Object.getPrototypeOf(this).trackBuddy.call(this, aNicks);</span>
<a href="#l59.387"></a><span id="l59.387">     aNicks = [aNicks];</span>
<a href="#l59.388"></a><span id="l59.388">   }</span>
<a href="#l59.389"></a><span id="l59.389"> </span>
<a href="#l59.390"></a><span id="l59.390">   let nicks = aNicks;</span>
<a href="#l59.391"></a><span id="l59.391" class="difflineminus">-  if (!nicks.length)</span>
<a href="#l59.392"></a><span id="l59.392" class="difflineplus">+  if (!nicks.length) {</span>
<a href="#l59.393"></a><span id="l59.393">     return;</span>
<a href="#l59.394"></a><span id="l59.394" class="difflineplus">+  }</span>
<a href="#l59.395"></a><span id="l59.395"> </span>
<a href="#l59.396"></a><span id="l59.396">   let newMonitorLength = this.monitorLength + nicks.length;</span>
<a href="#l59.397"></a><span id="l59.397">   if (newMonitorLength &gt; this.maxMonitorLength) {</span>
<a href="#l59.398"></a><span id="l59.398" class="difflineminus">-    this.WARN(&quot;Attempting to MONITOR &quot; + newMonitorLength +</span>
<a href="#l59.399"></a><span id="l59.399" class="difflineminus">-              &quot; nicks; maximum size is &quot; + this.maxMonitorLength + &quot;.&quot;);</span>
<a href="#l59.400"></a><span id="l59.400" class="difflineplus">+    this.WARN(</span>
<a href="#l59.401"></a><span id="l59.401" class="difflineplus">+      &quot;Attempting to MONITOR &quot; +</span>
<a href="#l59.402"></a><span id="l59.402" class="difflineplus">+        newMonitorLength +</span>
<a href="#l59.403"></a><span id="l59.403" class="difflineplus">+        &quot; nicks; maximum size is &quot; +</span>
<a href="#l59.404"></a><span id="l59.404" class="difflineplus">+        this.maxMonitorLength +</span>
<a href="#l59.405"></a><span id="l59.405" class="difflineplus">+        &quot;.&quot;</span>
<a href="#l59.406"></a><span id="l59.406" class="difflineplus">+    );</span>
<a href="#l59.407"></a><span id="l59.407">     // TODO We should trim the list and add the extra users to an ISON queue,</span>
<a href="#l59.408"></a><span id="l59.408">     // but that's not currently implemented, so just hope the server doesn't</span>
<a href="#l59.409"></a><span id="l59.409">     // enforce it's own limit.</span>
<a href="#l59.410"></a><span id="l59.410">   }</span>
<a href="#l59.411"></a><span id="l59.411">   this.monitorLength = newMonitorLength;</span>
<a href="#l59.412"></a><span id="l59.412"> </span>
<a href="#l59.413"></a><span id="l59.413">   let params = [];</span>
<a href="#l59.414"></a><span id="l59.414" class="difflineminus">-  let maxLength = this.maxMessageLength - 2 -</span>
<a href="#l59.415"></a><span id="l59.415" class="difflineminus">-                  this.countBytes(this.buildMessage(&quot;MONITOR&quot;, &quot;+&quot;));</span>
<a href="#l59.416"></a><span id="l59.416" class="difflineplus">+  let maxLength =</span>
<a href="#l59.417"></a><span id="l59.417" class="difflineplus">+    this.maxMessageLength -</span>
<a href="#l59.418"></a><span id="l59.418" class="difflineplus">+    2 -</span>
<a href="#l59.419"></a><span id="l59.419" class="difflineplus">+    this.countBytes(this.buildMessage(&quot;MONITOR&quot;, &quot;+&quot;));</span>
<a href="#l59.420"></a><span id="l59.420">   for (let nick of nicks) {</span>
<a href="#l59.421"></a><span id="l59.421">     if (this.countBytes(params + &quot; &quot; + nick) &gt;= maxLength) {</span>
<a href="#l59.422"></a><span id="l59.422">       // If the message would be too long, first send this message.</span>
<a href="#l59.423"></a><span id="l59.423">       this.sendMessage(&quot;MONITOR&quot;, [&quot;+&quot;, params.join(&quot;,&quot;)]);</span>
<a href="#l59.424"></a><span id="l59.424">       // Reset for the next message.</span>
<a href="#l59.425"></a><span id="l59.425">       params = [];</span>
<a href="#l59.426"></a><span id="l59.426">     }</span>
<a href="#l59.427"></a><span id="l59.427">     params.push(nick);</span>
<a href="#l59.428"></a><span id="l59.428" class="difflineat">@@ -337,20 +396,23 @@ function untrackBuddyMonitor(aNick) {</span>
<a href="#l59.429"></a><span id="l59.429"> }</span>
<a href="#l59.430"></a><span id="l59.430"> </span>
<a href="#l59.431"></a><span id="l59.431"> var ircMONITOR = {</span>
<a href="#l59.432"></a><span id="l59.432">   name: &quot;MONITOR&quot;,</span>
<a href="#l59.433"></a><span id="l59.433">   // Slightly above default IRC priority.</span>
<a href="#l59.434"></a><span id="l59.434">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l59.435"></a><span id="l59.435">   // Use MONITOR only if MONITOR is enabled and WATCH is not enabled, as WATCH</span>
<a href="#l59.436"></a><span id="l59.436">   // supports more features.</span>
<a href="#l59.437"></a><span id="l59.437" class="difflineminus">-  isEnabled() { return this.monitorEnabled &amp;&amp; !this.watchEnabled; },</span>
<a href="#l59.438"></a><span id="l59.438" class="difflineplus">+  isEnabled() {</span>
<a href="#l59.439"></a><span id="l59.439" class="difflineplus">+    return this.monitorEnabled &amp;&amp; !this.watchEnabled;</span>
<a href="#l59.440"></a><span id="l59.440" class="difflineplus">+  },</span>
<a href="#l59.441"></a><span id="l59.441"> </span>
<a href="#l59.442"></a><span id="l59.442">   commands: {</span>
<a href="#l59.443"></a><span id="l59.443" class="difflineminus">-    &quot;251&quot;: function(aMessage) { // RPL_LUSERCLIENT</span>
<a href="#l59.444"></a><span id="l59.444" class="difflineplus">+    &quot;251&quot;: function(aMessage) {</span>
<a href="#l59.445"></a><span id="l59.445" class="difflineplus">+      // RPL_LUSERCLIENT</span>
<a href="#l59.446"></a><span id="l59.446">       // &quot;:There are &lt;integer&gt; users and &lt;integer&gt; services on &lt;integer&gt; servers&quot;</span>
<a href="#l59.447"></a><span id="l59.447">       // Assume that this will always be sent after the 005 handler on</span>
<a href="#l59.448"></a><span id="l59.448">       // connection registration. If MONITOR is enabled, then set the new</span>
<a href="#l59.449"></a><span id="l59.449">       // function to keep track of nicks and send the messages to watch the</span>
<a href="#l59.450"></a><span id="l59.450">       // nicks.</span>
<a href="#l59.451"></a><span id="l59.451"> </span>
<a href="#l59.452"></a><span id="l59.452">       // Ensure that any new buddies are set to be watched, and removed buddies</span>
<a href="#l59.453"></a><span id="l59.453">       // are no longer watched.</span>
<a href="#l59.454"></a><span id="l59.454" class="difflineat">@@ -360,51 +422,57 @@ var ircMONITOR = {</span>
<a href="#l59.455"></a><span id="l59.455">       // Build the watchlist from the current list of nicks.</span>
<a href="#l59.456"></a><span id="l59.456">       this.trackBuddy(this.trackQueue);</span>
<a href="#l59.457"></a><span id="l59.457"> </span>
<a href="#l59.458"></a><span id="l59.458">       // Fall through to other handlers since we're only using this as an entry</span>
<a href="#l59.459"></a><span id="l59.459">       // point and not actually handling the message.</span>
<a href="#l59.460"></a><span id="l59.460">       return false;</span>
<a href="#l59.461"></a><span id="l59.461">     },</span>
<a href="#l59.462"></a><span id="l59.462"> </span>
<a href="#l59.463"></a><span id="l59.463" class="difflineminus">-    &quot;303&quot;: function(aMessage) { // RPL_ISON</span>
<a href="#l59.464"></a><span id="l59.464" class="difflineplus">+    &quot;303&quot;: function(aMessage) {</span>
<a href="#l59.465"></a><span id="l59.465" class="difflineplus">+      // RPL_ISON</span>
<a href="#l59.466"></a><span id="l59.466">       // :*1&lt;nick&gt; *( &quot; &quot; &lt;nick&gt; )</span>
<a href="#l59.467"></a><span id="l59.467">       // We don't want ircBase to interfere with us, so override the ISON</span>
<a href="#l59.468"></a><span id="l59.468">       // handler to do nothing if we're using MONITOR.</span>
<a href="#l59.469"></a><span id="l59.469">       return true;</span>
<a href="#l59.470"></a><span id="l59.470">     },</span>
<a href="#l59.471"></a><span id="l59.471"> </span>
<a href="#l59.472"></a><span id="l59.472" class="difflineminus">-    &quot;730&quot;: function(aMessage) { // RPL_MONONLINE</span>
<a href="#l59.473"></a><span id="l59.473" class="difflineplus">+    &quot;730&quot;: function(aMessage) {</span>
<a href="#l59.474"></a><span id="l59.474" class="difflineplus">+      // RPL_MONONLINE</span>
<a href="#l59.475"></a><span id="l59.475">       // :&lt;server&gt; 730 &lt;nick&gt; :nick!user@host[,nick!user@host]*</span>
<a href="#l59.476"></a><span id="l59.476">       // Mark each nick as online.</span>
<a href="#l59.477"></a><span id="l59.477" class="difflineminus">-      return aMessage.params[1].split(&quot;,&quot;)</span>
<a href="#l59.478"></a><span id="l59.478" class="difflineminus">-                               .map(aNick =&gt;</span>
<a href="#l59.479"></a><span id="l59.479" class="difflineminus">-                                      setStatus(this, aNick.split(&quot;!&quot;, 1)[0],</span>
<a href="#l59.480"></a><span id="l59.480" class="difflineminus">-                                                &quot;AVAILABLE&quot;))</span>
<a href="#l59.481"></a><span id="l59.481" class="difflineminus">-                               .every(aResult =&gt; aResult);</span>
<a href="#l59.482"></a><span id="l59.482" class="difflineplus">+      return aMessage.params[1]</span>
<a href="#l59.483"></a><span id="l59.483" class="difflineplus">+        .split(&quot;,&quot;)</span>
<a href="#l59.484"></a><span id="l59.484" class="difflineplus">+        .map(aNick =&gt; setStatus(this, aNick.split(&quot;!&quot;, 1)[0], &quot;AVAILABLE&quot;))</span>
<a href="#l59.485"></a><span id="l59.485" class="difflineplus">+        .every(aResult =&gt; aResult);</span>
<a href="#l59.486"></a><span id="l59.486">     },</span>
<a href="#l59.487"></a><span id="l59.487"> </span>
<a href="#l59.488"></a><span id="l59.488" class="difflineminus">-    &quot;731&quot;: function(aMessage) { // RPL_MONOFFLINE</span>
<a href="#l59.489"></a><span id="l59.489" class="difflineplus">+    &quot;731&quot;: function(aMessage) {</span>
<a href="#l59.490"></a><span id="l59.490" class="difflineplus">+      // RPL_MONOFFLINE</span>
<a href="#l59.491"></a><span id="l59.491">       // :&lt;server&gt; 731 &lt;nick&gt; :nick[,nick1]*</span>
<a href="#l59.492"></a><span id="l59.492" class="difflineminus">-      return aMessage.params[1].split(&quot;,&quot;)</span>
<a href="#l59.493"></a><span id="l59.493" class="difflineminus">-                               .map(aNick =&gt;</span>
<a href="#l59.494"></a><span id="l59.494" class="difflineminus">-                                      setStatus(this, aNick, &quot;OFFLINE&quot;))</span>
<a href="#l59.495"></a><span id="l59.495" class="difflineminus">-                               .every(aResult =&gt; aResult);</span>
<a href="#l59.496"></a><span id="l59.496" class="difflineplus">+      return aMessage.params[1]</span>
<a href="#l59.497"></a><span id="l59.497" class="difflineplus">+        .split(&quot;,&quot;)</span>
<a href="#l59.498"></a><span id="l59.498" class="difflineplus">+        .map(aNick =&gt; setStatus(this, aNick, &quot;OFFLINE&quot;))</span>
<a href="#l59.499"></a><span id="l59.499" class="difflineplus">+        .every(aResult =&gt; aResult);</span>
<a href="#l59.500"></a><span id="l59.500">     },</span>
<a href="#l59.501"></a><span id="l59.501"> </span>
<a href="#l59.502"></a><span id="l59.502" class="difflineminus">-    &quot;732&quot;: function(aMessage) { // RPL_MONLIST</span>
<a href="#l59.503"></a><span id="l59.503" class="difflineplus">+    &quot;732&quot;: function(aMessage) {</span>
<a href="#l59.504"></a><span id="l59.504" class="difflineplus">+      // RPL_MONLIST</span>
<a href="#l59.505"></a><span id="l59.505">       // :&lt;server&gt; 732 &lt;nick&gt; :nick[,nick1]*</span>
<a href="#l59.506"></a><span id="l59.506">       return false;</span>
<a href="#l59.507"></a><span id="l59.507">     },</span>
<a href="#l59.508"></a><span id="l59.508"> </span>
<a href="#l59.509"></a><span id="l59.509" class="difflineminus">-    &quot;733&quot;: function(aMessage) { // RPL_ENDOFMONLIST</span>
<a href="#l59.510"></a><span id="l59.510" class="difflineplus">+    &quot;733&quot;: function(aMessage) {</span>
<a href="#l59.511"></a><span id="l59.511" class="difflineplus">+      // RPL_ENDOFMONLIST</span>
<a href="#l59.512"></a><span id="l59.512">       // :&lt;server&gt; 733 &lt;nick&gt; :End of MONITOR list</span>
<a href="#l59.513"></a><span id="l59.513">       return false;</span>
<a href="#l59.514"></a><span id="l59.514">     },</span>
<a href="#l59.515"></a><span id="l59.515"> </span>
<a href="#l59.516"></a><span id="l59.516" class="difflineminus">-    &quot;734&quot;: function(aMessage) { // ERR_MONLISTFULL</span>
<a href="#l59.517"></a><span id="l59.517" class="difflineplus">+    &quot;734&quot;: function(aMessage) {</span>
<a href="#l59.518"></a><span id="l59.518" class="difflineplus">+      // ERR_MONLISTFULL</span>
<a href="#l59.519"></a><span id="l59.519">       // :&lt;server&gt; 734 &lt;nick&gt; &lt;limit&gt; &lt;nicks&gt; :Monitor list is full.</span>
<a href="#l59.520"></a><span id="l59.520" class="difflineminus">-      this.ERROR(&quot;Maximum size for MONITOR list exceeded (&quot; + this.params[1] +</span>
<a href="#l59.521"></a><span id="l59.521" class="difflineminus">-                 &quot;).&quot;);</span>
<a href="#l59.522"></a><span id="l59.522" class="difflineplus">+      this.ERROR(</span>
<a href="#l59.523"></a><span id="l59.523" class="difflineplus">+        &quot;Maximum size for MONITOR list exceeded (&quot; + this.params[1] + &quot;).&quot;</span>
<a href="#l59.524"></a><span id="l59.524" class="difflineplus">+      );</span>
<a href="#l59.525"></a><span id="l59.525">       return true;</span>
<a href="#l59.526"></a><span id="l59.526">     },</span>
<a href="#l59.527"></a><span id="l59.527">   },</span>
<a href="#l59.528"></a><span id="l59.528"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpColoring.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpColoring.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l60.4"></a><span id="l60.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l60.5"></a><span id="l60.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l60.6"></a><span id="l60.6"> </span>
<a href="#l60.7"></a><span id="l60.7" class="difflineminus">-var {</span>
<a href="#l60.8"></a><span id="l60.8" class="difflineminus">-  ctcpFormatToText,</span>
<a href="#l60.9"></a><span id="l60.9" class="difflineminus">-  ctcpFormatToHTML,</span>
<a href="#l60.10"></a><span id="l60.10" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l60.11"></a><span id="l60.11" class="difflineplus">+var { ctcpFormatToText, ctcpFormatToHTML } = ChromeUtils.import(</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+  &quot;resource:///modules/ircUtils.jsm&quot;</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+);</span>
<a href="#l60.14"></a><span id="l60.14"> </span>
<a href="#l60.15"></a><span id="l60.15"> var input = [</span>
<a href="#l60.16"></a><span id="l60.16">   // From http://www.mirc.com/colors.html</span>
<a href="#l60.17"></a><span id="l60.17">   &quot;\x035,12colored text and background\x03&quot;,</span>
<a href="#l60.18"></a><span id="l60.18">   &quot;\x035colored text\x03&quot;,</span>
<a href="#l60.19"></a><span id="l60.19">   &quot;\x033colored text \x035,2more colored text and background\x03&quot;,</span>
<a href="#l60.20"></a><span id="l60.20">   &quot;\x033,5colored text and background \x038other colored text but same background\x03&quot;,</span>
<a href="#l60.21"></a><span id="l60.21">   &quot;\x033,5colored text and background \x038,7other colored text and different background\x03&quot;,</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineat">@@ -29,29 +28,30 @@ function run_test() {</span>
<a href="#l60.23"></a><span id="l60.23">   add_test(test_mIRCColoring);</span>
<a href="#l60.24"></a><span id="l60.24">   add_test(test_ctcpFormatToText);</span>
<a href="#l60.25"></a><span id="l60.25"> </span>
<a href="#l60.26"></a><span id="l60.26">   run_next_test();</span>
<a href="#l60.27"></a><span id="l60.27"> }</span>
<a href="#l60.28"></a><span id="l60.28"> </span>
<a href="#l60.29"></a><span id="l60.29"> function test_mIRCColoring() {</span>
<a href="#l60.30"></a><span id="l60.30">   let expectedOutput = [</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-    &quot;&lt;font color=\&quot;maroon\&quot; background=\&quot;blue\&quot;&gt;colored text and background&lt;/font&gt;&quot;,</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineminus">-    &quot;&lt;font color=\&quot;maroon\&quot;&gt;colored text&lt;/font&gt;&quot;,</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineminus">-    &quot;&lt;font color=\&quot;green\&quot;&gt;colored text &lt;font color=\&quot;maroon\&quot; background=\&quot;navy\&quot;&gt;more colored text and background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineminus">-    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot;&gt;other colored text but same background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineminus">-    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot; background=\&quot;orange\&quot;&gt;other colored text and different background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineminus">-    &quot;&lt;b&gt;&lt;font color=\&quot;maroon\&quot; background=\&quot;blue\&quot;&gt;colored &lt;u&gt;text and background&lt;/u&gt;&lt;/font&gt;&lt;u&gt;. You sure about this?&lt;/u&gt;&lt;/b&gt;&quot;,</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+    '&lt;font color=&quot;maroon&quot; background=&quot;blue&quot;&gt;colored text and background&lt;/font&gt;',</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+    '&lt;font color=&quot;maroon&quot;&gt;colored text&lt;/font&gt;',</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+    '&lt;font color=&quot;green&quot;&gt;colored text &lt;font color=&quot;maroon&quot; background=&quot;navy&quot;&gt;more colored text and background&lt;/font&gt;&lt;/font&gt;',</span>
<a href="#l60.40"></a><span id="l60.40" class="difflineplus">+    '&lt;font color=&quot;green&quot; background=&quot;maroon&quot;&gt;colored text and background &lt;font color=&quot;yellow&quot;&gt;other colored text but same background&lt;/font&gt;&lt;/font&gt;',</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineplus">+    '&lt;font color=&quot;green&quot; background=&quot;maroon&quot;&gt;colored text and background &lt;font color=&quot;yellow&quot; background=&quot;orange&quot;&gt;other colored text and different background&lt;/font&gt;&lt;/font&gt;',</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineplus">+    '&lt;b&gt;&lt;font color=&quot;maroon&quot; background=&quot;blue&quot;&gt;colored &lt;u&gt;text and background&lt;/u&gt;&lt;/font&gt;&lt;u&gt;. You sure about this?&lt;/u&gt;&lt;/b&gt;',</span>
<a href="#l60.43"></a><span id="l60.43">     &quot;So a ,8 attribute is not valid and thus ignored.&quot;,</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineminus">-    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot;&gt;other colored text but same background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineminus">-    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot; background=\&quot;orange\&quot;&gt;other colored text and different background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+    '&lt;font color=&quot;green&quot; background=&quot;maroon&quot;&gt;colored text and background &lt;font color=&quot;yellow&quot;&gt;other colored text but same background&lt;/font&gt;&lt;/font&gt;',</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+    '&lt;font color=&quot;green&quot; background=&quot;maroon&quot;&gt;colored text and background &lt;font color=&quot;yellow&quot; background=&quot;orange&quot;&gt;other colored text and different background&lt;/font&gt;&lt;/font&gt;',</span>
<a href="#l60.48"></a><span id="l60.48">   ];</span>
<a href="#l60.49"></a><span id="l60.49"> </span>
<a href="#l60.50"></a><span id="l60.50" class="difflineminus">-  for (let i = 0; i &lt; input.length; i++)</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+  for (let i = 0; i &lt; input.length; i++) {</span>
<a href="#l60.52"></a><span id="l60.52">     equal(expectedOutput[i], ctcpFormatToHTML(input[i]));</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineplus">+  }</span>
<a href="#l60.54"></a><span id="l60.54"> </span>
<a href="#l60.55"></a><span id="l60.55">   run_next_test();</span>
<a href="#l60.56"></a><span id="l60.56"> }</span>
<a href="#l60.57"></a><span id="l60.57"> </span>
<a href="#l60.58"></a><span id="l60.58"> function test_ctcpFormatToText() {</span>
<a href="#l60.59"></a><span id="l60.59">   let expectedOutput = [</span>
<a href="#l60.60"></a><span id="l60.60">     &quot;colored text and background&quot;,</span>
<a href="#l60.61"></a><span id="l60.61">     &quot;colored text&quot;,</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineat">@@ -59,13 +59,14 @@ function test_ctcpFormatToText() {</span>
<a href="#l60.63"></a><span id="l60.63">     &quot;colored text and background other colored text but same background&quot;,</span>
<a href="#l60.64"></a><span id="l60.64">     &quot;colored text and background other colored text and different background&quot;,</span>
<a href="#l60.65"></a><span id="l60.65">     &quot;colored text and background. You sure about this?&quot;,</span>
<a href="#l60.66"></a><span id="l60.66">     &quot;So a ,8 attribute is not valid and thus ignored.&quot;,</span>
<a href="#l60.67"></a><span id="l60.67">     &quot;colored text and background other colored text but same background&quot;,</span>
<a href="#l60.68"></a><span id="l60.68">     &quot;colored text and background other colored text and different background&quot;,</span>
<a href="#l60.69"></a><span id="l60.69">   ];</span>
<a href="#l60.70"></a><span id="l60.70"> </span>
<a href="#l60.71"></a><span id="l60.71" class="difflineminus">-  for (let i = 0; i &lt; input.length; i++)</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineplus">+  for (let i = 0; i &lt; input.length; i++) {</span>
<a href="#l60.73"></a><span id="l60.73">     equal(expectedOutput[i], ctcpFormatToText(input[i]));</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+  }</span>
<a href="#l60.75"></a><span id="l60.75"> </span>
<a href="#l60.76"></a><span id="l60.76">   run_next_test();</span>
<a href="#l60.77"></a><span id="l60.77"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpDequote.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpDequote.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l61.4"></a><span id="l61.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l61.5"></a><span id="l61.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l61.8"></a><span id="l61.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l61.9"></a><span id="l61.9"> var ircCTCP = {};</span>
<a href="#l61.10"></a><span id="l61.10"> Services.scriptloader.loadSubScript(&quot;resource:///modules/ircCTCP.jsm&quot;, ircCTCP);</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12"> var input = [</span>
<a href="#l61.13"></a><span id="l61.13">   &quot;ACTION&quot;,</span>
<a href="#l61.14"></a><span id="l61.14">   &quot;ACTION test&quot;,</span>
<a href="#l61.15"></a><span id="l61.15">   &quot;ACTION \x5Ctest&quot;,</span>
<a href="#l61.16"></a><span id="l61.16">   &quot;ACTION te\x5Cst&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpFormatting.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpFormatting.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l62.4"></a><span id="l62.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l62.5"></a><span id="l62.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l62.6"></a><span id="l62.6"> </span>
<a href="#l62.7"></a><span id="l62.7" class="difflineminus">-var {</span>
<a href="#l62.8"></a><span id="l62.8" class="difflineminus">-  ctcpFormatToText,</span>
<a href="#l62.9"></a><span id="l62.9" class="difflineminus">-  ctcpFormatToHTML,</span>
<a href="#l62.10"></a><span id="l62.10" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l62.11"></a><span id="l62.11" class="difflineplus">+var { ctcpFormatToText, ctcpFormatToHTML } = ChromeUtils.import(</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+  &quot;resource:///modules/ircUtils.jsm&quot;</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+);</span>
<a href="#l62.14"></a><span id="l62.14"> </span>
<a href="#l62.15"></a><span id="l62.15"> // TODO add a test for special JS characters (|, etc...)</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17"> var input = [</span>
<a href="#l62.18"></a><span id="l62.18">   &quot;The quick brown fox \x02jumps\x02 over the lazy dog.&quot;,</span>
<a href="#l62.19"></a><span id="l62.19">   &quot;The quick brown fox \x02jumps\x0F over the lazy dog.&quot;,</span>
<a href="#l62.20"></a><span id="l62.20">   &quot;The quick brown \x16fox jumps\x16 over the lazy dog.&quot;,</span>
<a href="#l62.21"></a><span id="l62.21">   &quot;The quick brown \x16fox jumps\x0F over the lazy dog.&quot;,</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineat">@@ -37,22 +36,24 @@ function test_ctcpFormatToHTML() {</span>
<a href="#l62.23"></a><span id="l62.23">     &quot;The quick &lt;u&gt;brown fox jumps over the lazy&lt;/u&gt; dog.&quot;,</span>
<a href="#l62.24"></a><span id="l62.24">     &quot;The quick &lt;u&gt;brown fox jumps over the lazy&lt;/u&gt; dog.&quot;,</span>
<a href="#l62.25"></a><span id="l62.25">     &quot;The quick &lt;u&gt;brown fox &lt;b&gt;jumps over the lazy&lt;/b&gt;&lt;/u&gt;&lt;b&gt; dog.&lt;/b&gt;&quot;,</span>
<a href="#l62.26"></a><span id="l62.26">     &quot;The quick &lt;u&gt;brown fox &lt;b&gt;jumps&lt;/b&gt;&lt;/u&gt;&lt;b&gt; over the lazy&lt;/b&gt; dog.&quot;,</span>
<a href="#l62.27"></a><span id="l62.27">     &quot;The quick &lt;u&gt;brown &lt;i&gt;fox &lt;b&gt;jumps&lt;/b&gt;&lt;/i&gt;&lt;/u&gt;&lt;i&gt;&lt;b&gt; over&lt;/b&gt;&lt;/i&gt;&lt;b&gt; the lazy&lt;/b&gt; dog.&quot;,</span>
<a href="#l62.28"></a><span id="l62.28">     &quot;The quick &lt;u&gt;brown &lt;i&gt;fox &lt;b&gt;jumps&lt;/b&gt;&lt;/i&gt;&lt;/u&gt; over &lt;i&gt;the lazy &lt;b&gt;dog.&lt;/b&gt;&lt;/i&gt;&quot;,</span>
<a href="#l62.29"></a><span id="l62.29">   ];</span>
<a href="#l62.30"></a><span id="l62.30"> </span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-  for (let i = 0; i &lt; input.length; i++)</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+  for (let i = 0; i &lt; input.length; i++) {</span>
<a href="#l62.33"></a><span id="l62.33">     equal(expectedOutput[i], ctcpFormatToHTML(input[i]));</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+  }</span>
<a href="#l62.35"></a><span id="l62.35"> </span>
<a href="#l62.36"></a><span id="l62.36">   run_next_test();</span>
<a href="#l62.37"></a><span id="l62.37"> }</span>
<a href="#l62.38"></a><span id="l62.38"> </span>
<a href="#l62.39"></a><span id="l62.39"> function test_ctcpFormatToText() {</span>
<a href="#l62.40"></a><span id="l62.40">   let expectedOutput = &quot;The quick brown fox jumps over the lazy dog.&quot;;</span>
<a href="#l62.41"></a><span id="l62.41"> </span>
<a href="#l62.42"></a><span id="l62.42" class="difflineminus">-  for (let i = 0; i &lt; input.length; ++i)</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+  for (let i = 0; i &lt; input.length; ++i) {</span>
<a href="#l62.44"></a><span id="l62.44">     equal(expectedOutput, ctcpFormatToText(input[i]));</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+  }</span>
<a href="#l62.46"></a><span id="l62.46"> </span>
<a href="#l62.47"></a><span id="l62.47">   run_next_test();</span>
<a href="#l62.48"></a><span id="l62.48"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l63.4"></a><span id="l63.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l63.5"></a><span id="l63.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l63.6"></a><span id="l63.6"> </span>
<a href="#l63.7"></a><span id="l63.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l63.8"></a><span id="l63.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l63.9"></a><span id="l63.9"> var irc = {};</span>
<a href="#l63.10"></a><span id="l63.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12"> var input = [</span>
<a href="#l63.13"></a><span id="l63.13">   undefined,</span>
<a href="#l63.14"></a><span id="l63.14">   &quot;test&quot;,</span>
<a href="#l63.15"></a><span id="l63.15">   &quot;\\test&quot;,</span>
<a href="#l63.16"></a><span id="l63.16">   &quot;te\\st&quot;,</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineat">@@ -47,16 +47,18 @@ var outputParams = [];</span>
<a href="#l63.18"></a><span id="l63.18"> </span>
<a href="#l63.19"></a><span id="l63.19"> irc.ircAccount.prototype.sendMessage = function(aCommand, aParams) {</span>
<a href="#l63.20"></a><span id="l63.20">   equal(&quot;PRIVMSG&quot;, aCommand);</span>
<a href="#l63.21"></a><span id="l63.21">   outputParams.push(aParams[1]);</span>
<a href="#l63.22"></a><span id="l63.22"> };</span>
<a href="#l63.23"></a><span id="l63.23"> </span>
<a href="#l63.24"></a><span id="l63.24"> function run_test() {</span>
<a href="#l63.25"></a><span id="l63.25">   input.map(aStr =&gt;</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineminus">-    irc.ircAccount.prototype.sendCTCPMessage(&quot;&quot;, false, &quot;ACTION&quot;, aStr));</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineplus">+    irc.ircAccount.prototype.sendCTCPMessage(&quot;&quot;, false, &quot;ACTION&quot;, aStr)</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineplus">+  );</span>
<a href="#l63.29"></a><span id="l63.29"> </span>
<a href="#l63.30"></a><span id="l63.30">   // Ensure both arrays have the same length.</span>
<a href="#l63.31"></a><span id="l63.31">   equal(expectedOutputParams.length, outputParams.length);</span>
<a href="#l63.32"></a><span id="l63.32">   // Ensure the values in the arrays are equal.</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineminus">-  for (let i = 0; i &lt; outputParams.length; ++i)</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineplus">+  for (let i = 0; i &lt; outputParams.length; ++i) {</span>
<a href="#l63.35"></a><span id="l63.35">     equal(&quot;\x01&quot; + expectedOutputParams[i] + &quot;\x01&quot;, outputParams[i]);</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+  }</span>
<a href="#l63.37"></a><span id="l63.37"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircCAP.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircCAP.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1,91 +1,103 @@</span>
<a href="#l64.4"></a><span id="l64.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l64.5"></a><span id="l64.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l64.6"></a><span id="l64.6"> </span>
<a href="#l64.7"></a><span id="l64.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l64.8"></a><span id="l64.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l64.9"></a><span id="l64.9"> var cap = {};</span>
<a href="#l64.10"></a><span id="l64.10"> Services.scriptloader.loadSubScript(&quot;resource:///modules/ircCAP.jsm&quot;, cap);</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12"> var testData = [</span>
<a href="#l64.13"></a><span id="l64.13">   // A normal LS from the server.</span>
<a href="#l64.14"></a><span id="l64.14">   [</span>
<a href="#l64.15"></a><span id="l64.15">     [&quot;*&quot;, &quot;LS&quot;, &quot;multi-prefix sasl userhost-in-names&quot;],</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineminus">-    [{</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineminus">-      parameter: &quot;multi-prefix&quot;,</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineminus">-    },</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineminus">-    {</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineminus">-      parameter: &quot;sasl&quot;,</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineminus">-    },</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineminus">-    {</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineminus">-      parameter: &quot;userhost-in-names&quot;,</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineminus">-    }],</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineplus">+    [</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+      {</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineplus">+        parameter: &quot;multi-prefix&quot;,</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+      },</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+      {</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+        parameter: &quot;sasl&quot;,</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+      },</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+      {</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+        parameter: &quot;userhost-in-names&quot;,</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+      },</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineplus">+    ],</span>
<a href="#l64.42"></a><span id="l64.42">   ],</span>
<a href="#l64.43"></a><span id="l64.43"> </span>
<a href="#l64.44"></a><span id="l64.44">   // LS with both valid and invalid vendor specific capabilities.</span>
<a href="#l64.45"></a><span id="l64.45">   [</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineminus">-    [&quot;*&quot;, &quot;LS&quot;, &quot;sasl server-time znc.in/server-time-iso znc.in/playback palaverapp.com&quot;],</span>
<a href="#l64.47"></a><span id="l64.47" class="difflineminus">-    [{</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineminus">-      parameter: &quot;sasl&quot;,</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineminus">-    },</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineminus">-    {</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineminus">-      parameter: &quot;server-time&quot;,</span>
<a href="#l64.54"></a><span id="l64.54" class="difflineminus">-    },</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineminus">-    // Valid vendor prefixes (of the form &lt;domain name&gt;/&lt;capability&gt;).</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineminus">-    {</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineminus">-      parameter: &quot;znc.in/server-time-iso&quot;,</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineminus">-    },</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineminus">-    {</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineminus">-      parameter: &quot;znc.in/playback&quot;,</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineminus">-    },</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineminus">-    // Invalid vendor prefix, but we should treat it as an opaque identifier.</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineminus">-    {</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineminus">-      parameter: &quot;palaverapp.com&quot;,</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineminus">-    }],</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineplus">+    [</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineplus">+      &quot;*&quot;,</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineplus">+      &quot;LS&quot;,</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+      &quot;sasl server-time znc.in/server-time-iso znc.in/playback palaverapp.com&quot;,</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineplus">+    ],</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineplus">+    [</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+      {</span>
<a href="#l64.76"></a><span id="l64.76" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.77"></a><span id="l64.77" class="difflineplus">+        parameter: &quot;sasl&quot;,</span>
<a href="#l64.78"></a><span id="l64.78" class="difflineplus">+      },</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineplus">+      {</span>
<a href="#l64.80"></a><span id="l64.80" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.81"></a><span id="l64.81" class="difflineplus">+        parameter: &quot;server-time&quot;,</span>
<a href="#l64.82"></a><span id="l64.82" class="difflineplus">+      },</span>
<a href="#l64.83"></a><span id="l64.83" class="difflineplus">+      // Valid vendor prefixes (of the form &lt;domain name&gt;/&lt;capability&gt;).</span>
<a href="#l64.84"></a><span id="l64.84" class="difflineplus">+      {</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineplus">+        parameter: &quot;znc.in/server-time-iso&quot;,</span>
<a href="#l64.87"></a><span id="l64.87" class="difflineplus">+      },</span>
<a href="#l64.88"></a><span id="l64.88" class="difflineplus">+      {</span>
<a href="#l64.89"></a><span id="l64.89" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.90"></a><span id="l64.90" class="difflineplus">+        parameter: &quot;znc.in/playback&quot;,</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineplus">+      },</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineplus">+      // Invalid vendor prefix, but we should treat it as an opaque identifier.</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineplus">+      {</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.95"></a><span id="l64.95" class="difflineplus">+        parameter: &quot;palaverapp.com&quot;,</span>
<a href="#l64.96"></a><span id="l64.96" class="difflineplus">+      },</span>
<a href="#l64.97"></a><span id="l64.97" class="difflineplus">+    ],</span>
<a href="#l64.98"></a><span id="l64.98">   ],</span>
<a href="#l64.99"></a><span id="l64.99"> </span>
<a href="#l64.100"></a><span id="l64.100">   // Some implementations include one less parameter.</span>
<a href="#l64.101"></a><span id="l64.101">   [</span>
<a href="#l64.102"></a><span id="l64.102">     [&quot;LS&quot;, &quot;sasl&quot;],</span>
<a href="#l64.103"></a><span id="l64.103" class="difflineminus">-    [{</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.105"></a><span id="l64.105" class="difflineminus">-      parameter: &quot;sasl&quot;,</span>
<a href="#l64.106"></a><span id="l64.106" class="difflineminus">-    }],</span>
<a href="#l64.107"></a><span id="l64.107" class="difflineplus">+    [</span>
<a href="#l64.108"></a><span id="l64.108" class="difflineplus">+      {</span>
<a href="#l64.109"></a><span id="l64.109" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.110"></a><span id="l64.110" class="difflineplus">+        parameter: &quot;sasl&quot;,</span>
<a href="#l64.111"></a><span id="l64.111" class="difflineplus">+      },</span>
<a href="#l64.112"></a><span id="l64.112" class="difflineplus">+    ],</span>
<a href="#l64.113"></a><span id="l64.113">   ],</span>
<a href="#l64.114"></a><span id="l64.114"> </span>
<a href="#l64.115"></a><span id="l64.115">   // Modifier tests, ensure the modified is stripped from the capaibility and is</span>
<a href="#l64.116"></a><span id="l64.116">   // parsed correctly.</span>
<a href="#l64.117"></a><span id="l64.117">   [</span>
<a href="#l64.118"></a><span id="l64.118">     [&quot;LS&quot;, &quot;-disable =sticky ~ack&quot;],</span>
<a href="#l64.119"></a><span id="l64.119" class="difflineminus">-    [{</span>
<a href="#l64.120"></a><span id="l64.120" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.121"></a><span id="l64.121" class="difflineminus">-      parameter: &quot;disable&quot;,</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineminus">-      modifier: &quot;-&quot;,</span>
<a href="#l64.123"></a><span id="l64.123" class="difflineminus">-      disable: true,</span>
<a href="#l64.124"></a><span id="l64.124" class="difflineminus">-    },</span>
<a href="#l64.125"></a><span id="l64.125" class="difflineminus">-    {</span>
<a href="#l64.126"></a><span id="l64.126" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.127"></a><span id="l64.127" class="difflineminus">-      parameter: &quot;sticky&quot;,</span>
<a href="#l64.128"></a><span id="l64.128" class="difflineminus">-      modifier: &quot;=&quot;,</span>
<a href="#l64.129"></a><span id="l64.129" class="difflineminus">-      sticky: true,</span>
<a href="#l64.130"></a><span id="l64.130" class="difflineminus">-    },</span>
<a href="#l64.131"></a><span id="l64.131" class="difflineminus">-    {</span>
<a href="#l64.132"></a><span id="l64.132" class="difflineminus">-      subcommand: &quot;LS&quot;,</span>
<a href="#l64.133"></a><span id="l64.133" class="difflineminus">-      parameter: &quot;ack&quot;,</span>
<a href="#l64.134"></a><span id="l64.134" class="difflineminus">-      modifier: &quot;~&quot;,</span>
<a href="#l64.135"></a><span id="l64.135" class="difflineminus">-      ack: true,</span>
<a href="#l64.136"></a><span id="l64.136" class="difflineminus">-    }],</span>
<a href="#l64.137"></a><span id="l64.137" class="difflineplus">+    [</span>
<a href="#l64.138"></a><span id="l64.138" class="difflineplus">+      {</span>
<a href="#l64.139"></a><span id="l64.139" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.140"></a><span id="l64.140" class="difflineplus">+        parameter: &quot;disable&quot;,</span>
<a href="#l64.141"></a><span id="l64.141" class="difflineplus">+        modifier: &quot;-&quot;,</span>
<a href="#l64.142"></a><span id="l64.142" class="difflineplus">+        disable: true,</span>
<a href="#l64.143"></a><span id="l64.143" class="difflineplus">+      },</span>
<a href="#l64.144"></a><span id="l64.144" class="difflineplus">+      {</span>
<a href="#l64.145"></a><span id="l64.145" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.146"></a><span id="l64.146" class="difflineplus">+        parameter: &quot;sticky&quot;,</span>
<a href="#l64.147"></a><span id="l64.147" class="difflineplus">+        modifier: &quot;=&quot;,</span>
<a href="#l64.148"></a><span id="l64.148" class="difflineplus">+        sticky: true,</span>
<a href="#l64.149"></a><span id="l64.149" class="difflineplus">+      },</span>
<a href="#l64.150"></a><span id="l64.150" class="difflineplus">+      {</span>
<a href="#l64.151"></a><span id="l64.151" class="difflineplus">+        subcommand: &quot;LS&quot;,</span>
<a href="#l64.152"></a><span id="l64.152" class="difflineplus">+        parameter: &quot;ack&quot;,</span>
<a href="#l64.153"></a><span id="l64.153" class="difflineplus">+        modifier: &quot;~&quot;,</span>
<a href="#l64.154"></a><span id="l64.154" class="difflineplus">+        ack: true,</span>
<a href="#l64.155"></a><span id="l64.155" class="difflineplus">+      },</span>
<a href="#l64.156"></a><span id="l64.156" class="difflineplus">+    ],</span>
<a href="#l64.157"></a><span id="l64.157">   ],</span>
<a href="#l64.158"></a><span id="l64.158"> ];</span>
<a href="#l64.159"></a><span id="l64.159"> </span>
<a href="#l64.160"></a><span id="l64.160"> function run_test() {</span>
<a href="#l64.161"></a><span id="l64.161">   add_test(testCapMessages);</span>
<a href="#l64.162"></a><span id="l64.162"> </span>
<a href="#l64.163"></a><span id="l64.163">   run_next_test();</span>
<a href="#l64.164"></a><span id="l64.164"> }</span>
<a href="#l64.165"></a><span id="l64.165" class="difflineat">@@ -104,31 +116,34 @@ function testCapMessages() {</span>
<a href="#l64.166"></a><span id="l64.166">     let outputs = cap.capMessage(message);</span>
<a href="#l64.167"></a><span id="l64.167"> </span>
<a href="#l64.168"></a><span id="l64.168">     // The original message should get a cap object added with the subcommand</span>
<a href="#l64.169"></a><span id="l64.169">     // set.</span>
<a href="#l64.170"></a><span id="l64.170">     ok(message.cap);</span>
<a href="#l64.171"></a><span id="l64.171">     equal(message.cap.subcommand, data[1][0].subcommand);</span>
<a href="#l64.172"></a><span id="l64.172"> </span>
<a href="#l64.173"></a><span id="l64.173">     // We only care about the &quot;cap&quot; part of each return message.</span>
<a href="#l64.174"></a><span id="l64.174" class="difflineminus">-    outputs = outputs.map((o) =&gt; o.cap);</span>
<a href="#l64.175"></a><span id="l64.175" class="difflineplus">+    outputs = outputs.map(o =&gt; o.cap);</span>
<a href="#l64.176"></a><span id="l64.176"> </span>
<a href="#l64.177"></a><span id="l64.177">     // Ensure the expected output is an array.</span>
<a href="#l64.178"></a><span id="l64.178">     let expectedCaps = data[1];</span>
<a href="#l64.179"></a><span id="l64.179" class="difflineminus">-    if (!Array.isArray(expectedCaps))</span>
<a href="#l64.180"></a><span id="l64.180" class="difflineplus">+    if (!Array.isArray(expectedCaps)) {</span>
<a href="#l64.181"></a><span id="l64.181">       expectedCaps = [expectedCaps];</span>
<a href="#l64.182"></a><span id="l64.182" class="difflineplus">+    }</span>
<a href="#l64.183"></a><span id="l64.183"> </span>
<a href="#l64.184"></a><span id="l64.184">     // Add defaults to the expected output.</span>
<a href="#l64.185"></a><span id="l64.185">     for (let expectedCap of expectedCaps) {</span>
<a href="#l64.186"></a><span id="l64.186">       // By default there's no modifier.</span>
<a href="#l64.187"></a><span id="l64.187" class="difflineminus">-      if (!(&quot;modifier&quot; in expectedCap))</span>
<a href="#l64.188"></a><span id="l64.188" class="difflineplus">+      if (!(&quot;modifier&quot; in expectedCap)) {</span>
<a href="#l64.189"></a><span id="l64.189">         expectedCap.modifier = undefined;</span>
<a href="#l64.190"></a><span id="l64.190" class="difflineplus">+      }</span>
<a href="#l64.191"></a><span id="l64.191">       for (let param of [&quot;disable&quot;, &quot;sticky&quot;, &quot;ack&quot;]) {</span>
<a href="#l64.192"></a><span id="l64.192" class="difflineminus">-        if (!(param in expectedCap))</span>
<a href="#l64.193"></a><span id="l64.193" class="difflineplus">+        if (!(param in expectedCap)) {</span>
<a href="#l64.194"></a><span id="l64.194">           expectedCap[param] = false;</span>
<a href="#l64.195"></a><span id="l64.195" class="difflineplus">+        }</span>
<a href="#l64.196"></a><span id="l64.196">       }</span>
<a href="#l64.197"></a><span id="l64.197">     }</span>
<a href="#l64.198"></a><span id="l64.198"> </span>
<a href="#l64.199"></a><span id="l64.199">     // Ensure each item in the arrays are equal.</span>
<a href="#l64.200"></a><span id="l64.200">     deepEqual(outputs, expectedCaps);</span>
<a href="#l64.201"></a><span id="l64.201">   }</span>
<a href="#l64.202"></a><span id="l64.202"> </span>
<a href="#l64.203"></a><span id="l64.203">   run_next_test();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l65.5"></a><span id="l65.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l65.6"></a><span id="l65.6"> </span>
<a href="#l65.7"></a><span id="l65.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l65.8"></a><span id="l65.8" class="difflineminus">-var {commands} = ChromeUtils.import(&quot;resource:///modules/ircCommands.jsm&quot;);</span>
<a href="#l65.9"></a><span id="l65.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l65.10"></a><span id="l65.10" class="difflineplus">+var { commands } = ChromeUtils.import(&quot;resource:///modules/ircCommands.jsm&quot;);</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12"> var irc = {};</span>
<a href="#l65.13"></a><span id="l65.13"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l65.14"></a><span id="l65.14"> </span>
<a href="#l65.15"></a><span id="l65.15"> // Ensure the commands have been initialized.</span>
<a href="#l65.16"></a><span id="l65.16"> Services.conversations.initConversations();</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18"> var fakeProto = {</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineat">@@ -114,21 +114,22 @@ function testModeCommand() {</span>
<a href="#l65.20"></a><span id="l65.20">       expectedMessage: &quot;MODE matrixisreal_19 +oWp&quot;,</span>
<a href="#l65.21"></a><span id="l65.21">     },</span>
<a href="#l65.22"></a><span id="l65.22">     {</span>
<a href="#l65.23"></a><span id="l65.23">       msg: &quot;nick&quot;,</span>
<a href="#l65.24"></a><span id="l65.24">       expectedMessage: &quot;MODE nick&quot;,</span>
<a href="#l65.25"></a><span id="l65.25">     },</span>
<a href="#l65.26"></a><span id="l65.26">   ];</span>
<a href="#l65.27"></a><span id="l65.27"> </span>
<a href="#l65.28"></a><span id="l65.28" class="difflineminus">-  let account = new irc.ircAccount(fakeProto,</span>
<a href="#l65.29"></a><span id="l65.29" class="difflineminus">-                                   {name: &quot;defaultnick@instantbird.org&quot;});</span>
<a href="#l65.30"></a><span id="l65.30" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineplus">+    name: &quot;defaultnick@instantbird.org&quot;,</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+  });</span>
<a href="#l65.33"></a><span id="l65.33"> </span>
<a href="#l65.34"></a><span id="l65.34">   // check if the message being sent is same as expected message.</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineminus">-  account.sendRawMessage = (aMessage) =&gt; {</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineplus">+  account.sendRawMessage = aMessage =&gt; {</span>
<a href="#l65.37"></a><span id="l65.37">     equal(aMessage, account._expectedMessage);</span>
<a href="#l65.38"></a><span id="l65.38">   };</span>
<a href="#l65.39"></a><span id="l65.39"> </span>
<a href="#l65.40"></a><span id="l65.40">   const command = _getRunCommand(&quot;mode&quot;);</span>
<a href="#l65.41"></a><span id="l65.41"> </span>
<a href="#l65.42"></a><span id="l65.42">   // First test Channel Commands.</span>
<a href="#l65.43"></a><span id="l65.43">   for (let test of testChannelCommands) {</span>
<a href="#l65.44"></a><span id="l65.44">     let conv = new irc.ircConversation(account, test.channel);</span>
<a href="#l65.45"></a><span id="l65.45" class="difflineat">@@ -167,23 +168,24 @@ function testUserModeCommand() {</span>
<a href="#l65.46"></a><span id="l65.46">       expectedMessage: &quot;MODE test_nick +oWp&quot;,</span>
<a href="#l65.47"></a><span id="l65.47">     },</span>
<a href="#l65.48"></a><span id="l65.48">     {</span>
<a href="#l65.49"></a><span id="l65.49">       msg: &quot;&quot;,</span>
<a href="#l65.50"></a><span id="l65.50">       expectedMessage: &quot;MODE test_nick&quot;,</span>
<a href="#l65.51"></a><span id="l65.51">     },</span>
<a href="#l65.52"></a><span id="l65.52">   ];</span>
<a href="#l65.53"></a><span id="l65.53"> </span>
<a href="#l65.54"></a><span id="l65.54" class="difflineminus">-  let account = new irc.ircAccount(fakeProto,</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineminus">-                                   {name: &quot;test_nick@instantbird.org&quot;});</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineplus">+    name: &quot;test_nick@instantbird.org&quot;,</span>
<a href="#l65.58"></a><span id="l65.58" class="difflineplus">+  });</span>
<a href="#l65.59"></a><span id="l65.59">   account._nickname = &quot;test_nick&quot;;</span>
<a href="#l65.60"></a><span id="l65.60">   let conv = new irc.ircConversation(account, &quot;newconv&quot;);</span>
<a href="#l65.61"></a><span id="l65.61"> </span>
<a href="#l65.62"></a><span id="l65.62">   // check if the message being sent is same as expected message.</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineminus">-  account.sendRawMessage = (aMessage) =&gt; {</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+  account.sendRawMessage = aMessage =&gt; {</span>
<a href="#l65.65"></a><span id="l65.65">     equal(aMessage, account._expectedMessage);</span>
<a href="#l65.66"></a><span id="l65.66">   };</span>
<a href="#l65.67"></a><span id="l65.67"> </span>
<a href="#l65.68"></a><span id="l65.68">   const command = _getRunCommand(&quot;umode&quot;);</span>
<a href="#l65.69"></a><span id="l65.69"> </span>
<a href="#l65.70"></a><span id="l65.70">   // change the nick and runUserModeCommand for each test</span>
<a href="#l65.71"></a><span id="l65.71">   for (let test of testData) {</span>
<a href="#l65.72"></a><span id="l65.72">     account._expectedMessage = test.expectedMessage;</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineat">@@ -191,16 +193,17 @@ function testUserModeCommand() {</span>
<a href="#l65.74"></a><span id="l65.74">   }</span>
<a href="#l65.75"></a><span id="l65.75"> </span>
<a href="#l65.76"></a><span id="l65.76">   run_next_test();</span>
<a href="#l65.77"></a><span id="l65.77"> }</span>
<a href="#l65.78"></a><span id="l65.78"> </span>
<a href="#l65.79"></a><span id="l65.79"> // Fetch the run() of a named command.</span>
<a href="#l65.80"></a><span id="l65.80"> function _getRunCommand(aCommandName) {</span>
<a href="#l65.81"></a><span id="l65.81">   for (let command of commands) {</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineminus">-    if (command.name == aCommandName)</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineplus">+    if (command.name == aCommandName) {</span>
<a href="#l65.84"></a><span id="l65.84">       return command.run;</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineplus">+    }</span>
<a href="#l65.86"></a><span id="l65.86">   }</span>
<a href="#l65.87"></a><span id="l65.87"> </span>
<a href="#l65.88"></a><span id="l65.88">   // Fail if no command was found.</span>
<a href="#l65.89"></a><span id="l65.89">   ok(false, &quot;Could not find the '&quot; + aCommandName + &quot;' command.&quot;);</span>
<a href="#l65.90"></a><span id="l65.90">   return null; // Shut-up eslint.</span>
<a href="#l65.91"></a><span id="l65.91"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l66.4"></a><span id="l66.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l66.5"></a><span id="l66.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l66.6"></a><span id="l66.6"> </span>
<a href="#l66.7"></a><span id="l66.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l66.8"></a><span id="l66.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l66.9"></a><span id="l66.9"> var irc = {};</span>
<a href="#l66.10"></a><span id="l66.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12"> var testData = [</span>
<a href="#l66.13"></a><span id="l66.13">   // First off, let's test the messages from RFC 2812.</span>
<a href="#l66.14"></a><span id="l66.14">   &quot;PASS secretpasswordhere&quot;,</span>
<a href="#l66.15"></a><span id="l66.15">   &quot;NICK Wiz&quot;,</span>
<a href="#l66.16"></a><span id="l66.16">   &quot;:WiZ!jto@tolsun.oulu.fi NICK Kilroy&quot;,</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineat">@@ -128,40 +128,44 @@ function run_test() {</span>
<a href="#l66.18"></a><span id="l66.18"> /*</span>
<a href="#l66.19"></a><span id="l66.19">  * Test round tripping parsing and then rebuilding the messages from RFC 2812.</span>
<a href="#l66.20"></a><span id="l66.20">  */</span>
<a href="#l66.21"></a><span id="l66.21"> function testRFC2812Messages() {</span>
<a href="#l66.22"></a><span id="l66.22">   for (let expectedStringMessage of testData) {</span>
<a href="#l66.23"></a><span id="l66.23">     // Pass in an empty default origin in order to check this below.</span>
<a href="#l66.24"></a><span id="l66.24">     let message = irc.ircMessage(expectedStringMessage, &quot;&quot;);</span>
<a href="#l66.25"></a><span id="l66.25"> </span>
<a href="#l66.26"></a><span id="l66.26" class="difflineminus">-    let stringMessage =</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineminus">-      irc.ircAccount.prototype.buildMessage(message.command, message.params);</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+    let stringMessage = irc.ircAccount.prototype.buildMessage(</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineplus">+      message.command,</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+      message.params</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+    );</span>
<a href="#l66.32"></a><span id="l66.32"> </span>
<a href="#l66.33"></a><span id="l66.33">     // Let's do a little dance here...we don't rebuild the &quot;source&quot; of the</span>
<a href="#l66.34"></a><span id="l66.34">     // message (the server does that), so when comparing our output message, we</span>
<a href="#l66.35"></a><span id="l66.35">     // need to avoid comparing to that part.</span>
<a href="#l66.36"></a><span id="l66.36">     if (message.origin) {</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineminus">-      expectedStringMessage =</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineminus">-        expectedStringMessage.slice(expectedStringMessage.indexOf(&quot; &quot;) + 1);</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineplus">+      expectedStringMessage = expectedStringMessage.slice(</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineplus">+        expectedStringMessage.indexOf(&quot; &quot;) + 1</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineplus">+      );</span>
<a href="#l66.42"></a><span id="l66.42">     }</span>
<a href="#l66.43"></a><span id="l66.43"> </span>
<a href="#l66.44"></a><span id="l66.44">     equal(stringMessage, expectedStringMessage);</span>
<a href="#l66.45"></a><span id="l66.45">   }</span>
<a href="#l66.46"></a><span id="l66.46"> </span>
<a href="#l66.47"></a><span id="l66.47">   run_next_test();</span>
<a href="#l66.48"></a><span id="l66.48"> }</span>
<a href="#l66.49"></a><span id="l66.49"> </span>
<a href="#l66.50"></a><span id="l66.50"> // Unreal sends a couple of broken messages, see ircMessage in irc.js for a</span>
<a href="#l66.51"></a><span id="l66.51"> // description of what's wrong.</span>
<a href="#l66.52"></a><span id="l66.52"> function testBrokenUnrealMessages() {</span>
<a href="#l66.53"></a><span id="l66.53">   let messages = {</span>
<a href="#l66.54"></a><span id="l66.54">     // Two spaces after command.</span>
<a href="#l66.55"></a><span id="l66.55">     &quot;:gravel.mozilla.org 432  #momo :Erroneous Nickname: Illegal characters&quot;: {</span>
<a href="#l66.56"></a><span id="l66.56" class="difflineminus">-      rawMessage: &quot;:gravel.mozilla.org 432  #momo :Erroneous Nickname: Illegal characters&quot;,</span>
<a href="#l66.57"></a><span id="l66.57" class="difflineplus">+      rawMessage:</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineplus">+        &quot;:gravel.mozilla.org 432  #momo :Erroneous Nickname: Illegal characters&quot;,</span>
<a href="#l66.59"></a><span id="l66.59">       command: &quot;432&quot;,</span>
<a href="#l66.60"></a><span id="l66.60">       params: [&quot;&quot;, &quot;#momo&quot;, &quot;Erroneous Nickname: Illegal characters&quot;],</span>
<a href="#l66.61"></a><span id="l66.61">       origin: &quot;gravel.mozilla.org&quot;,</span>
<a href="#l66.62"></a><span id="l66.62">       user: undefined,</span>
<a href="#l66.63"></a><span id="l66.63">       host: undefined,</span>
<a href="#l66.64"></a><span id="l66.64">       source: &quot;&quot;,</span>
<a href="#l66.65"></a><span id="l66.65">       tags: new Map(),</span>
<a href="#l66.66"></a><span id="l66.66">     },</span>
<a href="#l66.67"></a><span id="l66.67" class="difflineat">@@ -184,81 +188,88 @@ function testBrokenUnrealMessages() {</span>
<a href="#l66.68"></a><span id="l66.68">       origin: &quot;services.esper.net&quot;,</span>
<a href="#l66.69"></a><span id="l66.69">       user: undefined,</span>
<a href="#l66.70"></a><span id="l66.70">       host: undefined,</span>
<a href="#l66.71"></a><span id="l66.71">       source: &quot;&quot;,</span>
<a href="#l66.72"></a><span id="l66.72">       tags: new Map(),</span>
<a href="#l66.73"></a><span id="l66.73">     },</span>
<a href="#l66.74"></a><span id="l66.74">   };</span>
<a href="#l66.75"></a><span id="l66.75"> </span>
<a href="#l66.76"></a><span id="l66.76" class="difflineminus">-  for (let messageStr in messages)</span>
<a href="#l66.77"></a><span id="l66.77" class="difflineplus">+  for (let messageStr in messages) {</span>
<a href="#l66.78"></a><span id="l66.78">     deepEqual(messages[messageStr], irc.ircMessage(messageStr, &quot;&quot;));</span>
<a href="#l66.79"></a><span id="l66.79" class="difflineplus">+  }</span>
<a href="#l66.80"></a><span id="l66.80"> </span>
<a href="#l66.81"></a><span id="l66.81">   run_next_test();</span>
<a href="#l66.82"></a><span id="l66.82"> }</span>
<a href="#l66.83"></a><span id="l66.83"> </span>
<a href="#l66.84"></a><span id="l66.84"> // After unescaping we can end up with line breaks inside of IRC messages. Test</span>
<a href="#l66.85"></a><span id="l66.85"> // this edge case specifically.</span>
<a href="#l66.86"></a><span id="l66.86"> function testNewLinesInMessages() {</span>
<a href="#l66.87"></a><span id="l66.87">   let messages = {</span>
<a href="#l66.88"></a><span id="l66.88">     &quot;:test!Instantbir@host PRIVMSG #instantbird :First line\nSecond line&quot;: {</span>
<a href="#l66.89"></a><span id="l66.89" class="difflineminus">-      rawMessage: &quot;:test!Instantbir@host PRIVMSG #instantbird :First line\nSecond line&quot;,</span>
<a href="#l66.90"></a><span id="l66.90" class="difflineplus">+      rawMessage:</span>
<a href="#l66.91"></a><span id="l66.91" class="difflineplus">+        &quot;:test!Instantbir@host PRIVMSG #instantbird :First line\nSecond line&quot;,</span>
<a href="#l66.92"></a><span id="l66.92">       command: &quot;PRIVMSG&quot;,</span>
<a href="#l66.93"></a><span id="l66.93">       params: [&quot;#instantbird&quot;, &quot;First line\nSecond line&quot;],</span>
<a href="#l66.94"></a><span id="l66.94">       origin: &quot;test&quot;,</span>
<a href="#l66.95"></a><span id="l66.95">       user: &quot;Instantbir&quot;,</span>
<a href="#l66.96"></a><span id="l66.96">       host: &quot;host&quot;,</span>
<a href="#l66.97"></a><span id="l66.97">       tags: new Map(),</span>
<a href="#l66.98"></a><span id="l66.98">       source: &quot;Instantbir@host&quot;,</span>
<a href="#l66.99"></a><span id="l66.99">     },</span>
<a href="#l66.100"></a><span id="l66.100">     &quot;:test!Instantbir@host PRIVMSG #instantbird :First line\r\nSecond line&quot;: {</span>
<a href="#l66.101"></a><span id="l66.101" class="difflineminus">-      rawMessage: &quot;:test!Instantbir@host PRIVMSG #instantbird :First line\r\nSecond line&quot;,</span>
<a href="#l66.102"></a><span id="l66.102" class="difflineplus">+      rawMessage:</span>
<a href="#l66.103"></a><span id="l66.103" class="difflineplus">+        &quot;:test!Instantbir@host PRIVMSG #instantbird :First line\r\nSecond line&quot;,</span>
<a href="#l66.104"></a><span id="l66.104">       command: &quot;PRIVMSG&quot;,</span>
<a href="#l66.105"></a><span id="l66.105">       params: [&quot;#instantbird&quot;, &quot;First line\r\nSecond line&quot;],</span>
<a href="#l66.106"></a><span id="l66.106">       origin: &quot;test&quot;,</span>
<a href="#l66.107"></a><span id="l66.107">       user: &quot;Instantbir&quot;,</span>
<a href="#l66.108"></a><span id="l66.108">       host: &quot;host&quot;,</span>
<a href="#l66.109"></a><span id="l66.109">       tags: new Map(),</span>
<a href="#l66.110"></a><span id="l66.110">       source: &quot;Instantbir@host&quot;,</span>
<a href="#l66.111"></a><span id="l66.111">     },</span>
<a href="#l66.112"></a><span id="l66.112">   };</span>
<a href="#l66.113"></a><span id="l66.113"> </span>
<a href="#l66.114"></a><span id="l66.114" class="difflineminus">-  for (let messageStr in messages)</span>
<a href="#l66.115"></a><span id="l66.115" class="difflineplus">+  for (let messageStr in messages) {</span>
<a href="#l66.116"></a><span id="l66.116">     deepEqual(messages[messageStr], irc.ircMessage(messageStr));</span>
<a href="#l66.117"></a><span id="l66.117" class="difflineplus">+  }</span>
<a href="#l66.118"></a><span id="l66.118"> </span>
<a href="#l66.119"></a><span id="l66.119">   run_next_test();</span>
<a href="#l66.120"></a><span id="l66.120"> }</span>
<a href="#l66.121"></a><span id="l66.121"> </span>
<a href="#l66.122"></a><span id="l66.122"> // Sometimes it is a bit hard to tell whether a prefix is a nickname or a</span>
<a href="#l66.123"></a><span id="l66.123"> // servername. Generally this happens when connecting to localhost or a local</span>
<a href="#l66.124"></a><span id="l66.124"> // hostname and is likely seen with bouncers.</span>
<a href="#l66.125"></a><span id="l66.125"> function testLocalhost() {</span>
<a href="#l66.126"></a><span id="l66.126">   let messages = {</span>
<a href="#l66.127"></a><span id="l66.127">     &quot;:localhost 001 clokep :Welcome to the BitlBee gateway, clokep&quot;: {</span>
<a href="#l66.128"></a><span id="l66.128" class="difflineminus">-      rawMessage: &quot;:localhost 001 clokep :Welcome to the BitlBee gateway, clokep&quot;,</span>
<a href="#l66.129"></a><span id="l66.129" class="difflineplus">+      rawMessage:</span>
<a href="#l66.130"></a><span id="l66.130" class="difflineplus">+        &quot;:localhost 001 clokep :Welcome to the BitlBee gateway, clokep&quot;,</span>
<a href="#l66.131"></a><span id="l66.131">       command: &quot;001&quot;,</span>
<a href="#l66.132"></a><span id="l66.132">       params: [&quot;clokep&quot;, &quot;Welcome to the BitlBee gateway, clokep&quot;],</span>
<a href="#l66.133"></a><span id="l66.133">       origin: &quot;localhost&quot;,</span>
<a href="#l66.134"></a><span id="l66.134">       user: undefined,</span>
<a href="#l66.135"></a><span id="l66.135">       host: undefined,</span>
<a href="#l66.136"></a><span id="l66.136">       tags: new Map(),</span>
<a href="#l66.137"></a><span id="l66.137">       source: &quot;&quot;,</span>
<a href="#l66.138"></a><span id="l66.138">     },</span>
<a href="#l66.139"></a><span id="l66.139">   };</span>
<a href="#l66.140"></a><span id="l66.140"> </span>
<a href="#l66.141"></a><span id="l66.141" class="difflineminus">-  for (let messageStr in messages)</span>
<a href="#l66.142"></a><span id="l66.142" class="difflineplus">+  for (let messageStr in messages) {</span>
<a href="#l66.143"></a><span id="l66.143">     deepEqual(messages[messageStr], irc.ircMessage(messageStr));</span>
<a href="#l66.144"></a><span id="l66.144" class="difflineplus">+  }</span>
<a href="#l66.145"></a><span id="l66.145"> </span>
<a href="#l66.146"></a><span id="l66.146">   run_next_test();</span>
<a href="#l66.147"></a><span id="l66.147"> }</span>
<a href="#l66.148"></a><span id="l66.148"> </span>
<a href="#l66.149"></a><span id="l66.149"> function testTags() {</span>
<a href="#l66.150"></a><span id="l66.150">   let messages = {</span>
<a href="#l66.151"></a><span id="l66.151">     &quot;@aaa=bBb;ccc;example.com/ddd=eee :nick!ident@host.com PRIVMSG me :Hello&quot;: {</span>
<a href="#l66.152"></a><span id="l66.152" class="difflineminus">-      rawMessage: &quot;@aaa=bBb;ccc;example.com/ddd=eee :nick!ident@host.com PRIVMSG me :Hello&quot;,</span>
<a href="#l66.153"></a><span id="l66.153" class="difflineplus">+      rawMessage:</span>
<a href="#l66.154"></a><span id="l66.154" class="difflineplus">+        &quot;@aaa=bBb;ccc;example.com/ddd=eee :nick!ident@host.com PRIVMSG me :Hello&quot;,</span>
<a href="#l66.155"></a><span id="l66.155">       command: &quot;PRIVMSG&quot;,</span>
<a href="#l66.156"></a><span id="l66.156">       params: [&quot;me&quot;, &quot;Hello&quot;],</span>
<a href="#l66.157"></a><span id="l66.157">       origin: &quot;nick&quot;,</span>
<a href="#l66.158"></a><span id="l66.158">       user: &quot;ident&quot;,</span>
<a href="#l66.159"></a><span id="l66.159">       host: &quot;host.com&quot;,</span>
<a href="#l66.160"></a><span id="l66.160">       tags: new Map([</span>
<a href="#l66.161"></a><span id="l66.161">         [&quot;aaa&quot;, &quot;bBb&quot;],</span>
<a href="#l66.162"></a><span id="l66.162">         [&quot;ccc&quot;, undefined],</span>
<a href="#l66.163"></a><span id="l66.163" class="difflineat">@@ -270,60 +281,52 @@ function testTags() {</span>
<a href="#l66.164"></a><span id="l66.164">       rawMessage: &quot;@xn--e1afmkfd.org/foo :nick@host.com PRIVMSG him :Test&quot;,</span>
<a href="#l66.165"></a><span id="l66.165">       command: &quot;PRIVMSG&quot;,</span>
<a href="#l66.166"></a><span id="l66.166">       params: [&quot;him&quot;, &quot;Test&quot;],</span>
<a href="#l66.167"></a><span id="l66.167">       origin: &quot;nick&quot;,</span>
<a href="#l66.168"></a><span id="l66.168">       // Note that this is a bug, it should be undefined for user and host.com</span>
<a href="#l66.169"></a><span id="l66.169">       // for host/source.</span>
<a href="#l66.170"></a><span id="l66.170">       user: &quot;host.com&quot;,</span>
<a href="#l66.171"></a><span id="l66.171">       host: undefined,</span>
<a href="#l66.172"></a><span id="l66.172" class="difflineminus">-      tags: new Map([</span>
<a href="#l66.173"></a><span id="l66.173" class="difflineminus">-        [&quot;xn--e1afmkfd.org/foo&quot;, undefined],</span>
<a href="#l66.174"></a><span id="l66.174" class="difflineminus">-      ]),</span>
<a href="#l66.175"></a><span id="l66.175" class="difflineplus">+      tags: new Map([[&quot;xn--e1afmkfd.org/foo&quot;, undefined]]),</span>
<a href="#l66.176"></a><span id="l66.176">       source: &quot;host.com@undefined&quot;,</span>
<a href="#l66.177"></a><span id="l66.177">     },</span>
<a href="#l66.178"></a><span id="l66.178">     &quot;@aaa=\\\\n\\:\\n\\r\\s :nick@host.com PRIVMSG it :Yes&quot;: {</span>
<a href="#l66.179"></a><span id="l66.179">       rawMessage: &quot;@aaa=\\\\n\\:\\n\\r\\s :nick@host.com PRIVMSG it :Yes&quot;,</span>
<a href="#l66.180"></a><span id="l66.180">       command: &quot;PRIVMSG&quot;,</span>
<a href="#l66.181"></a><span id="l66.181">       params: [&quot;it&quot;, &quot;Yes&quot;],</span>
<a href="#l66.182"></a><span id="l66.182">       origin: &quot;nick&quot;,</span>
<a href="#l66.183"></a><span id="l66.183">       // Note that this is a bug, it should be undefined for user and host.com</span>
<a href="#l66.184"></a><span id="l66.184">       // for host/source.</span>
<a href="#l66.185"></a><span id="l66.185">       user: &quot;host.com&quot;,</span>
<a href="#l66.186"></a><span id="l66.186">       host: undefined,</span>
<a href="#l66.187"></a><span id="l66.187" class="difflineminus">-      tags: new Map([</span>
<a href="#l66.188"></a><span id="l66.188" class="difflineminus">-        [&quot;aaa&quot;, &quot;\\n;\n\r &quot;],</span>
<a href="#l66.189"></a><span id="l66.189" class="difflineminus">-      ]),</span>
<a href="#l66.190"></a><span id="l66.190" class="difflineplus">+      tags: new Map([[&quot;aaa&quot;, &quot;\\n;\n\r &quot;]]),</span>
<a href="#l66.191"></a><span id="l66.191">       source: &quot;host.com@undefined&quot;,</span>
<a href="#l66.192"></a><span id="l66.192">     },</span>
<a href="#l66.193"></a><span id="l66.193">     &quot;@c;h=;a=b :quux ab cd&quot;: {</span>
<a href="#l66.194"></a><span id="l66.194">       rawMessage: &quot;@c;h=;a=b :quux ab cd&quot;,</span>
<a href="#l66.195"></a><span id="l66.195">       command: &quot;ab&quot;,</span>
<a href="#l66.196"></a><span id="l66.196">       params: [&quot;cd&quot;],</span>
<a href="#l66.197"></a><span id="l66.197">       origin: &quot;quux&quot;,</span>
<a href="#l66.198"></a><span id="l66.198">       user: undefined,</span>
<a href="#l66.199"></a><span id="l66.199">       host: undefined,</span>
<a href="#l66.200"></a><span id="l66.200" class="difflineminus">-      tags: new Map([</span>
<a href="#l66.201"></a><span id="l66.201" class="difflineminus">-        [&quot;c&quot;, undefined],</span>
<a href="#l66.202"></a><span id="l66.202" class="difflineminus">-        [&quot;h&quot;, &quot;&quot;],</span>
<a href="#l66.203"></a><span id="l66.203" class="difflineminus">-        [&quot;a&quot;, &quot;b&quot;],</span>
<a href="#l66.204"></a><span id="l66.204" class="difflineminus">-      ]),</span>
<a href="#l66.205"></a><span id="l66.205" class="difflineplus">+      tags: new Map([[&quot;c&quot;, undefined], [&quot;h&quot;, &quot;&quot;], [&quot;a&quot;, &quot;b&quot;]]),</span>
<a href="#l66.206"></a><span id="l66.206">       source: &quot;&quot;,</span>
<a href="#l66.207"></a><span id="l66.207">     },</span>
<a href="#l66.208"></a><span id="l66.208">     &quot;@time=2012-06-30T23:59:60.419Z :John!~john@1.2.3.4 JOIN #chan&quot;: {</span>
<a href="#l66.209"></a><span id="l66.209" class="difflineminus">-      rawMessage: &quot;@time=2012-06-30T23:59:60.419Z :John!~john@1.2.3.4 JOIN #chan&quot;,</span>
<a href="#l66.210"></a><span id="l66.210" class="difflineplus">+      rawMessage:</span>
<a href="#l66.211"></a><span id="l66.211" class="difflineplus">+        &quot;@time=2012-06-30T23:59:60.419Z :John!~john@1.2.3.4 JOIN #chan&quot;,</span>
<a href="#l66.212"></a><span id="l66.212">       command: &quot;JOIN&quot;,</span>
<a href="#l66.213"></a><span id="l66.213">       params: [&quot;#chan&quot;],</span>
<a href="#l66.214"></a><span id="l66.214">       origin: &quot;John&quot;,</span>
<a href="#l66.215"></a><span id="l66.215">       user: &quot;~john&quot;,</span>
<a href="#l66.216"></a><span id="l66.216">       host: &quot;1.2.3.4&quot;,</span>
<a href="#l66.217"></a><span id="l66.217" class="difflineminus">-      tags: new Map([</span>
<a href="#l66.218"></a><span id="l66.218" class="difflineminus">-        [&quot;time&quot;, &quot;2012-06-30T23:59:60.419Z&quot;],</span>
<a href="#l66.219"></a><span id="l66.219" class="difflineminus">-      ]),</span>
<a href="#l66.220"></a><span id="l66.220" class="difflineplus">+      tags: new Map([[&quot;time&quot;, &quot;2012-06-30T23:59:60.419Z&quot;]]),</span>
<a href="#l66.221"></a><span id="l66.221">       source: &quot;~john@1.2.3.4&quot;,</span>
<a href="#l66.222"></a><span id="l66.222">     },</span>
<a href="#l66.223"></a><span id="l66.223">   };</span>
<a href="#l66.224"></a><span id="l66.224"> </span>
<a href="#l66.225"></a><span id="l66.225" class="difflineminus">-  for (let messageStr in messages)</span>
<a href="#l66.226"></a><span id="l66.226" class="difflineplus">+  for (let messageStr in messages) {</span>
<a href="#l66.227"></a><span id="l66.227">     deepEqual(messages[messageStr], irc.ircMessage(messageStr, &quot;&quot;));</span>
<a href="#l66.228"></a><span id="l66.228" class="difflineplus">+  }</span>
<a href="#l66.229"></a><span id="l66.229"> </span>
<a href="#l66.230"></a><span id="l66.230">   run_next_test();</span>
<a href="#l66.231"></a><span id="l66.231"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircNonStandard.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircNonStandard.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -1,15 +1,17 @@</span>
<a href="#l67.4"></a><span id="l67.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l67.5"></a><span id="l67.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l67.6"></a><span id="l67.6"> </span>
<a href="#l67.7"></a><span id="l67.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l67.8"></a><span id="l67.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l67.9"></a><span id="l67.9"> var irc = {};</span>
<a href="#l67.10"></a><span id="l67.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l67.11"></a><span id="l67.11" class="difflineminus">-const {ircNonStandard} = ChromeUtils.import(&quot;resource:///modules/ircNonStandard.jsm&quot;);</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineplus">+const { ircNonStandard } = ChromeUtils.import(</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+  &quot;resource:///modules/ircNonStandard.jsm&quot;</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+);</span>
<a href="#l67.15"></a><span id="l67.15"> </span>
<a href="#l67.16"></a><span id="l67.16"> // The function that is under test here.</span>
<a href="#l67.17"></a><span id="l67.17"> var NOTICE = ircNonStandard.commands.NOTICE;</span>
<a href="#l67.18"></a><span id="l67.18"> </span>
<a href="#l67.19"></a><span id="l67.19"> function FakeConversation() {}</span>
<a href="#l67.20"></a><span id="l67.20"> FakeConversation.prototype = {</span>
<a href="#l67.21"></a><span id="l67.21">   writeMessage(aSender, aTarget, aOpts) {},</span>
<a href="#l67.22"></a><span id="l67.22"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircServerTime.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircServerTime.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -1,76 +1,96 @@</span>
<a href="#l68.4"></a><span id="l68.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l68.5"></a><span id="l68.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l68.6"></a><span id="l68.6"> </span>
<a href="#l68.7"></a><span id="l68.7" class="difflineminus">-var {tagServerTime} = ChromeUtils.import(&quot;resource:///modules/ircServerTime.jsm&quot;);</span>
<a href="#l68.8"></a><span id="l68.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l68.9"></a><span id="l68.9" class="difflineplus">+var { tagServerTime } = ChromeUtils.import(</span>
<a href="#l68.10"></a><span id="l68.10" class="difflineplus">+  &quot;resource:///modules/ircServerTime.jsm&quot;</span>
<a href="#l68.11"></a><span id="l68.11" class="difflineplus">+);</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l68.13"></a><span id="l68.13"> </span>
<a href="#l68.14"></a><span id="l68.14"> var irc = {};</span>
<a href="#l68.15"></a><span id="l68.15"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l68.16"></a><span id="l68.16"> </span>
<a href="#l68.17"></a><span id="l68.17"> function getTags(aRawMsg) {</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineminus">-  const {tags} = irc.ircMessage(aRawMsg, &quot;doesnt@matter&quot;);</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+  const { tags } = irc.ircMessage(aRawMsg, &quot;doesnt@matter&quot;);</span>
<a href="#l68.20"></a><span id="l68.20"> </span>
<a href="#l68.21"></a><span id="l68.21">   return tags;</span>
<a href="#l68.22"></a><span id="l68.22"> }</span>
<a href="#l68.23"></a><span id="l68.23"> </span>
<a href="#l68.24"></a><span id="l68.24"> function run_test() {</span>
<a href="#l68.25"></a><span id="l68.25">   add_test(specMessages);</span>
<a href="#l68.26"></a><span id="l68.26"> </span>
<a href="#l68.27"></a><span id="l68.27">   run_next_test();</span>
<a href="#l68.28"></a><span id="l68.28"> }</span>
<a href="#l68.29"></a><span id="l68.29"> </span>
<a href="#l68.30"></a><span id="l68.30"> function specMessages() {</span>
<a href="#l68.31"></a><span id="l68.31">   const kMessages = [</span>
<a href="#l68.32"></a><span id="l68.32">     {</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineminus">-      tags: getTags(&quot;@time=2011-10-19T16:40:51.620Z :Angel!angel@example.com PRIVMSG #test :Hello&quot;),</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+      tags: getTags(</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+        &quot;@time=2011-10-19T16:40:51.620Z :Angel!angel@example.com PRIVMSG #test :Hello&quot;</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+      ),</span>
<a href="#l68.37"></a><span id="l68.37">       who: &quot;Angel!angel@example.com&quot;,</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineminus">-      get originalMessage() { return &quot;Hello&quot;; },</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineplus">+      get originalMessage() {</span>
<a href="#l68.40"></a><span id="l68.40" class="difflineplus">+        return &quot;Hello&quot;;</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineplus">+      },</span>
<a href="#l68.42"></a><span id="l68.42">       message: &quot;Hello&quot;,</span>
<a href="#l68.43"></a><span id="l68.43">       incoming: true,</span>
<a href="#l68.44"></a><span id="l68.44">     },</span>
<a href="#l68.45"></a><span id="l68.45">     {</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineminus">-      tags: getTags(&quot;@time=2012-06-30T23:59:60.419Z :John!~john@1.2.3.4 JOIN #chan&quot;),</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineplus">+      tags: getTags(</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineplus">+        &quot;@time=2012-06-30T23:59:60.419Z :John!~john@1.2.3.4 JOIN #chan&quot;</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+      ),</span>
<a href="#l68.50"></a><span id="l68.50">       who: &quot;John!~john@1.2.3.4&quot;,</span>
<a href="#l68.51"></a><span id="l68.51">       message: &quot;John joined #chan&quot;,</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineminus">-      get originalMessage() { return &quot;John joined #chan&quot;; },</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+      get originalMessage() {</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+        return &quot;John joined #chan&quot;;</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineplus">+      },</span>
<a href="#l68.56"></a><span id="l68.56">       system: true,</span>
<a href="#l68.57"></a><span id="l68.57">       incoming: true,</span>
<a href="#l68.58"></a><span id="l68.58">     },</span>
<a href="#l68.59"></a><span id="l68.59">     {</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineminus">-      tags: getTags(&quot;@znc.in/server-time-iso=2016-11-13T19:20:45.284Z :John!~john@1.2.3.4 JOIN #chan&quot;),</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineplus">+      tags: getTags(</span>
<a href="#l68.62"></a><span id="l68.62" class="difflineplus">+        &quot;@znc.in/server-time-iso=2016-11-13T19:20:45.284Z :John!~john@1.2.3.4 JOIN #chan&quot;</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineplus">+      ),</span>
<a href="#l68.64"></a><span id="l68.64">       who: &quot;John!~john@1.2.3.4&quot;,</span>
<a href="#l68.65"></a><span id="l68.65">       message: &quot;John joined #chan&quot;,</span>
<a href="#l68.66"></a><span id="l68.66" class="difflineminus">-      get originalMessage() { return &quot;John joined #chan&quot;; },</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineplus">+      get originalMessage() {</span>
<a href="#l68.68"></a><span id="l68.68" class="difflineplus">+        return &quot;John joined #chan&quot;;</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineplus">+      },</span>
<a href="#l68.70"></a><span id="l68.70">       system: true,</span>
<a href="#l68.71"></a><span id="l68.71">       incoming: true,</span>
<a href="#l68.72"></a><span id="l68.72">     },</span>
<a href="#l68.73"></a><span id="l68.73">     {</span>
<a href="#l68.74"></a><span id="l68.74">       tags: getTags(&quot;@time= :empty!Empty@host.local JOIN #test&quot;),</span>
<a href="#l68.75"></a><span id="l68.75">       who: &quot;empty!Empty@localhost&quot;,</span>
<a href="#l68.76"></a><span id="l68.76">       message: &quot;Empty joined #test&quot;,</span>
<a href="#l68.77"></a><span id="l68.77" class="difflineminus">-      get originalMessage() { return &quot;Empty joined #test&quot;; },</span>
<a href="#l68.78"></a><span id="l68.78" class="difflineplus">+      get originalMessage() {</span>
<a href="#l68.79"></a><span id="l68.79" class="difflineplus">+        return &quot;Empty joined #test&quot;;</span>
<a href="#l68.80"></a><span id="l68.80" class="difflineplus">+      },</span>
<a href="#l68.81"></a><span id="l68.81">       system: true,</span>
<a href="#l68.82"></a><span id="l68.82">       incoming: true,</span>
<a href="#l68.83"></a><span id="l68.83">     },</span>
<a href="#l68.84"></a><span id="l68.84">     {</span>
<a href="#l68.85"></a><span id="l68.85">       tags: getTags(&quot;NoTags!notags@1.2.3.4 PART #test&quot;),</span>
<a href="#l68.86"></a><span id="l68.86">       who: &quot;NoTags!notags@1.2.3.4&quot;,</span>
<a href="#l68.87"></a><span id="l68.87">       message: &quot;NoTags left #test&quot;,</span>
<a href="#l68.88"></a><span id="l68.88" class="difflineminus">-      get originalMessage() { return &quot;NoTags left #test&quot;; },</span>
<a href="#l68.89"></a><span id="l68.89" class="difflineplus">+      get originalMessage() {</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineplus">+        return &quot;NoTags left #test&quot;;</span>
<a href="#l68.91"></a><span id="l68.91" class="difflineplus">+      },</span>
<a href="#l68.92"></a><span id="l68.92">       system: true,</span>
<a href="#l68.93"></a><span id="l68.93">       incoming: true,</span>
<a href="#l68.94"></a><span id="l68.94">     },</span>
<a href="#l68.95"></a><span id="l68.95">   ];</span>
<a href="#l68.96"></a><span id="l68.96"> </span>
<a href="#l68.97"></a><span id="l68.97">   const kExpectedTimes = [</span>
<a href="#l68.98"></a><span id="l68.98">     Math.floor(Date.parse(kMessages[0].tags.get(&quot;time&quot;)) / 1000),</span>
<a href="#l68.99"></a><span id="l68.99">     Math.floor(Date.parse(&quot;2012-06-30T23:59:59.999Z&quot;) / 1000),</span>
<a href="#l68.100"></a><span id="l68.100" class="difflineminus">-    Math.floor(Date.parse(kMessages[2].tags.get(&quot;znc.in/server-time-iso&quot;)) / 1000),</span>
<a href="#l68.101"></a><span id="l68.101" class="difflineplus">+    Math.floor(</span>
<a href="#l68.102"></a><span id="l68.102" class="difflineplus">+      Date.parse(kMessages[2].tags.get(&quot;znc.in/server-time-iso&quot;)) / 1000</span>
<a href="#l68.103"></a><span id="l68.103" class="difflineplus">+    ),</span>
<a href="#l68.104"></a><span id="l68.104">     undefined,</span>
<a href="#l68.105"></a><span id="l68.105">     undefined,</span>
<a href="#l68.106"></a><span id="l68.106">   ];</span>
<a href="#l68.107"></a><span id="l68.107"> </span>
<a href="#l68.108"></a><span id="l68.108">   for (let m in kMessages) {</span>
<a href="#l68.109"></a><span id="l68.109">     const msg = kMessages[m];</span>
<a href="#l68.110"></a><span id="l68.110">     const isZNC = kMessages[m].tags.has(&quot;znc.in/server-time-iso&quot;);</span>
<a href="#l68.111"></a><span id="l68.111">     const tag = isZNC ? &quot;znc.in/server-time-iso&quot; : &quot;time&quot;;</span>
<a href="#l68.112"></a><span id="l68.112" class="difflineat">@@ -79,21 +99,33 @@ function specMessages() {</span>
<a href="#l68.113"></a><span id="l68.113">       tagName: tag,</span>
<a href="#l68.114"></a><span id="l68.114">       tagValue: msg.tags.get(tag),</span>
<a href="#l68.115"></a><span id="l68.115">     };</span>
<a href="#l68.116"></a><span id="l68.116">     tagServerTime.commands[tag](tagMessage);</span>
<a href="#l68.117"></a><span id="l68.117"> </span>
<a href="#l68.118"></a><span id="l68.118">     // Ensuring that the expected properties and their values as given in</span>
<a href="#l68.119"></a><span id="l68.119">     // kMessages are still the same after the handler.</span>
<a href="#l68.120"></a><span id="l68.120">     for (let i in msg) {</span>
<a href="#l68.121"></a><span id="l68.121" class="difflineminus">-      equal(tagMessage.message[i], msg[i], &quot;Property '&quot; + i + &quot;' was not modified&quot;);</span>
<a href="#l68.122"></a><span id="l68.122" class="difflineplus">+      equal(</span>
<a href="#l68.123"></a><span id="l68.123" class="difflineplus">+        tagMessage.message[i],</span>
<a href="#l68.124"></a><span id="l68.124" class="difflineplus">+        msg[i],</span>
<a href="#l68.125"></a><span id="l68.125" class="difflineplus">+        &quot;Property '&quot; + i + &quot;' was not modified&quot;</span>
<a href="#l68.126"></a><span id="l68.126" class="difflineplus">+      );</span>
<a href="#l68.127"></a><span id="l68.127">     }</span>
<a href="#l68.128"></a><span id="l68.128">     // The time should only be adjusted when we expect a valid server-time tag.</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineminus">-    equal(&quot;time&quot; in tagMessage.message, kExpectedTimes[m] !== undefined, &quot;Message time was set when expected&quot;);</span>
<a href="#l68.130"></a><span id="l68.130" class="difflineplus">+    equal(</span>
<a href="#l68.131"></a><span id="l68.131" class="difflineplus">+      &quot;time&quot; in tagMessage.message,</span>
<a href="#l68.132"></a><span id="l68.132" class="difflineplus">+      kExpectedTimes[m] !== undefined,</span>
<a href="#l68.133"></a><span id="l68.133" class="difflineplus">+      &quot;Message time was set when expected&quot;</span>
<a href="#l68.134"></a><span id="l68.134" class="difflineplus">+    );</span>
<a href="#l68.135"></a><span id="l68.135"> </span>
<a href="#l68.136"></a><span id="l68.136">     if (kExpectedTimes[m] !== undefined) {</span>
<a href="#l68.137"></a><span id="l68.137">       ok(tagMessage.message.delayed, &quot;Delayed flag was set&quot;);</span>
<a href="#l68.138"></a><span id="l68.138" class="difflineminus">-      equal(kExpectedTimes[m], tagMessage.message.time, &quot;Time was parsed properly&quot;);</span>
<a href="#l68.139"></a><span id="l68.139" class="difflineplus">+      equal(</span>
<a href="#l68.140"></a><span id="l68.140" class="difflineplus">+        kExpectedTimes[m],</span>
<a href="#l68.141"></a><span id="l68.141" class="difflineplus">+        tagMessage.message.time,</span>
<a href="#l68.142"></a><span id="l68.142" class="difflineplus">+        &quot;Time was parsed properly&quot;</span>
<a href="#l68.143"></a><span id="l68.143" class="difflineplus">+      );</span>
<a href="#l68.144"></a><span id="l68.144">     }</span>
<a href="#l68.145"></a><span id="l68.145">   }</span>
<a href="#l68.146"></a><span id="l68.146"> </span>
<a href="#l68.147"></a><span id="l68.147">   run_next_test();</span>
<a href="#l68.148"></a><span id="l68.148"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/chat/protocols/irc/test/test_sendBufferedCommand.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_sendBufferedCommand.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -1,94 +1,99 @@</span>
<a href="#l69.4"></a><span id="l69.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l69.5"></a><span id="l69.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l69.6"></a><span id="l69.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l69.7"></a><span id="l69.7"> </span>
<a href="#l69.8"></a><span id="l69.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l69.9"></a><span id="l69.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l69.10"></a><span id="l69.10"> var irc = {};</span>
<a href="#l69.11"></a><span id="l69.11"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l69.12"></a><span id="l69.12"> </span>
<a href="#l69.13"></a><span id="l69.13"> function FakeAccount() {</span>
<a href="#l69.14"></a><span id="l69.14">   this._commandBuffers = new Map();</span>
<a href="#l69.15"></a><span id="l69.15">   this.callbacks = [];</span>
<a href="#l69.16"></a><span id="l69.16"> }</span>
<a href="#l69.17"></a><span id="l69.17"> FakeAccount.prototype = {</span>
<a href="#l69.18"></a><span id="l69.18">   __proto__: irc.ircAccount.prototype,</span>
<a href="#l69.19"></a><span id="l69.19">   maxMessageLength: 60,</span>
<a href="#l69.20"></a><span id="l69.20">   callbacks: [],</span>
<a href="#l69.21"></a><span id="l69.21">   sendMessage(aCommand, aParams) {</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineminus">-    (this.callbacks.shift())(aCommand, aParams);</span>
<a href="#l69.23"></a><span id="l69.23" class="difflineplus">+    this.callbacks.shift()(aCommand, aParams);</span>
<a href="#l69.24"></a><span id="l69.24">   },</span>
<a href="#l69.25"></a><span id="l69.25"> };</span>
<a href="#l69.26"></a><span id="l69.26"> </span>
<a href="#l69.27"></a><span id="l69.27"> var account = new FakeAccount();</span>
<a href="#l69.28"></a><span id="l69.28"> </span>
<a href="#l69.29"></a><span id="l69.29"> function run_test() {</span>
<a href="#l69.30"></a><span id="l69.30">   test_parameterCollect();</span>
<a href="#l69.31"></a><span id="l69.31">   test_maxLength();</span>
<a href="#l69.32"></a><span id="l69.32">   run_next_test();</span>
<a href="#l69.33"></a><span id="l69.33"> }</span>
<a href="#l69.34"></a><span id="l69.34"> </span>
<a href="#l69.35"></a><span id="l69.35"> function test_parameterCollect() {</span>
<a href="#l69.36"></a><span id="l69.36">   // Individual tests, data consisting of [channel, key] pairs.</span>
<a href="#l69.37"></a><span id="l69.37">   let tests = [</span>
<a href="#l69.38"></a><span id="l69.38">     {</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineminus">-      data: [[&quot;one&quot;], [&quot;one&quot;]],  // also tests deduplication</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineplus">+      data: [[&quot;one&quot;], [&quot;one&quot;]], // also tests deduplication</span>
<a href="#l69.41"></a><span id="l69.41">       result: &quot;JOIN one&quot;,</span>
<a href="#l69.42"></a><span id="l69.42">     },</span>
<a href="#l69.43"></a><span id="l69.43">     {</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineminus">-      data: [[&quot;one&quot;, &quot;&quot;]],  // explicit empty password string</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineplus">+      data: [[&quot;one&quot;, &quot;&quot;]], // explicit empty password string</span>
<a href="#l69.46"></a><span id="l69.46">       result: &quot;JOIN one&quot;,</span>
<a href="#l69.47"></a><span id="l69.47">     },</span>
<a href="#l69.48"></a><span id="l69.48">     {</span>
<a href="#l69.49"></a><span id="l69.49">       data: [[&quot;one&quot;], [&quot;two&quot;], [&quot;three&quot;]],</span>
<a href="#l69.50"></a><span id="l69.50">       result: &quot;JOIN one,two,three&quot;,</span>
<a href="#l69.51"></a><span id="l69.51">     },</span>
<a href="#l69.52"></a><span id="l69.52">     {</span>
<a href="#l69.53"></a><span id="l69.53">       data: [[&quot;one&quot;], [&quot;two&quot;, &quot;password&quot;], [&quot;three&quot;]],</span>
<a href="#l69.54"></a><span id="l69.54">       result: &quot;JOIN two,one,three password&quot;,</span>
<a href="#l69.55"></a><span id="l69.55">     },</span>
<a href="#l69.56"></a><span id="l69.56">     {</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineminus">-      data: [[&quot;one&quot;], [&quot;two&quot;, &quot;password&quot;], [&quot;three&quot;],</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineminus">-             [&quot;four&quot;, &quot;anotherpassword&quot;]],</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineplus">+      data: [</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineplus">+        [&quot;one&quot;],</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+        [&quot;two&quot;, &quot;password&quot;],</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineplus">+        [&quot;three&quot;],</span>
<a href="#l69.63"></a><span id="l69.63" class="difflineplus">+        [&quot;four&quot;, &quot;anotherpassword&quot;],</span>
<a href="#l69.64"></a><span id="l69.64" class="difflineplus">+      ],</span>
<a href="#l69.65"></a><span id="l69.65">       result: &quot;JOIN two,four,one,three password,anotherpassword&quot;,</span>
<a href="#l69.66"></a><span id="l69.66">     },</span>
<a href="#l69.67"></a><span id="l69.67">   ];</span>
<a href="#l69.68"></a><span id="l69.68"> </span>
<a href="#l69.69"></a><span id="l69.69">   for (let test of tests) {</span>
<a href="#l69.70"></a><span id="l69.70">     let timeout;</span>
<a href="#l69.71"></a><span id="l69.71">     // Destructure test to local variables so each function</span>
<a href="#l69.72"></a><span id="l69.72">     // generated here gets the correct value in its scope.</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineminus">-    let {data, result} = test;</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineplus">+    let { data, result } = test;</span>
<a href="#l69.75"></a><span id="l69.75">     account.callbacks.push((aCommand, aParams) =&gt; {</span>
<a href="#l69.76"></a><span id="l69.76">       let msg = account.buildMessage(aCommand, aParams);</span>
<a href="#l69.77"></a><span id="l69.77">       equal(msg, result, &quot;Test buffering of parameters&quot;);</span>
<a href="#l69.78"></a><span id="l69.78">       irc.clearTimeout(timeout);</span>
<a href="#l69.79"></a><span id="l69.79">       account._lastCommandSendTime = 0;</span>
<a href="#l69.80"></a><span id="l69.80">       run_next_test();</span>
<a href="#l69.81"></a><span id="l69.81">     });</span>
<a href="#l69.82"></a><span id="l69.82">     add_test(() =&gt; {</span>
<a href="#l69.83"></a><span id="l69.83">       // This timeout lets the test fail more quickly if</span>
<a href="#l69.84"></a><span id="l69.84">       // some of the callbacks we added don't get called.</span>
<a href="#l69.85"></a><span id="l69.85">       // Not strictly speaking necessary.</span>
<a href="#l69.86"></a><span id="l69.86">       timeout = irc.setTimeout(() =&gt; {</span>
<a href="#l69.87"></a><span id="l69.87">         ok(false, &quot;test_parameterCollect failed after timeout.&quot;);</span>
<a href="#l69.88"></a><span id="l69.88">         run_next_test();</span>
<a href="#l69.89"></a><span id="l69.89">       }, 2000);</span>
<a href="#l69.90"></a><span id="l69.90" class="difflineminus">-      for (let [channel, key] of data)</span>
<a href="#l69.91"></a><span id="l69.91" class="difflineplus">+      for (let [channel, key] of data) {</span>
<a href="#l69.92"></a><span id="l69.92">         account.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l69.93"></a><span id="l69.93" class="difflineplus">+      }</span>
<a href="#l69.94"></a><span id="l69.94">     });</span>
<a href="#l69.95"></a><span id="l69.95">   }</span>
<a href="#l69.96"></a><span id="l69.96"> </span>
<a href="#l69.97"></a><span id="l69.97">   // Test this still works when adding commands on different ticks of</span>
<a href="#l69.98"></a><span id="l69.98">   // the event loop.</span>
<a href="#l69.99"></a><span id="l69.99">   account._lastCommandSendTime = 0;</span>
<a href="#l69.100"></a><span id="l69.100">   for (let test of tests) {</span>
<a href="#l69.101"></a><span id="l69.101">     let timeout;</span>
<a href="#l69.102"></a><span id="l69.102" class="difflineminus">-    let {data, result} = test;</span>
<a href="#l69.103"></a><span id="l69.103" class="difflineplus">+    let { data, result } = test;</span>
<a href="#l69.104"></a><span id="l69.104">     account.callbacks.push((aCommand, aParams) =&gt; {</span>
<a href="#l69.105"></a><span id="l69.105">       let msg = account.buildMessage(aCommand, aParams);</span>
<a href="#l69.106"></a><span id="l69.106">       equal(msg, result, &quot;Test buffering with setTimeout&quot;);</span>
<a href="#l69.107"></a><span id="l69.107">       irc.clearTimeout(timeout);</span>
<a href="#l69.108"></a><span id="l69.108">       run_next_test();</span>
<a href="#l69.109"></a><span id="l69.109">     });</span>
<a href="#l69.110"></a><span id="l69.110">     add_test(() =&gt; {</span>
<a href="#l69.111"></a><span id="l69.111">       // This timeout lets the test fail more quickly if</span>
<a href="#l69.112"></a><span id="l69.112" class="difflineat">@@ -108,43 +113,59 @@ function test_parameterCollect() {</span>
<a href="#l69.113"></a><span id="l69.113">       }</span>
<a href="#l69.114"></a><span id="l69.114">     });</span>
<a href="#l69.115"></a><span id="l69.115">   }</span>
<a href="#l69.116"></a><span id="l69.116"> }</span>
<a href="#l69.117"></a><span id="l69.117"> </span>
<a href="#l69.118"></a><span id="l69.118"> function test_maxLength() {</span>
<a href="#l69.119"></a><span id="l69.119">   let tests = [</span>
<a href="#l69.120"></a><span id="l69.120">     {</span>
<a href="#l69.121"></a><span id="l69.121" class="difflineminus">-      data: [[&quot;applecustard&quot;], [&quot;pearpie&quot;], [&quot;strawberryfield&quot;],</span>
<a href="#l69.122"></a><span id="l69.122" class="difflineminus">-        [&quot;blueberrypancake&quot;], [&quot;mangojuice&quot;], [&quot;raspberryberet&quot;],</span>
<a href="#l69.123"></a><span id="l69.123" class="difflineminus">-        [&quot;pineapplesoup&quot;], [&quot;limejelly&quot;], [&quot;lemonsorbet&quot;]],</span>
<a href="#l69.124"></a><span id="l69.124" class="difflineplus">+      data: [</span>
<a href="#l69.125"></a><span id="l69.125" class="difflineplus">+        [&quot;applecustard&quot;],</span>
<a href="#l69.126"></a><span id="l69.126" class="difflineplus">+        [&quot;pearpie&quot;],</span>
<a href="#l69.127"></a><span id="l69.127" class="difflineplus">+        [&quot;strawberryfield&quot;],</span>
<a href="#l69.128"></a><span id="l69.128" class="difflineplus">+        [&quot;blueberrypancake&quot;],</span>
<a href="#l69.129"></a><span id="l69.129" class="difflineplus">+        [&quot;mangojuice&quot;],</span>
<a href="#l69.130"></a><span id="l69.130" class="difflineplus">+        [&quot;raspberryberet&quot;],</span>
<a href="#l69.131"></a><span id="l69.131" class="difflineplus">+        [&quot;pineapplesoup&quot;],</span>
<a href="#l69.132"></a><span id="l69.132" class="difflineplus">+        [&quot;limejelly&quot;],</span>
<a href="#l69.133"></a><span id="l69.133" class="difflineplus">+        [&quot;lemonsorbet&quot;],</span>
<a href="#l69.134"></a><span id="l69.134" class="difflineplus">+      ],</span>
<a href="#l69.135"></a><span id="l69.135">       results: [</span>
<a href="#l69.136"></a><span id="l69.136">         &quot;JOIN applecustard,pearpie,strawberryfield,blueberrypancake&quot;,</span>
<a href="#l69.137"></a><span id="l69.137">         &quot;JOIN mangojuice,raspberryberet,pineapplesoup,limejelly&quot;,</span>
<a href="#l69.138"></a><span id="l69.138">         &quot;JOIN lemonsorbet&quot;,</span>
<a href="#l69.139"></a><span id="l69.139">       ],</span>
<a href="#l69.140"></a><span id="l69.140">     },</span>
<a href="#l69.141"></a><span id="l69.141">     {</span>
<a href="#l69.142"></a><span id="l69.142" class="difflineminus">-      data: [[&quot;applecustard&quot;], [&quot;pearpie&quot;], [&quot;strawberryfield&quot;, &quot;password1&quot;],</span>
<a href="#l69.143"></a><span id="l69.143" class="difflineminus">-        [&quot;blueberrypancake&quot;], [&quot;mangojuice&quot;], [&quot;raspberryberet&quot;],</span>
<a href="#l69.144"></a><span id="l69.144" class="difflineminus">-        [&quot;pineapplesoup&quot;], [&quot;limejelly&quot;, &quot;password2&quot;], [&quot;lemonsorbet&quot;]],</span>
<a href="#l69.145"></a><span id="l69.145" class="difflineplus">+      data: [</span>
<a href="#l69.146"></a><span id="l69.146" class="difflineplus">+        [&quot;applecustard&quot;],</span>
<a href="#l69.147"></a><span id="l69.147" class="difflineplus">+        [&quot;pearpie&quot;],</span>
<a href="#l69.148"></a><span id="l69.148" class="difflineplus">+        [&quot;strawberryfield&quot;, &quot;password1&quot;],</span>
<a href="#l69.149"></a><span id="l69.149" class="difflineplus">+        [&quot;blueberrypancake&quot;],</span>
<a href="#l69.150"></a><span id="l69.150" class="difflineplus">+        [&quot;mangojuice&quot;],</span>
<a href="#l69.151"></a><span id="l69.151" class="difflineplus">+        [&quot;raspberryberet&quot;],</span>
<a href="#l69.152"></a><span id="l69.152" class="difflineplus">+        [&quot;pineapplesoup&quot;],</span>
<a href="#l69.153"></a><span id="l69.153" class="difflineplus">+        [&quot;limejelly&quot;, &quot;password2&quot;],</span>
<a href="#l69.154"></a><span id="l69.154" class="difflineplus">+        [&quot;lemonsorbet&quot;],</span>
<a href="#l69.155"></a><span id="l69.155" class="difflineplus">+      ],</span>
<a href="#l69.156"></a><span id="l69.156">       results: [</span>
<a href="#l69.157"></a><span id="l69.157">         &quot;JOIN strawberryfield,applecustard,pearpie password1&quot;,</span>
<a href="#l69.158"></a><span id="l69.158">         &quot;JOIN blueberrypancake,mangojuice,raspberryberet&quot;,</span>
<a href="#l69.159"></a><span id="l69.159">         &quot;JOIN limejelly,pineapplesoup,lemonsorbet password2&quot;,</span>
<a href="#l69.160"></a><span id="l69.160">       ],</span>
<a href="#l69.161"></a><span id="l69.161">     },</span>
<a href="#l69.162"></a><span id="l69.162">   ];</span>
<a href="#l69.163"></a><span id="l69.163"> </span>
<a href="#l69.164"></a><span id="l69.164">   account._lastCommandSendTime = 0;</span>
<a href="#l69.165"></a><span id="l69.165">   for (let test of tests) {</span>
<a href="#l69.166"></a><span id="l69.166">     let timeout;</span>
<a href="#l69.167"></a><span id="l69.167">     // Destructure test to local variables so each function</span>
<a href="#l69.168"></a><span id="l69.168">     // generated here gets the correct value in its scope.</span>
<a href="#l69.169"></a><span id="l69.169" class="difflineminus">-    let {data, results} = test;</span>
<a href="#l69.170"></a><span id="l69.170" class="difflineplus">+    let { data, results } = test;</span>
<a href="#l69.171"></a><span id="l69.171">     for (let r of results) {</span>
<a href="#l69.172"></a><span id="l69.172">       let result = r;</span>
<a href="#l69.173"></a><span id="l69.173">       account.callbacks.push((aCommand, aParams) =&gt; {</span>
<a href="#l69.174"></a><span id="l69.174">         let msg = account.buildMessage(aCommand, aParams);</span>
<a href="#l69.175"></a><span id="l69.175">         equal(msg, result, &quot;Test maximum message length constraint&quot;);</span>
<a href="#l69.176"></a><span id="l69.176">         // After all results are checked, run the next test.</span>
<a href="#l69.177"></a><span id="l69.177">         if (result == results[results.length - 1]) {</span>
<a href="#l69.178"></a><span id="l69.178">           irc.clearTimeout(timeout);</span>
<a href="#l69.179"></a><span id="l69.179" class="difflineat">@@ -155,13 +176,14 @@ function test_maxLength() {</span>
<a href="#l69.180"></a><span id="l69.180">     add_test(() =&gt; {</span>
<a href="#l69.181"></a><span id="l69.181">       // This timeout lets the test fail more quickly if</span>
<a href="#l69.182"></a><span id="l69.182">       // some of the callbacks we added don't get called.</span>
<a href="#l69.183"></a><span id="l69.183">       // Not strictly speaking necessary.</span>
<a href="#l69.184"></a><span id="l69.184">       timeout = irc.setTimeout(() =&gt; {</span>
<a href="#l69.185"></a><span id="l69.185">         ok(false, &quot;test_maxLength failed after timeout.&quot;);</span>
<a href="#l69.186"></a><span id="l69.186">         run_next_test();</span>
<a href="#l69.187"></a><span id="l69.187">       }, 2000);</span>
<a href="#l69.188"></a><span id="l69.188" class="difflineminus">-      for (let [channel, key] of data)</span>
<a href="#l69.189"></a><span id="l69.189" class="difflineplus">+      for (let [channel, key] of data) {</span>
<a href="#l69.190"></a><span id="l69.190">         account.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l69.191"></a><span id="l69.191" class="difflineplus">+      }</span>
<a href="#l69.192"></a><span id="l69.192">     });</span>
<a href="#l69.193"></a><span id="l69.193">   }</span>
<a href="#l69.194"></a><span id="l69.194"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/chat/protocols/irc/test/test_setMode.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_setMode.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -1,17 +1,16 @@</span>
<a href="#l70.4"></a><span id="l70.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l70.5"></a><span id="l70.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l70.6"></a><span id="l70.6"> </span>
<a href="#l70.7"></a><span id="l70.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l70.8"></a><span id="l70.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l70.9"></a><span id="l70.9"> var irc = {};</span>
<a href="#l70.10"></a><span id="l70.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l70.11"></a><span id="l70.11"> Services.conversations.initConversations();</span>
<a href="#l70.12"></a><span id="l70.12"> </span>
<a href="#l70.13"></a><span id="l70.13" class="difflineminus">-</span>
<a href="#l70.14"></a><span id="l70.14"> function FakeAccount() {</span>
<a href="#l70.15"></a><span id="l70.15">   this.normalizeNick = irc.ircAccount.prototype.normalizeNick.bind(this);</span>
<a href="#l70.16"></a><span id="l70.16"> }</span>
<a href="#l70.17"></a><span id="l70.17"> FakeAccount.prototype = {</span>
<a href="#l70.18"></a><span id="l70.18">   __proto__: irc.ircAccount.prototype,</span>
<a href="#l70.19"></a><span id="l70.19">   setWhois: (n, f) =&gt; true,</span>
<a href="#l70.20"></a><span id="l70.20">   ERROR: do_throw,</span>
<a href="#l70.21"></a><span id="l70.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/chat/protocols/irc/test/test_splitLongMessages.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_splitLongMessages.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -1,37 +1,40 @@</span>
<a href="#l71.4"></a><span id="l71.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l71.5"></a><span id="l71.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l71.6"></a><span id="l71.6"> </span>
<a href="#l71.7"></a><span id="l71.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l71.8"></a><span id="l71.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l71.9"></a><span id="l71.9"> var irc = {};</span>
<a href="#l71.10"></a><span id="l71.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l71.11"></a><span id="l71.11"> </span>
<a href="#l71.12"></a><span id="l71.12"> var messages = {</span>
<a href="#l71.13"></a><span id="l71.13">   // Exactly 51 characters.</span>
<a href="#l71.14"></a><span id="l71.14">   &quot;This is a test.&quot;: [&quot;This is a test.&quot;],</span>
<a href="#l71.15"></a><span id="l71.15">   // Too long.</span>
<a href="#l71.16"></a><span id="l71.16" class="difflineminus">-  &quot;This is a message that is too long.&quot;:</span>
<a href="#l71.17"></a><span id="l71.17" class="difflineminus">-    [&quot;This is a&quot;, &quot;message that is&quot;, &quot;too long.&quot;],</span>
<a href="#l71.18"></a><span id="l71.18" class="difflineplus">+  &quot;This is a message that is too long.&quot;: [</span>
<a href="#l71.19"></a><span id="l71.19" class="difflineplus">+    &quot;This is a&quot;,</span>
<a href="#l71.20"></a><span id="l71.20" class="difflineplus">+    &quot;message that is&quot;,</span>
<a href="#l71.21"></a><span id="l71.21" class="difflineplus">+    &quot;too long.&quot;,</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineplus">+  ],</span>
<a href="#l71.23"></a><span id="l71.23">   // Too short.</span>
<a href="#l71.24"></a><span id="l71.24">   &quot;Short msg.&quot;: [&quot;Short msg.&quot;],</span>
<a href="#l71.25"></a><span id="l71.25">   &quot;Thismessagecan'tbecut.&quot;: [&quot;Thismessagecan'&quot;, &quot;tbecut.&quot;],</span>
<a href="#l71.26"></a><span id="l71.26"> };</span>
<a href="#l71.27"></a><span id="l71.27"> </span>
<a href="#l71.28"></a><span id="l71.28"> irc.GenericIRCConversation.name = &quot;target&quot;;</span>
<a href="#l71.29"></a><span id="l71.29"> irc.GenericIRCConversation._account = {</span>
<a href="#l71.30"></a><span id="l71.30">   __proto__: irc.ircAccount.prototype,</span>
<a href="#l71.31"></a><span id="l71.31">   _nickname: &quot;sender&quot;,</span>
<a href="#l71.32"></a><span id="l71.32">   prefix: &quot;!user@host&quot;,</span>
<a href="#l71.33"></a><span id="l71.33">   maxMessageLength: 51, // For convenience.</span>
<a href="#l71.34"></a><span id="l71.34"> };</span>
<a href="#l71.35"></a><span id="l71.35"> </span>
<a href="#l71.36"></a><span id="l71.36"> function run_test() {</span>
<a href="#l71.37"></a><span id="l71.37">   for (let message in messages) {</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineminus">-    let msg = {message};</span>
<a href="#l71.39"></a><span id="l71.39" class="difflineplus">+    let msg = { message };</span>
<a href="#l71.40"></a><span id="l71.40">     let generatedMsgs = irc.GenericIRCConversation.prepareForSending(msg, {});</span>
<a href="#l71.41"></a><span id="l71.41"> </span>
<a href="#l71.42"></a><span id="l71.42">     // The expected messages as defined above.</span>
<a href="#l71.43"></a><span id="l71.43">     let expectedMsgs = messages[message];</span>
<a href="#l71.44"></a><span id="l71.44">     // Ensure the arrays are equal.</span>
<a href="#l71.45"></a><span id="l71.45">     deepEqual(generatedMsgs, expectedMsgs);</span>
<a href="#l71.46"></a><span id="l71.46">   }</span>
<a href="#l71.47"></a><span id="l71.47"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -1,41 +1,44 @@</span>
<a href="#l72.4"></a><span id="l72.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l72.5"></a><span id="l72.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l72.6"></a><span id="l72.6"> </span>
<a href="#l72.7"></a><span id="l72.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l72.8"></a><span id="l72.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l72.9"></a><span id="l72.9"> var irc = {};</span>
<a href="#l72.10"></a><span id="l72.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12"> var fakeProto = {</span>
<a href="#l72.13"></a><span id="l72.13">   id: &quot;fake-proto&quot;,</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineminus">-  options: {alternateNicks: &quot;&quot;},</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineminus">-  _getOptionDefault(aOption) { return this.options[aOption]; },</span>
<a href="#l72.16"></a><span id="l72.16" class="difflineplus">+  options: { alternateNicks: &quot;&quot; },</span>
<a href="#l72.17"></a><span id="l72.17" class="difflineplus">+  _getOptionDefault(aOption) {</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineplus">+    return this.options[aOption];</span>
<a href="#l72.19"></a><span id="l72.19" class="difflineplus">+  },</span>
<a href="#l72.20"></a><span id="l72.20"> };</span>
<a href="#l72.21"></a><span id="l72.21"> </span>
<a href="#l72.22"></a><span id="l72.22"> function test_tryNewNick() {</span>
<a href="#l72.23"></a><span id="l72.23">   const testData = {</span>
<a href="#l72.24"></a><span id="l72.24" class="difflineminus">-    &quot;clokep&quot;: &quot;clokep1&quot;,</span>
<a href="#l72.25"></a><span id="l72.25" class="difflineminus">-    &quot;clokep1&quot;: &quot;clokep2&quot;,</span>
<a href="#l72.26"></a><span id="l72.26" class="difflineminus">-    &quot;clokep10&quot;: &quot;clokep11&quot;,</span>
<a href="#l72.27"></a><span id="l72.27" class="difflineminus">-    &quot;clokep0&quot;: &quot;clokep1&quot;,</span>
<a href="#l72.28"></a><span id="l72.28" class="difflineminus">-    &quot;clokep01&quot;: &quot;clokep02&quot;,</span>
<a href="#l72.29"></a><span id="l72.29" class="difflineminus">-    &quot;clokep09&quot;: &quot;clokep10&quot;,</span>
<a href="#l72.30"></a><span id="l72.30" class="difflineplus">+    clokep: &quot;clokep1&quot;,</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineplus">+    clokep1: &quot;clokep2&quot;,</span>
<a href="#l72.32"></a><span id="l72.32" class="difflineplus">+    clokep10: &quot;clokep11&quot;,</span>
<a href="#l72.33"></a><span id="l72.33" class="difflineplus">+    clokep0: &quot;clokep1&quot;,</span>
<a href="#l72.34"></a><span id="l72.34" class="difflineplus">+    clokep01: &quot;clokep02&quot;,</span>
<a href="#l72.35"></a><span id="l72.35" class="difflineplus">+    clokep09: &quot;clokep10&quot;,</span>
<a href="#l72.36"></a><span id="l72.36"> </span>
<a href="#l72.37"></a><span id="l72.37">     // Now put a number in the &quot;first part&quot;.</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineminus">-    &quot;clo1kep&quot;: &quot;clo1kep1&quot;,</span>
<a href="#l72.39"></a><span id="l72.39" class="difflineminus">-    &quot;clo1kep1&quot;: &quot;clo1kep2&quot;,</span>
<a href="#l72.40"></a><span id="l72.40" class="difflineminus">-    &quot;clo1kep10&quot;: &quot;clo1kep11&quot;,</span>
<a href="#l72.41"></a><span id="l72.41" class="difflineminus">-    &quot;clo1kep0&quot;: &quot;clo1kep1&quot;,</span>
<a href="#l72.42"></a><span id="l72.42" class="difflineminus">-    &quot;clo1kep01&quot;: &quot;clo1kep02&quot;,</span>
<a href="#l72.43"></a><span id="l72.43" class="difflineminus">-    &quot;clo1kep09&quot;: &quot;clo1kep10&quot;,</span>
<a href="#l72.44"></a><span id="l72.44" class="difflineplus">+    clo1kep: &quot;clo1kep1&quot;,</span>
<a href="#l72.45"></a><span id="l72.45" class="difflineplus">+    clo1kep1: &quot;clo1kep2&quot;,</span>
<a href="#l72.46"></a><span id="l72.46" class="difflineplus">+    clo1kep10: &quot;clo1kep11&quot;,</span>
<a href="#l72.47"></a><span id="l72.47" class="difflineplus">+    clo1kep0: &quot;clo1kep1&quot;,</span>
<a href="#l72.48"></a><span id="l72.48" class="difflineplus">+    clo1kep01: &quot;clo1kep02&quot;,</span>
<a href="#l72.49"></a><span id="l72.49" class="difflineplus">+    clo1kep09: &quot;clo1kep10&quot;,</span>
<a href="#l72.50"></a><span id="l72.50">   };</span>
<a href="#l72.51"></a><span id="l72.51"> </span>
<a href="#l72.52"></a><span id="l72.52" class="difflineminus">-  let account = new irc.ircAccount(fakeProto,</span>
<a href="#l72.53"></a><span id="l72.53" class="difflineminus">-                                   {name: &quot;clokep@instantbird.org&quot;});</span>
<a href="#l72.54"></a><span id="l72.54" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l72.55"></a><span id="l72.55" class="difflineplus">+    name: &quot;clokep@instantbird.org&quot;,</span>
<a href="#l72.56"></a><span id="l72.56" class="difflineplus">+  });</span>
<a href="#l72.57"></a><span id="l72.57">   account.LOG = function(aStr) {};</span>
<a href="#l72.58"></a><span id="l72.58">   account.normalize = aStr =&gt; aStr;</span>
<a href="#l72.59"></a><span id="l72.59"> </span>
<a href="#l72.60"></a><span id="l72.60">   for (let currentNick in testData) {</span>
<a href="#l72.61"></a><span id="l72.61">     account._sentNickname = currentNick;</span>
<a href="#l72.62"></a><span id="l72.62">     account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l72.63"></a><span id="l72.63">       equal(aNewNick, testData[currentNick]);</span>
<a href="#l72.64"></a><span id="l72.64"> </span>
<a href="#l72.65"></a><span id="l72.65" class="difflineat">@@ -66,18 +69,19 @@ function test_maxLength() {</span>
<a href="#l72.66"></a><span id="l72.66">     [&quot;abcdefgh1&quot;, &quot;abcdefg10&quot;],</span>
<a href="#l72.67"></a><span id="l72.67">     [&quot;abcdefg10&quot;, &quot;abcdefg11&quot;],</span>
<a href="#l72.68"></a><span id="l72.68">     [&quot;abcdefg99&quot;, &quot;abcdefg100&quot;],</span>
<a href="#l72.69"></a><span id="l72.69">     [&quot;abcdefg10&quot;, &quot;abcdef100&quot;],</span>
<a href="#l72.70"></a><span id="l72.70">     [&quot;a99999999&quot;, &quot;a100000000&quot;],</span>
<a href="#l72.71"></a><span id="l72.71">     [&quot;a10000000&quot;, &quot;a00000000&quot;],</span>
<a href="#l72.72"></a><span id="l72.72">   ];</span>
<a href="#l72.73"></a><span id="l72.73"> </span>
<a href="#l72.74"></a><span id="l72.74" class="difflineminus">-  let account = new irc.ircAccount(fakeProto,</span>
<a href="#l72.75"></a><span id="l72.75" class="difflineminus">-                                   {name: &quot;clokep@instantbird.org&quot;});</span>
<a href="#l72.76"></a><span id="l72.76" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l72.77"></a><span id="l72.77" class="difflineplus">+    name: &quot;clokep@instantbird.org&quot;,</span>
<a href="#l72.78"></a><span id="l72.78" class="difflineplus">+  });</span>
<a href="#l72.79"></a><span id="l72.79">   account.LOG = function(aStr) {};</span>
<a href="#l72.80"></a><span id="l72.80">   account._sentNickname = &quot;abcdefghi&quot;;</span>
<a href="#l72.81"></a><span id="l72.81">   account.normalize = aStr =&gt; aStr;</span>
<a href="#l72.82"></a><span id="l72.82"> </span>
<a href="#l72.83"></a><span id="l72.83">   for (let currentNick of testData) {</span>
<a href="#l72.84"></a><span id="l72.84">     account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l72.85"></a><span id="l72.85">       equal(aNewNick, currentNick[1]);</span>
<a href="#l72.86"></a><span id="l72.86"> </span>
<a href="#l72.87"></a><span id="l72.87" class="difflineat">@@ -86,40 +90,42 @@ function test_maxLength() {</span>
<a href="#l72.88"></a><span id="l72.88"> </span>
<a href="#l72.89"></a><span id="l72.89">   run_next_test();</span>
<a href="#l72.90"></a><span id="l72.90"> }</span>
<a href="#l72.91"></a><span id="l72.91"> </span>
<a href="#l72.92"></a><span id="l72.92"> function test_altNicks() {</span>
<a href="#l72.93"></a><span id="l72.93">   const altNicks = [&quot;clokep_&quot;, &quot;clokep|&quot;];</span>
<a href="#l72.94"></a><span id="l72.94">   const testData = {</span>
<a href="#l72.95"></a><span id="l72.95">     // Test account nick.</span>
<a href="#l72.96"></a><span id="l72.96" class="difflineminus">-    &quot;clokep&quot;: [altNicks, &quot;clokep_&quot;],</span>
<a href="#l72.97"></a><span id="l72.97" class="difflineplus">+    clokep: [altNicks, &quot;clokep_&quot;],</span>
<a href="#l72.98"></a><span id="l72.98">     // Test first element in list.</span>
<a href="#l72.99"></a><span id="l72.99" class="difflineminus">-    &quot;clokep_&quot;: [altNicks, &quot;clokep|&quot;],</span>
<a href="#l72.100"></a><span id="l72.100" class="difflineplus">+    clokep_: [altNicks, &quot;clokep|&quot;],</span>
<a href="#l72.101"></a><span id="l72.101">     // Test last element in list.</span>
<a href="#l72.102"></a><span id="l72.102">     &quot;clokep|&quot;: [altNicks, &quot;clokep|1&quot;],</span>
<a href="#l72.103"></a><span id="l72.103">     // Test element not in list with number at end.</span>
<a href="#l72.104"></a><span id="l72.104" class="difflineminus">-    &quot;clokep1&quot;: [altNicks, &quot;clokep2&quot;],</span>
<a href="#l72.105"></a><span id="l72.105" class="difflineplus">+    clokep1: [altNicks, &quot;clokep2&quot;],</span>
<a href="#l72.106"></a><span id="l72.106"> </span>
<a href="#l72.107"></a><span id="l72.107">     // Test messy alternatives.</span>
<a href="#l72.108"></a><span id="l72.108">     &quot;clokep[&quot;: [&quot; clokep ,\n clokep111,,,\tclokep[, clokep_&quot;, &quot;clokep_&quot;],</span>
<a href="#l72.109"></a><span id="l72.109">   };</span>
<a href="#l72.110"></a><span id="l72.110"> </span>
<a href="#l72.111"></a><span id="l72.111" class="difflineminus">-  let account = new irc.ircAccount(fakeProto,</span>
<a href="#l72.112"></a><span id="l72.112" class="difflineminus">-                                   {name: &quot;clokep@instantbird.org&quot;});</span>
<a href="#l72.113"></a><span id="l72.113" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l72.114"></a><span id="l72.114" class="difflineplus">+    name: &quot;clokep@instantbird.org&quot;,</span>
<a href="#l72.115"></a><span id="l72.115" class="difflineplus">+  });</span>
<a href="#l72.116"></a><span id="l72.116">   account.LOG = function(aStr) {};</span>
<a href="#l72.117"></a><span id="l72.117">   account.normalize = aStr =&gt; aStr;</span>
<a href="#l72.118"></a><span id="l72.118"> </span>
<a href="#l72.119"></a><span id="l72.119">   for (let currentNick in testData) {</span>
<a href="#l72.120"></a><span id="l72.120">     // Only one pref is touched in here, override the default to return</span>
<a href="#l72.121"></a><span id="l72.121">     // what this test needs.</span>
<a href="#l72.122"></a><span id="l72.122">     account.getString = function(aStr) {</span>
<a href="#l72.123"></a><span id="l72.123">       let data = testData[currentNick][0];</span>
<a href="#l72.124"></a><span id="l72.124" class="difflineminus">-      if (Array.isArray(data))</span>
<a href="#l72.125"></a><span id="l72.125" class="difflineplus">+      if (Array.isArray(data)) {</span>
<a href="#l72.126"></a><span id="l72.126">         return data.join(&quot;,&quot;);</span>
<a href="#l72.127"></a><span id="l72.127" class="difflineplus">+      }</span>
<a href="#l72.128"></a><span id="l72.128">       return data;</span>
<a href="#l72.129"></a><span id="l72.129">     };</span>
<a href="#l72.130"></a><span id="l72.130">     account._sentNickname = currentNick;</span>
<a href="#l72.131"></a><span id="l72.131"> </span>
<a href="#l72.132"></a><span id="l72.132">     account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l72.133"></a><span id="l72.133">       equal(aNewNick, testData[currentNick][1]);</span>
<a href="#l72.134"></a><span id="l72.134"> </span>
<a href="#l72.135"></a><span id="l72.135">     account.tryNewNick(currentNick);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -21,96 +21,136 @@ var {</span>
<a href="#l73.4"></a><span id="l73.4">   GenericConvChatBuddyPrototype,</span>
<a href="#l73.5"></a><span id="l73.5">   GenericConversationPrototype,</span>
<a href="#l73.6"></a><span id="l73.6">   GenericMessagePrototype,</span>
<a href="#l73.7"></a><span id="l73.7">   GenericProtocolPrototype,</span>
<a href="#l73.8"></a><span id="l73.8">   Message,</span>
<a href="#l73.9"></a><span id="l73.9">   TooltipInfo,</span>
<a href="#l73.10"></a><span id="l73.10"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l73.11"></a><span id="l73.11"> </span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-function Conversation(aAccount)</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineminus">-{</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+function Conversation(aAccount) {</span>
<a href="#l73.15"></a><span id="l73.15">   this._init(aAccount);</span>
<a href="#l73.16"></a><span id="l73.16"> }</span>
<a href="#l73.17"></a><span id="l73.17"> Conversation.prototype = {</span>
<a href="#l73.18"></a><span id="l73.18">   __proto__: GenericConvIMPrototype,</span>
<a href="#l73.19"></a><span id="l73.19">   _disconnected: false,</span>
<a href="#l73.20"></a><span id="l73.20">   _setDisconnected() {</span>
<a href="#l73.21"></a><span id="l73.21">     this._disconnected = true;</span>
<a href="#l73.22"></a><span id="l73.22">   },</span>
<a href="#l73.23"></a><span id="l73.23">   close() {</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineminus">-    if (!this._disconnected)</span>
<a href="#l73.25"></a><span id="l73.25" class="difflineplus">+    if (!this._disconnected) {</span>
<a href="#l73.26"></a><span id="l73.26">       this.account.disconnect(true);</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineplus">+    }</span>
<a href="#l73.28"></a><span id="l73.28">   },</span>
<a href="#l73.29"></a><span id="l73.29">   sendMsg(aMsg) {</span>
<a href="#l73.30"></a><span id="l73.30">     if (this._disconnected) {</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineminus">-      this.writeMessage(&quot;jstest&quot;, &quot;This message could not be sent because the conversation is no longer active: &quot; + aMsg, {system: true, error: true});</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+      this.writeMessage(</span>
<a href="#l73.33"></a><span id="l73.33" class="difflineplus">+        &quot;jstest&quot;,</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineplus">+        &quot;This message could not be sent because the conversation is no longer active: &quot; +</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+          aMsg,</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+        { system: true, error: true }</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+      );</span>
<a href="#l73.38"></a><span id="l73.38">       return;</span>
<a href="#l73.39"></a><span id="l73.39">     }</span>
<a href="#l73.40"></a><span id="l73.40"> </span>
<a href="#l73.41"></a><span id="l73.41" class="difflineminus">-    this.writeMessage(&quot;You&quot;, aMsg, {outgoing: true});</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineminus">-    this.writeMessage(&quot;/dev/null&quot;, &quot;Thanks! I appreciate your attention.&quot;,</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineminus">-                      {incoming: true, autoResponse: true});</span>
<a href="#l73.44"></a><span id="l73.44" class="difflineplus">+    this.writeMessage(&quot;You&quot;, aMsg, { outgoing: true });</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineplus">+    this.writeMessage(&quot;/dev/null&quot;, &quot;Thanks! I appreciate your attention.&quot;, {</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineplus">+      incoming: true,</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineplus">+      autoResponse: true,</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineplus">+    });</span>
<a href="#l73.49"></a><span id="l73.49">   },</span>
<a href="#l73.50"></a><span id="l73.50"> </span>
<a href="#l73.51"></a><span id="l73.51" class="difflineminus">-  get name() { return &quot;/dev/null&quot;; },</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+  get name() {</span>
<a href="#l73.53"></a><span id="l73.53" class="difflineplus">+    return &quot;/dev/null&quot;;</span>
<a href="#l73.54"></a><span id="l73.54" class="difflineplus">+  },</span>
<a href="#l73.55"></a><span id="l73.55"> };</span>
<a href="#l73.56"></a><span id="l73.56"> </span>
<a href="#l73.57"></a><span id="l73.57" class="difflineminus">-function Account(aProtoInstance, aImAccount)</span>
<a href="#l73.58"></a><span id="l73.58" class="difflineminus">-{</span>
<a href="#l73.59"></a><span id="l73.59" class="difflineplus">+function Account(aProtoInstance, aImAccount) {</span>
<a href="#l73.60"></a><span id="l73.60">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l73.61"></a><span id="l73.61"> }</span>
<a href="#l73.62"></a><span id="l73.62"> Account.prototype = {</span>
<a href="#l73.63"></a><span id="l73.63">   __proto__: GenericAccountPrototype,</span>
<a href="#l73.64"></a><span id="l73.64">   connect() {</span>
<a href="#l73.65"></a><span id="l73.65">     this.reportConnecting();</span>
<a href="#l73.66"></a><span id="l73.66">     // do something here</span>
<a href="#l73.67"></a><span id="l73.67">     this.reportConnected();</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineminus">-    setTimeout((function() {</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineminus">-      this._conv = new Conversation(this);</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineminus">-      this._conv.writeMessage(&quot;jstest&quot;, &quot;You are now talking to /dev/null&quot;, {system: true});</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineminus">-    }).bind(this), 0);</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineplus">+    setTimeout(</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineplus">+      function() {</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+        this._conv = new Conversation(this);</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+        this._conv.writeMessage(&quot;jstest&quot;, &quot;You are now talking to /dev/null&quot;, {</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineplus">+          system: true,</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+        });</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineplus">+      }.bind(this),</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineplus">+      0</span>
<a href="#l73.80"></a><span id="l73.80" class="difflineplus">+    );</span>
<a href="#l73.81"></a><span id="l73.81">   },</span>
<a href="#l73.82"></a><span id="l73.82">   _conv: null,</span>
<a href="#l73.83"></a><span id="l73.83">   disconnect(aSilent) {</span>
<a href="#l73.84"></a><span id="l73.84">     this.reportDisconnecting(Ci.prplIAccount.NO_ERROR, &quot;&quot;);</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineminus">-    if (!aSilent)</span>
<a href="#l73.86"></a><span id="l73.86" class="difflineminus">-      this._conv.writeMessage(&quot;jstest&quot;, &quot;You have disconnected.&quot;, {system: true});</span>
<a href="#l73.87"></a><span id="l73.87" class="difflineplus">+    if (!aSilent) {</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineplus">+      this._conv.writeMessage(&quot;jstest&quot;, &quot;You have disconnected.&quot;, {</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+        system: true,</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineplus">+      });</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+    }</span>
<a href="#l73.92"></a><span id="l73.92">     if (this._conv) {</span>
<a href="#l73.93"></a><span id="l73.93">       this._conv._setDisconnected();</span>
<a href="#l73.94"></a><span id="l73.94">       delete this._conv;</span>
<a href="#l73.95"></a><span id="l73.95">     }</span>
<a href="#l73.96"></a><span id="l73.96">     this.reportDisconnected();</span>
<a href="#l73.97"></a><span id="l73.97">   },</span>
<a href="#l73.98"></a><span id="l73.98"> </span>
<a href="#l73.99"></a><span id="l73.99" class="difflineminus">-  get canJoinChat() { return true; },</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l73.101"></a><span id="l73.101" class="difflineplus">+    return true;</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineplus">+  },</span>
<a href="#l73.103"></a><span id="l73.103">   chatRoomFields: {</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineminus">-    channel: {label: &quot;_Channel Field&quot;, required: true},</span>
<a href="#l73.105"></a><span id="l73.105" class="difflineminus">-    channelDefault: {label: &quot;_Field with default&quot;, default: &quot;Default Value&quot;},</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineminus">-    password: {label: &quot;_Password Field&quot;, default: &quot;&quot;, isPassword: true,</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineminus">-               required: false},</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineminus">-    sampleIntField: {label: &quot;_Int Field&quot;, default: 4, min: 0, max: 10,</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineminus">-                     required: true},</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineplus">+    channel: { label: &quot;_Channel Field&quot;, required: true },</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineplus">+    channelDefault: { label: &quot;_Field with default&quot;, default: &quot;Default Value&quot; },</span>
<a href="#l73.112"></a><span id="l73.112" class="difflineplus">+    password: {</span>
<a href="#l73.113"></a><span id="l73.113" class="difflineplus">+      label: &quot;_Password Field&quot;,</span>
<a href="#l73.114"></a><span id="l73.114" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineplus">+      isPassword: true,</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineplus">+      required: false,</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+    },</span>
<a href="#l73.118"></a><span id="l73.118" class="difflineplus">+    sampleIntField: {</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineplus">+      label: &quot;_Int Field&quot;,</span>
<a href="#l73.120"></a><span id="l73.120" class="difflineplus">+      default: 4,</span>
<a href="#l73.121"></a><span id="l73.121" class="difflineplus">+      min: 0,</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineplus">+      max: 10,</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineplus">+      required: true,</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineplus">+    },</span>
<a href="#l73.125"></a><span id="l73.125">   },</span>
<a href="#l73.126"></a><span id="l73.126"> };</span>
<a href="#l73.127"></a><span id="l73.127"> </span>
<a href="#l73.128"></a><span id="l73.128" class="difflineminus">-function jsTestProtocol() { }</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+function jsTestProtocol() {}</span>
<a href="#l73.130"></a><span id="l73.130"> jsTestProtocol.prototype = {</span>
<a href="#l73.131"></a><span id="l73.131">   __proto__: GenericProtocolPrototype,</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineminus">-  get name() { return &quot;JS Test&quot;; },</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineplus">+  get name() {</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineplus">+    return &quot;JS Test&quot;;</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineplus">+  },</span>
<a href="#l73.136"></a><span id="l73.136">   options: {</span>
<a href="#l73.137"></a><span id="l73.137" class="difflineminus">-    &quot;text&quot;: {label: &quot;Text option&quot;,    default: &quot;foo&quot;},</span>
<a href="#l73.138"></a><span id="l73.138" class="difflineminus">-    &quot;bool&quot;: {label: &quot;Boolean option&quot;, default: true},</span>
<a href="#l73.139"></a><span id="l73.139" class="difflineminus">-    &quot;int&quot;: {label: &quot;Integer option&quot;, default: 42},</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineminus">-    &quot;list&quot;: {label: &quot;Select option&quot;,  default: &quot;option2&quot;,</span>
<a href="#l73.141"></a><span id="l73.141" class="difflineminus">-             listValues: {&quot;option1&quot;: &quot;First option&quot;,</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineminus">-                          &quot;option2&quot;: &quot;Default option&quot;,</span>
<a href="#l73.143"></a><span id="l73.143" class="difflineminus">-                          &quot;option3&quot;: &quot;Other option&quot;}},</span>
<a href="#l73.144"></a><span id="l73.144" class="difflineplus">+    text: { label: &quot;Text option&quot;, default: &quot;foo&quot; },</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineplus">+    bool: { label: &quot;Boolean option&quot;, default: true },</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineplus">+    int: { label: &quot;Integer option&quot;, default: 42 },</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+    list: {</span>
<a href="#l73.148"></a><span id="l73.148" class="difflineplus">+      label: &quot;Select option&quot;,</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineplus">+      default: &quot;option2&quot;,</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+      listValues: {</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineplus">+        option1: &quot;First option&quot;,</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineplus">+        option2: &quot;Default option&quot;,</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineplus">+        option3: &quot;Other option&quot;,</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineplus">+      },</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineplus">+    },</span>
<a href="#l73.156"></a><span id="l73.156">   },</span>
<a href="#l73.157"></a><span id="l73.157">   usernameSplits: [</span>
<a href="#l73.158"></a><span id="l73.158" class="difflineminus">-    {label: &quot;Server&quot;, separator: &quot;@&quot;, defaultValue: &quot;default.server&quot;,</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineminus">-     reverse: true},</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineplus">+    {</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineplus">+      label: &quot;Server&quot;,</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineplus">+      separator: &quot;@&quot;,</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineplus">+      defaultValue: &quot;default.server&quot;,</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+      reverse: true,</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineplus">+    },</span>
<a href="#l73.166"></a><span id="l73.166">   ],</span>
<a href="#l73.167"></a><span id="l73.167" class="difflineminus">-  getAccount(aImAccount) { return new Account(this, aImAccount); },</span>
<a href="#l73.168"></a><span id="l73.168" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineplus">+    return new Account(this, aImAccount);</span>
<a href="#l73.170"></a><span id="l73.170" class="difflineplus">+  },</span>
<a href="#l73.171"></a><span id="l73.171">   classID: Components.ID(&quot;{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}&quot;),</span>
<a href="#l73.172"></a><span id="l73.172"> };</span>
<a href="#l73.173"></a><span id="l73.173"> </span>
<a href="#l73.174"></a><span id="l73.174"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([jsTestProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/chat/protocols/matrix/matrix-sdk.jsm</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk.jsm</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -1,94 +1,101 @@</span>
<a href="#l74.4"></a><span id="l74.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l74.5"></a><span id="l74.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l74.6"></a><span id="l74.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l74.7"></a><span id="l74.7"> </span>
<a href="#l74.8"></a><span id="l74.8" class="difflineminus">-const {console} = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l74.9"></a><span id="l74.9" class="difflineminus">-const {clearInterval, clearTimeout, setInterval, setTimeout} = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l74.10"></a><span id="l74.10" class="difflineplus">+const { console } = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l74.11"></a><span id="l74.11" class="difflineplus">+const {</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineplus">+  clearInterval,</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+  clearTimeout,</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+  setInterval,</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineplus">+  setTimeout,</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l74.17"></a><span id="l74.17"> </span>
<a href="#l74.18"></a><span id="l74.18" class="difflineminus">-const { Loader, Require, Module } = ChromeUtils.import(&quot;resource://devtools/shared/base-loader.js&quot;);</span>
<a href="#l74.19"></a><span id="l74.19" class="difflineplus">+const { Loader, Require, Module } = ChromeUtils.import(</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineplus">+  &quot;resource://devtools/shared/base-loader.js&quot;</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineplus">+);</span>
<a href="#l74.22"></a><span id="l74.22"> </span>
<a href="#l74.23"></a><span id="l74.23"> this.EXPORTED_SYMBOLS = [&quot;MatrixSDK&quot;];</span>
<a href="#l74.24"></a><span id="l74.24"> </span>
<a href="#l74.25"></a><span id="l74.25"> // Set-up loading so require works properly in CommonJS modules.</span>
<a href="#l74.26"></a><span id="l74.26"> let matrixPath = &quot;resource:///modules/matrix/&quot;;</span>
<a href="#l74.27"></a><span id="l74.27"> let loader = Loader({</span>
<a href="#l74.28"></a><span id="l74.28">   paths: {</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineminus">-      &quot;&quot;: matrixPath,</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineminus">-      &quot;../../utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineminus">-      &quot;../content-repo&quot;: matrixPath + &quot;content-repo.js&quot;,</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineminus">-      &quot;../deviceinfo&quot;: matrixPath + &quot;crypto/deviceinfo.js&quot;,</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineminus">-      &quot;../models/event&quot;: matrixPath + &quot;models/event.js&quot;,</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineminus">-      &quot;../models/room&quot;: matrixPath + &quot;models/room.js&quot;,</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineminus">-      &quot;../models/user&quot;: matrixPath + &quot;models/user.js&quot;,</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineminus">-      &quot;../olmlib&quot;: matrixPath + &quot;crypto/olmlib.js&quot;,</span>
<a href="#l74.37"></a><span id="l74.37" class="difflineminus">-      &quot;../utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.38"></a><span id="l74.38" class="difflineminus">-      &quot;./../../utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.39"></a><span id="l74.39" class="difflineminus">-      &quot;./OlmDevice&quot;: matrixPath + &quot;crypto/OlmDevice.js&quot;,</span>
<a href="#l74.40"></a><span id="l74.40" class="difflineminus">-      &quot;./algorithms&quot;: matrixPath + &quot;crypto/algorithms/index.js&quot;,</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineminus">-      &quot;./base&quot;: matrixPath + &quot;crypto/algorithms/base.js&quot;,</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineminus">-      &quot;./base-apis&quot;: matrixPath + &quot;base-apis.js&quot;,</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineminus">-      &quot;./client&quot;: matrixPath + &quot;client.js&quot;,</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineminus">-      &quot;./content-repo&quot;: matrixPath + &quot;content-repo.js&quot;,</span>
<a href="#l74.45"></a><span id="l74.45" class="difflineminus">-      &quot;./crypto&quot;: matrixPath + &quot;crypto/index.js&quot;,</span>
<a href="#l74.46"></a><span id="l74.46" class="difflineminus">-      &quot;./decode&quot;: matrixPath + &quot;browserify/querystring/decode.js&quot;,</span>
<a href="#l74.47"></a><span id="l74.47" class="difflineminus">-      &quot;./deviceinfo&quot;: matrixPath + &quot;crypto/deviceinfo.js&quot;,</span>
<a href="#l74.48"></a><span id="l74.48" class="difflineminus">-      &quot;./encode&quot;: matrixPath + &quot;browserify/querystring/encode.js&quot;,</span>
<a href="#l74.49"></a><span id="l74.49" class="difflineminus">-      &quot;./event&quot;: matrixPath + &quot;models/event.js&quot;,</span>
<a href="#l74.50"></a><span id="l74.50" class="difflineminus">-      &quot;./event-context&quot;: matrixPath + &quot;models/event-content.js&quot;,</span>
<a href="#l74.51"></a><span id="l74.51" class="difflineminus">-      &quot;./event-timeline&quot;: matrixPath + &quot;models/event-timeline.js&quot;,</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineminus">-      &quot;./event-timeline-set&quot;: matrixPath + &quot;models/event-timeline-set.js&quot;,</span>
<a href="#l74.53"></a><span id="l74.53" class="difflineminus">-      &quot;./filter&quot;: matrixPath + &quot;filter.js&quot;,</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineminus">-      &quot;./filter-component&quot;: matrixPath + &quot;filter-component.js&quot;,</span>
<a href="#l74.55"></a><span id="l74.55" class="difflineminus">-      &quot;./http-api&quot;: matrixPath + &quot;http-api.js&quot;,</span>
<a href="#l74.56"></a><span id="l74.56" class="difflineminus">-      &quot;./interactive-auth&quot;: matrixPath + &quot;interactive-auth.js&quot;,</span>
<a href="#l74.57"></a><span id="l74.57" class="difflineminus">-      &quot;./megolm&quot;: matrixPath + &quot;crypto/algorithms/megolm.js&quot;,</span>
<a href="#l74.58"></a><span id="l74.58" class="difflineminus">-      &quot;./models/event&quot;: matrixPath + &quot;models/event.js&quot;,</span>
<a href="#l74.59"></a><span id="l74.59" class="difflineminus">-      &quot;./models/event-timeline&quot;: matrixPath + &quot;models/event-timeline.js&quot;,</span>
<a href="#l74.60"></a><span id="l74.60" class="difflineminus">-      &quot;./models/event-timeline-set&quot;: matrixPath + &quot;models/event-timeline-set.js&quot;,</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineminus">-      &quot;./models/room&quot;: matrixPath + &quot;models/room.js&quot;,</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineminus">-      &quot;./models/room-member&quot;: matrixPath + &quot;models/room-member.js&quot;,</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineminus">-      &quot;./models/room-state&quot;: matrixPath + &quot;models/room-state.js&quot;,</span>
<a href="#l74.64"></a><span id="l74.64" class="difflineminus">-      &quot;./models/search-result&quot;: matrixPath + &quot;models/search-result.js&quot;,</span>
<a href="#l74.65"></a><span id="l74.65" class="difflineminus">-      &quot;./models/user&quot;: matrixPath + &quot;models/user.js&quot;,</span>
<a href="#l74.66"></a><span id="l74.66" class="difflineminus">-      &quot;./olm&quot;: matrixPath + &quot;crypto/algorithms/olm.js&quot;,</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineminus">-      &quot;./olmlib&quot;: matrixPath + &quot;crypto/olmlib.js&quot;,</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineminus">-      &quot;./pushprocessor&quot;: matrixPath + &quot;pushprocessor.js&quot;,</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineminus">-      &quot;./q&quot;: matrixPath + &quot;q/q.js&quot;,</span>
<a href="#l74.70"></a><span id="l74.70" class="difflineminus">-      &quot;./realtime-callbacks&quot;: matrixPath + &quot;realtime-callbacks.js&quot;,</span>
<a href="#l74.71"></a><span id="l74.71" class="difflineminus">-      &quot;./room-member&quot;: matrixPath + &quot;models/room-member.js&quot;,</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineminus">-      &quot;./room-state&quot;: matrixPath + &quot;models/room-state.js&quot;,</span>
<a href="#l74.73"></a><span id="l74.73" class="difflineminus">-      &quot;./room-summary&quot;: matrixPath + &quot;models/room-summary.js&quot;,</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineminus">-      &quot;./scheduler&quot;: matrixPath + &quot;scheduler.js&quot;,</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineminus">-      &quot;./store/memory&quot;: matrixPath + &quot;store/memory.js&quot;,</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineminus">-      &quot;./store/session/webstorage&quot;: matrixPath + &quot;store/session/webstorage.js&quot;,</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineminus">-      &quot;./store/stub&quot;: matrixPath + &quot;store/stub.js&quot;,</span>
<a href="#l74.78"></a><span id="l74.78" class="difflineminus">-      &quot;./store/webstorage&quot;: matrixPath + &quot;store/webstorage.js&quot;,</span>
<a href="#l74.79"></a><span id="l74.79" class="difflineminus">-      &quot;./sync&quot;: matrixPath + &quot;sync.js&quot;,</span>
<a href="#l74.80"></a><span id="l74.80" class="difflineminus">-      &quot;./timeline-window&quot;: matrixPath + &quot;timeline-window.js&quot;,</span>
<a href="#l74.81"></a><span id="l74.81" class="difflineminus">-      &quot;./utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.82"></a><span id="l74.82" class="difflineminus">-      &quot;./webrtc/call&quot;: matrixPath + &quot;webrtc/call.js&quot;,</span>
<a href="#l74.83"></a><span id="l74.83" class="difflineminus">-      &quot;OlmDevice&quot;: matrixPath + &quot;crypto/OlmDevice.js&quot;,</span>
<a href="#l74.84"></a><span id="l74.84" class="difflineminus">-      &quot;algorithms&quot;: matrixPath + &quot;crypto/algorithms/index.js&quot;,</span>
<a href="#l74.85"></a><span id="l74.85" class="difflineminus">-      &quot;another-json&quot;: matrixPath + &quot;another_json/another-json.js&quot;,</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineminus">-      &quot;base&quot;: matrixPath + &quot;crypto/algorithms/base.js&quot;,</span>
<a href="#l74.87"></a><span id="l74.87" class="difflineminus">-      &quot;browser-request&quot;: matrixPath + &quot;browser_request/index.js&quot;,</span>
<a href="#l74.88"></a><span id="l74.88" class="difflineminus">-      &quot;crypto&quot;: matrixPath + &quot;crypto/index.js&quot;,</span>
<a href="#l74.89"></a><span id="l74.89" class="difflineminus">-      &quot;decode&quot;: matrixPath + &quot;browserify/querystring/decode.js&quot;,</span>
<a href="#l74.90"></a><span id="l74.90" class="difflineminus">-      &quot;deviceinfo&quot;: matrixPath + &quot;crypto/deviceinfo.js&quot;,</span>
<a href="#l74.91"></a><span id="l74.91" class="difflineminus">-      &quot;encode&quot;: matrixPath + &quot;browserify/querystring/encode.js&quot;,</span>
<a href="#l74.92"></a><span id="l74.92" class="difflineminus">-      &quot;events&quot;: matrixPath + &quot;browserify/events.js&quot;,</span>
<a href="#l74.93"></a><span id="l74.93" class="difflineminus">-      &quot;megolm&quot;: matrixPath + &quot;crypto/algorithms/megolm.js&quot;,</span>
<a href="#l74.94"></a><span id="l74.94" class="difflineminus">-      &quot;olm&quot;: matrixPath + &quot;crypto/algorithms/olm.js&quot;,</span>
<a href="#l74.95"></a><span id="l74.95" class="difflineminus">-      &quot;olmlib&quot;: matrixPath + &quot;crypto/olmlib.js&quot;,</span>
<a href="#l74.96"></a><span id="l74.96" class="difflineminus">-      &quot;punycode&quot;: matrixPath + &quot;browserify/punycode.js&quot;,</span>
<a href="#l74.97"></a><span id="l74.97" class="difflineminus">-      &quot;q&quot;: matrixPath + &quot;q/q.js&quot;,</span>
<a href="#l74.98"></a><span id="l74.98" class="difflineminus">-      &quot;querystring&quot;: matrixPath + &quot;browserify/querystring/index.js&quot;,</span>
<a href="#l74.99"></a><span id="l74.99" class="difflineminus">-      &quot;url&quot;: matrixPath + &quot;browserify/url.js&quot;,</span>
<a href="#l74.100"></a><span id="l74.100" class="difflineplus">+    &quot;&quot;: matrixPath,</span>
<a href="#l74.101"></a><span id="l74.101" class="difflineplus">+    &quot;../../utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.102"></a><span id="l74.102" class="difflineplus">+    &quot;../content-repo&quot;: matrixPath + &quot;content-repo.js&quot;,</span>
<a href="#l74.103"></a><span id="l74.103" class="difflineplus">+    &quot;../deviceinfo&quot;: matrixPath + &quot;crypto/deviceinfo.js&quot;,</span>
<a href="#l74.104"></a><span id="l74.104" class="difflineplus">+    &quot;../models/event&quot;: matrixPath + &quot;models/event.js&quot;,</span>
<a href="#l74.105"></a><span id="l74.105" class="difflineplus">+    &quot;../models/room&quot;: matrixPath + &quot;models/room.js&quot;,</span>
<a href="#l74.106"></a><span id="l74.106" class="difflineplus">+    &quot;../models/user&quot;: matrixPath + &quot;models/user.js&quot;,</span>
<a href="#l74.107"></a><span id="l74.107" class="difflineplus">+    &quot;../olmlib&quot;: matrixPath + &quot;crypto/olmlib.js&quot;,</span>
<a href="#l74.108"></a><span id="l74.108" class="difflineplus">+    &quot;../utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.109"></a><span id="l74.109" class="difflineplus">+    &quot;./../../utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.110"></a><span id="l74.110" class="difflineplus">+    &quot;./OlmDevice&quot;: matrixPath + &quot;crypto/OlmDevice.js&quot;,</span>
<a href="#l74.111"></a><span id="l74.111" class="difflineplus">+    &quot;./algorithms&quot;: matrixPath + &quot;crypto/algorithms/index.js&quot;,</span>
<a href="#l74.112"></a><span id="l74.112" class="difflineplus">+    &quot;./base&quot;: matrixPath + &quot;crypto/algorithms/base.js&quot;,</span>
<a href="#l74.113"></a><span id="l74.113" class="difflineplus">+    &quot;./base-apis&quot;: matrixPath + &quot;base-apis.js&quot;,</span>
<a href="#l74.114"></a><span id="l74.114" class="difflineplus">+    &quot;./client&quot;: matrixPath + &quot;client.js&quot;,</span>
<a href="#l74.115"></a><span id="l74.115" class="difflineplus">+    &quot;./content-repo&quot;: matrixPath + &quot;content-repo.js&quot;,</span>
<a href="#l74.116"></a><span id="l74.116" class="difflineplus">+    &quot;./crypto&quot;: matrixPath + &quot;crypto/index.js&quot;,</span>
<a href="#l74.117"></a><span id="l74.117" class="difflineplus">+    &quot;./decode&quot;: matrixPath + &quot;browserify/querystring/decode.js&quot;,</span>
<a href="#l74.118"></a><span id="l74.118" class="difflineplus">+    &quot;./deviceinfo&quot;: matrixPath + &quot;crypto/deviceinfo.js&quot;,</span>
<a href="#l74.119"></a><span id="l74.119" class="difflineplus">+    &quot;./encode&quot;: matrixPath + &quot;browserify/querystring/encode.js&quot;,</span>
<a href="#l74.120"></a><span id="l74.120" class="difflineplus">+    &quot;./event&quot;: matrixPath + &quot;models/event.js&quot;,</span>
<a href="#l74.121"></a><span id="l74.121" class="difflineplus">+    &quot;./event-context&quot;: matrixPath + &quot;models/event-content.js&quot;,</span>
<a href="#l74.122"></a><span id="l74.122" class="difflineplus">+    &quot;./event-timeline&quot;: matrixPath + &quot;models/event-timeline.js&quot;,</span>
<a href="#l74.123"></a><span id="l74.123" class="difflineplus">+    &quot;./event-timeline-set&quot;: matrixPath + &quot;models/event-timeline-set.js&quot;,</span>
<a href="#l74.124"></a><span id="l74.124" class="difflineplus">+    &quot;./filter&quot;: matrixPath + &quot;filter.js&quot;,</span>
<a href="#l74.125"></a><span id="l74.125" class="difflineplus">+    &quot;./filter-component&quot;: matrixPath + &quot;filter-component.js&quot;,</span>
<a href="#l74.126"></a><span id="l74.126" class="difflineplus">+    &quot;./http-api&quot;: matrixPath + &quot;http-api.js&quot;,</span>
<a href="#l74.127"></a><span id="l74.127" class="difflineplus">+    &quot;./interactive-auth&quot;: matrixPath + &quot;interactive-auth.js&quot;,</span>
<a href="#l74.128"></a><span id="l74.128" class="difflineplus">+    &quot;./megolm&quot;: matrixPath + &quot;crypto/algorithms/megolm.js&quot;,</span>
<a href="#l74.129"></a><span id="l74.129" class="difflineplus">+    &quot;./models/event&quot;: matrixPath + &quot;models/event.js&quot;,</span>
<a href="#l74.130"></a><span id="l74.130" class="difflineplus">+    &quot;./models/event-timeline&quot;: matrixPath + &quot;models/event-timeline.js&quot;,</span>
<a href="#l74.131"></a><span id="l74.131" class="difflineplus">+    &quot;./models/event-timeline-set&quot;: matrixPath + &quot;models/event-timeline-set.js&quot;,</span>
<a href="#l74.132"></a><span id="l74.132" class="difflineplus">+    &quot;./models/room&quot;: matrixPath + &quot;models/room.js&quot;,</span>
<a href="#l74.133"></a><span id="l74.133" class="difflineplus">+    &quot;./models/room-member&quot;: matrixPath + &quot;models/room-member.js&quot;,</span>
<a href="#l74.134"></a><span id="l74.134" class="difflineplus">+    &quot;./models/room-state&quot;: matrixPath + &quot;models/room-state.js&quot;,</span>
<a href="#l74.135"></a><span id="l74.135" class="difflineplus">+    &quot;./models/search-result&quot;: matrixPath + &quot;models/search-result.js&quot;,</span>
<a href="#l74.136"></a><span id="l74.136" class="difflineplus">+    &quot;./models/user&quot;: matrixPath + &quot;models/user.js&quot;,</span>
<a href="#l74.137"></a><span id="l74.137" class="difflineplus">+    &quot;./olm&quot;: matrixPath + &quot;crypto/algorithms/olm.js&quot;,</span>
<a href="#l74.138"></a><span id="l74.138" class="difflineplus">+    &quot;./olmlib&quot;: matrixPath + &quot;crypto/olmlib.js&quot;,</span>
<a href="#l74.139"></a><span id="l74.139" class="difflineplus">+    &quot;./pushprocessor&quot;: matrixPath + &quot;pushprocessor.js&quot;,</span>
<a href="#l74.140"></a><span id="l74.140" class="difflineplus">+    &quot;./q&quot;: matrixPath + &quot;q/q.js&quot;,</span>
<a href="#l74.141"></a><span id="l74.141" class="difflineplus">+    &quot;./realtime-callbacks&quot;: matrixPath + &quot;realtime-callbacks.js&quot;,</span>
<a href="#l74.142"></a><span id="l74.142" class="difflineplus">+    &quot;./room-member&quot;: matrixPath + &quot;models/room-member.js&quot;,</span>
<a href="#l74.143"></a><span id="l74.143" class="difflineplus">+    &quot;./room-state&quot;: matrixPath + &quot;models/room-state.js&quot;,</span>
<a href="#l74.144"></a><span id="l74.144" class="difflineplus">+    &quot;./room-summary&quot;: matrixPath + &quot;models/room-summary.js&quot;,</span>
<a href="#l74.145"></a><span id="l74.145" class="difflineplus">+    &quot;./scheduler&quot;: matrixPath + &quot;scheduler.js&quot;,</span>
<a href="#l74.146"></a><span id="l74.146" class="difflineplus">+    &quot;./store/memory&quot;: matrixPath + &quot;store/memory.js&quot;,</span>
<a href="#l74.147"></a><span id="l74.147" class="difflineplus">+    &quot;./store/session/webstorage&quot;: matrixPath + &quot;store/session/webstorage.js&quot;,</span>
<a href="#l74.148"></a><span id="l74.148" class="difflineplus">+    &quot;./store/stub&quot;: matrixPath + &quot;store/stub.js&quot;,</span>
<a href="#l74.149"></a><span id="l74.149" class="difflineplus">+    &quot;./store/webstorage&quot;: matrixPath + &quot;store/webstorage.js&quot;,</span>
<a href="#l74.150"></a><span id="l74.150" class="difflineplus">+    &quot;./sync&quot;: matrixPath + &quot;sync.js&quot;,</span>
<a href="#l74.151"></a><span id="l74.151" class="difflineplus">+    &quot;./timeline-window&quot;: matrixPath + &quot;timeline-window.js&quot;,</span>
<a href="#l74.152"></a><span id="l74.152" class="difflineplus">+    &quot;./utils&quot;: matrixPath + &quot;utils.js&quot;,</span>
<a href="#l74.153"></a><span id="l74.153" class="difflineplus">+    &quot;./webrtc/call&quot;: matrixPath + &quot;webrtc/call.js&quot;,</span>
<a href="#l74.154"></a><span id="l74.154" class="difflineplus">+    OlmDevice: matrixPath + &quot;crypto/OlmDevice.js&quot;,</span>
<a href="#l74.155"></a><span id="l74.155" class="difflineplus">+    algorithms: matrixPath + &quot;crypto/algorithms/index.js&quot;,</span>
<a href="#l74.156"></a><span id="l74.156" class="difflineplus">+    &quot;another-json&quot;: matrixPath + &quot;another_json/another-json.js&quot;,</span>
<a href="#l74.157"></a><span id="l74.157" class="difflineplus">+    base: matrixPath + &quot;crypto/algorithms/base.js&quot;,</span>
<a href="#l74.158"></a><span id="l74.158" class="difflineplus">+    &quot;browser-request&quot;: matrixPath + &quot;browser_request/index.js&quot;,</span>
<a href="#l74.159"></a><span id="l74.159" class="difflineplus">+    crypto: matrixPath + &quot;crypto/index.js&quot;,</span>
<a href="#l74.160"></a><span id="l74.160" class="difflineplus">+    decode: matrixPath + &quot;browserify/querystring/decode.js&quot;,</span>
<a href="#l74.161"></a><span id="l74.161" class="difflineplus">+    deviceinfo: matrixPath + &quot;crypto/deviceinfo.js&quot;,</span>
<a href="#l74.162"></a><span id="l74.162" class="difflineplus">+    encode: matrixPath + &quot;browserify/querystring/encode.js&quot;,</span>
<a href="#l74.163"></a><span id="l74.163" class="difflineplus">+    events: matrixPath + &quot;browserify/events.js&quot;,</span>
<a href="#l74.164"></a><span id="l74.164" class="difflineplus">+    megolm: matrixPath + &quot;crypto/algorithms/megolm.js&quot;,</span>
<a href="#l74.165"></a><span id="l74.165" class="difflineplus">+    olm: matrixPath + &quot;crypto/algorithms/olm.js&quot;,</span>
<a href="#l74.166"></a><span id="l74.166" class="difflineplus">+    olmlib: matrixPath + &quot;crypto/olmlib.js&quot;,</span>
<a href="#l74.167"></a><span id="l74.167" class="difflineplus">+    punycode: matrixPath + &quot;browserify/punycode.js&quot;,</span>
<a href="#l74.168"></a><span id="l74.168" class="difflineplus">+    q: matrixPath + &quot;q/q.js&quot;,</span>
<a href="#l74.169"></a><span id="l74.169" class="difflineplus">+    querystring: matrixPath + &quot;browserify/querystring/index.js&quot;,</span>
<a href="#l74.170"></a><span id="l74.170" class="difflineplus">+    url: matrixPath + &quot;browserify/url.js&quot;,</span>
<a href="#l74.171"></a><span id="l74.171">   },</span>
<a href="#l74.172"></a><span id="l74.172">   globals: {</span>
<a href="#l74.173"></a><span id="l74.173">     global: {</span>
<a href="#l74.174"></a><span id="l74.174">       setInterval,</span>
<a href="#l74.175"></a><span id="l74.175">       clearInterval,</span>
<a href="#l74.176"></a><span id="l74.176">       setTimeout,</span>
<a href="#l74.177"></a><span id="l74.177">       clearTimeout,</span>
<a href="#l74.178"></a><span id="l74.178">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/chat/protocols/matrix/matrix.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/chat/protocols/matrix/matrix.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -25,164 +25,193 @@ var {</span>
<a href="#l75.4"></a><span id="l75.4">   Message,</span>
<a href="#l75.5"></a><span id="l75.5">   TooltipInfo,</span>
<a href="#l75.6"></a><span id="l75.6"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l75.7"></a><span id="l75.7"> </span>
<a href="#l75.8"></a><span id="l75.8"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l75.9"></a><span id="l75.9">   l10nHelper(&quot;chrome://chat/locale/matrix.properties&quot;)</span>
<a href="#l75.10"></a><span id="l75.10"> );</span>
<a href="#l75.11"></a><span id="l75.11"> </span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;MatrixSDK&quot;, &quot;resource:///modules/matrix-sdk.jsm&quot;);</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineplus">+  this,</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+  &quot;MatrixSDK&quot;,</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineplus">+  &quot;resource:///modules/matrix-sdk.jsm&quot;</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineplus">+);</span>
<a href="#l75.18"></a><span id="l75.18"> </span>
<a href="#l75.19"></a><span id="l75.19"> function MatrixParticipant(aRoomMember) {</span>
<a href="#l75.20"></a><span id="l75.20">   // FIXME: Should probably use aRoomMember.name, but it's not unique id?</span>
<a href="#l75.21"></a><span id="l75.21">   this._name = aRoomMember.userId;</span>
<a href="#l75.22"></a><span id="l75.22">   this._roomMember = aRoomMember;</span>
<a href="#l75.23"></a><span id="l75.23"> }</span>
<a href="#l75.24"></a><span id="l75.24"> MatrixParticipant.prototype = {</span>
<a href="#l75.25"></a><span id="l75.25">   __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-  get alias() { return this._roomMember.name; },</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineplus">+  get alias() {</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineplus">+    return this._roomMember.name;</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineplus">+  },</span>
<a href="#l75.30"></a><span id="l75.30"> };</span>
<a href="#l75.31"></a><span id="l75.31"> </span>
<a href="#l75.32"></a><span id="l75.32"> /*</span>
<a href="#l75.33"></a><span id="l75.33">  * TODO Other functionality from MatrixClient to implement:</span>
<a href="#l75.34"></a><span id="l75.34">  *  sendNotice</span>
<a href="#l75.35"></a><span id="l75.35">  *  sendReadReceipt</span>
<a href="#l75.36"></a><span id="l75.36">  *  sendTyping</span>
<a href="#l75.37"></a><span id="l75.37">  *  setPowerLevel</span>
<a href="#l75.38"></a><span id="l75.38">  *  setRoomTopic</span>
<a href="#l75.39"></a><span id="l75.39">  */</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineminus">-function MatrixConversation(aAccount, aName, aNick)</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineminus">-{</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineplus">+function MatrixConversation(aAccount, aName, aNick) {</span>
<a href="#l75.43"></a><span id="l75.43">   this._init(aAccount, aName, aNick);</span>
<a href="#l75.44"></a><span id="l75.44"> }</span>
<a href="#l75.45"></a><span id="l75.45"> MatrixConversation.prototype = {</span>
<a href="#l75.46"></a><span id="l75.46">   __proto__: GenericConvChatPrototype,</span>
<a href="#l75.47"></a><span id="l75.47">   sendMsg(aMsg) {</span>
<a href="#l75.48"></a><span id="l75.48">     this._account._client.sendTextMessage(this._roomId, aMsg);</span>
<a href="#l75.49"></a><span id="l75.49">   },</span>
<a href="#l75.50"></a><span id="l75.50" class="difflineminus">-  get room() { return this._account._client.getRoom(this._roomId); },</span>
<a href="#l75.51"></a><span id="l75.51" class="difflineplus">+  get room() {</span>
<a href="#l75.52"></a><span id="l75.52" class="difflineplus">+    return this._account._client.getRoom(this._roomId);</span>
<a href="#l75.53"></a><span id="l75.53" class="difflineplus">+  },</span>
<a href="#l75.54"></a><span id="l75.54">   addParticipant(aRoomMember) {</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineminus">-    if (this._participants.has(aRoomMember.userId))</span>
<a href="#l75.56"></a><span id="l75.56" class="difflineplus">+    if (this._participants.has(aRoomMember.userId)) {</span>
<a href="#l75.57"></a><span id="l75.57">       return;</span>
<a href="#l75.58"></a><span id="l75.58" class="difflineplus">+    }</span>
<a href="#l75.59"></a><span id="l75.59"> </span>
<a href="#l75.60"></a><span id="l75.60">     let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l75.61"></a><span id="l75.61">     this._participants.set(aRoomMember.userId, participant);</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineminus">-    this.notifyObservers(new nsSimpleEnumerator([participant]),</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineminus">-                         &quot;chat-buddy-add&quot;);</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineplus">+    this.notifyObservers(</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+      new nsSimpleEnumerator([participant]),</span>
<a href="#l75.66"></a><span id="l75.66" class="difflineplus">+      &quot;chat-buddy-add&quot;</span>
<a href="#l75.67"></a><span id="l75.67" class="difflineplus">+    );</span>
<a href="#l75.68"></a><span id="l75.68">   },</span>
<a href="#l75.69"></a><span id="l75.69">   initListOfParticipants() {</span>
<a href="#l75.70"></a><span id="l75.70">     let conv = this;</span>
<a href="#l75.71"></a><span id="l75.71">     let participants = [];</span>
<a href="#l75.72"></a><span id="l75.72">     this.room.getJoinedMembers().forEach(function(aRoomMember) {</span>
<a href="#l75.73"></a><span id="l75.73">       if (!conv._participants.has(aRoomMember.userId)) {</span>
<a href="#l75.74"></a><span id="l75.74">         let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l75.75"></a><span id="l75.75">         participants.push(participant);</span>
<a href="#l75.76"></a><span id="l75.76">         conv._participants.set(aRoomMember.userId, participant);</span>
<a href="#l75.77"></a><span id="l75.77">       }</span>
<a href="#l75.78"></a><span id="l75.78">     });</span>
<a href="#l75.79"></a><span id="l75.79" class="difflineminus">-    if (participants.length)</span>
<a href="#l75.80"></a><span id="l75.80" class="difflineminus">-      this.notifyObservers(new nsSimpleEnumerator(participants),</span>
<a href="#l75.81"></a><span id="l75.81" class="difflineminus">-                           &quot;chat-buddy-add&quot;);</span>
<a href="#l75.82"></a><span id="l75.82" class="difflineplus">+    if (participants.length) {</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineplus">+      this.notifyObservers(</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineplus">+        new nsSimpleEnumerator(participants),</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineplus">+        &quot;chat-buddy-add&quot;</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineplus">+      );</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineplus">+    }</span>
<a href="#l75.88"></a><span id="l75.88">   },</span>
<a href="#l75.89"></a><span id="l75.89"> };</span>
<a href="#l75.90"></a><span id="l75.90"> </span>
<a href="#l75.91"></a><span id="l75.91"> /*</span>
<a href="#l75.92"></a><span id="l75.92">  * TODO Other random functionality from MatrixClient that will be useful:</span>
<a href="#l75.93"></a><span id="l75.93">  *  getRooms / getUsers / publicRooms</span>
<a href="#l75.94"></a><span id="l75.94">  *  invite</span>
<a href="#l75.95"></a><span id="l75.95">  *  ban / kick</span>
<a href="#l75.96"></a><span id="l75.96">  *  leave</span>
<a href="#l75.97"></a><span id="l75.97">  *  redactEvent</span>
<a href="#l75.98"></a><span id="l75.98">  *  scrollback</span>
<a href="#l75.99"></a><span id="l75.99">  *  setAvatarUrl</span>
<a href="#l75.100"></a><span id="l75.100">  *  setDisplayName</span>
<a href="#l75.101"></a><span id="l75.101">  *  setPassword</span>
<a href="#l75.102"></a><span id="l75.102">  *  setPresence</span>
<a href="#l75.103"></a><span id="l75.103">  */</span>
<a href="#l75.104"></a><span id="l75.104" class="difflineminus">-function MatrixAccount(aProtocol, aImAccount)</span>
<a href="#l75.105"></a><span id="l75.105" class="difflineminus">-{</span>
<a href="#l75.106"></a><span id="l75.106" class="difflineplus">+function MatrixAccount(aProtocol, aImAccount) {</span>
<a href="#l75.107"></a><span id="l75.107">   this._init(aProtocol, aImAccount);</span>
<a href="#l75.108"></a><span id="l75.108"> }</span>
<a href="#l75.109"></a><span id="l75.109"> MatrixAccount.prototype = {</span>
<a href="#l75.110"></a><span id="l75.110">   __proto__: GenericAccountPrototype,</span>
<a href="#l75.111"></a><span id="l75.111">   observe(aSubject, aTopic, aData) {},</span>
<a href="#l75.112"></a><span id="l75.112" class="difflineminus">-  remove() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l75.113"></a><span id="l75.113" class="difflineminus">-  unInit() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l75.114"></a><span id="l75.114" class="difflineplus">+  remove() {</span>
<a href="#l75.115"></a><span id="l75.115" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l75.116"></a><span id="l75.116" class="difflineplus">+  },</span>
<a href="#l75.117"></a><span id="l75.117" class="difflineplus">+  unInit() {</span>
<a href="#l75.118"></a><span id="l75.118" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l75.119"></a><span id="l75.119" class="difflineplus">+  },</span>
<a href="#l75.120"></a><span id="l75.120">   connect() {</span>
<a href="#l75.121"></a><span id="l75.121">     this.reportConnecting();</span>
<a href="#l75.122"></a><span id="l75.122">     let baseURL = this.getString(&quot;server&quot;) + &quot;:&quot; + this.getInt(&quot;port&quot;);</span>
<a href="#l75.123"></a><span id="l75.123">     let account = this;</span>
<a href="#l75.124"></a><span id="l75.124">     // We call MatrixSDK.createClient twice because loginWithPassword does not</span>
<a href="#l75.125"></a><span id="l75.125">     // properly set access token.</span>
<a href="#l75.126"></a><span id="l75.126">     // See https://github.com/matrix-org/matrix-js-sdk/issues/130</span>
<a href="#l75.127"></a><span id="l75.127">     MatrixSDK.createClient(baseURL)</span>
<a href="#l75.128"></a><span id="l75.128">       .loginWithPassword(this.name, this.imAccount.password)</span>
<a href="#l75.129"></a><span id="l75.129">       .then(function(data) {</span>
<a href="#l75.130"></a><span id="l75.130">         // TODO: Check data.errcode to pass more accurate value as the first</span>
<a href="#l75.131"></a><span id="l75.131">         // parameter of reportDisconnecting.</span>
<a href="#l75.132"></a><span id="l75.132" class="difflineminus">-        if (data.error)</span>
<a href="#l75.133"></a><span id="l75.133" class="difflineplus">+        if (data.error) {</span>
<a href="#l75.134"></a><span id="l75.134">           throw new Error(data.error);</span>
<a href="#l75.135"></a><span id="l75.135" class="difflineplus">+        }</span>
<a href="#l75.136"></a><span id="l75.136">         account._client = MatrixSDK.createClient({</span>
<a href="#l75.137"></a><span id="l75.137">           baseUrl: baseURL,</span>
<a href="#l75.138"></a><span id="l75.138">           accessToken: data.access_token,</span>
<a href="#l75.139"></a><span id="l75.139">           userId: data.user_id,</span>
<a href="#l75.140"></a><span id="l75.140">         });</span>
<a href="#l75.141"></a><span id="l75.141">         account.startClient();</span>
<a href="#l75.142"></a><span id="l75.142" class="difflineminus">-      }).catch(function(error) {</span>
<a href="#l75.143"></a><span id="l75.143" class="difflineminus">-        account.reportDisconnecting(Ci.prplIAccount.ERROR_OTHER_ERROR, error.message);</span>
<a href="#l75.144"></a><span id="l75.144" class="difflineplus">+      })</span>
<a href="#l75.145"></a><span id="l75.145" class="difflineplus">+      .catch(function(error) {</span>
<a href="#l75.146"></a><span id="l75.146" class="difflineplus">+        account.reportDisconnecting(</span>
<a href="#l75.147"></a><span id="l75.147" class="difflineplus">+          Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l75.148"></a><span id="l75.148" class="difflineplus">+          error.message</span>
<a href="#l75.149"></a><span id="l75.149" class="difflineplus">+        );</span>
<a href="#l75.150"></a><span id="l75.150">         account._client = null;</span>
<a href="#l75.151"></a><span id="l75.151">         account.reportDisconnected();</span>
<a href="#l75.152"></a><span id="l75.152" class="difflineminus">-      }).done();</span>
<a href="#l75.153"></a><span id="l75.153" class="difflineplus">+      })</span>
<a href="#l75.154"></a><span id="l75.154" class="difflineplus">+      .done();</span>
<a href="#l75.155"></a><span id="l75.155">   },</span>
<a href="#l75.156"></a><span id="l75.156">   /*</span>
<a href="#l75.157"></a><span id="l75.157">    * Hook up the Matrix Client to callbacks to handle various events.</span>
<a href="#l75.158"></a><span id="l75.158">    *</span>
<a href="#l75.159"></a><span id="l75.159">    * These are documented at:</span>
<a href="#l75.160"></a><span id="l75.160">    * https://matrix-org.github.io/matrix-js-sdk/0.7.0/module-client.html#~event:MatrixClient%2522Call.incoming%2522</span>
<a href="#l75.161"></a><span id="l75.161">    */</span>
<a href="#l75.162"></a><span id="l75.162">   startClient() {</span>
<a href="#l75.163"></a><span id="l75.163">     let account = this;</span>
<a href="#l75.164"></a><span id="l75.164">     this._client.on(&quot;sync&quot;, function(state, prevState, data) {</span>
<a href="#l75.165"></a><span id="l75.165">       switch (state) {</span>
<a href="#l75.166"></a><span id="l75.166">         case &quot;PREPARED&quot;:</span>
<a href="#l75.167"></a><span id="l75.167">           account.reportConnected();</span>
<a href="#l75.168"></a><span id="l75.168" class="difflineminus">-        break;</span>
<a href="#l75.169"></a><span id="l75.169" class="difflineplus">+          break;</span>
<a href="#l75.170"></a><span id="l75.170">         case &quot;STOPPED&quot;:</span>
<a href="#l75.171"></a><span id="l75.171">           // XXX Report disconnecting here?</span>
<a href="#l75.172"></a><span id="l75.172">           account._client.logout().done(function() {</span>
<a href="#l75.173"></a><span id="l75.173">             account.reportDisconnected();</span>
<a href="#l75.174"></a><span id="l75.174">             account._client = null;</span>
<a href="#l75.175"></a><span id="l75.175">           });</span>
<a href="#l75.176"></a><span id="l75.176" class="difflineminus">-        break;</span>
<a href="#l75.177"></a><span id="l75.177" class="difflineplus">+          break;</span>
<a href="#l75.178"></a><span id="l75.178">         // TODO: Handle other states (RECONNECTING, ERROR, SYNCING).</span>
<a href="#l75.179"></a><span id="l75.179">       }</span>
<a href="#l75.180"></a><span id="l75.180">     });</span>
<a href="#l75.181"></a><span id="l75.181" class="difflineminus">-    this._client.on(&quot;RoomMember.membership&quot;, function(event, member, oldMembership) {</span>
<a href="#l75.182"></a><span id="l75.182" class="difflineplus">+    this._client.on(&quot;RoomMember.membership&quot;, function(</span>
<a href="#l75.183"></a><span id="l75.183" class="difflineplus">+      event,</span>
<a href="#l75.184"></a><span id="l75.184" class="difflineplus">+      member,</span>
<a href="#l75.185"></a><span id="l75.185" class="difflineplus">+      oldMembership</span>
<a href="#l75.186"></a><span id="l75.186" class="difflineplus">+    ) {</span>
<a href="#l75.187"></a><span id="l75.187">       if (member.roomId in account._roomList) {</span>
<a href="#l75.188"></a><span id="l75.188">         var room = account._roomList[member.roomId];</span>
<a href="#l75.189"></a><span id="l75.189" class="difflineminus">-        if (member.membership === &quot;join&quot;)</span>
<a href="#l75.190"></a><span id="l75.190" class="difflineplus">+        if (member.membership === &quot;join&quot;) {</span>
<a href="#l75.191"></a><span id="l75.191">           room.addParticipant(member);</span>
<a href="#l75.192"></a><span id="l75.192" class="difflineminus">-        else</span>
<a href="#l75.193"></a><span id="l75.193" class="difflineplus">+        } else {</span>
<a href="#l75.194"></a><span id="l75.194">           room.removeParticipant(member.userId);</span>
<a href="#l75.195"></a><span id="l75.195" class="difflineplus">+        }</span>
<a href="#l75.196"></a><span id="l75.196">       }</span>
<a href="#l75.197"></a><span id="l75.197">     });</span>
<a href="#l75.198"></a><span id="l75.198">     this._client.on(&quot;Room.timeline&quot;, function(event, room, toStartOfTimeline) {</span>
<a href="#l75.199"></a><span id="l75.199">       // TODO: Better handle messages!</span>
<a href="#l75.200"></a><span id="l75.200" class="difflineminus">-      if (toStartOfTimeline)</span>
<a href="#l75.201"></a><span id="l75.201" class="difflineplus">+      if (toStartOfTimeline) {</span>
<a href="#l75.202"></a><span id="l75.202">         return;</span>
<a href="#l75.203"></a><span id="l75.203" class="difflineplus">+      }</span>
<a href="#l75.204"></a><span id="l75.204">       if (room.roomId in account._roomList) {</span>
<a href="#l75.205"></a><span id="l75.205">         let body;</span>
<a href="#l75.206"></a><span id="l75.206">         if (event.getType() === &quot;m.room.message&quot;) {</span>
<a href="#l75.207"></a><span id="l75.207">           body = event.getContent().body;</span>
<a href="#l75.208"></a><span id="l75.208">         } else {</span>
<a href="#l75.209"></a><span id="l75.209">           body = JSON.stringify(event.getContent());</span>
<a href="#l75.210"></a><span id="l75.210">         }</span>
<a href="#l75.211"></a><span id="l75.211" class="difflineminus">-        account._roomList[room.roomId].</span>
<a href="#l75.212"></a><span id="l75.212" class="difflineminus">-          writeMessage(event.getSender(), body, { incoming: true });</span>
<a href="#l75.213"></a><span id="l75.213" class="difflineplus">+        account._roomList[room.roomId].writeMessage(event.getSender(), body, {</span>
<a href="#l75.214"></a><span id="l75.214" class="difflineplus">+          incoming: true,</span>
<a href="#l75.215"></a><span id="l75.215" class="difflineplus">+        });</span>
<a href="#l75.216"></a><span id="l75.216">       }</span>
<a href="#l75.217"></a><span id="l75.217">     });</span>
<a href="#l75.218"></a><span id="l75.218"> </span>
<a href="#l75.219"></a><span id="l75.219">     // TODO Other events to handle:</span>
<a href="#l75.220"></a><span id="l75.220">     //  Room.accountData</span>
<a href="#l75.221"></a><span id="l75.221">     //  Room.localEchoUpdated</span>
<a href="#l75.222"></a><span id="l75.222">     //  Room.name</span>
<a href="#l75.223"></a><span id="l75.223">     //  Room.tags</span>
<a href="#l75.224"></a><span id="l75.224" class="difflineat">@@ -194,92 +223,120 @@ MatrixAccount.prototype = {</span>
<a href="#l75.225"></a><span id="l75.225">     //  User.avatarUrl</span>
<a href="#l75.226"></a><span id="l75.226">     //  User.currentlyActive</span>
<a href="#l75.227"></a><span id="l75.227">     //  User.displayName</span>
<a href="#l75.228"></a><span id="l75.228">     //  User.presence</span>
<a href="#l75.229"></a><span id="l75.229"> </span>
<a href="#l75.230"></a><span id="l75.230">     this._client.startClient();</span>
<a href="#l75.231"></a><span id="l75.231">   },</span>
<a href="#l75.232"></a><span id="l75.232">   disconnect() {</span>
<a href="#l75.233"></a><span id="l75.233" class="difflineminus">-    if (this._client)</span>
<a href="#l75.234"></a><span id="l75.234" class="difflineplus">+    if (this._client) {</span>
<a href="#l75.235"></a><span id="l75.235">       this._client.stopClient();</span>
<a href="#l75.236"></a><span id="l75.236" class="difflineplus">+    }</span>
<a href="#l75.237"></a><span id="l75.237">   },</span>
<a href="#l75.238"></a><span id="l75.238"> </span>
<a href="#l75.239"></a><span id="l75.239" class="difflineminus">-  get canJoinChat() { return true; },</span>
<a href="#l75.240"></a><span id="l75.240" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l75.241"></a><span id="l75.241" class="difflineplus">+    return true;</span>
<a href="#l75.242"></a><span id="l75.242" class="difflineplus">+  },</span>
<a href="#l75.243"></a><span id="l75.243">   chatRoomFields: {</span>
<a href="#l75.244"></a><span id="l75.244">     // XXX Does it make sense to split up the server into a separate field?</span>
<a href="#l75.245"></a><span id="l75.245">     roomIdOrAlias: {</span>
<a href="#l75.246"></a><span id="l75.246" class="difflineminus">-      get label() { return _(&quot;chatRoomField.room&quot;); },</span>
<a href="#l75.247"></a><span id="l75.247" class="difflineplus">+      get label() {</span>
<a href="#l75.248"></a><span id="l75.248" class="difflineplus">+        return _(&quot;chatRoomField.room&quot;);</span>
<a href="#l75.249"></a><span id="l75.249" class="difflineplus">+      },</span>
<a href="#l75.250"></a><span id="l75.250">       required: true,</span>
<a href="#l75.251"></a><span id="l75.251">     },</span>
<a href="#l75.252"></a><span id="l75.252">   },</span>
<a href="#l75.253"></a><span id="l75.253">   parseDefaultChatName(aDefaultName) {</span>
<a href="#l75.254"></a><span id="l75.254">     let chatFields = {</span>
<a href="#l75.255"></a><span id="l75.255">       roomIdOrAlias: aDefaultName,</span>
<a href="#l75.256"></a><span id="l75.256">     };</span>
<a href="#l75.257"></a><span id="l75.257"> </span>
<a href="#l75.258"></a><span id="l75.258">     return chatFields;</span>
<a href="#l75.259"></a><span id="l75.259">   },</span>
<a href="#l75.260"></a><span id="l75.260">   joinChat(aComponents) {</span>
<a href="#l75.261"></a><span id="l75.261">     let roomIdOrAlias = aComponents.getValue(&quot;roomIdOrAlias&quot;).trim();</span>
<a href="#l75.262"></a><span id="l75.262">     let domain = this._client.getDomain();</span>
<a href="#l75.263"></a><span id="l75.263">     // For the format of room id and alias, see the matrix documentation:</span>
<a href="#l75.264"></a><span id="l75.264">     // https://matrix.org/docs/spec/intro.html#room-structure</span>
<a href="#l75.265"></a><span id="l75.265">     // https://matrix.org/docs/spec/intro.html#room-aliases</span>
<a href="#l75.266"></a><span id="l75.266" class="difflineminus">-    if (!roomIdOrAlias.endsWith(&quot;:&quot; + domain))</span>
<a href="#l75.267"></a><span id="l75.267" class="difflineplus">+    if (!roomIdOrAlias.endsWith(&quot;:&quot; + domain)) {</span>
<a href="#l75.268"></a><span id="l75.268">       roomIdOrAlias += &quot;:&quot; + domain;</span>
<a href="#l75.269"></a><span id="l75.269" class="difflineminus">-    if (!roomIdOrAlias.match(&quot;^[!#]&quot;))</span>
<a href="#l75.270"></a><span id="l75.270" class="difflineplus">+    }</span>
<a href="#l75.271"></a><span id="l75.271" class="difflineplus">+    if (!roomIdOrAlias.match(&quot;^[!#]&quot;)) {</span>
<a href="#l75.272"></a><span id="l75.272">       roomIdOrAlias = &quot;#&quot; + roomIdOrAlias;</span>
<a href="#l75.273"></a><span id="l75.273" class="difflineplus">+    }</span>
<a href="#l75.274"></a><span id="l75.274"> </span>
<a href="#l75.275"></a><span id="l75.275">     // TODO: Use getRoom to find existing conversation?</span>
<a href="#l75.276"></a><span id="l75.276">     let conv = new MatrixConversation(this, roomIdOrAlias, this.userId);</span>
<a href="#l75.277"></a><span id="l75.277">     conv.joining = true;</span>
<a href="#l75.278"></a><span id="l75.278">     let account = this;</span>
<a href="#l75.279"></a><span id="l75.279" class="difflineminus">-    this._client.joinRoom(roomIdOrAlias).then(function(room) {</span>
<a href="#l75.280"></a><span id="l75.280" class="difflineminus">-      conv._roomId = room.roomId;</span>
<a href="#l75.281"></a><span id="l75.281" class="difflineminus">-      account._roomList[room.roomId] = conv;</span>
<a href="#l75.282"></a><span id="l75.282" class="difflineminus">-      conv.initListOfParticipants();</span>
<a href="#l75.283"></a><span id="l75.283" class="difflineminus">-      conv.joining = false;</span>
<a href="#l75.284"></a><span id="l75.284" class="difflineminus">-    }).catch(function(error) {</span>
<a href="#l75.285"></a><span id="l75.285" class="difflineplus">+    this._client</span>
<a href="#l75.286"></a><span id="l75.286" class="difflineplus">+      .joinRoom(roomIdOrAlias)</span>
<a href="#l75.287"></a><span id="l75.287" class="difflineplus">+      .then(function(room) {</span>
<a href="#l75.288"></a><span id="l75.288" class="difflineplus">+        conv._roomId = room.roomId;</span>
<a href="#l75.289"></a><span id="l75.289" class="difflineplus">+        account._roomList[room.roomId] = conv;</span>
<a href="#l75.290"></a><span id="l75.290" class="difflineplus">+        conv.initListOfParticipants();</span>
<a href="#l75.291"></a><span id="l75.291" class="difflineplus">+        conv.joining = false;</span>
<a href="#l75.292"></a><span id="l75.292" class="difflineplus">+      })</span>
<a href="#l75.293"></a><span id="l75.293" class="difflineplus">+      .catch(function(error) {</span>
<a href="#l75.294"></a><span id="l75.294">         // TODO: Handle errors?</span>
<a href="#l75.295"></a><span id="l75.295">         // XXX We probably want to display an error in the open conversation</span>
<a href="#l75.296"></a><span id="l75.296">         //     window and leave it as unjoined.</span>
<a href="#l75.297"></a><span id="l75.297">         account.ERROR(error);</span>
<a href="#l75.298"></a><span id="l75.298">         conv.close();</span>
<a href="#l75.299"></a><span id="l75.299"> </span>
<a href="#l75.300"></a><span id="l75.300">         // TODO Perhaps we should call createRoom if the room doesn't exist.</span>
<a href="#l75.301"></a><span id="l75.301" class="difflineminus">-    }).done();</span>
<a href="#l75.302"></a><span id="l75.302" class="difflineplus">+      })</span>
<a href="#l75.303"></a><span id="l75.303" class="difflineplus">+      .done();</span>
<a href="#l75.304"></a><span id="l75.304">     return conv;</span>
<a href="#l75.305"></a><span id="l75.305">   },</span>
<a href="#l75.306"></a><span id="l75.306" class="difflineminus">-  createConversation(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l75.307"></a><span id="l75.307" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l75.308"></a><span id="l75.308" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l75.309"></a><span id="l75.309" class="difflineplus">+  },</span>
<a href="#l75.310"></a><span id="l75.310"> </span>
<a href="#l75.311"></a><span id="l75.311" class="difflineminus">-  get userId() { return this._client.credentials.userId; },</span>
<a href="#l75.312"></a><span id="l75.312" class="difflineplus">+  get userId() {</span>
<a href="#l75.313"></a><span id="l75.313" class="difflineplus">+    return this._client.credentials.userId;</span>
<a href="#l75.314"></a><span id="l75.314" class="difflineplus">+  },</span>
<a href="#l75.315"></a><span id="l75.315">   _client: null,</span>
<a href="#l75.316"></a><span id="l75.316">   _roomList: new Map(),</span>
<a href="#l75.317"></a><span id="l75.317"> };</span>
<a href="#l75.318"></a><span id="l75.318"> </span>
<a href="#l75.319"></a><span id="l75.319" class="difflineminus">-function MatrixProtocol() {</span>
<a href="#l75.320"></a><span id="l75.320" class="difflineminus">-}</span>
<a href="#l75.321"></a><span id="l75.321" class="difflineplus">+function MatrixProtocol() {}</span>
<a href="#l75.322"></a><span id="l75.322"> MatrixProtocol.prototype = {</span>
<a href="#l75.323"></a><span id="l75.323">   __proto__: GenericProtocolPrototype,</span>
<a href="#l75.324"></a><span id="l75.324" class="difflineminus">-  get normalizedName() { return &quot;matrix&quot;; },</span>
<a href="#l75.325"></a><span id="l75.325" class="difflineminus">-  get name() { return &quot;Matrix&quot;; },</span>
<a href="#l75.326"></a><span id="l75.326" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-matrix/skin/&quot;; },</span>
<a href="#l75.327"></a><span id="l75.327" class="difflineminus">-  getAccount(aImAccount) { return new MatrixAccount(this, aImAccount); },</span>
<a href="#l75.328"></a><span id="l75.328" class="difflineplus">+  get normalizedName() {</span>
<a href="#l75.329"></a><span id="l75.329" class="difflineplus">+    return &quot;matrix&quot;;</span>
<a href="#l75.330"></a><span id="l75.330" class="difflineplus">+  },</span>
<a href="#l75.331"></a><span id="l75.331" class="difflineplus">+  get name() {</span>
<a href="#l75.332"></a><span id="l75.332" class="difflineplus">+    return &quot;Matrix&quot;;</span>
<a href="#l75.333"></a><span id="l75.333" class="difflineplus">+  },</span>
<a href="#l75.334"></a><span id="l75.334" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l75.335"></a><span id="l75.335" class="difflineplus">+    return &quot;chrome://prpl-matrix/skin/&quot;;</span>
<a href="#l75.336"></a><span id="l75.336" class="difflineplus">+  },</span>
<a href="#l75.337"></a><span id="l75.337" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l75.338"></a><span id="l75.338" class="difflineplus">+    return new MatrixAccount(this, aImAccount);</span>
<a href="#l75.339"></a><span id="l75.339" class="difflineplus">+  },</span>
<a href="#l75.340"></a><span id="l75.340"> </span>
<a href="#l75.341"></a><span id="l75.341">   options: {</span>
<a href="#l75.342"></a><span id="l75.342">     // XXX Default to matrix.org once we support connection as guest?</span>
<a href="#l75.343"></a><span id="l75.343">     server: {</span>
<a href="#l75.344"></a><span id="l75.344" class="difflineminus">-      get label() { return _(&quot;options.connectServer&quot;); },</span>
<a href="#l75.345"></a><span id="l75.345" class="difflineplus">+      get label() {</span>
<a href="#l75.346"></a><span id="l75.346" class="difflineplus">+        return _(&quot;options.connectServer&quot;);</span>
<a href="#l75.347"></a><span id="l75.347" class="difflineplus">+      },</span>
<a href="#l75.348"></a><span id="l75.348">       default: &quot;https://&quot;,</span>
<a href="#l75.349"></a><span id="l75.349">     },</span>
<a href="#l75.350"></a><span id="l75.350">     port: {</span>
<a href="#l75.351"></a><span id="l75.351" class="difflineminus">-      get label() { return _(&quot;options.connectPort&quot;); },</span>
<a href="#l75.352"></a><span id="l75.352" class="difflineplus">+      get label() {</span>
<a href="#l75.353"></a><span id="l75.353" class="difflineplus">+        return _(&quot;options.connectPort&quot;);</span>
<a href="#l75.354"></a><span id="l75.354" class="difflineplus">+      },</span>
<a href="#l75.355"></a><span id="l75.355">       default: 443,</span>
<a href="#l75.356"></a><span id="l75.356">     },</span>
<a href="#l75.357"></a><span id="l75.357">   },</span>
<a href="#l75.358"></a><span id="l75.358"> </span>
<a href="#l75.359"></a><span id="l75.359" class="difflineminus">-  get chatHasTopic() { return true; },</span>
<a href="#l75.360"></a><span id="l75.360" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l75.361"></a><span id="l75.361" class="difflineplus">+    return true;</span>
<a href="#l75.362"></a><span id="l75.362" class="difflineplus">+  },</span>
<a href="#l75.363"></a><span id="l75.363"> </span>
<a href="#l75.364"></a><span id="l75.364">   classID: Components.ID(&quot;{e9653ac6-a671-11e6-bf84-60a44c717042}&quot;),</span>
<a href="#l75.365"></a><span id="l75.365"> };</span>
<a href="#l75.366"></a><span id="l75.366"> </span>
<a href="#l75.367"></a><span id="l75.367"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([MatrixProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -26,60 +26,76 @@ var {</span>
<a href="#l76.4"></a><span id="l76.4">   TooltipInfo,</span>
<a href="#l76.5"></a><span id="l76.5"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l76.6"></a><span id="l76.6"> var {</span>
<a href="#l76.7"></a><span id="l76.7">   XMPPConversationPrototype,</span>
<a href="#l76.8"></a><span id="l76.8">   XMPPMUCConversationPrototype,</span>
<a href="#l76.9"></a><span id="l76.9">   XMPPAccountBuddyPrototype,</span>
<a href="#l76.10"></a><span id="l76.10">   XMPPAccountPrototype,</span>
<a href="#l76.11"></a><span id="l76.11"> } = ChromeUtils.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-var {</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineminus">-  XMPPSession,</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineminus">-  XMPPDefaultResource,</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineplus">+var { XMPPSession, XMPPDefaultResource } = ChromeUtils.import(</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineplus">+  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineplus">+);</span>
<a href="#l76.19"></a><span id="l76.19"> </span>
<a href="#l76.20"></a><span id="l76.20"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l76.21"></a><span id="l76.21">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l76.22"></a><span id="l76.22"> );</span>
<a href="#l76.23"></a><span id="l76.23"> </span>
<a href="#l76.24"></a><span id="l76.24"> function OdnoklassnikiAccount(aProtoInstance, aImAccount) {</span>
<a href="#l76.25"></a><span id="l76.25">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l76.26"></a><span id="l76.26"> }</span>
<a href="#l76.27"></a><span id="l76.27"> OdnoklassnikiAccount.prototype = {</span>
<a href="#l76.28"></a><span id="l76.28">   __proto__: XMPPAccountPrototype,</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineminus">-  get canJoinChat() { return false; },</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineplus">+    return false;</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+  },</span>
<a href="#l76.33"></a><span id="l76.33">   connect() {</span>
<a href="#l76.34"></a><span id="l76.34">     if (!this.name.includes(&quot;@&quot;)) {</span>
<a href="#l76.35"></a><span id="l76.35">       // TODO: Do not use the default resource value if the user has not</span>
<a href="#l76.36"></a><span id="l76.36">       // specified it and let the service generate it.</span>
<a href="#l76.37"></a><span id="l76.37">       let jid = this.name + &quot;@odnoklassniki.ru/&quot; + XMPPDefaultResource;</span>
<a href="#l76.38"></a><span id="l76.38">       this._jid = this._parseJID(jid);</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-    }</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineminus">-    else {</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+    } else {</span>
<a href="#l76.42"></a><span id="l76.42">       this._jid = this._parseJID(this.name);</span>
<a href="#l76.43"></a><span id="l76.43">       if (this._jid.domain != &quot;odnoklassniki.ru&quot;) {</span>
<a href="#l76.44"></a><span id="l76.44">         // We can't use this.onError because this._connection doesn't exist.</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineminus">-        this.reportDisconnecting(Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l76.46"></a><span id="l76.46" class="difflineminus">-                                 _(&quot;connection.error.invalidUsername&quot;));</span>
<a href="#l76.47"></a><span id="l76.47" class="difflineplus">+        this.reportDisconnecting(</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineplus">+          Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineplus">+          _(&quot;connection.error.invalidUsername&quot;)</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineplus">+        );</span>
<a href="#l76.51"></a><span id="l76.51">         this.reportDisconnected();</span>
<a href="#l76.52"></a><span id="l76.52">         return;</span>
<a href="#l76.53"></a><span id="l76.53">       }</span>
<a href="#l76.54"></a><span id="l76.54">     }</span>
<a href="#l76.55"></a><span id="l76.55"> </span>
<a href="#l76.56"></a><span id="l76.56" class="difflineminus">-    this._connection = new XMPPSession(&quot;xmpp.odnoklassniki.ru&quot;, 5222,</span>
<a href="#l76.57"></a><span id="l76.57" class="difflineminus">-                                       &quot;require_tls&quot;, this._jid,</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineminus">-                                       this.imAccount.password, this);</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineplus">+    this._connection = new XMPPSession(</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+      &quot;xmpp.odnoklassniki.ru&quot;,</span>
<a href="#l76.61"></a><span id="l76.61" class="difflineplus">+      5222,</span>
<a href="#l76.62"></a><span id="l76.62" class="difflineplus">+      &quot;require_tls&quot;,</span>
<a href="#l76.63"></a><span id="l76.63" class="difflineplus">+      this._jid,</span>
<a href="#l76.64"></a><span id="l76.64" class="difflineplus">+      this.imAccount.password,</span>
<a href="#l76.65"></a><span id="l76.65" class="difflineplus">+      this</span>
<a href="#l76.66"></a><span id="l76.66" class="difflineplus">+    );</span>
<a href="#l76.67"></a><span id="l76.67">   },</span>
<a href="#l76.68"></a><span id="l76.68"> };</span>
<a href="#l76.69"></a><span id="l76.69"> </span>
<a href="#l76.70"></a><span id="l76.70" class="difflineminus">-function OdnoklassnikiProtocol() {</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineminus">-}</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineplus">+function OdnoklassnikiProtocol() {}</span>
<a href="#l76.73"></a><span id="l76.73"> OdnoklassnikiProtocol.prototype = {</span>
<a href="#l76.74"></a><span id="l76.74">   __proto__: GenericProtocolPrototype,</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineminus">-  get normalizedName() { return &quot;odnoklassniki&quot;; },</span>
<a href="#l76.76"></a><span id="l76.76" class="difflineminus">-  get name() { return _(&quot;odnoklassniki.protocolName&quot;); },</span>
<a href="#l76.77"></a><span id="l76.77" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-odnoklassniki/skin/&quot;; },</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineminus">-  get usernameEmptyText() { return _(&quot;odnoklassniki.usernameHint&quot;); },</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineminus">-  getAccount(aImAccount) { return new OdnoklassnikiAccount(this, aImAccount); },</span>
<a href="#l76.80"></a><span id="l76.80" class="difflineplus">+  get normalizedName() {</span>
<a href="#l76.81"></a><span id="l76.81" class="difflineplus">+    return &quot;odnoklassniki&quot;;</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineplus">+  },</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineplus">+  get name() {</span>
<a href="#l76.84"></a><span id="l76.84" class="difflineplus">+    return _(&quot;odnoklassniki.protocolName&quot;);</span>
<a href="#l76.85"></a><span id="l76.85" class="difflineplus">+  },</span>
<a href="#l76.86"></a><span id="l76.86" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l76.87"></a><span id="l76.87" class="difflineplus">+    return &quot;chrome://prpl-odnoklassniki/skin/&quot;;</span>
<a href="#l76.88"></a><span id="l76.88" class="difflineplus">+  },</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l76.90"></a><span id="l76.90" class="difflineplus">+    return _(&quot;odnoklassniki.usernameHint&quot;);</span>
<a href="#l76.91"></a><span id="l76.91" class="difflineplus">+  },</span>
<a href="#l76.92"></a><span id="l76.92" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l76.93"></a><span id="l76.93" class="difflineplus">+    return new OdnoklassnikiAccount(this, aImAccount);</span>
<a href="#l76.94"></a><span id="l76.94" class="difflineplus">+  },</span>
<a href="#l76.95"></a><span id="l76.95">   classID: Components.ID(&quot;{29b09a83-81c1-2032-11e2-6d9bc4f8e969}&quot;),</span>
<a href="#l76.96"></a><span id="l76.96"> };</span>
<a href="#l76.97"></a><span id="l76.97"> </span>
<a href="#l76.98"></a><span id="l76.98"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([OdnoklassnikiProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/chat/protocols/skype/skype.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/chat/protocols/skype/skype.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -1,24 +1,24 @@</span>
<a href="#l77.4"></a><span id="l77.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l77.5"></a><span id="l77.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l77.6"></a><span id="l77.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l77.7"></a><span id="l77.7"> </span>
<a href="#l77.8"></a><span id="l77.8" class="difflineminus">-var {httpRequest} = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l77.9"></a><span id="l77.9" class="difflineplus">+var { httpRequest } = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l77.10"></a><span id="l77.10"> var {</span>
<a href="#l77.11"></a><span id="l77.11">   copyBytes,</span>
<a href="#l77.12"></a><span id="l77.12">   ArrayBufferToBytes,</span>
<a href="#l77.13"></a><span id="l77.13">   BytesToArrayBuffer,</span>
<a href="#l77.14"></a><span id="l77.14">   StringToBytes,</span>
<a href="#l77.15"></a><span id="l77.15">   StringToArrayBuffer,</span>
<a href="#l77.16"></a><span id="l77.16">   ArrayBufferToString,</span>
<a href="#l77.17"></a><span id="l77.17">   ArrayBufferToHexString,</span>
<a href="#l77.18"></a><span id="l77.18"> } = ChromeUtils.import(&quot;resource:///modules/ArrayBufferUtils.jsm&quot;);</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineminus">-var {bigInt} = ChromeUtils.import(&quot;resource:///modules/BigInteger.jsm&quot;);</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineplus">+var { bigInt } = ChromeUtils.import(&quot;resource:///modules/BigInteger.jsm&quot;);</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l77.23"></a><span id="l77.23"> var {</span>
<a href="#l77.24"></a><span id="l77.24">   EmptyEnumerator,</span>
<a href="#l77.25"></a><span id="l77.25">   XPCOMUtils,</span>
<a href="#l77.26"></a><span id="l77.26">   clearTimeout,</span>
<a href="#l77.27"></a><span id="l77.27">   l10nHelper,</span>
<a href="#l77.28"></a><span id="l77.28">   nsSimpleEnumerator,</span>
<a href="#l77.29"></a><span id="l77.29"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l77.30"></a><span id="l77.30"> var {</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineat">@@ -34,30 +34,31 @@ var {</span>
<a href="#l77.32"></a><span id="l77.32">   TooltipInfo,</span>
<a href="#l77.33"></a><span id="l77.33"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l77.34"></a><span id="l77.34"> </span>
<a href="#l77.35"></a><span id="l77.35"> // Constants used by the login process. This emulates a captured session using</span>
<a href="#l77.36"></a><span id="l77.36"> // official means.</span>
<a href="#l77.37"></a><span id="l77.37"> var kLockAndKeyAppId = &quot;msmsgs@msnmsgr.com&quot;;</span>
<a href="#l77.38"></a><span id="l77.38"> var kLockAndKeySecret = &quot;Q1P7W2E4J9R8U3S5&quot;;</span>
<a href="#l77.39"></a><span id="l77.39"> var kClientId = &quot;578134&quot;;</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineminus">-var kClientInfo = &quot;os=Windows; osVer=8.1; proc=Win32; lcid=en-us; &quot; +</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineplus">+var kClientInfo =</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineplus">+  &quot;os=Windows; osVer=8.1; proc=Win32; lcid=en-us; &quot; +</span>
<a href="#l77.43"></a><span id="l77.43">   &quot;deviceType=1; country=n/a; clientName=swx-skype.com; clientVer=908/1.0.0.20&quot;;</span>
<a href="#l77.44"></a><span id="l77.44"> </span>
<a href="#l77.45"></a><span id="l77.45"> var kLoginHost = &quot;login.skype.com&quot;;</span>
<a href="#l77.46"></a><span id="l77.46"> var kContactsHost = &quot;api.skype.com&quot;;</span>
<a href="#l77.47"></a><span id="l77.47"> var kMessagesHost = &quot;client-s.gateway.messenger.live.com&quot;;</span>
<a href="#l77.48"></a><span id="l77.48"> </span>
<a href="#l77.49"></a><span id="l77.49"> // Map from strings returned by the SkypeWeb API to statuses.</span>
<a href="#l77.50"></a><span id="l77.50"> var kStatusMap = {</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineminus">-  &quot;Online&quot;: &quot;AVAILABLE&quot;,</span>
<a href="#l77.52"></a><span id="l77.52" class="difflineminus">-  &quot;Offline&quot;: &quot;OFFLINE&quot;,</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineminus">-  &quot;Idle&quot;: &quot;IDLE&quot;,</span>
<a href="#l77.54"></a><span id="l77.54" class="difflineminus">-  &quot;Away&quot;: &quot;AWAY&quot;,</span>
<a href="#l77.55"></a><span id="l77.55" class="difflineminus">-  &quot;Hidden&quot;: &quot;INVISIBLE&quot;,</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineplus">+  Online: &quot;AVAILABLE&quot;,</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+  Offline: &quot;OFFLINE&quot;,</span>
<a href="#l77.58"></a><span id="l77.58" class="difflineplus">+  Idle: &quot;IDLE&quot;,</span>
<a href="#l77.59"></a><span id="l77.59" class="difflineplus">+  Away: &quot;AWAY&quot;,</span>
<a href="#l77.60"></a><span id="l77.60" class="difflineplus">+  Hidden: &quot;INVISIBLE&quot;,</span>
<a href="#l77.61"></a><span id="l77.61"> };</span>
<a href="#l77.62"></a><span id="l77.62"> </span>
<a href="#l77.63"></a><span id="l77.63"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l77.64"></a><span id="l77.64">   l10nHelper(&quot;chrome://chat/locale/skype.properties&quot;)</span>
<a href="#l77.65"></a><span id="l77.65"> );</span>
<a href="#l77.66"></a><span id="l77.66"> </span>
<a href="#l77.67"></a><span id="l77.67"> /*</span>
<a href="#l77.68"></a><span id="l77.68">  * Convert a URL to a user's name.</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineat">@@ -66,50 +67,57 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, (</span>
<a href="#l77.70"></a><span id="l77.70">  *      https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService</span>
<a href="#l77.71"></a><span id="l77.71">  *</span>
<a href="#l77.72"></a><span id="l77.72">  *</span>
<a href="#l77.73"></a><span id="l77.73">  * Note that some contacts might have a /1: in them (instead of a /8:), that's</span>
<a href="#l77.74"></a><span id="l77.74">  * for MSN linked contacts.</span>
<a href="#l77.75"></a><span id="l77.75">  */</span>
<a href="#l77.76"></a><span id="l77.76"> function contactUrlToName(aUrl) {</span>
<a href="#l77.77"></a><span id="l77.77">   let start = aUrl.indexOf(&quot;/8:&quot;);</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineminus">-  if (start == -1)</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineplus">+  if (start == -1) {</span>
<a href="#l77.80"></a><span id="l77.80">     return null;</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineplus">+  }</span>
<a href="#l77.82"></a><span id="l77.82">   // Skip over the separator.</span>
<a href="#l77.83"></a><span id="l77.83">   start += &quot;/8:&quot;.length;</span>
<a href="#l77.84"></a><span id="l77.84"> </span>
<a href="#l77.85"></a><span id="l77.85">   let end = aUrl.indexOf(&quot;/&quot;, start);</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineminus">-  if (end == -1)</span>
<a href="#l77.87"></a><span id="l77.87" class="difflineplus">+  if (end == -1) {</span>
<a href="#l77.88"></a><span id="l77.88">     end = undefined;</span>
<a href="#l77.89"></a><span id="l77.89" class="difflineplus">+  }</span>
<a href="#l77.90"></a><span id="l77.90"> </span>
<a href="#l77.91"></a><span id="l77.91">   return aUrl.slice(start, end);</span>
<a href="#l77.92"></a><span id="l77.92"> }</span>
<a href="#l77.93"></a><span id="l77.93"> </span>
<a href="#l77.94"></a><span id="l77.94"> function SkypeConversation(aAccount, aName) {</span>
<a href="#l77.95"></a><span id="l77.95">   this.buddy = aAccount._buddies.get(aName);</span>
<a href="#l77.96"></a><span id="l77.96">   this._init(aAccount, aName);</span>
<a href="#l77.97"></a><span id="l77.97"> }</span>
<a href="#l77.98"></a><span id="l77.98"> SkypeConversation.prototype = {</span>
<a href="#l77.99"></a><span id="l77.99">   __proto__: GenericConvIMPrototype,</span>
<a href="#l77.100"></a><span id="l77.100">   _account: null,</span>
<a href="#l77.101"></a><span id="l77.101"> </span>
<a href="#l77.102"></a><span id="l77.102">   sendMsg(aMessage) {</span>
<a href="#l77.103"></a><span id="l77.103" class="difflineminus">-    if (!aMessage.length)</span>
<a href="#l77.104"></a><span id="l77.104" class="difflineplus">+    if (!aMessage.length) {</span>
<a href="#l77.105"></a><span id="l77.105">       return;</span>
<a href="#l77.106"></a><span id="l77.106" class="difflineplus">+    }</span>
<a href="#l77.107"></a><span id="l77.107"> </span>
<a href="#l77.108"></a><span id="l77.108">     let target = &quot;8:&quot; + this.name;</span>
<a href="#l77.109"></a><span id="l77.109" class="difflineminus">-    let url = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/conversations/&quot; +</span>
<a href="#l77.110"></a><span id="l77.110" class="difflineminus">-              target + &quot;/messages&quot;;</span>
<a href="#l77.111"></a><span id="l77.111" class="difflineplus">+    let url =</span>
<a href="#l77.112"></a><span id="l77.112" class="difflineplus">+      &quot;https://&quot; +</span>
<a href="#l77.113"></a><span id="l77.113" class="difflineplus">+      kMessagesHost +</span>
<a href="#l77.114"></a><span id="l77.114" class="difflineplus">+      &quot;/v1/users/ME/conversations/&quot; +</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineplus">+      target +</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineplus">+      &quot;/messages&quot;;</span>
<a href="#l77.117"></a><span id="l77.117"> </span>
<a href="#l77.118"></a><span id="l77.118">     let clientMessageId = Date.now().toString();</span>
<a href="#l77.119"></a><span id="l77.119">     let message = {</span>
<a href="#l77.120"></a><span id="l77.120" class="difflineminus">-      &quot;clientmessageid&quot;: clientMessageId,</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineminus">-      &quot;content&quot;: aMessage,</span>
<a href="#l77.122"></a><span id="l77.122" class="difflineminus">-      &quot;messagetype&quot;: &quot;RichText&quot;,</span>
<a href="#l77.123"></a><span id="l77.123" class="difflineminus">-      &quot;contenttype&quot;: &quot;text&quot;,</span>
<a href="#l77.124"></a><span id="l77.124" class="difflineplus">+      clientmessageid: clientMessageId,</span>
<a href="#l77.125"></a><span id="l77.125" class="difflineplus">+      content: aMessage,</span>
<a href="#l77.126"></a><span id="l77.126" class="difflineplus">+      messagetype: &quot;RichText&quot;,</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineplus">+      contenttype: &quot;text&quot;,</span>
<a href="#l77.128"></a><span id="l77.128">     };</span>
<a href="#l77.129"></a><span id="l77.129">     let options = {</span>
<a href="#l77.130"></a><span id="l77.130">       onLoad: (aResponse, aXhr) =&gt; {</span>
<a href="#l77.131"></a><span id="l77.131">         this._account.LOG(&quot;Message response: &quot; + aResponse);</span>
<a href="#l77.132"></a><span id="l77.132">         this._account.LOG(&quot;Successfully sent message: &quot; + aMessage);</span>
<a href="#l77.133"></a><span id="l77.133">       },</span>
<a href="#l77.134"></a><span id="l77.134">       onError: this._account._onHttpFailure(&quot;sending message&quot;),</span>
<a href="#l77.135"></a><span id="l77.135">       postData: JSON.stringify(message),</span>
<a href="#l77.136"></a><span id="l77.136" class="difflineat">@@ -127,35 +135,40 @@ function SkypeAccountBuddy(aAccount, aBu</span>
<a href="#l77.137"></a><span id="l77.137">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l77.138"></a><span id="l77.138"> }</span>
<a href="#l77.139"></a><span id="l77.139"> SkypeAccountBuddy.prototype = {</span>
<a href="#l77.140"></a><span id="l77.140">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l77.141"></a><span id="l77.141">   _info: null,</span>
<a href="#l77.142"></a><span id="l77.142">   mood: null,</span>
<a href="#l77.143"></a><span id="l77.143"> </span>
<a href="#l77.144"></a><span id="l77.144">   // Called when the user wants to chat with the buddy.</span>
<a href="#l77.145"></a><span id="l77.145" class="difflineminus">-  createConversation() { return this._account.createConversation(this.userName); },</span>
<a href="#l77.146"></a><span id="l77.146" class="difflineplus">+  createConversation() {</span>
<a href="#l77.147"></a><span id="l77.147" class="difflineplus">+    return this._account.createConversation(this.userName);</span>
<a href="#l77.148"></a><span id="l77.148" class="difflineplus">+  },</span>
<a href="#l77.149"></a><span id="l77.149"> </span>
<a href="#l77.150"></a><span id="l77.150">   // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l77.151"></a><span id="l77.151">   // hovers over the buddy.</span>
<a href="#l77.152"></a><span id="l77.152">   getTooltipInfo() {</span>
<a href="#l77.153"></a><span id="l77.153" class="difflineminus">-    if (!this._info)</span>
<a href="#l77.154"></a><span id="l77.154" class="difflineplus">+    if (!this._info) {</span>
<a href="#l77.155"></a><span id="l77.155">       return EmptyEnumerator;</span>
<a href="#l77.156"></a><span id="l77.156" class="difflineplus">+    }</span>
<a href="#l77.157"></a><span id="l77.157"> </span>
<a href="#l77.158"></a><span id="l77.158">     let tooltipInfo = [];</span>
<a href="#l77.159"></a><span id="l77.159">     for (let info in this._info) {</span>
<a href="#l77.160"></a><span id="l77.160">       // If there's no value, skip the element.</span>
<a href="#l77.161"></a><span id="l77.161" class="difflineminus">-      if (!this._info[info])</span>
<a href="#l77.162"></a><span id="l77.162" class="difflineplus">+      if (!this._info[info]) {</span>
<a href="#l77.163"></a><span id="l77.163">         continue;</span>
<a href="#l77.164"></a><span id="l77.164" class="difflineplus">+      }</span>
<a href="#l77.165"></a><span id="l77.165"> </span>
<a href="#l77.166"></a><span id="l77.166">       // TODO Put real labels on here.</span>
<a href="#l77.167"></a><span id="l77.167">       tooltipInfo.push(new TooltipInfo(info, this._info[info]));</span>
<a href="#l77.168"></a><span id="l77.168">     }</span>
<a href="#l77.169"></a><span id="l77.169" class="difflineminus">-    if (this.mood)</span>
<a href="#l77.170"></a><span id="l77.170" class="difflineplus">+    if (this.mood) {</span>
<a href="#l77.171"></a><span id="l77.171">       tooltipInfo.push(new TooltipInfo(&quot;Mood&quot;, this.mood));</span>
<a href="#l77.172"></a><span id="l77.172" class="difflineplus">+    }</span>
<a href="#l77.173"></a><span id="l77.173"> </span>
<a href="#l77.174"></a><span id="l77.174">     return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l77.175"></a><span id="l77.175">   },</span>
<a href="#l77.176"></a><span id="l77.176"> </span>
<a href="#l77.177"></a><span id="l77.177">   remove() {</span>
<a href="#l77.178"></a><span id="l77.178">     this._account.removeBuddy(this);</span>
<a href="#l77.179"></a><span id="l77.179">     GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l77.180"></a><span id="l77.180">   },</span>
<a href="#l77.181"></a><span id="l77.181" class="difflineat">@@ -163,45 +176,49 @@ SkypeAccountBuddy.prototype = {</span>
<a href="#l77.182"></a><span id="l77.182"> </span>
<a href="#l77.183"></a><span id="l77.183"> /*</span>
<a href="#l77.184"></a><span id="l77.184">  * Cut out a part of a larger string bordered by aStart and aEnd. Returns an</span>
<a href="#l77.185"></a><span id="l77.185">  * empty string if the needle is not found.</span>
<a href="#l77.186"></a><span id="l77.186">  */</span>
<a href="#l77.187"></a><span id="l77.187"> function extractString(aStr, aStart, aEnd) {</span>
<a href="#l77.188"></a><span id="l77.188">   // First find the start index, then offset by the string length.</span>
<a href="#l77.189"></a><span id="l77.189">   let startIndex = aStr.indexOf(aStart) + aStart.length;</span>
<a href="#l77.190"></a><span id="l77.190" class="difflineminus">-  if (startIndex == -1)</span>
<a href="#l77.191"></a><span id="l77.191" class="difflineplus">+  if (startIndex == -1) {</span>
<a href="#l77.192"></a><span id="l77.192">     return &quot;&quot;;</span>
<a href="#l77.193"></a><span id="l77.193" class="difflineplus">+  }</span>
<a href="#l77.194"></a><span id="l77.194">   // Now find the next occurrence of end after the start.</span>
<a href="#l77.195"></a><span id="l77.195">   let endIndex = aStr.indexOf(aEnd, startIndex);</span>
<a href="#l77.196"></a><span id="l77.196" class="difflineminus">-  if (endIndex == -1)</span>
<a href="#l77.197"></a><span id="l77.197" class="difflineplus">+  if (endIndex == -1) {</span>
<a href="#l77.198"></a><span id="l77.198">     return &quot;&quot;;</span>
<a href="#l77.199"></a><span id="l77.199" class="difflineplus">+  }</span>
<a href="#l77.200"></a><span id="l77.200"> </span>
<a href="#l77.201"></a><span id="l77.201">   return aStr.slice(startIndex, endIndex);</span>
<a href="#l77.202"></a><span id="l77.202"> }</span>
<a href="#l77.203"></a><span id="l77.203"> </span>
<a href="#l77.204"></a><span id="l77.204"> /*</span>
<a href="#l77.205"></a><span id="l77.205">  * A magic method (originally from MSN) to stop 3rd parties from connecting.</span>
<a href="#l77.206"></a><span id="l77.206">  * Differs from MSN by swapping MD5 for SHA256.</span>
<a href="#l77.207"></a><span id="l77.207">  *</span>
<a href="#l77.208"></a><span id="l77.208">  * A pre-emptive apology is necessary for those about to embark on the journey</span>
<a href="#l77.209"></a><span id="l77.209">  * of understanding this code. I wish you luck and God's speed.</span>
<a href="#l77.210"></a><span id="l77.210">  */</span>
<a href="#l77.211"></a><span id="l77.211"> function magicSha256(aInput) {</span>
<a href="#l77.212"></a><span id="l77.212">   let productId = kLockAndKeyAppId;</span>
<a href="#l77.213"></a><span id="l77.213"> </span>
<a href="#l77.214"></a><span id="l77.214">   // Create a SHA 256 hash.</span>
<a href="#l77.215"></a><span id="l77.215" class="difflineminus">-  let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l77.216"></a><span id="l77.216" class="difflineminus">-                    .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l77.217"></a><span id="l77.217" class="difflineplus">+  let converter = Cc[</span>
<a href="#l77.218"></a><span id="l77.218" class="difflineplus">+    &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l77.219"></a><span id="l77.219" class="difflineplus">+  ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l77.220"></a><span id="l77.220">   converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l77.221"></a><span id="l77.221">   let data = converter.convertToByteArray(aInput);</span>
<a href="#l77.222"></a><span id="l77.222">   let productKey = converter.convertToByteArray(kLockAndKeySecret);</span>
<a href="#l77.223"></a><span id="l77.223"> </span>
<a href="#l77.224"></a><span id="l77.224" class="difflineminus">-  let hash =</span>
<a href="#l77.225"></a><span id="l77.225" class="difflineminus">-    Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l77.226"></a><span id="l77.226" class="difflineplus">+  let hash = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l77.227"></a><span id="l77.227" class="difflineplus">+    Ci.nsICryptoHash</span>
<a href="#l77.228"></a><span id="l77.228" class="difflineplus">+  );</span>
<a href="#l77.229"></a><span id="l77.229">   hash.init(hash.SHA256);</span>
<a href="#l77.230"></a><span id="l77.230">   hash.update(data, data.length);</span>
<a href="#l77.231"></a><span id="l77.231">   hash.update(productKey, productKey.length);</span>
<a href="#l77.232"></a><span id="l77.232">   // Finalize the hash as a set of bytes.</span>
<a href="#l77.233"></a><span id="l77.233">   let sha256Hash = hash.finish(false);</span>
<a href="#l77.234"></a><span id="l77.234"> </span>
<a href="#l77.235"></a><span id="l77.235">   // Split it into four integers (note that this ignores the second half of the</span>
<a href="#l77.236"></a><span id="l77.236">   // hash).</span>
<a href="#l77.237"></a><span id="l77.237" class="difflineat">@@ -210,17 +227,17 @@ function magicSha256(aInput) {</span>
<a href="#l77.238"></a><span id="l77.238"> </span>
<a href="#l77.239"></a><span id="l77.239">   let sha256Parts = [];</span>
<a href="#l77.240"></a><span id="l77.240">   let newHashParts = [];</span>
<a href="#l77.241"></a><span id="l77.241">   for (let i = 0; i &lt; 4; ++i) {</span>
<a href="#l77.242"></a><span id="l77.242">     // Ensure little-endianness is used.</span>
<a href="#l77.243"></a><span id="l77.243">     sha256Parts.push(view.getUint32(i * 4, true));</span>
<a href="#l77.244"></a><span id="l77.244"> </span>
<a href="#l77.245"></a><span id="l77.245">     newHashParts.push(sha256Parts[i]);</span>
<a href="#l77.246"></a><span id="l77.246" class="difflineminus">-    sha256Parts[i] &amp;= 0x7FFFFFFF;</span>
<a href="#l77.247"></a><span id="l77.247" class="difflineplus">+    sha256Parts[i] &amp;= 0x7fffffff;</span>
<a href="#l77.248"></a><span id="l77.248">   }</span>
<a href="#l77.249"></a><span id="l77.249"> </span>
<a href="#l77.250"></a><span id="l77.250">   // Make a new string and pad with '0' to a length that's a multiple of 8.</span>
<a href="#l77.251"></a><span id="l77.251">   let buf = aInput + productId;</span>
<a href="#l77.252"></a><span id="l77.252">   let len = buf.length;</span>
<a href="#l77.253"></a><span id="l77.253">   let modLen = len % 8;</span>
<a href="#l77.254"></a><span id="l77.254">   if (modLen != 0) {</span>
<a href="#l77.255"></a><span id="l77.255">     let fix = 8 - modLen;</span>
<a href="#l77.256"></a><span id="l77.256" class="difflineat">@@ -229,47 +246,65 @@ function magicSha256(aInput) {</span>
<a href="#l77.257"></a><span id="l77.257">   }</span>
<a href="#l77.258"></a><span id="l77.258"> </span>
<a href="#l77.259"></a><span id="l77.259">   // Split into integers.</span>
<a href="#l77.260"></a><span id="l77.260">   view = new DataView(StringToArrayBuffer(buf));</span>
<a href="#l77.261"></a><span id="l77.261"> </span>
<a href="#l77.262"></a><span id="l77.262">   // This is magic.</span>
<a href="#l77.263"></a><span id="l77.263">   let nHigh = bigInt(0);</span>
<a href="#l77.264"></a><span id="l77.264">   let nLow = bigInt(0);</span>
<a href="#l77.265"></a><span id="l77.265" class="difflineminus">-  for (let i = 0; i &lt; (len / 4); i += 2) {</span>
<a href="#l77.266"></a><span id="l77.266" class="difflineminus">-    let temp = bigInt(0x0E79A9C1).times(view.getUint32(i * 4, true))</span>
<a href="#l77.267"></a><span id="l77.267" class="difflineminus">-                                 .divmod(0x7FFFFFFF).remainder;</span>
<a href="#l77.268"></a><span id="l77.268" class="difflineminus">-    temp = temp.plus(nLow).times(sha256Parts[0]).plus(sha256Parts[1])</span>
<a href="#l77.269"></a><span id="l77.269" class="difflineminus">-                                                .divmod(0x7FFFFFFF).remainder;</span>
<a href="#l77.270"></a><span id="l77.270" class="difflineplus">+  for (let i = 0; i &lt; len / 4; i += 2) {</span>
<a href="#l77.271"></a><span id="l77.271" class="difflineplus">+    let temp = bigInt(0x0e79a9c1)</span>
<a href="#l77.272"></a><span id="l77.272" class="difflineplus">+      .times(view.getUint32(i * 4, true))</span>
<a href="#l77.273"></a><span id="l77.273" class="difflineplus">+      .divmod(0x7fffffff).remainder;</span>
<a href="#l77.274"></a><span id="l77.274" class="difflineplus">+    temp = temp</span>
<a href="#l77.275"></a><span id="l77.275" class="difflineplus">+      .plus(nLow)</span>
<a href="#l77.276"></a><span id="l77.276" class="difflineplus">+      .times(sha256Parts[0])</span>
<a href="#l77.277"></a><span id="l77.277" class="difflineplus">+      .plus(sha256Parts[1])</span>
<a href="#l77.278"></a><span id="l77.278" class="difflineplus">+      .divmod(0x7fffffff).remainder;</span>
<a href="#l77.279"></a><span id="l77.279">     nHigh = nHigh.plus(temp);</span>
<a href="#l77.280"></a><span id="l77.280"> </span>
<a href="#l77.281"></a><span id="l77.281" class="difflineminus">-    temp = temp.plus(view.getUint32((i + 1) * 4, true)).divmod(0x7FFFFFFF).remainder;</span>
<a href="#l77.282"></a><span id="l77.282" class="difflineminus">-    nLow = temp.times(sha256Parts[2]).plus(sha256Parts[3]).divmod(0x7FFFFFFF).remainder;</span>
<a href="#l77.283"></a><span id="l77.283" class="difflineplus">+    temp = temp.plus(view.getUint32((i + 1) * 4, true)).divmod(0x7fffffff)</span>
<a href="#l77.284"></a><span id="l77.284" class="difflineplus">+      .remainder;</span>
<a href="#l77.285"></a><span id="l77.285" class="difflineplus">+    nLow = temp</span>
<a href="#l77.286"></a><span id="l77.286" class="difflineplus">+      .times(sha256Parts[2])</span>
<a href="#l77.287"></a><span id="l77.287" class="difflineplus">+      .plus(sha256Parts[3])</span>
<a href="#l77.288"></a><span id="l77.288" class="difflineplus">+      .divmod(0x7fffffff).remainder;</span>
<a href="#l77.289"></a><span id="l77.289">     nHigh = nHigh.plus(nLow);</span>
<a href="#l77.290"></a><span id="l77.290">   }</span>
<a href="#l77.291"></a><span id="l77.291" class="difflineminus">-  nLow = nLow.plus(sha256Parts[1]).divmod(0x7FFFFFFF).remainder.toJSNumber();</span>
<a href="#l77.292"></a><span id="l77.292" class="difflineminus">-  nHigh = nHigh.plus(sha256Parts[3]).divmod(0x7FFFFFFF).remainder.toJSNumber();</span>
<a href="#l77.293"></a><span id="l77.293" class="difflineplus">+  nLow = nLow</span>
<a href="#l77.294"></a><span id="l77.294" class="difflineplus">+    .plus(sha256Parts[1])</span>
<a href="#l77.295"></a><span id="l77.295" class="difflineplus">+    .divmod(0x7fffffff)</span>
<a href="#l77.296"></a><span id="l77.296" class="difflineplus">+    .remainder.toJSNumber();</span>
<a href="#l77.297"></a><span id="l77.297" class="difflineplus">+  nHigh = nHigh</span>
<a href="#l77.298"></a><span id="l77.298" class="difflineplus">+    .plus(sha256Parts[3])</span>
<a href="#l77.299"></a><span id="l77.299" class="difflineplus">+    .divmod(0x7fffffff)</span>
<a href="#l77.300"></a><span id="l77.300" class="difflineplus">+    .remainder.toJSNumber();</span>
<a href="#l77.301"></a><span id="l77.301"> </span>
<a href="#l77.302"></a><span id="l77.302">   newHashParts[0] ^= nLow;</span>
<a href="#l77.303"></a><span id="l77.303">   newHashParts[1] ^= nHigh;</span>
<a href="#l77.304"></a><span id="l77.304">   newHashParts[2] ^= nLow;</span>
<a href="#l77.305"></a><span id="l77.305">   newHashParts[3] ^= nHigh;</span>
<a href="#l77.306"></a><span id="l77.306"> </span>
<a href="#l77.307"></a><span id="l77.307">   // Make a string of the parts and convert to hexadecimal.</span>
<a href="#l77.308"></a><span id="l77.308">   let output = &quot;&quot;;</span>
<a href="#l77.309"></a><span id="l77.309">   for (let i = 0; i &lt; 4; ++i) {</span>
<a href="#l77.310"></a><span id="l77.310">     let part = newHashParts[i];</span>
<a href="#l77.311"></a><span id="l77.311">     // Adjust to little-endianness.</span>
<a href="#l77.312"></a><span id="l77.312" class="difflineminus">-    part = ((part &amp; 0xFF) &lt;&lt; 24) | ((part &amp; 0xFF00) &lt;&lt; 8) |</span>
<a href="#l77.313"></a><span id="l77.313" class="difflineminus">-           ((part &gt;&gt; 8) &amp; 0xFF00) | ((part &gt;&gt; 24) &amp; 0xFF);</span>
<a href="#l77.314"></a><span id="l77.314" class="difflineplus">+    part =</span>
<a href="#l77.315"></a><span id="l77.315" class="difflineplus">+      ((part &amp; 0xff) &lt;&lt; 24) |</span>
<a href="#l77.316"></a><span id="l77.316" class="difflineplus">+      ((part &amp; 0xff00) &lt;&lt; 8) |</span>
<a href="#l77.317"></a><span id="l77.317" class="difflineplus">+      ((part &gt;&gt; 8) &amp; 0xff00) |</span>
<a href="#l77.318"></a><span id="l77.318" class="difflineplus">+      ((part &gt;&gt; 24) &amp; 0xff);</span>
<a href="#l77.319"></a><span id="l77.319"> </span>
<a href="#l77.320"></a><span id="l77.320">     // JavaScript likes to use signed numbers, force this to give us the</span>
<a href="#l77.321"></a><span id="l77.321">     // unsigned representation.</span>
<a href="#l77.322"></a><span id="l77.322" class="difflineminus">-    if (part &lt; 0)</span>
<a href="#l77.323"></a><span id="l77.323" class="difflineminus">-      part += 0xFFFFFFFF + 1;</span>
<a href="#l77.324"></a><span id="l77.324" class="difflineplus">+    if (part &lt; 0) {</span>
<a href="#l77.325"></a><span id="l77.325" class="difflineplus">+      part += 0xffffffff + 1;</span>
<a href="#l77.326"></a><span id="l77.326" class="difflineplus">+    }</span>
<a href="#l77.327"></a><span id="l77.327"> </span>
<a href="#l77.328"></a><span id="l77.328">     let hexPart = part.toString(16);</span>
<a href="#l77.329"></a><span id="l77.329">     // Ensure that the string has 8 characters (4 bytes).</span>
<a href="#l77.330"></a><span id="l77.330">     output += &quot;0&quot;.repeat(8 - hexPart.length) + hexPart;</span>
<a href="#l77.331"></a><span id="l77.331">   }</span>
<a href="#l77.332"></a><span id="l77.332"> </span>
<a href="#l77.333"></a><span id="l77.333">   return output;</span>
<a href="#l77.334"></a><span id="l77.334"> }</span>
<a href="#l77.335"></a><span id="l77.335" class="difflineat">@@ -280,28 +315,33 @@ function getTimezone() {</span>
<a href="#l77.336"></a><span id="l77.336">   /*</span>
<a href="#l77.337"></a><span id="l77.337">    * Zero-pad aNum to the length of aLen.</span>
<a href="#l77.338"></a><span id="l77.338">    */</span>
<a href="#l77.339"></a><span id="l77.339">   function zeroPad(aNum, aLen) {</span>
<a href="#l77.340"></a><span id="l77.340">     let nStr = aNum.toString();</span>
<a href="#l77.341"></a><span id="l77.341">     let nLen = nStr.length;</span>
<a href="#l77.342"></a><span id="l77.342"> </span>
<a href="#l77.343"></a><span id="l77.343">     if (nLen &gt; aLen) {</span>
<a href="#l77.344"></a><span id="l77.344" class="difflineminus">-      throw new Error(&quot;Can't zero-pad when longer than expected length: &quot; + nStr +</span>
<a href="#l77.345"></a><span id="l77.345" class="difflineminus">-        &quot;.length &gt; &quot; + aLen);</span>
<a href="#l77.346"></a><span id="l77.346" class="difflineplus">+      throw new Error(</span>
<a href="#l77.347"></a><span id="l77.347" class="difflineplus">+        &quot;Can't zero-pad when longer than expected length: &quot; +</span>
<a href="#l77.348"></a><span id="l77.348" class="difflineplus">+          nStr +</span>
<a href="#l77.349"></a><span id="l77.349" class="difflineplus">+          &quot;.length &gt; &quot; +</span>
<a href="#l77.350"></a><span id="l77.350" class="difflineplus">+          aLen</span>
<a href="#l77.351"></a><span id="l77.351" class="difflineplus">+      );</span>
<a href="#l77.352"></a><span id="l77.352">     }</span>
<a href="#l77.353"></a><span id="l77.353"> </span>
<a href="#l77.354"></a><span id="l77.354">     return &quot;0&quot;.repeat(aLen - nLen) + nStr;</span>
<a href="#l77.355"></a><span id="l77.355">   }</span>
<a href="#l77.356"></a><span id="l77.356"> </span>
<a href="#l77.357"></a><span id="l77.357">   // Invert the sign of the timezone from JavaScript's date object.</span>
<a href="#l77.358"></a><span id="l77.358">   let sign = &quot;+&quot;;</span>
<a href="#l77.359"></a><span id="l77.359">   let timezone = new Date().getTimezoneOffset() * -1;</span>
<a href="#l77.360"></a><span id="l77.360" class="difflineminus">-  if (timezone &lt; 0)</span>
<a href="#l77.361"></a><span id="l77.361" class="difflineplus">+  if (timezone &lt; 0) {</span>
<a href="#l77.362"></a><span id="l77.362">     sign = &quot;-&quot;;</span>
<a href="#l77.363"></a><span id="l77.363" class="difflineplus">+  }</span>
<a href="#l77.364"></a><span id="l77.364">   timezone = Math.abs(timezone);</span>
<a href="#l77.365"></a><span id="l77.365"> </span>
<a href="#l77.366"></a><span id="l77.366">   // Separate the timezone into hours and minutes.</span>
<a href="#l77.367"></a><span id="l77.367">   let minutes = timezone % 60;</span>
<a href="#l77.368"></a><span id="l77.368">   let hours = (timezone - minutes) / 60;</span>
<a href="#l77.369"></a><span id="l77.369"> </span>
<a href="#l77.370"></a><span id="l77.370">   // Ensure both hours and minutes are two digits long.</span>
<a href="#l77.371"></a><span id="l77.371">   minutes = zeroPad(minutes, 2);</span>
<a href="#l77.372"></a><span id="l77.372" class="difflineat">@@ -314,17 +354,17 @@ function getTimezone() {</span>
<a href="#l77.373"></a><span id="l77.373"> function SkypeAccount(aProtoInstance, aImAccount) {</span>
<a href="#l77.374"></a><span id="l77.374">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l77.375"></a><span id="l77.375"> </span>
<a href="#l77.376"></a><span id="l77.376">   // Initialize some maps.</span>
<a href="#l77.377"></a><span id="l77.377">   this._buddies = new Map();</span>
<a href="#l77.378"></a><span id="l77.378">   this._conversations = new Map();</span>
<a href="#l77.379"></a><span id="l77.379">   this._chats = new Map();</span>
<a href="#l77.380"></a><span id="l77.380"> </span>
<a href="#l77.381"></a><span id="l77.381" class="difflineminus">-  this._logger = {log: this.LOG.bind(this), debug: this.DEBUG.bind(this)};</span>
<a href="#l77.382"></a><span id="l77.382" class="difflineplus">+  this._logger = { log: this.LOG.bind(this), debug: this.DEBUG.bind(this) };</span>
<a href="#l77.383"></a><span id="l77.383"> }</span>
<a href="#l77.384"></a><span id="l77.384"> SkypeAccount.prototype = {</span>
<a href="#l77.385"></a><span id="l77.385">   __proto__: GenericAccountPrototype,</span>
<a href="#l77.386"></a><span id="l77.386">   // A Map holding the list of buddies associated with their usernames.</span>
<a href="#l77.387"></a><span id="l77.387">   _buddies: null,</span>
<a href="#l77.388"></a><span id="l77.388">   // A Map holding the list of open conversations by the username of the buddy.</span>
<a href="#l77.389"></a><span id="l77.389">   _conversations: null,</span>
<a href="#l77.390"></a><span id="l77.390">   // A Map holding the list of open (multiple user) chats by name.</span>
<a href="#l77.391"></a><span id="l77.391" class="difflineat">@@ -337,18 +377,19 @@ SkypeAccount.prototype = {</span>
<a href="#l77.392"></a><span id="l77.392">   // Some tokens.</span>
<a href="#l77.393"></a><span id="l77.393">   _skypeToken: null,</span>
<a href="#l77.394"></a><span id="l77.394">   _registrationToken: null,</span>
<a href="#l77.395"></a><span id="l77.395"> </span>
<a href="#l77.396"></a><span id="l77.396">   // Logger used for HTTP requests.</span>
<a href="#l77.397"></a><span id="l77.397">   _logger: null,</span>
<a href="#l77.398"></a><span id="l77.398"> </span>
<a href="#l77.399"></a><span id="l77.399">   mapStatusString(aStatus) {</span>
<a href="#l77.400"></a><span id="l77.400" class="difflineminus">-    if (aStatus in kStatusMap)</span>
<a href="#l77.401"></a><span id="l77.401" class="difflineplus">+    if (aStatus in kStatusMap) {</span>
<a href="#l77.402"></a><span id="l77.402">       return Ci.imIStatusInfo[&quot;STATUS_&quot; + kStatusMap[aStatus]];</span>
<a href="#l77.403"></a><span id="l77.403" class="difflineplus">+    }</span>
<a href="#l77.404"></a><span id="l77.404"> </span>
<a href="#l77.405"></a><span id="l77.405">     // Uh-oh, we got something not in the map.</span>
<a href="#l77.406"></a><span id="l77.406">     this.WARN(&quot;Received unknown status type: &quot; + aStatus);</span>
<a href="#l77.407"></a><span id="l77.407">     return Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l77.408"></a><span id="l77.408">   },</span>
<a href="#l77.409"></a><span id="l77.409"> </span>
<a href="#l77.410"></a><span id="l77.410">   connect() {</span>
<a href="#l77.411"></a><span id="l77.411">     this.reportConnecting();</span>
<a href="#l77.412"></a><span id="l77.412" class="difflineat">@@ -382,64 +423,69 @@ SkypeAccount.prototype = {</span>
<a href="#l77.413"></a><span id="l77.413"> </span>
<a href="#l77.414"></a><span id="l77.414">   // Mmmmm...pie.</span>
<a href="#l77.415"></a><span id="l77.415">   _onPieResponse(aResponse, aXhr) {</span>
<a href="#l77.416"></a><span id="l77.416">     this.reportConnecting(_(&quot;connecting.authenticating&quot;));</span>
<a href="#l77.417"></a><span id="l77.417"> </span>
<a href="#l77.418"></a><span id="l77.418">     // Parse the pie/etm and do the actual login.</span>
<a href="#l77.419"></a><span id="l77.419">     let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l77.420"></a><span id="l77.420"> </span>
<a href="#l77.421"></a><span id="l77.421" class="difflineminus">-    let params = [[&quot;client_id&quot;, kClientId],</span>
<a href="#l77.422"></a><span id="l77.422" class="difflineminus">-                  [&quot;redirect_uri&quot;, &quot;https://web.skype.com&quot;]];</span>
<a href="#l77.423"></a><span id="l77.423" class="difflineminus">-    loginUrl += &quot;?&quot; +</span>
<a href="#l77.424"></a><span id="l77.424" class="difflineminus">-      params.map(p =&gt; p.map(encodeURIComponent).join(&quot;=&quot;)).join(&quot;&amp;&quot;);</span>
<a href="#l77.425"></a><span id="l77.425" class="difflineplus">+    let params = [</span>
<a href="#l77.426"></a><span id="l77.426" class="difflineplus">+      [&quot;client_id&quot;, kClientId],</span>
<a href="#l77.427"></a><span id="l77.427" class="difflineplus">+      [&quot;redirect_uri&quot;, &quot;https://web.skype.com&quot;],</span>
<a href="#l77.428"></a><span id="l77.428" class="difflineplus">+    ];</span>
<a href="#l77.429"></a><span id="l77.429" class="difflineplus">+    loginUrl +=</span>
<a href="#l77.430"></a><span id="l77.430" class="difflineplus">+      &quot;?&quot; + params.map(p =&gt; p.map(encodeURIComponent).join(&quot;=&quot;)).join(&quot;&amp;&quot;);</span>
<a href="#l77.431"></a><span id="l77.431"> </span>
<a href="#l77.432"></a><span id="l77.432">     this.LOG(&quot;Received PIE response:\n&quot; + aResponse);</span>
<a href="#l77.433"></a><span id="l77.433"> </span>
<a href="#l77.434"></a><span id="l77.434">     // Note that the response is really just an HTML page with some JavaScript</span>
<a href="#l77.435"></a><span id="l77.435">     // and forms that these values are being pulled from.</span>
<a href="#l77.436"></a><span id="l77.436" class="difflineminus">-    let pie = extractString(aResponse, &quot;=\&quot;pie\&quot; value=\&quot;&quot;, &quot;\&quot;&quot;);</span>
<a href="#l77.437"></a><span id="l77.437" class="difflineplus">+    let pie = extractString(aResponse, '=&quot;pie&quot; value=&quot;', '&quot;');</span>
<a href="#l77.438"></a><span id="l77.438">     if (!pie) {</span>
<a href="#l77.439"></a><span id="l77.439">       this.ERROR(&quot;pie value not found.&quot;);</span>
<a href="#l77.440"></a><span id="l77.440">       this._disconnectWithAuthFailure();</span>
<a href="#l77.441"></a><span id="l77.441">       return;</span>
<a href="#l77.442"></a><span id="l77.442">     }</span>
<a href="#l77.443"></a><span id="l77.443" class="difflineminus">-    let etm = extractString(aResponse, &quot;=\&quot;etm\&quot; value=\&quot;&quot;, &quot;\&quot;&quot;);</span>
<a href="#l77.444"></a><span id="l77.444" class="difflineplus">+    let etm = extractString(aResponse, '=&quot;etm&quot; value=&quot;', '&quot;');</span>
<a href="#l77.445"></a><span id="l77.445">     if (!etm) {</span>
<a href="#l77.446"></a><span id="l77.446">       this.ERROR(&quot;etm value not found.&quot;);</span>
<a href="#l77.447"></a><span id="l77.447">       this._disconnectWithAuthFailure();</span>
<a href="#l77.448"></a><span id="l77.448">       return;</span>
<a href="#l77.449"></a><span id="l77.449">     }</span>
<a href="#l77.450"></a><span id="l77.450"> </span>
<a href="#l77.451"></a><span id="l77.451">     let options = {</span>
<a href="#l77.452"></a><span id="l77.452">       onLoad: this._onLoginResponse.bind(this),</span>
<a href="#l77.453"></a><span id="l77.453">       onError: this._onHttpFailure(&quot;requesting skypetoken&quot;),</span>
<a href="#l77.454"></a><span id="l77.454" class="difflineminus">-      postData: [[&quot;username&quot;, this.name],</span>
<a href="#l77.455"></a><span id="l77.455" class="difflineminus">-                 [&quot;password&quot;, this.imAccount.password],</span>
<a href="#l77.456"></a><span id="l77.456" class="difflineminus">-                 [&quot;timezone_field&quot;, getTimezone()],</span>
<a href="#l77.457"></a><span id="l77.457" class="difflineminus">-                 [&quot;pie&quot;, pie],</span>
<a href="#l77.458"></a><span id="l77.458" class="difflineminus">-                 [&quot;etm&quot;, etm],</span>
<a href="#l77.459"></a><span id="l77.459" class="difflineminus">-                 [&quot;js_time&quot;, Date.now()],</span>
<a href="#l77.460"></a><span id="l77.460" class="difflineminus">-                 [&quot;client_id&quot;, kClientId],</span>
<a href="#l77.461"></a><span id="l77.461" class="difflineminus">-                 [&quot;redirect_uri&quot;, &quot;https://web.skype.com/&quot;]],</span>
<a href="#l77.462"></a><span id="l77.462" class="difflineminus">-      headers: [[&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l77.463"></a><span id="l77.463" class="difflineminus">-                // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l77.464"></a><span id="l77.464" class="difflineminus">-                // response from doing a 302 Found Location redirect, since</span>
<a href="#l77.465"></a><span id="l77.465" class="difflineminus">-                // there are important headers that need to be plucked before</span>
<a href="#l77.466"></a><span id="l77.466" class="difflineminus">-                // the redirect happens.</span>
<a href="#l77.467"></a><span id="l77.467" class="difflineminus">-                [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;]],</span>
<a href="#l77.468"></a><span id="l77.468" class="difflineplus">+      postData: [</span>
<a href="#l77.469"></a><span id="l77.469" class="difflineplus">+        [&quot;username&quot;, this.name],</span>
<a href="#l77.470"></a><span id="l77.470" class="difflineplus">+        [&quot;password&quot;, this.imAccount.password],</span>
<a href="#l77.471"></a><span id="l77.471" class="difflineplus">+        [&quot;timezone_field&quot;, getTimezone()],</span>
<a href="#l77.472"></a><span id="l77.472" class="difflineplus">+        [&quot;pie&quot;, pie],</span>
<a href="#l77.473"></a><span id="l77.473" class="difflineplus">+        [&quot;etm&quot;, etm],</span>
<a href="#l77.474"></a><span id="l77.474" class="difflineplus">+        [&quot;js_time&quot;, Date.now()],</span>
<a href="#l77.475"></a><span id="l77.475" class="difflineplus">+        [&quot;client_id&quot;, kClientId],</span>
<a href="#l77.476"></a><span id="l77.476" class="difflineplus">+        [&quot;redirect_uri&quot;, &quot;https://web.skype.com/&quot;],</span>
<a href="#l77.477"></a><span id="l77.477" class="difflineplus">+      ],</span>
<a href="#l77.478"></a><span id="l77.478" class="difflineplus">+      headers: [</span>
<a href="#l77.479"></a><span id="l77.479" class="difflineplus">+        [&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l77.480"></a><span id="l77.480" class="difflineplus">+        // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l77.481"></a><span id="l77.481" class="difflineplus">+        // response from doing a 302 Found Location redirect, since</span>
<a href="#l77.482"></a><span id="l77.482" class="difflineplus">+        // there are important headers that need to be plucked before</span>
<a href="#l77.483"></a><span id="l77.483" class="difflineplus">+        // the redirect happens.</span>
<a href="#l77.484"></a><span id="l77.484" class="difflineplus">+        [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l77.485"></a><span id="l77.485" class="difflineplus">+      ],</span>
<a href="#l77.486"></a><span id="l77.486">       logger: this._logger,</span>
<a href="#l77.487"></a><span id="l77.487">     };</span>
<a href="#l77.488"></a><span id="l77.488">     httpRequest(loginUrl, options);</span>
<a href="#l77.489"></a><span id="l77.489">   },</span>
<a href="#l77.490"></a><span id="l77.490">   _onLoginResponse(aResponse, aXhr) {</span>
<a href="#l77.491"></a><span id="l77.491">     this.LOG(&quot;Received LOGIN response:\n&quot; + aResponse);</span>
<a href="#l77.492"></a><span id="l77.492"> </span>
<a href="#l77.493"></a><span id="l77.493" class="difflineminus">-    let refreshToken =</span>
<a href="#l77.494"></a><span id="l77.494" class="difflineminus">-      extractString(aResponse, &quot;=\&quot;skypetoken\&quot; value=\&quot;&quot;, &quot;\&quot;&quot;);</span>
<a href="#l77.495"></a><span id="l77.495" class="difflineplus">+    let refreshToken = extractString(aResponse, '=&quot;skypetoken&quot; value=&quot;', '&quot;');</span>
<a href="#l77.496"></a><span id="l77.496">     if (!refreshToken) {</span>
<a href="#l77.497"></a><span id="l77.497">       this.ERROR(&quot;skypetoken value not found.&quot;);</span>
<a href="#l77.498"></a><span id="l77.498">       this._disconnectWithAuthFailure();</span>
<a href="#l77.499"></a><span id="l77.499">       return;</span>
<a href="#l77.500"></a><span id="l77.500">     }</span>
<a href="#l77.501"></a><span id="l77.501"> </span>
<a href="#l77.502"></a><span id="l77.502">     // All done!</span>
<a href="#l77.503"></a><span id="l77.503">     this._skypeToken = refreshToken;</span>
<a href="#l77.504"></a><span id="l77.504" class="difflineat">@@ -456,32 +502,41 @@ SkypeAccount.prototype = {</span>
<a href="#l77.505"></a><span id="l77.505">     // Request the registration token.</span>
<a href="#l77.506"></a><span id="l77.506">     let messagesUrl = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/endpoints&quot;;</span>
<a href="#l77.507"></a><span id="l77.507">     // The current time in seconds, converted to a string.</span>
<a href="#l77.508"></a><span id="l77.508">     let curTime = String(Math.floor(Date.now() / 1000));</span>
<a href="#l77.509"></a><span id="l77.509">     let response = magicSha256(curTime);</span>
<a href="#l77.510"></a><span id="l77.510">     let options = {</span>
<a href="#l77.511"></a><span id="l77.511">       onLoad: this._onRegistrationTokenReceived.bind(this),</span>
<a href="#l77.512"></a><span id="l77.512">       onError: (aError, aResponse, aXhr) =&gt; {</span>
<a href="#l77.513"></a><span id="l77.513" class="difflineminus">-        this.ERROR(&quot;HTTP failure occurred: requesting registration token\n&quot; +</span>
<a href="#l77.514"></a><span id="l77.514" class="difflineminus">-                   aError);</span>
<a href="#l77.515"></a><span id="l77.515" class="difflineplus">+        this.ERROR(</span>
<a href="#l77.516"></a><span id="l77.516" class="difflineplus">+          &quot;HTTP failure occurred: requesting registration token\n&quot; + aError</span>
<a href="#l77.517"></a><span id="l77.517" class="difflineplus">+        );</span>
<a href="#l77.518"></a><span id="l77.518">         this._disconnectWithAuthFailure(&quot;error.registrationToken&quot;);</span>
<a href="#l77.519"></a><span id="l77.519">       },</span>
<a href="#l77.520"></a><span id="l77.520">       postData: &quot;{}&quot;, // Empty JSON object.</span>
<a href="#l77.521"></a><span id="l77.521" class="difflineminus">-      headers: [[&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l77.522"></a><span id="l77.522" class="difflineminus">-                // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l77.523"></a><span id="l77.523" class="difflineminus">-                // response from doing a 302 Found Location redirect, since</span>
<a href="#l77.524"></a><span id="l77.524" class="difflineminus">-                // there are important headers that need to be plucked before</span>
<a href="#l77.525"></a><span id="l77.525" class="difflineminus">-                // the redirect happens.</span>
<a href="#l77.526"></a><span id="l77.526" class="difflineminus">-                [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l77.527"></a><span id="l77.527" class="difflineminus">-                [&quot;LockAndKey&quot;, &quot;appId=&quot; + kLockAndKeyAppId +</span>
<a href="#l77.528"></a><span id="l77.528" class="difflineminus">-                               &quot;; time=&quot; + curTime +</span>
<a href="#l77.529"></a><span id="l77.529" class="difflineminus">-                               &quot;; lockAndKeyResponse=&quot; + response],</span>
<a href="#l77.530"></a><span id="l77.530" class="difflineminus">-                [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l77.531"></a><span id="l77.531" class="difflineminus">-                [&quot;Authentication&quot;, &quot;skypetoken=&quot; + this._skypeToken]],</span>
<a href="#l77.532"></a><span id="l77.532" class="difflineplus">+      headers: [</span>
<a href="#l77.533"></a><span id="l77.533" class="difflineplus">+        [&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l77.534"></a><span id="l77.534" class="difflineplus">+        // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l77.535"></a><span id="l77.535" class="difflineplus">+        // response from doing a 302 Found Location redirect, since</span>
<a href="#l77.536"></a><span id="l77.536" class="difflineplus">+        // there are important headers that need to be plucked before</span>
<a href="#l77.537"></a><span id="l77.537" class="difflineplus">+        // the redirect happens.</span>
<a href="#l77.538"></a><span id="l77.538" class="difflineplus">+        [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l77.539"></a><span id="l77.539" class="difflineplus">+        [</span>
<a href="#l77.540"></a><span id="l77.540" class="difflineplus">+          &quot;LockAndKey&quot;,</span>
<a href="#l77.541"></a><span id="l77.541" class="difflineplus">+          &quot;appId=&quot; +</span>
<a href="#l77.542"></a><span id="l77.542" class="difflineplus">+            kLockAndKeyAppId +</span>
<a href="#l77.543"></a><span id="l77.543" class="difflineplus">+            &quot;; time=&quot; +</span>
<a href="#l77.544"></a><span id="l77.544" class="difflineplus">+            curTime +</span>
<a href="#l77.545"></a><span id="l77.545" class="difflineplus">+            &quot;; lockAndKeyResponse=&quot; +</span>
<a href="#l77.546"></a><span id="l77.546" class="difflineplus">+            response,</span>
<a href="#l77.547"></a><span id="l77.547" class="difflineplus">+        ],</span>
<a href="#l77.548"></a><span id="l77.548" class="difflineplus">+        [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l77.549"></a><span id="l77.549" class="difflineplus">+        [&quot;Authentication&quot;, &quot;skypetoken=&quot; + this._skypeToken],</span>
<a href="#l77.550"></a><span id="l77.550" class="difflineplus">+      ],</span>
<a href="#l77.551"></a><span id="l77.551">       logger: this._logger,</span>
<a href="#l77.552"></a><span id="l77.552">     };</span>
<a href="#l77.553"></a><span id="l77.553">     httpRequest(messagesUrl, options);</span>
<a href="#l77.554"></a><span id="l77.554">   },</span>
<a href="#l77.555"></a><span id="l77.555">   _onRegistrationTokenReceived(aResponse, aXhr) {</span>
<a href="#l77.556"></a><span id="l77.556">     this.LOG(&quot;Registration token received: &quot; + aResponse);</span>
<a href="#l77.557"></a><span id="l77.557"> </span>
<a href="#l77.558"></a><span id="l77.558">     let registrationToken = aXhr.getResponseHeader(&quot;Set-RegistrationToken&quot;);</span>
<a href="#l77.559"></a><span id="l77.559" class="difflineat">@@ -500,22 +555,24 @@ SkypeAccount.prototype = {</span>
<a href="#l77.560"></a><span id="l77.560">   _subscribe() {</span>
<a href="#l77.561"></a><span id="l77.561">     this.LOG(&quot;Sending subscription.&quot;);</span>
<a href="#l77.562"></a><span id="l77.562"> </span>
<a href="#l77.563"></a><span id="l77.563">     // Subscribe to particular events.</span>
<a href="#l77.564"></a><span id="l77.564">     let messagesUrl =</span>
<a href="#l77.565"></a><span id="l77.565">       &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/endpoints/SELF/subscriptions&quot;;</span>
<a href="#l77.566"></a><span id="l77.566">     // The endpoints to subscribe to.</span>
<a href="#l77.567"></a><span id="l77.567">     let subscriptions = {</span>
<a href="#l77.568"></a><span id="l77.568" class="difflineminus">-      &quot;interestedResources&quot;: [&quot;/v1/users/ME/conversations/ALL/properties&quot;,</span>
<a href="#l77.569"></a><span id="l77.569" class="difflineminus">-                              &quot;/v1/users/ME/conversations/ALL/messages&quot;,</span>
<a href="#l77.570"></a><span id="l77.570" class="difflineminus">-                              &quot;/v1/users/ME/contacts/ALL&quot;,</span>
<a href="#l77.571"></a><span id="l77.571" class="difflineminus">-                              &quot;/v1/threads/ALL&quot;],</span>
<a href="#l77.572"></a><span id="l77.572" class="difflineminus">-      &quot;template&quot;: &quot;raw&quot;,</span>
<a href="#l77.573"></a><span id="l77.573" class="difflineminus">-      &quot;channelType&quot;: &quot;httpLongPoll&quot;,</span>
<a href="#l77.574"></a><span id="l77.574" class="difflineplus">+      interestedResources: [</span>
<a href="#l77.575"></a><span id="l77.575" class="difflineplus">+        &quot;/v1/users/ME/conversations/ALL/properties&quot;,</span>
<a href="#l77.576"></a><span id="l77.576" class="difflineplus">+        &quot;/v1/users/ME/conversations/ALL/messages&quot;,</span>
<a href="#l77.577"></a><span id="l77.577" class="difflineplus">+        &quot;/v1/users/ME/contacts/ALL&quot;,</span>
<a href="#l77.578"></a><span id="l77.578" class="difflineplus">+        &quot;/v1/threads/ALL&quot;,</span>
<a href="#l77.579"></a><span id="l77.579" class="difflineplus">+      ],</span>
<a href="#l77.580"></a><span id="l77.580" class="difflineplus">+      template: &quot;raw&quot;,</span>
<a href="#l77.581"></a><span id="l77.581" class="difflineplus">+      channelType: &quot;httpLongPoll&quot;,</span>
<a href="#l77.582"></a><span id="l77.582">     };</span>
<a href="#l77.583"></a><span id="l77.583">     let options = {</span>
<a href="#l77.584"></a><span id="l77.584">       onLoad: this._onSubscription.bind(this),</span>
<a href="#l77.585"></a><span id="l77.585">       onError: this._onHttpFailure(&quot;subscribing to notifications&quot;),</span>
<a href="#l77.586"></a><span id="l77.586">       postData: JSON.stringify(subscriptions),</span>
<a href="#l77.587"></a><span id="l77.587">       logger: this._logger,</span>
<a href="#l77.588"></a><span id="l77.588">     };</span>
<a href="#l77.589"></a><span id="l77.589">     this._messagesRequest(messagesUrl, options);</span>
<a href="#l77.590"></a><span id="l77.590" class="difflineat">@@ -545,66 +602,72 @@ SkypeAccount.prototype = {</span>
<a href="#l77.591"></a><span id="l77.591"> </span>
<a href="#l77.592"></a><span id="l77.592">     let buddies = JSON.parse(aResponse);</span>
<a href="#l77.593"></a><span id="l77.593">     if (!buddies) {</span>
<a href="#l77.594"></a><span id="l77.594">       this.ERROR(&quot;Unable to parse JSON response: &quot; + aResponse);</span>
<a href="#l77.595"></a><span id="l77.595">       return;</span>
<a href="#l77.596"></a><span id="l77.596">     }</span>
<a href="#l77.597"></a><span id="l77.597"> </span>
<a href="#l77.598"></a><span id="l77.598">     // You have no friends. :( Nothing to do, just move along.</span>
<a href="#l77.599"></a><span id="l77.599" class="difflineminus">-    if (!buddies.length)</span>
<a href="#l77.600"></a><span id="l77.600" class="difflineplus">+    if (!buddies.length) {</span>
<a href="#l77.601"></a><span id="l77.601">       return;</span>
<a href="#l77.602"></a><span id="l77.602" class="difflineplus">+    }</span>
<a href="#l77.603"></a><span id="l77.603"> </span>
<a href="#l77.604"></a><span id="l77.604">     // This gets a little confusing, buddyObj refers to the JSON that was parsed</span>
<a href="#l77.605"></a><span id="l77.605">     // and returned from the server, buddy refers to the prplIAccountBuddy.</span>
<a href="#l77.606"></a><span id="l77.606">     for (let buddyObj of buddies) {</span>
<a href="#l77.607"></a><span id="l77.607">       let buddy = this._buddies.get(buddyObj.skypename);</span>
<a href="#l77.608"></a><span id="l77.608">       if (!buddy) {</span>
<a href="#l77.609"></a><span id="l77.609">         buddy = new SkypeAccountBuddy(</span>
<a href="#l77.610"></a><span id="l77.610" class="difflineminus">-          this, null, Services.tags.defaultTag, buddyObj.skypename);</span>
<a href="#l77.611"></a><span id="l77.611" class="difflineplus">+          this,</span>
<a href="#l77.612"></a><span id="l77.612" class="difflineplus">+          null,</span>
<a href="#l77.613"></a><span id="l77.613" class="difflineplus">+          Services.tags.defaultTag,</span>
<a href="#l77.614"></a><span id="l77.614" class="difflineplus">+          buddyObj.skypename</span>
<a href="#l77.615"></a><span id="l77.615" class="difflineplus">+        );</span>
<a href="#l77.616"></a><span id="l77.616"> </span>
<a href="#l77.617"></a><span id="l77.617">         // Store the buddy for later.</span>
<a href="#l77.618"></a><span id="l77.618">         this._buddies.set(buddyObj.skypename, buddy);</span>
<a href="#l77.619"></a><span id="l77.619"> </span>
<a href="#l77.620"></a><span id="l77.620">         // Notify the UI of the buddy.</span>
<a href="#l77.621"></a><span id="l77.621">         Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l77.622"></a><span id="l77.622">       }</span>
<a href="#l77.623"></a><span id="l77.623"> </span>
<a href="#l77.624"></a><span id="l77.624">       // TODO There is also fullname / skypename.</span>
<a href="#l77.625"></a><span id="l77.625">       // Note that display_name is the public alias that the buddy has set for</span>
<a href="#l77.626"></a><span id="l77.626">       // themselves, skypename is the buddy's unique ID name, fullname is their</span>
<a href="#l77.627"></a><span id="l77.627">       // real name.</span>
<a href="#l77.628"></a><span id="l77.628" class="difflineminus">-      if (buddyObj.display_name)</span>
<a href="#l77.629"></a><span id="l77.629" class="difflineplus">+      if (buddyObj.display_name) {</span>
<a href="#l77.630"></a><span id="l77.630">         buddy.serverAlias = buddyObj.display_name;</span>
<a href="#l77.631"></a><span id="l77.631" class="difflineplus">+      }</span>
<a href="#l77.632"></a><span id="l77.632">       // Store the buddy info into the object for tooltips.</span>
<a href="#l77.633"></a><span id="l77.633">       buddy._info = buddyObj;</span>
<a href="#l77.634"></a><span id="l77.634"> </span>
<a href="#l77.635"></a><span id="l77.635">       // Set the buddy's status to offline until we get an update.</span>
<a href="#l77.636"></a><span id="l77.636">       buddy.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l77.637"></a><span id="l77.637">     }</span>
<a href="#l77.638"></a><span id="l77.638"> </span>
<a href="#l77.639"></a><span id="l77.639">     // Download profiles.</span>
<a href="#l77.640"></a><span id="l77.640">     let profilesUrl =</span>
<a href="#l77.641"></a><span id="l77.641">       &quot;https://&quot; + kContactsHost + &quot;/users/self/contacts/profiles&quot;;</span>
<a href="#l77.642"></a><span id="l77.642">     let options = {</span>
<a href="#l77.643"></a><span id="l77.643" class="difflineminus">-      postData: buddies.map((b) =&gt; [&quot;contacts[]&quot;, b.skypename]),</span>
<a href="#l77.644"></a><span id="l77.644" class="difflineplus">+      postData: buddies.map(b =&gt; [&quot;contacts[]&quot;, b.skypename]),</span>
<a href="#l77.645"></a><span id="l77.645">       onLoad: this._onProfiles.bind(this),</span>
<a href="#l77.646"></a><span id="l77.646">       onError: this._onHttpError.bind(this),</span>
<a href="#l77.647"></a><span id="l77.647">       logger: this._logger,</span>
<a href="#l77.648"></a><span id="l77.648">     };</span>
<a href="#l77.649"></a><span id="l77.649">     this.LOG(JSON.stringify(options));</span>
<a href="#l77.650"></a><span id="l77.650">     this._contactsRequest(profilesUrl, options);</span>
<a href="#l77.651"></a><span id="l77.651"> </span>
<a href="#l77.652"></a><span id="l77.652">     // Subscribe to user statuses.</span>
<a href="#l77.653"></a><span id="l77.653">     let contactsUrl = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/contacts&quot;;</span>
<a href="#l77.654"></a><span id="l77.654" class="difflineminus">-    let contacts = buddies.map((b) =&gt; {</span>
<a href="#l77.655"></a><span id="l77.655" class="difflineminus">-      return {&quot;id&quot;: &quot;8:&quot; + b.skypename};</span>
<a href="#l77.656"></a><span id="l77.656" class="difflineplus">+    let contacts = buddies.map(b =&gt; {</span>
<a href="#l77.657"></a><span id="l77.657" class="difflineplus">+      return { id: &quot;8:&quot; + b.skypename };</span>
<a href="#l77.658"></a><span id="l77.658">     });</span>
<a href="#l77.659"></a><span id="l77.659">     options = {</span>
<a href="#l77.660"></a><span id="l77.660" class="difflineminus">-      postData: JSON.stringify({&quot;contacts&quot;: contacts}),</span>
<a href="#l77.661"></a><span id="l77.661" class="difflineplus">+      postData: JSON.stringify({ contacts }),</span>
<a href="#l77.662"></a><span id="l77.662">       onLoad: (aResponse, aXhr) =&gt;</span>
<a href="#l77.663"></a><span id="l77.663">         this.LOG(&quot;Successfully subscribed to contacts.&quot;),</span>
<a href="#l77.664"></a><span id="l77.664">       onError: this._onHttpError.bind(this),</span>
<a href="#l77.665"></a><span id="l77.665">       logger: this._logger,</span>
<a href="#l77.666"></a><span id="l77.666">     };</span>
<a href="#l77.667"></a><span id="l77.667">     this.LOG(JSON.stringify(options));</span>
<a href="#l77.668"></a><span id="l77.668">     this._messagesRequest(contactsUrl, options);</span>
<a href="#l77.669"></a><span id="l77.669">   },</span>
<a href="#l77.670"></a><span id="l77.670" class="difflineat">@@ -615,39 +678,46 @@ SkypeAccount.prototype = {</span>
<a href="#l77.671"></a><span id="l77.671">     let skypeContacts = JSON.parse(aResponse);</span>
<a href="#l77.672"></a><span id="l77.672"> </span>
<a href="#l77.673"></a><span id="l77.673">     // TODO Error checking.</span>
<a href="#l77.674"></a><span id="l77.674"> </span>
<a href="#l77.675"></a><span id="l77.675">     for (let skypeContact of skypeContacts) {</span>
<a href="#l77.676"></a><span id="l77.676">       let username = skypeContact.username;</span>
<a href="#l77.677"></a><span id="l77.677"> </span>
<a href="#l77.678"></a><span id="l77.678">       let buddy = this._buddies.get(username);</span>
<a href="#l77.679"></a><span id="l77.679" class="difflineminus">-      if (!buddy)</span>
<a href="#l77.680"></a><span id="l77.680" class="difflineplus">+      if (!buddy) {</span>
<a href="#l77.681"></a><span id="l77.681">         continue;</span>
<a href="#l77.682"></a><span id="l77.682" class="difflineplus">+      }</span>
<a href="#l77.683"></a><span id="l77.683"> </span>
<a href="#l77.684"></a><span id="l77.684">       // Set some properties on the buddy.</span>
<a href="#l77.685"></a><span id="l77.685">       buddy.serverAlias = skypeContact.displayname;</span>
<a href="#l77.686"></a><span id="l77.686">       // TODO There's also firstname and lastname fields.</span>
<a href="#l77.687"></a><span id="l77.687">       buddy.mood = skypeContact.mood;</span>
<a href="#l77.688"></a><span id="l77.688"> </span>
<a href="#l77.689"></a><span id="l77.689">       // TODO Download the file and store it in the profile.</span>
<a href="#l77.690"></a><span id="l77.690">       let avatarUrl = skypeContact.avatarUrl;</span>
<a href="#l77.691"></a><span id="l77.691">       if (!avatarUrl) {</span>
<a href="#l77.692"></a><span id="l77.692" class="difflineminus">-        avatarUrl = &quot;https://&quot; + kContactsHost + &quot;/users/&quot; + buddy.userName +</span>
<a href="#l77.693"></a><span id="l77.693" class="difflineplus">+        avatarUrl =</span>
<a href="#l77.694"></a><span id="l77.694" class="difflineplus">+          &quot;https://&quot; +</span>
<a href="#l77.695"></a><span id="l77.695" class="difflineplus">+          kContactsHost +</span>
<a href="#l77.696"></a><span id="l77.696" class="difflineplus">+          &quot;/users/&quot; +</span>
<a href="#l77.697"></a><span id="l77.697" class="difflineplus">+          buddy.userName +</span>
<a href="#l77.698"></a><span id="l77.698">           &quot;/profile/avatar&quot;;</span>
<a href="#l77.699"></a><span id="l77.699">       }</span>
<a href="#l77.700"></a><span id="l77.700">       buddy.buddyIconFilename = skypeContact.avatarUrl;</span>
<a href="#l77.701"></a><span id="l77.701">     }</span>
<a href="#l77.702"></a><span id="l77.702">   },</span>
<a href="#l77.703"></a><span id="l77.703"> </span>
<a href="#l77.704"></a><span id="l77.704">   /*</span>
<a href="#l77.705"></a><span id="l77.705">    * Download the actual messages, this will recurse through its callback.</span>
<a href="#l77.706"></a><span id="l77.706">    */</span>
<a href="#l77.707"></a><span id="l77.707">   _getMessages() {</span>
<a href="#l77.708"></a><span id="l77.708" class="difflineminus">-    let messagesUrl = &quot;https://&quot; + kMessagesHost +</span>
<a href="#l77.709"></a><span id="l77.709" class="difflineplus">+    let messagesUrl =</span>
<a href="#l77.710"></a><span id="l77.710" class="difflineplus">+      &quot;https://&quot; +</span>
<a href="#l77.711"></a><span id="l77.711" class="difflineplus">+      kMessagesHost +</span>
<a href="#l77.712"></a><span id="l77.712">       &quot;/v1/users/ME/endpoints/SELF/subscriptions/0/poll&quot;;</span>
<a href="#l77.713"></a><span id="l77.713">     let options = {</span>
<a href="#l77.714"></a><span id="l77.714">       method: &quot;POST&quot;,</span>
<a href="#l77.715"></a><span id="l77.715">       onLoad: this._onMessages.bind(this),</span>
<a href="#l77.716"></a><span id="l77.716">       onError: this._onHttpError.bind(this),</span>
<a href="#l77.717"></a><span id="l77.717">       logger: this._logger,</span>
<a href="#l77.718"></a><span id="l77.718">     };</span>
<a href="#l77.719"></a><span id="l77.719">     this._request = this._messagesRequest(messagesUrl, options);</span>
<a href="#l77.720"></a><span id="l77.720" class="difflineat">@@ -656,44 +726,48 @@ SkypeAccount.prototype = {</span>
<a href="#l77.721"></a><span id="l77.721">   _onMessages(aResponse, aXhr) {</span>
<a href="#l77.722"></a><span id="l77.722">     this.LOG(&quot;Messages: &quot; + aResponse);</span>
<a href="#l77.723"></a><span id="l77.723"> </span>
<a href="#l77.724"></a><span id="l77.724">     // Poll for new events by performing another XHR in 1 second.</span>
<a href="#l77.725"></a><span id="l77.725">     this._request = null;</span>
<a href="#l77.726"></a><span id="l77.726">     this._poller = setTimeout(this._getMessages.bind(this), 1000);</span>
<a href="#l77.727"></a><span id="l77.727"> </span>
<a href="#l77.728"></a><span id="l77.728">     // Empty responses are received as keep alives.</span>
<a href="#l77.729"></a><span id="l77.729" class="difflineminus">-    if (!aResponse)</span>
<a href="#l77.730"></a><span id="l77.730" class="difflineplus">+    if (!aResponse) {</span>
<a href="#l77.731"></a><span id="l77.731">       return;</span>
<a href="#l77.732"></a><span id="l77.732" class="difflineplus">+    }</span>
<a href="#l77.733"></a><span id="l77.733"> </span>
<a href="#l77.734"></a><span id="l77.734">     // Otherwise, parse the response as JSON.</span>
<a href="#l77.735"></a><span id="l77.735">     let obj = JSON.parse(aResponse);</span>
<a href="#l77.736"></a><span id="l77.736">     if (!obj) {</span>
<a href="#l77.737"></a><span id="l77.737">       this.ERROR(&quot;Unable to parse JSON response: &quot; + aResponse);</span>
<a href="#l77.738"></a><span id="l77.738">       return;</span>
<a href="#l77.739"></a><span id="l77.739">     }</span>
<a href="#l77.740"></a><span id="l77.740"> </span>
<a href="#l77.741"></a><span id="l77.741">     // If no messages, nothing to do.</span>
<a href="#l77.742"></a><span id="l77.742" class="difflineminus">-    if (!(&quot;eventMessages&quot; in obj))</span>
<a href="#l77.743"></a><span id="l77.743" class="difflineplus">+    if (!(&quot;eventMessages&quot; in obj)) {</span>
<a href="#l77.744"></a><span id="l77.744">       return;</span>
<a href="#l77.745"></a><span id="l77.745" class="difflineplus">+    }</span>
<a href="#l77.746"></a><span id="l77.746"> </span>
<a href="#l77.747"></a><span id="l77.747">     for (let message of obj.eventMessages) {</span>
<a href="#l77.748"></a><span id="l77.748">       // The type of message (e.g. new message, new status).</span>
<a href="#l77.749"></a><span id="l77.749">       let resourceType = message.resourceType;</span>
<a href="#l77.750"></a><span id="l77.750">       // The message object.</span>
<a href="#l77.751"></a><span id="l77.751">       let resource = message.resource;</span>
<a href="#l77.752"></a><span id="l77.752"> </span>
<a href="#l77.753"></a><span id="l77.753">       // Based on what the message is, totally different things are done below.</span>
<a href="#l77.754"></a><span id="l77.754">       // Sorry for the mess. We can probably abstract this better.</span>
<a href="#l77.755"></a><span id="l77.755">       if (resourceType == &quot;NewMessage&quot;) {</span>
<a href="#l77.756"></a><span id="l77.756">         let messageType = resource.messagetype;</span>
<a href="#l77.757"></a><span id="l77.757">         let from = contactUrlToName(resource.from);</span>
<a href="#l77.758"></a><span id="l77.758">         if (!from) {</span>
<a href="#l77.759"></a><span id="l77.759" class="difflineminus">-          this.WARN(&quot;Received a message without a parseable from field: &quot; +</span>
<a href="#l77.760"></a><span id="l77.760" class="difflineminus">-                    resource.from);</span>
<a href="#l77.761"></a><span id="l77.761" class="difflineplus">+          this.WARN(</span>
<a href="#l77.762"></a><span id="l77.762" class="difflineplus">+            &quot;Received a message without a parseable from field: &quot; +</span>
<a href="#l77.763"></a><span id="l77.763" class="difflineplus">+              resource.from</span>
<a href="#l77.764"></a><span id="l77.764" class="difflineplus">+          );</span>
<a href="#l77.765"></a><span id="l77.765">           return;</span>
<a href="#l77.766"></a><span id="l77.766">         }</span>
<a href="#l77.767"></a><span id="l77.767"> </span>
<a href="#l77.768"></a><span id="l77.768">         // TODO Handle composetime field?</span>
<a href="#l77.769"></a><span id="l77.769">         let conversationLink = resource.conversationLink;</span>
<a href="#l77.770"></a><span id="l77.770"> </span>
<a href="#l77.771"></a><span id="l77.771">         // Check if the conversation is a chat.</span>
<a href="#l77.772"></a><span id="l77.772">         if (conversationLink.includes(&quot;/19:&quot;)) {</span>
<a href="#l77.773"></a><span id="l77.773" class="difflineat">@@ -706,48 +780,54 @@ SkypeAccount.prototype = {</span>
<a href="#l77.774"></a><span id="l77.774">         let conversationName = contactUrlToName(conversationLink);</span>
<a href="#l77.775"></a><span id="l77.775">         let conv = this._conversations.get(conversationName);</span>
<a href="#l77.776"></a><span id="l77.776"> </span>
<a href="#l77.777"></a><span id="l77.777">         let messageTypeParts = messageType.split(&quot;/&quot;);</span>
<a href="#l77.778"></a><span id="l77.778">         // Set the typing state (if the conversation exists).</span>
<a href="#l77.779"></a><span id="l77.779">         if (messageTypeParts[0] == &quot;Control&quot; &amp;&amp; conv) {</span>
<a href="#l77.780"></a><span id="l77.780">           let typingState = null;</span>
<a href="#l77.781"></a><span id="l77.781">           // NotTyping or Typing.</span>
<a href="#l77.782"></a><span id="l77.782" class="difflineminus">-          if (messageTypeParts[1] == &quot;Typing&quot;)</span>
<a href="#l77.783"></a><span id="l77.783" class="difflineplus">+          if (messageTypeParts[1] == &quot;Typing&quot;) {</span>
<a href="#l77.784"></a><span id="l77.784">             typingState = Ci.prplIConvIM.TYPING;</span>
<a href="#l77.785"></a><span id="l77.785" class="difflineminus">-          else if (messageTypeParts[1] == &quot;ClearTyping&quot;)</span>
<a href="#l77.786"></a><span id="l77.786" class="difflineplus">+          } else if (messageTypeParts[1] == &quot;ClearTyping&quot;) {</span>
<a href="#l77.787"></a><span id="l77.787">             typingState = Ci.prplIConvIM.NOT_TYPING;</span>
<a href="#l77.788"></a><span id="l77.788" class="difflineminus">-          if (typingState !== null)</span>
<a href="#l77.789"></a><span id="l77.789" class="difflineplus">+          }</span>
<a href="#l77.790"></a><span id="l77.790" class="difflineplus">+          if (typingState !== null) {</span>
<a href="#l77.791"></a><span id="l77.791">             conv.updateTyping(typingState);</span>
<a href="#l77.792"></a><span id="l77.792" class="difflineplus">+          }</span>
<a href="#l77.793"></a><span id="l77.793">           // TODO There doesn't seem to be a &quot;typed&quot; state.</span>
<a href="#l77.794"></a><span id="l77.794">         } else if (messageType == &quot;RichText&quot; || messageType == &quot;Text&quot;) {</span>
<a href="#l77.795"></a><span id="l77.795">           // Create a conversation if it doesn't exist.</span>
<a href="#l77.796"></a><span id="l77.796" class="difflineminus">-          if (!conv)</span>
<a href="#l77.797"></a><span id="l77.797" class="difflineplus">+          if (!conv) {</span>
<a href="#l77.798"></a><span id="l77.798">             conv = this.createConversation(conversationName);</span>
<a href="#l77.799"></a><span id="l77.799" class="difflineplus">+          }</span>
<a href="#l77.800"></a><span id="l77.800"> </span>
<a href="#l77.801"></a><span id="l77.801">           // TODO Handle RichText vs. Text.</span>
<a href="#l77.802"></a><span id="l77.802"> </span>
<a href="#l77.803"></a><span id="l77.803">           // Put the message into the conversation.</span>
<a href="#l77.804"></a><span id="l77.804">           let options = {};</span>
<a href="#l77.805"></a><span id="l77.805" class="difflineminus">-          if (from == this.name)</span>
<a href="#l77.806"></a><span id="l77.806" class="difflineplus">+          if (from == this.name) {</span>
<a href="#l77.807"></a><span id="l77.807">             options.outgoing = true;</span>
<a href="#l77.808"></a><span id="l77.808" class="difflineminus">-          else</span>
<a href="#l77.809"></a><span id="l77.809" class="difflineplus">+          } else {</span>
<a href="#l77.810"></a><span id="l77.810">             options.incoming = true;</span>
<a href="#l77.811"></a><span id="l77.811" class="difflineplus">+          }</span>
<a href="#l77.812"></a><span id="l77.812">           conv.writeMessage(from, resource.content, options);</span>
<a href="#l77.813"></a><span id="l77.813">         }</span>
<a href="#l77.814"></a><span id="l77.814">       } else if (resourceType == &quot;UserPresence&quot;) {</span>
<a href="#l77.815"></a><span id="l77.815">         // Ignore our own statuses.</span>
<a href="#l77.816"></a><span id="l77.816">         let from = contactUrlToName(resource.selfLink);</span>
<a href="#l77.817"></a><span id="l77.817" class="difflineminus">-        if (!from)</span>
<a href="#l77.818"></a><span id="l77.818" class="difflineplus">+        if (!from) {</span>
<a href="#l77.819"></a><span id="l77.819">           continue;</span>
<a href="#l77.820"></a><span id="l77.820" class="difflineplus">+        }</span>
<a href="#l77.821"></a><span id="l77.821"> </span>
<a href="#l77.822"></a><span id="l77.822">         // Get the buddy and update the status.</span>
<a href="#l77.823"></a><span id="l77.823">         let buddy = this._buddies.get(from);</span>
<a href="#l77.824"></a><span id="l77.824" class="difflineminus">-        if (buddy)</span>
<a href="#l77.825"></a><span id="l77.825" class="difflineplus">+        if (buddy) {</span>
<a href="#l77.826"></a><span id="l77.826">           buddy.setStatus(this.mapStatusString(resource.status), &quot;&quot;);</span>
<a href="#l77.827"></a><span id="l77.827" class="difflineplus">+        }</span>
<a href="#l77.828"></a><span id="l77.828">       } else if (resourceType == &quot;EndpointPresence&quot;) {</span>
<a href="#l77.829"></a><span id="l77.829">         // Nothing to do.</span>
<a href="#l77.830"></a><span id="l77.830">       } else if (resourceType == &quot;ConversationUpdate&quot;) {</span>
<a href="#l77.831"></a><span id="l77.831">         // Nothing to do.</span>
<a href="#l77.832"></a><span id="l77.832">       } else if (resourceType == &quot;ThreadUpdate&quot;) {</span>
<a href="#l77.833"></a><span id="l77.833">         // Nothing to do.</span>
<a href="#l77.834"></a><span id="l77.834">       } else {</span>
<a href="#l77.835"></a><span id="l77.835">         this.WARN(&quot;Unhandled resource type: &quot; + resourceType);</span>
<a href="#l77.836"></a><span id="l77.836" class="difflineat">@@ -794,35 +874,40 @@ SkypeAccount.prototype = {</span>
<a href="#l77.837"></a><span id="l77.837"> </span>
<a href="#l77.838"></a><span id="l77.838">     aOptions.headers = headers;</span>
<a href="#l77.839"></a><span id="l77.839"> </span>
<a href="#l77.840"></a><span id="l77.840">     return httpRequest(aUrl, aOptions);</span>
<a href="#l77.841"></a><span id="l77.841">   },</span>
<a href="#l77.842"></a><span id="l77.842"> </span>
<a href="#l77.843"></a><span id="l77.843">   // Helper function to disconnect with authentication failed.</span>
<a href="#l77.844"></a><span id="l77.844">   _disconnectWithAuthFailure(aMessageId = &quot;error.auth&quot;) {</span>
<a href="#l77.845"></a><span id="l77.845" class="difflineminus">-    this.reportDisconnecting(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l77.846"></a><span id="l77.846" class="difflineminus">-                             _(aMessageId));</span>
<a href="#l77.847"></a><span id="l77.847" class="difflineplus">+    this.reportDisconnecting(</span>
<a href="#l77.848"></a><span id="l77.848" class="difflineplus">+      Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l77.849"></a><span id="l77.849" class="difflineplus">+      _(aMessageId)</span>
<a href="#l77.850"></a><span id="l77.850" class="difflineplus">+    );</span>
<a href="#l77.851"></a><span id="l77.851">     this.reportDisconnected();</span>
<a href="#l77.852"></a><span id="l77.852">   },</span>
<a href="#l77.853"></a><span id="l77.853"> </span>
<a href="#l77.854"></a><span id="l77.854">   disconnect() {</span>
<a href="#l77.855"></a><span id="l77.855" class="difflineminus">-    if (this.disconnected || this.disconnecting)</span>
<a href="#l77.856"></a><span id="l77.856" class="difflineplus">+    if (this.disconnected || this.disconnecting) {</span>
<a href="#l77.857"></a><span id="l77.857">       return;</span>
<a href="#l77.858"></a><span id="l77.858" class="difflineplus">+    }</span>
<a href="#l77.859"></a><span id="l77.859"> </span>
<a href="#l77.860"></a><span id="l77.860">     clearTimeout(this._poller);</span>
<a href="#l77.861"></a><span id="l77.861" class="difflineminus">-    if (this._request)</span>
<a href="#l77.862"></a><span id="l77.862" class="difflineplus">+    if (this._request) {</span>
<a href="#l77.863"></a><span id="l77.863">       this._request.abort();</span>
<a href="#l77.864"></a><span id="l77.864" class="difflineplus">+    }</span>
<a href="#l77.865"></a><span id="l77.865"> </span>
<a href="#l77.866"></a><span id="l77.866">     this._request = null;</span>
<a href="#l77.867"></a><span id="l77.867">     this._poller = null;</span>
<a href="#l77.868"></a><span id="l77.868"> </span>
<a href="#l77.869"></a><span id="l77.869">     // Mark all contacts on the account as having an unknown status.</span>
<a href="#l77.870"></a><span id="l77.870">     this._buddies.forEach(aBuddy =&gt;</span>
<a href="#l77.871"></a><span id="l77.871" class="difflineminus">-      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;));</span>
<a href="#l77.872"></a><span id="l77.872" class="difflineplus">+      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;)</span>
<a href="#l77.873"></a><span id="l77.873" class="difflineplus">+    );</span>
<a href="#l77.874"></a><span id="l77.874"> </span>
<a href="#l77.875"></a><span id="l77.875">     this.reportDisconnected();</span>
<a href="#l77.876"></a><span id="l77.876">   },</span>
<a href="#l77.877"></a><span id="l77.877"> </span>
<a href="#l77.878"></a><span id="l77.878">   // TODO?</span>
<a href="#l77.879"></a><span id="l77.879">   observe(aSubject, aTopic, aData) {},</span>
<a href="#l77.880"></a><span id="l77.880"> </span>
<a href="#l77.881"></a><span id="l77.881">   remove() {</span>
<a href="#l77.882"></a><span id="l77.882" class="difflineat">@@ -849,27 +934,39 @@ SkypeAccount.prototype = {</span>
<a href="#l77.883"></a><span id="l77.883">   loadBuddy(aBuddy, aTag) {</span>
<a href="#l77.884"></a><span id="l77.884">     let buddy = new SkypeAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l77.885"></a><span id="l77.885">     this._buddies.set(buddy.userName, buddy);</span>
<a href="#l77.886"></a><span id="l77.886"> </span>
<a href="#l77.887"></a><span id="l77.887">     return buddy;</span>
<a href="#l77.888"></a><span id="l77.888">   },</span>
<a href="#l77.889"></a><span id="l77.889"> </span>
<a href="#l77.890"></a><span id="l77.890">   // TODO Add support for MUCs.</span>
<a href="#l77.891"></a><span id="l77.891" class="difflineminus">-  get canJoinChat() { return false; },</span>
<a href="#l77.892"></a><span id="l77.892" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l77.893"></a><span id="l77.893" class="difflineplus">+    return false;</span>
<a href="#l77.894"></a><span id="l77.894" class="difflineplus">+  },</span>
<a href="#l77.895"></a><span id="l77.895">   chatRoomFields: {},</span>
<a href="#l77.896"></a><span id="l77.896">   joinChat(aComponents) {},</span>
<a href="#l77.897"></a><span id="l77.897"> };</span>
<a href="#l77.898"></a><span id="l77.898"> </span>
<a href="#l77.899"></a><span id="l77.899"> function SkypeProtocol() {}</span>
<a href="#l77.900"></a><span id="l77.900"> SkypeProtocol.prototype = {</span>
<a href="#l77.901"></a><span id="l77.901">   __proto__: GenericProtocolPrototype,</span>
<a href="#l77.902"></a><span id="l77.902" class="difflineminus">-  get name() { return &quot;Skype&quot;; },</span>
<a href="#l77.903"></a><span id="l77.903" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-skype/skin/&quot;; },</span>
<a href="#l77.904"></a><span id="l77.904" class="difflineminus">-  get baseId() { return &quot;prpl-skype&quot;; },</span>
<a href="#l77.905"></a><span id="l77.905" class="difflineplus">+  get name() {</span>
<a href="#l77.906"></a><span id="l77.906" class="difflineplus">+    return &quot;Skype&quot;;</span>
<a href="#l77.907"></a><span id="l77.907" class="difflineplus">+  },</span>
<a href="#l77.908"></a><span id="l77.908" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l77.909"></a><span id="l77.909" class="difflineplus">+    return &quot;chrome://prpl-skype/skin/&quot;;</span>
<a href="#l77.910"></a><span id="l77.910" class="difflineplus">+  },</span>
<a href="#l77.911"></a><span id="l77.911" class="difflineplus">+  get baseId() {</span>
<a href="#l77.912"></a><span id="l77.912" class="difflineplus">+    return &quot;prpl-skype&quot;;</span>
<a href="#l77.913"></a><span id="l77.913" class="difflineplus">+  },</span>
<a href="#l77.914"></a><span id="l77.914"> </span>
<a href="#l77.915"></a><span id="l77.915" class="difflineminus">-  get passwordOptional() { return false; },</span>
<a href="#l77.916"></a><span id="l77.916" class="difflineplus">+  get passwordOptional() {</span>
<a href="#l77.917"></a><span id="l77.917" class="difflineplus">+    return false;</span>
<a href="#l77.918"></a><span id="l77.918" class="difflineplus">+  },</span>
<a href="#l77.919"></a><span id="l77.919"> </span>
<a href="#l77.920"></a><span id="l77.920" class="difflineminus">-  getAccount(aImAccount) { return new SkypeAccount(this, aImAccount); },</span>
<a href="#l77.921"></a><span id="l77.921" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l77.922"></a><span id="l77.922" class="difflineplus">+    return new SkypeAccount(this, aImAccount);</span>
<a href="#l77.923"></a><span id="l77.923" class="difflineplus">+  },</span>
<a href="#l77.924"></a><span id="l77.924">   classID: Components.ID(&quot;{8446c0f6-9f59-4710-844e-eaa6c1f49d35}&quot;),</span>
<a href="#l77.925"></a><span id="l77.925"> };</span>
<a href="#l77.926"></a><span id="l77.926"> </span>
<a href="#l77.927"></a><span id="l77.927"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([SkypeProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -1,25 +1,26 @@</span>
<a href="#l78.4"></a><span id="l78.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l78.5"></a><span id="l78.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l78.6"></a><span id="l78.6"> </span>
<a href="#l78.7"></a><span id="l78.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l78.8"></a><span id="l78.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l78.9"></a><span id="l78.9"> var skype = {};</span>
<a href="#l78.10"></a><span id="l78.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12"> var data = {</span>
<a href="#l78.13"></a><span id="l78.13">   &quot;1416264993&quot;: &quot;3a33ac47fe2ec1a33d569f4be5c69ddc&quot;,</span>
<a href="#l78.14"></a><span id="l78.14">   &quot;1416387358&quot;: &quot;eca9716e1eedcbe93320ba794cea3388&quot;,</span>
<a href="#l78.15"></a><span id="l78.15">   &quot;1416392361&quot;: &quot;2ed6fc80c3303caa137ae3fd4fcc7d80&quot;,</span>
<a href="#l78.16"></a><span id="l78.16"> };</span>
<a href="#l78.17"></a><span id="l78.17"> </span>
<a href="#l78.18"></a><span id="l78.18"> function run_test() {</span>
<a href="#l78.19"></a><span id="l78.19">   add_test(test_MagicSha256);</span>
<a href="#l78.20"></a><span id="l78.20"> </span>
<a href="#l78.21"></a><span id="l78.21">   run_next_test();</span>
<a href="#l78.22"></a><span id="l78.22"> }</span>
<a href="#l78.23"></a><span id="l78.23"> </span>
<a href="#l78.24"></a><span id="l78.24"> function test_MagicSha256() {</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineminus">-  for (let input in data)</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineplus">+  for (let input in data) {</span>
<a href="#l78.27"></a><span id="l78.27">     equal(data[input], skype.magicSha256(input));</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+  }</span>
<a href="#l78.29"></a><span id="l78.29"> </span>
<a href="#l78.30"></a><span id="l78.30">   run_next_test();</span>
<a href="#l78.31"></a><span id="l78.31"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l79.4"></a><span id="l79.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l79.5"></a><span id="l79.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l79.8"></a><span id="l79.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l79.9"></a><span id="l79.9"> var skype = {};</span>
<a href="#l79.10"></a><span id="l79.10"> Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l79.11"></a><span id="l79.11"> </span>
<a href="#l79.12"></a><span id="l79.12"> var data = {</span>
<a href="#l79.13"></a><span id="l79.13">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/ME/contacts/8:clokep&quot;:</span>
<a href="#l79.14"></a><span id="l79.14">     &quot;clokep&quot;,</span>
<a href="#l79.15"></a><span id="l79.15">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService&quot;:</span>
<a href="#l79.16"></a><span id="l79.16">     &quot;clokep&quot;,</span>
<a href="#l79.17"></a><span id="l79.17" class="difflineat">@@ -14,13 +14,14 @@ var data = {</span>
<a href="#l79.18"></a><span id="l79.18"> </span>
<a href="#l79.19"></a><span id="l79.19"> function run_test() {</span>
<a href="#l79.20"></a><span id="l79.20">   add_test(test_contactUrlToName);</span>
<a href="#l79.21"></a><span id="l79.21"> </span>
<a href="#l79.22"></a><span id="l79.22">   run_next_test();</span>
<a href="#l79.23"></a><span id="l79.23"> }</span>
<a href="#l79.24"></a><span id="l79.24"> </span>
<a href="#l79.25"></a><span id="l79.25"> function test_contactUrlToName() {</span>
<a href="#l79.26"></a><span id="l79.26" class="difflineminus">-  for (let input in data)</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineplus">+  for (let input in data) {</span>
<a href="#l79.28"></a><span id="l79.28">     equal(data[input], skype.contactUrlToName(input));</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineplus">+  }</span>
<a href="#l79.30"></a><span id="l79.30"> </span>
<a href="#l79.31"></a><span id="l79.31">   run_next_test();</span>
<a href="#l79.32"></a><span id="l79.32"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/chat/protocols/twitter/twitter.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/chat/protocols/twitter/twitter.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l80.4"></a><span id="l80.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l80.5"></a><span id="l80.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l80.6"></a><span id="l80.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l80.7"></a><span id="l80.7"> </span>
<a href="#l80.8"></a><span id="l80.8" class="difflineminus">-var {httpRequest, percentEncode} = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l80.9"></a><span id="l80.9" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l80.10"></a><span id="l80.10" class="difflineplus">+var { httpRequest, percentEncode } = ChromeUtils.import(</span>
<a href="#l80.11"></a><span id="l80.11" class="difflineplus">+  &quot;resource://gre/modules/Http.jsm&quot;</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineplus">+);</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l80.14"></a><span id="l80.14"> var {</span>
<a href="#l80.15"></a><span id="l80.15">   XPCOMUtils,</span>
<a href="#l80.16"></a><span id="l80.16">   setTimeout,</span>
<a href="#l80.17"></a><span id="l80.17">   clearTimeout,</span>
<a href="#l80.18"></a><span id="l80.18">   executeSoon,</span>
<a href="#l80.19"></a><span id="l80.19">   nsSimpleEnumerator,</span>
<a href="#l80.20"></a><span id="l80.20">   EmptyEnumerator,</span>
<a href="#l80.21"></a><span id="l80.21">   ClassInfo,</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineat">@@ -22,17 +24,17 @@ var {</span>
<a href="#l80.23"></a><span id="l80.23">   GenericConvChatPrototype,</span>
<a href="#l80.24"></a><span id="l80.24">   GenericConvChatBuddyPrototype,</span>
<a href="#l80.25"></a><span id="l80.25">   GenericConversationPrototype,</span>
<a href="#l80.26"></a><span id="l80.26">   GenericMessagePrototype,</span>
<a href="#l80.27"></a><span id="l80.27">   GenericProtocolPrototype,</span>
<a href="#l80.28"></a><span id="l80.28">   Message,</span>
<a href="#l80.29"></a><span id="l80.29">   TooltipInfo,</span>
<a href="#l80.30"></a><span id="l80.30"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineminus">-var {twttr} = ChromeUtils.import(&quot;resource:///modules/twitter-text.jsm&quot;);</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineplus">+var { twttr } = ChromeUtils.import(&quot;resource:///modules/twitter-text.jsm&quot;);</span>
<a href="#l80.33"></a><span id="l80.33"> </span>
<a href="#l80.34"></a><span id="l80.34"> var NS_PREFBRANCH_PREFCHANGE_TOPIC_ID = &quot;nsPref:changed&quot;;</span>
<a href="#l80.35"></a><span id="l80.35"> </span>
<a href="#l80.36"></a><span id="l80.36"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l80.37"></a><span id="l80.37">   l10nHelper(&quot;chrome://chat/locale/twitter.properties&quot;)</span>
<a href="#l80.38"></a><span id="l80.38"> );</span>
<a href="#l80.39"></a><span id="l80.39"> XPCOMUtils.defineLazyGetter(this, &quot;_lang&quot;, () =&gt;</span>
<a href="#l80.40"></a><span id="l80.40">   l10nHelper(&quot;chrome://global/locale/languageNames.properties&quot;)</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineat">@@ -42,229 +44,281 @@ initLogModule(&quot;twitter&quot;, this);</span>
<a href="#l80.42"></a><span id="l80.42"> function ChatBuddy(aName, aAccount) {</span>
<a href="#l80.43"></a><span id="l80.43">   this._name = aName;</span>
<a href="#l80.44"></a><span id="l80.44">   this._account = aAccount;</span>
<a href="#l80.45"></a><span id="l80.45"> }</span>
<a href="#l80.46"></a><span id="l80.46"> ChatBuddy.prototype = {</span>
<a href="#l80.47"></a><span id="l80.47">   __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l80.48"></a><span id="l80.48">   get buddyIconFilename() {</span>
<a href="#l80.49"></a><span id="l80.49">     let userInfo = this._account._userInfo.get(this.name);</span>
<a href="#l80.50"></a><span id="l80.50" class="difflineminus">-    if (userInfo)</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineplus">+    if (userInfo) {</span>
<a href="#l80.52"></a><span id="l80.52">       return userInfo.profile_image_url;</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineplus">+    }</span>
<a href="#l80.54"></a><span id="l80.54">     return undefined;</span>
<a href="#l80.55"></a><span id="l80.55">   },</span>
<a href="#l80.56"></a><span id="l80.56">   set buddyIconFilename(aName) {</span>
<a href="#l80.57"></a><span id="l80.57">     // Prevent accidental removal of the getter.</span>
<a href="#l80.58"></a><span id="l80.58" class="difflineminus">-    throw new Error(&quot;Don't set chatBuddy.buddyIconFilename directly for Twitter.&quot;);</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineplus">+    throw new Error(</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineplus">+      &quot;Don't set chatBuddy.buddyIconFilename directly for Twitter.&quot;</span>
<a href="#l80.61"></a><span id="l80.61" class="difflineplus">+    );</span>
<a href="#l80.62"></a><span id="l80.62">   },</span>
<a href="#l80.63"></a><span id="l80.63">   createConversation() {</span>
<a href="#l80.64"></a><span id="l80.64">     return this._account.createConversation(this._name);</span>
<a href="#l80.65"></a><span id="l80.65">   },</span>
<a href="#l80.66"></a><span id="l80.66"> };</span>
<a href="#l80.67"></a><span id="l80.67"> </span>
<a href="#l80.68"></a><span id="l80.68" class="difflineminus">-function Tweet(aTweet, aWho, aMessage, aObject)</span>
<a href="#l80.69"></a><span id="l80.69" class="difflineminus">-{</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineplus">+function Tweet(aTweet, aWho, aMessage, aObject) {</span>
<a href="#l80.71"></a><span id="l80.71">   this._tweet = aTweet;</span>
<a href="#l80.72"></a><span id="l80.72">   this._init(aWho, aMessage, aObject);</span>
<a href="#l80.73"></a><span id="l80.73"> }</span>
<a href="#l80.74"></a><span id="l80.74"> Tweet.prototype = {</span>
<a href="#l80.75"></a><span id="l80.75">   __proto__: GenericMessagePrototype,</span>
<a href="#l80.76"></a><span id="l80.76">   _deleted: false,</span>
<a href="#l80.77"></a><span id="l80.77">   getActions(aCount) {</span>
<a href="#l80.78"></a><span id="l80.78">     // Direct messages have no actions.</span>
<a href="#l80.79"></a><span id="l80.79">     if (!this.conversation.isChat) {</span>
<a href="#l80.80"></a><span id="l80.80" class="difflineminus">-      if (aCount)</span>
<a href="#l80.81"></a><span id="l80.81" class="difflineplus">+      if (aCount) {</span>
<a href="#l80.82"></a><span id="l80.82">         aCount.value = 0;</span>
<a href="#l80.83"></a><span id="l80.83" class="difflineplus">+      }</span>
<a href="#l80.84"></a><span id="l80.84">       return [];</span>
<a href="#l80.85"></a><span id="l80.85">     }</span>
<a href="#l80.86"></a><span id="l80.86"> </span>
<a href="#l80.87"></a><span id="l80.87">     let account = this.conversation._account;</span>
<a href="#l80.88"></a><span id="l80.88">     let actions = [];</span>
<a href="#l80.89"></a><span id="l80.89"> </span>
<a href="#l80.90"></a><span id="l80.90">     if (account.connected) {</span>
<a href="#l80.91"></a><span id="l80.91">       actions.push(</span>
<a href="#l80.92"></a><span id="l80.92" class="difflineminus">-        new Action(_(&quot;action.reply&quot;), function() {</span>
<a href="#l80.93"></a><span id="l80.93" class="difflineminus">-          this.conversation.startReply(this._tweet);</span>
<a href="#l80.94"></a><span id="l80.94" class="difflineminus">-        }, this)</span>
<a href="#l80.95"></a><span id="l80.95" class="difflineplus">+        new Action(</span>
<a href="#l80.96"></a><span id="l80.96" class="difflineplus">+          _(&quot;action.reply&quot;),</span>
<a href="#l80.97"></a><span id="l80.97" class="difflineplus">+          function() {</span>
<a href="#l80.98"></a><span id="l80.98" class="difflineplus">+            this.conversation.startReply(this._tweet);</span>
<a href="#l80.99"></a><span id="l80.99" class="difflineplus">+          },</span>
<a href="#l80.100"></a><span id="l80.100" class="difflineplus">+          this</span>
<a href="#l80.101"></a><span id="l80.101" class="difflineplus">+        )</span>
<a href="#l80.102"></a><span id="l80.102">       );</span>
<a href="#l80.103"></a><span id="l80.103">       actions.push(</span>
<a href="#l80.104"></a><span id="l80.104" class="difflineminus">-        new Action(_(&quot;action.retweet&quot;), function() {</span>
<a href="#l80.105"></a><span id="l80.105" class="difflineminus">-          this.conversation.reTweet(this._tweet);</span>
<a href="#l80.106"></a><span id="l80.106" class="difflineminus">-        }, this)</span>
<a href="#l80.107"></a><span id="l80.107" class="difflineplus">+        new Action(</span>
<a href="#l80.108"></a><span id="l80.108" class="difflineplus">+          _(&quot;action.retweet&quot;),</span>
<a href="#l80.109"></a><span id="l80.109" class="difflineplus">+          function() {</span>
<a href="#l80.110"></a><span id="l80.110" class="difflineplus">+            this.conversation.reTweet(this._tweet);</span>
<a href="#l80.111"></a><span id="l80.111" class="difflineplus">+          },</span>
<a href="#l80.112"></a><span id="l80.112" class="difflineplus">+          this</span>
<a href="#l80.113"></a><span id="l80.113" class="difflineplus">+        )</span>
<a href="#l80.114"></a><span id="l80.114">       );</span>
<a href="#l80.115"></a><span id="l80.115">       if (this.incoming) {</span>
<a href="#l80.116"></a><span id="l80.116">         let isFriend = account._friends.has(this._tweet.user.id_str);</span>
<a href="#l80.117"></a><span id="l80.117">         let action = isFriend ? &quot;stopFollowing&quot; : &quot;follow&quot;;</span>
<a href="#l80.118"></a><span id="l80.118">         let screenName = this._tweet.user.screen_name;</span>
<a href="#l80.119"></a><span id="l80.119" class="difflineminus">-        actions.push(new Action(_(&quot;action.&quot; + action, screenName),</span>
<a href="#l80.120"></a><span id="l80.120" class="difflineminus">-                                function() { account[action](screenName); }));</span>
<a href="#l80.121"></a><span id="l80.121" class="difflineplus">+        actions.push(</span>
<a href="#l80.122"></a><span id="l80.122" class="difflineplus">+          new Action(_(&quot;action.&quot; + action, screenName), function() {</span>
<a href="#l80.123"></a><span id="l80.123" class="difflineplus">+            account[action](screenName);</span>
<a href="#l80.124"></a><span id="l80.124" class="difflineplus">+          })</span>
<a href="#l80.125"></a><span id="l80.125" class="difflineplus">+        );</span>
<a href="#l80.126"></a><span id="l80.126"> </span>
<a href="#l80.127"></a><span id="l80.127">         const favAction = this._tweet.favorited ? &quot;unlike&quot; : &quot;like&quot;;</span>
<a href="#l80.128"></a><span id="l80.128" class="difflineminus">-        actions.push(new Action(_(&quot;action.&quot; + favAction), () =&gt; {</span>
<a href="#l80.129"></a><span id="l80.129" class="difflineminus">-          this.conversation.like(this._tweet, this._tweet.favorited);</span>
<a href="#l80.130"></a><span id="l80.130" class="difflineminus">-        }, this));</span>
<a href="#l80.131"></a><span id="l80.131" class="difflineminus">-      }</span>
<a href="#l80.132"></a><span id="l80.132" class="difflineminus">-      else if (this.outgoing &amp;&amp; !this._deleted) {</span>
<a href="#l80.133"></a><span id="l80.133">         actions.push(</span>
<a href="#l80.134"></a><span id="l80.134" class="difflineminus">-          new Action(_(&quot;action.delete&quot;), function() {</span>
<a href="#l80.135"></a><span id="l80.135" class="difflineminus">-            this.destroy();</span>
<a href="#l80.136"></a><span id="l80.136" class="difflineminus">-          }, this)</span>
<a href="#l80.137"></a><span id="l80.137" class="difflineplus">+          new Action(</span>
<a href="#l80.138"></a><span id="l80.138" class="difflineplus">+            _(&quot;action.&quot; + favAction),</span>
<a href="#l80.139"></a><span id="l80.139" class="difflineplus">+            () =&gt; {</span>
<a href="#l80.140"></a><span id="l80.140" class="difflineplus">+              this.conversation.like(this._tweet, this._tweet.favorited);</span>
<a href="#l80.141"></a><span id="l80.141" class="difflineplus">+            },</span>
<a href="#l80.142"></a><span id="l80.142" class="difflineplus">+            this</span>
<a href="#l80.143"></a><span id="l80.143" class="difflineplus">+          )</span>
<a href="#l80.144"></a><span id="l80.144" class="difflineplus">+        );</span>
<a href="#l80.145"></a><span id="l80.145" class="difflineplus">+      } else if (this.outgoing &amp;&amp; !this._deleted) {</span>
<a href="#l80.146"></a><span id="l80.146" class="difflineplus">+        actions.push(</span>
<a href="#l80.147"></a><span id="l80.147" class="difflineplus">+          new Action(</span>
<a href="#l80.148"></a><span id="l80.148" class="difflineplus">+            _(&quot;action.delete&quot;),</span>
<a href="#l80.149"></a><span id="l80.149" class="difflineplus">+            function() {</span>
<a href="#l80.150"></a><span id="l80.150" class="difflineplus">+              this.destroy();</span>
<a href="#l80.151"></a><span id="l80.151" class="difflineplus">+            },</span>
<a href="#l80.152"></a><span id="l80.152" class="difflineplus">+            this</span>
<a href="#l80.153"></a><span id="l80.153" class="difflineplus">+          )</span>
<a href="#l80.154"></a><span id="l80.154">         );</span>
<a href="#l80.155"></a><span id="l80.155">       }</span>
<a href="#l80.156"></a><span id="l80.156">     }</span>
<a href="#l80.157"></a><span id="l80.157" class="difflineminus">-    actions.push(new Action(_(&quot;action.copyLink&quot;), function() {</span>
<a href="#l80.158"></a><span id="l80.158" class="difflineminus">-      let href = &quot;https://twitter.com/&quot; + this._tweet.user.screen_name +</span>
<a href="#l80.159"></a><span id="l80.159" class="difflineminus">-                 &quot;/status/&quot; + this._tweet.id_str;</span>
<a href="#l80.160"></a><span id="l80.160" class="difflineminus">-      Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l80.161"></a><span id="l80.161" class="difflineminus">-        .getService(Ci.nsIClipboardHelper).copyString(href);</span>
<a href="#l80.162"></a><span id="l80.162" class="difflineminus">-    }, this));</span>
<a href="#l80.163"></a><span id="l80.163" class="difflineminus">-    if (aCount)</span>
<a href="#l80.164"></a><span id="l80.164" class="difflineplus">+    actions.push(</span>
<a href="#l80.165"></a><span id="l80.165" class="difflineplus">+      new Action(</span>
<a href="#l80.166"></a><span id="l80.166" class="difflineplus">+        _(&quot;action.copyLink&quot;),</span>
<a href="#l80.167"></a><span id="l80.167" class="difflineplus">+        function() {</span>
<a href="#l80.168"></a><span id="l80.168" class="difflineplus">+          let href =</span>
<a href="#l80.169"></a><span id="l80.169" class="difflineplus">+            &quot;https://twitter.com/&quot; +</span>
<a href="#l80.170"></a><span id="l80.170" class="difflineplus">+            this._tweet.user.screen_name +</span>
<a href="#l80.171"></a><span id="l80.171" class="difflineplus">+            &quot;/status/&quot; +</span>
<a href="#l80.172"></a><span id="l80.172" class="difflineplus">+            this._tweet.id_str;</span>
<a href="#l80.173"></a><span id="l80.173" class="difflineplus">+          Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l80.174"></a><span id="l80.174" class="difflineplus">+            .getService(Ci.nsIClipboardHelper)</span>
<a href="#l80.175"></a><span id="l80.175" class="difflineplus">+            .copyString(href);</span>
<a href="#l80.176"></a><span id="l80.176" class="difflineplus">+        },</span>
<a href="#l80.177"></a><span id="l80.177" class="difflineplus">+        this</span>
<a href="#l80.178"></a><span id="l80.178" class="difflineplus">+      )</span>
<a href="#l80.179"></a><span id="l80.179" class="difflineplus">+    );</span>
<a href="#l80.180"></a><span id="l80.180" class="difflineplus">+    if (aCount) {</span>
<a href="#l80.181"></a><span id="l80.181">       aCount.value = actions.length;</span>
<a href="#l80.182"></a><span id="l80.182" class="difflineplus">+    }</span>
<a href="#l80.183"></a><span id="l80.183">     return actions;</span>
<a href="#l80.184"></a><span id="l80.184">   },</span>
<a href="#l80.185"></a><span id="l80.185">   destroy() {</span>
<a href="#l80.186"></a><span id="l80.186">     // Mark the tweet as deleted until we receive a response.</span>
<a href="#l80.187"></a><span id="l80.187">     this._deleted = true;</span>
<a href="#l80.188"></a><span id="l80.188"> </span>
<a href="#l80.189"></a><span id="l80.189" class="difflineminus">-    this.conversation._account.destroy(this._tweet, this.onDestroyCallback,</span>
<a href="#l80.190"></a><span id="l80.190" class="difflineminus">-                                       this.onDestroyErrorCallback, this);</span>
<a href="#l80.191"></a><span id="l80.191" class="difflineplus">+    this.conversation._account.destroy(</span>
<a href="#l80.192"></a><span id="l80.192" class="difflineplus">+      this._tweet,</span>
<a href="#l80.193"></a><span id="l80.193" class="difflineplus">+      this.onDestroyCallback,</span>
<a href="#l80.194"></a><span id="l80.194" class="difflineplus">+      this.onDestroyErrorCallback,</span>
<a href="#l80.195"></a><span id="l80.195" class="difflineplus">+      this</span>
<a href="#l80.196"></a><span id="l80.196" class="difflineplus">+    );</span>
<a href="#l80.197"></a><span id="l80.197">   },</span>
<a href="#l80.198"></a><span id="l80.198">   onDestroyErrorCallback(aException, aData) {</span>
<a href="#l80.199"></a><span id="l80.199">     // The tweet was not successfully deleted.</span>
<a href="#l80.200"></a><span id="l80.200">     delete this._deleted;</span>
<a href="#l80.201"></a><span id="l80.201">     let error = this.conversation._parseError(aData);</span>
<a href="#l80.202"></a><span id="l80.202" class="difflineminus">-    this.conversation.systemMessage(_(&quot;error.delete&quot;, error,</span>
<a href="#l80.203"></a><span id="l80.203" class="difflineminus">-                                      this.originalMessage), true);</span>
<a href="#l80.204"></a><span id="l80.204" class="difflineplus">+    this.conversation.systemMessage(</span>
<a href="#l80.205"></a><span id="l80.205" class="difflineplus">+      _(&quot;error.delete&quot;, error, this.originalMessage),</span>
<a href="#l80.206"></a><span id="l80.206" class="difflineplus">+      true</span>
<a href="#l80.207"></a><span id="l80.207" class="difflineplus">+    );</span>
<a href="#l80.208"></a><span id="l80.208">   },</span>
<a href="#l80.209"></a><span id="l80.209">   onDestroyCallback(aData) {</span>
<a href="#l80.210"></a><span id="l80.210">     let tweet = JSON.parse(aData);</span>
<a href="#l80.211"></a><span id="l80.211">     // If Twitter responds with an error, throw to call the error callback.</span>
<a href="#l80.212"></a><span id="l80.212" class="difflineminus">-    if (&quot;error&quot; in tweet)</span>
<a href="#l80.213"></a><span id="l80.213" class="difflineplus">+    if (&quot;error&quot; in tweet) {</span>
<a href="#l80.214"></a><span id="l80.214">       throw tweet.error;</span>
<a href="#l80.215"></a><span id="l80.215" class="difflineplus">+    }</span>
<a href="#l80.216"></a><span id="l80.216"> </span>
<a href="#l80.217"></a><span id="l80.217">     // Create a new system message saying the tweet has been deleted.</span>
<a href="#l80.218"></a><span id="l80.218">     this.conversation.systemMessage(_(&quot;event.deleted&quot;, this.originalMessage));</span>
<a href="#l80.219"></a><span id="l80.219">   },</span>
<a href="#l80.220"></a><span id="l80.220"> };</span>
<a href="#l80.221"></a><span id="l80.221"> </span>
<a href="#l80.222"></a><span id="l80.222" class="difflineminus">-function Action(aLabel, aAction, aTweet)</span>
<a href="#l80.223"></a><span id="l80.223" class="difflineminus">-{</span>
<a href="#l80.224"></a><span id="l80.224" class="difflineplus">+function Action(aLabel, aAction, aTweet) {</span>
<a href="#l80.225"></a><span id="l80.225">   this.label = aLabel;</span>
<a href="#l80.226"></a><span id="l80.226">   this._action = aAction;</span>
<a href="#l80.227"></a><span id="l80.227">   this._tweet = aTweet;</span>
<a href="#l80.228"></a><span id="l80.228"> }</span>
<a href="#l80.229"></a><span id="l80.229"> Action.prototype = {</span>
<a href="#l80.230"></a><span id="l80.230">   __proto__: ClassInfo(&quot;prplIMessageAction&quot;, &quot;generic message action object&quot;),</span>
<a href="#l80.231"></a><span id="l80.231" class="difflineminus">-  get run() { return this._action.bind(this._tweet); },</span>
<a href="#l80.232"></a><span id="l80.232" class="difflineplus">+  get run() {</span>
<a href="#l80.233"></a><span id="l80.233" class="difflineplus">+    return this._action.bind(this._tweet);</span>
<a href="#l80.234"></a><span id="l80.234" class="difflineplus">+  },</span>
<a href="#l80.235"></a><span id="l80.235"> };</span>
<a href="#l80.236"></a><span id="l80.236"> </span>
<a href="#l80.237"></a><span id="l80.237"> // Properties / methods shared by both DirectMessageConversation and</span>
<a href="#l80.238"></a><span id="l80.238"> // TimelineConversation.</span>
<a href="#l80.239"></a><span id="l80.239"> var GenericTwitterConversation = {</span>
<a href="#l80.240"></a><span id="l80.240">   getTweetLength(aString) {</span>
<a href="#l80.241"></a><span id="l80.241">     // Use the Twitter library to calculate the length.</span>
<a href="#l80.242"></a><span id="l80.242">     let parsed = twttr.txt.parseTweet(aString);</span>
<a href="#l80.243"></a><span id="l80.243">     return parsed.weightedLength;</span>
<a href="#l80.244"></a><span id="l80.244">   },</span>
<a href="#l80.245"></a><span id="l80.245">   systemMessage(aMessage, aIsError, aDate) {</span>
<a href="#l80.246"></a><span id="l80.246" class="difflineminus">-    let flags = {system: true};</span>
<a href="#l80.247"></a><span id="l80.247" class="difflineminus">-    if (aIsError)</span>
<a href="#l80.248"></a><span id="l80.248" class="difflineplus">+    let flags = { system: true };</span>
<a href="#l80.249"></a><span id="l80.249" class="difflineplus">+    if (aIsError) {</span>
<a href="#l80.250"></a><span id="l80.250">       flags.error = true;</span>
<a href="#l80.251"></a><span id="l80.251" class="difflineminus">-    if (aDate)</span>
<a href="#l80.252"></a><span id="l80.252" class="difflineplus">+    }</span>
<a href="#l80.253"></a><span id="l80.253" class="difflineplus">+    if (aDate) {</span>
<a href="#l80.254"></a><span id="l80.254">       flags.time = aDate;</span>
<a href="#l80.255"></a><span id="l80.255" class="difflineplus">+    }</span>
<a href="#l80.256"></a><span id="l80.256">     this.writeMessage(&quot;twitter.com&quot;, aMessage, flags);</span>
<a href="#l80.257"></a><span id="l80.257">   },</span>
<a href="#l80.258"></a><span id="l80.258">   onSentCallback(aMsg, aData) {</span>
<a href="#l80.259"></a><span id="l80.259">     // The conversation may have been uninitialized in the time it takes for</span>
<a href="#l80.260"></a><span id="l80.260">     // the async callback to fire.  Use `_observers` as a proxy for uninit'd.</span>
<a href="#l80.261"></a><span id="l80.261" class="difflineminus">-    if (!this._observers)</span>
<a href="#l80.262"></a><span id="l80.262" class="difflineplus">+    if (!this._observers) {</span>
<a href="#l80.263"></a><span id="l80.263">       return;</span>
<a href="#l80.264"></a><span id="l80.264" class="difflineplus">+    }</span>
<a href="#l80.265"></a><span id="l80.265"> </span>
<a href="#l80.266"></a><span id="l80.266">     let tweet = JSON.parse(aData);</span>
<a href="#l80.267"></a><span id="l80.267">     // The OTR extension requires that the protocol not modify the message</span>
<a href="#l80.268"></a><span id="l80.268">     // (see the notes at `imIOutgoingMessage`).  That's the contract we made.</span>
<a href="#l80.269"></a><span id="l80.269">     // Unfortunately, Twitter trims tweets and substitutes links.</span>
<a href="#l80.270"></a><span id="l80.270">     tweet.text = aMsg;</span>
<a href="#l80.271"></a><span id="l80.271">     this.displayMessages([tweet]);</span>
<a href="#l80.272"></a><span id="l80.272">   },</span>
<a href="#l80.273"></a><span id="l80.273">   prepareForDisplaying(aMsg) {</span>
<a href="#l80.274"></a><span id="l80.274" class="difflineminus">-    if (!this._tweets.has(aMsg.id))</span>
<a href="#l80.275"></a><span id="l80.275" class="difflineplus">+    if (!this._tweets.has(aMsg.id)) {</span>
<a href="#l80.276"></a><span id="l80.276">       return;</span>
<a href="#l80.277"></a><span id="l80.277" class="difflineplus">+    }</span>
<a href="#l80.278"></a><span id="l80.278">     let tweet = this._tweets.get(aMsg.id)._tweet;</span>
<a href="#l80.279"></a><span id="l80.279">     this._tweets.delete(aMsg.id);</span>
<a href="#l80.280"></a><span id="l80.280"> </span>
<a href="#l80.281"></a><span id="l80.281">     let text = aMsg.displayMessage;</span>
<a href="#l80.282"></a><span id="l80.282">     let entities = {};</span>
<a href="#l80.283"></a><span id="l80.283"> </span>
<a href="#l80.284"></a><span id="l80.284">     // Handle retweets: retweeted_status contains the object for the original</span>
<a href="#l80.285"></a><span id="l80.285">     // tweet that is being retweeted.</span>
<a href="#l80.286"></a><span id="l80.286">     // If the retweet prefix (&quot;RT @&lt;username&gt;: &quot;) causes the tweet to be over</span>
<a href="#l80.287"></a><span id="l80.287">     // 140 characters, ellipses will be added. In this case, we want to get</span>
<a href="#l80.288"></a><span id="l80.288">     // the FULL text from the original tweet and update the entities to match.</span>
<a href="#l80.289"></a><span id="l80.289">     // Note: the truncated flag is not always set correctly by twitter, so we</span>
<a href="#l80.290"></a><span id="l80.290">     // always make use of the original tweet.</span>
<a href="#l80.291"></a><span id="l80.291">     if (&quot;retweeted_status&quot; in tweet) {</span>
<a href="#l80.292"></a><span id="l80.292">       let retweet = tweet.retweeted_status;</span>
<a href="#l80.293"></a><span id="l80.293" class="difflineminus">-      let retweetText, retweetEntities = {};</span>
<a href="#l80.294"></a><span id="l80.294" class="difflineplus">+      let retweetText,</span>
<a href="#l80.295"></a><span id="l80.295" class="difflineplus">+        retweetEntities = {};</span>
<a href="#l80.296"></a><span id="l80.296"> </span>
<a href="#l80.297"></a><span id="l80.297">       if (&quot;extended_tweet&quot; in retweet) {</span>
<a href="#l80.298"></a><span id="l80.298">         // Note that if an extended tweet is retweeted, only the</span>
<a href="#l80.299"></a><span id="l80.299">         // retweeted_status part will be extended, not the tweet itself.</span>
<a href="#l80.300"></a><span id="l80.300">         let extended = retweet.extended_tweet;</span>
<a href="#l80.301"></a><span id="l80.301">         retweetText = extended.full_text;</span>
<a href="#l80.302"></a><span id="l80.302" class="difflineminus">-        if (&quot;entities&quot; in extended)</span>
<a href="#l80.303"></a><span id="l80.303" class="difflineplus">+        if (&quot;entities&quot; in extended) {</span>
<a href="#l80.304"></a><span id="l80.304">           retweetEntities = extended.entities;</span>
<a href="#l80.305"></a><span id="l80.305" class="difflineminus">-      }</span>
<a href="#l80.306"></a><span id="l80.306" class="difflineminus">-      else {</span>
<a href="#l80.307"></a><span id="l80.307" class="difflineplus">+        }</span>
<a href="#l80.308"></a><span id="l80.308" class="difflineplus">+      } else {</span>
<a href="#l80.309"></a><span id="l80.309">         retweetText = retweet.text;</span>
<a href="#l80.310"></a><span id="l80.310" class="difflineminus">-        if (&quot;entities&quot; in retweet)</span>
<a href="#l80.311"></a><span id="l80.311" class="difflineplus">+        if (&quot;entities&quot; in retweet) {</span>
<a href="#l80.312"></a><span id="l80.312">           retweetEntities = retweet.entities;</span>
<a href="#l80.313"></a><span id="l80.313" class="difflineplus">+        }</span>
<a href="#l80.314"></a><span id="l80.314">       }</span>
<a href="#l80.315"></a><span id="l80.315"> </span>
<a href="#l80.316"></a><span id="l80.316">       // We're going to take portions of the retweeted status and replace parts</span>
<a href="#l80.317"></a><span id="l80.317">       // of the original tweet, the retweeted status prepends the original</span>
<a href="#l80.318"></a><span id="l80.318">       // status with &quot;RT @&lt;username&gt;: &quot;, we need to keep the prefix.</span>
<a href="#l80.319"></a><span id="l80.319">       // Note: this doesn't play nice with extensions that may have altered</span>
<a href="#l80.320"></a><span id="l80.320">       // `text` to this point, but at least OTR doesn't act on `isChat`.</span>
<a href="#l80.321"></a><span id="l80.321">       let offset = text.indexOf(&quot;: &quot;) + 2;</span>
<a href="#l80.322"></a><span id="l80.322">       text = text.slice(0, offset) + retweetText;</span>
<a href="#l80.323"></a><span id="l80.323"> </span>
<a href="#l80.324"></a><span id="l80.324">       // Keep any entities that refer to the prefix (we can refer directly to</span>
<a href="#l80.325"></a><span id="l80.325">       // the tweet for these since they are not edited).</span>
<a href="#l80.326"></a><span id="l80.326">       if (&quot;entities&quot; in tweet) {</span>
<a href="#l80.327"></a><span id="l80.327">         for (let type in tweet.entities) {</span>
<a href="#l80.328"></a><span id="l80.328" class="difflineminus">-          let filteredEntities =</span>
<a href="#l80.329"></a><span id="l80.329" class="difflineminus">-            tweet.entities[type].filter(e =&gt; e.indices[0] &lt; offset);</span>
<a href="#l80.330"></a><span id="l80.330" class="difflineminus">-          if (filteredEntities.length)</span>
<a href="#l80.331"></a><span id="l80.331" class="difflineplus">+          let filteredEntities = tweet.entities[type].filter(</span>
<a href="#l80.332"></a><span id="l80.332" class="difflineplus">+            e =&gt; e.indices[0] &lt; offset</span>
<a href="#l80.333"></a><span id="l80.333" class="difflineplus">+          );</span>
<a href="#l80.334"></a><span id="l80.334" class="difflineplus">+          if (filteredEntities.length) {</span>
<a href="#l80.335"></a><span id="l80.335">             entities[type] = filteredEntities;</span>
<a href="#l80.336"></a><span id="l80.336" class="difflineplus">+          }</span>
<a href="#l80.337"></a><span id="l80.337">         }</span>
<a href="#l80.338"></a><span id="l80.338">       }</span>
<a href="#l80.339"></a><span id="l80.339"> </span>
<a href="#l80.340"></a><span id="l80.340">       // Add the entities from the retweet (a copy of these must be made since</span>
<a href="#l80.341"></a><span id="l80.341">       // they will be edited and we do not wish to change the tweet).</span>
<a href="#l80.342"></a><span id="l80.342">       for (let type in retweetEntities) {</span>
<a href="#l80.343"></a><span id="l80.343" class="difflineminus">-        if (!(type in entities))</span>
<a href="#l80.344"></a><span id="l80.344" class="difflineplus">+        if (!(type in entities)) {</span>
<a href="#l80.345"></a><span id="l80.345">           entities[type] = [];</span>
<a href="#l80.346"></a><span id="l80.346" class="difflineplus">+        }</span>
<a href="#l80.347"></a><span id="l80.347"> </span>
<a href="#l80.348"></a><span id="l80.348">         // Append the entities from the original status.</span>
<a href="#l80.349"></a><span id="l80.349">         entities[type] = entities[type].concat(</span>
<a href="#l80.350"></a><span id="l80.350">           retweetEntities[type].map(function(aEntity) {</span>
<a href="#l80.351"></a><span id="l80.351">             let entity = Object.create(aEntity);</span>
<a href="#l80.352"></a><span id="l80.352">             // Add the offset to the indices to account for the prefix.</span>
<a href="#l80.353"></a><span id="l80.353">             entity.indices = entity.indices.map(i =&gt; i + offset);</span>
<a href="#l80.354"></a><span id="l80.354">             return entity;</span>
<a href="#l80.355"></a><span id="l80.355">           })</span>
<a href="#l80.356"></a><span id="l80.356">         );</span>
<a href="#l80.357"></a><span id="l80.357">       }</span>
<a href="#l80.358"></a><span id="l80.358">     } else if (&quot;extended_tweet&quot; in tweet) {</span>
<a href="#l80.359"></a><span id="l80.359">       // Bare bones extended tweet handling.</span>
<a href="#l80.360"></a><span id="l80.360">       let extended = tweet.extended_tweet;</span>
<a href="#l80.361"></a><span id="l80.361">       text = extended.full_text;</span>
<a href="#l80.362"></a><span id="l80.362" class="difflineminus">-      if (&quot;entities&quot; in extended)</span>
<a href="#l80.363"></a><span id="l80.363" class="difflineplus">+      if (&quot;entities&quot; in extended) {</span>
<a href="#l80.364"></a><span id="l80.364">         entities = extended.entities;</span>
<a href="#l80.365"></a><span id="l80.365" class="difflineplus">+      }</span>
<a href="#l80.366"></a><span id="l80.366">     } else if (&quot;entities&quot; in tweet) {</span>
<a href="#l80.367"></a><span id="l80.367">       // For non-retweets, we just want to use the entities that are given.</span>
<a href="#l80.368"></a><span id="l80.368">       entities = tweet.entities;</span>
<a href="#l80.369"></a><span id="l80.369">     }</span>
<a href="#l80.370"></a><span id="l80.370"> </span>
<a href="#l80.371"></a><span id="l80.371">     this._account.LOG(&quot;Tweet: &quot; + text);</span>
<a href="#l80.372"></a><span id="l80.372"> </span>
<a href="#l80.373"></a><span id="l80.373">     aMsg.displayMessage = twttr.txt.autoLink(text, {</span>
<a href="#l80.374"></a><span id="l80.374" class="difflineat">@@ -279,65 +333,75 @@ var GenericTwitterConversation = {</span>
<a href="#l80.375"></a><span id="l80.375">       }),</span>
<a href="#l80.376"></a><span id="l80.376">     });</span>
<a href="#l80.377"></a><span id="l80.377"> </span>
<a href="#l80.378"></a><span id="l80.378">     GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l80.379"></a><span id="l80.379">   },</span>
<a href="#l80.380"></a><span id="l80.380">   displayTweet(aTweet, aUser) {</span>
<a href="#l80.381"></a><span id="l80.381">     let name = aUser.screen_name;</span>
<a href="#l80.382"></a><span id="l80.382"> </span>
<a href="#l80.383"></a><span id="l80.383" class="difflineminus">-    let flags = name == this.nick ? {outgoing: true} : {incoming: true};</span>
<a href="#l80.384"></a><span id="l80.384" class="difflineplus">+    let flags = name == this.nick ? { outgoing: true } : { incoming: true };</span>
<a href="#l80.385"></a><span id="l80.385">     flags.time = Math.floor(new Date(aTweet.created_at) / 1000);</span>
<a href="#l80.386"></a><span id="l80.386">     flags._iconURL = aUser.profile_image_url;</span>
<a href="#l80.387"></a><span id="l80.387" class="difflineminus">-    if (aTweet.delayed)</span>
<a href="#l80.388"></a><span id="l80.388" class="difflineplus">+    if (aTweet.delayed) {</span>
<a href="#l80.389"></a><span id="l80.389">       flags.delayed = true;</span>
<a href="#l80.390"></a><span id="l80.390" class="difflineminus">-    if (aTweet.entities &amp;&amp; aTweet.entities.user_mentions &amp;&amp;</span>
<a href="#l80.391"></a><span id="l80.391" class="difflineminus">-        Array.isArray(aTweet.entities.user_mentions) &amp;&amp;</span>
<a href="#l80.392"></a><span id="l80.392" class="difflineminus">-        aTweet.entities.user_mentions.some(mention =&gt; mention.screen_name == this.nick))</span>
<a href="#l80.393"></a><span id="l80.393" class="difflineplus">+    }</span>
<a href="#l80.394"></a><span id="l80.394" class="difflineplus">+    if (</span>
<a href="#l80.395"></a><span id="l80.395" class="difflineplus">+      aTweet.entities &amp;&amp;</span>
<a href="#l80.396"></a><span id="l80.396" class="difflineplus">+      aTweet.entities.user_mentions &amp;&amp;</span>
<a href="#l80.397"></a><span id="l80.397" class="difflineplus">+      Array.isArray(aTweet.entities.user_mentions) &amp;&amp;</span>
<a href="#l80.398"></a><span id="l80.398" class="difflineplus">+      aTweet.entities.user_mentions.some(</span>
<a href="#l80.399"></a><span id="l80.399" class="difflineplus">+        mention =&gt; mention.screen_name == this.nick</span>
<a href="#l80.400"></a><span id="l80.400" class="difflineplus">+      )</span>
<a href="#l80.401"></a><span id="l80.401" class="difflineplus">+    ) {</span>
<a href="#l80.402"></a><span id="l80.402">       flags.containsNick = true;</span>
<a href="#l80.403"></a><span id="l80.403" class="difflineplus">+    }</span>
<a href="#l80.404"></a><span id="l80.404"> </span>
<a href="#l80.405"></a><span id="l80.405">     let tweet = new Tweet(aTweet, name, aTweet.text, flags);</span>
<a href="#l80.406"></a><span id="l80.406">     this._tweets.set(tweet.id, tweet);</span>
<a href="#l80.407"></a><span id="l80.407">     tweet.conversation = this;</span>
<a href="#l80.408"></a><span id="l80.408">   },</span>
<a href="#l80.409"></a><span id="l80.409">   _parseError(aData) {</span>
<a href="#l80.410"></a><span id="l80.410">     let error = &quot;&quot;;</span>
<a href="#l80.411"></a><span id="l80.411">     try {</span>
<a href="#l80.412"></a><span id="l80.412">       let data = JSON.parse(aData);</span>
<a href="#l80.413"></a><span id="l80.413" class="difflineminus">-      if (&quot;error&quot; in data)</span>
<a href="#l80.414"></a><span id="l80.414" class="difflineplus">+      if (&quot;error&quot; in data) {</span>
<a href="#l80.415"></a><span id="l80.415">         error = data.error;</span>
<a href="#l80.416"></a><span id="l80.416" class="difflineminus">-      else if (&quot;errors&quot; in data)</span>
<a href="#l80.417"></a><span id="l80.417" class="difflineplus">+      } else if (&quot;errors&quot; in data) {</span>
<a href="#l80.418"></a><span id="l80.418">         error = data.errors[0].message;</span>
<a href="#l80.419"></a><span id="l80.419" class="difflineminus">-      if (error)</span>
<a href="#l80.420"></a><span id="l80.420" class="difflineplus">+      }</span>
<a href="#l80.421"></a><span id="l80.421" class="difflineplus">+      if (error) {</span>
<a href="#l80.422"></a><span id="l80.422">         error = &quot;(&quot; + error + &quot;)&quot;;</span>
<a href="#l80.423"></a><span id="l80.423" class="difflineplus">+      }</span>
<a href="#l80.424"></a><span id="l80.424">     } catch (e) {}</span>
<a href="#l80.425"></a><span id="l80.425">     return error;</span>
<a href="#l80.426"></a><span id="l80.426">   },</span>
<a href="#l80.427"></a><span id="l80.427" class="difflineminus">-  getNormalizedChatBuddyName: (aNick) =&gt; aNick.replace(/^@/, &quot;&quot;),</span>
<a href="#l80.428"></a><span id="l80.428" class="difflineplus">+  getNormalizedChatBuddyName: aNick =&gt; aNick.replace(/^@/, &quot;&quot;),</span>
<a href="#l80.429"></a><span id="l80.429"> };</span>
<a href="#l80.430"></a><span id="l80.430"> </span>
<a href="#l80.431"></a><span id="l80.431" class="difflineminus">-function TimelineConversation(aAccount)</span>
<a href="#l80.432"></a><span id="l80.432" class="difflineminus">-{</span>
<a href="#l80.433"></a><span id="l80.433" class="difflineplus">+function TimelineConversation(aAccount) {</span>
<a href="#l80.434"></a><span id="l80.434">   this._init(aAccount);</span>
<a href="#l80.435"></a><span id="l80.435">   this._ensureParticipantExists(aAccount.name);</span>
<a href="#l80.436"></a><span id="l80.436">   // We need the screen names for the IDs in _friends, but _userInfo is</span>
<a href="#l80.437"></a><span id="l80.437">   // indexed by name, so we build an ID -&gt; name map.</span>
<a href="#l80.438"></a><span id="l80.438">   let entries = [];</span>
<a href="#l80.439"></a><span id="l80.439">   for (let [name, userInfo] of aAccount._userInfo) {</span>
<a href="#l80.440"></a><span id="l80.440">     entries.push([userInfo.id_str, name]);</span>
<a href="#l80.441"></a><span id="l80.441">   }</span>
<a href="#l80.442"></a><span id="l80.442">   let names = new Map(entries);</span>
<a href="#l80.443"></a><span id="l80.443" class="difflineminus">-  for (let id_str of aAccount._friends)</span>
<a href="#l80.444"></a><span id="l80.444" class="difflineplus">+  for (let id_str of aAccount._friends) {</span>
<a href="#l80.445"></a><span id="l80.445">     this._ensureParticipantExists(names.get(id_str));</span>
<a href="#l80.446"></a><span id="l80.446" class="difflineplus">+  }</span>
<a href="#l80.447"></a><span id="l80.447"> </span>
<a href="#l80.448"></a><span id="l80.448">   // If the user's info has already been received, update the timeline topic.</span>
<a href="#l80.449"></a><span id="l80.449">   if (aAccount._userInfo.has(aAccount.name)) {</span>
<a href="#l80.450"></a><span id="l80.450">     let userInfo = aAccount._userInfo.get(aAccount.name);</span>
<a href="#l80.451"></a><span id="l80.451" class="difflineminus">-    if (&quot;description&quot; in userInfo)</span>
<a href="#l80.452"></a><span id="l80.452" class="difflineplus">+    if (&quot;description&quot; in userInfo) {</span>
<a href="#l80.453"></a><span id="l80.453">       this.setTopic(userInfo.description, aAccount.name, true);</span>
<a href="#l80.454"></a><span id="l80.454" class="difflineplus">+    }</span>
<a href="#l80.455"></a><span id="l80.455">   }</span>
<a href="#l80.456"></a><span id="l80.456"> </span>
<a href="#l80.457"></a><span id="l80.457">   // Store messages by message id.</span>
<a href="#l80.458"></a><span id="l80.458">   this._tweets = new Map();</span>
<a href="#l80.459"></a><span id="l80.459"> }</span>
<a href="#l80.460"></a><span id="l80.460"> TimelineConversation.prototype = {</span>
<a href="#l80.461"></a><span id="l80.461">   __proto__: GenericConvChatPrototype,</span>
<a href="#l80.462"></a><span id="l80.462">   unInit() {</span>
<a href="#l80.463"></a><span id="l80.463" class="difflineat">@@ -347,154 +411,204 @@ TimelineConversation.prototype = {</span>
<a href="#l80.464"></a><span id="l80.464">   inReplyToStatusId: null,</span>
<a href="#l80.465"></a><span id="l80.465">   startReply(aTweet) {</span>
<a href="#l80.466"></a><span id="l80.466">     this.inReplyToStatusId = aTweet.id_str;</span>
<a href="#l80.467"></a><span id="l80.467">     let entities = aTweet.entities;</span>
<a href="#l80.468"></a><span id="l80.468"> </span>
<a href="#l80.469"></a><span id="l80.469">     // Twitter replies go to all the users mentioned in the tweet.</span>
<a href="#l80.470"></a><span id="l80.470">     let nicks = [aTweet.user.screen_name];</span>
<a href="#l80.471"></a><span id="l80.471">     if (&quot;user_mentions&quot; in entities &amp;&amp; Array.isArray(entities.user_mentions)) {</span>
<a href="#l80.472"></a><span id="l80.472" class="difflineminus">-      nicks = nicks.concat(entities.user_mentions</span>
<a href="#l80.473"></a><span id="l80.473" class="difflineminus">-                                   .map(um =&gt; um.screen_name));</span>
<a href="#l80.474"></a><span id="l80.474" class="difflineplus">+      nicks = nicks.concat(entities.user_mentions.map(um =&gt; um.screen_name));</span>
<a href="#l80.475"></a><span id="l80.475">     }</span>
<a href="#l80.476"></a><span id="l80.476">     // Ignore duplicates and the user's nick.</span>
<a href="#l80.477"></a><span id="l80.477">     let prompt =</span>
<a href="#l80.478"></a><span id="l80.478" class="difflineminus">-      nicks.filter(function(aNick, aPos) {</span>
<a href="#l80.479"></a><span id="l80.479" class="difflineminus">-             return nicks.indexOf(aNick) == aPos &amp;&amp; aNick != this._account.name;</span>
<a href="#l80.480"></a><span id="l80.480" class="difflineminus">-           }, this)</span>
<a href="#l80.481"></a><span id="l80.481" class="difflineminus">-           .map(aNick =&gt; &quot;@&quot; + aNick)</span>
<a href="#l80.482"></a><span id="l80.482" class="difflineminus">-           .join(&quot; &quot;) + &quot; &quot;;</span>
<a href="#l80.483"></a><span id="l80.483" class="difflineplus">+      nicks</span>
<a href="#l80.484"></a><span id="l80.484" class="difflineplus">+        .filter(function(aNick, aPos) {</span>
<a href="#l80.485"></a><span id="l80.485" class="difflineplus">+          return nicks.indexOf(aNick) == aPos &amp;&amp; aNick != this._account.name;</span>
<a href="#l80.486"></a><span id="l80.486" class="difflineplus">+        }, this)</span>
<a href="#l80.487"></a><span id="l80.487" class="difflineplus">+        .map(aNick =&gt; &quot;@&quot; + aNick)</span>
<a href="#l80.488"></a><span id="l80.488" class="difflineplus">+        .join(&quot; &quot;) + &quot; &quot;;</span>
<a href="#l80.489"></a><span id="l80.489"> </span>
<a href="#l80.490"></a><span id="l80.490">     this.notifyObservers(null, &quot;replying-to-prompt&quot;, prompt);</span>
<a href="#l80.491"></a><span id="l80.491" class="difflineminus">-    this.notifyObservers(null, &quot;status-text-changed&quot;,</span>
<a href="#l80.492"></a><span id="l80.492" class="difflineminus">-                         _(&quot;replyingToStatusText&quot;, aTweet.text));</span>
<a href="#l80.493"></a><span id="l80.493" class="difflineplus">+    this.notifyObservers(</span>
<a href="#l80.494"></a><span id="l80.494" class="difflineplus">+      null,</span>
<a href="#l80.495"></a><span id="l80.495" class="difflineplus">+      &quot;status-text-changed&quot;,</span>
<a href="#l80.496"></a><span id="l80.496" class="difflineplus">+      _(&quot;replyingToStatusText&quot;, aTweet.text)</span>
<a href="#l80.497"></a><span id="l80.497" class="difflineplus">+    );</span>
<a href="#l80.498"></a><span id="l80.498">   },</span>
<a href="#l80.499"></a><span id="l80.499">   reTweet(aTweet) {</span>
<a href="#l80.500"></a><span id="l80.500" class="difflineminus">-    this._account.reTweet(aTweet, null, function(aException, aData) {</span>
<a href="#l80.501"></a><span id="l80.501" class="difflineminus">-      this.systemMessage(_(&quot;error.retweet&quot;, this._parseError(aData),</span>
<a href="#l80.502"></a><span id="l80.502" class="difflineminus">-                           aTweet.text), true);</span>
<a href="#l80.503"></a><span id="l80.503" class="difflineminus">-    }, this);</span>
<a href="#l80.504"></a><span id="l80.504" class="difflineplus">+    this._account.reTweet(</span>
<a href="#l80.505"></a><span id="l80.505" class="difflineplus">+      aTweet,</span>
<a href="#l80.506"></a><span id="l80.506" class="difflineplus">+      null,</span>
<a href="#l80.507"></a><span id="l80.507" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l80.508"></a><span id="l80.508" class="difflineplus">+        this.systemMessage(</span>
<a href="#l80.509"></a><span id="l80.509" class="difflineplus">+          _(&quot;error.retweet&quot;, this._parseError(aData), aTweet.text),</span>
<a href="#l80.510"></a><span id="l80.510" class="difflineplus">+          true</span>
<a href="#l80.511"></a><span id="l80.511" class="difflineplus">+        );</span>
<a href="#l80.512"></a><span id="l80.512" class="difflineplus">+      },</span>
<a href="#l80.513"></a><span id="l80.513" class="difflineplus">+      this</span>
<a href="#l80.514"></a><span id="l80.514" class="difflineplus">+    );</span>
<a href="#l80.515"></a><span id="l80.515">   },</span>
<a href="#l80.516"></a><span id="l80.516">   sendMsg(aMsg) {</span>
<a href="#l80.517"></a><span id="l80.517">     let parsed = twttr.txt.parseTweet(aMsg);</span>
<a href="#l80.518"></a><span id="l80.518">     if (!parsed.valid) {</span>
<a href="#l80.519"></a><span id="l80.519">       this.systemMessage(_(&quot;error.tooLong&quot;), true);</span>
<a href="#l80.520"></a><span id="l80.520">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l80.521"></a><span id="l80.521">     }</span>
<a href="#l80.522"></a><span id="l80.522" class="difflineminus">-    this._account.tweet(aMsg, this.inReplyToStatusId,</span>
<a href="#l80.523"></a><span id="l80.523" class="difflineminus">-                        this.onSentCallback.bind(this, aMsg),</span>
<a href="#l80.524"></a><span id="l80.524" class="difflineminus">-                        function(aException, aData) {</span>
<a href="#l80.525"></a><span id="l80.525" class="difflineminus">-      let error = this._parseError(aData);</span>
<a href="#l80.526"></a><span id="l80.526" class="difflineminus">-      this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l80.527"></a><span id="l80.527" class="difflineminus">-    }, this);</span>
<a href="#l80.528"></a><span id="l80.528" class="difflineplus">+    this._account.tweet(</span>
<a href="#l80.529"></a><span id="l80.529" class="difflineplus">+      aMsg,</span>
<a href="#l80.530"></a><span id="l80.530" class="difflineplus">+      this.inReplyToStatusId,</span>
<a href="#l80.531"></a><span id="l80.531" class="difflineplus">+      this.onSentCallback.bind(this, aMsg),</span>
<a href="#l80.532"></a><span id="l80.532" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l80.533"></a><span id="l80.533" class="difflineplus">+        let error = this._parseError(aData);</span>
<a href="#l80.534"></a><span id="l80.534" class="difflineplus">+        this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l80.535"></a><span id="l80.535" class="difflineplus">+      },</span>
<a href="#l80.536"></a><span id="l80.536" class="difflineplus">+      this</span>
<a href="#l80.537"></a><span id="l80.537" class="difflineplus">+    );</span>
<a href="#l80.538"></a><span id="l80.538">     this.sendTyping(&quot;&quot;);</span>
<a href="#l80.539"></a><span id="l80.539">   },</span>
<a href="#l80.540"></a><span id="l80.540">   like(aTweet, aRemoveLike = false) {</span>
<a href="#l80.541"></a><span id="l80.541" class="difflineminus">-    this._account.like(aTweet, aRemoveLike, function() {</span>
<a href="#l80.542"></a><span id="l80.542" class="difflineminus">-      aTweet.favorited = !aRemoveLike;</span>
<a href="#l80.543"></a><span id="l80.543" class="difflineminus">-    }, function(aException, aData) {</span>
<a href="#l80.544"></a><span id="l80.544" class="difflineminus">-      const messageName = aRemoveLike ? &quot;unlike&quot; : &quot;like&quot;;</span>
<a href="#l80.545"></a><span id="l80.545" class="difflineminus">-      this.systemMessage(_(&quot;error.&quot; + messageName,</span>
<a href="#l80.546"></a><span id="l80.546" class="difflineminus">-                          this.parseError(aData), aTweet.text), true);</span>
<a href="#l80.547"></a><span id="l80.547" class="difflineminus">-    }, this);</span>
<a href="#l80.548"></a><span id="l80.548" class="difflineplus">+    this._account.like(</span>
<a href="#l80.549"></a><span id="l80.549" class="difflineplus">+      aTweet,</span>
<a href="#l80.550"></a><span id="l80.550" class="difflineplus">+      aRemoveLike,</span>
<a href="#l80.551"></a><span id="l80.551" class="difflineplus">+      function() {</span>
<a href="#l80.552"></a><span id="l80.552" class="difflineplus">+        aTweet.favorited = !aRemoveLike;</span>
<a href="#l80.553"></a><span id="l80.553" class="difflineplus">+      },</span>
<a href="#l80.554"></a><span id="l80.554" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l80.555"></a><span id="l80.555" class="difflineplus">+        const messageName = aRemoveLike ? &quot;unlike&quot; : &quot;like&quot;;</span>
<a href="#l80.556"></a><span id="l80.556" class="difflineplus">+        this.systemMessage(</span>
<a href="#l80.557"></a><span id="l80.557" class="difflineplus">+          _(&quot;error.&quot; + messageName, this.parseError(aData), aTweet.text),</span>
<a href="#l80.558"></a><span id="l80.558" class="difflineplus">+          true</span>
<a href="#l80.559"></a><span id="l80.559" class="difflineplus">+        );</span>
<a href="#l80.560"></a><span id="l80.560" class="difflineplus">+      },</span>
<a href="#l80.561"></a><span id="l80.561" class="difflineplus">+      this</span>
<a href="#l80.562"></a><span id="l80.562" class="difflineplus">+    );</span>
<a href="#l80.563"></a><span id="l80.563">   },</span>
<a href="#l80.564"></a><span id="l80.564">   sendTyping(aString) {</span>
<a href="#l80.565"></a><span id="l80.565">     let maxlen = twttr.txt.configs.defaults.maxWeightedTweetLength;</span>
<a href="#l80.566"></a><span id="l80.566">     if (aString.length == 0 &amp;&amp; this.inReplyToStatusId) {</span>
<a href="#l80.567"></a><span id="l80.567">       delete this.inReplyToStatusId;</span>
<a href="#l80.568"></a><span id="l80.568">       this.notifyObservers(null, &quot;status-text-changed&quot;);</span>
<a href="#l80.569"></a><span id="l80.569">       return maxlen;</span>
<a href="#l80.570"></a><span id="l80.570">     }</span>
<a href="#l80.571"></a><span id="l80.571">     return maxlen - this.getTweetLength(aString);</span>
<a href="#l80.572"></a><span id="l80.572">   },</span>
<a href="#l80.573"></a><span id="l80.573">   displayMessages(aMessages) {</span>
<a href="#l80.574"></a><span id="l80.574">     let account = this._account;</span>
<a href="#l80.575"></a><span id="l80.575">     let lastMsgId = account._lastMsgId;</span>
<a href="#l80.576"></a><span id="l80.576">     for (let tweet of aMessages) {</span>
<a href="#l80.577"></a><span id="l80.577" class="difflineminus">-      if (!(&quot;user&quot; in tweet) || !(&quot;text&quot; in tweet) || !(&quot;id_str&quot; in tweet) ||</span>
<a href="#l80.578"></a><span id="l80.578" class="difflineminus">-          account._knownMessageIds.has(tweet.id_str))</span>
<a href="#l80.579"></a><span id="l80.579" class="difflineplus">+      if (</span>
<a href="#l80.580"></a><span id="l80.580" class="difflineplus">+        !(&quot;user&quot; in tweet) ||</span>
<a href="#l80.581"></a><span id="l80.581" class="difflineplus">+        !(&quot;text&quot; in tweet) ||</span>
<a href="#l80.582"></a><span id="l80.582" class="difflineplus">+        !(&quot;id_str&quot; in tweet) ||</span>
<a href="#l80.583"></a><span id="l80.583" class="difflineplus">+        account._knownMessageIds.has(tweet.id_str)</span>
<a href="#l80.584"></a><span id="l80.584" class="difflineplus">+      ) {</span>
<a href="#l80.585"></a><span id="l80.585">         continue;</span>
<a href="#l80.586"></a><span id="l80.586" class="difflineplus">+      }</span>
<a href="#l80.587"></a><span id="l80.587">       let id = tweet.id_str;</span>
<a href="#l80.588"></a><span id="l80.588">       // Update the last known message.</span>
<a href="#l80.589"></a><span id="l80.589">       // Compare the length of the ids first, and then the text.</span>
<a href="#l80.590"></a><span id="l80.590">       // This avoids converting tweet ids into rounded numbers.</span>
<a href="#l80.591"></a><span id="l80.591" class="difflineminus">-      if (id.length &gt; lastMsgId.length ||</span>
<a href="#l80.592"></a><span id="l80.592" class="difflineminus">-          (id.length == lastMsgId.length &amp;&amp; id &gt; lastMsgId))</span>
<a href="#l80.593"></a><span id="l80.593" class="difflineplus">+      if (</span>
<a href="#l80.594"></a><span id="l80.594" class="difflineplus">+        id.length &gt; lastMsgId.length ||</span>
<a href="#l80.595"></a><span id="l80.595" class="difflineplus">+        (id.length == lastMsgId.length &amp;&amp; id &gt; lastMsgId)</span>
<a href="#l80.596"></a><span id="l80.596" class="difflineplus">+      ) {</span>
<a href="#l80.597"></a><span id="l80.597">         lastMsgId = id;</span>
<a href="#l80.598"></a><span id="l80.598" class="difflineplus">+      }</span>
<a href="#l80.599"></a><span id="l80.599">       account._knownMessageIds.add(id);</span>
<a href="#l80.600"></a><span id="l80.600">       account.setUserInfo(tweet.user);</span>
<a href="#l80.601"></a><span id="l80.601">       this._ensureParticipantExists(tweet.user.screen_name);</span>
<a href="#l80.602"></a><span id="l80.602">       this.displayTweet(tweet, tweet.user);</span>
<a href="#l80.603"></a><span id="l80.603">     }</span>
<a href="#l80.604"></a><span id="l80.604">     if (lastMsgId != account._lastMsgId) {</span>
<a href="#l80.605"></a><span id="l80.605">       account._lastMsgId = lastMsgId;</span>
<a href="#l80.606"></a><span id="l80.606">       account.prefs.setCharPref(&quot;lastMessageId&quot;, account._lastMsgId);</span>
<a href="#l80.607"></a><span id="l80.607">     }</span>
<a href="#l80.608"></a><span id="l80.608">   },</span>
<a href="#l80.609"></a><span id="l80.609">   _ensureParticipantExists(aNick) {</span>
<a href="#l80.610"></a><span id="l80.610" class="difflineminus">-    if (this._participants.has(aNick))</span>
<a href="#l80.611"></a><span id="l80.611" class="difflineplus">+    if (this._participants.has(aNick)) {</span>
<a href="#l80.612"></a><span id="l80.612">       return;</span>
<a href="#l80.613"></a><span id="l80.613" class="difflineplus">+    }</span>
<a href="#l80.614"></a><span id="l80.614"> </span>
<a href="#l80.615"></a><span id="l80.615">     let chatBuddy = new ChatBuddy(aNick, this._account);</span>
<a href="#l80.616"></a><span id="l80.616">     this._participants.set(aNick, chatBuddy);</span>
<a href="#l80.617"></a><span id="l80.617" class="difflineminus">-    this.notifyObservers(new nsSimpleEnumerator([chatBuddy]),</span>
<a href="#l80.618"></a><span id="l80.618" class="difflineminus">-                         &quot;chat-buddy-add&quot;);</span>
<a href="#l80.619"></a><span id="l80.619" class="difflineplus">+    this.notifyObservers(new nsSimpleEnumerator([chatBuddy]), &quot;chat-buddy-add&quot;);</span>
<a href="#l80.620"></a><span id="l80.620" class="difflineplus">+  },</span>
<a href="#l80.621"></a><span id="l80.621" class="difflineplus">+  get name() {</span>
<a href="#l80.622"></a><span id="l80.622" class="difflineplus">+    return this.nick + &quot; timeline&quot;;</span>
<a href="#l80.623"></a><span id="l80.623" class="difflineplus">+  },</span>
<a href="#l80.624"></a><span id="l80.624" class="difflineplus">+  get title() {</span>
<a href="#l80.625"></a><span id="l80.625" class="difflineplus">+    return _(&quot;timeline&quot;, this.nick);</span>
<a href="#l80.626"></a><span id="l80.626" class="difflineplus">+  },</span>
<a href="#l80.627"></a><span id="l80.627" class="difflineplus">+  get nick() {</span>
<a href="#l80.628"></a><span id="l80.628" class="difflineplus">+    return this._account.name;</span>
<a href="#l80.629"></a><span id="l80.629">   },</span>
<a href="#l80.630"></a><span id="l80.630" class="difflineminus">-  get name() { return this.nick + &quot; timeline&quot;; },</span>
<a href="#l80.631"></a><span id="l80.631" class="difflineminus">-  get title() { return _(&quot;timeline&quot;, this.nick); },</span>
<a href="#l80.632"></a><span id="l80.632" class="difflineminus">-  get nick() { return this._account.name; },</span>
<a href="#l80.633"></a><span id="l80.633">   set nick(aNick) {},</span>
<a href="#l80.634"></a><span id="l80.634" class="difflineminus">-  get topicSettable() { return this.nick == this._account.name; },</span>
<a href="#l80.635"></a><span id="l80.635" class="difflineminus">-  get topic() { return this._topic; }, // can't add a setter without redefining the getter</span>
<a href="#l80.636"></a><span id="l80.636" class="difflineplus">+  get topicSettable() {</span>
<a href="#l80.637"></a><span id="l80.637" class="difflineplus">+    return this.nick == this._account.name;</span>
<a href="#l80.638"></a><span id="l80.638" class="difflineplus">+  },</span>
<a href="#l80.639"></a><span id="l80.639" class="difflineplus">+  get topic() {</span>
<a href="#l80.640"></a><span id="l80.640" class="difflineplus">+    return this._topic;</span>
<a href="#l80.641"></a><span id="l80.641" class="difflineplus">+  }, // can't add a setter without redefining the getter</span>
<a href="#l80.642"></a><span id="l80.642">   set topic(aTopic) {</span>
<a href="#l80.643"></a><span id="l80.643" class="difflineminus">-    if (this.topicSettable)</span>
<a href="#l80.644"></a><span id="l80.644" class="difflineplus">+    if (this.topicSettable) {</span>
<a href="#l80.645"></a><span id="l80.645">       this._account.setUserDescription(aTopic);</span>
<a href="#l80.646"></a><span id="l80.646" class="difflineplus">+    }</span>
<a href="#l80.647"></a><span id="l80.647">   },</span>
<a href="#l80.648"></a><span id="l80.648"> };</span>
<a href="#l80.649"></a><span id="l80.649"> Object.assign(TimelineConversation.prototype, GenericTwitterConversation);</span>
<a href="#l80.650"></a><span id="l80.650"> </span>
<a href="#l80.651"></a><span id="l80.651" class="difflineminus">-function DirectMessageConversation(aAccount, aName)</span>
<a href="#l80.652"></a><span id="l80.652" class="difflineminus">-{</span>
<a href="#l80.653"></a><span id="l80.653" class="difflineplus">+function DirectMessageConversation(aAccount, aName) {</span>
<a href="#l80.654"></a><span id="l80.654">   this._init(aAccount, aName);</span>
<a href="#l80.655"></a><span id="l80.655"> </span>
<a href="#l80.656"></a><span id="l80.656">   // Store messages by message id.</span>
<a href="#l80.657"></a><span id="l80.657">   this._tweets = new Map();</span>
<a href="#l80.658"></a><span id="l80.658"> }</span>
<a href="#l80.659"></a><span id="l80.659"> DirectMessageConversation.prototype = {</span>
<a href="#l80.660"></a><span id="l80.660">   __proto__: GenericConvIMPrototype,</span>
<a href="#l80.661"></a><span id="l80.661">   sendMsg(aMsg) {</span>
<a href="#l80.662"></a><span id="l80.662" class="difflineminus">-    this._account.directMessage(aMsg, this.name,</span>
<a href="#l80.663"></a><span id="l80.663" class="difflineminus">-                                this.onSentCallback.bind(this, aMsg),</span>
<a href="#l80.664"></a><span id="l80.664" class="difflineminus">-                                function(aException, aData) {</span>
<a href="#l80.665"></a><span id="l80.665" class="difflineminus">-      let error = this._parseError(aData);</span>
<a href="#l80.666"></a><span id="l80.666" class="difflineminus">-      this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l80.667"></a><span id="l80.667" class="difflineminus">-    }, this);</span>
<a href="#l80.668"></a><span id="l80.668" class="difflineplus">+    this._account.directMessage(</span>
<a href="#l80.669"></a><span id="l80.669" class="difflineplus">+      aMsg,</span>
<a href="#l80.670"></a><span id="l80.670" class="difflineplus">+      this.name,</span>
<a href="#l80.671"></a><span id="l80.671" class="difflineplus">+      this.onSentCallback.bind(this, aMsg),</span>
<a href="#l80.672"></a><span id="l80.672" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l80.673"></a><span id="l80.673" class="difflineplus">+        let error = this._parseError(aData);</span>
<a href="#l80.674"></a><span id="l80.674" class="difflineplus">+        this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l80.675"></a><span id="l80.675" class="difflineplus">+      },</span>
<a href="#l80.676"></a><span id="l80.676" class="difflineplus">+      this</span>
<a href="#l80.677"></a><span id="l80.677" class="difflineplus">+    );</span>
<a href="#l80.678"></a><span id="l80.678">   },</span>
<a href="#l80.679"></a><span id="l80.679">   displayMessages(aMessages) {</span>
<a href="#l80.680"></a><span id="l80.680">     let account = this._account;</span>
<a href="#l80.681"></a><span id="l80.681">     for (let tweet of aMessages) {</span>
<a href="#l80.682"></a><span id="l80.682" class="difflineminus">-      if (!(&quot;sender&quot; in tweet) || !(&quot;recipient&quot; in tweet) ||</span>
<a href="#l80.683"></a><span id="l80.683" class="difflineminus">-          !(&quot;text&quot; in tweet) || !(&quot;id_str&quot; in tweet))</span>
<a href="#l80.684"></a><span id="l80.684" class="difflineplus">+      if (</span>
<a href="#l80.685"></a><span id="l80.685" class="difflineplus">+        !(&quot;sender&quot; in tweet) ||</span>
<a href="#l80.686"></a><span id="l80.686" class="difflineplus">+        !(&quot;recipient&quot; in tweet) ||</span>
<a href="#l80.687"></a><span id="l80.687" class="difflineplus">+        !(&quot;text&quot; in tweet) ||</span>
<a href="#l80.688"></a><span id="l80.688" class="difflineplus">+        !(&quot;id_str&quot; in tweet)</span>
<a href="#l80.689"></a><span id="l80.689" class="difflineplus">+      ) {</span>
<a href="#l80.690"></a><span id="l80.690">         continue;</span>
<a href="#l80.691"></a><span id="l80.691" class="difflineplus">+      }</span>
<a href="#l80.692"></a><span id="l80.692">       account.setUserInfo(tweet.sender);</span>
<a href="#l80.693"></a><span id="l80.693">       account.setUserInfo(tweet.recipient);</span>
<a href="#l80.694"></a><span id="l80.694">       this.displayTweet(tweet, tweet.sender);</span>
<a href="#l80.695"></a><span id="l80.695">     }</span>
<a href="#l80.696"></a><span id="l80.696">   },</span>
<a href="#l80.697"></a><span id="l80.697">   unInit() {</span>
<a href="#l80.698"></a><span id="l80.698">     this._account.removeConversation(this.name);</span>
<a href="#l80.699"></a><span id="l80.699">     GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l80.700"></a><span id="l80.700">   },</span>
<a href="#l80.701"></a><span id="l80.701" class="difflineminus">-  get nick() { return this._account.name; },</span>
<a href="#l80.702"></a><span id="l80.702" class="difflineplus">+  get nick() {</span>
<a href="#l80.703"></a><span id="l80.703" class="difflineplus">+    return this._account.name;</span>
<a href="#l80.704"></a><span id="l80.704" class="difflineplus">+  },</span>
<a href="#l80.705"></a><span id="l80.705">   set nick(aNick) {},</span>
<a href="#l80.706"></a><span id="l80.706"> };</span>
<a href="#l80.707"></a><span id="l80.707"> Object.assign(DirectMessageConversation.prototype, GenericTwitterConversation);</span>
<a href="#l80.708"></a><span id="l80.708"> </span>
<a href="#l80.709"></a><span id="l80.709" class="difflineminus">-function Account(aProtocol, aImAccount)</span>
<a href="#l80.710"></a><span id="l80.710" class="difflineminus">-{</span>
<a href="#l80.711"></a><span id="l80.711" class="difflineplus">+function Account(aProtocol, aImAccount) {</span>
<a href="#l80.712"></a><span id="l80.712">   this._init(aProtocol, aImAccount);</span>
<a href="#l80.713"></a><span id="l80.713">   this._knownMessageIds = new Set();</span>
<a href="#l80.714"></a><span id="l80.714">   this._userInfo = new Map();</span>
<a href="#l80.715"></a><span id="l80.715">   this._friends = new Set();</span>
<a href="#l80.716"></a><span id="l80.716">   // Contains just `DirectMessageConversation`s</span>
<a href="#l80.717"></a><span id="l80.717">   this._conversations = new Map();</span>
<a href="#l80.718"></a><span id="l80.718"> }</span>
<a href="#l80.719"></a><span id="l80.719"> Account.prototype = {</span>
<a href="#l80.720"></a><span id="l80.720" class="difflineat">@@ -515,119 +629,142 @@ Account.prototype = {</span>
<a href="#l80.721"></a><span id="l80.721">   // home_timeline, @ mentions and tracked keywords (i.e. 3 timelines)</span>
<a href="#l80.722"></a><span id="l80.722">   _pendingRequests: [],</span>
<a href="#l80.723"></a><span id="l80.723">   _timelineBuffer: [],</span>
<a href="#l80.724"></a><span id="l80.724">   _timelineAuthError: 0,</span>
<a href="#l80.725"></a><span id="l80.725"> </span>
<a href="#l80.726"></a><span id="l80.726">   token: &quot;&quot;,</span>
<a href="#l80.727"></a><span id="l80.727">   tokenSecret: &quot;&quot;,</span>
<a href="#l80.728"></a><span id="l80.728">   connect() {</span>
<a href="#l80.729"></a><span id="l80.729" class="difflineminus">-    if (this.connected || this.connecting)</span>
<a href="#l80.730"></a><span id="l80.730" class="difflineplus">+    if (this.connected || this.connecting) {</span>
<a href="#l80.731"></a><span id="l80.731">       return;</span>
<a href="#l80.732"></a><span id="l80.732" class="difflineplus">+    }</span>
<a href="#l80.733"></a><span id="l80.733"> </span>
<a href="#l80.734"></a><span id="l80.734">     this.reportConnecting();</span>
<a href="#l80.735"></a><span id="l80.735"> </span>
<a href="#l80.736"></a><span id="l80.736">     // Read the OAuth token from the prefs</span>
<a href="#l80.737"></a><span id="l80.737">     let prefValue = {};</span>
<a href="#l80.738"></a><span id="l80.738">     try {</span>
<a href="#l80.739"></a><span id="l80.739">       prefValue = JSON.parse(this.prefs.getCharPref(&quot;oauth&quot;));</span>
<a href="#l80.740"></a><span id="l80.740" class="difflineminus">-    } catch (e) { }</span>
<a href="#l80.741"></a><span id="l80.741" class="difflineplus">+    } catch (e) {}</span>
<a href="#l80.742"></a><span id="l80.742">     if (prefValue.hasOwnProperty(this.consumerKey)) {</span>
<a href="#l80.743"></a><span id="l80.743">       let result = prefValue[this.consumerKey];</span>
<a href="#l80.744"></a><span id="l80.744">       this.token = result.oauth_token;</span>
<a href="#l80.745"></a><span id="l80.745">       this.tokenSecret = result.oauth_token_secret;</span>
<a href="#l80.746"></a><span id="l80.746" class="difflineminus">-      if (!this.fixAccountName(result))</span>
<a href="#l80.747"></a><span id="l80.747" class="difflineplus">+      if (!this.fixAccountName(result)) {</span>
<a href="#l80.748"></a><span id="l80.748">         return;</span>
<a href="#l80.749"></a><span id="l80.749" class="difflineplus">+      }</span>
<a href="#l80.750"></a><span id="l80.750">     }</span>
<a href="#l80.751"></a><span id="l80.751"> </span>
<a href="#l80.752"></a><span id="l80.752">     // Get a new token if needed...</span>
<a href="#l80.753"></a><span id="l80.753">     if (!this.token || !this.tokenSecret) {</span>
<a href="#l80.754"></a><span id="l80.754">       this.requestToken();</span>
<a href="#l80.755"></a><span id="l80.755">       return;</span>
<a href="#l80.756"></a><span id="l80.756">     }</span>
<a href="#l80.757"></a><span id="l80.757"> </span>
<a href="#l80.758"></a><span id="l80.758">     this.LOG(&quot;Connecting using existing token&quot;);</span>
<a href="#l80.759"></a><span id="l80.759">     this.getTimelines();</span>
<a href="#l80.760"></a><span id="l80.760">   },</span>
<a href="#l80.761"></a><span id="l80.761"> </span>
<a href="#l80.762"></a><span id="l80.762">   observe(aSubject, aTopic, aMsg) {</span>
<a href="#l80.763"></a><span id="l80.763">     // Twitter doesn't broadcast the user's availability, so we can ignore</span>
<a href="#l80.764"></a><span id="l80.764">     // imIUserStatusInfo's status notifications.</span>
<a href="#l80.765"></a><span id="l80.765" class="difflineminus">-    if (aTopic != NS_PREFBRANCH_PREFCHANGE_TOPIC_ID)</span>
<a href="#l80.766"></a><span id="l80.766" class="difflineplus">+    if (aTopic != NS_PREFBRANCH_PREFCHANGE_TOPIC_ID) {</span>
<a href="#l80.767"></a><span id="l80.767">       return;</span>
<a href="#l80.768"></a><span id="l80.768" class="difflineplus">+    }</span>
<a href="#l80.769"></a><span id="l80.769"> </span>
<a href="#l80.770"></a><span id="l80.770">     // Reopen the stream with the new tracked keywords.</span>
<a href="#l80.771"></a><span id="l80.771">     this.DEBUG(&quot;Twitter tracked keywords modified: &quot; + this.getString(&quot;track&quot;));</span>
<a href="#l80.772"></a><span id="l80.772"> </span>
<a href="#l80.773"></a><span id="l80.773">     // Close the stream and reopen it.</span>
<a href="#l80.774"></a><span id="l80.774">     this._streamingRequest.abort();</span>
<a href="#l80.775"></a><span id="l80.775">     this.openStream();</span>
<a href="#l80.776"></a><span id="l80.776">   },</span>
<a href="#l80.777"></a><span id="l80.777"> </span>
<a href="#l80.778"></a><span id="l80.778" class="difflineminus">-  signAndSend(aUrl, aHeaders, aPOSTData, aOnLoad, aOnError, aThis, aOAuthParams) {</span>
<a href="#l80.779"></a><span id="l80.779" class="difflineplus">+  signAndSend(</span>
<a href="#l80.780"></a><span id="l80.780" class="difflineplus">+    aUrl,</span>
<a href="#l80.781"></a><span id="l80.781" class="difflineplus">+    aHeaders,</span>
<a href="#l80.782"></a><span id="l80.782" class="difflineplus">+    aPOSTData,</span>
<a href="#l80.783"></a><span id="l80.783" class="difflineplus">+    aOnLoad,</span>
<a href="#l80.784"></a><span id="l80.784" class="difflineplus">+    aOnError,</span>
<a href="#l80.785"></a><span id="l80.785" class="difflineplus">+    aThis,</span>
<a href="#l80.786"></a><span id="l80.786" class="difflineplus">+    aOAuthParams</span>
<a href="#l80.787"></a><span id="l80.787" class="difflineplus">+  ) {</span>
<a href="#l80.788"></a><span id="l80.788">     const kChars =</span>
<a href="#l80.789"></a><span id="l80.789">       &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz&quot;;</span>
<a href="#l80.790"></a><span id="l80.790">     const kNonceLength = 6;</span>
<a href="#l80.791"></a><span id="l80.791">     let nonce = &quot;&quot;;</span>
<a href="#l80.792"></a><span id="l80.792" class="difflineminus">-    for (let i = 0; i &lt; kNonceLength; ++i)</span>
<a href="#l80.793"></a><span id="l80.793" class="difflineplus">+    for (let i = 0; i &lt; kNonceLength; ++i) {</span>
<a href="#l80.794"></a><span id="l80.794">       nonce += kChars[Math.floor(Math.random() * kChars.length)];</span>
<a href="#l80.795"></a><span id="l80.795" class="difflineplus">+    }</span>
<a href="#l80.796"></a><span id="l80.796"> </span>
<a href="#l80.797"></a><span id="l80.797">     let params = (aOAuthParams || []).concat([</span>
<a href="#l80.798"></a><span id="l80.798">       [&quot;oauth_consumer_key&quot;, this.consumerKey],</span>
<a href="#l80.799"></a><span id="l80.799">       [&quot;oauth_nonce&quot;, nonce],</span>
<a href="#l80.800"></a><span id="l80.800">       [&quot;oauth_signature_method&quot;, &quot;HMAC-SHA1&quot;],</span>
<a href="#l80.801"></a><span id="l80.801">       [&quot;oauth_token&quot;, this.token],</span>
<a href="#l80.802"></a><span id="l80.802" class="difflineminus">-      [&quot;oauth_timestamp&quot;, Math.floor(((new Date()).getTime()) / 1000)],</span>
<a href="#l80.803"></a><span id="l80.803" class="difflineplus">+      [&quot;oauth_timestamp&quot;, Math.floor(new Date().getTime() / 1000)],</span>
<a href="#l80.804"></a><span id="l80.804">       [&quot;oauth_version&quot;, &quot;1.0&quot;],</span>
<a href="#l80.805"></a><span id="l80.805">     ]);</span>
<a href="#l80.806"></a><span id="l80.806"> </span>
<a href="#l80.807"></a><span id="l80.807">     let dataParams = [];</span>
<a href="#l80.808"></a><span id="l80.808">     let url = /^https?:/.test(aUrl) ? aUrl : this.baseURI + aUrl;</span>
<a href="#l80.809"></a><span id="l80.809">     let urlSpec = url;</span>
<a href="#l80.810"></a><span id="l80.810">     let queryIndex = url.indexOf(&quot;?&quot;);</span>
<a href="#l80.811"></a><span id="l80.811">     if (queryIndex != -1) {</span>
<a href="#l80.812"></a><span id="l80.812">       urlSpec = url.slice(0, queryIndex);</span>
<a href="#l80.813"></a><span id="l80.813" class="difflineminus">-      dataParams = url.slice(queryIndex + 1).split(&quot;&amp;&quot;)</span>
<a href="#l80.814"></a><span id="l80.814" class="difflineminus">-                      .map(p =&gt; p.split(&quot;=&quot;).map(percentEncode));</span>
<a href="#l80.815"></a><span id="l80.815" class="difflineplus">+      dataParams = url</span>
<a href="#l80.816"></a><span id="l80.816" class="difflineplus">+        .slice(queryIndex + 1)</span>
<a href="#l80.817"></a><span id="l80.817" class="difflineplus">+        .split(&quot;&amp;&quot;)</span>
<a href="#l80.818"></a><span id="l80.818" class="difflineplus">+        .map(p =&gt; p.split(&quot;=&quot;).map(percentEncode));</span>
<a href="#l80.819"></a><span id="l80.819">     }</span>
<a href="#l80.820"></a><span id="l80.820">     let method = &quot;GET&quot;;</span>
<a href="#l80.821"></a><span id="l80.821">     if (aPOSTData) {</span>
<a href="#l80.822"></a><span id="l80.822">       method = &quot;POST&quot;;</span>
<a href="#l80.823"></a><span id="l80.823">       aPOSTData.forEach(function(p) {</span>
<a href="#l80.824"></a><span id="l80.824">         dataParams.push(p.map(percentEncode));</span>
<a href="#l80.825"></a><span id="l80.825">       });</span>
<a href="#l80.826"></a><span id="l80.826">     }</span>
<a href="#l80.827"></a><span id="l80.827"> </span>
<a href="#l80.828"></a><span id="l80.828">     let signatureKey = this.consumerSecret + &quot;&amp;&quot; + this.tokenSecret;</span>
<a href="#l80.829"></a><span id="l80.829">     let signatureBase =</span>
<a href="#l80.830"></a><span id="l80.830" class="difflineminus">-      method + &quot;&amp;&quot; + encodeURIComponent(urlSpec) + &quot;&amp;&quot; +</span>
<a href="#l80.831"></a><span id="l80.831" class="difflineminus">-      params.concat(dataParams)</span>
<a href="#l80.832"></a><span id="l80.832" class="difflineminus">-            .sort((a, b) =&gt; {</span>
<a href="#l80.833"></a><span id="l80.833" class="difflineminus">-              if (a[0] &lt; b[0])</span>
<a href="#l80.834"></a><span id="l80.834" class="difflineminus">-                return -1;</span>
<a href="#l80.835"></a><span id="l80.835" class="difflineminus">-              return a[0] &gt; b[0] ? 1 : 0;</span>
<a href="#l80.836"></a><span id="l80.836" class="difflineminus">-            })</span>
<a href="#l80.837"></a><span id="l80.837" class="difflineminus">-            .map(p =&gt; p.map(encodeURIComponent).join(&quot;%3D&quot;))</span>
<a href="#l80.838"></a><span id="l80.838" class="difflineminus">-            .join(&quot;%26&quot;);</span>
<a href="#l80.839"></a><span id="l80.839" class="difflineplus">+      method +</span>
<a href="#l80.840"></a><span id="l80.840" class="difflineplus">+      &quot;&amp;&quot; +</span>
<a href="#l80.841"></a><span id="l80.841" class="difflineplus">+      encodeURIComponent(urlSpec) +</span>
<a href="#l80.842"></a><span id="l80.842" class="difflineplus">+      &quot;&amp;&quot; +</span>
<a href="#l80.843"></a><span id="l80.843" class="difflineplus">+      params</span>
<a href="#l80.844"></a><span id="l80.844" class="difflineplus">+        .concat(dataParams)</span>
<a href="#l80.845"></a><span id="l80.845" class="difflineplus">+        .sort((a, b) =&gt; {</span>
<a href="#l80.846"></a><span id="l80.846" class="difflineplus">+          if (a[0] &lt; b[0]) {</span>
<a href="#l80.847"></a><span id="l80.847" class="difflineplus">+            return -1;</span>
<a href="#l80.848"></a><span id="l80.848" class="difflineplus">+          }</span>
<a href="#l80.849"></a><span id="l80.849" class="difflineplus">+          return a[0] &gt; b[0] ? 1 : 0;</span>
<a href="#l80.850"></a><span id="l80.850" class="difflineplus">+        })</span>
<a href="#l80.851"></a><span id="l80.851" class="difflineplus">+        .map(p =&gt; p.map(encodeURIComponent).join(&quot;%3D&quot;))</span>
<a href="#l80.852"></a><span id="l80.852" class="difflineplus">+        .join(&quot;%26&quot;);</span>
<a href="#l80.853"></a><span id="l80.853"> </span>
<a href="#l80.854"></a><span id="l80.854" class="difflineminus">-    let keyFactory = Cc[&quot;@mozilla.org/security/keyobjectfactory;1&quot;]</span>
<a href="#l80.855"></a><span id="l80.855" class="difflineminus">-                     .getService(Ci.nsIKeyObjectFactory);</span>
<a href="#l80.856"></a><span id="l80.856" class="difflineminus">-    let hmac =</span>
<a href="#l80.857"></a><span id="l80.857" class="difflineminus">-      Cc[&quot;@mozilla.org/security/hmac;1&quot;].createInstance(Ci.nsICryptoHMAC);</span>
<a href="#l80.858"></a><span id="l80.858" class="difflineminus">-    hmac.init(hmac.SHA1,</span>
<a href="#l80.859"></a><span id="l80.859" class="difflineminus">-              keyFactory.keyFromString(Ci.nsIKeyObject.HMAC, signatureKey));</span>
<a href="#l80.860"></a><span id="l80.860" class="difflineplus">+    let keyFactory = Cc[&quot;@mozilla.org/security/keyobjectfactory;1&quot;].getService(</span>
<a href="#l80.861"></a><span id="l80.861" class="difflineplus">+      Ci.nsIKeyObjectFactory</span>
<a href="#l80.862"></a><span id="l80.862" class="difflineplus">+    );</span>
<a href="#l80.863"></a><span id="l80.863" class="difflineplus">+    let hmac = Cc[&quot;@mozilla.org/security/hmac;1&quot;].createInstance(</span>
<a href="#l80.864"></a><span id="l80.864" class="difflineplus">+      Ci.nsICryptoHMAC</span>
<a href="#l80.865"></a><span id="l80.865" class="difflineplus">+    );</span>
<a href="#l80.866"></a><span id="l80.866" class="difflineplus">+    hmac.init(</span>
<a href="#l80.867"></a><span id="l80.867" class="difflineplus">+      hmac.SHA1,</span>
<a href="#l80.868"></a><span id="l80.868" class="difflineplus">+      keyFactory.keyFromString(Ci.nsIKeyObject.HMAC, signatureKey)</span>
<a href="#l80.869"></a><span id="l80.869" class="difflineplus">+    );</span>
<a href="#l80.870"></a><span id="l80.870">     // No UTF-8 encoding, special chars are already escaped.</span>
<a href="#l80.871"></a><span id="l80.871">     let bytes = [...signatureBase].map(b =&gt; b.charCodeAt());</span>
<a href="#l80.872"></a><span id="l80.872">     hmac.update(bytes, bytes.length);</span>
<a href="#l80.873"></a><span id="l80.873">     let signature = hmac.finish(true);</span>
<a href="#l80.874"></a><span id="l80.874"> </span>
<a href="#l80.875"></a><span id="l80.875">     params.push([&quot;oauth_signature&quot;, encodeURIComponent(signature)]);</span>
<a href="#l80.876"></a><span id="l80.876"> </span>
<a href="#l80.877"></a><span id="l80.877">     let authorization =</span>
<a href="#l80.878"></a><span id="l80.878" class="difflineminus">-      &quot;OAuth &quot; + params.map(p =&gt; p[0] + &quot;=\&quot;&quot; + p[1] + &quot;\&quot;&quot;).join(&quot;, &quot;);</span>
<a href="#l80.879"></a><span id="l80.879" class="difflineplus">+      &quot;OAuth &quot; + params.map(p =&gt; p[0] + '=&quot;' + p[1] + '&quot;').join(&quot;, &quot;);</span>
<a href="#l80.880"></a><span id="l80.880"> </span>
<a href="#l80.881"></a><span id="l80.881">     let options = {</span>
<a href="#l80.882"></a><span id="l80.882">       headers: (aHeaders || []).concat([[&quot;Authorization&quot;, authorization]]),</span>
<a href="#l80.883"></a><span id="l80.883">       postData: aPOSTData,</span>
<a href="#l80.884"></a><span id="l80.884">       onLoad: aOnLoad ? aOnLoad.bind(aThis) : null,</span>
<a href="#l80.885"></a><span id="l80.885">       onError: aOnError ? aOnError.bind(aThis) : null,</span>
<a href="#l80.886"></a><span id="l80.886">       logger: {</span>
<a href="#l80.887"></a><span id="l80.887">         log: this.LOG.bind(this),</span>
<a href="#l80.888"></a><span id="l80.888" class="difflineat">@@ -642,60 +779,84 @@ Account.prototype = {</span>
<a href="#l80.889"></a><span id="l80.889">       let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l80.890"></a><span id="l80.890">       result[key] = value;</span>
<a href="#l80.891"></a><span id="l80.891">     });</span>
<a href="#l80.892"></a><span id="l80.892">     return result;</span>
<a href="#l80.893"></a><span id="l80.893">   },</span>
<a href="#l80.894"></a><span id="l80.894"> </span>
<a href="#l80.895"></a><span id="l80.895">   tweet(aMsg, aInReplyToId, aOnSent, aOnError, aThis) {</span>
<a href="#l80.896"></a><span id="l80.896">     let POSTData = [[&quot;status&quot;, aMsg]];</span>
<a href="#l80.897"></a><span id="l80.897" class="difflineminus">-    if (aInReplyToId)</span>
<a href="#l80.898"></a><span id="l80.898" class="difflineplus">+    if (aInReplyToId) {</span>
<a href="#l80.899"></a><span id="l80.899">       POSTData.push([&quot;in_reply_to_status_id&quot;, aInReplyToId]);</span>
<a href="#l80.900"></a><span id="l80.900" class="difflineminus">-    this.signAndSend(&quot;1.1/statuses/update.json&quot;, null, POSTData, aOnSent,</span>
<a href="#l80.901"></a><span id="l80.901" class="difflineminus">-                     aOnError, aThis);</span>
<a href="#l80.902"></a><span id="l80.902" class="difflineplus">+    }</span>
<a href="#l80.903"></a><span id="l80.903" class="difflineplus">+    this.signAndSend(</span>
<a href="#l80.904"></a><span id="l80.904" class="difflineplus">+      &quot;1.1/statuses/update.json&quot;,</span>
<a href="#l80.905"></a><span id="l80.905" class="difflineplus">+      null,</span>
<a href="#l80.906"></a><span id="l80.906" class="difflineplus">+      POSTData,</span>
<a href="#l80.907"></a><span id="l80.907" class="difflineplus">+      aOnSent,</span>
<a href="#l80.908"></a><span id="l80.908" class="difflineplus">+      aOnError,</span>
<a href="#l80.909"></a><span id="l80.909" class="difflineplus">+      aThis</span>
<a href="#l80.910"></a><span id="l80.910" class="difflineplus">+    );</span>
<a href="#l80.911"></a><span id="l80.911">   },</span>
<a href="#l80.912"></a><span id="l80.912">   reTweet(aTweet, aOnSent, aOnError, aThis) {</span>
<a href="#l80.913"></a><span id="l80.913">     let url = &quot;1.1/statuses/retweet/&quot; + aTweet.id_str + &quot;.json&quot;;</span>
<a href="#l80.914"></a><span id="l80.914">     this.signAndSend(url, null, [], aOnSent, aOnError, aThis);</span>
<a href="#l80.915"></a><span id="l80.915">   },</span>
<a href="#l80.916"></a><span id="l80.916">   destroy(aTweet, aOnSent, aOnError, aThis) {</span>
<a href="#l80.917"></a><span id="l80.917">     let url = &quot;1.1/statuses/destroy/&quot; + aTweet.id_str + &quot;.json&quot;;</span>
<a href="#l80.918"></a><span id="l80.918">     this.signAndSend(url, null, [], aOnSent, aOnError, aThis);</span>
<a href="#l80.919"></a><span id="l80.919">   },</span>
<a href="#l80.920"></a><span id="l80.920">   directMessage(aMsg, aName, aOnSent, aOnError, aThis) {</span>
<a href="#l80.921"></a><span id="l80.921">     let POSTData = [[&quot;text&quot;, aMsg], [&quot;screen_name&quot;, aName]];</span>
<a href="#l80.922"></a><span id="l80.922" class="difflineminus">-    this.signAndSend(&quot;1.1/direct_messages/new.json&quot;, null, POSTData, aOnSent,</span>
<a href="#l80.923"></a><span id="l80.923" class="difflineminus">-                     aOnError, aThis);</span>
<a href="#l80.924"></a><span id="l80.924" class="difflineplus">+    this.signAndSend(</span>
<a href="#l80.925"></a><span id="l80.925" class="difflineplus">+      &quot;1.1/direct_messages/new.json&quot;,</span>
<a href="#l80.926"></a><span id="l80.926" class="difflineplus">+      null,</span>
<a href="#l80.927"></a><span id="l80.927" class="difflineplus">+      POSTData,</span>
<a href="#l80.928"></a><span id="l80.928" class="difflineplus">+      aOnSent,</span>
<a href="#l80.929"></a><span id="l80.929" class="difflineplus">+      aOnError,</span>
<a href="#l80.930"></a><span id="l80.930" class="difflineplus">+      aThis</span>
<a href="#l80.931"></a><span id="l80.931" class="difflineplus">+    );</span>
<a href="#l80.932"></a><span id="l80.932">   },</span>
<a href="#l80.933"></a><span id="l80.933">   like(aTweet, aRemoveLike, aOnSent, aOnError, aThis) {</span>
<a href="#l80.934"></a><span id="l80.934">     const action = aRemoveLike ? &quot;destroy&quot; : &quot;create&quot;;</span>
<a href="#l80.935"></a><span id="l80.935">     const url = `1.1/favorites/${action}.json`;</span>
<a href="#l80.936"></a><span id="l80.936">     const POSTData = [[&quot;id&quot;, aTweet.id_str]];</span>
<a href="#l80.937"></a><span id="l80.937">     this.signAndSend(url, null, POSTData, aOnSent, aOnError, aThis);</span>
<a href="#l80.938"></a><span id="l80.938">   },</span>
<a href="#l80.939"></a><span id="l80.939"> </span>
<a href="#l80.940"></a><span id="l80.940">   _friends: null,</span>
<a href="#l80.941"></a><span id="l80.941">   follow(aUserName) {</span>
<a href="#l80.942"></a><span id="l80.942" class="difflineminus">-    this.signAndSend(&quot;1.1/friendships/create.json&quot;, null,</span>
<a href="#l80.943"></a><span id="l80.943" class="difflineminus">-                     [[&quot;screen_name&quot;, aUserName]]);</span>
<a href="#l80.944"></a><span id="l80.944" class="difflineplus">+    this.signAndSend(&quot;1.1/friendships/create.json&quot;, null, [</span>
<a href="#l80.945"></a><span id="l80.945" class="difflineplus">+      [&quot;screen_name&quot;, aUserName],</span>
<a href="#l80.946"></a><span id="l80.946" class="difflineplus">+    ]);</span>
<a href="#l80.947"></a><span id="l80.947">   },</span>
<a href="#l80.948"></a><span id="l80.948">   stopFollowing(aUserName) {</span>
<a href="#l80.949"></a><span id="l80.949">     // friendships/destroy will return the user in case of success.</span>
<a href="#l80.950"></a><span id="l80.950">     // Error cases would return a non 200 HTTP code and not call our callback.</span>
<a href="#l80.951"></a><span id="l80.951" class="difflineminus">-    this.signAndSend(&quot;1.1/friendships/destroy.json&quot;, null,</span>
<a href="#l80.952"></a><span id="l80.952" class="difflineminus">-                     [[&quot;screen_name&quot;, aUserName]], function(aData, aXHR) {</span>
<a href="#l80.953"></a><span id="l80.953" class="difflineminus">-      let user = JSON.parse(aData);</span>
<a href="#l80.954"></a><span id="l80.954" class="difflineminus">-      if (!(&quot;id_str&quot; in user))</span>
<a href="#l80.955"></a><span id="l80.955" class="difflineminus">-        return; // Unexpected response...</span>
<a href="#l80.956"></a><span id="l80.956" class="difflineminus">-      this._friends.delete(user.id_str);</span>
<a href="#l80.957"></a><span id="l80.957" class="difflineminus">-      this.timeline.removeParticipant(user.screen_name);</span>
<a href="#l80.958"></a><span id="l80.958" class="difflineminus">-      let date = aXHR.getResponseHeader(&quot;Date&quot;);</span>
<a href="#l80.959"></a><span id="l80.959" class="difflineminus">-      this.timeline.systemMessage(_(&quot;event.unfollow&quot;, user.screen_name), false,</span>
<a href="#l80.960"></a><span id="l80.960" class="difflineminus">-                                  new Date(date) / 1000);</span>
<a href="#l80.961"></a><span id="l80.961" class="difflineminus">-    }, null, this);</span>
<a href="#l80.962"></a><span id="l80.962" class="difflineplus">+    this.signAndSend(</span>
<a href="#l80.963"></a><span id="l80.963" class="difflineplus">+      &quot;1.1/friendships/destroy.json&quot;,</span>
<a href="#l80.964"></a><span id="l80.964" class="difflineplus">+      null,</span>
<a href="#l80.965"></a><span id="l80.965" class="difflineplus">+      [[&quot;screen_name&quot;, aUserName]],</span>
<a href="#l80.966"></a><span id="l80.966" class="difflineplus">+      function(aData, aXHR) {</span>
<a href="#l80.967"></a><span id="l80.967" class="difflineplus">+        let user = JSON.parse(aData);</span>
<a href="#l80.968"></a><span id="l80.968" class="difflineplus">+        if (!(&quot;id_str&quot; in user)) {</span>
<a href="#l80.969"></a><span id="l80.969" class="difflineplus">+          return;</span>
<a href="#l80.970"></a><span id="l80.970" class="difflineplus">+        } // Unexpected response...</span>
<a href="#l80.971"></a><span id="l80.971" class="difflineplus">+        this._friends.delete(user.id_str);</span>
<a href="#l80.972"></a><span id="l80.972" class="difflineplus">+        this.timeline.removeParticipant(user.screen_name);</span>
<a href="#l80.973"></a><span id="l80.973" class="difflineplus">+        let date = aXHR.getResponseHeader(&quot;Date&quot;);</span>
<a href="#l80.974"></a><span id="l80.974" class="difflineplus">+        this.timeline.systemMessage(</span>
<a href="#l80.975"></a><span id="l80.975" class="difflineplus">+          _(&quot;event.unfollow&quot;, user.screen_name),</span>
<a href="#l80.976"></a><span id="l80.976" class="difflineplus">+          false,</span>
<a href="#l80.977"></a><span id="l80.977" class="difflineplus">+          new Date(date) / 1000</span>
<a href="#l80.978"></a><span id="l80.978" class="difflineplus">+        );</span>
<a href="#l80.979"></a><span id="l80.979" class="difflineplus">+      },</span>
<a href="#l80.980"></a><span id="l80.980" class="difflineplus">+      null,</span>
<a href="#l80.981"></a><span id="l80.981" class="difflineplus">+      this</span>
<a href="#l80.982"></a><span id="l80.982" class="difflineplus">+    );</span>
<a href="#l80.983"></a><span id="l80.983">   },</span>
<a href="#l80.984"></a><span id="l80.984">   addBuddy(aTag, aName) {</span>
<a href="#l80.985"></a><span id="l80.985">     this.follow(aName);</span>
<a href="#l80.986"></a><span id="l80.986">   },</span>
<a href="#l80.987"></a><span id="l80.987"> </span>
<a href="#l80.988"></a><span id="l80.988">   getTimelines() {</span>
<a href="#l80.989"></a><span id="l80.989">     this.reportConnecting(_(&quot;connection.requestTimelines&quot;));</span>
<a href="#l80.990"></a><span id="l80.990"> </span>
<a href="#l80.991"></a><span id="l80.991" class="difflineat">@@ -703,363 +864,455 @@ Account.prototype = {</span>
<a href="#l80.992"></a><span id="l80.992">     let lastMsgParam = &quot;&quot;;</span>
<a href="#l80.993"></a><span id="l80.993">     if (this.prefs.prefHasUserValue(&quot;lastMessageId&quot;)) {</span>
<a href="#l80.994"></a><span id="l80.994">       let lastMsgId = this.prefs.getCharPref(&quot;lastMessageId&quot;);</span>
<a href="#l80.995"></a><span id="l80.995">       // Check that the ID is made up of all digits, otherwise the server will</span>
<a href="#l80.996"></a><span id="l80.996">       // croak on our request.</span>
<a href="#l80.997"></a><span id="l80.997">       if (/^\d+$/.test(lastMsgId)) {</span>
<a href="#l80.998"></a><span id="l80.998">         lastMsgParam = &quot;&amp;since_id=&quot; + lastMsgId;</span>
<a href="#l80.999"></a><span id="l80.999">         this._lastMsgId = lastMsgId;</span>
<a href="#l80.1000"></a><span id="l80.1000" class="difflineplus">+      } else {</span>
<a href="#l80.1001"></a><span id="l80.1001" class="difflineplus">+        this.WARN(</span>
<a href="#l80.1002"></a><span id="l80.1002" class="difflineplus">+          &quot;invalid value for the lastMessageId preference: &quot; + lastMsgId</span>
<a href="#l80.1003"></a><span id="l80.1003" class="difflineplus">+        );</span>
<a href="#l80.1004"></a><span id="l80.1004">       }</span>
<a href="#l80.1005"></a><span id="l80.1005" class="difflineminus">-      else</span>
<a href="#l80.1006"></a><span id="l80.1006" class="difflineminus">-        this.WARN(&quot;invalid value for the lastMessageId preference: &quot; + lastMsgId);</span>
<a href="#l80.1007"></a><span id="l80.1007">     }</span>
<a href="#l80.1008"></a><span id="l80.1008">     let getParams = &quot;?count=200&quot; + lastMsgParam;</span>
<a href="#l80.1009"></a><span id="l80.1009">     this._pendingRequests = [</span>
<a href="#l80.1010"></a><span id="l80.1010" class="difflineminus">-      this.signAndSend(&quot;1.1/statuses/home_timeline.json&quot; + getParams, null,</span>
<a href="#l80.1011"></a><span id="l80.1011" class="difflineminus">-                       null, this.onTimelineReceived, this.onTimelineError,</span>
<a href="#l80.1012"></a><span id="l80.1012" class="difflineminus">-                       this),</span>
<a href="#l80.1013"></a><span id="l80.1013" class="difflineminus">-      this.signAndSend(&quot;1.1/statuses/mentions_timeline.json&quot; + getParams, null,</span>
<a href="#l80.1014"></a><span id="l80.1014" class="difflineminus">-                       null, this.onTimelineReceived, this.onTimelineError,</span>
<a href="#l80.1015"></a><span id="l80.1015" class="difflineminus">-                       this),</span>
<a href="#l80.1016"></a><span id="l80.1016" class="difflineplus">+      this.signAndSend(</span>
<a href="#l80.1017"></a><span id="l80.1017" class="difflineplus">+        &quot;1.1/statuses/home_timeline.json&quot; + getParams,</span>
<a href="#l80.1018"></a><span id="l80.1018" class="difflineplus">+        null,</span>
<a href="#l80.1019"></a><span id="l80.1019" class="difflineplus">+        null,</span>
<a href="#l80.1020"></a><span id="l80.1020" class="difflineplus">+        this.onTimelineReceived,</span>
<a href="#l80.1021"></a><span id="l80.1021" class="difflineplus">+        this.onTimelineError,</span>
<a href="#l80.1022"></a><span id="l80.1022" class="difflineplus">+        this</span>
<a href="#l80.1023"></a><span id="l80.1023" class="difflineplus">+      ),</span>
<a href="#l80.1024"></a><span id="l80.1024" class="difflineplus">+      this.signAndSend(</span>
<a href="#l80.1025"></a><span id="l80.1025" class="difflineplus">+        &quot;1.1/statuses/mentions_timeline.json&quot; + getParams,</span>
<a href="#l80.1026"></a><span id="l80.1026" class="difflineplus">+        null,</span>
<a href="#l80.1027"></a><span id="l80.1027" class="difflineplus">+        null,</span>
<a href="#l80.1028"></a><span id="l80.1028" class="difflineplus">+        this.onTimelineReceived,</span>
<a href="#l80.1029"></a><span id="l80.1029" class="difflineplus">+        this.onTimelineError,</span>
<a href="#l80.1030"></a><span id="l80.1030" class="difflineplus">+        this</span>
<a href="#l80.1031"></a><span id="l80.1031" class="difflineplus">+      ),</span>
<a href="#l80.1032"></a><span id="l80.1032">     ];</span>
<a href="#l80.1033"></a><span id="l80.1033"> </span>
<a href="#l80.1034"></a><span id="l80.1034">     let track = this.getString(&quot;track&quot;);</span>
<a href="#l80.1035"></a><span id="l80.1035">     if (track) {</span>
<a href="#l80.1036"></a><span id="l80.1036" class="difflineminus">-      let trackQuery = track.split(&quot;,&quot;).map(encodeURIComponent).join(&quot; OR &quot;);</span>
<a href="#l80.1037"></a><span id="l80.1037" class="difflineplus">+      let trackQuery = track</span>
<a href="#l80.1038"></a><span id="l80.1038" class="difflineplus">+        .split(&quot;,&quot;)</span>
<a href="#l80.1039"></a><span id="l80.1039" class="difflineplus">+        .map(encodeURIComponent)</span>
<a href="#l80.1040"></a><span id="l80.1040" class="difflineplus">+        .join(&quot; OR &quot;);</span>
<a href="#l80.1041"></a><span id="l80.1041">       getParams = &quot;?q=&quot; + trackQuery + lastMsgParam + &quot;&amp;count=100&quot;;</span>
<a href="#l80.1042"></a><span id="l80.1042">       let url = &quot;1.1/search/tweets.json&quot; + getParams;</span>
<a href="#l80.1043"></a><span id="l80.1043">       this._pendingRequests.push(</span>
<a href="#l80.1044"></a><span id="l80.1044" class="difflineminus">-        this.signAndSend(url, null, null, this.onTimelineReceived,</span>
<a href="#l80.1045"></a><span id="l80.1045" class="difflineminus">-                         this.onTimelineError, this, null));</span>
<a href="#l80.1046"></a><span id="l80.1046" class="difflineplus">+        this.signAndSend(</span>
<a href="#l80.1047"></a><span id="l80.1047" class="difflineplus">+          url,</span>
<a href="#l80.1048"></a><span id="l80.1048" class="difflineplus">+          null,</span>
<a href="#l80.1049"></a><span id="l80.1049" class="difflineplus">+          null,</span>
<a href="#l80.1050"></a><span id="l80.1050" class="difflineplus">+          this.onTimelineReceived,</span>
<a href="#l80.1051"></a><span id="l80.1051" class="difflineplus">+          this.onTimelineError,</span>
<a href="#l80.1052"></a><span id="l80.1052" class="difflineplus">+          this,</span>
<a href="#l80.1053"></a><span id="l80.1053" class="difflineplus">+          null</span>
<a href="#l80.1054"></a><span id="l80.1054" class="difflineplus">+        )</span>
<a href="#l80.1055"></a><span id="l80.1055" class="difflineplus">+      );</span>
<a href="#l80.1056"></a><span id="l80.1056">     }</span>
<a href="#l80.1057"></a><span id="l80.1057">   },</span>
<a href="#l80.1058"></a><span id="l80.1058"> </span>
<a href="#l80.1059"></a><span id="l80.1059" class="difflineminus">-  get timeline() { return this._timeline || (this._timeline = new TimelineConversation(this)); },</span>
<a href="#l80.1060"></a><span id="l80.1060" class="difflineplus">+  get timeline() {</span>
<a href="#l80.1061"></a><span id="l80.1061" class="difflineplus">+    return this._timeline || (this._timeline = new TimelineConversation(this));</span>
<a href="#l80.1062"></a><span id="l80.1062" class="difflineplus">+  },</span>
<a href="#l80.1063"></a><span id="l80.1063"> </span>
<a href="#l80.1064"></a><span id="l80.1064">   onTimelineError(aError, aResponseText, aRequest) {</span>
<a href="#l80.1065"></a><span id="l80.1065">     this.ERROR(aError);</span>
<a href="#l80.1066"></a><span id="l80.1066" class="difflineminus">-    if (aRequest.status == 401)</span>
<a href="#l80.1067"></a><span id="l80.1067" class="difflineplus">+    if (aRequest.status == 401) {</span>
<a href="#l80.1068"></a><span id="l80.1068">       ++this._timelineAuthError;</span>
<a href="#l80.1069"></a><span id="l80.1069" class="difflineplus">+    }</span>
<a href="#l80.1070"></a><span id="l80.1070">     this._doneWithTimelineRequest(aRequest);</span>
<a href="#l80.1071"></a><span id="l80.1071">   },</span>
<a href="#l80.1072"></a><span id="l80.1072"> </span>
<a href="#l80.1073"></a><span id="l80.1073">   onTimelineReceived(aData, aRequest) {</span>
<a href="#l80.1074"></a><span id="l80.1074">     this._timelineBuffer = this._timelineBuffer.concat(JSON.parse(aData));</span>
<a href="#l80.1075"></a><span id="l80.1075">     this._doneWithTimelineRequest(aRequest);</span>
<a href="#l80.1076"></a><span id="l80.1076">   },</span>
<a href="#l80.1077"></a><span id="l80.1077"> </span>
<a href="#l80.1078"></a><span id="l80.1078">   _doneWithTimelineRequest(aRequest) {</span>
<a href="#l80.1079"></a><span id="l80.1079" class="difflineminus">-    this._pendingRequests =</span>
<a href="#l80.1080"></a><span id="l80.1080" class="difflineminus">-      this._pendingRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l80.1081"></a><span id="l80.1081" class="difflineplus">+    this._pendingRequests = this._pendingRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l80.1082"></a><span id="l80.1082"> </span>
<a href="#l80.1083"></a><span id="l80.1083">     // If we are still waiting for more data, return early</span>
<a href="#l80.1084"></a><span id="l80.1084" class="difflineminus">-    if (this._pendingRequests.length != 0)</span>
<a href="#l80.1085"></a><span id="l80.1085" class="difflineplus">+    if (this._pendingRequests.length != 0) {</span>
<a href="#l80.1086"></a><span id="l80.1086">       return;</span>
<a href="#l80.1087"></a><span id="l80.1087" class="difflineplus">+    }</span>
<a href="#l80.1088"></a><span id="l80.1088"> </span>
<a href="#l80.1089"></a><span id="l80.1089">     if (this._timelineAuthError &gt;= 2) {</span>
<a href="#l80.1090"></a><span id="l80.1090">       // 2 out of the 3 timeline requests are authenticated.</span>
<a href="#l80.1091"></a><span id="l80.1091">       // With at least 2 '401 - Unauthorized' errors, we are sure</span>
<a href="#l80.1092"></a><span id="l80.1092">       // that our OAuth token is consistently rejected.</span>
<a href="#l80.1093"></a><span id="l80.1093">       delete this._timelineAuthError;</span>
<a href="#l80.1094"></a><span id="l80.1094">       delete this._timelineBuffer;</span>
<a href="#l80.1095"></a><span id="l80.1095">       delete this._pendingRequests;</span>
<a href="#l80.1096"></a><span id="l80.1096">       delete this.token;</span>
<a href="#l80.1097"></a><span id="l80.1097">       delete this.tokenSecret;</span>
<a href="#l80.1098"></a><span id="l80.1098">       this.requestToken();</span>
<a href="#l80.1099"></a><span id="l80.1099">       return;</span>
<a href="#l80.1100"></a><span id="l80.1100">     }</span>
<a href="#l80.1101"></a><span id="l80.1101"> </span>
<a href="#l80.1102"></a><span id="l80.1102">     // Less than 2 auth errors is probably just some flakiness of the</span>
<a href="#l80.1103"></a><span id="l80.1103">     // twitter servers, ignore and reset this._timelineAuthError.</span>
<a href="#l80.1104"></a><span id="l80.1104" class="difflineminus">-    if (this._timelineAuthError)</span>
<a href="#l80.1105"></a><span id="l80.1105" class="difflineplus">+    if (this._timelineAuthError) {</span>
<a href="#l80.1106"></a><span id="l80.1106">       delete this._timelineAuthError;</span>
<a href="#l80.1107"></a><span id="l80.1107" class="difflineplus">+    }</span>
<a href="#l80.1108"></a><span id="l80.1108"> </span>
<a href="#l80.1109"></a><span id="l80.1109">     this.reportConnected();</span>
<a href="#l80.1110"></a><span id="l80.1110"> </span>
<a href="#l80.1111"></a><span id="l80.1111">     // If the conversation already exists, notify it we are back online.</span>
<a href="#l80.1112"></a><span id="l80.1112" class="difflineminus">-    if (this._timeline)</span>
<a href="#l80.1113"></a><span id="l80.1113" class="difflineplus">+    if (this._timeline) {</span>
<a href="#l80.1114"></a><span id="l80.1114">       this._timeline.notifyObservers(this._timeline, &quot;update-buddy-status&quot;);</span>
<a href="#l80.1115"></a><span id="l80.1115" class="difflineplus">+    }</span>
<a href="#l80.1116"></a><span id="l80.1116"> </span>
<a href="#l80.1117"></a><span id="l80.1117">     this._timelineBuffer.sort(this.sortByDate);</span>
<a href="#l80.1118"></a><span id="l80.1118" class="difflineminus">-    this._timelineBuffer.forEach(aTweet =&gt; aTweet.delayed = true);</span>
<a href="#l80.1119"></a><span id="l80.1119" class="difflineplus">+    this._timelineBuffer.forEach(aTweet =&gt; (aTweet.delayed = true));</span>
<a href="#l80.1120"></a><span id="l80.1120">     this.timeline.displayMessages(this._timelineBuffer);</span>
<a href="#l80.1121"></a><span id="l80.1121"> </span>
<a href="#l80.1122"></a><span id="l80.1122">     // Fetch userInfo for the user if we don't already have it.</span>
<a href="#l80.1123"></a><span id="l80.1123">     this.requestBuddyInfo(this.name);</span>
<a href="#l80.1124"></a><span id="l80.1124"> </span>
<a href="#l80.1125"></a><span id="l80.1125">     // Reset in case we get disconnected</span>
<a href="#l80.1126"></a><span id="l80.1126">     delete this._timelineBuffer;</span>
<a href="#l80.1127"></a><span id="l80.1127">     delete this._pendingRequests;</span>
<a href="#l80.1128"></a><span id="l80.1128"> </span>
<a href="#l80.1129"></a><span id="l80.1129">     // Open the streams to get the live data.</span>
<a href="#l80.1130"></a><span id="l80.1130">     this.openStream();</span>
<a href="#l80.1131"></a><span id="l80.1131">   },</span>
<a href="#l80.1132"></a><span id="l80.1132"> </span>
<a href="#l80.1133"></a><span id="l80.1133" class="difflineminus">-  sortByDate: (a, b) =&gt; (new Date(a.created_at)) - (new Date(b.created_at)),</span>
<a href="#l80.1134"></a><span id="l80.1134" class="difflineplus">+  sortByDate: (a, b) =&gt; new Date(a.created_at) - new Date(b.created_at),</span>
<a href="#l80.1135"></a><span id="l80.1135"> </span>
<a href="#l80.1136"></a><span id="l80.1136">   _streamingRequest: null,</span>
<a href="#l80.1137"></a><span id="l80.1137">   _pendingData: &quot;&quot;,</span>
<a href="#l80.1138"></a><span id="l80.1138">   openStream() {</span>
<a href="#l80.1139"></a><span id="l80.1139">     let track = this.getString(&quot;track&quot;);</span>
<a href="#l80.1140"></a><span id="l80.1140" class="difflineminus">-    this._streamingRequest =</span>
<a href="#l80.1141"></a><span id="l80.1141" class="difflineminus">-      this.signAndSend(&quot;https://userstream.twitter.com/1.1/user.json&quot;, null,</span>
<a href="#l80.1142"></a><span id="l80.1142" class="difflineminus">-                       track ? [[&quot;track&quot;, track]] : [], this.openStream,</span>
<a href="#l80.1143"></a><span id="l80.1143" class="difflineminus">-                       this.onStreamError, this);</span>
<a href="#l80.1144"></a><span id="l80.1144" class="difflineplus">+    this._streamingRequest = this.signAndSend(</span>
<a href="#l80.1145"></a><span id="l80.1145" class="difflineplus">+      &quot;https://userstream.twitter.com/1.1/user.json&quot;,</span>
<a href="#l80.1146"></a><span id="l80.1146" class="difflineplus">+      null,</span>
<a href="#l80.1147"></a><span id="l80.1147" class="difflineplus">+      track ? [[&quot;track&quot;, track]] : [],</span>
<a href="#l80.1148"></a><span id="l80.1148" class="difflineplus">+      this.openStream,</span>
<a href="#l80.1149"></a><span id="l80.1149" class="difflineplus">+      this.onStreamError,</span>
<a href="#l80.1150"></a><span id="l80.1150" class="difflineplus">+      this</span>
<a href="#l80.1151"></a><span id="l80.1151" class="difflineplus">+    );</span>
<a href="#l80.1152"></a><span id="l80.1152">     this._streamingRequest.responseType = &quot;moz-chunked-text&quot;;</span>
<a href="#l80.1153"></a><span id="l80.1153">     this._streamingRequest.onprogress = this.onDataAvailable.bind(this);</span>
<a href="#l80.1154"></a><span id="l80.1154">     this.resetStreamTimeout();</span>
<a href="#l80.1155"></a><span id="l80.1155">     this.prefs.addObserver(&quot;track&quot;, this);</span>
<a href="#l80.1156"></a><span id="l80.1156">   },</span>
<a href="#l80.1157"></a><span id="l80.1157">   _streamTimeout: null,</span>
<a href="#l80.1158"></a><span id="l80.1158">   resetStreamTimeout() {</span>
<a href="#l80.1159"></a><span id="l80.1159" class="difflineminus">-    if (this._streamTimeout)</span>
<a href="#l80.1160"></a><span id="l80.1160" class="difflineplus">+    if (this._streamTimeout) {</span>
<a href="#l80.1161"></a><span id="l80.1161">       clearTimeout(this._streamTimeout);</span>
<a href="#l80.1162"></a><span id="l80.1162" class="difflineplus">+    }</span>
<a href="#l80.1163"></a><span id="l80.1163">     // The twitter Streaming API sends a keep-alive newline every 30 seconds</span>
<a href="#l80.1164"></a><span id="l80.1164">     // so if we haven't received anything for 90s, we should disconnect and try</span>
<a href="#l80.1165"></a><span id="l80.1165">     // to reconnect.</span>
<a href="#l80.1166"></a><span id="l80.1166">     this._streamTimeout = setTimeout(this.onStreamTimeout.bind(this), 90000);</span>
<a href="#l80.1167"></a><span id="l80.1167">   },</span>
<a href="#l80.1168"></a><span id="l80.1168">   onStreamError(aError) {</span>
<a href="#l80.1169"></a><span id="l80.1169">     delete this._streamingRequest;</span>
<a href="#l80.1170"></a><span id="l80.1170">     // _streamTimeout is cleared by cleanUp called by gotDisconnected.</span>
<a href="#l80.1171"></a><span id="l80.1171">     this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, aError);</span>
<a href="#l80.1172"></a><span id="l80.1172">   },</span>
<a href="#l80.1173"></a><span id="l80.1173">   onStreamTimeout() {</span>
<a href="#l80.1174"></a><span id="l80.1174">     this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, &quot;timeout&quot;);</span>
<a href="#l80.1175"></a><span id="l80.1175">   },</span>
<a href="#l80.1176"></a><span id="l80.1176">   onDataAvailable(aRequest) {</span>
<a href="#l80.1177"></a><span id="l80.1177">     this.resetStreamTimeout();</span>
<a href="#l80.1178"></a><span id="l80.1178">     let newText = this._pendingData + aRequest.target.response;</span>
<a href="#l80.1179"></a><span id="l80.1179" class="difflineminus">-    if (newText.trim())</span>
<a href="#l80.1180"></a><span id="l80.1180" class="difflineplus">+    if (newText.trim()) {</span>
<a href="#l80.1181"></a><span id="l80.1181">       this.DEBUG(&quot;Received data: &quot; + newText);</span>
<a href="#l80.1182"></a><span id="l80.1182" class="difflineminus">-    else</span>
<a href="#l80.1183"></a><span id="l80.1183" class="difflineplus">+    } else {</span>
<a href="#l80.1184"></a><span id="l80.1184">       this.DEBUG(&quot;Received ping&quot;);</span>
<a href="#l80.1185"></a><span id="l80.1185" class="difflineplus">+    }</span>
<a href="#l80.1186"></a><span id="l80.1186">     let messages = newText.split(/\r\n?/);</span>
<a href="#l80.1187"></a><span id="l80.1187">     this._pendingData = messages.pop();</span>
<a href="#l80.1188"></a><span id="l80.1188">     for (let message of messages) {</span>
<a href="#l80.1189"></a><span id="l80.1189" class="difflineminus">-      if (!message.trim())</span>
<a href="#l80.1190"></a><span id="l80.1190" class="difflineplus">+      if (!message.trim()) {</span>
<a href="#l80.1191"></a><span id="l80.1191">         continue;</span>
<a href="#l80.1192"></a><span id="l80.1192" class="difflineplus">+      }</span>
<a href="#l80.1193"></a><span id="l80.1193">       let msg;</span>
<a href="#l80.1194"></a><span id="l80.1194">       try {</span>
<a href="#l80.1195"></a><span id="l80.1195">         msg = JSON.parse(message);</span>
<a href="#l80.1196"></a><span id="l80.1196">       } catch (e) {</span>
<a href="#l80.1197"></a><span id="l80.1197">         this.ERROR(e + &quot; while parsing &quot; + message);</span>
<a href="#l80.1198"></a><span id="l80.1198">         continue;</span>
<a href="#l80.1199"></a><span id="l80.1199">       }</span>
<a href="#l80.1200"></a><span id="l80.1200">       if (&quot;direct_message&quot; in msg) {</span>
<a href="#l80.1201"></a><span id="l80.1201">         let dm = msg.direct_message;</span>
<a href="#l80.1202"></a><span id="l80.1202" class="difflineminus">-        if (dm.sender_screen_name !== this.name)  // These are displayed on send.</span>
<a href="#l80.1203"></a><span id="l80.1203" class="difflineplus">+        if (dm.sender_screen_name !== this.name) {</span>
<a href="#l80.1204"></a><span id="l80.1204" class="difflineplus">+          // These are displayed on send.</span>
<a href="#l80.1205"></a><span id="l80.1205">           this.getConversation(dm.sender_screen_name).displayMessages([dm]);</span>
<a href="#l80.1206"></a><span id="l80.1206" class="difflineminus">-      }</span>
<a href="#l80.1207"></a><span id="l80.1207" class="difflineminus">-      else if (&quot;text&quot; in msg)</span>
<a href="#l80.1208"></a><span id="l80.1208" class="difflineplus">+        }</span>
<a href="#l80.1209"></a><span id="l80.1209" class="difflineplus">+      } else if (&quot;text&quot; in msg) {</span>
<a href="#l80.1210"></a><span id="l80.1210">         this.timeline.displayMessages([msg]);</span>
<a href="#l80.1211"></a><span id="l80.1211" class="difflineminus">-      else if (&quot;friends&quot; in msg) {</span>
<a href="#l80.1212"></a><span id="l80.1212" class="difflineplus">+      } else if (&quot;friends&quot; in msg) {</span>
<a href="#l80.1213"></a><span id="l80.1213">         // Filter out the IDs that info has already been received from (e.g. a</span>
<a href="#l80.1214"></a><span id="l80.1214">         // tweet has been received as part of the timeline request).</span>
<a href="#l80.1215"></a><span id="l80.1215">         let userInfoIds = new Set();</span>
<a href="#l80.1216"></a><span id="l80.1216" class="difflineminus">-        for (let userInfo of this._userInfo.values())</span>
<a href="#l80.1217"></a><span id="l80.1217" class="difflineplus">+        for (let userInfo of this._userInfo.values()) {</span>
<a href="#l80.1218"></a><span id="l80.1218">           userInfoIds.add(userInfo.id_str);</span>
<a href="#l80.1219"></a><span id="l80.1219" class="difflineminus">-        let ids = msg.friends.filter(</span>
<a href="#l80.1220"></a><span id="l80.1220" class="difflineminus">-          aId =&gt; !userInfoIds.has(aId.toString()));</span>
<a href="#l80.1221"></a><span id="l80.1221" class="difflineplus">+        }</span>
<a href="#l80.1222"></a><span id="l80.1222" class="difflineplus">+        let ids = msg.friends.filter(aId =&gt; !userInfoIds.has(aId.toString()));</span>
<a href="#l80.1223"></a><span id="l80.1223"> </span>
<a href="#l80.1224"></a><span id="l80.1224">         while (ids.length) {</span>
<a href="#l80.1225"></a><span id="l80.1225">           // Take the first 100 elements, turn them into a comma separated list.</span>
<a href="#l80.1226"></a><span id="l80.1226" class="difflineminus">-          this.signAndSend(&quot;1.1/users/lookup.json&quot;, null,</span>
<a href="#l80.1227"></a><span id="l80.1227" class="difflineminus">-                           [[&quot;user_id&quot;, ids.slice(0, 99).join(&quot;,&quot;)]],</span>
<a href="#l80.1228"></a><span id="l80.1228" class="difflineminus">-                           this.onLookupReceived, null, this);</span>
<a href="#l80.1229"></a><span id="l80.1229" class="difflineplus">+          this.signAndSend(</span>
<a href="#l80.1230"></a><span id="l80.1230" class="difflineplus">+            &quot;1.1/users/lookup.json&quot;,</span>
<a href="#l80.1231"></a><span id="l80.1231" class="difflineplus">+            null,</span>
<a href="#l80.1232"></a><span id="l80.1232" class="difflineplus">+            [[&quot;user_id&quot;, ids.slice(0, 99).join(&quot;,&quot;)]],</span>
<a href="#l80.1233"></a><span id="l80.1233" class="difflineplus">+            this.onLookupReceived,</span>
<a href="#l80.1234"></a><span id="l80.1234" class="difflineplus">+            null,</span>
<a href="#l80.1235"></a><span id="l80.1235" class="difflineplus">+            this</span>
<a href="#l80.1236"></a><span id="l80.1236" class="difflineplus">+          );</span>
<a href="#l80.1237"></a><span id="l80.1237">           // Remove the first 100 elements.</span>
<a href="#l80.1238"></a><span id="l80.1238">           ids = ids.slice(100);</span>
<a href="#l80.1239"></a><span id="l80.1239">         }</span>
<a href="#l80.1240"></a><span id="l80.1240"> </span>
<a href="#l80.1241"></a><span id="l80.1241">         // Overwrite the existing _friends list (if any).</span>
<a href="#l80.1242"></a><span id="l80.1242">         this._friends = new Set(msg.friends.map(aId =&gt; aId.toString()));</span>
<a href="#l80.1243"></a><span id="l80.1243" class="difflineminus">-      }</span>
<a href="#l80.1244"></a><span id="l80.1244" class="difflineminus">-      else if (&quot;event&quot; in msg) {</span>
<a href="#l80.1245"></a><span id="l80.1245" class="difflineplus">+      } else if (&quot;event&quot; in msg) {</span>
<a href="#l80.1246"></a><span id="l80.1246">         let user, event;</span>
<a href="#l80.1247"></a><span id="l80.1247">         switch (msg.event) {</span>
<a href="#l80.1248"></a><span id="l80.1248">           case &quot;follow&quot;:</span>
<a href="#l80.1249"></a><span id="l80.1249">             if (msg.source.screen_name == this.name) {</span>
<a href="#l80.1250"></a><span id="l80.1250">               user = msg.target;</span>
<a href="#l80.1251"></a><span id="l80.1251">               event = &quot;follow&quot;;</span>
<a href="#l80.1252"></a><span id="l80.1252">               this.setUserInfo(user);</span>
<a href="#l80.1253"></a><span id="l80.1253">               this._friends.add(user.id_str);</span>
<a href="#l80.1254"></a><span id="l80.1254">               this.timeline._ensureParticipantExists(user.screen_name);</span>
<a href="#l80.1255"></a><span id="l80.1255" class="difflineminus">-            }</span>
<a href="#l80.1256"></a><span id="l80.1256" class="difflineminus">-            else if (msg.target.screen_name == this.name) {</span>
<a href="#l80.1257"></a><span id="l80.1257" class="difflineplus">+            } else if (msg.target.screen_name == this.name) {</span>
<a href="#l80.1258"></a><span id="l80.1258">               user = msg.source;</span>
<a href="#l80.1259"></a><span id="l80.1259">               event = &quot;followed&quot;;</span>
<a href="#l80.1260"></a><span id="l80.1260">             }</span>
<a href="#l80.1261"></a><span id="l80.1261">             if (user) {</span>
<a href="#l80.1262"></a><span id="l80.1262">               this.setUserInfo(user);</span>
<a href="#l80.1263"></a><span id="l80.1263" class="difflineminus">-              this.timeline.systemMessage(_(&quot;event.&quot; + event, user.screen_name),</span>
<a href="#l80.1264"></a><span id="l80.1264" class="difflineminus">-                                          false, new Date(msg.created_at) / 1000);</span>
<a href="#l80.1265"></a><span id="l80.1265" class="difflineplus">+              this.timeline.systemMessage(</span>
<a href="#l80.1266"></a><span id="l80.1266" class="difflineplus">+                _(&quot;event.&quot; + event, user.screen_name),</span>
<a href="#l80.1267"></a><span id="l80.1267" class="difflineplus">+                false,</span>
<a href="#l80.1268"></a><span id="l80.1268" class="difflineplus">+                new Date(msg.created_at) / 1000</span>
<a href="#l80.1269"></a><span id="l80.1269" class="difflineplus">+              );</span>
<a href="#l80.1270"></a><span id="l80.1270">             }</span>
<a href="#l80.1271"></a><span id="l80.1271">             break;</span>
<a href="#l80.1272"></a><span id="l80.1272">           case &quot;user_update&quot;:</span>
<a href="#l80.1273"></a><span id="l80.1273">             this.setUserInfo(msg.target);</span>
<a href="#l80.1274"></a><span id="l80.1274">             break;</span>
<a href="#l80.1275"></a><span id="l80.1275">         }</span>
<a href="#l80.1276"></a><span id="l80.1276">       }</span>
<a href="#l80.1277"></a><span id="l80.1277">     }</span>
<a href="#l80.1278"></a><span id="l80.1278">   },</span>
<a href="#l80.1279"></a><span id="l80.1279"> </span>
<a href="#l80.1280"></a><span id="l80.1280">   requestToken() {</span>
<a href="#l80.1281"></a><span id="l80.1281">     this.reportConnecting(_(&quot;connection.initAuth&quot;));</span>
<a href="#l80.1282"></a><span id="l80.1282" class="difflineminus">-    let oauthParams =</span>
<a href="#l80.1283"></a><span id="l80.1283" class="difflineminus">-      [[&quot;oauth_callback&quot;, encodeURIComponent(this.completionURI)]];</span>
<a href="#l80.1284"></a><span id="l80.1284" class="difflineminus">-    this.signAndSend(&quot;oauth/request_token&quot;, null, [],</span>
<a href="#l80.1285"></a><span id="l80.1285" class="difflineminus">-                     this.onRequestTokenReceived, this.onError, this,</span>
<a href="#l80.1286"></a><span id="l80.1286" class="difflineminus">-                     oauthParams);</span>
<a href="#l80.1287"></a><span id="l80.1287" class="difflineplus">+    let oauthParams = [</span>
<a href="#l80.1288"></a><span id="l80.1288" class="difflineplus">+      [&quot;oauth_callback&quot;, encodeURIComponent(this.completionURI)],</span>
<a href="#l80.1289"></a><span id="l80.1289" class="difflineplus">+    ];</span>
<a href="#l80.1290"></a><span id="l80.1290" class="difflineplus">+    this.signAndSend(</span>
<a href="#l80.1291"></a><span id="l80.1291" class="difflineplus">+      &quot;oauth/request_token&quot;,</span>
<a href="#l80.1292"></a><span id="l80.1292" class="difflineplus">+      null,</span>
<a href="#l80.1293"></a><span id="l80.1293" class="difflineplus">+      [],</span>
<a href="#l80.1294"></a><span id="l80.1294" class="difflineplus">+      this.onRequestTokenReceived,</span>
<a href="#l80.1295"></a><span id="l80.1295" class="difflineplus">+      this.onError,</span>
<a href="#l80.1296"></a><span id="l80.1296" class="difflineplus">+      this,</span>
<a href="#l80.1297"></a><span id="l80.1297" class="difflineplus">+      oauthParams</span>
<a href="#l80.1298"></a><span id="l80.1298" class="difflineplus">+    );</span>
<a href="#l80.1299"></a><span id="l80.1299">   },</span>
<a href="#l80.1300"></a><span id="l80.1300">   onRequestTokenReceived(aData) {</span>
<a href="#l80.1301"></a><span id="l80.1301">     this.LOG(&quot;Received request token.&quot;);</span>
<a href="#l80.1302"></a><span id="l80.1302">     let data = this._parseURLData(aData);</span>
<a href="#l80.1303"></a><span id="l80.1303" class="difflineminus">-    if (!data.oauth_callback_confirmed ||</span>
<a href="#l80.1304"></a><span id="l80.1304" class="difflineminus">-        !data.oauth_token || !data.oauth_token_secret) {</span>
<a href="#l80.1305"></a><span id="l80.1305" class="difflineminus">-      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l80.1306"></a><span id="l80.1306" class="difflineminus">-                           _(&quot;connection.failedToken&quot;));</span>
<a href="#l80.1307"></a><span id="l80.1307" class="difflineplus">+    if (</span>
<a href="#l80.1308"></a><span id="l80.1308" class="difflineplus">+      !data.oauth_callback_confirmed ||</span>
<a href="#l80.1309"></a><span id="l80.1309" class="difflineplus">+      !data.oauth_token ||</span>
<a href="#l80.1310"></a><span id="l80.1310" class="difflineplus">+      !data.oauth_token_secret</span>
<a href="#l80.1311"></a><span id="l80.1311" class="difflineplus">+    ) {</span>
<a href="#l80.1312"></a><span id="l80.1312" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l80.1313"></a><span id="l80.1313" class="difflineplus">+        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l80.1314"></a><span id="l80.1314" class="difflineplus">+        _(&quot;connection.failedToken&quot;)</span>
<a href="#l80.1315"></a><span id="l80.1315" class="difflineplus">+      );</span>
<a href="#l80.1316"></a><span id="l80.1316">       return;</span>
<a href="#l80.1317"></a><span id="l80.1317">     }</span>
<a href="#l80.1318"></a><span id="l80.1318">     this.token = data.oauth_token;</span>
<a href="#l80.1319"></a><span id="l80.1319">     this.tokenSecret = data.oauth_token_secret;</span>
<a href="#l80.1320"></a><span id="l80.1320"> </span>
<a href="#l80.1321"></a><span id="l80.1321">     this.requestAuthorization();</span>
<a href="#l80.1322"></a><span id="l80.1322">   },</span>
<a href="#l80.1323"></a><span id="l80.1323">   requestAuthorization() {</span>
<a href="#l80.1324"></a><span id="l80.1324">     this.reportConnecting(_(&quot;connection.requestAuth&quot;));</span>
<a href="#l80.1325"></a><span id="l80.1325" class="difflineminus">-    let url = this.baseURI + &quot;oauth/authorize?&quot; +</span>
<a href="#l80.1326"></a><span id="l80.1326" class="difflineplus">+    let url =</span>
<a href="#l80.1327"></a><span id="l80.1327" class="difflineplus">+      this.baseURI +</span>
<a href="#l80.1328"></a><span id="l80.1328" class="difflineplus">+      &quot;oauth/authorize?&quot; +</span>
<a href="#l80.1329"></a><span id="l80.1329">       &quot;force_login=true&amp;&quot; + // ignore cookies</span>
<a href="#l80.1330"></a><span id="l80.1330" class="difflineminus">-      &quot;screen_name=&quot; + this.name + &quot;&amp;&quot; + // prefill the user name input box</span>
<a href="#l80.1331"></a><span id="l80.1331" class="difflineminus">-      &quot;oauth_token=&quot; + this.token;</span>
<a href="#l80.1332"></a><span id="l80.1332" class="difflineplus">+      &quot;screen_name=&quot; +</span>
<a href="#l80.1333"></a><span id="l80.1333" class="difflineplus">+      this.name +</span>
<a href="#l80.1334"></a><span id="l80.1334" class="difflineplus">+      &quot;&amp;&quot; + // prefill the user name input box</span>
<a href="#l80.1335"></a><span id="l80.1335" class="difflineplus">+      &quot;oauth_token=&quot; +</span>
<a href="#l80.1336"></a><span id="l80.1336" class="difflineplus">+      this.token;</span>
<a href="#l80.1337"></a><span id="l80.1337">     this._browserRequest = {</span>
<a href="#l80.1338"></a><span id="l80.1338" class="difflineminus">-      get promptText() { return _(&quot;authPrompt&quot;); },</span>
<a href="#l80.1339"></a><span id="l80.1339" class="difflineplus">+      get promptText() {</span>
<a href="#l80.1340"></a><span id="l80.1340" class="difflineplus">+        return _(&quot;authPrompt&quot;);</span>
<a href="#l80.1341"></a><span id="l80.1341" class="difflineplus">+      },</span>
<a href="#l80.1342"></a><span id="l80.1342">       account: this,</span>
<a href="#l80.1343"></a><span id="l80.1343">       url,</span>
<a href="#l80.1344"></a><span id="l80.1344">       _active: true,</span>
<a href="#l80.1345"></a><span id="l80.1345">       cancelled() {</span>
<a href="#l80.1346"></a><span id="l80.1346" class="difflineminus">-        if (!this._active)</span>
<a href="#l80.1347"></a><span id="l80.1347" class="difflineplus">+        if (!this._active) {</span>
<a href="#l80.1348"></a><span id="l80.1348">           return;</span>
<a href="#l80.1349"></a><span id="l80.1349" class="difflineplus">+        }</span>
<a href="#l80.1350"></a><span id="l80.1350"> </span>
<a href="#l80.1351"></a><span id="l80.1351" class="difflineminus">-        this.account</span>
<a href="#l80.1352"></a><span id="l80.1352" class="difflineminus">-            .gotDisconnected(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l80.1353"></a><span id="l80.1353" class="difflineminus">-                             _(&quot;connection.error.authCancelled&quot;));</span>
<a href="#l80.1354"></a><span id="l80.1354" class="difflineplus">+        this.account.gotDisconnected(</span>
<a href="#l80.1355"></a><span id="l80.1355" class="difflineplus">+          Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l80.1356"></a><span id="l80.1356" class="difflineplus">+          _(&quot;connection.error.authCancelled&quot;)</span>
<a href="#l80.1357"></a><span id="l80.1357" class="difflineplus">+        );</span>
<a href="#l80.1358"></a><span id="l80.1358">       },</span>
<a href="#l80.1359"></a><span id="l80.1359">       loaded(aWindow, aWebProgress) {</span>
<a href="#l80.1360"></a><span id="l80.1360" class="difflineminus">-        if (!this._active)</span>
<a href="#l80.1361"></a><span id="l80.1361" class="difflineplus">+        if (!this._active) {</span>
<a href="#l80.1362"></a><span id="l80.1362">           return;</span>
<a href="#l80.1363"></a><span id="l80.1363" class="difflineplus">+        }</span>
<a href="#l80.1364"></a><span id="l80.1364"> </span>
<a href="#l80.1365"></a><span id="l80.1365">         this._listener = {</span>
<a href="#l80.1366"></a><span id="l80.1366" class="difflineminus">-          QueryInterface: ChromeUtils.generateQI([Ci.nsIWebProgressListener,</span>
<a href="#l80.1367"></a><span id="l80.1367" class="difflineminus">-                                                 Ci.nsISupportsWeakReference]),</span>
<a href="#l80.1368"></a><span id="l80.1368" class="difflineplus">+          QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l80.1369"></a><span id="l80.1369" class="difflineplus">+            Ci.nsIWebProgressListener,</span>
<a href="#l80.1370"></a><span id="l80.1370" class="difflineplus">+            Ci.nsISupportsWeakReference,</span>
<a href="#l80.1371"></a><span id="l80.1371" class="difflineplus">+          ]),</span>
<a href="#l80.1372"></a><span id="l80.1372">           _cleanUp() {</span>
<a href="#l80.1373"></a><span id="l80.1373">             this.webProgress.removeProgressListener(this);</span>
<a href="#l80.1374"></a><span id="l80.1374">             this.window.close();</span>
<a href="#l80.1375"></a><span id="l80.1375">             delete this.window;</span>
<a href="#l80.1376"></a><span id="l80.1376">           },</span>
<a href="#l80.1377"></a><span id="l80.1377">           _checkForRedirect(aURL) {</span>
<a href="#l80.1378"></a><span id="l80.1378" class="difflineminus">-            if (!aURL.startsWith(this._parent.completionURI))</span>
<a href="#l80.1379"></a><span id="l80.1379" class="difflineplus">+            if (!aURL.startsWith(this._parent.completionURI)) {</span>
<a href="#l80.1380"></a><span id="l80.1380">               return;</span>
<a href="#l80.1381"></a><span id="l80.1381" class="difflineplus">+            }</span>
<a href="#l80.1382"></a><span id="l80.1382"> </span>
<a href="#l80.1383"></a><span id="l80.1383">             this._parent.finishAuthorizationRequest();</span>
<a href="#l80.1384"></a><span id="l80.1384">             this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l80.1385"></a><span id="l80.1385">           },</span>
<a href="#l80.1386"></a><span id="l80.1386">           onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l80.1387"></a><span id="l80.1387">             const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l80.1388"></a><span id="l80.1388" class="difflineminus">-            if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK))</span>
<a href="#l80.1389"></a><span id="l80.1389" class="difflineplus">+            if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK)) {</span>
<a href="#l80.1390"></a><span id="l80.1390">               this._checkForRedirect(aRequest.name);</span>
<a href="#l80.1391"></a><span id="l80.1391" class="difflineplus">+            }</span>
<a href="#l80.1392"></a><span id="l80.1392">           },</span>
<a href="#l80.1393"></a><span id="l80.1393">           onLocationChange(aWebProgress, aRequest, aLocation) {</span>
<a href="#l80.1394"></a><span id="l80.1394">             this._checkForRedirect(aLocation.spec);</span>
<a href="#l80.1395"></a><span id="l80.1395">           },</span>
<a href="#l80.1396"></a><span id="l80.1396">           onProgressChange() {},</span>
<a href="#l80.1397"></a><span id="l80.1397">           onStatusChange() {},</span>
<a href="#l80.1398"></a><span id="l80.1398">           onSecurityChange() {},</span>
<a href="#l80.1399"></a><span id="l80.1399"> </span>
<a href="#l80.1400"></a><span id="l80.1400">           window: aWindow,</span>
<a href="#l80.1401"></a><span id="l80.1401">           webProgress: aWebProgress,</span>
<a href="#l80.1402"></a><span id="l80.1402">           _parent: this.account,</span>
<a href="#l80.1403"></a><span id="l80.1403">         };</span>
<a href="#l80.1404"></a><span id="l80.1404" class="difflineminus">-        aWebProgress.addProgressListener(this._listener,</span>
<a href="#l80.1405"></a><span id="l80.1405" class="difflineminus">-                                         Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l80.1406"></a><span id="l80.1406" class="difflineplus">+        aWebProgress.addProgressListener(</span>
<a href="#l80.1407"></a><span id="l80.1407" class="difflineplus">+          this._listener,</span>
<a href="#l80.1408"></a><span id="l80.1408" class="difflineplus">+          Ci.nsIWebProgress.NOTIFY_ALL</span>
<a href="#l80.1409"></a><span id="l80.1409" class="difflineplus">+        );</span>
<a href="#l80.1410"></a><span id="l80.1410">       },</span>
<a href="#l80.1411"></a><span id="l80.1411">       QueryInterface: ChromeUtils.generateQI([Ci.prplIRequestBrowser]),</span>
<a href="#l80.1412"></a><span id="l80.1412">     };</span>
<a href="#l80.1413"></a><span id="l80.1413">     Services.obs.notifyObservers(this._browserRequest, &quot;browser-request&quot;);</span>
<a href="#l80.1414"></a><span id="l80.1414">   },</span>
<a href="#l80.1415"></a><span id="l80.1415">   finishAuthorizationRequest() {</span>
<a href="#l80.1416"></a><span id="l80.1416">     // Clean up the cookies, so that several twitter OAuth dialogs can work</span>
<a href="#l80.1417"></a><span id="l80.1417">     // during the same session (bug 954308).</span>
<a href="#l80.1418"></a><span id="l80.1418">     let cookies = Services.cookies.getCookiesFromHost(&quot;twitter.com&quot;, {});</span>
<a href="#l80.1419"></a><span id="l80.1419">     while (cookies.hasMoreElements()) {</span>
<a href="#l80.1420"></a><span id="l80.1420">       let cookie = cookies.getNext().QueryInterface(Ci.nsICookie);</span>
<a href="#l80.1421"></a><span id="l80.1421" class="difflineminus">-      Services.cookies.remove(cookie.host, cookie.name, cookie.path, false,</span>
<a href="#l80.1422"></a><span id="l80.1422" class="difflineminus">-                              cookie.originAttributes);</span>
<a href="#l80.1423"></a><span id="l80.1423" class="difflineplus">+      Services.cookies.remove(</span>
<a href="#l80.1424"></a><span id="l80.1424" class="difflineplus">+        cookie.host,</span>
<a href="#l80.1425"></a><span id="l80.1425" class="difflineplus">+        cookie.name,</span>
<a href="#l80.1426"></a><span id="l80.1426" class="difflineplus">+        cookie.path,</span>
<a href="#l80.1427"></a><span id="l80.1427" class="difflineplus">+        false,</span>
<a href="#l80.1428"></a><span id="l80.1428" class="difflineplus">+        cookie.originAttributes</span>
<a href="#l80.1429"></a><span id="l80.1429" class="difflineplus">+      );</span>
<a href="#l80.1430"></a><span id="l80.1430">     }</span>
<a href="#l80.1431"></a><span id="l80.1431"> </span>
<a href="#l80.1432"></a><span id="l80.1432" class="difflineminus">-    if (!(&quot;_browserRequest&quot; in this))</span>
<a href="#l80.1433"></a><span id="l80.1433" class="difflineplus">+    if (!(&quot;_browserRequest&quot; in this)) {</span>
<a href="#l80.1434"></a><span id="l80.1434">       return;</span>
<a href="#l80.1435"></a><span id="l80.1435" class="difflineplus">+    }</span>
<a href="#l80.1436"></a><span id="l80.1436">     this._browserRequest._active = false;</span>
<a href="#l80.1437"></a><span id="l80.1437" class="difflineminus">-    if (&quot;_listener&quot; in this._browserRequest)</span>
<a href="#l80.1438"></a><span id="l80.1438" class="difflineplus">+    if (&quot;_listener&quot; in this._browserRequest) {</span>
<a href="#l80.1439"></a><span id="l80.1439">       this._browserRequest._listener._cleanUp();</span>
<a href="#l80.1440"></a><span id="l80.1440" class="difflineplus">+    }</span>
<a href="#l80.1441"></a><span id="l80.1441">     delete this._browserRequest;</span>
<a href="#l80.1442"></a><span id="l80.1442">   },</span>
<a href="#l80.1443"></a><span id="l80.1443">   onAuthorizationReceived(aData) {</span>
<a href="#l80.1444"></a><span id="l80.1444">     let data = this._parseURLData(aData.split(&quot;?&quot;)[1]);</span>
<a href="#l80.1445"></a><span id="l80.1445">     if (data.oauth_token != this.token || !data.oauth_verifier) {</span>
<a href="#l80.1446"></a><span id="l80.1446" class="difflineminus">-      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l80.1447"></a><span id="l80.1447" class="difflineminus">-                           _(&quot;connection.error.authFailed&quot;));</span>
<a href="#l80.1448"></a><span id="l80.1448" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l80.1449"></a><span id="l80.1449" class="difflineplus">+        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l80.1450"></a><span id="l80.1450" class="difflineplus">+        _(&quot;connection.error.authFailed&quot;)</span>
<a href="#l80.1451"></a><span id="l80.1451" class="difflineplus">+      );</span>
<a href="#l80.1452"></a><span id="l80.1452">       return;</span>
<a href="#l80.1453"></a><span id="l80.1453">     }</span>
<a href="#l80.1454"></a><span id="l80.1454">     this.requestAccessToken(data.oauth_verifier);</span>
<a href="#l80.1455"></a><span id="l80.1455">   },</span>
<a href="#l80.1456"></a><span id="l80.1456">   requestAccessToken(aTokenVerifier) {</span>
<a href="#l80.1457"></a><span id="l80.1457">     this.reportConnecting(_(&quot;connection.requestAccess&quot;));</span>
<a href="#l80.1458"></a><span id="l80.1458" class="difflineminus">-    this.signAndSend(&quot;oauth/access_token&quot;, null, [],</span>
<a href="#l80.1459"></a><span id="l80.1459" class="difflineminus">-                     this.onAccessTokenReceived, this.onError, this,</span>
<a href="#l80.1460"></a><span id="l80.1460" class="difflineminus">-                     [[&quot;oauth_verifier&quot;, aTokenVerifier]]);</span>
<a href="#l80.1461"></a><span id="l80.1461" class="difflineplus">+    this.signAndSend(</span>
<a href="#l80.1462"></a><span id="l80.1462" class="difflineplus">+      &quot;oauth/access_token&quot;,</span>
<a href="#l80.1463"></a><span id="l80.1463" class="difflineplus">+      null,</span>
<a href="#l80.1464"></a><span id="l80.1464" class="difflineplus">+      [],</span>
<a href="#l80.1465"></a><span id="l80.1465" class="difflineplus">+      this.onAccessTokenReceived,</span>
<a href="#l80.1466"></a><span id="l80.1466" class="difflineplus">+      this.onError,</span>
<a href="#l80.1467"></a><span id="l80.1467" class="difflineplus">+      this,</span>
<a href="#l80.1468"></a><span id="l80.1468" class="difflineplus">+      [[&quot;oauth_verifier&quot;, aTokenVerifier]]</span>
<a href="#l80.1469"></a><span id="l80.1469" class="difflineplus">+    );</span>
<a href="#l80.1470"></a><span id="l80.1470">   },</span>
<a href="#l80.1471"></a><span id="l80.1471">   onAccessTokenReceived(aData) {</span>
<a href="#l80.1472"></a><span id="l80.1472">     this.LOG(&quot;Received access token.&quot;);</span>
<a href="#l80.1473"></a><span id="l80.1473">     let result = this._parseURLData(aData);</span>
<a href="#l80.1474"></a><span id="l80.1474" class="difflineminus">-    if (!this.fixAccountName(result))</span>
<a href="#l80.1475"></a><span id="l80.1475" class="difflineplus">+    if (!this.fixAccountName(result)) {</span>
<a href="#l80.1476"></a><span id="l80.1476">       return;</span>
<a href="#l80.1477"></a><span id="l80.1477" class="difflineplus">+    }</span>
<a href="#l80.1478"></a><span id="l80.1478"> </span>
<a href="#l80.1479"></a><span id="l80.1479">     let prefValue = {};</span>
<a href="#l80.1480"></a><span id="l80.1480">     try {</span>
<a href="#l80.1481"></a><span id="l80.1481">       JSON.parse(this.prefs.getCharPref(&quot;oauth&quot;));</span>
<a href="#l80.1482"></a><span id="l80.1482" class="difflineminus">-    } catch (e) { }</span>
<a href="#l80.1483"></a><span id="l80.1483" class="difflineplus">+    } catch (e) {}</span>
<a href="#l80.1484"></a><span id="l80.1484">     prefValue[this.consumerKey] = result;</span>
<a href="#l80.1485"></a><span id="l80.1485">     this.prefs.setCharPref(&quot;oauth&quot;, JSON.stringify(prefValue));</span>
<a href="#l80.1486"></a><span id="l80.1486"> </span>
<a href="#l80.1487"></a><span id="l80.1487">     this.token = result.oauth_token;</span>
<a href="#l80.1488"></a><span id="l80.1488">     this.tokenSecret = result.oauth_token_secret;</span>
<a href="#l80.1489"></a><span id="l80.1489"> </span>
<a href="#l80.1490"></a><span id="l80.1490">     this.getTimelines();</span>
<a href="#l80.1491"></a><span id="l80.1491">   },</span>
<a href="#l80.1492"></a><span id="l80.1492">   fixAccountName(aAuthResult) {</span>
<a href="#l80.1493"></a><span id="l80.1493" class="difflineminus">-    if (!aAuthResult.screen_name || aAuthResult.screen_name == this.name)</span>
<a href="#l80.1494"></a><span id="l80.1494" class="difflineplus">+    if (!aAuthResult.screen_name || aAuthResult.screen_name == this.name) {</span>
<a href="#l80.1495"></a><span id="l80.1495">       return true;</span>
<a href="#l80.1496"></a><span id="l80.1496" class="difflineplus">+    }</span>
<a href="#l80.1497"></a><span id="l80.1497"> </span>
<a href="#l80.1498"></a><span id="l80.1498">     if (aAuthResult.screen_name.toLowerCase() != this.name.toLowerCase()) {</span>
<a href="#l80.1499"></a><span id="l80.1499">       this.onError(_(&quot;connection.error.userMismatch&quot;));</span>
<a href="#l80.1500"></a><span id="l80.1500">       return false;</span>
<a href="#l80.1501"></a><span id="l80.1501">     }</span>
<a href="#l80.1502"></a><span id="l80.1502"> </span>
<a href="#l80.1503"></a><span id="l80.1503" class="difflineminus">-    this.LOG(&quot;Fixing the case of the account name: &quot; +</span>
<a href="#l80.1504"></a><span id="l80.1504" class="difflineminus">-             this.name + &quot; -&gt; &quot; + aAuthResult.screen_name);</span>
<a href="#l80.1505"></a><span id="l80.1505" class="difflineplus">+    this.LOG(</span>
<a href="#l80.1506"></a><span id="l80.1506" class="difflineplus">+      &quot;Fixing the case of the account name: &quot; +</span>
<a href="#l80.1507"></a><span id="l80.1507" class="difflineplus">+        this.name +</span>
<a href="#l80.1508"></a><span id="l80.1508" class="difflineplus">+        &quot; -&gt; &quot; +</span>
<a href="#l80.1509"></a><span id="l80.1509" class="difflineplus">+        aAuthResult.screen_name</span>
<a href="#l80.1510"></a><span id="l80.1510" class="difflineplus">+    );</span>
<a href="#l80.1511"></a><span id="l80.1511">     this.__defineGetter__(&quot;name&quot;, () =&gt; aAuthResult.screen_name);</span>
<a href="#l80.1512"></a><span id="l80.1512">     return true;</span>
<a href="#l80.1513"></a><span id="l80.1513">   },</span>
<a href="#l80.1514"></a><span id="l80.1514"> </span>
<a href="#l80.1515"></a><span id="l80.1515">   cleanUp() {</span>
<a href="#l80.1516"></a><span id="l80.1516">     this.finishAuthorizationRequest();</span>
<a href="#l80.1517"></a><span id="l80.1517">     if (this._pendingRequests.length != 0) {</span>
<a href="#l80.1518"></a><span id="l80.1518" class="difflineminus">-      for (let request of this._pendingRequests)</span>
<a href="#l80.1519"></a><span id="l80.1519" class="difflineplus">+      for (let request of this._pendingRequests) {</span>
<a href="#l80.1520"></a><span id="l80.1520">         request.abort();</span>
<a href="#l80.1521"></a><span id="l80.1521" class="difflineplus">+      }</span>
<a href="#l80.1522"></a><span id="l80.1522">       delete this._pendingRequests;</span>
<a href="#l80.1523"></a><span id="l80.1523">     }</span>
<a href="#l80.1524"></a><span id="l80.1524">     if (this._streamTimeout) {</span>
<a href="#l80.1525"></a><span id="l80.1525">       clearTimeout(this._streamTimeout);</span>
<a href="#l80.1526"></a><span id="l80.1526">       delete this._streamTimeout;</span>
<a href="#l80.1527"></a><span id="l80.1527">       // Remove the preference observer that is added when the user stream is</span>
<a href="#l80.1528"></a><span id="l80.1528">       // opened. (This needs to be removed even if an error occurs, in which</span>
<a href="#l80.1529"></a><span id="l80.1529">       // case _streamingRequest is immediately deleted.)</span>
<a href="#l80.1530"></a><span id="l80.1530" class="difflineat">@@ -1069,99 +1322,120 @@ Account.prototype = {</span>
<a href="#l80.1531"></a><span id="l80.1531">       this._streamingRequest.abort();</span>
<a href="#l80.1532"></a><span id="l80.1532">       delete this._streamingRequest;</span>
<a href="#l80.1533"></a><span id="l80.1533">     }</span>
<a href="#l80.1534"></a><span id="l80.1534">     delete this._pendingData;</span>
<a href="#l80.1535"></a><span id="l80.1535">     delete this.token;</span>
<a href="#l80.1536"></a><span id="l80.1536">     delete this.tokenSecret;</span>
<a href="#l80.1537"></a><span id="l80.1537">   },</span>
<a href="#l80.1538"></a><span id="l80.1538">   gotDisconnected(aError, aErrorMessage) {</span>
<a href="#l80.1539"></a><span id="l80.1539" class="difflineminus">-    if (this.disconnected || this.disconnecting)</span>
<a href="#l80.1540"></a><span id="l80.1540" class="difflineplus">+    if (this.disconnected || this.disconnecting) {</span>
<a href="#l80.1541"></a><span id="l80.1541">       return;</span>
<a href="#l80.1542"></a><span id="l80.1542" class="difflineplus">+    }</span>
<a href="#l80.1543"></a><span id="l80.1543"> </span>
<a href="#l80.1544"></a><span id="l80.1544" class="difflineminus">-    if (aError === undefined)</span>
<a href="#l80.1545"></a><span id="l80.1545" class="difflineplus">+    if (aError === undefined) {</span>
<a href="#l80.1546"></a><span id="l80.1546">       aError = Ci.prplIAccount.NO_ERROR;</span>
<a href="#l80.1547"></a><span id="l80.1547" class="difflineplus">+    }</span>
<a href="#l80.1548"></a><span id="l80.1548">     let connected = this.connected;</span>
<a href="#l80.1549"></a><span id="l80.1549">     this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l80.1550"></a><span id="l80.1550">     this.cleanUp();</span>
<a href="#l80.1551"></a><span id="l80.1551" class="difflineminus">-    if (this._timeline &amp;&amp; connected)</span>
<a href="#l80.1552"></a><span id="l80.1552" class="difflineplus">+    if (this._timeline &amp;&amp; connected) {</span>
<a href="#l80.1553"></a><span id="l80.1553">       this._timeline.notifyObservers(this._timeline, &quot;update-conv-chatleft&quot;);</span>
<a href="#l80.1554"></a><span id="l80.1554" class="difflineplus">+    }</span>
<a href="#l80.1555"></a><span id="l80.1555">     this.reportDisconnected();</span>
<a href="#l80.1556"></a><span id="l80.1556">   },</span>
<a href="#l80.1557"></a><span id="l80.1557">   remove() {</span>
<a href="#l80.1558"></a><span id="l80.1558" class="difflineminus">-    if (!this._timeline)</span>
<a href="#l80.1559"></a><span id="l80.1559" class="difflineplus">+    if (!this._timeline) {</span>
<a href="#l80.1560"></a><span id="l80.1560">       return;</span>
<a href="#l80.1561"></a><span id="l80.1561" class="difflineplus">+    }</span>
<a href="#l80.1562"></a><span id="l80.1562">     this._timeline.close();</span>
<a href="#l80.1563"></a><span id="l80.1563">     delete this._timeline;</span>
<a href="#l80.1564"></a><span id="l80.1564">   },</span>
<a href="#l80.1565"></a><span id="l80.1565">   unInit() {</span>
<a href="#l80.1566"></a><span id="l80.1566">     this.cleanUp();</span>
<a href="#l80.1567"></a><span id="l80.1567">   },</span>
<a href="#l80.1568"></a><span id="l80.1568">   disconnect() {</span>
<a href="#l80.1569"></a><span id="l80.1569">     this.gotDisconnected();</span>
<a href="#l80.1570"></a><span id="l80.1570">   },</span>
<a href="#l80.1571"></a><span id="l80.1571"> </span>
<a href="#l80.1572"></a><span id="l80.1572">   onError(aException) {</span>
<a href="#l80.1573"></a><span id="l80.1573">     if (aException == &quot;offline&quot;) {</span>
<a href="#l80.1574"></a><span id="l80.1574" class="difflineminus">-      this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l80.1575"></a><span id="l80.1575" class="difflineminus">-                           _(&quot;connection.error.noNetwork&quot;));</span>
<a href="#l80.1576"></a><span id="l80.1576" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l80.1577"></a><span id="l80.1577" class="difflineplus">+        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l80.1578"></a><span id="l80.1578" class="difflineplus">+        _(&quot;connection.error.noNetwork&quot;)</span>
<a href="#l80.1579"></a><span id="l80.1579" class="difflineplus">+      );</span>
<a href="#l80.1580"></a><span id="l80.1580" class="difflineplus">+    } else {</span>
<a href="#l80.1581"></a><span id="l80.1581" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l80.1582"></a><span id="l80.1582" class="difflineplus">+        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l80.1583"></a><span id="l80.1583" class="difflineplus">+        aException.toString()</span>
<a href="#l80.1584"></a><span id="l80.1584" class="difflineplus">+      );</span>
<a href="#l80.1585"></a><span id="l80.1585">     }</span>
<a href="#l80.1586"></a><span id="l80.1586" class="difflineminus">-    else</span>
<a href="#l80.1587"></a><span id="l80.1587" class="difflineminus">-      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR, aException.toString());</span>
<a href="#l80.1588"></a><span id="l80.1588">   },</span>
<a href="#l80.1589"></a><span id="l80.1589"> </span>
<a href="#l80.1590"></a><span id="l80.1590">   setUserDescription(aDescription) {</span>
<a href="#l80.1591"></a><span id="l80.1591">     const kMaxUserDescriptionLength = 160;</span>
<a href="#l80.1592"></a><span id="l80.1592">     if (aDescription.length &gt; kMaxUserDescriptionLength) {</span>
<a href="#l80.1593"></a><span id="l80.1593">       aDescription = aDescription.substr(0, kMaxUserDescriptionLength);</span>
<a href="#l80.1594"></a><span id="l80.1594" class="difflineminus">-      this.WARN(&quot;Description too long (over &quot; + kMaxUserDescriptionLength +</span>
<a href="#l80.1595"></a><span id="l80.1595" class="difflineminus">-                &quot; characters):\n&quot; + aDescription + &quot;.&quot;);</span>
<a href="#l80.1596"></a><span id="l80.1596" class="difflineplus">+      this.WARN(</span>
<a href="#l80.1597"></a><span id="l80.1597" class="difflineplus">+        &quot;Description too long (over &quot; +</span>
<a href="#l80.1598"></a><span id="l80.1598" class="difflineplus">+          kMaxUserDescriptionLength +</span>
<a href="#l80.1599"></a><span id="l80.1599" class="difflineplus">+          &quot; characters):\n&quot; +</span>
<a href="#l80.1600"></a><span id="l80.1600" class="difflineplus">+          aDescription +</span>
<a href="#l80.1601"></a><span id="l80.1601" class="difflineplus">+          &quot;.&quot;</span>
<a href="#l80.1602"></a><span id="l80.1602" class="difflineplus">+      );</span>
<a href="#l80.1603"></a><span id="l80.1603">       this.timeline.systemMessage(_(&quot;error.descriptionTooLong&quot;, aDescription));</span>
<a href="#l80.1604"></a><span id="l80.1604">     }</span>
<a href="#l80.1605"></a><span id="l80.1605">     // Don't need to catch the reply since the stream receives user_update.</span>
<a href="#l80.1606"></a><span id="l80.1606" class="difflineminus">-    this.signAndSend(&quot;1.1/account/update_profile.json&quot;, null,</span>
<a href="#l80.1607"></a><span id="l80.1607" class="difflineminus">-                     [[&quot;description&quot;, aDescription]]);</span>
<a href="#l80.1608"></a><span id="l80.1608" class="difflineplus">+    this.signAndSend(&quot;1.1/account/update_profile.json&quot;, null, [</span>
<a href="#l80.1609"></a><span id="l80.1609" class="difflineplus">+      [&quot;description&quot;, aDescription],</span>
<a href="#l80.1610"></a><span id="l80.1610" class="difflineplus">+    ]);</span>
<a href="#l80.1611"></a><span id="l80.1611">   },</span>
<a href="#l80.1612"></a><span id="l80.1612"> </span>
<a href="#l80.1613"></a><span id="l80.1613">   setUserInfo(aUser) {</span>
<a href="#l80.1614"></a><span id="l80.1614">     let nick = aUser.screen_name;</span>
<a href="#l80.1615"></a><span id="l80.1615">     this._userInfo.set(nick, aUser);</span>
<a href="#l80.1616"></a><span id="l80.1616"> </span>
<a href="#l80.1617"></a><span id="l80.1617">     // If it's the user's userInfo, update the timeline topic.</span>
<a href="#l80.1618"></a><span id="l80.1618" class="difflineminus">-    if (nick == this.name &amp;&amp; &quot;description&quot; in aUser)</span>
<a href="#l80.1619"></a><span id="l80.1619" class="difflineplus">+    if (nick == this.name &amp;&amp; &quot;description&quot; in aUser) {</span>
<a href="#l80.1620"></a><span id="l80.1620">       this.timeline.setTopic(aUser.description, nick, true);</span>
<a href="#l80.1621"></a><span id="l80.1621" class="difflineplus">+    }</span>
<a href="#l80.1622"></a><span id="l80.1622">   },</span>
<a href="#l80.1623"></a><span id="l80.1623">   onRequestedInfoReceived(aData) {</span>
<a href="#l80.1624"></a><span id="l80.1624">     let user = JSON.parse(aData);</span>
<a href="#l80.1625"></a><span id="l80.1625">     this.setUserInfo(user);</span>
<a href="#l80.1626"></a><span id="l80.1626">     this.requestBuddyInfo(user.screen_name);</span>
<a href="#l80.1627"></a><span id="l80.1627">   },</span>
<a href="#l80.1628"></a><span id="l80.1628">   requestBuddyInfo(aBuddyName) {</span>
<a href="#l80.1629"></a><span id="l80.1629">     let userInfo = this._userInfo.get(aBuddyName);</span>
<a href="#l80.1630"></a><span id="l80.1630">     if (!userInfo) {</span>
<a href="#l80.1631"></a><span id="l80.1631" class="difflineminus">-      this.signAndSend(&quot;1.1/users/show.json?screen_name=&quot; + aBuddyName, null,</span>
<a href="#l80.1632"></a><span id="l80.1632" class="difflineminus">-                       null, this.onRequestedInfoReceived, null, this);</span>
<a href="#l80.1633"></a><span id="l80.1633" class="difflineplus">+      this.signAndSend(</span>
<a href="#l80.1634"></a><span id="l80.1634" class="difflineplus">+        &quot;1.1/users/show.json?screen_name=&quot; + aBuddyName,</span>
<a href="#l80.1635"></a><span id="l80.1635" class="difflineplus">+        null,</span>
<a href="#l80.1636"></a><span id="l80.1636" class="difflineplus">+        null,</span>
<a href="#l80.1637"></a><span id="l80.1637" class="difflineplus">+        this.onRequestedInfoReceived,</span>
<a href="#l80.1638"></a><span id="l80.1638" class="difflineplus">+        null,</span>
<a href="#l80.1639"></a><span id="l80.1639" class="difflineplus">+        this</span>
<a href="#l80.1640"></a><span id="l80.1640" class="difflineplus">+      );</span>
<a href="#l80.1641"></a><span id="l80.1641">       return;</span>
<a href="#l80.1642"></a><span id="l80.1642">     }</span>
<a href="#l80.1643"></a><span id="l80.1643"> </span>
<a href="#l80.1644"></a><span id="l80.1644">     // List of the names of the info to actually show in the tooltip and</span>
<a href="#l80.1645"></a><span id="l80.1645">     // optionally a transform function to apply to the value.</span>
<a href="#l80.1646"></a><span id="l80.1646">     // See https://dev.twitter.com/docs/api/1/get/users/show for the options.</span>
<a href="#l80.1647"></a><span id="l80.1647">     let normalizeBool = isFollowing =&gt; _(isFollowing ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l80.1648"></a><span id="l80.1648">     const kFields = {</span>
<a href="#l80.1649"></a><span id="l80.1649">       name: null,</span>
<a href="#l80.1650"></a><span id="l80.1650">       following: normalizeBool,</span>
<a href="#l80.1651"></a><span id="l80.1651">       description: null,</span>
<a href="#l80.1652"></a><span id="l80.1652">       url: null,</span>
<a href="#l80.1653"></a><span id="l80.1653">       location: null,</span>
<a href="#l80.1654"></a><span id="l80.1654">       lang(aLang) {</span>
<a href="#l80.1655"></a><span id="l80.1655">         try {</span>
<a href="#l80.1656"></a><span id="l80.1656">           return _lang(aLang);</span>
<a href="#l80.1657"></a><span id="l80.1657" class="difflineminus">-        }</span>
<a href="#l80.1658"></a><span id="l80.1658" class="difflineminus">-        catch (e) {</span>
<a href="#l80.1659"></a><span id="l80.1659" class="difflineplus">+        } catch (e) {</span>
<a href="#l80.1660"></a><span id="l80.1660">           return aLang;</span>
<a href="#l80.1661"></a><span id="l80.1661">         }</span>
<a href="#l80.1662"></a><span id="l80.1662">       },</span>
<a href="#l80.1663"></a><span id="l80.1663">       time_zone: null,</span>
<a href="#l80.1664"></a><span id="l80.1664">       protected: normalizeBool,</span>
<a href="#l80.1665"></a><span id="l80.1665">       created_at(aDate) {</span>
<a href="#l80.1666"></a><span id="l80.1666">         const dateFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l80.1667"></a><span id="l80.1667">           dateStyle: &quot;short&quot;,</span>
<a href="#l80.1668"></a><span id="l80.1668" class="difflineat">@@ -1171,102 +1445,143 @@ Account.prototype = {</span>
<a href="#l80.1669"></a><span id="l80.1669">       statuses_count: null,</span>
<a href="#l80.1670"></a><span id="l80.1670">       friends_count: null,</span>
<a href="#l80.1671"></a><span id="l80.1671">       followers_count: null,</span>
<a href="#l80.1672"></a><span id="l80.1672">       listed_count: null,</span>
<a href="#l80.1673"></a><span id="l80.1673">     };</span>
<a href="#l80.1674"></a><span id="l80.1674"> </span>
<a href="#l80.1675"></a><span id="l80.1675">     let tooltipInfo = [];</span>
<a href="#l80.1676"></a><span id="l80.1676">     for (let field in kFields) {</span>
<a href="#l80.1677"></a><span id="l80.1677" class="difflineminus">-      if (Object.prototype.hasOwnProperty.call(userInfo, field) &amp;&amp;</span>
<a href="#l80.1678"></a><span id="l80.1678" class="difflineminus">-          userInfo[field]) {</span>
<a href="#l80.1679"></a><span id="l80.1679" class="difflineplus">+      if (</span>
<a href="#l80.1680"></a><span id="l80.1680" class="difflineplus">+        Object.prototype.hasOwnProperty.call(userInfo, field) &amp;&amp;</span>
<a href="#l80.1681"></a><span id="l80.1681" class="difflineplus">+        userInfo[field]</span>
<a href="#l80.1682"></a><span id="l80.1682" class="difflineplus">+      ) {</span>
<a href="#l80.1683"></a><span id="l80.1683">         let value = userInfo[field];</span>
<a href="#l80.1684"></a><span id="l80.1684" class="difflineminus">-        if (kFields[field])</span>
<a href="#l80.1685"></a><span id="l80.1685" class="difflineplus">+        if (kFields[field]) {</span>
<a href="#l80.1686"></a><span id="l80.1686">           value = kFields[field](value);</span>
<a href="#l80.1687"></a><span id="l80.1687" class="difflineplus">+        }</span>
<a href="#l80.1688"></a><span id="l80.1688">         tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l80.1689"></a><span id="l80.1689">       }</span>
<a href="#l80.1690"></a><span id="l80.1690">     }</span>
<a href="#l80.1691"></a><span id="l80.1691" class="difflineminus">-    tooltipInfo.push(new TooltipInfo(null, userInfo.profile_image_url,</span>
<a href="#l80.1692"></a><span id="l80.1692" class="difflineminus">-                                     Ci.prplITooltipInfo.icon));</span>
<a href="#l80.1693"></a><span id="l80.1693" class="difflineplus">+    tooltipInfo.push(</span>
<a href="#l80.1694"></a><span id="l80.1694" class="difflineplus">+      new TooltipInfo(</span>
<a href="#l80.1695"></a><span id="l80.1695" class="difflineplus">+        null,</span>
<a href="#l80.1696"></a><span id="l80.1696" class="difflineplus">+        userInfo.profile_image_url,</span>
<a href="#l80.1697"></a><span id="l80.1697" class="difflineplus">+        Ci.prplITooltipInfo.icon</span>
<a href="#l80.1698"></a><span id="l80.1698" class="difflineplus">+      )</span>
<a href="#l80.1699"></a><span id="l80.1699" class="difflineplus">+    );</span>
<a href="#l80.1700"></a><span id="l80.1700"> </span>
<a href="#l80.1701"></a><span id="l80.1701" class="difflineminus">-    Services.obs.notifyObservers(new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l80.1702"></a><span id="l80.1702" class="difflineminus">-                                 &quot;user-info-received&quot;, aBuddyName);</span>
<a href="#l80.1703"></a><span id="l80.1703" class="difflineplus">+    Services.obs.notifyObservers(</span>
<a href="#l80.1704"></a><span id="l80.1704" class="difflineplus">+      new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l80.1705"></a><span id="l80.1705" class="difflineplus">+      &quot;user-info-received&quot;,</span>
<a href="#l80.1706"></a><span id="l80.1706" class="difflineplus">+      aBuddyName</span>
<a href="#l80.1707"></a><span id="l80.1707" class="difflineplus">+    );</span>
<a href="#l80.1708"></a><span id="l80.1708">   },</span>
<a href="#l80.1709"></a><span id="l80.1709"> </span>
<a href="#l80.1710"></a><span id="l80.1710">   // Handle the full user info for each received friend. Set the user info and</span>
<a href="#l80.1711"></a><span id="l80.1711">   // create the participant.</span>
<a href="#l80.1712"></a><span id="l80.1712">   onLookupReceived(aData) {</span>
<a href="#l80.1713"></a><span id="l80.1713">     let users = JSON.parse(aData);</span>
<a href="#l80.1714"></a><span id="l80.1714">     for (let user of users) {</span>
<a href="#l80.1715"></a><span id="l80.1715">       this.setUserInfo(user);</span>
<a href="#l80.1716"></a><span id="l80.1716">       this.timeline._ensureParticipantExists(user.screen_name);</span>
<a href="#l80.1717"></a><span id="l80.1717">     }</span>
<a href="#l80.1718"></a><span id="l80.1718">   },</span>
<a href="#l80.1719"></a><span id="l80.1719"> </span>
<a href="#l80.1720"></a><span id="l80.1720">   // Allow us to reopen the timeline via the join chat menu.</span>
<a href="#l80.1721"></a><span id="l80.1721" class="difflineminus">-  get canJoinChat() { return true; },</span>
<a href="#l80.1722"></a><span id="l80.1722" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l80.1723"></a><span id="l80.1723" class="difflineplus">+    return true;</span>
<a href="#l80.1724"></a><span id="l80.1724" class="difflineplus">+  },</span>
<a href="#l80.1725"></a><span id="l80.1725">   joinChat(aComponents) {</span>
<a href="#l80.1726"></a><span id="l80.1726">     // The 'timeline' getter opens a timeline conversation if none exists.</span>
<a href="#l80.1727"></a><span id="l80.1727">     this.timeline;</span>
<a href="#l80.1728"></a><span id="l80.1728">   },</span>
<a href="#l80.1729"></a><span id="l80.1729"> </span>
<a href="#l80.1730"></a><span id="l80.1730">   getConversation(aName) {</span>
<a href="#l80.1731"></a><span id="l80.1731" class="difflineminus">-    if (!this._conversations.has(aName))</span>
<a href="#l80.1732"></a><span id="l80.1732" class="difflineminus">-      this._conversations.set(aName, new DirectMessageConversation(this, aName));</span>
<a href="#l80.1733"></a><span id="l80.1733" class="difflineplus">+    if (!this._conversations.has(aName)) {</span>
<a href="#l80.1734"></a><span id="l80.1734" class="difflineplus">+      this._conversations.set(</span>
<a href="#l80.1735"></a><span id="l80.1735" class="difflineplus">+        aName,</span>
<a href="#l80.1736"></a><span id="l80.1736" class="difflineplus">+        new DirectMessageConversation(this, aName)</span>
<a href="#l80.1737"></a><span id="l80.1737" class="difflineplus">+      );</span>
<a href="#l80.1738"></a><span id="l80.1738" class="difflineplus">+    }</span>
<a href="#l80.1739"></a><span id="l80.1739">     return this._conversations.get(aName);</span>
<a href="#l80.1740"></a><span id="l80.1740">   },</span>
<a href="#l80.1741"></a><span id="l80.1741">   removeConversation(aName) {</span>
<a href="#l80.1742"></a><span id="l80.1742" class="difflineminus">-    if (this._conversations.has(aName))</span>
<a href="#l80.1743"></a><span id="l80.1743" class="difflineplus">+    if (this._conversations.has(aName)) {</span>
<a href="#l80.1744"></a><span id="l80.1744">       this._conversations.delete(aName);</span>
<a href="#l80.1745"></a><span id="l80.1745" class="difflineplus">+    }</span>
<a href="#l80.1746"></a><span id="l80.1746">   },</span>
<a href="#l80.1747"></a><span id="l80.1747">   createConversation(aName) {</span>
<a href="#l80.1748"></a><span id="l80.1748">     return this.getConversation(aName);</span>
<a href="#l80.1749"></a><span id="l80.1749">   },</span>
<a href="#l80.1750"></a><span id="l80.1750"> };</span>
<a href="#l80.1751"></a><span id="l80.1751"> </span>
<a href="#l80.1752"></a><span id="l80.1752"> // Shortcut to get the JavaScript account object.</span>
<a href="#l80.1753"></a><span id="l80.1753" class="difflineminus">-function getAccount(aConv) { return aConv.wrappedJSObject._account; }</span>
<a href="#l80.1754"></a><span id="l80.1754" class="difflineplus">+function getAccount(aConv) {</span>
<a href="#l80.1755"></a><span id="l80.1755" class="difflineplus">+  return aConv.wrappedJSObject._account;</span>
<a href="#l80.1756"></a><span id="l80.1756" class="difflineplus">+}</span>
<a href="#l80.1757"></a><span id="l80.1757"> </span>
<a href="#l80.1758"></a><span id="l80.1758"> function TwitterProtocol() {</span>
<a href="#l80.1759"></a><span id="l80.1759">   this.registerCommands();</span>
<a href="#l80.1760"></a><span id="l80.1760"> }</span>
<a href="#l80.1761"></a><span id="l80.1761"> TwitterProtocol.prototype = {</span>
<a href="#l80.1762"></a><span id="l80.1762">   __proto__: GenericProtocolPrototype,</span>
<a href="#l80.1763"></a><span id="l80.1763" class="difflineminus">-  get normalizedName() { return &quot;twitter&quot;; },</span>
<a href="#l80.1764"></a><span id="l80.1764" class="difflineminus">-  get name() { return _(&quot;twitter.protocolName&quot;); },</span>
<a href="#l80.1765"></a><span id="l80.1765" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-twitter/skin/&quot;; },</span>
<a href="#l80.1766"></a><span id="l80.1766" class="difflineminus">-  get noPassword() { return true; },</span>
<a href="#l80.1767"></a><span id="l80.1767" class="difflineplus">+  get normalizedName() {</span>
<a href="#l80.1768"></a><span id="l80.1768" class="difflineplus">+    return &quot;twitter&quot;;</span>
<a href="#l80.1769"></a><span id="l80.1769" class="difflineplus">+  },</span>
<a href="#l80.1770"></a><span id="l80.1770" class="difflineplus">+  get name() {</span>
<a href="#l80.1771"></a><span id="l80.1771" class="difflineplus">+    return _(&quot;twitter.protocolName&quot;);</span>
<a href="#l80.1772"></a><span id="l80.1772" class="difflineplus">+  },</span>
<a href="#l80.1773"></a><span id="l80.1773" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l80.1774"></a><span id="l80.1774" class="difflineplus">+    return &quot;chrome://prpl-twitter/skin/&quot;;</span>
<a href="#l80.1775"></a><span id="l80.1775" class="difflineplus">+  },</span>
<a href="#l80.1776"></a><span id="l80.1776" class="difflineplus">+  get noPassword() {</span>
<a href="#l80.1777"></a><span id="l80.1777" class="difflineplus">+    return true;</span>
<a href="#l80.1778"></a><span id="l80.1778" class="difflineplus">+  },</span>
<a href="#l80.1779"></a><span id="l80.1779">   options: {</span>
<a href="#l80.1780"></a><span id="l80.1780" class="difflineminus">-    &quot;track&quot;: {get label() { return _(&quot;options.track&quot;); }, default: &quot;&quot;},</span>
<a href="#l80.1781"></a><span id="l80.1781" class="difflineplus">+    track: {</span>
<a href="#l80.1782"></a><span id="l80.1782" class="difflineplus">+      get label() {</span>
<a href="#l80.1783"></a><span id="l80.1783" class="difflineplus">+        return _(&quot;options.track&quot;);</span>
<a href="#l80.1784"></a><span id="l80.1784" class="difflineplus">+      },</span>
<a href="#l80.1785"></a><span id="l80.1785" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l80.1786"></a><span id="l80.1786" class="difflineplus">+    },</span>
<a href="#l80.1787"></a><span id="l80.1787">   },</span>
<a href="#l80.1788"></a><span id="l80.1788">   // Replace the command name in the help string so translators do not attempt</span>
<a href="#l80.1789"></a><span id="l80.1789">   // to translate it.</span>
<a href="#l80.1790"></a><span id="l80.1790">   commands: [</span>
<a href="#l80.1791"></a><span id="l80.1791">     {</span>
<a href="#l80.1792"></a><span id="l80.1792">       name: &quot;follow&quot;,</span>
<a href="#l80.1793"></a><span id="l80.1793" class="difflineminus">-      get helpString() { return _(&quot;command.follow&quot;, &quot;follow&quot;); },</span>
<a href="#l80.1794"></a><span id="l80.1794" class="difflineplus">+      get helpString() {</span>
<a href="#l80.1795"></a><span id="l80.1795" class="difflineplus">+        return _(&quot;command.follow&quot;, &quot;follow&quot;);</span>
<a href="#l80.1796"></a><span id="l80.1796" class="difflineplus">+      },</span>
<a href="#l80.1797"></a><span id="l80.1797">       run(aMsg, aConv) {</span>
<a href="#l80.1798"></a><span id="l80.1798">         aMsg = aMsg.trim();</span>
<a href="#l80.1799"></a><span id="l80.1799" class="difflineminus">-        if (!aMsg)</span>
<a href="#l80.1800"></a><span id="l80.1800" class="difflineplus">+        if (!aMsg) {</span>
<a href="#l80.1801"></a><span id="l80.1801">           return false;</span>
<a href="#l80.1802"></a><span id="l80.1802" class="difflineplus">+        }</span>
<a href="#l80.1803"></a><span id="l80.1803">         let account = getAccount(aConv);</span>
<a href="#l80.1804"></a><span id="l80.1804">         aMsg.split(&quot; &quot;).forEach(account.follow, account);</span>
<a href="#l80.1805"></a><span id="l80.1805">         return true;</span>
<a href="#l80.1806"></a><span id="l80.1806">       },</span>
<a href="#l80.1807"></a><span id="l80.1807">     },</span>
<a href="#l80.1808"></a><span id="l80.1808">     {</span>
<a href="#l80.1809"></a><span id="l80.1809">       name: &quot;unfollow&quot;,</span>
<a href="#l80.1810"></a><span id="l80.1810" class="difflineminus">-      get helpString() { return _(&quot;command.unfollow&quot;, &quot;unfollow&quot;); },</span>
<a href="#l80.1811"></a><span id="l80.1811" class="difflineplus">+      get helpString() {</span>
<a href="#l80.1812"></a><span id="l80.1812" class="difflineplus">+        return _(&quot;command.unfollow&quot;, &quot;unfollow&quot;);</span>
<a href="#l80.1813"></a><span id="l80.1813" class="difflineplus">+      },</span>
<a href="#l80.1814"></a><span id="l80.1814">       run(aMsg, aConv) {</span>
<a href="#l80.1815"></a><span id="l80.1815">         aMsg = aMsg.trim();</span>
<a href="#l80.1816"></a><span id="l80.1816" class="difflineminus">-        if (!aMsg)</span>
<a href="#l80.1817"></a><span id="l80.1817" class="difflineplus">+        if (!aMsg) {</span>
<a href="#l80.1818"></a><span id="l80.1818">           return false;</span>
<a href="#l80.1819"></a><span id="l80.1819" class="difflineplus">+        }</span>
<a href="#l80.1820"></a><span id="l80.1820">         let account = getAccount(aConv);</span>
<a href="#l80.1821"></a><span id="l80.1821">         aMsg.split(&quot; &quot;).forEach(account.stopFollowing, account);</span>
<a href="#l80.1822"></a><span id="l80.1822">         return true;</span>
<a href="#l80.1823"></a><span id="l80.1823">       },</span>
<a href="#l80.1824"></a><span id="l80.1824">     },</span>
<a href="#l80.1825"></a><span id="l80.1825">   ],</span>
<a href="#l80.1826"></a><span id="l80.1826" class="difflineminus">-  getAccount(aImAccount) { return new Account(this, aImAccount); },</span>
<a href="#l80.1827"></a><span id="l80.1827" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l80.1828"></a><span id="l80.1828" class="difflineplus">+    return new Account(this, aImAccount);</span>
<a href="#l80.1829"></a><span id="l80.1829" class="difflineplus">+  },</span>
<a href="#l80.1830"></a><span id="l80.1830">   classID: Components.ID(&quot;{31082ff6-1de8-422b-ab60-ca0ac0b2af13}&quot;),</span>
<a href="#l80.1831"></a><span id="l80.1831"> };</span>
<a href="#l80.1832"></a><span id="l80.1832"> </span>
<a href="#l80.1833"></a><span id="l80.1833"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([TwitterProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_authmechs.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_authmechs.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l81.4"></a><span id="l81.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l81.5"></a><span id="l81.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l81.6"></a><span id="l81.6"> </span>
<a href="#l81.7"></a><span id="l81.7" class="difflineminus">-var {XMPPAuthMechanisms} = ChromeUtils.import(&quot;resource:///modules/xmpp-authmechs.jsm&quot;);</span>
<a href="#l81.8"></a><span id="l81.8" class="difflineminus">-var {Stanza} = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l81.9"></a><span id="l81.9" class="difflineplus">+var { XMPPAuthMechanisms } = ChromeUtils.import(</span>
<a href="#l81.10"></a><span id="l81.10" class="difflineplus">+  &quot;resource:///modules/xmpp-authmechs.jsm&quot;</span>
<a href="#l81.11"></a><span id="l81.11" class="difflineplus">+);</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineplus">+var { Stanza } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l81.13"></a><span id="l81.13"> </span>
<a href="#l81.14"></a><span id="l81.14"> /*</span>
<a href="#l81.15"></a><span id="l81.15">  * Test PLAIN using the examples given in section 6 of RFC 6120.</span>
<a href="#l81.16"></a><span id="l81.16">  */</span>
<a href="#l81.17"></a><span id="l81.17"> add_task(async function testPlain() {</span>
<a href="#l81.18"></a><span id="l81.18">   const username = &quot;juliet&quot;;</span>
<a href="#l81.19"></a><span id="l81.19">   const password = &quot;r0m30myr0m30&quot;;</span>
<a href="#l81.20"></a><span id="l81.20"> </span>
<a href="#l81.21"></a><span id="l81.21" class="difflineat">@@ -37,34 +39,57 @@ add_task(async function testPlain() {</span>
<a href="#l81.22"></a><span id="l81.22">  */</span>
<a href="#l81.23"></a><span id="l81.23"> add_task(async function testScram() {</span>
<a href="#l81.24"></a><span id="l81.24">   const username = &quot;user&quot;;</span>
<a href="#l81.25"></a><span id="l81.25">   const password = &quot;pencil&quot;;</span>
<a href="#l81.26"></a><span id="l81.26"> </span>
<a href="#l81.27"></a><span id="l81.27">   // Use a constant value for the nonce.</span>
<a href="#l81.28"></a><span id="l81.28">   const nonce = &quot;fyko+d2lbbFgONRv9qkxdawL&quot;;</span>
<a href="#l81.29"></a><span id="l81.29"> </span>
<a href="#l81.30"></a><span id="l81.30" class="difflineminus">-  let mech = XMPPAuthMechanisms[&quot;SCRAM-SHA-1&quot;](username, password, undefined, nonce);</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineplus">+  let mech = XMPPAuthMechanisms[&quot;SCRAM-SHA-1&quot;](</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+    username,</span>
<a href="#l81.33"></a><span id="l81.33" class="difflineplus">+    password,</span>
<a href="#l81.34"></a><span id="l81.34" class="difflineplus">+    undefined,</span>
<a href="#l81.35"></a><span id="l81.35" class="difflineplus">+    nonce</span>
<a href="#l81.36"></a><span id="l81.36" class="difflineplus">+  );</span>
<a href="#l81.37"></a><span id="l81.37"> </span>
<a href="#l81.38"></a><span id="l81.38">   // Send the client-first-message.</span>
<a href="#l81.39"></a><span id="l81.39">   let result = mech.next();</span>
<a href="#l81.40"></a><span id="l81.40">   ok(!result.done);</span>
<a href="#l81.41"></a><span id="l81.41">   let value = await Promise.resolve(result.value);</span>
<a href="#l81.42"></a><span id="l81.42"> </span>
<a href="#l81.43"></a><span id="l81.43">   // Check the SCRAM content.</span>
<a href="#l81.44"></a><span id="l81.44" class="difflineminus">-  equal(atob(value.send.children[0].text), &quot;n,,n=user,r=fyko+d2lbbFgONRv9qkxdawL&quot;);</span>
<a href="#l81.45"></a><span id="l81.45" class="difflineplus">+  equal(</span>
<a href="#l81.46"></a><span id="l81.46" class="difflineplus">+    atob(value.send.children[0].text),</span>
<a href="#l81.47"></a><span id="l81.47" class="difflineplus">+    &quot;n,,n=user,r=fyko+d2lbbFgONRv9qkxdawL&quot;</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineplus">+  );</span>
<a href="#l81.49"></a><span id="l81.49"> </span>
<a href="#l81.50"></a><span id="l81.50">   // Receive the server-first-message and send the client-final-message.</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineminus">-  let response = Stanza.node(&quot;challenge&quot;, Stanza.NS.sasl, null, btoa(&quot;r=fyko+d2lbbFgONRv9qkxdawL3rfcNHYJY1ZVvWVs7j,s=QSXCR+Q6sek8bf92,i=4096&quot;));</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+  let response = Stanza.node(</span>
<a href="#l81.53"></a><span id="l81.53" class="difflineplus">+    &quot;challenge&quot;,</span>
<a href="#l81.54"></a><span id="l81.54" class="difflineplus">+    Stanza.NS.sasl,</span>
<a href="#l81.55"></a><span id="l81.55" class="difflineplus">+    null,</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineplus">+    btoa(</span>
<a href="#l81.57"></a><span id="l81.57" class="difflineplus">+      &quot;r=fyko+d2lbbFgONRv9qkxdawL3rfcNHYJY1ZVvWVs7j,s=QSXCR+Q6sek8bf92,i=4096&quot;</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineplus">+    )</span>
<a href="#l81.59"></a><span id="l81.59" class="difflineplus">+  );</span>
<a href="#l81.60"></a><span id="l81.60">   result = mech.next(response);</span>
<a href="#l81.61"></a><span id="l81.61">   ok(!result.done);</span>
<a href="#l81.62"></a><span id="l81.62">   value = await Promise.resolve(result.value);</span>
<a href="#l81.63"></a><span id="l81.63"> </span>
<a href="#l81.64"></a><span id="l81.64">   // Check the SCRAM content.</span>
<a href="#l81.65"></a><span id="l81.65" class="difflineminus">-  equal(atob(value.send.children[0].text), &quot;c=biws,r=fyko+d2lbbFgONRv9qkxdawL3rfcNHYJY1ZVvWVs7j,p=v0X8v3Bz2T0CJGbJQyF0X+HI4Ts=&quot;);</span>
<a href="#l81.66"></a><span id="l81.66" class="difflineplus">+  equal(</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineplus">+    atob(value.send.children[0].text),</span>
<a href="#l81.68"></a><span id="l81.68" class="difflineplus">+    &quot;c=biws,r=fyko+d2lbbFgONRv9qkxdawL3rfcNHYJY1ZVvWVs7j,p=v0X8v3Bz2T0CJGbJQyF0X+HI4Ts=&quot;</span>
<a href="#l81.69"></a><span id="l81.69" class="difflineplus">+  );</span>
<a href="#l81.70"></a><span id="l81.70"> </span>
<a href="#l81.71"></a><span id="l81.71">   // Receive the server-final-message.</span>
<a href="#l81.72"></a><span id="l81.72" class="difflineminus">-  response = Stanza.node(&quot;success&quot;, Stanza.NS.sasl, null, btoa(&quot;v=rmF9pqV8S7suAoZWja4dJRkFsKQ=&quot;));</span>
<a href="#l81.73"></a><span id="l81.73" class="difflineplus">+  response = Stanza.node(</span>
<a href="#l81.74"></a><span id="l81.74" class="difflineplus">+    &quot;success&quot;,</span>
<a href="#l81.75"></a><span id="l81.75" class="difflineplus">+    Stanza.NS.sasl,</span>
<a href="#l81.76"></a><span id="l81.76" class="difflineplus">+    null,</span>
<a href="#l81.77"></a><span id="l81.77" class="difflineplus">+    btoa(&quot;v=rmF9pqV8S7suAoZWja4dJRkFsKQ=&quot;)</span>
<a href="#l81.78"></a><span id="l81.78" class="difflineplus">+  );</span>
<a href="#l81.79"></a><span id="l81.79">   result = mech.next(response);</span>
<a href="#l81.80"></a><span id="l81.80">   ok(result.done);</span>
<a href="#l81.81"></a><span id="l81.81">   // There is no final value.</span>
<a href="#l81.82"></a><span id="l81.82">   equal(result.value, undefined);</span>
<a href="#l81.83"></a><span id="l81.83"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_dnsSrv.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_dnsSrv.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -1,32 +1,42 @@</span>
<a href="#l82.4"></a><span id="l82.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l82.5"></a><span id="l82.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l82.6"></a><span id="l82.6"> </span>
<a href="#l82.7"></a><span id="l82.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l82.8"></a><span id="l82.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l82.9"></a><span id="l82.9"> </span>
<a href="#l82.10"></a><span id="l82.10"> var dns = {};</span>
<a href="#l82.11"></a><span id="l82.11"> Services.scriptloader.loadSubScript(&quot;resource:///modules/DNS.jsm&quot;, dns);</span>
<a href="#l82.12"></a><span id="l82.12"> </span>
<a href="#l82.13"></a><span id="l82.13"> var xmpp = {};</span>
<a href="#l82.14"></a><span id="l82.14"> Services.scriptloader.loadSubScript(&quot;resource:///components/xmpp.js&quot;, xmpp);</span>
<a href="#l82.15"></a><span id="l82.15"> </span>
<a href="#l82.16"></a><span id="l82.16"> var xmppSession = {};</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///modules/xmpp-session.jsm&quot;,</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineminus">-                                    xmppSession);</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineplus">+  &quot;resource:///modules/xmpp-session.jsm&quot;,</span>
<a href="#l82.21"></a><span id="l82.21" class="difflineplus">+  xmppSession</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineplus">+);</span>
<a href="#l82.23"></a><span id="l82.23"> </span>
<a href="#l82.24"></a><span id="l82.24"> function FakeXMPPSession() {}</span>
<a href="#l82.25"></a><span id="l82.25"> FakeXMPPSession.prototype = {</span>
<a href="#l82.26"></a><span id="l82.26">   __proto__: xmppSession.XMPPSession.prototype,</span>
<a href="#l82.27"></a><span id="l82.27">   _account: { __proto__: xmpp.XMPPAccount.prototype },</span>
<a href="#l82.28"></a><span id="l82.28">   _host: null,</span>
<a href="#l82.29"></a><span id="l82.29">   _port: 0,</span>
<a href="#l82.30"></a><span id="l82.30" class="difflineminus">-  connect(aHostOrigin, aPortOrigin, aSecurity, aProxy,</span>
<a href="#l82.31"></a><span id="l82.31" class="difflineminus">-          aHost = aHostOrigin, aPort = aPortOrigin) {},</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineminus">-  _connectNextRecord() { this.isConnectNextRecord = true; },</span>
<a href="#l82.33"></a><span id="l82.33" class="difflineplus">+  connect(</span>
<a href="#l82.34"></a><span id="l82.34" class="difflineplus">+    aHostOrigin,</span>
<a href="#l82.35"></a><span id="l82.35" class="difflineplus">+    aPortOrigin,</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineplus">+    aSecurity,</span>
<a href="#l82.37"></a><span id="l82.37" class="difflineplus">+    aProxy,</span>
<a href="#l82.38"></a><span id="l82.38" class="difflineplus">+    aHost = aHostOrigin,</span>
<a href="#l82.39"></a><span id="l82.39" class="difflineplus">+    aPort = aPortOrigin</span>
<a href="#l82.40"></a><span id="l82.40" class="difflineplus">+  ) {},</span>
<a href="#l82.41"></a><span id="l82.41" class="difflineplus">+  _connectNextRecord() {</span>
<a href="#l82.42"></a><span id="l82.42" class="difflineplus">+    this.isConnectNextRecord = true;</span>
<a href="#l82.43"></a><span id="l82.43" class="difflineplus">+  },</span>
<a href="#l82.44"></a><span id="l82.44"> </span>
<a href="#l82.45"></a><span id="l82.45">   // Used to indicate that method _connectNextRecord is called or not.</span>
<a href="#l82.46"></a><span id="l82.46">   isConnectNextRecord: false,</span>
<a href="#l82.47"></a><span id="l82.47"> </span>
<a href="#l82.48"></a><span id="l82.48">   LOG(aMsg) {},</span>
<a href="#l82.49"></a><span id="l82.49">   WARN(aMsg) {},</span>
<a href="#l82.50"></a><span id="l82.50"> };</span>
<a href="#l82.51"></a><span id="l82.51"> </span>
<a href="#l82.52"></a><span id="l82.52" class="difflineat">@@ -73,29 +83,23 @@ var TEST_DATA = [</span>
<a href="#l82.53"></a><span id="l82.53">   {</span>
<a href="#l82.54"></a><span id="l82.54">     input: [],</span>
<a href="#l82.55"></a><span id="l82.55">     output: [],</span>
<a href="#l82.56"></a><span id="l82.56">     isConnectNextRecord: false,</span>
<a href="#l82.57"></a><span id="l82.57">   },</span>
<a href="#l82.58"></a><span id="l82.58"> </span>
<a href="#l82.59"></a><span id="l82.59">   // Tests XMPP is not supported if the result is one record with target &quot;.&quot;.</span>
<a href="#l82.60"></a><span id="l82.60">   {</span>
<a href="#l82.61"></a><span id="l82.61" class="difflineminus">-    input: [</span>
<a href="#l82.62"></a><span id="l82.62" class="difflineminus">-      new dns.SRVRecord(5, 30, &quot;.&quot;, 5222),</span>
<a href="#l82.63"></a><span id="l82.63" class="difflineminus">-    ],</span>
<a href="#l82.64"></a><span id="l82.64" class="difflineplus">+    input: [new dns.SRVRecord(5, 30, &quot;.&quot;, 5222)],</span>
<a href="#l82.65"></a><span id="l82.65">     output: xmppSession.XMPPSession.prototype.SRV_ERROR_XMPP_NOT_SUPPORTED,</span>
<a href="#l82.66"></a><span id="l82.66">     isConnectNextRecord: false,</span>
<a href="#l82.67"></a><span id="l82.67">   },</span>
<a href="#l82.68"></a><span id="l82.68">   {</span>
<a href="#l82.69"></a><span id="l82.69" class="difflineminus">-    input: [</span>
<a href="#l82.70"></a><span id="l82.70" class="difflineminus">-      new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l82.71"></a><span id="l82.71" class="difflineminus">-    ],</span>
<a href="#l82.72"></a><span id="l82.72" class="difflineminus">-    output: [</span>
<a href="#l82.73"></a><span id="l82.73" class="difflineminus">-      new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l82.74"></a><span id="l82.74" class="difflineminus">-    ],</span>
<a href="#l82.75"></a><span id="l82.75" class="difflineplus">+    input: [new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222)],</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineplus">+    output: [new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222)],</span>
<a href="#l82.77"></a><span id="l82.77">     isConnectNextRecord: true,</span>
<a href="#l82.78"></a><span id="l82.78">   },</span>
<a href="#l82.79"></a><span id="l82.79"> </span>
<a href="#l82.80"></a><span id="l82.80">   // Tests error happened during SRV lookup.</span>
<a href="#l82.81"></a><span id="l82.81">   {</span>
<a href="#l82.82"></a><span id="l82.82">     input: -1,</span>
<a href="#l82.83"></a><span id="l82.83">     output: xmppSession.XMPPSession.prototype.SRV_ERROR_LOOKUP_FAILED,</span>
<a href="#l82.84"></a><span id="l82.84">     isConnectNextRecord: false,</span>
<a href="#l82.85"></a><span id="l82.85" class="difflineat">@@ -103,18 +107,19 @@ var TEST_DATA = [</span>
<a href="#l82.86"></a><span id="l82.86"> ];</span>
<a href="#l82.87"></a><span id="l82.87"> </span>
<a href="#l82.88"></a><span id="l82.88"> function run_test() {</span>
<a href="#l82.89"></a><span id="l82.89">   for (let currentQuery of TEST_DATA) {</span>
<a href="#l82.90"></a><span id="l82.90">     let session = new FakeXMPPSession();</span>
<a href="#l82.91"></a><span id="l82.91">     try {</span>
<a href="#l82.92"></a><span id="l82.92">       session._handleSrvQuery(currentQuery.input);</span>
<a href="#l82.93"></a><span id="l82.93">       equal(session._srvRecords.length, currentQuery.output.length);</span>
<a href="#l82.94"></a><span id="l82.94" class="difflineminus">-      for (let index = 0; index &lt; session._srvRecords.length; index++)</span>
<a href="#l82.95"></a><span id="l82.95" class="difflineplus">+      for (let index = 0; index &lt; session._srvRecords.length; index++) {</span>
<a href="#l82.96"></a><span id="l82.96">         deepEqual(session._srvRecords[index], currentQuery.output[index]);</span>
<a href="#l82.97"></a><span id="l82.97" class="difflineplus">+      }</span>
<a href="#l82.98"></a><span id="l82.98">     } catch (e) {</span>
<a href="#l82.99"></a><span id="l82.99">       equal(e, currentQuery.output);</span>
<a href="#l82.100"></a><span id="l82.100">     }</span>
<a href="#l82.101"></a><span id="l82.101">     equal(session.isConnectNextRecord, currentQuery.isConnectNextRecord);</span>
<a href="#l82.102"></a><span id="l82.102">   }</span>
<a href="#l82.103"></a><span id="l82.103"> </span>
<a href="#l82.104"></a><span id="l82.104">   run_next_test();</span>
<a href="#l82.105"></a><span id="l82.105"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_parseJidAndNormalization.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_parseJidAndNormalization.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l83.4"></a><span id="l83.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l83.5"></a><span id="l83.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l83.6"></a><span id="l83.6"> </span>
<a href="#l83.7"></a><span id="l83.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l83.8"></a><span id="l83.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l83.9"></a><span id="l83.9"> </span>
<a href="#l83.10"></a><span id="l83.10"> var xmpp = {};</span>
<a href="#l83.11"></a><span id="l83.11"> Services.scriptloader.loadSubScript(&quot;resource:///components/xmpp.js&quot;, xmpp);</span>
<a href="#l83.12"></a><span id="l83.12"> </span>
<a href="#l83.13"></a><span id="l83.13"> var TEST_DATA = {</span>
<a href="#l83.14"></a><span id="l83.14">   &quot;abdelrhman@instantbird&quot;: {</span>
<a href="#l83.15"></a><span id="l83.15">     node: &quot;abdelrhman&quot;,</span>
<a href="#l83.16"></a><span id="l83.16">     domain: &quot;instantbird&quot;,</span>
<a href="#l83.17"></a><span id="l83.17" class="difflineat">@@ -50,17 +50,17 @@ var TEST_DATA = {</span>
<a href="#l83.18"></a><span id="l83.18">   },</span>
<a href="#l83.19"></a><span id="l83.19">   &quot;abdelrhman@host/instant/Bird&quot;: {</span>
<a href="#l83.20"></a><span id="l83.20">     node: &quot;abdelrhman&quot;,</span>
<a href="#l83.21"></a><span id="l83.21">     domain: &quot;host&quot;,</span>
<a href="#l83.22"></a><span id="l83.22">     resource: &quot;instant/Bird&quot;,</span>
<a href="#l83.23"></a><span id="l83.23">     jid: &quot;abdelrhman@host/instant/Bird&quot;,</span>
<a href="#l83.24"></a><span id="l83.24">     normalized: &quot;abdelrhman@host&quot;,</span>
<a href="#l83.25"></a><span id="l83.25">   },</span>
<a href="#l83.26"></a><span id="l83.26" class="difflineminus">-  &quot;instantbird&quot;: {</span>
<a href="#l83.27"></a><span id="l83.27" class="difflineplus">+  instantbird: {</span>
<a href="#l83.28"></a><span id="l83.28">     domain: &quot;instantbird&quot;,</span>
<a href="#l83.29"></a><span id="l83.29">     jid: &quot;instantbird&quot;,</span>
<a href="#l83.30"></a><span id="l83.30">     normalized: &quot;instantbird&quot;,</span>
<a href="#l83.31"></a><span id="l83.31">   },</span>
<a href="#l83.32"></a><span id="l83.32"> };</span>
<a href="#l83.33"></a><span id="l83.33"> </span>
<a href="#l83.34"></a><span id="l83.34"> function testParseJID() {</span>
<a href="#l83.35"></a><span id="l83.35">   for (let currentJID in TEST_DATA) {</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineat">@@ -70,25 +70,33 @@ function testParseJID() {</span>
<a href="#l83.37"></a><span id="l83.37">     equal(jid.resource, TEST_DATA[currentJID].resource);</span>
<a href="#l83.38"></a><span id="l83.38">     equal(jid.jid, TEST_DATA[currentJID].jid);</span>
<a href="#l83.39"></a><span id="l83.39">   }</span>
<a href="#l83.40"></a><span id="l83.40"> </span>
<a href="#l83.41"></a><span id="l83.41">   run_next_test();</span>
<a href="#l83.42"></a><span id="l83.42"> }</span>
<a href="#l83.43"></a><span id="l83.43"> </span>
<a href="#l83.44"></a><span id="l83.44"> function testNormalize() {</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineminus">-  for (let currentJID in TEST_DATA)</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineminus">-    equal(xmpp.XMPPAccount.prototype.normalize(currentJID), TEST_DATA[currentJID].normalized);</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineplus">+  for (let currentJID in TEST_DATA) {</span>
<a href="#l83.48"></a><span id="l83.48" class="difflineplus">+    equal(</span>
<a href="#l83.49"></a><span id="l83.49" class="difflineplus">+      xmpp.XMPPAccount.prototype.normalize(currentJID),</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineplus">+      TEST_DATA[currentJID].normalized</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+    );</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineplus">+  }</span>
<a href="#l83.53"></a><span id="l83.53"> </span>
<a href="#l83.54"></a><span id="l83.54">   run_next_test();</span>
<a href="#l83.55"></a><span id="l83.55"> }</span>
<a href="#l83.56"></a><span id="l83.56"> </span>
<a href="#l83.57"></a><span id="l83.57"> function testNormalizeFullJid() {</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineminus">-  for (let currentJID in TEST_DATA)</span>
<a href="#l83.59"></a><span id="l83.59" class="difflineminus">-    equal(xmpp.XMPPAccount.prototype.normalizeFullJid(currentJID), TEST_DATA[currentJID].jid);</span>
<a href="#l83.60"></a><span id="l83.60" class="difflineplus">+  for (let currentJID in TEST_DATA) {</span>
<a href="#l83.61"></a><span id="l83.61" class="difflineplus">+    equal(</span>
<a href="#l83.62"></a><span id="l83.62" class="difflineplus">+      xmpp.XMPPAccount.prototype.normalizeFullJid(currentJID),</span>
<a href="#l83.63"></a><span id="l83.63" class="difflineplus">+      TEST_DATA[currentJID].jid</span>
<a href="#l83.64"></a><span id="l83.64" class="difflineplus">+    );</span>
<a href="#l83.65"></a><span id="l83.65" class="difflineplus">+  }</span>
<a href="#l83.66"></a><span id="l83.66"> </span>
<a href="#l83.67"></a><span id="l83.67">   run_next_test();</span>
<a href="#l83.68"></a><span id="l83.68"> }</span>
<a href="#l83.69"></a><span id="l83.69"> </span>
<a href="#l83.70"></a><span id="l83.70"> function run_test() {</span>
<a href="#l83.71"></a><span id="l83.71">   add_test(testParseJID);</span>
<a href="#l83.72"></a><span id="l83.72">   add_test(testNormalize);</span>
<a href="#l83.73"></a><span id="l83.73">   add_test(testNormalizeFullJid);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_parseVCard.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_parseVCard.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l84.4"></a><span id="l84.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l84.5"></a><span id="l84.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l84.6"></a><span id="l84.6"> </span>
<a href="#l84.7"></a><span id="l84.7" class="difflineminus">-var {XMPPAccountPrototype} = ChromeUtils.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l84.8"></a><span id="l84.8" class="difflineminus">-var {XMPPParser} = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l84.9"></a><span id="l84.9" class="difflineplus">+var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l84.10"></a><span id="l84.10" class="difflineplus">+  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l84.11"></a><span id="l84.11" class="difflineplus">+);</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineplus">+var { XMPPParser } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l84.13"></a><span id="l84.13"> </span>
<a href="#l84.14"></a><span id="l84.14"> /*</span>
<a href="#l84.15"></a><span id="l84.15">  * Open an input stream, instantiate an XMPP parser, and feed the input string</span>
<a href="#l84.16"></a><span id="l84.16">  * into it. Then assert that the resulting vCard matches the expected result.</span>
<a href="#l84.17"></a><span id="l84.17">  */</span>
<a href="#l84.18"></a><span id="l84.18"> function _test_vcard(aInput, aExpectedResult) {</span>
<a href="#l84.19"></a><span id="l84.19">   let listener = {</span>
<a href="#l84.20"></a><span id="l84.20">     onXMLError(aError, aException) {</span>
<a href="#l84.21"></a><span id="l84.21" class="difflineat">@@ -17,28 +19,30 @@ function _test_vcard(aInput, aExpectedRe</span>
<a href="#l84.22"></a><span id="l84.22">     LOG(aString) {},</span>
<a href="#l84.23"></a><span id="l84.23">     onXmppStanza(aStanza) {</span>
<a href="#l84.24"></a><span id="l84.24">       // This is a simplified stanza parser that assumes inputs are vCards.</span>
<a href="#l84.25"></a><span id="l84.25">       let vCard = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l84.26"></a><span id="l84.26">       deepEqual(XMPPAccountPrototype.parseVCard(vCard), aExpectedResult);</span>
<a href="#l84.27"></a><span id="l84.27">     },</span>
<a href="#l84.28"></a><span id="l84.28">   };</span>
<a href="#l84.29"></a><span id="l84.29">   let parser = new XMPPParser(listener);</span>
<a href="#l84.30"></a><span id="l84.30" class="difflineminus">-  let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l84.31"></a><span id="l84.31" class="difflineminus">-                  .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineplus">+  let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;].createInstance(</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineplus">+    Ci.nsIStringInputStream</span>
<a href="#l84.34"></a><span id="l84.34" class="difflineplus">+  );</span>
<a href="#l84.35"></a><span id="l84.35">   istream.setData(aInput, aInput.length);</span>
<a href="#l84.36"></a><span id="l84.36">   parser.onDataAvailable(istream, 0, aInput.length);</span>
<a href="#l84.37"></a><span id="l84.37">   parser.destroy();</span>
<a href="#l84.38"></a><span id="l84.38"> }</span>
<a href="#l84.39"></a><span id="l84.39"> </span>
<a href="#l84.40"></a><span id="l84.40"> /*</span>
<a href="#l84.41"></a><span id="l84.41">  * Test parsing of the example vCard from XEP-0054 section 3.1, example 2.</span>
<a href="#l84.42"></a><span id="l84.42">  */</span>
<a href="#l84.43"></a><span id="l84.43"> function test_standard_vcard() {</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineminus">-  const standard_vcard = &quot;&lt;iq xmlns='jabber:client'\</span>
<a href="#l84.45"></a><span id="l84.45" class="difflineplus">+  const standard_vcard =</span>
<a href="#l84.46"></a><span id="l84.46" class="difflineplus">+    &quot;&lt;iq xmlns='jabber:client'\</span>
<a href="#l84.47"></a><span id="l84.47">     id='v1'\</span>
<a href="#l84.48"></a><span id="l84.48">     to='stpeter@jabber.org/roundabout'\</span>
<a href="#l84.49"></a><span id="l84.49">     type='result'&gt;\</span>
<a href="#l84.50"></a><span id="l84.50">   &lt;vCard xmlns='vcard-temp'&gt;\</span>
<a href="#l84.51"></a><span id="l84.51">     &lt;FN&gt;Peter Saint-Andre&lt;/FN&gt;\</span>
<a href="#l84.52"></a><span id="l84.52">     &lt;N&gt;\</span>
<a href="#l84.53"></a><span id="l84.53">       &lt;FAMILY&gt;Saint-Andre&lt;/FAMILY&gt;\</span>
<a href="#l84.54"></a><span id="l84.54">       &lt;GIVEN&gt;Peter&lt;/GIVEN&gt;\</span>
<a href="#l84.55"></a><span id="l84.55" class="difflineat">@@ -110,17 +114,18 @@ function test_standard_vcard() {</span>
<a href="#l84.56"></a><span id="l84.56">   run_next_test();</span>
<a href="#l84.57"></a><span id="l84.57"> }</span>
<a href="#l84.58"></a><span id="l84.58"> </span>
<a href="#l84.59"></a><span id="l84.59"> /*</span>
<a href="#l84.60"></a><span id="l84.60">  * Test parsing of the example empty vCard from XEP-0054 section 3.1, example</span>
<a href="#l84.61"></a><span id="l84.61">  * 4. This can be used instead of returning an error stanza.</span>
<a href="#l84.62"></a><span id="l84.62">  */</span>
<a href="#l84.63"></a><span id="l84.63"> function test_empty_vcard() {</span>
<a href="#l84.64"></a><span id="l84.64" class="difflineminus">-  const empty_vcard = &quot;&lt;iq xmlns='jabber:client'\</span>
<a href="#l84.65"></a><span id="l84.65" class="difflineplus">+  const empty_vcard =</span>
<a href="#l84.66"></a><span id="l84.66" class="difflineplus">+    &quot;&lt;iq xmlns='jabber:client'\</span>
<a href="#l84.67"></a><span id="l84.67">     id='v1'\</span>
<a href="#l84.68"></a><span id="l84.68">     to='stpeter@jabber.org/roundabout'\</span>
<a href="#l84.69"></a><span id="l84.69">     type='result'&gt;\</span>
<a href="#l84.70"></a><span id="l84.70">   &lt;vCard xmlns='vcard-temp'/&gt;\</span>
<a href="#l84.71"></a><span id="l84.71"> &lt;/iq&gt;&quot;;</span>
<a href="#l84.72"></a><span id="l84.72"> </span>
<a href="#l84.73"></a><span id="l84.73">   // There should be no properties.</span>
<a href="#l84.74"></a><span id="l84.74">   _test_vcard(empty_vcard, {});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_saslPrep.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_saslPrep.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l85.4"></a><span id="l85.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l85.5"></a><span id="l85.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l85.6"></a><span id="l85.6"> </span>
<a href="#l85.7"></a><span id="l85.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l85.8"></a><span id="l85.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l85.9"></a><span id="l85.9"> </span>
<a href="#l85.10"></a><span id="l85.10"> var xmppAuth = {};</span>
<a href="#l85.11"></a><span id="l85.11" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///modules/xmpp-authmechs.jsm&quot;,</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-                                    xmppAuth);</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineplus">+  &quot;resource:///modules/xmpp-authmechs.jsm&quot;,</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineplus">+  xmppAuth</span>
<a href="#l85.16"></a><span id="l85.16" class="difflineplus">+);</span>
<a href="#l85.17"></a><span id="l85.17"> </span>
<a href="#l85.18"></a><span id="l85.18"> // RFC 4013 3.Examples</span>
<a href="#l85.19"></a><span id="l85.19"> var TEST_DATA = [</span>
<a href="#l85.20"></a><span id="l85.20">   {</span>
<a href="#l85.21"></a><span id="l85.21">     // SOFT HYPHEN mapped to nothing.</span>
<a href="#l85.22"></a><span id="l85.22">     input: &quot;I\u00adX&quot;,</span>
<a href="#l85.23"></a><span id="l85.23">     output: &quot;IX&quot;,</span>
<a href="#l85.24"></a><span id="l85.24">     isError: false,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_xmppParser.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_xmppParser.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -1,79 +1,86 @@</span>
<a href="#l86.4"></a><span id="l86.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l86.5"></a><span id="l86.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l86.6"></a><span id="l86.6"> </span>
<a href="#l86.7"></a><span id="l86.7" class="difflineminus">-var {XMPPParser} = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l86.8"></a><span id="l86.8" class="difflineplus">+var { XMPPParser } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l86.9"></a><span id="l86.9"> </span>
<a href="#l86.10"></a><span id="l86.10"> var TEST_DATA = [</span>
<a href="#l86.11"></a><span id="l86.11">   {</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-    input: '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineplus">+    input:</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineplus">+      '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.15"></a><span id="l86.15"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l86.16"></a><span id="l86.16"> &lt;body&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l86.17"></a><span id="l86.17"> counsel?&lt;/body&gt;\</span>
<a href="#l86.18"></a><span id="l86.18"> &lt;/message&gt;',</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineminus">-    output: '&lt;message xmlns=&quot;jabber:client&quot; \</span>
<a href="#l86.20"></a><span id="l86.20" class="difflineplus">+    output:</span>
<a href="#l86.21"></a><span id="l86.21" class="difflineplus">+      '&lt;message xmlns=&quot;jabber:client&quot; \</span>
<a href="#l86.22"></a><span id="l86.22"> from=&quot;juliet@capulet.example/balcony&quot; to=&quot;romeo@montague.example/garden&quot; \</span>
<a href="#l86.23"></a><span id="l86.23"> type=&quot;chat&quot;&gt;&lt;body xmlns=&quot;jabber:client&quot;&gt;What man art thou that, thus \</span>
<a href="#l86.24"></a><span id="l86.24"> bescreen&quot;d in night, so stumblest on my counsel?&lt;/body&gt;\</span>
<a href="#l86.25"></a><span id="l86.25"> &lt;/message&gt;',</span>
<a href="#l86.26"></a><span id="l86.26">     isError: false,</span>
<a href="#l86.27"></a><span id="l86.27">     description: &quot;Message stanza with body element&quot;,</span>
<a href="#l86.28"></a><span id="l86.28">   },</span>
<a href="#l86.29"></a><span id="l86.29">   {</span>
<a href="#l86.30"></a><span id="l86.30" class="difflineminus">-    input: '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;romeo@montague.example&quot; \</span>
<a href="#l86.31"></a><span id="l86.31" class="difflineplus">+    input:</span>
<a href="#l86.32"></a><span id="l86.32" class="difflineplus">+      '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;romeo@montague.example&quot; \</span>
<a href="#l86.33"></a><span id="l86.33"> to=&quot;romeo@montague.example/home&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l86.34"></a><span id="l86.34"> &lt;received xmlns=&quot;urn:xmpp:carbons:2&quot;&gt;\</span>
<a href="#l86.35"></a><span id="l86.35"> &lt;forwarded xmlns=&quot;urn:xmpp:forward:0&quot;&gt;\</span>
<a href="#l86.36"></a><span id="l86.36"> &lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.37"></a><span id="l86.37"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l86.38"></a><span id="l86.38"> &lt;body&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l86.39"></a><span id="l86.39"> counsel?&lt;/body&gt;\</span>
<a href="#l86.40"></a><span id="l86.40"> &lt;thread&gt;0e3141cd80894871a68e6fe6b1ec56fa&lt;/thread&gt;\</span>
<a href="#l86.41"></a><span id="l86.41"> &lt;/message&gt;\</span>
<a href="#l86.42"></a><span id="l86.42"> &lt;/forwarded&gt;\</span>
<a href="#l86.43"></a><span id="l86.43"> &lt;/received&gt;\</span>
<a href="#l86.44"></a><span id="l86.44"> &lt;/message&gt;',</span>
<a href="#l86.45"></a><span id="l86.45" class="difflineminus">-    output: '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;romeo@montague.example&quot; \</span>
<a href="#l86.46"></a><span id="l86.46" class="difflineplus">+    output:</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineplus">+      '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;romeo@montague.example&quot; \</span>
<a href="#l86.48"></a><span id="l86.48"> to=&quot;romeo@montague.example/home&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l86.49"></a><span id="l86.49"> &lt;received xmlns=&quot;urn:xmpp:carbons:2&quot;&gt;&lt;forwarded xmlns=&quot;urn:xmpp:forward:0&quot;&gt;\</span>
<a href="#l86.50"></a><span id="l86.50"> &lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.51"></a><span id="l86.51"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l86.52"></a><span id="l86.52"> &lt;body xmlns=&quot;jabber:client&quot;&gt;What man art thou that, thus bescreen&quot;d in night, \</span>
<a href="#l86.53"></a><span id="l86.53"> so stumblest on my counsel?&lt;/body&gt;\</span>
<a href="#l86.54"></a><span id="l86.54"> &lt;thread xmlns=&quot;jabber:client&quot;&gt;0e3141cd80894871a68e6fe6b1ec56fa&lt;/thread&gt;\</span>
<a href="#l86.55"></a><span id="l86.55"> &lt;/message&gt;\</span>
<a href="#l86.56"></a><span id="l86.56"> &lt;/forwarded&gt;\</span>
<a href="#l86.57"></a><span id="l86.57"> &lt;/received&gt;\</span>
<a href="#l86.58"></a><span id="l86.58"> &lt;/message&gt;',</span>
<a href="#l86.59"></a><span id="l86.59">     isError: false,</span>
<a href="#l86.60"></a><span id="l86.60">     description: &quot;Forwarded copy of message carbons&quot;,</span>
<a href="#l86.61"></a><span id="l86.61">   },</span>
<a href="#l86.62"></a><span id="l86.62">   {</span>
<a href="#l86.63"></a><span id="l86.63" class="difflineminus">-    input: '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.64"></a><span id="l86.64" class="difflineplus">+    input:</span>
<a href="#l86.65"></a><span id="l86.65" class="difflineplus">+      '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.66"></a><span id="l86.66"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l86.67"></a><span id="l86.67"> &lt;body&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l86.68"></a><span id="l86.68"> counsel?\</span>
<a href="#l86.69"></a><span id="l86.69"> &lt;/message&gt;',</span>
<a href="#l86.70"></a><span id="l86.70">     output: &quot;&quot;,</span>
<a href="#l86.71"></a><span id="l86.71">     isError: true,</span>
<a href="#l86.72"></a><span id="l86.72">     description: &quot;No closing of body tag&quot;,</span>
<a href="#l86.73"></a><span id="l86.73">   },</span>
<a href="#l86.74"></a><span id="l86.74">   {</span>
<a href="#l86.75"></a><span id="l86.75" class="difflineminus">-    input: '&lt;message xmlns=&quot;http://etherx.jabber.org/streams&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.76"></a><span id="l86.76" class="difflineplus">+    input:</span>
<a href="#l86.77"></a><span id="l86.77" class="difflineplus">+      '&lt;message xmlns=&quot;http://etherx.jabber.org/streams&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l86.78"></a><span id="l86.78"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l86.79"></a><span id="l86.79"> &lt;body&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l86.80"></a><span id="l86.80"> counsel?&lt;/body&gt;\</span>
<a href="#l86.81"></a><span id="l86.81"> &lt;/message&gt;',</span>
<a href="#l86.82"></a><span id="l86.82">     output: &quot;&quot;,</span>
<a href="#l86.83"></a><span id="l86.83">     isError: true,</span>
<a href="#l86.84"></a><span id="l86.84">     description: &quot;Invalid namespace of top-level element&quot;,</span>
<a href="#l86.85"></a><span id="l86.85">   },</span>
<a href="#l86.86"></a><span id="l86.86">   {</span>
<a href="#l86.87"></a><span id="l86.87" class="difflineminus">-    input: '&lt;field xmlns=&quot;jabber:x:data&quot; type=&quot;fixed&quot;&gt;\</span>
<a href="#l86.88"></a><span id="l86.88" class="difflineplus">+    input:</span>
<a href="#l86.89"></a><span id="l86.89" class="difflineplus">+      '&lt;field xmlns=&quot;jabber:x:data&quot; type=&quot;fixed&quot;&gt;\</span>
<a href="#l86.90"></a><span id="l86.90"> &lt;value&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l86.91"></a><span id="l86.91"> counsel?&lt;/value&gt;\</span>
<a href="#l86.92"></a><span id="l86.92"> &lt;/field&gt;',</span>
<a href="#l86.93"></a><span id="l86.93">     output: &quot;&quot;,</span>
<a href="#l86.94"></a><span id="l86.94">     isError: true,</span>
<a href="#l86.95"></a><span id="l86.95">     description: &quot;Invalid top-level element&quot;,</span>
<a href="#l86.96"></a><span id="l86.96">   },</span>
<a href="#l86.97"></a><span id="l86.97"> ];</span>
<a href="#l86.98"></a><span id="l86.98" class="difflineat">@@ -87,18 +94,19 @@ function testXMPPParser() {</span>
<a href="#l86.99"></a><span id="l86.99">       LOG(aString) {},</span>
<a href="#l86.100"></a><span id="l86.100">       startLegacyAuth() {},</span>
<a href="#l86.101"></a><span id="l86.101">       onXmppStanza(aStanza) {</span>
<a href="#l86.102"></a><span id="l86.102">         equal(current.output, aStanza.getXML(), current.description);</span>
<a href="#l86.103"></a><span id="l86.103">         ok(!current.isError, current.description);</span>
<a href="#l86.104"></a><span id="l86.104">       },</span>
<a href="#l86.105"></a><span id="l86.105">     };</span>
<a href="#l86.106"></a><span id="l86.106">     let parser = new XMPPParser(listener);</span>
<a href="#l86.107"></a><span id="l86.107" class="difflineminus">-    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l86.108"></a><span id="l86.108" class="difflineminus">-                    .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l86.109"></a><span id="l86.109" class="difflineplus">+    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;].createInstance(</span>
<a href="#l86.110"></a><span id="l86.110" class="difflineplus">+      Ci.nsIStringInputStream</span>
<a href="#l86.111"></a><span id="l86.111" class="difflineplus">+    );</span>
<a href="#l86.112"></a><span id="l86.112">     istream.setData(current.input, current.input.length);</span>
<a href="#l86.113"></a><span id="l86.113">     parser.onDataAvailable(istream, 0, current.input.length);</span>
<a href="#l86.114"></a><span id="l86.114">     parser.destroy();</span>
<a href="#l86.115"></a><span id="l86.115">   }</span>
<a href="#l86.116"></a><span id="l86.116"> </span>
<a href="#l86.117"></a><span id="l86.117">   run_next_test();</span>
<a href="#l86.118"></a><span id="l86.118"> }</span>
<a href="#l86.119"></a><span id="l86.119"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_xmppXml.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_xmppXml.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -1,15 +1,18 @@</span>
<a href="#l87.4"></a><span id="l87.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l87.5"></a><span id="l87.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l87.6"></a><span id="l87.6"> </span>
<a href="#l87.7"></a><span id="l87.7" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l87.8"></a><span id="l87.8" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l87.9"></a><span id="l87.9"> </span>
<a href="#l87.10"></a><span id="l87.10"> var xmppXml = {};</span>
<a href="#l87.11"></a><span id="l87.11" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///modules/xmpp-xml.jsm&quot;, xmppXml);</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+  &quot;resource:///modules/xmpp-xml.jsm&quot;,</span>
<a href="#l87.14"></a><span id="l87.14" class="difflineplus">+  xmppXml</span>
<a href="#l87.15"></a><span id="l87.15" class="difflineplus">+);</span>
<a href="#l87.16"></a><span id="l87.16"> </span>
<a href="#l87.17"></a><span id="l87.17"> var TEST_DATA = [</span>
<a href="#l87.18"></a><span id="l87.18">   {</span>
<a href="#l87.19"></a><span id="l87.19">     input: {</span>
<a href="#l87.20"></a><span id="l87.20">       name: &quot;message&quot;,</span>
<a href="#l87.21"></a><span id="l87.21">       namespace: xmppXml.NS.client,</span>
<a href="#l87.22"></a><span id="l87.22">       attributes: {</span>
<a href="#l87.23"></a><span id="l87.23">         jid: &quot;user@domain&quot;,</span>
<a href="#l87.24"></a><span id="l87.24" class="difflineat">@@ -71,28 +74,34 @@ var TEST_DATA = [</span>
<a href="#l87.25"></a><span id="l87.25">     isError: false,</span>
<a href="#l87.26"></a><span id="l87.26">     description: &quot;Node with text content&quot;,</span>
<a href="#l87.27"></a><span id="l87.27">   },</span>
<a href="#l87.28"></a><span id="l87.28"> ];</span>
<a href="#l87.29"></a><span id="l87.29"> </span>
<a href="#l87.30"></a><span id="l87.30"> function testXMLNode() {</span>
<a href="#l87.31"></a><span id="l87.31">   for (let current of TEST_DATA) {</span>
<a href="#l87.32"></a><span id="l87.32">     try {</span>
<a href="#l87.33"></a><span id="l87.33" class="difflineminus">-      let result =</span>
<a href="#l87.34"></a><span id="l87.34" class="difflineminus">-        xmppXml.Stanza.node(current.input.name, current.input.namespace,</span>
<a href="#l87.35"></a><span id="l87.35" class="difflineminus">-                            current.input.attributes, current.input.data);</span>
<a href="#l87.36"></a><span id="l87.36" class="difflineplus">+      let result = xmppXml.Stanza.node(</span>
<a href="#l87.37"></a><span id="l87.37" class="difflineplus">+        current.input.name,</span>
<a href="#l87.38"></a><span id="l87.38" class="difflineplus">+        current.input.namespace,</span>
<a href="#l87.39"></a><span id="l87.39" class="difflineplus">+        current.input.attributes,</span>
<a href="#l87.40"></a><span id="l87.40" class="difflineplus">+        current.input.data</span>
<a href="#l87.41"></a><span id="l87.41" class="difflineplus">+      );</span>
<a href="#l87.42"></a><span id="l87.42">       equal(result.getXML(), current.XmlOutput, current.description);</span>
<a href="#l87.43"></a><span id="l87.43" class="difflineminus">-      equal(result.convertToString(), current.stringOutput, current.description);</span>
<a href="#l87.44"></a><span id="l87.44" class="difflineplus">+      equal(</span>
<a href="#l87.45"></a><span id="l87.45" class="difflineplus">+        result.convertToString(),</span>
<a href="#l87.46"></a><span id="l87.46" class="difflineplus">+        current.stringOutput,</span>
<a href="#l87.47"></a><span id="l87.47" class="difflineplus">+        current.description</span>
<a href="#l87.48"></a><span id="l87.48" class="difflineplus">+      );</span>
<a href="#l87.49"></a><span id="l87.49">       equal(current.isError, false);</span>
<a href="#l87.50"></a><span id="l87.50">     } catch (e) {</span>
<a href="#l87.51"></a><span id="l87.51">       equal(current.isError, true, current.description);</span>
<a href="#l87.52"></a><span id="l87.52">     }</span>
<a href="#l87.53"></a><span id="l87.53">   }</span>
<a href="#l87.54"></a><span id="l87.54"> </span>
<a href="#l87.55"></a><span id="l87.55">   run_next_test();</span>
<a href="#l87.56"></a><span id="l87.56"> }</span>
<a href="#l87.57"></a><span id="l87.57"> </span>
<a href="#l87.58"></a><span id="l87.58" class="difflineminus">-</span>
<a href="#l87.59"></a><span id="l87.59"> function run_test() {</span>
<a href="#l87.60"></a><span id="l87.60">   add_test(testXMLNode);</span>
<a href="#l87.61"></a><span id="l87.61"> </span>
<a href="#l87.62"></a><span id="l87.62">   run_next_test();</span>
<a href="#l87.63"></a><span id="l87.63"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -7,42 +7,55 @@</span>
<a href="#l88.4"></a><span id="l88.4"> // By default we currently support the PLAIN and the SCRAM-SHA-1 mechanisms.</span>
<a href="#l88.5"></a><span id="l88.5"> // As this is only used by XMPPSession, it may seem like an internal</span>
<a href="#l88.6"></a><span id="l88.6"> // detail of the XMPP implementation, but exporting it is valuable so that</span>
<a href="#l88.7"></a><span id="l88.7"> // add-ons can add support for more auth mechanisms easily by adding them</span>
<a href="#l88.8"></a><span id="l88.8"> // in XMPPAuthMechanisms without having to modify XMPPSession.</span>
<a href="#l88.9"></a><span id="l88.9"> </span>
<a href="#l88.10"></a><span id="l88.10"> this.EXPORTED_SYMBOLS = [&quot;XMPPAuthMechanisms&quot;];</span>
<a href="#l88.11"></a><span id="l88.11"> </span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-const {CommonUtils} = ChromeUtils.import(&quot;resource://services-common/utils.js&quot;);</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineminus">-const {CryptoUtils} = ChromeUtils.import(&quot;resource://services-crypto/utils.js&quot;);</span>
<a href="#l88.14"></a><span id="l88.14" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineminus">-var {Stanza} = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l88.16"></a><span id="l88.16" class="difflineplus">+const { CommonUtils } = ChromeUtils.import(</span>
<a href="#l88.17"></a><span id="l88.17" class="difflineplus">+  &quot;resource://services-common/utils.js&quot;</span>
<a href="#l88.18"></a><span id="l88.18" class="difflineplus">+);</span>
<a href="#l88.19"></a><span id="l88.19" class="difflineplus">+const { CryptoUtils } = ChromeUtils.import(</span>
<a href="#l88.20"></a><span id="l88.20" class="difflineplus">+  &quot;resource://services-crypto/utils.js&quot;</span>
<a href="#l88.21"></a><span id="l88.21" class="difflineplus">+);</span>
<a href="#l88.22"></a><span id="l88.22" class="difflineplus">+const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l88.23"></a><span id="l88.23" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineplus">+);</span>
<a href="#l88.25"></a><span id="l88.25" class="difflineplus">+var { Stanza } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l88.26"></a><span id="l88.26"> XPCOMUtils.defineLazyGlobalGetters(this, [&quot;crypto&quot;]);</span>
<a href="#l88.27"></a><span id="l88.27"> </span>
<a href="#l88.28"></a><span id="l88.28"> // Handle PLAIN authorization mechanism.</span>
<a href="#l88.29"></a><span id="l88.29"> function* PlainAuth(aUsername, aPassword, aDomain) {</span>
<a href="#l88.30"></a><span id="l88.30">   let data = &quot;\0&quot; + aUsername + &quot;\0&quot; + aPassword;</span>
<a href="#l88.31"></a><span id="l88.31"> </span>
<a href="#l88.32"></a><span id="l88.32">   // btoa for Unicode, see https://developer.mozilla.org/en-US/docs/DOM/window.btoa</span>
<a href="#l88.33"></a><span id="l88.33">   let base64Data = btoa(unescape(encodeURIComponent(data)));</span>
<a href="#l88.34"></a><span id="l88.34"> </span>
<a href="#l88.35"></a><span id="l88.35">   let stanza = yield {</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineminus">-    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;PLAIN&quot;},</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineminus">-                      base64Data),</span>
<a href="#l88.38"></a><span id="l88.38" class="difflineminus">-    log: '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)',</span>
<a href="#l88.39"></a><span id="l88.39" class="difflineplus">+    send: Stanza.node(</span>
<a href="#l88.40"></a><span id="l88.40" class="difflineplus">+      &quot;auth&quot;,</span>
<a href="#l88.41"></a><span id="l88.41" class="difflineplus">+      Stanza.NS.sasl,</span>
<a href="#l88.42"></a><span id="l88.42" class="difflineplus">+      { mechanism: &quot;PLAIN&quot; },</span>
<a href="#l88.43"></a><span id="l88.43" class="difflineplus">+      base64Data</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineplus">+    ),</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineplus">+    log:</span>
<a href="#l88.46"></a><span id="l88.46" class="difflineplus">+      '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)',</span>
<a href="#l88.47"></a><span id="l88.47">   };</span>
<a href="#l88.48"></a><span id="l88.48"> </span>
<a href="#l88.49"></a><span id="l88.49" class="difflineminus">-  if (stanza.localName != &quot;success&quot;)</span>
<a href="#l88.50"></a><span id="l88.50" class="difflineplus">+  if (stanza.localName != &quot;success&quot;) {</span>
<a href="#l88.51"></a><span id="l88.51">     throw new Error(&quot;Didn't receive the expected auth success stanza.&quot;);</span>
<a href="#l88.52"></a><span id="l88.52" class="difflineplus">+  }</span>
<a href="#l88.53"></a><span id="l88.53"> }</span>
<a href="#l88.54"></a><span id="l88.54"> </span>
<a href="#l88.55"></a><span id="l88.55"> // Handle SCRAM-SHA-1 authorization mechanism.</span>
<a href="#l88.56"></a><span id="l88.56"> const RFC3454 = {</span>
<a href="#l88.57"></a><span id="l88.57" class="difflineminus">-  A1: &quot;\u0221|[\u0234-\u024f]|[\u02ae-\u02af]|[\u02ef-\u02ff]|\</span>
<a href="#l88.58"></a><span id="l88.58" class="difflineplus">+  A1:</span>
<a href="#l88.59"></a><span id="l88.59" class="difflineplus">+    &quot;\u0221|[\u0234-\u024f]|[\u02ae-\u02af]|[\u02ef-\u02ff]|\</span>
<a href="#l88.60"></a><span id="l88.60"> [\u0350-\u035f]|[\u0370-\u0373]|[\u0376-\u0379]|[\u037b-\u037d]|\</span>
<a href="#l88.61"></a><span id="l88.61"> [\u037f-\u0383]|\u038b|\u038d|\u03a2|\u03cf|[\u03f7-\u03ff]|\u0487|\</span>
<a href="#l88.62"></a><span id="l88.62"> \u04cf|[\u04f6-\u04f7]|[\u04fa-\u04ff]|[\u0510-\u0530]|\</span>
<a href="#l88.63"></a><span id="l88.63"> [\u0557-\u0558]|\u0560|\u0588|[\u058b-\u0590]|\u05a2|\u05ba|\</span>
<a href="#l88.64"></a><span id="l88.64"> [\u05c5-\u05cf]|[\u05eb-\u05ef]|[\u05f5-\u060b]|[\u060d-\u061a]|\</span>
<a href="#l88.65"></a><span id="l88.65"> [\u061c-\u061e]|\u0620|[\u063b-\u063f]|[\u0656-\u065f]|\</span>
<a href="#l88.66"></a><span id="l88.66"> [\u06ee-\u06ef]|\u06ff|\u070e|[\u072d-\u072f]|[\u074b-\u077f]|\</span>
<a href="#l88.67"></a><span id="l88.67"> [\u07b2-\u0900]|\u0904|[\u093a-\u093b]|[\u094e-\u094f]|\</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineat">@@ -115,42 +128,47 @@ const RFC3454 = {</span>
<a href="#l88.69"></a><span id="l88.69"> \u{1d515}|\u{1d51d}|\u{1d53a}|\u{1d53f}|\u{1d545}|\</span>
<a href="#l88.70"></a><span id="l88.70"> [\u{1d547}-\u{1d549}]|\u{1d551}|[\u{1d6a4}-\u{1d6a7}]|\</span>
<a href="#l88.71"></a><span id="l88.71"> [\u{1d7ca}-\u{1d7cd}]|[\u{1d800}-\u{1fffd}]|[\u{2a6d7}-\u{2f7ff}]|\</span>
<a href="#l88.72"></a><span id="l88.72"> [\u{2fa1e}-\u{2fffd}]|[\u{30000}-\u{3fffd}]|[\u{40000}-\u{4fffd}]|\</span>
<a href="#l88.73"></a><span id="l88.73"> [\u{50000}-\u{5fffd}]|[\u{60000}-\u{6fffd}]|[\u{70000}-\u{7fffd}]|\</span>
<a href="#l88.74"></a><span id="l88.74"> [\u{80000}-\u{8fffd}]|[\u{90000}-\u{9fffd}]|[\u{a0000}-\u{afffd}]|\</span>
<a href="#l88.75"></a><span id="l88.75"> [\u{b0000}-\u{bfffd}]|[\u{c0000}-\u{cfffd}]|[\u{d0000}-\u{dfffd}]|\</span>
<a href="#l88.76"></a><span id="l88.76"> \u{e0000}|[\u{e0002}-\u{e001f}]|[\u{e0080}-\u{efffd}]&quot;,</span>
<a href="#l88.77"></a><span id="l88.77" class="difflineminus">-  B1: &quot;\u00ad|\u034f|\u1806|[\u180b-\u180d]|[\u200b-\u200d]|\u2060|\</span>
<a href="#l88.78"></a><span id="l88.78" class="difflineplus">+  B1:</span>
<a href="#l88.79"></a><span id="l88.79" class="difflineplus">+    &quot;\u00ad|\u034f|\u1806|[\u180b-\u180d]|[\u200b-\u200d]|\u2060|\</span>
<a href="#l88.80"></a><span id="l88.80"> [\ufe00-\ufe0f]|\ufeff&quot;,</span>
<a href="#l88.81"></a><span id="l88.81">   C12: &quot;\u00a0|\u1680|[\u2000-\u200b]|\u202f|\u205f|\u3000&quot;,</span>
<a href="#l88.82"></a><span id="l88.82">   C21: &quot;[\u0000-\u001f]|\u007f&quot;,</span>
<a href="#l88.83"></a><span id="l88.83" class="difflineminus">-  C22: &quot;[\u0080-\u009f]|\u06dd|\u070f|\u180e|\u200c|\u200d|\u2028|\u2029|\</span>
<a href="#l88.84"></a><span id="l88.84" class="difflineplus">+  C22:</span>
<a href="#l88.85"></a><span id="l88.85" class="difflineplus">+    &quot;[\u0080-\u009f]|\u06dd|\u070f|\u180e|\u200c|\u200d|\u2028|\u2029|\</span>
<a href="#l88.86"></a><span id="l88.86"> [\u2060-\u2063]|[\u206a-\u206f]|\ufeff|[\ufff9-\ufffc]&quot;,</span>
<a href="#l88.87"></a><span id="l88.87">   C3: &quot;[\ue000-\uf8ff]|[\u{f0000}-\u{ffffd}]|[\u{100000}-\u{10fffd}]&quot;,</span>
<a href="#l88.88"></a><span id="l88.88" class="difflineminus">-  C4: &quot;[\ufdd0-\ufdef]|[\ufffe-\uffff]|[\u{1fffe}-\u{1ffff}]|\</span>
<a href="#l88.89"></a><span id="l88.89" class="difflineplus">+  C4:</span>
<a href="#l88.90"></a><span id="l88.90" class="difflineplus">+    &quot;[\ufdd0-\ufdef]|[\ufffe-\uffff]|[\u{1fffe}-\u{1ffff}]|\</span>
<a href="#l88.91"></a><span id="l88.91"> [\u{2fffe}-\u{2ffff}]|[\u{3fffe}-\u{3ffff}]|[\u{4fffe}-\u{4ffff}]|\</span>
<a href="#l88.92"></a><span id="l88.92"> [\u{5fffe}-\u{5ffff}]|[\u{6fffe}-\u{6ffff}]|[\u{7fffe}-\u{7ffff}]|\</span>
<a href="#l88.93"></a><span id="l88.93"> [\u{8fffe}-\u{8ffff}]|[\u{9fffe}-\u{9ffff}]|[\u{afffe}-\u{affff}]|\</span>
<a href="#l88.94"></a><span id="l88.94"> [\u{bfffe}-\u{bffff}]|[\u{cfffe}-\u{cffff}]|[\u{dfffe}-\u{dffff}]|\</span>
<a href="#l88.95"></a><span id="l88.95"> [\u{efffe}-\u{effff}]|[\u{ffffe}-\u{fffff}]|[\u{10fffe}-\u{10ffff}]&quot;,</span>
<a href="#l88.96"></a><span id="l88.96">   C5: &quot;[\ud800-\udfff]&quot;,</span>
<a href="#l88.97"></a><span id="l88.97">   C6: &quot;\ufff9|[\ufffa-\ufffd]&quot;,</span>
<a href="#l88.98"></a><span id="l88.98">   C7: &quot;[\u2ff0-\u2ffb]&quot;,</span>
<a href="#l88.99"></a><span id="l88.99">   C8: &quot;\u0340|\u0341|\u200e|\u200f|[\u202a-\u202e]|[\u206a-\u206f]&quot;,</span>
<a href="#l88.100"></a><span id="l88.100">   C9: &quot;\u{e0001}|[\u{e0020}-\u{e007f}]&quot;,</span>
<a href="#l88.101"></a><span id="l88.101" class="difflineminus">-  D1: &quot;\u05be|\u05c0|\u05c3|[\u05d0-\u05ea]|[\u05f0-\u05f4]|\u061b|\u061f|\</span>
<a href="#l88.102"></a><span id="l88.102" class="difflineplus">+  D1:</span>
<a href="#l88.103"></a><span id="l88.103" class="difflineplus">+    &quot;\u05be|\u05c0|\u05c3|[\u05d0-\u05ea]|[\u05f0-\u05f4]|\u061b|\u061f|\</span>
<a href="#l88.104"></a><span id="l88.104"> [\u0621-\u063a]|[\u0640-\u064a]|[\u066d-\u066f]|[\u0671-\u06d5]|\</span>
<a href="#l88.105"></a><span id="l88.105"> \u06dd|[\u06e5-\u06e6]|[\u06fa-\u06fe]|[\u0700-\u070d]|\u0710|\</span>
<a href="#l88.106"></a><span id="l88.106"> [\u0712-\u072c]|[\u0780-\u07a5]|\u07b1|\u200f|\ufb1d|[\ufb1f-\ufb28]|\</span>
<a href="#l88.107"></a><span id="l88.107"> [\ufb2a-\ufb36]|[\ufb38-\ufb3c]|\ufb3e|[\ufb40-\ufb41]|\</span>
<a href="#l88.108"></a><span id="l88.108"> [\ufb43-\ufb44]|[\ufb46-\ufbb1]|[\ufbd3-\ufd3d]|[\ufd50-\ufd8f]|\</span>
<a href="#l88.109"></a><span id="l88.109"> [\ufd92-\ufdc7]|[\ufdf0-\ufdfc]|[\ufe70-\ufe74]|[\ufe76-\ufefc]&quot;,</span>
<a href="#l88.110"></a><span id="l88.110" class="difflineminus">-  D2: &quot;[\u0041-\u005a]|[\u0061-\u007a]|\u00aa|\u00b5|\u00ba|[\u00c0-\u00d6]|\</span>
<a href="#l88.111"></a><span id="l88.111" class="difflineplus">+  D2:</span>
<a href="#l88.112"></a><span id="l88.112" class="difflineplus">+    &quot;[\u0041-\u005a]|[\u0061-\u007a]|\u00aa|\u00b5|\u00ba|[\u00c0-\u00d6]|\</span>
<a href="#l88.113"></a><span id="l88.113"> [\u00d8-\u00f6]|[\u00f8-\u0220]|[\u0222-\u0233]|[\u0250-\u02ad]|\</span>
<a href="#l88.114"></a><span id="l88.114"> [\u02b0-\u02b8]|[\u02bb-\u02c1]|[\u02d0-\u02d1]|[\u02e0-\u02e4]|\</span>
<a href="#l88.115"></a><span id="l88.115"> \u02ee|\u037a|\u0386|[\u0388-\u038a]|\u038c|[\u038e-\u03a1]|\</span>
<a href="#l88.116"></a><span id="l88.116"> [\u03a3-\u03ce]|[\u03d0-\u03f5]|[\u0400-\u0482]|[\u048a-\u04ce]|\</span>
<a href="#l88.117"></a><span id="l88.117"> [\u04d0-\u04f5]|[\u04f8-\u04f9]|[\u0500-\u050f]|[\u0531-\u0556]|\</span>
<a href="#l88.118"></a><span id="l88.118"> [\u0559-\u055f]|[\u0561-\u0587]|\u0589|\u0903|[\u0905-\u0939]|\</span>
<a href="#l88.119"></a><span id="l88.119"> [\u093d-\u0940]|[\u0949-\u094c]|\u0950|[\u0958-\u0961]|\</span>
<a href="#l88.120"></a><span id="l88.120"> [\u0964-\u0970]|[\u0982-\u0983]|[\u0985-\u098c]|[\u098f-\u0990]|\</span>
<a href="#l88.121"></a><span id="l88.121" class="difflineat">@@ -241,19 +259,20 @@ function createNonce(aLength) {</span>
<a href="#l88.122"></a><span id="l88.122">   // We guarantee a valid nonce value using base64 encoding.</span>
<a href="#l88.123"></a><span id="l88.123">   return btoa(CryptoUtils.generateRandomBytes(aLength));</span>
<a href="#l88.124"></a><span id="l88.124"> }</span>
<a href="#l88.125"></a><span id="l88.125"> </span>
<a href="#l88.126"></a><span id="l88.126"> // Parses the string of server's response (aChallenge) into an object.</span>
<a href="#l88.127"></a><span id="l88.127"> function parseChallenge(aChallenge) {</span>
<a href="#l88.128"></a><span id="l88.128">   let attributes = {};</span>
<a href="#l88.129"></a><span id="l88.129">   aChallenge.split(&quot;,&quot;).forEach(value =&gt; {</span>
<a href="#l88.130"></a><span id="l88.130" class="difflineminus">-    let match =  /^(\w)=([\s\S]*)$/.exec(value);</span>
<a href="#l88.131"></a><span id="l88.131" class="difflineminus">-    if (match)</span>
<a href="#l88.132"></a><span id="l88.132" class="difflineplus">+    let match = /^(\w)=([\s\S]*)$/.exec(value);</span>
<a href="#l88.133"></a><span id="l88.133" class="difflineplus">+    if (match) {</span>
<a href="#l88.134"></a><span id="l88.134">       attributes[match[1]] = match[2];</span>
<a href="#l88.135"></a><span id="l88.135" class="difflineplus">+    }</span>
<a href="#l88.136"></a><span id="l88.136">   });</span>
<a href="#l88.137"></a><span id="l88.137">   return attributes;</span>
<a href="#l88.138"></a><span id="l88.138"> }</span>
<a href="#l88.139"></a><span id="l88.139"> </span>
<a href="#l88.140"></a><span id="l88.140"> // RFC 4013 and RFC 3454: Stringprep Profile for User Names and Passwords.</span>
<a href="#l88.141"></a><span id="l88.141"> function saslPrep(aString) {</span>
<a href="#l88.142"></a><span id="l88.142">   // RFC 4013 2.1: non-ASCII space characters (RFC 3454 C.1.2) mapped to space.</span>
<a href="#l88.143"></a><span id="l88.143">   let retVal = aString.replace(new RegExp(RFC3454.C12, &quot;u&quot;), &quot; &quot;);</span>
<a href="#l88.144"></a><span id="l88.144" class="difflineat">@@ -262,187 +281,251 @@ function saslPrep(aString) {</span>
<a href="#l88.145"></a><span id="l88.145">   retVal = retVal.replace(new RegExp(RFC3454.B1, &quot;u&quot;), &quot;&quot;);</span>
<a href="#l88.146"></a><span id="l88.146"> </span>
<a href="#l88.147"></a><span id="l88.147">   // RFC 4013 2.2 asks for Unicode normalization form KC, which corresponds to</span>
<a href="#l88.148"></a><span id="l88.148">   // RFC 3454 B.2.</span>
<a href="#l88.149"></a><span id="l88.149">   retVal = retVal.normalize(&quot;NFKC&quot;);</span>
<a href="#l88.150"></a><span id="l88.150"> </span>
<a href="#l88.151"></a><span id="l88.151">   // RFC 4013 2.3: Prohibited Output and 2.5: Unassigned Code Points.</span>
<a href="#l88.152"></a><span id="l88.152">   let matchStr =</span>
<a href="#l88.153"></a><span id="l88.153" class="difflineminus">-    RFC3454.C12 + &quot;|&quot; + RFC3454.C21 + &quot;|&quot; + RFC3454.C22 + &quot;|&quot; + RFC3454.C3 +</span>
<a href="#l88.154"></a><span id="l88.154" class="difflineminus">-    &quot;|&quot; + RFC3454.C4 + &quot;|&quot; + RFC3454.C5 + &quot;|&quot; + RFC3454.C6 + &quot;|&quot; + RFC3454.C7 +</span>
<a href="#l88.155"></a><span id="l88.155" class="difflineminus">-    &quot;|&quot; + RFC3454.C8 + &quot;|&quot; + RFC3454.C9 + &quot;|&quot; + RFC3454.A1;</span>
<a href="#l88.156"></a><span id="l88.156" class="difflineplus">+    RFC3454.C12 +</span>
<a href="#l88.157"></a><span id="l88.157" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.158"></a><span id="l88.158" class="difflineplus">+    RFC3454.C21 +</span>
<a href="#l88.159"></a><span id="l88.159" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.160"></a><span id="l88.160" class="difflineplus">+    RFC3454.C22 +</span>
<a href="#l88.161"></a><span id="l88.161" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.162"></a><span id="l88.162" class="difflineplus">+    RFC3454.C3 +</span>
<a href="#l88.163"></a><span id="l88.163" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.164"></a><span id="l88.164" class="difflineplus">+    RFC3454.C4 +</span>
<a href="#l88.165"></a><span id="l88.165" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.166"></a><span id="l88.166" class="difflineplus">+    RFC3454.C5 +</span>
<a href="#l88.167"></a><span id="l88.167" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.168"></a><span id="l88.168" class="difflineplus">+    RFC3454.C6 +</span>
<a href="#l88.169"></a><span id="l88.169" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.170"></a><span id="l88.170" class="difflineplus">+    RFC3454.C7 +</span>
<a href="#l88.171"></a><span id="l88.171" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.172"></a><span id="l88.172" class="difflineplus">+    RFC3454.C8 +</span>
<a href="#l88.173"></a><span id="l88.173" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.174"></a><span id="l88.174" class="difflineplus">+    RFC3454.C9 +</span>
<a href="#l88.175"></a><span id="l88.175" class="difflineplus">+    &quot;|&quot; +</span>
<a href="#l88.176"></a><span id="l88.176" class="difflineplus">+    RFC3454.A1;</span>
<a href="#l88.177"></a><span id="l88.177">   let match = new RegExp(matchStr, &quot;u&quot;).test(retVal);</span>
<a href="#l88.178"></a><span id="l88.178" class="difflineminus">-  if (match)</span>
<a href="#l88.179"></a><span id="l88.179" class="difflineplus">+  if (match) {</span>
<a href="#l88.180"></a><span id="l88.180">     throw new Error(&quot;String contains prohibited characters&quot;);</span>
<a href="#l88.181"></a><span id="l88.181" class="difflineplus">+  }</span>
<a href="#l88.182"></a><span id="l88.182"> </span>
<a href="#l88.183"></a><span id="l88.183">   // RFC 4013 2.4: Bidirectional Characters.</span>
<a href="#l88.184"></a><span id="l88.184">   let r = new RegExp(RFC3454.D1, &quot;u&quot;).test(retVal);</span>
<a href="#l88.185"></a><span id="l88.185">   let l = new RegExp(RFC3454.D2, &quot;u&quot;).test(retVal);</span>
<a href="#l88.186"></a><span id="l88.186" class="difflineminus">-  if (l &amp;&amp; r)</span>
<a href="#l88.187"></a><span id="l88.187" class="difflineminus">-    throw new Error(&quot;String must not contain LCat and RandALCat characters together&quot;);</span>
<a href="#l88.188"></a><span id="l88.188" class="difflineminus">-  else if (r) {</span>
<a href="#l88.189"></a><span id="l88.189" class="difflineplus">+  if (l &amp;&amp; r) {</span>
<a href="#l88.190"></a><span id="l88.190" class="difflineplus">+    throw new Error(</span>
<a href="#l88.191"></a><span id="l88.191" class="difflineplus">+      &quot;String must not contain LCat and RandALCat characters together&quot;</span>
<a href="#l88.192"></a><span id="l88.192" class="difflineplus">+    );</span>
<a href="#l88.193"></a><span id="l88.193" class="difflineplus">+  } else if (r) {</span>
<a href="#l88.194"></a><span id="l88.194">     let matchFirst = new RegExp(&quot;^(&quot; + RFC3454.D1 + &quot;)&quot;, &quot;u&quot;).test(retVal);</span>
<a href="#l88.195"></a><span id="l88.195">     let matchLast = new RegExp(&quot;(&quot; + RFC3454.D1 + &quot;)$&quot;, &quot;u&quot;).test(retVal);</span>
<a href="#l88.196"></a><span id="l88.196" class="difflineminus">-    if (!matchFirst || !matchLast)</span>
<a href="#l88.197"></a><span id="l88.197" class="difflineminus">-      throw new Error(&quot;A RandALCat character must be the first and the last character&quot;);</span>
<a href="#l88.198"></a><span id="l88.198" class="difflineplus">+    if (!matchFirst || !matchLast) {</span>
<a href="#l88.199"></a><span id="l88.199" class="difflineplus">+      throw new Error(</span>
<a href="#l88.200"></a><span id="l88.200" class="difflineplus">+        &quot;A RandALCat character must be the first and the last character&quot;</span>
<a href="#l88.201"></a><span id="l88.201" class="difflineplus">+      );</span>
<a href="#l88.202"></a><span id="l88.202" class="difflineplus">+    }</span>
<a href="#l88.203"></a><span id="l88.203">   }</span>
<a href="#l88.204"></a><span id="l88.204"> </span>
<a href="#l88.205"></a><span id="l88.205">   return retVal;</span>
<a href="#l88.206"></a><span id="l88.206"> }</span>
<a href="#l88.207"></a><span id="l88.207"> </span>
<a href="#l88.208"></a><span id="l88.208"> // Converts aName to saslname.</span>
<a href="#l88.209"></a><span id="l88.209"> function saslName(aName) {</span>
<a href="#l88.210"></a><span id="l88.210">   // RFC 5802 (5.1): the client SHOULD prepare the username using the &quot;SASLprep&quot;.</span>
<a href="#l88.211"></a><span id="l88.211">   // The characters ’,’ or ’=’ in usernames are sent as ’=2C’ and</span>
<a href="#l88.212"></a><span id="l88.212">   // ’=3D’ respectively.</span>
<a href="#l88.213"></a><span id="l88.213" class="difflineminus">-  let saslName = saslPrep(aName).replace(/=/g, &quot;=3D&quot;).replace(/,/g, &quot;=2C&quot;);</span>
<a href="#l88.214"></a><span id="l88.214" class="difflineminus">-  if (!saslName)</span>
<a href="#l88.215"></a><span id="l88.215" class="difflineplus">+  let saslName = saslPrep(aName)</span>
<a href="#l88.216"></a><span id="l88.216" class="difflineplus">+    .replace(/=/g, &quot;=3D&quot;)</span>
<a href="#l88.217"></a><span id="l88.217" class="difflineplus">+    .replace(/,/g, &quot;=2C&quot;);</span>
<a href="#l88.218"></a><span id="l88.218" class="difflineplus">+  if (!saslName) {</span>
<a href="#l88.219"></a><span id="l88.219">     throw new Error(&quot;Name is not valid&quot;);</span>
<a href="#l88.220"></a><span id="l88.220" class="difflineplus">+  }</span>
<a href="#l88.221"></a><span id="l88.221"> </span>
<a href="#l88.222"></a><span id="l88.222">   return saslName;</span>
<a href="#l88.223"></a><span id="l88.223"> }</span>
<a href="#l88.224"></a><span id="l88.224"> </span>
<a href="#l88.225"></a><span id="l88.225"> // Converts aMessage to array of bytes then apply SHA-1 hashing.</span>
<a href="#l88.226"></a><span id="l88.226"> function bytesAndSHA1(aMessage) {</span>
<a href="#l88.227"></a><span id="l88.227" class="difflineminus">-  let hasher =</span>
<a href="#l88.228"></a><span id="l88.228" class="difflineminus">-    Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l88.229"></a><span id="l88.229" class="difflineplus">+  let hasher = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l88.230"></a><span id="l88.230" class="difflineplus">+    Ci.nsICryptoHash</span>
<a href="#l88.231"></a><span id="l88.231" class="difflineplus">+  );</span>
<a href="#l88.232"></a><span id="l88.232">   hasher.init(hasher.SHA1);</span>
<a href="#l88.233"></a><span id="l88.233"> </span>
<a href="#l88.234"></a><span id="l88.234">   return CryptoUtils.digestBytes(aMessage, hasher);</span>
<a href="#l88.235"></a><span id="l88.235"> }</span>
<a href="#l88.236"></a><span id="l88.236"> </span>
<a href="#l88.237"></a><span id="l88.237"> /**</span>
<a href="#l88.238"></a><span id="l88.238">  * PBKDF2 password stretching with SHA-1 hmac.</span>
<a href="#l88.239"></a><span id="l88.239">  *</span>
<a href="#l88.240"></a><span id="l88.240">  * This is a copy of CryptoUtils.pbkdf2Generate, but using SHA-1 instead of</span>
<a href="#l88.241"></a><span id="l88.241">  * SHA-256.</span>
<a href="#l88.242"></a><span id="l88.242">  *</span>
<a href="#l88.243"></a><span id="l88.243">  * @param {string} passphrase Passphrase as an octet string.</span>
<a href="#l88.244"></a><span id="l88.244">  * @param {string} salt Salt as an octet string.</span>
<a href="#l88.245"></a><span id="l88.245">  * @param {string} iterations Number of iterations, a positive integer.</span>
<a href="#l88.246"></a><span id="l88.246">  * @param {string} len Desired output length in bytes.</span>
<a href="#l88.247"></a><span id="l88.247">  */</span>
<a href="#l88.248"></a><span id="l88.248" class="difflineminus">- async function pbkdf2Generate(passphrase, salt, iterations, len) {</span>
<a href="#l88.249"></a><span id="l88.249" class="difflineplus">+async function pbkdf2Generate(passphrase, salt, iterations, len) {</span>
<a href="#l88.250"></a><span id="l88.250">   passphrase = CommonUtils.byteStringToArrayBuffer(passphrase);</span>
<a href="#l88.251"></a><span id="l88.251">   salt = CommonUtils.byteStringToArrayBuffer(salt);</span>
<a href="#l88.252"></a><span id="l88.252" class="difflineminus">-  const key = await crypto.subtle.importKey(&quot;raw&quot;, passphrase, {name: &quot;PBKDF2&quot;}, false, [&quot;deriveBits&quot;]);</span>
<a href="#l88.253"></a><span id="l88.253" class="difflineminus">-  const output = await crypto.subtle.deriveBits({</span>
<a href="#l88.254"></a><span id="l88.254" class="difflineplus">+  const key = await crypto.subtle.importKey(</span>
<a href="#l88.255"></a><span id="l88.255" class="difflineplus">+    &quot;raw&quot;,</span>
<a href="#l88.256"></a><span id="l88.256" class="difflineplus">+    passphrase,</span>
<a href="#l88.257"></a><span id="l88.257" class="difflineplus">+    { name: &quot;PBKDF2&quot; },</span>
<a href="#l88.258"></a><span id="l88.258" class="difflineplus">+    false,</span>
<a href="#l88.259"></a><span id="l88.259" class="difflineplus">+    [&quot;deriveBits&quot;]</span>
<a href="#l88.260"></a><span id="l88.260" class="difflineplus">+  );</span>
<a href="#l88.261"></a><span id="l88.261" class="difflineplus">+  const output = await crypto.subtle.deriveBits(</span>
<a href="#l88.262"></a><span id="l88.262" class="difflineplus">+    {</span>
<a href="#l88.263"></a><span id="l88.263">       name: &quot;PBKDF2&quot;,</span>
<a href="#l88.264"></a><span id="l88.264">       hash: &quot;SHA-1&quot;,</span>
<a href="#l88.265"></a><span id="l88.265">       salt,</span>
<a href="#l88.266"></a><span id="l88.266">       iterations,</span>
<a href="#l88.267"></a><span id="l88.267" class="difflineminus">-  }, key, len * 8);</span>
<a href="#l88.268"></a><span id="l88.268" class="difflineplus">+    },</span>
<a href="#l88.269"></a><span id="l88.269" class="difflineplus">+    key,</span>
<a href="#l88.270"></a><span id="l88.270" class="difflineplus">+    len * 8</span>
<a href="#l88.271"></a><span id="l88.271" class="difflineplus">+  );</span>
<a href="#l88.272"></a><span id="l88.272">   return CommonUtils.arrayBufferToByteString(new Uint8Array(output));</span>
<a href="#l88.273"></a><span id="l88.273"> }</span>
<a href="#l88.274"></a><span id="l88.274"> </span>
<a href="#l88.275"></a><span id="l88.275"> function* scramSHA1Auth(aUsername, aPassword, aDomain, aNonce) {</span>
<a href="#l88.276"></a><span id="l88.276">   // RFC 5802 (5): SCRAM Authentication Exchange.</span>
<a href="#l88.277"></a><span id="l88.277">   const gs2Header = &quot;n,,&quot;;</span>
<a href="#l88.278"></a><span id="l88.278">   // If a hard-coded nonce was given (e.g. for testing), use it.</span>
<a href="#l88.279"></a><span id="l88.279">   let cNonce = aNonce ? aNonce : createNonce(32);</span>
<a href="#l88.280"></a><span id="l88.280"> </span>
<a href="#l88.281"></a><span id="l88.281" class="difflineminus">-  let clientFirstMessageBare =</span>
<a href="#l88.282"></a><span id="l88.282" class="difflineminus">-    &quot;n=&quot; + saslName(aUsername) + &quot;,r=&quot; + cNonce;</span>
<a href="#l88.283"></a><span id="l88.283" class="difflineplus">+  let clientFirstMessageBare = &quot;n=&quot; + saslName(aUsername) + &quot;,r=&quot; + cNonce;</span>
<a href="#l88.284"></a><span id="l88.284">   let clientFirstMessage = gs2Header + clientFirstMessageBare;</span>
<a href="#l88.285"></a><span id="l88.285"> </span>
<a href="#l88.286"></a><span id="l88.286">   let receivedStanza = yield {</span>
<a href="#l88.287"></a><span id="l88.287" class="difflineminus">-    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;SCRAM-SHA-1&quot;},</span>
<a href="#l88.288"></a><span id="l88.288" class="difflineminus">-                      btoa(clientFirstMessage)),</span>
<a href="#l88.289"></a><span id="l88.289" class="difflineplus">+    send: Stanza.node(</span>
<a href="#l88.290"></a><span id="l88.290" class="difflineplus">+      &quot;auth&quot;,</span>
<a href="#l88.291"></a><span id="l88.291" class="difflineplus">+      Stanza.NS.sasl,</span>
<a href="#l88.292"></a><span id="l88.292" class="difflineplus">+      { mechanism: &quot;SCRAM-SHA-1&quot; },</span>
<a href="#l88.293"></a><span id="l88.293" class="difflineplus">+      btoa(clientFirstMessage)</span>
<a href="#l88.294"></a><span id="l88.294" class="difflineplus">+    ),</span>
<a href="#l88.295"></a><span id="l88.295">   };</span>
<a href="#l88.296"></a><span id="l88.296"> </span>
<a href="#l88.297"></a><span id="l88.297" class="difflineminus">-  if (receivedStanza.localName != &quot;challenge&quot;)</span>
<a href="#l88.298"></a><span id="l88.298" class="difflineplus">+  if (receivedStanza.localName != &quot;challenge&quot;) {</span>
<a href="#l88.299"></a><span id="l88.299">     throw new Error(&quot;Not authorized&quot;);</span>
<a href="#l88.300"></a><span id="l88.300" class="difflineplus">+  }</span>
<a href="#l88.301"></a><span id="l88.301"> </span>
<a href="#l88.302"></a><span id="l88.302">   // RFC 5802 (3): SCRAM Algorithm Overview.</span>
<a href="#l88.303"></a><span id="l88.303">   let decodedChallenge = atob(receivedStanza.innerText);</span>
<a href="#l88.304"></a><span id="l88.304"> </span>
<a href="#l88.305"></a><span id="l88.305">   // Expected to contain the user’s iteration count (i) and the user’s</span>
<a href="#l88.306"></a><span id="l88.306">   // salt (s), and the server appends its own nonce to the client-specified</span>
<a href="#l88.307"></a><span id="l88.307">   // one (r).</span>
<a href="#l88.308"></a><span id="l88.308">   let attributes = parseChallenge(decodedChallenge);</span>
<a href="#l88.309"></a><span id="l88.309" class="difflineminus">-  if (attributes.hasOwnProperty(&quot;e&quot;))</span>
<a href="#l88.310"></a><span id="l88.310" class="difflineplus">+  if (attributes.hasOwnProperty(&quot;e&quot;)) {</span>
<a href="#l88.311"></a><span id="l88.311">     throw new Error(&quot;Authentication failed: &quot; + attributes.e);</span>
<a href="#l88.312"></a><span id="l88.312" class="difflineminus">-  else if (!attributes.hasOwnProperty(&quot;i&quot;) ||</span>
<a href="#l88.313"></a><span id="l88.313" class="difflineminus">-           !attributes.hasOwnProperty(&quot;s&quot;) ||</span>
<a href="#l88.314"></a><span id="l88.314" class="difflineminus">-           !attributes.hasOwnProperty(&quot;r&quot;)) {</span>
<a href="#l88.315"></a><span id="l88.315" class="difflineplus">+  } else if (</span>
<a href="#l88.316"></a><span id="l88.316" class="difflineplus">+    !attributes.hasOwnProperty(&quot;i&quot;) ||</span>
<a href="#l88.317"></a><span id="l88.317" class="difflineplus">+    !attributes.hasOwnProperty(&quot;s&quot;) ||</span>
<a href="#l88.318"></a><span id="l88.318" class="difflineplus">+    !attributes.hasOwnProperty(&quot;r&quot;)</span>
<a href="#l88.319"></a><span id="l88.319" class="difflineplus">+  ) {</span>
<a href="#l88.320"></a><span id="l88.320">     throw new Error(&quot;Unexpected response: &quot; + decodedChallenge);</span>
<a href="#l88.321"></a><span id="l88.321">   }</span>
<a href="#l88.322"></a><span id="l88.322" class="difflineminus">-  if (!attributes.r.startsWith(cNonce))</span>
<a href="#l88.323"></a><span id="l88.323" class="difflineplus">+  if (!attributes.r.startsWith(cNonce)) {</span>
<a href="#l88.324"></a><span id="l88.324">     throw new Error(&quot;Nonce is not correct&quot;);</span>
<a href="#l88.325"></a><span id="l88.325" class="difflineplus">+  }</span>
<a href="#l88.326"></a><span id="l88.326"> </span>
<a href="#l88.327"></a><span id="l88.327">   let clientFinalMessageWithoutProof =</span>
<a href="#l88.328"></a><span id="l88.328">     &quot;c=&quot; + btoa(gs2Header) + &quot;,r=&quot; + attributes.r;</span>
<a href="#l88.329"></a><span id="l88.329"> </span>
<a href="#l88.330"></a><span id="l88.330">   // Calculate ClientProof.</span>
<a href="#l88.331"></a><span id="l88.331"> </span>
<a href="#l88.332"></a><span id="l88.332">   // SaltedPassword := Hi(Normalize(password), salt, i)</span>
<a href="#l88.333"></a><span id="l88.333">   // Normalize using saslPrep.</span>
<a href="#l88.334"></a><span id="l88.334">   // dkLen MUST be equal to the SHA-1 digest size.</span>
<a href="#l88.335"></a><span id="l88.335" class="difflineminus">-  let passwordPromise = pbkdf2Generate(saslPrep(aPassword), atob(attributes.s),</span>
<a href="#l88.336"></a><span id="l88.336" class="difflineminus">-                                       parseInt(attributes.i), 20);</span>
<a href="#l88.337"></a><span id="l88.337" class="difflineplus">+  let passwordPromise = pbkdf2Generate(</span>
<a href="#l88.338"></a><span id="l88.338" class="difflineplus">+    saslPrep(aPassword),</span>
<a href="#l88.339"></a><span id="l88.339" class="difflineplus">+    atob(attributes.s),</span>
<a href="#l88.340"></a><span id="l88.340" class="difflineplus">+    parseInt(attributes.i),</span>
<a href="#l88.341"></a><span id="l88.341" class="difflineplus">+    20</span>
<a href="#l88.342"></a><span id="l88.342" class="difflineplus">+  );</span>
<a href="#l88.343"></a><span id="l88.343"> </span>
<a href="#l88.344"></a><span id="l88.344">   // The server signature is calculated below, but needs to escape back to the main scope.</span>
<a href="#l88.345"></a><span id="l88.345">   let serverSignature;</span>
<a href="#l88.346"></a><span id="l88.346"> </span>
<a href="#l88.347"></a><span id="l88.347">   // Once the promise resolves, continue with the handshake..</span>
<a href="#l88.348"></a><span id="l88.348" class="difflineminus">-  receivedStanza = yield passwordPromise.then((saltedPassword) =&gt; {</span>
<a href="#l88.349"></a><span id="l88.349" class="difflineplus">+  receivedStanza = yield passwordPromise.then(saltedPassword =&gt; {</span>
<a href="#l88.350"></a><span id="l88.350">     // ClientKey := HMAC(SaltedPassword, &quot;Client Key&quot;)</span>
<a href="#l88.351"></a><span id="l88.351" class="difflineminus">-    let saltedPasswordHasher =</span>
<a href="#l88.352"></a><span id="l88.352" class="difflineminus">-      CryptoUtils.makeHMACHasher(Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l88.353"></a><span id="l88.353" class="difflineminus">-                                 CryptoUtils.makeHMACKey(saltedPassword));</span>
<a href="#l88.354"></a><span id="l88.354" class="difflineplus">+    let saltedPasswordHasher = CryptoUtils.makeHMACHasher(</span>
<a href="#l88.355"></a><span id="l88.355" class="difflineplus">+      Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l88.356"></a><span id="l88.356" class="difflineplus">+      CryptoUtils.makeHMACKey(saltedPassword)</span>
<a href="#l88.357"></a><span id="l88.357" class="difflineplus">+    );</span>
<a href="#l88.358"></a><span id="l88.358">     let clientKey = CryptoUtils.digestBytes(&quot;Client Key&quot;, saltedPasswordHasher);</span>
<a href="#l88.359"></a><span id="l88.359"> </span>
<a href="#l88.360"></a><span id="l88.360">     // StoredKey := H(ClientKey)</span>
<a href="#l88.361"></a><span id="l88.361">     let storedKey = bytesAndSHA1(clientKey);</span>
<a href="#l88.362"></a><span id="l88.362"> </span>
<a href="#l88.363"></a><span id="l88.363">     let authMessage =</span>
<a href="#l88.364"></a><span id="l88.364" class="difflineminus">-      clientFirstMessageBare + &quot;,&quot; + decodedChallenge + &quot;,&quot; +</span>
<a href="#l88.365"></a><span id="l88.365" class="difflineplus">+      clientFirstMessageBare +</span>
<a href="#l88.366"></a><span id="l88.366" class="difflineplus">+      &quot;,&quot; +</span>
<a href="#l88.367"></a><span id="l88.367" class="difflineplus">+      decodedChallenge +</span>
<a href="#l88.368"></a><span id="l88.368" class="difflineplus">+      &quot;,&quot; +</span>
<a href="#l88.369"></a><span id="l88.369">       clientFinalMessageWithoutProof;</span>
<a href="#l88.370"></a><span id="l88.370"> </span>
<a href="#l88.371"></a><span id="l88.371">     // ClientSignature := HMAC(StoredKey, AuthMessage)</span>
<a href="#l88.372"></a><span id="l88.372" class="difflineminus">-    let storedKeyHasher =</span>
<a href="#l88.373"></a><span id="l88.373" class="difflineminus">-      CryptoUtils.makeHMACHasher(Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l88.374"></a><span id="l88.374" class="difflineminus">-                                 CryptoUtils.makeHMACKey(storedKey));</span>
<a href="#l88.375"></a><span id="l88.375" class="difflineplus">+    let storedKeyHasher = CryptoUtils.makeHMACHasher(</span>
<a href="#l88.376"></a><span id="l88.376" class="difflineplus">+      Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l88.377"></a><span id="l88.377" class="difflineplus">+      CryptoUtils.makeHMACKey(storedKey)</span>
<a href="#l88.378"></a><span id="l88.378" class="difflineplus">+    );</span>
<a href="#l88.379"></a><span id="l88.379">     let clientSignature = CryptoUtils.digestBytes(authMessage, storedKeyHasher);</span>
<a href="#l88.380"></a><span id="l88.380"> </span>
<a href="#l88.381"></a><span id="l88.381">     // ClientProof := ClientKey XOR ClientSignature</span>
<a href="#l88.382"></a><span id="l88.382">     let clientProof = CryptoUtils.xor(clientKey, clientSignature);</span>
<a href="#l88.383"></a><span id="l88.383"> </span>
<a href="#l88.384"></a><span id="l88.384">     // Calculate ServerSignature.</span>
<a href="#l88.385"></a><span id="l88.385"> </span>
<a href="#l88.386"></a><span id="l88.386">     // ServerKey := HMAC(SaltedPassword, &quot;Server Key&quot;)</span>
<a href="#l88.387"></a><span id="l88.387">     let serverKey = CryptoUtils.digestBytes(&quot;Server Key&quot;, saltedPasswordHasher);</span>
<a href="#l88.388"></a><span id="l88.388"> </span>
<a href="#l88.389"></a><span id="l88.389">     // ServerSignature := HMAC(ServerKey, AuthMessage)</span>
<a href="#l88.390"></a><span id="l88.390" class="difflineminus">-    let serverKeyHasher =</span>
<a href="#l88.391"></a><span id="l88.391" class="difflineminus">-      CryptoUtils.makeHMACHasher(Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l88.392"></a><span id="l88.392" class="difflineminus">-                                 CryptoUtils.makeHMACKey(serverKey));</span>
<a href="#l88.393"></a><span id="l88.393" class="difflineplus">+    let serverKeyHasher = CryptoUtils.makeHMACHasher(</span>
<a href="#l88.394"></a><span id="l88.394" class="difflineplus">+      Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l88.395"></a><span id="l88.395" class="difflineplus">+      CryptoUtils.makeHMACKey(serverKey)</span>
<a href="#l88.396"></a><span id="l88.396" class="difflineplus">+    );</span>
<a href="#l88.397"></a><span id="l88.397">     serverSignature = CryptoUtils.digestBytes(authMessage, serverKeyHasher);</span>
<a href="#l88.398"></a><span id="l88.398"> </span>
<a href="#l88.399"></a><span id="l88.399">     let clientFinalMessage =</span>
<a href="#l88.400"></a><span id="l88.400">       clientFinalMessageWithoutProof + &quot;,p=&quot; + btoa(clientProof);</span>
<a href="#l88.401"></a><span id="l88.401"> </span>
<a href="#l88.402"></a><span id="l88.402">     return {</span>
<a href="#l88.403"></a><span id="l88.403" class="difflineminus">-      send: Stanza.node(&quot;response&quot;, Stanza.NS.sasl, null, btoa(clientFinalMessage)),</span>
<a href="#l88.404"></a><span id="l88.404" class="difflineminus">-      log: &quot;&lt;response/&gt; (base64 encoded SCRAM response containing password not logged)&quot;,</span>
<a href="#l88.405"></a><span id="l88.405" class="difflineplus">+      send: Stanza.node(</span>
<a href="#l88.406"></a><span id="l88.406" class="difflineplus">+        &quot;response&quot;,</span>
<a href="#l88.407"></a><span id="l88.407" class="difflineplus">+        Stanza.NS.sasl,</span>
<a href="#l88.408"></a><span id="l88.408" class="difflineplus">+        null,</span>
<a href="#l88.409"></a><span id="l88.409" class="difflineplus">+        btoa(clientFinalMessage)</span>
<a href="#l88.410"></a><span id="l88.410" class="difflineplus">+      ),</span>
<a href="#l88.411"></a><span id="l88.411" class="difflineplus">+      log:</span>
<a href="#l88.412"></a><span id="l88.412" class="difflineplus">+        &quot;&lt;response/&gt; (base64 encoded SCRAM response containing password not logged)&quot;,</span>
<a href="#l88.413"></a><span id="l88.413">     };</span>
<a href="#l88.414"></a><span id="l88.414">   });</span>
<a href="#l88.415"></a><span id="l88.415"> </span>
<a href="#l88.416"></a><span id="l88.416">   // Only check server signature if we succeed to authenticate.</span>
<a href="#l88.417"></a><span id="l88.417" class="difflineminus">-  if (receivedStanza.localName != &quot;success&quot;)</span>
<a href="#l88.418"></a><span id="l88.418" class="difflineplus">+  if (receivedStanza.localName != &quot;success&quot;) {</span>
<a href="#l88.419"></a><span id="l88.419">     throw new Error(&quot;Didn't receive the expected auth success stanza.&quot;);</span>
<a href="#l88.420"></a><span id="l88.420" class="difflineplus">+  }</span>
<a href="#l88.421"></a><span id="l88.421"> </span>
<a href="#l88.422"></a><span id="l88.422">   let decodedResponse = atob(receivedStanza.innerText);</span>
<a href="#l88.423"></a><span id="l88.423"> </span>
<a href="#l88.424"></a><span id="l88.424">   // Expected to contain a base64-encoded ServerSignature (v).</span>
<a href="#l88.425"></a><span id="l88.425">   attributes = parseChallenge(decodedResponse);</span>
<a href="#l88.426"></a><span id="l88.426" class="difflineminus">-  if (!attributes.hasOwnProperty(&quot;v&quot;))</span>
<a href="#l88.427"></a><span id="l88.427" class="difflineplus">+  if (!attributes.hasOwnProperty(&quot;v&quot;)) {</span>
<a href="#l88.428"></a><span id="l88.428">     throw new Error(&quot;Unexpected response: &quot; + decodedResponse);</span>
<a href="#l88.429"></a><span id="l88.429" class="difflineplus">+  }</span>
<a href="#l88.430"></a><span id="l88.430"> </span>
<a href="#l88.431"></a><span id="l88.431">   // Compare ServerSignature with our ServerSignature which we calculated in</span>
<a href="#l88.432"></a><span id="l88.432">   // _generateResponse.</span>
<a href="#l88.433"></a><span id="l88.433">   let serverSignatureResponse = atob(attributes.v);</span>
<a href="#l88.434"></a><span id="l88.434" class="difflineminus">-  if (serverSignature != serverSignatureResponse)</span>
<a href="#l88.435"></a><span id="l88.435" class="difflineplus">+  if (serverSignature != serverSignatureResponse) {</span>
<a href="#l88.436"></a><span id="l88.436">     throw new Error(&quot;Server signature does not match&quot;);</span>
<a href="#l88.437"></a><span id="l88.437" class="difflineplus">+  }</span>
<a href="#l88.438"></a><span id="l88.438"> }</span>
<a href="#l88.439"></a><span id="l88.439"> </span>
<a href="#l88.440"></a><span id="l88.440" class="difflineminus">-var XMPPAuthMechanisms = {&quot;PLAIN&quot;: PlainAuth, &quot;SCRAM-SHA-1&quot;: scramSHA1Auth};</span>
<a href="#l88.441"></a><span id="l88.441" class="difflineplus">+var XMPPAuthMechanisms = { PLAIN: PlainAuth, &quot;SCRAM-SHA-1&quot;: scramSHA1Auth };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-commands.jsm</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-commands.jsm</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l89.4"></a><span id="l89.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l89.5"></a><span id="l89.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l89.6"></a><span id="l89.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l89.7"></a><span id="l89.7"> </span>
<a href="#l89.8"></a><span id="l89.8"> this.EXPORTED_SYMBOLS = [&quot;commands&quot;];</span>
<a href="#l89.9"></a><span id="l89.9"> </span>
<a href="#l89.10"></a><span id="l89.10" class="difflineminus">-var {</span>
<a href="#l89.11"></a><span id="l89.11" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-  l10nHelper,</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l89.16"></a><span id="l89.16" class="difflineplus">+);</span>
<a href="#l89.17"></a><span id="l89.17"> </span>
<a href="#l89.18"></a><span id="l89.18"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l89.19"></a><span id="l89.19">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l89.20"></a><span id="l89.20"> );</span>
<a href="#l89.21"></a><span id="l89.21"> </span>
<a href="#l89.22"></a><span id="l89.22"> // Get conversation object.</span>
<a href="#l89.23"></a><span id="l89.23"> function getConv(aConv) {</span>
<a href="#l89.24"></a><span id="l89.24">   return aConv.wrappedJSObject;</span>
<a href="#l89.25"></a><span id="l89.25" class="difflineat">@@ -21,275 +20,330 @@ function getConv(aConv) {</span>
<a href="#l89.26"></a><span id="l89.26"> // Get account object.</span>
<a href="#l89.27"></a><span id="l89.27"> function getAccount(aConv) {</span>
<a href="#l89.28"></a><span id="l89.28">   return getConv(aConv)._account;</span>
<a href="#l89.29"></a><span id="l89.29"> }</span>
<a href="#l89.30"></a><span id="l89.30"> </span>
<a href="#l89.31"></a><span id="l89.31"> function getMUC(aConv) {</span>
<a href="#l89.32"></a><span id="l89.32">   let conv = getConv(aConv);</span>
<a href="#l89.33"></a><span id="l89.33">   if (conv.left) {</span>
<a href="#l89.34"></a><span id="l89.34" class="difflineminus">-    conv.writeMessage(conv.name,</span>
<a href="#l89.35"></a><span id="l89.35" class="difflineminus">-                      _(&quot;conversation.error.commandFailedNotInRoom&quot;),</span>
<a href="#l89.36"></a><span id="l89.36" class="difflineminus">-                      {system: true});</span>
<a href="#l89.37"></a><span id="l89.37" class="difflineplus">+    conv.writeMessage(</span>
<a href="#l89.38"></a><span id="l89.38" class="difflineplus">+      conv.name,</span>
<a href="#l89.39"></a><span id="l89.39" class="difflineplus">+      _(&quot;conversation.error.commandFailedNotInRoom&quot;),</span>
<a href="#l89.40"></a><span id="l89.40" class="difflineplus">+      { system: true }</span>
<a href="#l89.41"></a><span id="l89.41" class="difflineplus">+    );</span>
<a href="#l89.42"></a><span id="l89.42">     return null;</span>
<a href="#l89.43"></a><span id="l89.43">   }</span>
<a href="#l89.44"></a><span id="l89.44">   return conv;</span>
<a href="#l89.45"></a><span id="l89.45"> }</span>
<a href="#l89.46"></a><span id="l89.46"> </span>
<a href="#l89.47"></a><span id="l89.47"> // Trims the string and splits it in two parts on the first space</span>
<a href="#l89.48"></a><span id="l89.48"> // if there is one. Returns the non-empty parts in an array.</span>
<a href="#l89.49"></a><span id="l89.49"> function splitInput(aString) {</span>
<a href="#l89.50"></a><span id="l89.50">   let params = aString.trim();</span>
<a href="#l89.51"></a><span id="l89.51" class="difflineminus">-  if (!params)</span>
<a href="#l89.52"></a><span id="l89.52" class="difflineplus">+  if (!params) {</span>
<a href="#l89.53"></a><span id="l89.53">     return [];</span>
<a href="#l89.54"></a><span id="l89.54" class="difflineplus">+  }</span>
<a href="#l89.55"></a><span id="l89.55"> </span>
<a href="#l89.56"></a><span id="l89.56">   let splitParams = [];</span>
<a href="#l89.57"></a><span id="l89.57">   let offset = params.indexOf(&quot; &quot;);</span>
<a href="#l89.58"></a><span id="l89.58">   if (offset != -1) {</span>
<a href="#l89.59"></a><span id="l89.59">     splitParams.push(params.slice(0, offset));</span>
<a href="#l89.60"></a><span id="l89.60">     splitParams.push(params.slice(offset + 1).trimLeft());</span>
<a href="#l89.61"></a><span id="l89.61" class="difflineplus">+  } else {</span>
<a href="#l89.62"></a><span id="l89.62" class="difflineplus">+    splitParams.push(params);</span>
<a href="#l89.63"></a><span id="l89.63">   }</span>
<a href="#l89.64"></a><span id="l89.64" class="difflineminus">-  else</span>
<a href="#l89.65"></a><span id="l89.65" class="difflineminus">-    splitParams.push(params);</span>
<a href="#l89.66"></a><span id="l89.66">   return splitParams;</span>
<a href="#l89.67"></a><span id="l89.67"> }</span>
<a href="#l89.68"></a><span id="l89.68"> </span>
<a href="#l89.69"></a><span id="l89.69"> // Trims the string and splits it in two parts (The first part is a nickname</span>
<a href="#l89.70"></a><span id="l89.70"> // and the second part is the rest of string) based on nicknames of current</span>
<a href="#l89.71"></a><span id="l89.71"> // participants. Returns the non-empty parts in an array.</span>
<a href="#l89.72"></a><span id="l89.72"> function splitByNick(aString, aConv) {</span>
<a href="#l89.73"></a><span id="l89.73">   let params = aString.trim();</span>
<a href="#l89.74"></a><span id="l89.74" class="difflineminus">-  if (!params)</span>
<a href="#l89.75"></a><span id="l89.75" class="difflineplus">+  if (!params) {</span>
<a href="#l89.76"></a><span id="l89.76">     return [];</span>
<a href="#l89.77"></a><span id="l89.77" class="difflineplus">+  }</span>
<a href="#l89.78"></a><span id="l89.78"> </span>
<a href="#l89.79"></a><span id="l89.79">   // Match trimmed-string with the longest prefix of participant's nickname.</span>
<a href="#l89.80"></a><span id="l89.80">   let nickName = &quot;&quot;;</span>
<a href="#l89.81"></a><span id="l89.81">   for (let participant of aConv._participants.keys()) {</span>
<a href="#l89.82"></a><span id="l89.82" class="difflineminus">-    if (params.startsWith(participant + &quot; &quot;) &amp;&amp;</span>
<a href="#l89.83"></a><span id="l89.83" class="difflineminus">-        participant.length &gt; nickName.length)</span>
<a href="#l89.84"></a><span id="l89.84" class="difflineplus">+    if (</span>
<a href="#l89.85"></a><span id="l89.85" class="difflineplus">+      params.startsWith(participant + &quot; &quot;) &amp;&amp;</span>
<a href="#l89.86"></a><span id="l89.86" class="difflineplus">+      participant.length &gt; nickName.length</span>
<a href="#l89.87"></a><span id="l89.87" class="difflineplus">+    ) {</span>
<a href="#l89.88"></a><span id="l89.88">       nickName = participant;</span>
<a href="#l89.89"></a><span id="l89.89" class="difflineplus">+    }</span>
<a href="#l89.90"></a><span id="l89.90">   }</span>
<a href="#l89.91"></a><span id="l89.91">   if (!nickName) {</span>
<a href="#l89.92"></a><span id="l89.92">     let offset = params.indexOf(&quot; &quot;);</span>
<a href="#l89.93"></a><span id="l89.93">     let expectedNickName = offset != -1 ? params.slice(0, offset) : params;</span>
<a href="#l89.94"></a><span id="l89.94" class="difflineminus">-    aConv.writeMessage(aConv.name,</span>
<a href="#l89.95"></a><span id="l89.95" class="difflineminus">-                      _(&quot;conversation.error.nickNotInRoom&quot;, expectedNickName),</span>
<a href="#l89.96"></a><span id="l89.96" class="difflineminus">-                      {system: true});</span>
<a href="#l89.97"></a><span id="l89.97" class="difflineplus">+    aConv.writeMessage(</span>
<a href="#l89.98"></a><span id="l89.98" class="difflineplus">+      aConv.name,</span>
<a href="#l89.99"></a><span id="l89.99" class="difflineplus">+      _(&quot;conversation.error.nickNotInRoom&quot;, expectedNickName),</span>
<a href="#l89.100"></a><span id="l89.100" class="difflineplus">+      { system: true }</span>
<a href="#l89.101"></a><span id="l89.101" class="difflineplus">+    );</span>
<a href="#l89.102"></a><span id="l89.102">     return [];</span>
<a href="#l89.103"></a><span id="l89.103">   }</span>
<a href="#l89.104"></a><span id="l89.104"> </span>
<a href="#l89.105"></a><span id="l89.105">   let splitParams = [];</span>
<a href="#l89.106"></a><span id="l89.106">   splitParams.push(nickName);</span>
<a href="#l89.107"></a><span id="l89.107"> </span>
<a href="#l89.108"></a><span id="l89.108">   let msg = params.substring(nickName.length);</span>
<a href="#l89.109"></a><span id="l89.109" class="difflineminus">-  if (msg)</span>
<a href="#l89.110"></a><span id="l89.110" class="difflineplus">+  if (msg) {</span>
<a href="#l89.111"></a><span id="l89.111">     splitParams.push(msg.trimLeft());</span>
<a href="#l89.112"></a><span id="l89.112" class="difflineplus">+  }</span>
<a href="#l89.113"></a><span id="l89.113">   return splitParams;</span>
<a href="#l89.114"></a><span id="l89.114"> }</span>
<a href="#l89.115"></a><span id="l89.115"> </span>
<a href="#l89.116"></a><span id="l89.116"> // Splits aMsg in two entries and checks the first entry is a valid jid, then</span>
<a href="#l89.117"></a><span id="l89.117"> // passes it to aConv.invite().</span>
<a href="#l89.118"></a><span id="l89.118"> // Returns false if aMsg is empty, otherwise returns true.</span>
<a href="#l89.119"></a><span id="l89.119"> function invite(aMsg, aConv) {</span>
<a href="#l89.120"></a><span id="l89.120">   let params = splitInput(aMsg);</span>
<a href="#l89.121"></a><span id="l89.121" class="difflineminus">-  if (!params.length)</span>
<a href="#l89.122"></a><span id="l89.122" class="difflineplus">+  if (!params.length) {</span>
<a href="#l89.123"></a><span id="l89.123">     return false;</span>
<a href="#l89.124"></a><span id="l89.124" class="difflineplus">+  }</span>
<a href="#l89.125"></a><span id="l89.125"> </span>
<a href="#l89.126"></a><span id="l89.126">   // Check user's jid is valid.</span>
<a href="#l89.127"></a><span id="l89.127">   let account = getAccount(aConv);</span>
<a href="#l89.128"></a><span id="l89.128">   let jid = account._parseJID(params[0]);</span>
<a href="#l89.129"></a><span id="l89.129">   if (!jid) {</span>
<a href="#l89.130"></a><span id="l89.130" class="difflineminus">-    aConv.writeMessage(aConv.name,</span>
<a href="#l89.131"></a><span id="l89.131" class="difflineminus">-                      _(&quot;conversation.error.invalidJID&quot;, params[0]),</span>
<a href="#l89.132"></a><span id="l89.132" class="difflineminus">-                      {system: true});</span>
<a href="#l89.133"></a><span id="l89.133" class="difflineplus">+    aConv.writeMessage(</span>
<a href="#l89.134"></a><span id="l89.134" class="difflineplus">+      aConv.name,</span>
<a href="#l89.135"></a><span id="l89.135" class="difflineplus">+      _(&quot;conversation.error.invalidJID&quot;, params[0]),</span>
<a href="#l89.136"></a><span id="l89.136" class="difflineplus">+      { system: true }</span>
<a href="#l89.137"></a><span id="l89.137" class="difflineplus">+    );</span>
<a href="#l89.138"></a><span id="l89.138">     return true;</span>
<a href="#l89.139"></a><span id="l89.139">   }</span>
<a href="#l89.140"></a><span id="l89.140"> </span>
<a href="#l89.141"></a><span id="l89.141">   aConv.invite(...params);</span>
<a href="#l89.142"></a><span id="l89.142">   return true;</span>
<a href="#l89.143"></a><span id="l89.143"> }</span>
<a href="#l89.144"></a><span id="l89.144"> </span>
<a href="#l89.145"></a><span id="l89.145"> var commands = [</span>
<a href="#l89.146"></a><span id="l89.146">   {</span>
<a href="#l89.147"></a><span id="l89.147">     name: &quot;join&quot;,</span>
<a href="#l89.148"></a><span id="l89.148" class="difflineminus">-    get helpString() { return _(&quot;command.join3&quot;, &quot;join&quot;); },</span>
<a href="#l89.149"></a><span id="l89.149" class="difflineplus">+    get helpString() {</span>
<a href="#l89.150"></a><span id="l89.150" class="difflineplus">+      return _(&quot;command.join3&quot;, &quot;join&quot;);</span>
<a href="#l89.151"></a><span id="l89.151" class="difflineplus">+    },</span>
<a href="#l89.152"></a><span id="l89.152">     run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l89.153"></a><span id="l89.153">       let account = getAccount(aConv);</span>
<a href="#l89.154"></a><span id="l89.154">       let params = aMsg.trim();</span>
<a href="#l89.155"></a><span id="l89.155">       let conv;</span>
<a href="#l89.156"></a><span id="l89.156"> </span>
<a href="#l89.157"></a><span id="l89.157">       if (!params) {</span>
<a href="#l89.158"></a><span id="l89.158">         conv = getConv(aConv);</span>
<a href="#l89.159"></a><span id="l89.159" class="difflineminus">-        if (!conv.isChat)</span>
<a href="#l89.160"></a><span id="l89.160" class="difflineplus">+        if (!conv.isChat) {</span>
<a href="#l89.161"></a><span id="l89.161">           return false;</span>
<a href="#l89.162"></a><span id="l89.162" class="difflineminus">-        if (!conv.left)</span>
<a href="#l89.163"></a><span id="l89.163" class="difflineplus">+        }</span>
<a href="#l89.164"></a><span id="l89.164" class="difflineplus">+        if (!conv.left) {</span>
<a href="#l89.165"></a><span id="l89.165">           return true;</span>
<a href="#l89.166"></a><span id="l89.166" class="difflineplus">+        }</span>
<a href="#l89.167"></a><span id="l89.167"> </span>
<a href="#l89.168"></a><span id="l89.168">         // Rejoin the current conversation. If the conversation was explicitly</span>
<a href="#l89.169"></a><span id="l89.169">         // parted by the user, chatRoomFields will have been deleted.</span>
<a href="#l89.170"></a><span id="l89.170">         // Otherwise, make use of it.</span>
<a href="#l89.171"></a><span id="l89.171">         if (conv.chatRoomFields) {</span>
<a href="#l89.172"></a><span id="l89.172">           account.joinChat(conv.chatRoomFields);</span>
<a href="#l89.173"></a><span id="l89.173">           return true;</span>
<a href="#l89.174"></a><span id="l89.174">         }</span>
<a href="#l89.175"></a><span id="l89.175"> </span>
<a href="#l89.176"></a><span id="l89.176">         params = conv.name;</span>
<a href="#l89.177"></a><span id="l89.177">       }</span>
<a href="#l89.178"></a><span id="l89.178">       let chatRoomFields = account.getChatRoomDefaultFieldValues(params);</span>
<a href="#l89.179"></a><span id="l89.179">       conv = account.joinChat(chatRoomFields);</span>
<a href="#l89.180"></a><span id="l89.180"> </span>
<a href="#l89.181"></a><span id="l89.181" class="difflineminus">-      if (aReturnedConv)</span>
<a href="#l89.182"></a><span id="l89.182" class="difflineplus">+      if (aReturnedConv) {</span>
<a href="#l89.183"></a><span id="l89.183">         aReturnedConv.value = conv;</span>
<a href="#l89.184"></a><span id="l89.184" class="difflineplus">+      }</span>
<a href="#l89.185"></a><span id="l89.185">       return true;</span>
<a href="#l89.186"></a><span id="l89.186">     },</span>
<a href="#l89.187"></a><span id="l89.187">   },</span>
<a href="#l89.188"></a><span id="l89.188">   {</span>
<a href="#l89.189"></a><span id="l89.189">     name: &quot;part&quot;,</span>
<a href="#l89.190"></a><span id="l89.190" class="difflineminus">-    get helpString() { return _(&quot;command.part2&quot;, &quot;part&quot;); },</span>
<a href="#l89.191"></a><span id="l89.191" class="difflineplus">+    get helpString() {</span>
<a href="#l89.192"></a><span id="l89.192" class="difflineplus">+      return _(&quot;command.part2&quot;, &quot;part&quot;);</span>
<a href="#l89.193"></a><span id="l89.193" class="difflineplus">+    },</span>
<a href="#l89.194"></a><span id="l89.194">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.195"></a><span id="l89.195">     run(aMsg, aConv) {</span>
<a href="#l89.196"></a><span id="l89.196">       let conv = getConv(aConv);</span>
<a href="#l89.197"></a><span id="l89.197" class="difflineminus">-      if (!conv.left)</span>
<a href="#l89.198"></a><span id="l89.198" class="difflineplus">+      if (!conv.left) {</span>
<a href="#l89.199"></a><span id="l89.199">         conv.part(aMsg);</span>
<a href="#l89.200"></a><span id="l89.200" class="difflineplus">+      }</span>
<a href="#l89.201"></a><span id="l89.201">       return true;</span>
<a href="#l89.202"></a><span id="l89.202">     },</span>
<a href="#l89.203"></a><span id="l89.203">   },</span>
<a href="#l89.204"></a><span id="l89.204">   {</span>
<a href="#l89.205"></a><span id="l89.205">     name: &quot;topic&quot;,</span>
<a href="#l89.206"></a><span id="l89.206" class="difflineminus">-    get helpString() { return _(&quot;command.topic&quot;, &quot;topic&quot;); },</span>
<a href="#l89.207"></a><span id="l89.207" class="difflineplus">+    get helpString() {</span>
<a href="#l89.208"></a><span id="l89.208" class="difflineplus">+      return _(&quot;command.topic&quot;, &quot;topic&quot;);</span>
<a href="#l89.209"></a><span id="l89.209" class="difflineplus">+    },</span>
<a href="#l89.210"></a><span id="l89.210">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.211"></a><span id="l89.211">     run(aMsg, aConv) {</span>
<a href="#l89.212"></a><span id="l89.212">       let conv = getMUC(aConv);</span>
<a href="#l89.213"></a><span id="l89.213" class="difflineminus">-      if (!conv)</span>
<a href="#l89.214"></a><span id="l89.214" class="difflineplus">+      if (!conv) {</span>
<a href="#l89.215"></a><span id="l89.215">         return true;</span>
<a href="#l89.216"></a><span id="l89.216" class="difflineplus">+      }</span>
<a href="#l89.217"></a><span id="l89.217">       conv.topic = aMsg;</span>
<a href="#l89.218"></a><span id="l89.218">       return true;</span>
<a href="#l89.219"></a><span id="l89.219">     },</span>
<a href="#l89.220"></a><span id="l89.220">   },</span>
<a href="#l89.221"></a><span id="l89.221">   {</span>
<a href="#l89.222"></a><span id="l89.222">     name: &quot;ban&quot;,</span>
<a href="#l89.223"></a><span id="l89.223" class="difflineminus">-    get helpString() { return _(&quot;command.ban&quot;, &quot;ban&quot;); },</span>
<a href="#l89.224"></a><span id="l89.224" class="difflineplus">+    get helpString() {</span>
<a href="#l89.225"></a><span id="l89.225" class="difflineplus">+      return _(&quot;command.ban&quot;, &quot;ban&quot;);</span>
<a href="#l89.226"></a><span id="l89.226" class="difflineplus">+    },</span>
<a href="#l89.227"></a><span id="l89.227">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.228"></a><span id="l89.228">     run(aMsg, aConv) {</span>
<a href="#l89.229"></a><span id="l89.229">       let params = splitInput(aMsg);</span>
<a href="#l89.230"></a><span id="l89.230" class="difflineminus">-      if (!params.length)</span>
<a href="#l89.231"></a><span id="l89.231" class="difflineplus">+      if (!params.length) {</span>
<a href="#l89.232"></a><span id="l89.232">         return false;</span>
<a href="#l89.233"></a><span id="l89.233" class="difflineplus">+      }</span>
<a href="#l89.234"></a><span id="l89.234"> </span>
<a href="#l89.235"></a><span id="l89.235">       let conv = getMUC(aConv);</span>
<a href="#l89.236"></a><span id="l89.236" class="difflineminus">-      if (conv)</span>
<a href="#l89.237"></a><span id="l89.237" class="difflineplus">+      if (conv) {</span>
<a href="#l89.238"></a><span id="l89.238">         conv.ban(...params);</span>
<a href="#l89.239"></a><span id="l89.239" class="difflineplus">+      }</span>
<a href="#l89.240"></a><span id="l89.240">       return true;</span>
<a href="#l89.241"></a><span id="l89.241">     },</span>
<a href="#l89.242"></a><span id="l89.242">   },</span>
<a href="#l89.243"></a><span id="l89.243">   {</span>
<a href="#l89.244"></a><span id="l89.244">     name: &quot;kick&quot;,</span>
<a href="#l89.245"></a><span id="l89.245" class="difflineminus">-    get helpString() { return _(&quot;command.kick&quot;, &quot;kick&quot;); },</span>
<a href="#l89.246"></a><span id="l89.246" class="difflineplus">+    get helpString() {</span>
<a href="#l89.247"></a><span id="l89.247" class="difflineplus">+      return _(&quot;command.kick&quot;, &quot;kick&quot;);</span>
<a href="#l89.248"></a><span id="l89.248" class="difflineplus">+    },</span>
<a href="#l89.249"></a><span id="l89.249">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.250"></a><span id="l89.250">     run(aMsg, aConv) {</span>
<a href="#l89.251"></a><span id="l89.251">       let conv = getMUC(aConv);</span>
<a href="#l89.252"></a><span id="l89.252" class="difflineminus">-      if (!conv)</span>
<a href="#l89.253"></a><span id="l89.253" class="difflineplus">+      if (!conv) {</span>
<a href="#l89.254"></a><span id="l89.254">         return true;</span>
<a href="#l89.255"></a><span id="l89.255" class="difflineplus">+      }</span>
<a href="#l89.256"></a><span id="l89.256"> </span>
<a href="#l89.257"></a><span id="l89.257">       let params = splitByNick(aMsg, conv);</span>
<a href="#l89.258"></a><span id="l89.258" class="difflineminus">-      if (!params.length)</span>
<a href="#l89.259"></a><span id="l89.259" class="difflineplus">+      if (!params.length) {</span>
<a href="#l89.260"></a><span id="l89.260">         return false;</span>
<a href="#l89.261"></a><span id="l89.261" class="difflineplus">+      }</span>
<a href="#l89.262"></a><span id="l89.262">       conv.kick(...params);</span>
<a href="#l89.263"></a><span id="l89.263">       return true;</span>
<a href="#l89.264"></a><span id="l89.264">     },</span>
<a href="#l89.265"></a><span id="l89.265">   },</span>
<a href="#l89.266"></a><span id="l89.266">   {</span>
<a href="#l89.267"></a><span id="l89.267">     name: &quot;invite&quot;,</span>
<a href="#l89.268"></a><span id="l89.268" class="difflineminus">-    get helpString() { return _(&quot;command.invite&quot;, &quot;invite&quot;); },</span>
<a href="#l89.269"></a><span id="l89.269" class="difflineplus">+    get helpString() {</span>
<a href="#l89.270"></a><span id="l89.270" class="difflineplus">+      return _(&quot;command.invite&quot;, &quot;invite&quot;);</span>
<a href="#l89.271"></a><span id="l89.271" class="difflineplus">+    },</span>
<a href="#l89.272"></a><span id="l89.272">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.273"></a><span id="l89.273">     run(aMsg, aConv) {</span>
<a href="#l89.274"></a><span id="l89.274">       let conv = getMUC(aConv);</span>
<a href="#l89.275"></a><span id="l89.275" class="difflineminus">-      if (!conv)</span>
<a href="#l89.276"></a><span id="l89.276" class="difflineplus">+      if (!conv) {</span>
<a href="#l89.277"></a><span id="l89.277">         return true;</span>
<a href="#l89.278"></a><span id="l89.278" class="difflineplus">+      }</span>
<a href="#l89.279"></a><span id="l89.279"> </span>
<a href="#l89.280"></a><span id="l89.280">       return invite(aMsg, conv);</span>
<a href="#l89.281"></a><span id="l89.281">     },</span>
<a href="#l89.282"></a><span id="l89.282">   },</span>
<a href="#l89.283"></a><span id="l89.283">   {</span>
<a href="#l89.284"></a><span id="l89.284">     name: &quot;inviteto&quot;,</span>
<a href="#l89.285"></a><span id="l89.285" class="difflineminus">-    get helpString() { return _(&quot;command.inviteto&quot;, &quot;inviteto&quot;); },</span>
<a href="#l89.286"></a><span id="l89.286" class="difflineplus">+    get helpString() {</span>
<a href="#l89.287"></a><span id="l89.287" class="difflineplus">+      return _(&quot;command.inviteto&quot;, &quot;inviteto&quot;);</span>
<a href="#l89.288"></a><span id="l89.288" class="difflineplus">+    },</span>
<a href="#l89.289"></a><span id="l89.289">     usageContext: Ci.imICommand.CMD_CONTEXT_IM,</span>
<a href="#l89.290"></a><span id="l89.290">     run: (aMsg, aConv) =&gt; invite(aMsg, getConv(aConv)),</span>
<a href="#l89.291"></a><span id="l89.291">   },</span>
<a href="#l89.292"></a><span id="l89.292">   {</span>
<a href="#l89.293"></a><span id="l89.293">     name: &quot;me&quot;,</span>
<a href="#l89.294"></a><span id="l89.294" class="difflineminus">-    get helpString() { return _(&quot;command.me&quot;, &quot;me&quot;); },</span>
<a href="#l89.295"></a><span id="l89.295" class="difflineplus">+    get helpString() {</span>
<a href="#l89.296"></a><span id="l89.296" class="difflineplus">+      return _(&quot;command.me&quot;, &quot;me&quot;);</span>
<a href="#l89.297"></a><span id="l89.297" class="difflineplus">+    },</span>
<a href="#l89.298"></a><span id="l89.298">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.299"></a><span id="l89.299">     run(aMsg, aConv) {</span>
<a href="#l89.300"></a><span id="l89.300">       let params = aMsg.trim();</span>
<a href="#l89.301"></a><span id="l89.301" class="difflineminus">-      if (!params)</span>
<a href="#l89.302"></a><span id="l89.302" class="difflineplus">+      if (!params) {</span>
<a href="#l89.303"></a><span id="l89.303">         return false;</span>
<a href="#l89.304"></a><span id="l89.304" class="difflineplus">+      }</span>
<a href="#l89.305"></a><span id="l89.305"> </span>
<a href="#l89.306"></a><span id="l89.306">       // XEP-0245: The /me Command.</span>
<a href="#l89.307"></a><span id="l89.307">       // We need to append &quot;/me &quot; in the first four characters of the message</span>
<a href="#l89.308"></a><span id="l89.308">       // body.</span>
<a href="#l89.309"></a><span id="l89.309">       let conv = getConv(aConv);</span>
<a href="#l89.310"></a><span id="l89.310">       conv.sendMsg(&quot;/me &quot; + params);</span>
<a href="#l89.311"></a><span id="l89.311"> </span>
<a href="#l89.312"></a><span id="l89.312">       return true;</span>
<a href="#l89.313"></a><span id="l89.313">     },</span>
<a href="#l89.314"></a><span id="l89.314">   },</span>
<a href="#l89.315"></a><span id="l89.315">   {</span>
<a href="#l89.316"></a><span id="l89.316">     name: &quot;nick&quot;,</span>
<a href="#l89.317"></a><span id="l89.317" class="difflineminus">-    get helpString() { return _(&quot;command.nick&quot;, &quot;nick&quot;); },</span>
<a href="#l89.318"></a><span id="l89.318" class="difflineplus">+    get helpString() {</span>
<a href="#l89.319"></a><span id="l89.319" class="difflineplus">+      return _(&quot;command.nick&quot;, &quot;nick&quot;);</span>
<a href="#l89.320"></a><span id="l89.320" class="difflineplus">+    },</span>
<a href="#l89.321"></a><span id="l89.321">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.322"></a><span id="l89.322">     run(aMsg, aConv) {</span>
<a href="#l89.323"></a><span id="l89.323">       let params = aMsg.trim().split(/\s+/);</span>
<a href="#l89.324"></a><span id="l89.324" class="difflineminus">-      if (!params[0])</span>
<a href="#l89.325"></a><span id="l89.325" class="difflineplus">+      if (!params[0]) {</span>
<a href="#l89.326"></a><span id="l89.326">         return false;</span>
<a href="#l89.327"></a><span id="l89.327" class="difflineplus">+      }</span>
<a href="#l89.328"></a><span id="l89.328"> </span>
<a href="#l89.329"></a><span id="l89.329">       let conv = getMUC(aConv);</span>
<a href="#l89.330"></a><span id="l89.330" class="difflineminus">-      if (conv)</span>
<a href="#l89.331"></a><span id="l89.331" class="difflineplus">+      if (conv) {</span>
<a href="#l89.332"></a><span id="l89.332">         conv.setNick(params[0]);</span>
<a href="#l89.333"></a><span id="l89.333" class="difflineplus">+      }</span>
<a href="#l89.334"></a><span id="l89.334">       return true;</span>
<a href="#l89.335"></a><span id="l89.335">     },</span>
<a href="#l89.336"></a><span id="l89.336">   },</span>
<a href="#l89.337"></a><span id="l89.337">   {</span>
<a href="#l89.338"></a><span id="l89.338">     name: &quot;msg&quot;,</span>
<a href="#l89.339"></a><span id="l89.339" class="difflineminus">-    get helpString() { return _(&quot;command.msg&quot;, &quot;msg&quot;); },</span>
<a href="#l89.340"></a><span id="l89.340" class="difflineplus">+    get helpString() {</span>
<a href="#l89.341"></a><span id="l89.341" class="difflineplus">+      return _(&quot;command.msg&quot;, &quot;msg&quot;);</span>
<a href="#l89.342"></a><span id="l89.342" class="difflineplus">+    },</span>
<a href="#l89.343"></a><span id="l89.343">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l89.344"></a><span id="l89.344">     run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l89.345"></a><span id="l89.345">       let conv = getMUC(aConv);</span>
<a href="#l89.346"></a><span id="l89.346" class="difflineminus">-      if (!conv)</span>
<a href="#l89.347"></a><span id="l89.347" class="difflineplus">+      if (!conv) {</span>
<a href="#l89.348"></a><span id="l89.348">         return true;</span>
<a href="#l89.349"></a><span id="l89.349" class="difflineplus">+      }</span>
<a href="#l89.350"></a><span id="l89.350"> </span>
<a href="#l89.351"></a><span id="l89.351">       let params = splitByNick(aMsg, conv);</span>
<a href="#l89.352"></a><span id="l89.352" class="difflineminus">-      if (params.length != 2)</span>
<a href="#l89.353"></a><span id="l89.353" class="difflineplus">+      if (params.length != 2) {</span>
<a href="#l89.354"></a><span id="l89.354">         return false;</span>
<a href="#l89.355"></a><span id="l89.355" class="difflineplus">+      }</span>
<a href="#l89.356"></a><span id="l89.356">       let [nickName, msg] = params;</span>
<a href="#l89.357"></a><span id="l89.357"> </span>
<a href="#l89.358"></a><span id="l89.358">       let account = getAccount(aConv);</span>
<a href="#l89.359"></a><span id="l89.359">       let privateConv = account.createConversation(conv.name + &quot;/&quot; + nickName);</span>
<a href="#l89.360"></a><span id="l89.360" class="difflineminus">-      if (!privateConv)</span>
<a href="#l89.361"></a><span id="l89.361" class="difflineplus">+      if (!privateConv) {</span>
<a href="#l89.362"></a><span id="l89.362">         return true;</span>
<a href="#l89.363"></a><span id="l89.363" class="difflineplus">+      }</span>
<a href="#l89.364"></a><span id="l89.364">       privateConv.sendMsg(msg.trim());</span>
<a href="#l89.365"></a><span id="l89.365"> </span>
<a href="#l89.366"></a><span id="l89.366" class="difflineminus">-      if (aReturnedConv)</span>
<a href="#l89.367"></a><span id="l89.367" class="difflineplus">+      if (aReturnedConv) {</span>
<a href="#l89.368"></a><span id="l89.368">         aReturnedConv.value = privateConv;</span>
<a href="#l89.369"></a><span id="l89.369" class="difflineplus">+      }</span>
<a href="#l89.370"></a><span id="l89.370">       return true;</span>
<a href="#l89.371"></a><span id="l89.371">     },</span>
<a href="#l89.372"></a><span id="l89.372">   },</span>
<a href="#l89.373"></a><span id="l89.373">   {</span>
<a href="#l89.374"></a><span id="l89.374">     name: &quot;version&quot;,</span>
<a href="#l89.375"></a><span id="l89.375" class="difflineminus">-    get helpString() { return _(&quot;command.version&quot;, &quot;version&quot;); },</span>
<a href="#l89.376"></a><span id="l89.376" class="difflineplus">+    get helpString() {</span>
<a href="#l89.377"></a><span id="l89.377" class="difflineplus">+      return _(&quot;command.version&quot;, &quot;version&quot;);</span>
<a href="#l89.378"></a><span id="l89.378" class="difflineplus">+    },</span>
<a href="#l89.379"></a><span id="l89.379">     usageContext: Ci.imICommand.CMD_CONTEXT_IM,</span>
<a href="#l89.380"></a><span id="l89.380">     run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l89.381"></a><span id="l89.381">       let conv = getConv(aConv);</span>
<a href="#l89.382"></a><span id="l89.382" class="difflineminus">-      if (conv.left)</span>
<a href="#l89.383"></a><span id="l89.383" class="difflineplus">+      if (conv.left) {</span>
<a href="#l89.384"></a><span id="l89.384">         return true;</span>
<a href="#l89.385"></a><span id="l89.385" class="difflineplus">+      }</span>
<a href="#l89.386"></a><span id="l89.386"> </span>
<a href="#l89.387"></a><span id="l89.387">       // We do not have user's resource.</span>
<a href="#l89.388"></a><span id="l89.388">       if (!conv._targetResource) {</span>
<a href="#l89.389"></a><span id="l89.389" class="difflineminus">-        conv.writeMessage(conv.name,</span>
<a href="#l89.390"></a><span id="l89.390" class="difflineminus">-                          _(&quot;conversation.error.resourceNotAvailable&quot;, conv.shortName),</span>
<a href="#l89.391"></a><span id="l89.391" class="difflineminus">-                          {system: true});</span>
<a href="#l89.392"></a><span id="l89.392" class="difflineplus">+        conv.writeMessage(</span>
<a href="#l89.393"></a><span id="l89.393" class="difflineplus">+          conv.name,</span>
<a href="#l89.394"></a><span id="l89.394" class="difflineplus">+          _(&quot;conversation.error.resourceNotAvailable&quot;, conv.shortName),</span>
<a href="#l89.395"></a><span id="l89.395" class="difflineplus">+          { system: true }</span>
<a href="#l89.396"></a><span id="l89.396" class="difflineplus">+        );</span>
<a href="#l89.397"></a><span id="l89.397">         return true;</span>
<a href="#l89.398"></a><span id="l89.398">       }</span>
<a href="#l89.399"></a><span id="l89.399"> </span>
<a href="#l89.400"></a><span id="l89.400">       conv.getVersion();</span>
<a href="#l89.401"></a><span id="l89.401">       return true;</span>
<a href="#l89.402"></a><span id="l89.402">     },</span>
<a href="#l89.403"></a><span id="l89.403">   },</span>
<a href="#l89.404"></a><span id="l89.404"> ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -1,26 +1,26 @@</span>
<a href="#l90.4"></a><span id="l90.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l90.5"></a><span id="l90.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l90.6"></a><span id="l90.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l90.7"></a><span id="l90.7"> </span>
<a href="#l90.8"></a><span id="l90.8"> this.EXPORTED_SYMBOLS = [&quot;XMPPSession&quot;, &quot;XMPPDefaultResource&quot;];</span>
<a href="#l90.9"></a><span id="l90.9"> </span>
<a href="#l90.10"></a><span id="l90.10" class="difflineminus">-const {DNS} = ChromeUtils.import(&quot;resource:///modules/DNS.jsm&quot;);</span>
<a href="#l90.11"></a><span id="l90.11" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-var {</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l90.14"></a><span id="l90.14" class="difflineminus">-  l10nHelper,</span>
<a href="#l90.15"></a><span id="l90.15" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l90.16"></a><span id="l90.16" class="difflineminus">-var {Socket} = ChromeUtils.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineminus">-var {</span>
<a href="#l90.18"></a><span id="l90.18" class="difflineminus">-  Stanza,</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineminus">-  XMPPParser,</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l90.21"></a><span id="l90.21" class="difflineminus">-var {XMPPAuthMechanisms} = ChromeUtils.import(&quot;resource:///modules/xmpp-authmechs.jsm&quot;);</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineplus">+const { DNS } = ChromeUtils.import(&quot;resource:///modules/DNS.jsm&quot;);</span>
<a href="#l90.23"></a><span id="l90.23" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l90.24"></a><span id="l90.24" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l90.25"></a><span id="l90.25" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l90.26"></a><span id="l90.26" class="difflineplus">+);</span>
<a href="#l90.27"></a><span id="l90.27" class="difflineplus">+var { Socket } = ChromeUtils.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l90.28"></a><span id="l90.28" class="difflineplus">+var { Stanza, XMPPParser } = ChromeUtils.import(</span>
<a href="#l90.29"></a><span id="l90.29" class="difflineplus">+  &quot;resource:///modules/xmpp-xml.jsm&quot;</span>
<a href="#l90.30"></a><span id="l90.30" class="difflineplus">+);</span>
<a href="#l90.31"></a><span id="l90.31" class="difflineplus">+var { XMPPAuthMechanisms } = ChromeUtils.import(</span>
<a href="#l90.32"></a><span id="l90.32" class="difflineplus">+  &quot;resource:///modules/xmpp-authmechs.jsm&quot;</span>
<a href="#l90.33"></a><span id="l90.33" class="difflineplus">+);</span>
<a href="#l90.34"></a><span id="l90.34"> </span>
<a href="#l90.35"></a><span id="l90.35"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l90.36"></a><span id="l90.36">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l90.37"></a><span id="l90.37"> );</span>
<a href="#l90.38"></a><span id="l90.38"> </span>
<a href="#l90.39"></a><span id="l90.39"> // Workaround because a lazy getter can't be exported.</span>
<a href="#l90.40"></a><span id="l90.40"> XPCOMUtils.defineLazyGetter(this, &quot;_defaultResource&quot;, () =&gt;</span>
<a href="#l90.41"></a><span id="l90.41">   l10nHelper(&quot;chrome://branding/locale/brand.properties&quot;)(&quot;brandShortName&quot;)</span>
<a href="#l90.42"></a><span id="l90.42" class="difflineat">@@ -33,166 +33,197 @@ Object.defineProperty(this, &quot;XMPPDefault</span>
<a href="#l90.43"></a><span id="l90.43">   },</span>
<a href="#l90.44"></a><span id="l90.44"> });</span>
<a href="#l90.45"></a><span id="l90.45"> </span>
<a href="#l90.46"></a><span id="l90.46"> function XMPPSession(aHost, aPort, aSecurity, aJID, aPassword, aAccount) {</span>
<a href="#l90.47"></a><span id="l90.47">   this._host = aHost;</span>
<a href="#l90.48"></a><span id="l90.48">   this._port = aPort;</span>
<a href="#l90.49"></a><span id="l90.49"> </span>
<a href="#l90.50"></a><span id="l90.50">   this._connectionSecurity = aSecurity;</span>
<a href="#l90.51"></a><span id="l90.51" class="difflineminus">-  if (this._connectionSecurity == &quot;old_ssl&quot;)</span>
<a href="#l90.52"></a><span id="l90.52" class="difflineplus">+  if (this._connectionSecurity == &quot;old_ssl&quot;) {</span>
<a href="#l90.53"></a><span id="l90.53">     this._security = [&quot;ssl&quot;];</span>
<a href="#l90.54"></a><span id="l90.54" class="difflineminus">-  else if (this._connectionSecurity != &quot;none&quot;)</span>
<a href="#l90.55"></a><span id="l90.55" class="difflineminus">-    this._security = [(aPort == 5223 || aPort == 443) ? &quot;ssl&quot; : &quot;starttls&quot;];</span>
<a href="#l90.56"></a><span id="l90.56" class="difflineplus">+  } else if (this._connectionSecurity != &quot;none&quot;) {</span>
<a href="#l90.57"></a><span id="l90.57" class="difflineplus">+    this._security = [aPort == 5223 || aPort == 443 ? &quot;ssl&quot; : &quot;starttls&quot;];</span>
<a href="#l90.58"></a><span id="l90.58" class="difflineplus">+  }</span>
<a href="#l90.59"></a><span id="l90.59"> </span>
<a href="#l90.60"></a><span id="l90.60">   if (!aJID.node) {</span>
<a href="#l90.61"></a><span id="l90.61" class="difflineminus">-    aAccount.reportDisconnecting(Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l90.62"></a><span id="l90.62" class="difflineminus">-                                 _(&quot;connection.error.invalidUsername&quot;));</span>
<a href="#l90.63"></a><span id="l90.63" class="difflineplus">+    aAccount.reportDisconnecting(</span>
<a href="#l90.64"></a><span id="l90.64" class="difflineplus">+      Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l90.65"></a><span id="l90.65" class="difflineplus">+      _(&quot;connection.error.invalidUsername&quot;)</span>
<a href="#l90.66"></a><span id="l90.66" class="difflineplus">+    );</span>
<a href="#l90.67"></a><span id="l90.67">     aAccount.reportDisconnected();</span>
<a href="#l90.68"></a><span id="l90.68">     return;</span>
<a href="#l90.69"></a><span id="l90.69">   }</span>
<a href="#l90.70"></a><span id="l90.70">   this._jid = aJID;</span>
<a href="#l90.71"></a><span id="l90.71">   this._domain = aJID.domain;</span>
<a href="#l90.72"></a><span id="l90.72">   this._password = aPassword;</span>
<a href="#l90.73"></a><span id="l90.73">   this._account = aAccount;</span>
<a href="#l90.74"></a><span id="l90.74">   this._resource = aJID.resource;</span>
<a href="#l90.75"></a><span id="l90.75">   this._handlers = new Map();</span>
<a href="#l90.76"></a><span id="l90.76">   this._account.reportConnecting();</span>
<a href="#l90.77"></a><span id="l90.77"> </span>
<a href="#l90.78"></a><span id="l90.78">   // The User has specified a certain server or port, so we should not do</span>
<a href="#l90.79"></a><span id="l90.79">   // DNS SRV lookup or the preference of disabling DNS SRV part and use</span>
<a href="#l90.80"></a><span id="l90.80">   // normal connect is set.</span>
<a href="#l90.81"></a><span id="l90.81">   // RFC 6120 (Section 3.2.3): When Not to Use SRV.</span>
<a href="#l90.82"></a><span id="l90.82" class="difflineminus">-  if (Services.prefs.getBoolPref(&quot;chat.dns.srv.disable&quot;) ||</span>
<a href="#l90.83"></a><span id="l90.83" class="difflineminus">-      (this._account.prefs.prefHasUserValue(&quot;server&quot;) ||</span>
<a href="#l90.84"></a><span id="l90.84" class="difflineminus">-       this._account.prefs.prefHasUserValue(&quot;port&quot;))) {</span>
<a href="#l90.85"></a><span id="l90.85" class="difflineplus">+  if (</span>
<a href="#l90.86"></a><span id="l90.86" class="difflineplus">+    Services.prefs.getBoolPref(&quot;chat.dns.srv.disable&quot;) ||</span>
<a href="#l90.87"></a><span id="l90.87" class="difflineplus">+    (this._account.prefs.prefHasUserValue(&quot;server&quot;) ||</span>
<a href="#l90.88"></a><span id="l90.88" class="difflineplus">+      this._account.prefs.prefHasUserValue(&quot;port&quot;))</span>
<a href="#l90.89"></a><span id="l90.89" class="difflineplus">+  ) {</span>
<a href="#l90.90"></a><span id="l90.90">     this.connect(this._host, this._port, this._security);</span>
<a href="#l90.91"></a><span id="l90.91">     return;</span>
<a href="#l90.92"></a><span id="l90.92">   }</span>
<a href="#l90.93"></a><span id="l90.93"> </span>
<a href="#l90.94"></a><span id="l90.94">   // RFC 6120 (Section 3.2.1): SRV lookup.</span>
<a href="#l90.95"></a><span id="l90.95">   this._account.reportConnecting(_(&quot;connection.srvLookup&quot;));</span>
<a href="#l90.96"></a><span id="l90.96" class="difflineminus">-  DNS.srv(&quot;_xmpp-client._tcp.&quot; + this._host).then(</span>
<a href="#l90.97"></a><span id="l90.97" class="difflineminus">-    aResult =&gt; this._handleSrvQuery(aResult)</span>
<a href="#l90.98"></a><span id="l90.98" class="difflineminus">-  ).catch(aError =&gt; {</span>
<a href="#l90.99"></a><span id="l90.99" class="difflineminus">-    if (aError === this.SRV_ERROR_XMPP_NOT_SUPPORTED) {</span>
<a href="#l90.100"></a><span id="l90.100" class="difflineminus">-      this.LOG(&quot;SRV: XMPP is not supported on this domain.&quot;);</span>
<a href="#l90.101"></a><span id="l90.101" class="difflineplus">+  DNS.srv(&quot;_xmpp-client._tcp.&quot; + this._host)</span>
<a href="#l90.102"></a><span id="l90.102" class="difflineplus">+    .then(aResult =&gt; this._handleSrvQuery(aResult))</span>
<a href="#l90.103"></a><span id="l90.103" class="difflineplus">+    .catch(aError =&gt; {</span>
<a href="#l90.104"></a><span id="l90.104" class="difflineplus">+      if (aError === this.SRV_ERROR_XMPP_NOT_SUPPORTED) {</span>
<a href="#l90.105"></a><span id="l90.105" class="difflineplus">+        this.LOG(&quot;SRV: XMPP is not supported on this domain.&quot;);</span>
<a href="#l90.106"></a><span id="l90.106"> </span>
<a href="#l90.107"></a><span id="l90.107" class="difflineminus">-      // RFC 6120 (Section 3.2.1) and RFC 2782 (Usage rules): Abort as the</span>
<a href="#l90.108"></a><span id="l90.108" class="difflineminus">-      // service is decidedly not available at this domain.</span>
<a href="#l90.109"></a><span id="l90.109" class="difflineminus">-      this._account.reportDisconnecting(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l90.110"></a><span id="l90.110" class="difflineminus">-                                        _(&quot;connection.error.XMPPNotSupported&quot;));</span>
<a href="#l90.111"></a><span id="l90.111" class="difflineminus">-      this._account.reportDisconnected();</span>
<a href="#l90.112"></a><span id="l90.112" class="difflineminus">-      return;</span>
<a href="#l90.113"></a><span id="l90.113" class="difflineminus">-    }</span>
<a href="#l90.114"></a><span id="l90.114" class="difflineminus">-    else if (aError === this.SRV_ERROR_LOOKUP_FAILED) {</span>
<a href="#l90.115"></a><span id="l90.115" class="difflineminus">-      // An error happened during SRV lookup (e.g. user is offline,</span>
<a href="#l90.116"></a><span id="l90.116" class="difflineminus">-      // network error, DNS name does not exist, etc.).</span>
<a href="#l90.117"></a><span id="l90.117" class="difflineminus">-      this.WARN(&quot;Error during SRV: Lookup failed.&quot;);</span>
<a href="#l90.118"></a><span id="l90.118" class="difflineminus">-    }</span>
<a href="#l90.119"></a><span id="l90.119" class="difflineminus">-    else</span>
<a href="#l90.120"></a><span id="l90.120" class="difflineminus">-      this.ERROR(&quot;Error during SRV lookup:&quot;, aError);</span>
<a href="#l90.121"></a><span id="l90.121" class="difflineplus">+        // RFC 6120 (Section 3.2.1) and RFC 2782 (Usage rules): Abort as the</span>
<a href="#l90.122"></a><span id="l90.122" class="difflineplus">+        // service is decidedly not available at this domain.</span>
<a href="#l90.123"></a><span id="l90.123" class="difflineplus">+        this._account.reportDisconnecting(</span>
<a href="#l90.124"></a><span id="l90.124" class="difflineplus">+          Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l90.125"></a><span id="l90.125" class="difflineplus">+          _(&quot;connection.error.XMPPNotSupported&quot;)</span>
<a href="#l90.126"></a><span id="l90.126" class="difflineplus">+        );</span>
<a href="#l90.127"></a><span id="l90.127" class="difflineplus">+        this._account.reportDisconnected();</span>
<a href="#l90.128"></a><span id="l90.128" class="difflineplus">+        return;</span>
<a href="#l90.129"></a><span id="l90.129" class="difflineplus">+      } else if (aError === this.SRV_ERROR_LOOKUP_FAILED) {</span>
<a href="#l90.130"></a><span id="l90.130" class="difflineplus">+        // An error happened during SRV lookup (e.g. user is offline,</span>
<a href="#l90.131"></a><span id="l90.131" class="difflineplus">+        // network error, DNS name does not exist, etc.).</span>
<a href="#l90.132"></a><span id="l90.132" class="difflineplus">+        this.WARN(&quot;Error during SRV: Lookup failed.&quot;);</span>
<a href="#l90.133"></a><span id="l90.133" class="difflineplus">+      } else {</span>
<a href="#l90.134"></a><span id="l90.134" class="difflineplus">+        this.ERROR(&quot;Error during SRV lookup:&quot;, aError);</span>
<a href="#l90.135"></a><span id="l90.135" class="difflineplus">+      }</span>
<a href="#l90.136"></a><span id="l90.136"> </span>
<a href="#l90.137"></a><span id="l90.137" class="difflineminus">-    // Since we don't receive a response to SRV query, we SHOULD attempt the</span>
<a href="#l90.138"></a><span id="l90.138" class="difflineminus">-    // fallback process (use normal connect without SRV lookup).</span>
<a href="#l90.139"></a><span id="l90.139" class="difflineminus">-    this.connect(this._host, this._port, this._security);</span>
<a href="#l90.140"></a><span id="l90.140" class="difflineminus">-  });</span>
<a href="#l90.141"></a><span id="l90.141" class="difflineplus">+      // Since we don't receive a response to SRV query, we SHOULD attempt the</span>
<a href="#l90.142"></a><span id="l90.142" class="difflineplus">+      // fallback process (use normal connect without SRV lookup).</span>
<a href="#l90.143"></a><span id="l90.143" class="difflineplus">+      this.connect(this._host, this._port, this._security);</span>
<a href="#l90.144"></a><span id="l90.144" class="difflineplus">+    });</span>
<a href="#l90.145"></a><span id="l90.145"> }</span>
<a href="#l90.146"></a><span id="l90.146"> </span>
<a href="#l90.147"></a><span id="l90.147"> XMPPSession.prototype = {</span>
<a href="#l90.148"></a><span id="l90.148">   /* for the socket.jsm helper */</span>
<a href="#l90.149"></a><span id="l90.149">   __proto__: Socket,</span>
<a href="#l90.150"></a><span id="l90.150">   connectTimeout: 60,</span>
<a href="#l90.151"></a><span id="l90.151">   readWriteTimeout: 300,</span>
<a href="#l90.152"></a><span id="l90.152"> </span>
<a href="#l90.153"></a><span id="l90.153">   // Contains the remaining SRV records if we failed to connect the current one.</span>
<a href="#l90.154"></a><span id="l90.154">   _srvRecords: [],</span>
<a href="#l90.155"></a><span id="l90.155"> </span>
<a href="#l90.156"></a><span id="l90.156">   sendPing() {</span>
<a href="#l90.157"></a><span id="l90.157" class="difflineminus">-    this.sendStanza(Stanza.iq(&quot;get&quot;, null, null,</span>
<a href="#l90.158"></a><span id="l90.158" class="difflineminus">-                              Stanza.node(&quot;ping&quot;, Stanza.NS.ping)),</span>
<a href="#l90.159"></a><span id="l90.159" class="difflineminus">-                    this.cancelDisconnectTimer, this);</span>
<a href="#l90.160"></a><span id="l90.160" class="difflineplus">+    this.sendStanza(</span>
<a href="#l90.161"></a><span id="l90.161" class="difflineplus">+      Stanza.iq(&quot;get&quot;, null, null, Stanza.node(&quot;ping&quot;, Stanza.NS.ping)),</span>
<a href="#l90.162"></a><span id="l90.162" class="difflineplus">+      this.cancelDisconnectTimer,</span>
<a href="#l90.163"></a><span id="l90.163" class="difflineplus">+      this</span>
<a href="#l90.164"></a><span id="l90.164" class="difflineplus">+    );</span>
<a href="#l90.165"></a><span id="l90.165">   },</span>
<a href="#l90.166"></a><span id="l90.166">   _lastReceiveTime: 0,</span>
<a href="#l90.167"></a><span id="l90.167">   _lastSendTime: 0,</span>
<a href="#l90.168"></a><span id="l90.168">   checkPingTimer(aJustSentSomething = false) {</span>
<a href="#l90.169"></a><span id="l90.169">     // Don't start a ping timer if we're not fully connected yet.</span>
<a href="#l90.170"></a><span id="l90.170" class="difflineminus">-    if (this.onXmppStanza != this.stanzaListeners.accountListening)</span>
<a href="#l90.171"></a><span id="l90.171" class="difflineplus">+    if (this.onXmppStanza != this.stanzaListeners.accountListening) {</span>
<a href="#l90.172"></a><span id="l90.172">       return;</span>
<a href="#l90.173"></a><span id="l90.173" class="difflineplus">+    }</span>
<a href="#l90.174"></a><span id="l90.174">     let now = Date.now();</span>
<a href="#l90.175"></a><span id="l90.175" class="difflineminus">-    if (aJustSentSomething)</span>
<a href="#l90.176"></a><span id="l90.176" class="difflineplus">+    if (aJustSentSomething) {</span>
<a href="#l90.177"></a><span id="l90.177">       this._lastSendTime = now;</span>
<a href="#l90.178"></a><span id="l90.178" class="difflineminus">-    else</span>
<a href="#l90.179"></a><span id="l90.179" class="difflineplus">+    } else {</span>
<a href="#l90.180"></a><span id="l90.180">       this._lastReceiveTime = now;</span>
<a href="#l90.181"></a><span id="l90.181" class="difflineplus">+    }</span>
<a href="#l90.182"></a><span id="l90.182">     // We only cancel the ping timer if we've both received and sent</span>
<a href="#l90.183"></a><span id="l90.183">     // something in the last two minutes. This is because Openfire</span>
<a href="#l90.184"></a><span id="l90.184">     // servers will disconnect us if we don't send anything for a</span>
<a href="#l90.185"></a><span id="l90.185">     // couple of minutes.</span>
<a href="#l90.186"></a><span id="l90.186" class="difflineminus">-    if (Math.min(this._lastSendTime, this._lastReceiveTime) &gt;</span>
<a href="#l90.187"></a><span id="l90.187" class="difflineminus">-        now - this.kTimeBeforePing)</span>
<a href="#l90.188"></a><span id="l90.188" class="difflineplus">+    if (</span>
<a href="#l90.189"></a><span id="l90.189" class="difflineplus">+      Math.min(this._lastSendTime, this._lastReceiveTime) &gt;</span>
<a href="#l90.190"></a><span id="l90.190" class="difflineplus">+      now - this.kTimeBeforePing</span>
<a href="#l90.191"></a><span id="l90.191" class="difflineplus">+    ) {</span>
<a href="#l90.192"></a><span id="l90.192">       this.resetPingTimer();</span>
<a href="#l90.193"></a><span id="l90.193" class="difflineplus">+    }</span>
<a href="#l90.194"></a><span id="l90.194">   },</span>
<a href="#l90.195"></a><span id="l90.195"> </span>
<a href="#l90.196"></a><span id="l90.196" class="difflineminus">-  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l90.197"></a><span id="l90.197" class="difflineminus">-  get LOG() { return this._account.LOG; },</span>
<a href="#l90.198"></a><span id="l90.198" class="difflineminus">-  get WARN() { return this._account.WARN; },</span>
<a href="#l90.199"></a><span id="l90.199" class="difflineminus">-  get ERROR() { return this._account.ERROR; },</span>
<a href="#l90.200"></a><span id="l90.200" class="difflineplus">+  get DEBUG() {</span>
<a href="#l90.201"></a><span id="l90.201" class="difflineplus">+    return this._account.DEBUG;</span>
<a href="#l90.202"></a><span id="l90.202" class="difflineplus">+  },</span>
<a href="#l90.203"></a><span id="l90.203" class="difflineplus">+  get LOG() {</span>
<a href="#l90.204"></a><span id="l90.204" class="difflineplus">+    return this._account.LOG;</span>
<a href="#l90.205"></a><span id="l90.205" class="difflineplus">+  },</span>
<a href="#l90.206"></a><span id="l90.206" class="difflineplus">+  get WARN() {</span>
<a href="#l90.207"></a><span id="l90.207" class="difflineplus">+    return this._account.WARN;</span>
<a href="#l90.208"></a><span id="l90.208" class="difflineplus">+  },</span>
<a href="#l90.209"></a><span id="l90.209" class="difflineplus">+  get ERROR() {</span>
<a href="#l90.210"></a><span id="l90.210" class="difflineplus">+    return this._account.ERROR;</span>
<a href="#l90.211"></a><span id="l90.211" class="difflineplus">+  },</span>
<a href="#l90.212"></a><span id="l90.212"> </span>
<a href="#l90.213"></a><span id="l90.213">   _security: null,</span>
<a href="#l90.214"></a><span id="l90.214">   _encrypted: false,</span>
<a href="#l90.215"></a><span id="l90.215"> </span>
<a href="#l90.216"></a><span id="l90.216">   // DNS SRV errors in XMPP.</span>
<a href="#l90.217"></a><span id="l90.217">   SRV_ERROR_LOOKUP_FAILED: -1,</span>
<a href="#l90.218"></a><span id="l90.218">   SRV_ERROR_XMPP_NOT_SUPPORTED: -2,</span>
<a href="#l90.219"></a><span id="l90.219"> </span>
<a href="#l90.220"></a><span id="l90.220">   // Handles result of DNS SRV query and saves sorted results if it's OK in _srvRecords,</span>
<a href="#l90.221"></a><span id="l90.221">   // otherwise throws error.</span>
<a href="#l90.222"></a><span id="l90.222">   _handleSrvQuery(aResult) {</span>
<a href="#l90.223"></a><span id="l90.223" class="difflineminus">-    if (typeof aResult == &quot;number&quot; &amp;&amp; aResult == -1)</span>
<a href="#l90.224"></a><span id="l90.224" class="difflineplus">+    if (typeof aResult == &quot;number&quot; &amp;&amp; aResult == -1) {</span>
<a href="#l90.225"></a><span id="l90.225">       throw this.SRV_ERROR_LOOKUP_FAILED;</span>
<a href="#l90.226"></a><span id="l90.226" class="difflineplus">+    }</span>
<a href="#l90.227"></a><span id="l90.227"> </span>
<a href="#l90.228"></a><span id="l90.228">     this.LOG(&quot;SRV lookup: &quot; + JSON.stringify(aResult));</span>
<a href="#l90.229"></a><span id="l90.229">     if (aResult.length == 0) {</span>
<a href="#l90.230"></a><span id="l90.230">       // RFC 6120 (Section 3.2.1) and RFC 2782 (Usage rules): No SRV records,</span>
<a href="#l90.231"></a><span id="l90.231">       // try to login with the given domain name.</span>
<a href="#l90.232"></a><span id="l90.232">       this.connect(this._host, this._port, this._security);</span>
<a href="#l90.233"></a><span id="l90.233">       return;</span>
<a href="#l90.234"></a><span id="l90.234" class="difflineplus">+    } else if (aResult.length == 1 &amp;&amp; aResult[0].host == &quot;.&quot;) {</span>
<a href="#l90.235"></a><span id="l90.235" class="difflineplus">+      throw this.SRV_ERROR_XMPP_NOT_SUPPORTED;</span>
<a href="#l90.236"></a><span id="l90.236">     }</span>
<a href="#l90.237"></a><span id="l90.237" class="difflineminus">-    else if (aResult.length == 1 &amp;&amp; aResult[0].host == &quot;.&quot;)</span>
<a href="#l90.238"></a><span id="l90.238" class="difflineminus">-      throw this.SRV_ERROR_XMPP_NOT_SUPPORTED;</span>
<a href="#l90.239"></a><span id="l90.239"> </span>
<a href="#l90.240"></a><span id="l90.240">     // Sort results: Lower priority is more preferred and higher weight is</span>
<a href="#l90.241"></a><span id="l90.241">     // more preferred in equal priorities.</span>
<a href="#l90.242"></a><span id="l90.242">     aResult.sort(function(a, b) {</span>
<a href="#l90.243"></a><span id="l90.243">       return a.prio - b.prio || b.weight - a.weight;</span>
<a href="#l90.244"></a><span id="l90.244">     });</span>
<a href="#l90.245"></a><span id="l90.245"> </span>
<a href="#l90.246"></a><span id="l90.246">     this._srvRecords = aResult;</span>
<a href="#l90.247"></a><span id="l90.247">     this._connectNextRecord();</span>
<a href="#l90.248"></a><span id="l90.248">   },</span>
<a href="#l90.249"></a><span id="l90.249"> </span>
<a href="#l90.250"></a><span id="l90.250">   _connectNextRecord() {</span>
<a href="#l90.251"></a><span id="l90.251">     if (!this._srvRecords.length) {</span>
<a href="#l90.252"></a><span id="l90.252" class="difflineminus">-      this.ERROR(&quot;_connectNextRecord is called and there are no more records &quot; +</span>
<a href="#l90.253"></a><span id="l90.253" class="difflineminus">-                 &quot;to connect.&quot;);</span>
<a href="#l90.254"></a><span id="l90.254" class="difflineplus">+      this.ERROR(</span>
<a href="#l90.255"></a><span id="l90.255" class="difflineplus">+        &quot;_connectNextRecord is called and there are no more records &quot; +</span>
<a href="#l90.256"></a><span id="l90.256" class="difflineplus">+          &quot;to connect.&quot;</span>
<a href="#l90.257"></a><span id="l90.257" class="difflineplus">+      );</span>
<a href="#l90.258"></a><span id="l90.258">       return;</span>
<a href="#l90.259"></a><span id="l90.259">     }</span>
<a href="#l90.260"></a><span id="l90.260"> </span>
<a href="#l90.261"></a><span id="l90.261">     let record = this._srvRecords.shift();</span>
<a href="#l90.262"></a><span id="l90.262"> </span>
<a href="#l90.263"></a><span id="l90.263">     // RFC 3920 (Section 5.1): Certificates MUST be checked against the</span>
<a href="#l90.264"></a><span id="l90.264">     // hostname as provided by the initiating entity (e.g. user).</span>
<a href="#l90.265"></a><span id="l90.265" class="difflineminus">-    this.connect(this._domain, this._port, this._security, null, record.host,</span>
<a href="#l90.266"></a><span id="l90.266" class="difflineminus">-                 record.port);</span>
<a href="#l90.267"></a><span id="l90.267" class="difflineplus">+    this.connect(</span>
<a href="#l90.268"></a><span id="l90.268" class="difflineplus">+      this._domain,</span>
<a href="#l90.269"></a><span id="l90.269" class="difflineplus">+      this._port,</span>
<a href="#l90.270"></a><span id="l90.270" class="difflineplus">+      this._security,</span>
<a href="#l90.271"></a><span id="l90.271" class="difflineplus">+      null,</span>
<a href="#l90.272"></a><span id="l90.272" class="difflineplus">+      record.host,</span>
<a href="#l90.273"></a><span id="l90.273" class="difflineplus">+      record.port</span>
<a href="#l90.274"></a><span id="l90.274" class="difflineplus">+    );</span>
<a href="#l90.275"></a><span id="l90.275">   },</span>
<a href="#l90.276"></a><span id="l90.276"> </span>
<a href="#l90.277"></a><span id="l90.277">   /* Disconnect from the server */</span>
<a href="#l90.278"></a><span id="l90.278">   disconnect() {</span>
<a href="#l90.279"></a><span id="l90.279" class="difflineminus">-    if (this.onXmppStanza == this.stanzaListeners.accountListening)</span>
<a href="#l90.280"></a><span id="l90.280" class="difflineplus">+    if (this.onXmppStanza == this.stanzaListeners.accountListening) {</span>
<a href="#l90.281"></a><span id="l90.281">       this.send(&quot;&lt;/stream:stream&gt;&quot;);</span>
<a href="#l90.282"></a><span id="l90.282" class="difflineplus">+    }</span>
<a href="#l90.283"></a><span id="l90.283">     delete this.onXmppStanza;</span>
<a href="#l90.284"></a><span id="l90.284">     Socket.disconnect.call(this);</span>
<a href="#l90.285"></a><span id="l90.285">     if (this._parser) {</span>
<a href="#l90.286"></a><span id="l90.286">       this._parser.destroy();</span>
<a href="#l90.287"></a><span id="l90.287">       delete this._parser;</span>
<a href="#l90.288"></a><span id="l90.288">     }</span>
<a href="#l90.289"></a><span id="l90.289">     this.cancelDisconnectTimer();</span>
<a href="#l90.290"></a><span id="l90.290">   },</span>
<a href="#l90.291"></a><span id="l90.291" class="difflineat">@@ -216,102 +247,127 @@ XMPPSession.prototype = {</span>
<a href="#l90.292"></a><span id="l90.292"> </span>
<a href="#l90.293"></a><span id="l90.293">   /* Send a stanza to the server.</span>
<a href="#l90.294"></a><span id="l90.294">    * Can set a callback if required, which will be called when the server</span>
<a href="#l90.295"></a><span id="l90.295">    * responds to the stanza with a stanza of the same id. The callback should</span>
<a href="#l90.296"></a><span id="l90.296">    * return true if the stanza was handled, false if not. Note that an</span>
<a href="#l90.297"></a><span id="l90.297">    * undefined return value is treated as true.</span>
<a href="#l90.298"></a><span id="l90.298">    */</span>
<a href="#l90.299"></a><span id="l90.299">   sendStanza(aStanza, aCallback, aThis, aLogString) {</span>
<a href="#l90.300"></a><span id="l90.300" class="difflineminus">-    if (!aStanza.attributes.hasOwnProperty(&quot;id&quot;))</span>
<a href="#l90.301"></a><span id="l90.301" class="difflineplus">+    if (!aStanza.attributes.hasOwnProperty(&quot;id&quot;)) {</span>
<a href="#l90.302"></a><span id="l90.302">       aStanza.attributes.id = this._account.generateId();</span>
<a href="#l90.303"></a><span id="l90.303" class="difflineminus">-    if (aCallback)</span>
<a href="#l90.304"></a><span id="l90.304" class="difflineplus">+    }</span>
<a href="#l90.305"></a><span id="l90.305" class="difflineplus">+    if (aCallback) {</span>
<a href="#l90.306"></a><span id="l90.306">       this._handlers.set(aStanza.attributes.id, aCallback.bind(aThis));</span>
<a href="#l90.307"></a><span id="l90.307" class="difflineplus">+    }</span>
<a href="#l90.308"></a><span id="l90.308">     this.send(aStanza.getXML(), aLogString);</span>
<a href="#l90.309"></a><span id="l90.309">     this.checkPingTimer(true);</span>
<a href="#l90.310"></a><span id="l90.310">     return aStanza.attributes.id;</span>
<a href="#l90.311"></a><span id="l90.311">   },</span>
<a href="#l90.312"></a><span id="l90.312"> </span>
<a href="#l90.313"></a><span id="l90.313">   /* This method handles callbacks for specific ids. */</span>
<a href="#l90.314"></a><span id="l90.314">   execHandler(aId, aStanza) {</span>
<a href="#l90.315"></a><span id="l90.315">     let handler = this._handlers.get(aId);</span>
<a href="#l90.316"></a><span id="l90.316" class="difflineminus">-    if (!handler)</span>
<a href="#l90.317"></a><span id="l90.317" class="difflineplus">+    if (!handler) {</span>
<a href="#l90.318"></a><span id="l90.318">       return false;</span>
<a href="#l90.319"></a><span id="l90.319" class="difflineplus">+    }</span>
<a href="#l90.320"></a><span id="l90.320">     let isHandled = handler(aStanza);</span>
<a href="#l90.321"></a><span id="l90.321">     // Treat undefined return values as handled.</span>
<a href="#l90.322"></a><span id="l90.322" class="difflineminus">-    if (isHandled === undefined)</span>
<a href="#l90.323"></a><span id="l90.323" class="difflineplus">+    if (isHandled === undefined) {</span>
<a href="#l90.324"></a><span id="l90.324">       isHandled = true;</span>
<a href="#l90.325"></a><span id="l90.325" class="difflineplus">+    }</span>
<a href="#l90.326"></a><span id="l90.326">     this._handlers.delete(aId);</span>
<a href="#l90.327"></a><span id="l90.327">     return isHandled;</span>
<a href="#l90.328"></a><span id="l90.328">   },</span>
<a href="#l90.329"></a><span id="l90.329"> </span>
<a href="#l90.330"></a><span id="l90.330">   /* Start the XMPP stream */</span>
<a href="#l90.331"></a><span id="l90.331">   startStream() {</span>
<a href="#l90.332"></a><span id="l90.332" class="difflineminus">-    if (this._parser)</span>
<a href="#l90.333"></a><span id="l90.333" class="difflineplus">+    if (this._parser) {</span>
<a href="#l90.334"></a><span id="l90.334">       this._parser.destroy();</span>
<a href="#l90.335"></a><span id="l90.335" class="difflineplus">+    }</span>
<a href="#l90.336"></a><span id="l90.336">     this._parser = new XMPPParser(this);</span>
<a href="#l90.337"></a><span id="l90.337" class="difflineminus">-    this.send('&lt;?xml version=&quot;1.0&quot;?&gt;&lt;stream:stream to=&quot;' + this._domain +</span>
<a href="#l90.338"></a><span id="l90.338" class="difflineminus">-              '&quot; xmlns=&quot;jabber:client&quot; xmlns:stream=&quot;http://etherx.jabber.org/streams&quot; version=&quot;1.0&quot;&gt;');</span>
<a href="#l90.339"></a><span id="l90.339" class="difflineplus">+    this.send(</span>
<a href="#l90.340"></a><span id="l90.340" class="difflineplus">+      '&lt;?xml version=&quot;1.0&quot;?&gt;&lt;stream:stream to=&quot;' +</span>
<a href="#l90.341"></a><span id="l90.341" class="difflineplus">+        this._domain +</span>
<a href="#l90.342"></a><span id="l90.342" class="difflineplus">+        '&quot; xmlns=&quot;jabber:client&quot; xmlns:stream=&quot;http://etherx.jabber.org/streams&quot; version=&quot;1.0&quot;&gt;'</span>
<a href="#l90.343"></a><span id="l90.343" class="difflineplus">+    );</span>
<a href="#l90.344"></a><span id="l90.344">   },</span>
<a href="#l90.345"></a><span id="l90.345"> </span>
<a href="#l90.346"></a><span id="l90.346">   startSession() {</span>
<a href="#l90.347"></a><span id="l90.347" class="difflineminus">-    this.sendStanza(Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l90.348"></a><span id="l90.348" class="difflineminus">-                              Stanza.node(&quot;session&quot;, Stanza.NS.session)),</span>
<a href="#l90.349"></a><span id="l90.349" class="difflineminus">-                    (aStanza) =&gt; aStanza.attributes.type == &quot;result&quot;);</span>
<a href="#l90.350"></a><span id="l90.350" class="difflineplus">+    this.sendStanza(</span>
<a href="#l90.351"></a><span id="l90.351" class="difflineplus">+      Stanza.iq(&quot;set&quot;, null, null, Stanza.node(&quot;session&quot;, Stanza.NS.session)),</span>
<a href="#l90.352"></a><span id="l90.352" class="difflineplus">+      aStanza =&gt; aStanza.attributes.type == &quot;result&quot;</span>
<a href="#l90.353"></a><span id="l90.353" class="difflineplus">+    );</span>
<a href="#l90.354"></a><span id="l90.354">     this.onXmppStanza = this.stanzaListeners.sessionStarted;</span>
<a href="#l90.355"></a><span id="l90.355">   },</span>
<a href="#l90.356"></a><span id="l90.356"> </span>
<a href="#l90.357"></a><span id="l90.357">   /* XEP-0078: Non-SASL Authentication */</span>
<a href="#l90.358"></a><span id="l90.358">   startLegacyAuth() {</span>
<a href="#l90.359"></a><span id="l90.359">     if (!this._encrypted &amp;&amp; this._connectionSecurity == &quot;require_tls&quot;) {</span>
<a href="#l90.360"></a><span id="l90.360" class="difflineminus">-      this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l90.361"></a><span id="l90.361" class="difflineminus">-                   _(&quot;connection.error.startTLSNotSupported&quot;));</span>
<a href="#l90.362"></a><span id="l90.362" class="difflineplus">+      this.onError(</span>
<a href="#l90.363"></a><span id="l90.363" class="difflineplus">+        Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l90.364"></a><span id="l90.364" class="difflineplus">+        _(&quot;connection.error.startTLSNotSupported&quot;)</span>
<a href="#l90.365"></a><span id="l90.365" class="difflineplus">+      );</span>
<a href="#l90.366"></a><span id="l90.366">       return;</span>
<a href="#l90.367"></a><span id="l90.367">     }</span>
<a href="#l90.368"></a><span id="l90.368"> </span>
<a href="#l90.369"></a><span id="l90.369">     this.onXmppStanza = this.stanzaListeners.legacyAuth;</span>
<a href="#l90.370"></a><span id="l90.370" class="difflineminus">-    let s = Stanza.iq(&quot;get&quot;, null, this._domain,</span>
<a href="#l90.371"></a><span id="l90.371" class="difflineminus">-                      Stanza.node(&quot;query&quot;, Stanza.NS.auth, null,</span>
<a href="#l90.372"></a><span id="l90.372" class="difflineminus">-                                  Stanza.node(&quot;username&quot;, null, null,</span>
<a href="#l90.373"></a><span id="l90.373" class="difflineminus">-                                              this._jid.node)));</span>
<a href="#l90.374"></a><span id="l90.374" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l90.375"></a><span id="l90.375" class="difflineplus">+      &quot;get&quot;,</span>
<a href="#l90.376"></a><span id="l90.376" class="difflineplus">+      null,</span>
<a href="#l90.377"></a><span id="l90.377" class="difflineplus">+      this._domain,</span>
<a href="#l90.378"></a><span id="l90.378" class="difflineplus">+      Stanza.node(</span>
<a href="#l90.379"></a><span id="l90.379" class="difflineplus">+        &quot;query&quot;,</span>
<a href="#l90.380"></a><span id="l90.380" class="difflineplus">+        Stanza.NS.auth,</span>
<a href="#l90.381"></a><span id="l90.381" class="difflineplus">+        null,</span>
<a href="#l90.382"></a><span id="l90.382" class="difflineplus">+        Stanza.node(&quot;username&quot;, null, null, this._jid.node)</span>
<a href="#l90.383"></a><span id="l90.383" class="difflineplus">+      )</span>
<a href="#l90.384"></a><span id="l90.384" class="difflineplus">+    );</span>
<a href="#l90.385"></a><span id="l90.385">     this.sendStanza(s);</span>
<a href="#l90.386"></a><span id="l90.386">   },</span>
<a href="#l90.387"></a><span id="l90.387"> </span>
<a href="#l90.388"></a><span id="l90.388">   // If aResource is null, it will request to bind a server-generated</span>
<a href="#l90.389"></a><span id="l90.389">   // resourcepart, otherwise request to bind a client-submitted resourcepart.</span>
<a href="#l90.390"></a><span id="l90.390">   _requestBind(aResource) {</span>
<a href="#l90.391"></a><span id="l90.391" class="difflineminus">-    let resourceNode =</span>
<a href="#l90.392"></a><span id="l90.392" class="difflineminus">-      aResource ? Stanza.node(&quot;resource&quot;, null, null, aResource) : null;</span>
<a href="#l90.393"></a><span id="l90.393" class="difflineminus">-    this.sendStanza(Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l90.394"></a><span id="l90.394" class="difflineminus">-                              Stanza.node(&quot;bind&quot;, Stanza.NS.bind, null,</span>
<a href="#l90.395"></a><span id="l90.395" class="difflineminus">-                                          resourceNode)));</span>
<a href="#l90.396"></a><span id="l90.396" class="difflineplus">+    let resourceNode = aResource</span>
<a href="#l90.397"></a><span id="l90.397" class="difflineplus">+      ? Stanza.node(&quot;resource&quot;, null, null, aResource)</span>
<a href="#l90.398"></a><span id="l90.398" class="difflineplus">+      : null;</span>
<a href="#l90.399"></a><span id="l90.399" class="difflineplus">+    this.sendStanza(</span>
<a href="#l90.400"></a><span id="l90.400" class="difflineplus">+      Stanza.iq(</span>
<a href="#l90.401"></a><span id="l90.401" class="difflineplus">+        &quot;set&quot;,</span>
<a href="#l90.402"></a><span id="l90.402" class="difflineplus">+        null,</span>
<a href="#l90.403"></a><span id="l90.403" class="difflineplus">+        null,</span>
<a href="#l90.404"></a><span id="l90.404" class="difflineplus">+        Stanza.node(&quot;bind&quot;, Stanza.NS.bind, null, resourceNode)</span>
<a href="#l90.405"></a><span id="l90.405" class="difflineplus">+      )</span>
<a href="#l90.406"></a><span id="l90.406" class="difflineplus">+    );</span>
<a href="#l90.407"></a><span id="l90.407">   },</span>
<a href="#l90.408"></a><span id="l90.408"> </span>
<a href="#l90.409"></a><span id="l90.409">   /* Socket events */</span>
<a href="#l90.410"></a><span id="l90.410">   /* The connection is established */</span>
<a href="#l90.411"></a><span id="l90.411">   onConnection() {</span>
<a href="#l90.412"></a><span id="l90.412">     if (this._security.includes(&quot;ssl&quot;)) {</span>
<a href="#l90.413"></a><span id="l90.413">       this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l90.414"></a><span id="l90.414">       this._encrypted = true;</span>
<a href="#l90.415"></a><span id="l90.415" class="difflineplus">+    } else {</span>
<a href="#l90.416"></a><span id="l90.416" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.initStream;</span>
<a href="#l90.417"></a><span id="l90.417">     }</span>
<a href="#l90.418"></a><span id="l90.418" class="difflineminus">-    else</span>
<a href="#l90.419"></a><span id="l90.419" class="difflineminus">-      this.onXmppStanza = this.stanzaListeners.initStream;</span>
<a href="#l90.420"></a><span id="l90.420"> </span>
<a href="#l90.421"></a><span id="l90.421">     // Clear SRV results since we have connected.</span>
<a href="#l90.422"></a><span id="l90.422">     this._srvRecords = [];</span>
<a href="#l90.423"></a><span id="l90.423"> </span>
<a href="#l90.424"></a><span id="l90.424">     this._account.reportConnecting(_(&quot;connection.initializingStream&quot;));</span>
<a href="#l90.425"></a><span id="l90.425">     this.startStream();</span>
<a href="#l90.426"></a><span id="l90.426">   },</span>
<a href="#l90.427"></a><span id="l90.427"> </span>
<a href="#l90.428"></a><span id="l90.428">   /* When incoming data is available to be parsed */</span>
<a href="#l90.429"></a><span id="l90.429">   onDataReceived(aData) {</span>
<a href="#l90.430"></a><span id="l90.430">     this.checkPingTimer();</span>
<a href="#l90.431"></a><span id="l90.431" class="difflineminus">-    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l90.432"></a><span id="l90.432" class="difflineminus">-                    .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l90.433"></a><span id="l90.433" class="difflineplus">+    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;].createInstance(</span>
<a href="#l90.434"></a><span id="l90.434" class="difflineplus">+      Ci.nsIStringInputStream</span>
<a href="#l90.435"></a><span id="l90.435" class="difflineplus">+    );</span>
<a href="#l90.436"></a><span id="l90.436">     istream.setData(aData, aData.length);</span>
<a href="#l90.437"></a><span id="l90.437">     this._lastReceivedData = aData;</span>
<a href="#l90.438"></a><span id="l90.438">     try {</span>
<a href="#l90.439"></a><span id="l90.439">       this._parser.onDataAvailable(istream, 0, aData.length);</span>
<a href="#l90.440"></a><span id="l90.440">     } catch (e) {</span>
<a href="#l90.441"></a><span id="l90.441">       Cu.reportError(e);</span>
<a href="#l90.442"></a><span id="l90.442">       this.onXMLError(&quot;parser-exception&quot;, e);</span>
<a href="#l90.443"></a><span id="l90.443">     }</span>
<a href="#l90.444"></a><span id="l90.444" class="difflineat">@@ -331,53 +387,59 @@ XMPPSession.prototype = {</span>
<a href="#l90.445"></a><span id="l90.445">   },</span>
<a href="#l90.446"></a><span id="l90.446">   onConnectionTimedOut() {</span>
<a href="#l90.447"></a><span id="l90.447">     this._networkError(_(&quot;connection.error.timedOut&quot;));</span>
<a href="#l90.448"></a><span id="l90.448">   },</span>
<a href="#l90.449"></a><span id="l90.449">   _networkError(aMessage) {</span>
<a href="#l90.450"></a><span id="l90.450">     this.onError(Ci.prplIAccount.ERROR_NETWORK_ERROR, aMessage);</span>
<a href="#l90.451"></a><span id="l90.451">   },</span>
<a href="#l90.452"></a><span id="l90.452"> </span>
<a href="#l90.453"></a><span id="l90.453" class="difflineminus">-</span>
<a href="#l90.454"></a><span id="l90.454">   /* Methods called by the XMPPParser instance */</span>
<a href="#l90.455"></a><span id="l90.455">   onXMLError(aError, aException) {</span>
<a href="#l90.456"></a><span id="l90.456" class="difflineminus">-    if (aError == &quot;parsing-characters&quot;)</span>
<a href="#l90.457"></a><span id="l90.457" class="difflineplus">+    if (aError == &quot;parsing-characters&quot;) {</span>
<a href="#l90.458"></a><span id="l90.458">       this.WARN(aError + &quot;: &quot; + aException + &quot;\n&quot; + this._lastReceivedData);</span>
<a href="#l90.459"></a><span id="l90.459" class="difflineminus">-    else</span>
<a href="#l90.460"></a><span id="l90.460" class="difflineplus">+    } else {</span>
<a href="#l90.461"></a><span id="l90.461">       this.ERROR(aError + &quot;: &quot; + aException + &quot;\n&quot; + this._lastReceivedData);</span>
<a href="#l90.462"></a><span id="l90.462" class="difflineminus">-    if (aError != &quot;parse-warning&quot; &amp;&amp; aError != &quot;parsing-characters&quot;)</span>
<a href="#l90.463"></a><span id="l90.463" class="difflineplus">+    }</span>
<a href="#l90.464"></a><span id="l90.464" class="difflineplus">+    if (aError != &quot;parse-warning&quot; &amp;&amp; aError != &quot;parsing-characters&quot;) {</span>
<a href="#l90.465"></a><span id="l90.465">       this._networkError(_(&quot;connection.error.receivedUnexpectedData&quot;));</span>
<a href="#l90.466"></a><span id="l90.466" class="difflineplus">+    }</span>
<a href="#l90.467"></a><span id="l90.467">   },</span>
<a href="#l90.468"></a><span id="l90.468"> </span>
<a href="#l90.469"></a><span id="l90.469">   // All the functions in stanzaListeners are used as onXmppStanza</span>
<a href="#l90.470"></a><span id="l90.470">   // implementations at various steps of establishing the session.</span>
<a href="#l90.471"></a><span id="l90.471">   stanzaListeners: {</span>
<a href="#l90.472"></a><span id="l90.472">     initStream(aStanza) {</span>
<a href="#l90.473"></a><span id="l90.473">       if (aStanza.localName != &quot;features&quot;) {</span>
<a href="#l90.474"></a><span id="l90.474" class="difflineminus">-        this.ERROR(&quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;);</span>
<a href="#l90.475"></a><span id="l90.475" class="difflineplus">+        this.ERROR(</span>
<a href="#l90.476"></a><span id="l90.476" class="difflineplus">+          &quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;</span>
<a href="#l90.477"></a><span id="l90.477" class="difflineplus">+        );</span>
<a href="#l90.478"></a><span id="l90.478">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l90.479"></a><span id="l90.479">         return;</span>
<a href="#l90.480"></a><span id="l90.480">       }</span>
<a href="#l90.481"></a><span id="l90.481"> </span>
<a href="#l90.482"></a><span id="l90.482">       let starttls = aStanza.getElement([&quot;starttls&quot;]);</span>
<a href="#l90.483"></a><span id="l90.483">       if (starttls &amp;&amp; this._security.includes(&quot;starttls&quot;)) {</span>
<a href="#l90.484"></a><span id="l90.484">         this._account.reportConnecting(_(&quot;connection.initializingEncryption&quot;));</span>
<a href="#l90.485"></a><span id="l90.485">         this.sendStanza(Stanza.node(&quot;starttls&quot;, Stanza.NS.tls));</span>
<a href="#l90.486"></a><span id="l90.486">         this.onXmppStanza = this.stanzaListeners.startTLS;</span>
<a href="#l90.487"></a><span id="l90.487">         return;</span>
<a href="#l90.488"></a><span id="l90.488">       }</span>
<a href="#l90.489"></a><span id="l90.489" class="difflineminus">-      if (starttls &amp;&amp;</span>
<a href="#l90.490"></a><span id="l90.490" class="difflineminus">-          starttls.children.some(c =&gt; c.localName == &quot;required&quot;)) {</span>
<a href="#l90.491"></a><span id="l90.491" class="difflineminus">-        this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l90.492"></a><span id="l90.492" class="difflineminus">-                     _(&quot;connection.error.startTLSRequired&quot;));</span>
<a href="#l90.493"></a><span id="l90.493" class="difflineplus">+      if (starttls &amp;&amp; starttls.children.some(c =&gt; c.localName == &quot;required&quot;)) {</span>
<a href="#l90.494"></a><span id="l90.494" class="difflineplus">+        this.onError(</span>
<a href="#l90.495"></a><span id="l90.495" class="difflineplus">+          Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l90.496"></a><span id="l90.496" class="difflineplus">+          _(&quot;connection.error.startTLSRequired&quot;)</span>
<a href="#l90.497"></a><span id="l90.497" class="difflineplus">+        );</span>
<a href="#l90.498"></a><span id="l90.498">         return;</span>
<a href="#l90.499"></a><span id="l90.499">       }</span>
<a href="#l90.500"></a><span id="l90.500">       if (!starttls &amp;&amp; this._connectionSecurity == &quot;require_tls&quot;) {</span>
<a href="#l90.501"></a><span id="l90.501" class="difflineminus">-        this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l90.502"></a><span id="l90.502" class="difflineminus">-                     _(&quot;connection.error.startTLSNotSupported&quot;));</span>
<a href="#l90.503"></a><span id="l90.503" class="difflineplus">+        this.onError(</span>
<a href="#l90.504"></a><span id="l90.504" class="difflineplus">+          Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l90.505"></a><span id="l90.505" class="difflineplus">+          _(&quot;connection.error.startTLSNotSupported&quot;)</span>
<a href="#l90.506"></a><span id="l90.506" class="difflineplus">+        );</span>
<a href="#l90.507"></a><span id="l90.507">         return;</span>
<a href="#l90.508"></a><span id="l90.508">       }</span>
<a href="#l90.509"></a><span id="l90.509"> </span>
<a href="#l90.510"></a><span id="l90.510">       // If we aren't starting TLS, jump to the auth step.</span>
<a href="#l90.511"></a><span id="l90.511">       this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l90.512"></a><span id="l90.512">       this.onXmppStanza(aStanza);</span>
<a href="#l90.513"></a><span id="l90.513">     },</span>
<a href="#l90.514"></a><span id="l90.514">     startTLS(aStanza) {</span>
<a href="#l90.515"></a><span id="l90.515" class="difflineat">@@ -388,28 +450,31 @@ XMPPSession.prototype = {</span>
<a href="#l90.516"></a><span id="l90.516"> </span>
<a href="#l90.517"></a><span id="l90.517">       this.startTLS();</span>
<a href="#l90.518"></a><span id="l90.518">       this._encrypted = true;</span>
<a href="#l90.519"></a><span id="l90.519">       this.startStream();</span>
<a href="#l90.520"></a><span id="l90.520">       this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l90.521"></a><span id="l90.521">     },</span>
<a href="#l90.522"></a><span id="l90.522">     startAuth(aStanza) {</span>
<a href="#l90.523"></a><span id="l90.523">       if (aStanza.localName != &quot;features&quot;) {</span>
<a href="#l90.524"></a><span id="l90.524" class="difflineminus">-        this.ERROR(&quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;);</span>
<a href="#l90.525"></a><span id="l90.525" class="difflineplus">+        this.ERROR(</span>
<a href="#l90.526"></a><span id="l90.526" class="difflineplus">+          &quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;</span>
<a href="#l90.527"></a><span id="l90.527" class="difflineplus">+        );</span>
<a href="#l90.528"></a><span id="l90.528">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l90.529"></a><span id="l90.529">         return;</span>
<a href="#l90.530"></a><span id="l90.530">       }</span>
<a href="#l90.531"></a><span id="l90.531"> </span>
<a href="#l90.532"></a><span id="l90.532">       let mechs = aStanza.getElement([&quot;mechanisms&quot;]);</span>
<a href="#l90.533"></a><span id="l90.533">       if (!mechs) {</span>
<a href="#l90.534"></a><span id="l90.534">         let auth = aStanza.getElement([&quot;auth&quot;]);</span>
<a href="#l90.535"></a><span id="l90.535" class="difflineminus">-        if (auth &amp;&amp; auth.uri == Stanza.NS.auth_feature)</span>
<a href="#l90.536"></a><span id="l90.536" class="difflineplus">+        if (auth &amp;&amp; auth.uri == Stanza.NS.auth_feature) {</span>
<a href="#l90.537"></a><span id="l90.537">           this.startLegacyAuth();</span>
<a href="#l90.538"></a><span id="l90.538" class="difflineminus">-        else</span>
<a href="#l90.539"></a><span id="l90.539" class="difflineplus">+        } else {</span>
<a href="#l90.540"></a><span id="l90.540">           this._networkError(_(&quot;connection.error.noAuthMec&quot;));</span>
<a href="#l90.541"></a><span id="l90.541" class="difflineplus">+        }</span>
<a href="#l90.542"></a><span id="l90.542">         return;</span>
<a href="#l90.543"></a><span id="l90.543">       }</span>
<a href="#l90.544"></a><span id="l90.544"> </span>
<a href="#l90.545"></a><span id="l90.545">       // Select the auth mechanism we will use. PLAIN will be treated</span>
<a href="#l90.546"></a><span id="l90.546">       // a bit differently as we want to avoid it over an unencrypted</span>
<a href="#l90.547"></a><span id="l90.547">       // connection, except if the user has explicly allowed that</span>
<a href="#l90.548"></a><span id="l90.548">       // behavior.</span>
<a href="#l90.549"></a><span id="l90.549">       let authMechanisms = this._account.authMechanisms || XMPPAuthMechanisms;</span>
<a href="#l90.550"></a><span id="l90.550" class="difflineat">@@ -419,73 +484,85 @@ XMPPSession.prototype = {</span>
<a href="#l90.551"></a><span id="l90.551">       for (let m of mechs) {</span>
<a href="#l90.552"></a><span id="l90.552">         let mech = m.innerText;</span>
<a href="#l90.553"></a><span id="l90.553">         if (mech == &quot;PLAIN&quot; &amp;&amp; !this._encrypted) {</span>
<a href="#l90.554"></a><span id="l90.554">           // If PLAIN is proposed over an unencrypted connection,</span>
<a href="#l90.555"></a><span id="l90.555">           // remember that it's a possibility but don't bother</span>
<a href="#l90.556"></a><span id="l90.556">           // checking if the user allowed it until we have verified</span>
<a href="#l90.557"></a><span id="l90.557">           // that nothing more secure is available.</span>
<a href="#l90.558"></a><span id="l90.558">           canUsePlain = true;</span>
<a href="#l90.559"></a><span id="l90.559" class="difflineminus">-        }</span>
<a href="#l90.560"></a><span id="l90.560" class="difflineminus">-        else if (authMechanisms.hasOwnProperty(mech)) {</span>
<a href="#l90.561"></a><span id="l90.561" class="difflineplus">+        } else if (authMechanisms.hasOwnProperty(mech)) {</span>
<a href="#l90.562"></a><span id="l90.562">           selectedMech = mech;</span>
<a href="#l90.563"></a><span id="l90.563">           break;</span>
<a href="#l90.564"></a><span id="l90.564">         }</span>
<a href="#l90.565"></a><span id="l90.565">       }</span>
<a href="#l90.566"></a><span id="l90.566">       if (!selectedMech &amp;&amp; canUsePlain) {</span>
<a href="#l90.567"></a><span id="l90.567" class="difflineminus">-        if (this._connectionSecurity == &quot;allow_unencrypted_plain_auth&quot;)</span>
<a href="#l90.568"></a><span id="l90.568" class="difflineplus">+        if (this._connectionSecurity == &quot;allow_unencrypted_plain_auth&quot;) {</span>
<a href="#l90.569"></a><span id="l90.569">           selectedMech = &quot;PLAIN&quot;;</span>
<a href="#l90.570"></a><span id="l90.570" class="difflineminus">-        else {</span>
<a href="#l90.571"></a><span id="l90.571" class="difflineminus">-          this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.572"></a><span id="l90.572" class="difflineminus">-                       _(&quot;connection.error.notSendingPasswordInClear&quot;));</span>
<a href="#l90.573"></a><span id="l90.573" class="difflineplus">+        } else {</span>
<a href="#l90.574"></a><span id="l90.574" class="difflineplus">+          this.onError(</span>
<a href="#l90.575"></a><span id="l90.575" class="difflineplus">+            Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.576"></a><span id="l90.576" class="difflineplus">+            _(&quot;connection.error.notSendingPasswordInClear&quot;)</span>
<a href="#l90.577"></a><span id="l90.577" class="difflineplus">+          );</span>
<a href="#l90.578"></a><span id="l90.578">           return;</span>
<a href="#l90.579"></a><span id="l90.579">         }</span>
<a href="#l90.580"></a><span id="l90.580">       }</span>
<a href="#l90.581"></a><span id="l90.581">       if (!selectedMech) {</span>
<a href="#l90.582"></a><span id="l90.582" class="difflineminus">-        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.583"></a><span id="l90.583" class="difflineminus">-                     _(&quot;connection.error.noCompatibleAuthMec&quot;));</span>
<a href="#l90.584"></a><span id="l90.584" class="difflineplus">+        this.onError(</span>
<a href="#l90.585"></a><span id="l90.585" class="difflineplus">+          Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.586"></a><span id="l90.586" class="difflineplus">+          _(&quot;connection.error.noCompatibleAuthMec&quot;)</span>
<a href="#l90.587"></a><span id="l90.587" class="difflineplus">+        );</span>
<a href="#l90.588"></a><span id="l90.588">         return;</span>
<a href="#l90.589"></a><span id="l90.589">       }</span>
<a href="#l90.590"></a><span id="l90.590" class="difflineminus">-      let authMec = authMechanisms[selectedMech](this._jid.node,</span>
<a href="#l90.591"></a><span id="l90.591" class="difflineminus">-                                                 this._password,</span>
<a href="#l90.592"></a><span id="l90.592" class="difflineminus">-                                                 this._domain);</span>
<a href="#l90.593"></a><span id="l90.593" class="difflineplus">+      let authMec = authMechanisms[selectedMech](</span>
<a href="#l90.594"></a><span id="l90.594" class="difflineplus">+        this._jid.node,</span>
<a href="#l90.595"></a><span id="l90.595" class="difflineplus">+        this._password,</span>
<a href="#l90.596"></a><span id="l90.596" class="difflineplus">+        this._domain</span>
<a href="#l90.597"></a><span id="l90.597" class="difflineplus">+      );</span>
<a href="#l90.598"></a><span id="l90.598">       this._password = null;</span>
<a href="#l90.599"></a><span id="l90.599"> </span>
<a href="#l90.600"></a><span id="l90.600">       this._account.reportConnecting(_(&quot;connection.authenticating&quot;));</span>
<a href="#l90.601"></a><span id="l90.601">       this.onXmppStanza = this.stanzaListeners.authDialog.bind(this, authMec);</span>
<a href="#l90.602"></a><span id="l90.602">       this.onXmppStanza(null); // the first auth step doesn't read anything</span>
<a href="#l90.603"></a><span id="l90.603">     },</span>
<a href="#l90.604"></a><span id="l90.604">     authDialog(aAuthMec, aStanza) {</span>
<a href="#l90.605"></a><span id="l90.605">       if (aStanza &amp;&amp; aStanza.localName == &quot;failure&quot;) {</span>
<a href="#l90.606"></a><span id="l90.606">         let errorMsg = &quot;authenticationFailure&quot;;</span>
<a href="#l90.607"></a><span id="l90.607" class="difflineminus">-        if (aStanza.getElement([&quot;not-authorized&quot;]) ||</span>
<a href="#l90.608"></a><span id="l90.608" class="difflineminus">-            aStanza.getElement([&quot;bad-auth&quot;])) {</span>
<a href="#l90.609"></a><span id="l90.609" class="difflineplus">+        if (</span>
<a href="#l90.610"></a><span id="l90.610" class="difflineplus">+          aStanza.getElement([&quot;not-authorized&quot;]) ||</span>
<a href="#l90.611"></a><span id="l90.611" class="difflineplus">+          aStanza.getElement([&quot;bad-auth&quot;])</span>
<a href="#l90.612"></a><span id="l90.612" class="difflineplus">+        ) {</span>
<a href="#l90.613"></a><span id="l90.613">           errorMsg = &quot;notAuthorized&quot;;</span>
<a href="#l90.614"></a><span id="l90.614">         }</span>
<a href="#l90.615"></a><span id="l90.615" class="difflineminus">-        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.616"></a><span id="l90.616" class="difflineminus">-                     _(&quot;connection.error.&quot; + errorMsg));</span>
<a href="#l90.617"></a><span id="l90.617" class="difflineplus">+        this.onError(</span>
<a href="#l90.618"></a><span id="l90.618" class="difflineplus">+          Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.619"></a><span id="l90.619" class="difflineplus">+          _(&quot;connection.error.&quot; + errorMsg)</span>
<a href="#l90.620"></a><span id="l90.620" class="difflineplus">+        );</span>
<a href="#l90.621"></a><span id="l90.621">         return;</span>
<a href="#l90.622"></a><span id="l90.622">       }</span>
<a href="#l90.623"></a><span id="l90.623"> </span>
<a href="#l90.624"></a><span id="l90.624">       let result;</span>
<a href="#l90.625"></a><span id="l90.625">       try {</span>
<a href="#l90.626"></a><span id="l90.626">         result = aAuthMec.next(aStanza);</span>
<a href="#l90.627"></a><span id="l90.627">       } catch (e) {</span>
<a href="#l90.628"></a><span id="l90.628">         this.ERROR(e);</span>
<a href="#l90.629"></a><span id="l90.629" class="difflineminus">-        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.630"></a><span id="l90.630" class="difflineminus">-                     _(&quot;connection.error.authenticationFailure&quot;));</span>
<a href="#l90.631"></a><span id="l90.631" class="difflineplus">+        this.onError(</span>
<a href="#l90.632"></a><span id="l90.632" class="difflineplus">+          Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.633"></a><span id="l90.633" class="difflineplus">+          _(&quot;connection.error.authenticationFailure&quot;)</span>
<a href="#l90.634"></a><span id="l90.634" class="difflineplus">+        );</span>
<a href="#l90.635"></a><span id="l90.635">         return;</span>
<a href="#l90.636"></a><span id="l90.636">       }</span>
<a href="#l90.637"></a><span id="l90.637"> </span>
<a href="#l90.638"></a><span id="l90.638">       // The authentication mechanism can yield a promise which must resolve</span>
<a href="#l90.639"></a><span id="l90.639">       // before sending data.</span>
<a href="#l90.640"></a><span id="l90.640">       if (result.value) {</span>
<a href="#l90.641"></a><span id="l90.641" class="difflineminus">-        Promise.resolve(result.value).then((value) =&gt; {</span>
<a href="#l90.642"></a><span id="l90.642" class="difflineminus">-          if (value.send)</span>
<a href="#l90.643"></a><span id="l90.643" class="difflineplus">+        Promise.resolve(result.value).then(value =&gt; {</span>
<a href="#l90.644"></a><span id="l90.644" class="difflineplus">+          if (value.send) {</span>
<a href="#l90.645"></a><span id="l90.645">             this.send(value.send.getXML(), value.log);</span>
<a href="#l90.646"></a><span id="l90.646" class="difflineplus">+          }</span>
<a href="#l90.647"></a><span id="l90.647">         });</span>
<a href="#l90.648"></a><span id="l90.648">       }</span>
<a href="#l90.649"></a><span id="l90.649">       if (result.done) {</span>
<a href="#l90.650"></a><span id="l90.650">         this.startStream();</span>
<a href="#l90.651"></a><span id="l90.651">         this.onXmppStanza = this.stanzaListeners.startBind;</span>
<a href="#l90.652"></a><span id="l90.652">       }</span>
<a href="#l90.653"></a><span id="l90.653">     },</span>
<a href="#l90.654"></a><span id="l90.654">     startBind(aStanza) {</span>
<a href="#l90.655"></a><span id="l90.655" class="difflineat">@@ -546,33 +623,36 @@ XMPPSession.prototype = {</span>
<a href="#l90.656"></a><span id="l90.656">         if (!error) {</span>
<a href="#l90.657"></a><span id="l90.657">           this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l90.658"></a><span id="l90.658">           return;</span>
<a href="#l90.659"></a><span id="l90.659">         }</span>
<a href="#l90.660"></a><span id="l90.660"> </span>
<a href="#l90.661"></a><span id="l90.661">         let code = parseInt(error.attributes.code, 10);</span>
<a href="#l90.662"></a><span id="l90.662">         if (code == 401) {</span>
<a href="#l90.663"></a><span id="l90.663">           // Failed Authentication (Incorrect Credentials)</span>
<a href="#l90.664"></a><span id="l90.664" class="difflineminus">-          this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.665"></a><span id="l90.665" class="difflineminus">-                       _(&quot;connection.error.notAuthorized&quot;));</span>
<a href="#l90.666"></a><span id="l90.666" class="difflineplus">+          this.onError(</span>
<a href="#l90.667"></a><span id="l90.667" class="difflineplus">+            Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.668"></a><span id="l90.668" class="difflineplus">+            _(&quot;connection.error.notAuthorized&quot;)</span>
<a href="#l90.669"></a><span id="l90.669" class="difflineplus">+          );</span>
<a href="#l90.670"></a><span id="l90.670">           return;</span>
<a href="#l90.671"></a><span id="l90.671" class="difflineminus">-        }</span>
<a href="#l90.672"></a><span id="l90.672" class="difflineminus">-        else if (code == 406) {</span>
<a href="#l90.673"></a><span id="l90.673" class="difflineplus">+        } else if (code == 406) {</span>
<a href="#l90.674"></a><span id="l90.674">           // Failed Authentication (Required Information Not Provided)</span>
<a href="#l90.675"></a><span id="l90.675" class="difflineminus">-          this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.676"></a><span id="l90.676" class="difflineminus">-                       _(&quot;connection.error.authenticationFailure&quot;));</span>
<a href="#l90.677"></a><span id="l90.677" class="difflineplus">+          this.onError(</span>
<a href="#l90.678"></a><span id="l90.678" class="difflineplus">+            Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l90.679"></a><span id="l90.679" class="difflineplus">+            _(&quot;connection.error.authenticationFailure&quot;)</span>
<a href="#l90.680"></a><span id="l90.680" class="difflineplus">+          );</span>
<a href="#l90.681"></a><span id="l90.681">           return;</span>
<a href="#l90.682"></a><span id="l90.682">         }</span>
<a href="#l90.683"></a><span id="l90.683">         // else if (code == 409) {</span>
<a href="#l90.684"></a><span id="l90.684" class="difflineminus">-          // Failed Authentication (Resource Conflict)</span>
<a href="#l90.685"></a><span id="l90.685" class="difflineminus">-          // XXX Flo The spec in XEP-0078 defines this error code, but</span>
<a href="#l90.686"></a><span id="l90.686" class="difflineminus">-          // I've yet to find a server sending it. The server I tested</span>
<a href="#l90.687"></a><span id="l90.687" class="difflineminus">-          // with just closed the first connection when a second</span>
<a href="#l90.688"></a><span id="l90.688" class="difflineminus">-          // connection was attempted with the same resource.</span>
<a href="#l90.689"></a><span id="l90.689" class="difflineminus">-          // libpurple's jabber prpl doesn't support this code either.</span>
<a href="#l90.690"></a><span id="l90.690" class="difflineplus">+        // Failed Authentication (Resource Conflict)</span>
<a href="#l90.691"></a><span id="l90.691" class="difflineplus">+        // XXX Flo The spec in XEP-0078 defines this error code, but</span>
<a href="#l90.692"></a><span id="l90.692" class="difflineplus">+        // I've yet to find a server sending it. The server I tested</span>
<a href="#l90.693"></a><span id="l90.693" class="difflineplus">+        // with just closed the first connection when a second</span>
<a href="#l90.694"></a><span id="l90.694" class="difflineplus">+        // connection was attempted with the same resource.</span>
<a href="#l90.695"></a><span id="l90.695" class="difflineplus">+        // libpurple's jabber prpl doesn't support this code either.</span>
<a href="#l90.696"></a><span id="l90.696">         // }</span>
<a href="#l90.697"></a><span id="l90.697">       }</span>
<a href="#l90.698"></a><span id="l90.698"> </span>
<a href="#l90.699"></a><span id="l90.699">       if (aStanza.attributes.type != &quot;result&quot;) {</span>
<a href="#l90.700"></a><span id="l90.700">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l90.701"></a><span id="l90.701">         return;</span>
<a href="#l90.702"></a><span id="l90.702">       }</span>
<a href="#l90.703"></a><span id="l90.703"> </span>
<a href="#l90.704"></a><span id="l90.704" class="difflineat">@@ -580,98 +660,119 @@ XMPPSession.prototype = {</span>
<a href="#l90.705"></a><span id="l90.705">         // Success!</span>
<a href="#l90.706"></a><span id="l90.706">         this._password = null;</span>
<a href="#l90.707"></a><span id="l90.707">         this.startSession();</span>
<a href="#l90.708"></a><span id="l90.708">         return;</span>
<a href="#l90.709"></a><span id="l90.709">       }</span>
<a href="#l90.710"></a><span id="l90.710"> </span>
<a href="#l90.711"></a><span id="l90.711">       let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l90.712"></a><span id="l90.712">       let values = {};</span>
<a href="#l90.713"></a><span id="l90.713" class="difflineminus">-      for (let c of query.children)</span>
<a href="#l90.714"></a><span id="l90.714" class="difflineplus">+      for (let c of query.children) {</span>
<a href="#l90.715"></a><span id="l90.715">         values[c.qName] = c.innerText;</span>
<a href="#l90.716"></a><span id="l90.716" class="difflineplus">+      }</span>
<a href="#l90.717"></a><span id="l90.717"> </span>
<a href="#l90.718"></a><span id="l90.718">       if (!(&quot;username&quot; in values) || !(&quot;resource&quot; in values)) {</span>
<a href="#l90.719"></a><span id="l90.719">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l90.720"></a><span id="l90.720">         return;</span>
<a href="#l90.721"></a><span id="l90.721">       }</span>
<a href="#l90.722"></a><span id="l90.722"> </span>
<a href="#l90.723"></a><span id="l90.723" class="difflineminus">-</span>
<a href="#l90.724"></a><span id="l90.724">       // If the resource is empty, we will fallback to XMPPDefaultResource</span>
<a href="#l90.725"></a><span id="l90.725">       // (set to brandShortName) as resource is REQUIRED.</span>
<a href="#l90.726"></a><span id="l90.726">       if (!this._resource) {</span>
<a href="#l90.727"></a><span id="l90.727">         this._resource = XMPPDefaultResource;</span>
<a href="#l90.728"></a><span id="l90.728" class="difflineminus">-        this._jid =</span>
<a href="#l90.729"></a><span id="l90.729" class="difflineminus">-          this._setJID(this._jid.domain, this._jid.node, this._resource);</span>
<a href="#l90.730"></a><span id="l90.730" class="difflineplus">+        this._jid = this._setJID(</span>
<a href="#l90.731"></a><span id="l90.731" class="difflineplus">+          this._jid.domain,</span>
<a href="#l90.732"></a><span id="l90.732" class="difflineplus">+          this._jid.node,</span>
<a href="#l90.733"></a><span id="l90.733" class="difflineplus">+          this._resource</span>
<a href="#l90.734"></a><span id="l90.734" class="difflineplus">+        );</span>
<a href="#l90.735"></a><span id="l90.735">       }</span>
<a href="#l90.736"></a><span id="l90.736"> </span>
<a href="#l90.737"></a><span id="l90.737">       let children = [</span>
<a href="#l90.738"></a><span id="l90.738">         Stanza.node(&quot;username&quot;, null, null, this._jid.node),</span>
<a href="#l90.739"></a><span id="l90.739">         Stanza.node(&quot;resource&quot;, null, null, this._resource),</span>
<a href="#l90.740"></a><span id="l90.740">       ];</span>
<a href="#l90.741"></a><span id="l90.741"> </span>
<a href="#l90.742"></a><span id="l90.742">       let logString;</span>
<a href="#l90.743"></a><span id="l90.743" class="difflineminus">-      if ((&quot;digest&quot; in values) &amp;&amp; this._streamId) {</span>
<a href="#l90.744"></a><span id="l90.744" class="difflineplus">+      if (&quot;digest&quot; in values &amp;&amp; this._streamId) {</span>
<a href="#l90.745"></a><span id="l90.745">         let hashBase = this._streamId + this._password;</span>
<a href="#l90.746"></a><span id="l90.746"> </span>
<a href="#l90.747"></a><span id="l90.747" class="difflineminus">-        let ch =</span>
<a href="#l90.748"></a><span id="l90.748" class="difflineminus">-          Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l90.749"></a><span id="l90.749" class="difflineplus">+        let ch = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l90.750"></a><span id="l90.750" class="difflineplus">+          Ci.nsICryptoHash</span>
<a href="#l90.751"></a><span id="l90.751" class="difflineplus">+        );</span>
<a href="#l90.752"></a><span id="l90.752">         ch.init(ch.SHA1);</span>
<a href="#l90.753"></a><span id="l90.753">         // Non-US-ASCII characters MUST be encoded as UTF-8 since the</span>
<a href="#l90.754"></a><span id="l90.754">         // SHA-1 hashing algorithm operates on byte arrays.</span>
<a href="#l90.755"></a><span id="l90.755" class="difflineminus">-        let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l90.756"></a><span id="l90.756" class="difflineminus">-                          .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l90.757"></a><span id="l90.757" class="difflineplus">+        let converter = Cc[</span>
<a href="#l90.758"></a><span id="l90.758" class="difflineplus">+          &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l90.759"></a><span id="l90.759" class="difflineplus">+        ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l90.760"></a><span id="l90.760">         converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l90.761"></a><span id="l90.761">         let data = converter.convertToByteArray(hashBase);</span>
<a href="#l90.762"></a><span id="l90.762">         ch.update(data, data.length);</span>
<a href="#l90.763"></a><span id="l90.763">         let hash = ch.finish(false);</span>
<a href="#l90.764"></a><span id="l90.764" class="difflineminus">-        let toHexString =</span>
<a href="#l90.765"></a><span id="l90.765" class="difflineminus">-          charCode =&gt; (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l90.766"></a><span id="l90.766" class="difflineminus">-        let digest = Object.keys(hash).map(i =&gt; toHexString(hash.charCodeAt(i))).join(&quot;&quot;);</span>
<a href="#l90.767"></a><span id="l90.767" class="difflineplus">+        let toHexString = charCode =&gt; (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l90.768"></a><span id="l90.768" class="difflineplus">+        let digest = Object.keys(hash)</span>
<a href="#l90.769"></a><span id="l90.769" class="difflineplus">+          .map(i =&gt; toHexString(hash.charCodeAt(i)))</span>
<a href="#l90.770"></a><span id="l90.770" class="difflineplus">+          .join(&quot;&quot;);</span>
<a href="#l90.771"></a><span id="l90.771"> </span>
<a href="#l90.772"></a><span id="l90.772">         children.push(Stanza.node(&quot;digest&quot;, null, null, digest));</span>
<a href="#l90.773"></a><span id="l90.773">         logString =</span>
<a href="#l90.774"></a><span id="l90.774">           &quot;legacyAuth stanza containing SHA-1 hash of the password not logged&quot;;</span>
<a href="#l90.775"></a><span id="l90.775" class="difflineminus">-      }</span>
<a href="#l90.776"></a><span id="l90.776" class="difflineminus">-      else if (&quot;password&quot; in values) {</span>
<a href="#l90.777"></a><span id="l90.777" class="difflineminus">-        if (!this._encrypted &amp;&amp;</span>
<a href="#l90.778"></a><span id="l90.778" class="difflineminus">-            this._connectionSecurity != &quot;allow_unencrypted_plain_auth&quot;) {</span>
<a href="#l90.779"></a><span id="l90.779" class="difflineminus">-          this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.780"></a><span id="l90.780" class="difflineminus">-                       _(&quot;connection.error.notSendingPasswordInClear&quot;));</span>
<a href="#l90.781"></a><span id="l90.781" class="difflineplus">+      } else if (&quot;password&quot; in values) {</span>
<a href="#l90.782"></a><span id="l90.782" class="difflineplus">+        if (</span>
<a href="#l90.783"></a><span id="l90.783" class="difflineplus">+          !this._encrypted &amp;&amp;</span>
<a href="#l90.784"></a><span id="l90.784" class="difflineplus">+          this._connectionSecurity != &quot;allow_unencrypted_plain_auth&quot;</span>
<a href="#l90.785"></a><span id="l90.785" class="difflineplus">+        ) {</span>
<a href="#l90.786"></a><span id="l90.786" class="difflineplus">+          this.onError(</span>
<a href="#l90.787"></a><span id="l90.787" class="difflineplus">+            Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.788"></a><span id="l90.788" class="difflineplus">+            _(&quot;connection.error.notSendingPasswordInClear&quot;)</span>
<a href="#l90.789"></a><span id="l90.789" class="difflineplus">+          );</span>
<a href="#l90.790"></a><span id="l90.790">           return;</span>
<a href="#l90.791"></a><span id="l90.791">         }</span>
<a href="#l90.792"></a><span id="l90.792">         children.push(Stanza.node(&quot;password&quot;, null, null, this._password));</span>
<a href="#l90.793"></a><span id="l90.793">         logString = &quot;legacyAuth stanza containing password not logged&quot;;</span>
<a href="#l90.794"></a><span id="l90.794" class="difflineminus">-      }</span>
<a href="#l90.795"></a><span id="l90.795" class="difflineminus">-      else {</span>
<a href="#l90.796"></a><span id="l90.796" class="difflineminus">-        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.797"></a><span id="l90.797" class="difflineminus">-                     _(&quot;connection.error.noCompatibleAuthMec&quot;));</span>
<a href="#l90.798"></a><span id="l90.798" class="difflineplus">+      } else {</span>
<a href="#l90.799"></a><span id="l90.799" class="difflineplus">+        this.onError(</span>
<a href="#l90.800"></a><span id="l90.800" class="difflineplus">+          Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l90.801"></a><span id="l90.801" class="difflineplus">+          _(&quot;connection.error.noCompatibleAuthMec&quot;)</span>
<a href="#l90.802"></a><span id="l90.802" class="difflineplus">+        );</span>
<a href="#l90.803"></a><span id="l90.803">         return;</span>
<a href="#l90.804"></a><span id="l90.804">       }</span>
<a href="#l90.805"></a><span id="l90.805"> </span>
<a href="#l90.806"></a><span id="l90.806" class="difflineminus">-      let s = Stanza.iq(&quot;set&quot;, null, this._domain,</span>
<a href="#l90.807"></a><span id="l90.807" class="difflineminus">-                        Stanza.node(&quot;query&quot;, Stanza.NS.auth, null, children));</span>
<a href="#l90.808"></a><span id="l90.808" class="difflineminus">-      this.sendStanza(s, undefined, undefined, `&lt;iq type=&quot;set&quot;.../&gt; (${logString})`);</span>
<a href="#l90.809"></a><span id="l90.809" class="difflineplus">+      let s = Stanza.iq(</span>
<a href="#l90.810"></a><span id="l90.810" class="difflineplus">+        &quot;set&quot;,</span>
<a href="#l90.811"></a><span id="l90.811" class="difflineplus">+        null,</span>
<a href="#l90.812"></a><span id="l90.812" class="difflineplus">+        this._domain,</span>
<a href="#l90.813"></a><span id="l90.813" class="difflineplus">+        Stanza.node(&quot;query&quot;, Stanza.NS.auth, null, children)</span>
<a href="#l90.814"></a><span id="l90.814" class="difflineplus">+      );</span>
<a href="#l90.815"></a><span id="l90.815" class="difflineplus">+      this.sendStanza(</span>
<a href="#l90.816"></a><span id="l90.816" class="difflineplus">+        s,</span>
<a href="#l90.817"></a><span id="l90.817" class="difflineplus">+        undefined,</span>
<a href="#l90.818"></a><span id="l90.818" class="difflineplus">+        undefined,</span>
<a href="#l90.819"></a><span id="l90.819" class="difflineplus">+        `&lt;iq type=&quot;set&quot;.../&gt; (${logString})`</span>
<a href="#l90.820"></a><span id="l90.820" class="difflineplus">+      );</span>
<a href="#l90.821"></a><span id="l90.821">     },</span>
<a href="#l90.822"></a><span id="l90.822">     sessionStarted(aStanza) {</span>
<a href="#l90.823"></a><span id="l90.823">       this.resetPingTimer();</span>
<a href="#l90.824"></a><span id="l90.824">       this._account.onConnection();</span>
<a href="#l90.825"></a><span id="l90.825">       this.LOG(&quot;Account successfully connected.&quot;);</span>
<a href="#l90.826"></a><span id="l90.826">       this.onXmppStanza = this.stanzaListeners.accountListening;</span>
<a href="#l90.827"></a><span id="l90.827">     },</span>
<a href="#l90.828"></a><span id="l90.828">     accountListening(aStanza) {</span>
<a href="#l90.829"></a><span id="l90.829">       let id = aStanza.attributes.id;</span>
<a href="#l90.830"></a><span id="l90.830" class="difflineminus">-      if (id &amp;&amp; this.execHandler(id, aStanza))</span>
<a href="#l90.831"></a><span id="l90.831" class="difflineplus">+      if (id &amp;&amp; this.execHandler(id, aStanza)) {</span>
<a href="#l90.832"></a><span id="l90.832">         return;</span>
<a href="#l90.833"></a><span id="l90.833" class="difflineplus">+      }</span>
<a href="#l90.834"></a><span id="l90.834"> </span>
<a href="#l90.835"></a><span id="l90.835">       this._account.onXmppStanza(aStanza);</span>
<a href="#l90.836"></a><span id="l90.836">       let name = aStanza.qName;</span>
<a href="#l90.837"></a><span id="l90.837" class="difflineminus">-      if (name == &quot;presence&quot;)</span>
<a href="#l90.838"></a><span id="l90.838" class="difflineplus">+      if (name == &quot;presence&quot;) {</span>
<a href="#l90.839"></a><span id="l90.839">         this._account.onPresenceStanza(aStanza);</span>
<a href="#l90.840"></a><span id="l90.840" class="difflineminus">-      else if (name == &quot;message&quot;)</span>
<a href="#l90.841"></a><span id="l90.841" class="difflineplus">+      } else if (name == &quot;message&quot;) {</span>
<a href="#l90.842"></a><span id="l90.842">         this._account.onMessageStanza(aStanza);</span>
<a href="#l90.843"></a><span id="l90.843" class="difflineminus">-      else if (name == &quot;iq&quot;)</span>
<a href="#l90.844"></a><span id="l90.844" class="difflineplus">+      } else if (name == &quot;iq&quot;) {</span>
<a href="#l90.845"></a><span id="l90.845">         this._account.onIQStanza(aStanza);</span>
<a href="#l90.846"></a><span id="l90.846" class="difflineplus">+      }</span>
<a href="#l90.847"></a><span id="l90.847">     },</span>
<a href="#l90.848"></a><span id="l90.848">   },</span>
<a href="#l90.849"></a><span id="l90.849">   onXmppStanza(aStanza) {</span>
<a href="#l90.850"></a><span id="l90.850">     this.ERROR(&quot;should not be reached\n&quot;);</span>
<a href="#l90.851"></a><span id="l90.851">   },</span>
<a href="#l90.852"></a><span id="l90.852"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -1,100 +1,102 @@</span>
<a href="#l91.4"></a><span id="l91.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l91.5"></a><span id="l91.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l91.6"></a><span id="l91.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l91.7"></a><span id="l91.7"> </span>
<a href="#l91.8"></a><span id="l91.8"> this.EXPORTED_SYMBOLS = [&quot;Stanza&quot;, &quot;XMPPParser&quot;, &quot;SupportedFeatures&quot;];</span>
<a href="#l91.9"></a><span id="l91.9"> </span>
<a href="#l91.10"></a><span id="l91.10"> /* eslint-disable key-spacing */</span>
<a href="#l91.11"></a><span id="l91.11"> var NS = {</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-  xml                       : &quot;http://www.w3.org/XML/1998/namespace&quot;,</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineminus">-  xhtml                     : &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineminus">-  xhtml_im                  : &quot;http://jabber.org/protocol/xhtml-im&quot;,</span>
<a href="#l91.15"></a><span id="l91.15" class="difflineplus">+  xml: &quot;http://www.w3.org/XML/1998/namespace&quot;,</span>
<a href="#l91.16"></a><span id="l91.16" class="difflineplus">+  xhtml: &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l91.17"></a><span id="l91.17" class="difflineplus">+  xhtml_im: &quot;http://jabber.org/protocol/xhtml-im&quot;,</span>
<a href="#l91.18"></a><span id="l91.18"> </span>
<a href="#l91.19"></a><span id="l91.19">   // auth</span>
<a href="#l91.20"></a><span id="l91.20" class="difflineminus">-  client                    : &quot;jabber:client&quot;,</span>
<a href="#l91.21"></a><span id="l91.21" class="difflineminus">-  streams                   : &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l91.22"></a><span id="l91.22" class="difflineminus">-  stream                    : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;,</span>
<a href="#l91.23"></a><span id="l91.23" class="difflineminus">-  sasl                      : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l91.24"></a><span id="l91.24" class="difflineminus">-  tls                       : &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l91.25"></a><span id="l91.25" class="difflineminus">-  bind                      : &quot;urn:ietf:params:xml:ns:xmpp-bind&quot;,</span>
<a href="#l91.26"></a><span id="l91.26" class="difflineminus">-  session                   : &quot;urn:ietf:params:xml:ns:xmpp-session&quot;,</span>
<a href="#l91.27"></a><span id="l91.27" class="difflineminus">-  auth                      : &quot;jabber:iq:auth&quot;,</span>
<a href="#l91.28"></a><span id="l91.28" class="difflineminus">-  auth_feature              : &quot;http://jabber.org/features/iq-auth&quot;,</span>
<a href="#l91.29"></a><span id="l91.29" class="difflineminus">-  http_bind                 : &quot;http://jabber.org/protocol/httpbind&quot;,</span>
<a href="#l91.30"></a><span id="l91.30" class="difflineminus">-  http_auth                 : &quot;http://jabber.org/protocol/http-auth&quot;,</span>
<a href="#l91.31"></a><span id="l91.31" class="difflineminus">-  xbosh                     : &quot;urn:xmpp:xbosh&quot;,</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineplus">+  client: &quot;jabber:client&quot;,</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineplus">+  streams: &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l91.34"></a><span id="l91.34" class="difflineplus">+  stream: &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;,</span>
<a href="#l91.35"></a><span id="l91.35" class="difflineplus">+  sasl: &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l91.36"></a><span id="l91.36" class="difflineplus">+  tls: &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l91.37"></a><span id="l91.37" class="difflineplus">+  bind: &quot;urn:ietf:params:xml:ns:xmpp-bind&quot;,</span>
<a href="#l91.38"></a><span id="l91.38" class="difflineplus">+  session: &quot;urn:ietf:params:xml:ns:xmpp-session&quot;,</span>
<a href="#l91.39"></a><span id="l91.39" class="difflineplus">+  auth: &quot;jabber:iq:auth&quot;,</span>
<a href="#l91.40"></a><span id="l91.40" class="difflineplus">+  auth_feature: &quot;http://jabber.org/features/iq-auth&quot;,</span>
<a href="#l91.41"></a><span id="l91.41" class="difflineplus">+  http_bind: &quot;http://jabber.org/protocol/httpbind&quot;,</span>
<a href="#l91.42"></a><span id="l91.42" class="difflineplus">+  http_auth: &quot;http://jabber.org/protocol/http-auth&quot;,</span>
<a href="#l91.43"></a><span id="l91.43" class="difflineplus">+  xbosh: &quot;urn:xmpp:xbosh&quot;,</span>
<a href="#l91.44"></a><span id="l91.44"> </span>
<a href="#l91.45"></a><span id="l91.45" class="difflineminus">-  &quot;private&quot;                 : &quot;jabber:iq:private&quot;,</span>
<a href="#l91.46"></a><span id="l91.46" class="difflineminus">-  xdata                     : &quot;jabber:x:data&quot;,</span>
<a href="#l91.47"></a><span id="l91.47" class="difflineplus">+  private: &quot;jabber:iq:private&quot;,</span>
<a href="#l91.48"></a><span id="l91.48" class="difflineplus">+  xdata: &quot;jabber:x:data&quot;,</span>
<a href="#l91.49"></a><span id="l91.49"> </span>
<a href="#l91.50"></a><span id="l91.50">   // roster</span>
<a href="#l91.51"></a><span id="l91.51" class="difflineminus">-  roster                    : &quot;jabber:iq:roster&quot;,</span>
<a href="#l91.52"></a><span id="l91.52" class="difflineminus">-  roster_versioning         : &quot;urn:xmpp:features:rosterver&quot;,</span>
<a href="#l91.53"></a><span id="l91.53" class="difflineminus">-  roster_delimiter          : &quot;roster:delimiter&quot;,</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineplus">+  roster: &quot;jabber:iq:roster&quot;,</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineplus">+  roster_versioning: &quot;urn:xmpp:features:rosterver&quot;,</span>
<a href="#l91.56"></a><span id="l91.56" class="difflineplus">+  roster_delimiter: &quot;roster:delimiter&quot;,</span>
<a href="#l91.57"></a><span id="l91.57"> </span>
<a href="#l91.58"></a><span id="l91.58">   // privacy lists</span>
<a href="#l91.59"></a><span id="l91.59" class="difflineminus">-  privacy                   : &quot;jabber:iq:privacy&quot;,</span>
<a href="#l91.60"></a><span id="l91.60" class="difflineplus">+  privacy: &quot;jabber:iq:privacy&quot;,</span>
<a href="#l91.61"></a><span id="l91.61"> </span>
<a href="#l91.62"></a><span id="l91.62">   // discovering</span>
<a href="#l91.63"></a><span id="l91.63" class="difflineminus">-  disco_info                : &quot;http://jabber.org/protocol/disco#info&quot;,</span>
<a href="#l91.64"></a><span id="l91.64" class="difflineminus">-  disco_items               : &quot;http://jabber.org/protocol/disco#items&quot;,</span>
<a href="#l91.65"></a><span id="l91.65" class="difflineminus">-  caps                      : &quot;http://jabber.org/protocol/caps&quot;,</span>
<a href="#l91.66"></a><span id="l91.66" class="difflineplus">+  disco_info: &quot;http://jabber.org/protocol/disco#info&quot;,</span>
<a href="#l91.67"></a><span id="l91.67" class="difflineplus">+  disco_items: &quot;http://jabber.org/protocol/disco#items&quot;,</span>
<a href="#l91.68"></a><span id="l91.68" class="difflineplus">+  caps: &quot;http://jabber.org/protocol/caps&quot;,</span>
<a href="#l91.69"></a><span id="l91.69"> </span>
<a href="#l91.70"></a><span id="l91.70">   // addressing</span>
<a href="#l91.71"></a><span id="l91.71" class="difflineminus">-  address                   : &quot;http://jabber.org/protocol/address&quot;,</span>
<a href="#l91.72"></a><span id="l91.72" class="difflineplus">+  address: &quot;http://jabber.org/protocol/address&quot;,</span>
<a href="#l91.73"></a><span id="l91.73"> </span>
<a href="#l91.74"></a><span id="l91.74" class="difflineminus">-  muc_user                  : &quot;http://jabber.org/protocol/muc#user&quot;,</span>
<a href="#l91.75"></a><span id="l91.75" class="difflineminus">-  muc_owner                 : &quot;http://jabber.org/protocol/muc#owner&quot;,</span>
<a href="#l91.76"></a><span id="l91.76" class="difflineminus">-  muc_admin                 : &quot;http://jabber.org/protocol/muc#admin&quot;,</span>
<a href="#l91.77"></a><span id="l91.77" class="difflineminus">-  muc_rooms                 : &quot;http://jabber.org/protocol/muc#rooms&quot;,</span>
<a href="#l91.78"></a><span id="l91.78" class="difflineminus">-  conference                : &quot;jabber:x:conference&quot;,</span>
<a href="#l91.79"></a><span id="l91.79" class="difflineminus">-  muc                       : &quot;http://jabber.org/protocol/muc&quot;,</span>
<a href="#l91.80"></a><span id="l91.80" class="difflineminus">-  register                  : &quot;jabber:iq:register&quot;,</span>
<a href="#l91.81"></a><span id="l91.81" class="difflineminus">-  delay                     : &quot;urn:xmpp:delay&quot;,</span>
<a href="#l91.82"></a><span id="l91.82" class="difflineminus">-  delay_legacy              : &quot;jabber:x:delay&quot;,</span>
<a href="#l91.83"></a><span id="l91.83" class="difflineminus">-  bookmarks                 : &quot;storage:bookmarks&quot;,</span>
<a href="#l91.84"></a><span id="l91.84" class="difflineminus">-  chatstates                : &quot;http://jabber.org/protocol/chatstates&quot;,</span>
<a href="#l91.85"></a><span id="l91.85" class="difflineminus">-  event                     : &quot;jabber:x:event&quot;,</span>
<a href="#l91.86"></a><span id="l91.86" class="difflineminus">-  stanzas                   : &quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;,</span>
<a href="#l91.87"></a><span id="l91.87" class="difflineminus">-  vcard                     : &quot;vcard-temp&quot;,</span>
<a href="#l91.88"></a><span id="l91.88" class="difflineminus">-  vcard_update              : &quot;vcard-temp:x:update&quot;,</span>
<a href="#l91.89"></a><span id="l91.89" class="difflineminus">-  ping                      : &quot;urn:xmpp:ping&quot;,</span>
<a href="#l91.90"></a><span id="l91.90" class="difflineminus">-  carbons                   : &quot;urn:xmpp:carbons:2&quot;,</span>
<a href="#l91.91"></a><span id="l91.91" class="difflineplus">+  muc_user: &quot;http://jabber.org/protocol/muc#user&quot;,</span>
<a href="#l91.92"></a><span id="l91.92" class="difflineplus">+  muc_owner: &quot;http://jabber.org/protocol/muc#owner&quot;,</span>
<a href="#l91.93"></a><span id="l91.93" class="difflineplus">+  muc_admin: &quot;http://jabber.org/protocol/muc#admin&quot;,</span>
<a href="#l91.94"></a><span id="l91.94" class="difflineplus">+  muc_rooms: &quot;http://jabber.org/protocol/muc#rooms&quot;,</span>
<a href="#l91.95"></a><span id="l91.95" class="difflineplus">+  conference: &quot;jabber:x:conference&quot;,</span>
<a href="#l91.96"></a><span id="l91.96" class="difflineplus">+  muc: &quot;http://jabber.org/protocol/muc&quot;,</span>
<a href="#l91.97"></a><span id="l91.97" class="difflineplus">+  register: &quot;jabber:iq:register&quot;,</span>
<a href="#l91.98"></a><span id="l91.98" class="difflineplus">+  delay: &quot;urn:xmpp:delay&quot;,</span>
<a href="#l91.99"></a><span id="l91.99" class="difflineplus">+  delay_legacy: &quot;jabber:x:delay&quot;,</span>
<a href="#l91.100"></a><span id="l91.100" class="difflineplus">+  bookmarks: &quot;storage:bookmarks&quot;,</span>
<a href="#l91.101"></a><span id="l91.101" class="difflineplus">+  chatstates: &quot;http://jabber.org/protocol/chatstates&quot;,</span>
<a href="#l91.102"></a><span id="l91.102" class="difflineplus">+  event: &quot;jabber:x:event&quot;,</span>
<a href="#l91.103"></a><span id="l91.103" class="difflineplus">+  stanzas: &quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;,</span>
<a href="#l91.104"></a><span id="l91.104" class="difflineplus">+  vcard: &quot;vcard-temp&quot;,</span>
<a href="#l91.105"></a><span id="l91.105" class="difflineplus">+  vcard_update: &quot;vcard-temp:x:update&quot;,</span>
<a href="#l91.106"></a><span id="l91.106" class="difflineplus">+  ping: &quot;urn:xmpp:ping&quot;,</span>
<a href="#l91.107"></a><span id="l91.107" class="difflineplus">+  carbons: &quot;urn:xmpp:carbons:2&quot;,</span>
<a href="#l91.108"></a><span id="l91.108"> </span>
<a href="#l91.109"></a><span id="l91.109" class="difflineminus">-  geoloc                    : &quot;http://jabber.org/protocol/geoloc&quot;,</span>
<a href="#l91.110"></a><span id="l91.110" class="difflineminus">-  geoloc_notify             : &quot;http://jabber.org/protocol/geoloc+notify&quot;,</span>
<a href="#l91.111"></a><span id="l91.111" class="difflineminus">-  mood                      : &quot;http://jabber.org/protocol/mood&quot;,</span>
<a href="#l91.112"></a><span id="l91.112" class="difflineminus">-  tune                      : &quot;http://jabber.org/protocol/tune&quot;,</span>
<a href="#l91.113"></a><span id="l91.113" class="difflineminus">-  nick                      : &quot;http://jabber.org/protocol/nick&quot;,</span>
<a href="#l91.114"></a><span id="l91.114" class="difflineminus">-  nick_notify               : &quot;http://jabber.org/protocol/nick+notify&quot;,</span>
<a href="#l91.115"></a><span id="l91.115" class="difflineminus">-  activity                  : &quot;http://jabber.org/protocol/activity&quot;,</span>
<a href="#l91.116"></a><span id="l91.116" class="difflineminus">-  rsm                       : &quot;http://jabber.org/protocol/rsm&quot;,</span>
<a href="#l91.117"></a><span id="l91.117" class="difflineminus">-  last                      : &quot;jabber:iq:last&quot;,</span>
<a href="#l91.118"></a><span id="l91.118" class="difflineminus">-  version                   : &quot;jabber:iq:version&quot;,</span>
<a href="#l91.119"></a><span id="l91.119" class="difflineminus">-  avatar_data               : &quot;urn:xmpp:avatar:data&quot;,</span>
<a href="#l91.120"></a><span id="l91.120" class="difflineminus">-  avatar_data_notify        : &quot;urn:xmpp:avatar:data+notify&quot;,</span>
<a href="#l91.121"></a><span id="l91.121" class="difflineminus">-  avatar_metadata           : &quot;urn:xmpp:avatar:metadata&quot;,</span>
<a href="#l91.122"></a><span id="l91.122" class="difflineminus">-  avatar_metadata_notify    : &quot;urn:xmpp:avatar:metadata+notify&quot;,</span>
<a href="#l91.123"></a><span id="l91.123" class="difflineminus">-  pubsub                    : &quot;http://jabber.org/protocol/pubsub&quot;,</span>
<a href="#l91.124"></a><span id="l91.124" class="difflineminus">-  pubsub_event              : &quot;http://jabber.org/protocol/pubsub#event&quot;,</span>
<a href="#l91.125"></a><span id="l91.125" class="difflineplus">+  geoloc: &quot;http://jabber.org/protocol/geoloc&quot;,</span>
<a href="#l91.126"></a><span id="l91.126" class="difflineplus">+  geoloc_notify: &quot;http://jabber.org/protocol/geoloc+notify&quot;,</span>
<a href="#l91.127"></a><span id="l91.127" class="difflineplus">+  mood: &quot;http://jabber.org/protocol/mood&quot;,</span>
<a href="#l91.128"></a><span id="l91.128" class="difflineplus">+  tune: &quot;http://jabber.org/protocol/tune&quot;,</span>
<a href="#l91.129"></a><span id="l91.129" class="difflineplus">+  nick: &quot;http://jabber.org/protocol/nick&quot;,</span>
<a href="#l91.130"></a><span id="l91.130" class="difflineplus">+  nick_notify: &quot;http://jabber.org/protocol/nick+notify&quot;,</span>
<a href="#l91.131"></a><span id="l91.131" class="difflineplus">+  activity: &quot;http://jabber.org/protocol/activity&quot;,</span>
<a href="#l91.132"></a><span id="l91.132" class="difflineplus">+  rsm: &quot;http://jabber.org/protocol/rsm&quot;,</span>
<a href="#l91.133"></a><span id="l91.133" class="difflineplus">+  last: &quot;jabber:iq:last&quot;,</span>
<a href="#l91.134"></a><span id="l91.134" class="difflineplus">+  version: &quot;jabber:iq:version&quot;,</span>
<a href="#l91.135"></a><span id="l91.135" class="difflineplus">+  avatar_data: &quot;urn:xmpp:avatar:data&quot;,</span>
<a href="#l91.136"></a><span id="l91.136" class="difflineplus">+  avatar_data_notify: &quot;urn:xmpp:avatar:data+notify&quot;,</span>
<a href="#l91.137"></a><span id="l91.137" class="difflineplus">+  avatar_metadata: &quot;urn:xmpp:avatar:metadata&quot;,</span>
<a href="#l91.138"></a><span id="l91.138" class="difflineplus">+  avatar_metadata_notify: &quot;urn:xmpp:avatar:metadata+notify&quot;,</span>
<a href="#l91.139"></a><span id="l91.139" class="difflineplus">+  pubsub: &quot;http://jabber.org/protocol/pubsub&quot;,</span>
<a href="#l91.140"></a><span id="l91.140" class="difflineplus">+  pubsub_event: &quot;http://jabber.org/protocol/pubsub#event&quot;,</span>
<a href="#l91.141"></a><span id="l91.141"> };</span>
<a href="#l91.142"></a><span id="l91.142"> </span>
<a href="#l91.143"></a><span id="l91.143"> var TOP_LEVEL_ELEMENTS = {</span>
<a href="#l91.144"></a><span id="l91.144" class="difflineminus">-  &quot;message&quot;             : &quot;jabber:client&quot;,</span>
<a href="#l91.145"></a><span id="l91.145" class="difflineminus">-  &quot;presence&quot;            : &quot;jabber:client&quot;,</span>
<a href="#l91.146"></a><span id="l91.146" class="difflineminus">-  &quot;iq&quot;                  : &quot;jabber:client&quot;,</span>
<a href="#l91.147"></a><span id="l91.147" class="difflineminus">-  &quot;stream:features&quot;     : &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l91.148"></a><span id="l91.148" class="difflineminus">-  &quot;proceed&quot;             : &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l91.149"></a><span id="l91.149" class="difflineminus">-  &quot;failure&quot;             : [&quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l91.150"></a><span id="l91.150" class="difflineminus">-                           &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;],</span>
<a href="#l91.151"></a><span id="l91.151" class="difflineminus">-  &quot;success&quot;             : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l91.152"></a><span id="l91.152" class="difflineminus">-  &quot;challenge&quot;           : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l91.153"></a><span id="l91.153" class="difflineminus">-  &quot;error&quot;               : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;,</span>
<a href="#l91.154"></a><span id="l91.154" class="difflineplus">+  message: &quot;jabber:client&quot;,</span>
<a href="#l91.155"></a><span id="l91.155" class="difflineplus">+  presence: &quot;jabber:client&quot;,</span>
<a href="#l91.156"></a><span id="l91.156" class="difflineplus">+  iq: &quot;jabber:client&quot;,</span>
<a href="#l91.157"></a><span id="l91.157" class="difflineplus">+  &quot;stream:features&quot;: &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l91.158"></a><span id="l91.158" class="difflineplus">+  proceed: &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l91.159"></a><span id="l91.159" class="difflineplus">+  failure: [</span>
<a href="#l91.160"></a><span id="l91.160" class="difflineplus">+    &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l91.161"></a><span id="l91.161" class="difflineplus">+    &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l91.162"></a><span id="l91.162" class="difflineplus">+  ],</span>
<a href="#l91.163"></a><span id="l91.163" class="difflineplus">+  success: &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l91.164"></a><span id="l91.164" class="difflineplus">+  challenge: &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l91.165"></a><span id="l91.165" class="difflineplus">+  error: &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;,</span>
<a href="#l91.166"></a><span id="l91.166"> };</span>
<a href="#l91.167"></a><span id="l91.167"> /* eslint-enable key-spacing */</span>
<a href="#l91.168"></a><span id="l91.168"> </span>
<a href="#l91.169"></a><span id="l91.169"> // Features that we support in XMPP.</span>
<a href="#l91.170"></a><span id="l91.170"> // Don't forget to add your new features here.</span>
<a href="#l91.171"></a><span id="l91.171"> var SupportedFeatures = [</span>
<a href="#l91.172"></a><span id="l91.172">   NS.chatstates,</span>
<a href="#l91.173"></a><span id="l91.173">   NS.conference,</span>
<a href="#l91.174"></a><span id="l91.174" class="difflineat">@@ -111,213 +113,254 @@ var Stanza = {</span>
<a href="#l91.175"></a><span id="l91.175">   NS,</span>
<a href="#l91.176"></a><span id="l91.176"> </span>
<a href="#l91.177"></a><span id="l91.177">   /* Create a presence stanza */</span>
<a href="#l91.178"></a><span id="l91.178">   presence: (aAttr, aData) =&gt; Stanza.node(&quot;presence&quot;, null, aAttr, aData),</span>
<a href="#l91.179"></a><span id="l91.179"> </span>
<a href="#l91.180"></a><span id="l91.180">   /* Create a message stanza */</span>
<a href="#l91.181"></a><span id="l91.181">   message(aTo, aMsg, aState, aAttr = {}, aData = []) {</span>
<a href="#l91.182"></a><span id="l91.182">     aAttr.to = aTo;</span>
<a href="#l91.183"></a><span id="l91.183" class="difflineminus">-    if (!(&quot;type&quot; in aAttr))</span>
<a href="#l91.184"></a><span id="l91.184" class="difflineplus">+    if (!(&quot;type&quot; in aAttr)) {</span>
<a href="#l91.185"></a><span id="l91.185">       aAttr.type = &quot;chat&quot;;</span>
<a href="#l91.186"></a><span id="l91.186" class="difflineplus">+    }</span>
<a href="#l91.187"></a><span id="l91.187"> </span>
<a href="#l91.188"></a><span id="l91.188" class="difflineminus">-    if (aMsg)</span>
<a href="#l91.189"></a><span id="l91.189" class="difflineplus">+    if (aMsg) {</span>
<a href="#l91.190"></a><span id="l91.190">       aData.push(Stanza.node(&quot;body&quot;, null, null, aMsg));</span>
<a href="#l91.191"></a><span id="l91.191" class="difflineplus">+    }</span>
<a href="#l91.192"></a><span id="l91.192"> </span>
<a href="#l91.193"></a><span id="l91.193" class="difflineminus">-    if (aState)</span>
<a href="#l91.194"></a><span id="l91.194" class="difflineplus">+    if (aState) {</span>
<a href="#l91.195"></a><span id="l91.195">       aData.push(Stanza.node(aState, Stanza.NS.chatstates));</span>
<a href="#l91.196"></a><span id="l91.196" class="difflineplus">+    }</span>
<a href="#l91.197"></a><span id="l91.197"> </span>
<a href="#l91.198"></a><span id="l91.198">     return Stanza.node(&quot;message&quot;, null, aAttr, aData);</span>
<a href="#l91.199"></a><span id="l91.199">   },</span>
<a href="#l91.200"></a><span id="l91.200"> </span>
<a href="#l91.201"></a><span id="l91.201">   /* Create a iq stanza */</span>
<a href="#l91.202"></a><span id="l91.202">   iq(aType, aId, aTo, aData) {</span>
<a href="#l91.203"></a><span id="l91.203" class="difflineminus">-    let attrs = {type: aType};</span>
<a href="#l91.204"></a><span id="l91.204" class="difflineminus">-    if (aId)</span>
<a href="#l91.205"></a><span id="l91.205" class="difflineplus">+    let attrs = { type: aType };</span>
<a href="#l91.206"></a><span id="l91.206" class="difflineplus">+    if (aId) {</span>
<a href="#l91.207"></a><span id="l91.207">       attrs.id = aId;</span>
<a href="#l91.208"></a><span id="l91.208" class="difflineminus">-    if (aTo)</span>
<a href="#l91.209"></a><span id="l91.209" class="difflineplus">+    }</span>
<a href="#l91.210"></a><span id="l91.210" class="difflineplus">+    if (aTo) {</span>
<a href="#l91.211"></a><span id="l91.211">       attrs.to = aTo;</span>
<a href="#l91.212"></a><span id="l91.212" class="difflineplus">+    }</span>
<a href="#l91.213"></a><span id="l91.213">     return this.node(&quot;iq&quot;, null, attrs, aData);</span>
<a href="#l91.214"></a><span id="l91.214">   },</span>
<a href="#l91.215"></a><span id="l91.215"> </span>
<a href="#l91.216"></a><span id="l91.216">   /* Create a XML node */</span>
<a href="#l91.217"></a><span id="l91.217">   node(aName, aNs, aAttr, aData) {</span>
<a href="#l91.218"></a><span id="l91.218">     let node = new XMLNode(null, aNs, aName, aName, aAttr);</span>
<a href="#l91.219"></a><span id="l91.219">     if (aData) {</span>
<a href="#l91.220"></a><span id="l91.220" class="difflineminus">-      if (!Array.isArray(aData))</span>
<a href="#l91.221"></a><span id="l91.221" class="difflineplus">+      if (!Array.isArray(aData)) {</span>
<a href="#l91.222"></a><span id="l91.222">         aData = [aData];</span>
<a href="#l91.223"></a><span id="l91.223" class="difflineminus">-      for (let child of aData)</span>
<a href="#l91.224"></a><span id="l91.224" class="difflineminus">-        node[typeof(child) == &quot;string&quot; ? &quot;addText&quot; : &quot;addChild&quot;](child);</span>
<a href="#l91.225"></a><span id="l91.225" class="difflineplus">+      }</span>
<a href="#l91.226"></a><span id="l91.226" class="difflineplus">+      for (let child of aData) {</span>
<a href="#l91.227"></a><span id="l91.227" class="difflineplus">+        node[typeof child == &quot;string&quot; ? &quot;addText&quot; : &quot;addChild&quot;](child);</span>
<a href="#l91.228"></a><span id="l91.228" class="difflineplus">+      }</span>
<a href="#l91.229"></a><span id="l91.229">     }</span>
<a href="#l91.230"></a><span id="l91.230"> </span>
<a href="#l91.231"></a><span id="l91.231">     return node;</span>
<a href="#l91.232"></a><span id="l91.232">   },</span>
<a href="#l91.233"></a><span id="l91.233"> };</span>
<a href="#l91.234"></a><span id="l91.234"> </span>
<a href="#l91.235"></a><span id="l91.235"> /* Text node</span>
<a href="#l91.236"></a><span id="l91.236">  * Contains a text */</span>
<a href="#l91.237"></a><span id="l91.237"> function TextNode(aText) {</span>
<a href="#l91.238"></a><span id="l91.238">   this.text = aText;</span>
<a href="#l91.239"></a><span id="l91.239"> }</span>
<a href="#l91.240"></a><span id="l91.240"> TextNode.prototype = {</span>
<a href="#l91.241"></a><span id="l91.241" class="difflineminus">-  get type() { return &quot;text&quot;; },</span>
<a href="#l91.242"></a><span id="l91.242" class="difflineplus">+  get type() {</span>
<a href="#l91.243"></a><span id="l91.243" class="difflineplus">+    return &quot;text&quot;;</span>
<a href="#l91.244"></a><span id="l91.244" class="difflineplus">+  },</span>
<a href="#l91.245"></a><span id="l91.245"> </span>
<a href="#l91.246"></a><span id="l91.246">   append(aText) {</span>
<a href="#l91.247"></a><span id="l91.247">     this.text += aText;</span>
<a href="#l91.248"></a><span id="l91.248">   },</span>
<a href="#l91.249"></a><span id="l91.249"> </span>
<a href="#l91.250"></a><span id="l91.250">   /* For debug purposes, returns an indented (unencoded) string */</span>
<a href="#l91.251"></a><span id="l91.251" class="difflineminus">-  convertToString(aIndent) { return aIndent + this.text + &quot;\n&quot;; },</span>
<a href="#l91.252"></a><span id="l91.252" class="difflineplus">+  convertToString(aIndent) {</span>
<a href="#l91.253"></a><span id="l91.253" class="difflineplus">+    return aIndent + this.text + &quot;\n&quot;;</span>
<a href="#l91.254"></a><span id="l91.254" class="difflineplus">+  },</span>
<a href="#l91.255"></a><span id="l91.255"> </span>
<a href="#l91.256"></a><span id="l91.256">   /* Returns the encoded XML */</span>
<a href="#l91.257"></a><span id="l91.257">   getXML() {</span>
<a href="#l91.258"></a><span id="l91.258">     return Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l91.259"></a><span id="l91.259" class="difflineminus">-           .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l91.260"></a><span id="l91.260" class="difflineminus">-           .scanTXT(this.text, Ci.mozITXTToHTMLConv.kEntities);</span>
<a href="#l91.261"></a><span id="l91.261" class="difflineplus">+      .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l91.262"></a><span id="l91.262" class="difflineplus">+      .scanTXT(this.text, Ci.mozITXTToHTMLConv.kEntities);</span>
<a href="#l91.263"></a><span id="l91.263">   },</span>
<a href="#l91.264"></a><span id="l91.264"> </span>
<a href="#l91.265"></a><span id="l91.265">   /* To read the unencoded data. */</span>
<a href="#l91.266"></a><span id="l91.266" class="difflineminus">-  get innerText() { return this.text; },</span>
<a href="#l91.267"></a><span id="l91.267" class="difflineplus">+  get innerText() {</span>
<a href="#l91.268"></a><span id="l91.268" class="difflineplus">+    return this.text;</span>
<a href="#l91.269"></a><span id="l91.269" class="difflineplus">+  },</span>
<a href="#l91.270"></a><span id="l91.270"> };</span>
<a href="#l91.271"></a><span id="l91.271"> </span>
<a href="#l91.272"></a><span id="l91.272"> /* XML node */</span>
<a href="#l91.273"></a><span id="l91.273"> /* https://www.w3.org/TR/2008/REC-xml-20081126 */</span>
<a href="#l91.274"></a><span id="l91.274"> /* aUri is the namespace. */</span>
<a href="#l91.275"></a><span id="l91.275"> /* aLocalName must have value, otherwise throws. */</span>
<a href="#l91.276"></a><span id="l91.276"> /* aAttr can be instance of nsISAXAttributes or object */</span>
<a href="#l91.277"></a><span id="l91.277"> /* Example: &lt;f:a xmlns:f='g' d='1'&gt; is parsed to</span>
<a href="#l91.278"></a><span id="l91.278">    uri/namespace='g', localName='a', qName='f:a', attributes={d='1'} */</span>
<a href="#l91.279"></a><span id="l91.279" class="difflineminus">-function XMLNode(aParentNode, aUri, aLocalName, aQName = aLocalName,</span>
<a href="#l91.280"></a><span id="l91.280" class="difflineminus">-                 aAttr = {}) {</span>
<a href="#l91.281"></a><span id="l91.281" class="difflineminus">-  if (!aLocalName)</span>
<a href="#l91.282"></a><span id="l91.282" class="difflineplus">+function XMLNode(</span>
<a href="#l91.283"></a><span id="l91.283" class="difflineplus">+  aParentNode,</span>
<a href="#l91.284"></a><span id="l91.284" class="difflineplus">+  aUri,</span>
<a href="#l91.285"></a><span id="l91.285" class="difflineplus">+  aLocalName,</span>
<a href="#l91.286"></a><span id="l91.286" class="difflineplus">+  aQName = aLocalName,</span>
<a href="#l91.287"></a><span id="l91.287" class="difflineplus">+  aAttr = {}</span>
<a href="#l91.288"></a><span id="l91.288" class="difflineplus">+) {</span>
<a href="#l91.289"></a><span id="l91.289" class="difflineplus">+  if (!aLocalName) {</span>
<a href="#l91.290"></a><span id="l91.290">     throw new Error(&quot;aLocalName must have value&quot;);</span>
<a href="#l91.291"></a><span id="l91.291" class="difflineplus">+  }</span>
<a href="#l91.292"></a><span id="l91.292"> </span>
<a href="#l91.293"></a><span id="l91.293">   this._parentNode = aParentNode; // Used only for parsing</span>
<a href="#l91.294"></a><span id="l91.294">   this.uri = aUri;</span>
<a href="#l91.295"></a><span id="l91.295">   this.localName = aLocalName;</span>
<a href="#l91.296"></a><span id="l91.296">   this.qName = aQName;</span>
<a href="#l91.297"></a><span id="l91.297">   this.attributes = {};</span>
<a href="#l91.298"></a><span id="l91.298">   this.children = [];</span>
<a href="#l91.299"></a><span id="l91.299"> </span>
<a href="#l91.300"></a><span id="l91.300">   if (aAttr instanceof Ci.nsISAXAttributes) {</span>
<a href="#l91.301"></a><span id="l91.301" class="difflineminus">-    for (let i = 0; i &lt; aAttr.length; ++i)</span>
<a href="#l91.302"></a><span id="l91.302" class="difflineplus">+    for (let i = 0; i &lt; aAttr.length; ++i) {</span>
<a href="#l91.303"></a><span id="l91.303">       this.attributes[aAttr.getQName(i)] = aAttr.getValue(i);</span>
<a href="#l91.304"></a><span id="l91.304" class="difflineminus">-  }</span>
<a href="#l91.305"></a><span id="l91.305" class="difflineminus">-  else {</span>
<a href="#l91.306"></a><span id="l91.306" class="difflineplus">+    }</span>
<a href="#l91.307"></a><span id="l91.307" class="difflineplus">+  } else {</span>
<a href="#l91.308"></a><span id="l91.308">     for (let attributeName in aAttr) {</span>
<a href="#l91.309"></a><span id="l91.309">       // Each attribute specification has a name and a value.</span>
<a href="#l91.310"></a><span id="l91.310" class="difflineminus">-      if (aAttr[attributeName])</span>
<a href="#l91.311"></a><span id="l91.311" class="difflineplus">+      if (aAttr[attributeName]) {</span>
<a href="#l91.312"></a><span id="l91.312">         this.attributes[attributeName] = aAttr[attributeName];</span>
<a href="#l91.313"></a><span id="l91.313" class="difflineplus">+      }</span>
<a href="#l91.314"></a><span id="l91.314">     }</span>
<a href="#l91.315"></a><span id="l91.315">   }</span>
<a href="#l91.316"></a><span id="l91.316"> }</span>
<a href="#l91.317"></a><span id="l91.317"> XMLNode.prototype = {</span>
<a href="#l91.318"></a><span id="l91.318" class="difflineminus">-  get type() { return &quot;node&quot;; },</span>
<a href="#l91.319"></a><span id="l91.319" class="difflineplus">+  get type() {</span>
<a href="#l91.320"></a><span id="l91.320" class="difflineplus">+    return &quot;node&quot;;</span>
<a href="#l91.321"></a><span id="l91.321" class="difflineplus">+  },</span>
<a href="#l91.322"></a><span id="l91.322"> </span>
<a href="#l91.323"></a><span id="l91.323">   /* Add a new child node */</span>
<a href="#l91.324"></a><span id="l91.324">   addChild(aNode) {</span>
<a href="#l91.325"></a><span id="l91.325">     this.children.push(aNode);</span>
<a href="#l91.326"></a><span id="l91.326">   },</span>
<a href="#l91.327"></a><span id="l91.327"> </span>
<a href="#l91.328"></a><span id="l91.328">   /* Add text node */</span>
<a href="#l91.329"></a><span id="l91.329">   addText(aText) {</span>
<a href="#l91.330"></a><span id="l91.330">     let lastIndex = this.children.length - 1;</span>
<a href="#l91.331"></a><span id="l91.331" class="difflineminus">-    if (lastIndex &gt;= 0 &amp;&amp; this.children[lastIndex] instanceof TextNode)</span>
<a href="#l91.332"></a><span id="l91.332" class="difflineplus">+    if (lastIndex &gt;= 0 &amp;&amp; this.children[lastIndex] instanceof TextNode) {</span>
<a href="#l91.333"></a><span id="l91.333">       this.children[lastIndex].append(aText);</span>
<a href="#l91.334"></a><span id="l91.334" class="difflineminus">-    else</span>
<a href="#l91.335"></a><span id="l91.335" class="difflineplus">+    } else {</span>
<a href="#l91.336"></a><span id="l91.336">       this.children.push(new TextNode(aText));</span>
<a href="#l91.337"></a><span id="l91.337" class="difflineplus">+    }</span>
<a href="#l91.338"></a><span id="l91.338">   },</span>
<a href="#l91.339"></a><span id="l91.339"> </span>
<a href="#l91.340"></a><span id="l91.340">   /* Get child elements by namespace */</span>
<a href="#l91.341"></a><span id="l91.341">   getChildrenByNS(aNS) {</span>
<a href="#l91.342"></a><span id="l91.342">     return this.children.filter(c =&gt; c.uri == aNS);</span>
<a href="#l91.343"></a><span id="l91.343">   },</span>
<a href="#l91.344"></a><span id="l91.344"> </span>
<a href="#l91.345"></a><span id="l91.345">   /* Get the first element anywhere inside the node (including child nodes)</span>
<a href="#l91.346"></a><span id="l91.346">      that matches the query.</span>
<a href="#l91.347"></a><span id="l91.347">      A query consists of an array of localNames. */</span>
<a href="#l91.348"></a><span id="l91.348">   getElement(aQuery) {</span>
<a href="#l91.349"></a><span id="l91.349" class="difflineminus">-    if (aQuery.length == 0)</span>
<a href="#l91.350"></a><span id="l91.350" class="difflineplus">+    if (aQuery.length == 0) {</span>
<a href="#l91.351"></a><span id="l91.351">       return this;</span>
<a href="#l91.352"></a><span id="l91.352" class="difflineplus">+    }</span>
<a href="#l91.353"></a><span id="l91.353"> </span>
<a href="#l91.354"></a><span id="l91.354">     let nq = aQuery.slice(1);</span>
<a href="#l91.355"></a><span id="l91.355">     for (let child of this.children) {</span>
<a href="#l91.356"></a><span id="l91.356" class="difflineminus">-      if (child.type == &quot;text&quot; || child.localName != aQuery[0])</span>
<a href="#l91.357"></a><span id="l91.357" class="difflineplus">+      if (child.type == &quot;text&quot; || child.localName != aQuery[0]) {</span>
<a href="#l91.358"></a><span id="l91.358">         continue;</span>
<a href="#l91.359"></a><span id="l91.359" class="difflineplus">+      }</span>
<a href="#l91.360"></a><span id="l91.360">       let n = child.getElement(nq);</span>
<a href="#l91.361"></a><span id="l91.361" class="difflineminus">-      if (n)</span>
<a href="#l91.362"></a><span id="l91.362" class="difflineplus">+      if (n) {</span>
<a href="#l91.363"></a><span id="l91.363">         return n;</span>
<a href="#l91.364"></a><span id="l91.364" class="difflineplus">+      }</span>
<a href="#l91.365"></a><span id="l91.365">     }</span>
<a href="#l91.366"></a><span id="l91.366"> </span>
<a href="#l91.367"></a><span id="l91.367">     return null;</span>
<a href="#l91.368"></a><span id="l91.368">   },</span>
<a href="#l91.369"></a><span id="l91.369"> </span>
<a href="#l91.370"></a><span id="l91.370">   /* Get all elements of the node (including child nodes) that match the query.</span>
<a href="#l91.371"></a><span id="l91.371">      A query consists of an array of localNames. */</span>
<a href="#l91.372"></a><span id="l91.372">   getElements(aQuery) {</span>
<a href="#l91.373"></a><span id="l91.373" class="difflineminus">-    if (aQuery.length == 0)</span>
<a href="#l91.374"></a><span id="l91.374" class="difflineplus">+    if (aQuery.length == 0) {</span>
<a href="#l91.375"></a><span id="l91.375">       return [this];</span>
<a href="#l91.376"></a><span id="l91.376" class="difflineplus">+    }</span>
<a href="#l91.377"></a><span id="l91.377"> </span>
<a href="#l91.378"></a><span id="l91.378">     let c = this.getChildren(aQuery[0]);</span>
<a href="#l91.379"></a><span id="l91.379">     let nq = aQuery.slice(1);</span>
<a href="#l91.380"></a><span id="l91.380">     let res = [];</span>
<a href="#l91.381"></a><span id="l91.381">     for (let child of c) {</span>
<a href="#l91.382"></a><span id="l91.382">       let n = child.getElements(nq);</span>
<a href="#l91.383"></a><span id="l91.383">       res = res.concat(n);</span>
<a href="#l91.384"></a><span id="l91.384">     }</span>
<a href="#l91.385"></a><span id="l91.385"> </span>
<a href="#l91.386"></a><span id="l91.386">     return res;</span>
<a href="#l91.387"></a><span id="l91.387">   },</span>
<a href="#l91.388"></a><span id="l91.388"> </span>
<a href="#l91.389"></a><span id="l91.389">   /* Get immediate children by the node name */</span>
<a href="#l91.390"></a><span id="l91.390">   getChildren(aName) {</span>
<a href="#l91.391"></a><span id="l91.391" class="difflineminus">-    return this.children.filter((c) =&gt; (c.type != &quot;text&quot; &amp;&amp; c.localName == aName));</span>
<a href="#l91.392"></a><span id="l91.392" class="difflineplus">+    return this.children.filter(c =&gt; c.type != &quot;text&quot; &amp;&amp; c.localName == aName);</span>
<a href="#l91.393"></a><span id="l91.393">   },</span>
<a href="#l91.394"></a><span id="l91.394"> </span>
<a href="#l91.395"></a><span id="l91.395">   // Test if the node is a stanza and its namespace is valid.</span>
<a href="#l91.396"></a><span id="l91.396">   isXmppStanza() {</span>
<a href="#l91.397"></a><span id="l91.397" class="difflineminus">-    if (!TOP_LEVEL_ELEMENTS.hasOwnProperty(this.qName))</span>
<a href="#l91.398"></a><span id="l91.398" class="difflineplus">+    if (!TOP_LEVEL_ELEMENTS.hasOwnProperty(this.qName)) {</span>
<a href="#l91.399"></a><span id="l91.399">       return false;</span>
<a href="#l91.400"></a><span id="l91.400" class="difflineplus">+    }</span>
<a href="#l91.401"></a><span id="l91.401">     let ns = TOP_LEVEL_ELEMENTS[this.qName];</span>
<a href="#l91.402"></a><span id="l91.402">     return ns == this.uri || (Array.isArray(ns) &amp;&amp; ns.includes(this.uri));</span>
<a href="#l91.403"></a><span id="l91.403">   },</span>
<a href="#l91.404"></a><span id="l91.404"> </span>
<a href="#l91.405"></a><span id="l91.405">   /* Returns indented XML */</span>
<a href="#l91.406"></a><span id="l91.406">   convertToString(aIndent = &quot;&quot;) {</span>
<a href="#l91.407"></a><span id="l91.407">     let s =</span>
<a href="#l91.408"></a><span id="l91.408">       aIndent + &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l91.409"></a><span id="l91.409">     let content = &quot;&quot;;</span>
<a href="#l91.410"></a><span id="l91.410" class="difflineminus">-    for (let child of this.children)</span>
<a href="#l91.411"></a><span id="l91.411" class="difflineplus">+    for (let child of this.children) {</span>
<a href="#l91.412"></a><span id="l91.412">       content += child.convertToString(aIndent + &quot; &quot;);</span>
<a href="#l91.413"></a><span id="l91.413" class="difflineminus">-    return s + (content ? &quot;&gt;\n&quot; + content + aIndent + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;\n&quot;;</span>
<a href="#l91.414"></a><span id="l91.414" class="difflineplus">+    }</span>
<a href="#l91.415"></a><span id="l91.415" class="difflineplus">+    return (</span>
<a href="#l91.416"></a><span id="l91.416" class="difflineplus">+      s +</span>
<a href="#l91.417"></a><span id="l91.417" class="difflineplus">+      (content ? &quot;&gt;\n&quot; + content + aIndent + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) +</span>
<a href="#l91.418"></a><span id="l91.418" class="difflineplus">+      &quot;&gt;\n&quot;</span>
<a href="#l91.419"></a><span id="l91.419" class="difflineplus">+    );</span>
<a href="#l91.420"></a><span id="l91.420">   },</span>
<a href="#l91.421"></a><span id="l91.421"> </span>
<a href="#l91.422"></a><span id="l91.422">   /* Returns the XML */</span>
<a href="#l91.423"></a><span id="l91.423">   getXML() {</span>
<a href="#l91.424"></a><span id="l91.424">     let s = &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l91.425"></a><span id="l91.425">     let innerXML = this.innerXML;</span>
<a href="#l91.426"></a><span id="l91.426">     return s + (innerXML ? &quot;&gt;&quot; + innerXML + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;&quot;;</span>
<a href="#l91.427"></a><span id="l91.427">   },</span>
<a href="#l91.428"></a><span id="l91.428"> </span>
<a href="#l91.429"></a><span id="l91.429" class="difflineminus">-  get innerXML() { return this.children.map(c =&gt; c.getXML()).join(&quot;&quot;); },</span>
<a href="#l91.430"></a><span id="l91.430" class="difflineminus">-  get innerText() { return this.children.map(c =&gt; c.innerText).join(&quot;&quot;); },</span>
<a href="#l91.431"></a><span id="l91.431" class="difflineplus">+  get innerXML() {</span>
<a href="#l91.432"></a><span id="l91.432" class="difflineplus">+    return this.children.map(c =&gt; c.getXML()).join(&quot;&quot;);</span>
<a href="#l91.433"></a><span id="l91.433" class="difflineplus">+  },</span>
<a href="#l91.434"></a><span id="l91.434" class="difflineplus">+  get innerText() {</span>
<a href="#l91.435"></a><span id="l91.435" class="difflineplus">+    return this.children.map(c =&gt; c.innerText).join(&quot;&quot;);</span>
<a href="#l91.436"></a><span id="l91.436" class="difflineplus">+  },</span>
<a href="#l91.437"></a><span id="l91.437"> </span>
<a href="#l91.438"></a><span id="l91.438">   /* Private methods */</span>
<a href="#l91.439"></a><span id="l91.439" class="difflineminus">-  _getXmlns() { return this.uri ? &quot; xmlns=\&quot;&quot; + this.uri + &quot;\&quot;&quot; : &quot;&quot;; },</span>
<a href="#l91.440"></a><span id="l91.440" class="difflineplus">+  _getXmlns() {</span>
<a href="#l91.441"></a><span id="l91.441" class="difflineplus">+    return this.uri ? ' xmlns=&quot;' + this.uri + '&quot;' : &quot;&quot;;</span>
<a href="#l91.442"></a><span id="l91.442" class="difflineplus">+  },</span>
<a href="#l91.443"></a><span id="l91.443">   _getAttributeText() {</span>
<a href="#l91.444"></a><span id="l91.444">     let s = &quot;&quot;;</span>
<a href="#l91.445"></a><span id="l91.445" class="difflineminus">-    for (let name in this.attributes)</span>
<a href="#l91.446"></a><span id="l91.446" class="difflineminus">-      s += &quot; &quot; + name + &quot;=\&quot;&quot; + this.attributes[name] + &quot;\&quot;&quot;;</span>
<a href="#l91.447"></a><span id="l91.447" class="difflineplus">+    for (let name in this.attributes) {</span>
<a href="#l91.448"></a><span id="l91.448" class="difflineplus">+      s += &quot; &quot; + name + '=&quot;' + this.attributes[name] + '&quot;';</span>
<a href="#l91.449"></a><span id="l91.449" class="difflineplus">+    }</span>
<a href="#l91.450"></a><span id="l91.450">     return s;</span>
<a href="#l91.451"></a><span id="l91.451">   },</span>
<a href="#l91.452"></a><span id="l91.452"> };</span>
<a href="#l91.453"></a><span id="l91.453"> </span>
<a href="#l91.454"></a><span id="l91.454"> function XMPPParser(aListener) {</span>
<a href="#l91.455"></a><span id="l91.455" class="difflineminus">-  this._parser = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l91.456"></a><span id="l91.456" class="difflineminus">-                   .createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l91.457"></a><span id="l91.457" class="difflineplus">+  this._parser = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(</span>
<a href="#l91.458"></a><span id="l91.458" class="difflineplus">+    Ci.nsISAXXMLReader</span>
<a href="#l91.459"></a><span id="l91.459" class="difflineplus">+  );</span>
<a href="#l91.460"></a><span id="l91.460">   this._parser.contentHandler = this;</span>
<a href="#l91.461"></a><span id="l91.461">   this._parser.errorHandler = this;</span>
<a href="#l91.462"></a><span id="l91.462">   this._parser.parseAsync(null);</span>
<a href="#l91.463"></a><span id="l91.463">   this._listener = aListener;</span>
<a href="#l91.464"></a><span id="l91.464">   this._parser.onStartRequest(this._dummyRequest);</span>
<a href="#l91.465"></a><span id="l91.465"> }</span>
<a href="#l91.466"></a><span id="l91.466"> XMPPParser.prototype = {</span>
<a href="#l91.467"></a><span id="l91.467">   _destroyPending: false,</span>
<a href="#l91.468"></a><span id="l91.468" class="difflineat">@@ -334,125 +377,144 @@ XMPPParser.prototype = {</span>
<a href="#l91.469"></a><span id="l91.469">     this._parser.onStopRequest(this._dummyRequest, Cr.NS_OK);</span>
<a href="#l91.470"></a><span id="l91.470">     // Stopping the request causes parse errors (because we parsed</span>
<a href="#l91.471"></a><span id="l91.471">     // only partial XML documents?), so the error handler is still</span>
<a href="#l91.472"></a><span id="l91.472">     // needed to avoid the errors being reported to the error console.</span>
<a href="#l91.473"></a><span id="l91.473">     this._parser.errorHandler = null;</span>
<a href="#l91.474"></a><span id="l91.474">     delete this._parser;</span>
<a href="#l91.475"></a><span id="l91.475">   },</span>
<a href="#l91.476"></a><span id="l91.476">   _dummyRequest: {</span>
<a href="#l91.477"></a><span id="l91.477" class="difflineminus">-    cancel() { },</span>
<a href="#l91.478"></a><span id="l91.478" class="difflineminus">-    isPending() { },</span>
<a href="#l91.479"></a><span id="l91.479" class="difflineminus">-    resume() { },</span>
<a href="#l91.480"></a><span id="l91.480" class="difflineminus">-    suspend() { },</span>
<a href="#l91.481"></a><span id="l91.481" class="difflineplus">+    cancel() {},</span>
<a href="#l91.482"></a><span id="l91.482" class="difflineplus">+    isPending() {},</span>
<a href="#l91.483"></a><span id="l91.483" class="difflineplus">+    resume() {},</span>
<a href="#l91.484"></a><span id="l91.484" class="difflineplus">+    suspend() {},</span>
<a href="#l91.485"></a><span id="l91.485">   },</span>
<a href="#l91.486"></a><span id="l91.486"> </span>
<a href="#l91.487"></a><span id="l91.487">   _logReceivedData(aData) {</span>
<a href="#l91.488"></a><span id="l91.488">     this._listener.LOG(&quot;received:\n&quot; + aData);</span>
<a href="#l91.489"></a><span id="l91.489">   },</span>
<a href="#l91.490"></a><span id="l91.490">   _inOnDataAvailable: false,</span>
<a href="#l91.491"></a><span id="l91.491">   onDataAvailable(aInputStream, aOffset, aCount) {</span>
<a href="#l91.492"></a><span id="l91.492">     this._inOnDataAvailable = true;</span>
<a href="#l91.493"></a><span id="l91.493" class="difflineminus">-    this._parser.onDataAvailable(this._dummyRequest,</span>
<a href="#l91.494"></a><span id="l91.494" class="difflineminus">-                                 aInputStream, aOffset, aCount);</span>
<a href="#l91.495"></a><span id="l91.495" class="difflineplus">+    this._parser.onDataAvailable(</span>
<a href="#l91.496"></a><span id="l91.496" class="difflineplus">+      this._dummyRequest,</span>
<a href="#l91.497"></a><span id="l91.497" class="difflineplus">+      aInputStream,</span>
<a href="#l91.498"></a><span id="l91.498" class="difflineplus">+      aOffset,</span>
<a href="#l91.499"></a><span id="l91.499" class="difflineplus">+      aCount</span>
<a href="#l91.500"></a><span id="l91.500" class="difflineplus">+    );</span>
<a href="#l91.501"></a><span id="l91.501">     delete this._inOnDataAvailable;</span>
<a href="#l91.502"></a><span id="l91.502" class="difflineminus">-    if (this._destroyPending)</span>
<a href="#l91.503"></a><span id="l91.503" class="difflineplus">+    if (this._destroyPending) {</span>
<a href="#l91.504"></a><span id="l91.504">       this.destroy();</span>
<a href="#l91.505"></a><span id="l91.505" class="difflineplus">+    }</span>
<a href="#l91.506"></a><span id="l91.506">   },</span>
<a href="#l91.507"></a><span id="l91.507"> </span>
<a href="#l91.508"></a><span id="l91.508">   /* nsISAXContentHandler implementation */</span>
<a href="#l91.509"></a><span id="l91.509" class="difflineminus">-  startDocument() { },</span>
<a href="#l91.510"></a><span id="l91.510" class="difflineminus">-  endDocument() { },</span>
<a href="#l91.511"></a><span id="l91.511" class="difflineplus">+  startDocument() {},</span>
<a href="#l91.512"></a><span id="l91.512" class="difflineplus">+  endDocument() {},</span>
<a href="#l91.513"></a><span id="l91.513"> </span>
<a href="#l91.514"></a><span id="l91.514">   startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l91.515"></a><span id="l91.515">     if (aQName == &quot;stream:stream&quot;) {</span>
<a href="#l91.516"></a><span id="l91.516">       let node = new XMLNode(null, aUri, aLocalName, aQName, aAttributes);</span>
<a href="#l91.517"></a><span id="l91.517">       // The node we created doesn't have children, but</span>
<a href="#l91.518"></a><span id="l91.518">       // &lt;stream:stream&gt; isn't closed, so avoid displaying /&gt; at the end.</span>
<a href="#l91.519"></a><span id="l91.519">       this._logReceivedData(node.convertToString().slice(0, -3) + &quot;&gt;\n&quot;);</span>
<a href="#l91.520"></a><span id="l91.520"> </span>
<a href="#l91.521"></a><span id="l91.521">       if (&quot;_node&quot; in this) {</span>
<a href="#l91.522"></a><span id="l91.522" class="difflineminus">-        this._listener.onXMLError(&quot;unexpected-stream-start&quot;,</span>
<a href="#l91.523"></a><span id="l91.523" class="difflineminus">-                                  &quot;stream:stream inside an already started stream&quot;);</span>
<a href="#l91.524"></a><span id="l91.524" class="difflineplus">+        this._listener.onXMLError(</span>
<a href="#l91.525"></a><span id="l91.525" class="difflineplus">+          &quot;unexpected-stream-start&quot;,</span>
<a href="#l91.526"></a><span id="l91.526" class="difflineplus">+          &quot;stream:stream inside an already started stream&quot;</span>
<a href="#l91.527"></a><span id="l91.527" class="difflineplus">+        );</span>
<a href="#l91.528"></a><span id="l91.528">         return;</span>
<a href="#l91.529"></a><span id="l91.529">       }</span>
<a href="#l91.530"></a><span id="l91.530"> </span>
<a href="#l91.531"></a><span id="l91.531">       this._listener._streamId = node.attributes.id;</span>
<a href="#l91.532"></a><span id="l91.532" class="difflineminus">-      if (!(&quot;version&quot; in node.attributes))</span>
<a href="#l91.533"></a><span id="l91.533" class="difflineplus">+      if (!(&quot;version&quot; in node.attributes)) {</span>
<a href="#l91.534"></a><span id="l91.534">         this._listener.startLegacyAuth();</span>
<a href="#l91.535"></a><span id="l91.535" class="difflineplus">+      }</span>
<a href="#l91.536"></a><span id="l91.536"> </span>
<a href="#l91.537"></a><span id="l91.537">       this._node = null;</span>
<a href="#l91.538"></a><span id="l91.538">       return;</span>
<a href="#l91.539"></a><span id="l91.539">     }</span>
<a href="#l91.540"></a><span id="l91.540"> </span>
<a href="#l91.541"></a><span id="l91.541">     let node = new XMLNode(this._node, aUri, aLocalName, aQName, aAttributes);</span>
<a href="#l91.542"></a><span id="l91.542" class="difflineminus">-    if (this._node)</span>
<a href="#l91.543"></a><span id="l91.543" class="difflineplus">+    if (this._node) {</span>
<a href="#l91.544"></a><span id="l91.544">       this._node.addChild(node);</span>
<a href="#l91.545"></a><span id="l91.545" class="difflineplus">+    }</span>
<a href="#l91.546"></a><span id="l91.546"> </span>
<a href="#l91.547"></a><span id="l91.547">     this._node = node;</span>
<a href="#l91.548"></a><span id="l91.548">   },</span>
<a href="#l91.549"></a><span id="l91.549"> </span>
<a href="#l91.550"></a><span id="l91.550">   characters(aCharacters) {</span>
<a href="#l91.551"></a><span id="l91.551">     if (!this._node) {</span>
<a href="#l91.552"></a><span id="l91.552">       // Ignore whitespace received on the stream to keep the connection alive.</span>
<a href="#l91.553"></a><span id="l91.553">       if (aCharacters.trim()) {</span>
<a href="#l91.554"></a><span id="l91.554" class="difflineminus">-        this._listener.onXMLError(&quot;parsing-characters&quot;,</span>
<a href="#l91.555"></a><span id="l91.555" class="difflineminus">-                                  &quot;No parent for characters: &quot; + aCharacters);</span>
<a href="#l91.556"></a><span id="l91.556" class="difflineplus">+        this._listener.onXMLError(</span>
<a href="#l91.557"></a><span id="l91.557" class="difflineplus">+          &quot;parsing-characters&quot;,</span>
<a href="#l91.558"></a><span id="l91.558" class="difflineplus">+          &quot;No parent for characters: &quot; + aCharacters</span>
<a href="#l91.559"></a><span id="l91.559" class="difflineplus">+        );</span>
<a href="#l91.560"></a><span id="l91.560">       }</span>
<a href="#l91.561"></a><span id="l91.561">       return;</span>
<a href="#l91.562"></a><span id="l91.562">     }</span>
<a href="#l91.563"></a><span id="l91.563"> </span>
<a href="#l91.564"></a><span id="l91.564">     this._node.addText(aCharacters);</span>
<a href="#l91.565"></a><span id="l91.565">   },</span>
<a href="#l91.566"></a><span id="l91.566"> </span>
<a href="#l91.567"></a><span id="l91.567">   endElement(aUri, aLocalName, aQName) {</span>
<a href="#l91.568"></a><span id="l91.568">     if (aQName == &quot;stream:stream&quot;) {</span>
<a href="#l91.569"></a><span id="l91.569">       this._logReceivedData(&quot;&lt;/stream:stream&gt;&quot;);</span>
<a href="#l91.570"></a><span id="l91.570">       delete this._node;</span>
<a href="#l91.571"></a><span id="l91.571">       return;</span>
<a href="#l91.572"></a><span id="l91.572">     }</span>
<a href="#l91.573"></a><span id="l91.573"> </span>
<a href="#l91.574"></a><span id="l91.574">     if (!this._node) {</span>
<a href="#l91.575"></a><span id="l91.575" class="difflineminus">-      this._listener.onXMLError(&quot;parsing-node&quot;,</span>
<a href="#l91.576"></a><span id="l91.576" class="difflineminus">-                                &quot;No parent for node : &quot; + aLocalName);</span>
<a href="#l91.577"></a><span id="l91.577" class="difflineplus">+      this._listener.onXMLError(</span>
<a href="#l91.578"></a><span id="l91.578" class="difflineplus">+        &quot;parsing-node&quot;,</span>
<a href="#l91.579"></a><span id="l91.579" class="difflineplus">+        &quot;No parent for node : &quot; + aLocalName</span>
<a href="#l91.580"></a><span id="l91.580" class="difflineplus">+      );</span>
<a href="#l91.581"></a><span id="l91.581">       return;</span>
<a href="#l91.582"></a><span id="l91.582">     }</span>
<a href="#l91.583"></a><span id="l91.583"> </span>
<a href="#l91.584"></a><span id="l91.584">     // RFC 6120 (8): XML Stanzas.</span>
<a href="#l91.585"></a><span id="l91.585">     // Checks if the node is the root and it's valid.</span>
<a href="#l91.586"></a><span id="l91.586">     if (!this._node._parentNode) {</span>
<a href="#l91.587"></a><span id="l91.587">       if (this._node.isXmppStanza()) {</span>
<a href="#l91.588"></a><span id="l91.588">         this._logReceivedData(this._node.convertToString());</span>
<a href="#l91.589"></a><span id="l91.589">         try {</span>
<a href="#l91.590"></a><span id="l91.590">           this._listener.onXmppStanza(this._node);</span>
<a href="#l91.591"></a><span id="l91.591">         } catch (e) {</span>
<a href="#l91.592"></a><span id="l91.592">           Cu.reportError(e);</span>
<a href="#l91.593"></a><span id="l91.593">           dump(e + &quot;\n&quot;);</span>
<a href="#l91.594"></a><span id="l91.594">         }</span>
<a href="#l91.595"></a><span id="l91.595" class="difflineminus">-      }</span>
<a href="#l91.596"></a><span id="l91.596" class="difflineminus">-      else {</span>
<a href="#l91.597"></a><span id="l91.597" class="difflineminus">-        this._listener.onXMLError(&quot;parsing-node&quot;,</span>
<a href="#l91.598"></a><span id="l91.598" class="difflineminus">-                                  &quot;Root node &quot; + aLocalName + &quot; is not valid.&quot;);</span>
<a href="#l91.599"></a><span id="l91.599" class="difflineplus">+      } else {</span>
<a href="#l91.600"></a><span id="l91.600" class="difflineplus">+        this._listener.onXMLError(</span>
<a href="#l91.601"></a><span id="l91.601" class="difflineplus">+          &quot;parsing-node&quot;,</span>
<a href="#l91.602"></a><span id="l91.602" class="difflineplus">+          &quot;Root node &quot; + aLocalName + &quot; is not valid.&quot;</span>
<a href="#l91.603"></a><span id="l91.603" class="difflineplus">+        );</span>
<a href="#l91.604"></a><span id="l91.604">       }</span>
<a href="#l91.605"></a><span id="l91.605">     }</span>
<a href="#l91.606"></a><span id="l91.606"> </span>
<a href="#l91.607"></a><span id="l91.607">     this._node = this._node._parentNode;</span>
<a href="#l91.608"></a><span id="l91.608">   },</span>
<a href="#l91.609"></a><span id="l91.609"> </span>
<a href="#l91.610"></a><span id="l91.610" class="difflineminus">-  processingInstruction(aTarget, aData) { },</span>
<a href="#l91.611"></a><span id="l91.611" class="difflineplus">+  processingInstruction(aTarget, aData) {},</span>
<a href="#l91.612"></a><span id="l91.612"> </span>
<a href="#l91.613"></a><span id="l91.613">   /* nsISAXErrorHandler implementation */</span>
<a href="#l91.614"></a><span id="l91.614">   error(aError) {</span>
<a href="#l91.615"></a><span id="l91.615" class="difflineminus">-    if (this._listener)</span>
<a href="#l91.616"></a><span id="l91.616" class="difflineplus">+    if (this._listener) {</span>
<a href="#l91.617"></a><span id="l91.617">       this._listener.onXMLError(&quot;parse-error&quot;, aError);</span>
<a href="#l91.618"></a><span id="l91.618" class="difflineplus">+    }</span>
<a href="#l91.619"></a><span id="l91.619">   },</span>
<a href="#l91.620"></a><span id="l91.620">   fatalError(aError) {</span>
<a href="#l91.621"></a><span id="l91.621" class="difflineminus">-    if (this._listener)</span>
<a href="#l91.622"></a><span id="l91.622" class="difflineplus">+    if (this._listener) {</span>
<a href="#l91.623"></a><span id="l91.623">       this._listener.onXMLError(&quot;parse-fatal-error&quot;, aError);</span>
<a href="#l91.624"></a><span id="l91.624" class="difflineplus">+    }</span>
<a href="#l91.625"></a><span id="l91.625">   },</span>
<a href="#l91.626"></a><span id="l91.626">   ignorableWarning(aError) {</span>
<a href="#l91.627"></a><span id="l91.627" class="difflineminus">-    if (this._listener)</span>
<a href="#l91.628"></a><span id="l91.628" class="difflineplus">+    if (this._listener) {</span>
<a href="#l91.629"></a><span id="l91.629">       this._listener.onXMLError(&quot;parse-warning&quot;, aError);</span>
<a href="#l91.630"></a><span id="l91.630" class="difflineplus">+    }</span>
<a href="#l91.631"></a><span id="l91.631">   },</span>
<a href="#l91.632"></a><span id="l91.632"> </span>
<a href="#l91.633"></a><span id="l91.633" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsISAXContentHandler&quot;,</span>
<a href="#l91.634"></a><span id="l91.634" class="difflineminus">-                                          &quot;nsISAXErrorHandler&quot;]),</span>
<a href="#l91.635"></a><span id="l91.635" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l91.636"></a><span id="l91.636" class="difflineplus">+    &quot;nsISAXContentHandler&quot;,</span>
<a href="#l91.637"></a><span id="l91.637" class="difflineplus">+    &quot;nsISAXErrorHandler&quot;,</span>
<a href="#l91.638"></a><span id="l91.638" class="difflineplus">+  ]),</span>
<a href="#l91.639"></a><span id="l91.639"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.js</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.js</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -26,61 +26,104 @@ var {</span>
<a href="#l92.4"></a><span id="l92.4">   TooltipInfo,</span>
<a href="#l92.5"></a><span id="l92.5"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l92.6"></a><span id="l92.6"> var {</span>
<a href="#l92.7"></a><span id="l92.7">   XMPPConversationPrototype,</span>
<a href="#l92.8"></a><span id="l92.8">   XMPPMUCConversationPrototype,</span>
<a href="#l92.9"></a><span id="l92.9">   XMPPAccountBuddyPrototype,</span>
<a href="#l92.10"></a><span id="l92.10">   XMPPAccountPrototype,</span>
<a href="#l92.11"></a><span id="l92.11"> } = ChromeUtils.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-var {</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineminus">-  XMPPSession,</span>
<a href="#l92.14"></a><span id="l92.14" class="difflineminus">-  XMPPDefaultResource,</span>
<a href="#l92.15"></a><span id="l92.15" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l92.16"></a><span id="l92.16" class="difflineplus">+var { XMPPSession, XMPPDefaultResource } = ChromeUtils.import(</span>
<a href="#l92.17"></a><span id="l92.17" class="difflineplus">+  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineplus">+);</span>
<a href="#l92.19"></a><span id="l92.19"> </span>
<a href="#l92.20"></a><span id="l92.20"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l92.21"></a><span id="l92.21">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l92.22"></a><span id="l92.22"> );</span>
<a href="#l92.23"></a><span id="l92.23"> </span>
<a href="#l92.24"></a><span id="l92.24"> function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l92.25"></a><span id="l92.25">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l92.26"></a><span id="l92.26"> }</span>
<a href="#l92.27"></a><span id="l92.27"> XMPPAccount.prototype = XMPPAccountPrototype;</span>
<a href="#l92.28"></a><span id="l92.28"> </span>
<a href="#l92.29"></a><span id="l92.29"> function XMPPProtocol() {</span>
<a href="#l92.30"></a><span id="l92.30">   ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l92.31"></a><span id="l92.31">   this.registerCommands();</span>
<a href="#l92.32"></a><span id="l92.32"> }</span>
<a href="#l92.33"></a><span id="l92.33"> XMPPProtocol.prototype = {</span>
<a href="#l92.34"></a><span id="l92.34">   __proto__: GenericProtocolPrototype,</span>
<a href="#l92.35"></a><span id="l92.35" class="difflineminus">-  get normalizedName() { return &quot;jabber&quot;; },</span>
<a href="#l92.36"></a><span id="l92.36" class="difflineminus">-  get name() { return &quot;XMPP&quot;; },</span>
<a href="#l92.37"></a><span id="l92.37" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-jabber/skin/&quot;; },</span>
<a href="#l92.38"></a><span id="l92.38" class="difflineminus">-  getAccount(aImAccount) { return new XMPPAccount(this, aImAccount); },</span>
<a href="#l92.39"></a><span id="l92.39" class="difflineplus">+  get normalizedName() {</span>
<a href="#l92.40"></a><span id="l92.40" class="difflineplus">+    return &quot;jabber&quot;;</span>
<a href="#l92.41"></a><span id="l92.41" class="difflineplus">+  },</span>
<a href="#l92.42"></a><span id="l92.42" class="difflineplus">+  get name() {</span>
<a href="#l92.43"></a><span id="l92.43" class="difflineplus">+    return &quot;XMPP&quot;;</span>
<a href="#l92.44"></a><span id="l92.44" class="difflineplus">+  },</span>
<a href="#l92.45"></a><span id="l92.45" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l92.46"></a><span id="l92.46" class="difflineplus">+    return &quot;chrome://prpl-jabber/skin/&quot;;</span>
<a href="#l92.47"></a><span id="l92.47" class="difflineplus">+  },</span>
<a href="#l92.48"></a><span id="l92.48" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l92.49"></a><span id="l92.49" class="difflineplus">+    return new XMPPAccount(this, aImAccount);</span>
<a href="#l92.50"></a><span id="l92.50" class="difflineplus">+  },</span>
<a href="#l92.51"></a><span id="l92.51"> </span>
<a href="#l92.52"></a><span id="l92.52">   usernameSplits: [</span>
<a href="#l92.53"></a><span id="l92.53" class="difflineminus">-    {get label() { return _(&quot;options.domain&quot;); }, separator: &quot;@&quot;,</span>
<a href="#l92.54"></a><span id="l92.54" class="difflineminus">-     defaultValue: &quot;jabber.org&quot;, reverse: true},</span>
<a href="#l92.55"></a><span id="l92.55" class="difflineplus">+    {</span>
<a href="#l92.56"></a><span id="l92.56" class="difflineplus">+      get label() {</span>
<a href="#l92.57"></a><span id="l92.57" class="difflineplus">+        return _(&quot;options.domain&quot;);</span>
<a href="#l92.58"></a><span id="l92.58" class="difflineplus">+      },</span>
<a href="#l92.59"></a><span id="l92.59" class="difflineplus">+      separator: &quot;@&quot;,</span>
<a href="#l92.60"></a><span id="l92.60" class="difflineplus">+      defaultValue: &quot;jabber.org&quot;,</span>
<a href="#l92.61"></a><span id="l92.61" class="difflineplus">+      reverse: true,</span>
<a href="#l92.62"></a><span id="l92.62" class="difflineplus">+    },</span>
<a href="#l92.63"></a><span id="l92.63">   ],</span>
<a href="#l92.64"></a><span id="l92.64"> </span>
<a href="#l92.65"></a><span id="l92.65">   options: {</span>
<a href="#l92.66"></a><span id="l92.66" class="difflineminus">-    resource: {get label() { return _(&quot;options.resource&quot;); }, default: &quot;&quot;},</span>
<a href="#l92.67"></a><span id="l92.67" class="difflineminus">-    priority: {get label() { return _(&quot;options.priority&quot;); }, default: 0},</span>
<a href="#l92.68"></a><span id="l92.68" class="difflineplus">+    resource: {</span>
<a href="#l92.69"></a><span id="l92.69" class="difflineplus">+      get label() {</span>
<a href="#l92.70"></a><span id="l92.70" class="difflineplus">+        return _(&quot;options.resource&quot;);</span>
<a href="#l92.71"></a><span id="l92.71" class="difflineplus">+      },</span>
<a href="#l92.72"></a><span id="l92.72" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l92.73"></a><span id="l92.73" class="difflineplus">+    },</span>
<a href="#l92.74"></a><span id="l92.74" class="difflineplus">+    priority: {</span>
<a href="#l92.75"></a><span id="l92.75" class="difflineplus">+      get label() {</span>
<a href="#l92.76"></a><span id="l92.76" class="difflineplus">+        return _(&quot;options.priority&quot;);</span>
<a href="#l92.77"></a><span id="l92.77" class="difflineplus">+      },</span>
<a href="#l92.78"></a><span id="l92.78" class="difflineplus">+      default: 0,</span>
<a href="#l92.79"></a><span id="l92.79" class="difflineplus">+    },</span>
<a href="#l92.80"></a><span id="l92.80">     connection_security: {</span>
<a href="#l92.81"></a><span id="l92.81" class="difflineminus">-      get label() { return _(&quot;options.connectionSecurity&quot;); },</span>
<a href="#l92.82"></a><span id="l92.82" class="difflineplus">+      get label() {</span>
<a href="#l92.83"></a><span id="l92.83" class="difflineplus">+        return _(&quot;options.connectionSecurity&quot;);</span>
<a href="#l92.84"></a><span id="l92.84" class="difflineplus">+      },</span>
<a href="#l92.85"></a><span id="l92.85">       listValues: {</span>
<a href="#l92.86"></a><span id="l92.86" class="difflineminus">-        get require_tls() { return _(&quot;options.connectionSecurity.requireEncryption&quot;); },</span>
<a href="#l92.87"></a><span id="l92.87" class="difflineminus">-        get opportunistic_tls() { return _(&quot;options.connectionSecurity.opportunisticTLS&quot;); },</span>
<a href="#l92.88"></a><span id="l92.88" class="difflineminus">-        get allow_unencrypted_plain_auth() { return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;); },</span>
<a href="#l92.89"></a><span id="l92.89" class="difflineplus">+        get require_tls() {</span>
<a href="#l92.90"></a><span id="l92.90" class="difflineplus">+          return _(&quot;options.connectionSecurity.requireEncryption&quot;);</span>
<a href="#l92.91"></a><span id="l92.91" class="difflineplus">+        },</span>
<a href="#l92.92"></a><span id="l92.92" class="difflineplus">+        get opportunistic_tls() {</span>
<a href="#l92.93"></a><span id="l92.93" class="difflineplus">+          return _(&quot;options.connectionSecurity.opportunisticTLS&quot;);</span>
<a href="#l92.94"></a><span id="l92.94" class="difflineplus">+        },</span>
<a href="#l92.95"></a><span id="l92.95" class="difflineplus">+        get allow_unencrypted_plain_auth() {</span>
<a href="#l92.96"></a><span id="l92.96" class="difflineplus">+          return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;);</span>
<a href="#l92.97"></a><span id="l92.97" class="difflineplus">+        },</span>
<a href="#l92.98"></a><span id="l92.98">         // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l92.99"></a><span id="l92.99">         // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l92.100"></a><span id="l92.100">       },</span>
<a href="#l92.101"></a><span id="l92.101">       default: &quot;require_tls&quot;,</span>
<a href="#l92.102"></a><span id="l92.102">     },</span>
<a href="#l92.103"></a><span id="l92.103" class="difflineminus">-    server: {get label() { return _(&quot;options.connectServer&quot;); }, default: &quot;&quot;},</span>
<a href="#l92.104"></a><span id="l92.104" class="difflineminus">-    port: {get label() { return _(&quot;options.connectPort&quot;); }, default: 5222},</span>
<a href="#l92.105"></a><span id="l92.105" class="difflineplus">+    server: {</span>
<a href="#l92.106"></a><span id="l92.106" class="difflineplus">+      get label() {</span>
<a href="#l92.107"></a><span id="l92.107" class="difflineplus">+        return _(&quot;options.connectServer&quot;);</span>
<a href="#l92.108"></a><span id="l92.108" class="difflineplus">+      },</span>
<a href="#l92.109"></a><span id="l92.109" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l92.110"></a><span id="l92.110" class="difflineplus">+    },</span>
<a href="#l92.111"></a><span id="l92.111" class="difflineplus">+    port: {</span>
<a href="#l92.112"></a><span id="l92.112" class="difflineplus">+      get label() {</span>
<a href="#l92.113"></a><span id="l92.113" class="difflineplus">+        return _(&quot;options.connectPort&quot;);</span>
<a href="#l92.114"></a><span id="l92.114" class="difflineplus">+      },</span>
<a href="#l92.115"></a><span id="l92.115" class="difflineplus">+      default: 5222,</span>
<a href="#l92.116"></a><span id="l92.116" class="difflineplus">+    },</span>
<a href="#l92.117"></a><span id="l92.117">   },</span>
<a href="#l92.118"></a><span id="l92.118" class="difflineminus">-  get chatHasTopic() { return true; },</span>
<a href="#l92.119"></a><span id="l92.119" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l92.120"></a><span id="l92.120" class="difflineplus">+    return true;</span>
<a href="#l92.121"></a><span id="l92.121" class="difflineplus">+  },</span>
<a href="#l92.122"></a><span id="l92.122"> </span>
<a href="#l92.123"></a><span id="l92.123">   classID: Components.ID(&quot;{dde786d1-6f59-43d0-9bc8-b505a757fb30}&quot;),</span>
<a href="#l92.124"></a><span id="l92.124"> };</span>
<a href="#l92.125"></a><span id="l92.125"> </span>
<a href="#l92.126"></a><span id="l92.126"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([XMPPProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -4,18 +4,18 @@</span>
<a href="#l93.4"></a><span id="l93.4"> </span>
<a href="#l93.5"></a><span id="l93.5"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l93.6"></a><span id="l93.6">   &quot;XMPPConversationPrototype&quot;,</span>
<a href="#l93.7"></a><span id="l93.7">   &quot;XMPPMUCConversationPrototype&quot;,</span>
<a href="#l93.8"></a><span id="l93.8">   &quot;XMPPAccountBuddyPrototype&quot;,</span>
<a href="#l93.9"></a><span id="l93.9">   &quot;XMPPAccountPrototype&quot;,</span>
<a href="#l93.10"></a><span id="l93.10"> ];</span>
<a href="#l93.11"></a><span id="l93.11"> </span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineminus">-const {Status} = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l93.14"></a><span id="l93.14" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l93.15"></a><span id="l93.15" class="difflineplus">+const { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l93.16"></a><span id="l93.16"> const {</span>
<a href="#l93.17"></a><span id="l93.17">   XPCOMUtils,</span>
<a href="#l93.18"></a><span id="l93.18">   setTimeout,</span>
<a href="#l93.19"></a><span id="l93.19">   clearTimeout,</span>
<a href="#l93.20"></a><span id="l93.20">   executeSoon,</span>
<a href="#l93.21"></a><span id="l93.21">   nsSimpleEnumerator,</span>
<a href="#l93.22"></a><span id="l93.22">   EmptyEnumerator,</span>
<a href="#l93.23"></a><span id="l93.23">   ClassInfo,</span>
<a href="#l93.24"></a><span id="l93.24" class="difflineat">@@ -24,37 +24,53 @@ const {</span>
<a href="#l93.25"></a><span id="l93.25"> var {</span>
<a href="#l93.26"></a><span id="l93.26">   GenericAccountPrototype,</span>
<a href="#l93.27"></a><span id="l93.27">   GenericAccountBuddyPrototype,</span>
<a href="#l93.28"></a><span id="l93.28">   GenericConvIMPrototype,</span>
<a href="#l93.29"></a><span id="l93.29">   GenericConvChatPrototype,</span>
<a href="#l93.30"></a><span id="l93.30">   GenericConversationPrototype,</span>
<a href="#l93.31"></a><span id="l93.31">   TooltipInfo,</span>
<a href="#l93.32"></a><span id="l93.32"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l93.33"></a><span id="l93.33" class="difflineminus">-const {NormalizedMap} = ChromeUtils.import(&quot;resource:///modules/NormalizedMap.jsm&quot;);</span>
<a href="#l93.34"></a><span id="l93.34" class="difflineminus">-var {</span>
<a href="#l93.35"></a><span id="l93.35" class="difflineminus">-  Stanza,</span>
<a href="#l93.36"></a><span id="l93.36" class="difflineminus">-  SupportedFeatures,</span>
<a href="#l93.37"></a><span id="l93.37" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l93.38"></a><span id="l93.38" class="difflineminus">-var {</span>
<a href="#l93.39"></a><span id="l93.39" class="difflineminus">-  XMPPSession,</span>
<a href="#l93.40"></a><span id="l93.40" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l93.41"></a><span id="l93.41" class="difflineminus">-</span>
<a href="#l93.42"></a><span id="l93.42" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;DownloadUtils&quot;,</span>
<a href="#l93.43"></a><span id="l93.43" class="difflineminus">-  &quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l93.44"></a><span id="l93.44" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;FileUtils&quot;,</span>
<a href="#l93.45"></a><span id="l93.45" class="difflineminus">-  &quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l93.46"></a><span id="l93.46" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l93.47"></a><span id="l93.47" class="difflineminus">-  &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l93.48"></a><span id="l93.48" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;imgTools&quot;,</span>
<a href="#l93.49"></a><span id="l93.49" class="difflineminus">-                                   &quot;@mozilla.org/image/tools;1&quot;,</span>
<a href="#l93.50"></a><span id="l93.50" class="difflineminus">-                                   &quot;imgITools&quot;);</span>
<a href="#l93.51"></a><span id="l93.51" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;UuidGenerator&quot;,</span>
<a href="#l93.52"></a><span id="l93.52" class="difflineminus">-                                   &quot;@mozilla.org/uuid-generator;1&quot;,</span>
<a href="#l93.53"></a><span id="l93.53" class="difflineminus">-                                   &quot;nsIUUIDGenerator&quot;);</span>
<a href="#l93.54"></a><span id="l93.54" class="difflineplus">+const { NormalizedMap } = ChromeUtils.import(</span>
<a href="#l93.55"></a><span id="l93.55" class="difflineplus">+  &quot;resource:///modules/NormalizedMap.jsm&quot;</span>
<a href="#l93.56"></a><span id="l93.56" class="difflineplus">+);</span>
<a href="#l93.57"></a><span id="l93.57" class="difflineplus">+var { Stanza, SupportedFeatures } = ChromeUtils.import(</span>
<a href="#l93.58"></a><span id="l93.58" class="difflineplus">+  &quot;resource:///modules/xmpp-xml.jsm&quot;</span>
<a href="#l93.59"></a><span id="l93.59" class="difflineplus">+);</span>
<a href="#l93.60"></a><span id="l93.60" class="difflineplus">+var { XMPPSession } = ChromeUtils.import(</span>
<a href="#l93.61"></a><span id="l93.61" class="difflineplus">+  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l93.62"></a><span id="l93.62" class="difflineplus">+);</span>
<a href="#l93.63"></a><span id="l93.63" class="difflineplus">+</span>
<a href="#l93.64"></a><span id="l93.64" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l93.65"></a><span id="l93.65" class="difflineplus">+  this,</span>
<a href="#l93.66"></a><span id="l93.66" class="difflineplus">+  &quot;DownloadUtils&quot;,</span>
<a href="#l93.67"></a><span id="l93.67" class="difflineplus">+  &quot;resource://gre/modules/DownloadUtils.jsm&quot;</span>
<a href="#l93.68"></a><span id="l93.68" class="difflineplus">+);</span>
<a href="#l93.69"></a><span id="l93.69" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l93.70"></a><span id="l93.70" class="difflineplus">+  this,</span>
<a href="#l93.71"></a><span id="l93.71" class="difflineplus">+  &quot;FileUtils&quot;,</span>
<a href="#l93.72"></a><span id="l93.72" class="difflineplus">+  &quot;resource://gre/modules/FileUtils.jsm&quot;</span>
<a href="#l93.73"></a><span id="l93.73" class="difflineplus">+);</span>
<a href="#l93.74"></a><span id="l93.74" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l93.75"></a><span id="l93.75" class="difflineplus">+  this,</span>
<a href="#l93.76"></a><span id="l93.76" class="difflineplus">+  &quot;NetUtil&quot;,</span>
<a href="#l93.77"></a><span id="l93.77" class="difflineplus">+  &quot;resource://gre/modules/NetUtil.jsm&quot;</span>
<a href="#l93.78"></a><span id="l93.78" class="difflineplus">+);</span>
<a href="#l93.79"></a><span id="l93.79" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l93.80"></a><span id="l93.80" class="difflineplus">+  this,</span>
<a href="#l93.81"></a><span id="l93.81" class="difflineplus">+  &quot;imgTools&quot;,</span>
<a href="#l93.82"></a><span id="l93.82" class="difflineplus">+  &quot;@mozilla.org/image/tools;1&quot;,</span>
<a href="#l93.83"></a><span id="l93.83" class="difflineplus">+  &quot;imgITools&quot;</span>
<a href="#l93.84"></a><span id="l93.84" class="difflineplus">+);</span>
<a href="#l93.85"></a><span id="l93.85" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l93.86"></a><span id="l93.86" class="difflineplus">+  this,</span>
<a href="#l93.87"></a><span id="l93.87" class="difflineplus">+  &quot;UuidGenerator&quot;,</span>
<a href="#l93.88"></a><span id="l93.88" class="difflineplus">+  &quot;@mozilla.org/uuid-generator;1&quot;,</span>
<a href="#l93.89"></a><span id="l93.89" class="difflineplus">+  &quot;nsIUUIDGenerator&quot;</span>
<a href="#l93.90"></a><span id="l93.90" class="difflineplus">+);</span>
<a href="#l93.91"></a><span id="l93.91"> </span>
<a href="#l93.92"></a><span id="l93.92"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l93.93"></a><span id="l93.93">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l93.94"></a><span id="l93.94"> );</span>
<a href="#l93.95"></a><span id="l93.95"> </span>
<a href="#l93.96"></a><span id="l93.96"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l93.97"></a><span id="l93.97">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l93.98"></a><span id="l93.98">   return aTxt =&gt; cs.scanTXT(aTxt, cs.kEntities);</span>
<a href="#l93.99"></a><span id="l93.99" class="difflineat">@@ -62,77 +78,87 @@ XPCOMUtils.defineLazyGetter(this, &quot;TXTTo</span>
<a href="#l93.100"></a><span id="l93.100"> </span>
<a href="#l93.101"></a><span id="l93.101"> // Parses the status from a presence stanza into an object of statusType,</span>
<a href="#l93.102"></a><span id="l93.102"> // statusText and idleSince.</span>
<a href="#l93.103"></a><span id="l93.103"> function parseStatus(aStanza) {</span>
<a href="#l93.104"></a><span id="l93.104">   let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l93.105"></a><span id="l93.105">   let show = aStanza.getElement([&quot;show&quot;]);</span>
<a href="#l93.106"></a><span id="l93.106">   if (show) {</span>
<a href="#l93.107"></a><span id="l93.107">     show = show.innerText;</span>
<a href="#l93.108"></a><span id="l93.108" class="difflineminus">-    if (show == &quot;away&quot;)</span>
<a href="#l93.109"></a><span id="l93.109" class="difflineplus">+    if (show == &quot;away&quot;) {</span>
<a href="#l93.110"></a><span id="l93.110">       statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l93.111"></a><span id="l93.111" class="difflineminus">-    else if (show == &quot;chat&quot;)</span>
<a href="#l93.112"></a><span id="l93.112" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_AVAILABLE; // FIXME</span>
<a href="#l93.113"></a><span id="l93.113" class="difflineminus">-    else if (show == &quot;dnd&quot;)</span>
<a href="#l93.114"></a><span id="l93.114" class="difflineplus">+    } else if (show == &quot;chat&quot;) {</span>
<a href="#l93.115"></a><span id="l93.115" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l93.116"></a><span id="l93.116" class="difflineplus">+    } // FIXME</span>
<a href="#l93.117"></a><span id="l93.117" class="difflineplus">+    else if (show == &quot;dnd&quot;) {</span>
<a href="#l93.118"></a><span id="l93.118">       statusType = Ci.imIStatusInfo.STATUS_UNAVAILABLE;</span>
<a href="#l93.119"></a><span id="l93.119" class="difflineminus">-    else if (show == &quot;xa&quot;)</span>
<a href="#l93.120"></a><span id="l93.120" class="difflineplus">+    } else if (show == &quot;xa&quot;) {</span>
<a href="#l93.121"></a><span id="l93.121">       statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l93.122"></a><span id="l93.122" class="difflineplus">+    }</span>
<a href="#l93.123"></a><span id="l93.123">   }</span>
<a href="#l93.124"></a><span id="l93.124"> </span>
<a href="#l93.125"></a><span id="l93.125">   let idleSince = 0;</span>
<a href="#l93.126"></a><span id="l93.126">   let date = _getDelay(aStanza);</span>
<a href="#l93.127"></a><span id="l93.127" class="difflineminus">-  if (date)</span>
<a href="#l93.128"></a><span id="l93.128" class="difflineplus">+  if (date) {</span>
<a href="#l93.129"></a><span id="l93.129">     idleSince = date.getTime();</span>
<a href="#l93.130"></a><span id="l93.130" class="difflineplus">+  }</span>
<a href="#l93.131"></a><span id="l93.131"> </span>
<a href="#l93.132"></a><span id="l93.132">   let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l93.133"></a><span id="l93.133">   if (query &amp;&amp; query.uri == Stanza.NS.last) {</span>
<a href="#l93.134"></a><span id="l93.134">     let now = Math.floor(Date.now() / 1000);</span>
<a href="#l93.135"></a><span id="l93.135">     idleSince = now - parseInt(query.attributes.seconds, 10);</span>
<a href="#l93.136"></a><span id="l93.136">     statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l93.137"></a><span id="l93.137">   }</span>
<a href="#l93.138"></a><span id="l93.138"> </span>
<a href="#l93.139"></a><span id="l93.139">   // Mark official Android clients as mobile.</span>
<a href="#l93.140"></a><span id="l93.140">   const kAndroidNodeURI = &quot;http://www.android.com/gtalk/client/caps&quot;;</span>
<a href="#l93.141"></a><span id="l93.141" class="difflineminus">-  if (aStanza.getChildrenByNS(Stanza.NS.caps)</span>
<a href="#l93.142"></a><span id="l93.142" class="difflineminus">-             .some(s =&gt; s.localName == &quot;c&quot; &amp;&amp;</span>
<a href="#l93.143"></a><span id="l93.143" class="difflineminus">-                        s.attributes.node == kAndroidNodeURI))</span>
<a href="#l93.144"></a><span id="l93.144" class="difflineplus">+  if (</span>
<a href="#l93.145"></a><span id="l93.145" class="difflineplus">+    aStanza</span>
<a href="#l93.146"></a><span id="l93.146" class="difflineplus">+      .getChildrenByNS(Stanza.NS.caps)</span>
<a href="#l93.147"></a><span id="l93.147" class="difflineplus">+      .some(s =&gt; s.localName == &quot;c&quot; &amp;&amp; s.attributes.node == kAndroidNodeURI)</span>
<a href="#l93.148"></a><span id="l93.148" class="difflineplus">+  ) {</span>
<a href="#l93.149"></a><span id="l93.149">     statusType = Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l93.150"></a><span id="l93.150" class="difflineplus">+  }</span>
<a href="#l93.151"></a><span id="l93.151"> </span>
<a href="#l93.152"></a><span id="l93.152">   let status = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l93.153"></a><span id="l93.153">   status = status ? status.innerText : &quot;&quot;;</span>
<a href="#l93.154"></a><span id="l93.154"> </span>
<a href="#l93.155"></a><span id="l93.155" class="difflineminus">-  return {statusType, statusText: status, idleSince};</span>
<a href="#l93.156"></a><span id="l93.156" class="difflineplus">+  return { statusType, statusText: status, idleSince };</span>
<a href="#l93.157"></a><span id="l93.157"> }</span>
<a href="#l93.158"></a><span id="l93.158"> </span>
<a href="#l93.159"></a><span id="l93.159"> // Returns a Date object for the delay value (stamp) in aStanza if it exists,</span>
<a href="#l93.160"></a><span id="l93.160"> // otherwise returns undefined.</span>
<a href="#l93.161"></a><span id="l93.161"> function _getDelay(aStanza) {</span>
<a href="#l93.162"></a><span id="l93.162">   // XEP-0203: Delayed Delivery.</span>
<a href="#l93.163"></a><span id="l93.163">   let date;</span>
<a href="#l93.164"></a><span id="l93.164">   let delay = aStanza.getElement([&quot;delay&quot;]);</span>
<a href="#l93.165"></a><span id="l93.165">   if (delay &amp;&amp; delay.uri == Stanza.NS.delay) {</span>
<a href="#l93.166"></a><span id="l93.166" class="difflineminus">-    if (delay.attributes.stamp)</span>
<a href="#l93.167"></a><span id="l93.167" class="difflineplus">+    if (delay.attributes.stamp) {</span>
<a href="#l93.168"></a><span id="l93.168">       date = new Date(delay.attributes.stamp);</span>
<a href="#l93.169"></a><span id="l93.169" class="difflineplus">+    }</span>
<a href="#l93.170"></a><span id="l93.170">   }</span>
<a href="#l93.171"></a><span id="l93.171" class="difflineminus">-  if (date &amp;&amp; isNaN(date.getTime()))</span>
<a href="#l93.172"></a><span id="l93.172" class="difflineplus">+  if (date &amp;&amp; isNaN(date.getTime())) {</span>
<a href="#l93.173"></a><span id="l93.173">     return undefined;</span>
<a href="#l93.174"></a><span id="l93.174" class="difflineplus">+  }</span>
<a href="#l93.175"></a><span id="l93.175"> </span>
<a href="#l93.176"></a><span id="l93.176">   return date;</span>
<a href="#l93.177"></a><span id="l93.177"> }</span>
<a href="#l93.178"></a><span id="l93.178"> </span>
<a href="#l93.179"></a><span id="l93.179"> // Writes aMsg in aConv as an outgoing message with optional date as the</span>
<a href="#l93.180"></a><span id="l93.180"> // message may be sent from another client.</span>
<a href="#l93.181"></a><span id="l93.181"> function _displaySentMsg(aConv, aMsg, aDate) {</span>
<a href="#l93.182"></a><span id="l93.182">   let who;</span>
<a href="#l93.183"></a><span id="l93.183" class="difflineminus">-  if (aConv._account._connection)</span>
<a href="#l93.184"></a><span id="l93.184" class="difflineplus">+  if (aConv._account._connection) {</span>
<a href="#l93.185"></a><span id="l93.185">     who = aConv._account._connection._jid.jid;</span>
<a href="#l93.186"></a><span id="l93.186" class="difflineminus">-  if (!who)</span>
<a href="#l93.187"></a><span id="l93.187" class="difflineplus">+  }</span>
<a href="#l93.188"></a><span id="l93.188" class="difflineplus">+  if (!who) {</span>
<a href="#l93.189"></a><span id="l93.189">     who = aConv._account.name;</span>
<a href="#l93.190"></a><span id="l93.190" class="difflineminus">-</span>
<a href="#l93.191"></a><span id="l93.191" class="difflineminus">-  let flags = {outgoing: true};</span>
<a href="#l93.192"></a><span id="l93.192" class="difflineplus">+  }</span>
<a href="#l93.193"></a><span id="l93.193" class="difflineplus">+</span>
<a href="#l93.194"></a><span id="l93.194" class="difflineplus">+  let flags = { outgoing: true };</span>
<a href="#l93.195"></a><span id="l93.195">   flags._alias = aConv.account.alias || aConv.account.statusInfo.displayName;</span>
<a href="#l93.196"></a><span id="l93.196"> </span>
<a href="#l93.197"></a><span id="l93.197">   if (aDate) {</span>
<a href="#l93.198"></a><span id="l93.198">     flags.time = aDate / 1000;</span>
<a href="#l93.199"></a><span id="l93.199">     flags.delayed = true;</span>
<a href="#l93.200"></a><span id="l93.200">   }</span>
<a href="#l93.201"></a><span id="l93.201">   aConv.writeMessage(who, aMsg, flags);</span>
<a href="#l93.202"></a><span id="l93.202"> }</span>
<a href="#l93.203"></a><span id="l93.203" class="difflineat">@@ -142,21 +168,27 @@ var kListRefreshInterval = 12 * 60 * 60 </span>
<a href="#l93.204"></a><span id="l93.204"> </span>
<a href="#l93.205"></a><span id="l93.205"> /* This is an ordered list, used to determine chat buddy flags:</span>
<a href="#l93.206"></a><span id="l93.206">  *  index &lt; member    -&gt; noFlags</span>
<a href="#l93.207"></a><span id="l93.207">  *  index = member    -&gt; voiced</span>
<a href="#l93.208"></a><span id="l93.208">  *          moderator -&gt; halfOp</span>
<a href="#l93.209"></a><span id="l93.209">  *          admin     -&gt; op</span>
<a href="#l93.210"></a><span id="l93.210">  *          owner     -&gt; founder</span>
<a href="#l93.211"></a><span id="l93.211">  */</span>
<a href="#l93.212"></a><span id="l93.212" class="difflineminus">-var kRoles = [&quot;outcast&quot;, &quot;visitor&quot;, &quot;participant&quot;, &quot;member&quot;, &quot;moderator&quot;,</span>
<a href="#l93.213"></a><span id="l93.213" class="difflineminus">-                &quot;admin&quot;, &quot;owner&quot;];</span>
<a href="#l93.214"></a><span id="l93.214" class="difflineminus">-</span>
<a href="#l93.215"></a><span id="l93.215" class="difflineminus">-function MUCParticipant(aNick, aJid, aPresenceStanza)</span>
<a href="#l93.216"></a><span id="l93.216" class="difflineminus">-{</span>
<a href="#l93.217"></a><span id="l93.217" class="difflineplus">+var kRoles = [</span>
<a href="#l93.218"></a><span id="l93.218" class="difflineplus">+  &quot;outcast&quot;,</span>
<a href="#l93.219"></a><span id="l93.219" class="difflineplus">+  &quot;visitor&quot;,</span>
<a href="#l93.220"></a><span id="l93.220" class="difflineplus">+  &quot;participant&quot;,</span>
<a href="#l93.221"></a><span id="l93.221" class="difflineplus">+  &quot;member&quot;,</span>
<a href="#l93.222"></a><span id="l93.222" class="difflineplus">+  &quot;moderator&quot;,</span>
<a href="#l93.223"></a><span id="l93.223" class="difflineplus">+  &quot;admin&quot;,</span>
<a href="#l93.224"></a><span id="l93.224" class="difflineplus">+  &quot;owner&quot;,</span>
<a href="#l93.225"></a><span id="l93.225" class="difflineplus">+];</span>
<a href="#l93.226"></a><span id="l93.226" class="difflineplus">+</span>
<a href="#l93.227"></a><span id="l93.227" class="difflineplus">+function MUCParticipant(aNick, aJid, aPresenceStanza) {</span>
<a href="#l93.228"></a><span id="l93.228">   this._jid = aJid;</span>
<a href="#l93.229"></a><span id="l93.229">   this.name = aNick;</span>
<a href="#l93.230"></a><span id="l93.230">   this.onPresenceStanza(aPresenceStanza);</span>
<a href="#l93.231"></a><span id="l93.231"> }</span>
<a href="#l93.232"></a><span id="l93.232"> MUCParticipant.prototype = {</span>
<a href="#l93.233"></a><span id="l93.233">   __proto__: ClassInfo(&quot;prplIConvChatBuddy&quot;, &quot;XMPP ConvChatBuddy object&quot;),</span>
<a href="#l93.234"></a><span id="l93.234"> </span>
<a href="#l93.235"></a><span id="l93.235">   buddy: false,</span>
<a href="#l93.236"></a><span id="l93.236" class="difflineat">@@ -164,52 +196,70 @@ MUCParticipant.prototype = {</span>
<a href="#l93.237"></a><span id="l93.237">   // The occupant jid of the participant which is of the form room@domain/nick.</span>
<a href="#l93.238"></a><span id="l93.238">   _jid: null,</span>
<a href="#l93.239"></a><span id="l93.239"> </span>
<a href="#l93.240"></a><span id="l93.240">   // The real jid of the participant which is of the form local@domain/resource.</span>
<a href="#l93.241"></a><span id="l93.241">   accountJid: null,</span>
<a href="#l93.242"></a><span id="l93.242"> </span>
<a href="#l93.243"></a><span id="l93.243">   statusType: null,</span>
<a href="#l93.244"></a><span id="l93.244">   statusText: null,</span>
<a href="#l93.245"></a><span id="l93.245" class="difflineminus">-  get alias() { return this.name; },</span>
<a href="#l93.246"></a><span id="l93.246" class="difflineplus">+  get alias() {</span>
<a href="#l93.247"></a><span id="l93.247" class="difflineplus">+    return this.name;</span>
<a href="#l93.248"></a><span id="l93.248" class="difflineplus">+  },</span>
<a href="#l93.249"></a><span id="l93.249"> </span>
<a href="#l93.250"></a><span id="l93.250">   role: 2, // &quot;participant&quot; by default</span>
<a href="#l93.251"></a><span id="l93.251"> </span>
<a href="#l93.252"></a><span id="l93.252">   // Called when a presence stanza is received for this participant.</span>
<a href="#l93.253"></a><span id="l93.253">   onPresenceStanza(aStanza) {</span>
<a href="#l93.254"></a><span id="l93.254">     let statusInfo = parseStatus(aStanza);</span>
<a href="#l93.255"></a><span id="l93.255">     this.statusType = statusInfo.statusType;</span>
<a href="#l93.256"></a><span id="l93.256">     this.statusText = statusInfo.statusText;</span>
<a href="#l93.257"></a><span id="l93.257"> </span>
<a href="#l93.258"></a><span id="l93.258" class="difflineminus">-    let x = aStanza.children.filter(child =&gt; child.localName == &quot;x&quot; &amp;&amp;</span>
<a href="#l93.259"></a><span id="l93.259" class="difflineminus">-                                             child.uri == Stanza.NS.muc_user);</span>
<a href="#l93.260"></a><span id="l93.260" class="difflineminus">-    if (x.length == 0)</span>
<a href="#l93.261"></a><span id="l93.261" class="difflineplus">+    let x = aStanza.children.filter(</span>
<a href="#l93.262"></a><span id="l93.262" class="difflineplus">+      child =&gt; child.localName == &quot;x&quot; &amp;&amp; child.uri == Stanza.NS.muc_user</span>
<a href="#l93.263"></a><span id="l93.263" class="difflineplus">+    );</span>
<a href="#l93.264"></a><span id="l93.264" class="difflineplus">+    if (x.length == 0) {</span>
<a href="#l93.265"></a><span id="l93.265">       return;</span>
<a href="#l93.266"></a><span id="l93.266" class="difflineplus">+    }</span>
<a href="#l93.267"></a><span id="l93.267"> </span>
<a href="#l93.268"></a><span id="l93.268">     // XEP-0045 (7.2.3): We only expect a single &lt;x/&gt; element of this namespace,</span>
<a href="#l93.269"></a><span id="l93.269">     // so we ignore any others.</span>
<a href="#l93.270"></a><span id="l93.270">     x = x[0];</span>
<a href="#l93.271"></a><span id="l93.271"> </span>
<a href="#l93.272"></a><span id="l93.272">     let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l93.273"></a><span id="l93.273" class="difflineminus">-    if (!item)</span>
<a href="#l93.274"></a><span id="l93.274" class="difflineplus">+    if (!item) {</span>
<a href="#l93.275"></a><span id="l93.275">       return;</span>
<a href="#l93.276"></a><span id="l93.276" class="difflineminus">-</span>
<a href="#l93.277"></a><span id="l93.277" class="difflineminus">-    this.role = Math.max(kRoles.indexOf(item.attributes.role),</span>
<a href="#l93.278"></a><span id="l93.278" class="difflineminus">-                         kRoles.indexOf(item.attributes.affiliation));</span>
<a href="#l93.279"></a><span id="l93.279" class="difflineplus">+    }</span>
<a href="#l93.280"></a><span id="l93.280" class="difflineplus">+</span>
<a href="#l93.281"></a><span id="l93.281" class="difflineplus">+    this.role = Math.max(</span>
<a href="#l93.282"></a><span id="l93.282" class="difflineplus">+      kRoles.indexOf(item.attributes.role),</span>
<a href="#l93.283"></a><span id="l93.283" class="difflineplus">+      kRoles.indexOf(item.attributes.affiliation)</span>
<a href="#l93.284"></a><span id="l93.284" class="difflineplus">+    );</span>
<a href="#l93.285"></a><span id="l93.285"> </span>
<a href="#l93.286"></a><span id="l93.286">     let accountJid = item.attributes.jid;</span>
<a href="#l93.287"></a><span id="l93.287" class="difflineminus">-    if (accountJid)</span>
<a href="#l93.288"></a><span id="l93.288" class="difflineplus">+    if (accountJid) {</span>
<a href="#l93.289"></a><span id="l93.289">       this.accountJid = accountJid;</span>
<a href="#l93.290"></a><span id="l93.290" class="difflineplus">+    }</span>
<a href="#l93.291"></a><span id="l93.291" class="difflineplus">+  },</span>
<a href="#l93.292"></a><span id="l93.292" class="difflineplus">+</span>
<a href="#l93.293"></a><span id="l93.293" class="difflineplus">+  get noFlags() {</span>
<a href="#l93.294"></a><span id="l93.294" class="difflineplus">+    return this.role &lt; kRoles.indexOf(&quot;member&quot;);</span>
<a href="#l93.295"></a><span id="l93.295">   },</span>
<a href="#l93.296"></a><span id="l93.296" class="difflineminus">-</span>
<a href="#l93.297"></a><span id="l93.297" class="difflineminus">-  get noFlags() { return this.role &lt; kRoles.indexOf(&quot;member&quot;); },</span>
<a href="#l93.298"></a><span id="l93.298" class="difflineminus">-  get voiced() { return this.role == kRoles.indexOf(&quot;member&quot;); },</span>
<a href="#l93.299"></a><span id="l93.299" class="difflineminus">-  get halfOp() { return this.role == kRoles.indexOf(&quot;moderator&quot;); },</span>
<a href="#l93.300"></a><span id="l93.300" class="difflineminus">-  get op() { return this.role == kRoles.indexOf(&quot;admin&quot;); },</span>
<a href="#l93.301"></a><span id="l93.301" class="difflineminus">-  get founder() { return this.role == kRoles.indexOf(&quot;owner&quot;); },</span>
<a href="#l93.302"></a><span id="l93.302" class="difflineplus">+  get voiced() {</span>
<a href="#l93.303"></a><span id="l93.303" class="difflineplus">+    return this.role == kRoles.indexOf(&quot;member&quot;);</span>
<a href="#l93.304"></a><span id="l93.304" class="difflineplus">+  },</span>
<a href="#l93.305"></a><span id="l93.305" class="difflineplus">+  get halfOp() {</span>
<a href="#l93.306"></a><span id="l93.306" class="difflineplus">+    return this.role == kRoles.indexOf(&quot;moderator&quot;);</span>
<a href="#l93.307"></a><span id="l93.307" class="difflineplus">+  },</span>
<a href="#l93.308"></a><span id="l93.308" class="difflineplus">+  get op() {</span>
<a href="#l93.309"></a><span id="l93.309" class="difflineplus">+    return this.role == kRoles.indexOf(&quot;admin&quot;);</span>
<a href="#l93.310"></a><span id="l93.310" class="difflineplus">+  },</span>
<a href="#l93.311"></a><span id="l93.311" class="difflineplus">+  get founder() {</span>
<a href="#l93.312"></a><span id="l93.312" class="difflineplus">+    return this.role == kRoles.indexOf(&quot;owner&quot;);</span>
<a href="#l93.313"></a><span id="l93.313" class="difflineplus">+  },</span>
<a href="#l93.314"></a><span id="l93.314">   typing: false,</span>
<a href="#l93.315"></a><span id="l93.315"> };</span>
<a href="#l93.316"></a><span id="l93.316"> </span>
<a href="#l93.317"></a><span id="l93.317"> // MUC (Multi-User Chat)</span>
<a href="#l93.318"></a><span id="l93.318"> var XMPPMUCConversationPrototype = {</span>
<a href="#l93.319"></a><span id="l93.319">   __proto__: GenericConvChatPrototype,</span>
<a href="#l93.320"></a><span id="l93.320">   // By default users are not in a MUC.</span>
<a href="#l93.321"></a><span id="l93.321">   _left: true,</span>
<a href="#l93.322"></a><span id="l93.322" class="difflineat">@@ -223,40 +273,65 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l93.323"></a><span id="l93.323">     GenericConvChatPrototype._init.call(this, aAccount, aJID, aNick);</span>
<a href="#l93.324"></a><span id="l93.324">   },</span>
<a href="#l93.325"></a><span id="l93.325"> </span>
<a href="#l93.326"></a><span id="l93.326">   _targetResource: &quot;&quot;,</span>
<a href="#l93.327"></a><span id="l93.327"> </span>
<a href="#l93.328"></a><span id="l93.328">   // True while we are rejoining a room previously parted by the user.</span>
<a href="#l93.329"></a><span id="l93.329">   _rejoined: false,</span>
<a href="#l93.330"></a><span id="l93.330"> </span>
<a href="#l93.331"></a><span id="l93.331" class="difflineminus">-  get topic() { return this._topic; },</span>
<a href="#l93.332"></a><span id="l93.332" class="difflineplus">+  get topic() {</span>
<a href="#l93.333"></a><span id="l93.333" class="difflineplus">+    return this._topic;</span>
<a href="#l93.334"></a><span id="l93.334" class="difflineplus">+  },</span>
<a href="#l93.335"></a><span id="l93.335">   set topic(aTopic) {</span>
<a href="#l93.336"></a><span id="l93.336">     // XEP-0045 (8.1): Modifying the room subject.</span>
<a href="#l93.337"></a><span id="l93.337">     let subject = Stanza.node(&quot;subject&quot;, null, null, aTopic.trim());</span>
<a href="#l93.338"></a><span id="l93.338" class="difflineminus">-    let s = Stanza.message(this.name, null, null, {type: &quot;groupchat&quot;}, subject);</span>
<a href="#l93.339"></a><span id="l93.339" class="difflineplus">+    let s = Stanza.message(</span>
<a href="#l93.340"></a><span id="l93.340" class="difflineplus">+      this.name,</span>
<a href="#l93.341"></a><span id="l93.341" class="difflineplus">+      null,</span>
<a href="#l93.342"></a><span id="l93.342" class="difflineplus">+      null,</span>
<a href="#l93.343"></a><span id="l93.343" class="difflineplus">+      { type: &quot;groupchat&quot; },</span>
<a href="#l93.344"></a><span id="l93.344" class="difflineplus">+      subject</span>
<a href="#l93.345"></a><span id="l93.345" class="difflineplus">+    );</span>
<a href="#l93.346"></a><span id="l93.346">     let notAuthorized = _(&quot;conversation.error.changeTopicFailedNotAuthorized&quot;);</span>
<a href="#l93.347"></a><span id="l93.347" class="difflineminus">-    this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l93.348"></a><span id="l93.348" class="difflineminus">-      forbidden: notAuthorized,</span>
<a href="#l93.349"></a><span id="l93.349" class="difflineminus">-      notAcceptable: notAuthorized,</span>
<a href="#l93.350"></a><span id="l93.350" class="difflineminus">-      itemNotFound: notAuthorized,</span>
<a href="#l93.351"></a><span id="l93.351" class="difflineminus">-    }, this));</span>
<a href="#l93.352"></a><span id="l93.352" class="difflineplus">+    this._account.sendStanza(</span>
<a href="#l93.353"></a><span id="l93.353" class="difflineplus">+      s,</span>
<a href="#l93.354"></a><span id="l93.354" class="difflineplus">+      this._account.handleErrors(</span>
<a href="#l93.355"></a><span id="l93.355" class="difflineplus">+        {</span>
<a href="#l93.356"></a><span id="l93.356" class="difflineplus">+          forbidden: notAuthorized,</span>
<a href="#l93.357"></a><span id="l93.357" class="difflineplus">+          notAcceptable: notAuthorized,</span>
<a href="#l93.358"></a><span id="l93.358" class="difflineplus">+          itemNotFound: notAuthorized,</span>
<a href="#l93.359"></a><span id="l93.359" class="difflineplus">+        },</span>
<a href="#l93.360"></a><span id="l93.360" class="difflineplus">+        this</span>
<a href="#l93.361"></a><span id="l93.361" class="difflineplus">+      )</span>
<a href="#l93.362"></a><span id="l93.362" class="difflineplus">+    );</span>
<a href="#l93.363"></a><span id="l93.363">   },</span>
<a href="#l93.364"></a><span id="l93.364" class="difflineminus">-  get topicSettable() { return true; },</span>
<a href="#l93.365"></a><span id="l93.365" class="difflineplus">+  get topicSettable() {</span>
<a href="#l93.366"></a><span id="l93.366" class="difflineplus">+    return true;</span>
<a href="#l93.367"></a><span id="l93.367" class="difflineplus">+  },</span>
<a href="#l93.368"></a><span id="l93.368"> </span>
<a href="#l93.369"></a><span id="l93.369">   /* Called when the user enters a chat message */</span>
<a href="#l93.370"></a><span id="l93.370">   sendMsg(aMsg) {</span>
<a href="#l93.371"></a><span id="l93.371">     // XEP-0045 (7.4): Sending a message to all occupants in a room.</span>
<a href="#l93.372"></a><span id="l93.372" class="difflineminus">-    let s = Stanza.message(this.name, aMsg, null, {type: &quot;groupchat&quot;});</span>
<a href="#l93.373"></a><span id="l93.373" class="difflineminus">-    let notInRoom = _(&quot;conversation.error.sendFailedAsNotInRoom&quot;,</span>
<a href="#l93.374"></a><span id="l93.374" class="difflineminus">-                      this.name, aMsg);</span>
<a href="#l93.375"></a><span id="l93.375" class="difflineminus">-    this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l93.376"></a><span id="l93.376" class="difflineminus">-      itemNotFound: notInRoom,</span>
<a href="#l93.377"></a><span id="l93.377" class="difflineminus">-      notAcceptable: notInRoom,</span>
<a href="#l93.378"></a><span id="l93.378" class="difflineminus">-    }, this));</span>
<a href="#l93.379"></a><span id="l93.379" class="difflineplus">+    let s = Stanza.message(this.name, aMsg, null, { type: &quot;groupchat&quot; });</span>
<a href="#l93.380"></a><span id="l93.380" class="difflineplus">+    let notInRoom = _(</span>
<a href="#l93.381"></a><span id="l93.381" class="difflineplus">+      &quot;conversation.error.sendFailedAsNotInRoom&quot;,</span>
<a href="#l93.382"></a><span id="l93.382" class="difflineplus">+      this.name,</span>
<a href="#l93.383"></a><span id="l93.383" class="difflineplus">+      aMsg</span>
<a href="#l93.384"></a><span id="l93.384" class="difflineplus">+    );</span>
<a href="#l93.385"></a><span id="l93.385" class="difflineplus">+    this._account.sendStanza(</span>
<a href="#l93.386"></a><span id="l93.386" class="difflineplus">+      s,</span>
<a href="#l93.387"></a><span id="l93.387" class="difflineplus">+      this._account.handleErrors(</span>
<a href="#l93.388"></a><span id="l93.388" class="difflineplus">+        {</span>
<a href="#l93.389"></a><span id="l93.389" class="difflineplus">+          itemNotFound: notInRoom,</span>
<a href="#l93.390"></a><span id="l93.390" class="difflineplus">+          notAcceptable: notInRoom,</span>
<a href="#l93.391"></a><span id="l93.391" class="difflineplus">+        },</span>
<a href="#l93.392"></a><span id="l93.392" class="difflineplus">+        this</span>
<a href="#l93.393"></a><span id="l93.393" class="difflineplus">+      )</span>
<a href="#l93.394"></a><span id="l93.394" class="difflineplus">+    );</span>
<a href="#l93.395"></a><span id="l93.395">   },</span>
<a href="#l93.396"></a><span id="l93.396"> </span>
<a href="#l93.397"></a><span id="l93.397">   /* Called by the account when a presence stanza is received for this muc */</span>
<a href="#l93.398"></a><span id="l93.398">   onPresenceStanza(aStanza) {</span>
<a href="#l93.399"></a><span id="l93.399">     let from = aStanza.attributes.from;</span>
<a href="#l93.400"></a><span id="l93.400">     let nick = this._account._parseJID(from).resource;</span>
<a href="#l93.401"></a><span id="l93.401">     let jid = this._account.normalize(from);</span>
<a href="#l93.402"></a><span id="l93.402">     let x = aStanza.getElements([&quot;x&quot;]).find(e =&gt; e.uri == Stanza.NS.muc_user);</span>
<a href="#l93.403"></a><span id="l93.403" class="difflineat">@@ -270,56 +345,64 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l93.404"></a><span id="l93.404">         case &quot;registration-required&quot;:</span>
<a href="#l93.405"></a><span id="l93.405">           // XEP-0045 (7.2.7): Members-Only Rooms.</span>
<a href="#l93.406"></a><span id="l93.406">           message = _(&quot;conversation.error.joinFailedNotAuthorized&quot;);</span>
<a href="#l93.407"></a><span id="l93.407">           break;</span>
<a href="#l93.408"></a><span id="l93.408">         case &quot;not-allowed&quot;:</span>
<a href="#l93.409"></a><span id="l93.409">           message = _(&quot;conversation.error.creationFailedNotAllowed&quot;);</span>
<a href="#l93.410"></a><span id="l93.410">           break;</span>
<a href="#l93.411"></a><span id="l93.411">         case &quot;remote-server-not-found&quot;:</span>
<a href="#l93.412"></a><span id="l93.412" class="difflineminus">-          message = _(&quot;conversation.error.joinFailedRemoteServerNotFound&quot;,</span>
<a href="#l93.413"></a><span id="l93.413" class="difflineminus">-                      this.name);</span>
<a href="#l93.414"></a><span id="l93.414" class="difflineplus">+          message = _(</span>
<a href="#l93.415"></a><span id="l93.415" class="difflineplus">+            &quot;conversation.error.joinFailedRemoteServerNotFound&quot;,</span>
<a href="#l93.416"></a><span id="l93.416" class="difflineplus">+            this.name</span>
<a href="#l93.417"></a><span id="l93.417" class="difflineplus">+          );</span>
<a href="#l93.418"></a><span id="l93.418">           break;</span>
<a href="#l93.419"></a><span id="l93.419">         case &quot;forbidden&quot;:</span>
<a href="#l93.420"></a><span id="l93.420">           // XEP-0045 (7.2.8): Banned users.</span>
<a href="#l93.421"></a><span id="l93.421">           message = _(&quot;conversation.error.joinForbidden&quot;, this.name);</span>
<a href="#l93.422"></a><span id="l93.422">           break;</span>
<a href="#l93.423"></a><span id="l93.423">         default:</span>
<a href="#l93.424"></a><span id="l93.424">           message = _(&quot;conversation.error.joinFailed&quot;, this.name);</span>
<a href="#l93.425"></a><span id="l93.425">           this.ERROR(&quot;Failed to join MUC: &quot; + aStanza.convertToString());</span>
<a href="#l93.426"></a><span id="l93.426">           break;</span>
<a href="#l93.427"></a><span id="l93.427">       }</span>
<a href="#l93.428"></a><span id="l93.428" class="difflineminus">-      this.writeMessage(this.name, message, {system: true, error: true});</span>
<a href="#l93.429"></a><span id="l93.429" class="difflineplus">+      this.writeMessage(this.name, message, { system: true, error: true });</span>
<a href="#l93.430"></a><span id="l93.430">       this.joining = false;</span>
<a href="#l93.431"></a><span id="l93.431">       return;</span>
<a href="#l93.432"></a><span id="l93.432">     }</span>
<a href="#l93.433"></a><span id="l93.433"> </span>
<a href="#l93.434"></a><span id="l93.434">     if (!x) {</span>
<a href="#l93.435"></a><span id="l93.435" class="difflineminus">-      this.WARN(&quot;Received a MUC presence stanza without an x element or &quot; +</span>
<a href="#l93.436"></a><span id="l93.436" class="difflineminus">-                &quot;with a namespace we don't handle.&quot;);</span>
<a href="#l93.437"></a><span id="l93.437" class="difflineplus">+      this.WARN(</span>
<a href="#l93.438"></a><span id="l93.438" class="difflineplus">+        &quot;Received a MUC presence stanza without an x element or &quot; +</span>
<a href="#l93.439"></a><span id="l93.439" class="difflineplus">+          &quot;with a namespace we don't handle.&quot;</span>
<a href="#l93.440"></a><span id="l93.440" class="difflineplus">+      );</span>
<a href="#l93.441"></a><span id="l93.441">       return;</span>
<a href="#l93.442"></a><span id="l93.442">     }</span>
<a href="#l93.443"></a><span id="l93.443">     let codes = x.getElements([&quot;status&quot;]).map(elt =&gt; elt.attributes.code);</span>
<a href="#l93.444"></a><span id="l93.444">     let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l93.445"></a><span id="l93.445"> </span>
<a href="#l93.446"></a><span id="l93.446">     // Changes the nickname of a participant for this muc.</span>
<a href="#l93.447"></a><span id="l93.447">     let changeNick = () =&gt; {</span>
<a href="#l93.448"></a><span id="l93.448">       if (!item || !item.attributes.nick) {</span>
<a href="#l93.449"></a><span id="l93.449" class="difflineminus">-        this.WARN(&quot;Received a MUC presence code 303 or 210 stanza without an &quot; +</span>
<a href="#l93.450"></a><span id="l93.450" class="difflineminus">-                  &quot;item element or a nick attribute.&quot;);</span>
<a href="#l93.451"></a><span id="l93.451" class="difflineplus">+        this.WARN(</span>
<a href="#l93.452"></a><span id="l93.452" class="difflineplus">+          &quot;Received a MUC presence code 303 or 210 stanza without an &quot; +</span>
<a href="#l93.453"></a><span id="l93.453" class="difflineplus">+            &quot;item element or a nick attribute.&quot;</span>
<a href="#l93.454"></a><span id="l93.454" class="difflineplus">+        );</span>
<a href="#l93.455"></a><span id="l93.455">         return;</span>
<a href="#l93.456"></a><span id="l93.456">       }</span>
<a href="#l93.457"></a><span id="l93.457">       let newNick = item.attributes.nick;</span>
<a href="#l93.458"></a><span id="l93.458">       this.updateNick(nick, newNick, nick == this.nick);</span>
<a href="#l93.459"></a><span id="l93.459">     };</span>
<a href="#l93.460"></a><span id="l93.460"> </span>
<a href="#l93.461"></a><span id="l93.461">     if (aStanza.attributes.type == &quot;unavailable&quot;) {</span>
<a href="#l93.462"></a><span id="l93.462">       if (!this._participants.has(nick)) {</span>
<a href="#l93.463"></a><span id="l93.463" class="difflineminus">-        this.WARN(&quot;received unavailable presence for an unknown MUC participant: &quot; +</span>
<a href="#l93.464"></a><span id="l93.464" class="difflineminus">-                  from);</span>
<a href="#l93.465"></a><span id="l93.465" class="difflineplus">+        this.WARN(</span>
<a href="#l93.466"></a><span id="l93.466" class="difflineplus">+          &quot;received unavailable presence for an unknown MUC participant: &quot; +</span>
<a href="#l93.467"></a><span id="l93.467" class="difflineplus">+            from</span>
<a href="#l93.468"></a><span id="l93.468" class="difflineplus">+        );</span>
<a href="#l93.469"></a><span id="l93.469">         return;</span>
<a href="#l93.470"></a><span id="l93.470">       }</span>
<a href="#l93.471"></a><span id="l93.471">       if (codes.includes(&quot;303&quot;)) {</span>
<a href="#l93.472"></a><span id="l93.472">         // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l93.473"></a><span id="l93.473">         // Service Updates Nick for user.</span>
<a href="#l93.474"></a><span id="l93.474">         changeNick();</span>
<a href="#l93.475"></a><span id="l93.475">         return;</span>
<a href="#l93.476"></a><span id="l93.476">       }</span>
<a href="#l93.477"></a><span id="l93.477" class="difflineat">@@ -334,352 +417,421 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l93.478"></a><span id="l93.478"> </span>
<a href="#l93.479"></a><span id="l93.479">         // Why the participant left.</span>
<a href="#l93.480"></a><span id="l93.480">         let reasonNode = item.getElement([&quot;reason&quot;]);</span>
<a href="#l93.481"></a><span id="l93.481">         let reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l93.482"></a><span id="l93.482">         let isReason = reason ? &quot;.reason&quot; : &quot;&quot;;</span>
<a href="#l93.483"></a><span id="l93.483"> </span>
<a href="#l93.484"></a><span id="l93.484">         let isYou = nick == this.nick ? &quot;.you&quot; : &quot;&quot;;</span>
<a href="#l93.485"></a><span id="l93.485">         let affectedNick = isYou ? &quot;&quot; : nick;</span>
<a href="#l93.486"></a><span id="l93.486" class="difflineminus">-        if (isYou)</span>
<a href="#l93.487"></a><span id="l93.487" class="difflineplus">+        if (isYou) {</span>
<a href="#l93.488"></a><span id="l93.488">           this.left = true;</span>
<a href="#l93.489"></a><span id="l93.489" class="difflineplus">+        }</span>
<a href="#l93.490"></a><span id="l93.490"> </span>
<a href="#l93.491"></a><span id="l93.491">         let message;</span>
<a href="#l93.492"></a><span id="l93.492">         if (codes.includes(&quot;301&quot;)) {</span>
<a href="#l93.493"></a><span id="l93.493">           // XEP-0045 (9.1): Banning a User.</span>
<a href="#l93.494"></a><span id="l93.494">           message = &quot;conversation.message.banned&quot;;</span>
<a href="#l93.495"></a><span id="l93.495" class="difflineminus">-        }</span>
<a href="#l93.496"></a><span id="l93.496" class="difflineminus">-        else if (codes.includes(&quot;307&quot;)) {</span>
<a href="#l93.497"></a><span id="l93.497" class="difflineplus">+        } else if (codes.includes(&quot;307&quot;)) {</span>
<a href="#l93.498"></a><span id="l93.498">           // XEP-0045 (8.2): Kicking an Occupant.</span>
<a href="#l93.499"></a><span id="l93.499">           message = &quot;conversation.message.kicked&quot;;</span>
<a href="#l93.500"></a><span id="l93.500" class="difflineminus">-        }</span>
<a href="#l93.501"></a><span id="l93.501" class="difflineminus">-        else if (codes.includes(&quot;322&quot;) || codes.includes(&quot;321&quot;)) {</span>
<a href="#l93.502"></a><span id="l93.502" class="difflineplus">+        } else if (codes.includes(&quot;322&quot;) || codes.includes(&quot;321&quot;)) {</span>
<a href="#l93.503"></a><span id="l93.503">           // XEP-0045: Inform user that he or she is being removed from the</span>
<a href="#l93.504"></a><span id="l93.504">           // room because the room has been changed to members-only and the</span>
<a href="#l93.505"></a><span id="l93.505">           // user is not a member.</span>
<a href="#l93.506"></a><span id="l93.506">           message = &quot;conversation.message.removedNonMember&quot;;</span>
<a href="#l93.507"></a><span id="l93.507" class="difflineminus">-        }</span>
<a href="#l93.508"></a><span id="l93.508" class="difflineminus">-        else if (codes.includes(&quot;332&quot;)) {</span>
<a href="#l93.509"></a><span id="l93.509" class="difflineplus">+        } else if (codes.includes(&quot;332&quot;)) {</span>
<a href="#l93.510"></a><span id="l93.510">           // XEP-0045: Inform user that he or she is being removed from the</span>
<a href="#l93.511"></a><span id="l93.511">           // room because the MUC service is being shut down.</span>
<a href="#l93.512"></a><span id="l93.512">           message = &quot;conversation.message.mucShutdown&quot;;</span>
<a href="#l93.513"></a><span id="l93.513"> </span>
<a href="#l93.514"></a><span id="l93.514">           // The reason here just duplicates what's in the system message.</span>
<a href="#l93.515"></a><span id="l93.515">           reason = isReason = &quot;&quot;;</span>
<a href="#l93.516"></a><span id="l93.516" class="difflineminus">-        }</span>
<a href="#l93.517"></a><span id="l93.517" class="difflineminus">-        else {</span>
<a href="#l93.518"></a><span id="l93.518" class="difflineplus">+        } else {</span>
<a href="#l93.519"></a><span id="l93.519">           // XEP-0045 (7.14): Received when the user parts a room.</span>
<a href="#l93.520"></a><span id="l93.520">           message = &quot;conversation.message.parted&quot;;</span>
<a href="#l93.521"></a><span id="l93.521"> </span>
<a href="#l93.522"></a><span id="l93.522">           // The reason is in a status element in this case.</span>
<a href="#l93.523"></a><span id="l93.523">           reasonNode = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l93.524"></a><span id="l93.524">           reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l93.525"></a><span id="l93.525">           isReason = reason ? &quot;.reason&quot; : &quot;&quot;;</span>
<a href="#l93.526"></a><span id="l93.526">         }</span>
<a href="#l93.527"></a><span id="l93.527"> </span>
<a href="#l93.528"></a><span id="l93.528">         if (message) {</span>
<a href="#l93.529"></a><span id="l93.529">           let messageID = message + isYou + isActor + isReason;</span>
<a href="#l93.530"></a><span id="l93.530">           let params = [actorNick, affectedNick, reason].filter(s =&gt; s);</span>
<a href="#l93.531"></a><span id="l93.531" class="difflineminus">-          this.writeMessage(this.name, _(messageID, ...params), {system: true});</span>
<a href="#l93.532"></a><span id="l93.532" class="difflineplus">+          this.writeMessage(this.name, _(messageID, ...params), {</span>
<a href="#l93.533"></a><span id="l93.533" class="difflineplus">+            system: true,</span>
<a href="#l93.534"></a><span id="l93.534" class="difflineplus">+          });</span>
<a href="#l93.535"></a><span id="l93.535">         }</span>
<a href="#l93.536"></a><span id="l93.536" class="difflineplus">+      } else {</span>
<a href="#l93.537"></a><span id="l93.537" class="difflineplus">+        this.WARN(&quot;Unhandled type==unavailable MUC presence stanza.&quot;);</span>
<a href="#l93.538"></a><span id="l93.538">       }</span>
<a href="#l93.539"></a><span id="l93.539" class="difflineminus">-      else</span>
<a href="#l93.540"></a><span id="l93.540" class="difflineminus">-        this.WARN(&quot;Unhandled type==unavailable MUC presence stanza.&quot;);</span>
<a href="#l93.541"></a><span id="l93.541">       return;</span>
<a href="#l93.542"></a><span id="l93.542">     }</span>
<a href="#l93.543"></a><span id="l93.543"> </span>
<a href="#l93.544"></a><span id="l93.544">     if (codes.includes(&quot;201&quot;)) {</span>
<a href="#l93.545"></a><span id="l93.545">       // XEP-0045 (10.1): Creating room.</span>
<a href="#l93.546"></a><span id="l93.546">       // Service Acknowledges Room Creation</span>
<a href="#l93.547"></a><span id="l93.547">       // and Room is awaiting configuration.</span>
<a href="#l93.548"></a><span id="l93.548">       // XEP-0045 (10.1.2): Instant room.</span>
<a href="#l93.549"></a><span id="l93.549" class="difflineminus">-      let query = Stanza.node(&quot;query&quot;, Stanza.NS.muc_owner, null,</span>
<a href="#l93.550"></a><span id="l93.550" class="difflineminus">-                              Stanza.node(&quot;x&quot;, Stanza.NS.xdata,</span>
<a href="#l93.551"></a><span id="l93.551" class="difflineminus">-                                          {type: &quot;submit&quot;}));</span>
<a href="#l93.552"></a><span id="l93.552" class="difflineplus">+      let query = Stanza.node(</span>
<a href="#l93.553"></a><span id="l93.553" class="difflineplus">+        &quot;query&quot;,</span>
<a href="#l93.554"></a><span id="l93.554" class="difflineplus">+        Stanza.NS.muc_owner,</span>
<a href="#l93.555"></a><span id="l93.555" class="difflineplus">+        null,</span>
<a href="#l93.556"></a><span id="l93.556" class="difflineplus">+        Stanza.node(&quot;x&quot;, Stanza.NS.xdata, { type: &quot;submit&quot; })</span>
<a href="#l93.557"></a><span id="l93.557" class="difflineplus">+      );</span>
<a href="#l93.558"></a><span id="l93.558">       let s = Stanza.iq(&quot;set&quot;, null, jid, query);</span>
<a href="#l93.559"></a><span id="l93.559">       this._account.sendStanza(s, aStanzaReceived =&gt; {</span>
<a href="#l93.560"></a><span id="l93.560" class="difflineminus">-        if (aStanzaReceived.attributes.type != &quot;result&quot;)</span>
<a href="#l93.561"></a><span id="l93.561" class="difflineplus">+        if (aStanzaReceived.attributes.type != &quot;result&quot;) {</span>
<a href="#l93.562"></a><span id="l93.562">           return false;</span>
<a href="#l93.563"></a><span id="l93.563" class="difflineplus">+        }</span>
<a href="#l93.564"></a><span id="l93.564"> </span>
<a href="#l93.565"></a><span id="l93.565">         // XEP-0045: Service Informs New Room Owner of Success</span>
<a href="#l93.566"></a><span id="l93.566">         // for instant and reserved rooms.</span>
<a href="#l93.567"></a><span id="l93.567">         this.left = false;</span>
<a href="#l93.568"></a><span id="l93.568">         this.joining = false;</span>
<a href="#l93.569"></a><span id="l93.569">         return true;</span>
<a href="#l93.570"></a><span id="l93.570">       });</span>
<a href="#l93.571"></a><span id="l93.571" class="difflineminus">-    }</span>
<a href="#l93.572"></a><span id="l93.572" class="difflineminus">-    else if (codes.includes(&quot;210&quot;)) {</span>
<a href="#l93.573"></a><span id="l93.573" class="difflineplus">+    } else if (codes.includes(&quot;210&quot;)) {</span>
<a href="#l93.574"></a><span id="l93.574">       // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l93.575"></a><span id="l93.575">       // Service modifies this user's nickname in accordance with local service</span>
<a href="#l93.576"></a><span id="l93.576">       // policies.</span>
<a href="#l93.577"></a><span id="l93.577">       changeNick();</span>
<a href="#l93.578"></a><span id="l93.578">       return;</span>
<a href="#l93.579"></a><span id="l93.579" class="difflineminus">-    }</span>
<a href="#l93.580"></a><span id="l93.580" class="difflineminus">-    else if (codes.includes(&quot;110&quot;)) {</span>
<a href="#l93.581"></a><span id="l93.581" class="difflineplus">+    } else if (codes.includes(&quot;110&quot;)) {</span>
<a href="#l93.582"></a><span id="l93.582">       // XEP-0045: Room exists and joined successfully.</span>
<a href="#l93.583"></a><span id="l93.583">       this.left = false;</span>
<a href="#l93.584"></a><span id="l93.584">       this.joining = false;</span>
<a href="#l93.585"></a><span id="l93.585">       // TODO (Bug 1172350): Implement Service Discovery Extensions (XEP-0128) to obtain</span>
<a href="#l93.586"></a><span id="l93.586">       // configuration of this room.</span>
<a href="#l93.587"></a><span id="l93.587">     }</span>
<a href="#l93.588"></a><span id="l93.588"> </span>
<a href="#l93.589"></a><span id="l93.589">     if (!this._participants.get(nick)) {</span>
<a href="#l93.590"></a><span id="l93.590">       let participant = new MUCParticipant(nick, from, aStanza);</span>
<a href="#l93.591"></a><span id="l93.591">       this._participants.set(nick, participant);</span>
<a href="#l93.592"></a><span id="l93.592" class="difflineminus">-      this.notifyObservers(new nsSimpleEnumerator([participant]),</span>
<a href="#l93.593"></a><span id="l93.593" class="difflineminus">-                           &quot;chat-buddy-add&quot;);</span>
<a href="#l93.594"></a><span id="l93.594" class="difflineplus">+      this.notifyObservers(</span>
<a href="#l93.595"></a><span id="l93.595" class="difflineplus">+        new nsSimpleEnumerator([participant]),</span>
<a href="#l93.596"></a><span id="l93.596" class="difflineplus">+        &quot;chat-buddy-add&quot;</span>
<a href="#l93.597"></a><span id="l93.597" class="difflineplus">+      );</span>
<a href="#l93.598"></a><span id="l93.598">       if (this.nick != nick &amp;&amp; !this.joining) {</span>
<a href="#l93.599"></a><span id="l93.599" class="difflineminus">-        this.writeMessage(this.name, _(&quot;conversation.message.join&quot;, nick),</span>
<a href="#l93.600"></a><span id="l93.600" class="difflineminus">-                          {system: true});</span>
<a href="#l93.601"></a><span id="l93.601" class="difflineminus">-      }</span>
<a href="#l93.602"></a><span id="l93.602" class="difflineminus">-      else if (this.nick == nick &amp;&amp; this._rejoined) {</span>
<a href="#l93.603"></a><span id="l93.603" class="difflineminus">-        this.writeMessage(this.name, _(&quot;conversation.message.rejoined&quot;),</span>
<a href="#l93.604"></a><span id="l93.604" class="difflineminus">-                          {system: true});</span>
<a href="#l93.605"></a><span id="l93.605" class="difflineplus">+        this.writeMessage(this.name, _(&quot;conversation.message.join&quot;, nick), {</span>
<a href="#l93.606"></a><span id="l93.606" class="difflineplus">+          system: true,</span>
<a href="#l93.607"></a><span id="l93.607" class="difflineplus">+        });</span>
<a href="#l93.608"></a><span id="l93.608" class="difflineplus">+      } else if (this.nick == nick &amp;&amp; this._rejoined) {</span>
<a href="#l93.609"></a><span id="l93.609" class="difflineplus">+        this.writeMessage(this.name, _(&quot;conversation.message.rejoined&quot;), {</span>
<a href="#l93.610"></a><span id="l93.610" class="difflineplus">+          system: true,</span>
<a href="#l93.611"></a><span id="l93.611" class="difflineplus">+        });</span>
<a href="#l93.612"></a><span id="l93.612">         this._rejoined = false;</span>
<a href="#l93.613"></a><span id="l93.613">       }</span>
<a href="#l93.614"></a><span id="l93.614" class="difflineminus">-    }</span>
<a href="#l93.615"></a><span id="l93.615" class="difflineminus">-    else {</span>
<a href="#l93.616"></a><span id="l93.616" class="difflineplus">+    } else {</span>
<a href="#l93.617"></a><span id="l93.617">       this._participants.get(nick).onPresenceStanza(aStanza);</span>
<a href="#l93.618"></a><span id="l93.618">       this.notifyObservers(this._participants.get(nick), &quot;chat-buddy-update&quot;);</span>
<a href="#l93.619"></a><span id="l93.619">     }</span>
<a href="#l93.620"></a><span id="l93.620">   },</span>
<a href="#l93.621"></a><span id="l93.621"> </span>
<a href="#l93.622"></a><span id="l93.622">   /* Called by the account when a message is received for this muc */</span>
<a href="#l93.623"></a><span id="l93.623">   incomingMessage(aMsg, aStanza, aDate) {</span>
<a href="#l93.624"></a><span id="l93.624">     let from = this._account._parseJID(aStanza.attributes.from).resource;</span>
<a href="#l93.625"></a><span id="l93.625">     let id = aStanza.attributes.id;</span>
<a href="#l93.626"></a><span id="l93.626">     let flags = {};</span>
<a href="#l93.627"></a><span id="l93.627">     if (!from) {</span>
<a href="#l93.628"></a><span id="l93.628">       flags.system = true;</span>
<a href="#l93.629"></a><span id="l93.629">       from = this.name;</span>
<a href="#l93.630"></a><span id="l93.630" class="difflineminus">-    }</span>
<a href="#l93.631"></a><span id="l93.631" class="difflineminus">-    else if (aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l93.632"></a><span id="l93.632" class="difflineplus">+    } else if (aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l93.633"></a><span id="l93.633">       aMsg = _(&quot;conversation.error.notDelivered&quot;, aMsg);</span>
<a href="#l93.634"></a><span id="l93.634">       flags.system = true;</span>
<a href="#l93.635"></a><span id="l93.635">       flags.error = true;</span>
<a href="#l93.636"></a><span id="l93.636" class="difflineminus">-    }</span>
<a href="#l93.637"></a><span id="l93.637" class="difflineminus">-    else if (from == this._nick)</span>
<a href="#l93.638"></a><span id="l93.638" class="difflineplus">+    } else if (from == this._nick) {</span>
<a href="#l93.639"></a><span id="l93.639">       flags.outgoing = true;</span>
<a href="#l93.640"></a><span id="l93.640" class="difflineminus">-    else</span>
<a href="#l93.641"></a><span id="l93.641" class="difflineplus">+    } else {</span>
<a href="#l93.642"></a><span id="l93.642">       flags.incoming = true;</span>
<a href="#l93.643"></a><span id="l93.643" class="difflineplus">+    }</span>
<a href="#l93.644"></a><span id="l93.644">     if (aDate) {</span>
<a href="#l93.645"></a><span id="l93.645">       flags.time = aDate / 1000;</span>
<a href="#l93.646"></a><span id="l93.646">       flags.delayed = true;</span>
<a href="#l93.647"></a><span id="l93.647">     }</span>
<a href="#l93.648"></a><span id="l93.648">     if (id) {</span>
<a href="#l93.649"></a><span id="l93.649">       // Checks if a message exists in conversation to avoid duplication.</span>
<a href="#l93.650"></a><span id="l93.650" class="difflineminus">-      if (this._messageIds.has(id))</span>
<a href="#l93.651"></a><span id="l93.651" class="difflineplus">+      if (this._messageIds.has(id)) {</span>
<a href="#l93.652"></a><span id="l93.652">         return;</span>
<a href="#l93.653"></a><span id="l93.653" class="difflineplus">+      }</span>
<a href="#l93.654"></a><span id="l93.654">       this._messageIds.add(id);</span>
<a href="#l93.655"></a><span id="l93.655">     }</span>
<a href="#l93.656"></a><span id="l93.656">     this.writeMessage(from, aMsg, flags);</span>
<a href="#l93.657"></a><span id="l93.657">   },</span>
<a href="#l93.658"></a><span id="l93.658"> </span>
<a href="#l93.659"></a><span id="l93.659">   getNormalizedChatBuddyName(aNick) {</span>
<a href="#l93.660"></a><span id="l93.660">     return this._account.normalizeFullJid(this.name + &quot;/&quot; + aNick);</span>
<a href="#l93.661"></a><span id="l93.661">   },</span>
<a href="#l93.662"></a><span id="l93.662"> </span>
<a href="#l93.663"></a><span id="l93.663">   // Leaves MUC conversation.</span>
<a href="#l93.664"></a><span id="l93.664">   part(aMsg = null) {</span>
<a href="#l93.665"></a><span id="l93.665" class="difflineminus">-    let s = Stanza.presence({to: this.name + &quot;/&quot; + this._nick, type: &quot;unavailable&quot;},</span>
<a href="#l93.666"></a><span id="l93.666" class="difflineminus">-                            aMsg ? Stanza.node(&quot;status&quot;, null, null, aMsg.trim()) : null);</span>
<a href="#l93.667"></a><span id="l93.667" class="difflineplus">+    let s = Stanza.presence(</span>
<a href="#l93.668"></a><span id="l93.668" class="difflineplus">+      { to: this.name + &quot;/&quot; + this._nick, type: &quot;unavailable&quot; },</span>
<a href="#l93.669"></a><span id="l93.669" class="difflineplus">+      aMsg ? Stanza.node(&quot;status&quot;, null, null, aMsg.trim()) : null</span>
<a href="#l93.670"></a><span id="l93.670" class="difflineplus">+    );</span>
<a href="#l93.671"></a><span id="l93.671">     this._account.sendStanza(s);</span>
<a href="#l93.672"></a><span id="l93.672">     delete this.chatRoomFields;</span>
<a href="#l93.673"></a><span id="l93.673">   },</span>
<a href="#l93.674"></a><span id="l93.674"> </span>
<a href="#l93.675"></a><span id="l93.675">   // Invites a user to MUC conversation.</span>
<a href="#l93.676"></a><span id="l93.676">   invite(aJID, aMsg = null) {</span>
<a href="#l93.677"></a><span id="l93.677">     // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l93.678"></a><span id="l93.678">     // XEP-0045 (7.8.2): Mediated Invitation.</span>
<a href="#l93.679"></a><span id="l93.679" class="difflineminus">-    let invite = Stanza.node(&quot;invite&quot;, null, {to: aJID},</span>
<a href="#l93.680"></a><span id="l93.680" class="difflineminus">-      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null);</span>
<a href="#l93.681"></a><span id="l93.681" class="difflineplus">+    let invite = Stanza.node(</span>
<a href="#l93.682"></a><span id="l93.682" class="difflineplus">+      &quot;invite&quot;,</span>
<a href="#l93.683"></a><span id="l93.683" class="difflineplus">+      null,</span>
<a href="#l93.684"></a><span id="l93.684" class="difflineplus">+      { to: aJID },</span>
<a href="#l93.685"></a><span id="l93.685" class="difflineplus">+      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null</span>
<a href="#l93.686"></a><span id="l93.686" class="difflineplus">+    );</span>
<a href="#l93.687"></a><span id="l93.687">     let x = Stanza.node(&quot;x&quot;, Stanza.NS.muc_user, null, invite);</span>
<a href="#l93.688"></a><span id="l93.688" class="difflineminus">-    let s = Stanza.node(&quot;message&quot;, null, {to: this.name}, x);</span>
<a href="#l93.689"></a><span id="l93.689" class="difflineminus">-    this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l93.690"></a><span id="l93.690" class="difflineminus">-      forbidden: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l93.691"></a><span id="l93.691" class="difflineminus">-      // ejabberd uses error not-allowed to indicate that this account does not</span>
<a href="#l93.692"></a><span id="l93.692" class="difflineminus">-      // have the required privileges to invite users instead of forbidden error,</span>
<a href="#l93.693"></a><span id="l93.693" class="difflineminus">-      // and this is not mentioned in the spec (XEP-0045).</span>
<a href="#l93.694"></a><span id="l93.694" class="difflineminus">-      notAllowed: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l93.695"></a><span id="l93.695" class="difflineminus">-      itemNotFound: _(&quot;conversation.error.failedJIDNotFound&quot;, aJID),</span>
<a href="#l93.696"></a><span id="l93.696" class="difflineminus">-    }, this));</span>
<a href="#l93.697"></a><span id="l93.697" class="difflineplus">+    let s = Stanza.node(&quot;message&quot;, null, { to: this.name }, x);</span>
<a href="#l93.698"></a><span id="l93.698" class="difflineplus">+    this._account.sendStanza(</span>
<a href="#l93.699"></a><span id="l93.699" class="difflineplus">+      s,</span>
<a href="#l93.700"></a><span id="l93.700" class="difflineplus">+      this._account.handleErrors(</span>
<a href="#l93.701"></a><span id="l93.701" class="difflineplus">+        {</span>
<a href="#l93.702"></a><span id="l93.702" class="difflineplus">+          forbidden: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l93.703"></a><span id="l93.703" class="difflineplus">+          // ejabberd uses error not-allowed to indicate that this account does not</span>
<a href="#l93.704"></a><span id="l93.704" class="difflineplus">+          // have the required privileges to invite users instead of forbidden error,</span>
<a href="#l93.705"></a><span id="l93.705" class="difflineplus">+          // and this is not mentioned in the spec (XEP-0045).</span>
<a href="#l93.706"></a><span id="l93.706" class="difflineplus">+          notAllowed: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l93.707"></a><span id="l93.707" class="difflineplus">+          itemNotFound: _(&quot;conversation.error.failedJIDNotFound&quot;, aJID),</span>
<a href="#l93.708"></a><span id="l93.708" class="difflineplus">+        },</span>
<a href="#l93.709"></a><span id="l93.709" class="difflineplus">+        this</span>
<a href="#l93.710"></a><span id="l93.710" class="difflineplus">+      )</span>
<a href="#l93.711"></a><span id="l93.711" class="difflineplus">+    );</span>
<a href="#l93.712"></a><span id="l93.712">   },</span>
<a href="#l93.713"></a><span id="l93.713"> </span>
<a href="#l93.714"></a><span id="l93.714">   // Bans a participant from MUC conversation.</span>
<a href="#l93.715"></a><span id="l93.715">   ban(aNickName, aMsg = null) {</span>
<a href="#l93.716"></a><span id="l93.716">     // XEP-0045 (9.1): Banning a User.</span>
<a href="#l93.717"></a><span id="l93.717">     let participant = this._participants.get(aNickName);</span>
<a href="#l93.718"></a><span id="l93.718">     if (!participant) {</span>
<a href="#l93.719"></a><span id="l93.719" class="difflineminus">-      this.writeMessage(this.name,</span>
<a href="#l93.720"></a><span id="l93.720" class="difflineminus">-                        _(&quot;conversation.error.nickNotInRoom&quot;, aNickName),</span>
<a href="#l93.721"></a><span id="l93.721" class="difflineminus">-                        {system: true});</span>
<a href="#l93.722"></a><span id="l93.722" class="difflineplus">+      this.writeMessage(</span>
<a href="#l93.723"></a><span id="l93.723" class="difflineplus">+        this.name,</span>
<a href="#l93.724"></a><span id="l93.724" class="difflineplus">+        _(&quot;conversation.error.nickNotInRoom&quot;, aNickName),</span>
<a href="#l93.725"></a><span id="l93.725" class="difflineplus">+        { system: true }</span>
<a href="#l93.726"></a><span id="l93.726" class="difflineplus">+      );</span>
<a href="#l93.727"></a><span id="l93.727">       return;</span>
<a href="#l93.728"></a><span id="l93.728">     }</span>
<a href="#l93.729"></a><span id="l93.729">     if (!participant.accountJid) {</span>
<a href="#l93.730"></a><span id="l93.730" class="difflineminus">-      this.writeMessage(this.name,</span>
<a href="#l93.731"></a><span id="l93.731" class="difflineminus">-                        _(&quot;conversation.error.banCommandAnonymousRoom&quot;),</span>
<a href="#l93.732"></a><span id="l93.732" class="difflineminus">-                        {system: true});</span>
<a href="#l93.733"></a><span id="l93.733" class="difflineplus">+      this.writeMessage(</span>
<a href="#l93.734"></a><span id="l93.734" class="difflineplus">+        this.name,</span>
<a href="#l93.735"></a><span id="l93.735" class="difflineplus">+        _(&quot;conversation.error.banCommandAnonymousRoom&quot;),</span>
<a href="#l93.736"></a><span id="l93.736" class="difflineplus">+        { system: true }</span>
<a href="#l93.737"></a><span id="l93.737" class="difflineplus">+      );</span>
<a href="#l93.738"></a><span id="l93.738">       return;</span>
<a href="#l93.739"></a><span id="l93.739">     }</span>
<a href="#l93.740"></a><span id="l93.740"> </span>
<a href="#l93.741"></a><span id="l93.741" class="difflineminus">-    let attributes = {affiliation: &quot;outcast&quot;, jid: participant.accountJid};</span>
<a href="#l93.742"></a><span id="l93.742" class="difflineminus">-    let item = Stanza.node(&quot;item&quot;, null, attributes,</span>
<a href="#l93.743"></a><span id="l93.743" class="difflineminus">-      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null);</span>
<a href="#l93.744"></a><span id="l93.744" class="difflineminus">-    let s = Stanza.iq(&quot;set&quot;, null, this.name,</span>
<a href="#l93.745"></a><span id="l93.745" class="difflineminus">-                      Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item));</span>
<a href="#l93.746"></a><span id="l93.746" class="difflineplus">+    let attributes = { affiliation: &quot;outcast&quot;, jid: participant.accountJid };</span>
<a href="#l93.747"></a><span id="l93.747" class="difflineplus">+    let item = Stanza.node(</span>
<a href="#l93.748"></a><span id="l93.748" class="difflineplus">+      &quot;item&quot;,</span>
<a href="#l93.749"></a><span id="l93.749" class="difflineplus">+      null,</span>
<a href="#l93.750"></a><span id="l93.750" class="difflineplus">+      attributes,</span>
<a href="#l93.751"></a><span id="l93.751" class="difflineplus">+      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null</span>
<a href="#l93.752"></a><span id="l93.752" class="difflineplus">+    );</span>
<a href="#l93.753"></a><span id="l93.753" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.754"></a><span id="l93.754" class="difflineplus">+      &quot;set&quot;,</span>
<a href="#l93.755"></a><span id="l93.755" class="difflineplus">+      null,</span>
<a href="#l93.756"></a><span id="l93.756" class="difflineplus">+      this.name,</span>
<a href="#l93.757"></a><span id="l93.757" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item)</span>
<a href="#l93.758"></a><span id="l93.758" class="difflineplus">+    );</span>
<a href="#l93.759"></a><span id="l93.759">     this._account.sendStanza(s, this._banKickHandler, this);</span>
<a href="#l93.760"></a><span id="l93.760">   },</span>
<a href="#l93.761"></a><span id="l93.761"> </span>
<a href="#l93.762"></a><span id="l93.762">   // Kicks a participant from MUC conversation.</span>
<a href="#l93.763"></a><span id="l93.763">   kick(aNickName, aMsg = null) {</span>
<a href="#l93.764"></a><span id="l93.764">     // XEP-0045 (8.2): Kicking an Occupant.</span>
<a href="#l93.765"></a><span id="l93.765" class="difflineminus">-    let attributes = {role: &quot;none&quot;, nick: aNickName};</span>
<a href="#l93.766"></a><span id="l93.766" class="difflineminus">-    let item = Stanza.node(&quot;item&quot;, null, attributes,</span>
<a href="#l93.767"></a><span id="l93.767" class="difflineminus">-      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null);</span>
<a href="#l93.768"></a><span id="l93.768" class="difflineminus">-    let s = Stanza.iq(&quot;set&quot;, null, this.name,</span>
<a href="#l93.769"></a><span id="l93.769" class="difflineminus">-                      Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item));</span>
<a href="#l93.770"></a><span id="l93.770" class="difflineplus">+    let attributes = { role: &quot;none&quot;, nick: aNickName };</span>
<a href="#l93.771"></a><span id="l93.771" class="difflineplus">+    let item = Stanza.node(</span>
<a href="#l93.772"></a><span id="l93.772" class="difflineplus">+      &quot;item&quot;,</span>
<a href="#l93.773"></a><span id="l93.773" class="difflineplus">+      null,</span>
<a href="#l93.774"></a><span id="l93.774" class="difflineplus">+      attributes,</span>
<a href="#l93.775"></a><span id="l93.775" class="difflineplus">+      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null</span>
<a href="#l93.776"></a><span id="l93.776" class="difflineplus">+    );</span>
<a href="#l93.777"></a><span id="l93.777" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.778"></a><span id="l93.778" class="difflineplus">+      &quot;set&quot;,</span>
<a href="#l93.779"></a><span id="l93.779" class="difflineplus">+      null,</span>
<a href="#l93.780"></a><span id="l93.780" class="difflineplus">+      this.name,</span>
<a href="#l93.781"></a><span id="l93.781" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item)</span>
<a href="#l93.782"></a><span id="l93.782" class="difflineplus">+    );</span>
<a href="#l93.783"></a><span id="l93.783">     this._account.sendStanza(s, this._banKickHandler, this);</span>
<a href="#l93.784"></a><span id="l93.784">   },</span>
<a href="#l93.785"></a><span id="l93.785"> </span>
<a href="#l93.786"></a><span id="l93.786">   // Callback for ban and kick commands.</span>
<a href="#l93.787"></a><span id="l93.787">   _banKickHandler(aStanza) {</span>
<a href="#l93.788"></a><span id="l93.788" class="difflineminus">-    return this._account._handleResult({</span>
<a href="#l93.789"></a><span id="l93.789" class="difflineminus">-      notAllowed: _(&quot;conversation.error.banKickCommandNotAllowed&quot;),</span>
<a href="#l93.790"></a><span id="l93.790" class="difflineminus">-      conflict: _(&quot;conversation.error.banKickCommandConflict&quot;),</span>
<a href="#l93.791"></a><span id="l93.791" class="difflineminus">-    }, this)(aStanza);</span>
<a href="#l93.792"></a><span id="l93.792" class="difflineplus">+    return this._account._handleResult(</span>
<a href="#l93.793"></a><span id="l93.793" class="difflineplus">+      {</span>
<a href="#l93.794"></a><span id="l93.794" class="difflineplus">+        notAllowed: _(&quot;conversation.error.banKickCommandNotAllowed&quot;),</span>
<a href="#l93.795"></a><span id="l93.795" class="difflineplus">+        conflict: _(&quot;conversation.error.banKickCommandConflict&quot;),</span>
<a href="#l93.796"></a><span id="l93.796" class="difflineplus">+      },</span>
<a href="#l93.797"></a><span id="l93.797" class="difflineplus">+      this</span>
<a href="#l93.798"></a><span id="l93.798" class="difflineplus">+    )(aStanza);</span>
<a href="#l93.799"></a><span id="l93.799">   },</span>
<a href="#l93.800"></a><span id="l93.800"> </span>
<a href="#l93.801"></a><span id="l93.801">   // Changes nick in MUC conversation to a new one.</span>
<a href="#l93.802"></a><span id="l93.802">   setNick(aNewNick) {</span>
<a href="#l93.803"></a><span id="l93.803">     // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l93.804"></a><span id="l93.804" class="difflineminus">-    let s = Stanza.presence({to: this.name + &quot;/&quot; + aNewNick}, null);</span>
<a href="#l93.805"></a><span id="l93.805" class="difflineminus">-    this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l93.806"></a><span id="l93.806" class="difflineminus">-      // XEP-0045 (7.6): Changing Nickname (example 53).</span>
<a href="#l93.807"></a><span id="l93.807" class="difflineminus">-      // TODO: We should discover if the user has a reserved nickname (maybe</span>
<a href="#l93.808"></a><span id="l93.808" class="difflineminus">-      // before joining a room), cf. XEP-0045 (7.12).</span>
<a href="#l93.809"></a><span id="l93.809" class="difflineminus">-      notAcceptable: _(&quot;conversation.error.changeNickFailedNotAcceptable&quot;,</span>
<a href="#l93.810"></a><span id="l93.810" class="difflineminus">-                       aNewNick),</span>
<a href="#l93.811"></a><span id="l93.811" class="difflineminus">-      // XEP-0045 (7.2.9): Nickname Conflict.</span>
<a href="#l93.812"></a><span id="l93.812" class="difflineminus">-      conflict: _(&quot;conversation.error.changeNickFailedConflict&quot;, aNewNick),</span>
<a href="#l93.813"></a><span id="l93.813" class="difflineminus">-    }, this));</span>
<a href="#l93.814"></a><span id="l93.814" class="difflineplus">+    let s = Stanza.presence({ to: this.name + &quot;/&quot; + aNewNick }, null);</span>
<a href="#l93.815"></a><span id="l93.815" class="difflineplus">+    this._account.sendStanza(</span>
<a href="#l93.816"></a><span id="l93.816" class="difflineplus">+      s,</span>
<a href="#l93.817"></a><span id="l93.817" class="difflineplus">+      this._account.handleErrors(</span>
<a href="#l93.818"></a><span id="l93.818" class="difflineplus">+        {</span>
<a href="#l93.819"></a><span id="l93.819" class="difflineplus">+          // XEP-0045 (7.6): Changing Nickname (example 53).</span>
<a href="#l93.820"></a><span id="l93.820" class="difflineplus">+          // TODO: We should discover if the user has a reserved nickname (maybe</span>
<a href="#l93.821"></a><span id="l93.821" class="difflineplus">+          // before joining a room), cf. XEP-0045 (7.12).</span>
<a href="#l93.822"></a><span id="l93.822" class="difflineplus">+          notAcceptable: _(</span>
<a href="#l93.823"></a><span id="l93.823" class="difflineplus">+            &quot;conversation.error.changeNickFailedNotAcceptable&quot;,</span>
<a href="#l93.824"></a><span id="l93.824" class="difflineplus">+            aNewNick</span>
<a href="#l93.825"></a><span id="l93.825" class="difflineplus">+          ),</span>
<a href="#l93.826"></a><span id="l93.826" class="difflineplus">+          // XEP-0045 (7.2.9): Nickname Conflict.</span>
<a href="#l93.827"></a><span id="l93.827" class="difflineplus">+          conflict: _(&quot;conversation.error.changeNickFailedConflict&quot;, aNewNick),</span>
<a href="#l93.828"></a><span id="l93.828" class="difflineplus">+        },</span>
<a href="#l93.829"></a><span id="l93.829" class="difflineplus">+        this</span>
<a href="#l93.830"></a><span id="l93.830" class="difflineplus">+      )</span>
<a href="#l93.831"></a><span id="l93.831" class="difflineplus">+    );</span>
<a href="#l93.832"></a><span id="l93.832">   },</span>
<a href="#l93.833"></a><span id="l93.833"> </span>
<a href="#l93.834"></a><span id="l93.834">   // Called by the account when a message stanza is received for this muc and</span>
<a href="#l93.835"></a><span id="l93.835">   // needs to be handled.</span>
<a href="#l93.836"></a><span id="l93.836">   onMessageStanza(aStanza) {</span>
<a href="#l93.837"></a><span id="l93.837">     let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l93.838"></a><span id="l93.838">     let decline = x.getElement([&quot;decline&quot;]);</span>
<a href="#l93.839"></a><span id="l93.839">     if (decline) {</span>
<a href="#l93.840"></a><span id="l93.840">       // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l93.841"></a><span id="l93.841">       // XEP-0045 (7.8.2): Mediated Invitation.</span>
<a href="#l93.842"></a><span id="l93.842">       let invitee = decline.attributes.jid;</span>
<a href="#l93.843"></a><span id="l93.843">       let reasonNode = decline.getElement([&quot;reason&quot;]);</span>
<a href="#l93.844"></a><span id="l93.844">       let reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l93.845"></a><span id="l93.845">       let msg;</span>
<a href="#l93.846"></a><span id="l93.846" class="difflineminus">-      if (reason)</span>
<a href="#l93.847"></a><span id="l93.847" class="difflineminus">-        msg = _(&quot;conversation.message.invitationDeclined.reason&quot;, invitee, reason);</span>
<a href="#l93.848"></a><span id="l93.848" class="difflineminus">-      else</span>
<a href="#l93.849"></a><span id="l93.849" class="difflineplus">+      if (reason) {</span>
<a href="#l93.850"></a><span id="l93.850" class="difflineplus">+        msg = _(</span>
<a href="#l93.851"></a><span id="l93.851" class="difflineplus">+          &quot;conversation.message.invitationDeclined.reason&quot;,</span>
<a href="#l93.852"></a><span id="l93.852" class="difflineplus">+          invitee,</span>
<a href="#l93.853"></a><span id="l93.853" class="difflineplus">+          reason</span>
<a href="#l93.854"></a><span id="l93.854" class="difflineplus">+        );</span>
<a href="#l93.855"></a><span id="l93.855" class="difflineplus">+      } else {</span>
<a href="#l93.856"></a><span id="l93.856">         msg = _(&quot;conversation.message.invitationDeclined&quot;, invitee);</span>
<a href="#l93.857"></a><span id="l93.857" class="difflineminus">-</span>
<a href="#l93.858"></a><span id="l93.858" class="difflineminus">-      this.writeMessage(this.name, msg, {system: true});</span>
<a href="#l93.859"></a><span id="l93.859" class="difflineplus">+      }</span>
<a href="#l93.860"></a><span id="l93.860" class="difflineplus">+</span>
<a href="#l93.861"></a><span id="l93.861" class="difflineplus">+      this.writeMessage(this.name, msg, { system: true });</span>
<a href="#l93.862"></a><span id="l93.862" class="difflineplus">+    } else {</span>
<a href="#l93.863"></a><span id="l93.863" class="difflineplus">+      this.WARN(&quot;Unhandled message stanza.&quot;);</span>
<a href="#l93.864"></a><span id="l93.864">     }</span>
<a href="#l93.865"></a><span id="l93.865" class="difflineminus">-    else</span>
<a href="#l93.866"></a><span id="l93.866" class="difflineminus">-      this.WARN(&quot;Unhandled message stanza.&quot;);</span>
<a href="#l93.867"></a><span id="l93.867">   },</span>
<a href="#l93.868"></a><span id="l93.868"> </span>
<a href="#l93.869"></a><span id="l93.869">   /* Called when the user closed the conversation */</span>
<a href="#l93.870"></a><span id="l93.870">   close() {</span>
<a href="#l93.871"></a><span id="l93.871" class="difflineminus">-    if (!this.left)</span>
<a href="#l93.872"></a><span id="l93.872" class="difflineplus">+    if (!this.left) {</span>
<a href="#l93.873"></a><span id="l93.873">       this.part();</span>
<a href="#l93.874"></a><span id="l93.874" class="difflineplus">+    }</span>
<a href="#l93.875"></a><span id="l93.875">     GenericConvChatPrototype.close.call(this);</span>
<a href="#l93.876"></a><span id="l93.876">   },</span>
<a href="#l93.877"></a><span id="l93.877">   unInit() {</span>
<a href="#l93.878"></a><span id="l93.878">     this._account.removeConversation(this.name);</span>
<a href="#l93.879"></a><span id="l93.879">     GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l93.880"></a><span id="l93.880">   },</span>
<a href="#l93.881"></a><span id="l93.881"> };</span>
<a href="#l93.882"></a><span id="l93.882" class="difflineminus">-function XMPPMUCConversation(aAccount, aJID, aNick)</span>
<a href="#l93.883"></a><span id="l93.883" class="difflineminus">-{</span>
<a href="#l93.884"></a><span id="l93.884" class="difflineplus">+function XMPPMUCConversation(aAccount, aJID, aNick) {</span>
<a href="#l93.885"></a><span id="l93.885">   this._init(aAccount, aJID, aNick);</span>
<a href="#l93.886"></a><span id="l93.886"> }</span>
<a href="#l93.887"></a><span id="l93.887"> XMPPMUCConversation.prototype = XMPPMUCConversationPrototype;</span>
<a href="#l93.888"></a><span id="l93.888"> </span>
<a href="#l93.889"></a><span id="l93.889"> /* Helper class for buddy conversations */</span>
<a href="#l93.890"></a><span id="l93.890"> var XMPPConversationPrototype = {</span>
<a href="#l93.891"></a><span id="l93.891">   __proto__: GenericConvIMPrototype,</span>
<a href="#l93.892"></a><span id="l93.892"> </span>
<a href="#l93.893"></a><span id="l93.893">   _typingTimer: null,</span>
<a href="#l93.894"></a><span id="l93.894">   supportChatStateNotifications: true,</span>
<a href="#l93.895"></a><span id="l93.895">   _typingState: &quot;active&quot;,</span>
<a href="#l93.896"></a><span id="l93.896"> </span>
<a href="#l93.897"></a><span id="l93.897">   // Indicates that current conversation is with a MUC participant and the</span>
<a href="#l93.898"></a><span id="l93.898">   // recipient jid (stored in the userName) is of the form room@domain/nick.</span>
<a href="#l93.899"></a><span id="l93.899">   _isMucParticipant: false,</span>
<a href="#l93.900"></a><span id="l93.900"> </span>
<a href="#l93.901"></a><span id="l93.901" class="difflineminus">-  get buddy() { return this._account._buddies.get(this.name); },</span>
<a href="#l93.902"></a><span id="l93.902" class="difflineminus">-  get title() { return this.contactDisplayName; },</span>
<a href="#l93.903"></a><span id="l93.903" class="difflineminus">-  get contactDisplayName() { return this.buddy ? this.buddy.contactDisplayName : this.name; },</span>
<a href="#l93.904"></a><span id="l93.904" class="difflineminus">-  get userName() { return this.buddy ? this.buddy.userName : this.name; },</span>
<a href="#l93.905"></a><span id="l93.905" class="difflineplus">+  get buddy() {</span>
<a href="#l93.906"></a><span id="l93.906" class="difflineplus">+    return this._account._buddies.get(this.name);</span>
<a href="#l93.907"></a><span id="l93.907" class="difflineplus">+  },</span>
<a href="#l93.908"></a><span id="l93.908" class="difflineplus">+  get title() {</span>
<a href="#l93.909"></a><span id="l93.909" class="difflineplus">+    return this.contactDisplayName;</span>
<a href="#l93.910"></a><span id="l93.910" class="difflineplus">+  },</span>
<a href="#l93.911"></a><span id="l93.911" class="difflineplus">+  get contactDisplayName() {</span>
<a href="#l93.912"></a><span id="l93.912" class="difflineplus">+    return this.buddy ? this.buddy.contactDisplayName : this.name;</span>
<a href="#l93.913"></a><span id="l93.913" class="difflineplus">+  },</span>
<a href="#l93.914"></a><span id="l93.914" class="difflineplus">+  get userName() {</span>
<a href="#l93.915"></a><span id="l93.915" class="difflineplus">+    return this.buddy ? this.buddy.userName : this.name;</span>
<a href="#l93.916"></a><span id="l93.916" class="difflineplus">+  },</span>
<a href="#l93.917"></a><span id="l93.917"> </span>
<a href="#l93.918"></a><span id="l93.918">   // Returns jid (room@domain/nick) if it is with a MUC participant, and the</span>
<a href="#l93.919"></a><span id="l93.919">   // name of conversation otherwise.</span>
<a href="#l93.920"></a><span id="l93.920">   get normalizedName() {</span>
<a href="#l93.921"></a><span id="l93.921" class="difflineminus">-    if (this._isMucParticipant)</span>
<a href="#l93.922"></a><span id="l93.922" class="difflineplus">+    if (this._isMucParticipant) {</span>
<a href="#l93.923"></a><span id="l93.923">       return this._account.normalizeFullJid(this.name);</span>
<a href="#l93.924"></a><span id="l93.924" class="difflineplus">+    }</span>
<a href="#l93.925"></a><span id="l93.925">     return this._account.normalize(this.name);</span>
<a href="#l93.926"></a><span id="l93.926">   },</span>
<a href="#l93.927"></a><span id="l93.927"> </span>
<a href="#l93.928"></a><span id="l93.928">   // Used to avoid showing full jids in typing notifications.</span>
<a href="#l93.929"></a><span id="l93.929">   get shortName() {</span>
<a href="#l93.930"></a><span id="l93.930" class="difflineminus">-    if (this.buddy)</span>
<a href="#l93.931"></a><span id="l93.931" class="difflineplus">+    if (this.buddy) {</span>
<a href="#l93.932"></a><span id="l93.932">       return this.buddy.contactDisplayName;</span>
<a href="#l93.933"></a><span id="l93.933" class="difflineplus">+    }</span>
<a href="#l93.934"></a><span id="l93.934"> </span>
<a href="#l93.935"></a><span id="l93.935">     let jid = this._account._parseJID(this.name);</span>
<a href="#l93.936"></a><span id="l93.936" class="difflineminus">-    if (!jid)</span>
<a href="#l93.937"></a><span id="l93.937" class="difflineplus">+    if (!jid) {</span>
<a href="#l93.938"></a><span id="l93.938">       return this.name;</span>
<a href="#l93.939"></a><span id="l93.939" class="difflineplus">+    }</span>
<a href="#l93.940"></a><span id="l93.940"> </span>
<a href="#l93.941"></a><span id="l93.941">     // Returns nick of the recipient if conversation is with a participant of</span>
<a href="#l93.942"></a><span id="l93.942">     // a MUC we are in as jid of the recipient is of the form room@domain/nick.</span>
<a href="#l93.943"></a><span id="l93.943" class="difflineminus">-    if (this._isMucParticipant)</span>
<a href="#l93.944"></a><span id="l93.944" class="difflineplus">+    if (this._isMucParticipant) {</span>
<a href="#l93.945"></a><span id="l93.945">       return jid.resource;</span>
<a href="#l93.946"></a><span id="l93.946" class="difflineplus">+    }</span>
<a href="#l93.947"></a><span id="l93.947"> </span>
<a href="#l93.948"></a><span id="l93.948">     return jid.node;</span>
<a href="#l93.949"></a><span id="l93.949">   },</span>
<a href="#l93.950"></a><span id="l93.950"> </span>
<a href="#l93.951"></a><span id="l93.951">   get shouldSendTypingNotifications() {</span>
<a href="#l93.952"></a><span id="l93.952" class="difflineminus">-    return this.supportChatStateNotifications &amp;&amp;</span>
<a href="#l93.953"></a><span id="l93.953" class="difflineminus">-           Services.prefs.getBoolPref(&quot;purple.conversations.im.send_typing&quot;);</span>
<a href="#l93.954"></a><span id="l93.954" class="difflineplus">+    return (</span>
<a href="#l93.955"></a><span id="l93.955" class="difflineplus">+      this.supportChatStateNotifications &amp;&amp;</span>
<a href="#l93.956"></a><span id="l93.956" class="difflineplus">+      Services.prefs.getBoolPref(&quot;purple.conversations.im.send_typing&quot;)</span>
<a href="#l93.957"></a><span id="l93.957" class="difflineplus">+    );</span>
<a href="#l93.958"></a><span id="l93.958">   },</span>
<a href="#l93.959"></a><span id="l93.959"> </span>
<a href="#l93.960"></a><span id="l93.960">   /* Called when the user is typing a message</span>
<a href="#l93.961"></a><span id="l93.961">    * aString - the currently typed message</span>
<a href="#l93.962"></a><span id="l93.962">    * Returns the number of characters that can still be typed */</span>
<a href="#l93.963"></a><span id="l93.963">   sendTyping(aString) {</span>
<a href="#l93.964"></a><span id="l93.964" class="difflineminus">-    if (!this.shouldSendTypingNotifications)</span>
<a href="#l93.965"></a><span id="l93.965" class="difflineplus">+    if (!this.shouldSendTypingNotifications) {</span>
<a href="#l93.966"></a><span id="l93.966">       return Ci.prplIConversation.NO_TYPING_LIMIT;</span>
<a href="#l93.967"></a><span id="l93.967" class="difflineplus">+    }</span>
<a href="#l93.968"></a><span id="l93.968"> </span>
<a href="#l93.969"></a><span id="l93.969">     this._cancelTypingTimer();</span>
<a href="#l93.970"></a><span id="l93.970" class="difflineminus">-    if (aString.length)</span>
<a href="#l93.971"></a><span id="l93.971" class="difflineplus">+    if (aString.length) {</span>
<a href="#l93.972"></a><span id="l93.972">       this._typingTimer = setTimeout(this.finishedComposing.bind(this), 10000);</span>
<a href="#l93.973"></a><span id="l93.973" class="difflineplus">+    }</span>
<a href="#l93.974"></a><span id="l93.974"> </span>
<a href="#l93.975"></a><span id="l93.975">     this._setTypingState(aString.length ? &quot;composing&quot; : &quot;active&quot;);</span>
<a href="#l93.976"></a><span id="l93.976"> </span>
<a href="#l93.977"></a><span id="l93.977">     return Ci.prplIConversation.NO_TYPING_LIMIT;</span>
<a href="#l93.978"></a><span id="l93.978">   },</span>
<a href="#l93.979"></a><span id="l93.979"> </span>
<a href="#l93.980"></a><span id="l93.980">   finishedComposing() {</span>
<a href="#l93.981"></a><span id="l93.981" class="difflineminus">-    if (!this.shouldSendTypingNotifications)</span>
<a href="#l93.982"></a><span id="l93.982" class="difflineplus">+    if (!this.shouldSendTypingNotifications) {</span>
<a href="#l93.983"></a><span id="l93.983">       return;</span>
<a href="#l93.984"></a><span id="l93.984" class="difflineplus">+    }</span>
<a href="#l93.985"></a><span id="l93.985"> </span>
<a href="#l93.986"></a><span id="l93.986">     this._setTypingState(&quot;paused&quot;);</span>
<a href="#l93.987"></a><span id="l93.987">   },</span>
<a href="#l93.988"></a><span id="l93.988"> </span>
<a href="#l93.989"></a><span id="l93.989">   _setTypingState(aNewState) {</span>
<a href="#l93.990"></a><span id="l93.990" class="difflineminus">-    if (this._typingState == aNewState)</span>
<a href="#l93.991"></a><span id="l93.991" class="difflineplus">+    if (this._typingState == aNewState) {</span>
<a href="#l93.992"></a><span id="l93.992">       return;</span>
<a href="#l93.993"></a><span id="l93.993" class="difflineplus">+    }</span>
<a href="#l93.994"></a><span id="l93.994"> </span>
<a href="#l93.995"></a><span id="l93.995">     let s = Stanza.message(this.to, null, aNewState);</span>
<a href="#l93.996"></a><span id="l93.996"> </span>
<a href="#l93.997"></a><span id="l93.997">     // We don't care about errors in response to typing notifications</span>
<a href="#l93.998"></a><span id="l93.998">     // (e.g. because the user has left the room when talking to a MUC</span>
<a href="#l93.999"></a><span id="l93.999">     // participant).</span>
<a href="#l93.1000"></a><span id="l93.1000">     this._account.sendStanza(s, () =&gt; true);</span>
<a href="#l93.1001"></a><span id="l93.1001"> </span>
<a href="#l93.1002"></a><span id="l93.1002" class="difflineat">@@ -693,18 +845,19 @@ var XMPPConversationPrototype = {</span>
<a href="#l93.1003"></a><span id="l93.1003">   },</span>
<a href="#l93.1004"></a><span id="l93.1004"> </span>
<a href="#l93.1005"></a><span id="l93.1005">   // Holds the resource of user that you are currently talking to, but if the</span>
<a href="#l93.1006"></a><span id="l93.1006">   // user is a participant of a MUC we are in, holds the nick of user you are</span>
<a href="#l93.1007"></a><span id="l93.1007">   // talking to.</span>
<a href="#l93.1008"></a><span id="l93.1008">   _targetResource: &quot;&quot;,</span>
<a href="#l93.1009"></a><span id="l93.1009"> </span>
<a href="#l93.1010"></a><span id="l93.1010">   get to() {</span>
<a href="#l93.1011"></a><span id="l93.1011" class="difflineminus">-    if (!this._targetResource || this._isMucParticipant)</span>
<a href="#l93.1012"></a><span id="l93.1012" class="difflineplus">+    if (!this._targetResource || this._isMucParticipant) {</span>
<a href="#l93.1013"></a><span id="l93.1013">       return this.userName;</span>
<a href="#l93.1014"></a><span id="l93.1014" class="difflineplus">+    }</span>
<a href="#l93.1015"></a><span id="l93.1015">     return this.userName + &quot;/&quot; + this._targetResource;</span>
<a href="#l93.1016"></a><span id="l93.1016">   },</span>
<a href="#l93.1017"></a><span id="l93.1017"> </span>
<a href="#l93.1018"></a><span id="l93.1018">   /* Called when the user enters a chat message */</span>
<a href="#l93.1019"></a><span id="l93.1019">   sendMsg(aMsg) {</span>
<a href="#l93.1020"></a><span id="l93.1020">     this._cancelTypingTimer();</span>
<a href="#l93.1021"></a><span id="l93.1021">     let cs = this.shouldSendTypingNotifications ? &quot;active&quot; : null;</span>
<a href="#l93.1022"></a><span id="l93.1022">     let s = Stanza.message(this.to, aMsg, cs);</span>
<a href="#l93.1023"></a><span id="l93.1023" class="difflineat">@@ -712,73 +865,89 @@ var XMPPConversationPrototype = {</span>
<a href="#l93.1024"></a><span id="l93.1024">     _displaySentMsg(this, aMsg);</span>
<a href="#l93.1025"></a><span id="l93.1025">     delete this._typingState;</span>
<a href="#l93.1026"></a><span id="l93.1026">   },</span>
<a href="#l93.1027"></a><span id="l93.1027"> </span>
<a href="#l93.1028"></a><span id="l93.1028">   // Invites the contact to a MUC room.</span>
<a href="#l93.1029"></a><span id="l93.1029">   invite(aRoomJid, aPassword = null) {</span>
<a href="#l93.1030"></a><span id="l93.1030">     // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l93.1031"></a><span id="l93.1031">     // XEP-0045 (7.8.1) and XEP-0249: Direct Invitation.</span>
<a href="#l93.1032"></a><span id="l93.1032" class="difflineminus">-    let x = Stanza.node(&quot;x&quot;, Stanza.NS.conference, {jid: aRoomJid,</span>
<a href="#l93.1033"></a><span id="l93.1033" class="difflineminus">-                                                    password: aPassword});</span>
<a href="#l93.1034"></a><span id="l93.1034" class="difflineminus">-    this._account.sendStanza(Stanza.node(&quot;message&quot;, null, {to: this.to}, x));</span>
<a href="#l93.1035"></a><span id="l93.1035" class="difflineplus">+    let x = Stanza.node(&quot;x&quot;, Stanza.NS.conference, {</span>
<a href="#l93.1036"></a><span id="l93.1036" class="difflineplus">+      jid: aRoomJid,</span>
<a href="#l93.1037"></a><span id="l93.1037" class="difflineplus">+      password: aPassword,</span>
<a href="#l93.1038"></a><span id="l93.1038" class="difflineplus">+    });</span>
<a href="#l93.1039"></a><span id="l93.1039" class="difflineplus">+    this._account.sendStanza(Stanza.node(&quot;message&quot;, null, { to: this.to }, x));</span>
<a href="#l93.1040"></a><span id="l93.1040">   },</span>
<a href="#l93.1041"></a><span id="l93.1041"> </span>
<a href="#l93.1042"></a><span id="l93.1042">   // Query the user for its Software Version.</span>
<a href="#l93.1043"></a><span id="l93.1043">   // XEP-0092: Software Version.</span>
<a href="#l93.1044"></a><span id="l93.1044">   getVersion() {</span>
<a href="#l93.1045"></a><span id="l93.1045">     // TODO: Use Service Discovery to determine if the user's client supports</span>
<a href="#l93.1046"></a><span id="l93.1046">     // jabber:iq:version protocol.</span>
<a href="#l93.1047"></a><span id="l93.1047"> </span>
<a href="#l93.1048"></a><span id="l93.1048" class="difflineminus">-    let s = Stanza.iq(&quot;get&quot;, null, this.to,</span>
<a href="#l93.1049"></a><span id="l93.1049" class="difflineminus">-                      Stanza.node(&quot;query&quot;, Stanza.NS.version));</span>
<a href="#l93.1050"></a><span id="l93.1050" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.1051"></a><span id="l93.1051" class="difflineplus">+      &quot;get&quot;,</span>
<a href="#l93.1052"></a><span id="l93.1052" class="difflineplus">+      null,</span>
<a href="#l93.1053"></a><span id="l93.1053" class="difflineplus">+      this.to,</span>
<a href="#l93.1054"></a><span id="l93.1054" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.version)</span>
<a href="#l93.1055"></a><span id="l93.1055" class="difflineplus">+    );</span>
<a href="#l93.1056"></a><span id="l93.1056">     this._account.sendStanza(s, aStanza =&gt; {</span>
<a href="#l93.1057"></a><span id="l93.1057">       // TODO: handle other errors that can result from querying</span>
<a href="#l93.1058"></a><span id="l93.1058">       // user for its software version.</span>
<a href="#l93.1059"></a><span id="l93.1059" class="difflineminus">-      if (this._account.handleErrors({</span>
<a href="#l93.1060"></a><span id="l93.1060" class="difflineplus">+      if (</span>
<a href="#l93.1061"></a><span id="l93.1061" class="difflineplus">+        this._account.handleErrors(</span>
<a href="#l93.1062"></a><span id="l93.1062" class="difflineplus">+          {</span>
<a href="#l93.1063"></a><span id="l93.1063">             default: _(&quot;conversation.error.version.unknown&quot;),</span>
<a href="#l93.1064"></a><span id="l93.1064" class="difflineminus">-          }, this)(aStanza)) {</span>
<a href="#l93.1065"></a><span id="l93.1065" class="difflineplus">+          },</span>
<a href="#l93.1066"></a><span id="l93.1066" class="difflineplus">+          this</span>
<a href="#l93.1067"></a><span id="l93.1067" class="difflineplus">+        )(aStanza)</span>
<a href="#l93.1068"></a><span id="l93.1068" class="difflineplus">+      ) {</span>
<a href="#l93.1069"></a><span id="l93.1069">         return;</span>
<a href="#l93.1070"></a><span id="l93.1070">       }</span>
<a href="#l93.1071"></a><span id="l93.1071"> </span>
<a href="#l93.1072"></a><span id="l93.1072">       let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l93.1073"></a><span id="l93.1073">       if (!query || query.uri != Stanza.NS.version) {</span>
<a href="#l93.1074"></a><span id="l93.1074" class="difflineminus">-        this.WARN(&quot;Received a response to version query which does not &quot; +</span>
<a href="#l93.1075"></a><span id="l93.1075" class="difflineminus">-                  &quot;contain query element or 'jabber:iq:version' namespace.&quot;);</span>
<a href="#l93.1076"></a><span id="l93.1076" class="difflineplus">+        this.WARN(</span>
<a href="#l93.1077"></a><span id="l93.1077" class="difflineplus">+          &quot;Received a response to version query which does not &quot; +</span>
<a href="#l93.1078"></a><span id="l93.1078" class="difflineplus">+            &quot;contain query element or 'jabber:iq:version' namespace.&quot;</span>
<a href="#l93.1079"></a><span id="l93.1079" class="difflineplus">+        );</span>
<a href="#l93.1080"></a><span id="l93.1080">         return;</span>
<a href="#l93.1081"></a><span id="l93.1081">       }</span>
<a href="#l93.1082"></a><span id="l93.1082"> </span>
<a href="#l93.1083"></a><span id="l93.1083">       let name = query.getElement([&quot;name&quot;]);</span>
<a href="#l93.1084"></a><span id="l93.1084">       let version = query.getElement([&quot;version&quot;]);</span>
<a href="#l93.1085"></a><span id="l93.1085">       if (!name || !version) {</span>
<a href="#l93.1086"></a><span id="l93.1086">         // XEP-0092: name and version elements are REQUIRED.</span>
<a href="#l93.1087"></a><span id="l93.1087" class="difflineminus">-        this.WARN(&quot;Received a response to version query which does not &quot; +</span>
<a href="#l93.1088"></a><span id="l93.1088" class="difflineminus">-                  &quot;contain name or version.&quot;);</span>
<a href="#l93.1089"></a><span id="l93.1089" class="difflineplus">+        this.WARN(</span>
<a href="#l93.1090"></a><span id="l93.1090" class="difflineplus">+          &quot;Received a response to version query which does not &quot; +</span>
<a href="#l93.1091"></a><span id="l93.1091" class="difflineplus">+            &quot;contain name or version.&quot;</span>
<a href="#l93.1092"></a><span id="l93.1092" class="difflineplus">+        );</span>
<a href="#l93.1093"></a><span id="l93.1093">         return;</span>
<a href="#l93.1094"></a><span id="l93.1094">       }</span>
<a href="#l93.1095"></a><span id="l93.1095"> </span>
<a href="#l93.1096"></a><span id="l93.1096">       let messageID = &quot;conversation.message.version&quot;;</span>
<a href="#l93.1097"></a><span id="l93.1097">       let params = [this.shortName, name.innerText, version.innerText];</span>
<a href="#l93.1098"></a><span id="l93.1098"> </span>
<a href="#l93.1099"></a><span id="l93.1099">       // XEP-0092: os is OPTIONAL.</span>
<a href="#l93.1100"></a><span id="l93.1100">       let os = query.getElement([&quot;os&quot;]);</span>
<a href="#l93.1101"></a><span id="l93.1101">       if (os) {</span>
<a href="#l93.1102"></a><span id="l93.1102">         params.push(os.innerText);</span>
<a href="#l93.1103"></a><span id="l93.1103">         messageID += &quot;WithOS&quot;;</span>
<a href="#l93.1104"></a><span id="l93.1104">       }</span>
<a href="#l93.1105"></a><span id="l93.1105"> </span>
<a href="#l93.1106"></a><span id="l93.1106" class="difflineminus">-      this.writeMessage(this.name, _(messageID, ...params), {system: true});</span>
<a href="#l93.1107"></a><span id="l93.1107" class="difflineplus">+      this.writeMessage(this.name, _(messageID, ...params), { system: true });</span>
<a href="#l93.1108"></a><span id="l93.1108">     });</span>
<a href="#l93.1109"></a><span id="l93.1109">   },</span>
<a href="#l93.1110"></a><span id="l93.1110"> </span>
<a href="#l93.1111"></a><span id="l93.1111">   /* Perform entity escaping before displaying the message. We assume incoming</span>
<a href="#l93.1112"></a><span id="l93.1112">      messages have already been escaped, and will otherwise be filtered. */</span>
<a href="#l93.1113"></a><span id="l93.1113">   prepareForDisplaying(aMsg) {</span>
<a href="#l93.1114"></a><span id="l93.1114" class="difflineminus">-    if (aMsg.outgoing &amp;&amp; !aMsg.system)</span>
<a href="#l93.1115"></a><span id="l93.1115" class="difflineplus">+    if (aMsg.outgoing &amp;&amp; !aMsg.system) {</span>
<a href="#l93.1116"></a><span id="l93.1116">       aMsg.displayMessage = TXTToHTML(aMsg.displayMessage);</span>
<a href="#l93.1117"></a><span id="l93.1117" class="difflineplus">+    }</span>
<a href="#l93.1118"></a><span id="l93.1118">     GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l93.1119"></a><span id="l93.1119">   },</span>
<a href="#l93.1120"></a><span id="l93.1120"> </span>
<a href="#l93.1121"></a><span id="l93.1121">   /* Called by the account when a message is received from the buddy */</span>
<a href="#l93.1122"></a><span id="l93.1122">   incomingMessage(aMsg, aStanza, aDate) {</span>
<a href="#l93.1123"></a><span id="l93.1123">     let from = aStanza.attributes.from;</span>
<a href="#l93.1124"></a><span id="l93.1124">     this._targetResource = this._account._parseJID(from).resource;</span>
<a href="#l93.1125"></a><span id="l93.1125">     let flags = {};</span>
<a href="#l93.1126"></a><span id="l93.1126" class="difflineat">@@ -789,45 +958,58 @@ var XMPPConversationPrototype = {</span>
<a href="#l93.1127"></a><span id="l93.1127"> </span>
<a href="#l93.1128"></a><span id="l93.1128">       if (!aMsg) {</span>
<a href="#l93.1129"></a><span id="l93.1129">         // Failed outgoing message.</span>
<a href="#l93.1130"></a><span id="l93.1130">         switch (error.condition) {</span>
<a href="#l93.1131"></a><span id="l93.1131">           case &quot;remote-server-not-found&quot;:</span>
<a href="#l93.1132"></a><span id="l93.1132">             aMsg = _(&quot;conversation.error.remoteServerNotFound&quot;);</span>
<a href="#l93.1133"></a><span id="l93.1133">             break;</span>
<a href="#l93.1134"></a><span id="l93.1134">           case &quot;service-unavailable&quot;:</span>
<a href="#l93.1135"></a><span id="l93.1135" class="difflineminus">-            aMsg = _(&quot;conversation.error.sendServiceUnavailable&quot;, this.shortName);</span>
<a href="#l93.1136"></a><span id="l93.1136" class="difflineplus">+            aMsg = _(</span>
<a href="#l93.1137"></a><span id="l93.1137" class="difflineplus">+              &quot;conversation.error.sendServiceUnavailable&quot;,</span>
<a href="#l93.1138"></a><span id="l93.1138" class="difflineplus">+              this.shortName</span>
<a href="#l93.1139"></a><span id="l93.1139" class="difflineplus">+            );</span>
<a href="#l93.1140"></a><span id="l93.1140">             break;</span>
<a href="#l93.1141"></a><span id="l93.1141">           default:</span>
<a href="#l93.1142"></a><span id="l93.1142">             aMsg = _(&quot;conversation.error.unknownSendError&quot;);</span>
<a href="#l93.1143"></a><span id="l93.1143">             break;</span>
<a href="#l93.1144"></a><span id="l93.1144">         }</span>
<a href="#l93.1145"></a><span id="l93.1145" class="difflineminus">-      }</span>
<a href="#l93.1146"></a><span id="l93.1146" class="difflineminus">-      else if (this._isMucParticipant &amp;&amp; muc &amp;&amp; !muc.left &amp;&amp;</span>
<a href="#l93.1147"></a><span id="l93.1147" class="difflineminus">-               error.condition == &quot;item-not-found&quot;) {</span>
<a href="#l93.1148"></a><span id="l93.1148" class="difflineplus">+      } else if (</span>
<a href="#l93.1149"></a><span id="l93.1149" class="difflineplus">+        this._isMucParticipant &amp;&amp;</span>
<a href="#l93.1150"></a><span id="l93.1150" class="difflineplus">+        muc &amp;&amp;</span>
<a href="#l93.1151"></a><span id="l93.1151" class="difflineplus">+        !muc.left &amp;&amp;</span>
<a href="#l93.1152"></a><span id="l93.1152" class="difflineplus">+        error.condition == &quot;item-not-found&quot;</span>
<a href="#l93.1153"></a><span id="l93.1153" class="difflineplus">+      ) {</span>
<a href="#l93.1154"></a><span id="l93.1154">         // XEP-0045 (7.5): MUC private messages.</span>
<a href="#l93.1155"></a><span id="l93.1155">         // If we try to send to participant not in a room we are in.</span>
<a href="#l93.1156"></a><span id="l93.1156" class="difflineminus">-        aMsg = _(&quot;conversation.error.sendFailedAsRecipientNotInRoom&quot;,</span>
<a href="#l93.1157"></a><span id="l93.1157" class="difflineminus">-                 this._targetResource, aMsg);</span>
<a href="#l93.1158"></a><span id="l93.1158" class="difflineminus">-      }</span>
<a href="#l93.1159"></a><span id="l93.1159" class="difflineminus">-      else if (this._isMucParticipant &amp;&amp;</span>
<a href="#l93.1160"></a><span id="l93.1160" class="difflineminus">-               (error.condition == &quot;item-not-found&quot; ||</span>
<a href="#l93.1161"></a><span id="l93.1161" class="difflineminus">-                error.condition == &quot;not-acceptable&quot;)) {</span>
<a href="#l93.1162"></a><span id="l93.1162" class="difflineplus">+        aMsg = _(</span>
<a href="#l93.1163"></a><span id="l93.1163" class="difflineplus">+          &quot;conversation.error.sendFailedAsRecipientNotInRoom&quot;,</span>
<a href="#l93.1164"></a><span id="l93.1164" class="difflineplus">+          this._targetResource,</span>
<a href="#l93.1165"></a><span id="l93.1165" class="difflineplus">+          aMsg</span>
<a href="#l93.1166"></a><span id="l93.1166" class="difflineplus">+        );</span>
<a href="#l93.1167"></a><span id="l93.1167" class="difflineplus">+      } else if (</span>
<a href="#l93.1168"></a><span id="l93.1168" class="difflineplus">+        this._isMucParticipant &amp;&amp;</span>
<a href="#l93.1169"></a><span id="l93.1169" class="difflineplus">+        (error.condition == &quot;item-not-found&quot; ||</span>
<a href="#l93.1170"></a><span id="l93.1170" class="difflineplus">+          error.condition == &quot;not-acceptable&quot;)</span>
<a href="#l93.1171"></a><span id="l93.1171" class="difflineplus">+      ) {</span>
<a href="#l93.1172"></a><span id="l93.1172">         // If we left a room and try to send to a participant in it or the</span>
<a href="#l93.1173"></a><span id="l93.1173">         // room is removed.</span>
<a href="#l93.1174"></a><span id="l93.1174" class="difflineminus">-        aMsg = _(&quot;conversation.error.sendFailedAsNotInRoom&quot;,</span>
<a href="#l93.1175"></a><span id="l93.1175" class="difflineminus">-                 this._account.normalize(from), aMsg);</span>
<a href="#l93.1176"></a><span id="l93.1176" class="difflineplus">+        aMsg = _(</span>
<a href="#l93.1177"></a><span id="l93.1177" class="difflineplus">+          &quot;conversation.error.sendFailedAsNotInRoom&quot;,</span>
<a href="#l93.1178"></a><span id="l93.1178" class="difflineplus">+          this._account.normalize(from),</span>
<a href="#l93.1179"></a><span id="l93.1179" class="difflineplus">+          aMsg</span>
<a href="#l93.1180"></a><span id="l93.1180" class="difflineplus">+        );</span>
<a href="#l93.1181"></a><span id="l93.1181" class="difflineplus">+      } else {</span>
<a href="#l93.1182"></a><span id="l93.1182" class="difflineplus">+        aMsg = _(&quot;conversation.error.notDelivered&quot;, aMsg);</span>
<a href="#l93.1183"></a><span id="l93.1183">       }</span>
<a href="#l93.1184"></a><span id="l93.1184" class="difflineminus">-      else</span>
<a href="#l93.1185"></a><span id="l93.1185" class="difflineminus">-        aMsg = _(&quot;conversation.error.notDelivered&quot;, aMsg);</span>
<a href="#l93.1186"></a><span id="l93.1186">       flags.system = true;</span>
<a href="#l93.1187"></a><span id="l93.1187">       flags.error = true;</span>
<a href="#l93.1188"></a><span id="l93.1188" class="difflineplus">+    } else {</span>
<a href="#l93.1189"></a><span id="l93.1189" class="difflineplus">+      flags = { incoming: true, _alias: this.contactDisplayName };</span>
<a href="#l93.1190"></a><span id="l93.1190">     }</span>
<a href="#l93.1191"></a><span id="l93.1191" class="difflineminus">-    else</span>
<a href="#l93.1192"></a><span id="l93.1192" class="difflineminus">-      flags = {incoming: true, _alias: this.contactDisplayName};</span>
<a href="#l93.1193"></a><span id="l93.1193">     if (aDate) {</span>
<a href="#l93.1194"></a><span id="l93.1194">       flags.time = aDate / 1000;</span>
<a href="#l93.1195"></a><span id="l93.1195">       flags.delayed = true;</span>
<a href="#l93.1196"></a><span id="l93.1196">     }</span>
<a href="#l93.1197"></a><span id="l93.1197">     this.writeMessage(from, aMsg, flags);</span>
<a href="#l93.1198"></a><span id="l93.1198">   },</span>
<a href="#l93.1199"></a><span id="l93.1199"> </span>
<a href="#l93.1200"></a><span id="l93.1200">   /* Called when the user closed the conversation */</span>
<a href="#l93.1201"></a><span id="l93.1201" class="difflineat">@@ -837,213 +1019,269 @@ var XMPPConversationPrototype = {</span>
<a href="#l93.1202"></a><span id="l93.1202">   },</span>
<a href="#l93.1203"></a><span id="l93.1203">   unInit() {</span>
<a href="#l93.1204"></a><span id="l93.1204">     this._account.removeConversation(this.normalizedName);</span>
<a href="#l93.1205"></a><span id="l93.1205">     GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l93.1206"></a><span id="l93.1206">   },</span>
<a href="#l93.1207"></a><span id="l93.1207"> };</span>
<a href="#l93.1208"></a><span id="l93.1208"> </span>
<a href="#l93.1209"></a><span id="l93.1209"> // Creates XMPP conversation.</span>
<a href="#l93.1210"></a><span id="l93.1210" class="difflineminus">-function XMPPConversation(aAccount, aNormalizedName, aMucParticipant)</span>
<a href="#l93.1211"></a><span id="l93.1211" class="difflineminus">-{</span>
<a href="#l93.1212"></a><span id="l93.1212" class="difflineplus">+function XMPPConversation(aAccount, aNormalizedName, aMucParticipant) {</span>
<a href="#l93.1213"></a><span id="l93.1213">   this._init(aAccount, aNormalizedName);</span>
<a href="#l93.1214"></a><span id="l93.1214" class="difflineminus">-  if (aMucParticipant)</span>
<a href="#l93.1215"></a><span id="l93.1215" class="difflineplus">+  if (aMucParticipant) {</span>
<a href="#l93.1216"></a><span id="l93.1216">     this._isMucParticipant = true;</span>
<a href="#l93.1217"></a><span id="l93.1217" class="difflineplus">+  }</span>
<a href="#l93.1218"></a><span id="l93.1218"> }</span>
<a href="#l93.1219"></a><span id="l93.1219"> XMPPConversation.prototype = XMPPConversationPrototype;</span>
<a href="#l93.1220"></a><span id="l93.1220"> </span>
<a href="#l93.1221"></a><span id="l93.1221"> /* Helper class for buddies */</span>
<a href="#l93.1222"></a><span id="l93.1222"> var XMPPAccountBuddyPrototype = {</span>
<a href="#l93.1223"></a><span id="l93.1223">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l93.1224"></a><span id="l93.1224"> </span>
<a href="#l93.1225"></a><span id="l93.1225">   subscription: &quot;none&quot;,</span>
<a href="#l93.1226"></a><span id="l93.1226">   // Returns a list of TooltipInfo objects to be displayed when the user</span>
<a href="#l93.1227"></a><span id="l93.1227">   // hovers over the buddy.</span>
<a href="#l93.1228"></a><span id="l93.1228">   getTooltipInfo() {</span>
<a href="#l93.1229"></a><span id="l93.1229" class="difflineminus">-    if (!this._account.connected)</span>
<a href="#l93.1230"></a><span id="l93.1230" class="difflineplus">+    if (!this._account.connected) {</span>
<a href="#l93.1231"></a><span id="l93.1231">       return null;</span>
<a href="#l93.1232"></a><span id="l93.1232" class="difflineplus">+    }</span>
<a href="#l93.1233"></a><span id="l93.1233"> </span>
<a href="#l93.1234"></a><span id="l93.1234">     let tooltipInfo = [];</span>
<a href="#l93.1235"></a><span id="l93.1235">     if (this._resources) {</span>
<a href="#l93.1236"></a><span id="l93.1236">       for (let r in this._resources) {</span>
<a href="#l93.1237"></a><span id="l93.1237">         let status = this._resources[r];</span>
<a href="#l93.1238"></a><span id="l93.1238">         let statusString = Status.toLabel(status.statusType);</span>
<a href="#l93.1239"></a><span id="l93.1239" class="difflineminus">-        if (status.statusType == Ci.imIStatusInfo.STATUS_IDLE &amp;&amp;</span>
<a href="#l93.1240"></a><span id="l93.1240" class="difflineminus">-            status.idleSince) {</span>
<a href="#l93.1241"></a><span id="l93.1241" class="difflineplus">+        if (</span>
<a href="#l93.1242"></a><span id="l93.1242" class="difflineplus">+          status.statusType == Ci.imIStatusInfo.STATUS_IDLE &amp;&amp;</span>
<a href="#l93.1243"></a><span id="l93.1243" class="difflineplus">+          status.idleSince</span>
<a href="#l93.1244"></a><span id="l93.1244" class="difflineplus">+        ) {</span>
<a href="#l93.1245"></a><span id="l93.1245">           let now = Math.floor(Date.now() / 1000);</span>
<a href="#l93.1246"></a><span id="l93.1246" class="difflineminus">-          let valuesAndUnits =</span>
<a href="#l93.1247"></a><span id="l93.1247" class="difflineminus">-            DownloadUtils.convertTimeUnits(now - status.idleSince);</span>
<a href="#l93.1248"></a><span id="l93.1248" class="difflineminus">-          if (!valuesAndUnits[2])</span>
<a href="#l93.1249"></a><span id="l93.1249" class="difflineplus">+          let valuesAndUnits = DownloadUtils.convertTimeUnits(</span>
<a href="#l93.1250"></a><span id="l93.1250" class="difflineplus">+            now - status.idleSince</span>
<a href="#l93.1251"></a><span id="l93.1251" class="difflineplus">+          );</span>
<a href="#l93.1252"></a><span id="l93.1252" class="difflineplus">+          if (!valuesAndUnits[2]) {</span>
<a href="#l93.1253"></a><span id="l93.1253">             valuesAndUnits.splice(2, 2);</span>
<a href="#l93.1254"></a><span id="l93.1254" class="difflineplus">+          }</span>
<a href="#l93.1255"></a><span id="l93.1255">           statusString += &quot; (&quot; + valuesAndUnits.join(&quot; &quot;) + &quot;)&quot;;</span>
<a href="#l93.1256"></a><span id="l93.1256">         }</span>
<a href="#l93.1257"></a><span id="l93.1257" class="difflineminus">-        if (status.statusText)</span>
<a href="#l93.1258"></a><span id="l93.1258" class="difflineplus">+        if (status.statusText) {</span>
<a href="#l93.1259"></a><span id="l93.1259">           statusString += &quot; - &quot; + status.statusText;</span>
<a href="#l93.1260"></a><span id="l93.1260" class="difflineplus">+        }</span>
<a href="#l93.1261"></a><span id="l93.1261">         let label = r ? _(&quot;tooltip.status&quot;, r) : _(&quot;tooltip.statusNoResource&quot;);</span>
<a href="#l93.1262"></a><span id="l93.1262">         tooltipInfo.push(new TooltipInfo(label, statusString));</span>
<a href="#l93.1263"></a><span id="l93.1263">       }</span>
<a href="#l93.1264"></a><span id="l93.1264">     }</span>
<a href="#l93.1265"></a><span id="l93.1265"> </span>
<a href="#l93.1266"></a><span id="l93.1266">     // The subscription value is interesting to display only in unusual cases.</span>
<a href="#l93.1267"></a><span id="l93.1267">     if (this.subscription != &quot;both&quot;) {</span>
<a href="#l93.1268"></a><span id="l93.1268" class="difflineminus">-      tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.subscription&quot;),</span>
<a href="#l93.1269"></a><span id="l93.1269" class="difflineminus">-                                       this.subscription));</span>
<a href="#l93.1270"></a><span id="l93.1270" class="difflineplus">+      tooltipInfo.push(</span>
<a href="#l93.1271"></a><span id="l93.1271" class="difflineplus">+        new TooltipInfo(_(&quot;tooltip.subscription&quot;), this.subscription)</span>
<a href="#l93.1272"></a><span id="l93.1272" class="difflineplus">+      );</span>
<a href="#l93.1273"></a><span id="l93.1273">     }</span>
<a href="#l93.1274"></a><span id="l93.1274"> </span>
<a href="#l93.1275"></a><span id="l93.1275">     return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l93.1276"></a><span id="l93.1276">   },</span>
<a href="#l93.1277"></a><span id="l93.1277"> </span>
<a href="#l93.1278"></a><span id="l93.1278">   // _rosterAlias is the value stored in the roster on the XMPP</span>
<a href="#l93.1279"></a><span id="l93.1279">   // server. For most servers we will be read/write.</span>
<a href="#l93.1280"></a><span id="l93.1280">   _rosterAlias: &quot;&quot;,</span>
<a href="#l93.1281"></a><span id="l93.1281">   set rosterAlias(aNewAlias) {</span>
<a href="#l93.1282"></a><span id="l93.1282">     let old = this.displayName;</span>
<a href="#l93.1283"></a><span id="l93.1283">     this._rosterAlias = aNewAlias;</span>
<a href="#l93.1284"></a><span id="l93.1284" class="difflineminus">-    if (old != this.displayName)</span>
<a href="#l93.1285"></a><span id="l93.1285" class="difflineplus">+    if (old != this.displayName) {</span>
<a href="#l93.1286"></a><span id="l93.1286">       this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l93.1287"></a><span id="l93.1287" class="difflineplus">+    }</span>
<a href="#l93.1288"></a><span id="l93.1288">   },</span>
<a href="#l93.1289"></a><span id="l93.1289">   _vCardReceived: false,</span>
<a href="#l93.1290"></a><span id="l93.1290">   // _vCardFormattedName is the display name the contact has set for</span>
<a href="#l93.1291"></a><span id="l93.1291">   // himself in his vCard. It's read-only from our point of view.</span>
<a href="#l93.1292"></a><span id="l93.1292">   _vCardFormattedName: &quot;&quot;,</span>
<a href="#l93.1293"></a><span id="l93.1293">   set vCardFormattedName(aNewFormattedName) {</span>
<a href="#l93.1294"></a><span id="l93.1294">     let old = this.displayName;</span>
<a href="#l93.1295"></a><span id="l93.1295">     this._vCardFormattedName = aNewFormattedName;</span>
<a href="#l93.1296"></a><span id="l93.1296" class="difflineminus">-    if (old != this.displayName)</span>
<a href="#l93.1297"></a><span id="l93.1297" class="difflineplus">+    if (old != this.displayName) {</span>
<a href="#l93.1298"></a><span id="l93.1298">       this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l93.1299"></a><span id="l93.1299" class="difflineplus">+    }</span>
<a href="#l93.1300"></a><span id="l93.1300">   },</span>
<a href="#l93.1301"></a><span id="l93.1301"> </span>
<a href="#l93.1302"></a><span id="l93.1302">   // _serverAlias is set by jsProtoHelper to the value we cached in sqlite.</span>
<a href="#l93.1303"></a><span id="l93.1303">   // Use it only if we have neither of the other two values; usually because</span>
<a href="#l93.1304"></a><span id="l93.1304">   // we haven't connected to the server yet.</span>
<a href="#l93.1305"></a><span id="l93.1305" class="difflineminus">-  get serverAlias() { return this._rosterAlias || this._vCardFormattedName || this._serverAlias; },</span>
<a href="#l93.1306"></a><span id="l93.1306" class="difflineplus">+  get serverAlias() {</span>
<a href="#l93.1307"></a><span id="l93.1307" class="difflineplus">+    return this._rosterAlias || this._vCardFormattedName || this._serverAlias;</span>
<a href="#l93.1308"></a><span id="l93.1308" class="difflineplus">+  },</span>
<a href="#l93.1309"></a><span id="l93.1309">   set serverAlias(aNewAlias) {</span>
<a href="#l93.1310"></a><span id="l93.1310">     if (!this._rosterItem) {</span>
<a href="#l93.1311"></a><span id="l93.1311" class="difflineminus">-      this.ERROR(&quot;attempting to update the server alias of an account buddy &quot; +</span>
<a href="#l93.1312"></a><span id="l93.1312" class="difflineminus">-                 &quot;for which we haven't received a roster item.&quot;);</span>
<a href="#l93.1313"></a><span id="l93.1313" class="difflineplus">+      this.ERROR(</span>
<a href="#l93.1314"></a><span id="l93.1314" class="difflineplus">+        &quot;attempting to update the server alias of an account buddy &quot; +</span>
<a href="#l93.1315"></a><span id="l93.1315" class="difflineplus">+          &quot;for which we haven't received a roster item.&quot;</span>
<a href="#l93.1316"></a><span id="l93.1316" class="difflineplus">+      );</span>
<a href="#l93.1317"></a><span id="l93.1317">       return;</span>
<a href="#l93.1318"></a><span id="l93.1318">     }</span>
<a href="#l93.1319"></a><span id="l93.1319"> </span>
<a href="#l93.1320"></a><span id="l93.1320">     let item = this._rosterItem;</span>
<a href="#l93.1321"></a><span id="l93.1321" class="difflineminus">-    if (aNewAlias)</span>
<a href="#l93.1322"></a><span id="l93.1322" class="difflineplus">+    if (aNewAlias) {</span>
<a href="#l93.1323"></a><span id="l93.1323">       item.attributes.name = aNewAlias;</span>
<a href="#l93.1324"></a><span id="l93.1324" class="difflineminus">-    else if (&quot;name&quot; in item.attributes)</span>
<a href="#l93.1325"></a><span id="l93.1325" class="difflineplus">+    } else if (&quot;name&quot; in item.attributes) {</span>
<a href="#l93.1326"></a><span id="l93.1326">       delete item.attributes.name;</span>
<a href="#l93.1327"></a><span id="l93.1327" class="difflineminus">-</span>
<a href="#l93.1328"></a><span id="l93.1328" class="difflineminus">-    let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l93.1329"></a><span id="l93.1329" class="difflineminus">-                      Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item));</span>
<a href="#l93.1330"></a><span id="l93.1330" class="difflineplus">+    }</span>
<a href="#l93.1331"></a><span id="l93.1331" class="difflineplus">+</span>
<a href="#l93.1332"></a><span id="l93.1332" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.1333"></a><span id="l93.1333" class="difflineplus">+      &quot;set&quot;,</span>
<a href="#l93.1334"></a><span id="l93.1334" class="difflineplus">+      null,</span>
<a href="#l93.1335"></a><span id="l93.1335" class="difflineplus">+      null,</span>
<a href="#l93.1336"></a><span id="l93.1336" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item)</span>
<a href="#l93.1337"></a><span id="l93.1337" class="difflineplus">+    );</span>
<a href="#l93.1338"></a><span id="l93.1338">     this._account.sendStanza(s);</span>
<a href="#l93.1339"></a><span id="l93.1339"> </span>
<a href="#l93.1340"></a><span id="l93.1340">     // If we are going to change the alias on the server, discard the cached</span>
<a href="#l93.1341"></a><span id="l93.1341">     // value that we got from our local sqlite storage at startup.</span>
<a href="#l93.1342"></a><span id="l93.1342">     delete this._serverAlias;</span>
<a href="#l93.1343"></a><span id="l93.1343">   },</span>
<a href="#l93.1344"></a><span id="l93.1344"> </span>
<a href="#l93.1345"></a><span id="l93.1345">   /* Display name of the buddy */</span>
<a href="#l93.1346"></a><span id="l93.1346" class="difflineminus">-  get contactDisplayName() { return this.buddy.contact.displayName || this.displayName; },</span>
<a href="#l93.1347"></a><span id="l93.1347" class="difflineminus">-</span>
<a href="#l93.1348"></a><span id="l93.1348" class="difflineminus">-  get tag() { return this._tag; },</span>
<a href="#l93.1349"></a><span id="l93.1349" class="difflineplus">+  get contactDisplayName() {</span>
<a href="#l93.1350"></a><span id="l93.1350" class="difflineplus">+    return this.buddy.contact.displayName || this.displayName;</span>
<a href="#l93.1351"></a><span id="l93.1351" class="difflineplus">+  },</span>
<a href="#l93.1352"></a><span id="l93.1352" class="difflineplus">+</span>
<a href="#l93.1353"></a><span id="l93.1353" class="difflineplus">+  get tag() {</span>
<a href="#l93.1354"></a><span id="l93.1354" class="difflineplus">+    return this._tag;</span>
<a href="#l93.1355"></a><span id="l93.1355" class="difflineplus">+  },</span>
<a href="#l93.1356"></a><span id="l93.1356">   set tag(aNewTag) {</span>
<a href="#l93.1357"></a><span id="l93.1357">     let oldTag = this._tag;</span>
<a href="#l93.1358"></a><span id="l93.1358">     if (oldTag.name == aNewTag.name) {</span>
<a href="#l93.1359"></a><span id="l93.1359">       this.ERROR(&quot;attempting to set the tag to the same value&quot;);</span>
<a href="#l93.1360"></a><span id="l93.1360">       return;</span>
<a href="#l93.1361"></a><span id="l93.1361">     }</span>
<a href="#l93.1362"></a><span id="l93.1362"> </span>
<a href="#l93.1363"></a><span id="l93.1363">     this._tag = aNewTag;</span>
<a href="#l93.1364"></a><span id="l93.1364">     Services.contacts.accountBuddyMoved(this, oldTag, aNewTag);</span>
<a href="#l93.1365"></a><span id="l93.1365"> </span>
<a href="#l93.1366"></a><span id="l93.1366">     if (!this._rosterItem) {</span>
<a href="#l93.1367"></a><span id="l93.1367" class="difflineminus">-      this.ERROR(&quot;attempting to change the tag of an account buddy without roster item&quot;);</span>
<a href="#l93.1368"></a><span id="l93.1368" class="difflineplus">+      this.ERROR(</span>
<a href="#l93.1369"></a><span id="l93.1369" class="difflineplus">+        &quot;attempting to change the tag of an account buddy without roster item&quot;</span>
<a href="#l93.1370"></a><span id="l93.1370" class="difflineplus">+      );</span>
<a href="#l93.1371"></a><span id="l93.1371">       return;</span>
<a href="#l93.1372"></a><span id="l93.1372">     }</span>
<a href="#l93.1373"></a><span id="l93.1373"> </span>
<a href="#l93.1374"></a><span id="l93.1374">     let item = this._rosterItem;</span>
<a href="#l93.1375"></a><span id="l93.1375">     let oldXML = item.getXML();</span>
<a href="#l93.1376"></a><span id="l93.1376">     // Remove the old tag if it was listed in the roster item.</span>
<a href="#l93.1377"></a><span id="l93.1377" class="difflineminus">-    item.children =</span>
<a href="#l93.1378"></a><span id="l93.1378" class="difflineminus">-      item.children.filter(c =&gt; c.qName != &quot;group&quot; ||</span>
<a href="#l93.1379"></a><span id="l93.1379" class="difflineminus">-                                c.innerText != oldTag.name);</span>
<a href="#l93.1380"></a><span id="l93.1380" class="difflineplus">+    item.children = item.children.filter(</span>
<a href="#l93.1381"></a><span id="l93.1381" class="difflineplus">+      c =&gt; c.qName != &quot;group&quot; || c.innerText != oldTag.name</span>
<a href="#l93.1382"></a><span id="l93.1382" class="difflineplus">+    );</span>
<a href="#l93.1383"></a><span id="l93.1383">     // Ensure the new tag is listed.</span>
<a href="#l93.1384"></a><span id="l93.1384">     let newTagName = aNewTag.name;</span>
<a href="#l93.1385"></a><span id="l93.1385" class="difflineminus">-    if (!item.getChildren(&quot;group&quot;).some(g =&gt; g.innerText == newTagName))</span>
<a href="#l93.1386"></a><span id="l93.1386" class="difflineplus">+    if (!item.getChildren(&quot;group&quot;).some(g =&gt; g.innerText == newTagName)) {</span>
<a href="#l93.1387"></a><span id="l93.1387">       item.addChild(Stanza.node(&quot;group&quot;, null, null, newTagName));</span>
<a href="#l93.1388"></a><span id="l93.1388" class="difflineplus">+    }</span>
<a href="#l93.1389"></a><span id="l93.1389">     // Avoid sending anything to the server if the roster item hasn't changed.</span>
<a href="#l93.1390"></a><span id="l93.1390">     // It's possible that the roster item hasn't changed if the roster</span>
<a href="#l93.1391"></a><span id="l93.1391">     // item had several groups and the user moved locally the contact</span>
<a href="#l93.1392"></a><span id="l93.1392">     // to another group where it already was on the server.</span>
<a href="#l93.1393"></a><span id="l93.1393" class="difflineminus">-    if (item.getXML() == oldXML)</span>
<a href="#l93.1394"></a><span id="l93.1394" class="difflineplus">+    if (item.getXML() == oldXML) {</span>
<a href="#l93.1395"></a><span id="l93.1395">       return;</span>
<a href="#l93.1396"></a><span id="l93.1396" class="difflineminus">-</span>
<a href="#l93.1397"></a><span id="l93.1397" class="difflineminus">-    let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l93.1398"></a><span id="l93.1398" class="difflineminus">-                      Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item));</span>
<a href="#l93.1399"></a><span id="l93.1399" class="difflineplus">+    }</span>
<a href="#l93.1400"></a><span id="l93.1400" class="difflineplus">+</span>
<a href="#l93.1401"></a><span id="l93.1401" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.1402"></a><span id="l93.1402" class="difflineplus">+      &quot;set&quot;,</span>
<a href="#l93.1403"></a><span id="l93.1403" class="difflineplus">+      null,</span>
<a href="#l93.1404"></a><span id="l93.1404" class="difflineplus">+      null,</span>
<a href="#l93.1405"></a><span id="l93.1405" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item)</span>
<a href="#l93.1406"></a><span id="l93.1406" class="difflineplus">+    );</span>
<a href="#l93.1407"></a><span id="l93.1407">     this._account.sendStanza(s);</span>
<a href="#l93.1408"></a><span id="l93.1408">   },</span>
<a href="#l93.1409"></a><span id="l93.1409"> </span>
<a href="#l93.1410"></a><span id="l93.1410">   remove() {</span>
<a href="#l93.1411"></a><span id="l93.1411" class="difflineminus">-    if (!this._account.connected)</span>
<a href="#l93.1412"></a><span id="l93.1412" class="difflineplus">+    if (!this._account.connected) {</span>
<a href="#l93.1413"></a><span id="l93.1413">       return;</span>
<a href="#l93.1414"></a><span id="l93.1414" class="difflineminus">-</span>
<a href="#l93.1415"></a><span id="l93.1415" class="difflineminus">-    let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l93.1416"></a><span id="l93.1416" class="difflineminus">-                      Stanza.node(&quot;query&quot;, Stanza.NS.roster, null,</span>
<a href="#l93.1417"></a><span id="l93.1417" class="difflineminus">-                                  Stanza.node(&quot;item&quot;, null,</span>
<a href="#l93.1418"></a><span id="l93.1418" class="difflineminus">-                                              {jid: this.normalizedName,</span>
<a href="#l93.1419"></a><span id="l93.1419" class="difflineminus">-                                               subscription: &quot;remove&quot;})));</span>
<a href="#l93.1420"></a><span id="l93.1420" class="difflineplus">+    }</span>
<a href="#l93.1421"></a><span id="l93.1421" class="difflineplus">+</span>
<a href="#l93.1422"></a><span id="l93.1422" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.1423"></a><span id="l93.1423" class="difflineplus">+      &quot;set&quot;,</span>
<a href="#l93.1424"></a><span id="l93.1424" class="difflineplus">+      null,</span>
<a href="#l93.1425"></a><span id="l93.1425" class="difflineplus">+      null,</span>
<a href="#l93.1426"></a><span id="l93.1426" class="difflineplus">+      Stanza.node(</span>
<a href="#l93.1427"></a><span id="l93.1427" class="difflineplus">+        &quot;query&quot;,</span>
<a href="#l93.1428"></a><span id="l93.1428" class="difflineplus">+        Stanza.NS.roster,</span>
<a href="#l93.1429"></a><span id="l93.1429" class="difflineplus">+        null,</span>
<a href="#l93.1430"></a><span id="l93.1430" class="difflineplus">+        Stanza.node(&quot;item&quot;, null, {</span>
<a href="#l93.1431"></a><span id="l93.1431" class="difflineplus">+          jid: this.normalizedName,</span>
<a href="#l93.1432"></a><span id="l93.1432" class="difflineplus">+          subscription: &quot;remove&quot;,</span>
<a href="#l93.1433"></a><span id="l93.1433" class="difflineplus">+        })</span>
<a href="#l93.1434"></a><span id="l93.1434" class="difflineplus">+      )</span>
<a href="#l93.1435"></a><span id="l93.1435" class="difflineplus">+    );</span>
<a href="#l93.1436"></a><span id="l93.1436">     this._account.sendStanza(s);</span>
<a href="#l93.1437"></a><span id="l93.1437">   },</span>
<a href="#l93.1438"></a><span id="l93.1438"> </span>
<a href="#l93.1439"></a><span id="l93.1439">   _photoHash: null,</span>
<a href="#l93.1440"></a><span id="l93.1440">   _saveIcon(aPhotoNode) {</span>
<a href="#l93.1441"></a><span id="l93.1441">     // Some servers seem to send a photo node without a type declared.</span>
<a href="#l93.1442"></a><span id="l93.1442">     let type = aPhotoNode.getElement([&quot;TYPE&quot;]);</span>
<a href="#l93.1443"></a><span id="l93.1443" class="difflineminus">-    if (!type)</span>
<a href="#l93.1444"></a><span id="l93.1444" class="difflineminus">-      return;</span>
<a href="#l93.1445"></a><span id="l93.1445" class="difflineminus">-    type = type.innerText;</span>
<a href="#l93.1446"></a><span id="l93.1446" class="difflineminus">-    const kExt = {&quot;image/gif&quot;: &quot;gif&quot;, &quot;image/jpeg&quot;: &quot;jpg&quot;, &quot;image/png&quot;: &quot;png&quot;};</span>
<a href="#l93.1447"></a><span id="l93.1447" class="difflineminus">-    if (!kExt.hasOwnProperty(type))</span>
<a href="#l93.1448"></a><span id="l93.1448" class="difflineplus">+    if (!type) {</span>
<a href="#l93.1449"></a><span id="l93.1449">       return;</span>
<a href="#l93.1450"></a><span id="l93.1450" class="difflineminus">-</span>
<a href="#l93.1451"></a><span id="l93.1451" class="difflineminus">-    let content = &quot;&quot;, data = &quot;&quot;;</span>
<a href="#l93.1452"></a><span id="l93.1452" class="difflineplus">+    }</span>
<a href="#l93.1453"></a><span id="l93.1453" class="difflineplus">+    type = type.innerText;</span>
<a href="#l93.1454"></a><span id="l93.1454" class="difflineplus">+    const kExt = {</span>
<a href="#l93.1455"></a><span id="l93.1455" class="difflineplus">+      &quot;image/gif&quot;: &quot;gif&quot;,</span>
<a href="#l93.1456"></a><span id="l93.1456" class="difflineplus">+      &quot;image/jpeg&quot;: &quot;jpg&quot;,</span>
<a href="#l93.1457"></a><span id="l93.1457" class="difflineplus">+      &quot;image/png&quot;: &quot;png&quot;,</span>
<a href="#l93.1458"></a><span id="l93.1458" class="difflineplus">+    };</span>
<a href="#l93.1459"></a><span id="l93.1459" class="difflineplus">+    if (!kExt.hasOwnProperty(type)) {</span>
<a href="#l93.1460"></a><span id="l93.1460" class="difflineplus">+      return;</span>
<a href="#l93.1461"></a><span id="l93.1461" class="difflineplus">+    }</span>
<a href="#l93.1462"></a><span id="l93.1462" class="difflineplus">+</span>
<a href="#l93.1463"></a><span id="l93.1463" class="difflineplus">+    let content = &quot;&quot;,</span>
<a href="#l93.1464"></a><span id="l93.1464" class="difflineplus">+      data = &quot;&quot;;</span>
<a href="#l93.1465"></a><span id="l93.1465">     // Strip all characters not allowed in base64 before parsing.</span>
<a href="#l93.1466"></a><span id="l93.1466" class="difflineminus">-    let parseBase64 =</span>
<a href="#l93.1467"></a><span id="l93.1467" class="difflineminus">-      (aBase) =&gt; atob(aBase.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;));</span>
<a href="#l93.1468"></a><span id="l93.1468" class="difflineplus">+    let parseBase64 = aBase =&gt; atob(aBase.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;));</span>
<a href="#l93.1469"></a><span id="l93.1469">     for (let line of aPhotoNode.getElement([&quot;BINVAL&quot;]).innerText.split(&quot;\n&quot;)) {</span>
<a href="#l93.1470"></a><span id="l93.1470">       data += line;</span>
<a href="#l93.1471"></a><span id="l93.1471">       // Mozilla's atob() doesn't handle padding with &quot;=&quot; or &quot;==&quot;</span>
<a href="#l93.1472"></a><span id="l93.1472">       // unless it's at the end of the string, so we have to work around that.</span>
<a href="#l93.1473"></a><span id="l93.1473">       if (line.endsWith(&quot;=&quot;)) {</span>
<a href="#l93.1474"></a><span id="l93.1474">         content += parseBase64(data);</span>
<a href="#l93.1475"></a><span id="l93.1475">         data = &quot;&quot;;</span>
<a href="#l93.1476"></a><span id="l93.1476">       }</span>
<a href="#l93.1477"></a><span id="l93.1477">     }</span>
<a href="#l93.1478"></a><span id="l93.1478">     content += parseBase64(data);</span>
<a href="#l93.1479"></a><span id="l93.1479"> </span>
<a href="#l93.1480"></a><span id="l93.1480">     // Store a sha1 hash of the photo we have just received.</span>
<a href="#l93.1481"></a><span id="l93.1481" class="difflineminus">-    let ch = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l93.1482"></a><span id="l93.1482" class="difflineplus">+    let ch = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l93.1483"></a><span id="l93.1483" class="difflineplus">+      Ci.nsICryptoHash</span>
<a href="#l93.1484"></a><span id="l93.1484" class="difflineplus">+    );</span>
<a href="#l93.1485"></a><span id="l93.1485">     ch.init(ch.SHA1);</span>
<a href="#l93.1486"></a><span id="l93.1486">     let dataArray = Object.keys(content).map(i =&gt; content.charCodeAt(i));</span>
<a href="#l93.1487"></a><span id="l93.1487">     ch.update(dataArray, dataArray.length);</span>
<a href="#l93.1488"></a><span id="l93.1488">     let hash = ch.finish(false);</span>
<a href="#l93.1489"></a><span id="l93.1489" class="difflineminus">-    function toHexString(charCode) { return (&quot;0&quot; + charCode.toString(16)).slice(-2); }</span>
<a href="#l93.1490"></a><span id="l93.1490" class="difflineminus">-    this._photoHash = Object.keys(hash).map(i =&gt; toHexString(hash.charCodeAt(i))).join(&quot;&quot;);</span>
<a href="#l93.1491"></a><span id="l93.1491" class="difflineminus">-</span>
<a href="#l93.1492"></a><span id="l93.1492" class="difflineminus">-    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l93.1493"></a><span id="l93.1493" class="difflineminus">-                  .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l93.1494"></a><span id="l93.1494" class="difflineplus">+    function toHexString(charCode) {</span>
<a href="#l93.1495"></a><span id="l93.1495" class="difflineplus">+      return (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l93.1496"></a><span id="l93.1496" class="difflineplus">+    }</span>
<a href="#l93.1497"></a><span id="l93.1497" class="difflineplus">+    this._photoHash = Object.keys(hash)</span>
<a href="#l93.1498"></a><span id="l93.1498" class="difflineplus">+      .map(i =&gt; toHexString(hash.charCodeAt(i)))</span>
<a href="#l93.1499"></a><span id="l93.1499" class="difflineplus">+      .join(&quot;&quot;);</span>
<a href="#l93.1500"></a><span id="l93.1500" class="difflineplus">+</span>
<a href="#l93.1501"></a><span id="l93.1501" class="difflineplus">+    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;].createInstance(</span>
<a href="#l93.1502"></a><span id="l93.1502" class="difflineplus">+      Ci.nsIStringInputStream</span>
<a href="#l93.1503"></a><span id="l93.1503" class="difflineplus">+    );</span>
<a href="#l93.1504"></a><span id="l93.1504">     istream.setData(content, content.length);</span>
<a href="#l93.1505"></a><span id="l93.1505"> </span>
<a href="#l93.1506"></a><span id="l93.1506">     let fileName = this._photoHash + &quot;.&quot; + kExt[type];</span>
<a href="#l93.1507"></a><span id="l93.1507" class="difflineminus">-    let file = FileUtils.getFile(&quot;ProfD&quot;, [&quot;icons&quot;,</span>
<a href="#l93.1508"></a><span id="l93.1508" class="difflineminus">-                                           this.account.protocol.normalizedName,</span>
<a href="#l93.1509"></a><span id="l93.1509" class="difflineminus">-                                           this.account.normalizedName,</span>
<a href="#l93.1510"></a><span id="l93.1510" class="difflineminus">-                                           fileName]);</span>
<a href="#l93.1511"></a><span id="l93.1511" class="difflineplus">+    let file = FileUtils.getFile(&quot;ProfD&quot;, [</span>
<a href="#l93.1512"></a><span id="l93.1512" class="difflineplus">+      &quot;icons&quot;,</span>
<a href="#l93.1513"></a><span id="l93.1513" class="difflineplus">+      this.account.protocol.normalizedName,</span>
<a href="#l93.1514"></a><span id="l93.1514" class="difflineplus">+      this.account.normalizedName,</span>
<a href="#l93.1515"></a><span id="l93.1515" class="difflineplus">+      fileName,</span>
<a href="#l93.1516"></a><span id="l93.1516" class="difflineplus">+    ]);</span>
<a href="#l93.1517"></a><span id="l93.1517">     let ostream = FileUtils.openSafeFileOutputStream(file);</span>
<a href="#l93.1518"></a><span id="l93.1518">     let buddy = this;</span>
<a href="#l93.1519"></a><span id="l93.1519">     NetUtil.asyncCopy(istream, ostream, function(rc) {</span>
<a href="#l93.1520"></a><span id="l93.1520" class="difflineminus">-      if (Components.isSuccessCode(rc))</span>
<a href="#l93.1521"></a><span id="l93.1521" class="difflineplus">+      if (Components.isSuccessCode(rc)) {</span>
<a href="#l93.1522"></a><span id="l93.1522">         buddy.buddyIconFilename = Services.io.newFileURI(file).spec;</span>
<a href="#l93.1523"></a><span id="l93.1523" class="difflineplus">+      }</span>
<a href="#l93.1524"></a><span id="l93.1524">     });</span>
<a href="#l93.1525"></a><span id="l93.1525">   },</span>
<a href="#l93.1526"></a><span id="l93.1526"> </span>
<a href="#l93.1527"></a><span id="l93.1527">   _preferredResource: undefined,</span>
<a href="#l93.1528"></a><span id="l93.1528">   _resources: null,</span>
<a href="#l93.1529"></a><span id="l93.1529">   onAccountDisconnected() {</span>
<a href="#l93.1530"></a><span id="l93.1530">     delete this._preferredResource;</span>
<a href="#l93.1531"></a><span id="l93.1531">     delete this._resources;</span>
<a href="#l93.1532"></a><span id="l93.1532" class="difflineat">@@ -1056,98 +1294,111 @@ var XMPPAccountBuddyPrototype = {</span>
<a href="#l93.1533"></a><span id="l93.1533">     // replace undefined resources with empty resources.</span>
<a href="#l93.1534"></a><span id="l93.1534">     let resource =</span>
<a href="#l93.1535"></a><span id="l93.1535">       this._account._parseJID(aStanza.attributes.from).resource || &quot;&quot;;</span>
<a href="#l93.1536"></a><span id="l93.1536"> </span>
<a href="#l93.1537"></a><span id="l93.1537">     let type = aStanza.attributes.type;</span>
<a href="#l93.1538"></a><span id="l93.1538"> </span>
<a href="#l93.1539"></a><span id="l93.1539">     // Reset typing status if the buddy is in a conversation and becomes unavailable.</span>
<a href="#l93.1540"></a><span id="l93.1540">     let conv = this._account._conv.get(this.normalizedName);</span>
<a href="#l93.1541"></a><span id="l93.1541" class="difflineminus">-    if (type == &quot;unavailable&quot; &amp;&amp; conv)</span>
<a href="#l93.1542"></a><span id="l93.1542" class="difflineplus">+    if (type == &quot;unavailable&quot; &amp;&amp; conv) {</span>
<a href="#l93.1543"></a><span id="l93.1543">       conv.updateTyping(Ci.prplIConvIM.NOT_TYPING, this.contactDisplayName);</span>
<a href="#l93.1544"></a><span id="l93.1544" class="difflineplus">+    }</span>
<a href="#l93.1545"></a><span id="l93.1545"> </span>
<a href="#l93.1546"></a><span id="l93.1546">     if (type == &quot;unavailable&quot; || type == &quot;error&quot;) {</span>
<a href="#l93.1547"></a><span id="l93.1547" class="difflineminus">-      if (!this._resources || !(resource in this._resources))</span>
<a href="#l93.1548"></a><span id="l93.1548" class="difflineminus">-        return; // ignore for already offline resources.</span>
<a href="#l93.1549"></a><span id="l93.1549" class="difflineplus">+      if (!this._resources || !(resource in this._resources)) {</span>
<a href="#l93.1550"></a><span id="l93.1550" class="difflineplus">+        return;</span>
<a href="#l93.1551"></a><span id="l93.1551" class="difflineplus">+      } // ignore for already offline resources.</span>
<a href="#l93.1552"></a><span id="l93.1552">       delete this._resources[resource];</span>
<a href="#l93.1553"></a><span id="l93.1553" class="difflineminus">-      if (preferred == resource)</span>
<a href="#l93.1554"></a><span id="l93.1554" class="difflineplus">+      if (preferred == resource) {</span>
<a href="#l93.1555"></a><span id="l93.1555">         preferred = undefined;</span>
<a href="#l93.1556"></a><span id="l93.1556" class="difflineminus">-    }</span>
<a href="#l93.1557"></a><span id="l93.1557" class="difflineminus">-    else {</span>
<a href="#l93.1558"></a><span id="l93.1558" class="difflineplus">+      }</span>
<a href="#l93.1559"></a><span id="l93.1559" class="difflineplus">+    } else {</span>
<a href="#l93.1560"></a><span id="l93.1560">       let statusInfo = parseStatus(aStanza);</span>
<a href="#l93.1561"></a><span id="l93.1561">       let priority = aStanza.getElement([&quot;priority&quot;]);</span>
<a href="#l93.1562"></a><span id="l93.1562">       priority = priority ? parseInt(priority.innerText, 10) : 0;</span>
<a href="#l93.1563"></a><span id="l93.1563"> </span>
<a href="#l93.1564"></a><span id="l93.1564" class="difflineminus">-      if (!this._resources)</span>
<a href="#l93.1565"></a><span id="l93.1565" class="difflineplus">+      if (!this._resources) {</span>
<a href="#l93.1566"></a><span id="l93.1566">         this._resources = {};</span>
<a href="#l93.1567"></a><span id="l93.1567" class="difflineplus">+      }</span>
<a href="#l93.1568"></a><span id="l93.1568">       this._resources[resource] = {</span>
<a href="#l93.1569"></a><span id="l93.1569">         statusType: statusInfo.statusType,</span>
<a href="#l93.1570"></a><span id="l93.1570">         statusText: statusInfo.statusText,</span>
<a href="#l93.1571"></a><span id="l93.1571">         idleSince: statusInfo.idleSince,</span>
<a href="#l93.1572"></a><span id="l93.1572">         priority,</span>
<a href="#l93.1573"></a><span id="l93.1573">         stanza: aStanza,</span>
<a href="#l93.1574"></a><span id="l93.1574">       };</span>
<a href="#l93.1575"></a><span id="l93.1575">     }</span>
<a href="#l93.1576"></a><span id="l93.1576"> </span>
<a href="#l93.1577"></a><span id="l93.1577">     let photo = aStanza.getElement([&quot;x&quot;, &quot;photo&quot;]);</span>
<a href="#l93.1578"></a><span id="l93.1578">     if (photo &amp;&amp; photo.uri == Stanza.NS.vcard_update) {</span>
<a href="#l93.1579"></a><span id="l93.1579">       let hash = photo.innerText;</span>
<a href="#l93.1580"></a><span id="l93.1580" class="difflineminus">-      if (hash &amp;&amp; hash != this._photoHash)</span>
<a href="#l93.1581"></a><span id="l93.1581" class="difflineplus">+      if (hash &amp;&amp; hash != this._photoHash) {</span>
<a href="#l93.1582"></a><span id="l93.1582">         this._account._addVCardRequest(this.normalizedName);</span>
<a href="#l93.1583"></a><span id="l93.1583" class="difflineminus">-      else if (!hash &amp;&amp; this._photoHash) {</span>
<a href="#l93.1584"></a><span id="l93.1584" class="difflineplus">+      } else if (!hash &amp;&amp; this._photoHash) {</span>
<a href="#l93.1585"></a><span id="l93.1585">         delete this._photoHash;</span>
<a href="#l93.1586"></a><span id="l93.1586">         this.buddyIconFilename = &quot;&quot;;</span>
<a href="#l93.1587"></a><span id="l93.1587">       }</span>
<a href="#l93.1588"></a><span id="l93.1588">     }</span>
<a href="#l93.1589"></a><span id="l93.1589"> </span>
<a href="#l93.1590"></a><span id="l93.1590">     for (let r in this._resources) {</span>
<a href="#l93.1591"></a><span id="l93.1591" class="difflineminus">-      if (preferred === undefined ||</span>
<a href="#l93.1592"></a><span id="l93.1592" class="difflineminus">-          this._resources[r].statusType &gt; this._resources[preferred].statusType)</span>
<a href="#l93.1593"></a><span id="l93.1593" class="difflineplus">+      if (</span>
<a href="#l93.1594"></a><span id="l93.1594" class="difflineplus">+        preferred === undefined ||</span>
<a href="#l93.1595"></a><span id="l93.1595" class="difflineplus">+        this._resources[r].statusType &gt; this._resources[preferred].statusType</span>
<a href="#l93.1596"></a><span id="l93.1596" class="difflineplus">+      ) {</span>
<a href="#l93.1597"></a><span id="l93.1597">         // FIXME also compare priorities...</span>
<a href="#l93.1598"></a><span id="l93.1598">         preferred = r;</span>
<a href="#l93.1599"></a><span id="l93.1599" class="difflineplus">+      }</span>
<a href="#l93.1600"></a><span id="l93.1600">     }</span>
<a href="#l93.1601"></a><span id="l93.1601" class="difflineminus">-    if (preferred != undefined &amp;&amp; preferred == this._preferredResource &amp;&amp;</span>
<a href="#l93.1602"></a><span id="l93.1602" class="difflineminus">-        resource != preferred) {</span>
<a href="#l93.1603"></a><span id="l93.1603" class="difflineplus">+    if (</span>
<a href="#l93.1604"></a><span id="l93.1604" class="difflineplus">+      preferred != undefined &amp;&amp;</span>
<a href="#l93.1605"></a><span id="l93.1605" class="difflineplus">+      preferred == this._preferredResource &amp;&amp;</span>
<a href="#l93.1606"></a><span id="l93.1606" class="difflineplus">+      resource != preferred</span>
<a href="#l93.1607"></a><span id="l93.1607" class="difflineplus">+    ) {</span>
<a href="#l93.1608"></a><span id="l93.1608">       // The presence information change is only for an unused resource,</span>
<a href="#l93.1609"></a><span id="l93.1609">       // only potential buddy tooltips need to be refreshed.</span>
<a href="#l93.1610"></a><span id="l93.1610">       this._notifyObservers(&quot;status-detail-changed&quot;);</span>
<a href="#l93.1611"></a><span id="l93.1611">       return;</span>
<a href="#l93.1612"></a><span id="l93.1612">     }</span>
<a href="#l93.1613"></a><span id="l93.1613"> </span>
<a href="#l93.1614"></a><span id="l93.1614">     // Presence info has changed enough that if we are having a</span>
<a href="#l93.1615"></a><span id="l93.1615">     // conversation with one resource of this buddy, we should send</span>
<a href="#l93.1616"></a><span id="l93.1616">     // the next message to all resources.</span>
<a href="#l93.1617"></a><span id="l93.1617">     // FIXME: the test here isn't exactly right...</span>
<a href="#l93.1618"></a><span id="l93.1618" class="difflineminus">-    if (this._preferredResource != preferred &amp;&amp;</span>
<a href="#l93.1619"></a><span id="l93.1619" class="difflineminus">-        this._account._conv.has(this.normalizedName))</span>
<a href="#l93.1620"></a><span id="l93.1620" class="difflineplus">+    if (</span>
<a href="#l93.1621"></a><span id="l93.1621" class="difflineplus">+      this._preferredResource != preferred &amp;&amp;</span>
<a href="#l93.1622"></a><span id="l93.1622" class="difflineplus">+      this._account._conv.has(this.normalizedName)</span>
<a href="#l93.1623"></a><span id="l93.1623" class="difflineplus">+    ) {</span>
<a href="#l93.1624"></a><span id="l93.1624">       delete this._account._conv.get(this.normalizedName)._targetResource;</span>
<a href="#l93.1625"></a><span id="l93.1625" class="difflineplus">+    }</span>
<a href="#l93.1626"></a><span id="l93.1626"> </span>
<a href="#l93.1627"></a><span id="l93.1627">     this._preferredResource = preferred;</span>
<a href="#l93.1628"></a><span id="l93.1628">     if (preferred === undefined) {</span>
<a href="#l93.1629"></a><span id="l93.1629">       let statusType = Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l93.1630"></a><span id="l93.1630" class="difflineminus">-      if (type == &quot;unavailable&quot;)</span>
<a href="#l93.1631"></a><span id="l93.1631" class="difflineplus">+      if (type == &quot;unavailable&quot;) {</span>
<a href="#l93.1632"></a><span id="l93.1632">         statusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l93.1633"></a><span id="l93.1633" class="difflineplus">+      }</span>
<a href="#l93.1634"></a><span id="l93.1634">       this.setStatus(statusType, &quot;&quot;);</span>
<a href="#l93.1635"></a><span id="l93.1635" class="difflineminus">-    }</span>
<a href="#l93.1636"></a><span id="l93.1636" class="difflineminus">-    else {</span>
<a href="#l93.1637"></a><span id="l93.1637" class="difflineplus">+    } else {</span>
<a href="#l93.1638"></a><span id="l93.1638">       preferred = this._resources[preferred];</span>
<a href="#l93.1639"></a><span id="l93.1639">       this.setStatus(preferred.statusType, preferred.statusText);</span>
<a href="#l93.1640"></a><span id="l93.1640">     }</span>
<a href="#l93.1641"></a><span id="l93.1641">   },</span>
<a href="#l93.1642"></a><span id="l93.1642"> </span>
<a href="#l93.1643"></a><span id="l93.1643">   /* Can send messages to buddies who appear offline */</span>
<a href="#l93.1644"></a><span id="l93.1644" class="difflineminus">-  get canSendMessage() { return this.account.connected; },</span>
<a href="#l93.1645"></a><span id="l93.1645" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l93.1646"></a><span id="l93.1646" class="difflineplus">+    return this.account.connected;</span>
<a href="#l93.1647"></a><span id="l93.1647" class="difflineplus">+  },</span>
<a href="#l93.1648"></a><span id="l93.1648"> </span>
<a href="#l93.1649"></a><span id="l93.1649">   /* Called when the user wants to chat with the buddy */</span>
<a href="#l93.1650"></a><span id="l93.1650">   createConversation() {</span>
<a href="#l93.1651"></a><span id="l93.1651">     return this._account.createConversation(this.normalizedName);</span>
<a href="#l93.1652"></a><span id="l93.1652">   },</span>
<a href="#l93.1653"></a><span id="l93.1653"> };</span>
<a href="#l93.1654"></a><span id="l93.1654" class="difflineminus">-function XMPPAccountBuddy(aAccount, aBuddy, aTag, aUserName)</span>
<a href="#l93.1655"></a><span id="l93.1655" class="difflineminus">-{</span>
<a href="#l93.1656"></a><span id="l93.1656" class="difflineplus">+function XMPPAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l93.1657"></a><span id="l93.1657">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l93.1658"></a><span id="l93.1658"> }</span>
<a href="#l93.1659"></a><span id="l93.1659"> XMPPAccountBuddy.prototype = XMPPAccountBuddyPrototype;</span>
<a href="#l93.1660"></a><span id="l93.1660"> </span>
<a href="#l93.1661"></a><span id="l93.1661"> var XMPPRoomInfoPrototype = {</span>
<a href="#l93.1662"></a><span id="l93.1662">   __proto__: ClassInfo(&quot;prplIRoomInfo&quot;, &quot;XMPP RoomInfo Object&quot;),</span>
<a href="#l93.1663"></a><span id="l93.1663">   get topic() {</span>
<a href="#l93.1664"></a><span id="l93.1664">     return &quot;&quot;;</span>
<a href="#l93.1665"></a><span id="l93.1665" class="difflineat">@@ -1173,253 +1424,322 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.1666"></a><span id="l93.1666">   _jid: null, // parsed Jabber ID: node, domain, resource</span>
<a href="#l93.1667"></a><span id="l93.1667">   _connection: null, // XMPPSession socket</span>
<a href="#l93.1668"></a><span id="l93.1668">   authMechanisms: null, // hook to let prpls tweak the list of auth mechanisms</span>
<a href="#l93.1669"></a><span id="l93.1669"> </span>
<a href="#l93.1670"></a><span id="l93.1670">   // Contains the domain of MUC service which is obtained using service</span>
<a href="#l93.1671"></a><span id="l93.1671">   // discovery.</span>
<a href="#l93.1672"></a><span id="l93.1672">   _mucService: null,</span>
<a href="#l93.1673"></a><span id="l93.1673"> </span>
<a href="#l93.1674"></a><span id="l93.1674" class="difflineminus">-   // Maps room names to room jid.</span>
<a href="#l93.1675"></a><span id="l93.1675" class="difflineplus">+  // Maps room names to room jid.</span>
<a href="#l93.1676"></a><span id="l93.1676">   _roomList: new Map(),</span>
<a href="#l93.1677"></a><span id="l93.1677"> </span>
<a href="#l93.1678"></a><span id="l93.1678">   // Callbacks used when roomInfo is available.</span>
<a href="#l93.1679"></a><span id="l93.1679">   _roomInfoCallbacks: new Set(),</span>
<a href="#l93.1680"></a><span id="l93.1680"> </span>
<a href="#l93.1681"></a><span id="l93.1681">   // Determines if roomInfo that we have is expired or not.</span>
<a href="#l93.1682"></a><span id="l93.1682">   _lastListTime: 0,</span>
<a href="#l93.1683"></a><span id="l93.1683" class="difflineminus">-  get isRoomInfoStale() { return Date.now() - this._lastListTime &gt; kListRefreshInterval; },</span>
<a href="#l93.1684"></a><span id="l93.1684" class="difflineplus">+  get isRoomInfoStale() {</span>
<a href="#l93.1685"></a><span id="l93.1685" class="difflineplus">+    return Date.now() - this._lastListTime &gt; kListRefreshInterval;</span>
<a href="#l93.1686"></a><span id="l93.1686" class="difflineplus">+  },</span>
<a href="#l93.1687"></a><span id="l93.1687"> </span>
<a href="#l93.1688"></a><span id="l93.1688">   // If true, we are waiting for replies.</span>
<a href="#l93.1689"></a><span id="l93.1689">   _pendingList: false,</span>
<a href="#l93.1690"></a><span id="l93.1690"> </span>
<a href="#l93.1691"></a><span id="l93.1691">   // An array of jids for which we still need to request vCards.</span>
<a href="#l93.1692"></a><span id="l93.1692">   _pendingVCardRequests: [],</span>
<a href="#l93.1693"></a><span id="l93.1693"> </span>
<a href="#l93.1694"></a><span id="l93.1694">   // XEP-0280: Message Carbons.</span>
<a href="#l93.1695"></a><span id="l93.1695">   // If true, message carbons are currently enabled.</span>
<a href="#l93.1696"></a><span id="l93.1696">   _isCarbonsEnabled: false,</span>
<a href="#l93.1697"></a><span id="l93.1697"> </span>
<a href="#l93.1698"></a><span id="l93.1698">   /* Generate unique id for a stanza. Using id and unique sid is defined in</span>
<a href="#l93.1699"></a><span id="l93.1699">    * RFC 6120 (Section 8.2.3, 4.7.3).</span>
<a href="#l93.1700"></a><span id="l93.1700">    */</span>
<a href="#l93.1701"></a><span id="l93.1701" class="difflineminus">-  generateId: () =&gt; UuidGenerator.generateUUID().toString().slice(1, -1),</span>
<a href="#l93.1702"></a><span id="l93.1702" class="difflineplus">+  generateId: () =&gt;</span>
<a href="#l93.1703"></a><span id="l93.1703" class="difflineplus">+    UuidGenerator.generateUUID()</span>
<a href="#l93.1704"></a><span id="l93.1704" class="difflineplus">+      .toString()</span>
<a href="#l93.1705"></a><span id="l93.1705" class="difflineplus">+      .slice(1, -1),</span>
<a href="#l93.1706"></a><span id="l93.1706"> </span>
<a href="#l93.1707"></a><span id="l93.1707">   _init(aProtoInstance, aImAccount) {</span>
<a href="#l93.1708"></a><span id="l93.1708">     GenericAccountPrototype._init.call(this, aProtoInstance, aImAccount);</span>
<a href="#l93.1709"></a><span id="l93.1709"> </span>
<a href="#l93.1710"></a><span id="l93.1710">     // Ongoing conversations.</span>
<a href="#l93.1711"></a><span id="l93.1711">     // The keys of this._conv are assumed to be normalized like account@domain</span>
<a href="#l93.1712"></a><span id="l93.1712">     // for normal conversations and like room@domain/nick for MUC participant</span>
<a href="#l93.1713"></a><span id="l93.1713">     // convs.</span>
<a href="#l93.1714"></a><span id="l93.1714">     this._conv = new NormalizedMap(this.normalizeFullJid.bind(this));</span>
<a href="#l93.1715"></a><span id="l93.1715"> </span>
<a href="#l93.1716"></a><span id="l93.1716">     this._buddies = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l93.1717"></a><span id="l93.1717">     this._mucs = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l93.1718"></a><span id="l93.1718">   },</span>
<a href="#l93.1719"></a><span id="l93.1719"> </span>
<a href="#l93.1720"></a><span id="l93.1720" class="difflineminus">-  get canJoinChat() { return true; },</span>
<a href="#l93.1721"></a><span id="l93.1721" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l93.1722"></a><span id="l93.1722" class="difflineplus">+    return true;</span>
<a href="#l93.1723"></a><span id="l93.1723" class="difflineplus">+  },</span>
<a href="#l93.1724"></a><span id="l93.1724">   chatRoomFields: {</span>
<a href="#l93.1725"></a><span id="l93.1725" class="difflineminus">-    room: {get label() { return _(&quot;chatRoomField.room&quot;); }, required: true},</span>
<a href="#l93.1726"></a><span id="l93.1726" class="difflineminus">-    server: {get label() { return _(&quot;chatRoomField.server&quot;); }, required: true},</span>
<a href="#l93.1727"></a><span id="l93.1727" class="difflineminus">-    nick: {get label() { return _(&quot;chatRoomField.nick&quot;); }, required: true},</span>
<a href="#l93.1728"></a><span id="l93.1728" class="difflineminus">-    password: {get label() { return _(&quot;chatRoomField.password&quot;); }, isPassword: true},</span>
<a href="#l93.1729"></a><span id="l93.1729" class="difflineplus">+    room: {</span>
<a href="#l93.1730"></a><span id="l93.1730" class="difflineplus">+      get label() {</span>
<a href="#l93.1731"></a><span id="l93.1731" class="difflineplus">+        return _(&quot;chatRoomField.room&quot;);</span>
<a href="#l93.1732"></a><span id="l93.1732" class="difflineplus">+      },</span>
<a href="#l93.1733"></a><span id="l93.1733" class="difflineplus">+      required: true,</span>
<a href="#l93.1734"></a><span id="l93.1734" class="difflineplus">+    },</span>
<a href="#l93.1735"></a><span id="l93.1735" class="difflineplus">+    server: {</span>
<a href="#l93.1736"></a><span id="l93.1736" class="difflineplus">+      get label() {</span>
<a href="#l93.1737"></a><span id="l93.1737" class="difflineplus">+        return _(&quot;chatRoomField.server&quot;);</span>
<a href="#l93.1738"></a><span id="l93.1738" class="difflineplus">+      },</span>
<a href="#l93.1739"></a><span id="l93.1739" class="difflineplus">+      required: true,</span>
<a href="#l93.1740"></a><span id="l93.1740" class="difflineplus">+    },</span>
<a href="#l93.1741"></a><span id="l93.1741" class="difflineplus">+    nick: {</span>
<a href="#l93.1742"></a><span id="l93.1742" class="difflineplus">+      get label() {</span>
<a href="#l93.1743"></a><span id="l93.1743" class="difflineplus">+        return _(&quot;chatRoomField.nick&quot;);</span>
<a href="#l93.1744"></a><span id="l93.1744" class="difflineplus">+      },</span>
<a href="#l93.1745"></a><span id="l93.1745" class="difflineplus">+      required: true,</span>
<a href="#l93.1746"></a><span id="l93.1746" class="difflineplus">+    },</span>
<a href="#l93.1747"></a><span id="l93.1747" class="difflineplus">+    password: {</span>
<a href="#l93.1748"></a><span id="l93.1748" class="difflineplus">+      get label() {</span>
<a href="#l93.1749"></a><span id="l93.1749" class="difflineplus">+        return _(&quot;chatRoomField.password&quot;);</span>
<a href="#l93.1750"></a><span id="l93.1750" class="difflineplus">+      },</span>
<a href="#l93.1751"></a><span id="l93.1751" class="difflineplus">+      isPassword: true,</span>
<a href="#l93.1752"></a><span id="l93.1752" class="difflineplus">+    },</span>
<a href="#l93.1753"></a><span id="l93.1753">   },</span>
<a href="#l93.1754"></a><span id="l93.1754">   parseDefaultChatName(aDefaultChatName) {</span>
<a href="#l93.1755"></a><span id="l93.1755" class="difflineminus">-    if (!aDefaultChatName)</span>
<a href="#l93.1756"></a><span id="l93.1756" class="difflineminus">-      return {nick: this._jid.node};</span>
<a href="#l93.1757"></a><span id="l93.1757" class="difflineplus">+    if (!aDefaultChatName) {</span>
<a href="#l93.1758"></a><span id="l93.1758" class="difflineplus">+      return { nick: this._jid.node };</span>
<a href="#l93.1759"></a><span id="l93.1759" class="difflineplus">+    }</span>
<a href="#l93.1760"></a><span id="l93.1760"> </span>
<a href="#l93.1761"></a><span id="l93.1761">     let params = aDefaultChatName.trim().split(/\s+/);</span>
<a href="#l93.1762"></a><span id="l93.1762">     let jid = this._parseJID(params[0]);</span>
<a href="#l93.1763"></a><span id="l93.1763"> </span>
<a href="#l93.1764"></a><span id="l93.1764">     // We swap node and domain as domain is required for parseJID, but node and</span>
<a href="#l93.1765"></a><span id="l93.1765">     // resource are optional. In MUC join command, Node is required as it</span>
<a href="#l93.1766"></a><span id="l93.1766">     // represents a room, but domain and resource are optional as we get muc</span>
<a href="#l93.1767"></a><span id="l93.1767">     // domain from service discovery.</span>
<a href="#l93.1768"></a><span id="l93.1768" class="difflineminus">-    if (!jid.node &amp;&amp; jid.domain)</span>
<a href="#l93.1769"></a><span id="l93.1769" class="difflineplus">+    if (!jid.node &amp;&amp; jid.domain) {</span>
<a href="#l93.1770"></a><span id="l93.1770">       [jid.node, jid.domain] = [jid.domain, jid.node];</span>
<a href="#l93.1771"></a><span id="l93.1771" class="difflineplus">+    }</span>
<a href="#l93.1772"></a><span id="l93.1772"> </span>
<a href="#l93.1773"></a><span id="l93.1773">     let chatFields = {</span>
<a href="#l93.1774"></a><span id="l93.1774">       room: jid.node,</span>
<a href="#l93.1775"></a><span id="l93.1775">       server: jid.domain || this._mucService,</span>
<a href="#l93.1776"></a><span id="l93.1776">       nick: jid.resource || this._jid.node,</span>
<a href="#l93.1777"></a><span id="l93.1777">     };</span>
<a href="#l93.1778"></a><span id="l93.1778" class="difflineminus">-    if (params.length &gt; 1)</span>
<a href="#l93.1779"></a><span id="l93.1779" class="difflineplus">+    if (params.length &gt; 1) {</span>
<a href="#l93.1780"></a><span id="l93.1780">       chatFields.password = params[1];</span>
<a href="#l93.1781"></a><span id="l93.1781" class="difflineplus">+    }</span>
<a href="#l93.1782"></a><span id="l93.1782">     return chatFields;</span>
<a href="#l93.1783"></a><span id="l93.1783">   },</span>
<a href="#l93.1784"></a><span id="l93.1784">   getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l93.1785"></a><span id="l93.1785" class="difflineminus">-    let rv = GenericAccountPrototype.getChatRoomDefaultFieldValues</span>
<a href="#l93.1786"></a><span id="l93.1786" class="difflineminus">-                                    .call(this, aDefaultChatName);</span>
<a href="#l93.1787"></a><span id="l93.1787" class="difflineminus">-    if (!rv.values.nick)</span>
<a href="#l93.1788"></a><span id="l93.1788" class="difflineplus">+    let rv = GenericAccountPrototype.getChatRoomDefaultFieldValues.call(</span>
<a href="#l93.1789"></a><span id="l93.1789" class="difflineplus">+      this,</span>
<a href="#l93.1790"></a><span id="l93.1790" class="difflineplus">+      aDefaultChatName</span>
<a href="#l93.1791"></a><span id="l93.1791" class="difflineplus">+    );</span>
<a href="#l93.1792"></a><span id="l93.1792" class="difflineplus">+    if (!rv.values.nick) {</span>
<a href="#l93.1793"></a><span id="l93.1793">       rv.values.nick = this._jid.node;</span>
<a href="#l93.1794"></a><span id="l93.1794" class="difflineminus">-    if (!rv.values.server &amp;&amp; this._mucService)</span>
<a href="#l93.1795"></a><span id="l93.1795" class="difflineplus">+    }</span>
<a href="#l93.1796"></a><span id="l93.1796" class="difflineplus">+    if (!rv.values.server &amp;&amp; this._mucService) {</span>
<a href="#l93.1797"></a><span id="l93.1797">       rv.values.server = this._mucService;</span>
<a href="#l93.1798"></a><span id="l93.1798" class="difflineplus">+    }</span>
<a href="#l93.1799"></a><span id="l93.1799"> </span>
<a href="#l93.1800"></a><span id="l93.1800">     return rv;</span>
<a href="#l93.1801"></a><span id="l93.1801">   },</span>
<a href="#l93.1802"></a><span id="l93.1802"> </span>
<a href="#l93.1803"></a><span id="l93.1803">   // XEP-0045: Requests joining room if it exists or</span>
<a href="#l93.1804"></a><span id="l93.1804">   // creating room if it does not exist.</span>
<a href="#l93.1805"></a><span id="l93.1805">   joinChat(aComponents) {</span>
<a href="#l93.1806"></a><span id="l93.1806">     let jid =</span>
<a href="#l93.1807"></a><span id="l93.1807">       aComponents.getValue(&quot;room&quot;) + &quot;@&quot; + aComponents.getValue(&quot;server&quot;);</span>
<a href="#l93.1808"></a><span id="l93.1808">     let nick = aComponents.getValue(&quot;nick&quot;);</span>
<a href="#l93.1809"></a><span id="l93.1809"> </span>
<a href="#l93.1810"></a><span id="l93.1810">     let muc = this._mucs.get(jid);</span>
<a href="#l93.1811"></a><span id="l93.1811">     if (muc) {</span>
<a href="#l93.1812"></a><span id="l93.1812" class="difflineminus">-      if (!muc.left)</span>
<a href="#l93.1813"></a><span id="l93.1813" class="difflineminus">-        return muc; // We are already in this conversation.</span>
<a href="#l93.1814"></a><span id="l93.1814" class="difflineplus">+      if (!muc.left) {</span>
<a href="#l93.1815"></a><span id="l93.1815" class="difflineplus">+        return muc;</span>
<a href="#l93.1816"></a><span id="l93.1816" class="difflineplus">+      } // We are already in this conversation.</span>
<a href="#l93.1817"></a><span id="l93.1817">       else if (!muc.chatRoomFields) {</span>
<a href="#l93.1818"></a><span id="l93.1818">         // We are rejoining a room that was parted by the user.</span>
<a href="#l93.1819"></a><span id="l93.1819">         muc._rejoined = true;</span>
<a href="#l93.1820"></a><span id="l93.1820">       }</span>
<a href="#l93.1821"></a><span id="l93.1821" class="difflineminus">-    }</span>
<a href="#l93.1822"></a><span id="l93.1822" class="difflineminus">-    else {</span>
<a href="#l93.1823"></a><span id="l93.1823" class="difflineplus">+    } else {</span>
<a href="#l93.1824"></a><span id="l93.1824">       muc = new this._MUCConversationConstructor(this, jid, nick);</span>
<a href="#l93.1825"></a><span id="l93.1825">       this._mucs.set(jid, muc);</span>
<a href="#l93.1826"></a><span id="l93.1826">     }</span>
<a href="#l93.1827"></a><span id="l93.1827"> </span>
<a href="#l93.1828"></a><span id="l93.1828">     // Store the prplIChatRoomFieldValues to enable later reconnections.</span>
<a href="#l93.1829"></a><span id="l93.1829">     muc.chatRoomFields = aComponents;</span>
<a href="#l93.1830"></a><span id="l93.1830">     muc.joining = true;</span>
<a href="#l93.1831"></a><span id="l93.1831">     muc.removeAllParticipants();</span>
<a href="#l93.1832"></a><span id="l93.1832"> </span>
<a href="#l93.1833"></a><span id="l93.1833">     let password = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l93.1834"></a><span id="l93.1834" class="difflineminus">-    let x = Stanza.node(&quot;x&quot;, Stanza.NS.muc, null,</span>
<a href="#l93.1835"></a><span id="l93.1835" class="difflineminus">-                        password ? Stanza.node(&quot;password&quot;, null, null, password) : null);</span>
<a href="#l93.1836"></a><span id="l93.1836" class="difflineplus">+    let x = Stanza.node(</span>
<a href="#l93.1837"></a><span id="l93.1837" class="difflineplus">+      &quot;x&quot;,</span>
<a href="#l93.1838"></a><span id="l93.1838" class="difflineplus">+      Stanza.NS.muc,</span>
<a href="#l93.1839"></a><span id="l93.1839" class="difflineplus">+      null,</span>
<a href="#l93.1840"></a><span id="l93.1840" class="difflineplus">+      password ? Stanza.node(&quot;password&quot;, null, null, password) : null</span>
<a href="#l93.1841"></a><span id="l93.1841" class="difflineplus">+    );</span>
<a href="#l93.1842"></a><span id="l93.1842">     let logString;</span>
<a href="#l93.1843"></a><span id="l93.1843">     if (password) {</span>
<a href="#l93.1844"></a><span id="l93.1844" class="difflineminus">-      logString = &quot;&lt;presence .../&gt; (Stanza containing password to join MUC &quot; +</span>
<a href="#l93.1845"></a><span id="l93.1845" class="difflineminus">-        jid + &quot;/&quot; + nick + &quot; not logged)&quot;;</span>
<a href="#l93.1846"></a><span id="l93.1846" class="difflineplus">+      logString =</span>
<a href="#l93.1847"></a><span id="l93.1847" class="difflineplus">+        &quot;&lt;presence .../&gt; (Stanza containing password to join MUC &quot; +</span>
<a href="#l93.1848"></a><span id="l93.1848" class="difflineplus">+        jid +</span>
<a href="#l93.1849"></a><span id="l93.1849" class="difflineplus">+        &quot;/&quot; +</span>
<a href="#l93.1850"></a><span id="l93.1850" class="difflineplus">+        nick +</span>
<a href="#l93.1851"></a><span id="l93.1851" class="difflineplus">+        &quot; not logged)&quot;;</span>
<a href="#l93.1852"></a><span id="l93.1852">     }</span>
<a href="#l93.1853"></a><span id="l93.1853" class="difflineminus">-    this.sendStanza(Stanza.presence({to: jid + &quot;/&quot; + nick}, x),</span>
<a href="#l93.1854"></a><span id="l93.1854" class="difflineminus">-      undefined, undefined, logString);</span>
<a href="#l93.1855"></a><span id="l93.1855" class="difflineplus">+    this.sendStanza(</span>
<a href="#l93.1856"></a><span id="l93.1856" class="difflineplus">+      Stanza.presence({ to: jid + &quot;/&quot; + nick }, x),</span>
<a href="#l93.1857"></a><span id="l93.1857" class="difflineplus">+      undefined,</span>
<a href="#l93.1858"></a><span id="l93.1858" class="difflineplus">+      undefined,</span>
<a href="#l93.1859"></a><span id="l93.1859" class="difflineplus">+      logString</span>
<a href="#l93.1860"></a><span id="l93.1860" class="difflineplus">+    );</span>
<a href="#l93.1861"></a><span id="l93.1861">     return muc;</span>
<a href="#l93.1862"></a><span id="l93.1862">   },</span>
<a href="#l93.1863"></a><span id="l93.1863"> </span>
<a href="#l93.1864"></a><span id="l93.1864">   _idleSince: 0,</span>
<a href="#l93.1865"></a><span id="l93.1865">   observe(aSubject, aTopic, aData) {</span>
<a href="#l93.1866"></a><span id="l93.1866">     if (aTopic == &quot;idle-time-changed&quot;) {</span>
<a href="#l93.1867"></a><span id="l93.1867">       let idleTime = parseInt(aData, 10);</span>
<a href="#l93.1868"></a><span id="l93.1868" class="difflineminus">-      if (idleTime)</span>
<a href="#l93.1869"></a><span id="l93.1869" class="difflineplus">+      if (idleTime) {</span>
<a href="#l93.1870"></a><span id="l93.1870">         this._idleSince = Math.floor(Date.now() / 1000) - idleTime;</span>
<a href="#l93.1871"></a><span id="l93.1871" class="difflineminus">-      else</span>
<a href="#l93.1872"></a><span id="l93.1872" class="difflineplus">+      } else {</span>
<a href="#l93.1873"></a><span id="l93.1873">         delete this._idleSince;</span>
<a href="#l93.1874"></a><span id="l93.1874" class="difflineplus">+      }</span>
<a href="#l93.1875"></a><span id="l93.1875">       this._shouldSendPresenceForIdlenessChange = true;</span>
<a href="#l93.1876"></a><span id="l93.1876" class="difflineminus">-      executeSoon((function() {</span>
<a href="#l93.1877"></a><span id="l93.1877" class="difflineminus">-        if (&quot;_shouldSendPresenceForIdlenessChange&quot; in this)</span>
<a href="#l93.1878"></a><span id="l93.1878" class="difflineminus">-          this._sendPresence();</span>
<a href="#l93.1879"></a><span id="l93.1879" class="difflineminus">-      }).bind(this));</span>
<a href="#l93.1880"></a><span id="l93.1880" class="difflineminus">-    }</span>
<a href="#l93.1881"></a><span id="l93.1881" class="difflineminus">-    else if (aTopic == &quot;status-changed&quot;)</span>
<a href="#l93.1882"></a><span id="l93.1882" class="difflineplus">+      executeSoon(</span>
<a href="#l93.1883"></a><span id="l93.1883" class="difflineplus">+        function() {</span>
<a href="#l93.1884"></a><span id="l93.1884" class="difflineplus">+          if (&quot;_shouldSendPresenceForIdlenessChange&quot; in this) {</span>
<a href="#l93.1885"></a><span id="l93.1885" class="difflineplus">+            this._sendPresence();</span>
<a href="#l93.1886"></a><span id="l93.1886" class="difflineplus">+          }</span>
<a href="#l93.1887"></a><span id="l93.1887" class="difflineplus">+        }.bind(this)</span>
<a href="#l93.1888"></a><span id="l93.1888" class="difflineplus">+      );</span>
<a href="#l93.1889"></a><span id="l93.1889" class="difflineplus">+    } else if (aTopic == &quot;status-changed&quot;) {</span>
<a href="#l93.1890"></a><span id="l93.1890">       this._sendPresence();</span>
<a href="#l93.1891"></a><span id="l93.1891" class="difflineminus">-    else if (aTopic == &quot;user-icon-changed&quot;) {</span>
<a href="#l93.1892"></a><span id="l93.1892" class="difflineplus">+    } else if (aTopic == &quot;user-icon-changed&quot;) {</span>
<a href="#l93.1893"></a><span id="l93.1893">       delete this._cachedUserIcon;</span>
<a href="#l93.1894"></a><span id="l93.1894">       this._forceUserIconUpdate = true;</span>
<a href="#l93.1895"></a><span id="l93.1895">       this._sendVCard();</span>
<a href="#l93.1896"></a><span id="l93.1896" class="difflineplus">+    } else if (aTopic == &quot;user-display-name-changed&quot;) {</span>
<a href="#l93.1897"></a><span id="l93.1897" class="difflineplus">+      this._forceUserDisplayNameUpdate = true;</span>
<a href="#l93.1898"></a><span id="l93.1898">     }</span>
<a href="#l93.1899"></a><span id="l93.1899" class="difflineminus">-    else if (aTopic == &quot;user-display-name-changed&quot;)</span>
<a href="#l93.1900"></a><span id="l93.1900" class="difflineminus">-      this._forceUserDisplayNameUpdate = true;</span>
<a href="#l93.1901"></a><span id="l93.1901" class="difflineminus">-      this._sendVCard();</span>
<a href="#l93.1902"></a><span id="l93.1902" class="difflineplus">+    this._sendVCard();</span>
<a href="#l93.1903"></a><span id="l93.1903">   },</span>
<a href="#l93.1904"></a><span id="l93.1904"> </span>
<a href="#l93.1905"></a><span id="l93.1905">   /* GenericAccountPrototype events */</span>
<a href="#l93.1906"></a><span id="l93.1906">   /* Connect to the server */</span>
<a href="#l93.1907"></a><span id="l93.1907">   connect() {</span>
<a href="#l93.1908"></a><span id="l93.1908">     this._jid = this._parseJID(this.name);</span>
<a href="#l93.1909"></a><span id="l93.1909"> </span>
<a href="#l93.1910"></a><span id="l93.1910">     // For the resource, if the user has edited the option, always use that.</span>
<a href="#l93.1911"></a><span id="l93.1911">     if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l93.1912"></a><span id="l93.1912">       let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l93.1913"></a><span id="l93.1913"> </span>
<a href="#l93.1914"></a><span id="l93.1914">       // this._jid needs to be updated. This value is however never used</span>
<a href="#l93.1915"></a><span id="l93.1915">       // because while connected it's the jid of the session that's</span>
<a href="#l93.1916"></a><span id="l93.1916">       // interesting.</span>
<a href="#l93.1917"></a><span id="l93.1917">       this._jid = this._setJID(this._jid.domain, this._jid.node, resource);</span>
<a href="#l93.1918"></a><span id="l93.1918" class="difflineminus">-    }</span>
<a href="#l93.1919"></a><span id="l93.1919" class="difflineminus">-    else if (this._jid.resource) {</span>
<a href="#l93.1920"></a><span id="l93.1920" class="difflineplus">+    } else if (this._jid.resource) {</span>
<a href="#l93.1921"></a><span id="l93.1921">       // If there is a resource in the account name (inherited from libpurple),</span>
<a href="#l93.1922"></a><span id="l93.1922">       // migrate it to the pref so it appears correctly in the advanced account</span>
<a href="#l93.1923"></a><span id="l93.1923">       // options next time.</span>
<a href="#l93.1924"></a><span id="l93.1924">       this.prefs.setStringPref(&quot;resource&quot;, this._jid.resource);</span>
<a href="#l93.1925"></a><span id="l93.1925">     }</span>
<a href="#l93.1926"></a><span id="l93.1926"> </span>
<a href="#l93.1927"></a><span id="l93.1927" class="difflineminus">-    this._connection =</span>
<a href="#l93.1928"></a><span id="l93.1928" class="difflineminus">-      new XMPPSession(this.getString(&quot;server&quot;) || this._jid.domain,</span>
<a href="#l93.1929"></a><span id="l93.1929" class="difflineminus">-                      this.getInt(&quot;port&quot;) || 5222,</span>
<a href="#l93.1930"></a><span id="l93.1930" class="difflineminus">-                      this.getString(&quot;connection_security&quot;), this._jid,</span>
<a href="#l93.1931"></a><span id="l93.1931" class="difflineminus">-                      this.imAccount.password, this);</span>
<a href="#l93.1932"></a><span id="l93.1932" class="difflineplus">+    this._connection = new XMPPSession(</span>
<a href="#l93.1933"></a><span id="l93.1933" class="difflineplus">+      this.getString(&quot;server&quot;) || this._jid.domain,</span>
<a href="#l93.1934"></a><span id="l93.1934" class="difflineplus">+      this.getInt(&quot;port&quot;) || 5222,</span>
<a href="#l93.1935"></a><span id="l93.1935" class="difflineplus">+      this.getString(&quot;connection_security&quot;),</span>
<a href="#l93.1936"></a><span id="l93.1936" class="difflineplus">+      this._jid,</span>
<a href="#l93.1937"></a><span id="l93.1937" class="difflineplus">+      this.imAccount.password,</span>
<a href="#l93.1938"></a><span id="l93.1938" class="difflineplus">+      this</span>
<a href="#l93.1939"></a><span id="l93.1939" class="difflineplus">+    );</span>
<a href="#l93.1940"></a><span id="l93.1940">   },</span>
<a href="#l93.1941"></a><span id="l93.1941"> </span>
<a href="#l93.1942"></a><span id="l93.1942">   remove() {</span>
<a href="#l93.1943"></a><span id="l93.1943">     this._conv.forEach(conv =&gt; conv.close());</span>
<a href="#l93.1944"></a><span id="l93.1944">     this._mucs.forEach(muc =&gt; muc.close());</span>
<a href="#l93.1945"></a><span id="l93.1945">     this._buddies.forEach((buddy, jid) =&gt; this._forgetRosterItem(jid));</span>
<a href="#l93.1946"></a><span id="l93.1946">   },</span>
<a href="#l93.1947"></a><span id="l93.1947"> </span>
<a href="#l93.1948"></a><span id="l93.1948">   unInit() {</span>
<a href="#l93.1949"></a><span id="l93.1949" class="difflineminus">-    if (this._connection)</span>
<a href="#l93.1950"></a><span id="l93.1950" class="difflineplus">+    if (this._connection) {</span>
<a href="#l93.1951"></a><span id="l93.1951">       this._disconnect(undefined, undefined, true);</span>
<a href="#l93.1952"></a><span id="l93.1952" class="difflineplus">+    }</span>
<a href="#l93.1953"></a><span id="l93.1953">     delete this._jid;</span>
<a href="#l93.1954"></a><span id="l93.1954">     delete this._conv;</span>
<a href="#l93.1955"></a><span id="l93.1955">     delete this._buddies;</span>
<a href="#l93.1956"></a><span id="l93.1956">     delete this._mucs;</span>
<a href="#l93.1957"></a><span id="l93.1957">   },</span>
<a href="#l93.1958"></a><span id="l93.1958"> </span>
<a href="#l93.1959"></a><span id="l93.1959">   /* Disconnect from the server */</span>
<a href="#l93.1960"></a><span id="l93.1960">   disconnect() {</span>
<a href="#l93.1961"></a><span id="l93.1961">     this._disconnect();</span>
<a href="#l93.1962"></a><span id="l93.1962">   },</span>
<a href="#l93.1963"></a><span id="l93.1963"> </span>
<a href="#l93.1964"></a><span id="l93.1964">   addBuddy(aTag, aName) {</span>
<a href="#l93.1965"></a><span id="l93.1965" class="difflineminus">-    if (!this._connection)</span>
<a href="#l93.1966"></a><span id="l93.1966" class="difflineplus">+    if (!this._connection) {</span>
<a href="#l93.1967"></a><span id="l93.1967">       throw new Error(&quot;The account isn't connected&quot;);</span>
<a href="#l93.1968"></a><span id="l93.1968" class="difflineplus">+    }</span>
<a href="#l93.1969"></a><span id="l93.1969"> </span>
<a href="#l93.1970"></a><span id="l93.1970">     let jid = this.normalize(aName);</span>
<a href="#l93.1971"></a><span id="l93.1971" class="difflineminus">-    if (!jid || !jid.includes(&quot;@&quot;))</span>
<a href="#l93.1972"></a><span id="l93.1972" class="difflineplus">+    if (!jid || !jid.includes(&quot;@&quot;)) {</span>
<a href="#l93.1973"></a><span id="l93.1973">       throw new Error(&quot;Invalid username&quot;);</span>
<a href="#l93.1974"></a><span id="l93.1974" class="difflineplus">+    }</span>
<a href="#l93.1975"></a><span id="l93.1975"> </span>
<a href="#l93.1976"></a><span id="l93.1976">     if (this._buddies.has(jid)) {</span>
<a href="#l93.1977"></a><span id="l93.1977">       let subscription = this._buddies.get(jid).subscription;</span>
<a href="#l93.1978"></a><span id="l93.1978">       if (subscription &amp;&amp; (subscription == &quot;both&quot; || subscription == &quot;to&quot;)) {</span>
<a href="#l93.1979"></a><span id="l93.1979">         this.DEBUG(&quot;not re-adding an existing buddy&quot;);</span>
<a href="#l93.1980"></a><span id="l93.1980">         return;</span>
<a href="#l93.1981"></a><span id="l93.1981">       }</span>
<a href="#l93.1982"></a><span id="l93.1982" class="difflineplus">+    } else {</span>
<a href="#l93.1983"></a><span id="l93.1983" class="difflineplus">+      let s = Stanza.iq(</span>
<a href="#l93.1984"></a><span id="l93.1984" class="difflineplus">+        &quot;set&quot;,</span>
<a href="#l93.1985"></a><span id="l93.1985" class="difflineplus">+        null,</span>
<a href="#l93.1986"></a><span id="l93.1986" class="difflineplus">+        null,</span>
<a href="#l93.1987"></a><span id="l93.1987" class="difflineplus">+        Stanza.node(</span>
<a href="#l93.1988"></a><span id="l93.1988" class="difflineplus">+          &quot;query&quot;,</span>
<a href="#l93.1989"></a><span id="l93.1989" class="difflineplus">+          Stanza.NS.roster,</span>
<a href="#l93.1990"></a><span id="l93.1990" class="difflineplus">+          null,</span>
<a href="#l93.1991"></a><span id="l93.1991" class="difflineplus">+          Stanza.node(</span>
<a href="#l93.1992"></a><span id="l93.1992" class="difflineplus">+            &quot;item&quot;,</span>
<a href="#l93.1993"></a><span id="l93.1993" class="difflineplus">+            null,</span>
<a href="#l93.1994"></a><span id="l93.1994" class="difflineplus">+            { jid },</span>
<a href="#l93.1995"></a><span id="l93.1995" class="difflineplus">+            Stanza.node(&quot;group&quot;, null, null, aTag.name)</span>
<a href="#l93.1996"></a><span id="l93.1996" class="difflineplus">+          )</span>
<a href="#l93.1997"></a><span id="l93.1997" class="difflineplus">+        )</span>
<a href="#l93.1998"></a><span id="l93.1998" class="difflineplus">+      );</span>
<a href="#l93.1999"></a><span id="l93.1999" class="difflineplus">+      this.sendStanza(</span>
<a href="#l93.2000"></a><span id="l93.2000" class="difflineplus">+        s,</span>
<a href="#l93.2001"></a><span id="l93.2001" class="difflineplus">+        this._handleResult({</span>
<a href="#l93.2002"></a><span id="l93.2002" class="difflineplus">+          default: aError =&gt; {</span>
<a href="#l93.2003"></a><span id="l93.2003" class="difflineplus">+            this.WARN(</span>
<a href="#l93.2004"></a><span id="l93.2004" class="difflineplus">+              &quot;Unable to add a roster item due to &quot; + aError + &quot; error.&quot;</span>
<a href="#l93.2005"></a><span id="l93.2005" class="difflineplus">+            );</span>
<a href="#l93.2006"></a><span id="l93.2006" class="difflineplus">+          },</span>
<a href="#l93.2007"></a><span id="l93.2007" class="difflineplus">+        })</span>
<a href="#l93.2008"></a><span id="l93.2008" class="difflineplus">+      );</span>
<a href="#l93.2009"></a><span id="l93.2009">     }</span>
<a href="#l93.2010"></a><span id="l93.2010" class="difflineminus">-    else {</span>
<a href="#l93.2011"></a><span id="l93.2011" class="difflineminus">-      let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l93.2012"></a><span id="l93.2012" class="difflineminus">-                        Stanza.node(&quot;query&quot;, Stanza.NS.roster, null,</span>
<a href="#l93.2013"></a><span id="l93.2013" class="difflineminus">-                                    Stanza.node(&quot;item&quot;, null, {jid},</span>
<a href="#l93.2014"></a><span id="l93.2014" class="difflineminus">-                                                Stanza.node(&quot;group&quot;, null, null,</span>
<a href="#l93.2015"></a><span id="l93.2015" class="difflineminus">-                                                            aTag.name))));</span>
<a href="#l93.2016"></a><span id="l93.2016" class="difflineminus">-      this.sendStanza(s, this._handleResult({</span>
<a href="#l93.2017"></a><span id="l93.2017" class="difflineminus">-        default: (aError) =&gt; {</span>
<a href="#l93.2018"></a><span id="l93.2018" class="difflineminus">-          this.WARN(&quot;Unable to add a roster item due to &quot; + aError +</span>
<a href="#l93.2019"></a><span id="l93.2019" class="difflineminus">-                    &quot; error.&quot;);</span>
<a href="#l93.2020"></a><span id="l93.2020" class="difflineminus">-        },</span>
<a href="#l93.2021"></a><span id="l93.2021" class="difflineminus">-      }));</span>
<a href="#l93.2022"></a><span id="l93.2022" class="difflineminus">-    }</span>
<a href="#l93.2023"></a><span id="l93.2023" class="difflineminus">-    this.sendStanza(Stanza.presence({to: jid, type: &quot;subscribe&quot;}));</span>
<a href="#l93.2024"></a><span id="l93.2024" class="difflineplus">+    this.sendStanza(Stanza.presence({ to: jid, type: &quot;subscribe&quot; }));</span>
<a href="#l93.2025"></a><span id="l93.2025">   },</span>
<a href="#l93.2026"></a><span id="l93.2026"> </span>
<a href="#l93.2027"></a><span id="l93.2027">   /* Loads a buddy from the local storage.</span>
<a href="#l93.2028"></a><span id="l93.2028">    * Called for each buddy locally stored before connecting</span>
<a href="#l93.2029"></a><span id="l93.2029">    * to the server. */</span>
<a href="#l93.2030"></a><span id="l93.2030">   loadBuddy(aBuddy, aTag) {</span>
<a href="#l93.2031"></a><span id="l93.2031">     let buddy = new this._accountBuddyConstructor(this, aBuddy, aTag);</span>
<a href="#l93.2032"></a><span id="l93.2032">     this._buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l93.2033"></a><span id="l93.2033">     return buddy;</span>
<a href="#l93.2034"></a><span id="l93.2034">   },</span>
<a href="#l93.2035"></a><span id="l93.2035"> </span>
<a href="#l93.2036"></a><span id="l93.2036">   /* Replies to a buddy request in order to accept it or deny it. */</span>
<a href="#l93.2037"></a><span id="l93.2037">   replyToBuddyRequest(aReply, aRequest) {</span>
<a href="#l93.2038"></a><span id="l93.2038" class="difflineminus">-    if (!this._connection)</span>
<a href="#l93.2039"></a><span id="l93.2039" class="difflineplus">+    if (!this._connection) {</span>
<a href="#l93.2040"></a><span id="l93.2040">       return;</span>
<a href="#l93.2041"></a><span id="l93.2041" class="difflineminus">-    let s = Stanza.presence({to: aRequest.userName, type: aReply});</span>
<a href="#l93.2042"></a><span id="l93.2042" class="difflineplus">+    }</span>
<a href="#l93.2043"></a><span id="l93.2043" class="difflineplus">+    let s = Stanza.presence({ to: aRequest.userName, type: aReply });</span>
<a href="#l93.2044"></a><span id="l93.2044">     this.sendStanza(s);</span>
<a href="#l93.2045"></a><span id="l93.2045">     this.removeBuddyRequest(aRequest);</span>
<a href="#l93.2046"></a><span id="l93.2046">   },</span>
<a href="#l93.2047"></a><span id="l93.2047"> </span>
<a href="#l93.2048"></a><span id="l93.2048">   requestBuddyInfo(aJid) {</span>
<a href="#l93.2049"></a><span id="l93.2049">     if (!this.connected) {</span>
<a href="#l93.2050"></a><span id="l93.2050">       Services.obs.notifyObservers(EmptyEnumerator, &quot;user-info-received&quot;, aJid);</span>
<a href="#l93.2051"></a><span id="l93.2051">       return;</span>
<a href="#l93.2052"></a><span id="l93.2052" class="difflineat">@@ -1428,146 +1748,189 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.2053"></a><span id="l93.2053">     let userName;</span>
<a href="#l93.2054"></a><span id="l93.2054">     let tooltipInfo = [];</span>
<a href="#l93.2055"></a><span id="l93.2055">     let jid = this._parseJID(aJid);</span>
<a href="#l93.2056"></a><span id="l93.2056">     let muc = this._mucs.get(jid.node + &quot;@&quot; + jid.domain);</span>
<a href="#l93.2057"></a><span id="l93.2057">     let participant;</span>
<a href="#l93.2058"></a><span id="l93.2058">     if (muc) {</span>
<a href="#l93.2059"></a><span id="l93.2059">       participant = muc._participants.get(jid.resource);</span>
<a href="#l93.2060"></a><span id="l93.2060">       if (participant) {</span>
<a href="#l93.2061"></a><span id="l93.2061" class="difflineminus">-        if (participant.accountJid)</span>
<a href="#l93.2062"></a><span id="l93.2062" class="difflineplus">+        if (participant.accountJid) {</span>
<a href="#l93.2063"></a><span id="l93.2063">           userName = participant.accountJid;</span>
<a href="#l93.2064"></a><span id="l93.2064" class="difflineplus">+        }</span>
<a href="#l93.2065"></a><span id="l93.2065">         if (!muc.left) {</span>
<a href="#l93.2066"></a><span id="l93.2066">           let statusType = participant.statusType;</span>
<a href="#l93.2067"></a><span id="l93.2067">           let statusText = participant.statusText;</span>
<a href="#l93.2068"></a><span id="l93.2068" class="difflineminus">-          tooltipInfo.push(new TooltipInfo(statusType, statusText,</span>
<a href="#l93.2069"></a><span id="l93.2069" class="difflineminus">-                                           Ci.prplITooltipInfo.status));</span>
<a href="#l93.2070"></a><span id="l93.2070" class="difflineplus">+          tooltipInfo.push(</span>
<a href="#l93.2071"></a><span id="l93.2071" class="difflineplus">+            new TooltipInfo(statusType, statusText, Ci.prplITooltipInfo.status)</span>
<a href="#l93.2072"></a><span id="l93.2072" class="difflineplus">+          );</span>
<a href="#l93.2073"></a><span id="l93.2073"> </span>
<a href="#l93.2074"></a><span id="l93.2074">           if (participant.buddyIconFilename) {</span>
<a href="#l93.2075"></a><span id="l93.2075" class="difflineminus">-            tooltipInfo.push(new TooltipInfo(null, participant.buddyIconFilename,</span>
<a href="#l93.2076"></a><span id="l93.2076" class="difflineminus">-                                             Ci.prplITooltipInfo.icon));</span>
<a href="#l93.2077"></a><span id="l93.2077" class="difflineplus">+            tooltipInfo.push(</span>
<a href="#l93.2078"></a><span id="l93.2078" class="difflineplus">+              new TooltipInfo(</span>
<a href="#l93.2079"></a><span id="l93.2079" class="difflineplus">+                null,</span>
<a href="#l93.2080"></a><span id="l93.2080" class="difflineplus">+                participant.buddyIconFilename,</span>
<a href="#l93.2081"></a><span id="l93.2081" class="difflineplus">+                Ci.prplITooltipInfo.icon</span>
<a href="#l93.2082"></a><span id="l93.2082" class="difflineplus">+              )</span>
<a href="#l93.2083"></a><span id="l93.2083" class="difflineplus">+            );</span>
<a href="#l93.2084"></a><span id="l93.2084">           }</span>
<a href="#l93.2085"></a><span id="l93.2085">         }</span>
<a href="#l93.2086"></a><span id="l93.2086">       }</span>
<a href="#l93.2087"></a><span id="l93.2087">     }</span>
<a href="#l93.2088"></a><span id="l93.2088" class="difflineminus">-    Services.obs.notifyObservers(new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l93.2089"></a><span id="l93.2089" class="difflineminus">-                                 &quot;user-info-received&quot;, aJid);</span>
<a href="#l93.2090"></a><span id="l93.2090" class="difflineminus">-</span>
<a href="#l93.2091"></a><span id="l93.2091" class="difflineminus">-    let iq = Stanza.iq(&quot;get&quot;, null, aJid, Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l93.2092"></a><span id="l93.2092" class="difflineplus">+    Services.obs.notifyObservers(</span>
<a href="#l93.2093"></a><span id="l93.2093" class="difflineplus">+      new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l93.2094"></a><span id="l93.2094" class="difflineplus">+      &quot;user-info-received&quot;,</span>
<a href="#l93.2095"></a><span id="l93.2095" class="difflineplus">+      aJid</span>
<a href="#l93.2096"></a><span id="l93.2096" class="difflineplus">+    );</span>
<a href="#l93.2097"></a><span id="l93.2097" class="difflineplus">+</span>
<a href="#l93.2098"></a><span id="l93.2098" class="difflineplus">+    let iq = Stanza.iq(</span>
<a href="#l93.2099"></a><span id="l93.2099" class="difflineplus">+      &quot;get&quot;,</span>
<a href="#l93.2100"></a><span id="l93.2100" class="difflineplus">+      null,</span>
<a href="#l93.2101"></a><span id="l93.2101" class="difflineplus">+      aJid,</span>
<a href="#l93.2102"></a><span id="l93.2102" class="difflineplus">+      Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard)</span>
<a href="#l93.2103"></a><span id="l93.2103" class="difflineplus">+    );</span>
<a href="#l93.2104"></a><span id="l93.2104">     this.sendStanza(iq, aStanza =&gt; {</span>
<a href="#l93.2105"></a><span id="l93.2105">       let vCardInfo = {};</span>
<a href="#l93.2106"></a><span id="l93.2106">       let vCardNode = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l93.2107"></a><span id="l93.2107"> </span>
<a href="#l93.2108"></a><span id="l93.2108">       // In the case of an error response, we just notify the observers with</span>
<a href="#l93.2109"></a><span id="l93.2109">       // what info we already have.</span>
<a href="#l93.2110"></a><span id="l93.2110" class="difflineminus">-      if (aStanza.attributes.type == &quot;result&quot; &amp;&amp; vCardNode)</span>
<a href="#l93.2111"></a><span id="l93.2111" class="difflineplus">+      if (aStanza.attributes.type == &quot;result&quot; &amp;&amp; vCardNode) {</span>
<a href="#l93.2112"></a><span id="l93.2112">         vCardInfo = this.parseVCard(vCardNode);</span>
<a href="#l93.2113"></a><span id="l93.2113" class="difflineplus">+      }</span>
<a href="#l93.2114"></a><span id="l93.2114"> </span>
<a href="#l93.2115"></a><span id="l93.2115">       // The real jid of participant which is of the form local@domain/resource.</span>
<a href="#l93.2116"></a><span id="l93.2116">       // We consider the jid is provided by server is more correct than jid is</span>
<a href="#l93.2117"></a><span id="l93.2117">       // set by the user.</span>
<a href="#l93.2118"></a><span id="l93.2118" class="difflineminus">-      if (userName)</span>
<a href="#l93.2119"></a><span id="l93.2119" class="difflineplus">+      if (userName) {</span>
<a href="#l93.2120"></a><span id="l93.2120">         vCardInfo.userName = userName;</span>
<a href="#l93.2121"></a><span id="l93.2121" class="difflineplus">+      }</span>
<a href="#l93.2122"></a><span id="l93.2122"> </span>
<a href="#l93.2123"></a><span id="l93.2123">       // vCard fields we want to display in the tooltip.</span>
<a href="#l93.2124"></a><span id="l93.2124" class="difflineminus">-      const kTooltipFields = [&quot;userName&quot;, &quot;fullName&quot;, &quot;nickname&quot;, &quot;title&quot;,</span>
<a href="#l93.2125"></a><span id="l93.2125" class="difflineminus">-                              &quot;organization&quot;, &quot;email&quot;, &quot;birthday&quot;, &quot;locality&quot;,</span>
<a href="#l93.2126"></a><span id="l93.2126" class="difflineminus">-                              &quot;country&quot;, &quot;telephone&quot;];</span>
<a href="#l93.2127"></a><span id="l93.2127" class="difflineplus">+      const kTooltipFields = [</span>
<a href="#l93.2128"></a><span id="l93.2128" class="difflineplus">+        &quot;userName&quot;,</span>
<a href="#l93.2129"></a><span id="l93.2129" class="difflineplus">+        &quot;fullName&quot;,</span>
<a href="#l93.2130"></a><span id="l93.2130" class="difflineplus">+        &quot;nickname&quot;,</span>
<a href="#l93.2131"></a><span id="l93.2131" class="difflineplus">+        &quot;title&quot;,</span>
<a href="#l93.2132"></a><span id="l93.2132" class="difflineplus">+        &quot;organization&quot;,</span>
<a href="#l93.2133"></a><span id="l93.2133" class="difflineplus">+        &quot;email&quot;,</span>
<a href="#l93.2134"></a><span id="l93.2134" class="difflineplus">+        &quot;birthday&quot;,</span>
<a href="#l93.2135"></a><span id="l93.2135" class="difflineplus">+        &quot;locality&quot;,</span>
<a href="#l93.2136"></a><span id="l93.2136" class="difflineplus">+        &quot;country&quot;,</span>
<a href="#l93.2137"></a><span id="l93.2137" class="difflineplus">+        &quot;telephone&quot;,</span>
<a href="#l93.2138"></a><span id="l93.2138" class="difflineplus">+      ];</span>
<a href="#l93.2139"></a><span id="l93.2139"> </span>
<a href="#l93.2140"></a><span id="l93.2140">       let tooltipInfo = [];</span>
<a href="#l93.2141"></a><span id="l93.2141">       for (let field of kTooltipFields) {</span>
<a href="#l93.2142"></a><span id="l93.2142" class="difflineminus">-        if (vCardInfo.hasOwnProperty(field))</span>
<a href="#l93.2143"></a><span id="l93.2143" class="difflineminus">-          tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), vCardInfo[field]));</span>
<a href="#l93.2144"></a><span id="l93.2144" class="difflineplus">+        if (vCardInfo.hasOwnProperty(field)) {</span>
<a href="#l93.2145"></a><span id="l93.2145" class="difflineplus">+          tooltipInfo.push(</span>
<a href="#l93.2146"></a><span id="l93.2146" class="difflineplus">+            new TooltipInfo(_(&quot;tooltip.&quot; + field), vCardInfo[field])</span>
<a href="#l93.2147"></a><span id="l93.2147" class="difflineplus">+          );</span>
<a href="#l93.2148"></a><span id="l93.2148" class="difflineplus">+        }</span>
<a href="#l93.2149"></a><span id="l93.2149">       }</span>
<a href="#l93.2150"></a><span id="l93.2150">       if (vCardInfo.photo) {</span>
<a href="#l93.2151"></a><span id="l93.2151">         let dataURI = this._getPhotoURI(vCardInfo.photo);</span>
<a href="#l93.2152"></a><span id="l93.2152"> </span>
<a href="#l93.2153"></a><span id="l93.2153">         // Store the photo URI for this participant.</span>
<a href="#l93.2154"></a><span id="l93.2154" class="difflineminus">-        if (participant)</span>
<a href="#l93.2155"></a><span id="l93.2155" class="difflineplus">+        if (participant) {</span>
<a href="#l93.2156"></a><span id="l93.2156">           participant.buddyIconFilename = dataURI;</span>
<a href="#l93.2157"></a><span id="l93.2157" class="difflineminus">-</span>
<a href="#l93.2158"></a><span id="l93.2158" class="difflineminus">-        tooltipInfo.push(new TooltipInfo(null, dataURI, Ci.prplITooltipInfo.icon));</span>
<a href="#l93.2159"></a><span id="l93.2159" class="difflineplus">+        }</span>
<a href="#l93.2160"></a><span id="l93.2160" class="difflineplus">+</span>
<a href="#l93.2161"></a><span id="l93.2161" class="difflineplus">+        tooltipInfo.push(</span>
<a href="#l93.2162"></a><span id="l93.2162" class="difflineplus">+          new TooltipInfo(null, dataURI, Ci.prplITooltipInfo.icon)</span>
<a href="#l93.2163"></a><span id="l93.2163" class="difflineplus">+        );</span>
<a href="#l93.2164"></a><span id="l93.2164">       }</span>
<a href="#l93.2165"></a><span id="l93.2165" class="difflineminus">-      Services.obs.notifyObservers(new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l93.2166"></a><span id="l93.2166" class="difflineminus">-                                   &quot;user-info-received&quot;, aJid);</span>
<a href="#l93.2167"></a><span id="l93.2167" class="difflineplus">+      Services.obs.notifyObservers(</span>
<a href="#l93.2168"></a><span id="l93.2168" class="difflineplus">+        new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l93.2169"></a><span id="l93.2169" class="difflineplus">+        &quot;user-info-received&quot;,</span>
<a href="#l93.2170"></a><span id="l93.2170" class="difflineplus">+        aJid</span>
<a href="#l93.2171"></a><span id="l93.2171" class="difflineplus">+      );</span>
<a href="#l93.2172"></a><span id="l93.2172">     });</span>
<a href="#l93.2173"></a><span id="l93.2173">   },</span>
<a href="#l93.2174"></a><span id="l93.2174"> </span>
<a href="#l93.2175"></a><span id="l93.2175">   // Parses the photo node of a received vCard if exists and returns string of</span>
<a href="#l93.2176"></a><span id="l93.2176">   // data URI, otherwise returns null.</span>
<a href="#l93.2177"></a><span id="l93.2177">   _getPhotoURI(aPhotoNode) {</span>
<a href="#l93.2178"></a><span id="l93.2178" class="difflineminus">-    if (!aPhotoNode)</span>
<a href="#l93.2179"></a><span id="l93.2179" class="difflineplus">+    if (!aPhotoNode) {</span>
<a href="#l93.2180"></a><span id="l93.2180">       return null;</span>
<a href="#l93.2181"></a><span id="l93.2181" class="difflineplus">+    }</span>
<a href="#l93.2182"></a><span id="l93.2182"> </span>
<a href="#l93.2183"></a><span id="l93.2183">     let type = aPhotoNode.getElement([&quot;TYPE&quot;]);</span>
<a href="#l93.2184"></a><span id="l93.2184">     let value = aPhotoNode.getElement([&quot;BINVAL&quot;]);</span>
<a href="#l93.2185"></a><span id="l93.2185" class="difflineminus">-    if (!type || !value)</span>
<a href="#l93.2186"></a><span id="l93.2186" class="difflineplus">+    if (!type || !value) {</span>
<a href="#l93.2187"></a><span id="l93.2187">       return null;</span>
<a href="#l93.2188"></a><span id="l93.2188" class="difflineplus">+    }</span>
<a href="#l93.2189"></a><span id="l93.2189"> </span>
<a href="#l93.2190"></a><span id="l93.2190">     return &quot;data:&quot; + type.innerText + &quot;;base64,&quot; + value.innerText;</span>
<a href="#l93.2191"></a><span id="l93.2191">   },</span>
<a href="#l93.2192"></a><span id="l93.2192"> </span>
<a href="#l93.2193"></a><span id="l93.2193">   // Parses the vCard into the properties of the returned object.</span>
<a href="#l93.2194"></a><span id="l93.2194">   parseVCard(aVCardNode) {</span>
<a href="#l93.2195"></a><span id="l93.2195">     // XEP-0054: vcard-temp.</span>
<a href="#l93.2196"></a><span id="l93.2196">     let aResult = {};</span>
<a href="#l93.2197"></a><span id="l93.2197" class="difflineminus">-    for (let node of aVCardNode.children.filter(child =&gt; child.type == &quot;node&quot;)) {</span>
<a href="#l93.2198"></a><span id="l93.2198" class="difflineplus">+    for (let node of aVCardNode.children.filter(</span>
<a href="#l93.2199"></a><span id="l93.2199" class="difflineplus">+      child =&gt; child.type == &quot;node&quot;</span>
<a href="#l93.2200"></a><span id="l93.2200" class="difflineplus">+    )) {</span>
<a href="#l93.2201"></a><span id="l93.2201">       let localName = node.localName;</span>
<a href="#l93.2202"></a><span id="l93.2202">       let innerText = node.innerText;</span>
<a href="#l93.2203"></a><span id="l93.2203">       if (innerText) {</span>
<a href="#l93.2204"></a><span id="l93.2204" class="difflineminus">-        if (localName == &quot;FN&quot;)</span>
<a href="#l93.2205"></a><span id="l93.2205" class="difflineplus">+        if (localName == &quot;FN&quot;) {</span>
<a href="#l93.2206"></a><span id="l93.2206">           aResult.fullName = innerText;</span>
<a href="#l93.2207"></a><span id="l93.2207" class="difflineminus">-        else if (localName == &quot;NICKNAME&quot;)</span>
<a href="#l93.2208"></a><span id="l93.2208" class="difflineplus">+        } else if (localName == &quot;NICKNAME&quot;) {</span>
<a href="#l93.2209"></a><span id="l93.2209">           aResult.nickname = innerText;</span>
<a href="#l93.2210"></a><span id="l93.2210" class="difflineminus">-        else if (localName == &quot;TITLE&quot;)</span>
<a href="#l93.2211"></a><span id="l93.2211" class="difflineplus">+        } else if (localName == &quot;TITLE&quot;) {</span>
<a href="#l93.2212"></a><span id="l93.2212">           aResult.title = innerText;</span>
<a href="#l93.2213"></a><span id="l93.2213" class="difflineminus">-        else if (localName == &quot;BDAY&quot;)</span>
<a href="#l93.2214"></a><span id="l93.2214" class="difflineplus">+        } else if (localName == &quot;BDAY&quot;) {</span>
<a href="#l93.2215"></a><span id="l93.2215">           aResult.birthday = innerText;</span>
<a href="#l93.2216"></a><span id="l93.2216" class="difflineminus">-        else if (localName == &quot;JABBERID&quot;)</span>
<a href="#l93.2217"></a><span id="l93.2217" class="difflineplus">+        } else if (localName == &quot;JABBERID&quot;) {</span>
<a href="#l93.2218"></a><span id="l93.2218">           aResult.userName = innerText;</span>
<a href="#l93.2219"></a><span id="l93.2219" class="difflineplus">+        }</span>
<a href="#l93.2220"></a><span id="l93.2220">       }</span>
<a href="#l93.2221"></a><span id="l93.2221">       if (localName == &quot;ORG&quot;) {</span>
<a href="#l93.2222"></a><span id="l93.2222">         let organization = node.getElement([&quot;ORGNAME&quot;]);</span>
<a href="#l93.2223"></a><span id="l93.2223" class="difflineminus">-        if (organization &amp;&amp; organization.innerText)</span>
<a href="#l93.2224"></a><span id="l93.2224" class="difflineplus">+        if (organization &amp;&amp; organization.innerText) {</span>
<a href="#l93.2225"></a><span id="l93.2225">           aResult.organization = organization.innerText;</span>
<a href="#l93.2226"></a><span id="l93.2226" class="difflineminus">-      }</span>
<a href="#l93.2227"></a><span id="l93.2227" class="difflineminus">-      else if (localName == &quot;EMAIL&quot;) {</span>
<a href="#l93.2228"></a><span id="l93.2228" class="difflineplus">+        }</span>
<a href="#l93.2229"></a><span id="l93.2229" class="difflineplus">+      } else if (localName == &quot;EMAIL&quot;) {</span>
<a href="#l93.2230"></a><span id="l93.2230">         let userID = node.getElement([&quot;USERID&quot;]);</span>
<a href="#l93.2231"></a><span id="l93.2231" class="difflineminus">-        if (userID &amp;&amp; userID.innerText)</span>
<a href="#l93.2232"></a><span id="l93.2232" class="difflineplus">+        if (userID &amp;&amp; userID.innerText) {</span>
<a href="#l93.2233"></a><span id="l93.2233">           aResult.email = userID.innerText;</span>
<a href="#l93.2234"></a><span id="l93.2234" class="difflineminus">-      }</span>
<a href="#l93.2235"></a><span id="l93.2235" class="difflineminus">-      else if (localName == &quot;ADR&quot;) {</span>
<a href="#l93.2236"></a><span id="l93.2236" class="difflineplus">+        }</span>
<a href="#l93.2237"></a><span id="l93.2237" class="difflineplus">+      } else if (localName == &quot;ADR&quot;) {</span>
<a href="#l93.2238"></a><span id="l93.2238">         let locality = node.getElement([&quot;LOCALITY&quot;]);</span>
<a href="#l93.2239"></a><span id="l93.2239" class="difflineminus">-        if (locality &amp;&amp; locality.innerText)</span>
<a href="#l93.2240"></a><span id="l93.2240" class="difflineplus">+        if (locality &amp;&amp; locality.innerText) {</span>
<a href="#l93.2241"></a><span id="l93.2241">           aResult.locality = locality.innerText;</span>
<a href="#l93.2242"></a><span id="l93.2242" class="difflineplus">+        }</span>
<a href="#l93.2243"></a><span id="l93.2243"> </span>
<a href="#l93.2244"></a><span id="l93.2244">         let country = node.getElement([&quot;CTRY&quot;]);</span>
<a href="#l93.2245"></a><span id="l93.2245" class="difflineminus">-        if (country &amp;&amp; country.innerText)</span>
<a href="#l93.2246"></a><span id="l93.2246" class="difflineplus">+        if (country &amp;&amp; country.innerText) {</span>
<a href="#l93.2247"></a><span id="l93.2247">           aResult.country = country.innerText;</span>
<a href="#l93.2248"></a><span id="l93.2248" class="difflineminus">-      }</span>
<a href="#l93.2249"></a><span id="l93.2249" class="difflineminus">-      else if (localName == &quot;PHOTO&quot;)</span>
<a href="#l93.2250"></a><span id="l93.2250" class="difflineplus">+        }</span>
<a href="#l93.2251"></a><span id="l93.2251" class="difflineplus">+      } else if (localName == &quot;PHOTO&quot;) {</span>
<a href="#l93.2252"></a><span id="l93.2252">         aResult.photo = node;</span>
<a href="#l93.2253"></a><span id="l93.2253" class="difflineminus">-      else if (localName == &quot;TEL&quot;) {</span>
<a href="#l93.2254"></a><span id="l93.2254" class="difflineplus">+      } else if (localName == &quot;TEL&quot;) {</span>
<a href="#l93.2255"></a><span id="l93.2255">         let number = node.getElement([&quot;NUMBER&quot;]);</span>
<a href="#l93.2256"></a><span id="l93.2256" class="difflineminus">-        if (number &amp;&amp; number.innerText)</span>
<a href="#l93.2257"></a><span id="l93.2257" class="difflineplus">+        if (number &amp;&amp; number.innerText) {</span>
<a href="#l93.2258"></a><span id="l93.2258">           aResult.telephone = number.innerText;</span>
<a href="#l93.2259"></a><span id="l93.2259" class="difflineplus">+        }</span>
<a href="#l93.2260"></a><span id="l93.2260">       }</span>
<a href="#l93.2261"></a><span id="l93.2261">       // TODO: Parse the other fields of vCard and display it in system messages</span>
<a href="#l93.2262"></a><span id="l93.2262">       // in response to /whois.</span>
<a href="#l93.2263"></a><span id="l93.2263">     }</span>
<a href="#l93.2264"></a><span id="l93.2264">     return aResult;</span>
<a href="#l93.2265"></a><span id="l93.2265">   },</span>
<a href="#l93.2266"></a><span id="l93.2266"> </span>
<a href="#l93.2267"></a><span id="l93.2267">   // Returns undefined if not an error stanza, and an object</span>
<a href="#l93.2268"></a><span id="l93.2268">   // describing the error otherwise:</span>
<a href="#l93.2269"></a><span id="l93.2269">   parseError(aStanza) {</span>
<a href="#l93.2270"></a><span id="l93.2270" class="difflineminus">-    if (aStanza.attributes.type != &quot;error&quot;)</span>
<a href="#l93.2271"></a><span id="l93.2271" class="difflineplus">+    if (aStanza.attributes.type != &quot;error&quot;) {</span>
<a href="#l93.2272"></a><span id="l93.2272">       return undefined;</span>
<a href="#l93.2273"></a><span id="l93.2273" class="difflineminus">-</span>
<a href="#l93.2274"></a><span id="l93.2274" class="difflineminus">-    let retval = {stanza: aStanza};</span>
<a href="#l93.2275"></a><span id="l93.2275" class="difflineplus">+    }</span>
<a href="#l93.2276"></a><span id="l93.2276" class="difflineplus">+</span>
<a href="#l93.2277"></a><span id="l93.2277" class="difflineplus">+    let retval = { stanza: aStanza };</span>
<a href="#l93.2278"></a><span id="l93.2278">     let error = aStanza.getElement([&quot;error&quot;]);</span>
<a href="#l93.2279"></a><span id="l93.2279"> </span>
<a href="#l93.2280"></a><span id="l93.2280">     // RFC 6120 Section 8.3.2: Type must be one of</span>
<a href="#l93.2281"></a><span id="l93.2281">     // auth -- retry after providing credentials</span>
<a href="#l93.2282"></a><span id="l93.2282">     // cancel -- do not retry (the error cannot be remedied)</span>
<a href="#l93.2283"></a><span id="l93.2283">     // continue -- proceed (the condition was only a warning)</span>
<a href="#l93.2284"></a><span id="l93.2284">     // modify -- retry after changing the data sent</span>
<a href="#l93.2285"></a><span id="l93.2285">     // wait -- retry after waiting (the error is temporary).</span>
<a href="#l93.2286"></a><span id="l93.2286" class="difflineat">@@ -1596,263 +1959,324 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.2287"></a><span id="l93.2287">       &quot;service-unavailable&quot;,</span>
<a href="#l93.2288"></a><span id="l93.2288">       &quot;subscription-required&quot;,</span>
<a href="#l93.2289"></a><span id="l93.2289">       &quot;undefined-condition&quot;,</span>
<a href="#l93.2290"></a><span id="l93.2290">       &quot;unexpected-request&quot;,</span>
<a href="#l93.2291"></a><span id="l93.2291">     ];</span>
<a href="#l93.2292"></a><span id="l93.2292">     let condition = kDefinedConditions.find(c =&gt; error.getElement([c]));</span>
<a href="#l93.2293"></a><span id="l93.2293">     if (!condition) {</span>
<a href="#l93.2294"></a><span id="l93.2294">       // RFC 6120 Section 8.3.2.</span>
<a href="#l93.2295"></a><span id="l93.2295" class="difflineminus">-      this.WARN(&quot;Nonstandard or missing defined-condition element in &quot; +</span>
<a href="#l93.2296"></a><span id="l93.2296" class="difflineminus">-        &quot;error stanza.&quot;);</span>
<a href="#l93.2297"></a><span id="l93.2297" class="difflineplus">+      this.WARN(</span>
<a href="#l93.2298"></a><span id="l93.2298" class="difflineplus">+        &quot;Nonstandard or missing defined-condition element in &quot; + &quot;error stanza.&quot;</span>
<a href="#l93.2299"></a><span id="l93.2299" class="difflineplus">+      );</span>
<a href="#l93.2300"></a><span id="l93.2300">       condition = &quot;undefined-condition&quot;;</span>
<a href="#l93.2301"></a><span id="l93.2301">     }</span>
<a href="#l93.2302"></a><span id="l93.2302">     retval.condition = condition;</span>
<a href="#l93.2303"></a><span id="l93.2303"> </span>
<a href="#l93.2304"></a><span id="l93.2304">     let errortext = error.getElement([&quot;text&quot;]);</span>
<a href="#l93.2305"></a><span id="l93.2305" class="difflineminus">-    if (errortext)</span>
<a href="#l93.2306"></a><span id="l93.2306" class="difflineplus">+    if (errortext) {</span>
<a href="#l93.2307"></a><span id="l93.2307">       retval.text = errortext.innerText;</span>
<a href="#l93.2308"></a><span id="l93.2308" class="difflineplus">+    }</span>
<a href="#l93.2309"></a><span id="l93.2309"> </span>
<a href="#l93.2310"></a><span id="l93.2310">     return retval;</span>
<a href="#l93.2311"></a><span id="l93.2311">   },</span>
<a href="#l93.2312"></a><span id="l93.2312"> </span>
<a href="#l93.2313"></a><span id="l93.2313">   // Returns an error-handling callback for use with sendStanza generated</span>
<a href="#l93.2314"></a><span id="l93.2314">   // from aHandlers, an object defining the error handlers.</span>
<a href="#l93.2315"></a><span id="l93.2315">   // If the stanza passed to the callback is an error stanza, it checks if</span>
<a href="#l93.2316"></a><span id="l93.2316">   // aHandlers contains a property with the name of the defined condition</span>
<a href="#l93.2317"></a><span id="l93.2317">   // of the error.</span>
<a href="#l93.2318"></a><span id="l93.2318">   // * If the property is a function, it is called with the parsed error</span>
<a href="#l93.2319"></a><span id="l93.2319">   //   as its argument, bound to aThis (if provided).</span>
<a href="#l93.2320"></a><span id="l93.2320">   //   It should return true if the error was handled.</span>
<a href="#l93.2321"></a><span id="l93.2321">   // * If the property is a string, it is displayed as a system message</span>
<a href="#l93.2322"></a><span id="l93.2322">   //   in the conversation given by aThis.</span>
<a href="#l93.2323"></a><span id="l93.2323">   handleErrors(aHandlers, aThis) {</span>
<a href="#l93.2324"></a><span id="l93.2324" class="difflineminus">-    return (aStanza) =&gt; {</span>
<a href="#l93.2325"></a><span id="l93.2325" class="difflineminus">-      if (!aHandlers)</span>
<a href="#l93.2326"></a><span id="l93.2326" class="difflineplus">+    return aStanza =&gt; {</span>
<a href="#l93.2327"></a><span id="l93.2327" class="difflineplus">+      if (!aHandlers) {</span>
<a href="#l93.2328"></a><span id="l93.2328">         return false;</span>
<a href="#l93.2329"></a><span id="l93.2329" class="difflineplus">+      }</span>
<a href="#l93.2330"></a><span id="l93.2330"> </span>
<a href="#l93.2331"></a><span id="l93.2331">       let error = this.parseError(aStanza);</span>
<a href="#l93.2332"></a><span id="l93.2332" class="difflineminus">-      if (!error)</span>
<a href="#l93.2333"></a><span id="l93.2333" class="difflineplus">+      if (!error) {</span>
<a href="#l93.2334"></a><span id="l93.2334">         return false;</span>
<a href="#l93.2335"></a><span id="l93.2335" class="difflineplus">+      }</span>
<a href="#l93.2336"></a><span id="l93.2336"> </span>
<a href="#l93.2337"></a><span id="l93.2337">       let toCamelCase = aStr =&gt; {</span>
<a href="#l93.2338"></a><span id="l93.2338">         // Turn defined condition string into a valid camelcase</span>
<a href="#l93.2339"></a><span id="l93.2339">         // JS property name.</span>
<a href="#l93.2340"></a><span id="l93.2340" class="difflineminus">-        let capitalize = s =&gt; (s[0].toUpperCase() + s.slice(1));</span>
<a href="#l93.2341"></a><span id="l93.2341" class="difflineminus">-        let uncapitalize = s =&gt; (s[0].toLowerCase() + s.slice(1));</span>
<a href="#l93.2342"></a><span id="l93.2342" class="difflineminus">-        return uncapitalize(aStr.split(&quot;-&quot;).map(capitalize).join(&quot;&quot;));</span>
<a href="#l93.2343"></a><span id="l93.2343" class="difflineplus">+        let capitalize = s =&gt; s[0].toUpperCase() + s.slice(1);</span>
<a href="#l93.2344"></a><span id="l93.2344" class="difflineplus">+        let uncapitalize = s =&gt; s[0].toLowerCase() + s.slice(1);</span>
<a href="#l93.2345"></a><span id="l93.2345" class="difflineplus">+        return uncapitalize(</span>
<a href="#l93.2346"></a><span id="l93.2346" class="difflineplus">+          aStr</span>
<a href="#l93.2347"></a><span id="l93.2347" class="difflineplus">+            .split(&quot;-&quot;)</span>
<a href="#l93.2348"></a><span id="l93.2348" class="difflineplus">+            .map(capitalize)</span>
<a href="#l93.2349"></a><span id="l93.2349" class="difflineplus">+            .join(&quot;&quot;)</span>
<a href="#l93.2350"></a><span id="l93.2350" class="difflineplus">+        );</span>
<a href="#l93.2351"></a><span id="l93.2351">       };</span>
<a href="#l93.2352"></a><span id="l93.2352">       let condition = toCamelCase(error.condition);</span>
<a href="#l93.2353"></a><span id="l93.2353">       // Check if we have a handler property for this kind of error or a</span>
<a href="#l93.2354"></a><span id="l93.2354">       // default handler.</span>
<a href="#l93.2355"></a><span id="l93.2355" class="difflineminus">-      if (!(condition in aHandlers) &amp;&amp; !(&quot;default&quot; in aHandlers))</span>
<a href="#l93.2356"></a><span id="l93.2356" class="difflineplus">+      if (!(condition in aHandlers) &amp;&amp; !(&quot;default&quot; in aHandlers)) {</span>
<a href="#l93.2357"></a><span id="l93.2357">         return false;</span>
<a href="#l93.2358"></a><span id="l93.2358" class="difflineplus">+      }</span>
<a href="#l93.2359"></a><span id="l93.2359"> </span>
<a href="#l93.2360"></a><span id="l93.2360">       // Try to get the handler for condition, if we cannot get it, try to get</span>
<a href="#l93.2361"></a><span id="l93.2361">       // the default handler.</span>
<a href="#l93.2362"></a><span id="l93.2362">       let handler = aHandlers[condition];</span>
<a href="#l93.2363"></a><span id="l93.2363" class="difflineminus">-      if (!handler)</span>
<a href="#l93.2364"></a><span id="l93.2364" class="difflineplus">+      if (!handler) {</span>
<a href="#l93.2365"></a><span id="l93.2365">         handler = aHandlers.default;</span>
<a href="#l93.2366"></a><span id="l93.2366" class="difflineplus">+      }</span>
<a href="#l93.2367"></a><span id="l93.2367"> </span>
<a href="#l93.2368"></a><span id="l93.2368">       if (typeof handler == &quot;string&quot;) {</span>
<a href="#l93.2369"></a><span id="l93.2369">         // The string is an error message to be displayed in the conversation.</span>
<a href="#l93.2370"></a><span id="l93.2370">         if (!aThis || !aThis.writeMessage) {</span>
<a href="#l93.2371"></a><span id="l93.2371" class="difflineminus">-          this.ERROR(&quot;HandleErrors was passed an error message string, but &quot; +</span>
<a href="#l93.2372"></a><span id="l93.2372" class="difflineminus">-            &quot;no conversation to display it in:\n&quot; + handler);</span>
<a href="#l93.2373"></a><span id="l93.2373" class="difflineplus">+          this.ERROR(</span>
<a href="#l93.2374"></a><span id="l93.2374" class="difflineplus">+            &quot;HandleErrors was passed an error message string, but &quot; +</span>
<a href="#l93.2375"></a><span id="l93.2375" class="difflineplus">+              &quot;no conversation to display it in:\n&quot; +</span>
<a href="#l93.2376"></a><span id="l93.2376" class="difflineplus">+              handler</span>
<a href="#l93.2377"></a><span id="l93.2377" class="difflineplus">+          );</span>
<a href="#l93.2378"></a><span id="l93.2378">           return true;</span>
<a href="#l93.2379"></a><span id="l93.2379">         }</span>
<a href="#l93.2380"></a><span id="l93.2380" class="difflineminus">-        aThis.writeMessage(aThis.name, handler, {system: true, error: true});</span>
<a href="#l93.2381"></a><span id="l93.2381" class="difflineplus">+        aThis.writeMessage(aThis.name, handler, { system: true, error: true });</span>
<a href="#l93.2382"></a><span id="l93.2382">         return true;</span>
<a href="#l93.2383"></a><span id="l93.2383" class="difflineminus">-      }</span>
<a href="#l93.2384"></a><span id="l93.2384" class="difflineminus">-      else if (typeof handler == &quot;function&quot;) {</span>
<a href="#l93.2385"></a><span id="l93.2385" class="difflineplus">+      } else if (typeof handler == &quot;function&quot;) {</span>
<a href="#l93.2386"></a><span id="l93.2386">         // If we're given a function, call this error handler.</span>
<a href="#l93.2387"></a><span id="l93.2387">         return handler.call(aThis, error);</span>
<a href="#l93.2388"></a><span id="l93.2388">       }</span>
<a href="#l93.2389"></a><span id="l93.2389"> </span>
<a href="#l93.2390"></a><span id="l93.2390">       // If this happens, there's a bug somewhere.</span>
<a href="#l93.2391"></a><span id="l93.2391" class="difflineminus">-      this.ERROR(&quot;HandleErrors was passed a handler for '&quot; + condition +</span>
<a href="#l93.2392"></a><span id="l93.2392" class="difflineminus">-        &quot;'' which is neither a function nor a string.&quot;);</span>
<a href="#l93.2393"></a><span id="l93.2393" class="difflineplus">+      this.ERROR(</span>
<a href="#l93.2394"></a><span id="l93.2394" class="difflineplus">+        &quot;HandleErrors was passed a handler for '&quot; +</span>
<a href="#l93.2395"></a><span id="l93.2395" class="difflineplus">+          condition +</span>
<a href="#l93.2396"></a><span id="l93.2396" class="difflineplus">+          &quot;'' which is neither a function nor a string.&quot;</span>
<a href="#l93.2397"></a><span id="l93.2397" class="difflineplus">+      );</span>
<a href="#l93.2398"></a><span id="l93.2398">       return false;</span>
<a href="#l93.2399"></a><span id="l93.2399">     };</span>
<a href="#l93.2400"></a><span id="l93.2400">   },</span>
<a href="#l93.2401"></a><span id="l93.2401"> </span>
<a href="#l93.2402"></a><span id="l93.2402">   // Returns a callback suitable for use in sendStanza, to handle type==result</span>
<a href="#l93.2403"></a><span id="l93.2403">   // responses. aHandlers and aThis are passed on to handleErrors for error</span>
<a href="#l93.2404"></a><span id="l93.2404">   // handling.</span>
<a href="#l93.2405"></a><span id="l93.2405">   _handleResult(aHandlers, aThis) {</span>
<a href="#l93.2406"></a><span id="l93.2406">     return aStanza =&gt; {</span>
<a href="#l93.2407"></a><span id="l93.2407" class="difflineminus">-      if (aStanza.attributes.type == &quot;result&quot;)</span>
<a href="#l93.2408"></a><span id="l93.2408" class="difflineplus">+      if (aStanza.attributes.type == &quot;result&quot;) {</span>
<a href="#l93.2409"></a><span id="l93.2409">         return true;</span>
<a href="#l93.2410"></a><span id="l93.2410" class="difflineplus">+      }</span>
<a href="#l93.2411"></a><span id="l93.2411">       return this.handleErrors(aHandlers, aThis)(aStanza);</span>
<a href="#l93.2412"></a><span id="l93.2412">     };</span>
<a href="#l93.2413"></a><span id="l93.2413">   },</span>
<a href="#l93.2414"></a><span id="l93.2414"> </span>
<a href="#l93.2415"></a><span id="l93.2415">   /* XMPPSession events */</span>
<a href="#l93.2416"></a><span id="l93.2416"> </span>
<a href="#l93.2417"></a><span id="l93.2417">   /* Called when the XMPP session is started */</span>
<a href="#l93.2418"></a><span id="l93.2418">   onConnection() {</span>
<a href="#l93.2419"></a><span id="l93.2419">     // Request the roster. The account will be marked as connected when this is</span>
<a href="#l93.2420"></a><span id="l93.2420">     // complete.</span>
<a href="#l93.2421"></a><span id="l93.2421">     this.reportConnecting(_(&quot;connection.downloadingRoster&quot;));</span>
<a href="#l93.2422"></a><span id="l93.2422" class="difflineminus">-    let s = Stanza.iq(&quot;get&quot;, null, null, Stanza.node(&quot;query&quot;, Stanza.NS.roster));</span>
<a href="#l93.2423"></a><span id="l93.2423" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.2424"></a><span id="l93.2424" class="difflineplus">+      &quot;get&quot;,</span>
<a href="#l93.2425"></a><span id="l93.2425" class="difflineplus">+      null,</span>
<a href="#l93.2426"></a><span id="l93.2426" class="difflineplus">+      null,</span>
<a href="#l93.2427"></a><span id="l93.2427" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.roster)</span>
<a href="#l93.2428"></a><span id="l93.2428" class="difflineplus">+    );</span>
<a href="#l93.2429"></a><span id="l93.2429">     this.sendStanza(s, this.onRoster, this);</span>
<a href="#l93.2430"></a><span id="l93.2430"> </span>
<a href="#l93.2431"></a><span id="l93.2431">     // XEP-0030 and XEP-0045 (6): Service Discovery.</span>
<a href="#l93.2432"></a><span id="l93.2432">     // Queries Server for Associated Services.</span>
<a href="#l93.2433"></a><span id="l93.2433" class="difflineminus">-    let iq = Stanza.iq(&quot;get&quot;, null, this._jid.domain,</span>
<a href="#l93.2434"></a><span id="l93.2434" class="difflineminus">-                       Stanza.node(&quot;query&quot;, Stanza.NS.disco_items));</span>
<a href="#l93.2435"></a><span id="l93.2435" class="difflineplus">+    let iq = Stanza.iq(</span>
<a href="#l93.2436"></a><span id="l93.2436" class="difflineplus">+      &quot;get&quot;,</span>
<a href="#l93.2437"></a><span id="l93.2437" class="difflineplus">+      null,</span>
<a href="#l93.2438"></a><span id="l93.2438" class="difflineplus">+      this._jid.domain,</span>
<a href="#l93.2439"></a><span id="l93.2439" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.disco_items)</span>
<a href="#l93.2440"></a><span id="l93.2440" class="difflineplus">+    );</span>
<a href="#l93.2441"></a><span id="l93.2441">     this.sendStanza(iq, this.onServiceDiscovery, this);</span>
<a href="#l93.2442"></a><span id="l93.2442"> </span>
<a href="#l93.2443"></a><span id="l93.2443">     // XEP-0030: Service Discovery Information Features.</span>
<a href="#l93.2444"></a><span id="l93.2444" class="difflineminus">-    iq = Stanza.iq(&quot;get&quot;, null, this._jid.domain,</span>
<a href="#l93.2445"></a><span id="l93.2445" class="difflineminus">-                       Stanza.node(&quot;query&quot;, Stanza.NS.disco_info));</span>
<a href="#l93.2446"></a><span id="l93.2446" class="difflineplus">+    iq = Stanza.iq(</span>
<a href="#l93.2447"></a><span id="l93.2447" class="difflineplus">+      &quot;get&quot;,</span>
<a href="#l93.2448"></a><span id="l93.2448" class="difflineplus">+      null,</span>
<a href="#l93.2449"></a><span id="l93.2449" class="difflineplus">+      this._jid.domain,</span>
<a href="#l93.2450"></a><span id="l93.2450" class="difflineplus">+      Stanza.node(&quot;query&quot;, Stanza.NS.disco_info)</span>
<a href="#l93.2451"></a><span id="l93.2451" class="difflineplus">+    );</span>
<a href="#l93.2452"></a><span id="l93.2452">     this.sendStanza(iq, this.onServiceDiscoveryInfo, this);</span>
<a href="#l93.2453"></a><span id="l93.2453">   },</span>
<a href="#l93.2454"></a><span id="l93.2454"> </span>
<a href="#l93.2455"></a><span id="l93.2455">   /* Called whenever a stanza is received */</span>
<a href="#l93.2456"></a><span id="l93.2456" class="difflineminus">-  onXmppStanza(aStanza) {</span>
<a href="#l93.2457"></a><span id="l93.2457" class="difflineminus">-  },</span>
<a href="#l93.2458"></a><span id="l93.2458" class="difflineplus">+  onXmppStanza(aStanza) {},</span>
<a href="#l93.2459"></a><span id="l93.2459"> </span>
<a href="#l93.2460"></a><span id="l93.2460">   /* Called when a iq stanza is received */</span>
<a href="#l93.2461"></a><span id="l93.2461">   onIQStanza(aStanza) {</span>
<a href="#l93.2462"></a><span id="l93.2462">     let type = aStanza.attributes.type;</span>
<a href="#l93.2463"></a><span id="l93.2463">     if (type == &quot;set&quot;) {</span>
<a href="#l93.2464"></a><span id="l93.2464">       for (let query of aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l93.2465"></a><span id="l93.2465" class="difflineminus">-        if (query.uri != Stanza.NS.roster)</span>
<a href="#l93.2466"></a><span id="l93.2466" class="difflineplus">+        if (query.uri != Stanza.NS.roster) {</span>
<a href="#l93.2467"></a><span id="l93.2467">           continue;</span>
<a href="#l93.2468"></a><span id="l93.2468" class="difflineplus">+        }</span>
<a href="#l93.2469"></a><span id="l93.2469"> </span>
<a href="#l93.2470"></a><span id="l93.2470">         // RFC 6121 2.1.6 (Roster push):</span>
<a href="#l93.2471"></a><span id="l93.2471">         // A receiving client MUST ignore the stanza unless it has no 'from'</span>
<a href="#l93.2472"></a><span id="l93.2472">         // attribute (i.e., implicitly from the bare JID of the user's</span>
<a href="#l93.2473"></a><span id="l93.2473">         // account) or it has a 'from' attribute whose value matches the</span>
<a href="#l93.2474"></a><span id="l93.2474">         // user's bare JID &lt;user@domainpart&gt;.</span>
<a href="#l93.2475"></a><span id="l93.2475">         let from = aStanza.attributes.from;</span>
<a href="#l93.2476"></a><span id="l93.2476">         if (from &amp;&amp; from != this._jid.node + &quot;@&quot; + this._jid.domain) {</span>
<a href="#l93.2477"></a><span id="l93.2477">           this.WARN(&quot;Ignoring potentially spoofed roster push.&quot;);</span>
<a href="#l93.2478"></a><span id="l93.2478">           return;</span>
<a href="#l93.2479"></a><span id="l93.2479">         }</span>
<a href="#l93.2480"></a><span id="l93.2480"> </span>
<a href="#l93.2481"></a><span id="l93.2481" class="difflineminus">-        for (let item of query.getChildren(&quot;item&quot;))</span>
<a href="#l93.2482"></a><span id="l93.2482" class="difflineplus">+        for (let item of query.getChildren(&quot;item&quot;)) {</span>
<a href="#l93.2483"></a><span id="l93.2483">           this._onRosterItem(item, true);</span>
<a href="#l93.2484"></a><span id="l93.2484" class="difflineplus">+        }</span>
<a href="#l93.2485"></a><span id="l93.2485">         return;</span>
<a href="#l93.2486"></a><span id="l93.2486">       }</span>
<a href="#l93.2487"></a><span id="l93.2487" class="difflineminus">-    }</span>
<a href="#l93.2488"></a><span id="l93.2488" class="difflineminus">-    else if (type == &quot;get&quot;) {</span>
<a href="#l93.2489"></a><span id="l93.2489" class="difflineplus">+    } else if (type == &quot;get&quot;) {</span>
<a href="#l93.2490"></a><span id="l93.2490">       let id = aStanza.attributes.id;</span>
<a href="#l93.2491"></a><span id="l93.2491">       let from = aStanza.attributes.from;</span>
<a href="#l93.2492"></a><span id="l93.2492"> </span>
<a href="#l93.2493"></a><span id="l93.2493">       // XEP-0199: XMPP server-to-client ping (XEP-0199)</span>
<a href="#l93.2494"></a><span id="l93.2494">       let ping = aStanza.getElement([&quot;ping&quot;]);</span>
<a href="#l93.2495"></a><span id="l93.2495">       if (ping &amp;&amp; ping.uri == Stanza.NS.ping) {</span>
<a href="#l93.2496"></a><span id="l93.2496" class="difflineminus">-        if (from == this._jid.domain)</span>
<a href="#l93.2497"></a><span id="l93.2497" class="difflineplus">+        if (from == this._jid.domain) {</span>
<a href="#l93.2498"></a><span id="l93.2498">           this.sendStanza(Stanza.iq(&quot;result&quot;, id, this._jid.domain));</span>
<a href="#l93.2499"></a><span id="l93.2499" class="difflineplus">+        }</span>
<a href="#l93.2500"></a><span id="l93.2500">         return;</span>
<a href="#l93.2501"></a><span id="l93.2501">       }</span>
<a href="#l93.2502"></a><span id="l93.2502"> </span>
<a href="#l93.2503"></a><span id="l93.2503">       let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l93.2504"></a><span id="l93.2504">       if (query &amp;&amp; query.uri == Stanza.NS.version) {</span>
<a href="#l93.2505"></a><span id="l93.2505">         // XEP-0092: Software Version.</span>
<a href="#l93.2506"></a><span id="l93.2506">         let children = [];</span>
<a href="#l93.2507"></a><span id="l93.2507">         children.push(Stanza.node(&quot;name&quot;, null, null, Services.appinfo.name));</span>
<a href="#l93.2508"></a><span id="l93.2508" class="difflineminus">-        children.push(Stanza.node(&quot;version&quot;, null, null,</span>
<a href="#l93.2509"></a><span id="l93.2509" class="difflineminus">-                                  Services.appinfo.version));</span>
<a href="#l93.2510"></a><span id="l93.2510" class="difflineminus">-        let versionQuery = Stanza.node(&quot;query&quot;, Stanza.NS.version, null,</span>
<a href="#l93.2511"></a><span id="l93.2511" class="difflineminus">-                                       children);</span>
<a href="#l93.2512"></a><span id="l93.2512" class="difflineplus">+        children.push(</span>
<a href="#l93.2513"></a><span id="l93.2513" class="difflineplus">+          Stanza.node(&quot;version&quot;, null, null, Services.appinfo.version)</span>
<a href="#l93.2514"></a><span id="l93.2514" class="difflineplus">+        );</span>
<a href="#l93.2515"></a><span id="l93.2515" class="difflineplus">+        let versionQuery = Stanza.node(</span>
<a href="#l93.2516"></a><span id="l93.2516" class="difflineplus">+          &quot;query&quot;,</span>
<a href="#l93.2517"></a><span id="l93.2517" class="difflineplus">+          Stanza.NS.version,</span>
<a href="#l93.2518"></a><span id="l93.2518" class="difflineplus">+          null,</span>
<a href="#l93.2519"></a><span id="l93.2519" class="difflineplus">+          children</span>
<a href="#l93.2520"></a><span id="l93.2520" class="difflineplus">+        );</span>
<a href="#l93.2521"></a><span id="l93.2521">         this.sendStanza(Stanza.iq(&quot;result&quot;, id, from, versionQuery));</span>
<a href="#l93.2522"></a><span id="l93.2522">         return;</span>
<a href="#l93.2523"></a><span id="l93.2523">       }</span>
<a href="#l93.2524"></a><span id="l93.2524">       if (query &amp;&amp; query.uri == Stanza.NS.disco_info) {</span>
<a href="#l93.2525"></a><span id="l93.2525">         // XEP-0030: Service Discovery.</span>
<a href="#l93.2526"></a><span id="l93.2526">         let children = [];</span>
<a href="#l93.2527"></a><span id="l93.2527">         if (aStanza.attributes.node == Stanza.NS.muc_rooms) {</span>
<a href="#l93.2528"></a><span id="l93.2528">           // XEP-0045 (6.7): Room query.</span>
<a href="#l93.2529"></a><span id="l93.2529">           // TODO: Currently, we return an empty &lt;query/&gt; element, but we</span>
<a href="#l93.2530"></a><span id="l93.2530">           // should return non-private rooms.</span>
<a href="#l93.2531"></a><span id="l93.2531" class="difflineminus">-        }</span>
<a href="#l93.2532"></a><span id="l93.2532" class="difflineminus">-        else {</span>
<a href="#l93.2533"></a><span id="l93.2533" class="difflineplus">+        } else {</span>
<a href="#l93.2534"></a><span id="l93.2534">           children = SupportedFeatures.map(feature =&gt;</span>
<a href="#l93.2535"></a><span id="l93.2535" class="difflineminus">-            Stanza.node(&quot;feature&quot;, null, {var: feature})</span>
<a href="#l93.2536"></a><span id="l93.2536" class="difflineplus">+            Stanza.node(&quot;feature&quot;, null, { var: feature })</span>
<a href="#l93.2537"></a><span id="l93.2537">           );</span>
<a href="#l93.2538"></a><span id="l93.2538" class="difflineminus">-          children.unshift(Stanza.node(&quot;identity&quot;, null,</span>
<a href="#l93.2539"></a><span id="l93.2539" class="difflineminus">-                                       {category: &quot;client&quot;, type: &quot;pc&quot;,</span>
<a href="#l93.2540"></a><span id="l93.2540" class="difflineminus">-                                        name: Services.appinfo.name}));</span>
<a href="#l93.2541"></a><span id="l93.2541" class="difflineplus">+          children.unshift(</span>
<a href="#l93.2542"></a><span id="l93.2542" class="difflineplus">+            Stanza.node(&quot;identity&quot;, null, {</span>
<a href="#l93.2543"></a><span id="l93.2543" class="difflineplus">+              category: &quot;client&quot;,</span>
<a href="#l93.2544"></a><span id="l93.2544" class="difflineplus">+              type: &quot;pc&quot;,</span>
<a href="#l93.2545"></a><span id="l93.2545" class="difflineplus">+              name: Services.appinfo.name,</span>
<a href="#l93.2546"></a><span id="l93.2546" class="difflineplus">+            })</span>
<a href="#l93.2547"></a><span id="l93.2547" class="difflineplus">+          );</span>
<a href="#l93.2548"></a><span id="l93.2548">         }</span>
<a href="#l93.2549"></a><span id="l93.2549" class="difflineminus">-        let discoveryQuery =</span>
<a href="#l93.2550"></a><span id="l93.2550" class="difflineminus">-          Stanza.node(&quot;query&quot;, Stanza.NS.disco_info, null, children);</span>
<a href="#l93.2551"></a><span id="l93.2551" class="difflineplus">+        let discoveryQuery = Stanza.node(</span>
<a href="#l93.2552"></a><span id="l93.2552" class="difflineplus">+          &quot;query&quot;,</span>
<a href="#l93.2553"></a><span id="l93.2553" class="difflineplus">+          Stanza.NS.disco_info,</span>
<a href="#l93.2554"></a><span id="l93.2554" class="difflineplus">+          null,</span>
<a href="#l93.2555"></a><span id="l93.2555" class="difflineplus">+          children</span>
<a href="#l93.2556"></a><span id="l93.2556" class="difflineplus">+        );</span>
<a href="#l93.2557"></a><span id="l93.2557">         this.sendStanza(Stanza.iq(&quot;result&quot;, id, from, discoveryQuery));</span>
<a href="#l93.2558"></a><span id="l93.2558">         return;</span>
<a href="#l93.2559"></a><span id="l93.2559">       }</span>
<a href="#l93.2560"></a><span id="l93.2560">     }</span>
<a href="#l93.2561"></a><span id="l93.2561">     this.WARN(`Unhandled IQ ${type} stanza.`);</span>
<a href="#l93.2562"></a><span id="l93.2562">   },</span>
<a href="#l93.2563"></a><span id="l93.2563"> </span>
<a href="#l93.2564"></a><span id="l93.2564">   /* Called when a presence stanza is received */</span>
<a href="#l93.2565"></a><span id="l93.2565">   onPresenceStanza(aStanza) {</span>
<a href="#l93.2566"></a><span id="l93.2566">     let from = aStanza.attributes.from;</span>
<a href="#l93.2567"></a><span id="l93.2567">     this.DEBUG(&quot;Received presence stanza for &quot; + from);</span>
<a href="#l93.2568"></a><span id="l93.2568"> </span>
<a href="#l93.2569"></a><span id="l93.2569">     let jid = this.normalize(from);</span>
<a href="#l93.2570"></a><span id="l93.2570">     let type = aStanza.attributes.type;</span>
<a href="#l93.2571"></a><span id="l93.2571">     if (type == &quot;subscribe&quot;) {</span>
<a href="#l93.2572"></a><span id="l93.2572" class="difflineminus">-      this.addBuddyRequest(jid,</span>
<a href="#l93.2573"></a><span id="l93.2573" class="difflineminus">-                           this.replyToBuddyRequest.bind(this, &quot;subscribed&quot;),</span>
<a href="#l93.2574"></a><span id="l93.2574" class="difflineminus">-                           this.replyToBuddyRequest.bind(this, &quot;unsubscribed&quot;));</span>
<a href="#l93.2575"></a><span id="l93.2575" class="difflineminus">-    }</span>
<a href="#l93.2576"></a><span id="l93.2576" class="difflineminus">-    else if (type == &quot;unsubscribe&quot; || type == &quot;unsubscribed&quot; ||</span>
<a href="#l93.2577"></a><span id="l93.2577" class="difflineminus">-             type == &quot;subscribed&quot;) {</span>
<a href="#l93.2578"></a><span id="l93.2578" class="difflineplus">+      this.addBuddyRequest(</span>
<a href="#l93.2579"></a><span id="l93.2579" class="difflineplus">+        jid,</span>
<a href="#l93.2580"></a><span id="l93.2580" class="difflineplus">+        this.replyToBuddyRequest.bind(this, &quot;subscribed&quot;),</span>
<a href="#l93.2581"></a><span id="l93.2581" class="difflineplus">+        this.replyToBuddyRequest.bind(this, &quot;unsubscribed&quot;)</span>
<a href="#l93.2582"></a><span id="l93.2582" class="difflineplus">+      );</span>
<a href="#l93.2583"></a><span id="l93.2583" class="difflineplus">+    } else if (</span>
<a href="#l93.2584"></a><span id="l93.2584" class="difflineplus">+      type == &quot;unsubscribe&quot; ||</span>
<a href="#l93.2585"></a><span id="l93.2585" class="difflineplus">+      type == &quot;unsubscribed&quot; ||</span>
<a href="#l93.2586"></a><span id="l93.2586" class="difflineplus">+      type == &quot;subscribed&quot;</span>
<a href="#l93.2587"></a><span id="l93.2587" class="difflineplus">+    ) {</span>
<a href="#l93.2588"></a><span id="l93.2588">       // Nothing useful to do for these presence stanzas, as we will also</span>
<a href="#l93.2589"></a><span id="l93.2589">       // receive a roster push containing more or less the same information</span>
<a href="#l93.2590"></a><span id="l93.2590" class="difflineminus">-</span>
<a href="#l93.2591"></a><span id="l93.2591" class="difflineminus">-    }</span>
<a href="#l93.2592"></a><span id="l93.2592" class="difflineminus">-    else if (this._buddies.has(jid))</span>
<a href="#l93.2593"></a><span id="l93.2593" class="difflineplus">+    } else if (this._buddies.has(jid)) {</span>
<a href="#l93.2594"></a><span id="l93.2594">       this._buddies.get(jid).onPresenceStanza(aStanza);</span>
<a href="#l93.2595"></a><span id="l93.2595" class="difflineminus">-    else if (this._mucs.has(jid))</span>
<a href="#l93.2596"></a><span id="l93.2596" class="difflineplus">+    } else if (this._mucs.has(jid)) {</span>
<a href="#l93.2597"></a><span id="l93.2597">       this._mucs.get(jid).onPresenceStanza(aStanza);</span>
<a href="#l93.2598"></a><span id="l93.2598" class="difflineminus">-    else if (jid != this.normalize(this._connection._jid.jid))</span>
<a href="#l93.2599"></a><span id="l93.2599" class="difflineplus">+    } else if (jid != this.normalize(this._connection._jid.jid)) {</span>
<a href="#l93.2600"></a><span id="l93.2600">       this.WARN(&quot;received presence stanza for unknown buddy &quot; + from);</span>
<a href="#l93.2601"></a><span id="l93.2601" class="difflineminus">-    else if (jid == this._jid.node + &quot;@&quot; + this._jid.domain &amp;&amp;</span>
<a href="#l93.2602"></a><span id="l93.2602" class="difflineminus">-             this._connection._resource != this._parseJID(from).resource) {</span>
<a href="#l93.2603"></a><span id="l93.2603" class="difflineplus">+    } else if (</span>
<a href="#l93.2604"></a><span id="l93.2604" class="difflineplus">+      jid == this._jid.node + &quot;@&quot; + this._jid.domain &amp;&amp;</span>
<a href="#l93.2605"></a><span id="l93.2605" class="difflineplus">+      this._connection._resource != this._parseJID(from).resource</span>
<a href="#l93.2606"></a><span id="l93.2606" class="difflineplus">+    ) {</span>
<a href="#l93.2607"></a><span id="l93.2607">       // Ignore presence stanzas for another resource.</span>
<a href="#l93.2608"></a><span id="l93.2608" class="difflineminus">-</span>
<a href="#l93.2609"></a><span id="l93.2609" class="difflineplus">+    } else {</span>
<a href="#l93.2610"></a><span id="l93.2610" class="difflineplus">+      this.WARN(&quot;Unhandled presence stanza.&quot;);</span>
<a href="#l93.2611"></a><span id="l93.2611">     }</span>
<a href="#l93.2612"></a><span id="l93.2612" class="difflineminus">-    else</span>
<a href="#l93.2613"></a><span id="l93.2613" class="difflineminus">-      this.WARN(&quot;Unhandled presence stanza.&quot;);</span>
<a href="#l93.2614"></a><span id="l93.2614">   },</span>
<a href="#l93.2615"></a><span id="l93.2615"> </span>
<a href="#l93.2616"></a><span id="l93.2616">   // XEP-0030: Discovering services and their features that are supported by</span>
<a href="#l93.2617"></a><span id="l93.2617">   // the server.</span>
<a href="#l93.2618"></a><span id="l93.2618">   onServiceDiscovery(aStanza) {</span>
<a href="#l93.2619"></a><span id="l93.2619">     let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l93.2620"></a><span id="l93.2620" class="difflineminus">-    if (aStanza.attributes.type != &quot;result&quot; || !query ||</span>
<a href="#l93.2621"></a><span id="l93.2621" class="difflineminus">-        query.uri != Stanza.NS.disco_items) {</span>
<a href="#l93.2622"></a><span id="l93.2622" class="difflineplus">+    if (</span>
<a href="#l93.2623"></a><span id="l93.2623" class="difflineplus">+      aStanza.attributes.type != &quot;result&quot; ||</span>
<a href="#l93.2624"></a><span id="l93.2624" class="difflineplus">+      !query ||</span>
<a href="#l93.2625"></a><span id="l93.2625" class="difflineplus">+      query.uri != Stanza.NS.disco_items</span>
<a href="#l93.2626"></a><span id="l93.2626" class="difflineplus">+    ) {</span>
<a href="#l93.2627"></a><span id="l93.2627">       this.LOG(&quot;Could not get services for this server: &quot; + this._jid.domain);</span>
<a href="#l93.2628"></a><span id="l93.2628">       return true;</span>
<a href="#l93.2629"></a><span id="l93.2629">     }</span>
<a href="#l93.2630"></a><span id="l93.2630"> </span>
<a href="#l93.2631"></a><span id="l93.2631">     // Discovering the Features that are Supported by each service.</span>
<a href="#l93.2632"></a><span id="l93.2632">     query.getElements([&quot;item&quot;]).forEach(item =&gt; {</span>
<a href="#l93.2633"></a><span id="l93.2633">       let jid = item.attributes.jid;</span>
<a href="#l93.2634"></a><span id="l93.2634" class="difflineminus">-      if (!jid)</span>
<a href="#l93.2635"></a><span id="l93.2635" class="difflineplus">+      if (!jid) {</span>
<a href="#l93.2636"></a><span id="l93.2636">         return;</span>
<a href="#l93.2637"></a><span id="l93.2637" class="difflineminus">-      let iq = Stanza.iq(&quot;get&quot;, null, jid,</span>
<a href="#l93.2638"></a><span id="l93.2638" class="difflineminus">-                         Stanza.node(&quot;query&quot;, Stanza.NS.disco_info));</span>
<a href="#l93.2639"></a><span id="l93.2639" class="difflineplus">+      }</span>
<a href="#l93.2640"></a><span id="l93.2640" class="difflineplus">+      let iq = Stanza.iq(</span>
<a href="#l93.2641"></a><span id="l93.2641" class="difflineplus">+        &quot;get&quot;,</span>
<a href="#l93.2642"></a><span id="l93.2642" class="difflineplus">+        null,</span>
<a href="#l93.2643"></a><span id="l93.2643" class="difflineplus">+        jid,</span>
<a href="#l93.2644"></a><span id="l93.2644" class="difflineplus">+        Stanza.node(&quot;query&quot;, Stanza.NS.disco_info)</span>
<a href="#l93.2645"></a><span id="l93.2645" class="difflineplus">+      );</span>
<a href="#l93.2646"></a><span id="l93.2646">       this.sendStanza(iq, receivedStanza =&gt; {</span>
<a href="#l93.2647"></a><span id="l93.2647">         let query = receivedStanza.getElement([&quot;query&quot;]);</span>
<a href="#l93.2648"></a><span id="l93.2648">         let from = receivedStanza.attributes.from;</span>
<a href="#l93.2649"></a><span id="l93.2649" class="difflineminus">-        if (aStanza.attributes.type != &quot;result&quot; || !query ||</span>
<a href="#l93.2650"></a><span id="l93.2650" class="difflineminus">-            query.uri != Stanza.NS.disco_info) {</span>
<a href="#l93.2651"></a><span id="l93.2651" class="difflineplus">+        if (</span>
<a href="#l93.2652"></a><span id="l93.2652" class="difflineplus">+          aStanza.attributes.type != &quot;result&quot; ||</span>
<a href="#l93.2653"></a><span id="l93.2653" class="difflineplus">+          !query ||</span>
<a href="#l93.2654"></a><span id="l93.2654" class="difflineplus">+          query.uri != Stanza.NS.disco_info</span>
<a href="#l93.2655"></a><span id="l93.2655" class="difflineplus">+        ) {</span>
<a href="#l93.2656"></a><span id="l93.2656">           this.LOG(&quot;Could not get features for this service: &quot; + from);</span>
<a href="#l93.2657"></a><span id="l93.2657">           return true;</span>
<a href="#l93.2658"></a><span id="l93.2658">         }</span>
<a href="#l93.2659"></a><span id="l93.2659" class="difflineminus">-        let features = query.getElements([&quot;feature&quot;])</span>
<a href="#l93.2660"></a><span id="l93.2660" class="difflineminus">-                            .map(elt =&gt; elt.attributes.var);</span>
<a href="#l93.2661"></a><span id="l93.2661" class="difflineplus">+        let features = query</span>
<a href="#l93.2662"></a><span id="l93.2662" class="difflineplus">+          .getElements([&quot;feature&quot;])</span>
<a href="#l93.2663"></a><span id="l93.2663" class="difflineplus">+          .map(elt =&gt; elt.attributes.var);</span>
<a href="#l93.2664"></a><span id="l93.2664">         let identity = query.getElement([&quot;identity&quot;]);</span>
<a href="#l93.2665"></a><span id="l93.2665" class="difflineminus">-        if (identity &amp;&amp; identity.attributes.category == &quot;conference&quot; &amp;&amp;</span>
<a href="#l93.2666"></a><span id="l93.2666" class="difflineminus">-            identity.attributes.type == &quot;text&quot; &amp;&amp;</span>
<a href="#l93.2667"></a><span id="l93.2667" class="difflineminus">-            features.includes(Stanza.NS.muc)) {</span>
<a href="#l93.2668"></a><span id="l93.2668" class="difflineplus">+        if (</span>
<a href="#l93.2669"></a><span id="l93.2669" class="difflineplus">+          identity &amp;&amp;</span>
<a href="#l93.2670"></a><span id="l93.2670" class="difflineplus">+          identity.attributes.category == &quot;conference&quot; &amp;&amp;</span>
<a href="#l93.2671"></a><span id="l93.2671" class="difflineplus">+          identity.attributes.type == &quot;text&quot; &amp;&amp;</span>
<a href="#l93.2672"></a><span id="l93.2672" class="difflineplus">+          features.includes(Stanza.NS.muc)</span>
<a href="#l93.2673"></a><span id="l93.2673" class="difflineplus">+        ) {</span>
<a href="#l93.2674"></a><span id="l93.2674">           // XEP-0045 (6.2): this feature is for a MUC Service.</span>
<a href="#l93.2675"></a><span id="l93.2675">           // XEP-0045 (15.2): Service Discovery Category/Type.</span>
<a href="#l93.2676"></a><span id="l93.2676">           this._mucService = from;</span>
<a href="#l93.2677"></a><span id="l93.2677">         }</span>
<a href="#l93.2678"></a><span id="l93.2678">         // TODO: Handle other services that are supported by XMPP through</span>
<a href="#l93.2679"></a><span id="l93.2679">         // their features.</span>
<a href="#l93.2680"></a><span id="l93.2680"> </span>
<a href="#l93.2681"></a><span id="l93.2681">         return true;</span>
<a href="#l93.2682"></a><span id="l93.2682" class="difflineat">@@ -1860,193 +2284,231 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.2683"></a><span id="l93.2683">     });</span>
<a href="#l93.2684"></a><span id="l93.2684">     return true;</span>
<a href="#l93.2685"></a><span id="l93.2685">   },</span>
<a href="#l93.2686"></a><span id="l93.2686"> </span>
<a href="#l93.2687"></a><span id="l93.2687">   // XEP-0030: Discovering Service Information and its features that are</span>
<a href="#l93.2688"></a><span id="l93.2688">   // supported by the server.</span>
<a href="#l93.2689"></a><span id="l93.2689">   onServiceDiscoveryInfo(aStanza) {</span>
<a href="#l93.2690"></a><span id="l93.2690">     let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l93.2691"></a><span id="l93.2691" class="difflineminus">-    if (aStanza.attributes.type != &quot;result&quot; || !query ||</span>
<a href="#l93.2692"></a><span id="l93.2692" class="difflineminus">-        query.uri != Stanza.NS.disco_info) {</span>
<a href="#l93.2693"></a><span id="l93.2693" class="difflineplus">+    if (</span>
<a href="#l93.2694"></a><span id="l93.2694" class="difflineplus">+      aStanza.attributes.type != &quot;result&quot; ||</span>
<a href="#l93.2695"></a><span id="l93.2695" class="difflineplus">+      !query ||</span>
<a href="#l93.2696"></a><span id="l93.2696" class="difflineplus">+      query.uri != Stanza.NS.disco_info</span>
<a href="#l93.2697"></a><span id="l93.2697" class="difflineplus">+    ) {</span>
<a href="#l93.2698"></a><span id="l93.2698">       this.LOG(&quot;Could not get features for this server: &quot; + this._jid.domain);</span>
<a href="#l93.2699"></a><span id="l93.2699">       return true;</span>
<a href="#l93.2700"></a><span id="l93.2700">     }</span>
<a href="#l93.2701"></a><span id="l93.2701"> </span>
<a href="#l93.2702"></a><span id="l93.2702" class="difflineminus">-    let features = query.getElements([&quot;feature&quot;])</span>
<a href="#l93.2703"></a><span id="l93.2703" class="difflineminus">-                        .map(elt =&gt; elt.attributes.var);</span>
<a href="#l93.2704"></a><span id="l93.2704" class="difflineplus">+    let features = query</span>
<a href="#l93.2705"></a><span id="l93.2705" class="difflineplus">+      .getElements([&quot;feature&quot;])</span>
<a href="#l93.2706"></a><span id="l93.2706" class="difflineplus">+      .map(elt =&gt; elt.attributes.var);</span>
<a href="#l93.2707"></a><span id="l93.2707">     if (features.includes(Stanza.NS.carbons)) {</span>
<a href="#l93.2708"></a><span id="l93.2708">       // XEP-0280: Message Carbons.</span>
<a href="#l93.2709"></a><span id="l93.2709">       // Enabling Carbons on server, as it's disabled by default on server.</span>
<a href="#l93.2710"></a><span id="l93.2710">       if (Services.prefs.getBoolPref(&quot;chat.xmpp.messageCarbons&quot;)) {</span>
<a href="#l93.2711"></a><span id="l93.2711" class="difflineminus">-        let iqStanza = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l93.2712"></a><span id="l93.2712" class="difflineminus">-                                 Stanza.node(&quot;enable&quot;, Stanza.NS.carbons));</span>
<a href="#l93.2713"></a><span id="l93.2713" class="difflineplus">+        let iqStanza = Stanza.iq(</span>
<a href="#l93.2714"></a><span id="l93.2714" class="difflineplus">+          &quot;set&quot;,</span>
<a href="#l93.2715"></a><span id="l93.2715" class="difflineplus">+          null,</span>
<a href="#l93.2716"></a><span id="l93.2716" class="difflineplus">+          null,</span>
<a href="#l93.2717"></a><span id="l93.2717" class="difflineplus">+          Stanza.node(&quot;enable&quot;, Stanza.NS.carbons)</span>
<a href="#l93.2718"></a><span id="l93.2718" class="difflineplus">+        );</span>
<a href="#l93.2719"></a><span id="l93.2719">         this.sendStanza(iqStanza, aStanza =&gt; {</span>
<a href="#l93.2720"></a><span id="l93.2720">           let error = this.parseError(aStanza);</span>
<a href="#l93.2721"></a><span id="l93.2721">           if (error) {</span>
<a href="#l93.2722"></a><span id="l93.2722" class="difflineminus">-            this.WARN(&quot;Unable to enable message carbons due to &quot; +</span>
<a href="#l93.2723"></a><span id="l93.2723" class="difflineminus">-                      error.condition + &quot; error.&quot;);</span>
<a href="#l93.2724"></a><span id="l93.2724" class="difflineplus">+            this.WARN(</span>
<a href="#l93.2725"></a><span id="l93.2725" class="difflineplus">+              &quot;Unable to enable message carbons due to &quot; +</span>
<a href="#l93.2726"></a><span id="l93.2726" class="difflineplus">+                error.condition +</span>
<a href="#l93.2727"></a><span id="l93.2727" class="difflineplus">+                &quot; error.&quot;</span>
<a href="#l93.2728"></a><span id="l93.2728" class="difflineplus">+            );</span>
<a href="#l93.2729"></a><span id="l93.2729">             return true;</span>
<a href="#l93.2730"></a><span id="l93.2730">           }</span>
<a href="#l93.2731"></a><span id="l93.2731"> </span>
<a href="#l93.2732"></a><span id="l93.2732">           let type = aStanza.attributes.type;</span>
<a href="#l93.2733"></a><span id="l93.2733">           if (type != &quot;result&quot;) {</span>
<a href="#l93.2734"></a><span id="l93.2734" class="difflineminus">-            this.WARN(&quot;Received unexpected stanza with &quot; + type + &quot; type &quot; +</span>
<a href="#l93.2735"></a><span id="l93.2735" class="difflineminus">-                      &quot;while enabling message carbons.&quot;);</span>
<a href="#l93.2736"></a><span id="l93.2736" class="difflineplus">+            this.WARN(</span>
<a href="#l93.2737"></a><span id="l93.2737" class="difflineplus">+              &quot;Received unexpected stanza with &quot; +</span>
<a href="#l93.2738"></a><span id="l93.2738" class="difflineplus">+                type +</span>
<a href="#l93.2739"></a><span id="l93.2739" class="difflineplus">+                &quot; type &quot; +</span>
<a href="#l93.2740"></a><span id="l93.2740" class="difflineplus">+                &quot;while enabling message carbons.&quot;</span>
<a href="#l93.2741"></a><span id="l93.2741" class="difflineplus">+            );</span>
<a href="#l93.2742"></a><span id="l93.2742">             return true;</span>
<a href="#l93.2743"></a><span id="l93.2743">           }</span>
<a href="#l93.2744"></a><span id="l93.2744"> </span>
<a href="#l93.2745"></a><span id="l93.2745">           this.LOG(&quot;Message carbons enabled.&quot;);</span>
<a href="#l93.2746"></a><span id="l93.2746">           this._isCarbonsEnabled = true;</span>
<a href="#l93.2747"></a><span id="l93.2747">           return true;</span>
<a href="#l93.2748"></a><span id="l93.2748">         });</span>
<a href="#l93.2749"></a><span id="l93.2749">       }</span>
<a href="#l93.2750"></a><span id="l93.2750">     }</span>
<a href="#l93.2751"></a><span id="l93.2751">     // TODO: Handle other features that are supported by the server.</span>
<a href="#l93.2752"></a><span id="l93.2752">     return true;</span>
<a href="#l93.2753"></a><span id="l93.2753">   },</span>
<a href="#l93.2754"></a><span id="l93.2754"> </span>
<a href="#l93.2755"></a><span id="l93.2755">   requestRoomInfo(aCallback) {</span>
<a href="#l93.2756"></a><span id="l93.2756" class="difflineminus">-    if (this._roomInfoCallbacks.has(aCallback))</span>
<a href="#l93.2757"></a><span id="l93.2757" class="difflineplus">+    if (this._roomInfoCallbacks.has(aCallback)) {</span>
<a href="#l93.2758"></a><span id="l93.2758">       return;</span>
<a href="#l93.2759"></a><span id="l93.2759" class="difflineplus">+    }</span>
<a href="#l93.2760"></a><span id="l93.2760"> </span>
<a href="#l93.2761"></a><span id="l93.2761">     if (this.isRoomInfoStale &amp;&amp; !this._pendingList) {</span>
<a href="#l93.2762"></a><span id="l93.2762">       this._roomList = new Map();</span>
<a href="#l93.2763"></a><span id="l93.2763">       this._lastListTime = Date.now();</span>
<a href="#l93.2764"></a><span id="l93.2764">       this._roomInfoCallback = aCallback;</span>
<a href="#l93.2765"></a><span id="l93.2765">       this._pendingList = true;</span>
<a href="#l93.2766"></a><span id="l93.2766"> </span>
<a href="#l93.2767"></a><span id="l93.2767">       // XEP-0045 (6.3): Discovering Rooms.</span>
<a href="#l93.2768"></a><span id="l93.2768" class="difflineminus">-      let iq = Stanza.iq(&quot;get&quot;, null, this._mucService,</span>
<a href="#l93.2769"></a><span id="l93.2769" class="difflineminus">-                         Stanza.node(&quot;query&quot;, Stanza.NS.disco_items));</span>
<a href="#l93.2770"></a><span id="l93.2770" class="difflineplus">+      let iq = Stanza.iq(</span>
<a href="#l93.2771"></a><span id="l93.2771" class="difflineplus">+        &quot;get&quot;,</span>
<a href="#l93.2772"></a><span id="l93.2772" class="difflineplus">+        null,</span>
<a href="#l93.2773"></a><span id="l93.2773" class="difflineplus">+        this._mucService,</span>
<a href="#l93.2774"></a><span id="l93.2774" class="difflineplus">+        Stanza.node(&quot;query&quot;, Stanza.NS.disco_items)</span>
<a href="#l93.2775"></a><span id="l93.2775" class="difflineplus">+      );</span>
<a href="#l93.2776"></a><span id="l93.2776">       this.sendStanza(iq, this.onRoomDiscovery, this);</span>
<a href="#l93.2777"></a><span id="l93.2777" class="difflineminus">-    }</span>
<a href="#l93.2778"></a><span id="l93.2778" class="difflineminus">-    else {</span>
<a href="#l93.2779"></a><span id="l93.2779" class="difflineplus">+    } else {</span>
<a href="#l93.2780"></a><span id="l93.2780">       let rooms = [...this._roomList.keys()];</span>
<a href="#l93.2781"></a><span id="l93.2781">       aCallback.onRoomInfoAvailable(rooms, !this._pendingList, rooms.length);</span>
<a href="#l93.2782"></a><span id="l93.2782">     }</span>
<a href="#l93.2783"></a><span id="l93.2783"> </span>
<a href="#l93.2784"></a><span id="l93.2784" class="difflineminus">-    if (this._pendingList)</span>
<a href="#l93.2785"></a><span id="l93.2785" class="difflineplus">+    if (this._pendingList) {</span>
<a href="#l93.2786"></a><span id="l93.2786">       this._roomInfoCallbacks.add(aCallback);</span>
<a href="#l93.2787"></a><span id="l93.2787" class="difflineplus">+    }</span>
<a href="#l93.2788"></a><span id="l93.2788">   },</span>
<a href="#l93.2789"></a><span id="l93.2789"> </span>
<a href="#l93.2790"></a><span id="l93.2790">   onRoomDiscovery(aStanza) {</span>
<a href="#l93.2791"></a><span id="l93.2791">     let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l93.2792"></a><span id="l93.2792">     if (!query || query.uri != Stanza.NS.disco_items) {</span>
<a href="#l93.2793"></a><span id="l93.2793">       this.LOG(&quot;Could not get rooms for this server: &quot; + this._jid.domain);</span>
<a href="#l93.2794"></a><span id="l93.2794">       return;</span>
<a href="#l93.2795"></a><span id="l93.2795">     }</span>
<a href="#l93.2796"></a><span id="l93.2796"> </span>
<a href="#l93.2797"></a><span id="l93.2797">     // XEP-0059: Result Set Management.</span>
<a href="#l93.2798"></a><span id="l93.2798">     let set = query.getElement([&quot;set&quot;]);</span>
<a href="#l93.2799"></a><span id="l93.2799">     let last = set ? set.getElement([&quot;last&quot;]) : null;</span>
<a href="#l93.2800"></a><span id="l93.2800">     if (last) {</span>
<a href="#l93.2801"></a><span id="l93.2801" class="difflineminus">-      let iq = Stanza.iq(&quot;get&quot;, null, this._mucService,</span>
<a href="#l93.2802"></a><span id="l93.2802" class="difflineminus">-                         Stanza.node(&quot;query&quot;, Stanza.NS.disco_items));</span>
<a href="#l93.2803"></a><span id="l93.2803" class="difflineplus">+      let iq = Stanza.iq(</span>
<a href="#l93.2804"></a><span id="l93.2804" class="difflineplus">+        &quot;get&quot;,</span>
<a href="#l93.2805"></a><span id="l93.2805" class="difflineplus">+        null,</span>
<a href="#l93.2806"></a><span id="l93.2806" class="difflineplus">+        this._mucService,</span>
<a href="#l93.2807"></a><span id="l93.2807" class="difflineplus">+        Stanza.node(&quot;query&quot;, Stanza.NS.disco_items)</span>
<a href="#l93.2808"></a><span id="l93.2808" class="difflineplus">+      );</span>
<a href="#l93.2809"></a><span id="l93.2809">       this.sendStanza(iq, this.onRoomDiscovery, this);</span>
<a href="#l93.2810"></a><span id="l93.2810" class="difflineplus">+    } else {</span>
<a href="#l93.2811"></a><span id="l93.2811" class="difflineplus">+      this._pendingList = false;</span>
<a href="#l93.2812"></a><span id="l93.2812">     }</span>
<a href="#l93.2813"></a><span id="l93.2813" class="difflineminus">-    else</span>
<a href="#l93.2814"></a><span id="l93.2814" class="difflineminus">-      this._pendingList = false;</span>
<a href="#l93.2815"></a><span id="l93.2815"> </span>
<a href="#l93.2816"></a><span id="l93.2816">     let rooms = [];</span>
<a href="#l93.2817"></a><span id="l93.2817">     query.getElements([&quot;item&quot;]).forEach(item =&gt; {</span>
<a href="#l93.2818"></a><span id="l93.2818">       let jid = this._parseJID(item.attributes.jid);</span>
<a href="#l93.2819"></a><span id="l93.2819" class="difflineminus">-      if (!jid)</span>
<a href="#l93.2820"></a><span id="l93.2820" class="difflineplus">+      if (!jid) {</span>
<a href="#l93.2821"></a><span id="l93.2821">         return;</span>
<a href="#l93.2822"></a><span id="l93.2822" class="difflineplus">+      }</span>
<a href="#l93.2823"></a><span id="l93.2823"> </span>
<a href="#l93.2824"></a><span id="l93.2824">       let name = item.attributes.name;</span>
<a href="#l93.2825"></a><span id="l93.2825" class="difflineminus">-      if (!name)</span>
<a href="#l93.2826"></a><span id="l93.2826" class="difflineplus">+      if (!name) {</span>
<a href="#l93.2827"></a><span id="l93.2827">         name = jid.node ? jid.node : jid.jid;</span>
<a href="#l93.2828"></a><span id="l93.2828" class="difflineplus">+      }</span>
<a href="#l93.2829"></a><span id="l93.2829"> </span>
<a href="#l93.2830"></a><span id="l93.2830">       this._roomList.set(name, jid.jid);</span>
<a href="#l93.2831"></a><span id="l93.2831">       rooms.push(name);</span>
<a href="#l93.2832"></a><span id="l93.2832">     });</span>
<a href="#l93.2833"></a><span id="l93.2833"> </span>
<a href="#l93.2834"></a><span id="l93.2834" class="difflineminus">-    this._roomInfoCallback.onRoomInfoAvailable(rooms, !this._pendingList,</span>
<a href="#l93.2835"></a><span id="l93.2835" class="difflineminus">-                                               rooms.length);</span>
<a href="#l93.2836"></a><span id="l93.2836" class="difflineplus">+    this._roomInfoCallback.onRoomInfoAvailable(</span>
<a href="#l93.2837"></a><span id="l93.2837" class="difflineplus">+      rooms,</span>
<a href="#l93.2838"></a><span id="l93.2838" class="difflineplus">+      !this._pendingList,</span>
<a href="#l93.2839"></a><span id="l93.2839" class="difflineplus">+      rooms.length</span>
<a href="#l93.2840"></a><span id="l93.2840" class="difflineplus">+    );</span>
<a href="#l93.2841"></a><span id="l93.2841">   },</span>
<a href="#l93.2842"></a><span id="l93.2842"> </span>
<a href="#l93.2843"></a><span id="l93.2843">   getRoomInfo(aName) {</span>
<a href="#l93.2844"></a><span id="l93.2844">     return new XMPPRoomInfo(aName, this);</span>
<a href="#l93.2845"></a><span id="l93.2845">   },</span>
<a href="#l93.2846"></a><span id="l93.2846"> </span>
<a href="#l93.2847"></a><span id="l93.2847">   // Returns null if not an invitation stanza, and an object</span>
<a href="#l93.2848"></a><span id="l93.2848">   // describing the invitation otherwise.</span>
<a href="#l93.2849"></a><span id="l93.2849">   parseInvitation(aStanza) {</span>
<a href="#l93.2850"></a><span id="l93.2850" class="difflineminus">-      let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l93.2851"></a><span id="l93.2851" class="difflineminus">-      if (!x)</span>
<a href="#l93.2852"></a><span id="l93.2852" class="difflineplus">+    let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l93.2853"></a><span id="l93.2853" class="difflineplus">+    if (!x) {</span>
<a href="#l93.2854"></a><span id="l93.2854" class="difflineplus">+      return null;</span>
<a href="#l93.2855"></a><span id="l93.2855" class="difflineplus">+    }</span>
<a href="#l93.2856"></a><span id="l93.2856" class="difflineplus">+    let retVal = {};</span>
<a href="#l93.2857"></a><span id="l93.2857" class="difflineplus">+</span>
<a href="#l93.2858"></a><span id="l93.2858" class="difflineplus">+    // XEP-0045. Direct Invitation (7.8.1)</span>
<a href="#l93.2859"></a><span id="l93.2859" class="difflineplus">+    // Described in XEP-0249.</span>
<a href="#l93.2860"></a><span id="l93.2860" class="difflineplus">+    // jid (chatroom) is required.</span>
<a href="#l93.2861"></a><span id="l93.2861" class="difflineplus">+    // Password, reason, continue and thread are optional.</span>
<a href="#l93.2862"></a><span id="l93.2862" class="difflineplus">+    if (x.uri == Stanza.NS.conference) {</span>
<a href="#l93.2863"></a><span id="l93.2863" class="difflineplus">+      if (!x.attributes.jid) {</span>
<a href="#l93.2864"></a><span id="l93.2864" class="difflineplus">+        this.WARN(&quot;Received an invitation with missing MUC jid.&quot;);</span>
<a href="#l93.2865"></a><span id="l93.2865">         return null;</span>
<a href="#l93.2866"></a><span id="l93.2866" class="difflineminus">-      let retVal = {};</span>
<a href="#l93.2867"></a><span id="l93.2867" class="difflineminus">-</span>
<a href="#l93.2868"></a><span id="l93.2868" class="difflineminus">-      // XEP-0045. Direct Invitation (7.8.1)</span>
<a href="#l93.2869"></a><span id="l93.2869" class="difflineminus">-      // Described in XEP-0249.</span>
<a href="#l93.2870"></a><span id="l93.2870" class="difflineminus">-      // jid (chatroom) is required.</span>
<a href="#l93.2871"></a><span id="l93.2871" class="difflineminus">-      // Password, reason, continue and thread are optional.</span>
<a href="#l93.2872"></a><span id="l93.2872" class="difflineminus">-      if (x.uri == Stanza.NS.conference) {</span>
<a href="#l93.2873"></a><span id="l93.2873" class="difflineminus">-        if (!x.attributes.jid) {</span>
<a href="#l93.2874"></a><span id="l93.2874" class="difflineminus">-          this.WARN(&quot;Received an invitation with missing MUC jid.&quot;);</span>
<a href="#l93.2875"></a><span id="l93.2875" class="difflineminus">-          return null;</span>
<a href="#l93.2876"></a><span id="l93.2876" class="difflineminus">-        }</span>
<a href="#l93.2877"></a><span id="l93.2877" class="difflineminus">-        retVal.mucJid = this.normalize(x.attributes.jid);</span>
<a href="#l93.2878"></a><span id="l93.2878" class="difflineminus">-        retVal.from = this.normalize(aStanza.attributes.from);</span>
<a href="#l93.2879"></a><span id="l93.2879" class="difflineminus">-        retVal.password = x.attributes.password;</span>
<a href="#l93.2880"></a><span id="l93.2880" class="difflineminus">-        retVal.reason = x.attributes.reason;</span>
<a href="#l93.2881"></a><span id="l93.2881" class="difflineminus">-        retVal.continue = x.attributes.continue;</span>
<a href="#l93.2882"></a><span id="l93.2882" class="difflineminus">-        retVal.thread = x.attributes.thread;</span>
<a href="#l93.2883"></a><span id="l93.2883" class="difflineminus">-        return retVal;</span>
<a href="#l93.2884"></a><span id="l93.2884">       }</span>
<a href="#l93.2885"></a><span id="l93.2885" class="difflineminus">-</span>
<a href="#l93.2886"></a><span id="l93.2886" class="difflineminus">-      // XEP-0045. Mediated Invitation (7.8.2)</span>
<a href="#l93.2887"></a><span id="l93.2887" class="difflineminus">-      // Sent by the chatroom on behalf of someone in the chatroom.</span>
<a href="#l93.2888"></a><span id="l93.2888" class="difflineminus">-      // jid (chatroom) and from (inviter) are required.</span>
<a href="#l93.2889"></a><span id="l93.2889" class="difflineminus">-      // password and reason are optional.</span>
<a href="#l93.2890"></a><span id="l93.2890" class="difflineminus">-      if (x.uri == Stanza.NS.muc_user) {</span>
<a href="#l93.2891"></a><span id="l93.2891" class="difflineminus">-        let invite = x.getElement([&quot;invite&quot;]);</span>
<a href="#l93.2892"></a><span id="l93.2892" class="difflineminus">-        if (!invite || !invite.attributes.from) {</span>
<a href="#l93.2893"></a><span id="l93.2893" class="difflineminus">-          this.WARN(&quot;Received an invitation with missing MUC invite or from.&quot;);</span>
<a href="#l93.2894"></a><span id="l93.2894" class="difflineminus">-          return null;</span>
<a href="#l93.2895"></a><span id="l93.2895" class="difflineminus">-        }</span>
<a href="#l93.2896"></a><span id="l93.2896" class="difflineminus">-        retVal.mucJid = this.normalize(aStanza.attributes.from);</span>
<a href="#l93.2897"></a><span id="l93.2897" class="difflineminus">-        retVal.from = this.normalize(invite.attributes.from);</span>
<a href="#l93.2898"></a><span id="l93.2898" class="difflineminus">-        let continueElement = invite.getElement([&quot;continue&quot;]);</span>
<a href="#l93.2899"></a><span id="l93.2899" class="difflineminus">-        retVal.continue = !!continueElement;</span>
<a href="#l93.2900"></a><span id="l93.2900" class="difflineminus">-        if (continueElement)</span>
<a href="#l93.2901"></a><span id="l93.2901" class="difflineminus">-          retVal.thread = continueElement.attributes.thread;</span>
<a href="#l93.2902"></a><span id="l93.2902" class="difflineminus">-        if (x.getElement([&quot;password&quot;]))</span>
<a href="#l93.2903"></a><span id="l93.2903" class="difflineminus">-          retVal.password = x.getElement([&quot;password&quot;]).innerText;</span>
<a href="#l93.2904"></a><span id="l93.2904" class="difflineminus">-        if (invite.getElement([&quot;reason&quot;]))</span>
<a href="#l93.2905"></a><span id="l93.2905" class="difflineminus">-          retVal.reason = invite.getElement([&quot;reason&quot;]).innerText;</span>
<a href="#l93.2906"></a><span id="l93.2906" class="difflineminus">-        return retVal;</span>
<a href="#l93.2907"></a><span id="l93.2907" class="difflineplus">+      retVal.mucJid = this.normalize(x.attributes.jid);</span>
<a href="#l93.2908"></a><span id="l93.2908" class="difflineplus">+      retVal.from = this.normalize(aStanza.attributes.from);</span>
<a href="#l93.2909"></a><span id="l93.2909" class="difflineplus">+      retVal.password = x.attributes.password;</span>
<a href="#l93.2910"></a><span id="l93.2910" class="difflineplus">+      retVal.reason = x.attributes.reason;</span>
<a href="#l93.2911"></a><span id="l93.2911" class="difflineplus">+      retVal.continue = x.attributes.continue;</span>
<a href="#l93.2912"></a><span id="l93.2912" class="difflineplus">+      retVal.thread = x.attributes.thread;</span>
<a href="#l93.2913"></a><span id="l93.2913" class="difflineplus">+      return retVal;</span>
<a href="#l93.2914"></a><span id="l93.2914" class="difflineplus">+    }</span>
<a href="#l93.2915"></a><span id="l93.2915" class="difflineplus">+</span>
<a href="#l93.2916"></a><span id="l93.2916" class="difflineplus">+    // XEP-0045. Mediated Invitation (7.8.2)</span>
<a href="#l93.2917"></a><span id="l93.2917" class="difflineplus">+    // Sent by the chatroom on behalf of someone in the chatroom.</span>
<a href="#l93.2918"></a><span id="l93.2918" class="difflineplus">+    // jid (chatroom) and from (inviter) are required.</span>
<a href="#l93.2919"></a><span id="l93.2919" class="difflineplus">+    // password and reason are optional.</span>
<a href="#l93.2920"></a><span id="l93.2920" class="difflineplus">+    if (x.uri == Stanza.NS.muc_user) {</span>
<a href="#l93.2921"></a><span id="l93.2921" class="difflineplus">+      let invite = x.getElement([&quot;invite&quot;]);</span>
<a href="#l93.2922"></a><span id="l93.2922" class="difflineplus">+      if (!invite || !invite.attributes.from) {</span>
<a href="#l93.2923"></a><span id="l93.2923" class="difflineplus">+        this.WARN(&quot;Received an invitation with missing MUC invite or from.&quot;);</span>
<a href="#l93.2924"></a><span id="l93.2924" class="difflineplus">+        return null;</span>
<a href="#l93.2925"></a><span id="l93.2925">       }</span>
<a href="#l93.2926"></a><span id="l93.2926" class="difflineminus">-</span>
<a href="#l93.2927"></a><span id="l93.2927" class="difflineminus">-      return null;</span>
<a href="#l93.2928"></a><span id="l93.2928" class="difflineplus">+      retVal.mucJid = this.normalize(aStanza.attributes.from);</span>
<a href="#l93.2929"></a><span id="l93.2929" class="difflineplus">+      retVal.from = this.normalize(invite.attributes.from);</span>
<a href="#l93.2930"></a><span id="l93.2930" class="difflineplus">+      let continueElement = invite.getElement([&quot;continue&quot;]);</span>
<a href="#l93.2931"></a><span id="l93.2931" class="difflineplus">+      retVal.continue = !!continueElement;</span>
<a href="#l93.2932"></a><span id="l93.2932" class="difflineplus">+      if (continueElement) {</span>
<a href="#l93.2933"></a><span id="l93.2933" class="difflineplus">+        retVal.thread = continueElement.attributes.thread;</span>
<a href="#l93.2934"></a><span id="l93.2934" class="difflineplus">+      }</span>
<a href="#l93.2935"></a><span id="l93.2935" class="difflineplus">+      if (x.getElement([&quot;password&quot;])) {</span>
<a href="#l93.2936"></a><span id="l93.2936" class="difflineplus">+        retVal.password = x.getElement([&quot;password&quot;]).innerText;</span>
<a href="#l93.2937"></a><span id="l93.2937" class="difflineplus">+      }</span>
<a href="#l93.2938"></a><span id="l93.2938" class="difflineplus">+      if (invite.getElement([&quot;reason&quot;])) {</span>
<a href="#l93.2939"></a><span id="l93.2939" class="difflineplus">+        retVal.reason = invite.getElement([&quot;reason&quot;]).innerText;</span>
<a href="#l93.2940"></a><span id="l93.2940" class="difflineplus">+      }</span>
<a href="#l93.2941"></a><span id="l93.2941" class="difflineplus">+      return retVal;</span>
<a href="#l93.2942"></a><span id="l93.2942" class="difflineplus">+    }</span>
<a href="#l93.2943"></a><span id="l93.2943" class="difflineplus">+</span>
<a href="#l93.2944"></a><span id="l93.2944" class="difflineplus">+    return null;</span>
<a href="#l93.2945"></a><span id="l93.2945">   },</span>
<a href="#l93.2946"></a><span id="l93.2946"> </span>
<a href="#l93.2947"></a><span id="l93.2947">   /* Called when a message stanza is received */</span>
<a href="#l93.2948"></a><span id="l93.2948">   onMessageStanza(aStanza) {</span>
<a href="#l93.2949"></a><span id="l93.2949">     // XEP-0280: Message Carbons.</span>
<a href="#l93.2950"></a><span id="l93.2950">     // Sending and Receiving Messages.</span>
<a href="#l93.2951"></a><span id="l93.2951">     // Indicates that the forwarded message was sent or received.</span>
<a href="#l93.2952"></a><span id="l93.2952">     let isSent = false;</span>
<a href="#l93.2953"></a><span id="l93.2953">     let carbonStanza =</span>
<a href="#l93.2954"></a><span id="l93.2954">       aStanza.getElement([&quot;sent&quot;]) || aStanza.getElement([&quot;received&quot;]);</span>
<a href="#l93.2955"></a><span id="l93.2955">     if (carbonStanza) {</span>
<a href="#l93.2956"></a><span id="l93.2956">       if (carbonStanza.uri != Stanza.NS.carbons) {</span>
<a href="#l93.2957"></a><span id="l93.2957" class="difflineminus">-        this.WARN(&quot;Received a forwarded message which does not '&quot; +</span>
<a href="#l93.2958"></a><span id="l93.2958" class="difflineminus">-                  Stanza.NS.carbons + &quot;' namespace.&quot;);</span>
<a href="#l93.2959"></a><span id="l93.2959" class="difflineplus">+        this.WARN(</span>
<a href="#l93.2960"></a><span id="l93.2960" class="difflineplus">+          &quot;Received a forwarded message which does not '&quot; +</span>
<a href="#l93.2961"></a><span id="l93.2961" class="difflineplus">+            Stanza.NS.carbons +</span>
<a href="#l93.2962"></a><span id="l93.2962" class="difflineplus">+            &quot;' namespace.&quot;</span>
<a href="#l93.2963"></a><span id="l93.2963" class="difflineplus">+        );</span>
<a href="#l93.2964"></a><span id="l93.2964">         return;</span>
<a href="#l93.2965"></a><span id="l93.2965">       }</span>
<a href="#l93.2966"></a><span id="l93.2966"> </span>
<a href="#l93.2967"></a><span id="l93.2967">       isSent = carbonStanza.localName == &quot;sent&quot;;</span>
<a href="#l93.2968"></a><span id="l93.2968">       carbonStanza = carbonStanza.getElement([&quot;forwarded&quot;, &quot;message&quot;]);</span>
<a href="#l93.2969"></a><span id="l93.2969" class="difflineminus">-      if (this._isCarbonsEnabled)</span>
<a href="#l93.2970"></a><span id="l93.2970" class="difflineplus">+      if (this._isCarbonsEnabled) {</span>
<a href="#l93.2971"></a><span id="l93.2971">         aStanza = carbonStanza;</span>
<a href="#l93.2972"></a><span id="l93.2972" class="difflineminus">-      else {</span>
<a href="#l93.2973"></a><span id="l93.2973" class="difflineminus">-        this.WARN(&quot;Received an unexpected forwarded message while message &quot; +</span>
<a href="#l93.2974"></a><span id="l93.2974" class="difflineminus">-                  &quot;carbons are not enabled.&quot;);</span>
<a href="#l93.2975"></a><span id="l93.2975" class="difflineplus">+      } else {</span>
<a href="#l93.2976"></a><span id="l93.2976" class="difflineplus">+        this.WARN(</span>
<a href="#l93.2977"></a><span id="l93.2977" class="difflineplus">+          &quot;Received an unexpected forwarded message while message &quot; +</span>
<a href="#l93.2978"></a><span id="l93.2978" class="difflineplus">+            &quot;carbons are not enabled.&quot;</span>
<a href="#l93.2979"></a><span id="l93.2979" class="difflineplus">+        );</span>
<a href="#l93.2980"></a><span id="l93.2980">         return;</span>
<a href="#l93.2981"></a><span id="l93.2981">       }</span>
<a href="#l93.2982"></a><span id="l93.2982">     }</span>
<a href="#l93.2983"></a><span id="l93.2983"> </span>
<a href="#l93.2984"></a><span id="l93.2984">     // For forwarded sent messages, we need to use &quot;to&quot; attribute to</span>
<a href="#l93.2985"></a><span id="l93.2985">     // get the right conversation as from in this case is this account.</span>
<a href="#l93.2986"></a><span id="l93.2986">     let convJid = isSent ? aStanza.attributes.to : aStanza.attributes.from;</span>
<a href="#l93.2987"></a><span id="l93.2987"> </span>
<a href="#l93.2988"></a><span id="l93.2988" class="difflineat">@@ -2056,19 +2518,19 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.2989"></a><span id="l93.2989">     let type = aStanza.attributes.type;</span>
<a href="#l93.2990"></a><span id="l93.2990">     let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l93.2991"></a><span id="l93.2991">     let body;</span>
<a href="#l93.2992"></a><span id="l93.2992">     let b = aStanza.getElement([&quot;body&quot;]);</span>
<a href="#l93.2993"></a><span id="l93.2993">     if (b) {</span>
<a href="#l93.2994"></a><span id="l93.2994">       // If there's a &lt;body&gt; child we have more than just typing notifications.</span>
<a href="#l93.2995"></a><span id="l93.2995">       // Prefer HTML (in &lt;html&gt;&lt;body&gt;) and use plain text (&lt;body&gt;) as fallback.</span>
<a href="#l93.2996"></a><span id="l93.2996">       let htmlBody = aStanza.getElement([&quot;html&quot;, &quot;body&quot;]);</span>
<a href="#l93.2997"></a><span id="l93.2997" class="difflineminus">-      if (htmlBody)</span>
<a href="#l93.2998"></a><span id="l93.2998" class="difflineplus">+      if (htmlBody) {</span>
<a href="#l93.2999"></a><span id="l93.2999">         body = htmlBody.innerXML;</span>
<a href="#l93.3000"></a><span id="l93.3000" class="difflineminus">-      else {</span>
<a href="#l93.3001"></a><span id="l93.3001" class="difflineplus">+      } else {</span>
<a href="#l93.3002"></a><span id="l93.3002">         // Even if the message is in plain text, the prplIMessage</span>
<a href="#l93.3003"></a><span id="l93.3003">         // should contain a string that's correctly escaped for</span>
<a href="#l93.3004"></a><span id="l93.3004">         // insertion in an HTML document.</span>
<a href="#l93.3005"></a><span id="l93.3005">         body = TXTToHTML(b.innerText);</span>
<a href="#l93.3006"></a><span id="l93.3006">       }</span>
<a href="#l93.3007"></a><span id="l93.3007">     }</span>
<a href="#l93.3008"></a><span id="l93.3008"> </span>
<a href="#l93.3009"></a><span id="l93.3009">     let subject = aStanza.getElement([&quot;subject&quot;]);</span>
<a href="#l93.3010"></a><span id="l93.3010" class="difflineat">@@ -2089,348 +2551,409 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.3011"></a><span id="l93.3011">       // attributes.</span>
<a href="#l93.3012"></a><span id="l93.3012">       muc.setTopic(subject.innerText, nick);</span>
<a href="#l93.3013"></a><span id="l93.3013">       return;</span>
<a href="#l93.3014"></a><span id="l93.3014">     }</span>
<a href="#l93.3015"></a><span id="l93.3015"> </span>
<a href="#l93.3016"></a><span id="l93.3016">     let invitation = this.parseInvitation(aStanza);</span>
<a href="#l93.3017"></a><span id="l93.3017">     if (invitation) {</span>
<a href="#l93.3018"></a><span id="l93.3018">       let messageID;</span>
<a href="#l93.3019"></a><span id="l93.3019" class="difflineminus">-      if (invitation.reason)</span>
<a href="#l93.3020"></a><span id="l93.3020" class="difflineplus">+      if (invitation.reason) {</span>
<a href="#l93.3021"></a><span id="l93.3021">         messageID = &quot;conversation.muc.invitationWithReason2&quot;;</span>
<a href="#l93.3022"></a><span id="l93.3022" class="difflineminus">-      else</span>
<a href="#l93.3023"></a><span id="l93.3023" class="difflineplus">+      } else {</span>
<a href="#l93.3024"></a><span id="l93.3024">         messageID = &quot;conversation.muc.invitationWithoutReason&quot;;</span>
<a href="#l93.3025"></a><span id="l93.3025" class="difflineminus">-      if (invitation.password)</span>
<a href="#l93.3026"></a><span id="l93.3026" class="difflineplus">+      }</span>
<a href="#l93.3027"></a><span id="l93.3027" class="difflineplus">+      if (invitation.password) {</span>
<a href="#l93.3028"></a><span id="l93.3028">         messageID += &quot;.password&quot;;</span>
<a href="#l93.3029"></a><span id="l93.3029" class="difflineminus">-      let params =</span>
<a href="#l93.3030"></a><span id="l93.3030" class="difflineminus">-        [invitation.from, invitation.mucJid, invitation.password,</span>
<a href="#l93.3031"></a><span id="l93.3031" class="difflineminus">-         invitation.reason].filter(s =&gt; s);</span>
<a href="#l93.3032"></a><span id="l93.3032" class="difflineplus">+      }</span>
<a href="#l93.3033"></a><span id="l93.3033" class="difflineplus">+      let params = [</span>
<a href="#l93.3034"></a><span id="l93.3034" class="difflineplus">+        invitation.from,</span>
<a href="#l93.3035"></a><span id="l93.3035" class="difflineplus">+        invitation.mucJid,</span>
<a href="#l93.3036"></a><span id="l93.3036" class="difflineplus">+        invitation.password,</span>
<a href="#l93.3037"></a><span id="l93.3037" class="difflineplus">+        invitation.reason,</span>
<a href="#l93.3038"></a><span id="l93.3038" class="difflineplus">+      ].filter(s =&gt; s);</span>
<a href="#l93.3039"></a><span id="l93.3039">       let message = _(messageID, ...params);</span>
<a href="#l93.3040"></a><span id="l93.3040"> </span>
<a href="#l93.3041"></a><span id="l93.3041" class="difflineminus">-      if (Services.prefs.getIntPref(&quot;messenger.conversations.autoAcceptChatInvitations&quot;) == 1) {</span>
<a href="#l93.3042"></a><span id="l93.3042" class="difflineplus">+      if (</span>
<a href="#l93.3043"></a><span id="l93.3043" class="difflineplus">+        Services.prefs.getIntPref(</span>
<a href="#l93.3044"></a><span id="l93.3044" class="difflineplus">+          &quot;messenger.conversations.autoAcceptChatInvitations&quot;</span>
<a href="#l93.3045"></a><span id="l93.3045" class="difflineplus">+        ) == 1</span>
<a href="#l93.3046"></a><span id="l93.3046" class="difflineplus">+      ) {</span>
<a href="#l93.3047"></a><span id="l93.3047">         // Auto-accept the invitation.</span>
<a href="#l93.3048"></a><span id="l93.3048" class="difflineminus">-        let chatRoomFields = this.getChatRoomDefaultFieldValues(invitation.mucJid);</span>
<a href="#l93.3049"></a><span id="l93.3049" class="difflineminus">-        if (invitation.password)</span>
<a href="#l93.3050"></a><span id="l93.3050" class="difflineplus">+        let chatRoomFields = this.getChatRoomDefaultFieldValues(</span>
<a href="#l93.3051"></a><span id="l93.3051" class="difflineplus">+          invitation.mucJid</span>
<a href="#l93.3052"></a><span id="l93.3052" class="difflineplus">+        );</span>
<a href="#l93.3053"></a><span id="l93.3053" class="difflineplus">+        if (invitation.password) {</span>
<a href="#l93.3054"></a><span id="l93.3054">           chatRoomFields.setValue(&quot;password&quot;, invitation.password);</span>
<a href="#l93.3055"></a><span id="l93.3055" class="difflineplus">+        }</span>
<a href="#l93.3056"></a><span id="l93.3056">         let muc = this.joinChat(chatRoomFields);</span>
<a href="#l93.3057"></a><span id="l93.3057" class="difflineminus">-        muc.writeMessage(muc.name, message, {system: true});</span>
<a href="#l93.3058"></a><span id="l93.3058" class="difflineminus">-      }</span>
<a href="#l93.3059"></a><span id="l93.3059" class="difflineminus">-      else {</span>
<a href="#l93.3060"></a><span id="l93.3060" class="difflineplus">+        muc.writeMessage(muc.name, message, { system: true });</span>
<a href="#l93.3061"></a><span id="l93.3061" class="difflineplus">+      } else {</span>
<a href="#l93.3062"></a><span id="l93.3062">         // Otherwise, just notify the user.</span>
<a href="#l93.3063"></a><span id="l93.3063">         let conv = this.createConversation(invitation.from);</span>
<a href="#l93.3064"></a><span id="l93.3064" class="difflineminus">-        if (conv)</span>
<a href="#l93.3065"></a><span id="l93.3065" class="difflineminus">-          conv.writeMessage(invitation.from, message, {system: true});</span>
<a href="#l93.3066"></a><span id="l93.3066" class="difflineplus">+        if (conv) {</span>
<a href="#l93.3067"></a><span id="l93.3067" class="difflineplus">+          conv.writeMessage(invitation.from, message, { system: true });</span>
<a href="#l93.3068"></a><span id="l93.3068" class="difflineplus">+        }</span>
<a href="#l93.3069"></a><span id="l93.3069">       }</span>
<a href="#l93.3070"></a><span id="l93.3070">     }</span>
<a href="#l93.3071"></a><span id="l93.3071"> </span>
<a href="#l93.3072"></a><span id="l93.3072">     if (body) {</span>
<a href="#l93.3073"></a><span id="l93.3073">       let date = _getDelay(aStanza);</span>
<a href="#l93.3074"></a><span id="l93.3074" class="difflineminus">-      if (type == &quot;groupchat&quot; ||</span>
<a href="#l93.3075"></a><span id="l93.3075" class="difflineminus">-          (type == &quot;error&quot; &amp;&amp; isMuc &amp;&amp; !this._conv.has(convJid))) {</span>
<a href="#l93.3076"></a><span id="l93.3076" class="difflineplus">+      if (</span>
<a href="#l93.3077"></a><span id="l93.3077" class="difflineplus">+        type == &quot;groupchat&quot; ||</span>
<a href="#l93.3078"></a><span id="l93.3078" class="difflineplus">+        (type == &quot;error&quot; &amp;&amp; isMuc &amp;&amp; !this._conv.has(convJid))</span>
<a href="#l93.3079"></a><span id="l93.3079" class="difflineplus">+      ) {</span>
<a href="#l93.3080"></a><span id="l93.3080">         if (!isMuc) {</span>
<a href="#l93.3081"></a><span id="l93.3081" class="difflineminus">-          this.WARN(&quot;Received a groupchat message for unknown MUC &quot; + normConvJid);</span>
<a href="#l93.3082"></a><span id="l93.3082" class="difflineplus">+          this.WARN(</span>
<a href="#l93.3083"></a><span id="l93.3083" class="difflineplus">+            &quot;Received a groupchat message for unknown MUC &quot; + normConvJid</span>
<a href="#l93.3084"></a><span id="l93.3084" class="difflineplus">+          );</span>
<a href="#l93.3085"></a><span id="l93.3085">           return;</span>
<a href="#l93.3086"></a><span id="l93.3086">         }</span>
<a href="#l93.3087"></a><span id="l93.3087">         let muc = this._mucs.get(normConvJid);</span>
<a href="#l93.3088"></a><span id="l93.3088">         muc.incomingMessage(body, aStanza, date);</span>
<a href="#l93.3089"></a><span id="l93.3089">         return;</span>
<a href="#l93.3090"></a><span id="l93.3090">       }</span>
<a href="#l93.3091"></a><span id="l93.3091"> </span>
<a href="#l93.3092"></a><span id="l93.3092">       let conv = this.createConversation(convJid);</span>
<a href="#l93.3093"></a><span id="l93.3093" class="difflineminus">-      if (!conv)</span>
<a href="#l93.3094"></a><span id="l93.3094" class="difflineplus">+      if (!conv) {</span>
<a href="#l93.3095"></a><span id="l93.3095">         return;</span>
<a href="#l93.3096"></a><span id="l93.3096" class="difflineplus">+      }</span>
<a href="#l93.3097"></a><span id="l93.3097"> </span>
<a href="#l93.3098"></a><span id="l93.3098">       if (isSent) {</span>
<a href="#l93.3099"></a><span id="l93.3099">         _displaySentMsg(conv, body, date);</span>
<a href="#l93.3100"></a><span id="l93.3100">         return;</span>
<a href="#l93.3101"></a><span id="l93.3101">       }</span>
<a href="#l93.3102"></a><span id="l93.3102">       conv.incomingMessage(body, aStanza, date);</span>
<a href="#l93.3103"></a><span id="l93.3103" class="difflineminus">-    }</span>
<a href="#l93.3104"></a><span id="l93.3104" class="difflineminus">-    else if (type == &quot;error&quot;) {</span>
<a href="#l93.3105"></a><span id="l93.3105" class="difflineplus">+    } else if (type == &quot;error&quot;) {</span>
<a href="#l93.3106"></a><span id="l93.3106">       let conv = this.createConversation(convJid);</span>
<a href="#l93.3107"></a><span id="l93.3107" class="difflineminus">-      if (conv)</span>
<a href="#l93.3108"></a><span id="l93.3108" class="difflineplus">+      if (conv) {</span>
<a href="#l93.3109"></a><span id="l93.3109">         conv.incomingMessage(null, aStanza);</span>
<a href="#l93.3110"></a><span id="l93.3110" class="difflineminus">-    }</span>
<a href="#l93.3111"></a><span id="l93.3111" class="difflineminus">-    else if (x &amp;&amp; x.uri == Stanza.NS.muc_user) {</span>
<a href="#l93.3112"></a><span id="l93.3112" class="difflineplus">+      }</span>
<a href="#l93.3113"></a><span id="l93.3113" class="difflineplus">+    } else if (x &amp;&amp; x.uri == Stanza.NS.muc_user) {</span>
<a href="#l93.3114"></a><span id="l93.3114">       let muc = this._mucs.get(normConvJid);</span>
<a href="#l93.3115"></a><span id="l93.3115">       if (!muc) {</span>
<a href="#l93.3116"></a><span id="l93.3116" class="difflineminus">-        this.WARN(&quot;Received a groupchat message for unknown MUC &quot; + normConvJid);</span>
<a href="#l93.3117"></a><span id="l93.3117" class="difflineplus">+        this.WARN(</span>
<a href="#l93.3118"></a><span id="l93.3118" class="difflineplus">+          &quot;Received a groupchat message for unknown MUC &quot; + normConvJid</span>
<a href="#l93.3119"></a><span id="l93.3119" class="difflineplus">+        );</span>
<a href="#l93.3120"></a><span id="l93.3120">         return;</span>
<a href="#l93.3121"></a><span id="l93.3121">       }</span>
<a href="#l93.3122"></a><span id="l93.3122">       muc.onMessageStanza(aStanza);</span>
<a href="#l93.3123"></a><span id="l93.3123">       return;</span>
<a href="#l93.3124"></a><span id="l93.3124">     }</span>
<a href="#l93.3125"></a><span id="l93.3125"> </span>
<a href="#l93.3126"></a><span id="l93.3126">     // If this is a sent message carbon, the user is typing on another client.</span>
<a href="#l93.3127"></a><span id="l93.3127" class="difflineminus">-    if (isSent)</span>
<a href="#l93.3128"></a><span id="l93.3128" class="difflineplus">+    if (isSent) {</span>
<a href="#l93.3129"></a><span id="l93.3129">       return;</span>
<a href="#l93.3130"></a><span id="l93.3130" class="difflineplus">+    }</span>
<a href="#l93.3131"></a><span id="l93.3131"> </span>
<a href="#l93.3132"></a><span id="l93.3132">     // Don't create a conversation to only display the typing notifications.</span>
<a href="#l93.3133"></a><span id="l93.3133" class="difflineminus">-    if (!this._conv.has(normConvJid) &amp;&amp; !this._conv.has(convJid))</span>
<a href="#l93.3134"></a><span id="l93.3134" class="difflineplus">+    if (!this._conv.has(normConvJid) &amp;&amp; !this._conv.has(convJid)) {</span>
<a href="#l93.3135"></a><span id="l93.3135">       return;</span>
<a href="#l93.3136"></a><span id="l93.3136" class="difflineplus">+    }</span>
<a href="#l93.3137"></a><span id="l93.3137"> </span>
<a href="#l93.3138"></a><span id="l93.3138">     // Ignore errors while delivering typing notifications.</span>
<a href="#l93.3139"></a><span id="l93.3139" class="difflineminus">-    if (type == &quot;error&quot;)</span>
<a href="#l93.3140"></a><span id="l93.3140" class="difflineplus">+    if (type == &quot;error&quot;) {</span>
<a href="#l93.3141"></a><span id="l93.3141">       return;</span>
<a href="#l93.3142"></a><span id="l93.3142" class="difflineplus">+    }</span>
<a href="#l93.3143"></a><span id="l93.3143"> </span>
<a href="#l93.3144"></a><span id="l93.3144">     let typingState = Ci.prplIConvIM.NOT_TYPING;</span>
<a href="#l93.3145"></a><span id="l93.3145">     let state;</span>
<a href="#l93.3146"></a><span id="l93.3146">     let s = aStanza.getChildrenByNS(Stanza.NS.chatstates);</span>
<a href="#l93.3147"></a><span id="l93.3147" class="difflineminus">-    if (s.length &gt; 0)</span>
<a href="#l93.3148"></a><span id="l93.3148" class="difflineplus">+    if (s.length &gt; 0) {</span>
<a href="#l93.3149"></a><span id="l93.3149">       state = s[0].localName;</span>
<a href="#l93.3150"></a><span id="l93.3150" class="difflineplus">+    }</span>
<a href="#l93.3151"></a><span id="l93.3151">     if (state) {</span>
<a href="#l93.3152"></a><span id="l93.3152">       this.DEBUG(state);</span>
<a href="#l93.3153"></a><span id="l93.3153" class="difflineminus">-      if (state == &quot;composing&quot;)</span>
<a href="#l93.3154"></a><span id="l93.3154" class="difflineplus">+      if (state == &quot;composing&quot;) {</span>
<a href="#l93.3155"></a><span id="l93.3155">         typingState = Ci.prplIConvIM.TYPING;</span>
<a href="#l93.3156"></a><span id="l93.3156" class="difflineminus">-      else if (state == &quot;paused&quot;)</span>
<a href="#l93.3157"></a><span id="l93.3157" class="difflineplus">+      } else if (state == &quot;paused&quot;) {</span>
<a href="#l93.3158"></a><span id="l93.3158">         typingState = Ci.prplIConvIM.TYPED;</span>
<a href="#l93.3159"></a><span id="l93.3159" class="difflineplus">+      }</span>
<a href="#l93.3160"></a><span id="l93.3160">     }</span>
<a href="#l93.3161"></a><span id="l93.3161">     let convName = normConvJid;</span>
<a href="#l93.3162"></a><span id="l93.3162"> </span>
<a href="#l93.3163"></a><span id="l93.3163">     // If the bare JID is a MUC that we have joined, use the full JID as this</span>
<a href="#l93.3164"></a><span id="l93.3164">     // is a private message to a MUC participant.</span>
<a href="#l93.3165"></a><span id="l93.3165" class="difflineminus">-    if (isMuc)</span>
<a href="#l93.3166"></a><span id="l93.3166" class="difflineplus">+    if (isMuc) {</span>
<a href="#l93.3167"></a><span id="l93.3167">       convName = convJid;</span>
<a href="#l93.3168"></a><span id="l93.3168" class="difflineplus">+    }</span>
<a href="#l93.3169"></a><span id="l93.3169"> </span>
<a href="#l93.3170"></a><span id="l93.3170">     let conv = this._conv.get(convName);</span>
<a href="#l93.3171"></a><span id="l93.3171" class="difflineminus">-    if (!conv)</span>
<a href="#l93.3172"></a><span id="l93.3172" class="difflineplus">+    if (!conv) {</span>
<a href="#l93.3173"></a><span id="l93.3173">       return;</span>
<a href="#l93.3174"></a><span id="l93.3174" class="difflineplus">+    }</span>
<a href="#l93.3175"></a><span id="l93.3175">     conv.updateTyping(typingState, conv.shortName);</span>
<a href="#l93.3176"></a><span id="l93.3176">     conv.supportChatStateNotifications = !!state;</span>
<a href="#l93.3177"></a><span id="l93.3177">   },</span>
<a href="#l93.3178"></a><span id="l93.3178"> </span>
<a href="#l93.3179"></a><span id="l93.3179">   /* Called when there is an error in the xmpp session */</span>
<a href="#l93.3180"></a><span id="l93.3180">   onError(aError, aException) {</span>
<a href="#l93.3181"></a><span id="l93.3181" class="difflineminus">-    if (aError === null || aError === undefined)</span>
<a href="#l93.3182"></a><span id="l93.3182" class="difflineplus">+    if (aError === null || aError === undefined) {</span>
<a href="#l93.3183"></a><span id="l93.3183">       aError = Ci.prplIAccount.ERROR_OTHER_ERROR;</span>
<a href="#l93.3184"></a><span id="l93.3184" class="difflineplus">+    }</span>
<a href="#l93.3185"></a><span id="l93.3185">     this._disconnect(aError, aException.toString());</span>
<a href="#l93.3186"></a><span id="l93.3186">   },</span>
<a href="#l93.3187"></a><span id="l93.3187"> </span>
<a href="#l93.3188"></a><span id="l93.3188">   onVCard(aStanza) {</span>
<a href="#l93.3189"></a><span id="l93.3189">     let jid = this._pendingVCardRequests.shift();</span>
<a href="#l93.3190"></a><span id="l93.3190">     this._requestNextVCard();</span>
<a href="#l93.3191"></a><span id="l93.3191">     if (!this._buddies.has(jid)) {</span>
<a href="#l93.3192"></a><span id="l93.3192">       this.WARN(&quot;Received a vCard for unknown buddy &quot; + jid);</span>
<a href="#l93.3193"></a><span id="l93.3193">       return;</span>
<a href="#l93.3194"></a><span id="l93.3194">     }</span>
<a href="#l93.3195"></a><span id="l93.3195"> </span>
<a href="#l93.3196"></a><span id="l93.3196">     let vCard = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l93.3197"></a><span id="l93.3197">     let error = this.parseError(aStanza);</span>
<a href="#l93.3198"></a><span id="l93.3198" class="difflineminus">-    if ((error &amp;&amp; (error.condition == &quot;item-not-found&quot; ||</span>
<a href="#l93.3199"></a><span id="l93.3199" class="difflineminus">-         error.condition == &quot;service-unavailable&quot;)) ||</span>
<a href="#l93.3200"></a><span id="l93.3200" class="difflineminus">-        !vCard || !vCard.children.length) {</span>
<a href="#l93.3201"></a><span id="l93.3201" class="difflineplus">+    if (</span>
<a href="#l93.3202"></a><span id="l93.3202" class="difflineplus">+      (error &amp;&amp;</span>
<a href="#l93.3203"></a><span id="l93.3203" class="difflineplus">+        (error.condition == &quot;item-not-found&quot; ||</span>
<a href="#l93.3204"></a><span id="l93.3204" class="difflineplus">+          error.condition == &quot;service-unavailable&quot;)) ||</span>
<a href="#l93.3205"></a><span id="l93.3205" class="difflineplus">+      !vCard ||</span>
<a href="#l93.3206"></a><span id="l93.3206" class="difflineplus">+      !vCard.children.length</span>
<a href="#l93.3207"></a><span id="l93.3207" class="difflineplus">+    ) {</span>
<a href="#l93.3208"></a><span id="l93.3208">       this.LOG(&quot;No vCard exists (or the user does not exist) for &quot; + jid);</span>
<a href="#l93.3209"></a><span id="l93.3209">       return;</span>
<a href="#l93.3210"></a><span id="l93.3210" class="difflineminus">-    }</span>
<a href="#l93.3211"></a><span id="l93.3211" class="difflineminus">-    else if (error) {</span>
<a href="#l93.3212"></a><span id="l93.3212" class="difflineplus">+    } else if (error) {</span>
<a href="#l93.3213"></a><span id="l93.3213">       this.WARN(&quot;Received unexpected vCard error &quot; + error.condition);</span>
<a href="#l93.3214"></a><span id="l93.3214">       return;</span>
<a href="#l93.3215"></a><span id="l93.3215">     }</span>
<a href="#l93.3216"></a><span id="l93.3216"> </span>
<a href="#l93.3217"></a><span id="l93.3217">     let buddy = this._buddies.get(jid);</span>
<a href="#l93.3218"></a><span id="l93.3218">     let stanzaJid = this.normalize(aStanza.attributes.from);</span>
<a href="#l93.3219"></a><span id="l93.3219">     if (jid &amp;&amp; jid != stanzaJid) {</span>
<a href="#l93.3220"></a><span id="l93.3220" class="difflineminus">-      this.ERROR(&quot;Received vCard for a different jid (&quot; + stanzaJid + &quot;) &quot; +</span>
<a href="#l93.3221"></a><span id="l93.3221" class="difflineminus">-                 &quot;than the requested &quot; + jid);</span>
<a href="#l93.3222"></a><span id="l93.3222" class="difflineplus">+      this.ERROR(</span>
<a href="#l93.3223"></a><span id="l93.3223" class="difflineplus">+        &quot;Received vCard for a different jid (&quot; +</span>
<a href="#l93.3224"></a><span id="l93.3224" class="difflineplus">+          stanzaJid +</span>
<a href="#l93.3225"></a><span id="l93.3225" class="difflineplus">+          &quot;) &quot; +</span>
<a href="#l93.3226"></a><span id="l93.3226" class="difflineplus">+          &quot;than the requested &quot; +</span>
<a href="#l93.3227"></a><span id="l93.3227" class="difflineplus">+          jid</span>
<a href="#l93.3228"></a><span id="l93.3228" class="difflineplus">+      );</span>
<a href="#l93.3229"></a><span id="l93.3229">     }</span>
<a href="#l93.3230"></a><span id="l93.3230"> </span>
<a href="#l93.3231"></a><span id="l93.3231">     let foundFormattedName = false;</span>
<a href="#l93.3232"></a><span id="l93.3232">     let vCardInfo = this.parseVCard(vCard);</span>
<a href="#l93.3233"></a><span id="l93.3233">     if (vCardInfo.fullName) {</span>
<a href="#l93.3234"></a><span id="l93.3234">       buddy.vCardFormattedName = vCardInfo.fullName;</span>
<a href="#l93.3235"></a><span id="l93.3235">       foundFormattedName = true;</span>
<a href="#l93.3236"></a><span id="l93.3236">     }</span>
<a href="#l93.3237"></a><span id="l93.3237" class="difflineminus">-    if (vCardInfo.photo)</span>
<a href="#l93.3238"></a><span id="l93.3238" class="difflineplus">+    if (vCardInfo.photo) {</span>
<a href="#l93.3239"></a><span id="l93.3239">       buddy._saveIcon(vCardInfo.photo);</span>
<a href="#l93.3240"></a><span id="l93.3240" class="difflineminus">-    if (!foundFormattedName &amp;&amp; buddy._vCardFormattedName)</span>
<a href="#l93.3241"></a><span id="l93.3241" class="difflineplus">+    }</span>
<a href="#l93.3242"></a><span id="l93.3242" class="difflineplus">+    if (!foundFormattedName &amp;&amp; buddy._vCardFormattedName) {</span>
<a href="#l93.3243"></a><span id="l93.3243">       buddy.vCardFormattedName = &quot;&quot;;</span>
<a href="#l93.3244"></a><span id="l93.3244" class="difflineplus">+    }</span>
<a href="#l93.3245"></a><span id="l93.3245">     buddy._vCardReceived = true;</span>
<a href="#l93.3246"></a><span id="l93.3246">   },</span>
<a href="#l93.3247"></a><span id="l93.3247"> </span>
<a href="#l93.3248"></a><span id="l93.3248">   _requestNextVCard() {</span>
<a href="#l93.3249"></a><span id="l93.3249" class="difflineminus">-    if (!this._pendingVCardRequests.length)</span>
<a href="#l93.3250"></a><span id="l93.3250" class="difflineplus">+    if (!this._pendingVCardRequests.length) {</span>
<a href="#l93.3251"></a><span id="l93.3251">       return;</span>
<a href="#l93.3252"></a><span id="l93.3252" class="difflineminus">-    let s = Stanza.iq(&quot;get&quot;, null, this._pendingVCardRequests[0],</span>
<a href="#l93.3253"></a><span id="l93.3253" class="difflineminus">-                      Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l93.3254"></a><span id="l93.3254" class="difflineplus">+    }</span>
<a href="#l93.3255"></a><span id="l93.3255" class="difflineplus">+    let s = Stanza.iq(</span>
<a href="#l93.3256"></a><span id="l93.3256" class="difflineplus">+      &quot;get&quot;,</span>
<a href="#l93.3257"></a><span id="l93.3257" class="difflineplus">+      null,</span>
<a href="#l93.3258"></a><span id="l93.3258" class="difflineplus">+      this._pendingVCardRequests[0],</span>
<a href="#l93.3259"></a><span id="l93.3259" class="difflineplus">+      Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard)</span>
<a href="#l93.3260"></a><span id="l93.3260" class="difflineplus">+    );</span>
<a href="#l93.3261"></a><span id="l93.3261">     this.sendStanza(s, this.onVCard, this);</span>
<a href="#l93.3262"></a><span id="l93.3262">   },</span>
<a href="#l93.3263"></a><span id="l93.3263"> </span>
<a href="#l93.3264"></a><span id="l93.3264">   _addVCardRequest(aJID) {</span>
<a href="#l93.3265"></a><span id="l93.3265">     let requestPending = !!this._pendingVCardRequests.length;</span>
<a href="#l93.3266"></a><span id="l93.3266">     this._pendingVCardRequests.push(aJID);</span>
<a href="#l93.3267"></a><span id="l93.3267" class="difflineminus">-    if (!requestPending)</span>
<a href="#l93.3268"></a><span id="l93.3268" class="difflineplus">+    if (!requestPending) {</span>
<a href="#l93.3269"></a><span id="l93.3269">       this._requestNextVCard();</span>
<a href="#l93.3270"></a><span id="l93.3270" class="difflineplus">+    }</span>
<a href="#l93.3271"></a><span id="l93.3271">   },</span>
<a href="#l93.3272"></a><span id="l93.3272"> </span>
<a href="#l93.3273"></a><span id="l93.3273">   // XEP-0029 (Section 2) and RFC 6122 (Section 2): The node and domain are</span>
<a href="#l93.3274"></a><span id="l93.3274">   // lowercase, while resources are case sensitive and can contain spaces.</span>
<a href="#l93.3275"></a><span id="l93.3275">   normalizeFullJid(aJID) {</span>
<a href="#l93.3276"></a><span id="l93.3276">     return this._parseJID(aJID.trim()).jid;</span>
<a href="#l93.3277"></a><span id="l93.3277">   },</span>
<a href="#l93.3278"></a><span id="l93.3278"> </span>
<a href="#l93.3279"></a><span id="l93.3279">   // Standard normalization for XMPP removes the resource part of jids.</span>
<a href="#l93.3280"></a><span id="l93.3280">   normalize(aJID) {</span>
<a href="#l93.3281"></a><span id="l93.3281" class="difflineminus">-    return aJID.trim()</span>
<a href="#l93.3282"></a><span id="l93.3282" class="difflineminus">-               .split(&quot;/&quot;, 1)[0] // up to first slash</span>
<a href="#l93.3283"></a><span id="l93.3283" class="difflineminus">-               .toLowerCase();</span>
<a href="#l93.3284"></a><span id="l93.3284" class="difflineplus">+    return aJID</span>
<a href="#l93.3285"></a><span id="l93.3285" class="difflineplus">+      .trim()</span>
<a href="#l93.3286"></a><span id="l93.3286" class="difflineplus">+      .split(&quot;/&quot;, 1)[0] // up to first slash</span>
<a href="#l93.3287"></a><span id="l93.3287" class="difflineplus">+      .toLowerCase();</span>
<a href="#l93.3288"></a><span id="l93.3288">   },</span>
<a href="#l93.3289"></a><span id="l93.3289"> </span>
<a href="#l93.3290"></a><span id="l93.3290">   // RFC 6122 (Section 2): [ localpart &quot;@&quot; ] domainpart [ &quot;/&quot; resourcepart ] is</span>
<a href="#l93.3291"></a><span id="l93.3291">   // the form of jid.</span>
<a href="#l93.3292"></a><span id="l93.3292">   // Localpart is parsed as node and optional.</span>
<a href="#l93.3293"></a><span id="l93.3293">   // Domainpart is parsed as domain and required.</span>
<a href="#l93.3294"></a><span id="l93.3294">   // resourcepart is parsed as resource and optional.</span>
<a href="#l93.3295"></a><span id="l93.3295">   _parseJID(aJid) {</span>
<a href="#l93.3296"></a><span id="l93.3296" class="difflineminus">-    let match =</span>
<a href="#l93.3297"></a><span id="l93.3297" class="difflineminus">-      /^(?:([^&quot;&amp;'/:&lt;&gt;@]+)@)?([^@/&lt;&gt;'\&quot;]+)(?:\/(.*))?$/.exec(aJid.trim());</span>
<a href="#l93.3298"></a><span id="l93.3298" class="difflineminus">-    if (!match)</span>
<a href="#l93.3299"></a><span id="l93.3299" class="difflineplus">+    let match = /^(?:([^&quot;&amp;'/:&lt;&gt;@]+)@)?([^@/&lt;&gt;'\&quot;]+)(?:\/(.*))?$/.exec(</span>
<a href="#l93.3300"></a><span id="l93.3300" class="difflineplus">+      aJid.trim()</span>
<a href="#l93.3301"></a><span id="l93.3301" class="difflineplus">+    );</span>
<a href="#l93.3302"></a><span id="l93.3302" class="difflineplus">+    if (!match) {</span>
<a href="#l93.3303"></a><span id="l93.3303">       return null;</span>
<a href="#l93.3304"></a><span id="l93.3304" class="difflineplus">+    }</span>
<a href="#l93.3305"></a><span id="l93.3305"> </span>
<a href="#l93.3306"></a><span id="l93.3306">     let result = {</span>
<a href="#l93.3307"></a><span id="l93.3307">       node: match[1],</span>
<a href="#l93.3308"></a><span id="l93.3308">       domain: match[2].toLowerCase(),</span>
<a href="#l93.3309"></a><span id="l93.3309">       resource: match[3],</span>
<a href="#l93.3310"></a><span id="l93.3310">     };</span>
<a href="#l93.3311"></a><span id="l93.3311">     return this._setJID(result.domain, result.node, result.resource);</span>
<a href="#l93.3312"></a><span id="l93.3312">   },</span>
<a href="#l93.3313"></a><span id="l93.3313"> </span>
<a href="#l93.3314"></a><span id="l93.3314">   // Constructs jid as an object from domain, node and resource parts.</span>
<a href="#l93.3315"></a><span id="l93.3315">   // The object has properties (node, domain, resource and jid).</span>
<a href="#l93.3316"></a><span id="l93.3316">   // aDomain is required, but aNode and aResource are optional.</span>
<a href="#l93.3317"></a><span id="l93.3317">   _setJID(aDomain, aNode = null, aResource = null) {</span>
<a href="#l93.3318"></a><span id="l93.3318" class="difflineminus">-    if (!aDomain)</span>
<a href="#l93.3319"></a><span id="l93.3319" class="difflineplus">+    if (!aDomain) {</span>
<a href="#l93.3320"></a><span id="l93.3320">       throw new Error(&quot;aDomain must have a value&quot;);</span>
<a href="#l93.3321"></a><span id="l93.3321" class="difflineplus">+    }</span>
<a href="#l93.3322"></a><span id="l93.3322"> </span>
<a href="#l93.3323"></a><span id="l93.3323">     let result = {</span>
<a href="#l93.3324"></a><span id="l93.3324">       node: aNode,</span>
<a href="#l93.3325"></a><span id="l93.3325">       domain: aDomain.toLowerCase(),</span>
<a href="#l93.3326"></a><span id="l93.3326">       resource: aResource,</span>
<a href="#l93.3327"></a><span id="l93.3327">     };</span>
<a href="#l93.3328"></a><span id="l93.3328">     let jid = result.domain;</span>
<a href="#l93.3329"></a><span id="l93.3329">     if (result.node) {</span>
<a href="#l93.3330"></a><span id="l93.3330">       result.node = result.node.toLowerCase();</span>
<a href="#l93.3331"></a><span id="l93.3331">       jid = result.node + &quot;@&quot; + jid;</span>
<a href="#l93.3332"></a><span id="l93.3332">     }</span>
<a href="#l93.3333"></a><span id="l93.3333" class="difflineminus">-    if (result.resource)</span>
<a href="#l93.3334"></a><span id="l93.3334" class="difflineplus">+    if (result.resource) {</span>
<a href="#l93.3335"></a><span id="l93.3335">       jid += &quot;/&quot; + result.resource;</span>
<a href="#l93.3336"></a><span id="l93.3336" class="difflineplus">+    }</span>
<a href="#l93.3337"></a><span id="l93.3337">     result.jid = jid;</span>
<a href="#l93.3338"></a><span id="l93.3338">     return result;</span>
<a href="#l93.3339"></a><span id="l93.3339">   },</span>
<a href="#l93.3340"></a><span id="l93.3340"> </span>
<a href="#l93.3341"></a><span id="l93.3341">   _onRosterItem(aItem, aNotifyOfUpdates) {</span>
<a href="#l93.3342"></a><span id="l93.3342">     let jid = aItem.attributes.jid;</span>
<a href="#l93.3343"></a><span id="l93.3343">     if (!jid) {</span>
<a href="#l93.3344"></a><span id="l93.3344">       this.WARN(&quot;Received a roster item without jid: &quot; + aItem.getXML());</span>
<a href="#l93.3345"></a><span id="l93.3345">       return &quot;&quot;;</span>
<a href="#l93.3346"></a><span id="l93.3346">     }</span>
<a href="#l93.3347"></a><span id="l93.3347">     jid = this.normalize(jid);</span>
<a href="#l93.3348"></a><span id="l93.3348"> </span>
<a href="#l93.3349"></a><span id="l93.3349" class="difflineminus">-    let subscription =  &quot;&quot;;</span>
<a href="#l93.3350"></a><span id="l93.3350" class="difflineminus">-    if (&quot;subscription&quot; in aItem.attributes)</span>
<a href="#l93.3351"></a><span id="l93.3351" class="difflineplus">+    let subscription = &quot;&quot;;</span>
<a href="#l93.3352"></a><span id="l93.3352" class="difflineplus">+    if (&quot;subscription&quot; in aItem.attributes) {</span>
<a href="#l93.3353"></a><span id="l93.3353">       subscription = aItem.attributes.subscription;</span>
<a href="#l93.3354"></a><span id="l93.3354" class="difflineplus">+    }</span>
<a href="#l93.3355"></a><span id="l93.3355">     if (subscription == &quot;remove&quot;) {</span>
<a href="#l93.3356"></a><span id="l93.3356">       this._forgetRosterItem(jid);</span>
<a href="#l93.3357"></a><span id="l93.3357">       return &quot;&quot;;</span>
<a href="#l93.3358"></a><span id="l93.3358">     }</span>
<a href="#l93.3359"></a><span id="l93.3359"> </span>
<a href="#l93.3360"></a><span id="l93.3360">     let buddy;</span>
<a href="#l93.3361"></a><span id="l93.3361">     if (this._buddies.has(jid)) {</span>
<a href="#l93.3362"></a><span id="l93.3362">       buddy = this._buddies.get(jid);</span>
<a href="#l93.3363"></a><span id="l93.3363">       let groups = aItem.getChildren(&quot;group&quot;);</span>
<a href="#l93.3364"></a><span id="l93.3364">       if (groups.length) {</span>
<a href="#l93.3365"></a><span id="l93.3365">         // If the server specified at least one group, ensure the group we use</span>
<a href="#l93.3366"></a><span id="l93.3366">         // as the account buddy's tag is still a group on the server...</span>
<a href="#l93.3367"></a><span id="l93.3367">         let tagName = buddy.tag.name;</span>
<a href="#l93.3368"></a><span id="l93.3368">         if (!groups.some(g =&gt; g.innerText == tagName)) {</span>
<a href="#l93.3369"></a><span id="l93.3369">           // ... otherwise we need to move our account buddy to a new group.</span>
<a href="#l93.3370"></a><span id="l93.3370">           tagName = groups[0].innerText;</span>
<a href="#l93.3371"></a><span id="l93.3371" class="difflineminus">-          if (tagName) { // Should always be true, but check just in case...</span>
<a href="#l93.3372"></a><span id="l93.3372" class="difflineplus">+          if (tagName) {</span>
<a href="#l93.3373"></a><span id="l93.3373" class="difflineplus">+            // Should always be true, but check just in case...</span>
<a href="#l93.3374"></a><span id="l93.3374">             let oldTag = buddy.tag;</span>
<a href="#l93.3375"></a><span id="l93.3375">             buddy._tag = Services.tags.createTag(tagName);</span>
<a href="#l93.3376"></a><span id="l93.3376">             Services.contacts.accountBuddyMoved(buddy, oldTag, buddy._tag);</span>
<a href="#l93.3377"></a><span id="l93.3377">           }</span>
<a href="#l93.3378"></a><span id="l93.3378">         }</span>
<a href="#l93.3379"></a><span id="l93.3379">       }</span>
<a href="#l93.3380"></a><span id="l93.3380" class="difflineminus">-    }</span>
<a href="#l93.3381"></a><span id="l93.3381" class="difflineminus">-    else {</span>
<a href="#l93.3382"></a><span id="l93.3382" class="difflineplus">+    } else {</span>
<a href="#l93.3383"></a><span id="l93.3383">       let tag;</span>
<a href="#l93.3384"></a><span id="l93.3384">       for (let group of aItem.getChildren(&quot;group&quot;)) {</span>
<a href="#l93.3385"></a><span id="l93.3385">         let name = group.innerText;</span>
<a href="#l93.3386"></a><span id="l93.3386">         if (name) {</span>
<a href="#l93.3387"></a><span id="l93.3387">           tag = Services.tags.createTag(name);</span>
<a href="#l93.3388"></a><span id="l93.3388">           break; // TODO we should create an accountBuddy per group,</span>
<a href="#l93.3389"></a><span id="l93.3389" class="difflineminus">-                 // but this._buddies would probably not like that...</span>
<a href="#l93.3390"></a><span id="l93.3390" class="difflineplus">+          // but this._buddies would probably not like that...</span>
<a href="#l93.3391"></a><span id="l93.3391">         }</span>
<a href="#l93.3392"></a><span id="l93.3392">       }</span>
<a href="#l93.3393"></a><span id="l93.3393" class="difflineminus">-      buddy = new this._accountBuddyConstructor(this, null,</span>
<a href="#l93.3394"></a><span id="l93.3394" class="difflineminus">-                                                tag || Services.tags.defaultTag,</span>
<a href="#l93.3395"></a><span id="l93.3395" class="difflineminus">-                                                jid);</span>
<a href="#l93.3396"></a><span id="l93.3396" class="difflineplus">+      buddy = new this._accountBuddyConstructor(</span>
<a href="#l93.3397"></a><span id="l93.3397" class="difflineplus">+        this,</span>
<a href="#l93.3398"></a><span id="l93.3398" class="difflineplus">+        null,</span>
<a href="#l93.3399"></a><span id="l93.3399" class="difflineplus">+        tag || Services.tags.defaultTag,</span>
<a href="#l93.3400"></a><span id="l93.3400" class="difflineplus">+        jid</span>
<a href="#l93.3401"></a><span id="l93.3401" class="difflineplus">+      );</span>
<a href="#l93.3402"></a><span id="l93.3402">     }</span>
<a href="#l93.3403"></a><span id="l93.3403"> </span>
<a href="#l93.3404"></a><span id="l93.3404">     // We request the vCard only if we haven't received it yet and are</span>
<a href="#l93.3405"></a><span id="l93.3405">     // subscribed to presence for that contact.</span>
<a href="#l93.3406"></a><span id="l93.3406" class="difflineminus">-    if ((subscription == &quot;both&quot; || subscription == &quot;to&quot;) &amp;&amp; !buddy._vCardReceived)</span>
<a href="#l93.3407"></a><span id="l93.3407" class="difflineplus">+    if (</span>
<a href="#l93.3408"></a><span id="l93.3408" class="difflineplus">+      (subscription == &quot;both&quot; || subscription == &quot;to&quot;) &amp;&amp;</span>
<a href="#l93.3409"></a><span id="l93.3409" class="difflineplus">+      !buddy._vCardReceived</span>
<a href="#l93.3410"></a><span id="l93.3410" class="difflineplus">+    ) {</span>
<a href="#l93.3411"></a><span id="l93.3411">       this._addVCardRequest(jid);</span>
<a href="#l93.3412"></a><span id="l93.3412" class="difflineplus">+    }</span>
<a href="#l93.3413"></a><span id="l93.3413"> </span>
<a href="#l93.3414"></a><span id="l93.3414">     let alias = &quot;name&quot; in aItem.attributes ? aItem.attributes.name : &quot;&quot;;</span>
<a href="#l93.3415"></a><span id="l93.3415">     if (alias) {</span>
<a href="#l93.3416"></a><span id="l93.3416" class="difflineminus">-      if (aNotifyOfUpdates &amp;&amp; this._buddies.has(jid))</span>
<a href="#l93.3417"></a><span id="l93.3417" class="difflineplus">+      if (aNotifyOfUpdates &amp;&amp; this._buddies.has(jid)) {</span>
<a href="#l93.3418"></a><span id="l93.3418">         buddy.rosterAlias = alias;</span>
<a href="#l93.3419"></a><span id="l93.3419" class="difflineminus">-      else</span>
<a href="#l93.3420"></a><span id="l93.3420" class="difflineplus">+      } else {</span>
<a href="#l93.3421"></a><span id="l93.3421">         buddy._rosterAlias = alias;</span>
<a href="#l93.3422"></a><span id="l93.3422" class="difflineplus">+      }</span>
<a href="#l93.3423"></a><span id="l93.3423" class="difflineplus">+    } else if (buddy._rosterAlias) {</span>
<a href="#l93.3424"></a><span id="l93.3424" class="difflineplus">+      buddy.rosterAlias = &quot;&quot;;</span>
<a href="#l93.3425"></a><span id="l93.3425">     }</span>
<a href="#l93.3426"></a><span id="l93.3426" class="difflineminus">-    else if (buddy._rosterAlias)</span>
<a href="#l93.3427"></a><span id="l93.3427" class="difflineminus">-      buddy.rosterAlias = &quot;&quot;;</span>
<a href="#l93.3428"></a><span id="l93.3428" class="difflineminus">-</span>
<a href="#l93.3429"></a><span id="l93.3429" class="difflineminus">-    if (subscription)</span>
<a href="#l93.3430"></a><span id="l93.3430" class="difflineplus">+</span>
<a href="#l93.3431"></a><span id="l93.3431" class="difflineplus">+    if (subscription) {</span>
<a href="#l93.3432"></a><span id="l93.3432">       buddy.subscription = subscription;</span>
<a href="#l93.3433"></a><span id="l93.3433" class="difflineplus">+    }</span>
<a href="#l93.3434"></a><span id="l93.3434">     if (!this._buddies.has(jid)) {</span>
<a href="#l93.3435"></a><span id="l93.3435">       this._buddies.set(jid, buddy);</span>
<a href="#l93.3436"></a><span id="l93.3436">       Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l93.3437"></a><span id="l93.3437" class="difflineplus">+    } else if (aNotifyOfUpdates) {</span>
<a href="#l93.3438"></a><span id="l93.3438" class="difflineplus">+      buddy._notifyObservers(&quot;status-detail-changed&quot;);</span>
<a href="#l93.3439"></a><span id="l93.3439">     }</span>
<a href="#l93.3440"></a><span id="l93.3440" class="difflineminus">-    else if (aNotifyOfUpdates)</span>
<a href="#l93.3441"></a><span id="l93.3441" class="difflineminus">-      buddy._notifyObservers(&quot;status-detail-changed&quot;);</span>
<a href="#l93.3442"></a><span id="l93.3442"> </span>
<a href="#l93.3443"></a><span id="l93.3443">     // Keep the xml nodes of the item so that we don't have to</span>
<a href="#l93.3444"></a><span id="l93.3444">     // recreate them when changing something (eg. the alias) in it.</span>
<a href="#l93.3445"></a><span id="l93.3445">     buddy._rosterItem = aItem;</span>
<a href="#l93.3446"></a><span id="l93.3446"> </span>
<a href="#l93.3447"></a><span id="l93.3447">     return jid;</span>
<a href="#l93.3448"></a><span id="l93.3448">   },</span>
<a href="#l93.3449"></a><span id="l93.3449">   _forgetRosterItem(aJID) {</span>
<a href="#l93.3450"></a><span id="l93.3450">     Services.contacts.accountBuddyRemoved(this._buddies.get(aJID));</span>
<a href="#l93.3451"></a><span id="l93.3451">     this._buddies.delete(aJID);</span>
<a href="#l93.3452"></a><span id="l93.3452">   },</span>
<a href="#l93.3453"></a><span id="l93.3453"> </span>
<a href="#l93.3454"></a><span id="l93.3454">   /* When the roster is received */</span>
<a href="#l93.3455"></a><span id="l93.3455">   onRoster(aStanza) {</span>
<a href="#l93.3456"></a><span id="l93.3456">     // For the first element that is a roster stanza.</span>
<a href="#l93.3457"></a><span id="l93.3457">     for (let qe of aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l93.3458"></a><span id="l93.3458" class="difflineminus">-      if (qe.uri != Stanza.NS.roster)</span>
<a href="#l93.3459"></a><span id="l93.3459" class="difflineplus">+      if (qe.uri != Stanza.NS.roster) {</span>
<a href="#l93.3460"></a><span id="l93.3460">         continue;</span>
<a href="#l93.3461"></a><span id="l93.3461" class="difflineplus">+      }</span>
<a href="#l93.3462"></a><span id="l93.3462"> </span>
<a href="#l93.3463"></a><span id="l93.3463">       // Find all the roster items in the new message.</span>
<a href="#l93.3464"></a><span id="l93.3464">       let newRoster = new Set();</span>
<a href="#l93.3465"></a><span id="l93.3465">       for (let item of qe.getChildren(&quot;item&quot;)) {</span>
<a href="#l93.3466"></a><span id="l93.3466">         let jid = this._onRosterItem(item);</span>
<a href="#l93.3467"></a><span id="l93.3467" class="difflineminus">-        if (jid)</span>
<a href="#l93.3468"></a><span id="l93.3468" class="difflineplus">+        if (jid) {</span>
<a href="#l93.3469"></a><span id="l93.3469">           newRoster.add(jid);</span>
<a href="#l93.3470"></a><span id="l93.3470" class="difflineplus">+        }</span>
<a href="#l93.3471"></a><span id="l93.3471">       }</span>
<a href="#l93.3472"></a><span id="l93.3472">       // If an item was in the old roster, but not in the new, forget it.</span>
<a href="#l93.3473"></a><span id="l93.3473">       for (let jid of this._buddies.keys()) {</span>
<a href="#l93.3474"></a><span id="l93.3474" class="difflineminus">-        if (!newRoster.has(jid))</span>
<a href="#l93.3475"></a><span id="l93.3475" class="difflineplus">+        if (!newRoster.has(jid)) {</span>
<a href="#l93.3476"></a><span id="l93.3476">           this._forgetRosterItem(jid);</span>
<a href="#l93.3477"></a><span id="l93.3477" class="difflineplus">+        }</span>
<a href="#l93.3478"></a><span id="l93.3478">       }</span>
<a href="#l93.3479"></a><span id="l93.3479">       break;</span>
<a href="#l93.3480"></a><span id="l93.3480">     }</span>
<a href="#l93.3481"></a><span id="l93.3481"> </span>
<a href="#l93.3482"></a><span id="l93.3482">     this._sendPresence();</span>
<a href="#l93.3483"></a><span id="l93.3483">     this._buddies.forEach(b =&gt; {</span>
<a href="#l93.3484"></a><span id="l93.3484" class="difflineminus">-      if (b.subscription == &quot;both&quot; || b.subscription == &quot;to&quot;)</span>
<a href="#l93.3485"></a><span id="l93.3485" class="difflineplus">+      if (b.subscription == &quot;both&quot; || b.subscription == &quot;to&quot;) {</span>
<a href="#l93.3486"></a><span id="l93.3486">         b.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l93.3487"></a><span id="l93.3487" class="difflineplus">+      }</span>
<a href="#l93.3488"></a><span id="l93.3488">     });</span>
<a href="#l93.3489"></a><span id="l93.3489">     this.reportConnected();</span>
<a href="#l93.3490"></a><span id="l93.3490">     this._sendVCard();</span>
<a href="#l93.3491"></a><span id="l93.3491">   },</span>
<a href="#l93.3492"></a><span id="l93.3492"> </span>
<a href="#l93.3493"></a><span id="l93.3493">   /* Public methods */</span>
<a href="#l93.3494"></a><span id="l93.3494"> </span>
<a href="#l93.3495"></a><span id="l93.3495">   sendStanza(aStanza, aCallback, aThis, aLogString) {</span>
<a href="#l93.3496"></a><span id="l93.3496" class="difflineat">@@ -2444,59 +2967,72 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.3497"></a><span id="l93.3497"> </span>
<a href="#l93.3498"></a><span id="l93.3498">   /* Create a new conversation */</span>
<a href="#l93.3499"></a><span id="l93.3499">   createConversation(aName) {</span>
<a href="#l93.3500"></a><span id="l93.3500">     let convName = this.normalize(aName);</span>
<a href="#l93.3501"></a><span id="l93.3501"> </span>
<a href="#l93.3502"></a><span id="l93.3502">     // Checks if conversation is with a participant of a MUC we are in. We do</span>
<a href="#l93.3503"></a><span id="l93.3503">     // not want to strip the resource as it is of the form room@domain/nick.</span>
<a href="#l93.3504"></a><span id="l93.3504">     let isMucParticipant = this._mucs.has(convName);</span>
<a href="#l93.3505"></a><span id="l93.3505" class="difflineminus">-    if (isMucParticipant)</span>
<a href="#l93.3506"></a><span id="l93.3506" class="difflineplus">+    if (isMucParticipant) {</span>
<a href="#l93.3507"></a><span id="l93.3507">       convName = this.normalizeFullJid(aName);</span>
<a href="#l93.3508"></a><span id="l93.3508" class="difflineplus">+    }</span>
<a href="#l93.3509"></a><span id="l93.3509"> </span>
<a href="#l93.3510"></a><span id="l93.3510">     // Checking that the aName can be parsed and is not broken.</span>
<a href="#l93.3511"></a><span id="l93.3511">     let jid = this._parseJID(convName);</span>
<a href="#l93.3512"></a><span id="l93.3512" class="difflineminus">-    if (!jid || !jid.domain || (isMucParticipant &amp;&amp; (!jid.node || !jid.resource))) {</span>
<a href="#l93.3513"></a><span id="l93.3513" class="difflineplus">+    if (</span>
<a href="#l93.3514"></a><span id="l93.3514" class="difflineplus">+      !jid ||</span>
<a href="#l93.3515"></a><span id="l93.3515" class="difflineplus">+      !jid.domain ||</span>
<a href="#l93.3516"></a><span id="l93.3516" class="difflineplus">+      (isMucParticipant &amp;&amp; (!jid.node || !jid.resource))</span>
<a href="#l93.3517"></a><span id="l93.3517" class="difflineplus">+    ) {</span>
<a href="#l93.3518"></a><span id="l93.3518">       this.ERROR(&quot;Could not create conversation as jid is broken: &quot; + convName);</span>
<a href="#l93.3519"></a><span id="l93.3519">       throw new Error(&quot;Invalid JID&quot;);</span>
<a href="#l93.3520"></a><span id="l93.3520">     }</span>
<a href="#l93.3521"></a><span id="l93.3521"> </span>
<a href="#l93.3522"></a><span id="l93.3522">     if (!this._conv.has(convName)) {</span>
<a href="#l93.3523"></a><span id="l93.3523" class="difflineminus">-      this._conv.set(convName,</span>
<a href="#l93.3524"></a><span id="l93.3524" class="difflineminus">-                     new this._conversationConstructor(this, convName,</span>
<a href="#l93.3525"></a><span id="l93.3525" class="difflineminus">-                                                       isMucParticipant));</span>
<a href="#l93.3526"></a><span id="l93.3526" class="difflineplus">+      this._conv.set(</span>
<a href="#l93.3527"></a><span id="l93.3527" class="difflineplus">+        convName,</span>
<a href="#l93.3528"></a><span id="l93.3528" class="difflineplus">+        new this._conversationConstructor(this, convName, isMucParticipant)</span>
<a href="#l93.3529"></a><span id="l93.3529" class="difflineplus">+      );</span>
<a href="#l93.3530"></a><span id="l93.3530">     }</span>
<a href="#l93.3531"></a><span id="l93.3531"> </span>
<a href="#l93.3532"></a><span id="l93.3532">     return this._conv.get(convName);</span>
<a href="#l93.3533"></a><span id="l93.3533">   },</span>
<a href="#l93.3534"></a><span id="l93.3534"> </span>
<a href="#l93.3535"></a><span id="l93.3535">   /* Remove an existing conversation */</span>
<a href="#l93.3536"></a><span id="l93.3536">   removeConversation(aNormalizedName) {</span>
<a href="#l93.3537"></a><span id="l93.3537" class="difflineminus">-    if (this._conv.has(aNormalizedName))</span>
<a href="#l93.3538"></a><span id="l93.3538" class="difflineplus">+    if (this._conv.has(aNormalizedName)) {</span>
<a href="#l93.3539"></a><span id="l93.3539">       this._conv.delete(aNormalizedName);</span>
<a href="#l93.3540"></a><span id="l93.3540" class="difflineminus">-    else if (this._mucs.has(aNormalizedName))</span>
<a href="#l93.3541"></a><span id="l93.3541" class="difflineplus">+    } else if (this._mucs.has(aNormalizedName)) {</span>
<a href="#l93.3542"></a><span id="l93.3542">       this._mucs.delete(aNormalizedName);</span>
<a href="#l93.3543"></a><span id="l93.3543" class="difflineplus">+    }</span>
<a href="#l93.3544"></a><span id="l93.3544">   },</span>
<a href="#l93.3545"></a><span id="l93.3545"> </span>
<a href="#l93.3546"></a><span id="l93.3546">   /* Private methods */</span>
<a href="#l93.3547"></a><span id="l93.3547"> </span>
<a href="#l93.3548"></a><span id="l93.3548">   /* Disconnect from the server */</span>
<a href="#l93.3549"></a><span id="l93.3549">   /* The aError and aErrorMessage parameters are passed to reportDisconnecting</span>
<a href="#l93.3550"></a><span id="l93.3550">    * and used by the account manager.</span>
<a href="#l93.3551"></a><span id="l93.3551">    * The aQuiet parameter is to avoid sending status change notifications</span>
<a href="#l93.3552"></a><span id="l93.3552">    * during the uninitialization of the account. */</span>
<a href="#l93.3553"></a><span id="l93.3553" class="difflineminus">-  _disconnect(aError = Ci.prplIAccount.NO_ERROR, aErrorMessage = &quot;&quot;, aQuiet = false) {</span>
<a href="#l93.3554"></a><span id="l93.3554" class="difflineminus">-    if (!this._connection)</span>
<a href="#l93.3555"></a><span id="l93.3555" class="difflineplus">+  _disconnect(</span>
<a href="#l93.3556"></a><span id="l93.3556" class="difflineplus">+    aError = Ci.prplIAccount.NO_ERROR,</span>
<a href="#l93.3557"></a><span id="l93.3557" class="difflineplus">+    aErrorMessage = &quot;&quot;,</span>
<a href="#l93.3558"></a><span id="l93.3558" class="difflineplus">+    aQuiet = false</span>
<a href="#l93.3559"></a><span id="l93.3559" class="difflineplus">+  ) {</span>
<a href="#l93.3560"></a><span id="l93.3560" class="difflineplus">+    if (!this._connection) {</span>
<a href="#l93.3561"></a><span id="l93.3561">       return;</span>
<a href="#l93.3562"></a><span id="l93.3562" class="difflineplus">+    }</span>
<a href="#l93.3563"></a><span id="l93.3563"> </span>
<a href="#l93.3564"></a><span id="l93.3564">     this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l93.3565"></a><span id="l93.3565"> </span>
<a href="#l93.3566"></a><span id="l93.3566">     this._buddies.forEach(b =&gt; {</span>
<a href="#l93.3567"></a><span id="l93.3567" class="difflineminus">-      if (!aQuiet)</span>
<a href="#l93.3568"></a><span id="l93.3568" class="difflineplus">+      if (!aQuiet) {</span>
<a href="#l93.3569"></a><span id="l93.3569">         b.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;);</span>
<a href="#l93.3570"></a><span id="l93.3570" class="difflineplus">+      }</span>
<a href="#l93.3571"></a><span id="l93.3571">       b.onAccountDisconnected();</span>
<a href="#l93.3572"></a><span id="l93.3572">     });</span>
<a href="#l93.3573"></a><span id="l93.3573"> </span>
<a href="#l93.3574"></a><span id="l93.3574">     this._mucs.forEach(muc =&gt; {</span>
<a href="#l93.3575"></a><span id="l93.3575">       muc.joining = false; // In case we never finished joining.</span>
<a href="#l93.3576"></a><span id="l93.3576">       muc.left = true;</span>
<a href="#l93.3577"></a><span id="l93.3577">     });</span>
<a href="#l93.3578"></a><span id="l93.3578"> </span>
<a href="#l93.3579"></a><span id="l93.3579" class="difflineat">@@ -2516,155 +3052,185 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.3580"></a><span id="l93.3580"> </span>
<a href="#l93.3581"></a><span id="l93.3581">     this.reportDisconnected();</span>
<a href="#l93.3582"></a><span id="l93.3582">   },</span>
<a href="#l93.3583"></a><span id="l93.3583"> </span>
<a href="#l93.3584"></a><span id="l93.3584">   /* Set the user status on the server */</span>
<a href="#l93.3585"></a><span id="l93.3585">   _sendPresence() {</span>
<a href="#l93.3586"></a><span id="l93.3586">     delete this._shouldSendPresenceForIdlenessChange;</span>
<a href="#l93.3587"></a><span id="l93.3587"> </span>
<a href="#l93.3588"></a><span id="l93.3588" class="difflineminus">-    if (!this._connection)</span>
<a href="#l93.3589"></a><span id="l93.3589" class="difflineplus">+    if (!this._connection) {</span>
<a href="#l93.3590"></a><span id="l93.3590">       return;</span>
<a href="#l93.3591"></a><span id="l93.3591" class="difflineplus">+    }</span>
<a href="#l93.3592"></a><span id="l93.3592"> </span>
<a href="#l93.3593"></a><span id="l93.3593">     let si = this.imAccount.statusInfo;</span>
<a href="#l93.3594"></a><span id="l93.3594">     let statusType = si.statusType;</span>
<a href="#l93.3595"></a><span id="l93.3595">     let show = &quot;&quot;;</span>
<a href="#l93.3596"></a><span id="l93.3596" class="difflineminus">-    if (statusType == Ci.imIStatusInfo.STATUS_UNAVAILABLE)</span>
<a href="#l93.3597"></a><span id="l93.3597" class="difflineplus">+    if (statusType == Ci.imIStatusInfo.STATUS_UNAVAILABLE) {</span>
<a href="#l93.3598"></a><span id="l93.3598">       show = &quot;dnd&quot;;</span>
<a href="#l93.3599"></a><span id="l93.3599" class="difflineminus">-    else if (statusType == Ci.imIStatusInfo.STATUS_AWAY ||</span>
<a href="#l93.3600"></a><span id="l93.3600" class="difflineminus">-             statusType == Ci.imIStatusInfo.STATUS_IDLE)</span>
<a href="#l93.3601"></a><span id="l93.3601" class="difflineplus">+    } else if (</span>
<a href="#l93.3602"></a><span id="l93.3602" class="difflineplus">+      statusType == Ci.imIStatusInfo.STATUS_AWAY ||</span>
<a href="#l93.3603"></a><span id="l93.3603" class="difflineplus">+      statusType == Ci.imIStatusInfo.STATUS_IDLE</span>
<a href="#l93.3604"></a><span id="l93.3604" class="difflineplus">+    ) {</span>
<a href="#l93.3605"></a><span id="l93.3605">       show = &quot;away&quot;;</span>
<a href="#l93.3606"></a><span id="l93.3606" class="difflineplus">+    }</span>
<a href="#l93.3607"></a><span id="l93.3607">     let children = [];</span>
<a href="#l93.3608"></a><span id="l93.3608" class="difflineminus">-    if (show)</span>
<a href="#l93.3609"></a><span id="l93.3609" class="difflineplus">+    if (show) {</span>
<a href="#l93.3610"></a><span id="l93.3610">       children.push(Stanza.node(&quot;show&quot;, null, null, show));</span>
<a href="#l93.3611"></a><span id="l93.3611" class="difflineplus">+    }</span>
<a href="#l93.3612"></a><span id="l93.3612">     let statusText = si.statusText;</span>
<a href="#l93.3613"></a><span id="l93.3613" class="difflineminus">-    if (statusText)</span>
<a href="#l93.3614"></a><span id="l93.3614" class="difflineplus">+    if (statusText) {</span>
<a href="#l93.3615"></a><span id="l93.3615">       children.push(Stanza.node(&quot;status&quot;, null, null, statusText));</span>
<a href="#l93.3616"></a><span id="l93.3616" class="difflineplus">+    }</span>
<a href="#l93.3617"></a><span id="l93.3617">     if (this._idleSince) {</span>
<a href="#l93.3618"></a><span id="l93.3618">       let time = Math.floor(Date.now() / 1000) - this._idleSince;</span>
<a href="#l93.3619"></a><span id="l93.3619" class="difflineminus">-      children.push(Stanza.node(&quot;query&quot;, Stanza.NS.last, {seconds: time}));</span>
<a href="#l93.3620"></a><span id="l93.3620" class="difflineplus">+      children.push(Stanza.node(&quot;query&quot;, Stanza.NS.last, { seconds: time }));</span>
<a href="#l93.3621"></a><span id="l93.3621">     }</span>
<a href="#l93.3622"></a><span id="l93.3622">     if (this.prefs.prefHasUserValue(&quot;priority&quot;)) {</span>
<a href="#l93.3623"></a><span id="l93.3623">       let priority = Math.max(-128, Math.min(127, this.getInt(&quot;priority&quot;)));</span>
<a href="#l93.3624"></a><span id="l93.3624" class="difflineminus">-      if (priority)</span>
<a href="#l93.3625"></a><span id="l93.3625" class="difflineplus">+      if (priority) {</span>
<a href="#l93.3626"></a><span id="l93.3626">         children.push(Stanza.node(&quot;priority&quot;, null, null, priority.toString()));</span>
<a href="#l93.3627"></a><span id="l93.3627" class="difflineplus">+      }</span>
<a href="#l93.3628"></a><span id="l93.3628">     }</span>
<a href="#l93.3629"></a><span id="l93.3629" class="difflineminus">-    this.sendStanza(Stanza.presence({&quot;xml:lang&quot;: &quot;en&quot;}, children), aStanza =&gt; {</span>
<a href="#l93.3630"></a><span id="l93.3630" class="difflineminus">-      // As we are implicitly subscribed to our own presence (rfc6121#4), we</span>
<a href="#l93.3631"></a><span id="l93.3631" class="difflineminus">-      // will receive the presence stanza mirrored back to us. We don't need</span>
<a href="#l93.3632"></a><span id="l93.3632" class="difflineminus">-      // to do anything with this response.</span>
<a href="#l93.3633"></a><span id="l93.3633" class="difflineminus">-      return true;</span>
<a href="#l93.3634"></a><span id="l93.3634" class="difflineminus">-    });</span>
<a href="#l93.3635"></a><span id="l93.3635" class="difflineplus">+    this.sendStanza(</span>
<a href="#l93.3636"></a><span id="l93.3636" class="difflineplus">+      Stanza.presence({ &quot;xml:lang&quot;: &quot;en&quot; }, children),</span>
<a href="#l93.3637"></a><span id="l93.3637" class="difflineplus">+      aStanza =&gt; {</span>
<a href="#l93.3638"></a><span id="l93.3638" class="difflineplus">+        // As we are implicitly subscribed to our own presence (rfc6121#4), we</span>
<a href="#l93.3639"></a><span id="l93.3639" class="difflineplus">+        // will receive the presence stanza mirrored back to us. We don't need</span>
<a href="#l93.3640"></a><span id="l93.3640" class="difflineplus">+        // to do anything with this response.</span>
<a href="#l93.3641"></a><span id="l93.3641" class="difflineplus">+        return true;</span>
<a href="#l93.3642"></a><span id="l93.3642" class="difflineplus">+      }</span>
<a href="#l93.3643"></a><span id="l93.3643" class="difflineplus">+    );</span>
<a href="#l93.3644"></a><span id="l93.3644">   },</span>
<a href="#l93.3645"></a><span id="l93.3645"> </span>
<a href="#l93.3646"></a><span id="l93.3646">   _downloadingUserVCard: false,</span>
<a href="#l93.3647"></a><span id="l93.3647">   _downloadUserVCard() {</span>
<a href="#l93.3648"></a><span id="l93.3648">     // If a download is already in progress, don't start another one.</span>
<a href="#l93.3649"></a><span id="l93.3649" class="difflineminus">-    if (this._downloadingUserVCard)</span>
<a href="#l93.3650"></a><span id="l93.3650" class="difflineplus">+    if (this._downloadingUserVCard) {</span>
<a href="#l93.3651"></a><span id="l93.3651">       return;</span>
<a href="#l93.3652"></a><span id="l93.3652" class="difflineplus">+    }</span>
<a href="#l93.3653"></a><span id="l93.3653">     this._downloadingUserVCard = true;</span>
<a href="#l93.3654"></a><span id="l93.3654" class="difflineminus">-    let s = Stanza.iq(&quot;get&quot;, null, null,</span>
<a href="#l93.3655"></a><span id="l93.3655" class="difflineminus">-                      Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l93.3656"></a><span id="l93.3656" class="difflineplus">+    let s = Stanza.iq(&quot;get&quot;, null, null, Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l93.3657"></a><span id="l93.3657">     this.sendStanza(s, this.onUserVCard, this);</span>
<a href="#l93.3658"></a><span id="l93.3658">   },</span>
<a href="#l93.3659"></a><span id="l93.3659"> </span>
<a href="#l93.3660"></a><span id="l93.3660">   onUserVCard(aStanza) {</span>
<a href="#l93.3661"></a><span id="l93.3661">     delete this._downloadingUserVCard;</span>
<a href="#l93.3662"></a><span id="l93.3662">     let userVCard = aStanza.getElement([&quot;vCard&quot;]) || null;</span>
<a href="#l93.3663"></a><span id="l93.3663">     if (userVCard) {</span>
<a href="#l93.3664"></a><span id="l93.3664">       // Strip any server-specific namespace off the incoming vcard</span>
<a href="#l93.3665"></a><span id="l93.3665">       // before storing it.</span>
<a href="#l93.3666"></a><span id="l93.3666" class="difflineminus">-      this._userVCard =</span>
<a href="#l93.3667"></a><span id="l93.3667" class="difflineminus">-        Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard, null, userVCard.children);</span>
<a href="#l93.3668"></a><span id="l93.3668" class="difflineplus">+      this._userVCard = Stanza.node(</span>
<a href="#l93.3669"></a><span id="l93.3669" class="difflineplus">+        &quot;vCard&quot;,</span>
<a href="#l93.3670"></a><span id="l93.3670" class="difflineplus">+        Stanza.NS.vcard,</span>
<a href="#l93.3671"></a><span id="l93.3671" class="difflineplus">+        null,</span>
<a href="#l93.3672"></a><span id="l93.3672" class="difflineplus">+        userVCard.children</span>
<a href="#l93.3673"></a><span id="l93.3673" class="difflineplus">+      );</span>
<a href="#l93.3674"></a><span id="l93.3674">     }</span>
<a href="#l93.3675"></a><span id="l93.3675"> </span>
<a href="#l93.3676"></a><span id="l93.3676">     // If a user icon exists in the vCard we received from the server,</span>
<a href="#l93.3677"></a><span id="l93.3677">     // we need to ensure the line breaks in its binval are exactly the</span>
<a href="#l93.3678"></a><span id="l93.3678">     // same as those we would include if we sent the icon, and that</span>
<a href="#l93.3679"></a><span id="l93.3679">     // there isn't any other whitespace.</span>
<a href="#l93.3680"></a><span id="l93.3680">     if (this._userVCard) {</span>
<a href="#l93.3681"></a><span id="l93.3681">       let binval = this._userVCard.getElement([&quot;PHOTO&quot;, &quot;BINVAL&quot;]);</span>
<a href="#l93.3682"></a><span id="l93.3682">       if (binval &amp;&amp; binval.children.length) {</span>
<a href="#l93.3683"></a><span id="l93.3683">         binval = binval.children[0];</span>
<a href="#l93.3684"></a><span id="l93.3684" class="difflineminus">-        binval.text = binval.text.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;)</span>
<a href="#l93.3685"></a><span id="l93.3685" class="difflineminus">-                                 .replace(/.{74}/g, &quot;$&amp;\n&quot;);</span>
<a href="#l93.3686"></a><span id="l93.3686" class="difflineplus">+        binval.text = binval.text</span>
<a href="#l93.3687"></a><span id="l93.3687" class="difflineplus">+          .replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;)</span>
<a href="#l93.3688"></a><span id="l93.3688" class="difflineplus">+          .replace(/.{74}/g, &quot;$&amp;\n&quot;);</span>
<a href="#l93.3689"></a><span id="l93.3689">       }</span>
<a href="#l93.3690"></a><span id="l93.3690" class="difflineminus">-    }</span>
<a href="#l93.3691"></a><span id="l93.3691" class="difflineminus">-    else {</span>
<a href="#l93.3692"></a><span id="l93.3692" class="difflineplus">+    } else {</span>
<a href="#l93.3693"></a><span id="l93.3693">       // Downloading the vCard failed.</span>
<a href="#l93.3694"></a><span id="l93.3694" class="difflineminus">-      if (this.handleErrors({</span>
<a href="#l93.3695"></a><span id="l93.3695" class="difflineminus">-          itemNotFound: () =&gt; false,  // OK, no vCard exists yet.</span>
<a href="#l93.3696"></a><span id="l93.3696" class="difflineplus">+      if (</span>
<a href="#l93.3697"></a><span id="l93.3697" class="difflineplus">+        this.handleErrors({</span>
<a href="#l93.3698"></a><span id="l93.3698" class="difflineplus">+          itemNotFound: () =&gt; false, // OK, no vCard exists yet.</span>
<a href="#l93.3699"></a><span id="l93.3699">           default: () =&gt; true,</span>
<a href="#l93.3700"></a><span id="l93.3700" class="difflineminus">-        })(aStanza)) {</span>
<a href="#l93.3701"></a><span id="l93.3701" class="difflineminus">-        this.WARN(&quot;Unexpected error retrieving the user's vcard, &quot; +</span>
<a href="#l93.3702"></a><span id="l93.3702" class="difflineminus">-          &quot;so we won't attempt to set it either.&quot;);</span>
<a href="#l93.3703"></a><span id="l93.3703" class="difflineplus">+        })(aStanza)</span>
<a href="#l93.3704"></a><span id="l93.3704" class="difflineplus">+      ) {</span>
<a href="#l93.3705"></a><span id="l93.3705" class="difflineplus">+        this.WARN(</span>
<a href="#l93.3706"></a><span id="l93.3706" class="difflineplus">+          &quot;Unexpected error retrieving the user's vcard, &quot; +</span>
<a href="#l93.3707"></a><span id="l93.3707" class="difflineplus">+            &quot;so we won't attempt to set it either.&quot;</span>
<a href="#l93.3708"></a><span id="l93.3708" class="difflineplus">+        );</span>
<a href="#l93.3709"></a><span id="l93.3709">         return;</span>
<a href="#l93.3710"></a><span id="l93.3710">       }</span>
<a href="#l93.3711"></a><span id="l93.3711">       // Set this so that we don't get into an infinite loop trying to download</span>
<a href="#l93.3712"></a><span id="l93.3712">       // the vcard again. The check in sendVCard is for hasOwnProperty.</span>
<a href="#l93.3713"></a><span id="l93.3713">       this._userVCard = null;</span>
<a href="#l93.3714"></a><span id="l93.3714">     }</span>
<a href="#l93.3715"></a><span id="l93.3715">     this._sendVCard();</span>
<a href="#l93.3716"></a><span id="l93.3716">   },</span>
<a href="#l93.3717"></a><span id="l93.3717"> </span>
<a href="#l93.3718"></a><span id="l93.3718">   _cachingUserIcon: false,</span>
<a href="#l93.3719"></a><span id="l93.3719">   _cacheUserIcon() {</span>
<a href="#l93.3720"></a><span id="l93.3720" class="difflineminus">-    if (this._cachingUserIcon)</span>
<a href="#l93.3721"></a><span id="l93.3721" class="difflineplus">+    if (this._cachingUserIcon) {</span>
<a href="#l93.3722"></a><span id="l93.3722">       return;</span>
<a href="#l93.3723"></a><span id="l93.3723" class="difflineplus">+    }</span>
<a href="#l93.3724"></a><span id="l93.3724"> </span>
<a href="#l93.3725"></a><span id="l93.3725">     let userIcon = this.imAccount.statusInfo.getUserIcon();</span>
<a href="#l93.3726"></a><span id="l93.3726">     if (!userIcon) {</span>
<a href="#l93.3727"></a><span id="l93.3727">       this._cachedUserIcon = null;</span>
<a href="#l93.3728"></a><span id="l93.3728">       this._sendVCard();</span>
<a href="#l93.3729"></a><span id="l93.3729">       return;</span>
<a href="#l93.3730"></a><span id="l93.3730">     }</span>
<a href="#l93.3731"></a><span id="l93.3731"> </span>
<a href="#l93.3732"></a><span id="l93.3732">     this._cachingUserIcon = true;</span>
<a href="#l93.3733"></a><span id="l93.3733">     let channel = NetUtil.newChannel({</span>
<a href="#l93.3734"></a><span id="l93.3734">       uri: userIcon,</span>
<a href="#l93.3735"></a><span id="l93.3735">       loadingPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l93.3736"></a><span id="l93.3736">       securityFlags: Ci.nsILoadInfo.SEC_REQUIRE_SAME_ORIGIN_DATA_INHERITS,</span>
<a href="#l93.3737"></a><span id="l93.3737">       contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l93.3738"></a><span id="l93.3738">     });</span>
<a href="#l93.3739"></a><span id="l93.3739">     NetUtil.asyncFetch(channel, (inputStream, resultCode) =&gt; {</span>
<a href="#l93.3740"></a><span id="l93.3740" class="difflineminus">-      if (!Components.isSuccessCode(resultCode))</span>
<a href="#l93.3741"></a><span id="l93.3741" class="difflineplus">+      if (!Components.isSuccessCode(resultCode)) {</span>
<a href="#l93.3742"></a><span id="l93.3742">         return;</span>
<a href="#l93.3743"></a><span id="l93.3743" class="difflineplus">+      }</span>
<a href="#l93.3744"></a><span id="l93.3744">       try {</span>
<a href="#l93.3745"></a><span id="l93.3745">         let type = channel.contentType;</span>
<a href="#l93.3746"></a><span id="l93.3746" class="difflineminus">-        let buffer = NetUtil.readInputStreamToString(inputStream, inputStream.available());</span>
<a href="#l93.3747"></a><span id="l93.3747" class="difflineminus">-        let readImage = imgTools.decodeImageFromBuffer(buffer, buffer.length, type);</span>
<a href="#l93.3748"></a><span id="l93.3748" class="difflineplus">+        let buffer = NetUtil.readInputStreamToString(</span>
<a href="#l93.3749"></a><span id="l93.3749" class="difflineplus">+          inputStream,</span>
<a href="#l93.3750"></a><span id="l93.3750" class="difflineplus">+          inputStream.available()</span>
<a href="#l93.3751"></a><span id="l93.3751" class="difflineplus">+        );</span>
<a href="#l93.3752"></a><span id="l93.3752" class="difflineplus">+        let readImage = imgTools.decodeImageFromBuffer(</span>
<a href="#l93.3753"></a><span id="l93.3753" class="difflineplus">+          buffer,</span>
<a href="#l93.3754"></a><span id="l93.3754" class="difflineplus">+          buffer.length,</span>
<a href="#l93.3755"></a><span id="l93.3755" class="difflineplus">+          type</span>
<a href="#l93.3756"></a><span id="l93.3756" class="difflineplus">+        );</span>
<a href="#l93.3757"></a><span id="l93.3757">         let scaledImage;</span>
<a href="#l93.3758"></a><span id="l93.3758" class="difflineminus">-        if (readImage.width &lt;= 96 &amp;&amp; readImage.height &lt;= 96)</span>
<a href="#l93.3759"></a><span id="l93.3759" class="difflineplus">+        if (readImage.width &lt;= 96 &amp;&amp; readImage.height &lt;= 96) {</span>
<a href="#l93.3760"></a><span id="l93.3760">           scaledImage = imgTools.encodeImage(readImage, type);</span>
<a href="#l93.3761"></a><span id="l93.3761" class="difflineminus">-        else {</span>
<a href="#l93.3762"></a><span id="l93.3762" class="difflineminus">-          if (type != &quot;image/jpeg&quot;)</span>
<a href="#l93.3763"></a><span id="l93.3763" class="difflineplus">+        } else {</span>
<a href="#l93.3764"></a><span id="l93.3764" class="difflineplus">+          if (type != &quot;image/jpeg&quot;) {</span>
<a href="#l93.3765"></a><span id="l93.3765">             type = &quot;image/png&quot;;</span>
<a href="#l93.3766"></a><span id="l93.3766" class="difflineplus">+          }</span>
<a href="#l93.3767"></a><span id="l93.3767">           scaledImage = imgTools.encodeScaledImage(readImage, type, 64, 64);</span>
<a href="#l93.3768"></a><span id="l93.3768">         }</span>
<a href="#l93.3769"></a><span id="l93.3769"> </span>
<a href="#l93.3770"></a><span id="l93.3770" class="difflineminus">-        let bstream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l93.3771"></a><span id="l93.3771" class="difflineminus">-                        .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l93.3772"></a><span id="l93.3772" class="difflineplus">+        let bstream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;].createInstance(</span>
<a href="#l93.3773"></a><span id="l93.3773" class="difflineplus">+          Ci.nsIBinaryInputStream</span>
<a href="#l93.3774"></a><span id="l93.3774" class="difflineplus">+        );</span>
<a href="#l93.3775"></a><span id="l93.3775">         bstream.setInputStream(scaledImage);</span>
<a href="#l93.3776"></a><span id="l93.3776"> </span>
<a href="#l93.3777"></a><span id="l93.3777">         let data = bstream.readBytes(bstream.available());</span>
<a href="#l93.3778"></a><span id="l93.3778">         this._cachedUserIcon = {</span>
<a href="#l93.3779"></a><span id="l93.3779">           type,</span>
<a href="#l93.3780"></a><span id="l93.3780">           binval: btoa(data).replace(/.{74}/g, &quot;$&amp;\n&quot;),</span>
<a href="#l93.3781"></a><span id="l93.3781">         };</span>
<a href="#l93.3782"></a><span id="l93.3782">       } catch (e) {</span>
<a href="#l93.3783"></a><span id="l93.3783">         Cu.reportError(e);</span>
<a href="#l93.3784"></a><span id="l93.3784">         this._cachedUserIcon = null;</span>
<a href="#l93.3785"></a><span id="l93.3785">       }</span>
<a href="#l93.3786"></a><span id="l93.3786">       delete this._cachingUserIcon;</span>
<a href="#l93.3787"></a><span id="l93.3787">       this._sendVCard();</span>
<a href="#l93.3788"></a><span id="l93.3788">     });</span>
<a href="#l93.3789"></a><span id="l93.3789">   },</span>
<a href="#l93.3790"></a><span id="l93.3790">   _sendVCard() {</span>
<a href="#l93.3791"></a><span id="l93.3791" class="difflineminus">-    if (!this._connection)</span>
<a href="#l93.3792"></a><span id="l93.3792" class="difflineplus">+    if (!this._connection) {</span>
<a href="#l93.3793"></a><span id="l93.3793">       return;</span>
<a href="#l93.3794"></a><span id="l93.3794" class="difflineplus">+    }</span>
<a href="#l93.3795"></a><span id="l93.3795"> </span>
<a href="#l93.3796"></a><span id="l93.3796">     // We have to download the user's existing vCard before updating it.</span>
<a href="#l93.3797"></a><span id="l93.3797">     // This lets us preserve the fields that we don't change or don't know.</span>
<a href="#l93.3798"></a><span id="l93.3798">     // Some servers may reject a new vCard if we don't do this first.</span>
<a href="#l93.3799"></a><span id="l93.3799">     if (!this.hasOwnProperty(&quot;_userVCard&quot;)) {</span>
<a href="#l93.3800"></a><span id="l93.3800">       // The download of the vCard is asynchronous and will call _sendVCard back</span>
<a href="#l93.3801"></a><span id="l93.3801">       // when the user's vCard has been received.</span>
<a href="#l93.3802"></a><span id="l93.3802">       this._downloadUserVCard();</span>
<a href="#l93.3803"></a><span id="l93.3803" class="difflineat">@@ -2675,74 +3241,88 @@ var XMPPAccountPrototype = {</span>
<a href="#l93.3804"></a><span id="l93.3804">     // _cacheUserIcon will call _sendVCard back once the icon is ready.</span>
<a href="#l93.3805"></a><span id="l93.3805">     if (!this.hasOwnProperty(&quot;_cachedUserIcon&quot;)) {</span>
<a href="#l93.3806"></a><span id="l93.3806">       this._cacheUserIcon();</span>
<a href="#l93.3807"></a><span id="l93.3807">       return;</span>
<a href="#l93.3808"></a><span id="l93.3808">     }</span>
<a href="#l93.3809"></a><span id="l93.3809"> </span>
<a href="#l93.3810"></a><span id="l93.3810">     // If the user currently doesn't have any vCard on the server or</span>
<a href="#l93.3811"></a><span id="l93.3811">     // the download failed, an empty new one.</span>
<a href="#l93.3812"></a><span id="l93.3812" class="difflineminus">-    if (!this._userVCard)</span>
<a href="#l93.3813"></a><span id="l93.3813" class="difflineplus">+    if (!this._userVCard) {</span>
<a href="#l93.3814"></a><span id="l93.3814">       this._userVCard = Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard);</span>
<a href="#l93.3815"></a><span id="l93.3815" class="difflineplus">+    }</span>
<a href="#l93.3816"></a><span id="l93.3816"> </span>
<a href="#l93.3817"></a><span id="l93.3817">     // Keep a serialized copy of the existing user vCard so that we</span>
<a href="#l93.3818"></a><span id="l93.3818">     // can avoid resending identical data to the server.</span>
<a href="#l93.3819"></a><span id="l93.3819">     let existingVCard = this._userVCard.getXML();</span>
<a href="#l93.3820"></a><span id="l93.3820"> </span>
<a href="#l93.3821"></a><span id="l93.3821">     let fn = this._userVCard.getElement([&quot;FN&quot;]);</span>
<a href="#l93.3822"></a><span id="l93.3822">     let displayName = this.imAccount.statusInfo.displayName;</span>
<a href="#l93.3823"></a><span id="l93.3823">     if (displayName) {</span>
<a href="#l93.3824"></a><span id="l93.3824">       // If a display name is set locally, update or add an FN field to the vCard.</span>
<a href="#l93.3825"></a><span id="l93.3825" class="difflineminus">-      if (!fn)</span>
<a href="#l93.3826"></a><span id="l93.3826" class="difflineminus">-        this._userVCard.addChild(Stanza.node(&quot;FN&quot;, Stanza.NS.vcard, null, displayName));</span>
<a href="#l93.3827"></a><span id="l93.3827" class="difflineminus">-      else if (fn.children.length)</span>
<a href="#l93.3828"></a><span id="l93.3828" class="difflineplus">+      if (!fn) {</span>
<a href="#l93.3829"></a><span id="l93.3829" class="difflineplus">+        this._userVCard.addChild(</span>
<a href="#l93.3830"></a><span id="l93.3830" class="difflineplus">+          Stanza.node(&quot;FN&quot;, Stanza.NS.vcard, null, displayName)</span>
<a href="#l93.3831"></a><span id="l93.3831" class="difflineplus">+        );</span>
<a href="#l93.3832"></a><span id="l93.3832" class="difflineplus">+      } else if (fn.children.length) {</span>
<a href="#l93.3833"></a><span id="l93.3833">         fn.children[0].text = displayName;</span>
<a href="#l93.3834"></a><span id="l93.3834" class="difflineminus">-      else</span>
<a href="#l93.3835"></a><span id="l93.3835" class="difflineplus">+      } else {</span>
<a href="#l93.3836"></a><span id="l93.3836">         fn.addText(displayName);</span>
<a href="#l93.3837"></a><span id="l93.3837" class="difflineminus">-    }</span>
<a href="#l93.3838"></a><span id="l93.3838" class="difflineminus">-    else if (&quot;_forceUserDisplayNameUpdate&quot; in this) {</span>
<a href="#l93.3839"></a><span id="l93.3839" class="difflineplus">+      }</span>
<a href="#l93.3840"></a><span id="l93.3840" class="difflineplus">+    } else if (&quot;_forceUserDisplayNameUpdate&quot; in this) {</span>
<a href="#l93.3841"></a><span id="l93.3841">       // We remove a display name stored on the server without replacing</span>
<a href="#l93.3842"></a><span id="l93.3842">       // it with a new value only if this _sendVCard call is the result of</span>
<a href="#l93.3843"></a><span id="l93.3843">       // a user action. This is to avoid removing data from the server each</span>
<a href="#l93.3844"></a><span id="l93.3844">       // time the user connects from a new profile.</span>
<a href="#l93.3845"></a><span id="l93.3845" class="difflineminus">-      this._userVCard.children =</span>
<a href="#l93.3846"></a><span id="l93.3846" class="difflineminus">-        this._userVCard.children.filter(n =&gt; n.qName != &quot;FN&quot;);</span>
<a href="#l93.3847"></a><span id="l93.3847" class="difflineplus">+      this._userVCard.children = this._userVCard.children.filter(</span>
<a href="#l93.3848"></a><span id="l93.3848" class="difflineplus">+        n =&gt; n.qName != &quot;FN&quot;</span>
<a href="#l93.3849"></a><span id="l93.3849" class="difflineplus">+      );</span>
<a href="#l93.3850"></a><span id="l93.3850">     }</span>
<a href="#l93.3851"></a><span id="l93.3851">     delete this._forceUserDisplayNameUpdate;</span>
<a href="#l93.3852"></a><span id="l93.3852"> </span>
<a href="#l93.3853"></a><span id="l93.3853">     if (this._cachedUserIcon) {</span>
<a href="#l93.3854"></a><span id="l93.3854">       // If we have a local user icon, update or add it in the PHOTO field.</span>
<a href="#l93.3855"></a><span id="l93.3855">       let photoChildren = [</span>
<a href="#l93.3856"></a><span id="l93.3856">         Stanza.node(&quot;TYPE&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.type),</span>
<a href="#l93.3857"></a><span id="l93.3857" class="difflineminus">-        Stanza.node(&quot;BINVAL&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.binval),</span>
<a href="#l93.3858"></a><span id="l93.3858" class="difflineplus">+        Stanza.node(</span>
<a href="#l93.3859"></a><span id="l93.3859" class="difflineplus">+          &quot;BINVAL&quot;,</span>
<a href="#l93.3860"></a><span id="l93.3860" class="difflineplus">+          Stanza.NS.vcard,</span>
<a href="#l93.3861"></a><span id="l93.3861" class="difflineplus">+          null,</span>
<a href="#l93.3862"></a><span id="l93.3862" class="difflineplus">+          this._cachedUserIcon.binval</span>
<a href="#l93.3863"></a><span id="l93.3863" class="difflineplus">+        ),</span>
<a href="#l93.3864"></a><span id="l93.3864">       ];</span>
<a href="#l93.3865"></a><span id="l93.3865">       let photo = this._userVCard.getElement([&quot;PHOTO&quot;]);</span>
<a href="#l93.3866"></a><span id="l93.3866" class="difflineminus">-      if (photo)</span>
<a href="#l93.3867"></a><span id="l93.3867" class="difflineplus">+      if (photo) {</span>
<a href="#l93.3868"></a><span id="l93.3868">         photo.children = photoChildren;</span>
<a href="#l93.3869"></a><span id="l93.3869" class="difflineminus">-      else</span>
<a href="#l93.3870"></a><span id="l93.3870" class="difflineminus">-        this._userVCard.addChild(Stanza.node(&quot;PHOTO&quot;, Stanza.NS.vcard, null,</span>
<a href="#l93.3871"></a><span id="l93.3871" class="difflineminus">-                                             photoChildren));</span>
<a href="#l93.3872"></a><span id="l93.3872" class="difflineminus">-    }</span>
<a href="#l93.3873"></a><span id="l93.3873" class="difflineminus">-    else if (&quot;_forceUserIconUpdate&quot; in this) {</span>
<a href="#l93.3874"></a><span id="l93.3874" class="difflineplus">+      } else {</span>
<a href="#l93.3875"></a><span id="l93.3875" class="difflineplus">+        this._userVCard.addChild(</span>
<a href="#l93.3876"></a><span id="l93.3876" class="difflineplus">+          Stanza.node(&quot;PHOTO&quot;, Stanza.NS.vcard, null, photoChildren)</span>
<a href="#l93.3877"></a><span id="l93.3877" class="difflineplus">+        );</span>
<a href="#l93.3878"></a><span id="l93.3878" class="difflineplus">+      }</span>
<a href="#l93.3879"></a><span id="l93.3879" class="difflineplus">+    } else if (&quot;_forceUserIconUpdate&quot; in this) {</span>
<a href="#l93.3880"></a><span id="l93.3880">       // Like for the display name, we remove a photo without</span>
<a href="#l93.3881"></a><span id="l93.3881">       // replacing it only if the call is caused by a user action.</span>
<a href="#l93.3882"></a><span id="l93.3882" class="difflineminus">-      this._userVCard.children =</span>
<a href="#l93.3883"></a><span id="l93.3883" class="difflineminus">-        this._userVCard.children.filter(n =&gt; n.qName != &quot;PHOTO&quot;);</span>
<a href="#l93.3884"></a><span id="l93.3884" class="difflineplus">+      this._userVCard.children = this._userVCard.children.filter(</span>
<a href="#l93.3885"></a><span id="l93.3885" class="difflineplus">+        n =&gt; n.qName != &quot;PHOTO&quot;</span>
<a href="#l93.3886"></a><span id="l93.3886" class="difflineplus">+      );</span>
<a href="#l93.3887"></a><span id="l93.3887">     }</span>
<a href="#l93.3888"></a><span id="l93.3888">     delete this._forceUserIconUpdate;</span>
<a href="#l93.3889"></a><span id="l93.3889"> </span>
<a href="#l93.3890"></a><span id="l93.3890">     // Send the vCard only if it has really changed.</span>
<a href="#l93.3891"></a><span id="l93.3891">     // We handle the result response from the server (it does not require</span>
<a href="#l93.3892"></a><span id="l93.3892">     // any further action).</span>
<a href="#l93.3893"></a><span id="l93.3893">     if (this._userVCard.getXML() != existingVCard) {</span>
<a href="#l93.3894"></a><span id="l93.3894" class="difflineminus">-      this.sendStanza(Stanza.iq(&quot;set&quot;, null, null, this._userVCard),</span>
<a href="#l93.3895"></a><span id="l93.3895" class="difflineminus">-                      this._handleResult());</span>
<a href="#l93.3896"></a><span id="l93.3896" class="difflineplus">+      this.sendStanza(</span>
<a href="#l93.3897"></a><span id="l93.3897" class="difflineplus">+        Stanza.iq(&quot;set&quot;, null, null, this._userVCard),</span>
<a href="#l93.3898"></a><span id="l93.3898" class="difflineplus">+        this._handleResult()</span>
<a href="#l93.3899"></a><span id="l93.3899" class="difflineplus">+      );</span>
<a href="#l93.3900"></a><span id="l93.3900" class="difflineplus">+    } else {</span>
<a href="#l93.3901"></a><span id="l93.3901" class="difflineplus">+      this.LOG(</span>
<a href="#l93.3902"></a><span id="l93.3902" class="difflineplus">+        &quot;Not sending the vCard because the server stored vCard is identical.&quot;</span>
<a href="#l93.3903"></a><span id="l93.3903" class="difflineplus">+      );</span>
<a href="#l93.3904"></a><span id="l93.3904">     }</span>
<a href="#l93.3905"></a><span id="l93.3905" class="difflineminus">-    else</span>
<a href="#l93.3906"></a><span id="l93.3906" class="difflineminus">-      this.LOG(&quot;Not sending the vCard because the server stored vCard is identical.&quot;);</span>
<a href="#l93.3907"></a><span id="l93.3907">   },</span>
<a href="#l93.3908"></a><span id="l93.3908"> };</span>
<a href="#l93.3909"></a><span id="l93.3909" class="difflineminus">-function XMPPAccount(aProtocol, aImAccount)</span>
<a href="#l93.3910"></a><span id="l93.3910" class="difflineminus">-{</span>
<a href="#l93.3911"></a><span id="l93.3911" class="difflineplus">+function XMPPAccount(aProtocol, aImAccount) {</span>
<a href="#l93.3912"></a><span id="l93.3912">   this._pendingVCardRequests = [];</span>
<a href="#l93.3913"></a><span id="l93.3913">   this._init(aProtocol, aImAccount);</span>
<a href="#l93.3914"></a><span id="l93.3914"> }</span>
<a href="#l93.3915"></a><span id="l93.3915"> XMPPAccount.prototype = XMPPAccountPrototype;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -25,36 +25,47 @@ var {</span>
<a href="#l94.4"></a><span id="l94.4">   Message,</span>
<a href="#l94.5"></a><span id="l94.5">   TooltipInfo,</span>
<a href="#l94.6"></a><span id="l94.6"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l94.7"></a><span id="l94.7"> </span>
<a href="#l94.8"></a><span id="l94.8"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l94.9"></a><span id="l94.9">   l10nHelper(&quot;chrome://chat/locale/yahoo.properties&quot;)</span>
<a href="#l94.10"></a><span id="l94.10"> );</span>
<a href="#l94.11"></a><span id="l94.11"> </span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-function YahooAccount(aProtoInstance, aImAccount)</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineminus">-{</span>
<a href="#l94.14"></a><span id="l94.14" class="difflineplus">+function YahooAccount(aProtoInstance, aImAccount) {</span>
<a href="#l94.15"></a><span id="l94.15">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l94.16"></a><span id="l94.16"> }</span>
<a href="#l94.17"></a><span id="l94.17"> YahooAccount.prototype = {</span>
<a href="#l94.18"></a><span id="l94.18">   __proto__: GenericAccountPrototype,</span>
<a href="#l94.19"></a><span id="l94.19"> </span>
<a href="#l94.20"></a><span id="l94.20">   connect() {</span>
<a href="#l94.21"></a><span id="l94.21" class="difflineminus">-    this.WARN(&quot;The legacy versions of Yahoo Messenger was disabled on August &quot; +</span>
<a href="#l94.22"></a><span id="l94.22" class="difflineminus">-              &quot;5, 2016. It is currently not possible to connect to Yahoo &quot; +</span>
<a href="#l94.23"></a><span id="l94.23" class="difflineminus">-              &quot;Messenger. See bug 1316000&quot;);</span>
<a href="#l94.24"></a><span id="l94.24" class="difflineminus">-    this.reportDisconnecting(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l94.25"></a><span id="l94.25" class="difflineminus">-                             _(&quot;yahoo.disabled&quot;));</span>
<a href="#l94.26"></a><span id="l94.26" class="difflineplus">+    this.WARN(</span>
<a href="#l94.27"></a><span id="l94.27" class="difflineplus">+      &quot;The legacy versions of Yahoo Messenger was disabled on August &quot; +</span>
<a href="#l94.28"></a><span id="l94.28" class="difflineplus">+        &quot;5, 2016. It is currently not possible to connect to Yahoo &quot; +</span>
<a href="#l94.29"></a><span id="l94.29" class="difflineplus">+        &quot;Messenger. See bug 1316000&quot;</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineplus">+    );</span>
<a href="#l94.31"></a><span id="l94.31" class="difflineplus">+    this.reportDisconnecting(</span>
<a href="#l94.32"></a><span id="l94.32" class="difflineplus">+      Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l94.33"></a><span id="l94.33" class="difflineplus">+      _(&quot;yahoo.disabled&quot;)</span>
<a href="#l94.34"></a><span id="l94.34" class="difflineplus">+    );</span>
<a href="#l94.35"></a><span id="l94.35">     this.reportDisconnected();</span>
<a href="#l94.36"></a><span id="l94.36">   },</span>
<a href="#l94.37"></a><span id="l94.37"> };</span>
<a href="#l94.38"></a><span id="l94.38"> </span>
<a href="#l94.39"></a><span id="l94.39"> function YahooProtocol() {}</span>
<a href="#l94.40"></a><span id="l94.40"> YahooProtocol.prototype = {</span>
<a href="#l94.41"></a><span id="l94.41">   __proto__: GenericProtocolPrototype,</span>
<a href="#l94.42"></a><span id="l94.42" class="difflineminus">-  get id() { return &quot;prpl-yahoo&quot;; },</span>
<a href="#l94.43"></a><span id="l94.43" class="difflineminus">-  get name() { return &quot;Yahoo&quot;; },</span>
<a href="#l94.44"></a><span id="l94.44" class="difflineminus">-  get iconBaseURI() { return &quot;chrome://prpl-yahoo/skin/&quot;; },</span>
<a href="#l94.45"></a><span id="l94.45" class="difflineminus">-  getAccount(aImAccount) { return new YahooAccount(this, aImAccount); },</span>
<a href="#l94.46"></a><span id="l94.46" class="difflineplus">+  get id() {</span>
<a href="#l94.47"></a><span id="l94.47" class="difflineplus">+    return &quot;prpl-yahoo&quot;;</span>
<a href="#l94.48"></a><span id="l94.48" class="difflineplus">+  },</span>
<a href="#l94.49"></a><span id="l94.49" class="difflineplus">+  get name() {</span>
<a href="#l94.50"></a><span id="l94.50" class="difflineplus">+    return &quot;Yahoo&quot;;</span>
<a href="#l94.51"></a><span id="l94.51" class="difflineplus">+  },</span>
<a href="#l94.52"></a><span id="l94.52" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l94.53"></a><span id="l94.53" class="difflineplus">+    return &quot;chrome://prpl-yahoo/skin/&quot;;</span>
<a href="#l94.54"></a><span id="l94.54" class="difflineplus">+  },</span>
<a href="#l94.55"></a><span id="l94.55" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l94.56"></a><span id="l94.56" class="difflineplus">+    return new YahooAccount(this, aImAccount);</span>
<a href="#l94.57"></a><span id="l94.57" class="difflineplus">+  },</span>
<a href="#l94.58"></a><span id="l94.58">   classID: Components.ID(&quot;{50ea817e-5d79-4657-91ae-aa0a52bdb98c}&quot;),</span>
<a href="#l94.59"></a><span id="l94.59"> };</span>
<a href="#l94.60"></a><span id="l94.60"> </span>
<a href="#l94.61"></a><span id="l94.61"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([YahooProtocol]);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

