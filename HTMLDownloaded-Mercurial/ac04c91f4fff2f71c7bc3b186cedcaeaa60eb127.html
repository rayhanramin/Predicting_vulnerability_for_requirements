<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26646:ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127" />
<meta property="og:url" content="/comm-central/rev/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/base/src (part 4). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127">shortlog</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127">files</a> |
changeset |
<a href="/comm-central/raw-rev/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127">raw</a>  | <a href="/comm-central/archive/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 4). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 19 May 2019 22:22:21 +0200</td></tr>

<tr>
 <td>changeset 26646</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127">ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127</a></td>
</tr>



<tr>
<td>parent 26645</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bd8dc610ca345b54fa024a7160c12788a006c024">bd8dc610ca345b54fa024a7160c12788a006c024</a>
</td>
</tr>

<tr>
<td>child 26647</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/aa46c393d41f395b07246e19250fb3ce46c6c323">aa46c393d41f395b07246e19250fb3ce46c6c323</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127">15935</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 19 May 2019 20:52:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@aa46c393d41f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=aa46c393d41f395b07246e19250fb3ce46c6c323">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=aa46c393d41f395b07246e19250fb3ce46c6c323&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=aa46c393d41f395b07246e19250fb3ce46c6c323&newProject=comm-central&newRevision=6b97e6f65af806a8f1d9b316ceba376a575064d0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=aa46c393d41f395b07246e19250fb3ce46c6c323&newProject=comm-central&newRevision=6b97e6f65af806a8f1d9b316ceba376a575064d0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=aa46c393d41f395b07246e19250fb3ce46c6c323&newProject=comm-central&newRevision=6b97e6f65af806a8f1d9b316ceba376a575064d0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 4). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.cpp">mailnews/base/src/nsMsgFolderCache.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.h">mailnews/base/src/nsMsgFolderCache.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCache.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.cpp">mailnews/base/src/nsMsgFolderCacheElement.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.h">mailnews/base/src/nsMsgFolderCacheElement.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCacheElement.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.h">mailnews/base/src/nsMsgFolderCompactor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderCompactor.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.cpp">mailnews/base/src/nsMsgFolderNotificationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.h">mailnews/base/src/nsMsgFolderNotificationService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgFolderNotificationService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.cpp">mailnews/base/src/nsMsgGroupThread.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.h">mailnews/base/src/nsMsgGroupThread.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupThread.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.cpp">mailnews/base/src/nsMsgGroupView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.h">mailnews/base/src/nsMsgGroupView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgGroupView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.cpp">mailnews/base/src/nsMsgMailSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.h">mailnews/base/src/nsMsgMailSession.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgMailSession.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.cpp">mailnews/base/src/nsMsgOfflineManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.h">mailnews/base/src/nsMsgOfflineManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgOfflineManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.cpp">mailnews/base/src/nsMsgPrintEngine.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.h">mailnews/base/src/nsMsgPrintEngine.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPrintEngine.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.cpp">mailnews/base/src/nsMsgProgress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.h">mailnews/base/src/nsMsgProgress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgProgress.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.cpp">mailnews/base/src/nsMsgPurgeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.h">mailnews/base/src/nsMsgPurgeService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgPurgeService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.cpp">mailnews/base/src/nsMsgQuickSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.h">mailnews/base/src/nsMsgQuickSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgQuickSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.cpp">mailnews/base/src/nsMsgRDFUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.cpp">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.cpp">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.cpp">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.cpp">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.h">mailnews/base/src/nsMsgRDFUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.h">file</a> |
<a href="/comm-central/annotate/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.h">annotate</a> |
<a href="/comm-central/diff/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.h">diff</a> |
<a href="/comm-central/comparison/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.h">comparison</a> |
<a href="/comm-central/log/ac04c91f4fff2f71c7bc3b186cedcaeaa60eb127/mailnews/base/src/nsMsgRDFUtils.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCache.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCache.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -7,373 +7,330 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsMsgFolderCacheElement.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsMsgFolderCache.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsMorkCID.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsIMdbFactoryFactory.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-const char *kFoldersScope = &quot;ns:msg:db:row:scope:folders:all&quot;;  // scope for all folders table</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+const char *kFoldersScope =</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    &quot;ns:msg:db:row:scope:folders:all&quot;;  // scope for all folders table</span>
<a href="#l1.15"></a><span id="l1.15"> const char *kFoldersTableKind = &quot;ns:msg:db:table:kind:folders&quot;;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-nsMsgFolderCache::nsMsgFolderCache()</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-{</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+nsMsgFolderCache::nsMsgFolderCache() {</span>
<a href="#l1.20"></a><span id="l1.20">   m_mdbEnv = nullptr;</span>
<a href="#l1.21"></a><span id="l1.21">   m_mdbStore = nullptr;</span>
<a href="#l1.22"></a><span id="l1.22">   m_mdbAllFoldersTable = nullptr;</span>
<a href="#l1.23"></a><span id="l1.23"> }</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> // should this, could this be an nsCOMPtr ?</span>
<a href="#l1.26"></a><span id="l1.26"> static nsIMdbFactory *gMDBFactory = nullptr;</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-nsMsgFolderCache::~nsMsgFolderCache()</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-{</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  m_cacheElements.Clear(); // make sure the folder cache elements are released before we release our m_mdb objects...</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  if (m_mdbAllFoldersTable)</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    m_mdbAllFoldersTable-&gt;Release();</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  if (m_mdbStore)</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    m_mdbStore-&gt;Release();</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+nsMsgFolderCache::~nsMsgFolderCache() {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  // Make sure the folder cache elements are released before we</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  // release our m_mdb objects.</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  m_cacheElements.Clear();</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  if (m_mdbAllFoldersTable) m_mdbAllFoldersTable-&gt;Release();</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  if (m_mdbStore) m_mdbStore-&gt;Release();</span>
<a href="#l1.41"></a><span id="l1.41">   NS_IF_RELEASE(gMDBFactory);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  if (m_mdbEnv)</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    m_mdbEnv-&gt;Release();</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  if (m_mdbEnv) m_mdbEnv-&gt;Release();</span>
<a href="#l1.45"></a><span id="l1.45"> }</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-</span>
<a href="#l1.48"></a><span id="l1.48"> NS_IMPL_ISUPPORTS(nsMsgFolderCache, nsIMsgFolderCache)</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-nsresult nsMsgFolderCache::GetMDBFactory(nsIMdbFactory ** aMdbFactory)</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-{</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  if (!mMdbFactory)</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-  {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+nsresult nsMsgFolderCache::GetMDBFactory(nsIMdbFactory **aMdbFactory) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  if (!mMdbFactory) {</span>
<a href="#l1.56"></a><span id="l1.56">     nsresult rv;</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-    nsCOMPtr &lt;nsIMdbFactoryService&gt; mdbFactoryService = do_GetService(NS_MORK_CONTRACTID, &amp;rv);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    nsCOMPtr&lt;nsIMdbFactoryService&gt; mdbFactoryService =</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+        do_GetService(NS_MORK_CONTRACTID, &amp;rv);</span>
<a href="#l1.60"></a><span id="l1.60">     if (NS_SUCCEEDED(rv) &amp;&amp; mdbFactoryService) {</span>
<a href="#l1.61"></a><span id="l1.61">       rv = mdbFactoryService-&gt;GetMdbFactory(getter_AddRefs(mMdbFactory));</span>
<a href="#l1.62"></a><span id="l1.62">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-      if (!mMdbFactory)</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+      if (!mMdbFactory) return NS_ERROR_FAILURE;</span>
<a href="#l1.66"></a><span id="l1.66">     }</span>
<a href="#l1.67"></a><span id="l1.67">   }</span>
<a href="#l1.68"></a><span id="l1.68">   NS_ADDREF(*aMdbFactory = mMdbFactory);</span>
<a href="#l1.69"></a><span id="l1.69">   return NS_OK;</span>
<a href="#l1.70"></a><span id="l1.70"> }</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72"> // initialize the various tokens and tables in our db's env</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-nsresult nsMsgFolderCache::InitMDBInfo()</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-{</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+nsresult nsMsgFolderCache::InitMDBInfo() {</span>
<a href="#l1.76"></a><span id="l1.76">   nsresult err = NS_OK;</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  if (GetStore())</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-    err = GetStore()-&gt;StringToToken(GetEnv(), kFoldersScope, &amp;m_folderRowScopeToken);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-    {</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-      err = GetStore()-&gt;StringToToken(GetEnv(), kFoldersTableKind, &amp;m_folderTableKindToken);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-      if (NS_SUCCEEDED(err))</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-      {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  if (GetStore()) {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    err = GetStore()-&gt;StringToToken(GetEnv(), kFoldersScope,</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+                                    &amp;m_folderRowScopeToken);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kFoldersTableKind,</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+                                      &amp;m_folderTableKindToken);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+      if (NS_SUCCEEDED(err)) {</span>
<a href="#l1.92"></a><span id="l1.92">         // The table of all message hdrs will have table id 1.</span>
<a href="#l1.93"></a><span id="l1.93">         m_allFoldersTableOID.mOid_Scope = m_folderRowScopeToken;</span>
<a href="#l1.94"></a><span id="l1.94">         m_allFoldersTableOID.mOid_Id = 1;</span>
<a href="#l1.95"></a><span id="l1.95">       }</span>
<a href="#l1.96"></a><span id="l1.96">     }</span>
<a href="#l1.97"></a><span id="l1.97">   }</span>
<a href="#l1.98"></a><span id="l1.98">   return err;</span>
<a href="#l1.99"></a><span id="l1.99"> }</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101"> // set up empty tables, dbFolderInfo, etc.</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-nsresult nsMsgFolderCache::InitNewDB()</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-{</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+nsresult nsMsgFolderCache::InitNewDB() {</span>
<a href="#l1.105"></a><span id="l1.105">   nsresult err = InitMDBInfo();</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-  {</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l1.109"></a><span id="l1.109">     nsIMdbStore *store = GetStore();</span>
<a href="#l1.110"></a><span id="l1.110">     // create the unique table for the dbFolderInfo.</span>
<a href="#l1.111"></a><span id="l1.111">     // TODO: this error assignment is suspicious and never checked.</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-    (void) store-&gt;NewTable(GetEnv(), m_folderRowScopeToken, m_folderTableKindToken,</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-                           false, nullptr, &amp;m_mdbAllFoldersTable);</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+    (void)store-&gt;NewTable(GetEnv(), m_folderRowScopeToken,</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+                          m_folderTableKindToken, false, nullptr,</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+                          &amp;m_mdbAllFoldersTable);</span>
<a href="#l1.117"></a><span id="l1.117">   }</span>
<a href="#l1.118"></a><span id="l1.118">   return err;</span>
<a href="#l1.119"></a><span id="l1.119"> }</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-nsresult nsMsgFolderCache::InitExistingDB()</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-{</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+nsresult nsMsgFolderCache::InitExistingDB() {</span>
<a href="#l1.124"></a><span id="l1.124">   nsresult err = InitMDBInfo();</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    return err;</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  if (NS_FAILED(err)) return err;</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-  err = GetStore()-&gt;GetTable(GetEnv(), &amp;m_allFoldersTableOID, &amp;m_mdbAllFoldersTable);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; m_mdbAllFoldersTable)</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-    nsIMdbTableRowCursor* rowCursor = nullptr;</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+  err = GetStore()-&gt;GetTable(GetEnv(), &amp;m_allFoldersTableOID,</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+                             &amp;m_mdbAllFoldersTable);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; m_mdbAllFoldersTable) {</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    nsIMdbTableRowCursor *rowCursor = nullptr;</span>
<a href="#l1.137"></a><span id="l1.137">     err = m_mdbAllFoldersTable-&gt;GetTableRowCursor(GetEnv(), -1, &amp;rowCursor);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; rowCursor)</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    {</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-      // iterate over the table rows and create nsMsgFolderCacheElements for each.</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-      while (true)</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-      {</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; rowCursor) {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+      // iterate over the table rows and create nsMsgFolderCacheElements for</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+      // each.</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+      while (true) {</span>
<a href="#l1.147"></a><span id="l1.147">         nsresult rv;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-        nsIMdbRow* hdrRow;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+        nsIMdbRow *hdrRow;</span>
<a href="#l1.150"></a><span id="l1.150">         mdb_pos rowPos;</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152">         rv = rowCursor-&gt;NextRow(GetEnv(), &amp;hdrRow, &amp;rowPos);</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-        if (NS_FAILED(rv) || !hdrRow)</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-          break;</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+        if (NS_FAILED(rv) || !hdrRow) break;</span>
<a href="#l1.156"></a><span id="l1.156"> </span>
<a href="#l1.157"></a><span id="l1.157">         rv = AddCacheElement(EmptyCString(), hdrRow, nullptr);</span>
<a href="#l1.158"></a><span id="l1.158">         hdrRow-&gt;Release();</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-          return rv;</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.162"></a><span id="l1.162">       }</span>
<a href="#l1.163"></a><span id="l1.163">       rowCursor-&gt;Release();</span>
<a href="#l1.164"></a><span id="l1.164">     }</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-  }</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-  else</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+  } else</span>
<a href="#l1.168"></a><span id="l1.168">     err = NS_ERROR_FAILURE;</span>
<a href="#l1.169"></a><span id="l1.169"> </span>
<a href="#l1.170"></a><span id="l1.170">   return err;</span>
<a href="#l1.171"></a><span id="l1.171"> }</span>
<a href="#l1.172"></a><span id="l1.172"> </span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-nsresult nsMsgFolderCache::OpenMDB(const PathString&amp; dbName, bool exists)</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-{</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+nsresult nsMsgFolderCache::OpenMDB(const PathString &amp;dbName, bool exists) {</span>
<a href="#l1.176"></a><span id="l1.176">   nsCOMPtr&lt;nsIMdbFactory&gt; mdbFactory;</span>
<a href="#l1.177"></a><span id="l1.177">   nsresult ret = GetMDBFactory(getter_AddRefs(mdbFactory));</span>
<a href="#l1.178"></a><span id="l1.178">   NS_ENSURE_SUCCESS(ret, ret);</span>
<a href="#l1.179"></a><span id="l1.179"> </span>
<a href="#l1.180"></a><span id="l1.180">   ret = mdbFactory-&gt;MakeEnv(nullptr, &amp;m_mdbEnv);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-  if (NS_SUCCEEDED(ret))</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-  {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+  if (NS_SUCCEEDED(ret)) {</span>
<a href="#l1.184"></a><span id="l1.184">     nsIMdbThumb *thumb = nullptr;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-    nsIMdbHeap* dbHeap = nullptr;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+    nsIMdbHeap *dbHeap = nullptr;</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-    if (m_mdbEnv)</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-      m_mdbEnv-&gt;SetAutoClear(true);</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-    if (exists)</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-    {</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+    if (m_mdbEnv) m_mdbEnv-&gt;SetAutoClear(true);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+    if (exists) {</span>
<a href="#l1.194"></a><span id="l1.194">       mdbOpenPolicy inOpenPolicy;</span>
<a href="#l1.195"></a><span id="l1.195">       mdb_bool canOpen;</span>
<a href="#l1.196"></a><span id="l1.196">       mdbYarn outFormatVersion;</span>
<a href="#l1.197"></a><span id="l1.197"> </span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-      nsIMdbFile* oldFile = nullptr;</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-      ret = mdbFactory-&gt;OpenOldFile(m_mdbEnv, dbHeap, dbName.get(),</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-                                    mdbBool_kFalse, // not readonly, we want modifiable</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-                                    &amp;oldFile);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-      if ( oldFile )</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-      {</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-        if (NS_SUCCEEDED(ret))</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-        {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-          ret = mdbFactory-&gt;CanOpenFilePort(m_mdbEnv, oldFile, // file to investigate</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-            &amp;canOpen, &amp;outFormatVersion);</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-          if (NS_SUCCEEDED(ret) &amp;&amp; canOpen)</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-          {</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+      nsIMdbFile *oldFile = nullptr;</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+      ret = mdbFactory-&gt;OpenOldFile(</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+          m_mdbEnv, dbHeap, dbName.get(),</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+          mdbBool_kFalse,  // not readonly, we want modifiable</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+          &amp;oldFile);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+      if (oldFile) {</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+        if (NS_SUCCEEDED(ret)) {</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+          ret = mdbFactory-&gt;CanOpenFilePort(m_mdbEnv,</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+                                            oldFile,  // file to investigate</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+                                            &amp;canOpen, &amp;outFormatVersion);</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+          if (NS_SUCCEEDED(ret) &amp;&amp; canOpen) {</span>
<a href="#l1.221"></a><span id="l1.221">             inOpenPolicy.mOpenPolicy_ScopePlan.mScopeStringSet_Count = 0;</span>
<a href="#l1.222"></a><span id="l1.222">             inOpenPolicy.mOpenPolicy_MinMemory = 0;</span>
<a href="#l1.223"></a><span id="l1.223">             inOpenPolicy.mOpenPolicy_MaxLazy = 0;</span>
<a href="#l1.224"></a><span id="l1.224"> </span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-            ret = mdbFactory-&gt;OpenFileStore(m_mdbEnv, NULL, oldFile, &amp;inOpenPolicy,</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-              &amp;thumb);</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-          }</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-          else</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+            ret = mdbFactory-&gt;OpenFileStore(m_mdbEnv, NULL, oldFile,</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+                                            &amp;inOpenPolicy, &amp;thumb);</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+          } else</span>
<a href="#l1.232"></a><span id="l1.232">             ret = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l1.233"></a><span id="l1.233">         }</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-        NS_RELEASE(oldFile); // always release our file ref, store has own</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+        NS_RELEASE(oldFile);  // always release our file ref, store has own</span>
<a href="#l1.236"></a><span id="l1.236">       }</span>
<a href="#l1.237"></a><span id="l1.237">     }</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-    if (NS_SUCCEEDED(ret) &amp;&amp; thumb)</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-    {</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-      mdb_count outTotal;    // total somethings to do in operation</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-      mdb_count outCurrent;  // subportion of total completed so far</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-      mdb_bool outDone = false;      // is operation finished?</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-      mdb_bool outBroken;     // is operation irreparably dead and broken?</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-      do</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-      {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-        ret = thumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone, &amp;outBroken);</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-        if (NS_FAILED(ret))</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-        {</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+    if (NS_SUCCEEDED(ret) &amp;&amp; thumb) {</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+      mdb_count outTotal;        // total somethings to do in operation</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+      mdb_count outCurrent;      // subportion of total completed so far</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+      mdb_bool outDone = false;  // is operation finished?</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      mdb_bool outBroken;        // is operation irreparably dead and broken?</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+      do {</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+        ret = thumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone,</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+                            &amp;outBroken);</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+        if (NS_FAILED(ret)) {</span>
<a href="#l1.258"></a><span id="l1.258">           outDone = true;</span>
<a href="#l1.259"></a><span id="l1.259">           break;</span>
<a href="#l1.260"></a><span id="l1.260">         }</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-      }</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-      while (NS_SUCCEEDED(ret) &amp;&amp; !outBroken &amp;&amp; !outDone);</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+      } while (NS_SUCCEEDED(ret) &amp;&amp; !outBroken &amp;&amp; !outDone);</span>
<a href="#l1.264"></a><span id="l1.264">       // m_mdbEnv-&gt;ClearErrors(); // ### temporary...</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-      if (NS_SUCCEEDED(ret) &amp;&amp; outDone)</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-      {</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+      if (NS_SUCCEEDED(ret) &amp;&amp; outDone) {</span>
<a href="#l1.268"></a><span id="l1.268">         ret = mdbFactory-&gt;ThumbToOpenStore(m_mdbEnv, thumb, &amp;m_mdbStore);</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-        if (NS_SUCCEEDED(ret) &amp;&amp; m_mdbStore)</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-          ret = InitExistingDB();</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+        if (NS_SUCCEEDED(ret) &amp;&amp; m_mdbStore) ret = InitExistingDB();</span>
<a href="#l1.272"></a><span id="l1.272">       }</span>
<a href="#l1.273"></a><span id="l1.273"> #ifdef DEBUG_bienvenu1</span>
<a href="#l1.274"></a><span id="l1.274">       DumpContents();</span>
<a href="#l1.275"></a><span id="l1.275"> #endif</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-    }</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-    else // ### need error code saying why open file store failed</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-    {</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-      nsIMdbFile* newFile = 0;</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+    } else {  // ### need error code saying why open file store failed</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+      nsIMdbFile *newFile = 0;</span>
<a href="#l1.282"></a><span id="l1.282">       ret = mdbFactory-&gt;CreateNewFile(m_mdbEnv, dbHeap, dbName.get(), &amp;newFile);</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-      if ( newFile )</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-      {</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-        if (NS_SUCCEEDED(ret))</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-        {</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+      if (newFile) {</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+        if (NS_SUCCEEDED(ret)) {</span>
<a href="#l1.289"></a><span id="l1.289">           mdbOpenPolicy inOpenPolicy;</span>
<a href="#l1.290"></a><span id="l1.290"> </span>
<a href="#l1.291"></a><span id="l1.291">           inOpenPolicy.mOpenPolicy_ScopePlan.mScopeStringSet_Count = 0;</span>
<a href="#l1.292"></a><span id="l1.292">           inOpenPolicy.mOpenPolicy_MinMemory = 0;</span>
<a href="#l1.293"></a><span id="l1.293">           inOpenPolicy.mOpenPolicy_MaxLazy = 0;</span>
<a href="#l1.294"></a><span id="l1.294"> </span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-          ret = mdbFactory-&gt;CreateNewFileStore(m_mdbEnv, dbHeap,</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-            newFile, &amp;inOpenPolicy, &amp;m_mdbStore);</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-          if (NS_SUCCEEDED(ret))</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-            ret = InitNewDB();</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+          ret = mdbFactory-&gt;CreateNewFileStore(m_mdbEnv, dbHeap, newFile,</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+                                               &amp;inOpenPolicy, &amp;m_mdbStore);</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+          if (NS_SUCCEEDED(ret)) ret = InitNewDB();</span>
<a href="#l1.302"></a><span id="l1.302">         }</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-        NS_RELEASE(newFile); // always release our file ref, store has own</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+        NS_RELEASE(newFile);  // always release our file ref, store has own</span>
<a href="#l1.305"></a><span id="l1.305">       }</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-</span>
<a href="#l1.307"></a><span id="l1.307">     }</span>
<a href="#l1.308"></a><span id="l1.308">     NS_IF_RELEASE(thumb);</span>
<a href="#l1.309"></a><span id="l1.309">   }</span>
<a href="#l1.310"></a><span id="l1.310"> </span>
<a href="#l1.311"></a><span id="l1.311">   return ret;</span>
<a href="#l1.312"></a><span id="l1.312"> }</span>
<a href="#l1.313"></a><span id="l1.313"> </span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCache::Init(nsIFile *aFile)</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-{</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCache::Init(nsIFile *aFile) {</span>
<a href="#l1.317"></a><span id="l1.317">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l1.318"></a><span id="l1.318"> </span>
<a href="#l1.319"></a><span id="l1.319">   bool exists;</span>
<a href="#l1.320"></a><span id="l1.320">   aFile-&gt;Exists(&amp;exists);</span>
<a href="#l1.321"></a><span id="l1.321"> </span>
<a href="#l1.322"></a><span id="l1.322">   PathString dbPath = aFile-&gt;NativePath();</span>
<a href="#l1.323"></a><span id="l1.323">   // ### evil cast until MDB supports file streams.</span>
<a href="#l1.324"></a><span id="l1.324">   nsresult rv = OpenMDB(dbPath, exists);</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-  // if this fails and panacea.dat exists, try blowing away the db and recreating it</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; exists)</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-  {</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-    if (m_mdbStore)</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-      m_mdbStore-&gt;Release();</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+  // if this fails and panacea.dat exists, try blowing away the db and</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+  // recreating it</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; exists) {</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+    if (m_mdbStore) m_mdbStore-&gt;Release();</span>
<a href="#l1.334"></a><span id="l1.334">     aFile-&gt;Remove(false);</span>
<a href="#l1.335"></a><span id="l1.335">     rv = OpenMDB(dbPath, false);</span>
<a href="#l1.336"></a><span id="l1.336">   }</span>
<a href="#l1.337"></a><span id="l1.337">   return rv;</span>
<a href="#l1.338"></a><span id="l1.338"> }</span>
<a href="#l1.339"></a><span id="l1.339"> </span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCache::GetCacheElement(const nsACString&amp; pathKey, bool createIfMissing,</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-                                                nsIMsgFolderCacheElement **result)</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-{</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCache::GetCacheElement(</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+    const nsACString &amp;pathKey, bool createIfMissing,</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+    nsIMsgFolderCacheElement **result) {</span>
<a href="#l1.346"></a><span id="l1.346">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l1.347"></a><span id="l1.347">   NS_ENSURE_TRUE(!pathKey.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l1.348"></a><span id="l1.348"> </span>
<a href="#l1.349"></a><span id="l1.349">   nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; folderCacheEl;</span>
<a href="#l1.350"></a><span id="l1.350">   m_cacheElements.Get(pathKey, getter_AddRefs(folderCacheEl));</span>
<a href="#l1.351"></a><span id="l1.351">   folderCacheEl.forget(result);</span>
<a href="#l1.352"></a><span id="l1.352"> </span>
<a href="#l1.353"></a><span id="l1.353">   if (*result)</span>
<a href="#l1.354"></a><span id="l1.354">     return NS_OK;</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-  else if (createIfMissing)</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-  {</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-    nsIMdbRow* hdrRow;</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+  else if (createIfMissing) {</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+    nsIMdbRow *hdrRow;</span>
<a href="#l1.360"></a><span id="l1.360"> </span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-    if (GetStore())</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-    {</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-      nsresult err = GetStore()-&gt;NewRow(GetEnv(), m_folderRowScopeToken, // row scope for row ids</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-        &amp;hdrRow);</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-      if (NS_SUCCEEDED(err) &amp;&amp; hdrRow)</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-      {</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+    if (GetStore()) {</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+      nsresult err = GetStore()-&gt;NewRow(</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+          GetEnv(), m_folderRowScopeToken,  // row scope for row ids</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+          &amp;hdrRow);</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+      if (NS_SUCCEEDED(err) &amp;&amp; hdrRow) {</span>
<a href="#l1.372"></a><span id="l1.372">         m_mdbAllFoldersTable-&gt;AddRow(GetEnv(), hdrRow);</span>
<a href="#l1.373"></a><span id="l1.373">         nsresult ret = AddCacheElement(pathKey, hdrRow, result);</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-        if (*result)</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-          (*result)-&gt;SetStringProperty(&quot;key&quot;, pathKey);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineplus">+        if (*result) (*result)-&gt;SetStringProperty(&quot;key&quot;, pathKey);</span>
<a href="#l1.377"></a><span id="l1.377">         hdrRow-&gt;Release();</span>
<a href="#l1.378"></a><span id="l1.378">         return ret;</span>
<a href="#l1.379"></a><span id="l1.379">       }</span>
<a href="#l1.380"></a><span id="l1.380">     }</span>
<a href="#l1.381"></a><span id="l1.381">   }</span>
<a href="#l1.382"></a><span id="l1.382">   return NS_ERROR_FAILURE;</span>
<a href="#l1.383"></a><span id="l1.383"> }</span>
<a href="#l1.384"></a><span id="l1.384"> </span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCache::RemoveElement(const nsACString&amp; key)</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-{</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCache::RemoveElement(const nsACString &amp;key) {</span>
<a href="#l1.388"></a><span id="l1.388">   nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; folderCacheEl;</span>
<a href="#l1.389"></a><span id="l1.389">   m_cacheElements.Get(key, getter_AddRefs(folderCacheEl));</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-  if (!folderCacheEl)</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-  nsMsgFolderCacheElement *element = static_cast&lt;nsMsgFolderCacheElement *&gt;(static_cast&lt;nsISupports *&gt;(folderCacheEl.get())); // why the double cast??</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+  if (!folderCacheEl) return NS_ERROR_FAILURE;</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+  nsMsgFolderCacheElement *element =</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+      static_cast&lt;nsMsgFolderCacheElement *&gt;(static_cast&lt;nsISupports *&gt;(</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+          folderCacheEl.get()));  // why the double cast??</span>
<a href="#l1.397"></a><span id="l1.397">   m_mdbAllFoldersTable-&gt;CutRow(GetEnv(), element-&gt;m_mdbRow);</span>
<a href="#l1.398"></a><span id="l1.398">   m_cacheElements.Remove(key);</span>
<a href="#l1.399"></a><span id="l1.399">   return NS_OK;</span>
<a href="#l1.400"></a><span id="l1.400"> }</span>
<a href="#l1.401"></a><span id="l1.401"> </span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCache::Clear()</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-{</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCache::Clear() {</span>
<a href="#l1.405"></a><span id="l1.405">   m_cacheElements.Clear();</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-  if (m_mdbAllFoldersTable)</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-    m_mdbAllFoldersTable-&gt;CutAllRows(GetEnv());</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+  if (m_mdbAllFoldersTable) m_mdbAllFoldersTable-&gt;CutAllRows(GetEnv());</span>
<a href="#l1.409"></a><span id="l1.409">   return NS_OK;</span>
<a href="#l1.410"></a><span id="l1.410"> }</span>
<a href="#l1.411"></a><span id="l1.411"> </span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCache::Close()</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineminus">-{</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-  return Commit(true);</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-}</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCache::Close() { return Commit(true); }</span>
<a href="#l1.417"></a><span id="l1.417"> </span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCache::Commit(bool compress)</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-{</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCache::Commit(bool compress) {</span>
<a href="#l1.421"></a><span id="l1.421">   nsresult ret = NS_OK;</span>
<a href="#l1.422"></a><span id="l1.422">   nsIMdbThumb *commitThumb = nullptr;</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-  if (m_mdbStore)</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-  {</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+  if (m_mdbStore) {</span>
<a href="#l1.426"></a><span id="l1.426">     if (compress)</span>
<a href="#l1.427"></a><span id="l1.427">       ret = m_mdbStore-&gt;CompressCommit(GetEnv(), &amp;commitThumb);</span>
<a href="#l1.428"></a><span id="l1.428">     else</span>
<a href="#l1.429"></a><span id="l1.429">       ret = m_mdbStore-&gt;LargeCommit(GetEnv(), &amp;commitThumb);</span>
<a href="#l1.430"></a><span id="l1.430">   }</span>
<a href="#l1.431"></a><span id="l1.431"> </span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">-  if (commitThumb)</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-  {</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-    mdb_count outTotal = 0;    // total somethings to do in operation</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-    mdb_count outCurrent = 0;  // subportion of total completed so far</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-    mdb_bool outDone = false;      // is operation finished?</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-    mdb_bool outBroken = false;     // is operation irreparably dead and broken?</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+  if (commitThumb) {</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+    mdb_count outTotal = 0;      // total somethings to do in operation</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineplus">+    mdb_count outCurrent = 0;    // subportion of total completed so far</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+    mdb_bool outDone = false;    // is operation finished?</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+    mdb_bool outBroken = false;  // is operation irreparably dead and broken?</span>
<a href="#l1.443"></a><span id="l1.443">     while (!outDone &amp;&amp; !outBroken &amp;&amp; NS_SUCCEEDED(ret))</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-      ret = commitThumb-&gt;DoMore(GetEnv(), &amp;outTotal, &amp;outCurrent, &amp;outDone, &amp;outBroken);</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+      ret = commitThumb-&gt;DoMore(GetEnv(), &amp;outTotal, &amp;outCurrent, &amp;outDone,</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+                                &amp;outBroken);</span>
<a href="#l1.447"></a><span id="l1.447">     NS_IF_RELEASE(commitThumb);</span>
<a href="#l1.448"></a><span id="l1.448">   }</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-  // ### do something with error, but clear it now because mork errors out on commits.</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-  if (GetEnv())</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-    GetEnv()-&gt;ClearErrors();</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+  // ### do something with error, but clear it now because mork errors out on</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+  // commits.</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+  if (GetEnv()) GetEnv()-&gt;ClearErrors();</span>
<a href="#l1.455"></a><span id="l1.455">   return ret;</span>
<a href="#l1.456"></a><span id="l1.456"> }</span>
<a href="#l1.457"></a><span id="l1.457"> </span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">-nsresult nsMsgFolderCache::AddCacheElement(const nsACString&amp; key, nsIMdbRow *row, nsIMsgFolderCacheElement **result)</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineminus">-{</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+nsresult nsMsgFolderCache::AddCacheElement(const nsACString &amp;key,</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+                                           nsIMdbRow *row,</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+                                           nsIMsgFolderCacheElement **result) {</span>
<a href="#l1.463"></a><span id="l1.463">   nsMsgFolderCacheElement *cacheElement = new nsMsgFolderCacheElement;</span>
<a href="#l1.464"></a><span id="l1.464">   NS_ENSURE_TRUE(cacheElement, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l1.465"></a><span id="l1.465">   nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; folderCacheEl = cacheElement;</span>
<a href="#l1.466"></a><span id="l1.466"> </span>
<a href="#l1.467"></a><span id="l1.467">   cacheElement-&gt;SetMDBRow(row);</span>
<a href="#l1.468"></a><span id="l1.468">   cacheElement-&gt;SetOwningCache(this);</span>
<a href="#l1.469"></a><span id="l1.469">   nsCString hashStrKey(key);</span>
<a href="#l1.470"></a><span id="l1.470">   // if caller didn't pass in key, try to get it from row.</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-  if (key.IsEmpty())</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineminus">-    folderCacheEl-&gt;GetStringProperty(&quot;key&quot;, hashStrKey);</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+  if (key.IsEmpty()) folderCacheEl-&gt;GetStringProperty(&quot;key&quot;, hashStrKey);</span>
<a href="#l1.474"></a><span id="l1.474">   folderCacheEl-&gt;SetKey(hashStrKey);</span>
<a href="#l1.475"></a><span id="l1.475">   m_cacheElements.Put(hashStrKey, folderCacheEl);</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-  if (result)</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-    folderCacheEl.forget(result);</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+  if (result) folderCacheEl.forget(result);</span>
<a href="#l1.479"></a><span id="l1.479">   return NS_OK;</span>
<a href="#l1.480"></a><span id="l1.480"> }</span>
<a href="#l1.481"></a><span id="l1.481"> </span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-nsresult nsMsgFolderCache::RowCellColumnToCharPtr(nsIMdbRow *hdrRow, mdb_token columnToken, nsACString&amp; resultStr)</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-{</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+nsresult nsMsgFolderCache::RowCellColumnToCharPtr(nsIMdbRow *hdrRow,</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+                                                  mdb_token columnToken,</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineplus">+                                                  nsACString &amp;resultStr) {</span>
<a href="#l1.487"></a><span id="l1.487">   nsresult err = NS_OK;</span>
<a href="#l1.488"></a><span id="l1.488">   nsIMdbCell *hdrCell;</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-  if (hdrRow) // ### probably should be an error if hdrRow is NULL...</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+  if (hdrRow)  // ### probably should be an error if hdrRow is NULL...</span>
<a href="#l1.491"></a><span id="l1.491">   {</span>
<a href="#l1.492"></a><span id="l1.492">     err = hdrRow-&gt;GetCell(GetEnv(), columnToken, &amp;hdrCell);</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; hdrCell)</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-    {</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; hdrCell) {</span>
<a href="#l1.496"></a><span id="l1.496">       struct mdbYarn yarn;</span>
<a href="#l1.497"></a><span id="l1.497">       hdrCell-&gt;AliasYarn(GetEnv(), &amp;yarn);</span>
<a href="#l1.498"></a><span id="l1.498">       resultStr.Assign((const char *)yarn.mYarn_Buf, yarn.mYarn_Fill);</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-      resultStr.SetLength(yarn.mYarn_Fill); // ensure the string is null terminated.</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-      hdrCell-&gt;Release(); // always release ref</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+      // Ensure the string is null terminated.</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+      resultStr.SetLength(yarn.mYarn_Fill);</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineplus">+      hdrCell-&gt;Release();  // always release ref</span>
<a href="#l1.504"></a><span id="l1.504">     }</span>
<a href="#l1.505"></a><span id="l1.505">   }</span>
<a href="#l1.506"></a><span id="l1.506">   return err;</span>
<a href="#l1.507"></a><span id="l1.507"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCache.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCache.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -8,45 +8,47 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsIMsgFolderCache.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsIFile.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;mdb.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-class nsMsgFolderCache : public nsIMsgFolderCache</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+class nsMsgFolderCache : public nsIMsgFolderCache {</span>
<a href="#l2.15"></a><span id="l2.15">   using PathString = mozilla::PathString;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-public:</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ public:</span>
<a href="#l2.19"></a><span id="l2.19">   friend class nsMsgFolderCacheElement;</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   nsMsgFolderCache();</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">   NS_DECL_ISUPPORTS</span>
<a href="#l2.24"></a><span id="l2.24">   NS_DECL_NSIMSGFOLDERCACHE</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-protected:</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+ protected:</span>
<a href="#l2.28"></a><span id="l2.28">   virtual ~nsMsgFolderCache();</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  nsresult GetMDBFactory(nsIMdbFactory ** aMdbFactory);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  nsresult AddCacheElement(const nsACString&amp; key, nsIMdbRow *row, nsIMsgFolderCacheElement **result);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  nsresult RowCellColumnToCharPtr(nsIMdbRow *hdrRow, mdb_token columnToken, nsACString&amp; resultPtr);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  nsresult GetMDBFactory(nsIMdbFactory **aMdbFactory);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  nsresult AddCacheElement(const nsACString &amp;key, nsIMdbRow *row,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+                           nsIMsgFolderCacheElement **result);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  nsresult RowCellColumnToCharPtr(nsIMdbRow *hdrRow, mdb_token columnToken,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+                                  nsACString &amp;resultPtr);</span>
<a href="#l2.38"></a><span id="l2.38">   nsresult InitMDBInfo();</span>
<a href="#l2.39"></a><span id="l2.39">   nsresult InitNewDB();</span>
<a href="#l2.40"></a><span id="l2.40">   nsresult InitExistingDB();</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  nsresult OpenMDB(const PathString&amp; dbName, bool create);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-  nsIMdbEnv *GetEnv() {return m_mdbEnv;}</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-  nsIMdbStore *GetStore() {return m_mdbStore;}</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgFolderCacheElement&gt; m_cacheElements;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  nsresult OpenMDB(const PathString &amp;dbName, bool create);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  nsIMdbEnv *GetEnv() { return m_mdbEnv; }</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  nsIMdbStore *GetStore() { return m_mdbStore; }</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgFolderCacheElement&gt;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+      m_cacheElements;</span>
<a href="#l2.50"></a><span id="l2.50">   // mdb stuff</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  nsIMdbEnv           *m_mdbEnv; // to be used in all the db calls.</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-  nsIMdbStore         *m_mdbStore;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  nsIMdbTable         *m_mdbAllFoldersTable;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-  mdb_token           m_folderRowScopeToken;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  mdb_token           m_folderTableKindToken;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  nsIMdbEnv *m_mdbEnv;  // to be used in all the db calls.</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  nsIMdbStore *m_mdbStore;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  nsIMdbTable *m_mdbAllFoldersTable;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  mdb_token m_folderRowScopeToken;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  mdb_token m_folderTableKindToken;</span>
<a href="#l2.61"></a><span id="l2.61">   nsCOMPtr&lt;nsIMdbFactory&gt; mMdbFactory;</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  struct mdbOid       m_allFoldersTableOID;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  struct mdbOid m_allFoldersTableOID;</span>
<a href="#l2.65"></a><span id="l2.65"> };</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCacheElement.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCacheElement.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3,153 +3,142 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.5"></a><span id="l3.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsMsgFolderCacheElement.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;prmem.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-nsMsgFolderCacheElement::nsMsgFolderCacheElement()</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+nsMsgFolderCacheElement::nsMsgFolderCacheElement() {</span>
<a href="#l3.15"></a><span id="l3.15">   m_mdbRow = nullptr;</span>
<a href="#l3.16"></a><span id="l3.16">   m_owningCache = nullptr;</span>
<a href="#l3.17"></a><span id="l3.17"> }</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-nsMsgFolderCacheElement::~nsMsgFolderCacheElement()</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-{</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-}</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+nsMsgFolderCacheElement::~nsMsgFolderCacheElement() {}</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24"> NS_IMPL_ISUPPORTS(nsMsgFolderCacheElement, nsIMsgFolderCacheElement)</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::GetKey(nsACString&amp; aFolderKey)</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-{</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::GetKey(nsACString &amp;aFolderKey) {</span>
<a href="#l3.29"></a><span id="l3.29">   aFolderKey = m_folderKey;</span>
<a href="#l3.30"></a><span id="l3.30">   return NS_OK;</span>
<a href="#l3.31"></a><span id="l3.31"> }</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::SetKey(const nsACString&amp; aFolderKey)</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-{</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::SetKey(const nsACString &amp;aFolderKey) {</span>
<a href="#l3.36"></a><span id="l3.36">   m_folderKey = aFolderKey;</span>
<a href="#l3.37"></a><span id="l3.37">   return NS_OK;</span>
<a href="#l3.38"></a><span id="l3.38"> }</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-void nsMsgFolderCacheElement::SetOwningCache(nsMsgFolderCache *owningCache)</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-{</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+void nsMsgFolderCacheElement::SetOwningCache(nsMsgFolderCache *owningCache) {</span>
<a href="#l3.43"></a><span id="l3.43">   m_owningCache = owningCache;</span>
<a href="#l3.44"></a><span id="l3.44"> }</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::GetStringProperty(const char *propertyName, nsACString&amp; result)</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-{</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::GetStringProperty(</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    const char *propertyName, nsACString &amp;result) {</span>
<a href="#l3.50"></a><span id="l3.50">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l3.51"></a><span id="l3.51">   NS_ENSURE_TRUE(m_mdbRow &amp;&amp; m_owningCache, NS_ERROR_FAILURE);</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">   mdb_token property_token;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  nsresult ret = m_owningCache-&gt;GetStore()-&gt;StringToToken(m_owningCache-&gt;GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  nsresult ret = m_owningCache-&gt;GetStore()-&gt;StringToToken(</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+      m_owningCache-&gt;GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l3.57"></a><span id="l3.57">   if (NS_SUCCEEDED(ret))</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    ret = m_owningCache-&gt;RowCellColumnToCharPtr(m_mdbRow, property_token, result);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    ret =</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+        m_owningCache-&gt;RowCellColumnToCharPtr(m_mdbRow, property_token, result);</span>
<a href="#l3.61"></a><span id="l3.61">   return ret;</span>
<a href="#l3.62"></a><span id="l3.62"> }</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::GetInt32Property(const char *propertyName, int32_t *aResult)</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-{</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::GetInt32Property(</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    const char *propertyName, int32_t *aResult) {</span>
<a href="#l3.68"></a><span id="l3.68">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l3.69"></a><span id="l3.69">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.70"></a><span id="l3.70">   NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">   nsCString resultStr;</span>
<a href="#l3.73"></a><span id="l3.73">   GetStringProperty(propertyName, resultStr);</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  if (resultStr.IsEmpty())</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  if (resultStr.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">   // This must be an inverse function to nsCString.AppentInt(),</span>
<a href="#l3.79"></a><span id="l3.79">   // which uses snprintf(&quot;%x&quot;) internally, so that the wrapped negative numbers</span>
<a href="#l3.80"></a><span id="l3.80">   // are decoded properly.</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-  if (PR_sscanf(resultStr.get(), &quot;%x&quot;, aResult) != 1)</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-  {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+  if (PR_sscanf(resultStr.get(), &quot;%x&quot;, aResult) != 1) {</span>
<a href="#l3.84"></a><span id="l3.84">     NS_WARNING(&quot;Unexpected failure to decode hex string.&quot;);</span>
<a href="#l3.85"></a><span id="l3.85">     return NS_ERROR_FAILURE;</span>
<a href="#l3.86"></a><span id="l3.86">   }</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88">   return NS_OK;</span>
<a href="#l3.89"></a><span id="l3.89"> }</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::GetInt64Property(const char *propertyName, int64_t *aResult)</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-{</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::GetInt64Property(</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    const char *propertyName, int64_t *aResult) {</span>
<a href="#l3.95"></a><span id="l3.95">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l3.96"></a><span id="l3.96">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.97"></a><span id="l3.97">   NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99">   nsCString resultStr;</span>
<a href="#l3.100"></a><span id="l3.100">   GetStringProperty(propertyName, resultStr);</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  if (resultStr.IsEmpty())</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  if (resultStr.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105">   // This must be an inverse function to nsCString.AppentInt(),</span>
<a href="#l3.106"></a><span id="l3.106">   // which uses snprintf(&quot;%x&quot;) internally, so that the wrapped negative numbers</span>
<a href="#l3.107"></a><span id="l3.107">   // are decoded properly.</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  if (PR_sscanf(resultStr.get(), &quot;%llx&quot;, aResult) != 1)</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  {</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  if (PR_sscanf(resultStr.get(), &quot;%llx&quot;, aResult) != 1) {</span>
<a href="#l3.111"></a><span id="l3.111">     NS_WARNING(&quot;Unexpected failure to decode hex string.&quot;);</span>
<a href="#l3.112"></a><span id="l3.112">     return NS_ERROR_FAILURE;</span>
<a href="#l3.113"></a><span id="l3.113">   }</span>
<a href="#l3.114"></a><span id="l3.114"> </span>
<a href="#l3.115"></a><span id="l3.115">   return NS_OK;</span>
<a href="#l3.116"></a><span id="l3.116"> }</span>
<a href="#l3.117"></a><span id="l3.117"> </span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::SetStringProperty(const char *propertyName, const nsACString&amp; propertyValue)</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-{</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::SetStringProperty(</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    const char *propertyName, const nsACString &amp;propertyValue) {</span>
<a href="#l3.122"></a><span id="l3.122">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l3.123"></a><span id="l3.123">   NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l3.124"></a><span id="l3.124">   nsresult rv = NS_OK;</span>
<a href="#l3.125"></a><span id="l3.125">   mdb_token property_token;</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  if (m_owningCache)</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    rv = m_owningCache-&gt;GetStore()-&gt;StringToToken(m_owningCache-&gt;GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  if (m_owningCache) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    rv = m_owningCache-&gt;GetStore()-&gt;StringToToken(</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+        m_owningCache-&gt;GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.136"></a><span id="l3.136">       struct mdbYarn yarn;</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138">       yarn.mYarn_Grow = NULL;</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-      if (m_mdbRow)</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-      {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-        nsCString propertyVal (propertyValue);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-        yarn.mYarn_Buf = (void *) propertyVal.get();</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-        yarn.mYarn_Size = strlen((const char *) yarn.mYarn_Buf) + 1;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+      if (m_mdbRow) {</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+        nsCString propertyVal(propertyValue);</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+        yarn.mYarn_Buf = (void *)propertyVal.get();</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+        yarn.mYarn_Size = strlen((const char *)yarn.mYarn_Buf) + 1;</span>
<a href="#l3.148"></a><span id="l3.148">         yarn.mYarn_Fill = yarn.mYarn_Size - 1;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-        yarn.mYarn_Form = 0; // what to do with this? we're storing csid in the msg hdr...</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-        rv = m_mdbRow-&gt;AddColumn(m_owningCache-&gt;GetEnv(), property_token, &amp;yarn);</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+        yarn.mYarn_Form =</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+            0;  // what to do with this? we're storing csid in the msg hdr...</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+        rv =</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+            m_mdbRow-&gt;AddColumn(m_owningCache-&gt;GetEnv(), property_token, &amp;yarn);</span>
<a href="#l3.155"></a><span id="l3.155">         return rv;</span>
<a href="#l3.156"></a><span id="l3.156">       }</span>
<a href="#l3.157"></a><span id="l3.157">     }</span>
<a href="#l3.158"></a><span id="l3.158">   }</span>
<a href="#l3.159"></a><span id="l3.159">   return rv;</span>
<a href="#l3.160"></a><span id="l3.160"> }</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::SetInt32Property(const char *propertyName, int32_t propertyValue)</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-{</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::SetInt32Property(</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+    const char *propertyName, int32_t propertyValue) {</span>
<a href="#l3.166"></a><span id="l3.166">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l3.167"></a><span id="l3.167">   NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l3.168"></a><span id="l3.168"> </span>
<a href="#l3.169"></a><span id="l3.169">   // This also supports encoding negative numbers into hex</span>
<a href="#l3.170"></a><span id="l3.170">   // by integer wrapping them (e.g. -1 -&gt; &quot;ffffffff&quot;).</span>
<a href="#l3.171"></a><span id="l3.171">   nsAutoCString propertyStr;</span>
<a href="#l3.172"></a><span id="l3.172">   propertyStr.AppendInt(propertyValue, 16);</span>
<a href="#l3.173"></a><span id="l3.173">   return SetStringProperty(propertyName, propertyStr);</span>
<a href="#l3.174"></a><span id="l3.174"> }</span>
<a href="#l3.175"></a><span id="l3.175"> </span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-NS_IMETHODIMP nsMsgFolderCacheElement::SetInt64Property(const char *propertyName, int64_t propertyValue)</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-{</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::SetInt64Property(</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+    const char *propertyName, int64_t propertyValue) {</span>
<a href="#l3.180"></a><span id="l3.180">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l3.181"></a><span id="l3.181">   NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183">   // This also supports encoding negative numbers into hex</span>
<a href="#l3.184"></a><span id="l3.184">   // by integer wrapping them (e.g. -1 -&gt; &quot;ffffffffffffffff&quot;).</span>
<a href="#l3.185"></a><span id="l3.185">   nsAutoCString propertyStr;</span>
<a href="#l3.186"></a><span id="l3.186">   propertyStr.AppendInt(propertyValue, 16);</span>
<a href="#l3.187"></a><span id="l3.187">   return SetStringProperty(propertyName, propertyStr);</span>
<a href="#l3.188"></a><span id="l3.188"> }</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-void nsMsgFolderCacheElement::SetMDBRow(nsIMdbRow *row)</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-{</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-  m_mdbRow = row;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-}</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+void nsMsgFolderCacheElement::SetMDBRow(nsIMdbRow *row) { m_mdbRow = row; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCacheElement.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCacheElement.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,31 +5,32 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> #ifndef nsMsgFolderCacheElement_H</span>
<a href="#l4.6"></a><span id="l4.6"> #define nsMsgFolderCacheElement_H</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsMsgFolderCache.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;mdb.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-class nsMsgFolderCacheElement : public nsIMsgFolderCacheElement</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-public:</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+class nsMsgFolderCacheElement : public nsIMsgFolderCacheElement {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ public:</span>
<a href="#l4.17"></a><span id="l4.17">   nsMsgFolderCacheElement();</span>
<a href="#l4.18"></a><span id="l4.18">   friend class nsMsgFolderCache;</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   NS_DECL_ISUPPORTS</span>
<a href="#l4.21"></a><span id="l4.21">   NS_DECL_NSIMSGFOLDERCACHEELEMENT</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">   void SetMDBRow(nsIMdbRow *row);</span>
<a href="#l4.24"></a><span id="l4.24">   void SetOwningCache(nsMsgFolderCache *owningCache);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-protected:</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ protected:</span>
<a href="#l4.28"></a><span id="l4.28">   virtual ~nsMsgFolderCacheElement();</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">   RefPtr&lt;nsIMdbRow&gt; m_mdbRow;</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  nsMsgFolderCache *m_owningCache; // this will be ref-counted. Is this going to be a problem?</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  nsMsgFolderCache *m_owningCache;  // this will be ref-counted. Is this going</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+                                    // to be a problem?</span>
<a href="#l4.35"></a><span id="l4.35">   // I want to avoid circular references, but since this is</span>
<a href="#l4.36"></a><span id="l4.36">   // scriptable, I think I have to ref-count it.</span>
<a href="#l4.37"></a><span id="l4.37">   nsCString m_folderKey;</span>
<a href="#l4.38"></a><span id="l4.38"> };</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsIFile.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineat">@@ -33,203 +33,177 @@</span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l5.22"></a><span id="l5.22"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l5.23"></a><span id="l5.23"> #include &quot;nsMsgFolderCompactor.h&quot;</span>
<a href="#l5.24"></a><span id="l5.24"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l5.26"></a><span id="l5.26"> #include &quot;nsPrintfCString.h&quot;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-</span>
<a href="#l5.29"></a><span id="l5.29"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.30"></a><span id="l5.30"> // nsFolderCompactState</span>
<a href="#l5.31"></a><span id="l5.31"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-NS_IMPL_ISUPPORTS(nsFolderCompactState, nsIMsgFolderCompactor, nsIRequestObserver, nsIStreamListener, nsICopyMessageStreamListener, nsIUrlListener)</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+NS_IMPL_ISUPPORTS(nsFolderCompactState, nsIMsgFolderCompactor,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                  nsIRequestObserver, nsIStreamListener,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+                  nsICopyMessageStreamListener, nsIUrlListener)</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-nsFolderCompactState::nsFolderCompactState()</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-{</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+nsFolderCompactState::nsFolderCompactState() {</span>
<a href="#l5.41"></a><span id="l5.41">   m_fileStream = nullptr;</span>
<a href="#l5.42"></a><span id="l5.42">   m_size = 0;</span>
<a href="#l5.43"></a><span id="l5.43">   m_curIndex = 0;</span>
<a href="#l5.44"></a><span id="l5.44">   m_status = NS_OK;</span>
<a href="#l5.45"></a><span id="l5.45">   m_compactAll = false;</span>
<a href="#l5.46"></a><span id="l5.46">   m_compactOfflineAlso = false;</span>
<a href="#l5.47"></a><span id="l5.47">   m_compactingOfflineFolders = false;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-  m_parsingFolder=false;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  m_parsingFolder = false;</span>
<a href="#l5.50"></a><span id="l5.50">   m_folderIndex = 0;</span>
<a href="#l5.51"></a><span id="l5.51">   m_startOfMsg = true;</span>
<a href="#l5.52"></a><span id="l5.52">   m_needStatusLine = false;</span>
<a href="#l5.53"></a><span id="l5.53">   m_totalExpungedBytes = 0;</span>
<a href="#l5.54"></a><span id="l5.54">   m_alreadyWarnedDiskSpace = false;</span>
<a href="#l5.55"></a><span id="l5.55"> }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-nsFolderCompactState::~nsFolderCompactState()</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-{</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+nsFolderCompactState::~nsFolderCompactState() {</span>
<a href="#l5.60"></a><span id="l5.60">   CloseOutputStream();</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-  if (NS_FAILED(m_status))</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-  {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  if (NS_FAILED(m_status)) {</span>
<a href="#l5.64"></a><span id="l5.64">     CleanupTempFilesAfterError();</span>
<a href="#l5.65"></a><span id="l5.65">     // if for some reason we failed remove the temp folder and database</span>
<a href="#l5.66"></a><span id="l5.66">   }</span>
<a href="#l5.67"></a><span id="l5.67"> }</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-nsresult</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-GetBaseStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-{</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+nsresult GetBaseStringBundle(nsIStringBundle **aBundle) {</span>
<a href="#l5.73"></a><span id="l5.73">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l5.74"></a><span id="l5.74">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l5.77"></a><span id="l5.77">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.78"></a><span id="l5.78">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.79"></a><span id="l5.79">   return bundleService-&gt;CreateBundle(</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    &quot;chrome://messenger/locale/messenger.properties&quot;, aBundle);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+      &quot;chrome://messenger/locale/messenger.properties&quot;, aBundle);</span>
<a href="#l5.82"></a><span id="l5.82"> }</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-void nsFolderCompactState::CloseOutputStream()</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-{</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-  if (m_fileStream)</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-  {</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+void nsFolderCompactState::CloseOutputStream() {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  if (m_fileStream) {</span>
<a href="#l5.90"></a><span id="l5.90">     m_fileStream-&gt;Close();</span>
<a href="#l5.91"></a><span id="l5.91">     m_fileStream = nullptr;</span>
<a href="#l5.92"></a><span id="l5.92">   }</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-</span>
<a href="#l5.94"></a><span id="l5.94"> }</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-void nsFolderCompactState::CleanupTempFilesAfterError()</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-{</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+void nsFolderCompactState::CleanupTempFilesAfterError() {</span>
<a href="#l5.99"></a><span id="l5.99">   CloseOutputStream();</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-  if (m_db)</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-    m_db-&gt;ForceClosed();</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; summaryFile;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  if (m_db) m_db-&gt;ForceClosed();</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; summaryFile;</span>
<a href="#l5.105"></a><span id="l5.105">   GetSummaryFileLocation(m_file, getter_AddRefs(summaryFile));</span>
<a href="#l5.106"></a><span id="l5.106">   m_file-&gt;Remove(false);</span>
<a href="#l5.107"></a><span id="l5.107">   summaryFile-&gt;Remove(false);</span>
<a href="#l5.108"></a><span id="l5.108"> }</span>
<a href="#l5.109"></a><span id="l5.109"> </span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-nsresult nsFolderCompactState::BuildMessageURI(const char *baseURI, nsMsgKey key, nsCString&amp; uri)</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-{</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+nsresult nsFolderCompactState::BuildMessageURI(const char *baseURI,</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+                                               nsMsgKey key, nsCString &amp;uri) {</span>
<a href="#l5.114"></a><span id="l5.114">   uri.Append(baseURI);</span>
<a href="#l5.115"></a><span id="l5.115">   uri.Append('#');</span>
<a href="#l5.116"></a><span id="l5.116">   uri.AppendInt(key);</span>
<a href="#l5.117"></a><span id="l5.117"> </span>
<a href="#l5.118"></a><span id="l5.118">   return NS_OK;</span>
<a href="#l5.119"></a><span id="l5.119"> }</span>
<a href="#l5.120"></a><span id="l5.120"> </span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-nsresult</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-nsFolderCompactState::InitDB(nsIMsgDatabase *db)</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-{</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+nsresult nsFolderCompactState::InitDB(nsIMsgDatabase *db) {</span>
<a href="#l5.126"></a><span id="l5.126">   nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l5.127"></a><span id="l5.127">   nsresult rv = db-&gt;ListAllKeys(m_keyArray);</span>
<a href="#l5.128"></a><span id="l5.128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.129"></a><span id="l5.129">   m_size = m_keyArray-&gt;m_keys.Length();</span>
<a href="#l5.130"></a><span id="l5.130"> </span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.134"></a><span id="l5.134">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.135"></a><span id="l5.135">   rv = msgDBService-&gt;OpenMailDBFromFile(m_file, m_folder, true, false,</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-                                     getter_AddRefs(m_db));</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+                                        getter_AddRefs(m_db));</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139">   if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE ||</span>
<a href="#l5.140"></a><span id="l5.140">       rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-      // if it's out of date then reopen with upgrade.</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-    return msgDBService-&gt;OpenMailDBFromFile(m_file,</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-                                            m_folder, true, true,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-                               getter_AddRefs(m_db));</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    // if it's out of date then reopen with upgrade.</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+    return msgDBService-&gt;OpenMailDBFromFile(m_file, m_folder, true, true,</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+                                            getter_AddRefs(m_db));</span>
<a href="#l5.148"></a><span id="l5.148">   return rv;</span>
<a href="#l5.149"></a><span id="l5.149"> }</span>
<a href="#l5.150"></a><span id="l5.150"> </span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-NS_IMETHODIMP nsFolderCompactState::CompactFolders(nsIArray *aArrayOfFoldersToCompact,</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-                                                   nsIArray *aOfflineFolderArray,</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-                                                   nsIUrlListener *aUrlListener,</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-                                                   nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-{</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+NS_IMETHODIMP nsFolderCompactState::CompactFolders(</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+    nsIArray *aArrayOfFoldersToCompact, nsIArray *aOfflineFolderArray,</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+    nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.159"></a><span id="l5.159">   m_window = aMsgWindow;</span>
<a href="#l5.160"></a><span id="l5.160">   m_listener = aUrlListener;</span>
<a href="#l5.161"></a><span id="l5.161">   if (aArrayOfFoldersToCompact)</span>
<a href="#l5.162"></a><span id="l5.162">     m_folderArray = aArrayOfFoldersToCompact;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-  else if (aOfflineFolderArray)</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-  {</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+  else if (aOfflineFolderArray) {</span>
<a href="#l5.166"></a><span id="l5.166">     m_folderArray = aOfflineFolderArray;</span>
<a href="#l5.167"></a><span id="l5.167">     m_compactingOfflineFolders = true;</span>
<a href="#l5.168"></a><span id="l5.168">     aOfflineFolderArray = nullptr;</span>
<a href="#l5.169"></a><span id="l5.169">   }</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-  if (!m_folderArray)</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  if (!m_folderArray) return NS_OK;</span>
<a href="#l5.173"></a><span id="l5.173"> </span>
<a href="#l5.174"></a><span id="l5.174">   m_compactAll = true;</span>
<a href="#l5.175"></a><span id="l5.175">   m_compactOfflineAlso = aOfflineFolderArray != nullptr;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-  if (m_compactOfflineAlso)</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-    m_offlineFolderArray = aOfflineFolderArray;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+  if (m_compactOfflineAlso) m_offlineFolderArray = aOfflineFolderArray;</span>
<a href="#l5.179"></a><span id="l5.179"> </span>
<a href="#l5.180"></a><span id="l5.180">   m_folderIndex = 0;</span>
<a href="#l5.181"></a><span id="l5.181">   nsresult rv = NS_OK;</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; firstFolder = do_QueryElementAt(m_folderArray,</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-                                                         m_folderIndex, &amp;rv);</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; firstFolder =</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+      do_QueryElementAt(m_folderArray, m_folderIndex, &amp;rv);</span>
<a href="#l5.186"></a><span id="l5.186"> </span>
<a href="#l5.187"></a><span id="l5.187">   if (NS_SUCCEEDED(rv) &amp;&amp; firstFolder)</span>
<a href="#l5.188"></a><span id="l5.188">     Compact(firstFolder, m_compactingOfflineFolders, aUrlListener,</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-            aMsgWindow);   //start with first folder from here.</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+            aMsgWindow);  // start with first folder from here.</span>
<a href="#l5.191"></a><span id="l5.191"> </span>
<a href="#l5.192"></a><span id="l5.192">   return rv;</span>
<a href="#l5.193"></a><span id="l5.193"> }</span>
<a href="#l5.194"></a><span id="l5.194"> </span>
<a href="#l5.195"></a><span id="l5.195"> NS_IMETHODIMP</span>
<a href="#l5.196"></a><span id="l5.196"> nsFolderCompactState::Compact(nsIMsgFolder *folder, bool aOfflineStore,</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-                              nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-{</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+                              nsIUrlListener *aListener,</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+                              nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.201"></a><span id="l5.201">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l5.202"></a><span id="l5.202">   m_listener = aListener;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  if (!m_compactingOfflineFolders &amp;&amp; !aOfflineStore)</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-  {</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-    nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-    if (imapFolder)</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-      return imapFolder-&gt;Expunge(this, aMsgWindow);</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  if (!m_compactingOfflineFolders &amp;&amp; !aOfflineStore) {</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+    if (imapFolder) return imapFolder-&gt;Expunge(this, aMsgWindow);</span>
<a href="#l5.211"></a><span id="l5.211">   }</span>
<a href="#l5.212"></a><span id="l5.212"> </span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-   m_window = aMsgWindow;</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-   nsresult rv;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-   nsCString baseMessageURI;</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+  m_window = aMsgWindow;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+  nsresult rv;</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+  nsCString baseMessageURI;</span>
<a href="#l5.223"></a><span id="l5.223"> </span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-   nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-   if (NS_SUCCEEDED(rv) &amp;&amp; localFolder)</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-   {</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-     rv=localFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(db));</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-     if (NS_FAILED(rv) || !db)</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-     {</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-       if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING ||</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-           rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-       {</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-         m_folder = folder;  //will be used to compact</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-         m_parsingFolder = true;</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-         rv = localFolder-&gt;ParseFolder(m_window, this);</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-       }</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-       return rv;</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-     }</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-     else</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-     {</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-       bool valid;</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-       rv = db-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-       if (!valid) //we are probably parsing the folder because we selected it.</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-       {</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-         folder-&gt;NotifyCompactCompleted();</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-         if (m_compactAll)</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-           return CompactNextFolder();</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-         else</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-           return NS_OK;</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-       }</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-     }</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-   }</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-   else</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-   {</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-     rv = folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-   }</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; localFolder) {</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+    rv = localFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(db));</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+    if (NS_FAILED(rv) || !db) {</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+      if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING ||</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+          rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) {</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+        m_folder = folder;  // will be used to compact</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+        m_parsingFolder = true;</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+        rv = localFolder-&gt;ParseFolder(m_window, this);</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+      }</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+      return rv;</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+    } else {</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+      bool valid;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+      rv = db-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+      if (!valid)  // we are probably parsing the folder because we selected it.</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+      {</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+        folder-&gt;NotifyCompactCompleted();</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+        if (m_compactAll)</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+          return CompactNextFolder();</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+        else</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+          return NS_OK;</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+      }</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+    }</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+  } else {</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+    rv = folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+  }</span>
<a href="#l5.285"></a><span id="l5.285"> </span>
<a href="#l5.286"></a><span id="l5.286">   rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l5.287"></a><span id="l5.287">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.288"></a><span id="l5.288"> </span>
<a href="#l5.289"></a><span id="l5.289">   do {</span>
<a href="#l5.290"></a><span id="l5.290">     bool exists = false;</span>
<a href="#l5.291"></a><span id="l5.291">     rv = path-&gt;Exists(&amp;exists);</span>
<a href="#l5.292"></a><span id="l5.292">     if (!exists) {</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineat">@@ -248,1139 +222,1048 @@ nsFolderCompactState::Compact(nsIMsgFold</span>
<a href="#l5.294"></a><span id="l5.294">     int64_t diskSize;</span>
<a href="#l5.295"></a><span id="l5.295">     rv = folder-&gt;GetSizeOnDisk(&amp;diskSize);</span>
<a href="#l5.296"></a><span id="l5.296">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.297"></a><span id="l5.297"> </span>
<a href="#l5.298"></a><span id="l5.298">     int64_t diskFree;</span>
<a href="#l5.299"></a><span id="l5.299">     rv = path-&gt;GetDiskSpaceAvailable(&amp;diskFree);</span>
<a href="#l5.300"></a><span id="l5.300">     if (NS_FAILED(rv)) {</span>
<a href="#l5.301"></a><span id="l5.301">       // If GetDiskSpaceAvailable() failed, better bail out fast.</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-      if (rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-        return rv;</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+      if (rv != NS_ERROR_NOT_IMPLEMENTED) return rv;</span>
<a href="#l5.305"></a><span id="l5.305">       // Some platforms do not have GetDiskSpaceAvailable implemented.</span>
<a href="#l5.306"></a><span id="l5.306">       // In that case skip the preventive free space analysis and let it</span>
<a href="#l5.307"></a><span id="l5.307">       // fail in compact later if space actually wasn't available.</span>
<a href="#l5.308"></a><span id="l5.308">     } else {</span>
<a href="#l5.309"></a><span id="l5.309">       // Let's try to not even start compact if there is really low free space.</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-      // It may still fail later as we do not know how big exactly the folder DB will</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-      // end up being.</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-      // The DB already doesn't contain references to messages that are already deleted.</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineminus">-      // So theoretically it shouldn't shrink with compact. But in practice,</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-      // the automatic shrinking of the DB may still have not yet happened.</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-      // So we cap the final size at 1KB per message.</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+      // It may still fail later as we do not know how big exactly the folder DB</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+      // will end up being. The DB already doesn't contain references to</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+      // messages that are already deleted. So theoretically it shouldn't shrink</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+      // with compact. But in practice, the automatic shrinking of the DB may</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+      // still have not yet happened. So we cap the final size at 1KB per</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+      // message.</span>
<a href="#l5.322"></a><span id="l5.322">       db-&gt;Commit(nsMsgDBCommitType::kCompressCommit);</span>
<a href="#l5.323"></a><span id="l5.323"> </span>
<a href="#l5.324"></a><span id="l5.324">       int64_t dbSize;</span>
<a href="#l5.325"></a><span id="l5.325">       rv = db-&gt;GetDatabaseSize(&amp;dbSize);</span>
<a href="#l5.326"></a><span id="l5.326">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.327"></a><span id="l5.327"> </span>
<a href="#l5.328"></a><span id="l5.328">       int32_t totalMsgs;</span>
<a href="#l5.329"></a><span id="l5.329">       rv = folder-&gt;GetTotalMessages(false, &amp;totalMsgs);</span>
<a href="#l5.330"></a><span id="l5.330">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-      int64_t expectedDBSize = std::min&lt;int64_t&gt;(dbSize, ((int64_t)totalMsgs) * 1024);</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-      if (diskFree &lt; diskSize - expunged + expectedDBSize)</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-      {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-        if (!m_alreadyWarnedDiskSpace)</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-        {</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+      int64_t expectedDBSize =</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+          std::min&lt;int64_t&gt;(dbSize, ((int64_t)totalMsgs) * 1024);</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+      if (diskFree &lt; diskSize - expunged + expectedDBSize) {</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+        if (!m_alreadyWarnedDiskSpace) {</span>
<a href="#l5.340"></a><span id="l5.340">           folder-&gt;ThrowAlertMsg(&quot;compactFolderInsufficientSpace&quot;, m_window);</span>
<a href="#l5.341"></a><span id="l5.341">           m_alreadyWarnedDiskSpace = true;</span>
<a href="#l5.342"></a><span id="l5.342">         }</span>
<a href="#l5.343"></a><span id="l5.343">         break;</span>
<a href="#l5.344"></a><span id="l5.344">       }</span>
<a href="#l5.345"></a><span id="l5.345">     }</span>
<a href="#l5.346"></a><span id="l5.346"> </span>
<a href="#l5.347"></a><span id="l5.347">     rv = folder-&gt;GetBaseMessageURI(baseMessageURI);</span>
<a href="#l5.348"></a><span id="l5.348">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.349"></a><span id="l5.349"> </span>
<a href="#l5.350"></a><span id="l5.350">     rv = Init(folder, baseMessageURI.get(), db, path, m_window);</span>
<a href="#l5.351"></a><span id="l5.351">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.352"></a><span id="l5.352"> </span>
<a href="#l5.353"></a><span id="l5.353">     bool isLocked = true;</span>
<a href="#l5.354"></a><span id="l5.354">     m_folder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-    if (isLocked)</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-    {</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+    if (isLocked) {</span>
<a href="#l5.358"></a><span id="l5.358">       CleanupTempFilesAfterError();</span>
<a href="#l5.359"></a><span id="l5.359">       m_folder-&gt;ThrowAlertMsg(&quot;compactFolderDeniedLock&quot;, m_window);</span>
<a href="#l5.360"></a><span id="l5.360">       break;</span>
<a href="#l5.361"></a><span id="l5.361">     }</span>
<a href="#l5.362"></a><span id="l5.362"> </span>
<a href="#l5.363"></a><span id="l5.363">     // If we got here start the real compacting.</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMsgFolderCompactor*&gt;(this));</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports =</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+        do_QueryInterface(static_cast&lt;nsIMsgFolderCompactor *&gt;(this));</span>
<a href="#l5.367"></a><span id="l5.367">     m_folder-&gt;AcquireSemaphore(supports);</span>
<a href="#l5.368"></a><span id="l5.368">     m_totalExpungedBytes += expunged;</span>
<a href="#l5.369"></a><span id="l5.369">     return StartCompacting();</span>
<a href="#l5.370"></a><span id="l5.370"> </span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-  } while(false); // block for easy skipping the compaction using 'break'</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+  } while (false);  // block for easy skipping the compaction using 'break'</span>
<a href="#l5.373"></a><span id="l5.373"> </span>
<a href="#l5.374"></a><span id="l5.374">   folder-&gt;NotifyCompactCompleted();</span>
<a href="#l5.375"></a><span id="l5.375">   if (m_compactAll)</span>
<a href="#l5.376"></a><span id="l5.376">     return CompactNextFolder();</span>
<a href="#l5.377"></a><span id="l5.377">   else</span>
<a href="#l5.378"></a><span id="l5.378">     return NS_OK;</span>
<a href="#l5.379"></a><span id="l5.379"> }</span>
<a href="#l5.380"></a><span id="l5.380"> </span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-nsresult nsFolderCompactState::ShowStatusMsg(const nsString&amp; aMsg)</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-{</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-  if (!m_window || aMsg.IsEmpty())</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+nsresult nsFolderCompactState::ShowStatusMsg(const nsString &amp;aMsg) {</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+  if (!m_window || aMsg.IsEmpty()) return NS_OK;</span>
<a href="#l5.387"></a><span id="l5.387"> </span>
<a href="#l5.388"></a><span id="l5.388">   nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l5.389"></a><span id="l5.389">   nsresult rv = m_window-&gt;GetStatusFeedback(getter_AddRefs(statusFeedback));</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-  if (NS_FAILED(rv) || !statusFeedback)</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+  if (NS_FAILED(rv) || !statusFeedback) return NS_OK;</span>
<a href="#l5.393"></a><span id="l5.393"> </span>
<a href="#l5.394"></a><span id="l5.394">   // Try to prepend account name to the message.</span>
<a href="#l5.395"></a><span id="l5.395">   nsString statusMessage;</span>
<a href="#l5.396"></a><span id="l5.396">   do {</span>
<a href="#l5.397"></a><span id="l5.397">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.398"></a><span id="l5.398">     rv = m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-      break;</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l5.402"></a><span id="l5.402">     nsAutoString accountName;</span>
<a href="#l5.403"></a><span id="l5.403">     rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-      break;</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l5.407"></a><span id="l5.407">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.408"></a><span id="l5.408">     rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-      break;</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-    const char16_t *params[] = { accountName.get(), aMsg.get() };</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(&quot;statusMessage&quot;,</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-                                      params, 2, statusMessage);</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+    const char16_t *params[] = {accountName.get(), aMsg.get()};</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+    rv =</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+        bundle-&gt;FormatStringFromName(&quot;statusMessage&quot;, params, 2, statusMessage);</span>
<a href="#l5.418"></a><span id="l5.418">   } while (false);</span>
<a href="#l5.419"></a><span id="l5.419"> </span>
<a href="#l5.420"></a><span id="l5.420">   // If fetching any of the needed info failed, just show the original message.</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-    statusMessage.Assign(aMsg);</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+  if (NS_FAILED(rv)) statusMessage.Assign(aMsg);</span>
<a href="#l5.424"></a><span id="l5.424">   return statusFeedback-&gt;SetStatusString(statusMessage);</span>
<a href="#l5.425"></a><span id="l5.425"> }</span>
<a href="#l5.426"></a><span id="l5.426"> </span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-nsresult</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-nsFolderCompactState::Init(nsIMsgFolder *folder, const char *baseMsgUri, nsIMsgDatabase *db,</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-                           nsIFile *path, nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-{</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+nsresult nsFolderCompactState::Init(nsIMsgFolder *folder,</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+                                    const char *baseMsgUri, nsIMsgDatabase *db,</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+                                    nsIFile *path, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.434"></a><span id="l5.434">   nsresult rv;</span>
<a href="#l5.435"></a><span id="l5.435"> </span>
<a href="#l5.436"></a><span id="l5.436">   m_folder = folder;</span>
<a href="#l5.437"></a><span id="l5.437">   m_baseMessageUri = baseMsgUri;</span>
<a href="#l5.438"></a><span id="l5.438">   m_file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l5.439"></a><span id="l5.439">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.440"></a><span id="l5.440">   m_file-&gt;InitWithFile(path);</span>
<a href="#l5.441"></a><span id="l5.441">   // need to make sure the temp file goes in the same real directory</span>
<a href="#l5.442"></a><span id="l5.442">   // as the original file, so resolve sym links.</span>
<a href="#l5.443"></a><span id="l5.443">   m_file-&gt;SetFollowLinks(true);</span>
<a href="#l5.444"></a><span id="l5.444"> </span>
<a href="#l5.445"></a><span id="l5.445">   m_file-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;nstmp&quot;));</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-  rv = m_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);   //make sure we are not crunching existing nstmp file</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+  // Make sure we are not crunching existing nstmp file.</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+  rv = m_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l5.449"></a><span id="l5.449">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.450"></a><span id="l5.450"> </span>
<a href="#l5.451"></a><span id="l5.451">   m_window = aMsgWindow;</span>
<a href="#l5.452"></a><span id="l5.452">   m_keyArray = new nsMsgKeyArray;</span>
<a href="#l5.453"></a><span id="l5.453">   m_size = 0;</span>
<a href="#l5.454"></a><span id="l5.454">   m_totalMsgSize = 0;</span>
<a href="#l5.455"></a><span id="l5.455">   rv = InitDB(db);</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-  {</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l5.459"></a><span id="l5.459">     CleanupTempFilesAfterError();</span>
<a href="#l5.460"></a><span id="l5.460">     return rv;</span>
<a href="#l5.461"></a><span id="l5.461">   }</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463">   m_curIndex = 0;</span>
<a href="#l5.464"></a><span id="l5.464"> </span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_fileStream), m_file, -1, 00600);</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_fileStream), m_file, -1,</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+                                      00600);</span>
<a href="#l5.468"></a><span id="l5.468">   if (NS_FAILED(rv))</span>
<a href="#l5.469"></a><span id="l5.469">     m_folder-&gt;ThrowAlertMsg(&quot;compactFolderWriteFailed&quot;, m_window);</span>
<a href="#l5.470"></a><span id="l5.470">   else</span>
<a href="#l5.471"></a><span id="l5.471">     rv = GetMessageServiceFromURI(nsDependentCString(baseMsgUri),</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-                                getter_AddRefs(m_messageService));</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-  {</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+                                  getter_AddRefs(m_messageService));</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l5.477"></a><span id="l5.477">     m_status = rv;</span>
<a href="#l5.478"></a><span id="l5.478">   }</span>
<a href="#l5.479"></a><span id="l5.479">   return rv;</span>
<a href="#l5.480"></a><span id="l5.480"> }</span>
<a href="#l5.481"></a><span id="l5.481"> </span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-void nsFolderCompactState::ShowCompactingStatusMsg()</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineminus">-{</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+void nsFolderCompactState::ShowCompactingStatusMsg() {</span>
<a href="#l5.485"></a><span id="l5.485">   nsString statusString;</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-  nsresult rv = m_folder-&gt;GetStringWithFolderNameFromBundle(&quot;compactingFolder&quot;, statusString);</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-  if (!statusString.IsEmpty() &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-    ShowStatusMsg(statusString);</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+  nsresult rv = m_folder-&gt;GetStringWithFolderNameFromBundle(&quot;compactingFolder&quot;,</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+                                                            statusString);</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+  if (!statusString.IsEmpty() &amp;&amp; NS_SUCCEEDED(rv)) ShowStatusMsg(statusString);</span>
<a href="#l5.492"></a><span id="l5.492"> }</span>
<a href="#l5.493"></a><span id="l5.493"> </span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-NS_IMETHODIMP nsFolderCompactState::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-{</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+NS_IMETHODIMP nsFolderCompactState::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l5.497"></a><span id="l5.497">   return NS_OK;</span>
<a href="#l5.498"></a><span id="l5.498"> }</span>
<a href="#l5.499"></a><span id="l5.499"> </span>
<a href="#l5.500"></a><span id="l5.500" class="difflineminus">-NS_IMETHODIMP nsFolderCompactState::OnStopRunningUrl(nsIURI *url, nsresult status)</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineminus">-{</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineminus">-  if (m_parsingFolder)</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineminus">-  {</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+NS_IMETHODIMP nsFolderCompactState::OnStopRunningUrl(nsIURI *url,</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+                                                     nsresult status) {</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+  if (m_parsingFolder) {</span>
<a href="#l5.507"></a><span id="l5.507">     m_parsingFolder = false;</span>
<a href="#l5.508"></a><span id="l5.508">     if (NS_SUCCEEDED(status))</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-      status = Compact(m_folder, m_compactingOfflineFolders, m_listener, m_window);</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+      status =</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+          Compact(m_folder, m_compactingOfflineFolders, m_listener, m_window);</span>
<a href="#l5.512"></a><span id="l5.512">     else if (m_compactAll)</span>
<a href="#l5.513"></a><span id="l5.513">       CompactNextFolder();</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-  }</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-  else if (m_compactAll) // this should be the imap case only</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+  } else if (m_compactAll)  // this should be the imap case only</span>
<a href="#l5.517"></a><span id="l5.517">   {</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; prevFolder = do_QueryElementAt(m_folderArray,</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-                                                           m_folderIndex);</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-    if (prevFolder)</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineminus">-      prevFolder-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; prevFolder =</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+        do_QueryElementAt(m_folderArray, m_folderIndex);</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+    if (prevFolder) prevFolder-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l5.525"></a><span id="l5.525">     CompactNextFolder();</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineminus">-  }</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-  else if (m_listener)</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-  {</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+  } else if (m_listener) {</span>
<a href="#l5.530"></a><span id="l5.530">     CompactCompleted(status);</span>
<a href="#l5.531"></a><span id="l5.531">   }</span>
<a href="#l5.532"></a><span id="l5.532">   return NS_OK;</span>
<a href="#l5.533"></a><span id="l5.533"> }</span>
<a href="#l5.534"></a><span id="l5.534"> </span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-nsresult nsFolderCompactState::StartCompacting()</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-{</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+nsresult nsFolderCompactState::StartCompacting() {</span>
<a href="#l5.538"></a><span id="l5.538">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l5.539"></a><span id="l5.539">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.540"></a><span id="l5.540"> </span>
<a href="#l5.541"></a><span id="l5.541">   nsresult rv = m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.542"></a><span id="l5.542">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.543"></a><span id="l5.543">   rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l5.544"></a><span id="l5.544">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.545"></a><span id="l5.545"> </span>
<a href="#l5.546"></a><span id="l5.546">   // Notify that compaction is beginning.  We do this even if there are no</span>
<a href="#l5.547"></a><span id="l5.547">   // messages to be copied because the summary database still gets blown away</span>
<a href="#l5.548"></a><span id="l5.548">   // which is still pretty interesting.  (And we like consistency.)</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineminus">-    notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.553"></a><span id="l5.553">   if (notifier)</span>
<a href="#l5.554"></a><span id="l5.554">     notifier-&gt;NotifyItemEvent(m_folder,</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineminus">-                              NS_LITERAL_CSTRING(&quot;FolderCompactStart&quot;),</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-                              nullptr,</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+                              NS_LITERAL_CSTRING(&quot;FolderCompactStart&quot;), nullptr,</span>
<a href="#l5.558"></a><span id="l5.558">                               EmptyCString());</span>
<a href="#l5.559"></a><span id="l5.559"> </span>
<a href="#l5.560"></a><span id="l5.560">   // TODO: test whether sorting the messages (m_keyArray) by messageOffset</span>
<a href="#l5.561"></a><span id="l5.561">   // would improve performance on large files (less seeks).</span>
<a href="#l5.562"></a><span id="l5.562">   // The m_keyArray is in the order as stored in DB and on IMAP or News</span>
<a href="#l5.563"></a><span id="l5.563">   // the messages stored on the mbox file are not necessarily in the same order.</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-  if (m_size &gt; 0)</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineminus">-  {</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+  if (m_size &gt; 0) {</span>
<a href="#l5.567"></a><span id="l5.567">     nsCOMPtr&lt;nsIURI&gt; notUsed;</span>
<a href="#l5.568"></a><span id="l5.568">     ShowCompactingStatusMsg();</span>
<a href="#l5.569"></a><span id="l5.569">     NS_ADDREF_THIS();</span>
<a href="#l5.570"></a><span id="l5.570">     rv = m_messageService-&gt;CopyMessages(m_size, m_keyArray-&gt;m_keys.Elements(),</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineminus">-                                        m_folder, this,</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineminus">-                                        false, nullptr, m_window,</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineminus">-                                        getter_AddRefs(notUsed));</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineminus">-  }</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineminus">-  else</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineminus">-  { // no messages to copy with</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+                                        m_folder, this, false, nullptr,</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+                                        m_window, getter_AddRefs(notUsed));</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+  } else {  // no messages to copy with</span>
<a href="#l5.580"></a><span id="l5.580">     FinishCompact();</span>
<a href="#l5.581"></a><span id="l5.581">   }</span>
<a href="#l5.582"></a><span id="l5.582">   return rv;</span>
<a href="#l5.583"></a><span id="l5.583"> }</span>
<a href="#l5.584"></a><span id="l5.584"> </span>
<a href="#l5.585"></a><span id="l5.585" class="difflineminus">-nsresult</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineminus">-nsFolderCompactState::FinishCompact()</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineminus">-{</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+nsresult nsFolderCompactState::FinishCompact() {</span>
<a href="#l5.589"></a><span id="l5.589">   NS_ENSURE_TRUE(m_folder, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.590"></a><span id="l5.590">   NS_ENSURE_TRUE(m_file, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.591"></a><span id="l5.591"> </span>
<a href="#l5.592"></a><span id="l5.592">   // All okay time to finish up the compact process</span>
<a href="#l5.593"></a><span id="l5.593">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l5.594"></a><span id="l5.594">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l5.595"></a><span id="l5.595"> </span>
<a href="#l5.596"></a><span id="l5.596">   // get leaf name and database name of the folder</span>
<a href="#l5.597"></a><span id="l5.597">   nsresult rv = m_folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; folderPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; folderPath =</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+      do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l5.601"></a><span id="l5.601">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.602"></a><span id="l5.602">   rv = folderPath-&gt;InitWithFile(path);</span>
<a href="#l5.603"></a><span id="l5.603">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.604"></a><span id="l5.604">   // need to make sure we put the .msf file in the same directory</span>
<a href="#l5.605"></a><span id="l5.605">   // as the original mailbox, so resolve symlinks.</span>
<a href="#l5.606"></a><span id="l5.606">   folderPath-&gt;SetFollowLinks(true);</span>
<a href="#l5.607"></a><span id="l5.607"> </span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; oldSummaryFile;</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; oldSummaryFile;</span>
<a href="#l5.610"></a><span id="l5.610">   rv = GetSummaryFileLocation(folderPath, getter_AddRefs(oldSummaryFile));</span>
<a href="#l5.611"></a><span id="l5.611">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.612"></a><span id="l5.612">   nsAutoCString dbName;</span>
<a href="#l5.613"></a><span id="l5.613">   oldSummaryFile-&gt;GetNativeLeafName(dbName);</span>
<a href="#l5.614"></a><span id="l5.614">   nsAutoCString folderName;</span>
<a href="#l5.615"></a><span id="l5.615">   path-&gt;GetNativeLeafName(folderName);</span>
<a href="#l5.616"></a><span id="l5.616"> </span>
<a href="#l5.617"></a><span id="l5.617">   // close down the temp file stream; preparing for deleting the old folder</span>
<a href="#l5.618"></a><span id="l5.618">   // and its database; then rename the temp folder and database</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineminus">-  if (m_fileStream)</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineminus">-  {</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+  if (m_fileStream) {</span>
<a href="#l5.622"></a><span id="l5.622">     m_fileStream-&gt;Flush();</span>
<a href="#l5.623"></a><span id="l5.623">     m_fileStream-&gt;Close();</span>
<a href="#l5.624"></a><span id="l5.624">     m_fileStream = nullptr;</span>
<a href="#l5.625"></a><span id="l5.625">   }</span>
<a href="#l5.626"></a><span id="l5.626"> </span>
<a href="#l5.627"></a><span id="l5.627">   // make sure the new database is valid.</span>
<a href="#l5.628"></a><span id="l5.628">   // Close it so we can rename the .msf file.</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-  if (m_db)</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineminus">-  {</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+  if (m_db) {</span>
<a href="#l5.632"></a><span id="l5.632">     m_db-&gt;ForceClosed();</span>
<a href="#l5.633"></a><span id="l5.633">     m_db = nullptr;</span>
<a href="#l5.634"></a><span id="l5.634">   }</span>
<a href="#l5.635"></a><span id="l5.635"> </span>
<a href="#l5.636"></a><span id="l5.636" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; newSummaryFile;</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; newSummaryFile;</span>
<a href="#l5.638"></a><span id="l5.638">   rv = GetSummaryFileLocation(m_file, getter_AddRefs(newSummaryFile));</span>
<a href="#l5.639"></a><span id="l5.639">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.640"></a><span id="l5.640"> </span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l5.643"></a><span id="l5.643">   m_folder-&gt;GetDBTransferInfo(getter_AddRefs(transferInfo));</span>
<a href="#l5.644"></a><span id="l5.644"> </span>
<a href="#l5.645"></a><span id="l5.645">   // close down database of the original folder</span>
<a href="#l5.646"></a><span id="l5.646">   m_folder-&gt;ForceDBClosed();</span>
<a href="#l5.647"></a><span id="l5.647"> </span>
<a href="#l5.648"></a><span id="l5.648">   nsCOMPtr&lt;nsIFile&gt; cloneFile;</span>
<a href="#l5.649"></a><span id="l5.649">   int64_t fileSize = 0;</span>
<a href="#l5.650"></a><span id="l5.650">   rv = m_file-&gt;Clone(getter_AddRefs(cloneFile));</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-    rv = cloneFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = cloneFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l5.654"></a><span id="l5.654">   bool tempFileRightSize = ((uint64_t)fileSize == m_totalMsgSize);</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-  NS_WARNING_ASSERTION(tempFileRightSize, &quot;temp file not of expected size in compact&quot;);</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+  NS_WARNING_ASSERTION(tempFileRightSize,</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+                       &quot;temp file not of expected size in compact&quot;);</span>
<a href="#l5.658"></a><span id="l5.658"> </span>
<a href="#l5.659"></a><span id="l5.659">   bool folderRenameSucceeded = false;</span>
<a href="#l5.660"></a><span id="l5.660">   bool msfRenameSucceeded = false;</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; tempFileRightSize)</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineminus">-  {</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; tempFileRightSize) {</span>
<a href="#l5.664"></a><span id="l5.664">     // First we're going to try and move the old summary file out the way.</span>
<a href="#l5.665"></a><span id="l5.665">     // We don't delete it yet, as we want to keep the files in sync.</span>
<a href="#l5.666"></a><span id="l5.666">     nsCOMPtr&lt;nsIFile&gt; tempSummaryFile;</span>
<a href="#l5.667"></a><span id="l5.667">     rv = oldSummaryFile-&gt;Clone(getter_AddRefs(tempSummaryFile));</span>
<a href="#l5.668"></a><span id="l5.668">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.669"></a><span id="l5.669">       rv = tempSummaryFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l5.670"></a><span id="l5.670"> </span>
<a href="#l5.671"></a><span id="l5.671">     nsAutoCString tempSummaryFileName;</span>
<a href="#l5.672"></a><span id="l5.672">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.673"></a><span id="l5.673">       rv = tempSummaryFile-&gt;GetNativeLeafName(tempSummaryFileName);</span>
<a href="#l5.674"></a><span id="l5.674"> </span>
<a href="#l5.675"></a><span id="l5.675">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineminus">-      rv = oldSummaryFile-&gt;MoveToNative((nsIFile*) nullptr, tempSummaryFileName);</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+      rv =</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+          oldSummaryFile-&gt;MoveToNative((nsIFile *)nullptr, tempSummaryFileName);</span>
<a href="#l5.679"></a><span id="l5.679"> </span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-    NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;error moving compacted folder's db out of the way&quot;);</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineminus">-    {</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+    NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+                         &quot;error moving compacted folder's db out of the way&quot;);</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.686"></a><span id="l5.686">       // Now we've successfully moved the summary file out the way, try moving</span>
<a href="#l5.687"></a><span id="l5.687">       // the newly compacted message file over the old one.</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-      rv = m_file-&gt;MoveToNative((nsIFile *) nullptr, folderName);</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+      rv = m_file-&gt;MoveToNative((nsIFile *)nullptr, folderName);</span>
<a href="#l5.690"></a><span id="l5.690">       folderRenameSucceeded = NS_SUCCEEDED(rv);</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineminus">-      NS_WARNING_ASSERTION(folderRenameSucceeded, &quot;error renaming compacted folder&quot;);</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineminus">-      if (folderRenameSucceeded)</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-      {</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+      NS_WARNING_ASSERTION(folderRenameSucceeded,</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+                           &quot;error renaming compacted folder&quot;);</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+      if (folderRenameSucceeded) {</span>
<a href="#l5.697"></a><span id="l5.697">         // That worked, so land the new summary file in the right place.</span>
<a href="#l5.698"></a><span id="l5.698">         nsCOMPtr&lt;nsIFile&gt; renamedCompactedSummaryFile;</span>
<a href="#l5.699"></a><span id="l5.699">         newSummaryFile-&gt;Clone(getter_AddRefs(renamedCompactedSummaryFile));</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineminus">-        if (renamedCompactedSummaryFile)</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineminus">-        {</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineminus">-          rv = renamedCompactedSummaryFile-&gt;MoveToNative((nsIFile *) nullptr, dbName);</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+        if (renamedCompactedSummaryFile) {</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineplus">+          rv = renamedCompactedSummaryFile-&gt;MoveToNative((nsIFile *)nullptr,</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+                                                         dbName);</span>
<a href="#l5.706"></a><span id="l5.706">           msfRenameSucceeded = NS_SUCCEEDED(rv);</span>
<a href="#l5.707"></a><span id="l5.707">         }</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineminus">-        NS_WARNING_ASSERTION(msfRenameSucceeded, &quot;error renaming compacted folder's db&quot;);</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+        NS_WARNING_ASSERTION(msfRenameSucceeded,</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+                             &quot;error renaming compacted folder's db&quot;);</span>
<a href="#l5.711"></a><span id="l5.711">       }</span>
<a href="#l5.712"></a><span id="l5.712"> </span>
<a href="#l5.713"></a><span id="l5.713" class="difflineminus">-      if (!msfRenameSucceeded)</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineminus">-      {</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+      if (!msfRenameSucceeded) {</span>
<a href="#l5.716"></a><span id="l5.716">         // Do our best to put the summary file back to where it was</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineminus">-        rv = tempSummaryFile-&gt;MoveToNative((nsIFile*) nullptr, dbName);</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineminus">-          tempSummaryFile = nullptr; // flagging that a renamed db no longer exists</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineminus">-        else</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+        rv = tempSummaryFile-&gt;MoveToNative((nsIFile *)nullptr, dbName);</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineplus">+          // Flagging that a renamed db no longer exists.</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+          tempSummaryFile = nullptr;</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+        } else {</span>
<a href="#l5.726"></a><span id="l5.726">           NS_WARNING(&quot;error restoring uncompacted folder's db&quot;);</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+        }</span>
<a href="#l5.728"></a><span id="l5.728">       }</span>
<a href="#l5.729"></a><span id="l5.729">     }</span>
<a href="#l5.730"></a><span id="l5.730">     // We don't want any temporarily renamed summary file to lie around</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineminus">-    if (tempSummaryFile)</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineminus">-      tempSummaryFile-&gt;Remove(false);</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+    if (tempSummaryFile) tempSummaryFile-&gt;Remove(false);</span>
<a href="#l5.734"></a><span id="l5.734">   }</span>
<a href="#l5.735"></a><span id="l5.735"> </span>
<a href="#l5.736"></a><span id="l5.736">   NS_WARNING_ASSERTION(msfRenameSucceeded, &quot;compact failed&quot;);</span>
<a href="#l5.737"></a><span id="l5.737">   nsresult rvReleaseFolderLock = ReleaseFolderLock();</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineminus">-  NS_WARNING_ASSERTION(NS_SUCCEEDED(rvReleaseFolderLock),&quot;folder lock not released successfully&quot;);</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+  NS_WARNING_ASSERTION(NS_SUCCEEDED(rvReleaseFolderLock),</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+                       &quot;folder lock not released successfully&quot;);</span>
<a href="#l5.741"></a><span id="l5.741">   rv = NS_FAILED(rv) ? rv : rvReleaseFolderLock;</span>
<a href="#l5.742"></a><span id="l5.742"> </span>
<a href="#l5.743"></a><span id="l5.743">   // Cleanup of nstmp-named compacted files if failure</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineminus">-  if (!folderRenameSucceeded)</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineminus">-  {</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+  if (!folderRenameSucceeded) {</span>
<a href="#l5.747"></a><span id="l5.747">     // remove the abandoned compacted version with the wrong name</span>
<a href="#l5.748"></a><span id="l5.748">     m_file-&gt;Remove(false);</span>
<a href="#l5.749"></a><span id="l5.749">   }</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineminus">-  if (!msfRenameSucceeded)</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineminus">-  {</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+  if (!msfRenameSucceeded) {</span>
<a href="#l5.753"></a><span id="l5.753">     // remove the abandoned compacted summary file</span>
<a href="#l5.754"></a><span id="l5.754">     newSummaryFile-&gt;Remove(false);</span>
<a href="#l5.755"></a><span id="l5.755">   }</span>
<a href="#l5.756"></a><span id="l5.756"> </span>
<a href="#l5.757"></a><span id="l5.757" class="difflineminus">-  if (msfRenameSucceeded)</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineminus">-  {</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineplus">+  if (msfRenameSucceeded) {</span>
<a href="#l5.760"></a><span id="l5.760">     // Transfer local db information from transferInfo</span>
<a href="#l5.761"></a><span id="l5.761">     nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineminus">-      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.764"></a><span id="l5.764">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.765"></a><span id="l5.765">     rv = msgDBService-&gt;OpenFolderDB(m_folder, true, getter_AddRefs(m_db));</span>
<a href="#l5.766"></a><span id="l5.766">     NS_ENSURE_TRUE(m_db, NS_FAILED(rv) ? rv : NS_ERROR_FAILURE);</span>
<a href="#l5.767"></a><span id="l5.767">     // These errors are expected.</span>
<a href="#l5.768"></a><span id="l5.768">     rv = (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING ||</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-          rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) ? NS_OK : rv;</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+          rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+             ? NS_OK</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+             : rv;</span>
<a href="#l5.773"></a><span id="l5.773">     m_db-&gt;SetSummaryValid(true);</span>
<a href="#l5.774"></a><span id="l5.774">     m_folder-&gt;SetDBTransferInfo(transferInfo);</span>
<a href="#l5.775"></a><span id="l5.775"> </span>
<a href="#l5.776"></a><span id="l5.776" class="difflineminus">-    // since we're transferring info from the old db, we need to reset the expunged bytes</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineplus">+    // since we're transferring info from the old db, we need to reset the</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+    // expunged bytes</span>
<a href="#l5.779"></a><span id="l5.779">     nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l5.780"></a><span id="l5.780">     m_db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineminus">-    if(dbFolderInfo)</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineminus">-      dbFolderInfo-&gt;SetExpungedBytes(0);</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+    if (dbFolderInfo) dbFolderInfo-&gt;SetExpungedBytes(0);</span>
<a href="#l5.784"></a><span id="l5.784">   }</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineminus">-  if (m_db)</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineminus">-    m_db-&gt;Close(true);</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+  if (m_db) m_db-&gt;Close(true);</span>
<a href="#l5.788"></a><span id="l5.788">   m_db = nullptr;</span>
<a href="#l5.789"></a><span id="l5.789"> </span>
<a href="#l5.790"></a><span id="l5.790">   // Notify that compaction of the folder is completed.</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineminus">-    notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.795"></a><span id="l5.795">   if (notifier)</span>
<a href="#l5.796"></a><span id="l5.796">     notifier-&gt;NotifyItemEvent(m_folder,</span>
<a href="#l5.797"></a><span id="l5.797">                               NS_LITERAL_CSTRING(&quot;FolderCompactFinish&quot;),</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineminus">-                              nullptr,</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineminus">-                              EmptyCString());</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+                              nullptr, EmptyCString());</span>
<a href="#l5.801"></a><span id="l5.801">   m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l5.802"></a><span id="l5.802"> </span>
<a href="#l5.803"></a><span id="l5.803">   if (m_compactAll)</span>
<a href="#l5.804"></a><span id="l5.804">     rv = CompactNextFolder();</span>
<a href="#l5.805"></a><span id="l5.805">   else</span>
<a href="#l5.806"></a><span id="l5.806">     CompactCompleted(rv);</span>
<a href="#l5.807"></a><span id="l5.807"> </span>
<a href="#l5.808"></a><span id="l5.808">   return rv;</span>
<a href="#l5.809"></a><span id="l5.809"> }</span>
<a href="#l5.810"></a><span id="l5.810"> </span>
<a href="#l5.811"></a><span id="l5.811" class="difflineminus">-</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineminus">-void nsFolderCompactState::CompactCompleted(nsresult exitCode)</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineminus">-{</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+void nsFolderCompactState::CompactCompleted(nsresult exitCode) {</span>
<a href="#l5.815"></a><span id="l5.815">   NS_WARNING_ASSERTION(NS_SUCCEEDED(exitCode),</span>
<a href="#l5.816"></a><span id="l5.816">                        &quot;nsFolderCompactState::CompactCompleted failed&quot;);</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineminus">-  if (m_listener)</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineminus">-    m_listener-&gt;OnStopRunningUrl(nullptr, exitCode);</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+  if (m_listener) m_listener-&gt;OnStopRunningUrl(nullptr, exitCode);</span>
<a href="#l5.820"></a><span id="l5.820">   ShowDoneStatus();</span>
<a href="#l5.821"></a><span id="l5.821"> }</span>
<a href="#l5.822"></a><span id="l5.822"> </span>
<a href="#l5.823"></a><span id="l5.823" class="difflineminus">-nsresult</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineminus">-nsFolderCompactState::ReleaseFolderLock()</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineminus">-{</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineplus">+nsresult nsFolderCompactState::ReleaseFolderLock() {</span>
<a href="#l5.827"></a><span id="l5.827">   nsresult result = NS_OK;</span>
<a href="#l5.828"></a><span id="l5.828">   if (!m_folder) return result;</span>
<a href="#l5.829"></a><span id="l5.829">   bool haveSemaphore;</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMsgFolderCompactor*&gt;(this));</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports =</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineplus">+      do_QueryInterface(static_cast&lt;nsIMsgFolderCompactor *&gt;(this));</span>
<a href="#l5.833"></a><span id="l5.833">   result = m_folder-&gt;TestSemaphore(supports, &amp;haveSemaphore);</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineminus">-  if(NS_SUCCEEDED(result) &amp;&amp; haveSemaphore)</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+  if (NS_SUCCEEDED(result) &amp;&amp; haveSemaphore)</span>
<a href="#l5.836"></a><span id="l5.836">     result = m_folder-&gt;ReleaseSemaphore(supports);</span>
<a href="#l5.837"></a><span id="l5.837">   return result;</span>
<a href="#l5.838"></a><span id="l5.838"> }</span>
<a href="#l5.839"></a><span id="l5.839"> </span>
<a href="#l5.840"></a><span id="l5.840" class="difflineminus">-void nsFolderCompactState::ShowDoneStatus()</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineminus">-{</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineminus">-  if (m_folder)</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineminus">-  {</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineplus">+void nsFolderCompactState::ShowDoneStatus() {</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+  if (m_folder) {</span>
<a href="#l5.846"></a><span id="l5.846">     nsString statusString;</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineminus">-    nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+    nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.849"></a><span id="l5.849">     nsresult rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l5.850"></a><span id="l5.850">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l5.851"></a><span id="l5.851">     nsAutoString expungedAmount;</span>
<a href="#l5.852"></a><span id="l5.852">     FormatFileSize(m_totalExpungedBytes, true, expungedAmount);</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineminus">-    const char16_t* params[] = { expungedAmount.get() };</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(&quot;compactingDone&quot;,</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineminus">-                                      params, 1, statusString);</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineplus">+    const char16_t *params[] = {expungedAmount.get()};</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineplus">+    rv =</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineplus">+        bundle-&gt;FormatStringFromName(&quot;compactingDone&quot;, params, 1, statusString);</span>
<a href="#l5.859"></a><span id="l5.859"> </span>
<a href="#l5.860"></a><span id="l5.860">     if (!statusString.IsEmpty() &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l5.861"></a><span id="l5.861">       ShowStatusMsg(statusString);</span>
<a href="#l5.862"></a><span id="l5.862">   }</span>
<a href="#l5.863"></a><span id="l5.863"> }</span>
<a href="#l5.864"></a><span id="l5.864"> </span>
<a href="#l5.865"></a><span id="l5.865" class="difflineminus">-nsresult</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineminus">-nsFolderCompactState::CompactNextFolder()</span>
<a href="#l5.867"></a><span id="l5.867" class="difflineminus">-{</span>
<a href="#l5.868"></a><span id="l5.868" class="difflineplus">+nsresult nsFolderCompactState::CompactNextFolder() {</span>
<a href="#l5.869"></a><span id="l5.869">   m_folderIndex++;</span>
<a href="#l5.870"></a><span id="l5.870">   uint32_t cnt = 0;</span>
<a href="#l5.871"></a><span id="l5.871">   nsresult rv = m_folderArray-&gt;GetLength(&amp;cnt);</span>
<a href="#l5.872"></a><span id="l5.872">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.873"></a><span id="l5.873">   // m_folderIndex might be &gt; cnt if we compact offline stores,</span>
<a href="#l5.874"></a><span id="l5.874">   // and get back here from OnStopRunningUrl.</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineminus">-  if (m_folderIndex &gt;= cnt)</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-  {</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineminus">-    if (!m_compactOfflineAlso || m_compactingOfflineFolders)</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineminus">-    {</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineplus">+  if (m_folderIndex &gt;= cnt) {</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+    if (!m_compactOfflineAlso || m_compactingOfflineFolders) {</span>
<a href="#l5.881"></a><span id="l5.881">       CompactCompleted(NS_OK);</span>
<a href="#l5.882"></a><span id="l5.882">       return rv;</span>
<a href="#l5.883"></a><span id="l5.883">     }</span>
<a href="#l5.884"></a><span id="l5.884">     m_compactingOfflineFolders = true;</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(m_folderArray,</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-                                                      m_folderIndex-1, &amp;rv);</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder =</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineplus">+        do_QueryElementAt(m_folderArray, m_folderIndex - 1, &amp;rv);</span>
<a href="#l5.889"></a><span id="l5.889">     if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineminus">-      return folder-&gt;CompactAllOfflineStores(this, m_window, m_offlineFolderArray);</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineplus">+      return folder-&gt;CompactAllOfflineStores(this, m_window,</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+                                             m_offlineFolderArray);</span>
<a href="#l5.893"></a><span id="l5.893">     else</span>
<a href="#l5.894"></a><span id="l5.894">       NS_WARNING(&quot;couldn't get folder to compact offline stores&quot;);</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineminus">-</span>
<a href="#l5.896"></a><span id="l5.896">   }</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(m_folderArray,</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineminus">-                                                    m_folderIndex, &amp;rv);</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder =</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineplus">+      do_QueryElementAt(m_folderArray, m_folderIndex, &amp;rv);</span>
<a href="#l5.901"></a><span id="l5.901"> </span>
<a href="#l5.902"></a><span id="l5.902">   if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l5.903"></a><span id="l5.903">     rv = Compact(folder, m_compactingOfflineFolders, m_listener, m_window);</span>
<a href="#l5.904"></a><span id="l5.904">   else</span>
<a href="#l5.905"></a><span id="l5.905">     CompactCompleted(rv);</span>
<a href="#l5.906"></a><span id="l5.906">   return rv;</span>
<a href="#l5.907"></a><span id="l5.907"> }</span>
<a href="#l5.908"></a><span id="l5.908"> </span>
<a href="#l5.909"></a><span id="l5.909" class="difflineminus">-nsresult</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineminus">-nsFolderCompactState::GetMessage(nsIMsgDBHdr **message)</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineminus">-{</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineplus">+nsresult nsFolderCompactState::GetMessage(nsIMsgDBHdr **message) {</span>
<a href="#l5.913"></a><span id="l5.913">   return GetMsgDBHdrFromURI(m_messageUri.get(), message);</span>
<a href="#l5.914"></a><span id="l5.914"> }</span>
<a href="#l5.915"></a><span id="l5.915"> </span>
<a href="#l5.916"></a><span id="l5.916" class="difflineminus">-</span>
<a href="#l5.917"></a><span id="l5.917"> NS_IMETHODIMP</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-nsFolderCompactState::OnStartRequest(nsIRequest *request)</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-{</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineplus">+nsFolderCompactState::OnStartRequest(nsIRequest *request) {</span>
<a href="#l5.921"></a><span id="l5.921">   return StartMessage();</span>
<a href="#l5.922"></a><span id="l5.922"> }</span>
<a href="#l5.923"></a><span id="l5.923"> </span>
<a href="#l5.924"></a><span id="l5.924"> NS_IMETHODIMP</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineminus">-nsFolderCompactState::OnStopRequest(nsIRequest *request, nsresult status)</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineminus">-{</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineplus">+nsFolderCompactState::OnStopRequest(nsIRequest *request, nsresult status) {</span>
<a href="#l5.928"></a><span id="l5.928">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineminus">-  {</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineminus">-    m_status = status; // set the m_status to status so the destructor can remove the</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineminus">-                       // temp folder and database</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+  if (NS_FAILED(status)) {</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineplus">+    // Set m_status to status so the destructor can remove the temp folder and</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineplus">+    // database.</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineplus">+    m_status = status;</span>
<a href="#l5.937"></a><span id="l5.937">     CleanupTempFilesAfterError();</span>
<a href="#l5.938"></a><span id="l5.938">     m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l5.939"></a><span id="l5.939">     ReleaseFolderLock();</span>
<a href="#l5.940"></a><span id="l5.940">     m_folder-&gt;ThrowAlertMsg(&quot;compactFolderWriteFailed&quot;, m_window);</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineminus">-  }</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineminus">-  else</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineminus">-  {</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineplus">+  } else {</span>
<a href="#l5.945"></a><span id="l5.945">     // XXX TODO: Error checking and handling missing here.</span>
<a href="#l5.946"></a><span id="l5.946">     EndCopy(nullptr, status);</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineminus">-    if (m_curIndex &gt;= m_size)</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineminus">-    {</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineplus">+    if (m_curIndex &gt;= m_size) {</span>
<a href="#l5.950"></a><span id="l5.950">       msgHdr = nullptr;</span>
<a href="#l5.951"></a><span id="l5.951">       // no more to copy finish it up</span>
<a href="#l5.952"></a><span id="l5.952">       FinishCompact();</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineminus">-    }</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-    else</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineminus">-    {</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineminus">-      // in case we're not getting an error, we still need to pretend we did get an error,</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineminus">-      // because the compact did not successfully complete.</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineplus">+    } else {</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+      // in case we're not getting an error, we still need to pretend we did get</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+      // an error, because the compact did not successfully complete.</span>
<a href="#l5.961"></a><span id="l5.961">       m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l5.962"></a><span id="l5.962">       CleanupTempFilesAfterError();</span>
<a href="#l5.963"></a><span id="l5.963">       ReleaseFolderLock();</span>
<a href="#l5.964"></a><span id="l5.964">     }</span>
<a href="#l5.965"></a><span id="l5.965">   }</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineminus">-  NS_RELEASE_THIS(); // kill self</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineplus">+  NS_RELEASE_THIS();  // kill self</span>
<a href="#l5.968"></a><span id="l5.968">   return status;</span>
<a href="#l5.969"></a><span id="l5.969"> }</span>
<a href="#l5.970"></a><span id="l5.970"> </span>
<a href="#l5.971"></a><span id="l5.971"> NS_IMETHODIMP</span>
<a href="#l5.972"></a><span id="l5.972"> nsFolderCompactState::OnDataAvailable(nsIRequest *request,</span>
<a href="#l5.973"></a><span id="l5.973">                                       nsIInputStream *inStr,</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineminus">-                                      uint64_t sourceOffset, uint32_t count)</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineminus">-{</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-  if (!m_fileStream || !inStr)</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineplus">+                                      uint64_t sourceOffset, uint32_t count) {</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineplus">+  if (!m_fileStream || !inStr) return NS_ERROR_FAILURE;</span>
<a href="#l5.980"></a><span id="l5.980"> </span>
<a href="#l5.981"></a><span id="l5.981">   nsresult rv = NS_OK;</span>
<a href="#l5.982"></a><span id="l5.982">   uint32_t msgFlags;</span>
<a href="#l5.983"></a><span id="l5.983">   bool checkForKeyword = m_startOfMsg;</span>
<a href="#l5.984"></a><span id="l5.984">   bool addKeywordHdr = false;</span>
<a href="#l5.985"></a><span id="l5.985">   uint32_t needToGrowKeywords = 0;</span>
<a href="#l5.986"></a><span id="l5.986">   uint32_t statusOffset;</span>
<a href="#l5.987"></a><span id="l5.987">   nsCString msgHdrKeywords;</span>
<a href="#l5.988"></a><span id="l5.988"> </span>
<a href="#l5.989"></a><span id="l5.989" class="difflineminus">-  if (m_startOfMsg)</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineminus">-  {</span>
<a href="#l5.991"></a><span id="l5.991" class="difflineplus">+  if (m_startOfMsg) {</span>
<a href="#l5.992"></a><span id="l5.992">     m_statusOffset = 0;</span>
<a href="#l5.993"></a><span id="l5.993">     m_addedHeaderSize = 0;</span>
<a href="#l5.994"></a><span id="l5.994" class="difflineminus">-    m_messageUri.Truncate(); // clear the previous message uri</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineminus">-    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(), m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineminus">-                                m_messageUri)))</span>
<a href="#l5.997"></a><span id="l5.997" class="difflineminus">-    {</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineplus">+    m_messageUri.Truncate();  // clear the previous message uri</span>
<a href="#l5.999"></a><span id="l5.999" class="difflineplus">+    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(),</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineplus">+                                     m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineplus">+                                     m_messageUri))) {</span>
<a href="#l5.1002"></a><span id="l5.1002">       rv = GetMessage(getter_AddRefs(m_curSrcHdr));</span>
<a href="#l5.1003"></a><span id="l5.1003">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1004"></a><span id="l5.1004" class="difflineminus">-      if (m_curSrcHdr)</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineminus">-      {</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineminus">-        (void) m_curSrcHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineminus">-        (void) m_curSrcHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineplus">+      if (m_curSrcHdr) {</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineplus">+        (void)m_curSrcHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineplus">+        (void)m_curSrcHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l5.1011"></a><span id="l5.1011"> </span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineminus">-        if (statusOffset == 0)</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineminus">-          m_needStatusLine = true;</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineminus">-        // x-mozilla-status lines should be at the start of the headers, and the code</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineminus">-        // below assumes everything will fit in m_dataBuffer - if there's not</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineminus">-        // room, skip the keyword stuff.</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineminus">-        if (statusOffset &gt; sizeof(m_dataBuffer) - 1024)</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineminus">-        {</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineplus">+        if (statusOffset == 0) m_needStatusLine = true;</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineplus">+        // x-mozilla-status lines should be at the start of the headers, and the</span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineplus">+        // code below assumes everything will fit in m_dataBuffer - if there's</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineplus">+        // not room, skip the keyword stuff.</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineplus">+        if (statusOffset &gt; sizeof(m_dataBuffer) - 1024) {</span>
<a href="#l5.1024"></a><span id="l5.1024">           checkForKeyword = false;</span>
<a href="#l5.1025"></a><span id="l5.1025">           NS_ASSERTION(false, &quot;status offset past end of read buffer size&quot;);</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineminus">-</span>
<a href="#l5.1027"></a><span id="l5.1027">         }</span>
<a href="#l5.1028"></a><span id="l5.1028">       }</span>
<a href="#l5.1029"></a><span id="l5.1029">     }</span>
<a href="#l5.1030"></a><span id="l5.1030">     m_startOfMsg = false;</span>
<a href="#l5.1031"></a><span id="l5.1031">   }</span>
<a href="#l5.1032"></a><span id="l5.1032">   uint32_t maxReadCount, readCount, writeCount;</span>
<a href="#l5.1033"></a><span id="l5.1033">   uint32_t bytesWritten;</span>
<a href="#l5.1034"></a><span id="l5.1034"> </span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; (int32_t) count &gt; 0)</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineminus">-  {</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineminus">-    maxReadCount = count &gt; sizeof(m_dataBuffer) - 1 ? sizeof(m_dataBuffer) - 1 : count;</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; (int32_t)count &gt; 0) {</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineplus">+    maxReadCount =</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+        count &gt; sizeof(m_dataBuffer) - 1 ? sizeof(m_dataBuffer) - 1 : count;</span>
<a href="#l5.1041"></a><span id="l5.1041">     writeCount = 0;</span>
<a href="#l5.1042"></a><span id="l5.1042">     rv = inStr-&gt;Read(m_dataBuffer, maxReadCount, &amp;readCount);</span>
<a href="#l5.1043"></a><span id="l5.1043"> </span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineminus">-    // if status offset is past the number of bytes we read, it's probably bogus,</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineminus">-    // and we shouldn't do any of the keyword stuff.</span>
<a href="#l5.1046"></a><span id="l5.1046" class="difflineplus">+    // if status offset is past the number of bytes we read, it's probably</span>
<a href="#l5.1047"></a><span id="l5.1047" class="difflineplus">+    // bogus, and we shouldn't do any of the keyword stuff.</span>
<a href="#l5.1048"></a><span id="l5.1048">     if (statusOffset + X_MOZILLA_STATUS_LEN &gt; readCount)</span>
<a href="#l5.1049"></a><span id="l5.1049">       checkForKeyword = false;</span>
<a href="#l5.1050"></a><span id="l5.1050"> </span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineminus">-    {</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineminus">-      if (checkForKeyword)</span>
<a href="#l5.1054"></a><span id="l5.1054" class="difflineminus">-      {</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineplus">+      if (checkForKeyword) {</span>
<a href="#l5.1057"></a><span id="l5.1057">         // make sure that status offset really points to x-mozilla-status line</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineminus">-        if  (!strncmp(m_dataBuffer + statusOffset, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN))</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineminus">-        {</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineminus">-          const char *keywordHdr = PL_strnrstr(m_dataBuffer, HEADER_X_MOZILLA_KEYWORDS, readCount);</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineplus">+        if (!strncmp(m_dataBuffer + statusOffset, X_MOZILLA_STATUS,</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineplus">+                     X_MOZILLA_STATUS_LEN)) {</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineplus">+          const char *keywordHdr =</span>
<a href="#l5.1064"></a><span id="l5.1064" class="difflineplus">+              PL_strnrstr(m_dataBuffer, HEADER_X_MOZILLA_KEYWORDS, readCount);</span>
<a href="#l5.1065"></a><span id="l5.1065">           if (keywordHdr)</span>
<a href="#l5.1066"></a><span id="l5.1066">             m_curSrcHdr-&gt;GetUint32Property(&quot;growKeywords&quot;, &amp;needToGrowKeywords);</span>
<a href="#l5.1067"></a><span id="l5.1067">           else</span>
<a href="#l5.1068"></a><span id="l5.1068">             addKeywordHdr = true;</span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineminus">-          m_curSrcHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(msgHdrKeywords));</span>
<a href="#l5.1070"></a><span id="l5.1070" class="difflineplus">+          m_curSrcHdr-&gt;GetStringProperty(&quot;keywords&quot;,</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineplus">+                                         getter_Copies(msgHdrKeywords));</span>
<a href="#l5.1072"></a><span id="l5.1072">         }</span>
<a href="#l5.1073"></a><span id="l5.1073">         checkForKeyword = false;</span>
<a href="#l5.1074"></a><span id="l5.1074">       }</span>
<a href="#l5.1075"></a><span id="l5.1075">       uint32_t blockOffset = 0;</span>
<a href="#l5.1076"></a><span id="l5.1076" class="difflineminus">-      if (m_needStatusLine)</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineminus">-      {</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineplus">+      if (m_needStatusLine) {</span>
<a href="#l5.1079"></a><span id="l5.1079">         m_needStatusLine = false;</span>
<a href="#l5.1080"></a><span id="l5.1080">         // we need to parse out the &quot;From &quot; header, write it out, then</span>
<a href="#l5.1081"></a><span id="l5.1081">         // write out the x-mozilla-status headers, and set the</span>
<a href="#l5.1082"></a><span id="l5.1082">         // status offset of the dest hdr for later use</span>
<a href="#l5.1083"></a><span id="l5.1083">         // in OnEndCopy).</span>
<a href="#l5.1084"></a><span id="l5.1084" class="difflineminus">-        if (!strncmp(m_dataBuffer, &quot;From &quot;, 5))</span>
<a href="#l5.1085"></a><span id="l5.1085" class="difflineminus">-        {</span>
<a href="#l5.1086"></a><span id="l5.1086" class="difflineplus">+        if (!strncmp(m_dataBuffer, &quot;From &quot;, 5)) {</span>
<a href="#l5.1087"></a><span id="l5.1087">           blockOffset = 5;</span>
<a href="#l5.1088"></a><span id="l5.1088">           // skip from line</span>
<a href="#l5.1089"></a><span id="l5.1089">           MsgAdvanceToNextLine(m_dataBuffer, blockOffset, readCount);</span>
<a href="#l5.1090"></a><span id="l5.1090">           char statusLine[50];</span>
<a href="#l5.1091"></a><span id="l5.1091">           m_fileStream-&gt;Write(m_dataBuffer, blockOffset, &amp;writeCount);</span>
<a href="#l5.1092"></a><span id="l5.1092">           m_statusOffset = blockOffset;</span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineminus">-          PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineminus">-          m_fileStream-&gt;Write(statusLine, strlen(statusLine), &amp;m_addedHeaderSize);</span>
<a href="#l5.1095"></a><span id="l5.1095" class="difflineminus">-          PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF0000);</span>
<a href="#l5.1096"></a><span id="l5.1096" class="difflineplus">+          PR_snprintf(statusLine, sizeof(statusLine),</span>
<a href="#l5.1097"></a><span id="l5.1097" class="difflineplus">+                      X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l5.1098"></a><span id="l5.1098" class="difflineplus">+          m_fileStream-&gt;Write(statusLine, strlen(statusLine),</span>
<a href="#l5.1099"></a><span id="l5.1099" class="difflineplus">+                              &amp;m_addedHeaderSize);</span>
<a href="#l5.1100"></a><span id="l5.1100" class="difflineplus">+          PR_snprintf(statusLine, sizeof(statusLine),</span>
<a href="#l5.1101"></a><span id="l5.1101" class="difflineplus">+                      X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK,</span>
<a href="#l5.1102"></a><span id="l5.1102" class="difflineplus">+                      msgFlags &amp; 0xFFFF0000);</span>
<a href="#l5.1103"></a><span id="l5.1103">           m_fileStream-&gt;Write(statusLine, strlen(statusLine), &amp;bytesWritten);</span>
<a href="#l5.1104"></a><span id="l5.1104">           m_addedHeaderSize += bytesWritten;</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineminus">-        }</span>
<a href="#l5.1106"></a><span id="l5.1106" class="difflineminus">-        else</span>
<a href="#l5.1107"></a><span id="l5.1107" class="difflineminus">-        {</span>
<a href="#l5.1108"></a><span id="l5.1108" class="difflineplus">+        } else {</span>
<a href="#l5.1109"></a><span id="l5.1109">           NS_ASSERTION(false, &quot;not an envelope&quot;);</span>
<a href="#l5.1110"></a><span id="l5.1110">           // try to mark the db as invalid so it will be reparsed.</span>
<a href="#l5.1111"></a><span id="l5.1111" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l5.1113"></a><span id="l5.1113">           m_folder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineminus">-          if (srcDB)</span>
<a href="#l5.1115"></a><span id="l5.1115" class="difflineminus">-          {</span>
<a href="#l5.1116"></a><span id="l5.1116" class="difflineplus">+          if (srcDB) {</span>
<a href="#l5.1117"></a><span id="l5.1117">             srcDB-&gt;SetSummaryValid(false);</span>
<a href="#l5.1118"></a><span id="l5.1118">             srcDB-&gt;ForceClosed();</span>
<a href="#l5.1119"></a><span id="l5.1119">           }</span>
<a href="#l5.1120"></a><span id="l5.1120">         }</span>
<a href="#l5.1121"></a><span id="l5.1121">       }</span>
<a href="#l5.1122"></a><span id="l5.1122" class="difflineminus">-#define EXTRA_KEYWORD_HDR &quot;                                                                                 &quot; MSG_LINEBREAK</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineplus">+// clang-format off</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineplus">+#define EXTRA_KEYWORD_HDR                                                             \</span>
<a href="#l5.1125"></a><span id="l5.1125" class="difflineplus">+  &quot;                                                                                 &quot; \</span>
<a href="#l5.1126"></a><span id="l5.1126" class="difflineplus">+  MSG_LINEBREAK</span>
<a href="#l5.1127"></a><span id="l5.1127" class="difflineplus">+      // clang-format on</span>
<a href="#l5.1128"></a><span id="l5.1128"> </span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineminus">-       // if status offset isn't in the first block, this code won't work. There's no good reason</span>
<a href="#l5.1130"></a><span id="l5.1130" class="difflineplus">+      // if status offset isn't in the first block, this code won't work.</span>
<a href="#l5.1131"></a><span id="l5.1131" class="difflineplus">+      // There's no good reason</span>
<a href="#l5.1132"></a><span id="l5.1132">       // for the status offset not to be at the beginning of the message anyway.</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineminus">-      if (addKeywordHdr)</span>
<a href="#l5.1134"></a><span id="l5.1134" class="difflineminus">-      {</span>
<a href="#l5.1135"></a><span id="l5.1135" class="difflineplus">+      if (addKeywordHdr) {</span>
<a href="#l5.1136"></a><span id="l5.1136">         // if blockOffset is set, we added x-mozilla-status headers so</span>
<a href="#l5.1137"></a><span id="l5.1137">         // file pointer is already past them.</span>
<a href="#l5.1138"></a><span id="l5.1138" class="difflineminus">-        if (!blockOffset)</span>
<a href="#l5.1139"></a><span id="l5.1139" class="difflineminus">-        {</span>
<a href="#l5.1140"></a><span id="l5.1140" class="difflineplus">+        if (!blockOffset) {</span>
<a href="#l5.1141"></a><span id="l5.1141">           blockOffset = statusOffset;</span>
<a href="#l5.1142"></a><span id="l5.1142">           // skip x-mozilla-status and status2 lines.</span>
<a href="#l5.1143"></a><span id="l5.1143">           MsgAdvanceToNextLine(m_dataBuffer, blockOffset, readCount);</span>
<a href="#l5.1144"></a><span id="l5.1144">           MsgAdvanceToNextLine(m_dataBuffer, blockOffset, readCount);</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineminus">-          // need to rewrite the headers up to and including the x-mozilla-status2 header</span>
<a href="#l5.1146"></a><span id="l5.1146" class="difflineplus">+          // need to rewrite the headers up to and including the</span>
<a href="#l5.1147"></a><span id="l5.1147" class="difflineplus">+          // x-mozilla-status2 header</span>
<a href="#l5.1148"></a><span id="l5.1148">           m_fileStream-&gt;Write(m_dataBuffer, blockOffset, &amp;writeCount);</span>
<a href="#l5.1149"></a><span id="l5.1149">         }</span>
<a href="#l5.1150"></a><span id="l5.1150">         // we should write out the existing keywords from the msg hdr, if any.</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineminus">-        if (msgHdrKeywords.IsEmpty())</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineminus">-        { // no keywords, so write blank header</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineminus">-          m_fileStream-&gt;Write(X_MOZILLA_KEYWORDS, sizeof(X_MOZILLA_KEYWORDS) - 1, &amp;bytesWritten);</span>
<a href="#l5.1154"></a><span id="l5.1154" class="difflineplus">+        if (msgHdrKeywords.IsEmpty()) {  // no keywords, so write blank header</span>
<a href="#l5.1155"></a><span id="l5.1155" class="difflineplus">+          m_fileStream-&gt;Write(X_MOZILLA_KEYWORDS,</span>
<a href="#l5.1156"></a><span id="l5.1156" class="difflineplus">+                              sizeof(X_MOZILLA_KEYWORDS) - 1, &amp;bytesWritten);</span>
<a href="#l5.1157"></a><span id="l5.1157">           m_addedHeaderSize += bytesWritten;</span>
<a href="#l5.1158"></a><span id="l5.1158" class="difflineminus">-        }</span>
<a href="#l5.1159"></a><span id="l5.1159" class="difflineminus">-        else</span>
<a href="#l5.1160"></a><span id="l5.1160" class="difflineminus">-        {</span>
<a href="#l5.1161"></a><span id="l5.1161" class="difflineminus">-          if (msgHdrKeywords.Length() &lt; sizeof(X_MOZILLA_KEYWORDS) - sizeof(HEADER_X_MOZILLA_KEYWORDS) + 10 /* allow some slop */)</span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineminus">-          { // keywords fit in normal blank header, so replace blanks in keyword hdr with keywords</span>
<a href="#l5.1163"></a><span id="l5.1163" class="difflineplus">+        } else {</span>
<a href="#l5.1164"></a><span id="l5.1164" class="difflineplus">+          if (msgHdrKeywords.Length() &lt; sizeof(X_MOZILLA_KEYWORDS) -</span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineplus">+                                            sizeof(HEADER_X_MOZILLA_KEYWORDS) +</span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineplus">+                                            10 /* allow some slop */) {</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineplus">+            // Keywords fit in normal blank header, so replace blanks in</span>
<a href="#l5.1168"></a><span id="l5.1168" class="difflineplus">+            // keyword hdr with keywords.</span>
<a href="#l5.1169"></a><span id="l5.1169">             nsAutoCString keywordsHdr(X_MOZILLA_KEYWORDS);</span>
<a href="#l5.1170"></a><span id="l5.1170" class="difflineminus">-            keywordsHdr.Replace(sizeof(HEADER_X_MOZILLA_KEYWORDS) + 1, msgHdrKeywords.Length(), msgHdrKeywords);</span>
<a href="#l5.1171"></a><span id="l5.1171" class="difflineminus">-            m_fileStream-&gt;Write(keywordsHdr.get(), keywordsHdr.Length(), &amp;bytesWritten);</span>
<a href="#l5.1172"></a><span id="l5.1172" class="difflineplus">+            keywordsHdr.Replace(sizeof(HEADER_X_MOZILLA_KEYWORDS) + 1,</span>
<a href="#l5.1173"></a><span id="l5.1173" class="difflineplus">+                                msgHdrKeywords.Length(), msgHdrKeywords);</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineplus">+            m_fileStream-&gt;Write(keywordsHdr.get(), keywordsHdr.Length(),</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineplus">+                                &amp;bytesWritten);</span>
<a href="#l5.1176"></a><span id="l5.1176">             m_addedHeaderSize += bytesWritten;</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineminus">-          }</span>
<a href="#l5.1178"></a><span id="l5.1178" class="difflineminus">-          else</span>
<a href="#l5.1179"></a><span id="l5.1179" class="difflineminus">-          { // keywords don't fit, so write out keywords on one line and an extra blank line</span>
<a href="#l5.1180"></a><span id="l5.1180" class="difflineplus">+          } else {</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineplus">+            // Keywords don't fit, so write out keywords on one line and</span>
<a href="#l5.1182"></a><span id="l5.1182" class="difflineplus">+            // an extra blank line.</span>
<a href="#l5.1183"></a><span id="l5.1183">             nsCString newKeywordHeader(HEADER_X_MOZILLA_KEYWORDS &quot;: &quot;);</span>
<a href="#l5.1184"></a><span id="l5.1184">             newKeywordHeader.Append(msgHdrKeywords);</span>
<a href="#l5.1185"></a><span id="l5.1185">             newKeywordHeader.Append(MSG_LINEBREAK EXTRA_KEYWORD_HDR);</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineminus">-            m_fileStream-&gt;Write(newKeywordHeader.get(), newKeywordHeader.Length(), &amp;bytesWritten);</span>
<a href="#l5.1187"></a><span id="l5.1187" class="difflineplus">+            m_fileStream-&gt;Write(newKeywordHeader.get(),</span>
<a href="#l5.1188"></a><span id="l5.1188" class="difflineplus">+                                newKeywordHeader.Length(), &amp;bytesWritten);</span>
<a href="#l5.1189"></a><span id="l5.1189">             m_addedHeaderSize += bytesWritten;</span>
<a href="#l5.1190"></a><span id="l5.1190">           }</span>
<a href="#l5.1191"></a><span id="l5.1191">         }</span>
<a href="#l5.1192"></a><span id="l5.1192">         addKeywordHdr = false;</span>
<a href="#l5.1193"></a><span id="l5.1193" class="difflineminus">-      }</span>
<a href="#l5.1194"></a><span id="l5.1194" class="difflineminus">-      else if (needToGrowKeywords)</span>
<a href="#l5.1195"></a><span id="l5.1195" class="difflineminus">-      {</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineplus">+      } else if (needToGrowKeywords) {</span>
<a href="#l5.1197"></a><span id="l5.1197">         blockOffset = statusOffset;</span>
<a href="#l5.1198"></a><span id="l5.1198" class="difflineminus">-        if (!strncmp(m_dataBuffer + blockOffset, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN))</span>
<a href="#l5.1199"></a><span id="l5.1199" class="difflineminus">-          MsgAdvanceToNextLine(m_dataBuffer, blockOffset, readCount); // skip x-mozilla-status hdr</span>
<a href="#l5.1200"></a><span id="l5.1200" class="difflineminus">-        if (!strncmp(m_dataBuffer + blockOffset, X_MOZILLA_STATUS2, X_MOZILLA_STATUS2_LEN))</span>
<a href="#l5.1201"></a><span id="l5.1201" class="difflineminus">-          MsgAdvanceToNextLine(m_dataBuffer, blockOffset, readCount); // skip x-mozilla-status2 hdr</span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineplus">+        if (!strncmp(m_dataBuffer + blockOffset, X_MOZILLA_STATUS,</span>
<a href="#l5.1203"></a><span id="l5.1203" class="difflineplus">+                     X_MOZILLA_STATUS_LEN))</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineplus">+          MsgAdvanceToNextLine(m_dataBuffer, blockOffset,</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineplus">+                               readCount);  // skip x-mozilla-status hdr</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineplus">+        if (!strncmp(m_dataBuffer + blockOffset, X_MOZILLA_STATUS2,</span>
<a href="#l5.1207"></a><span id="l5.1207" class="difflineplus">+                     X_MOZILLA_STATUS2_LEN))</span>
<a href="#l5.1208"></a><span id="l5.1208" class="difflineplus">+          MsgAdvanceToNextLine(m_dataBuffer, blockOffset,</span>
<a href="#l5.1209"></a><span id="l5.1209" class="difflineplus">+                               readCount);  // skip x-mozilla-status2 hdr</span>
<a href="#l5.1210"></a><span id="l5.1210">         uint32_t preKeywordBlockOffset = blockOffset;</span>
<a href="#l5.1211"></a><span id="l5.1211" class="difflineminus">-        if (!strncmp(m_dataBuffer + blockOffset, HEADER_X_MOZILLA_KEYWORDS, sizeof(HEADER_X_MOZILLA_KEYWORDS) - 1))</span>
<a href="#l5.1212"></a><span id="l5.1212" class="difflineminus">-        {</span>
<a href="#l5.1213"></a><span id="l5.1213" class="difflineminus">-          do</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineminus">-          {</span>
<a href="#l5.1215"></a><span id="l5.1215" class="difflineplus">+        if (!strncmp(m_dataBuffer + blockOffset, HEADER_X_MOZILLA_KEYWORDS,</span>
<a href="#l5.1216"></a><span id="l5.1216" class="difflineplus">+                     sizeof(HEADER_X_MOZILLA_KEYWORDS) - 1)) {</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineplus">+          do {</span>
<a href="#l5.1218"></a><span id="l5.1218">             // skip x-mozilla-keywords hdr and any existing continuation headers</span>
<a href="#l5.1219"></a><span id="l5.1219">             MsgAdvanceToNextLine(m_dataBuffer, blockOffset, readCount);</span>
<a href="#l5.1220"></a><span id="l5.1220" class="difflineminus">-          }</span>
<a href="#l5.1221"></a><span id="l5.1221" class="difflineminus">-          while (m_dataBuffer[blockOffset] == ' ');</span>
<a href="#l5.1222"></a><span id="l5.1222" class="difflineplus">+          } while (m_dataBuffer[blockOffset] == ' ');</span>
<a href="#l5.1223"></a><span id="l5.1223">         }</span>
<a href="#l5.1224"></a><span id="l5.1224">         int32_t oldKeywordSize = blockOffset - preKeywordBlockOffset;</span>
<a href="#l5.1225"></a><span id="l5.1225"> </span>
<a href="#l5.1226"></a><span id="l5.1226">         // rewrite the headers up to and including the x-mozilla-status2 header</span>
<a href="#l5.1227"></a><span id="l5.1227">         m_fileStream-&gt;Write(m_dataBuffer, preKeywordBlockOffset, &amp;writeCount);</span>
<a href="#l5.1228"></a><span id="l5.1228" class="difflineminus">-        // let's just rewrite all the keywords on several lines and add a blank line,</span>
<a href="#l5.1229"></a><span id="l5.1229" class="difflineminus">-        // instead of worrying about which are missing.</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineplus">+        // let's just rewrite all the keywords on several lines and add a blank</span>
<a href="#l5.1231"></a><span id="l5.1231" class="difflineplus">+        // line, instead of worrying about which are missing.</span>
<a href="#l5.1232"></a><span id="l5.1232">         bool done = false;</span>
<a href="#l5.1233"></a><span id="l5.1233">         nsAutoCString keywordHdr(HEADER_X_MOZILLA_KEYWORDS &quot;: &quot;);</span>
<a href="#l5.1234"></a><span id="l5.1234">         int32_t nextBlankOffset = 0;</span>
<a href="#l5.1235"></a><span id="l5.1235">         int32_t curHdrLineStart = 0;</span>
<a href="#l5.1236"></a><span id="l5.1236">         int32_t newKeywordSize = 0;</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineminus">-        while (!done)</span>
<a href="#l5.1238"></a><span id="l5.1238" class="difflineminus">-        {</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineplus">+        while (!done) {</span>
<a href="#l5.1240"></a><span id="l5.1240">           nextBlankOffset = msgHdrKeywords.FindChar(' ', nextBlankOffset);</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineminus">-          if (nextBlankOffset == kNotFound)</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineminus">-          {</span>
<a href="#l5.1243"></a><span id="l5.1243" class="difflineplus">+          if (nextBlankOffset == kNotFound) {</span>
<a href="#l5.1244"></a><span id="l5.1244">             nextBlankOffset = msgHdrKeywords.Length();</span>
<a href="#l5.1245"></a><span id="l5.1245">             done = true;</span>
<a href="#l5.1246"></a><span id="l5.1246">           }</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineminus">-          if (nextBlankOffset - curHdrLineStart &gt; 90 || done)</span>
<a href="#l5.1248"></a><span id="l5.1248" class="difflineminus">-          {</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineminus">-            keywordHdr.Append(nsDependentCSubstring(msgHdrKeywords, curHdrLineStart, msgHdrKeywords.Length() - curHdrLineStart));</span>
<a href="#l5.1250"></a><span id="l5.1250" class="difflineplus">+          if (nextBlankOffset - curHdrLineStart &gt; 90 || done) {</span>
<a href="#l5.1251"></a><span id="l5.1251" class="difflineplus">+            keywordHdr.Append(nsDependentCSubstring(</span>
<a href="#l5.1252"></a><span id="l5.1252" class="difflineplus">+                msgHdrKeywords, curHdrLineStart,</span>
<a href="#l5.1253"></a><span id="l5.1253" class="difflineplus">+                msgHdrKeywords.Length() - curHdrLineStart));</span>
<a href="#l5.1254"></a><span id="l5.1254">             keywordHdr.Append(MSG_LINEBREAK);</span>
<a href="#l5.1255"></a><span id="l5.1255" class="difflineminus">-            m_fileStream-&gt;Write(keywordHdr.get(), keywordHdr.Length(), &amp;bytesWritten);</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineplus">+            m_fileStream-&gt;Write(keywordHdr.get(), keywordHdr.Length(),</span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineplus">+                                &amp;bytesWritten);</span>
<a href="#l5.1258"></a><span id="l5.1258">             newKeywordSize += bytesWritten;</span>
<a href="#l5.1259"></a><span id="l5.1259">             curHdrLineStart = nextBlankOffset;</span>
<a href="#l5.1260"></a><span id="l5.1260">             keywordHdr.Assign(' ');</span>
<a href="#l5.1261"></a><span id="l5.1261">           }</span>
<a href="#l5.1262"></a><span id="l5.1262">           nextBlankOffset++;</span>
<a href="#l5.1263"></a><span id="l5.1263">         }</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineminus">-        m_fileStream-&gt;Write(EXTRA_KEYWORD_HDR, sizeof(EXTRA_KEYWORD_HDR) - 1, &amp;bytesWritten);</span>
<a href="#l5.1265"></a><span id="l5.1265" class="difflineplus">+        m_fileStream-&gt;Write(EXTRA_KEYWORD_HDR, sizeof(EXTRA_KEYWORD_HDR) - 1,</span>
<a href="#l5.1266"></a><span id="l5.1266" class="difflineplus">+                            &amp;bytesWritten);</span>
<a href="#l5.1267"></a><span id="l5.1267">         newKeywordSize += bytesWritten;</span>
<a href="#l5.1268"></a><span id="l5.1268">         m_addedHeaderSize += newKeywordSize - oldKeywordSize;</span>
<a href="#l5.1269"></a><span id="l5.1269">         m_curSrcHdr-&gt;SetUint32Property(&quot;growKeywords&quot;, 0);</span>
<a href="#l5.1270"></a><span id="l5.1270">         needToGrowKeywords = false;</span>
<a href="#l5.1271"></a><span id="l5.1271" class="difflineminus">-        writeCount += blockOffset - preKeywordBlockOffset; // fudge writeCount</span>
<a href="#l5.1272"></a><span id="l5.1272" class="difflineminus">-</span>
<a href="#l5.1273"></a><span id="l5.1273" class="difflineplus">+        writeCount += blockOffset - preKeywordBlockOffset;  // fudge writeCount</span>
<a href="#l5.1274"></a><span id="l5.1274">       }</span>
<a href="#l5.1275"></a><span id="l5.1275" class="difflineminus">-      if (readCount &lt;= blockOffset)</span>
<a href="#l5.1276"></a><span id="l5.1276" class="difflineminus">-      {</span>
<a href="#l5.1277"></a><span id="l5.1277" class="difflineplus">+      if (readCount &lt;= blockOffset) {</span>
<a href="#l5.1278"></a><span id="l5.1278">         NS_ASSERTION(false, &quot;bad block offset&quot;);</span>
<a href="#l5.1279"></a><span id="l5.1279">         // not sure what to do to handle this.</span>
<a href="#l5.1280"></a><span id="l5.1280" class="difflineminus">-</span>
<a href="#l5.1281"></a><span id="l5.1281">       }</span>
<a href="#l5.1282"></a><span id="l5.1282" class="difflineminus">-      m_fileStream-&gt;Write(m_dataBuffer + blockOffset, readCount - blockOffset, &amp;bytesWritten);</span>
<a href="#l5.1283"></a><span id="l5.1283" class="difflineplus">+      m_fileStream-&gt;Write(m_dataBuffer + blockOffset, readCount - blockOffset,</span>
<a href="#l5.1284"></a><span id="l5.1284" class="difflineplus">+                          &amp;bytesWritten);</span>
<a href="#l5.1285"></a><span id="l5.1285">       writeCount += bytesWritten;</span>
<a href="#l5.1286"></a><span id="l5.1286">       count -= readCount;</span>
<a href="#l5.1287"></a><span id="l5.1287" class="difflineminus">-      if (writeCount != readCount)</span>
<a href="#l5.1288"></a><span id="l5.1288" class="difflineminus">-        return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineplus">+      if (writeCount != readCount) return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l5.1290"></a><span id="l5.1290">     }</span>
<a href="#l5.1291"></a><span id="l5.1291">   }</span>
<a href="#l5.1292"></a><span id="l5.1292">   return rv;</span>
<a href="#l5.1293"></a><span id="l5.1293"> }</span>
<a href="#l5.1294"></a><span id="l5.1294"> </span>
<a href="#l5.1295"></a><span id="l5.1295" class="difflineminus">-nsOfflineStoreCompactState::nsOfflineStoreCompactState()</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineminus">-{</span>
<a href="#l5.1297"></a><span id="l5.1297" class="difflineminus">-}</span>
<a href="#l5.1298"></a><span id="l5.1298" class="difflineplus">+nsOfflineStoreCompactState::nsOfflineStoreCompactState() {}</span>
<a href="#l5.1299"></a><span id="l5.1299"> </span>
<a href="#l5.1300"></a><span id="l5.1300" class="difflineminus">-nsOfflineStoreCompactState::~nsOfflineStoreCompactState()</span>
<a href="#l5.1301"></a><span id="l5.1301" class="difflineminus">-{</span>
<a href="#l5.1302"></a><span id="l5.1302" class="difflineminus">-}</span>
<a href="#l5.1303"></a><span id="l5.1303" class="difflineplus">+nsOfflineStoreCompactState::~nsOfflineStoreCompactState() {}</span>
<a href="#l5.1304"></a><span id="l5.1304"> </span>
<a href="#l5.1305"></a><span id="l5.1305" class="difflineminus">-</span>
<a href="#l5.1306"></a><span id="l5.1306" class="difflineminus">-nsresult</span>
<a href="#l5.1307"></a><span id="l5.1307" class="difflineminus">-nsOfflineStoreCompactState::InitDB(nsIMsgDatabase *db)</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineminus">-{</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineplus">+nsresult nsOfflineStoreCompactState::InitDB(nsIMsgDatabase *db) {</span>
<a href="#l5.1310"></a><span id="l5.1310">   // Start with the list of messages we have offline as the possible</span>
<a href="#l5.1311"></a><span id="l5.1311">   // message to keep when compacting the offline store.</span>
<a href="#l5.1312"></a><span id="l5.1312">   db-&gt;ListAllOfflineMsgs(m_keyArray);</span>
<a href="#l5.1313"></a><span id="l5.1313">   m_size = m_keyArray-&gt;m_keys.Length();</span>
<a href="#l5.1314"></a><span id="l5.1314">   m_db = db;</span>
<a href="#l5.1315"></a><span id="l5.1315">   return NS_OK;</span>
<a href="#l5.1316"></a><span id="l5.1316"> }</span>
<a href="#l5.1317"></a><span id="l5.1317"> </span>
<a href="#l5.1318"></a><span id="l5.1318"> /**</span>
<a href="#l5.1319"></a><span id="l5.1319">  * This will copy one message to the offline store, but if it fails to</span>
<a href="#l5.1320"></a><span id="l5.1320">  * copy the next message, it will keep trying messages until it finds one</span>
<a href="#l5.1321"></a><span id="l5.1321">  * it can copy, or it runs out of messages.</span>
<a href="#l5.1322"></a><span id="l5.1322">  */</span>
<a href="#l5.1323"></a><span id="l5.1323" class="difflineminus">-nsresult nsOfflineStoreCompactState::CopyNextMessage(bool &amp;done)</span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineminus">-{</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineminus">-  while (m_curIndex &lt; m_size)</span>
<a href="#l5.1326"></a><span id="l5.1326" class="difflineminus">-  {</span>
<a href="#l5.1327"></a><span id="l5.1327" class="difflineplus">+nsresult nsOfflineStoreCompactState::CopyNextMessage(bool &amp;done) {</span>
<a href="#l5.1328"></a><span id="l5.1328" class="difflineplus">+  while (m_curIndex &lt; m_size) {</span>
<a href="#l5.1329"></a><span id="l5.1329">     // Filter out msgs that have the &quot;pendingRemoval&quot; attribute set.</span>
<a href="#l5.1330"></a><span id="l5.1330">     nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l5.1331"></a><span id="l5.1331">     nsString pendingRemoval;</span>
<a href="#l5.1332"></a><span id="l5.1332" class="difflineminus">-    nsresult rv = m_db-&gt;GetMsgHdrForKey(m_keyArray-&gt;m_keys[m_curIndex], getter_AddRefs(hdr));</span>
<a href="#l5.1333"></a><span id="l5.1333" class="difflineplus">+    nsresult rv = m_db-&gt;GetMsgHdrForKey(m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineplus">+                                        getter_AddRefs(hdr));</span>
<a href="#l5.1335"></a><span id="l5.1335">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1336"></a><span id="l5.1336">     hdr-&gt;GetProperty(&quot;pendingRemoval&quot;, pendingRemoval);</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineminus">-    if (!pendingRemoval.IsEmpty())</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineminus">-    {</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineplus">+    if (!pendingRemoval.IsEmpty()) {</span>
<a href="#l5.1340"></a><span id="l5.1340">       m_curIndex++;</span>
<a href="#l5.1341"></a><span id="l5.1341" class="difflineminus">-      // Turn off offline flag for message, since after the compact is completed;</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineminus">-      // we won't have the message in the offline store.</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineplus">+      // Turn off offline flag for message, since after the compact is</span>
<a href="#l5.1344"></a><span id="l5.1344" class="difflineplus">+      // completed; we won't have the message in the offline store.</span>
<a href="#l5.1345"></a><span id="l5.1345">       uint32_t resultFlags;</span>
<a href="#l5.1346"></a><span id="l5.1346">       hdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l5.1347"></a><span id="l5.1347">       // We need to clear this in case the user changes the offline retention</span>
<a href="#l5.1348"></a><span id="l5.1348">       // settings.</span>
<a href="#l5.1349"></a><span id="l5.1349">       hdr-&gt;SetStringProperty(&quot;pendingRemoval&quot;, &quot;&quot;);</span>
<a href="#l5.1350"></a><span id="l5.1350">       continue;</span>
<a href="#l5.1351"></a><span id="l5.1351">     }</span>
<a href="#l5.1352"></a><span id="l5.1352" class="difflineminus">-    m_messageUri.Truncate(); // clear the previous message uri</span>
<a href="#l5.1353"></a><span id="l5.1353" class="difflineplus">+    m_messageUri.Truncate();  // clear the previous message uri</span>
<a href="#l5.1354"></a><span id="l5.1354">     rv = BuildMessageURI(m_baseMessageUri.get(), m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l5.1355"></a><span id="l5.1355" class="difflineminus">-                                  m_messageUri);</span>
<a href="#l5.1356"></a><span id="l5.1356" class="difflineplus">+                         m_messageUri);</span>
<a href="#l5.1357"></a><span id="l5.1357">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1358"></a><span id="l5.1358">     m_startOfMsg = true;</span>
<a href="#l5.1359"></a><span id="l5.1359">     nsCOMPtr&lt;nsISupports&gt; thisSupports;</span>
<a href="#l5.1360"></a><span id="l5.1360">     QueryInterface(NS_GET_IID(nsISupports), getter_AddRefs(thisSupports));</span>
<a href="#l5.1361"></a><span id="l5.1361">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l5.1362"></a><span id="l5.1362" class="difflineminus">-    rv = m_messageService-&gt;StreamMessage(m_messageUri.get(), thisSupports, m_window, nullptr,</span>
<a href="#l5.1363"></a><span id="l5.1363" class="difflineminus">-                                    false, EmptyCString(), true, getter_AddRefs(dummyNull));</span>
<a href="#l5.1364"></a><span id="l5.1364" class="difflineplus">+    rv = m_messageService-&gt;StreamMessage(</span>
<a href="#l5.1365"></a><span id="l5.1365" class="difflineplus">+        m_messageUri.get(), thisSupports, m_window, nullptr, false,</span>
<a href="#l5.1366"></a><span id="l5.1366" class="difflineplus">+        EmptyCString(), true, getter_AddRefs(dummyNull));</span>
<a href="#l5.1367"></a><span id="l5.1367">     // if copy fails, we clear the offline flag on the source message.</span>
<a href="#l5.1368"></a><span id="l5.1368" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.1369"></a><span id="l5.1369" class="difflineminus">-    {</span>
<a href="#l5.1370"></a><span id="l5.1370" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l5.1371"></a><span id="l5.1371">       nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l5.1372"></a><span id="l5.1372">       GetMessage(getter_AddRefs(hdr));</span>
<a href="#l5.1373"></a><span id="l5.1373" class="difflineminus">-      if (hdr)</span>
<a href="#l5.1374"></a><span id="l5.1374" class="difflineminus">-      {</span>
<a href="#l5.1375"></a><span id="l5.1375" class="difflineplus">+      if (hdr) {</span>
<a href="#l5.1376"></a><span id="l5.1376">         uint32_t resultFlags;</span>
<a href="#l5.1377"></a><span id="l5.1377">         hdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l5.1378"></a><span id="l5.1378">       }</span>
<a href="#l5.1379"></a><span id="l5.1379">       m_curIndex++;</span>
<a href="#l5.1380"></a><span id="l5.1380">       continue;</span>
<a href="#l5.1381"></a><span id="l5.1381" class="difflineminus">-    }</span>
<a href="#l5.1382"></a><span id="l5.1382" class="difflineminus">-    else</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineplus">+    } else</span>
<a href="#l5.1384"></a><span id="l5.1384">       break;</span>
<a href="#l5.1385"></a><span id="l5.1385">   }</span>
<a href="#l5.1386"></a><span id="l5.1386">   done = m_curIndex &gt;= m_size;</span>
<a href="#l5.1387"></a><span id="l5.1387">   // In theory, we might be able to stream the next message, so</span>
<a href="#l5.1388"></a><span id="l5.1388">   // return NS_OK, not rv.</span>
<a href="#l5.1389"></a><span id="l5.1389">   return NS_OK;</span>
<a href="#l5.1390"></a><span id="l5.1390"> }</span>
<a href="#l5.1391"></a><span id="l5.1391"> </span>
<a href="#l5.1392"></a><span id="l5.1392"> NS_IMETHODIMP</span>
<a href="#l5.1393"></a><span id="l5.1393" class="difflineminus">-nsOfflineStoreCompactState::OnStopRequest(nsIRequest *request, nsresult status)</span>
<a href="#l5.1394"></a><span id="l5.1394" class="difflineminus">-{</span>
<a href="#l5.1395"></a><span id="l5.1395" class="difflineplus">+nsOfflineStoreCompactState::OnStopRequest(nsIRequest *request,</span>
<a href="#l5.1396"></a><span id="l5.1396" class="difflineplus">+                                          nsresult status) {</span>
<a href="#l5.1397"></a><span id="l5.1397">   nsresult rv = status;</span>
<a href="#l5.1398"></a><span id="l5.1398">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l5.1399"></a><span id="l5.1399">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l5.1400"></a><span id="l5.1400" class="difflineminus">-  nsCOMPtr &lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l5.1401"></a><span id="l5.1401" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l5.1402"></a><span id="l5.1402">   nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l5.1403"></a><span id="l5.1403">   bool done = false;</span>
<a href="#l5.1404"></a><span id="l5.1404"> </span>
<a href="#l5.1405"></a><span id="l5.1405">   // The NS_MSG_ERROR_MSG_NOT_OFFLINE error should allow us to continue, so we</span>
<a href="#l5.1406"></a><span id="l5.1406">   // check for it specifically and don't terminate the compaction.</span>
<a href="#l5.1407"></a><span id="l5.1407" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_ERROR_MSG_NOT_OFFLINE)</span>
<a href="#l5.1408"></a><span id="l5.1408" class="difflineminus">-    goto done;</span>
<a href="#l5.1409"></a><span id="l5.1409" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_ERROR_MSG_NOT_OFFLINE) goto done;</span>
<a href="#l5.1410"></a><span id="l5.1410"> </span>
<a href="#l5.1411"></a><span id="l5.1411">   // We know the request is an nsIChannel we can get a URI from, but this is</span>
<a href="#l5.1412"></a><span id="l5.1412">   // probably bad form. See Bug 1528662.</span>
<a href="#l5.1413"></a><span id="l5.1413">   channel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l5.1414"></a><span id="l5.1414" class="difflineminus">-  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l5.1415"></a><span id="l5.1415" class="difflineplus">+  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l5.1416"></a><span id="l5.1416" class="difflineplus">+                       &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l5.1417"></a><span id="l5.1417">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l5.1418"></a><span id="l5.1418">   rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l5.1419"></a><span id="l5.1419">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l5.1420"></a><span id="l5.1420">   rv = GetMessage(getter_AddRefs(msgHdr));</span>
<a href="#l5.1421"></a><span id="l5.1421">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l5.1422"></a><span id="l5.1422"> </span>
<a href="#l5.1423"></a><span id="l5.1423">   // This is however an unexpected condition, so let's print a warning.</span>
<a href="#l5.1424"></a><span id="l5.1424">   if (rv == NS_MSG_ERROR_MSG_NOT_OFFLINE) {</span>
<a href="#l5.1425"></a><span id="l5.1425">     nsAutoCString spec;</span>
<a href="#l5.1426"></a><span id="l5.1426">     uri-&gt;GetSpec(spec);</span>
<a href="#l5.1427"></a><span id="l5.1427" class="difflineminus">-    nsPrintfCString msg(&quot;Message expectedly not available offline: %s&quot;, spec.get());</span>
<a href="#l5.1428"></a><span id="l5.1428" class="difflineplus">+    nsPrintfCString msg(&quot;Message expectedly not available offline: %s&quot;,</span>
<a href="#l5.1429"></a><span id="l5.1429" class="difflineplus">+                        spec.get());</span>
<a href="#l5.1430"></a><span id="l5.1430">     NS_WARNING(msg.get());</span>
<a href="#l5.1431"></a><span id="l5.1431">   }</span>
<a href="#l5.1432"></a><span id="l5.1432"> </span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineminus">-  if (msgHdr)</span>
<a href="#l5.1434"></a><span id="l5.1434" class="difflineminus">-  {</span>
<a href="#l5.1435"></a><span id="l5.1435" class="difflineminus">-    if (NS_SUCCEEDED(status))</span>
<a href="#l5.1436"></a><span id="l5.1436" class="difflineminus">-    {</span>
<a href="#l5.1437"></a><span id="l5.1437" class="difflineplus">+  if (msgHdr) {</span>
<a href="#l5.1438"></a><span id="l5.1438" class="difflineplus">+    if (NS_SUCCEEDED(status)) {</span>
<a href="#l5.1439"></a><span id="l5.1439">       msgHdr-&gt;SetMessageOffset(m_startOfNewMsg);</span>
<a href="#l5.1440"></a><span id="l5.1440">       char storeToken[100];</span>
<a href="#l5.1441"></a><span id="l5.1441">       PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, m_startOfNewMsg);</span>
<a href="#l5.1442"></a><span id="l5.1442">       msgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l5.1443"></a><span id="l5.1443">       msgHdr-&gt;SetOfflineMessageSize(m_offlineMsgSize);</span>
<a href="#l5.1444"></a><span id="l5.1444" class="difflineminus">-    }</span>
<a href="#l5.1445"></a><span id="l5.1445" class="difflineminus">-    else</span>
<a href="#l5.1446"></a><span id="l5.1446" class="difflineminus">-    {</span>
<a href="#l5.1447"></a><span id="l5.1447" class="difflineplus">+    } else {</span>
<a href="#l5.1448"></a><span id="l5.1448">       uint32_t resultFlags;</span>
<a href="#l5.1449"></a><span id="l5.1449">       msgHdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l5.1450"></a><span id="l5.1450">     }</span>
<a href="#l5.1451"></a><span id="l5.1451">   }</span>
<a href="#l5.1452"></a><span id="l5.1452"> </span>
<a href="#l5.1453"></a><span id="l5.1453" class="difflineminus">-  if (m_window)</span>
<a href="#l5.1454"></a><span id="l5.1454" class="difflineminus">-  {</span>
<a href="#l5.1455"></a><span id="l5.1455" class="difflineplus">+  if (m_window) {</span>
<a href="#l5.1456"></a><span id="l5.1456">     m_window-&gt;GetStatusFeedback(getter_AddRefs(statusFeedback));</span>
<a href="#l5.1457"></a><span id="l5.1457" class="difflineminus">-    if (statusFeedback)</span>
<a href="#l5.1458"></a><span id="l5.1458" class="difflineminus">-      statusFeedback-&gt;ShowProgress(100 * m_curIndex / m_size);</span>
<a href="#l5.1459"></a><span id="l5.1459" class="difflineplus">+    if (statusFeedback) statusFeedback-&gt;ShowProgress(100 * m_curIndex / m_size);</span>
<a href="#l5.1460"></a><span id="l5.1460">   }</span>
<a href="#l5.1461"></a><span id="l5.1461">   // advance to next message</span>
<a href="#l5.1462"></a><span id="l5.1462">   m_curIndex++;</span>
<a href="#l5.1463"></a><span id="l5.1463">   rv = CopyNextMessage(done);</span>
<a href="#l5.1464"></a><span id="l5.1464" class="difflineminus">-  if (done)</span>
<a href="#l5.1465"></a><span id="l5.1465" class="difflineminus">-  {</span>
<a href="#l5.1466"></a><span id="l5.1466" class="difflineplus">+  if (done) {</span>
<a href="#l5.1467"></a><span id="l5.1467">     m_db-&gt;Commit(nsMsgDBCommitType::kCompressCommit);</span>
<a href="#l5.1468"></a><span id="l5.1468">     msgHdr = nullptr;</span>
<a href="#l5.1469"></a><span id="l5.1469">     // no more to copy finish it up</span>
<a href="#l5.1470"></a><span id="l5.1470">     ReleaseFolderLock();</span>
<a href="#l5.1471"></a><span id="l5.1471">     FinishCompact();</span>
<a href="#l5.1472"></a><span id="l5.1472" class="difflineminus">-    NS_RELEASE_THIS(); // kill self</span>
<a href="#l5.1473"></a><span id="l5.1473" class="difflineplus">+    NS_RELEASE_THIS();  // kill self</span>
<a href="#l5.1474"></a><span id="l5.1474">   }</span>
<a href="#l5.1475"></a><span id="l5.1475"> </span>
<a href="#l5.1476"></a><span id="l5.1476"> done:</span>
<a href="#l5.1477"></a><span id="l5.1477">   if (NS_FAILED(rv)) {</span>
<a href="#l5.1478"></a><span id="l5.1478" class="difflineminus">-    m_status = rv; // set the status to rv so the destructor can remove the</span>
<a href="#l5.1479"></a><span id="l5.1479" class="difflineminus">-                   // temp folder and database</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineplus">+    m_status = rv;  // set the status to rv so the destructor can remove the</span>
<a href="#l5.1481"></a><span id="l5.1481" class="difflineplus">+                    // temp folder and database</span>
<a href="#l5.1482"></a><span id="l5.1482">     ReleaseFolderLock();</span>
<a href="#l5.1483"></a><span id="l5.1483" class="difflineminus">-    NS_RELEASE_THIS(); // kill self</span>
<a href="#l5.1484"></a><span id="l5.1484" class="difflineplus">+    NS_RELEASE_THIS();  // kill self</span>
<a href="#l5.1485"></a><span id="l5.1485">     return rv;</span>
<a href="#l5.1486"></a><span id="l5.1486">   }</span>
<a href="#l5.1487"></a><span id="l5.1487">   return rv;</span>
<a href="#l5.1488"></a><span id="l5.1488"> }</span>
<a href="#l5.1489"></a><span id="l5.1489"> </span>
<a href="#l5.1490"></a><span id="l5.1490" class="difflineminus">-</span>
<a href="#l5.1491"></a><span id="l5.1491" class="difflineminus">-nsresult</span>
<a href="#l5.1492"></a><span id="l5.1492" class="difflineminus">-nsOfflineStoreCompactState::FinishCompact()</span>
<a href="#l5.1493"></a><span id="l5.1493" class="difflineminus">-{</span>
<a href="#l5.1494"></a><span id="l5.1494" class="difflineplus">+nsresult nsOfflineStoreCompactState::FinishCompact() {</span>
<a href="#l5.1495"></a><span id="l5.1495">   // All okay time to finish up the compact process</span>
<a href="#l5.1496"></a><span id="l5.1496">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l5.1497"></a><span id="l5.1497">   uint32_t flags;</span>
<a href="#l5.1498"></a><span id="l5.1498"> </span>
<a href="#l5.1499"></a><span id="l5.1499" class="difflineminus">-    // get leaf name and database name of the folder</span>
<a href="#l5.1500"></a><span id="l5.1500" class="difflineplus">+  // get leaf name and database name of the folder</span>
<a href="#l5.1501"></a><span id="l5.1501">   m_folder-&gt;GetFlags(&amp;flags);</span>
<a href="#l5.1502"></a><span id="l5.1502">   nsresult rv = m_folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l5.1503"></a><span id="l5.1503"> </span>
<a href="#l5.1504"></a><span id="l5.1504">   nsCString leafName;</span>
<a href="#l5.1505"></a><span id="l5.1505">   path-&gt;GetNativeLeafName(leafName);</span>
<a href="#l5.1506"></a><span id="l5.1506"> </span>
<a href="#l5.1507"></a><span id="l5.1507" class="difflineminus">-  if (m_fileStream)</span>
<a href="#l5.1508"></a><span id="l5.1508" class="difflineminus">-  {</span>
<a href="#l5.1509"></a><span id="l5.1509" class="difflineplus">+  if (m_fileStream) {</span>
<a href="#l5.1510"></a><span id="l5.1510">     // close down the temp file stream; preparing for deleting the old folder</span>
<a href="#l5.1511"></a><span id="l5.1511">     // and its database; then rename the temp folder and database</span>
<a href="#l5.1512"></a><span id="l5.1512">     m_fileStream-&gt;Flush();</span>
<a href="#l5.1513"></a><span id="l5.1513">     m_fileStream-&gt;Close();</span>
<a href="#l5.1514"></a><span id="l5.1514">     m_fileStream = nullptr;</span>
<a href="#l5.1515"></a><span id="l5.1515">   }</span>
<a href="#l5.1516"></a><span id="l5.1516"> </span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineminus">-    // make sure the new database is valid</span>
<a href="#l5.1518"></a><span id="l5.1518" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l5.1519"></a><span id="l5.1519" class="difflineplus">+  // make sure the new database is valid</span>
<a href="#l5.1520"></a><span id="l5.1520" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l5.1521"></a><span id="l5.1521">   m_db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l5.1522"></a><span id="l5.1522" class="difflineminus">-  if (dbFolderInfo)</span>
<a href="#l5.1523"></a><span id="l5.1523" class="difflineminus">-    dbFolderInfo-&gt;SetExpungedBytes(0);</span>
<a href="#l5.1524"></a><span id="l5.1524" class="difflineplus">+  if (dbFolderInfo) dbFolderInfo-&gt;SetExpungedBytes(0);</span>
<a href="#l5.1525"></a><span id="l5.1525">   // this forces the m_folder to update mExpungedBytes from the db folder info.</span>
<a href="#l5.1526"></a><span id="l5.1526">   int64_t expungedBytes;</span>
<a href="#l5.1527"></a><span id="l5.1527">   m_folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l5.1528"></a><span id="l5.1528">   m_folder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l5.1529"></a><span id="l5.1529">   m_db-&gt;SetSummaryValid(true);</span>
<a href="#l5.1530"></a><span id="l5.1530"> </span>
<a href="#l5.1531"></a><span id="l5.1531" class="difflineminus">-    // remove the old folder</span>
<a href="#l5.1532"></a><span id="l5.1532" class="difflineplus">+  // remove the old folder</span>
<a href="#l5.1533"></a><span id="l5.1533">   path-&gt;Remove(false);</span>
<a href="#l5.1534"></a><span id="l5.1534"> </span>
<a href="#l5.1535"></a><span id="l5.1535" class="difflineminus">-    // rename the copied folder to be the original folder</span>
<a href="#l5.1536"></a><span id="l5.1536" class="difflineminus">-  m_file-&gt;MoveToNative((nsIFile *) nullptr, leafName);</span>
<a href="#l5.1537"></a><span id="l5.1537" class="difflineplus">+  // rename the copied folder to be the original folder</span>
<a href="#l5.1538"></a><span id="l5.1538" class="difflineplus">+  m_file-&gt;MoveToNative((nsIFile *)nullptr, leafName);</span>
<a href="#l5.1539"></a><span id="l5.1539"> </span>
<a href="#l5.1540"></a><span id="l5.1540">   ShowStatusMsg(EmptyString());</span>
<a href="#l5.1541"></a><span id="l5.1541">   m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l5.1542"></a><span id="l5.1542" class="difflineminus">-  if (m_compactAll)</span>
<a href="#l5.1543"></a><span id="l5.1543" class="difflineminus">-    rv = CompactNextFolder();</span>
<a href="#l5.1544"></a><span id="l5.1544" class="difflineplus">+  if (m_compactAll) rv = CompactNextFolder();</span>
<a href="#l5.1545"></a><span id="l5.1545">   return rv;</span>
<a href="#l5.1546"></a><span id="l5.1546"> }</span>
<a href="#l5.1547"></a><span id="l5.1547"> </span>
<a href="#l5.1548"></a><span id="l5.1548" class="difflineminus">-</span>
<a href="#l5.1549"></a><span id="l5.1549"> NS_IMETHODIMP</span>
<a href="#l5.1550"></a><span id="l5.1550" class="difflineminus">-nsFolderCompactState::Init(nsIMsgFolder *srcFolder, nsICopyMessageListener *destination, nsISupports *listenerData)</span>
<a href="#l5.1551"></a><span id="l5.1551" class="difflineminus">-{</span>
<a href="#l5.1552"></a><span id="l5.1552" class="difflineplus">+nsFolderCompactState::Init(nsIMsgFolder *srcFolder,</span>
<a href="#l5.1553"></a><span id="l5.1553" class="difflineplus">+                           nsICopyMessageListener *destination,</span>
<a href="#l5.1554"></a><span id="l5.1554" class="difflineplus">+                           nsISupports *listenerData) {</span>
<a href="#l5.1555"></a><span id="l5.1555">   return NS_OK;</span>
<a href="#l5.1556"></a><span id="l5.1556"> }</span>
<a href="#l5.1557"></a><span id="l5.1557"> </span>
<a href="#l5.1558"></a><span id="l5.1558"> NS_IMETHODIMP</span>
<a href="#l5.1559"></a><span id="l5.1559" class="difflineminus">-nsFolderCompactState::StartMessage()</span>
<a href="#l5.1560"></a><span id="l5.1560" class="difflineminus">-{</span>
<a href="#l5.1561"></a><span id="l5.1561" class="difflineplus">+nsFolderCompactState::StartMessage() {</span>
<a href="#l5.1562"></a><span id="l5.1562">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l5.1563"></a><span id="l5.1563">   NS_ASSERTION(m_fileStream, &quot;Fatal, null m_fileStream...&quot;);</span>
<a href="#l5.1564"></a><span id="l5.1564" class="difflineminus">-  if (m_fileStream)</span>
<a href="#l5.1565"></a><span id="l5.1565" class="difflineminus">-  {</span>
<a href="#l5.1566"></a><span id="l5.1566" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_fileStream, &amp;rv);</span>
<a href="#l5.1567"></a><span id="l5.1567" class="difflineplus">+  if (m_fileStream) {</span>
<a href="#l5.1568"></a><span id="l5.1568" class="difflineplus">+    nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l5.1569"></a><span id="l5.1569" class="difflineplus">+        do_QueryInterface(m_fileStream, &amp;rv);</span>
<a href="#l5.1570"></a><span id="l5.1570">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1571"></a><span id="l5.1571" class="difflineminus">-    // this will force an internal flush, but not a sync. Tell should really do an internal flush,</span>
<a href="#l5.1572"></a><span id="l5.1572" class="difflineminus">-    // but it doesn't, and I'm afraid to change that nsIFileStream.cpp code anymore.</span>
<a href="#l5.1573"></a><span id="l5.1573" class="difflineplus">+    // this will force an internal flush, but not a sync. Tell should really do</span>
<a href="#l5.1574"></a><span id="l5.1574" class="difflineplus">+    // an internal flush, but it doesn't, and I'm afraid to change that</span>
<a href="#l5.1575"></a><span id="l5.1575" class="difflineplus">+    // nsIFileStream.cpp code anymore.</span>
<a href="#l5.1576"></a><span id="l5.1576">     seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, 0);</span>
<a href="#l5.1577"></a><span id="l5.1577">     // record the new message key for the message</span>
<a href="#l5.1578"></a><span id="l5.1578">     int64_t curStreamPos;</span>
<a href="#l5.1579"></a><span id="l5.1579">     seekableStream-&gt;Tell(&amp;curStreamPos);</span>
<a href="#l5.1580"></a><span id="l5.1580">     m_startOfNewMsg = curStreamPos;</span>
<a href="#l5.1581"></a><span id="l5.1581">     rv = NS_OK;</span>
<a href="#l5.1582"></a><span id="l5.1582">   }</span>
<a href="#l5.1583"></a><span id="l5.1583">   return rv;</span>
<a href="#l5.1584"></a><span id="l5.1584"> }</span>
<a href="#l5.1585"></a><span id="l5.1585"> </span>
<a href="#l5.1586"></a><span id="l5.1586"> NS_IMETHODIMP</span>
<a href="#l5.1587"></a><span id="l5.1587" class="difflineminus">-nsFolderCompactState::EndMessage(nsMsgKey key)</span>
<a href="#l5.1588"></a><span id="l5.1588" class="difflineminus">-{</span>
<a href="#l5.1589"></a><span id="l5.1589" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.1590"></a><span id="l5.1590" class="difflineminus">-}</span>
<a href="#l5.1591"></a><span id="l5.1591" class="difflineplus">+nsFolderCompactState::EndMessage(nsMsgKey key) { return NS_OK; }</span>
<a href="#l5.1592"></a><span id="l5.1592"> </span>
<a href="#l5.1593"></a><span id="l5.1593"> // XXX TODO: This function is sadly lacking all status checking, it always</span>
<a href="#l5.1594"></a><span id="l5.1594"> // returns NS_OK and moves onto the next message.</span>
<a href="#l5.1595"></a><span id="l5.1595"> NS_IMETHODIMP</span>
<a href="#l5.1596"></a><span id="l5.1596" class="difflineminus">-nsFolderCompactState::EndCopy(nsISupports *url, nsresult aStatus)</span>
<a href="#l5.1597"></a><span id="l5.1597" class="difflineminus">-{</span>
<a href="#l5.1598"></a><span id="l5.1598" class="difflineplus">+nsFolderCompactState::EndCopy(nsISupports *url, nsresult aStatus) {</span>
<a href="#l5.1599"></a><span id="l5.1599">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l5.1600"></a><span id="l5.1600">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l5.1601"></a><span id="l5.1601"> </span>
<a href="#l5.1602"></a><span id="l5.1602" class="difflineminus">-  if (m_curIndex &gt;= m_size)</span>
<a href="#l5.1603"></a><span id="l5.1603" class="difflineminus">-  {</span>
<a href="#l5.1604"></a><span id="l5.1604" class="difflineplus">+  if (m_curIndex &gt;= m_size) {</span>
<a href="#l5.1605"></a><span id="l5.1605">     NS_ASSERTION(false, &quot;m_curIndex out of bounds&quot;);</span>
<a href="#l5.1606"></a><span id="l5.1606">     return NS_OK;</span>
<a href="#l5.1607"></a><span id="l5.1607">   }</span>
<a href="#l5.1608"></a><span id="l5.1608"> </span>
<a href="#l5.1609"></a><span id="l5.1609">   /* Messages need to have trailing blank lines */</span>
<a href="#l5.1610"></a><span id="l5.1610">   uint32_t bytesWritten;</span>
<a href="#l5.1611"></a><span id="l5.1611" class="difflineminus">-  (void) m_fileStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;bytesWritten);</span>
<a href="#l5.1612"></a><span id="l5.1612" class="difflineplus">+  (void)m_fileStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;bytesWritten);</span>
<a href="#l5.1613"></a><span id="l5.1613"> </span>
<a href="#l5.1614"></a><span id="l5.1614">   /**</span>
<a href="#l5.1615"></a><span id="l5.1615">    * Done with the current message; copying the existing message header</span>
<a href="#l5.1616"></a><span id="l5.1616">    * to the new database.</span>
<a href="#l5.1617"></a><span id="l5.1617">    */</span>
<a href="#l5.1618"></a><span id="l5.1618" class="difflineminus">-  if (m_curSrcHdr)</span>
<a href="#l5.1619"></a><span id="l5.1619" class="difflineminus">-  {</span>
<a href="#l5.1620"></a><span id="l5.1620" class="difflineplus">+  if (m_curSrcHdr) {</span>
<a href="#l5.1621"></a><span id="l5.1621">     nsMsgKey key;</span>
<a href="#l5.1622"></a><span id="l5.1622">     m_curSrcHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l5.1623"></a><span id="l5.1623">     m_db-&gt;CopyHdrFromExistingHdr(key, m_curSrcHdr, true,</span>
<a href="#l5.1624"></a><span id="l5.1624">                                  getter_AddRefs(newMsgHdr));</span>
<a href="#l5.1625"></a><span id="l5.1625">   }</span>
<a href="#l5.1626"></a><span id="l5.1626">   m_curSrcHdr = nullptr;</span>
<a href="#l5.1627"></a><span id="l5.1627" class="difflineminus">-  if (newMsgHdr)</span>
<a href="#l5.1628"></a><span id="l5.1628" class="difflineminus">-  {</span>
<a href="#l5.1629"></a><span id="l5.1629" class="difflineminus">-    if (m_statusOffset != 0)</span>
<a href="#l5.1630"></a><span id="l5.1630" class="difflineminus">-      newMsgHdr-&gt;SetStatusOffset(m_statusOffset);</span>
<a href="#l5.1631"></a><span id="l5.1631" class="difflineplus">+  if (newMsgHdr) {</span>
<a href="#l5.1632"></a><span id="l5.1632" class="difflineplus">+    if (m_statusOffset != 0) newMsgHdr-&gt;SetStatusOffset(m_statusOffset);</span>
<a href="#l5.1633"></a><span id="l5.1633"> </span>
<a href="#l5.1634"></a><span id="l5.1634">     char storeToken[100];</span>
<a href="#l5.1635"></a><span id="l5.1635">     PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, m_startOfNewMsg);</span>
<a href="#l5.1636"></a><span id="l5.1636">     newMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l5.1637"></a><span id="l5.1637">     newMsgHdr-&gt;SetMessageOffset(m_startOfNewMsg);</span>
<a href="#l5.1638"></a><span id="l5.1638"> </span>
<a href="#l5.1639"></a><span id="l5.1639">     uint32_t msgSize;</span>
<a href="#l5.1640"></a><span id="l5.1640" class="difflineminus">-    (void) newMsgHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l5.1641"></a><span id="l5.1641" class="difflineminus">-    if (m_addedHeaderSize)</span>
<a href="#l5.1642"></a><span id="l5.1642" class="difflineminus">-    {</span>
<a href="#l5.1643"></a><span id="l5.1643" class="difflineplus">+    (void)newMsgHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l5.1644"></a><span id="l5.1644" class="difflineplus">+    if (m_addedHeaderSize) {</span>
<a href="#l5.1645"></a><span id="l5.1645">       msgSize += m_addedHeaderSize;</span>
<a href="#l5.1646"></a><span id="l5.1646">       newMsgHdr-&gt;SetMessageSize(msgSize);</span>
<a href="#l5.1647"></a><span id="l5.1647">     }</span>
<a href="#l5.1648"></a><span id="l5.1648">     m_totalMsgSize += msgSize + MSG_LINEBREAK_LEN;</span>
<a href="#l5.1649"></a><span id="l5.1649">   }</span>
<a href="#l5.1650"></a><span id="l5.1650"> </span>
<a href="#l5.1651"></a><span id="l5.1651" class="difflineminus">-//  m_db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);  // no sense committing until the end</span>
<a href="#l5.1652"></a><span id="l5.1652" class="difflineplus">+  //  m_db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);  // no sense committing</span>
<a href="#l5.1653"></a><span id="l5.1653" class="difflineplus">+  //  until the end</span>
<a href="#l5.1654"></a><span id="l5.1654">   // advance to next message</span>
<a href="#l5.1655"></a><span id="l5.1655" class="difflineminus">-  m_curIndex ++;</span>
<a href="#l5.1656"></a><span id="l5.1656" class="difflineplus">+  m_curIndex++;</span>
<a href="#l5.1657"></a><span id="l5.1657">   m_startOfMsg = true;</span>
<a href="#l5.1658"></a><span id="l5.1658" class="difflineminus">-  nsCOMPtr &lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l5.1659"></a><span id="l5.1659" class="difflineminus">-  if (m_window)</span>
<a href="#l5.1660"></a><span id="l5.1660" class="difflineminus">-  {</span>
<a href="#l5.1661"></a><span id="l5.1661" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l5.1662"></a><span id="l5.1662" class="difflineplus">+  if (m_window) {</span>
<a href="#l5.1663"></a><span id="l5.1663">     m_window-&gt;GetStatusFeedback(getter_AddRefs(statusFeedback));</span>
<a href="#l5.1664"></a><span id="l5.1664" class="difflineminus">-    if (statusFeedback)</span>
<a href="#l5.1665"></a><span id="l5.1665" class="difflineminus">-      statusFeedback-&gt;ShowProgress(100 * m_curIndex / m_size);</span>
<a href="#l5.1666"></a><span id="l5.1666" class="difflineplus">+    if (statusFeedback) statusFeedback-&gt;ShowProgress(100 * m_curIndex / m_size);</span>
<a href="#l5.1667"></a><span id="l5.1667">   }</span>
<a href="#l5.1668"></a><span id="l5.1668">   return NS_OK;</span>
<a href="#l5.1669"></a><span id="l5.1669"> }</span>
<a href="#l5.1670"></a><span id="l5.1670"> </span>
<a href="#l5.1671"></a><span id="l5.1671" class="difflineminus">-nsresult nsOfflineStoreCompactState::StartCompacting()</span>
<a href="#l5.1672"></a><span id="l5.1672" class="difflineminus">-{</span>
<a href="#l5.1673"></a><span id="l5.1673" class="difflineplus">+nsresult nsOfflineStoreCompactState::StartCompacting() {</span>
<a href="#l5.1674"></a><span id="l5.1674">   nsresult rv = NS_OK;</span>
<a href="#l5.1675"></a><span id="l5.1675" class="difflineminus">-  if (m_size &gt; 0 &amp;&amp; m_curIndex == 0)</span>
<a href="#l5.1676"></a><span id="l5.1676" class="difflineminus">-  {</span>
<a href="#l5.1677"></a><span id="l5.1677" class="difflineminus">-    NS_ADDREF_THIS(); // we own ourselves, until we're done, anyway.</span>
<a href="#l5.1678"></a><span id="l5.1678" class="difflineplus">+  if (m_size &gt; 0 &amp;&amp; m_curIndex == 0) {</span>
<a href="#l5.1679"></a><span id="l5.1679" class="difflineplus">+    NS_ADDREF_THIS();  // we own ourselves, until we're done, anyway.</span>
<a href="#l5.1680"></a><span id="l5.1680">     ShowCompactingStatusMsg();</span>
<a href="#l5.1681"></a><span id="l5.1681">     bool done = false;</span>
<a href="#l5.1682"></a><span id="l5.1682">     rv = CopyNextMessage(done);</span>
<a href="#l5.1683"></a><span id="l5.1683" class="difflineminus">-    if (!done)</span>
<a href="#l5.1684"></a><span id="l5.1684" class="difflineminus">-      return rv;</span>
<a href="#l5.1685"></a><span id="l5.1685" class="difflineplus">+    if (!done) return rv;</span>
<a href="#l5.1686"></a><span id="l5.1686">   }</span>
<a href="#l5.1687"></a><span id="l5.1687">   ReleaseFolderLock();</span>
<a href="#l5.1688"></a><span id="l5.1688">   FinishCompact();</span>
<a href="#l5.1689"></a><span id="l5.1689">   return rv;</span>
<a href="#l5.1690"></a><span id="l5.1690"> }</span>
<a href="#l5.1691"></a><span id="l5.1691"> </span>
<a href="#l5.1692"></a><span id="l5.1692"> NS_IMETHODIMP</span>
<a href="#l5.1693"></a><span id="l5.1693"> nsOfflineStoreCompactState::OnDataAvailable(nsIRequest *request,</span>
<a href="#l5.1694"></a><span id="l5.1694">                                             nsIInputStream *inStr,</span>
<a href="#l5.1695"></a><span id="l5.1695" class="difflineminus">-                                            uint64_t sourceOffset, uint32_t count)</span>
<a href="#l5.1696"></a><span id="l5.1696" class="difflineminus">-{</span>
<a href="#l5.1697"></a><span id="l5.1697" class="difflineminus">-  if (!m_fileStream || !inStr)</span>
<a href="#l5.1698"></a><span id="l5.1698" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.1699"></a><span id="l5.1699" class="difflineplus">+                                            uint64_t sourceOffset,</span>
<a href="#l5.1700"></a><span id="l5.1700" class="difflineplus">+                                            uint32_t count) {</span>
<a href="#l5.1701"></a><span id="l5.1701" class="difflineplus">+  if (!m_fileStream || !inStr) return NS_ERROR_FAILURE;</span>
<a href="#l5.1702"></a><span id="l5.1702"> </span>
<a href="#l5.1703"></a><span id="l5.1703">   nsresult rv = NS_OK;</span>
<a href="#l5.1704"></a><span id="l5.1704"> </span>
<a href="#l5.1705"></a><span id="l5.1705" class="difflineminus">-  if (m_startOfMsg)</span>
<a href="#l5.1706"></a><span id="l5.1706" class="difflineminus">-  {</span>
<a href="#l5.1707"></a><span id="l5.1707" class="difflineplus">+  if (m_startOfMsg) {</span>
<a href="#l5.1708"></a><span id="l5.1708">     m_statusOffset = 0;</span>
<a href="#l5.1709"></a><span id="l5.1709">     m_offlineMsgSize = 0;</span>
<a href="#l5.1710"></a><span id="l5.1710" class="difflineminus">-    m_messageUri.Truncate(); // clear the previous message uri</span>
<a href="#l5.1711"></a><span id="l5.1711" class="difflineminus">-    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(), m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l5.1712"></a><span id="l5.1712" class="difflineminus">-                                m_messageUri)))</span>
<a href="#l5.1713"></a><span id="l5.1713" class="difflineminus">-    {</span>
<a href="#l5.1714"></a><span id="l5.1714" class="difflineplus">+    m_messageUri.Truncate();  // clear the previous message uri</span>
<a href="#l5.1715"></a><span id="l5.1715" class="difflineplus">+    if (NS_SUCCEEDED(BuildMessageURI(m_baseMessageUri.get(),</span>
<a href="#l5.1716"></a><span id="l5.1716" class="difflineplus">+                                     m_keyArray-&gt;m_keys[m_curIndex],</span>
<a href="#l5.1717"></a><span id="l5.1717" class="difflineplus">+                                     m_messageUri))) {</span>
<a href="#l5.1718"></a><span id="l5.1718">       rv = GetMessage(getter_AddRefs(m_curSrcHdr));</span>
<a href="#l5.1719"></a><span id="l5.1719">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1720"></a><span id="l5.1720">     }</span>
<a href="#l5.1721"></a><span id="l5.1721">   }</span>
<a href="#l5.1722"></a><span id="l5.1722">   uint32_t maxReadCount, readCount, writeCount;</span>
<a href="#l5.1723"></a><span id="l5.1723">   uint32_t bytesWritten;</span>
<a href="#l5.1724"></a><span id="l5.1724"> </span>
<a href="#l5.1725"></a><span id="l5.1725" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; (int32_t) count &gt; 0)</span>
<a href="#l5.1726"></a><span id="l5.1726" class="difflineminus">-  {</span>
<a href="#l5.1727"></a><span id="l5.1727" class="difflineminus">-    maxReadCount = count &gt; sizeof(m_dataBuffer) - 1 ? sizeof(m_dataBuffer) - 1 : count;</span>
<a href="#l5.1728"></a><span id="l5.1728" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; (int32_t)count &gt; 0) {</span>
<a href="#l5.1729"></a><span id="l5.1729" class="difflineplus">+    maxReadCount =</span>
<a href="#l5.1730"></a><span id="l5.1730" class="difflineplus">+        count &gt; sizeof(m_dataBuffer) - 1 ? sizeof(m_dataBuffer) - 1 : count;</span>
<a href="#l5.1731"></a><span id="l5.1731">     writeCount = 0;</span>
<a href="#l5.1732"></a><span id="l5.1732">     rv = inStr-&gt;Read(m_dataBuffer, maxReadCount, &amp;readCount);</span>
<a href="#l5.1733"></a><span id="l5.1733"> </span>
<a href="#l5.1734"></a><span id="l5.1734" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1735"></a><span id="l5.1735" class="difflineminus">-    {</span>
<a href="#l5.1736"></a><span id="l5.1736" class="difflineminus">-      if (m_startOfMsg)</span>
<a href="#l5.1737"></a><span id="l5.1737" class="difflineminus">-      {</span>
<a href="#l5.1738"></a><span id="l5.1738" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1739"></a><span id="l5.1739" class="difflineplus">+      if (m_startOfMsg) {</span>
<a href="#l5.1740"></a><span id="l5.1740">         m_startOfMsg = false;</span>
<a href="#l5.1741"></a><span id="l5.1741">         // check if there's an envelope header; if not, write one.</span>
<a href="#l5.1742"></a><span id="l5.1742" class="difflineminus">-        if (strncmp(m_dataBuffer, &quot;From &quot;, 5))</span>
<a href="#l5.1743"></a><span id="l5.1743" class="difflineminus">-        {</span>
<a href="#l5.1744"></a><span id="l5.1744" class="difflineplus">+        if (strncmp(m_dataBuffer, &quot;From &quot;, 5)) {</span>
<a href="#l5.1745"></a><span id="l5.1745">           m_fileStream-&gt;Write(&quot;From &quot; CRLF, 7, &amp;bytesWritten);</span>
<a href="#l5.1746"></a><span id="l5.1746">           m_offlineMsgSize += bytesWritten;</span>
<a href="#l5.1747"></a><span id="l5.1747">         }</span>
<a href="#l5.1748"></a><span id="l5.1748">       }</span>
<a href="#l5.1749"></a><span id="l5.1749">       m_fileStream-&gt;Write(m_dataBuffer, readCount, &amp;bytesWritten);</span>
<a href="#l5.1750"></a><span id="l5.1750">       m_offlineMsgSize += bytesWritten;</span>
<a href="#l5.1751"></a><span id="l5.1751">       writeCount += bytesWritten;</span>
<a href="#l5.1752"></a><span id="l5.1752">       count -= readCount;</span>
<a href="#l5.1753"></a><span id="l5.1753" class="difflineminus">-      if (writeCount != readCount)</span>
<a href="#l5.1754"></a><span id="l5.1754" class="difflineminus">-      {</span>
<a href="#l5.1755"></a><span id="l5.1755" class="difflineplus">+      if (writeCount != readCount) {</span>
<a href="#l5.1756"></a><span id="l5.1756">         m_folder-&gt;ThrowAlertMsg(&quot;compactFolderWriteFailed&quot;, m_window);</span>
<a href="#l5.1757"></a><span id="l5.1757">         return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l5.1758"></a><span id="l5.1758">       }</span>
<a href="#l5.1759"></a><span id="l5.1759">     }</span>
<a href="#l5.1760"></a><span id="l5.1760">   }</span>
<a href="#l5.1761"></a><span id="l5.1761">   return rv;</span>
<a href="#l5.1762"></a><span id="l5.1762"> }</span>
<a href="#l5.1763"></a><span id="l5.1763" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -17,98 +17,99 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> #define COMPACTOR_READ_BUFF_SIZE 16384</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> class nsFolderCompactState : public nsIMsgFolderCompactor,</span>
<a href="#l6.10"></a><span id="l6.10">                              public nsIStreamListener,</span>
<a href="#l6.11"></a><span id="l6.11">                              public nsICopyMessageStreamListener,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                             public nsIUrlListener</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-public:</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                             public nsIUrlListener {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ public:</span>
<a href="#l6.17"></a><span id="l6.17">   NS_DECL_ISUPPORTS</span>
<a href="#l6.18"></a><span id="l6.18">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l6.19"></a><span id="l6.19">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l6.20"></a><span id="l6.20">   NS_DECL_NSICOPYMESSAGESTREAMLISTENER</span>
<a href="#l6.21"></a><span id="l6.21">   NS_DECL_NSIURLLISTENER</span>
<a href="#l6.22"></a><span id="l6.22">   NS_DECL_NSIMSGFOLDERCOMPACTOR</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   nsFolderCompactState(void);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-protected:</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ protected:</span>
<a href="#l6.28"></a><span id="l6.28">   virtual ~nsFolderCompactState(void);</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">   virtual nsresult InitDB(nsIMsgDatabase *db);</span>
<a href="#l6.31"></a><span id="l6.31">   virtual nsresult StartCompacting();</span>
<a href="#l6.32"></a><span id="l6.32">   virtual nsresult FinishCompact();</span>
<a href="#l6.33"></a><span id="l6.33">   void CloseOutputStream();</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  void  CleanupTempFilesAfterError();</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  void CleanupTempFilesAfterError();</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  nsresult Init(nsIMsgFolder *aFolder, const char* aBaseMsgUri, nsIMsgDatabase *aDb,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-                            nsIFile *aPath, nsIMsgWindow *aMsgWindow);</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  nsresult Init(nsIMsgFolder *aFolder, const char *aBaseMsgUri,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                nsIMsgDatabase *aDb, nsIFile *aPath, nsIMsgWindow *aMsgWindow);</span>
<a href="#l6.41"></a><span id="l6.41">   nsresult GetMessage(nsIMsgDBHdr **message);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  nsresult BuildMessageURI(const char *baseURI, nsMsgKey key, nsCString&amp; uri);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  nsresult ShowStatusMsg(const nsString&amp; aMsg);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  nsresult BuildMessageURI(const char *baseURI, nsMsgKey key, nsCString &amp;uri);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  nsresult ShowStatusMsg(const nsString &amp;aMsg);</span>
<a href="#l6.46"></a><span id="l6.46">   nsresult ReleaseFolderLock();</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  void     ShowCompactingStatusMsg();</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  void     CompactCompleted(nsresult exitCode);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  void     ShowDoneStatus();</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  void ShowCompactingStatusMsg();</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  void CompactCompleted(nsresult exitCode);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  void ShowDoneStatus();</span>
<a href="#l6.53"></a><span id="l6.53">   nsresult CompactNextFolder();</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  nsCString m_baseMessageUri; // base message uri</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  nsCString m_messageUri; // current message uri being copy</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder; // current folder being compact</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDatabase&gt; m_db; // new database for the compact folder</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; m_file; // new mailbox for the compact folder</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; m_fileStream; // output file stream for writing</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  nsCString m_baseMessageUri;       // base message uri</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  nsCString m_messageUri;           // current message uri being copy</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;  // current folder being compact</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;    // new database for the compact folder</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_file;         // new mailbox for the compact folder</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; m_fileStream;  // output file stream for writing</span>
<a href="#l6.67"></a><span id="l6.67">   // all message keys that need to be copied over</span>
<a href="#l6.68"></a><span id="l6.68">   RefPtr&lt;nsMsgKeyArray&gt; m_keyArray;</span>
<a href="#l6.69"></a><span id="l6.69">   uint32_t m_size;</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-   // sum of the sizes of the messages, accumulated as we visit each msg.</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  // sum of the sizes of the messages, accumulated as we visit each msg.</span>
<a href="#l6.73"></a><span id="l6.73">   uint64_t m_totalMsgSize;</span>
<a href="#l6.74"></a><span id="l6.74">   // number of bytes that can be expunged while compacting.</span>
<a href="#l6.75"></a><span id="l6.75">   uint64_t m_totalExpungedBytes;</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  uint32_t m_curIndex; // index of the current copied message key in key array</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-  uint64_t m_startOfNewMsg; // offset in mailbox of new message</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  char m_dataBuffer[COMPACTOR_READ_BUFF_SIZE + 1]; // temp data buffer for copying message</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-  nsresult m_status; // the status of the copying operation</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; m_messageService; // message service for copying</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; m_folderArray; // folders we are compacting, if compacting multiple.</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; m_curSrcHdr;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  uint32_t m_folderIndex; // tells which folder to compact in case of compact all</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-  bool m_compactAll;  //flag for compact all</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-  bool m_compactOfflineAlso; //whether to compact offline also</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-  bool m_compactingOfflineFolders; // are we in the offline folder compact phase</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-  bool m_parsingFolder; //flag for parsing local folders;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  uint32_t m_curIndex;  // index of the current copied message key in key array</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  uint64_t m_startOfNewMsg;  // offset in mailbox of new message</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  char m_dataBuffer[COMPACTOR_READ_BUFF_SIZE + 1];  // temp data buffer for</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+                                                    // copying message</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  nsresult m_status;  // the status of the copying operation</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; m_messageService;  // message service for</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+                                                    // copying</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_folderArray;  // folders we are compacting,</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+                                     // if compacting multiple.</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_curSrcHdr;</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  uint32_t m_folderIndex;           // tells which folder to compact in case of</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+                                    // compact all</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+  bool m_compactAll;                // flag for compact all</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  bool m_compactOfflineAlso;        // whether to compact offline also</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  bool m_compactingOfflineFolders;  // are we in offline folder compact phase</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  bool m_parsingFolder;             // flag for parsing local folders;</span>
<a href="#l6.107"></a><span id="l6.107">   // these members are used to add missing status lines to compacted messages.</span>
<a href="#l6.108"></a><span id="l6.108">   bool m_needStatusLine;</span>
<a href="#l6.109"></a><span id="l6.109">   bool m_startOfMsg;</span>
<a href="#l6.110"></a><span id="l6.110">   int32_t m_statusOffset;</span>
<a href="#l6.111"></a><span id="l6.111">   uint32_t m_addedHeaderSize;</span>
<a href="#l6.112"></a><span id="l6.112">   nsCOMPtr&lt;nsIArray&gt; m_offlineFolderArray;</span>
<a href="#l6.113"></a><span id="l6.113">   nsCOMPtr&lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l6.114"></a><span id="l6.114">   bool m_alreadyWarnedDiskSpace;</span>
<a href="#l6.115"></a><span id="l6.115"> };</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-class nsOfflineStoreCompactState : public nsFolderCompactState</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-{</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-public:</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+class nsOfflineStoreCompactState : public nsFolderCompactState {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+ public:</span>
<a href="#l6.123"></a><span id="l6.123">   nsOfflineStoreCompactState(void);</span>
<a href="#l6.124"></a><span id="l6.124">   virtual ~nsOfflineStoreCompactState(void);</span>
<a href="#l6.125"></a><span id="l6.125">   NS_IMETHOD OnStopRequest(nsIRequest *request, nsresult status) override;</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-  NS_IMETHODIMP OnDataAvailable(nsIRequest *request,</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-                                nsIInputStream *inStr,</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+  NS_IMETHODIMP OnDataAvailable(nsIRequest *request, nsIInputStream *inStr,</span>
<a href="#l6.129"></a><span id="l6.129">                                 uint64_t sourceOffset, uint32_t count) override;</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-protected:</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-    nsresult         CopyNextMessage(bool &amp;done);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    virtual nsresult InitDB(nsIMsgDatabase *db) override;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    virtual nsresult StartCompacting() override;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    virtual nsresult FinishCompact() override;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+ protected:</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+  nsresult CopyNextMessage(bool &amp;done);</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+  virtual nsresult InitDB(nsIMsgDatabase *db) override;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+  virtual nsresult StartCompacting() override;</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+  virtual nsresult FinishCompact() override;</span>
<a href="#l6.141"></a><span id="l6.141"> </span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-    uint32_t m_offlineMsgSize;</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  uint32_t m_offlineMsgSize;</span>
<a href="#l6.144"></a><span id="l6.144"> };</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -10,164 +10,145 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> //</span>
<a href="#l7.10"></a><span id="l7.10"> //  nsMsgFolderNotificationService</span>
<a href="#l7.11"></a><span id="l7.11"> //</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgFolderNotificationService, nsIMsgFolderNotificationService)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgFolderNotificationService,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+                  nsIMsgFolderNotificationService)</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-nsMsgFolderNotificationService::nsMsgFolderNotificationService()</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-{</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-}</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+nsMsgFolderNotificationService::nsMsgFolderNotificationService() {}</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-nsMsgFolderNotificationService::~nsMsgFolderNotificationService()</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-{</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+nsMsgFolderNotificationService::~nsMsgFolderNotificationService() {</span>
<a href="#l7.24"></a><span id="l7.24">   /* destructor code */</span>
<a href="#l7.25"></a><span id="l7.25"> }</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::GetHasListeners(bool *aHasListeners)</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-{</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::GetHasListeners(</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    bool *aHasListeners) {</span>
<a href="#l7.31"></a><span id="l7.31">   NS_ENSURE_ARG_POINTER(aHasListeners);</span>
<a href="#l7.32"></a><span id="l7.32">   *aHasListeners = mListeners.Length() &gt; 0;</span>
<a href="#l7.33"></a><span id="l7.33">   return NS_OK;</span>
<a href="#l7.34"></a><span id="l7.34"> }</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-/* void addListener (in nsIMsgFolderListener aListener, in msgFolderListenerFlag flags); */</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::AddListener(nsIMsgFolderListener *aListener,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-                                                          msgFolderListenerFlag aFlags)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-{</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::AddListener(</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+    nsIMsgFolderListener *aListener, msgFolderListenerFlag aFlags) {</span>
<a href="#l7.43"></a><span id="l7.43">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l7.44"></a><span id="l7.44">   MsgFolderListener listener(aListener, aFlags);</span>
<a href="#l7.45"></a><span id="l7.45">   mListeners.AppendElementUnlessExists(listener);</span>
<a href="#l7.46"></a><span id="l7.46">   return NS_OK;</span>
<a href="#l7.47"></a><span id="l7.47"> }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-/* void removeListener (in nsIMsgFolderListener aListener); */</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::RemoveListener(nsIMsgFolderListener *aListener)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-{</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::RemoveListener(</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    nsIMsgFolderListener *aListener) {</span>
<a href="#l7.54"></a><span id="l7.54">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56">   mListeners.RemoveElement(aListener);</span>
<a href="#l7.57"></a><span id="l7.57">   return NS_OK;</span>
<a href="#l7.58"></a><span id="l7.58"> }</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60"> #define NOTIFY_MSGFOLDER_LISTENERS(propertyflag_, propertyfunc_, params_) \</span>
<a href="#l7.61"></a><span id="l7.61">   PR_BEGIN_MACRO                                                          \</span>
<a href="#l7.62"></a><span id="l7.62">   nsTObserverArray&lt;MsgFolderListener&gt;::ForwardIterator iter(mListeners);  \</span>
<a href="#l7.63"></a><span id="l7.63">   while (iter.HasMore()) {                                                \</span>
<a href="#l7.64"></a><span id="l7.64">     const MsgFolderListener &amp;listener = iter.GetNext();                   \</span>
<a href="#l7.65"></a><span id="l7.65">     if (listener.mFlags &amp; propertyflag_)                                  \</span>
<a href="#l7.66"></a><span id="l7.66">       listener.mListener-&gt;propertyfunc_ params_;                          \</span>
<a href="#l7.67"></a><span id="l7.67">   }                                                                       \</span>
<a href="#l7.68"></a><span id="l7.68">   PR_END_MACRO</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-/* void notifyMsgAdded (in nsIMsgDBHdr aMsg); */</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgAdded(nsIMsgDBHdr *aMsg)</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-{</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgAdded(</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+    nsIMsgDBHdr *aMsg) {</span>
<a href="#l7.75"></a><span id="l7.75">   NOTIFY_MSGFOLDER_LISTENERS(msgAdded, MsgAdded, (aMsg));</span>
<a href="#l7.76"></a><span id="l7.76">   return NS_OK;</span>
<a href="#l7.77"></a><span id="l7.77"> }</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-/* void notifyMsgsClassified (in  */</span>
<a href="#l7.80"></a><span id="l7.80"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsClassified(</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  nsIArray *aMsgs, bool aJunkProcessed, bool aTraitProcessed)</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-{</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    nsIArray *aMsgs, bool aJunkProcessed, bool aTraitProcessed) {</span>
<a href="#l7.84"></a><span id="l7.84">   NOTIFY_MSGFOLDER_LISTENERS(msgsClassified, MsgsClassified,</span>
<a href="#l7.85"></a><span id="l7.85">                              (aMsgs, aJunkProcessed, aTraitProcessed));</span>
<a href="#l7.86"></a><span id="l7.86">   return NS_OK;</span>
<a href="#l7.87"></a><span id="l7.87"> }</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-/* void notifyMsgsDeleted (in nsIArray aMsgs); */</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsDeleted(nsIArray *aMsgs)</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-{</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsDeleted(</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    nsIArray *aMsgs) {</span>
<a href="#l7.94"></a><span id="l7.94">   NOTIFY_MSGFOLDER_LISTENERS(msgsDeleted, MsgsDeleted, (aMsgs));</span>
<a href="#l7.95"></a><span id="l7.95">   return NS_OK;</span>
<a href="#l7.96"></a><span id="l7.96"> }</span>
<a href="#l7.97"></a><span id="l7.97"> </span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-/* void notifyMsgsMoveCopyCompleted (in boolean aMove, in nsIArray aSrcMsgs,</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-                                     in nsIMsgFolder aDestFolder); */</span>
<a href="#l7.100"></a><span id="l7.100"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsMoveCopyCompleted(</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-  bool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-  nsIArray *aDestMsgs)</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-{</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+    bool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+    nsIArray *aDestMsgs) {</span>
<a href="#l7.106"></a><span id="l7.106">   uint32_t count = mListeners.Length();</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108">   // IMAP delete model means that a &quot;move&quot; isn't really a move, it is a copy,</span>
<a href="#l7.109"></a><span id="l7.109">   // followed by storing the IMAP deleted flag on the message.</span>
<a href="#l7.110"></a><span id="l7.110">   bool isReallyMove = aMove;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-  if (count &gt; 0 &amp;&amp; aMove)</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-  {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+  if (count &gt; 0 &amp;&amp; aMove) {</span>
<a href="#l7.114"></a><span id="l7.114">     nsresult rv;</span>
<a href="#l7.115"></a><span id="l7.115">     // Assume that all the source messages are from the same server.</span>
<a href="#l7.116"></a><span id="l7.116">     nsCOMPtr&lt;nsIMsgDBHdr&gt; message(do_QueryElementAt(aSrcMsgs, 0, &amp;rv));</span>
<a href="#l7.117"></a><span id="l7.117">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.118"></a><span id="l7.118"> </span>
<a href="#l7.119"></a><span id="l7.119">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l7.120"></a><span id="l7.120">     rv = message-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l7.121"></a><span id="l7.121">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.122"></a><span id="l7.122"> </span>
<a href="#l7.123"></a><span id="l7.123">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder(do_QueryInterface(msgFolder));</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-    if (imapFolder)</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-    {</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    if (imapFolder) {</span>
<a href="#l7.127"></a><span id="l7.127">       nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer;</span>
<a href="#l7.128"></a><span id="l7.128">       imapFolder-&gt;GetImapIncomingServer(getter_AddRefs(imapServer));</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-      if (imapServer)</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-      {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+      if (imapServer) {</span>
<a href="#l7.132"></a><span id="l7.132">         nsMsgImapDeleteModel deleteModel;</span>
<a href="#l7.133"></a><span id="l7.133">         imapServer-&gt;GetDeleteModel(&amp;deleteModel);</span>
<a href="#l7.134"></a><span id="l7.134">         if (deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l7.135"></a><span id="l7.135">           isReallyMove = false;</span>
<a href="#l7.136"></a><span id="l7.136">       }</span>
<a href="#l7.137"></a><span id="l7.137">     }</span>
<a href="#l7.138"></a><span id="l7.138">   }</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">   NOTIFY_MSGFOLDER_LISTENERS(msgsMoveCopyCompleted, MsgsMoveCopyCompleted,</span>
<a href="#l7.141"></a><span id="l7.141">                              (isReallyMove, aSrcMsgs, aDestFolder, aDestMsgs));</span>
<a href="#l7.142"></a><span id="l7.142">   return NS_OK;</span>
<a href="#l7.143"></a><span id="l7.143"> }</span>
<a href="#l7.144"></a><span id="l7.144"> </span>
<a href="#l7.145"></a><span id="l7.145"> NS_IMETHODIMP</span>
<a href="#l7.146"></a><span id="l7.146"> nsMsgFolderNotificationService::NotifyMsgKeyChanged(nsMsgKey aOldKey,</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-                                                    nsIMsgDBHdr *aNewHdr)</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-{</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+                                                    nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l7.150"></a><span id="l7.150">   NOTIFY_MSGFOLDER_LISTENERS(msgKeyChanged, MsgKeyChanged, (aOldKey, aNewHdr));</span>
<a href="#l7.151"></a><span id="l7.151">   return NS_OK;</span>
<a href="#l7.152"></a><span id="l7.152"> }</span>
<a href="#l7.153"></a><span id="l7.153"> </span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-/* void notifyFolderAdded(in nsIMsgFolder aFolder); */</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderAdded(nsIMsgFolder *aFolder)</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-{</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderAdded(</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    nsIMsgFolder *aFolder) {</span>
<a href="#l7.159"></a><span id="l7.159">   NOTIFY_MSGFOLDER_LISTENERS(folderAdded, FolderAdded, (aFolder));</span>
<a href="#l7.160"></a><span id="l7.160">   return NS_OK;</span>
<a href="#l7.161"></a><span id="l7.161"> }</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-/* void notifyFolderDeleted(in nsIMsgFolder aFolder); */</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderDeleted(nsIMsgFolder *aFolder)</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-{</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderDeleted(</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+    nsIMsgFolder *aFolder) {</span>
<a href="#l7.168"></a><span id="l7.168">   NOTIFY_MSGFOLDER_LISTENERS(folderDeleted, FolderDeleted, (aFolder));</span>
<a href="#l7.169"></a><span id="l7.169">   return NS_OK;</span>
<a href="#l7.170"></a><span id="l7.170"> }</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-/* void notifyFolderMoveCopyCompleted(in boolean aMove, in nsIMsgFolder aSrcFolder, in nsIMsgFolder aDestFolder); */</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderMoveCopyCompleted(bool aMove, nsIMsgFolder *aSrcFolder, nsIMsgFolder *aDestFolder)</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-{</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderMoveCopyCompleted(</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    bool aMove, nsIMsgFolder *aSrcFolder, nsIMsgFolder *aDestFolder) {</span>
<a href="#l7.177"></a><span id="l7.177">   NOTIFY_MSGFOLDER_LISTENERS(folderMoveCopyCompleted, FolderMoveCopyCompleted,</span>
<a href="#l7.178"></a><span id="l7.178">                              (aMove, aSrcFolder, aDestFolder));</span>
<a href="#l7.179"></a><span id="l7.179">   return NS_OK;</span>
<a href="#l7.180"></a><span id="l7.180"> }</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-/* void notifyFolderRenamed (in nsIMsgFolder aOrigFolder, in nsIMsgFolder aNewFolder); */</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderRenamed(nsIMsgFolder *aOrigFolder, nsIMsgFolder *aNewFolder)</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-{</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-  NOTIFY_MSGFOLDER_LISTENERS(folderRenamed, FolderRenamed, (aOrigFolder, aNewFolder));</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::NotifyFolderRenamed(</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+    nsIMsgFolder *aOrigFolder, nsIMsgFolder *aNewFolder) {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  NOTIFY_MSGFOLDER_LISTENERS(folderRenamed, FolderRenamed,</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+                             (aOrigFolder, aNewFolder));</span>
<a href="#l7.190"></a><span id="l7.190">   return NS_OK;</span>
<a href="#l7.191"></a><span id="l7.191"> }</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-/* void notifyItemEvent (in nsISupports aItem, in string aEvent, in nsISupports aData, in AUTF8String aString); */</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-NS_IMETHODIMP nsMsgFolderNotificationService::NotifyItemEvent(nsISupports *aItem, const nsACString &amp;aEvent, nsISupports *aData, const nsACString &amp;aString)</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-{</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  NOTIFY_MSGFOLDER_LISTENERS(itemEvent, ItemEvent, (aItem, aEvent, aData, aString));</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+NS_IMETHODIMP nsMsgFolderNotificationService::NotifyItemEvent(</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    nsISupports *aItem, const nsACString &amp;aEvent, nsISupports *aData,</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+    const nsACString &amp;aString) {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+  NOTIFY_MSGFOLDER_LISTENERS(itemEvent, ItemEvent,</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+                             (aItem, aEvent, aData, aString));</span>
<a href="#l7.202"></a><span id="l7.202">   return NS_OK;</span>
<a href="#l7.203"></a><span id="l7.203"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderNotificationService.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderNotificationService.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6,38 +6,38 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #ifndef nsMsgFolderNotificationService_h__</span>
<a href="#l8.5"></a><span id="l8.5"> #define nsMsgFolderNotificationService_h__</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIMsgFolderListener.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-class nsMsgFolderNotificationService final : public nsIMsgFolderNotificationService</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-public:</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+class nsMsgFolderNotificationService final</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    : public nsIMsgFolderNotificationService {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ public:</span>
<a href="#l8.18"></a><span id="l8.18">   NS_DECL_ISUPPORTS</span>
<a href="#l8.19"></a><span id="l8.19">   NS_DECL_NSIMSGFOLDERNOTIFICATIONSERVICE</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21">   nsMsgFolderNotificationService();</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-private:</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ private:</span>
<a href="#l8.25"></a><span id="l8.25">   ~nsMsgFolderNotificationService();</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  struct MsgFolderListener</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-  {</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  struct MsgFolderListener {</span>
<a href="#l8.29"></a><span id="l8.29">     nsCOMPtr&lt;nsIMsgFolderListener&gt; mListener;</span>
<a href="#l8.30"></a><span id="l8.30">     msgFolderListenerFlag mFlags;</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-    MsgFolderListener(nsIMsgFolderListener *aListener, msgFolderListenerFlag aFlags)</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-      : mListener(aListener), mFlags(aFlags) {}</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+    MsgFolderListener(nsIMsgFolderListener *aListener,</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+                      msgFolderListenerFlag aFlags)</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+        : mListener(aListener), mFlags(aFlags) {}</span>
<a href="#l8.37"></a><span id="l8.37">     MsgFolderListener(const MsgFolderListener &amp;aListener)</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-      : mListener(aListener.mListener), mFlags(aListener.mFlags) {}</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+        : mListener(aListener.mListener), mFlags(aListener.mFlags) {}</span>
<a href="#l8.40"></a><span id="l8.40">     ~MsgFolderListener() {}</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-    int operator==(nsIMsgFolderListener* aListener) const {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    int operator==(nsIMsgFolderListener *aListener) const {</span>
<a href="#l8.44"></a><span id="l8.44">       return mListener == aListener;</span>
<a href="#l8.45"></a><span id="l8.45">     }</span>
<a href="#l8.46"></a><span id="l8.46">     int operator==(const MsgFolderListener &amp;aListener) const {</span>
<a href="#l8.47"></a><span id="l8.47">       return mListener == aListener.mListener;</span>
<a href="#l8.48"></a><span id="l8.48">     }</span>
<a href="#l8.49"></a><span id="l8.49">   };</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51">   nsTObserverArray&lt;MsgFolderListener&gt; mListeners;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupThread.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupThread.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -7,562 +7,494 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsMsgGroupThread.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsMsgDBView.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> NS_IMPL_ISUPPORTS(nsMsgGroupThread, nsIMsgThread)</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsMsgGroupThread::nsMsgGroupThread()</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  Init();</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-}</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+nsMsgGroupThread::nsMsgGroupThread() { Init(); }</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-nsMsgGroupThread::nsMsgGroupThread(nsIMsgDatabase *db)</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-{</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+nsMsgGroupThread::nsMsgGroupThread(nsIMsgDatabase *db) {</span>
<a href="#l9.21"></a><span id="l9.21">   m_db = db;</span>
<a href="#l9.22"></a><span id="l9.22">   Init();</span>
<a href="#l9.23"></a><span id="l9.23"> }</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-void nsMsgGroupThread::Init()</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-{</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+void nsMsgGroupThread::Init() {</span>
<a href="#l9.28"></a><span id="l9.28">   m_threadKey = nsMsgKey_None;</span>
<a href="#l9.29"></a><span id="l9.29">   m_threadRootKey = nsMsgKey_None;</span>
<a href="#l9.30"></a><span id="l9.30">   m_numUnreadChildren = 0;</span>
<a href="#l9.31"></a><span id="l9.31">   m_flags = 0;</span>
<a href="#l9.32"></a><span id="l9.32">   m_newestMsgDate = 0;</span>
<a href="#l9.33"></a><span id="l9.33">   m_dummy = false;</span>
<a href="#l9.34"></a><span id="l9.34"> }</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-nsMsgGroupThread::~nsMsgGroupThread()</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-{</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-}</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+nsMsgGroupThread::~nsMsgGroupThread() {}</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::SetThreadKey(nsMsgKey threadKey)</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-{</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::SetThreadKey(nsMsgKey threadKey) {</span>
<a href="#l9.44"></a><span id="l9.44">   m_threadKey = threadKey;</span>
<a href="#l9.45"></a><span id="l9.45">   // by definition, the initial thread key is also the thread root key.</span>
<a href="#l9.46"></a><span id="l9.46">   m_threadRootKey = threadKey;</span>
<a href="#l9.47"></a><span id="l9.47">   return NS_OK;</span>
<a href="#l9.48"></a><span id="l9.48"> }</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetThreadKey(nsMsgKey *aResult)</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-{</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetThreadKey(nsMsgKey *aResult) {</span>
<a href="#l9.53"></a><span id="l9.53">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.54"></a><span id="l9.54">   *aResult = m_threadKey;</span>
<a href="#l9.55"></a><span id="l9.55">   return NS_OK;</span>
<a href="#l9.56"></a><span id="l9.56"> }</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetFlags(uint32_t *aFlags)</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-{</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetFlags(uint32_t *aFlags) {</span>
<a href="#l9.61"></a><span id="l9.61">   NS_ENSURE_ARG_POINTER(aFlags);</span>
<a href="#l9.62"></a><span id="l9.62">   *aFlags = m_flags;</span>
<a href="#l9.63"></a><span id="l9.63">   return NS_OK;</span>
<a href="#l9.64"></a><span id="l9.64"> }</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::SetFlags(uint32_t aFlags)</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-{</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::SetFlags(uint32_t aFlags) {</span>
<a href="#l9.69"></a><span id="l9.69">   m_flags = aFlags;</span>
<a href="#l9.70"></a><span id="l9.70">   return NS_OK;</span>
<a href="#l9.71"></a><span id="l9.71"> }</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::SetSubject(const nsACString&amp; aSubject)</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-{</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::SetSubject(const nsACString &amp;aSubject) {</span>
<a href="#l9.76"></a><span id="l9.76">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l9.77"></a><span id="l9.77">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.78"></a><span id="l9.78"> }</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetSubject(nsACString&amp; result)</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-{</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetSubject(nsACString &amp;result) {</span>
<a href="#l9.83"></a><span id="l9.83">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l9.84"></a><span id="l9.84">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.85"></a><span id="l9.85"> }</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetNumChildren(uint32_t *aNumChildren)</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-{</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetNumChildren(uint32_t *aNumChildren) {</span>
<a href="#l9.90"></a><span id="l9.90">   NS_ENSURE_ARG_POINTER(aNumChildren);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-  *aNumChildren = m_keys.Length(); // - ((m_dummy) ? 1 : 0);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+  *aNumChildren = m_keys.Length();  // - ((m_dummy) ? 1 : 0);</span>
<a href="#l9.93"></a><span id="l9.93">   return NS_OK;</span>
<a href="#l9.94"></a><span id="l9.94"> }</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-uint32_t nsMsgGroupThread::NumRealChildren()</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-{</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+uint32_t nsMsgGroupThread::NumRealChildren() {</span>
<a href="#l9.99"></a><span id="l9.99">   return m_keys.Length() - ((m_dummy) ? 1 : 0);</span>
<a href="#l9.100"></a><span id="l9.100"> }</span>
<a href="#l9.101"></a><span id="l9.101"> </span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetNumUnreadChildren (uint32_t *aNumUnreadChildren)</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-{</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetNumUnreadChildren(</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+    uint32_t *aNumUnreadChildren) {</span>
<a href="#l9.106"></a><span id="l9.106">   NS_ENSURE_ARG_POINTER(aNumUnreadChildren);</span>
<a href="#l9.107"></a><span id="l9.107">   *aNumUnreadChildren = m_numUnreadChildren;</span>
<a href="#l9.108"></a><span id="l9.108">   return NS_OK;</span>
<a href="#l9.109"></a><span id="l9.109"> }</span>
<a href="#l9.110"></a><span id="l9.110"> </span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-void nsMsgGroupThread::InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr)</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-{</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+void nsMsgGroupThread::InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr) {</span>
<a href="#l9.114"></a><span id="l9.114">   nsMsgKey msgKey;</span>
<a href="#l9.115"></a><span id="l9.115">   hdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.116"></a><span id="l9.116">   m_keys.InsertElementAt(index, msgKey);</span>
<a href="#l9.117"></a><span id="l9.117"> }</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-void nsMsgGroupThread::SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr)</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-{</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+void nsMsgGroupThread::SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr) {</span>
<a href="#l9.122"></a><span id="l9.122">   nsMsgKey msgKey;</span>
<a href="#l9.123"></a><span id="l9.123">   hdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.124"></a><span id="l9.124">   m_keys[index] = msgKey;</span>
<a href="#l9.125"></a><span id="l9.125"> }</span>
<a href="#l9.126"></a><span id="l9.126"> </span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-nsMsgViewIndex nsMsgGroupThread::FindMsgHdr(nsIMsgDBHdr *hdr)</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-{</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+nsMsgViewIndex nsMsgGroupThread::FindMsgHdr(nsIMsgDBHdr *hdr) {</span>
<a href="#l9.130"></a><span id="l9.130">   nsMsgKey msgKey;</span>
<a href="#l9.131"></a><span id="l9.131">   hdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.132"></a><span id="l9.132">   return (nsMsgViewIndex)m_keys.IndexOf(msgKey);</span>
<a href="#l9.133"></a><span id="l9.133"> }</span>
<a href="#l9.134"></a><span id="l9.134"> </span>
<a href="#l9.135"></a><span id="l9.135"> NS_IMETHODIMP nsMsgGroupThread::AddChild(nsIMsgDBHdr *child,</span>
<a href="#l9.136"></a><span id="l9.136">                                          nsIMsgDBHdr *inReplyTo,</span>
<a href="#l9.137"></a><span id="l9.137">                                          bool threadInThread,</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-                                         nsIDBChangeAnnouncer *announcer)</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-{</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+                                         nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l9.141"></a><span id="l9.141">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l9.142"></a><span id="l9.142">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.143"></a><span id="l9.143"> }</span>
<a href="#l9.144"></a><span id="l9.144"> </span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-nsMsgViewIndex nsMsgGroupThread::AddMsgHdrInDateOrder(nsIMsgDBHdr *child, nsMsgDBView *view)</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-{</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+nsMsgViewIndex nsMsgGroupThread::AddMsgHdrInDateOrder(nsIMsgDBHdr *child,</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+                                                      nsMsgDBView *view) {</span>
<a href="#l9.149"></a><span id="l9.149">   nsMsgKey newHdrKey;</span>
<a href="#l9.150"></a><span id="l9.150">   child-&gt;GetMessageKey(&amp;newHdrKey);</span>
<a href="#l9.151"></a><span id="l9.151">   uint32_t insertIndex = 0;</span>
<a href="#l9.152"></a><span id="l9.152">   // since we're sorted by date, we could do a binary search for the</span>
<a href="#l9.153"></a><span id="l9.153">   // insert point. Or, we could start at the end...</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-  if (m_keys.Length() &gt; 0)</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-  {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    nsMsgViewSortTypeValue  sortType;</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+  if (m_keys.Length() &gt; 0) {</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+    nsMsgViewSortTypeValue sortType;</span>
<a href="#l9.159"></a><span id="l9.159">     nsMsgViewSortOrderValue sortOrder;</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-    (void) view-&gt;GetSortType(&amp;sortType);</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-    (void) view-&gt;GetSortOrder(&amp;sortOrder);</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+    (void)view-&gt;GetSortType(&amp;sortType);</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+    (void)view-&gt;GetSortOrder(&amp;sortOrder);</span>
<a href="#l9.164"></a><span id="l9.164">     // historical behavior is ascending date order unless our primary sort is</span>
<a href="#l9.165"></a><span id="l9.165">     //  on date</span>
<a href="#l9.166"></a><span id="l9.166">     nsMsgViewSortOrderValue threadSortOrder =</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-      (sortType == nsMsgViewSortType::byDate</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-        &amp;&amp; sortOrder == nsMsgViewSortOrder::descending) ?</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-          nsMsgViewSortOrder::descending : nsMsgViewSortOrder::ascending;</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+        (sortType == nsMsgViewSortType::byDate &amp;&amp;</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+         sortOrder == nsMsgViewSortOrder::descending)</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+            ? nsMsgViewSortOrder::descending</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+            : nsMsgViewSortOrder::ascending;</span>
<a href="#l9.174"></a><span id="l9.174">     // new behavior is tricky and uses the secondary sort order if the secondary</span>
<a href="#l9.175"></a><span id="l9.175">     //  sort is on the date</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-    nsMsgViewSortTypeValue  secondarySortType;</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+    nsMsgViewSortTypeValue secondarySortType;</span>
<a href="#l9.178"></a><span id="l9.178">     nsMsgViewSortOrderValue secondarySortOrder;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-    (void) view-&gt;GetSecondarySortType(&amp;secondarySortType);</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-    (void) view-&gt;GetSecondarySortOrder(&amp;secondarySortOrder);</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+    (void)view-&gt;GetSecondarySortType(&amp;secondarySortType);</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+    (void)view-&gt;GetSecondarySortOrder(&amp;secondarySortOrder);</span>
<a href="#l9.183"></a><span id="l9.183">     if (secondarySortType == nsMsgViewSortType::byDate)</span>
<a href="#l9.184"></a><span id="l9.184">       threadSortOrder = secondarySortOrder;</span>
<a href="#l9.185"></a><span id="l9.185">     // sort by date within group.</span>
<a href="#l9.186"></a><span id="l9.186">     insertIndex = GetInsertIndexFromView(view, child, threadSortOrder);</span>
<a href="#l9.187"></a><span id="l9.187">   }</span>
<a href="#l9.188"></a><span id="l9.188">   m_keys.InsertElementAt(insertIndex, newHdrKey);</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-  if (!insertIndex)</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    m_threadRootKey = newHdrKey;</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+  if (!insertIndex) m_threadRootKey = newHdrKey;</span>
<a href="#l9.192"></a><span id="l9.192">   return insertIndex;</span>
<a href="#l9.193"></a><span id="l9.193"> }</span>
<a href="#l9.194"></a><span id="l9.194"> </span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-nsMsgGroupThread::GetInsertIndexFromView(nsMsgDBView *view,</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-                                         nsIMsgDBHdr *child,</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-                                         nsMsgViewSortOrderValue threadSortOrder)</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-{</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-  return view-&gt;GetInsertIndexHelper(child, m_keys, nullptr, threadSortOrder, nsMsgViewSortType::byDate);</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+nsMsgViewIndex nsMsgGroupThread::GetInsertIndexFromView(</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+    nsMsgDBView *view, nsIMsgDBHdr *child,</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+    nsMsgViewSortOrderValue threadSortOrder) {</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+  return view-&gt;GetInsertIndexHelper(child, m_keys, nullptr, threadSortOrder,</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+                                    nsMsgViewSortType::byDate);</span>
<a href="#l9.206"></a><span id="l9.206"> }</span>
<a href="#l9.207"></a><span id="l9.207"> </span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-nsMsgViewIndex nsMsgGroupThread::AddChildFromGroupView(nsIMsgDBHdr *child, nsMsgDBView *view)</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-{</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+nsMsgViewIndex nsMsgGroupThread::AddChildFromGroupView(nsIMsgDBHdr *child,</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+                                                       nsMsgDBView *view) {</span>
<a href="#l9.212"></a><span id="l9.212">   uint32_t newHdrFlags = 0;</span>
<a href="#l9.213"></a><span id="l9.213">   uint32_t msgDate;</span>
<a href="#l9.214"></a><span id="l9.214">   nsMsgKey newHdrKey = 0;</span>
<a href="#l9.215"></a><span id="l9.215"> </span>
<a href="#l9.216"></a><span id="l9.216">   child-&gt;GetFlags(&amp;newHdrFlags);</span>
<a href="#l9.217"></a><span id="l9.217">   child-&gt;GetMessageKey(&amp;newHdrKey);</span>
<a href="#l9.218"></a><span id="l9.218">   child-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-  if (msgDate &gt; m_newestMsgDate)</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-    SetNewestMsgDate(msgDate);</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  if (msgDate &gt; m_newestMsgDate) SetNewestMsgDate(msgDate);</span>
<a href="#l9.222"></a><span id="l9.222"> </span>
<a href="#l9.223"></a><span id="l9.223">   child-&gt;AndFlags(~(nsMsgMessageFlags::Watched), &amp;newHdrFlags);</span>
<a href="#l9.224"></a><span id="l9.224">   uint32_t numChildren;</span>
<a href="#l9.225"></a><span id="l9.225"> </span>
<a href="#l9.226"></a><span id="l9.226">   // get the num children before we add the new header.</span>
<a href="#l9.227"></a><span id="l9.227">   GetNumChildren(&amp;numChildren);</span>
<a href="#l9.228"></a><span id="l9.228"> </span>
<a href="#l9.229"></a><span id="l9.229">   // if this is an empty thread, set the root key to this header's key</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-  if (numChildren == 0)</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-    m_threadRootKey = newHdrKey;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+  if (numChildren == 0) m_threadRootKey = newHdrKey;</span>
<a href="#l9.233"></a><span id="l9.233"> </span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-  if (! (newHdrFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-    ChangeUnreadChildCount(1);</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+  if (!(newHdrFlags &amp; nsMsgMessageFlags::Read)) ChangeUnreadChildCount(1);</span>
<a href="#l9.237"></a><span id="l9.237"> </span>
<a href="#l9.238"></a><span id="l9.238">   return AddMsgHdrInDateOrder(child, view);</span>
<a href="#l9.239"></a><span id="l9.239"> }</span>
<a href="#l9.240"></a><span id="l9.240"> </span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-nsresult</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-nsMsgGroupThread::ReparentNonReferenceChildrenOf(nsIMsgDBHdr *topLevelHdr,</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-                                                 nsMsgKey newParentKey,</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-                                                 nsIDBChangeAnnouncer *announcer)</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-{</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+nsresult nsMsgGroupThread::ReparentNonReferenceChildrenOf(</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+    nsIMsgDBHdr *topLevelHdr, nsMsgKey newParentKey,</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+    nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l9.249"></a><span id="l9.249">   return NS_OK;</span>
<a href="#l9.250"></a><span id="l9.250"> }</span>
<a href="#l9.251"></a><span id="l9.251"> </span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetChildKeyAt(uint32_t aIndex, nsMsgKey *aResult)</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-{</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetChildKeyAt(uint32_t aIndex,</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+                                              nsMsgKey *aResult) {</span>
<a href="#l9.256"></a><span id="l9.256">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-  if (aIndex &gt;= m_keys.Length())</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+  if (aIndex &gt;= m_keys.Length()) return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.260"></a><span id="l9.260">   *aResult = m_keys[aIndex];</span>
<a href="#l9.261"></a><span id="l9.261">   return NS_OK;</span>
<a href="#l9.262"></a><span id="l9.262"> }</span>
<a href="#l9.263"></a><span id="l9.263"> </span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetChildHdrAt(uint32_t aIndex, nsIMsgDBHdr **aResult)</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-{</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-  if (aIndex &gt;= m_keys.Length())</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetChildHdrAt(uint32_t aIndex,</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+                                              nsIMsgDBHdr **aResult) {</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+  if (aIndex &gt;= m_keys.Length()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l9.271"></a><span id="l9.271">   return m_db-&gt;GetMsgHdrForKey(m_keys[aIndex], aResult);</span>
<a href="#l9.272"></a><span id="l9.272"> }</span>
<a href="#l9.273"></a><span id="l9.273"> </span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetChild(nsMsgKey msgKey, nsIMsgDBHdr **aResult)</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-{</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetChild(nsMsgKey msgKey,</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+                                         nsIMsgDBHdr **aResult) {</span>
<a href="#l9.279"></a><span id="l9.279">   return GetChildHdrAt(m_keys.IndexOf(msgKey), aResult);</span>
<a href="#l9.280"></a><span id="l9.280"> }</span>
<a href="#l9.281"></a><span id="l9.281"> </span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::RemoveChildAt(uint32_t aIndex)</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-{</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::RemoveChildAt(uint32_t aIndex) {</span>
<a href="#l9.285"></a><span id="l9.285">   NS_ENSURE_TRUE(aIndex &lt; m_keys.Length(), NS_MSG_MESSAGE_NOT_FOUND);</span>
<a href="#l9.286"></a><span id="l9.286"> </span>
<a href="#l9.287"></a><span id="l9.287">   m_keys.RemoveElementAt(aIndex);</span>
<a href="#l9.288"></a><span id="l9.288">   return NS_OK;</span>
<a href="#l9.289"></a><span id="l9.289"> }</span>
<a href="#l9.290"></a><span id="l9.290"> </span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-nsresult nsMsgGroupThread::RemoveChild(nsMsgKey msgKey)</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-{</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+nsresult nsMsgGroupThread::RemoveChild(nsMsgKey msgKey) {</span>
<a href="#l9.294"></a><span id="l9.294">   m_keys.RemoveElement(msgKey);</span>
<a href="#l9.295"></a><span id="l9.295">   return NS_OK;</span>
<a href="#l9.296"></a><span id="l9.296"> }</span>
<a href="#l9.297"></a><span id="l9.297"> </span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::RemoveChildHdr(nsIMsgDBHdr *child,</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-                                               nsIDBChangeAnnouncer *announcer)</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-{</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::RemoveChildHdr(</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+    nsIMsgDBHdr *child, nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l9.303"></a><span id="l9.303">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l9.304"></a><span id="l9.304"> </span>
<a href="#l9.305"></a><span id="l9.305">   uint32_t flags;</span>
<a href="#l9.306"></a><span id="l9.306">   nsMsgKey key;</span>
<a href="#l9.307"></a><span id="l9.307"> </span>
<a href="#l9.308"></a><span id="l9.308">   child-&gt;GetFlags(&amp;flags);</span>
<a href="#l9.309"></a><span id="l9.309">   child-&gt;GetMessageKey(&amp;key);</span>
<a href="#l9.310"></a><span id="l9.310"> </span>
<a href="#l9.311"></a><span id="l9.311">   // if this was the newest msg, clear the newest msg date so we'll recalc.</span>
<a href="#l9.312"></a><span id="l9.312">   uint32_t date;</span>
<a href="#l9.313"></a><span id="l9.313">   child-&gt;GetDateInSeconds(&amp;date);</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-  if (date == m_newestMsgDate)</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    SetNewestMsgDate(0);</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+  if (date == m_newestMsgDate) SetNewestMsgDate(0);</span>
<a href="#l9.317"></a><span id="l9.317"> </span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-  if (!(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-    ChangeUnreadChildCount(-1);</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+  if (!(flags &amp; nsMsgMessageFlags::Read)) ChangeUnreadChildCount(-1);</span>
<a href="#l9.321"></a><span id="l9.321">   nsMsgViewIndex threadIndex = FindMsgHdr(child);</span>
<a href="#l9.322"></a><span id="l9.322">   bool wasFirstChild = threadIndex == 0;</span>
<a href="#l9.323"></a><span id="l9.323">   nsresult rv = RemoveChildAt(threadIndex);</span>
<a href="#l9.324"></a><span id="l9.324">   // if we're deleting the root of a dummy thread, need to update the threadKey</span>
<a href="#l9.325"></a><span id="l9.325">   // and the dummy header at position 0</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-  if (m_dummy &amp;&amp; wasFirstChild &amp;&amp; m_keys.Length() &gt; 1)</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-  {</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+  if (m_dummy &amp;&amp; wasFirstChild &amp;&amp; m_keys.Length() &gt; 1) {</span>
<a href="#l9.329"></a><span id="l9.329">     nsIMsgDBHdr *newRootChild;</span>
<a href="#l9.330"></a><span id="l9.330">     rv = GetChildHdrAt(1, &amp;newRootChild);</span>
<a href="#l9.331"></a><span id="l9.331">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.332"></a><span id="l9.332">     SetMsgHdrAt(0, newRootChild);</span>
<a href="#l9.333"></a><span id="l9.333">   }</span>
<a href="#l9.334"></a><span id="l9.334"> </span>
<a href="#l9.335"></a><span id="l9.335">   return rv;</span>
<a href="#l9.336"></a><span id="l9.336"> }</span>
<a href="#l9.337"></a><span id="l9.337"> </span>
<a href="#l9.338"></a><span id="l9.338"> nsresult nsMsgGroupThread::ReparentChildrenOf(nsMsgKey oldParent,</span>
<a href="#l9.339"></a><span id="l9.339">                                               nsMsgKey newParent,</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-                                              nsIDBChangeAnnouncer *announcer)</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-{</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+                                              nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l9.343"></a><span id="l9.343">   nsresult rv = NS_OK;</span>
<a href="#l9.344"></a><span id="l9.344"> </span>
<a href="#l9.345"></a><span id="l9.345">   uint32_t numChildren = 0;</span>
<a href="#l9.346"></a><span id="l9.346">   GetNumChildren(&amp;numChildren);</span>
<a href="#l9.347"></a><span id="l9.347"> </span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-  if (numChildren &gt; 0)</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-  {</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineplus">+  if (numChildren &gt; 0) {</span>
<a href="#l9.351"></a><span id="l9.351">     nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-    {</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l9.355"></a><span id="l9.355">       rv = GetChildHdrAt(childIndex, getter_AddRefs(curHdr));</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; curHdr)</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-      {</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; curHdr) {</span>
<a href="#l9.359"></a><span id="l9.359">         nsMsgKey threadParent;</span>
<a href="#l9.360"></a><span id="l9.360"> </span>
<a href="#l9.361"></a><span id="l9.361">         curHdr-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineminus">-        if (threadParent == oldParent)</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineminus">-        {</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+        if (threadParent == oldParent) {</span>
<a href="#l9.365"></a><span id="l9.365">           nsMsgKey curKey;</span>
<a href="#l9.366"></a><span id="l9.366"> </span>
<a href="#l9.367"></a><span id="l9.367">           curHdr-&gt;SetThreadParent(newParent);</span>
<a href="#l9.368"></a><span id="l9.368">           curHdr-&gt;GetMessageKey(&amp;curKey);</span>
<a href="#l9.369"></a><span id="l9.369">           if (announcer)</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-            announcer-&gt;NotifyParentChangedAll(curKey, oldParent, newParent, nullptr);</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-          // if the old parent was the root of the thread, then only the first child gets</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-          // promoted to root, and other children become children of the new root.</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-          if (newParent == nsMsgKey_None)</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-          {</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+            announcer-&gt;NotifyParentChangedAll(curKey, oldParent, newParent,</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+                                              nullptr);</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineplus">+          // if the old parent was the root of the thread, then only the first</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+          // child gets promoted to root, and other children become children of</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+          // the new root.</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+          if (newParent == nsMsgKey_None) {</span>
<a href="#l9.381"></a><span id="l9.381">             m_threadRootKey = curKey;</span>
<a href="#l9.382"></a><span id="l9.382">             newParent = curKey;</span>
<a href="#l9.383"></a><span id="l9.383">           }</span>
<a href="#l9.384"></a><span id="l9.384">         }</span>
<a href="#l9.385"></a><span id="l9.385">       }</span>
<a href="#l9.386"></a><span id="l9.386">     }</span>
<a href="#l9.387"></a><span id="l9.387">   }</span>
<a href="#l9.388"></a><span id="l9.388">   return rv;</span>
<a href="#l9.389"></a><span id="l9.389"> }</span>
<a href="#l9.390"></a><span id="l9.390"> </span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::MarkChildRead(bool bRead)</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-{</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::MarkChildRead(bool bRead) {</span>
<a href="#l9.394"></a><span id="l9.394">   ChangeUnreadChildCount(bRead ? -1 : 1);</span>
<a href="#l9.395"></a><span id="l9.395">   return NS_OK;</span>
<a href="#l9.396"></a><span id="l9.396"> }</span>
<a href="#l9.397"></a><span id="l9.397"> </span>
<a href="#l9.398"></a><span id="l9.398"> // this could be moved into utils, because I think it's the same as the db impl.</span>
<a href="#l9.399"></a><span id="l9.399"> class nsMsgGroupThreadEnumerator : public nsSimpleEnumerator {</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-public:</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-  const nsID&amp; DefaultInterface() override</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-  {</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-    return NS_GET_IID(nsIMsgDBHdr);</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-  }</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+ public:</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+  const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIMsgDBHdr); }</span>
<a href="#l9.407"></a><span id="l9.407"> </span>
<a href="#l9.408"></a><span id="l9.408">   // nsISimpleEnumerator methods:</span>
<a href="#l9.409"></a><span id="l9.409">   NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l9.410"></a><span id="l9.410"> </span>
<a href="#l9.411"></a><span id="l9.411">   // nsMsgGroupThreadEnumerator methods:</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-  typedef nsresult (*nsMsgGroupThreadEnumeratorFilter)(nsIMsgDBHdr* hdr, void* closure);</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+  typedef nsresult (*nsMsgGroupThreadEnumeratorFilter)(nsIMsgDBHdr *hdr,</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+                                                       void *closure);</span>
<a href="#l9.415"></a><span id="l9.415"> </span>
<a href="#l9.416"></a><span id="l9.416">   nsMsgGroupThreadEnumerator(nsMsgGroupThread *thread, nsMsgKey startKey,</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-  nsMsgGroupThreadEnumeratorFilter filter, void* closure);</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+                             nsMsgGroupThreadEnumeratorFilter filter,</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineplus">+                             void *closure);</span>
<a href="#l9.420"></a><span id="l9.420">   int32_t MsgKeyFirstChildIndex(nsMsgKey inMsgKey);</span>
<a href="#l9.421"></a><span id="l9.421"> </span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-protected:</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+ protected:</span>
<a href="#l9.424"></a><span id="l9.424">   virtual ~nsMsgGroupThreadEnumerator();</span>
<a href="#l9.425"></a><span id="l9.425"> </span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-  nsresult                Prefetch();</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+  nsresult Prefetch();</span>
<a href="#l9.428"></a><span id="l9.428"> </span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;   mResultHdr;</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mResultHdr;</span>
<a href="#l9.431"></a><span id="l9.431">   RefPtr&lt;nsMsgGroupThread&gt; mThread;</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-  nsMsgKey                mThreadParentKey;</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineminus">-  nsMsgKey                mFirstMsgKey;</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-  int32_t                 mChildIndex;</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-  bool                    mDone;</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-  bool                    mNeedToPrefetch;</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-  nsMsgGroupThreadEnumeratorFilter     mFilter;</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-  void*                   mClosure;</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-  bool                    mFoundChildren;</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+  nsMsgKey mThreadParentKey;</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+  nsMsgKey mFirstMsgKey;</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+  int32_t mChildIndex;</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+  bool mDone;</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+  bool mNeedToPrefetch;</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+  nsMsgGroupThreadEnumeratorFilter mFilter;</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+  void *mClosure;</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+  bool mFoundChildren;</span>
<a href="#l9.448"></a><span id="l9.448"> };</span>
<a href="#l9.449"></a><span id="l9.449"> </span>
<a href="#l9.450"></a><span id="l9.450" class="difflineminus">-nsMsgGroupThreadEnumerator::nsMsgGroupThreadEnumerator(nsMsgGroupThread *thread, nsMsgKey startKey,</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-                                             nsMsgGroupThreadEnumeratorFilter filter, void* closure)</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-                                             : mDone(false),</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineminus">-                                             mFilter(filter), mClosure(closure), mFoundChildren(false)</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineminus">-{</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+nsMsgGroupThreadEnumerator::nsMsgGroupThreadEnumerator(</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+    nsMsgGroupThread *thread, nsMsgKey startKey,</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+    nsMsgGroupThreadEnumeratorFilter filter, void *closure)</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+    : mDone(false), mFilter(filter), mClosure(closure), mFoundChildren(false) {</span>
<a href="#l9.459"></a><span id="l9.459">   mThreadParentKey = startKey;</span>
<a href="#l9.460"></a><span id="l9.460">   mChildIndex = 0;</span>
<a href="#l9.461"></a><span id="l9.461">   mThread = thread;</span>
<a href="#l9.462"></a><span id="l9.462">   mNeedToPrefetch = true;</span>
<a href="#l9.463"></a><span id="l9.463">   mFirstMsgKey = nsMsgKey_None;</span>
<a href="#l9.464"></a><span id="l9.464"> </span>
<a href="#l9.465"></a><span id="l9.465">   nsresult rv = mThread-&gt;GetRootHdr(nullptr, getter_AddRefs(mResultHdr));</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-    mResultHdr-&gt;GetMessageKey(&amp;mFirstMsgKey);</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) mResultHdr-&gt;GetMessageKey(&amp;mFirstMsgKey);</span>
<a href="#l9.469"></a><span id="l9.469"> </span>
<a href="#l9.470"></a><span id="l9.470">   uint32_t numChildren;</span>
<a href="#l9.471"></a><span id="l9.471">   mThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l9.472"></a><span id="l9.472"> </span>
<a href="#l9.473"></a><span id="l9.473" class="difflineminus">-  if (mThreadParentKey != nsMsgKey_None)</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-  {</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+  if (mThreadParentKey != nsMsgKey_None) {</span>
<a href="#l9.476"></a><span id="l9.476">     nsMsgKey msgKey = nsMsgKey_None;</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-    {</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l9.480"></a><span id="l9.480">       rv = mThread-&gt;GetChildHdrAt(childIndex, getter_AddRefs(mResultHdr));</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineminus">-      {</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) {</span>
<a href="#l9.484"></a><span id="l9.484">         mResultHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-        if (msgKey == startKey)</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-        {</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+        if (msgKey == startKey) {</span>
<a href="#l9.488"></a><span id="l9.488">           mChildIndex = MsgKeyFirstChildIndex(msgKey);</span>
<a href="#l9.489"></a><span id="l9.489">           mDone = (mChildIndex &lt; 0);</span>
<a href="#l9.490"></a><span id="l9.490">           break;</span>
<a href="#l9.491"></a><span id="l9.491">         }</span>
<a href="#l9.492"></a><span id="l9.492"> </span>
<a href="#l9.493"></a><span id="l9.493" class="difflineminus">-        if (mDone)</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-          break;</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-      }</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-      else</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineplus">+        if (mDone) break;</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+      } else</span>
<a href="#l9.499"></a><span id="l9.499">         NS_ASSERTION(false, &quot;couldn't get child from thread&quot;);</span>
<a href="#l9.500"></a><span id="l9.500">     }</span>
<a href="#l9.501"></a><span id="l9.501">   }</span>
<a href="#l9.502"></a><span id="l9.502"> </span>
<a href="#l9.503"></a><span id="l9.503"> #ifdef DEBUG_bienvenu1</span>
<a href="#l9.504"></a><span id="l9.504">   nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-  {</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l9.508"></a><span id="l9.508">     rv = mThread-&gt;GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-    {</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l9.512"></a><span id="l9.512">       nsMsgKey threadParent;</span>
<a href="#l9.513"></a><span id="l9.513">       nsMsgKey msgKey;</span>
<a href="#l9.514"></a><span id="l9.514">       // we're only doing one level of threading, so check if caller is</span>
<a href="#l9.515"></a><span id="l9.515">       // asking for children of the first message in the thread or not.</span>
<a href="#l9.516"></a><span id="l9.516">       // if not, we will tell him there are no children.</span>
<a href="#l9.517"></a><span id="l9.517">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.518"></a><span id="l9.518">       child-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l9.519"></a><span id="l9.519"> </span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-      printf(&quot;index = %ld key = %ld parent = %lx\n&quot;, childIndex, msgKey, threadParent);</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineplus">+      printf(&quot;index = %ld key = %ld parent = %lx\n&quot;, childIndex, msgKey,</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+             threadParent);</span>
<a href="#l9.523"></a><span id="l9.523">     }</span>
<a href="#l9.524"></a><span id="l9.524">   }</span>
<a href="#l9.525"></a><span id="l9.525"> #endif</span>
<a href="#l9.526"></a><span id="l9.526"> }</span>
<a href="#l9.527"></a><span id="l9.527"> </span>
<a href="#l9.528"></a><span id="l9.528" class="difflineminus">-nsMsgGroupThreadEnumerator::~nsMsgGroupThreadEnumerator()</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-{</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineminus">-}</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+nsMsgGroupThreadEnumerator::~nsMsgGroupThreadEnumerator() {}</span>
<a href="#l9.532"></a><span id="l9.532"> </span>
<a href="#l9.533"></a><span id="l9.533" class="difflineminus">-int32_t nsMsgGroupThreadEnumerator::MsgKeyFirstChildIndex(nsMsgKey inMsgKey)</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineminus">-{</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+int32_t nsMsgGroupThreadEnumerator::MsgKeyFirstChildIndex(nsMsgKey inMsgKey) {</span>
<a href="#l9.536"></a><span id="l9.536">   // look through rest of thread looking for a child of this message.</span>
<a href="#l9.537"></a><span id="l9.537">   // If the inMsgKey is the first message in the thread, then all children</span>
<a href="#l9.538"></a><span id="l9.538">   // without parents are considered to be children of inMsgKey.</span>
<a href="#l9.539"></a><span id="l9.539">   // Otherwise, only true children qualify.</span>
<a href="#l9.540"></a><span id="l9.540">   uint32_t numChildren;</span>
<a href="#l9.541"></a><span id="l9.541">   nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l9.542"></a><span id="l9.542">   int32_t firstChildIndex = -1;</span>
<a href="#l9.543"></a><span id="l9.543"> </span>
<a href="#l9.544"></a><span id="l9.544">   mThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l9.545"></a><span id="l9.545"> </span>
<a href="#l9.546"></a><span id="l9.546" class="difflineminus">-  for (uint32_t curChildIndex = 0; curChildIndex &lt; numChildren; curChildIndex++)</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineminus">-  {</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineplus">+  for (uint32_t curChildIndex = 0; curChildIndex &lt; numChildren;</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+       curChildIndex++) {</span>
<a href="#l9.550"></a><span id="l9.550">     nsresult rv = mThread-&gt;GetChildHdrAt(curChildIndex, getter_AddRefs(curHdr));</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; curHdr)</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-    {</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; curHdr) {</span>
<a href="#l9.554"></a><span id="l9.554">       nsMsgKey parentKey;</span>
<a href="#l9.555"></a><span id="l9.555"> </span>
<a href="#l9.556"></a><span id="l9.556">       curHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-      if (parentKey == inMsgKey)</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-      {</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+      if (parentKey == inMsgKey) {</span>
<a href="#l9.560"></a><span id="l9.560">         firstChildIndex = curChildIndex;</span>
<a href="#l9.561"></a><span id="l9.561">         break;</span>
<a href="#l9.562"></a><span id="l9.562">       }</span>
<a href="#l9.563"></a><span id="l9.563">     }</span>
<a href="#l9.564"></a><span id="l9.564">   }</span>
<a href="#l9.565"></a><span id="l9.565"> #ifdef DEBUG_bienvenu1</span>
<a href="#l9.566"></a><span id="l9.566">   printf(&quot;first child index of %ld = %ld\n&quot;, inMsgKey, firstChildIndex);</span>
<a href="#l9.567"></a><span id="l9.567"> #endif</span>
<a href="#l9.568"></a><span id="l9.568">   return firstChildIndex;</span>
<a href="#l9.569"></a><span id="l9.569"> }</span>
<a href="#l9.570"></a><span id="l9.570"> </span>
<a href="#l9.571"></a><span id="l9.571" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThreadEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineminus">-{</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThreadEnumerator::GetNext(nsISupports **aItem) {</span>
<a href="#l9.574"></a><span id="l9.574">   NS_ENSURE_ARG_POINTER(aItem);</span>
<a href="#l9.575"></a><span id="l9.575">   nsresult rv = NS_OK;</span>
<a href="#l9.576"></a><span id="l9.576"> </span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-  if (mNeedToPrefetch)</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineminus">-    rv = Prefetch();</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+  if (mNeedToPrefetch) rv = Prefetch();</span>
<a href="#l9.580"></a><span id="l9.580"> </span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-  {</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) {</span>
<a href="#l9.584"></a><span id="l9.584">     NS_ADDREF(*aItem = mResultHdr);</span>
<a href="#l9.585"></a><span id="l9.585">     mNeedToPrefetch = true;</span>
<a href="#l9.586"></a><span id="l9.586">   }</span>
<a href="#l9.587"></a><span id="l9.587">   return rv;</span>
<a href="#l9.588"></a><span id="l9.588"> }</span>
<a href="#l9.589"></a><span id="l9.589"> </span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-nsresult nsMsgGroupThreadEnumerator::Prefetch()</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-{</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-  nsresult rv = NS_OK;          // XXX or should this default to an error?</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineplus">+nsresult nsMsgGroupThreadEnumerator::Prefetch() {</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+  nsresult rv = NS_OK;  // XXX or should this default to an error?</span>
<a href="#l9.595"></a><span id="l9.595">   mResultHdr = nullptr;</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-  if (mThreadParentKey == nsMsgKey_None)</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-  {</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+  if (mThreadParentKey == nsMsgKey_None) {</span>
<a href="#l9.599"></a><span id="l9.599">     rv = mThread-&gt;GetRootHdr(&amp;mChildIndex, getter_AddRefs(mResultHdr));</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; mResultHdr, &quot;better be able to get root hdr&quot;);</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineminus">-    mChildIndex = 0; // since root can be anywhere, set mChildIndex to 0.</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineminus">-  }</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineminus">-  else if (!mDone)</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineminus">-  {</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; mResultHdr,</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineplus">+                 &quot;better be able to get root hdr&quot;);</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineplus">+    mChildIndex = 0;  // since root can be anywhere, set mChildIndex to 0.</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+  } else if (!mDone) {</span>
<a href="#l9.609"></a><span id="l9.609">     uint32_t numChildren;</span>
<a href="#l9.610"></a><span id="l9.610">     mThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l9.611"></a><span id="l9.611"> </span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-    while ((uint32_t)mChildIndex &lt; numChildren)</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineminus">-    {</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-      rv  = mThread-&gt;GetChildHdrAt(mChildIndex++, getter_AddRefs(mResultHdr));</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineminus">-      {</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+    while ((uint32_t)mChildIndex &lt; numChildren) {</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+      rv = mThread-&gt;GetChildHdrAt(mChildIndex++, getter_AddRefs(mResultHdr));</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) {</span>
<a href="#l9.620"></a><span id="l9.620">         nsMsgKey parentKey;</span>
<a href="#l9.621"></a><span id="l9.621">         nsMsgKey curKey;</span>
<a href="#l9.622"></a><span id="l9.622"> </span>
<a href="#l9.623"></a><span id="l9.623">         if (mFilter &amp;&amp; NS_FAILED(mFilter(mResultHdr, mClosure))) {</span>
<a href="#l9.624"></a><span id="l9.624">           mResultHdr = nullptr;</span>
<a href="#l9.625"></a><span id="l9.625">           continue;</span>
<a href="#l9.626"></a><span id="l9.626">         }</span>
<a href="#l9.627"></a><span id="l9.627"> </span>
<a href="#l9.628"></a><span id="l9.628">         mResultHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l9.629"></a><span id="l9.629">         mResultHdr-&gt;GetMessageKey(&amp;curKey);</span>
<a href="#l9.630"></a><span id="l9.630">         // if the parent is the same as the msg we're enumerating over,</span>
<a href="#l9.631"></a><span id="l9.631">         // or the parentKey isn't set, and we're iterating over the top</span>
<a href="#l9.632"></a><span id="l9.632">         // level message in the thread, then leave mResultHdr set to cur msg.</span>
<a href="#l9.633"></a><span id="l9.633">         if (parentKey == mThreadParentKey ||</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineminus">-          (parentKey == nsMsgKey_None</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineminus">-          &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp; curKey != mThreadParentKey))</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineplus">+            (parentKey == nsMsgKey_None &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp;</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+             curKey != mThreadParentKey))</span>
<a href="#l9.638"></a><span id="l9.638">           break;</span>
<a href="#l9.639"></a><span id="l9.639">         mResultHdr = nullptr;</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-      }</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineminus">-      else</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineplus">+      } else</span>
<a href="#l9.643"></a><span id="l9.643">         NS_ASSERTION(false, &quot;better be able to get child&quot;);</span>
<a href="#l9.644"></a><span id="l9.644">     }</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineminus">-    if (!mResultHdr &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp; !mFoundChildren &amp;&amp; numChildren &gt; 1)</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-    {</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-//      mThread-&gt;ReparentMsgsWithInvalidParent(numChildren, mThreadParentKey);</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-    }</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineplus">+    // if (!mResultHdr &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp; !mFoundChildren &amp;&amp;</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineplus">+    //     numChildren &gt; 1) {</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+    //   mThread-&gt;ReparentMsgsWithInvalidParent(numChildren,  mThreadParentKey);</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+    // }</span>
<a href="#l9.653"></a><span id="l9.653">   }</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineminus">-  if (!mResultHdr)</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineminus">-  {</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineplus">+  if (!mResultHdr) {</span>
<a href="#l9.657"></a><span id="l9.657">     mDone = true;</span>
<a href="#l9.658"></a><span id="l9.658">     return NS_ERROR_FAILURE;</span>
<a href="#l9.659"></a><span id="l9.659">   }</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-  {</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l9.663"></a><span id="l9.663">     mDone = true;</span>
<a href="#l9.664"></a><span id="l9.664">     return rv;</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineminus">-  }</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-  else</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineplus">+  } else</span>
<a href="#l9.668"></a><span id="l9.668">     mNeedToPrefetch = false;</span>
<a href="#l9.669"></a><span id="l9.669">   mFoundChildren = true;</span>
<a href="#l9.670"></a><span id="l9.670"> </span>
<a href="#l9.671"></a><span id="l9.671"> #ifdef DEBUG_bienvenu1</span>
<a href="#l9.672"></a><span id="l9.672">   nsMsgKey debugMsgKey;</span>
<a href="#l9.673"></a><span id="l9.673">   mResultHdr-&gt;GetMessageKey(&amp;debugMsgKey);</span>
<a href="#l9.674"></a><span id="l9.674">   printf(&quot;next for %ld = %ld\n&quot;, mThreadParentKey, debugMsgKey);</span>
<a href="#l9.675"></a><span id="l9.675"> #endif</span>
<a href="#l9.676"></a><span id="l9.676"> </span>
<a href="#l9.677"></a><span id="l9.677">   return rv;</span>
<a href="#l9.678"></a><span id="l9.678"> }</span>
<a href="#l9.679"></a><span id="l9.679"> </span>
<a href="#l9.680"></a><span id="l9.680" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThreadEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineminus">-{</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThreadEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l9.683"></a><span id="l9.683">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineminus">-  if (mNeedToPrefetch)</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineminus">-    Prefetch();</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineplus">+  if (mNeedToPrefetch) Prefetch();</span>
<a href="#l9.687"></a><span id="l9.687">   *aResult = !mDone;</span>
<a href="#l9.688"></a><span id="l9.688">   return NS_OK;</span>
<a href="#l9.689"></a><span id="l9.689"> }</span>
<a href="#l9.690"></a><span id="l9.690"> </span>
<a href="#l9.691"></a><span id="l9.691" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::EnumerateMessages(nsMsgKey parentKey, nsISimpleEnumerator* *result)</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineminus">-{</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-  NS_ADDREF(*result = new nsMsgGroupThreadEnumerator(this, parentKey, nullptr, nullptr));</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::EnumerateMessages(</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineplus">+    nsMsgKey parentKey, nsISimpleEnumerator **result) {</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineplus">+  NS_ADDREF(*result = new nsMsgGroupThreadEnumerator(this, parentKey, nullptr,</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineplus">+                                                     nullptr));</span>
<a href="#l9.698"></a><span id="l9.698">   return NS_OK;</span>
<a href="#l9.699"></a><span id="l9.699"> }</span>
<a href="#l9.700"></a><span id="l9.700"> </span>
<a href="#l9.701"></a><span id="l9.701"> #if 0</span>
<a href="#l9.702"></a><span id="l9.702"> nsresult nsMsgGroupThread::ReparentMsgsWithInvalidParent(uint32_t numChildren, nsMsgKey threadParentKey)</span>
<a href="#l9.703"></a><span id="l9.703"> {</span>
<a href="#l9.704"></a><span id="l9.704">   nsresult ret = NS_OK;</span>
<a href="#l9.705"></a><span id="l9.705">   // run through looking for messages that don't have a correct parent,</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineat">@@ -585,252 +517,220 @@ nsresult nsMsgGroupThread::ReparentMsgsW</span>
<a href="#l9.707"></a><span id="l9.707">           curChild-&gt;SetThreadParent(threadParentKey);</span>
<a href="#l9.708"></a><span id="l9.708">       }</span>
<a href="#l9.709"></a><span id="l9.709">     }</span>
<a href="#l9.710"></a><span id="l9.710">   }</span>
<a href="#l9.711"></a><span id="l9.711">   return ret;</span>
<a href="#l9.712"></a><span id="l9.712"> }</span>
<a href="#l9.713"></a><span id="l9.713"> #endif</span>
<a href="#l9.714"></a><span id="l9.714"> </span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetRootHdr(int32_t *resultIndex, nsIMsgDBHdr **result)</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineminus">-{</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetRootHdr(int32_t *resultIndex,</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+                                           nsIMsgDBHdr **result) {</span>
<a href="#l9.719"></a><span id="l9.719">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l9.720"></a><span id="l9.720"> </span>
<a href="#l9.721"></a><span id="l9.721">   *result = nullptr;</span>
<a href="#l9.722"></a><span id="l9.722"> </span>
<a href="#l9.723"></a><span id="l9.723" class="difflineminus">-  if (m_threadRootKey != nsMsgKey_None)</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineminus">-  {</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineplus">+  if (m_threadRootKey != nsMsgKey_None) {</span>
<a href="#l9.726"></a><span id="l9.726">     nsresult ret = GetChildHdrForKey(m_threadRootKey, result, resultIndex);</span>
<a href="#l9.727"></a><span id="l9.727">     if (NS_SUCCEEDED(ret) &amp;&amp; *result)</span>
<a href="#l9.728"></a><span id="l9.728">       return ret;</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineminus">-    else</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineminus">-    {</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+    else {</span>
<a href="#l9.732"></a><span id="l9.732">       printf(&quot;need to reset thread root key\n&quot;);</span>
<a href="#l9.733"></a><span id="l9.733">       uint32_t numChildren;</span>
<a href="#l9.734"></a><span id="l9.734">       nsMsgKey threadParentKey = nsMsgKey_None;</span>
<a href="#l9.735"></a><span id="l9.735">       GetNumChildren(&amp;numChildren);</span>
<a href="#l9.736"></a><span id="l9.736"> </span>
<a href="#l9.737"></a><span id="l9.737" class="difflineminus">-      for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineminus">-      {</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineplus">+      for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l9.740"></a><span id="l9.740">         nsCOMPtr&lt;nsIMsgDBHdr&gt; curChild;</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineminus">-        ret  = GetChildHdrAt(childIndex, getter_AddRefs(curChild));</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineminus">-        if (NS_SUCCEEDED(ret) &amp;&amp; curChild)</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineminus">-        {</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineplus">+        ret = GetChildHdrAt(childIndex, getter_AddRefs(curChild));</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+        if (NS_SUCCEEDED(ret) &amp;&amp; curChild) {</span>
<a href="#l9.746"></a><span id="l9.746">           nsMsgKey parentKey;</span>
<a href="#l9.747"></a><span id="l9.747"> </span>
<a href="#l9.748"></a><span id="l9.748">           curChild-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-          if (parentKey == nsMsgKey_None)</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineminus">-          {</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineplus">+          if (parentKey == nsMsgKey_None) {</span>
<a href="#l9.752"></a><span id="l9.752">             NS_ASSERTION(!(*result), &quot;two top level msgs, not good&quot;);</span>
<a href="#l9.753"></a><span id="l9.753">             curChild-&gt;GetMessageKey(&amp;threadParentKey);</span>
<a href="#l9.754"></a><span id="l9.754">             m_threadRootKey = threadParentKey;</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineminus">-            if (resultIndex)</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineminus">-              *resultIndex = childIndex;</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+            if (resultIndex) *resultIndex = childIndex;</span>
<a href="#l9.758"></a><span id="l9.758">             curChild.forget(result);</span>
<a href="#l9.759"></a><span id="l9.759">           }</span>
<a href="#l9.760"></a><span id="l9.760">         }</span>
<a href="#l9.761"></a><span id="l9.761">       }</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineminus">-      if (*result)</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineminus">-      {</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineplus">+      if (*result) {</span>
<a href="#l9.765"></a><span id="l9.765">         return NS_OK;</span>
<a href="#l9.766"></a><span id="l9.766">       }</span>
<a href="#l9.767"></a><span id="l9.767">     }</span>
<a href="#l9.768"></a><span id="l9.768">     // if we can't get the thread root key, we'll just get the first hdr.</span>
<a href="#l9.769"></a><span id="l9.769">     // there's a bug where sometimes we weren't resetting the thread root key</span>
<a href="#l9.770"></a><span id="l9.770">     // when removing the thread root key.</span>
<a href="#l9.771"></a><span id="l9.771">   }</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-  if (resultIndex)</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineminus">-    *resultIndex = 0;</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+  if (resultIndex) *resultIndex = 0;</span>
<a href="#l9.775"></a><span id="l9.775">   return GetChildHdrAt(0, result);</span>
<a href="#l9.776"></a><span id="l9.776"> }</span>
<a href="#l9.777"></a><span id="l9.777"> </span>
<a href="#l9.778"></a><span id="l9.778" class="difflineminus">-nsresult nsMsgGroupThread::ChangeUnreadChildCount(int32_t delta)</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineminus">-{</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineplus">+nsresult nsMsgGroupThread::ChangeUnreadChildCount(int32_t delta) {</span>
<a href="#l9.781"></a><span id="l9.781">   m_numUnreadChildren += delta;</span>
<a href="#l9.782"></a><span id="l9.782">   return NS_OK;</span>
<a href="#l9.783"></a><span id="l9.783"> }</span>
<a href="#l9.784"></a><span id="l9.784"> </span>
<a href="#l9.785"></a><span id="l9.785" class="difflineminus">-nsresult nsMsgGroupThread::GetChildHdrForKey(nsMsgKey desiredKey, nsIMsgDBHdr **result, int32_t *resultIndex)</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineminus">-{</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineplus">+nsresult nsMsgGroupThread::GetChildHdrForKey(nsMsgKey desiredKey,</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineplus">+                                             nsIMsgDBHdr **result,</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineplus">+                                             int32_t *resultIndex) {</span>
<a href="#l9.790"></a><span id="l9.790">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l9.791"></a><span id="l9.791"> </span>
<a href="#l9.792"></a><span id="l9.792" class="difflineminus">-  nsresult rv = NS_OK;        // XXX or should this default to an error?</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+  nsresult rv = NS_OK;  // XXX or should this default to an error?</span>
<a href="#l9.794"></a><span id="l9.794">   uint32_t numChildren = 0;</span>
<a href="#l9.795"></a><span id="l9.795">   GetNumChildren(&amp;numChildren);</span>
<a href="#l9.796"></a><span id="l9.796"> </span>
<a href="#l9.797"></a><span id="l9.797">   uint32_t childIndex;</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineminus">-  for (childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineminus">-  {</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineplus">+  for (childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l9.801"></a><span id="l9.801">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l9.802"></a><span id="l9.802">     rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineminus">-    {</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l9.806"></a><span id="l9.806">       nsMsgKey msgKey;</span>
<a href="#l9.807"></a><span id="l9.807">       // we're only doing one level of threading, so check if caller is</span>
<a href="#l9.808"></a><span id="l9.808">       // asking for children of the first message in the thread or not.</span>
<a href="#l9.809"></a><span id="l9.809">       // if not, we will tell him there are no children.</span>
<a href="#l9.810"></a><span id="l9.810">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.811"></a><span id="l9.811"> </span>
<a href="#l9.812"></a><span id="l9.812">       if (msgKey == desiredKey) {</span>
<a href="#l9.813"></a><span id="l9.813">         child.forget(result);</span>
<a href="#l9.814"></a><span id="l9.814">         break;</span>
<a href="#l9.815"></a><span id="l9.815">       }</span>
<a href="#l9.816"></a><span id="l9.816">     }</span>
<a href="#l9.817"></a><span id="l9.817">   }</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineminus">-  if (resultIndex)</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineminus">-    *resultIndex = (int32_t) childIndex;</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineplus">+  if (resultIndex) *resultIndex = (int32_t)childIndex;</span>
<a href="#l9.821"></a><span id="l9.821"> </span>
<a href="#l9.822"></a><span id="l9.822">   return rv;</span>
<a href="#l9.823"></a><span id="l9.823"> }</span>
<a href="#l9.824"></a><span id="l9.824"> </span>
<a href="#l9.825"></a><span id="l9.825" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetFirstUnreadChild(nsIMsgDBHdr **result)</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineminus">-{</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetFirstUnreadChild(nsIMsgDBHdr **result) {</span>
<a href="#l9.828"></a><span id="l9.828">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l9.829"></a><span id="l9.829"> </span>
<a href="#l9.830"></a><span id="l9.830">   nsresult rv = NS_OK;</span>
<a href="#l9.831"></a><span id="l9.831"> </span>
<a href="#l9.832"></a><span id="l9.832">   uint32_t numChildren = 0;</span>
<a href="#l9.833"></a><span id="l9.833">   GetNumChildren(&amp;numChildren);</span>
<a href="#l9.834"></a><span id="l9.834"> </span>
<a href="#l9.835"></a><span id="l9.835" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineminus">-  {</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l9.838"></a><span id="l9.838">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l9.839"></a><span id="l9.839">     rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineminus">-    {</span>
<a href="#l9.842"></a><span id="l9.842" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l9.843"></a><span id="l9.843">       nsMsgKey msgKey;</span>
<a href="#l9.844"></a><span id="l9.844">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.845"></a><span id="l9.845"> </span>
<a href="#l9.846"></a><span id="l9.846">       bool isRead;</span>
<a href="#l9.847"></a><span id="l9.847">       rv = m_db-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !isRead)</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineminus">-      {</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !isRead) {</span>
<a href="#l9.851"></a><span id="l9.851">         child.forget(result);</span>
<a href="#l9.852"></a><span id="l9.852">         break;</span>
<a href="#l9.853"></a><span id="l9.853">       }</span>
<a href="#l9.854"></a><span id="l9.854">     }</span>
<a href="#l9.855"></a><span id="l9.855">   }</span>
<a href="#l9.856"></a><span id="l9.856"> </span>
<a href="#l9.857"></a><span id="l9.857">   return rv;</span>
<a href="#l9.858"></a><span id="l9.858"> }</span>
<a href="#l9.859"></a><span id="l9.859"> </span>
<a href="#l9.860"></a><span id="l9.860" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::GetNewestMsgDate(uint32_t *aResult)</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineminus">-{</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::GetNewestMsgDate(uint32_t *aResult) {</span>
<a href="#l9.863"></a><span id="l9.863">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.864"></a><span id="l9.864"> </span>
<a href="#l9.865"></a><span id="l9.865" class="difflineminus">-  // if this hasn't been set, figure it out by enumerating the msgs in the thread.</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineminus">-  if (!m_newestMsgDate)</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineminus">-  {</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineplus">+  // if this hasn't been set, figure it out by enumerating the msgs in the</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineplus">+  // thread.</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+  if (!m_newestMsgDate) {</span>
<a href="#l9.871"></a><span id="l9.871">     nsresult rv = NS_OK;</span>
<a href="#l9.872"></a><span id="l9.872"> </span>
<a href="#l9.873"></a><span id="l9.873">     uint32_t numChildren = 0;</span>
<a href="#l9.874"></a><span id="l9.874">     GetNumChildren(&amp;numChildren);</span>
<a href="#l9.875"></a><span id="l9.875"> </span>
<a href="#l9.876"></a><span id="l9.876" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineminus">-    {</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l9.879"></a><span id="l9.879">       nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l9.880"></a><span id="l9.880">       rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineminus">-      {</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l9.884"></a><span id="l9.884">         uint32_t msgDate;</span>
<a href="#l9.885"></a><span id="l9.885">         child-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineminus">-        if (msgDate &gt; m_newestMsgDate)</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineminus">-          m_newestMsgDate = msgDate;</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+        if (msgDate &gt; m_newestMsgDate) m_newestMsgDate = msgDate;</span>
<a href="#l9.889"></a><span id="l9.889">       }</span>
<a href="#l9.890"></a><span id="l9.890">     }</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineminus">-</span>
<a href="#l9.892"></a><span id="l9.892">   }</span>
<a href="#l9.893"></a><span id="l9.893">   *aResult = m_newestMsgDate;</span>
<a href="#l9.894"></a><span id="l9.894">   return NS_OK;</span>
<a href="#l9.895"></a><span id="l9.895"> }</span>
<a href="#l9.896"></a><span id="l9.896"> </span>
<a href="#l9.897"></a><span id="l9.897" class="difflineminus">-</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineminus">-NS_IMETHODIMP nsMsgGroupThread::SetNewestMsgDate(uint32_t aNewestMsgDate)</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineminus">-{</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineplus">+NS_IMETHODIMP nsMsgGroupThread::SetNewestMsgDate(uint32_t aNewestMsgDate) {</span>
<a href="#l9.901"></a><span id="l9.901">   m_newestMsgDate = aNewestMsgDate;</span>
<a href="#l9.902"></a><span id="l9.902">   return NS_OK;</span>
<a href="#l9.903"></a><span id="l9.903"> }</span>
<a href="#l9.904"></a><span id="l9.904"> </span>
<a href="#l9.905"></a><span id="l9.905" class="difflineminus">-nsMsgXFGroupThread::nsMsgXFGroupThread()</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineminus">-{</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineminus">-}</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineplus">+nsMsgXFGroupThread::nsMsgXFGroupThread() {}</span>
<a href="#l9.909"></a><span id="l9.909"> </span>
<a href="#l9.910"></a><span id="l9.910" class="difflineminus">-nsMsgXFGroupThread::~nsMsgXFGroupThread()</span>
<a href="#l9.911"></a><span id="l9.911" class="difflineminus">-{</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineminus">-}</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+nsMsgXFGroupThread::~nsMsgXFGroupThread() {}</span>
<a href="#l9.914"></a><span id="l9.914"> </span>
<a href="#l9.915"></a><span id="l9.915" class="difflineminus">-NS_IMETHODIMP nsMsgXFGroupThread::GetNumChildren(uint32_t *aNumChildren)</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineminus">-{</span>
<a href="#l9.917"></a><span id="l9.917" class="difflineplus">+NS_IMETHODIMP nsMsgXFGroupThread::GetNumChildren(uint32_t *aNumChildren) {</span>
<a href="#l9.918"></a><span id="l9.918">   NS_ENSURE_ARG_POINTER(aNumChildren);</span>
<a href="#l9.919"></a><span id="l9.919">   *aNumChildren = m_folders.Length();</span>
<a href="#l9.920"></a><span id="l9.920">   return NS_OK;</span>
<a href="#l9.921"></a><span id="l9.921"> }</span>
<a href="#l9.922"></a><span id="l9.922"> </span>
<a href="#l9.923"></a><span id="l9.923" class="difflineminus">-NS_IMETHODIMP nsMsgXFGroupThread::GetChildHdrAt(uint32_t aIndex, nsIMsgDBHdr **aResult)</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineminus">-{</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineminus">-  if (aIndex &gt;= m_folders.Length())</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+NS_IMETHODIMP nsMsgXFGroupThread::GetChildHdrAt(uint32_t aIndex,</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineplus">+                                                nsIMsgDBHdr **aResult) {</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+  if (aIndex &gt;= m_folders.Length()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l9.930"></a><span id="l9.930">   return m_folders.ObjectAt(aIndex)-&gt;GetMessageHeader(m_keys[aIndex], aResult);</span>
<a href="#l9.931"></a><span id="l9.931"> }</span>
<a href="#l9.932"></a><span id="l9.932"> </span>
<a href="#l9.933"></a><span id="l9.933" class="difflineminus">-NS_IMETHODIMP nsMsgXFGroupThread::GetChildKeyAt(uint32_t aIndex, nsMsgKey *aResult)</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineminus">-{</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineplus">+NS_IMETHODIMP nsMsgXFGroupThread::GetChildKeyAt(uint32_t aIndex,</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineplus">+                                                nsMsgKey *aResult) {</span>
<a href="#l9.937"></a><span id="l9.937">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l9.938"></a><span id="l9.938">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.939"></a><span id="l9.939"> }</span>
<a href="#l9.940"></a><span id="l9.940"> </span>
<a href="#l9.941"></a><span id="l9.941" class="difflineminus">-NS_IMETHODIMP nsMsgXFGroupThread::RemoveChildAt(uint32_t aIndex)</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineminus">-{</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+NS_IMETHODIMP nsMsgXFGroupThread::RemoveChildAt(uint32_t aIndex) {</span>
<a href="#l9.944"></a><span id="l9.944">   NS_ENSURE_TRUE(aIndex &lt; m_folders.Length(), NS_MSG_MESSAGE_NOT_FOUND);</span>
<a href="#l9.945"></a><span id="l9.945"> </span>
<a href="#l9.946"></a><span id="l9.946">   nsresult rv = nsMsgGroupThread::RemoveChildAt(aIndex);</span>
<a href="#l9.947"></a><span id="l9.947">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.948"></a><span id="l9.948">   m_folders.RemoveElementAt(aIndex);</span>
<a href="#l9.949"></a><span id="l9.949">   return NS_OK;</span>
<a href="#l9.950"></a><span id="l9.950"> }</span>
<a href="#l9.951"></a><span id="l9.951"> </span>
<a href="#l9.952"></a><span id="l9.952" class="difflineminus">-void nsMsgXFGroupThread::InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr)</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineminus">-{</span>
<a href="#l9.954"></a><span id="l9.954" class="difflineplus">+void nsMsgXFGroupThread::InsertMsgHdrAt(nsMsgViewIndex index,</span>
<a href="#l9.955"></a><span id="l9.955" class="difflineplus">+                                        nsIMsgDBHdr *hdr) {</span>
<a href="#l9.956"></a><span id="l9.956">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.957"></a><span id="l9.957">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l9.958"></a><span id="l9.958">   m_folders.InsertObjectAt(folder, index);</span>
<a href="#l9.959"></a><span id="l9.959">   nsMsgGroupThread::InsertMsgHdrAt(index, hdr);</span>
<a href="#l9.960"></a><span id="l9.960"> }</span>
<a href="#l9.961"></a><span id="l9.961"> </span>
<a href="#l9.962"></a><span id="l9.962" class="difflineminus">-void nsMsgXFGroupThread::SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr)</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineminus">-{</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineplus">+void nsMsgXFGroupThread::SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr) {</span>
<a href="#l9.965"></a><span id="l9.965">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.966"></a><span id="l9.966">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l9.967"></a><span id="l9.967">   m_folders.ReplaceObjectAt(folder, index);</span>
<a href="#l9.968"></a><span id="l9.968">   nsMsgGroupThread::SetMsgHdrAt(index, hdr);</span>
<a href="#l9.969"></a><span id="l9.969"> }</span>
<a href="#l9.970"></a><span id="l9.970"> </span>
<a href="#l9.971"></a><span id="l9.971" class="difflineminus">-nsMsgViewIndex nsMsgXFGroupThread::FindMsgHdr(nsIMsgDBHdr *hdr)</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineminus">-{</span>
<a href="#l9.973"></a><span id="l9.973" class="difflineplus">+nsMsgViewIndex nsMsgXFGroupThread::FindMsgHdr(nsIMsgDBHdr *hdr) {</span>
<a href="#l9.974"></a><span id="l9.974">   nsMsgKey msgKey;</span>
<a href="#l9.975"></a><span id="l9.975">   hdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.976"></a><span id="l9.976">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.977"></a><span id="l9.977">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l9.978"></a><span id="l9.978">   size_t index = 0;</span>
<a href="#l9.979"></a><span id="l9.979">   while (true) {</span>
<a href="#l9.980"></a><span id="l9.980">     index = m_keys.IndexOf(msgKey, index);</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineminus">-    if (index == m_keys.NoIndex || m_folders[index] == folder)</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineminus">-      break;</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineplus">+    if (index == m_keys.NoIndex || m_folders[index] == folder) break;</span>
<a href="#l9.984"></a><span id="l9.984">     index++;</span>
<a href="#l9.985"></a><span id="l9.985">   }</span>
<a href="#l9.986"></a><span id="l9.986">   return (nsMsgViewIndex)index;</span>
<a href="#l9.987"></a><span id="l9.987"> }</span>
<a href="#l9.988"></a><span id="l9.988"> </span>
<a href="#l9.989"></a><span id="l9.989" class="difflineminus">-nsMsgViewIndex nsMsgXFGroupThread::AddMsgHdrInDateOrder(nsIMsgDBHdr *child, nsMsgDBView *view)</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineminus">-{</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineminus">-  nsMsgViewIndex insertIndex = nsMsgGroupThread::AddMsgHdrInDateOrder(child, view);</span>
<a href="#l9.992"></a><span id="l9.992" class="difflineplus">+nsMsgViewIndex nsMsgXFGroupThread::AddMsgHdrInDateOrder(nsIMsgDBHdr *child,</span>
<a href="#l9.993"></a><span id="l9.993" class="difflineplus">+                                                        nsMsgDBView *view) {</span>
<a href="#l9.994"></a><span id="l9.994" class="difflineplus">+  nsMsgViewIndex insertIndex =</span>
<a href="#l9.995"></a><span id="l9.995" class="difflineplus">+      nsMsgGroupThread::AddMsgHdrInDateOrder(child, view);</span>
<a href="#l9.996"></a><span id="l9.996">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.997"></a><span id="l9.997">   child-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l9.998"></a><span id="l9.998">   m_folders.InsertObjectAt(folder, insertIndex);</span>
<a href="#l9.999"></a><span id="l9.999">   return insertIndex;</span>
<a href="#l9.1000"></a><span id="l9.1000"> }</span>
<a href="#l9.1001"></a><span id="l9.1001" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l9.1002"></a><span id="l9.1002" class="difflineminus">-nsMsgXFGroupThread::GetInsertIndexFromView(nsMsgDBView *view,</span>
<a href="#l9.1003"></a><span id="l9.1003" class="difflineminus">-                                           nsIMsgDBHdr *child,</span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineminus">-                                           nsMsgViewSortOrderValue threadSortOrder)</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineminus">-{</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineminus">-  return view-&gt;GetInsertIndexHelper(child, m_keys, &amp;m_folders, threadSortOrder, nsMsgViewSortType::byDate);</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineplus">+nsMsgViewIndex nsMsgXFGroupThread::GetInsertIndexFromView(</span>
<a href="#l9.1008"></a><span id="l9.1008" class="difflineplus">+    nsMsgDBView *view, nsIMsgDBHdr *child,</span>
<a href="#l9.1009"></a><span id="l9.1009" class="difflineplus">+    nsMsgViewSortOrderValue threadSortOrder) {</span>
<a href="#l9.1010"></a><span id="l9.1010" class="difflineplus">+  return view-&gt;GetInsertIndexHelper(child, m_keys, &amp;m_folders, threadSortOrder,</span>
<a href="#l9.1011"></a><span id="l9.1011" class="difflineplus">+                                    nsMsgViewSortType::byDate);</span>
<a href="#l9.1012"></a><span id="l9.1012"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupThread.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupThread.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -10,78 +10,79 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsMsgDBView.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> class nsMsgGroupView;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-class nsMsgGroupThread : public nsIMsgThread</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-public:</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+class nsMsgGroupThread : public nsIMsgThread {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ public:</span>
<a href="#l10.17"></a><span id="l10.17">   friend class nsMsgGroupView;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">   nsMsgGroupThread();</span>
<a href="#l10.20"></a><span id="l10.20">   explicit nsMsgGroupThread(nsIMsgDatabase *db);</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22">   NS_DECL_NSIMSGTHREAD</span>
<a href="#l10.23"></a><span id="l10.23">   NS_DECL_ISUPPORTS</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-protected:</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ protected:</span>
<a href="#l10.27"></a><span id="l10.27">   virtual ~nsMsgGroupThread();</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  void      Init();</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  void Init();</span>
<a href="#l10.31"></a><span id="l10.31">   nsMsgViewIndex AddChildFromGroupView(nsIMsgDBHdr *child, nsMsgDBView *view);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  nsresult  RemoveChild(nsMsgKey msgKey);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  nsresult  RerootThread(nsIMsgDBHdr *newParentOfOldRoot, nsIMsgDBHdr *oldRoot, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  nsresult RemoveChild(nsMsgKey msgKey);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  nsresult RerootThread(nsIMsgDBHdr *newParentOfOldRoot, nsIMsgDBHdr *oldRoot,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+                        nsIDBChangeAnnouncer *announcer);</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  virtual nsMsgViewIndex AddMsgHdrInDateOrder(nsIMsgDBHdr *child, nsMsgDBView *view);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  virtual nsMsgViewIndex GetInsertIndexFromView(nsMsgDBView *view,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-                                          nsIMsgDBHdr *child,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-                                          nsMsgViewSortOrderValue threadSortOrder);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-  nsresult ReparentNonReferenceChildrenOf(nsIMsgDBHdr *topLevelHdr, nsMsgKey newParentKey,</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-                                                            nsIDBChangeAnnouncer *announcer);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  virtual nsMsgViewIndex AddMsgHdrInDateOrder(nsIMsgDBHdr *child,</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+                                              nsMsgDBView *view);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  virtual nsMsgViewIndex GetInsertIndexFromView(</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+      nsMsgDBView *view, nsIMsgDBHdr *child,</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+      nsMsgViewSortOrderValue threadSortOrder);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  nsresult ReparentNonReferenceChildrenOf(nsIMsgDBHdr *topLevelHdr,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+                                          nsMsgKey newParentKey,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+                                          nsIDBChangeAnnouncer *announcer);</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  nsresult ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  nsresult ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+                              nsIDBChangeAnnouncer *announcer);</span>
<a href="#l10.56"></a><span id="l10.56">   nsresult ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  nsresult GetChildHdrForKey(nsMsgKey desiredKey, nsIMsgDBHdr **result, int32_t *resultIndex);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  nsresult GetChildHdrForKey(nsMsgKey desiredKey, nsIMsgDBHdr **result,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+                             int32_t *resultIndex);</span>
<a href="#l10.60"></a><span id="l10.60">   uint32_t NumRealChildren();</span>
<a href="#l10.61"></a><span id="l10.61">   virtual void InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr);</span>
<a href="#l10.62"></a><span id="l10.62">   virtual void SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr);</span>
<a href="#l10.63"></a><span id="l10.63">   virtual nsMsgViewIndex FindMsgHdr(nsIMsgDBHdr *hdr);</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  nsMsgKey        m_threadKey;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  uint32_t        m_numUnreadChildren;</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-  uint32_t        m_flags;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  nsMsgKey        m_threadRootKey;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  uint32_t        m_newestMsgDate;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+  nsMsgKey m_threadKey;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  uint32_t m_numUnreadChildren;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  uint32_t m_flags;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  nsMsgKey m_threadRootKey;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  uint32_t m_newestMsgDate;</span>
<a href="#l10.75"></a><span id="l10.75">   nsTArray&lt;nsMsgKey&gt; m_keys;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  bool            m_dummy; // top level msg is a dummy, e.g., grouped by age.</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; m_db; // should we make a weak ref or just a ptr?</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  bool m_dummy;  // top level msg is a dummy, e.g., grouped by age.</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;  // should we make a weak ref or just a ptr?</span>
<a href="#l10.80"></a><span id="l10.80"> };</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-class nsMsgXFGroupThread : public nsMsgGroupThread</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-{</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-public:</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+class nsMsgXFGroupThread : public nsMsgGroupThread {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+ public:</span>
<a href="#l10.87"></a><span id="l10.87">   nsMsgXFGroupThread();</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89">   NS_IMETHOD GetNumChildren(uint32_t *aNumChildren) override;</span>
<a href="#l10.90"></a><span id="l10.90">   NS_IMETHOD GetChildKeyAt(uint32_t aIndex, nsMsgKey *aResult) override;</span>
<a href="#l10.91"></a><span id="l10.91">   NS_IMETHOD GetChildHdrAt(uint32_t aIndex, nsIMsgDBHdr **aResult) override;</span>
<a href="#l10.92"></a><span id="l10.92">   NS_IMETHOD RemoveChildAt(uint32_t aIndex) override;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-protected:</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+ protected:</span>
<a href="#l10.96"></a><span id="l10.96">   virtual ~nsMsgXFGroupThread();</span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-  virtual void InsertMsgHdrAt(nsMsgViewIndex index,</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-                              nsIMsgDBHdr *hdr) override;</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+  virtual void InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr) override;</span>
<a href="#l10.101"></a><span id="l10.101">   virtual void SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr) override;</span>
<a href="#l10.102"></a><span id="l10.102">   virtual nsMsgViewIndex FindMsgHdr(nsIMsgDBHdr *hdr) override;</span>
<a href="#l10.103"></a><span id="l10.103">   virtual nsMsgViewIndex AddMsgHdrInDateOrder(nsIMsgDBHdr *child,</span>
<a href="#l10.104"></a><span id="l10.104">                                               nsMsgDBView *view) override;</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-  virtual nsMsgViewIndex GetInsertIndexFromView(nsMsgDBView *view,</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-                                          nsIMsgDBHdr *child,</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-                                          nsMsgViewSortOrderValue threadSortOrder</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-                                                ) override;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+  virtual nsMsgViewIndex GetInsertIndexFromView(</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+      nsMsgDBView *view, nsIMsgDBHdr *child,</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+      nsMsgViewSortOrderValue threadSortOrder) override;</span>
<a href="#l10.112"></a><span id="l10.112"> </span>
<a href="#l10.113"></a><span id="l10.113">   nsCOMArray&lt;nsIMsgFolder&gt; m_folders;</span>
<a href="#l10.114"></a><span id="l10.114"> };</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -12,117 +12,97 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsMsgGroupThread.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsTreeColumns.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &lt;plhash.h&gt;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> // Allocate this more to avoid reallocation on new mail.</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#define MSGHDR_CACHE_LOOK_AHEAD_SIZE  25</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#define MSGHDR_CACHE_LOOK_AHEAD_SIZE 25</span>
<a href="#l11.14"></a><span id="l11.14"> // Max msghdr cache entries.</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#define MSGHDR_CACHE_MAX_SIZE         8192</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-#define MSGHDR_CACHE_DEFAULT_SIZE     100</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+#define MSGHDR_CACHE_MAX_SIZE 8192</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+#define MSGHDR_CACHE_DEFAULT_SIZE 100</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-nsMsgGroupView::nsMsgGroupView()</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-{</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+nsMsgGroupView::nsMsgGroupView() {</span>
<a href="#l11.23"></a><span id="l11.23">   m_dayChanged = false;</span>
<a href="#l11.24"></a><span id="l11.24">   m_lastCurExplodedTime.tm_mday = 0;</span>
<a href="#l11.25"></a><span id="l11.25"> }</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-nsMsgGroupView::~nsMsgGroupView()</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-{</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-}</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+nsMsgGroupView::~nsMsgGroupView() {}</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32"> NS_IMETHODIMP</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-nsMsgGroupView::Open(nsIMsgFolder *aFolder,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-                     nsMsgViewSortTypeValue aSortType,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+nsMsgGroupView::Open(nsIMsgFolder *aFolder, nsMsgViewSortTypeValue aSortType,</span>
<a href="#l11.36"></a><span id="l11.36">                      nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-                     nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-                     int32_t *aCount)</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-{</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-  nsresult rv = nsMsgDBView::Open(aFolder, aSortType, aSortOrder, aViewFlags, aCount);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+                     nsMsgViewFlagsTypeValue aViewFlags, int32_t *aCount) {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  nsresult rv =</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      nsMsgDBView::Open(aFolder, aSortType, aSortOrder, aViewFlags, aCount);</span>
<a href="#l11.44"></a><span id="l11.44">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l11.48"></a><span id="l11.48">   PersistFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; headers;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; headers;</span>
<a href="#l11.52"></a><span id="l11.52">   rv = m_db-&gt;EnumerateMessages(getter_AddRefs(headers));</span>
<a href="#l11.53"></a><span id="l11.53">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55">   return OpenWithHdrs(headers, aSortType, aSortOrder, aViewFlags, aCount);</span>
<a href="#l11.56"></a><span id="l11.56"> }</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-void nsMsgGroupView::InternalClose()</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-{</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+void nsMsgGroupView::InternalClose() {</span>
<a href="#l11.61"></a><span id="l11.61">   m_groupsTable.Clear();</span>
<a href="#l11.62"></a><span id="l11.62">   // Nothing to do if we're not grouped.</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-    return;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)) return;</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67">   bool rcvDate = false;</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-  if (m_sortType == nsMsgViewSortType::byReceived)</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    rcvDate = true;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  if (m_sortType == nsMsgViewSortType::byReceived) rcvDate = true;</span>
<a href="#l11.72"></a><span id="l11.72"> </span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  if (m_db &amp;&amp;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-      ((m_sortType == nsMsgViewSortType::byDate) ||</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-       (m_sortType == nsMsgViewSortType::byReceived)))</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-  {</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  if (m_db &amp;&amp; ((m_sortType == nsMsgViewSortType::byDate) ||</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+               (m_sortType == nsMsgViewSortType::byReceived))) {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l11.81"></a><span id="l11.81">     m_db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-    if (dbFolderInfo)</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-    {</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+    if (dbFolderInfo) {</span>
<a href="#l11.85"></a><span id="l11.85">       uint32_t expandFlags = 0;</span>
<a href="#l11.86"></a><span id="l11.86">       uint32_t num = GetSize();</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-      for (uint32_t i = 0; i &lt; num; i++)</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-      {</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+      for (uint32_t i = 0; i &lt; num; i++) {</span>
<a href="#l11.91"></a><span id="l11.91">         if (m_flags[i] &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-            !(m_flags[i] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-        {</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+            !(m_flags[i] &amp; nsMsgMessageFlags::Elided)) {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.97"></a><span id="l11.97">           GetMsgHdrForViewIndex(i, getter_AddRefs(msgHdr));</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-          if (msgHdr)</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-          {</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+          if (msgHdr) {</span>
<a href="#l11.101"></a><span id="l11.101">             uint32_t ageBucket;</span>
<a href="#l11.102"></a><span id="l11.102">             nsresult rv = GetAgeBucketValue(msgHdr, &amp;ageBucket, rcvDate);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-              expandFlags |=  1 &lt;&lt; ageBucket;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+            if (NS_SUCCEEDED(rv)) expandFlags |= 1 &lt;&lt; ageBucket;</span>
<a href="#l11.106"></a><span id="l11.106">           }</span>
<a href="#l11.107"></a><span id="l11.107">         }</span>
<a href="#l11.108"></a><span id="l11.108">       }</span>
<a href="#l11.109"></a><span id="l11.109">       dbFolderInfo-&gt;SetUint32Property(&quot;dateGroupFlags&quot;, expandFlags);</span>
<a href="#l11.110"></a><span id="l11.110">     }</span>
<a href="#l11.111"></a><span id="l11.111">   }</span>
<a href="#l11.112"></a><span id="l11.112"> }</span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114"> NS_IMETHODIMP</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-nsMsgGroupView::Close()</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-{</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+nsMsgGroupView::Close() {</span>
<a href="#l11.118"></a><span id="l11.118">   InternalClose();</span>
<a href="#l11.119"></a><span id="l11.119">   return nsMsgDBView::Close();</span>
<a href="#l11.120"></a><span id="l11.120"> }</span>
<a href="#l11.121"></a><span id="l11.121"> </span>
<a href="#l11.122"></a><span id="l11.122"> // Set rcvDate to true to get the Received: date instead of the Date: date.</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-nsresult</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-nsMsgGroupView::GetAgeBucketValue(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-                                  uint32_t * aAgeBucket,</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-                                  bool rcvDate)</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-{</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+nsresult nsMsgGroupView::GetAgeBucketValue(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+                                           uint32_t *aAgeBucket, bool rcvDate) {</span>
<a href="#l11.130"></a><span id="l11.130">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l11.131"></a><span id="l11.131">   NS_ENSURE_ARG_POINTER(aAgeBucket);</span>
<a href="#l11.132"></a><span id="l11.132"> </span>
<a href="#l11.133"></a><span id="l11.133">   PRTime dateOfMsg;</span>
<a href="#l11.134"></a><span id="l11.134">   nsresult rv;</span>
<a href="#l11.135"></a><span id="l11.135">   if (!rcvDate)</span>
<a href="#l11.136"></a><span id="l11.136">     rv = aMsgHdr-&gt;GetDate(&amp;dateOfMsg);</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-  else</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  else {</span>
<a href="#l11.140"></a><span id="l11.140">     uint32_t rcvDateSecs;</span>
<a href="#l11.141"></a><span id="l11.141">     rv = aMsgHdr-&gt;GetUint32Property(&quot;dateReceived&quot;, &amp;rcvDateSecs);</span>
<a href="#l11.142"></a><span id="l11.142">     Seconds2PRTime(rcvDateSecs, &amp;dateOfMsg);</span>
<a href="#l11.143"></a><span id="l11.143">   }</span>
<a href="#l11.144"></a><span id="l11.144">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.145"></a><span id="l11.145"> </span>
<a href="#l11.146"></a><span id="l11.146">   PRTime currentTime = PR_Now();</span>
<a href="#l11.147"></a><span id="l11.147">   PRExplodedTime currentExplodedTime;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineat">@@ -133,24 +113,22 @@ nsMsgGroupView::GetAgeBucketValue(nsIMsg</span>
<a href="#l11.149"></a><span id="l11.149">   if (m_lastCurExplodedTime.tm_mday &amp;&amp;</span>
<a href="#l11.150"></a><span id="l11.150">       m_lastCurExplodedTime.tm_mday != currentExplodedTime.tm_mday)</span>
<a href="#l11.151"></a><span id="l11.151">     // This will cause us to rebuild the view.</span>
<a href="#l11.152"></a><span id="l11.152">     m_dayChanged = true;</span>
<a href="#l11.153"></a><span id="l11.153"> </span>
<a href="#l11.154"></a><span id="l11.154">   m_lastCurExplodedTime = currentExplodedTime;</span>
<a href="#l11.155"></a><span id="l11.155">   if (currentExplodedTime.tm_year == explodedMsgTime.tm_year &amp;&amp;</span>
<a href="#l11.156"></a><span id="l11.156">       currentExplodedTime.tm_month == explodedMsgTime.tm_month &amp;&amp;</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-      currentExplodedTime.tm_mday == explodedMsgTime.tm_mday)</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-  {</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+      currentExplodedTime.tm_mday == explodedMsgTime.tm_mday) {</span>
<a href="#l11.160"></a><span id="l11.160">     // Same day.</span>
<a href="#l11.161"></a><span id="l11.161">     *aAgeBucket = 1;</span>
<a href="#l11.162"></a><span id="l11.162">   }</span>
<a href="#l11.163"></a><span id="l11.163">   // Figure out how many days ago this msg arrived.</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-  else if (currentTime &gt; dateOfMsg)</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-  {</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  else if (currentTime &gt; dateOfMsg) {</span>
<a href="#l11.167"></a><span id="l11.167">     // Setting the time variables to local time.</span>
<a href="#l11.168"></a><span id="l11.168">     int64_t GMTLocalTimeShift = currentExplodedTime.tm_params.tp_gmt_offset +</span>
<a href="#l11.169"></a><span id="l11.169">                                 currentExplodedTime.tm_params.tp_dst_offset;</span>
<a href="#l11.170"></a><span id="l11.170">     GMTLocalTimeShift *= PR_USEC_PER_SEC;</span>
<a href="#l11.171"></a><span id="l11.171">     currentTime += GMTLocalTimeShift;</span>
<a href="#l11.172"></a><span id="l11.172">     dateOfMsg += GMTLocalTimeShift;</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174">     // The most recent midnight, counting from current time.</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineat">@@ -159,118 +137,96 @@ nsMsgGroupView::GetAgeBucketValue(nsIMsg</span>
<a href="#l11.176"></a><span id="l11.176">     // Most recent midnight minus 6 days.</span>
<a href="#l11.177"></a><span id="l11.177">     int64_t mostRecentWeek = mostRecentMidnight - (PR_USEC_PER_DAY * 6);</span>
<a href="#l11.178"></a><span id="l11.178"> </span>
<a href="#l11.179"></a><span id="l11.179">     // Was the message sent yesterday?</span>
<a href="#l11.180"></a><span id="l11.180">     if (dateOfMsg &gt;= yesterday)</span>
<a href="#l11.181"></a><span id="l11.181">       *aAgeBucket = 2;</span>
<a href="#l11.182"></a><span id="l11.182">     else if (dateOfMsg &gt;= mostRecentWeek)</span>
<a href="#l11.183"></a><span id="l11.183">       *aAgeBucket = 3;</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    else</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-    {</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    else {</span>
<a href="#l11.187"></a><span id="l11.187">       int64_t lastTwoWeeks = mostRecentMidnight - PR_USEC_PER_DAY * 13;</span>
<a href="#l11.188"></a><span id="l11.188">       *aAgeBucket = (dateOfMsg &gt;= lastTwoWeeks) ? 4 : 5;</span>
<a href="#l11.189"></a><span id="l11.189">     }</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-  }</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-  else</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-  {</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+  } else {</span>
<a href="#l11.194"></a><span id="l11.194">     // All that remains is a future date.</span>
<a href="#l11.195"></a><span id="l11.195">     *aAgeBucket = 6;</span>
<a href="#l11.196"></a><span id="l11.196">   }</span>
<a href="#l11.197"></a><span id="l11.197">   return NS_OK;</span>
<a href="#l11.198"></a><span id="l11.198"> }</span>
<a href="#l11.199"></a><span id="l11.199"> </span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-nsresult</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-nsMsgGroupView::HashHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-                        nsString&amp; aHashKey)</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-{</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+nsresult nsMsgGroupView::HashHdr(nsIMsgDBHdr *msgHdr, nsString &amp;aHashKey) {</span>
<a href="#l11.205"></a><span id="l11.205">   nsCString cStringKey;</span>
<a href="#l11.206"></a><span id="l11.206">   aHashKey.Truncate();</span>
<a href="#l11.207"></a><span id="l11.207">   nsresult rv = NS_OK;</span>
<a href="#l11.208"></a><span id="l11.208">   bool rcvDate = false;</span>
<a href="#l11.209"></a><span id="l11.209"> </span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-  switch (m_sortType)</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-  {</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+  switch (m_sortType) {</span>
<a href="#l11.213"></a><span id="l11.213">     case nsMsgViewSortType::bySubject:</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-      (void) msgHdr-&gt;GetSubject(getter_Copies(cStringKey));</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+      (void)msgHdr-&gt;GetSubject(getter_Copies(cStringKey));</span>
<a href="#l11.216"></a><span id="l11.216">       CopyASCIItoUTF16(cStringKey, aHashKey);</span>
<a href="#l11.217"></a><span id="l11.217">       break;</span>
<a href="#l11.218"></a><span id="l11.218">     case nsMsgViewSortType::byAuthor:</span>
<a href="#l11.219"></a><span id="l11.219">       rv = nsMsgDBView::FetchAuthor(msgHdr, aHashKey);</span>
<a href="#l11.220"></a><span id="l11.220">       break;</span>
<a href="#l11.221"></a><span id="l11.221">     case nsMsgViewSortType::byRecipient:</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-      (void) msgHdr-&gt;GetRecipients(getter_Copies(cStringKey));</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+      (void)msgHdr-&gt;GetRecipients(getter_Copies(cStringKey));</span>
<a href="#l11.224"></a><span id="l11.224">       CopyASCIItoUTF16(cStringKey, aHashKey);</span>
<a href="#l11.225"></a><span id="l11.225">       break;</span>
<a href="#l11.226"></a><span id="l11.226">     case nsMsgViewSortType::byAccount:</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-    case nsMsgViewSortType::byTags:</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-      {</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-        if (!dbToUse)</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-          // Probably a search view.</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-          GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+    case nsMsgViewSortType::byTags: {</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+      if (!dbToUse)</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+        // Probably a search view.</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+        GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l11.238"></a><span id="l11.238"> </span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-        rv = (m_sortType == nsMsgViewSortType::byAccount)</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-          ? FetchAccount(msgHdr, aHashKey)</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-          : FetchTags(msgHdr, aHashKey);</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-      }</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+      rv = (m_sortType == nsMsgViewSortType::byAccount)</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+               ? FetchAccount(msgHdr, aHashKey)</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+               : FetchTags(msgHdr, aHashKey);</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+    } break;</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+    case nsMsgViewSortType::byAttachments: {</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+      uint32_t flags;</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+      msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+      aHashKey.Assign(flags &amp; nsMsgMessageFlags::Attachment ? '1' : '0');</span>
<a href="#l11.251"></a><span id="l11.251">       break;</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-    case nsMsgViewSortType::byAttachments:</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-      {</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-        uint32_t flags;</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-        msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-        aHashKey.Assign(flags &amp; nsMsgMessageFlags::Attachment ? '1' : '0');</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-        break;</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-      }</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-    case nsMsgViewSortType::byFlagged:</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-      {</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-        uint32_t flags;</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-        msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-        aHashKey.Assign(flags &amp; nsMsgMessageFlags::Marked ? '1' : '0');</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-        break;</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-      }</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-    case nsMsgViewSortType::byPriority:</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-      {</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-        nsMsgPriorityValue priority;</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-        msgHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-        aHashKey.AppendInt(priority);</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-      }</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+    }</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+    case nsMsgViewSortType::byFlagged: {</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+      uint32_t flags;</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+      msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+      aHashKey.Assign(flags &amp; nsMsgMessageFlags::Marked ? '1' : '0');</span>
<a href="#l11.277"></a><span id="l11.277">       break;</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-    case nsMsgViewSortType::byStatus:</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-      {</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-        uint32_t status = 0;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-        GetStatusSortValue(msgHdr, &amp;status);</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-        aHashKey.AppendInt(status);</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-      }</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-      break;</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+    }</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+    case nsMsgViewSortType::byPriority: {</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+      nsMsgPriorityValue priority;</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+      msgHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+      aHashKey.AppendInt(priority);</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+    } break;</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+    case nsMsgViewSortType::byStatus: {</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+      uint32_t status = 0;</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+      GetStatusSortValue(msgHdr, &amp;status);</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+      aHashKey.AppendInt(status);</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+    } break;</span>
<a href="#l11.296"></a><span id="l11.296">     case nsMsgViewSortType::byReceived:</span>
<a href="#l11.297"></a><span id="l11.297">       rcvDate = true;</span>
<a href="#l11.298"></a><span id="l11.298">       MOZ_FALLTHROUGH;</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-    case nsMsgViewSortType::byDate:</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-    {</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+    case nsMsgViewSortType::byDate: {</span>
<a href="#l11.302"></a><span id="l11.302">       uint32_t ageBucket;</span>
<a href="#l11.303"></a><span id="l11.303">       rv = GetAgeBucketValue(msgHdr, &amp;ageBucket, rcvDate);</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-        aHashKey.AppendInt(ageBucket);</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+      if (NS_SUCCEEDED(rv)) aHashKey.AppendInt(ageBucket);</span>
<a href="#l11.307"></a><span id="l11.307"> </span>
<a href="#l11.308"></a><span id="l11.308">       break;</span>
<a href="#l11.309"></a><span id="l11.309">     }</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-    case nsMsgViewSortType::byCustom:</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-    {</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-      nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-      if (colHandler)</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-      {</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+    case nsMsgViewSortType::byCustom: {</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+      nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+      if (colHandler) {</span>
<a href="#l11.318"></a><span id="l11.318">         bool isString;</span>
<a href="#l11.319"></a><span id="l11.319">         colHandler-&gt;IsString(&amp;isString);</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-        if (isString)</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-        {</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+        if (isString) {</span>
<a href="#l11.323"></a><span id="l11.323">           rv = colHandler-&gt;GetSortStringForRow(msgHdr, aHashKey);</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-        }</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-        else</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-        {</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+        } else {</span>
<a href="#l11.328"></a><span id="l11.328">           uint32_t intKey;</span>
<a href="#l11.329"></a><span id="l11.329">           rv = colHandler-&gt;GetSortLongForRow(msgHdr, &amp;intKey);</span>
<a href="#l11.330"></a><span id="l11.330">           aHashKey.AppendInt(intKey);</span>
<a href="#l11.331"></a><span id="l11.331">         }</span>
<a href="#l11.332"></a><span id="l11.332">       }</span>
<a href="#l11.333"></a><span id="l11.333">       break;</span>
<a href="#l11.334"></a><span id="l11.334">     }</span>
<a href="#l11.335"></a><span id="l11.335">     case nsMsgViewSortType::byCorrespondent:</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineat">@@ -282,372 +238,338 @@ nsMsgGroupView::HashHdr(nsIMsgDBHdr *msg</span>
<a href="#l11.337"></a><span id="l11.337">       break;</span>
<a href="#l11.338"></a><span id="l11.338">     default:</span>
<a href="#l11.339"></a><span id="l11.339">       NS_ASSERTION(false, &quot;no hash key for this type&quot;);</span>
<a href="#l11.340"></a><span id="l11.340">       rv = NS_ERROR_FAILURE;</span>
<a href="#l11.341"></a><span id="l11.341">   }</span>
<a href="#l11.342"></a><span id="l11.342">   return rv;</span>
<a href="#l11.343"></a><span id="l11.343"> }</span>
<a href="#l11.344"></a><span id="l11.344"> </span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-nsMsgGroupThread *nsMsgGroupView::CreateGroupThread(nsIMsgDatabase *db)</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-{</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+nsMsgGroupThread *nsMsgGroupView::CreateGroupThread(nsIMsgDatabase *db) {</span>
<a href="#l11.348"></a><span id="l11.348">   return new nsMsgGroupThread(db);</span>
<a href="#l11.349"></a><span id="l11.349"> }</span>
<a href="#l11.350"></a><span id="l11.350"> </span>
<a href="#l11.351"></a><span id="l11.351"> nsMsgGroupThread *nsMsgGroupView::AddHdrToThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-                                                 bool *pNewThread)</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-{</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+                                                 bool *pNewThread) {</span>
<a href="#l11.355"></a><span id="l11.355">   nsMsgKey msgKey;</span>
<a href="#l11.356"></a><span id="l11.356">   uint32_t msgFlags;</span>
<a href="#l11.357"></a><span id="l11.357">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l11.358"></a><span id="l11.358">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l11.359"></a><span id="l11.359">   nsString hashKey;</span>
<a href="#l11.360"></a><span id="l11.360">   nsresult rv = HashHdr(msgHdr, hashKey);</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-    return nullptr;</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l11.364"></a><span id="l11.364"> </span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-//  if (m_sortType == nsMsgViewSortType::byDate)</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-//    msgKey = ((nsPRUint32Key *) hashKey)-&gt;GetValue();</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+  // if (m_sortType == nsMsgViewSortType::byDate)</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+  //    msgKey = ((nsPRUint32Key *)hashKey)-&gt;GetValue();</span>
<a href="#l11.369"></a><span id="l11.369">   nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l11.370"></a><span id="l11.370">   m_groupsTable.Get(hashKey, getter_AddRefs(msgThread));</span>
<a href="#l11.371"></a><span id="l11.371">   bool newThread = !msgThread;</span>
<a href="#l11.372"></a><span id="l11.372">   *pNewThread = newThread;</span>
<a href="#l11.373"></a><span id="l11.373">   // Index of first message in thread in view.</span>
<a href="#l11.374"></a><span id="l11.374">   nsMsgViewIndex viewIndexOfThread;</span>
<a href="#l11.375"></a><span id="l11.375">   // Index of newly added header in thread.</span>
<a href="#l11.376"></a><span id="l11.376">   nsMsgViewIndex threadInsertIndex;</span>
<a href="#l11.377"></a><span id="l11.377"> </span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-  nsMsgGroupThread *foundThread = static_cast&lt;nsMsgGroupThread *&gt;(msgThread.get());</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineminus">-  if (foundThread)</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-  {</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+  nsMsgGroupThread *foundThread =</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+      static_cast&lt;nsMsgGroupThread *&gt;(msgThread.get());</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+  if (foundThread) {</span>
<a href="#l11.384"></a><span id="l11.384">     // Find the view index of the root node of the thread in the view.</span>
<a href="#l11.385"></a><span id="l11.385">     viewIndexOfThread = GetIndexOfFirstDisplayedKeyInThread(foundThread, true);</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-    if (viewIndexOfThread == nsMsgViewIndex_None)</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-    {</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+    if (viewIndexOfThread == nsMsgViewIndex_None) {</span>
<a href="#l11.389"></a><span id="l11.389">       // Something is wrong with the group table. Remove the old group and</span>
<a href="#l11.390"></a><span id="l11.390">       // insert a new one.</span>
<a href="#l11.391"></a><span id="l11.391">       m_groupsTable.Remove(hashKey);</span>
<a href="#l11.392"></a><span id="l11.392">       foundThread = nullptr;</span>
<a href="#l11.393"></a><span id="l11.393">       *pNewThread = newThread = true;</span>
<a href="#l11.394"></a><span id="l11.394">     }</span>
<a href="#l11.395"></a><span id="l11.395">   }</span>
<a href="#l11.396"></a><span id="l11.396"> </span>
<a href="#l11.397"></a><span id="l11.397">   // If the thread does not already exist, create one</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-  if (!foundThread)</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-  {</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+  if (!foundThread) {</span>
<a href="#l11.401"></a><span id="l11.401">     foundThread = CreateGroupThread(m_db);</span>
<a href="#l11.402"></a><span id="l11.402">     msgThread = foundThread;</span>
<a href="#l11.403"></a><span id="l11.403">     m_groupsTable.Put(hashKey, msgThread);</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-    if (GroupViewUsesDummyRow())</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">-    {</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+    if (GroupViewUsesDummyRow()) {</span>
<a href="#l11.407"></a><span id="l11.407">       foundThread-&gt;m_dummy = true;</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-      msgFlags |=  MSG_VIEW_FLAG_DUMMY | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+      msgFlags |= MSG_VIEW_FLAG_DUMMY | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l11.410"></a><span id="l11.410">     }</span>
<a href="#l11.411"></a><span id="l11.411"> </span>
<a href="#l11.412"></a><span id="l11.412">     viewIndexOfThread = GetInsertIndex(msgHdr);</span>
<a href="#l11.413"></a><span id="l11.413">     if (viewIndexOfThread == nsMsgViewIndex_None)</span>
<a href="#l11.414"></a><span id="l11.414">       viewIndexOfThread = m_keys.Length();</span>
<a href="#l11.415"></a><span id="l11.415"> </span>
<a href="#l11.416"></a><span id="l11.416">     // Add the thread root node to the view.</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineminus">-    InsertMsgHdrAt(viewIndexOfThread, msgHdr, msgKey,</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineminus">-                   msgFlags | MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided, 0);</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+    InsertMsgHdrAt(</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+        viewIndexOfThread, msgHdr, msgKey,</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+        msgFlags | MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided, 0);</span>
<a href="#l11.422"></a><span id="l11.422"> </span>
<a href="#l11.423"></a><span id="l11.423">     // For dummy rows, Have the header serve as the dummy node (it will be</span>
<a href="#l11.424"></a><span id="l11.424">     // added again for its actual content later).</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-    if (GroupViewUsesDummyRow())</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-      foundThread-&gt;InsertMsgHdrAt(0, msgHdr);</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+    if (GroupViewUsesDummyRow()) foundThread-&gt;InsertMsgHdrAt(0, msgHdr);</span>
<a href="#l11.428"></a><span id="l11.428"> </span>
<a href="#l11.429"></a><span id="l11.429">     // Calculate the (integer thread key); this really only needs to be done for</span>
<a href="#l11.430"></a><span id="l11.430">     // the byDate case where the expanded state of the groups can be easily</span>
<a href="#l11.431"></a><span id="l11.431">     // persisted and restored because of the bounded, consecutive value space</span>
<a href="#l11.432"></a><span id="l11.432">     // occupied.  We calculate an integer value in all cases mainly because</span>
<a href="#l11.433"></a><span id="l11.433">     // it's the sanest choice available...</span>
<a href="#l11.434"></a><span id="l11.434">     // (The thread key needs to be an integer, so parse hash keys that are</span>
<a href="#l11.435"></a><span id="l11.435">     // stringified integers to real integers, and hash actual strings into</span>
<a href="#l11.436"></a><span id="l11.436">     // integers.)</span>
<a href="#l11.437"></a><span id="l11.437">     if ((m_sortType == nsMsgViewSortType::byAttachments) ||</span>
<a href="#l11.438"></a><span id="l11.438">         (m_sortType == nsMsgViewSortType::byFlagged) ||</span>
<a href="#l11.439"></a><span id="l11.439">         (m_sortType == nsMsgViewSortType::byPriority) ||</span>
<a href="#l11.440"></a><span id="l11.440">         (m_sortType == nsMsgViewSortType::byStatus) ||</span>
<a href="#l11.441"></a><span id="l11.441">         (m_sortType == nsMsgViewSortType::byReceived) ||</span>
<a href="#l11.442"></a><span id="l11.442">         (m_sortType == nsMsgViewSortType::byDate))</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-      foundThread-&gt;m_threadKey = atoi(NS_LossyConvertUTF16toASCII(hashKey).get());</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+      foundThread-&gt;m_threadKey =</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+          atoi(NS_LossyConvertUTF16toASCII(hashKey).get());</span>
<a href="#l11.446"></a><span id="l11.446">     else</span>
<a href="#l11.447"></a><span id="l11.447">       foundThread-&gt;m_threadKey =</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineminus">-        (nsMsgKey)PL_HashString(NS_LossyConvertUTF16toASCII(hashKey).get());</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+          (nsMsgKey)PL_HashString(NS_LossyConvertUTF16toASCII(hashKey).get());</span>
<a href="#l11.450"></a><span id="l11.450">   }</span>
<a href="#l11.451"></a><span id="l11.451"> </span>
<a href="#l11.452"></a><span id="l11.452">   // Add the message to the thread as an actual content-bearing header.</span>
<a href="#l11.453"></a><span id="l11.453">   // (If we use dummy rows, it was already added to the thread during creation.)</span>
<a href="#l11.454"></a><span id="l11.454">   threadInsertIndex = foundThread-&gt;AddChildFromGroupView(msgHdr, this);</span>
<a href="#l11.455"></a><span id="l11.455">   // Check if new hdr became thread root.</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineminus">-  if (!newThread &amp;&amp; threadInsertIndex == 0)</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineminus">-  {</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+  if (!newThread &amp;&amp; threadInsertIndex == 0) {</span>
<a href="#l11.459"></a><span id="l11.459">     // Update the root node's header (in the view) to be the same as the root</span>
<a href="#l11.460"></a><span id="l11.460">     // node in the thread.</span>
<a href="#l11.461"></a><span id="l11.461">     SetMsgHdrAt(msgHdr, viewIndexOfThread, msgKey,</span>
<a href="#l11.462"></a><span id="l11.462">                 (msgFlags &amp; ~(nsMsgMessageFlags::Elided)) |</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineminus">-                // Maintain elided flag and dummy flag.</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineminus">-                (m_flags[viewIndexOfThread] &amp; (nsMsgMessageFlags::Elided |</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-                                               MSG_VIEW_FLAG_DUMMY)) |</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineminus">-                // Ensure thread and has-children flags are set.</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-                MSG_VIEW_FLAG_ISTHREAD | MSG_VIEW_FLAG_HASCHILDREN, 0);</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+                    // Maintain elided flag and dummy flag.</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+                    (m_flags[viewIndexOfThread] &amp;</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+                     (nsMsgMessageFlags::Elided | MSG_VIEW_FLAG_DUMMY)) |</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+                    // Ensure thread and has-children flags are set.</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+                    MSG_VIEW_FLAG_ISTHREAD | MSG_VIEW_FLAG_HASCHILDREN,</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+                0);</span>
<a href="#l11.474"></a><span id="l11.474">     // Update the content-bearing copy in the thread to match.  (the root and</span>
<a href="#l11.475"></a><span id="l11.475">     // first nodes in the thread should always be the same header.)</span>
<a href="#l11.476"></a><span id="l11.476">     // Note: the guy who used to be the root will still exist.  If our list of</span>
<a href="#l11.477"></a><span id="l11.477">     // nodes was [A A], a new node B is introduced which sorts to be the first</span>
<a href="#l11.478"></a><span id="l11.478">     // node, giving us [B A A], our copy makes that [B B A], and things are</span>
<a href="#l11.479"></a><span id="l11.479">     // right in the world (since we want the first two headers to be the same</span>
<a href="#l11.480"></a><span id="l11.480">     // since one is our dummy and one is real.)</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-    if (GroupViewUsesDummyRow())</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-    {</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+    if (GroupViewUsesDummyRow()) {</span>
<a href="#l11.484"></a><span id="l11.484">       // Replace the old duplicate dummy header.</span>
<a href="#l11.485"></a><span id="l11.485">       // We do not update the content-bearing copy in the view to match; we</span>
<a href="#l11.486"></a><span id="l11.486">       // leave that up to OnNewHeader, which is the piece of code who gets to</span>
<a href="#l11.487"></a><span id="l11.487">       // care about whether the thread's children are shown or not (elided).</span>
<a href="#l11.488"></a><span id="l11.488">       foundThread-&gt;SetMsgHdrAt(1, msgHdr);</span>
<a href="#l11.489"></a><span id="l11.489">     }</span>
<a href="#l11.490"></a><span id="l11.490">   }</span>
<a href="#l11.491"></a><span id="l11.491"> </span>
<a href="#l11.492"></a><span id="l11.492">   return foundThread;</span>
<a href="#l11.493"></a><span id="l11.493"> }</span>
<a href="#l11.494"></a><span id="l11.494"> </span>
<a href="#l11.495"></a><span id="l11.495"> NS_IMETHODIMP</span>
<a href="#l11.496"></a><span id="l11.496"> nsMsgGroupView::OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l11.497"></a><span id="l11.497">                              nsMsgViewSortTypeValue aSortType,</span>
<a href="#l11.498"></a><span id="l11.498">                              nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l11.499"></a><span id="l11.499">                              nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-                             int32_t *aCount)</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-{</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+                             int32_t *aCount) {</span>
<a href="#l11.503"></a><span id="l11.503">   nsresult rv = NS_OK;</span>
<a href="#l11.504"></a><span id="l11.504"> </span>
<a href="#l11.505"></a><span id="l11.505">   m_groupsTable.Clear();</span>
<a href="#l11.506"></a><span id="l11.506">   if (aSortType == nsMsgViewSortType::byThread ||</span>
<a href="#l11.507"></a><span id="l11.507">       aSortType == nsMsgViewSortType::byId ||</span>
<a href="#l11.508"></a><span id="l11.508">       aSortType == nsMsgViewSortType::byNone ||</span>
<a href="#l11.509"></a><span id="l11.509">       aSortType == nsMsgViewSortType::bySize)</span>
<a href="#l11.510"></a><span id="l11.510">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l11.511"></a><span id="l11.511"> </span>
<a href="#l11.512"></a><span id="l11.512">   m_sortType = aSortType;</span>
<a href="#l11.513"></a><span id="l11.513">   m_sortOrder = aSortOrder;</span>
<a href="#l11.514"></a><span id="l11.514">   m_viewFlags = aViewFlags | nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineminus">-                             nsMsgViewFlagsType::kGroupBySort;</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+                nsMsgViewFlagsType::kGroupBySort;</span>
<a href="#l11.517"></a><span id="l11.517">   SaveSortInfo(m_sortType, m_sortOrder);</span>
<a href="#l11.518"></a><span id="l11.518"> </span>
<a href="#l11.519"></a><span id="l11.519" class="difflineminus">-  if (m_sortType == nsMsgViewSortType::byCustom)</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineminus">-  {</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+  if (m_sortType == nsMsgViewSortType::byCustom) {</span>
<a href="#l11.522"></a><span id="l11.522">     // If the desired sort is a custom column and there is no handler found,</span>
<a href="#l11.523"></a><span id="l11.523">     // it hasn't been registered yet; after the custom column observer is</span>
<a href="#l11.524"></a><span id="l11.524">     // notified with MsgCreateDBView and registers the handler, it will come</span>
<a href="#l11.525"></a><span id="l11.525">     // back and build the view.</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-    nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineminus">-    if (!colHandler)</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineminus">-      return rv;</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+    nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+    if (!colHandler) return rv;</span>
<a href="#l11.531"></a><span id="l11.531">   }</span>
<a href="#l11.532"></a><span id="l11.532"> </span>
<a href="#l11.533"></a><span id="l11.533">   bool hasMore;</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.538"></a><span id="l11.538">   while (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineminus">-         NS_SUCCEEDED(rv = aHeaders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineminus">-         hasMore)</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineminus">-  {</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineplus">+         NS_SUCCEEDED(rv = aHeaders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l11.543"></a><span id="l11.543">     rv = aHeaders-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineminus">-    {</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l11.547"></a><span id="l11.547">       bool notUsed;</span>
<a href="#l11.548"></a><span id="l11.548">       msgHdr = do_QueryInterface(supports);</span>
<a href="#l11.549"></a><span id="l11.549">       AddHdrToThread(msgHdr, &amp;notUsed);</span>
<a href="#l11.550"></a><span id="l11.550">     }</span>
<a href="#l11.551"></a><span id="l11.551">   }</span>
<a href="#l11.552"></a><span id="l11.552">   uint32_t expandFlags = 0;</span>
<a href="#l11.553"></a><span id="l11.553">   bool expandAll = m_viewFlags &amp; nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineminus">-  uint32_t viewFlag = (m_sortType == nsMsgViewSortType::byDate) ? MSG_VIEW_FLAG_DUMMY : 0;</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-  if (viewFlag &amp;&amp; m_db)</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-  {</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineplus">+  uint32_t viewFlag =</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+      (m_sortType == nsMsgViewSortType::byDate) ? MSG_VIEW_FLAG_DUMMY : 0;</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+  if (viewFlag &amp;&amp; m_db) {</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l11.562"></a><span id="l11.562">     nsresult rv = m_db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l11.563"></a><span id="l11.563">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.564"></a><span id="l11.564">     if (dbFolderInfo)</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineminus">-      dbFolderInfo-&gt;GetUint32Property(&quot;dateGroupFlags&quot;,  0, &amp;expandFlags);</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineplus">+      dbFolderInfo-&gt;GetUint32Property(&quot;dateGroupFlags&quot;, 0, &amp;expandFlags);</span>
<a href="#l11.567"></a><span id="l11.567">   }</span>
<a href="#l11.568"></a><span id="l11.568">   // Go through the view updating the flags for threads with more than one</span>
<a href="#l11.569"></a><span id="l11.569">   // message, and if grouped by date, expanding threads that were expanded</span>
<a href="#l11.570"></a><span id="l11.570">   // before.</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineminus">-  for (uint32_t viewIndex = 0; viewIndex &lt; m_keys.Length(); viewIndex++)</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineminus">-  {</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineminus">-    nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineplus">+  for (uint32_t viewIndex = 0; viewIndex &lt; m_keys.Length(); viewIndex++) {</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+    nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l11.576"></a><span id="l11.576">     GetThreadContainingIndex(viewIndex, getter_AddRefs(thread));</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineminus">-    if (thread)</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineminus">-    {</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineplus">+    if (thread) {</span>
<a href="#l11.580"></a><span id="l11.580">       uint32_t numChildren;</span>
<a href="#l11.581"></a><span id="l11.581">       thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l11.582"></a><span id="l11.582">       if (numChildren &gt; 1 || viewFlag)</span>
<a href="#l11.583"></a><span id="l11.583">         OrExtraFlag(viewIndex, viewFlag | MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineminus">-      if (expandAll || expandFlags)</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineminus">-      {</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineplus">+      if (expandAll || expandFlags) {</span>
<a href="#l11.587"></a><span id="l11.587">         nsMsgGroupThread *groupThread =</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineminus">-          static_cast&lt;nsMsgGroupThread *&gt;((nsIMsgThread *) thread);</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineminus">-        if (expandAll || expandFlags &amp; (1 &lt;&lt; groupThread-&gt;m_threadKey))</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-        {</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineplus">+            static_cast&lt;nsMsgGroupThread *&gt;((nsIMsgThread *)thread);</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineplus">+        if (expandAll || expandFlags &amp; (1 &lt;&lt; groupThread-&gt;m_threadKey)) {</span>
<a href="#l11.593"></a><span id="l11.593">           uint32_t numExpanded;</span>
<a href="#l11.594"></a><span id="l11.594">           ExpandByIndex(viewIndex, &amp;numExpanded);</span>
<a href="#l11.595"></a><span id="l11.595">           viewIndex += numExpanded;</span>
<a href="#l11.596"></a><span id="l11.596">         }</span>
<a href="#l11.597"></a><span id="l11.597">       }</span>
<a href="#l11.598"></a><span id="l11.598">     }</span>
<a href="#l11.599"></a><span id="l11.599">   }</span>
<a href="#l11.600"></a><span id="l11.600">   *aCount = m_keys.Length();</span>
<a href="#l11.601"></a><span id="l11.601">   return rv;</span>
<a href="#l11.602"></a><span id="l11.602"> }</span>
<a href="#l11.603"></a><span id="l11.603"> </span>
<a href="#l11.604"></a><span id="l11.604"> // We wouldn't need this if we never instantiated this directly,</span>
<a href="#l11.605"></a><span id="l11.605"> // but instead used nsMsgThreadedDBView with the grouping flag set.</span>
<a href="#l11.606"></a><span id="l11.606"> // Or, we could get rid of the nsMsgThreadedDBView impl of this method.</span>
<a href="#l11.607"></a><span id="l11.607"> NS_IMETHODIMP</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineminus">-nsMsgGroupView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l11.609"></a><span id="l11.609" class="difflineminus">-{</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-    *aViewType = nsMsgViewType::eShowAllThreads;</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+nsMsgGroupView::GetViewType(nsMsgViewTypeValue *aViewType) {</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineplus">+  *aViewType = nsMsgViewType::eShowAllThreads;</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.617"></a><span id="l11.617"> }</span>
<a href="#l11.618"></a><span id="l11.618"> </span>
<a href="#l11.619"></a><span id="l11.619"> NS_IMETHODIMP</span>
<a href="#l11.620"></a><span id="l11.620"> nsMsgGroupView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l11.621"></a><span id="l11.621">                            nsIMessenger *aMessengerInstance,</span>
<a href="#l11.622"></a><span id="l11.622">                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-                           nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-{</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-  nsMsgDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-  nsMsgGroupView* newMsgDBView = (nsMsgGroupView *) aNewMsgDBView;</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineplus">+                           nsIMsgDBViewCommandUpdater *aCmdUpdater) {</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineplus">+  nsMsgDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow,</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineplus">+                          aCmdUpdater);</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineplus">+  nsMsgGroupView *newMsgDBView = (nsMsgGroupView *)aNewMsgDBView;</span>
<a href="#l11.631"></a><span id="l11.631"> </span>
<a href="#l11.632"></a><span id="l11.632">   // If grouped, we need to clone the group thread hash table.</span>
<a href="#l11.633"></a><span id="l11.633">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) {</span>
<a href="#l11.634"></a><span id="l11.634">     for (auto iter = m_groupsTable.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l11.635"></a><span id="l11.635">       newMsgDBView-&gt;m_groupsTable.Put(iter.Key(), iter.UserData());</span>
<a href="#l11.636"></a><span id="l11.636">     }</span>
<a href="#l11.637"></a><span id="l11.637">   }</span>
<a href="#l11.638"></a><span id="l11.638">   return NS_OK;</span>
<a href="#l11.639"></a><span id="l11.639"> }</span>
<a href="#l11.640"></a><span id="l11.640"> </span>
<a href="#l11.641"></a><span id="l11.641"> // E.g., if the day has changed, we need to close and re-open the view.</span>
<a href="#l11.642"></a><span id="l11.642"> // Or, if we're switching between grouping and threading in a cross-folder</span>
<a href="#l11.643"></a><span id="l11.643"> // saved search. In that case, we needed to build an enumerator based on the</span>
<a href="#l11.644"></a><span id="l11.644"> // old view type, and internally close the view based on its old type, but</span>
<a href="#l11.645"></a><span id="l11.645"> // rebuild the new view based on the new view type. So we pass the new</span>
<a href="#l11.646"></a><span id="l11.646"> // view flags to OpenWithHdrs.</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineminus">-nsresult</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-nsMsgGroupView::RebuildView(nsMsgViewFlagsTypeValue newFlags)</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineminus">-{</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; headers;</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-  if (NS_SUCCEEDED(GetMessageEnumerator(getter_AddRefs(headers))))</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-  {</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineplus">+nsresult nsMsgGroupView::RebuildView(nsMsgViewFlagsTypeValue newFlags) {</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; headers;</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineplus">+  if (NS_SUCCEEDED(GetMessageEnumerator(getter_AddRefs(headers)))) {</span>
<a href="#l11.656"></a><span id="l11.656">     int32_t count;</span>
<a href="#l11.657"></a><span id="l11.657">     m_dayChanged = false;</span>
<a href="#l11.658"></a><span id="l11.658">     AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l11.659"></a><span id="l11.659">     nsMsgKey curSelectedKey;</span>
<a href="#l11.660"></a><span id="l11.660">     SaveAndClearSelection(&amp;curSelectedKey, preservedSelection);</span>
<a href="#l11.661"></a><span id="l11.661">     InternalClose();</span>
<a href="#l11.662"></a><span id="l11.662">     int32_t oldSize = GetSize();</span>
<a href="#l11.663"></a><span id="l11.663">     // This is important, because the tree will ask us for our row count,</span>
<a href="#l11.664"></a><span id="l11.664">     // which gets determined from the number of keys.</span>
<a href="#l11.665"></a><span id="l11.665">     m_keys.Clear();</span>
<a href="#l11.666"></a><span id="l11.666">     // Be consistent.</span>
<a href="#l11.667"></a><span id="l11.667">     m_flags.Clear();</span>
<a href="#l11.668"></a><span id="l11.668">     m_levels.Clear();</span>
<a href="#l11.669"></a><span id="l11.669"> </span>
<a href="#l11.670"></a><span id="l11.670">     // This needs to happen after we remove all the keys, since</span>
<a href="#l11.671"></a><span id="l11.671">     // RowCountChanged() will call our GetRowCount().</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineminus">-    if (mTree)</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineminus">-      mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineplus">+    if (mTree) mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l11.675"></a><span id="l11.675"> </span>
<a href="#l11.676"></a><span id="l11.676">     SetSuppressChangeNotifications(true);</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineminus">-    nsresult rv = OpenWithHdrs(headers, m_sortType, m_sortOrder, newFlags, &amp;count);</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineplus">+    nsresult rv =</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineplus">+        OpenWithHdrs(headers, m_sortType, m_sortOrder, newFlags, &amp;count);</span>
<a href="#l11.680"></a><span id="l11.680">     SetSuppressChangeNotifications(false);</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineminus">-    if (mTree)</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineminus">-      mTree-&gt;RowCountChanged(0, GetSize());</span>
<a href="#l11.683"></a><span id="l11.683" class="difflineplus">+    if (mTree) mTree-&gt;RowCountChanged(0, GetSize());</span>
<a href="#l11.684"></a><span id="l11.684"> </span>
<a href="#l11.685"></a><span id="l11.685" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.687"></a><span id="l11.687"> </span>
<a href="#l11.688"></a><span id="l11.688">     // Now, restore our desired selection.</span>
<a href="#l11.689"></a><span id="l11.689">     AutoTArray&lt;nsMsgKey, 1&gt; keyArray;</span>
<a href="#l11.690"></a><span id="l11.690">     keyArray.AppendElement(curSelectedKey);</span>
<a href="#l11.691"></a><span id="l11.691"> </span>
<a href="#l11.692"></a><span id="l11.692">     return RestoreSelection(curSelectedKey, keyArray);</span>
<a href="#l11.693"></a><span id="l11.693">   }</span>
<a href="#l11.694"></a><span id="l11.694">   return NS_OK;</span>
<a href="#l11.695"></a><span id="l11.695"> }</span>
<a href="#l11.696"></a><span id="l11.696"> </span>
<a href="#l11.697"></a><span id="l11.697" class="difflineminus">-nsresult</span>
<a href="#l11.698"></a><span id="l11.698" class="difflineminus">-nsMsgGroupView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l11.699"></a><span id="l11.699" class="difflineminus">-                            nsMsgKey aParentKey,</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineminus">-                            bool ensureListed)</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineminus">-{</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineplus">+nsresult nsMsgGroupView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey,</span>
<a href="#l11.703"></a><span id="l11.703" class="difflineplus">+                                     bool ensureListed) {</span>
<a href="#l11.704"></a><span id="l11.704">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l11.705"></a><span id="l11.705">     return nsMsgDBView::OnNewHeader(newHdr, aParentKey, ensureListed);</span>
<a href="#l11.706"></a><span id="l11.706"> </span>
<a href="#l11.707"></a><span id="l11.707">   // Check if we're adding a header, and the current day has changed.</span>
<a href="#l11.708"></a><span id="l11.708">   // If it has, we're just going to close and re-open the view so things</span>
<a href="#l11.709"></a><span id="l11.709">   // will be correctly categorized.</span>
<a href="#l11.710"></a><span id="l11.710" class="difflineminus">-  if (m_dayChanged)</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineminus">-    return RebuildView(m_viewFlags);</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineplus">+  if (m_dayChanged) return RebuildView(m_viewFlags);</span>
<a href="#l11.713"></a><span id="l11.713"> </span>
<a href="#l11.714"></a><span id="l11.714">   bool newThread;</span>
<a href="#l11.715"></a><span id="l11.715">   nsMsgGroupThread *thread = AddHdrToThread(newHdr, &amp;newThread);</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineminus">-  if (thread)</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineminus">-  {</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineplus">+  if (thread) {</span>
<a href="#l11.719"></a><span id="l11.719">     // Find the view index of (the root node of) the thread.</span>
<a href="#l11.720"></a><span id="l11.720">     nsMsgViewIndex threadIndex = ThreadIndexOfMsgHdr(newHdr);</span>
<a href="#l11.721"></a><span id="l11.721">     // May need to fix thread counts.</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineminus">-    if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineminus">-    {</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineminus">-      if (newThread)</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineminus">-      {</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineplus">+    if (threadIndex != nsMsgViewIndex_None) {</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineplus">+      if (newThread) {</span>
<a href="#l11.728"></a><span id="l11.728">         // AddHdrToThread creates the header elided, so we need to un-elide it</span>
<a href="#l11.729"></a><span id="l11.729">         // if we want it expanded.</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineminus">-        if(m_viewFlags &amp; nsMsgViewFlagsType::kExpandAll)</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+        if (m_viewFlags &amp; nsMsgViewFlagsType::kExpandAll)</span>
<a href="#l11.732"></a><span id="l11.732">           m_flags[threadIndex] &amp;= ~nsMsgMessageFlags::Elided;</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineminus">-      }</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineminus">-      else</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineminus">-      {</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineminus">-        m_flags[threadIndex] |= MSG_VIEW_FLAG_HASCHILDREN |</span>
<a href="#l11.737"></a><span id="l11.737" class="difflineminus">-                                MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineplus">+      } else {</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineplus">+        m_flags[threadIndex] |=</span>
<a href="#l11.740"></a><span id="l11.740" class="difflineplus">+            MSG_VIEW_FLAG_HASCHILDREN | MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l11.741"></a><span id="l11.741">       }</span>
<a href="#l11.742"></a><span id="l11.742"> </span>
<a href="#l11.743"></a><span id="l11.743">       int32_t numRowsToInvalidate = 1;</span>
<a href="#l11.744"></a><span id="l11.744">       // If the thread is expanded (not elided), we should add the header to</span>
<a href="#l11.745"></a><span id="l11.745">       // the view.</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineminus">-      if (! (m_flags[threadIndex] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l11.747"></a><span id="l11.747" class="difflineminus">-      {</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineplus">+      if (!(m_flags[threadIndex] &amp; nsMsgMessageFlags::Elided)) {</span>
<a href="#l11.749"></a><span id="l11.749">         uint32_t msgIndexInThread = thread-&gt;FindMsgHdr(newHdr);</span>
<a href="#l11.750"></a><span id="l11.750">         bool insertedAtThreadRoot = !msgIndexInThread;</span>
<a href="#l11.751"></a><span id="l11.751">         // Add any new display node and potentially fix-up changes in the root.</span>
<a href="#l11.752"></a><span id="l11.752">         // (If this is a new thread and we are not using a dummy row, the only</span>
<a href="#l11.753"></a><span id="l11.753">         // node to display is the root node which has already been added by</span>
<a href="#l11.754"></a><span id="l11.754">         // AddHdrToThread.  And since there is just the one, no change in root</span>
<a href="#l11.755"></a><span id="l11.755">         // could have occurred, so we have nothing to do.)</span>
<a href="#l11.756"></a><span id="l11.756" class="difflineminus">-        if (!newThread || GroupViewUsesDummyRow())</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineminus">-        {</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineplus">+        if (!newThread || GroupViewUsesDummyRow()) {</span>
<a href="#l11.759"></a><span id="l11.759">           // We never want to insert/update the root node, because</span>
<a href="#l11.760"></a><span id="l11.760">           // AddHdrToThread has already done that for us (in all cases).</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineminus">-          if (insertedAtThreadRoot)</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineminus">-            msgIndexInThread++;</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineplus">+          if (insertedAtThreadRoot) msgIndexInThread++;</span>
<a href="#l11.764"></a><span id="l11.764">           // If this header is the new parent of the thread... AND</span>
<a href="#l11.765"></a><span id="l11.765">           // If we are not using a dummy row, this means we need to append our</span>
<a href="#l11.766"></a><span id="l11.766">           // old node as the first child of the new root.</span>
<a href="#l11.767"></a><span id="l11.767">           // (If we are using a dummy row, the old node's &quot;content&quot; node already</span>
<a href="#l11.768"></a><span id="l11.768">           // exists (at position threadIndex + 1) and we need to insert the</span>
<a href="#l11.769"></a><span id="l11.769">           // &quot;content&quot; copy of the new root node there, pushing our old</span>
<a href="#l11.770"></a><span id="l11.770">           // &quot;content&quot; node down.)</span>
<a href="#l11.771"></a><span id="l11.771">           // Example mini-diagrams, wrapping the to-add thing with ()</span>
<a href="#l11.772"></a><span id="l11.772">           // No dummy row; we had: [A], now we have [B], we want [B (A)].</span>
<a href="#l11.773"></a><span id="l11.773">           // Dummy row; we had: [A A], now we have [B A], we want [B (B) A].</span>
<a href="#l11.774"></a><span id="l11.774">           // (Coming into this we're adding 'B')</span>
<a href="#l11.775"></a><span id="l11.775" class="difflineminus">-          if (!newThread &amp;&amp; insertedAtThreadRoot &amp;&amp; !GroupViewUsesDummyRow())</span>
<a href="#l11.776"></a><span id="l11.776" class="difflineminus">-          {</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineplus">+          if (!newThread &amp;&amp; insertedAtThreadRoot &amp;&amp; !GroupViewUsesDummyRow()) {</span>
<a href="#l11.778"></a><span id="l11.778">             // Grab a copy of the old root node ('A') from the thread so we can</span>
<a href="#l11.779"></a><span id="l11.779">             // insert it. (offset msgIndexInThread=1 is the right thing; we are</span>
<a href="#l11.780"></a><span id="l11.780">             // non-dummy.)</span>
<a href="#l11.781"></a><span id="l11.781">             thread-&gt;GetChildHdrAt(msgIndexInThread, &amp;newHdr);</span>
<a href="#l11.782"></a><span id="l11.782">           }</span>
<a href="#l11.783"></a><span id="l11.783">           // Nothing to do for dummy case, we're already inserting 'B'.</span>
<a href="#l11.784"></a><span id="l11.784"> </span>
<a href="#l11.785"></a><span id="l11.785">           nsMsgKey msgKey;</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineat">@@ -663,264 +585,235 @@ nsMsgGroupView::OnNewHeader(nsIMsgDBHdr </span>
<a href="#l11.787"></a><span id="l11.787">         // (msgIndexInThread states - new thread: 0, old thread at root: 1).</span>
<a href="#l11.788"></a><span id="l11.788">         if (newThread &amp;&amp; GroupViewUsesDummyRow())</span>
<a href="#l11.789"></a><span id="l11.789">           NoteChange(threadIndex, 2, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l11.790"></a><span id="l11.790">         else</span>
<a href="#l11.791"></a><span id="l11.791">           NoteChange(threadIndex + msgIndexInThread, 1,</span>
<a href="#l11.792"></a><span id="l11.792">                      nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l11.793"></a><span id="l11.793"> </span>
<a href="#l11.794"></a><span id="l11.794">         numRowsToInvalidate = msgIndexInThread;</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineminus">-      }</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineminus">-      else if (newThread)</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineminus">-      {</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineplus">+      } else if (newThread) {</span>
<a href="#l11.799"></a><span id="l11.799">         // We still need the addition notification for new threads when elided.</span>
<a href="#l11.800"></a><span id="l11.800">         NoteChange(threadIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l11.801"></a><span id="l11.801">       }</span>
<a href="#l11.802"></a><span id="l11.802"> </span>
<a href="#l11.803"></a><span id="l11.803" class="difflineminus">-      NoteChange(threadIndex, numRowsToInvalidate, nsMsgViewNotificationCode::changed);</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineplus">+      NoteChange(threadIndex, numRowsToInvalidate,</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineplus">+                 nsMsgViewNotificationCode::changed);</span>
<a href="#l11.806"></a><span id="l11.806">     }</span>
<a href="#l11.807"></a><span id="l11.807">   }</span>
<a href="#l11.808"></a><span id="l11.808"> </span>
<a href="#l11.809"></a><span id="l11.809">   // If thread is expanded, we need to add hdr to view...</span>
<a href="#l11.810"></a><span id="l11.810">   return NS_OK;</span>
<a href="#l11.811"></a><span id="l11.811"> }</span>
<a href="#l11.812"></a><span id="l11.812"> </span>
<a href="#l11.813"></a><span id="l11.813"> NS_IMETHODIMP</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineminus">-nsMsgGroupView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-                                  uint32_t aOldFlags,</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineplus">+nsMsgGroupView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l11.817"></a><span id="l11.817">                                   uint32_t aNewFlags,</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineminus">-                                  nsIDBChangeListener *aInstigator)</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineminus">-{</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineplus">+                                  nsIDBChangeListener *aInstigator) {</span>
<a href="#l11.821"></a><span id="l11.821">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l11.822"></a><span id="l11.822">     return nsMsgDBView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags,</span>
<a href="#l11.823"></a><span id="l11.823">                                           aInstigator);</span>
<a href="#l11.824"></a><span id="l11.824"> </span>
<a href="#l11.825"></a><span id="l11.825" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l11.826"></a><span id="l11.826" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l11.827"></a><span id="l11.827"> </span>
<a href="#l11.828"></a><span id="l11.828">   // Check if we're adding a header, and the current day has changed.</span>
<a href="#l11.829"></a><span id="l11.829">   // If it has, we're just going to close and re-open the view so things</span>
<a href="#l11.830"></a><span id="l11.830">   // will be correctly categorized.</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineminus">-  if (m_dayChanged)</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineminus">-    return RebuildView(m_viewFlags);</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineplus">+  if (m_dayChanged) return RebuildView(m_viewFlags);</span>
<a href="#l11.834"></a><span id="l11.834"> </span>
<a href="#l11.835"></a><span id="l11.835">   nsresult rv = GetThreadContainingMsgHdr(aHdrChanged, getter_AddRefs(thread));</span>
<a href="#l11.836"></a><span id="l11.836">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.837"></a><span id="l11.837">   uint32_t deltaFlags = (aOldFlags ^ aNewFlags);</span>
<a href="#l11.838"></a><span id="l11.838">   if (deltaFlags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l11.839"></a><span id="l11.839">     thread-&gt;MarkChildRead(aNewFlags &amp; nsMsgMessageFlags::Read);</span>
<a href="#l11.840"></a><span id="l11.840"> </span>
<a href="#l11.841"></a><span id="l11.841" class="difflineminus">-  return nsMsgDBView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator);</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+  return nsMsgDBView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags,</span>
<a href="#l11.843"></a><span id="l11.843" class="difflineplus">+                                        aInstigator);</span>
<a href="#l11.844"></a><span id="l11.844"> }</span>
<a href="#l11.845"></a><span id="l11.845"> </span>
<a href="#l11.846"></a><span id="l11.846"> NS_IMETHODIMP</span>
<a href="#l11.847"></a><span id="l11.847" class="difflineminus">-nsMsgGroupView::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted,</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineminus">-                             nsMsgKey aParentKey,</span>
<a href="#l11.849"></a><span id="l11.849" class="difflineminus">-                             int32_t aFlags,</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineminus">-                             nsIDBChangeListener *aInstigator)</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineminus">-{</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineplus">+nsMsgGroupView::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineplus">+                             int32_t aFlags, nsIDBChangeListener *aInstigator) {</span>
<a href="#l11.854"></a><span id="l11.854">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineminus">-    return nsMsgDBView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags, aInstigator);</span>
<a href="#l11.856"></a><span id="l11.856" class="difflineplus">+    return nsMsgDBView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags,</span>
<a href="#l11.857"></a><span id="l11.857" class="difflineplus">+                                     aInstigator);</span>
<a href="#l11.858"></a><span id="l11.858"> </span>
<a href="#l11.859"></a><span id="l11.859">   // Check if we're adding a header, and the current day has changed.</span>
<a href="#l11.860"></a><span id="l11.860">   // If it has, we're just going to close and re-open the view so things</span>
<a href="#l11.861"></a><span id="l11.861">   // will be correctly categorized.</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineminus">-  if (m_dayChanged)</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineminus">-    return RebuildView(m_viewFlags);</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineplus">+  if (m_dayChanged) return RebuildView(m_viewFlags);</span>
<a href="#l11.865"></a><span id="l11.865"> </span>
<a href="#l11.866"></a><span id="l11.866" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l11.868"></a><span id="l11.868">   nsMsgKey keyDeleted;</span>
<a href="#l11.869"></a><span id="l11.869">   aHdrDeleted-&gt;GetMessageKey(&amp;keyDeleted);</span>
<a href="#l11.870"></a><span id="l11.870"> </span>
<a href="#l11.871"></a><span id="l11.871">   nsresult rv = GetThreadContainingMsgHdr(aHdrDeleted, getter_AddRefs(thread));</span>
<a href="#l11.872"></a><span id="l11.872">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.873"></a><span id="l11.873">   nsMsgViewIndex viewIndexOfThread =</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineminus">-    GetIndexOfFirstDisplayedKeyInThread(thread, true); // Yes to dummy node.</span>
<a href="#l11.875"></a><span id="l11.875" class="difflineplus">+      GetIndexOfFirstDisplayedKeyInThread(thread, true);  // Yes to dummy node.</span>
<a href="#l11.876"></a><span id="l11.876"> </span>
<a href="#l11.877"></a><span id="l11.877">   thread-&gt;RemoveChildHdr(aHdrDeleted, nullptr);</span>
<a href="#l11.878"></a><span id="l11.878"> </span>
<a href="#l11.879"></a><span id="l11.879">   nsMsgGroupThread *groupThread =</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineminus">-    static_cast&lt;nsMsgGroupThread *&gt;((nsIMsgThread *) thread);</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineplus">+      static_cast&lt;nsMsgGroupThread *&gt;((nsIMsgThread *)thread);</span>
<a href="#l11.882"></a><span id="l11.882"> </span>
<a href="#l11.883"></a><span id="l11.883">   bool rootDeleted = viewIndexOfThread != nsMsgKey_None &amp;&amp;</span>
<a href="#l11.884"></a><span id="l11.884">                      m_keys[viewIndexOfThread] == keyDeleted;</span>
<a href="#l11.885"></a><span id="l11.885">   rv = nsMsgDBView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags, aInstigator);</span>
<a href="#l11.886"></a><span id="l11.886" class="difflineminus">-  if (groupThread-&gt;m_dummy)</span>
<a href="#l11.887"></a><span id="l11.887" class="difflineminus">-  {</span>
<a href="#l11.888"></a><span id="l11.888" class="difflineminus">-    if (!groupThread-&gt;NumRealChildren())</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineminus">-    {</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineplus">+  if (groupThread-&gt;m_dummy) {</span>
<a href="#l11.891"></a><span id="l11.891" class="difflineplus">+    if (!groupThread-&gt;NumRealChildren()) {</span>
<a href="#l11.892"></a><span id="l11.892">       // Get rid of dummy.</span>
<a href="#l11.893"></a><span id="l11.893">       thread-&gt;RemoveChildAt(0);</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineminus">-      if (viewIndexOfThread != nsMsgKey_None)</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineminus">-      {</span>
<a href="#l11.896"></a><span id="l11.896" class="difflineplus">+      if (viewIndexOfThread != nsMsgKey_None) {</span>
<a href="#l11.897"></a><span id="l11.897">         RemoveByIndex(viewIndexOfThread);</span>
<a href="#l11.898"></a><span id="l11.898">         if (m_deletingRows)</span>
<a href="#l11.899"></a><span id="l11.899">           mIndicesToNoteChange.AppendElement(viewIndexOfThread);</span>
<a href="#l11.900"></a><span id="l11.900">       }</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineminus">-    }</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineminus">-    else if (rootDeleted)</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineminus">-    {</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineplus">+    } else if (rootDeleted) {</span>
<a href="#l11.905"></a><span id="l11.905">       // Reflect new thread root into view.dummy row.</span>
<a href="#l11.906"></a><span id="l11.906">       nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l11.907"></a><span id="l11.907">       thread-&gt;GetChildHdrAt(0, getter_AddRefs(hdr));</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineminus">-      if (hdr)</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineminus">-      {</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineplus">+      if (hdr) {</span>
<a href="#l11.911"></a><span id="l11.911">         nsMsgKey msgKey;</span>
<a href="#l11.912"></a><span id="l11.912">         hdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineminus">-        SetMsgHdrAt(hdr, viewIndexOfThread, msgKey, m_flags[viewIndexOfThread], 0);</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineplus">+        SetMsgHdrAt(hdr, viewIndexOfThread, msgKey, m_flags[viewIndexOfThread],</span>
<a href="#l11.915"></a><span id="l11.915" class="difflineplus">+                    0);</span>
<a href="#l11.916"></a><span id="l11.916">       }</span>
<a href="#l11.917"></a><span id="l11.917">     }</span>
<a href="#l11.918"></a><span id="l11.918">   }</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineminus">-  if (!groupThread-&gt;m_keys.Length())</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineminus">-  {</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineplus">+  if (!groupThread-&gt;m_keys.Length()) {</span>
<a href="#l11.922"></a><span id="l11.922">     nsString hashKey;</span>
<a href="#l11.923"></a><span id="l11.923">     rv = HashHdr(aHdrDeleted, hashKey);</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l11.925"></a><span id="l11.925" class="difflineminus">-      m_groupsTable.Remove(hashKey);</span>
<a href="#l11.926"></a><span id="l11.926" class="difflineplus">+    if (NS_SUCCEEDED(rv)) m_groupsTable.Remove(hashKey);</span>
<a href="#l11.927"></a><span id="l11.927">   }</span>
<a href="#l11.928"></a><span id="l11.928">   return rv;</span>
<a href="#l11.929"></a><span id="l11.929"> }</span>
<a href="#l11.930"></a><span id="l11.930"> </span>
<a href="#l11.931"></a><span id="l11.931"> NS_IMETHODIMP</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineminus">-nsMsgGroupView::GetRowProperties(int32_t aRow,</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineminus">-                                 nsAString&amp; aProperties)</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineminus">-{</span>
<a href="#l11.935"></a><span id="l11.935" class="difflineminus">-  if (!IsValidIndex(aRow))</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineplus">+nsMsgGroupView::GetRowProperties(int32_t aRow, nsAString &amp;aProperties) {</span>
<a href="#l11.938"></a><span id="l11.938" class="difflineplus">+  if (!IsValidIndex(aRow)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.939"></a><span id="l11.939"> </span>
<a href="#l11.940"></a><span id="l11.940" class="difflineminus">-  if (m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineminus">-  {</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineplus">+  if (m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY) {</span>
<a href="#l11.943"></a><span id="l11.943">     aProperties.AssignLiteral(&quot;dummy&quot;);</span>
<a href="#l11.944"></a><span id="l11.944">     return NS_OK;</span>
<a href="#l11.945"></a><span id="l11.945">   }</span>
<a href="#l11.946"></a><span id="l11.946"> </span>
<a href="#l11.947"></a><span id="l11.947">   return nsMsgDBView::GetRowProperties(aRow, aProperties);</span>
<a href="#l11.948"></a><span id="l11.948"> }</span>
<a href="#l11.949"></a><span id="l11.949"> </span>
<a href="#l11.950"></a><span id="l11.950"> NS_IMETHODIMP</span>
<a href="#l11.951"></a><span id="l11.951" class="difflineminus">-nsMsgGroupView::GetCellProperties(int32_t aRow,</span>
<a href="#l11.952"></a><span id="l11.952" class="difflineminus">-                                  nsTreeColumn *aCol,</span>
<a href="#l11.953"></a><span id="l11.953" class="difflineminus">-                                  nsAString&amp; aProperties)</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineminus">-{</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineminus">-  if (!IsValidIndex(aRow))</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineplus">+nsMsgGroupView::GetCellProperties(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineplus">+                                  nsAString &amp;aProperties) {</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineplus">+  if (!IsValidIndex(aRow)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.960"></a><span id="l11.960"> </span>
<a href="#l11.961"></a><span id="l11.961" class="difflineminus">-  if (m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineminus">-  {</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineplus">+  if (m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY) {</span>
<a href="#l11.964"></a><span id="l11.964">     aProperties.AssignLiteral(&quot;dummy read&quot;);</span>
<a href="#l11.965"></a><span id="l11.965"> </span>
<a href="#l11.966"></a><span id="l11.966" class="difflineminus">-    if (!(m_flags[aRow] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineminus">-      return NS_OK;</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineplus">+    if (!(m_flags[aRow] &amp; nsMsgMessageFlags::Elided)) return NS_OK;</span>
<a href="#l11.969"></a><span id="l11.969"> </span>
<a href="#l11.970"></a><span id="l11.970">     // Set unread property if a collapsed group thread has unread.</span>
<a href="#l11.971"></a><span id="l11.971" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.972"></a><span id="l11.972" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.973"></a><span id="l11.973">     nsresult rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l11.974"></a><span id="l11.974">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.975"></a><span id="l11.975">     nsString hashKey;</span>
<a href="#l11.976"></a><span id="l11.976">     rv = HashHdr(msgHdr, hashKey);</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l11.978"></a><span id="l11.978" class="difflineminus">-      return NS_OK;</span>
<a href="#l11.979"></a><span id="l11.979" class="difflineplus">+    if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l11.980"></a><span id="l11.980"> </span>
<a href="#l11.981"></a><span id="l11.981">     nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l11.982"></a><span id="l11.982">     m_groupsTable.Get(hashKey, getter_AddRefs(msgThread));</span>
<a href="#l11.983"></a><span id="l11.983" class="difflineminus">-    nsMsgGroupThread *groupThread = static_cast&lt;nsMsgGroupThread *&gt;(msgThread.get());</span>
<a href="#l11.984"></a><span id="l11.984" class="difflineminus">-    if (!groupThread)</span>
<a href="#l11.985"></a><span id="l11.985" class="difflineminus">-      return NS_OK;</span>
<a href="#l11.986"></a><span id="l11.986" class="difflineplus">+    nsMsgGroupThread *groupThread =</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+        static_cast&lt;nsMsgGroupThread *&gt;(msgThread.get());</span>
<a href="#l11.988"></a><span id="l11.988" class="difflineplus">+    if (!groupThread) return NS_OK;</span>
<a href="#l11.989"></a><span id="l11.989"> </span>
<a href="#l11.990"></a><span id="l11.990">     uint32_t numUnrMsg = 0;</span>
<a href="#l11.991"></a><span id="l11.991">     groupThread-&gt;GetNumUnreadChildren(&amp;numUnrMsg);</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineminus">-    if (numUnrMsg &gt; 0)</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineminus">-      aProperties.AppendLiteral(&quot; hasUnread&quot;);</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineplus">+    if (numUnrMsg &gt; 0) aProperties.AppendLiteral(&quot; hasUnread&quot;);</span>
<a href="#l11.995"></a><span id="l11.995"> </span>
<a href="#l11.996"></a><span id="l11.996">     return NS_OK;</span>
<a href="#l11.997"></a><span id="l11.997">   }</span>
<a href="#l11.998"></a><span id="l11.998"> </span>
<a href="#l11.999"></a><span id="l11.999">   return nsMsgDBView::GetCellProperties(aRow, aCol, aProperties);</span>
<a href="#l11.1000"></a><span id="l11.1000"> }</span>
<a href="#l11.1001"></a><span id="l11.1001"> </span>
<a href="#l11.1002"></a><span id="l11.1002"> NS_IMETHODIMP</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineminus">-nsMsgGroupView::CellTextForColumn(int32_t aRow,</span>
<a href="#l11.1004"></a><span id="l11.1004" class="difflineminus">-                                  const nsAString&amp; aColumnName,</span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineplus">+nsMsgGroupView::CellTextForColumn(int32_t aRow, const nsAString &amp;aColumnName,</span>
<a href="#l11.1006"></a><span id="l11.1006">                                   nsAString &amp;aValue) {</span>
<a href="#l11.1007"></a><span id="l11.1007" class="difflineminus">-  if (!IsValidIndex(aRow))</span>
<a href="#l11.1008"></a><span id="l11.1008" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.1009"></a><span id="l11.1009" class="difflineplus">+  if (!IsValidIndex(aRow)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.1010"></a><span id="l11.1010"> </span>
<a href="#l11.1011"></a><span id="l11.1011" class="difflineminus">-  if (!(m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY) || aColumnName.EqualsLiteral(&quot;unreadCol&quot;))</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineplus">+  if (!(m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY) ||</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineplus">+      aColumnName.EqualsLiteral(&quot;unreadCol&quot;))</span>
<a href="#l11.1014"></a><span id="l11.1014">     return nsMsgDBView::CellTextForColumn(aRow, aColumnName, aValue);</span>
<a href="#l11.1015"></a><span id="l11.1015"> </span>
<a href="#l11.1016"></a><span id="l11.1016">   // We only treat &quot;subject&quot; and &quot;total&quot; here.</span>
<a href="#l11.1017"></a><span id="l11.1017">   bool isSubject;</span>
<a href="#l11.1018"></a><span id="l11.1018">   if (!(isSubject = aColumnName.EqualsLiteral(&quot;subjectCol&quot;)) &amp;&amp;</span>
<a href="#l11.1019"></a><span id="l11.1019">       !aColumnName.EqualsLiteral(&quot;totalCol&quot;))</span>
<a href="#l11.1020"></a><span id="l11.1020">     return NS_OK;</span>
<a href="#l11.1021"></a><span id="l11.1021"> </span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.1024"></a><span id="l11.1024">   nsresult rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l11.1025"></a><span id="l11.1025">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1026"></a><span id="l11.1026">   nsString hashKey;</span>
<a href="#l11.1027"></a><span id="l11.1027">   rv = HashHdr(msgHdr, hashKey);</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.1030"></a><span id="l11.1030" class="difflineplus">+  if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l11.1031"></a><span id="l11.1031">   nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l11.1032"></a><span id="l11.1032">   m_groupsTable.Get(hashKey, getter_AddRefs(msgThread));</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineminus">-  nsMsgGroupThread * groupThread = static_cast&lt;nsMsgGroupThread *&gt;(msgThread.get());</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineminus">-  if (isSubject)</span>
<a href="#l11.1035"></a><span id="l11.1035" class="difflineminus">-  {</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineplus">+  nsMsgGroupThread *groupThread =</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineplus">+      static_cast&lt;nsMsgGroupThread *&gt;(msgThread.get());</span>
<a href="#l11.1038"></a><span id="l11.1038" class="difflineplus">+  if (isSubject) {</span>
<a href="#l11.1039"></a><span id="l11.1039">     uint32_t flags;</span>
<a href="#l11.1040"></a><span id="l11.1040">     bool rcvDate = false;</span>
<a href="#l11.1041"></a><span id="l11.1041">     msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l11.1042"></a><span id="l11.1042">     aValue.Truncate();</span>
<a href="#l11.1043"></a><span id="l11.1043">     nsString tmp_str;</span>
<a href="#l11.1044"></a><span id="l11.1044" class="difflineminus">-    switch (m_sortType)</span>
<a href="#l11.1045"></a><span id="l11.1045" class="difflineminus">-    {</span>
<a href="#l11.1046"></a><span id="l11.1046" class="difflineplus">+    switch (m_sortType) {</span>
<a href="#l11.1047"></a><span id="l11.1047">       case nsMsgViewSortType::byReceived:</span>
<a href="#l11.1048"></a><span id="l11.1048">         rcvDate = true;</span>
<a href="#l11.1049"></a><span id="l11.1049">         MOZ_FALLTHROUGH;</span>
<a href="#l11.1050"></a><span id="l11.1050" class="difflineminus">-      case nsMsgViewSortType::byDate:</span>
<a href="#l11.1051"></a><span id="l11.1051" class="difflineminus">-      {</span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineplus">+      case nsMsgViewSortType::byDate: {</span>
<a href="#l11.1053"></a><span id="l11.1053">         uint32_t ageBucket = 0;</span>
<a href="#l11.1054"></a><span id="l11.1054">         GetAgeBucketValue(msgHdr, &amp;ageBucket, rcvDate);</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineminus">-        switch (ageBucket)</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineminus">-        {</span>
<a href="#l11.1057"></a><span id="l11.1057" class="difflineminus">-        case 1:</span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineminus">-          if (m_kTodayString.IsEmpty())</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineminus">-            m_kTodayString.Adopt(GetString(u&quot;today&quot;));</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineplus">+        switch (ageBucket) {</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineplus">+          case 1:</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineplus">+            if (m_kTodayString.IsEmpty())</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineplus">+              m_kTodayString.Adopt(GetString(u&quot;today&quot;));</span>
<a href="#l11.1064"></a><span id="l11.1064"> </span>
<a href="#l11.1065"></a><span id="l11.1065" class="difflineminus">-          aValue.Assign(m_kTodayString);</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineminus">-          break;</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineminus">-        case 2:</span>
<a href="#l11.1068"></a><span id="l11.1068" class="difflineminus">-          if (m_kYesterdayString.IsEmpty())</span>
<a href="#l11.1069"></a><span id="l11.1069" class="difflineminus">-            m_kYesterdayString.Adopt(GetString(u&quot;yesterday&quot;));</span>
<a href="#l11.1070"></a><span id="l11.1070" class="difflineplus">+            aValue.Assign(m_kTodayString);</span>
<a href="#l11.1071"></a><span id="l11.1071" class="difflineplus">+            break;</span>
<a href="#l11.1072"></a><span id="l11.1072" class="difflineplus">+          case 2:</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineplus">+            if (m_kYesterdayString.IsEmpty())</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineplus">+              m_kYesterdayString.Adopt(GetString(u&quot;yesterday&quot;));</span>
<a href="#l11.1075"></a><span id="l11.1075"> </span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineminus">-          aValue.Assign(m_kYesterdayString);</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineminus">-          break;</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineminus">-        case 3:</span>
<a href="#l11.1079"></a><span id="l11.1079" class="difflineminus">-          if (m_kLastWeekString.IsEmpty())</span>
<a href="#l11.1080"></a><span id="l11.1080" class="difflineminus">-            m_kLastWeekString.Adopt(GetString(u&quot;last7Days&quot;));</span>
<a href="#l11.1081"></a><span id="l11.1081" class="difflineplus">+            aValue.Assign(m_kYesterdayString);</span>
<a href="#l11.1082"></a><span id="l11.1082" class="difflineplus">+            break;</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineplus">+          case 3:</span>
<a href="#l11.1084"></a><span id="l11.1084" class="difflineplus">+            if (m_kLastWeekString.IsEmpty())</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineplus">+              m_kLastWeekString.Adopt(GetString(u&quot;last7Days&quot;));</span>
<a href="#l11.1086"></a><span id="l11.1086"> </span>
<a href="#l11.1087"></a><span id="l11.1087" class="difflineminus">-          aValue.Assign(m_kLastWeekString);</span>
<a href="#l11.1088"></a><span id="l11.1088" class="difflineminus">-          break;</span>
<a href="#l11.1089"></a><span id="l11.1089" class="difflineminus">-        case 4:</span>
<a href="#l11.1090"></a><span id="l11.1090" class="difflineminus">-          if (m_kTwoWeeksAgoString.IsEmpty())</span>
<a href="#l11.1091"></a><span id="l11.1091" class="difflineminus">-            m_kTwoWeeksAgoString.Adopt(GetString(u&quot;last14Days&quot;));</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineplus">+            aValue.Assign(m_kLastWeekString);</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineplus">+            break;</span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineplus">+          case 4:</span>
<a href="#l11.1095"></a><span id="l11.1095" class="difflineplus">+            if (m_kTwoWeeksAgoString.IsEmpty())</span>
<a href="#l11.1096"></a><span id="l11.1096" class="difflineplus">+              m_kTwoWeeksAgoString.Adopt(GetString(u&quot;last14Days&quot;));</span>
<a href="#l11.1097"></a><span id="l11.1097"> </span>
<a href="#l11.1098"></a><span id="l11.1098" class="difflineminus">-          aValue.Assign(m_kTwoWeeksAgoString);</span>
<a href="#l11.1099"></a><span id="l11.1099" class="difflineminus">-          break;</span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineminus">-        case 5:</span>
<a href="#l11.1101"></a><span id="l11.1101" class="difflineminus">-          if (m_kOldMailString.IsEmpty())</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineminus">-            m_kOldMailString.Adopt(GetString(u&quot;older&quot;));</span>
<a href="#l11.1103"></a><span id="l11.1103" class="difflineplus">+            aValue.Assign(m_kTwoWeeksAgoString);</span>
<a href="#l11.1104"></a><span id="l11.1104" class="difflineplus">+            break;</span>
<a href="#l11.1105"></a><span id="l11.1105" class="difflineplus">+          case 5:</span>
<a href="#l11.1106"></a><span id="l11.1106" class="difflineplus">+            if (m_kOldMailString.IsEmpty())</span>
<a href="#l11.1107"></a><span id="l11.1107" class="difflineplus">+              m_kOldMailString.Adopt(GetString(u&quot;older&quot;));</span>
<a href="#l11.1108"></a><span id="l11.1108"> </span>
<a href="#l11.1109"></a><span id="l11.1109" class="difflineminus">-          aValue.Assign(m_kOldMailString);</span>
<a href="#l11.1110"></a><span id="l11.1110" class="difflineminus">-          break;</span>
<a href="#l11.1111"></a><span id="l11.1111" class="difflineminus">-        default:</span>
<a href="#l11.1112"></a><span id="l11.1112" class="difflineminus">-          // Future date, error/spoofed.</span>
<a href="#l11.1113"></a><span id="l11.1113" class="difflineminus">-          if (m_kFutureDateString.IsEmpty())</span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineminus">-            m_kFutureDateString.Adopt(GetString(u&quot;futureDate&quot;));</span>
<a href="#l11.1115"></a><span id="l11.1115" class="difflineplus">+            aValue.Assign(m_kOldMailString);</span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineplus">+            break;</span>
<a href="#l11.1117"></a><span id="l11.1117" class="difflineplus">+          default:</span>
<a href="#l11.1118"></a><span id="l11.1118" class="difflineplus">+            // Future date, error/spoofed.</span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineplus">+            if (m_kFutureDateString.IsEmpty())</span>
<a href="#l11.1120"></a><span id="l11.1120" class="difflineplus">+              m_kFutureDateString.Adopt(GetString(u&quot;futureDate&quot;));</span>
<a href="#l11.1121"></a><span id="l11.1121"> </span>
<a href="#l11.1122"></a><span id="l11.1122" class="difflineminus">-          aValue.Assign(m_kFutureDateString);</span>
<a href="#l11.1123"></a><span id="l11.1123" class="difflineminus">-          break;</span>
<a href="#l11.1124"></a><span id="l11.1124" class="difflineplus">+            aValue.Assign(m_kFutureDateString);</span>
<a href="#l11.1125"></a><span id="l11.1125" class="difflineplus">+            break;</span>
<a href="#l11.1126"></a><span id="l11.1126">         }</span>
<a href="#l11.1127"></a><span id="l11.1127">         break;</span>
<a href="#l11.1128"></a><span id="l11.1128">       }</span>
<a href="#l11.1129"></a><span id="l11.1129">       case nsMsgViewSortType::bySubject:</span>
<a href="#l11.1130"></a><span id="l11.1130">         FetchSubject(msgHdr, m_flags[aRow], aValue);</span>
<a href="#l11.1131"></a><span id="l11.1131">         break;</span>
<a href="#l11.1132"></a><span id="l11.1132">       case nsMsgViewSortType::byAuthor:</span>
<a href="#l11.1133"></a><span id="l11.1133">         FetchAuthor(msgHdr, aValue);</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineat">@@ -948,174 +841,152 @@ nsMsgGroupView::CellTextForColumn(int32_</span>
<a href="#l11.1135"></a><span id="l11.1135">         break;</span>
<a href="#l11.1136"></a><span id="l11.1136">       case nsMsgViewSortType::byAccount:</span>
<a href="#l11.1137"></a><span id="l11.1137">         FetchAccount(msgHdr, aValue);</span>
<a href="#l11.1138"></a><span id="l11.1138">         break;</span>
<a href="#l11.1139"></a><span id="l11.1139">       case nsMsgViewSortType::byRecipient:</span>
<a href="#l11.1140"></a><span id="l11.1140">         FetchRecipients(msgHdr, aValue);</span>
<a href="#l11.1141"></a><span id="l11.1141">         break;</span>
<a href="#l11.1142"></a><span id="l11.1142">       case nsMsgViewSortType::byAttachments:</span>
<a href="#l11.1143"></a><span id="l11.1143" class="difflineminus">-        tmp_str.Adopt(GetString(flags &amp; nsMsgMessageFlags::Attachment ?</span>
<a href="#l11.1144"></a><span id="l11.1144" class="difflineminus">-          u&quot;attachments&quot; : u&quot;noAttachments&quot;));</span>
<a href="#l11.1145"></a><span id="l11.1145" class="difflineplus">+        tmp_str.Adopt(GetString(flags &amp; nsMsgMessageFlags::Attachment</span>
<a href="#l11.1146"></a><span id="l11.1146" class="difflineplus">+                                    ? u&quot;attachments&quot;</span>
<a href="#l11.1147"></a><span id="l11.1147" class="difflineplus">+                                    : u&quot;noAttachments&quot;));</span>
<a href="#l11.1148"></a><span id="l11.1148">         aValue.Assign(tmp_str);</span>
<a href="#l11.1149"></a><span id="l11.1149">         break;</span>
<a href="#l11.1150"></a><span id="l11.1150">       case nsMsgViewSortType::byFlagged:</span>
<a href="#l11.1151"></a><span id="l11.1151" class="difflineminus">-        tmp_str.Adopt(GetString(flags &amp; nsMsgMessageFlags::Marked ?</span>
<a href="#l11.1152"></a><span id="l11.1152" class="difflineminus">-          u&quot;groupFlagged&quot; : u&quot;notFlagged&quot;));</span>
<a href="#l11.1153"></a><span id="l11.1153" class="difflineplus">+        tmp_str.Adopt(GetString(flags &amp; nsMsgMessageFlags::Marked</span>
<a href="#l11.1154"></a><span id="l11.1154" class="difflineplus">+                                    ? u&quot;groupFlagged&quot;</span>
<a href="#l11.1155"></a><span id="l11.1155" class="difflineplus">+                                    : u&quot;notFlagged&quot;));</span>
<a href="#l11.1156"></a><span id="l11.1156">         aValue.Assign(tmp_str);</span>
<a href="#l11.1157"></a><span id="l11.1157">         break;</span>
<a href="#l11.1158"></a><span id="l11.1158">       // byLocation is a special case; we don't want to have duplicate</span>
<a href="#l11.1159"></a><span id="l11.1159">       // all this logic in nsMsgSearchDBView, and its hash key is what we</span>
<a href="#l11.1160"></a><span id="l11.1160">       // want anyways, so just copy it across.</span>
<a href="#l11.1161"></a><span id="l11.1161">       case nsMsgViewSortType::byLocation:</span>
<a href="#l11.1162"></a><span id="l11.1162">       case nsMsgViewSortType::byCorrespondent:</span>
<a href="#l11.1163"></a><span id="l11.1163">         aValue = hashKey;</span>
<a href="#l11.1164"></a><span id="l11.1164">         break;</span>
<a href="#l11.1165"></a><span id="l11.1165" class="difflineminus">-      case nsMsgViewSortType::byCustom:</span>
<a href="#l11.1166"></a><span id="l11.1166" class="difflineminus">-      {</span>
<a href="#l11.1167"></a><span id="l11.1167" class="difflineminus">-        nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l11.1168"></a><span id="l11.1168" class="difflineminus">-        if (colHandler)</span>
<a href="#l11.1169"></a><span id="l11.1169" class="difflineminus">-        {</span>
<a href="#l11.1170"></a><span id="l11.1170" class="difflineplus">+      case nsMsgViewSortType::byCustom: {</span>
<a href="#l11.1171"></a><span id="l11.1171" class="difflineplus">+        nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l11.1172"></a><span id="l11.1172" class="difflineplus">+        if (colHandler) {</span>
<a href="#l11.1173"></a><span id="l11.1173">           bool isString;</span>
<a href="#l11.1174"></a><span id="l11.1174">           colHandler-&gt;IsString(&amp;isString);</span>
<a href="#l11.1175"></a><span id="l11.1175" class="difflineminus">-          if (isString)</span>
<a href="#l11.1176"></a><span id="l11.1176" class="difflineminus">-          {</span>
<a href="#l11.1177"></a><span id="l11.1177" class="difflineplus">+          if (isString) {</span>
<a href="#l11.1178"></a><span id="l11.1178">             rv = colHandler-&gt;GetSortStringForRow(msgHdr.get(), aValue);</span>
<a href="#l11.1179"></a><span id="l11.1179" class="difflineminus">-          }</span>
<a href="#l11.1180"></a><span id="l11.1180" class="difflineminus">-          else</span>
<a href="#l11.1181"></a><span id="l11.1181" class="difflineminus">-          {</span>
<a href="#l11.1182"></a><span id="l11.1182" class="difflineplus">+          } else {</span>
<a href="#l11.1183"></a><span id="l11.1183">             uint32_t intKey;</span>
<a href="#l11.1184"></a><span id="l11.1184">             rv = colHandler-&gt;GetSortLongForRow(msgHdr.get(), &amp;intKey);</span>
<a href="#l11.1185"></a><span id="l11.1185">             aValue.AppendInt(intKey);</span>
<a href="#l11.1186"></a><span id="l11.1186">           }</span>
<a href="#l11.1187"></a><span id="l11.1187">         }</span>
<a href="#l11.1188"></a><span id="l11.1188" class="difflineminus">-        if (aValue.IsEmpty())</span>
<a href="#l11.1189"></a><span id="l11.1189" class="difflineminus">-          aValue.Assign('*');</span>
<a href="#l11.1190"></a><span id="l11.1190" class="difflineplus">+        if (aValue.IsEmpty()) aValue.Assign('*');</span>
<a href="#l11.1191"></a><span id="l11.1191">         break;</span>
<a href="#l11.1192"></a><span id="l11.1192">       }</span>
<a href="#l11.1193"></a><span id="l11.1193"> </span>
<a href="#l11.1194"></a><span id="l11.1194">       default:</span>
<a href="#l11.1195"></a><span id="l11.1195">         NS_ASSERTION(false, &quot;we don't sort by group for this type&quot;);</span>
<a href="#l11.1196"></a><span id="l11.1196">         break;</span>
<a href="#l11.1197"></a><span id="l11.1197">     }</span>
<a href="#l11.1198"></a><span id="l11.1198"> </span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineminus">-    if (groupThread)</span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineminus">-    {</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineplus">+    if (groupThread) {</span>
<a href="#l11.1202"></a><span id="l11.1202">       // Get number of messages in group.</span>
<a href="#l11.1203"></a><span id="l11.1203">       nsAutoString formattedCountMsg;</span>
<a href="#l11.1204"></a><span id="l11.1204">       uint32_t numMsg = groupThread-&gt;NumRealChildren();</span>
<a href="#l11.1205"></a><span id="l11.1205">       formattedCountMsg.AppendInt(numMsg);</span>
<a href="#l11.1206"></a><span id="l11.1206"> </span>
<a href="#l11.1207"></a><span id="l11.1207">       // Get number of unread messages.</span>
<a href="#l11.1208"></a><span id="l11.1208">       nsAutoString formattedCountUnrMsg;</span>
<a href="#l11.1209"></a><span id="l11.1209">       uint32_t numUnrMsg = 0;</span>
<a href="#l11.1210"></a><span id="l11.1210">       groupThread-&gt;GetNumUnreadChildren(&amp;numUnrMsg);</span>
<a href="#l11.1211"></a><span id="l11.1211">       formattedCountUnrMsg.AppendInt(numUnrMsg);</span>
<a href="#l11.1212"></a><span id="l11.1212"> </span>
<a href="#l11.1213"></a><span id="l11.1213">       // Add text to header.</span>
<a href="#l11.1214"></a><span id="l11.1214">       aValue.AppendLiteral(u&quot; (&quot;);</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineminus">-      if (numUnrMsg)</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineminus">-      {</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineplus">+      if (numUnrMsg) {</span>
<a href="#l11.1218"></a><span id="l11.1218">         aValue.Append(formattedCountUnrMsg);</span>
<a href="#l11.1219"></a><span id="l11.1219">         aValue.Append(u'/');</span>
<a href="#l11.1220"></a><span id="l11.1220">       }</span>
<a href="#l11.1221"></a><span id="l11.1221"> </span>
<a href="#l11.1222"></a><span id="l11.1222">       aValue.Append(formattedCountMsg);</span>
<a href="#l11.1223"></a><span id="l11.1223">       aValue.Append(u')');</span>
<a href="#l11.1224"></a><span id="l11.1224">     }</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineminus">-  }</span>
<a href="#l11.1226"></a><span id="l11.1226" class="difflineminus">-  else</span>
<a href="#l11.1227"></a><span id="l11.1227" class="difflineminus">-  {</span>
<a href="#l11.1228"></a><span id="l11.1228" class="difflineplus">+  } else {</span>
<a href="#l11.1229"></a><span id="l11.1229">     nsAutoString formattedCountString;</span>
<a href="#l11.1230"></a><span id="l11.1230">     uint32_t numChildren = (groupThread) ? groupThread-&gt;NumRealChildren() : 0;</span>
<a href="#l11.1231"></a><span id="l11.1231">     formattedCountString.AppendInt(numChildren);</span>
<a href="#l11.1232"></a><span id="l11.1232">     aValue.Assign(formattedCountString);</span>
<a href="#l11.1233"></a><span id="l11.1233">   }</span>
<a href="#l11.1234"></a><span id="l11.1234">   return NS_OK;</span>
<a href="#l11.1235"></a><span id="l11.1235"> }</span>
<a href="#l11.1236"></a><span id="l11.1236"> </span>
<a href="#l11.1237"></a><span id="l11.1237"> NS_IMETHODIMP</span>
<a href="#l11.1238"></a><span id="l11.1238" class="difflineminus">-nsMsgGroupView::LoadMessageByViewIndex(nsMsgViewIndex aViewIndex)</span>
<a href="#l11.1239"></a><span id="l11.1239" class="difflineminus">-{</span>
<a href="#l11.1240"></a><span id="l11.1240" class="difflineminus">-  if (!IsValidIndex(aViewIndex))</span>
<a href="#l11.1241"></a><span id="l11.1241" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.1242"></a><span id="l11.1242" class="difflineplus">+nsMsgGroupView::LoadMessageByViewIndex(nsMsgViewIndex aViewIndex) {</span>
<a href="#l11.1243"></a><span id="l11.1243" class="difflineplus">+  if (!IsValidIndex(aViewIndex)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l11.1244"></a><span id="l11.1244"> </span>
<a href="#l11.1245"></a><span id="l11.1245" class="difflineminus">-  if (m_flags[aViewIndex] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l11.1246"></a><span id="l11.1246" class="difflineminus">-  {</span>
<a href="#l11.1247"></a><span id="l11.1247" class="difflineplus">+  if (m_flags[aViewIndex] &amp; MSG_VIEW_FLAG_DUMMY) {</span>
<a href="#l11.1248"></a><span id="l11.1248">     // If we used to have one item selected, and now we have more than one,</span>
<a href="#l11.1249"></a><span id="l11.1249">     // we should clear the message pane.</span>
<a href="#l11.1250"></a><span id="l11.1250">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l11.1251"></a><span id="l11.1251" class="difflineminus">-    nsCOMPtr &lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l11.1252"></a><span id="l11.1252" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l11.1253"></a><span id="l11.1253">     if (msgWindow &amp;&amp;</span>
<a href="#l11.1254"></a><span id="l11.1254" class="difflineminus">-        NS_SUCCEEDED(msgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands))) &amp;&amp;</span>
<a href="#l11.1255"></a><span id="l11.1255" class="difflineminus">-        windowCommands)</span>
<a href="#l11.1256"></a><span id="l11.1256" class="difflineminus">-    {</span>
<a href="#l11.1257"></a><span id="l11.1257" class="difflineplus">+        NS_SUCCEEDED(</span>
<a href="#l11.1258"></a><span id="l11.1258" class="difflineplus">+            msgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands))) &amp;&amp;</span>
<a href="#l11.1259"></a><span id="l11.1259" class="difflineplus">+        windowCommands) {</span>
<a href="#l11.1260"></a><span id="l11.1260">       windowCommands-&gt;ClearMsgPane();</span>
<a href="#l11.1261"></a><span id="l11.1261">     }</span>
<a href="#l11.1262"></a><span id="l11.1262"> </span>
<a href="#l11.1263"></a><span id="l11.1263">     // Since we are selecting a dummy row, we should also clear out</span>
<a href="#l11.1264"></a><span id="l11.1264">     // m_currentlyDisplayedMsgUri.</span>
<a href="#l11.1265"></a><span id="l11.1265">     m_currentlyDisplayedMsgUri.Truncate();</span>
<a href="#l11.1266"></a><span id="l11.1266">     return NS_OK;</span>
<a href="#l11.1267"></a><span id="l11.1267" class="difflineminus">-  }</span>
<a href="#l11.1268"></a><span id="l11.1268" class="difflineminus">-  else</span>
<a href="#l11.1269"></a><span id="l11.1269" class="difflineminus">-  {</span>
<a href="#l11.1270"></a><span id="l11.1270" class="difflineplus">+  } else {</span>
<a href="#l11.1271"></a><span id="l11.1271">     return nsMsgDBView::LoadMessageByViewIndex(aViewIndex);</span>
<a href="#l11.1272"></a><span id="l11.1272">   }</span>
<a href="#l11.1273"></a><span id="l11.1273"> }</span>
<a href="#l11.1274"></a><span id="l11.1274"> </span>
<a href="#l11.1275"></a><span id="l11.1275"> NS_IMETHODIMP</span>
<a href="#l11.1276"></a><span id="l11.1276"> nsMsgGroupView::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l11.1277"></a><span id="l11.1277" class="difflineminus">-                                          nsIMsgThread **pThread)</span>
<a href="#l11.1278"></a><span id="l11.1278" class="difflineminus">-{</span>
<a href="#l11.1279"></a><span id="l11.1279" class="difflineplus">+                                          nsIMsgThread **pThread) {</span>
<a href="#l11.1280"></a><span id="l11.1280">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l11.1281"></a><span id="l11.1281">     return nsMsgDBView::GetThreadContainingMsgHdr(msgHdr, pThread);</span>
<a href="#l11.1282"></a><span id="l11.1282"> </span>
<a href="#l11.1283"></a><span id="l11.1283">   nsString hashKey;</span>
<a href="#l11.1284"></a><span id="l11.1284">   nsresult rv = HashHdr(msgHdr, hashKey);</span>
<a href="#l11.1285"></a><span id="l11.1285">   *pThread = nullptr;</span>
<a href="#l11.1286"></a><span id="l11.1286" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l11.1287"></a><span id="l11.1287" class="difflineminus">-  {</span>
<a href="#l11.1288"></a><span id="l11.1288" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.1289"></a><span id="l11.1289">     nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l11.1290"></a><span id="l11.1290">     m_groupsTable.Get(hashKey, getter_AddRefs(thread));</span>
<a href="#l11.1291"></a><span id="l11.1291">     thread.forget(pThread);</span>
<a href="#l11.1292"></a><span id="l11.1292">   }</span>
<a href="#l11.1293"></a><span id="l11.1293"> </span>
<a href="#l11.1294"></a><span id="l11.1294">   return (*pThread) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l11.1295"></a><span id="l11.1295"> }</span>
<a href="#l11.1296"></a><span id="l11.1296"> </span>
<a href="#l11.1297"></a><span id="l11.1297" class="difflineminus">-int32_t</span>
<a href="#l11.1298"></a><span id="l11.1298" class="difflineminus">-nsMsgGroupView::FindLevelInThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l11.1299"></a><span id="l11.1299" class="difflineminus">-                                  nsMsgViewIndex startOfThread,</span>
<a href="#l11.1300"></a><span id="l11.1300" class="difflineminus">-                                  nsMsgViewIndex viewIndex)</span>
<a href="#l11.1301"></a><span id="l11.1301" class="difflineminus">-{</span>
<a href="#l11.1302"></a><span id="l11.1302" class="difflineplus">+int32_t nsMsgGroupView::FindLevelInThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l11.1303"></a><span id="l11.1303" class="difflineplus">+                                          nsMsgViewIndex startOfThread,</span>
<a href="#l11.1304"></a><span id="l11.1304" class="difflineplus">+                                          nsMsgViewIndex viewIndex) {</span>
<a href="#l11.1305"></a><span id="l11.1305">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l11.1306"></a><span id="l11.1306">     return nsMsgDBView::FindLevelInThread(msgHdr, startOfThread, viewIndex);</span>
<a href="#l11.1307"></a><span id="l11.1307"> </span>
<a href="#l11.1308"></a><span id="l11.1308">   return (startOfThread == viewIndex) ? 0 : 1;</span>
<a href="#l11.1309"></a><span id="l11.1309"> }</span>
<a href="#l11.1310"></a><span id="l11.1310"> </span>
<a href="#l11.1311"></a><span id="l11.1311" class="difflineminus">-bool</span>
<a href="#l11.1312"></a><span id="l11.1312" class="difflineminus">-nsMsgGroupView::GroupViewUsesDummyRow()</span>
<a href="#l11.1313"></a><span id="l11.1313" class="difflineminus">-{</span>
<a href="#l11.1314"></a><span id="l11.1314" class="difflineplus">+bool nsMsgGroupView::GroupViewUsesDummyRow() {</span>
<a href="#l11.1315"></a><span id="l11.1315">   // Return true to always use a header row as root grouped parent row.</span>
<a href="#l11.1316"></a><span id="l11.1316">   return true;</span>
<a href="#l11.1317"></a><span id="l11.1317"> }</span>
<a href="#l11.1318"></a><span id="l11.1318"> </span>
<a href="#l11.1319"></a><span id="l11.1319"> NS_IMETHODIMP</span>
<a href="#l11.1320"></a><span id="l11.1320" class="difflineminus">-nsMsgGroupView::AddColumnHandler(const nsAString&amp; column,</span>
<a href="#l11.1321"></a><span id="l11.1321" class="difflineminus">-                                 nsIMsgCustomColumnHandler* handler)</span>
<a href="#l11.1322"></a><span id="l11.1322" class="difflineminus">-{</span>
<a href="#l11.1323"></a><span id="l11.1323" class="difflineplus">+nsMsgGroupView::AddColumnHandler(const nsAString &amp;column,</span>
<a href="#l11.1324"></a><span id="l11.1324" class="difflineplus">+                                 nsIMsgCustomColumnHandler *handler) {</span>
<a href="#l11.1325"></a><span id="l11.1325">   nsMsgDBView::AddColumnHandler(column, handler);</span>
<a href="#l11.1326"></a><span id="l11.1326"> </span>
<a href="#l11.1327"></a><span id="l11.1327">   // If the sortType is byCustom and the desired custom column is the one just</span>
<a href="#l11.1328"></a><span id="l11.1328">   // registered, build the view.</span>
<a href="#l11.1329"></a><span id="l11.1329">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort &amp;&amp;</span>
<a href="#l11.1330"></a><span id="l11.1330" class="difflineminus">-      m_sortType == nsMsgViewSortType::byCustom)</span>
<a href="#l11.1331"></a><span id="l11.1331" class="difflineminus">-  {</span>
<a href="#l11.1332"></a><span id="l11.1332" class="difflineplus">+      m_sortType == nsMsgViewSortType::byCustom) {</span>
<a href="#l11.1333"></a><span id="l11.1333">     nsAutoString curCustomColumn;</span>
<a href="#l11.1334"></a><span id="l11.1334">     GetCurCustomColumn(curCustomColumn);</span>
<a href="#l11.1335"></a><span id="l11.1335" class="difflineminus">-    if (curCustomColumn == column)</span>
<a href="#l11.1336"></a><span id="l11.1336" class="difflineminus">-      RebuildView(m_viewFlags);</span>
<a href="#l11.1337"></a><span id="l11.1337" class="difflineplus">+    if (curCustomColumn == column) RebuildView(m_viewFlags);</span>
<a href="#l11.1338"></a><span id="l11.1338">   }</span>
<a href="#l11.1339"></a><span id="l11.1339"> </span>
<a href="#l11.1340"></a><span id="l11.1340">   return NS_OK;</span>
<a href="#l11.1341"></a><span id="l11.1341"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupView.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupView.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -11,63 +11,76 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> class nsIMsgThread;</span>
<a href="#l12.7"></a><span id="l12.7"> class nsMsgGroupThread;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> // Please note that if you override a method of nsMsgDBView,</span>
<a href="#l12.10"></a><span id="l12.10"> // you will most likely want to check the m_viewFlags to see if</span>
<a href="#l12.11"></a><span id="l12.11"> // we're grouping, and if not, call the base class implementation.</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-class nsMsgGroupView : public nsMsgDBView</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-public:</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+class nsMsgGroupView : public nsMsgDBView {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ public:</span>
<a href="#l12.17"></a><span id="l12.17">   nsMsgGroupView();</span>
<a href="#l12.18"></a><span id="l12.18">   virtual ~nsMsgGroupView();</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-                  nsMsgViewSortOrderValue sortOrder, nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-                  int32_t *pCount) override;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders, nsMsgViewSortTypeValue aSortType,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-                                        nsMsgViewSortOrderValue aSortOrder, nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-                                        int32_t *aCount) override;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+                  nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+                          nsMsgViewSortTypeValue aSortType,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+                          nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+                          nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+                          int32_t *aCount) override;</span>
<a href="#l12.33"></a><span id="l12.33">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-                        nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+                        nsIMessenger *aMessengerInstance,</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+                        nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l12.40"></a><span id="l12.40">   NS_IMETHOD Close() override;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-  NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+                          int32_t aFlags,</span>
<a href="#l12.44"></a><span id="l12.44">                           nsIDBChangeListener *aInstigator) override;</span>
<a href="#l12.45"></a><span id="l12.45">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-                               uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+                               uint32_t aNewFlags,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+                               nsIDBChangeListener *aInstigator) override;</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50">   NS_IMETHOD LoadMessageByViewIndex(nsMsgViewIndex aViewIndex) override;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  NS_IMETHOD GetCellProperties(int32_t aRow, nsTreeColumn *aCol, nsAString&amp; aProperties) override;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-  NS_IMETHOD GetRowProperties(int32_t aRow, nsAString&amp; aProperties) override;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-  NS_IMETHOD CellTextForColumn(int32_t aRow, const nsAString&amp; aColumnName,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  NS_IMETHOD GetCellProperties(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+                               nsAString &amp;aProperties) override;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+  NS_IMETHOD GetRowProperties(int32_t aRow, nsAString &amp;aProperties) override;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  NS_IMETHOD CellTextForColumn(int32_t aRow, const nsAString &amp;aColumnName,</span>
<a href="#l12.58"></a><span id="l12.58">                                nsAString &amp;aValue) override;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-  NS_IMETHOD GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread) override;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-  NS_IMETHOD AddColumnHandler(const nsAString&amp; column, nsIMsgCustomColumnHandler* handler) override;</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+  NS_IMETHOD GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+                                       nsIMsgThread **pThread) override;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  NS_IMETHOD AddColumnHandler(const nsAString &amp;column,</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+                              nsIMsgCustomColumnHandler *handler) override;</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-protected:</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+ protected:</span>
<a href="#l12.68"></a><span id="l12.68">   virtual void InternalClose();</span>
<a href="#l12.69"></a><span id="l12.69">   nsMsgGroupThread *AddHdrToThread(nsIMsgDBHdr *msgHdr, bool *pNewThread);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-  virtual nsresult HashHdr(nsIMsgDBHdr *msgHdr, nsString&amp; aHashKey);</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-  nsresult GetAgeBucketValue(nsIMsgDBHdr *aMsgHdr, uint32_t * aAgeBucket, bool rcvDate = false); // helper function to get the age bucket for a hdr, useful when grouped by date</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-  nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool /*ensureListed*/) override;</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-  virtual int32_t FindLevelInThread(nsIMsgDBHdr *msgHdr, nsMsgViewIndex startOfThread, nsMsgViewIndex viewIndex) override;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  virtual nsresult HashHdr(nsIMsgDBHdr *msgHdr, nsString &amp;aHashKey);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+  // Helper function to get age bucket for a hdr, useful when grouped by date.</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+  nsresult GetAgeBucketValue(nsIMsgDBHdr *aMsgHdr, uint32_t *aAgeBucket,</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+                             bool rcvDate = false);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey,</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+                       bool /*ensureListed*/) override;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  virtual int32_t FindLevelInThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+                                    nsMsgViewIndex startOfThread,</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+                                    nsMsgViewIndex viewIndex) override;</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84">   // Returns true if we are grouped by a sort attribute that uses a dummy row.</span>
<a href="#l12.85"></a><span id="l12.85">   bool GroupViewUsesDummyRow();</span>
<a href="#l12.86"></a><span id="l12.86">   nsresult RebuildView(nsMsgViewFlagsTypeValue viewFlags);</span>
<a href="#l12.87"></a><span id="l12.87">   virtual nsMsgGroupThread *CreateGroupThread(nsIMsgDatabase *db);</span>
<a href="#l12.88"></a><span id="l12.88"> </span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-  nsInterfaceHashtable &lt;nsStringHashKey, nsIMsgThread&gt; m_groupsTable;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  nsInterfaceHashtable&lt;nsStringHashKey, nsIMsgThread&gt; m_groupsTable;</span>
<a href="#l12.91"></a><span id="l12.91">   PRExplodedTime m_lastCurExplodedTime;</span>
<a href="#l12.92"></a><span id="l12.92">   bool m_dayChanged;</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-private:</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+ private:</span>
<a href="#l12.96"></a><span id="l12.96">   nsString m_kTodayString;</span>
<a href="#l12.97"></a><span id="l12.97">   nsString m_kYesterdayString;</span>
<a href="#l12.98"></a><span id="l12.98">   nsString m_kLastWeekString;</span>
<a href="#l12.99"></a><span id="l12.99">   nsString m_kTwoWeeksAgoString;</span>
<a href="#l12.100"></a><span id="l12.100">   nsString m_kOldMailString;</span>
<a href="#l12.101"></a><span id="l12.101">   nsString m_kFutureDateString;</span>
<a href="#l12.102"></a><span id="l12.102"> };</span>
<a href="#l12.103"></a><span id="l12.103"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.5"></a><span id="l13.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-#include &quot;msgCore.h&quot; // for pre-compiled headers</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12"> #include &quot;nsMsgMailSession.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsIChromeRegistry.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> #include &quot;nsIDirectoryService.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineat">@@ -29,59 +29,47 @@</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21"> #include &quot;nsIProperties.h&quot;</span>
<a href="#l13.22"></a><span id="l13.22"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.23"></a><span id="l13.23"> #include &quot;mozilla/dom/Element.h&quot;</span>
<a href="#l13.24"></a><span id="l13.24"> #include &quot;mozilla/Components.h&quot;</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26"> NS_IMPL_ISUPPORTS(nsMsgMailSession, nsIMsgMailSession, nsIFolderListener)</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-nsMsgMailSession::nsMsgMailSession()</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-{</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-}</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+nsMsgMailSession::nsMsgMailSession() {}</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-nsMsgMailSession::~nsMsgMailSession()</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-{</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  Shutdown();</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-}</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+nsMsgMailSession::~nsMsgMailSession() { Shutdown(); }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-nsresult nsMsgMailSession::Init()</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-{</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+nsresult nsMsgMailSession::Init() {</span>
<a href="#l13.43"></a><span id="l13.43">   // Ensures the shutdown service is initialised</span>
<a href="#l13.44"></a><span id="l13.44">   nsresult rv;</span>
<a href="#l13.45"></a><span id="l13.45">   nsCOMPtr&lt;nsIMsgShutdownService&gt; shutdownService =</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-    do_GetService(NS_MSGSHUTDOWNSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+      do_GetService(NS_MSGSHUTDOWNSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l13.48"></a><span id="l13.48">   return rv;</span>
<a href="#l13.49"></a><span id="l13.49"> }</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-nsresult nsMsgMailSession::Shutdown()</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-{</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-}</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+nsresult nsMsgMailSession::Shutdown() { return NS_OK; }</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57"> NS_IMETHODIMP nsMsgMailSession::AddFolderListener(nsIFolderListener *aListener,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-                                                  uint32_t aNotifyFlags)</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-{</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+                                                  uint32_t aNotifyFlags) {</span>
<a href="#l13.61"></a><span id="l13.61">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63">   // we don't care about the notification flags for equivalence purposes</span>
<a href="#l13.64"></a><span id="l13.64">   size_t index = mListeners.IndexOf(aListener);</span>
<a href="#l13.65"></a><span id="l13.65">   NS_ASSERTION(index == size_t(-1), &quot;tried to add duplicate listener&quot;);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-  if (index == size_t(-1))</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-  {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  if (index == size_t(-1)) {</span>
<a href="#l13.69"></a><span id="l13.69">     folderListener newListener(aListener, aNotifyFlags);</span>
<a href="#l13.70"></a><span id="l13.70">     mListeners.AppendElement(newListener);</span>
<a href="#l13.71"></a><span id="l13.71">   }</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73">   return NS_OK;</span>
<a href="#l13.74"></a><span id="l13.74"> }</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-NS_IMETHODIMP nsMsgMailSession::RemoveFolderListener(nsIFolderListener *aListener)</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-{</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+NS_IMETHODIMP nsMsgMailSession::RemoveFolderListener(</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    nsIFolderListener *aListener) {</span>
<a href="#l13.80"></a><span id="l13.80">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82">   mListeners.RemoveElement(aListener);</span>
<a href="#l13.83"></a><span id="l13.83">   return NS_OK;</span>
<a href="#l13.84"></a><span id="l13.84"> }</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86"> #define NOTIFY_FOLDER_LISTENERS(propertyflag_, propertyfunc_, params_) \</span>
<a href="#l13.87"></a><span id="l13.87">   PR_BEGIN_MACRO                                                       \</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineat">@@ -91,341 +79,315 @@ NS_IMETHODIMP nsMsgMailSession::RemoveFo</span>
<a href="#l13.89"></a><span id="l13.89">     if (fL.mNotifyFlags &amp; nsIFolderListener::propertyflag_)            \</span>
<a href="#l13.90"></a><span id="l13.90">       fL.mListener-&gt;propertyfunc_ params_;                             \</span>
<a href="#l13.91"></a><span id="l13.91">   }                                                                    \</span>
<a href="#l13.92"></a><span id="l13.92">   PR_END_MACRO</span>
<a href="#l13.93"></a><span id="l13.93"> </span>
<a href="#l13.94"></a><span id="l13.94"> NS_IMETHODIMP</span>
<a href="#l13.95"></a><span id="l13.95"> nsMsgMailSession::OnItemPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l13.96"></a><span id="l13.96">                                         const nsACString &amp;aProperty,</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-                                        const char* aOldValue,</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-                                        const char* aNewValue)</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-{</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+                                        const char *aOldValue,</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+                                        const char *aNewValue) {</span>
<a href="#l13.102"></a><span id="l13.102">   NOTIFY_FOLDER_LISTENERS(propertyChanged, OnItemPropertyChanged,</span>
<a href="#l13.103"></a><span id="l13.103">                           (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l13.104"></a><span id="l13.104">   return NS_OK;</span>
<a href="#l13.105"></a><span id="l13.105"> }</span>
<a href="#l13.106"></a><span id="l13.106"> </span>
<a href="#l13.107"></a><span id="l13.107"> NS_IMETHODIMP</span>
<a href="#l13.108"></a><span id="l13.108"> nsMsgMailSession::OnItemUnicharPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l13.109"></a><span id="l13.109">                                                const nsACString &amp;aProperty,</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-                                               const char16_t* aOldValue,</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-                                               const char16_t* aNewValue)</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-{</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+                                               const char16_t *aOldValue,</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+                                               const char16_t *aNewValue) {</span>
<a href="#l13.115"></a><span id="l13.115">   NOTIFY_FOLDER_LISTENERS(unicharPropertyChanged, OnItemUnicharPropertyChanged,</span>
<a href="#l13.116"></a><span id="l13.116">                           (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l13.117"></a><span id="l13.117">   return NS_OK;</span>
<a href="#l13.118"></a><span id="l13.118"> }</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120"> NS_IMETHODIMP</span>
<a href="#l13.121"></a><span id="l13.121"> nsMsgMailSession::OnItemIntPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l13.122"></a><span id="l13.122">                                            const nsACString &amp;aProperty,</span>
<a href="#l13.123"></a><span id="l13.123">                                            int64_t aOldValue,</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-                                           int64_t aNewValue)</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-{</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+                                           int64_t aNewValue) {</span>
<a href="#l13.127"></a><span id="l13.127">   NOTIFY_FOLDER_LISTENERS(intPropertyChanged, OnItemIntPropertyChanged,</span>
<a href="#l13.128"></a><span id="l13.128">                           (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l13.129"></a><span id="l13.129">   return NS_OK;</span>
<a href="#l13.130"></a><span id="l13.130"> }</span>
<a href="#l13.131"></a><span id="l13.131"> </span>
<a href="#l13.132"></a><span id="l13.132"> NS_IMETHODIMP</span>
<a href="#l13.133"></a><span id="l13.133"> nsMsgMailSession::OnItemBoolPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l13.134"></a><span id="l13.134">                                             const nsACString &amp;aProperty,</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-                                            bool aOldValue,</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-                                            bool aNewValue)</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-{</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+                                            bool aOldValue, bool aNewValue) {</span>
<a href="#l13.139"></a><span id="l13.139">   NOTIFY_FOLDER_LISTENERS(boolPropertyChanged, OnItemBoolPropertyChanged,</span>
<a href="#l13.140"></a><span id="l13.140">                           (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l13.141"></a><span id="l13.141">   return NS_OK;</span>
<a href="#l13.142"></a><span id="l13.142"> }</span>
<a href="#l13.143"></a><span id="l13.143"> </span>
<a href="#l13.144"></a><span id="l13.144"> NS_IMETHODIMP</span>
<a href="#l13.145"></a><span id="l13.145"> nsMsgMailSession::OnItemPropertyFlagChanged(nsIMsgDBHdr *aItem,</span>
<a href="#l13.146"></a><span id="l13.146">                                             const nsACString &amp;aProperty,</span>
<a href="#l13.147"></a><span id="l13.147">                                             uint32_t aOldValue,</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-                                            uint32_t aNewValue)</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-{</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+                                            uint32_t aNewValue) {</span>
<a href="#l13.151"></a><span id="l13.151">   NOTIFY_FOLDER_LISTENERS(propertyFlagChanged, OnItemPropertyFlagChanged,</span>
<a href="#l13.152"></a><span id="l13.152">                           (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l13.153"></a><span id="l13.153">   return NS_OK;</span>
<a href="#l13.154"></a><span id="l13.154"> }</span>
<a href="#l13.155"></a><span id="l13.155"> </span>
<a href="#l13.156"></a><span id="l13.156"> NS_IMETHODIMP nsMsgMailSession::OnItemAdded(nsIMsgFolder *aParentItem,</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-                                            nsISupports *aItem)</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-{</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+                                            nsISupports *aItem) {</span>
<a href="#l13.160"></a><span id="l13.160">   NOTIFY_FOLDER_LISTENERS(added, OnItemAdded, (aParentItem, aItem));</span>
<a href="#l13.161"></a><span id="l13.161">   return NS_OK;</span>
<a href="#l13.162"></a><span id="l13.162"> }</span>
<a href="#l13.163"></a><span id="l13.163"> </span>
<a href="#l13.164"></a><span id="l13.164"> NS_IMETHODIMP nsMsgMailSession::OnItemRemoved(nsIMsgFolder *aParentItem,</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-                                              nsISupports *aItem)</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-{</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+                                              nsISupports *aItem) {</span>
<a href="#l13.168"></a><span id="l13.168">   NOTIFY_FOLDER_LISTENERS(removed, OnItemRemoved, (aParentItem, aItem));</span>
<a href="#l13.169"></a><span id="l13.169">   return NS_OK;</span>
<a href="#l13.170"></a><span id="l13.170"> }</span>
<a href="#l13.171"></a><span id="l13.171"> </span>
<a href="#l13.172"></a><span id="l13.172"> NS_IMETHODIMP nsMsgMailSession::OnItemEvent(nsIMsgFolder *aFolder,</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-                                            const nsACString &amp;aEvent)</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-{</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+                                            const nsACString &amp;aEvent) {</span>
<a href="#l13.176"></a><span id="l13.176">   NOTIFY_FOLDER_LISTENERS(event, OnItemEvent, (aFolder, aEvent));</span>
<a href="#l13.177"></a><span id="l13.177">   return NS_OK;</span>
<a href="#l13.178"></a><span id="l13.178"> }</span>
<a href="#l13.179"></a><span id="l13.179"> </span>
<a href="#l13.180"></a><span id="l13.180"> NS_IMETHODIMP</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-nsMsgMailSession::AddUserFeedbackListener(nsIMsgUserFeedbackListener *aListener)</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-{</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+nsMsgMailSession::AddUserFeedbackListener(</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+    nsIMsgUserFeedbackListener *aListener) {</span>
<a href="#l13.185"></a><span id="l13.185">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l13.186"></a><span id="l13.186"> </span>
<a href="#l13.187"></a><span id="l13.187">   size_t index = mFeedbackListeners.IndexOf(aListener);</span>
<a href="#l13.188"></a><span id="l13.188">   NS_ASSERTION(index == size_t(-1), &quot;tried to add duplicate listener&quot;);</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-  if (index == size_t(-1))</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-    mFeedbackListeners.AppendElement(aListener);</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+  if (index == size_t(-1)) mFeedbackListeners.AppendElement(aListener);</span>
<a href="#l13.192"></a><span id="l13.192"> </span>
<a href="#l13.193"></a><span id="l13.193">   return NS_OK;</span>
<a href="#l13.194"></a><span id="l13.194"> }</span>
<a href="#l13.195"></a><span id="l13.195"> </span>
<a href="#l13.196"></a><span id="l13.196"> NS_IMETHODIMP</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-nsMsgMailSession::RemoveUserFeedbackListener(nsIMsgUserFeedbackListener *aListener)</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-{</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+nsMsgMailSession::RemoveUserFeedbackListener(</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+    nsIMsgUserFeedbackListener *aListener) {</span>
<a href="#l13.201"></a><span id="l13.201">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l13.202"></a><span id="l13.202"> </span>
<a href="#l13.203"></a><span id="l13.203">   mFeedbackListeners.RemoveElement(aListener);</span>
<a href="#l13.204"></a><span id="l13.204">   return NS_OK;</span>
<a href="#l13.205"></a><span id="l13.205"> }</span>
<a href="#l13.206"></a><span id="l13.206"> </span>
<a href="#l13.207"></a><span id="l13.207"> NS_IMETHODIMP</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-nsMsgMailSession::AlertUser(const nsAString &amp;aMessage, nsIMsgMailNewsUrl *aUrl)</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-{</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+nsMsgMailSession::AlertUser(const nsAString &amp;aMessage,</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+                            nsIMsgMailNewsUrl *aUrl) {</span>
<a href="#l13.212"></a><span id="l13.212">   bool listenersNotified = false;</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgUserFeedbackListener&gt; &gt;::ForwardIterator iter(mFeedbackListeners);</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgUserFeedbackListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+      mFeedbackListeners);</span>
<a href="#l13.216"></a><span id="l13.216">   nsCOMPtr&lt;nsIMsgUserFeedbackListener&gt; listener;</span>
<a href="#l13.217"></a><span id="l13.217"> </span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-  {</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l13.221"></a><span id="l13.221">     bool notified = false;</span>
<a href="#l13.222"></a><span id="l13.222">     listener = iter.GetNext();</span>
<a href="#l13.223"></a><span id="l13.223">     listener-&gt;OnAlert(aMessage, aUrl, &amp;notified);</span>
<a href="#l13.224"></a><span id="l13.224">     listenersNotified = listenersNotified || notified;</span>
<a href="#l13.225"></a><span id="l13.225">   }</span>
<a href="#l13.226"></a><span id="l13.226"> </span>
<a href="#l13.227"></a><span id="l13.227">   // If the listeners notified the user, then we don't need to. Also exit if</span>
<a href="#l13.228"></a><span id="l13.228">   // aUrl is null because we won't have a nsIMsgWindow in that case.</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-  if (listenersNotified || !aUrl)</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+  if (listenersNotified || !aUrl) return NS_OK;</span>
<a href="#l13.232"></a><span id="l13.232"> </span>
<a href="#l13.233"></a><span id="l13.233">   // If the url hasn't got a message window, then the error was a generated as a</span>
<a href="#l13.234"></a><span id="l13.234">   // result of background activity (e.g. autosync, biff, etc), and hence we</span>
<a href="#l13.235"></a><span id="l13.235">   // shouldn't prompt either.</span>
<a href="#l13.236"></a><span id="l13.236">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l13.237"></a><span id="l13.237">   aUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l13.238"></a><span id="l13.238"> </span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-  if (!msgWindow)</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+  if (!msgWindow) return NS_OK;</span>
<a href="#l13.242"></a><span id="l13.242"> </span>
<a href="#l13.243"></a><span id="l13.243">   nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l13.244"></a><span id="l13.244">   msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l13.245"></a><span id="l13.245"> </span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-  if (!dialog) // if we didn't get one, use the default....</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+  if (!dialog)  // if we didn't get one, use the default....</span>
<a href="#l13.248"></a><span id="l13.248">   {</span>
<a href="#l13.249"></a><span id="l13.249">     nsresult rv;</span>
<a href="#l13.250"></a><span id="l13.250">     nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch =</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-      do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l13.253"></a><span id="l13.253">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.254"></a><span id="l13.254"> </span>
<a href="#l13.255"></a><span id="l13.255">     wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l13.256"></a><span id="l13.256">   }</span>
<a href="#l13.257"></a><span id="l13.257"> </span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-  if (dialog)</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-    return dialog-&gt;Alert(nullptr, PromiseFlatString(aMessage).get());</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+  if (dialog) return dialog-&gt;Alert(nullptr, PromiseFlatString(aMessage).get());</span>
<a href="#l13.261"></a><span id="l13.261"> </span>
<a href="#l13.262"></a><span id="l13.262">   return NS_OK;</span>
<a href="#l13.263"></a><span id="l13.263"> }</span>
<a href="#l13.264"></a><span id="l13.264"> </span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-nsresult nsMsgMailSession::GetTopmostMsgWindow(nsIMsgWindow **aMsgWindow)</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-{</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+nsresult nsMsgMailSession::GetTopmostMsgWindow(nsIMsgWindow **aMsgWindow) {</span>
<a href="#l13.268"></a><span id="l13.268">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l13.269"></a><span id="l13.269"> </span>
<a href="#l13.270"></a><span id="l13.270">   *aMsgWindow = nullptr;</span>
<a href="#l13.271"></a><span id="l13.271"> </span>
<a href="#l13.272"></a><span id="l13.272">   uint32_t count = mWindows.Count();</span>
<a href="#l13.273"></a><span id="l13.273"> </span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-  if (count == 1)</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-  {</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+  if (count == 1) {</span>
<a href="#l13.277"></a><span id="l13.277">     NS_ADDREF(*aMsgWindow = mWindows[0]);</span>
<a href="#l13.278"></a><span id="l13.278">     return (*aMsgWindow) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-  }</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-  else if (count &gt; 1)</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-  {</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+  } else if (count &gt; 1) {</span>
<a href="#l13.283"></a><span id="l13.283">     // If multiple message windows then we have lots more work.</span>
<a href="#l13.284"></a><span id="l13.284">     nsresult rv;</span>
<a href="#l13.285"></a><span id="l13.285"> </span>
<a href="#l13.286"></a><span id="l13.286">     // The msgWindows array does not hold z-order info. Use mediator to get</span>
<a href="#l13.287"></a><span id="l13.287">     // the top most window then match that with the msgWindows array.</span>
<a href="#l13.288"></a><span id="l13.288">     nsCOMPtr&lt;nsIWindowMediator&gt; windowMediator =</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-      do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv);</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+        do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv);</span>
<a href="#l13.291"></a><span id="l13.291">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.292"></a><span id="l13.292"> </span>
<a href="#l13.293"></a><span id="l13.293">     nsCOMPtr&lt;nsISimpleEnumerator&gt; windowEnum;</span>
<a href="#l13.294"></a><span id="l13.294"> </span>
<a href="#l13.295"></a><span id="l13.295">     rv = windowMediator-&gt;GetEnumerator(nullptr, getter_AddRefs(windowEnum));</span>
<a href="#l13.296"></a><span id="l13.296">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.297"></a><span id="l13.297"> </span>
<a href="#l13.298"></a><span id="l13.298">     nsCOMPtr&lt;nsISupports&gt; windowSupports;</span>
<a href="#l13.299"></a><span id="l13.299">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; topMostWindow;</span>
<a href="#l13.300"></a><span id="l13.300">     nsAutoString windowType;</span>
<a href="#l13.301"></a><span id="l13.301">     bool more;</span>
<a href="#l13.302"></a><span id="l13.302"> </span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-    // loop to get the top most with attribute &quot;mail:3pane&quot; or &quot;mail:messageWindow&quot;</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+    // loop to get the top most with attribute &quot;mail:3pane&quot; or</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+    // &quot;mail:messageWindow&quot;</span>
<a href="#l13.306"></a><span id="l13.306">     windowEnum-&gt;HasMoreElements(&amp;more);</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-    while (more)</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-    {</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+    while (more) {</span>
<a href="#l13.310"></a><span id="l13.310">       rv = windowEnum-&gt;GetNext(getter_AddRefs(windowSupports));</span>
<a href="#l13.311"></a><span id="l13.311">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.312"></a><span id="l13.312">       NS_ENSURE_TRUE(windowSupports, NS_ERROR_FAILURE);</span>
<a href="#l13.313"></a><span id="l13.313"> </span>
<a href="#l13.314"></a><span id="l13.314">       topMostWindow = do_QueryInterface(windowSupports, &amp;rv);</span>
<a href="#l13.315"></a><span id="l13.315">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.316"></a><span id="l13.316">       NS_ENSURE_TRUE(topMostWindow, NS_ERROR_FAILURE);</span>
<a href="#l13.317"></a><span id="l13.317"> </span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-      mozilla::dom::Document* domDocument = topMostWindow-&gt;GetDoc();</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+      mozilla::dom::Document *domDocument = topMostWindow-&gt;GetDoc();</span>
<a href="#l13.320"></a><span id="l13.320">       NS_ENSURE_TRUE(domDocument, NS_ERROR_FAILURE);</span>
<a href="#l13.321"></a><span id="l13.321"> </span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-      Element* domElement = domDocument-&gt;GetDocumentElement();</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+      Element *domElement = domDocument-&gt;GetDocumentElement();</span>
<a href="#l13.324"></a><span id="l13.324">       NS_ENSURE_TRUE(domElement, NS_ERROR_FAILURE);</span>
<a href="#l13.325"></a><span id="l13.325"> </span>
<a href="#l13.326"></a><span id="l13.326">       domElement-&gt;GetAttribute(NS_LITERAL_STRING(&quot;windowtype&quot;), windowType);</span>
<a href="#l13.327"></a><span id="l13.327">       if (windowType.EqualsLiteral(&quot;mail:3pane&quot;) ||</span>
<a href="#l13.328"></a><span id="l13.328">           windowType.EqualsLiteral(&quot;mail:messageWindow&quot;))</span>
<a href="#l13.329"></a><span id="l13.329">         break;</span>
<a href="#l13.330"></a><span id="l13.330"> </span>
<a href="#l13.331"></a><span id="l13.331">       windowEnum-&gt;HasMoreElements(&amp;more);</span>
<a href="#l13.332"></a><span id="l13.332">     }</span>
<a href="#l13.333"></a><span id="l13.333"> </span>
<a href="#l13.334"></a><span id="l13.334">     // identified the top most window</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-    if (more)</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-    {</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+    if (more) {</span>
<a href="#l13.338"></a><span id="l13.338">       // use this for the match</span>
<a href="#l13.339"></a><span id="l13.339">       nsIDocShell *topDocShell = topMostWindow-&gt;GetDocShell();</span>
<a href="#l13.340"></a><span id="l13.340"> </span>
<a href="#l13.341"></a><span id="l13.341">       // loop for the msgWindow array to find the match</span>
<a href="#l13.342"></a><span id="l13.342">       nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l13.343"></a><span id="l13.343"> </span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-      while (count)</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-      {</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+      while (count) {</span>
<a href="#l13.347"></a><span id="l13.347">         nsIMsgWindow *msgWindow = mWindows[--count];</span>
<a href="#l13.348"></a><span id="l13.348"> </span>
<a href="#l13.349"></a><span id="l13.349">         rv = msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l13.350"></a><span id="l13.350">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.351"></a><span id="l13.351"> </span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-        if (topDocShell == docShell)</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-        {</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+        if (topDocShell == docShell) {</span>
<a href="#l13.355"></a><span id="l13.355">           NS_IF_ADDREF(*aMsgWindow = msgWindow);</span>
<a href="#l13.356"></a><span id="l13.356">           break;</span>
<a href="#l13.357"></a><span id="l13.357">         }</span>
<a href="#l13.358"></a><span id="l13.358">       }</span>
<a href="#l13.359"></a><span id="l13.359">     }</span>
<a href="#l13.360"></a><span id="l13.360">   }</span>
<a href="#l13.361"></a><span id="l13.361"> </span>
<a href="#l13.362"></a><span id="l13.362">   return (*aMsgWindow) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l13.363"></a><span id="l13.363"> }</span>
<a href="#l13.364"></a><span id="l13.364"> </span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-NS_IMETHODIMP nsMsgMailSession::AddMsgWindow(nsIMsgWindow *msgWindow)</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-{</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+NS_IMETHODIMP nsMsgMailSession::AddMsgWindow(nsIMsgWindow *msgWindow) {</span>
<a href="#l13.368"></a><span id="l13.368">   NS_ENSURE_ARG_POINTER(msgWindow);</span>
<a href="#l13.369"></a><span id="l13.369"> </span>
<a href="#l13.370"></a><span id="l13.370">   mWindows.AppendObject(msgWindow);</span>
<a href="#l13.371"></a><span id="l13.371">   return NS_OK;</span>
<a href="#l13.372"></a><span id="l13.372"> }</span>
<a href="#l13.373"></a><span id="l13.373"> </span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-NS_IMETHODIMP nsMsgMailSession::RemoveMsgWindow(nsIMsgWindow *msgWindow)</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-{</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+NS_IMETHODIMP nsMsgMailSession::RemoveMsgWindow(nsIMsgWindow *msgWindow) {</span>
<a href="#l13.377"></a><span id="l13.377">   mWindows.RemoveObject(msgWindow);</span>
<a href="#l13.378"></a><span id="l13.378">   // Mac keeps a hidden window open so the app doesn't shut down when</span>
<a href="#l13.379"></a><span id="l13.379">   // the last window is closed. So don't shutdown the account manager in that</span>
<a href="#l13.380"></a><span id="l13.380">   // case. Similarly, for suite, we don't want to disable mailnews when the</span>
<a href="#l13.381"></a><span id="l13.381">   // last mail window is closed.</span>
<a href="#l13.382"></a><span id="l13.382"> #if !defined(XP_MACOSX) &amp;&amp; !defined(MOZ_SUITE)</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-  if (!mWindows.Count())</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-  {</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+  if (!mWindows.Count()) {</span>
<a href="#l13.386"></a><span id="l13.386">     nsresult rv;</span>
<a href="#l13.387"></a><span id="l13.387">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineminus">-      return rv;</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.393"></a><span id="l13.393">     accountManager-&gt;CleanupOnExit();</span>
<a href="#l13.394"></a><span id="l13.394">   }</span>
<a href="#l13.395"></a><span id="l13.395"> #endif</span>
<a href="#l13.396"></a><span id="l13.396">   return NS_OK;</span>
<a href="#l13.397"></a><span id="l13.397"> }</span>
<a href="#l13.398"></a><span id="l13.398"> </span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-NS_IMETHODIMP nsMsgMailSession::IsFolderOpenInWindow(nsIMsgFolder *folder, bool *aResult)</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-{</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+NS_IMETHODIMP nsMsgMailSession::IsFolderOpenInWindow(nsIMsgFolder *folder,</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+                                                     bool *aResult) {</span>
<a href="#l13.403"></a><span id="l13.403">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.404"></a><span id="l13.404"> </span>
<a href="#l13.405"></a><span id="l13.405">   *aResult = false;</span>
<a href="#l13.406"></a><span id="l13.406"> </span>
<a href="#l13.407"></a><span id="l13.407">   uint32_t count = mWindows.Count();</span>
<a href="#l13.408"></a><span id="l13.408"> </span>
<a href="#l13.409"></a><span id="l13.409" class="difflineminus">-  for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineminus">-  {</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l13.412"></a><span id="l13.412">     nsCOMPtr&lt;nsIMsgFolder&gt; openFolder;</span>
<a href="#l13.413"></a><span id="l13.413">     mWindows[i]-&gt;GetOpenFolder(getter_AddRefs(openFolder));</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineminus">-    if (folder == openFolder.get())</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineminus">-    {</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+    if (folder == openFolder.get()) {</span>
<a href="#l13.417"></a><span id="l13.417">       *aResult = true;</span>
<a href="#l13.418"></a><span id="l13.418">       break;</span>
<a href="#l13.419"></a><span id="l13.419">     }</span>
<a href="#l13.420"></a><span id="l13.420">   }</span>
<a href="#l13.421"></a><span id="l13.421"> </span>
<a href="#l13.422"></a><span id="l13.422">   return NS_OK;</span>
<a href="#l13.423"></a><span id="l13.423"> }</span>
<a href="#l13.424"></a><span id="l13.424"> </span>
<a href="#l13.425"></a><span id="l13.425"> NS_IMETHODIMP</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineminus">-nsMsgMailSession::ConvertMsgURIToMsgURL(const char *aURI, nsIMsgWindow *aMsgWindow, char **aURL)</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineminus">-{</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+nsMsgMailSession::ConvertMsgURIToMsgURL(const char *aURI,</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+                                        nsIMsgWindow *aMsgWindow, char **aURL) {</span>
<a href="#l13.430"></a><span id="l13.430">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l13.431"></a><span id="l13.431">   NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l13.432"></a><span id="l13.432"> </span>
<a href="#l13.433"></a><span id="l13.433">   // convert the rdf msg uri into a url that represents the message...</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineminus">-  nsresult rv = GetMessageServiceFromURI(nsDependentCString(aURI), getter_AddRefs(msgService));</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+  nsresult rv = GetMessageServiceFromURI(nsDependentCString(aURI),</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+                                         getter_AddRefs(msgService));</span>
<a href="#l13.439"></a><span id="l13.439">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NULL_POINTER);</span>
<a href="#l13.440"></a><span id="l13.440"> </span>
<a href="#l13.441"></a><span id="l13.441">   nsCOMPtr&lt;nsIURI&gt; tURI;</span>
<a href="#l13.442"></a><span id="l13.442">   rv = msgService-&gt;GetUrlForUri(aURI, getter_AddRefs(tURI), aMsgWindow);</span>
<a href="#l13.443"></a><span id="l13.443">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NULL_POINTER);</span>
<a href="#l13.444"></a><span id="l13.444"> </span>
<a href="#l13.445"></a><span id="l13.445">   nsAutoCString urlString;</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-  if (NS_SUCCEEDED(tURI-&gt;GetSpec(urlString)))</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-  {</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+  if (NS_SUCCEEDED(tURI-&gt;GetSpec(urlString))) {</span>
<a href="#l13.449"></a><span id="l13.449">     *aURL = ToNewCString(urlString);</span>
<a href="#l13.450"></a><span id="l13.450">     NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l13.451"></a><span id="l13.451">   }</span>
<a href="#l13.452"></a><span id="l13.452">   return rv;</span>
<a href="#l13.453"></a><span id="l13.453"> }</span>
<a href="#l13.454"></a><span id="l13.454"> </span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-//----------------------------------------------------------------------------------------</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-// GetSelectedLocaleDataDir - If a locale is selected, appends the selected locale to the</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-//                            defaults data dir and returns that new defaults data dir</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-//----------------------------------------------------------------------------------------</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-nsresult</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineminus">-nsMsgMailSession::GetSelectedLocaleDataDir(nsIFile *defaultsDir)</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineminus">-{</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+//-------------------------------------------------------------------------</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+// GetSelectedLocaleDataDir - If a locale is selected, appends the selected</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+//                            locale to the defaults data dir and returns</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineplus">+//                            that new defaults data dir</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineplus">+//-------------------------------------------------------------------------</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+nsresult nsMsgMailSession::GetSelectedLocaleDataDir(nsIFile *defaultsDir) {</span>
<a href="#l13.468"></a><span id="l13.468">   NS_ENSURE_ARG_POINTER(defaultsDir);</span>
<a href="#l13.469"></a><span id="l13.469"> </span>
<a href="#l13.470"></a><span id="l13.470">   bool baseDirExists = false;</span>
<a href="#l13.471"></a><span id="l13.471">   nsresult rv = defaultsDir-&gt;Exists(&amp;baseDirExists);</span>
<a href="#l13.472"></a><span id="l13.472">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.473"></a><span id="l13.473"> </span>
<a href="#l13.474"></a><span id="l13.474">   if (baseDirExists) {</span>
<a href="#l13.475"></a><span id="l13.475">     nsCOMPtr&lt;nsIXULChromeRegistry&gt; packageRegistry =</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-      mozilla::services::GetXULChromeRegistryService();</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineplus">+        mozilla::services::GetXULChromeRegistryService();</span>
<a href="#l13.478"></a><span id="l13.478">     if (packageRegistry) {</span>
<a href="#l13.479"></a><span id="l13.479">       nsAutoCString localeName;</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineminus">-      rv = packageRegistry-&gt;GetSelectedLocale(NS_LITERAL_CSTRING(&quot;global-region&quot;), false, localeName);</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+      rv = packageRegistry-&gt;GetSelectedLocale(</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineplus">+          NS_LITERAL_CSTRING(&quot;global-region&quot;), false, localeName);</span>
<a href="#l13.483"></a><span id="l13.483"> </span>
<a href="#l13.484"></a><span id="l13.484">       if (NS_SUCCEEDED(rv) &amp;&amp; !localeName.IsEmpty()) {</span>
<a href="#l13.485"></a><span id="l13.485">         bool localeDirExists = false;</span>
<a href="#l13.486"></a><span id="l13.486">         nsCOMPtr&lt;nsIFile&gt; localeDataDir;</span>
<a href="#l13.487"></a><span id="l13.487"> </span>
<a href="#l13.488"></a><span id="l13.488">         rv = defaultsDir-&gt;Clone(getter_AddRefs(localeDataDir));</span>
<a href="#l13.489"></a><span id="l13.489">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.490"></a><span id="l13.490"> </span>
<a href="#l13.491"></a><span id="l13.491" class="difflineat">@@ -441,305 +403,283 @@ nsMsgMailSession::GetSelectedLocaleDataD</span>
<a href="#l13.492"></a><span id="l13.492">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.493"></a><span id="l13.493">         }</span>
<a href="#l13.494"></a><span id="l13.494">       }</span>
<a href="#l13.495"></a><span id="l13.495">     }</span>
<a href="#l13.496"></a><span id="l13.496">   }</span>
<a href="#l13.497"></a><span id="l13.497">   return NS_OK;</span>
<a href="#l13.498"></a><span id="l13.498"> }</span>
<a href="#l13.499"></a><span id="l13.499"> </span>
<a href="#l13.500"></a><span id="l13.500" class="difflineminus">-//----------------------------------------------------------------------------------------</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+//-----------------------------------------------------------------------------</span>
<a href="#l13.502"></a><span id="l13.502"> // GetDataFilesDir - Gets the application's default folder and then appends the</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineminus">-//                   subdirectory named passed in as param dirName. If there is a selected</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineminus">-//                   locale, will append that to the dir path before returning the value</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineminus">-//----------------------------------------------------------------------------------------</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+//                   subdirectory named passed in as param dirName. If there is</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineplus">+//                   a selected locale, will append that to the dir path before</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineplus">+//                   returning the value</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineplus">+//-----------------------------------------------------------------------------</span>
<a href="#l13.510"></a><span id="l13.510"> NS_IMETHODIMP</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineminus">-nsMsgMailSession::GetDataFilesDir(const char* dirName, nsIFile **dataFilesDir)</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineminus">-{</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineminus">-</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+nsMsgMailSession::GetDataFilesDir(const char *dirName, nsIFile **dataFilesDir) {</span>
<a href="#l13.515"></a><span id="l13.515">   NS_ENSURE_ARG_POINTER(dirName);</span>
<a href="#l13.516"></a><span id="l13.516">   NS_ENSURE_ARG_POINTER(dataFilesDir);</span>
<a href="#l13.517"></a><span id="l13.517"> </span>
<a href="#l13.518"></a><span id="l13.518">   nsresult rv;</span>
<a href="#l13.519"></a><span id="l13.519">   nsCOMPtr&lt;nsIProperties&gt; directoryService =</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineminus">-    do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineplus">+      do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l13.522"></a><span id="l13.522">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.523"></a><span id="l13.523"> </span>
<a href="#l13.524"></a><span id="l13.524">   nsCOMPtr&lt;nsIFile&gt; defaultsDir;</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineminus">-  rv = directoryService-&gt;Get(NS_APP_DEFAULTS_50_DIR,</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineminus">-                             NS_GET_IID(nsIFile),</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+  rv = directoryService-&gt;Get(NS_APP_DEFAULTS_50_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l13.528"></a><span id="l13.528">                              getter_AddRefs(defaultsDir));</span>
<a href="#l13.529"></a><span id="l13.529">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.530"></a><span id="l13.530"> </span>
<a href="#l13.531"></a><span id="l13.531">   rv = defaultsDir-&gt;AppendNative(nsDependentCString(dirName));</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineminus">-    rv = GetSelectedLocaleDataDir(defaultsDir);</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = GetSelectedLocaleDataDir(defaultsDir);</span>
<a href="#l13.535"></a><span id="l13.535"> </span>
<a href="#l13.536"></a><span id="l13.536">   defaultsDir.forget(dataFilesDir);</span>
<a href="#l13.537"></a><span id="l13.537"> </span>
<a href="#l13.538"></a><span id="l13.538">   return rv;</span>
<a href="#l13.539"></a><span id="l13.539"> }</span>
<a href="#l13.540"></a><span id="l13.540"> </span>
<a href="#l13.541"></a><span id="l13.541"> /********************************************************************************/</span>
<a href="#l13.542"></a><span id="l13.542"> </span>
<a href="#l13.543"></a><span id="l13.543" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgShutdownService, nsIMsgShutdownService, nsIUrlListener, nsIObserver)</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgShutdownService, nsIMsgShutdownService, nsIUrlListener,</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+                  nsIObserver)</span>
<a href="#l13.546"></a><span id="l13.546"> </span>
<a href="#l13.547"></a><span id="l13.547"> nsMsgShutdownService::nsMsgShutdownService()</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineminus">-: mQuitMode(nsIAppStartup::eAttemptQuit),</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineminus">-  mProcessedShutdown(false),</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineminus">-  mQuitForced(false),</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineminus">-  mReadyToQuit(false)</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineminus">-{</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+    : mQuitMode(nsIAppStartup::eAttemptQuit),</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineplus">+      mProcessedShutdown(false),</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+      mQuitForced(false),</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineplus">+      mReadyToQuit(false) {</span>
<a href="#l13.557"></a><span id="l13.557">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineminus">-  if (observerService)</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineminus">-  {</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+  if (observerService) {</span>
<a href="#l13.563"></a><span id="l13.563">     observerService-&gt;AddObserver(this, &quot;quit-application-requested&quot;, false);</span>
<a href="#l13.564"></a><span id="l13.564">     observerService-&gt;AddObserver(this, &quot;quit-application-granted&quot;, false);</span>
<a href="#l13.565"></a><span id="l13.565">     observerService-&gt;AddObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l13.566"></a><span id="l13.566">   }</span>
<a href="#l13.567"></a><span id="l13.567"> }</span>
<a href="#l13.568"></a><span id="l13.568"> </span>
<a href="#l13.569"></a><span id="l13.569" class="difflineminus">-nsMsgShutdownService::~nsMsgShutdownService()</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineminus">-{</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineplus">+nsMsgShutdownService::~nsMsgShutdownService() {</span>
<a href="#l13.572"></a><span id="l13.572">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineminus">-  if (observerService)</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-  {</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineplus">+  if (observerService) {</span>
<a href="#l13.578"></a><span id="l13.578">     observerService-&gt;RemoveObserver(this, &quot;quit-application-requested&quot;);</span>
<a href="#l13.579"></a><span id="l13.579">     observerService-&gt;RemoveObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l13.580"></a><span id="l13.580">     observerService-&gt;RemoveObserver(this, &quot;quit-application&quot;);</span>
<a href="#l13.581"></a><span id="l13.581">   }</span>
<a href="#l13.582"></a><span id="l13.582"> }</span>
<a href="#l13.583"></a><span id="l13.583"> </span>
<a href="#l13.584"></a><span id="l13.584" class="difflineminus">-nsresult nsMsgShutdownService::ProcessNextTask()</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineminus">-{</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineplus">+nsresult nsMsgShutdownService::ProcessNextTask() {</span>
<a href="#l13.587"></a><span id="l13.587">   bool shutdownTasksDone = true;</span>
<a href="#l13.588"></a><span id="l13.588"> </span>
<a href="#l13.589"></a><span id="l13.589">   uint32_t count = mShutdownTasks.Length();</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineminus">-  if (mTaskIndex &lt; count)</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineminus">-  {</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineplus">+  if (mTaskIndex &lt; count) {</span>
<a href="#l13.593"></a><span id="l13.593">     shutdownTasksDone = false;</span>
<a href="#l13.594"></a><span id="l13.594"> </span>
<a href="#l13.595"></a><span id="l13.595">     nsCOMPtr&lt;nsIMsgShutdownTask&gt; curTask = mShutdownTasks[mTaskIndex];</span>
<a href="#l13.596"></a><span id="l13.596">     nsString taskName;</span>
<a href="#l13.597"></a><span id="l13.597">     curTask-&gt;GetCurrentTaskName(taskName);</span>
<a href="#l13.598"></a><span id="l13.598">     SetStatusText(taskName);</span>
<a href="#l13.599"></a><span id="l13.599"> </span>
<a href="#l13.600"></a><span id="l13.600" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l13.603"></a><span id="l13.603">     NS_ENSURE_TRUE(mailSession, NS_ERROR_FAILURE);</span>
<a href="#l13.604"></a><span id="l13.604"> </span>
<a href="#l13.605"></a><span id="l13.605">     nsCOMPtr&lt;nsIMsgWindow&gt; topMsgWindow;</span>
<a href="#l13.606"></a><span id="l13.606">     mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMsgWindow));</span>
<a href="#l13.607"></a><span id="l13.607"> </span>
<a href="#l13.608"></a><span id="l13.608">     bool taskIsRunning = true;</span>
<a href="#l13.609"></a><span id="l13.609">     nsresult rv = curTask-&gt;DoShutdownTask(this, topMsgWindow, &amp;taskIsRunning);</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-    if (NS_FAILED(rv) || !taskIsRunning)</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineminus">-    {</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineplus">+    if (NS_FAILED(rv) || !taskIsRunning) {</span>
<a href="#l13.613"></a><span id="l13.613">       // We have failed, let's go on to the next task.</span>
<a href="#l13.614"></a><span id="l13.614">       mTaskIndex++;</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineminus">-      mMsgProgress-&gt;OnProgressChange(nullptr, nullptr, 0, 0, (int32_t)mTaskIndex, count);</span>
<a href="#l13.616"></a><span id="l13.616" class="difflineplus">+      mMsgProgress-&gt;OnProgressChange(nullptr, nullptr, 0, 0,</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineplus">+                                     (int32_t)mTaskIndex, count);</span>
<a href="#l13.618"></a><span id="l13.618">       ProcessNextTask();</span>
<a href="#l13.619"></a><span id="l13.619">     }</span>
<a href="#l13.620"></a><span id="l13.620">   }</span>
<a href="#l13.621"></a><span id="l13.621"> </span>
<a href="#l13.622"></a><span id="l13.622" class="difflineminus">-  if (shutdownTasksDone)</span>
<a href="#l13.623"></a><span id="l13.623" class="difflineminus">-  {</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineplus">+  if (shutdownTasksDone) {</span>
<a href="#l13.625"></a><span id="l13.625">     if (mMsgProgress)</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineminus">-      mMsgProgress-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP, NS_OK);</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineplus">+      mMsgProgress-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineplus">+                                  nsIWebProgressListener::STATE_STOP, NS_OK);</span>
<a href="#l13.629"></a><span id="l13.629">     AttemptShutdown();</span>
<a href="#l13.630"></a><span id="l13.630">   }</span>
<a href="#l13.631"></a><span id="l13.631"> </span>
<a href="#l13.632"></a><span id="l13.632">   return NS_OK;</span>
<a href="#l13.633"></a><span id="l13.633"> }</span>
<a href="#l13.634"></a><span id="l13.634"> </span>
<a href="#l13.635"></a><span id="l13.635" class="difflineminus">-void nsMsgShutdownService::AttemptShutdown()</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineminus">-{</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineminus">-  if (mQuitForced)</span>
<a href="#l13.638"></a><span id="l13.638" class="difflineminus">-  {</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineplus">+void nsMsgShutdownService::AttemptShutdown() {</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineplus">+  if (mQuitForced) {</span>
<a href="#l13.641"></a><span id="l13.641">     PR_CEnterMonitor(this);</span>
<a href="#l13.642"></a><span id="l13.642">     mReadyToQuit = true;</span>
<a href="#l13.643"></a><span id="l13.643">     PR_CNotifyAll(this);</span>
<a href="#l13.644"></a><span id="l13.644">     PR_CExitMonitor(this);</span>
<a href="#l13.645"></a><span id="l13.645" class="difflineminus">-  }</span>
<a href="#l13.646"></a><span id="l13.646" class="difflineminus">-  else</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineminus">-  {</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineminus">-    nsCOMPtr&lt;nsIAppStartup&gt; appStartup = mozilla::components::AppStartup::Service();</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineplus">+  } else {</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineplus">+    nsCOMPtr&lt;nsIAppStartup&gt; appStartup =</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineplus">+        mozilla::components::AppStartup::Service();</span>
<a href="#l13.652"></a><span id="l13.652">     NS_ENSURE_TRUE_VOID(appStartup);</span>
<a href="#l13.653"></a><span id="l13.653">     NS_ENSURE_SUCCESS_VOID(appStartup-&gt;Quit(mQuitMode));</span>
<a href="#l13.654"></a><span id="l13.654">   }</span>
<a href="#l13.655"></a><span id="l13.655"> }</span>
<a href="#l13.656"></a><span id="l13.656"> </span>
<a href="#l13.657"></a><span id="l13.657" class="difflineminus">-NS_IMETHODIMP nsMsgShutdownService::SetShutdownListener(nsIWebProgressListener *inListener)</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineminus">-{</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineplus">+NS_IMETHODIMP nsMsgShutdownService::SetShutdownListener(</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineplus">+    nsIWebProgressListener *inListener) {</span>
<a href="#l13.661"></a><span id="l13.661">   NS_ENSURE_TRUE(mMsgProgress, NS_ERROR_FAILURE);</span>
<a href="#l13.662"></a><span id="l13.662">   mMsgProgress-&gt;RegisterListener(inListener);</span>
<a href="#l13.663"></a><span id="l13.663">   return NS_OK;</span>
<a href="#l13.664"></a><span id="l13.664"> }</span>
<a href="#l13.665"></a><span id="l13.665"> </span>
<a href="#l13.666"></a><span id="l13.666"> NS_IMETHODIMP nsMsgShutdownService::Observe(nsISupports *aSubject,</span>
<a href="#l13.667"></a><span id="l13.667">                                             const char *aTopic,</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineminus">-                                            const char16_t *aData)</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineminus">-{</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineplus">+                                            const char16_t *aData) {</span>
<a href="#l13.671"></a><span id="l13.671">   // Due to bug 459376 we don't always get quit-application-requested and</span>
<a href="#l13.672"></a><span id="l13.672">   // quit-application-granted. quit-application-requested is preferred, but if</span>
<a href="#l13.673"></a><span id="l13.673">   // we don't then we have to hook onto quit-application, but we don't want</span>
<a href="#l13.674"></a><span id="l13.674">   // to do the checking twice so we set some flags to prevent that.</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineminus">-  if (!strcmp(aTopic, &quot;quit-application-granted&quot;))</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineminus">-  {</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineplus">+  if (!strcmp(aTopic, &quot;quit-application-granted&quot;)) {</span>
<a href="#l13.678"></a><span id="l13.678">     // Quit application has been requested and granted, therefore we will shut</span>
<a href="#l13.679"></a><span id="l13.679">     // down.</span>
<a href="#l13.680"></a><span id="l13.680">     mProcessedShutdown = true;</span>
<a href="#l13.681"></a><span id="l13.681">     return NS_OK;</span>
<a href="#l13.682"></a><span id="l13.682">   }</span>
<a href="#l13.683"></a><span id="l13.683"> </span>
<a href="#l13.684"></a><span id="l13.684">   // If we've already processed a shutdown notification, no need to do it again.</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineminus">-  if (!strcmp(aTopic, &quot;quit-application&quot;))</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineminus">-  {</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineplus">+  if (!strcmp(aTopic, &quot;quit-application&quot;)) {</span>
<a href="#l13.688"></a><span id="l13.688">     if (mProcessedShutdown)</span>
<a href="#l13.689"></a><span id="l13.689">       return NS_OK;</span>
<a href="#l13.690"></a><span id="l13.690">     else</span>
<a href="#l13.691"></a><span id="l13.691">       mQuitForced = true;</span>
<a href="#l13.692"></a><span id="l13.692">   }</span>
<a href="#l13.693"></a><span id="l13.693"> </span>
<a href="#l13.694"></a><span id="l13.694">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l13.697"></a><span id="l13.697">   NS_ENSURE_STATE(observerService);</span>
<a href="#l13.698"></a><span id="l13.698"> </span>
<a href="#l13.699"></a><span id="l13.699">   nsCOMPtr&lt;nsISimpleEnumerator&gt; listenerEnum;</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineminus">-  nsresult rv = observerService-&gt;EnumerateObservers(&quot;msg-shutdown&quot;, getter_AddRefs(listenerEnum));</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; listenerEnum)</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineminus">-  {</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineplus">+  nsresult rv = observerService-&gt;EnumerateObservers(</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineplus">+      &quot;msg-shutdown&quot;, getter_AddRefs(listenerEnum));</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; listenerEnum) {</span>
<a href="#l13.706"></a><span id="l13.706">     bool hasMore;</span>
<a href="#l13.707"></a><span id="l13.707">     listenerEnum-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineminus">-    if (!hasMore)</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineminus">-      return NS_OK;</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineplus">+    if (!hasMore) return NS_OK;</span>
<a href="#l13.711"></a><span id="l13.711"> </span>
<a href="#l13.712"></a><span id="l13.712" class="difflineminus">-    while (hasMore)</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineminus">-    {</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineplus">+    while (hasMore) {</span>
<a href="#l13.715"></a><span id="l13.715">       nsCOMPtr&lt;nsISupports&gt; curObject;</span>
<a href="#l13.716"></a><span id="l13.716">       listenerEnum-&gt;GetNext(getter_AddRefs(curObject));</span>
<a href="#l13.717"></a><span id="l13.717"> </span>
<a href="#l13.718"></a><span id="l13.718">       nsCOMPtr&lt;nsIMsgShutdownTask&gt; curTask = do_QueryInterface(curObject);</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineminus">-      if (curTask)</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineminus">-      {</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineplus">+      if (curTask) {</span>
<a href="#l13.722"></a><span id="l13.722">         bool shouldRunTask;</span>
<a href="#l13.723"></a><span id="l13.723">         curTask-&gt;GetNeedsToRunTask(&amp;shouldRunTask);</span>
<a href="#l13.724"></a><span id="l13.724" class="difflineminus">-        if (shouldRunTask)</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineminus">-          mShutdownTasks.AppendObject(curTask);</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineplus">+        if (shouldRunTask) mShutdownTasks.AppendObject(curTask);</span>
<a href="#l13.727"></a><span id="l13.727">       }</span>
<a href="#l13.728"></a><span id="l13.728"> </span>
<a href="#l13.729"></a><span id="l13.729">       listenerEnum-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l13.730"></a><span id="l13.730">     }</span>
<a href="#l13.731"></a><span id="l13.731"> </span>
<a href="#l13.732"></a><span id="l13.732" class="difflineminus">-    if (mShutdownTasks.Count() &lt; 1)</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineplus">+    if (mShutdownTasks.Count() &lt; 1) return NS_ERROR_FAILURE;</span>
<a href="#l13.735"></a><span id="l13.735"> </span>
<a href="#l13.736"></a><span id="l13.736">     mTaskIndex = 0;</span>
<a href="#l13.737"></a><span id="l13.737"> </span>
<a href="#l13.738"></a><span id="l13.738">     mMsgProgress = do_CreateInstance(NS_MSGPROGRESS_CONTRACTID);</span>
<a href="#l13.739"></a><span id="l13.739">     NS_ENSURE_TRUE(mMsgProgress, NS_ERROR_FAILURE);</span>
<a href="#l13.740"></a><span id="l13.740"> </span>
<a href="#l13.741"></a><span id="l13.741" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l13.744"></a><span id="l13.744">     NS_ENSURE_TRUE(mailSession, NS_ERROR_FAILURE);</span>
<a href="#l13.745"></a><span id="l13.745"> </span>
<a href="#l13.746"></a><span id="l13.746">     nsCOMPtr&lt;nsIMsgWindow&gt; topMsgWindow;</span>
<a href="#l13.747"></a><span id="l13.747">     mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMsgWindow));</span>
<a href="#l13.748"></a><span id="l13.748"> </span>
<a href="#l13.749"></a><span id="l13.749">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; internalDomWin;</span>
<a href="#l13.750"></a><span id="l13.750">     if (topMsgWindow)</span>
<a href="#l13.751"></a><span id="l13.751">       topMsgWindow-&gt;GetDomWindow(getter_AddRefs(internalDomWin));</span>
<a href="#l13.752"></a><span id="l13.752"> </span>
<a href="#l13.753"></a><span id="l13.753" class="difflineminus">-    if (!internalDomWin)</span>
<a href="#l13.754"></a><span id="l13.754" class="difflineminus">-    {</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineplus">+    if (!internalDomWin) {</span>
<a href="#l13.756"></a><span id="l13.756">       // First see if there is a window open.</span>
<a href="#l13.757"></a><span id="l13.757" class="difflineminus">-      nsCOMPtr&lt;nsIWindowMediator&gt; winMed = do_GetService(NS_WINDOWMEDIATOR_CONTRACTID);</span>
<a href="#l13.758"></a><span id="l13.758" class="difflineplus">+      nsCOMPtr&lt;nsIWindowMediator&gt; winMed =</span>
<a href="#l13.759"></a><span id="l13.759" class="difflineplus">+          do_GetService(NS_WINDOWMEDIATOR_CONTRACTID);</span>
<a href="#l13.760"></a><span id="l13.760">       winMed-&gt;GetMostRecentWindow(nullptr, getter_AddRefs(internalDomWin));</span>
<a href="#l13.761"></a><span id="l13.761"> </span>
<a href="#l13.762"></a><span id="l13.762" class="difflineminus">-      //If not use the hidden window.</span>
<a href="#l13.763"></a><span id="l13.763" class="difflineminus">-      if (!internalDomWin)</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineminus">-      {</span>
<a href="#l13.765"></a><span id="l13.765" class="difflineminus">-        nsCOMPtr&lt;nsIAppShellService&gt; appShell(do_GetService(NS_APPSHELLSERVICE_CONTRACTID));</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineplus">+      // If not use the hidden window.</span>
<a href="#l13.767"></a><span id="l13.767" class="difflineplus">+      if (!internalDomWin) {</span>
<a href="#l13.768"></a><span id="l13.768" class="difflineplus">+        nsCOMPtr&lt;nsIAppShellService&gt; appShell(</span>
<a href="#l13.769"></a><span id="l13.769" class="difflineplus">+            do_GetService(NS_APPSHELLSERVICE_CONTRACTID));</span>
<a href="#l13.770"></a><span id="l13.770">         appShell-&gt;GetHiddenDOMWindow(getter_AddRefs(internalDomWin));</span>
<a href="#l13.771"></a><span id="l13.771" class="difflineminus">-        NS_ENSURE_TRUE(internalDomWin, NS_ERROR_FAILURE);  // bail if we don't get a window.</span>
<a href="#l13.772"></a><span id="l13.772" class="difflineplus">+        NS_ENSURE_TRUE(internalDomWin,</span>
<a href="#l13.773"></a><span id="l13.773" class="difflineplus">+                       NS_ERROR_FAILURE);  // bail if we don't get a window.</span>
<a href="#l13.774"></a><span id="l13.774">       }</span>
<a href="#l13.775"></a><span id="l13.775">     }</span>
<a href="#l13.776"></a><span id="l13.776"> </span>
<a href="#l13.777"></a><span id="l13.777" class="difflineminus">-    if (!mQuitForced)</span>
<a href="#l13.778"></a><span id="l13.778" class="difflineminus">-    {</span>
<a href="#l13.779"></a><span id="l13.779" class="difflineplus">+    if (!mQuitForced) {</span>
<a href="#l13.780"></a><span id="l13.780">       nsCOMPtr&lt;nsISupportsPRBool&gt; stopShutdown = do_QueryInterface(aSubject);</span>
<a href="#l13.781"></a><span id="l13.781">       stopShutdown-&gt;SetData(true);</span>
<a href="#l13.782"></a><span id="l13.782"> </span>
<a href="#l13.783"></a><span id="l13.783">       // If the attempted quit was a restart, be sure to restart the app once</span>
<a href="#l13.784"></a><span id="l13.784">       // the tasks have been run. This is usually the case when addons or</span>
<a href="#l13.785"></a><span id="l13.785">       // updates are going to be installed.</span>
<a href="#l13.786"></a><span id="l13.786">       if (aData &amp;&amp; nsDependentString(aData).EqualsLiteral(&quot;restart&quot;))</span>
<a href="#l13.787"></a><span id="l13.787">         mQuitMode |= nsIAppStartup::eRestart;</span>
<a href="#l13.788"></a><span id="l13.788">     }</span>
<a href="#l13.789"></a><span id="l13.789"> </span>
<a href="#l13.790"></a><span id="l13.790" class="difflineminus">-    mMsgProgress-&gt;OpenProgressDialog(internalDomWin, topMsgWindow,</span>
<a href="#l13.791"></a><span id="l13.791" class="difflineminus">-                                     &quot;chrome://messenger/content/shutdownWindow.xul&quot;,</span>
<a href="#l13.792"></a><span id="l13.792" class="difflineminus">-                                     false, nullptr);</span>
<a href="#l13.793"></a><span id="l13.793" class="difflineplus">+    mMsgProgress-&gt;OpenProgressDialog(</span>
<a href="#l13.794"></a><span id="l13.794" class="difflineplus">+        internalDomWin, topMsgWindow,</span>
<a href="#l13.795"></a><span id="l13.795" class="difflineplus">+        &quot;chrome://messenger/content/shutdownWindow.xul&quot;, false, nullptr);</span>
<a href="#l13.796"></a><span id="l13.796"> </span>
<a href="#l13.797"></a><span id="l13.797" class="difflineminus">-    if (mQuitForced)</span>
<a href="#l13.798"></a><span id="l13.798" class="difflineminus">-    {</span>
<a href="#l13.799"></a><span id="l13.799" class="difflineplus">+    if (mQuitForced) {</span>
<a href="#l13.800"></a><span id="l13.800">       nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.801"></a><span id="l13.801"> </span>
<a href="#l13.802"></a><span id="l13.802">       mReadyToQuit = false;</span>
<a href="#l13.803"></a><span id="l13.803" class="difflineminus">-      while (!mReadyToQuit)</span>
<a href="#l13.804"></a><span id="l13.804" class="difflineminus">-      {</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineplus">+      while (!mReadyToQuit) {</span>
<a href="#l13.806"></a><span id="l13.806">         PR_CEnterMonitor(this);</span>
<a href="#l13.807"></a><span id="l13.807">         // Waiting for 50 milliseconds</span>
<a href="#l13.808"></a><span id="l13.808">         PR_CWait(this, PR_MicrosecondsToInterval(50000UL));</span>
<a href="#l13.809"></a><span id="l13.809">         PR_CExitMonitor(this);</span>
<a href="#l13.810"></a><span id="l13.810">         NS_ProcessPendingEvents(thread);</span>
<a href="#l13.811"></a><span id="l13.811">       }</span>
<a href="#l13.812"></a><span id="l13.812">     }</span>
<a href="#l13.813"></a><span id="l13.813">   }</span>
<a href="#l13.814"></a><span id="l13.814"> </span>
<a href="#l13.815"></a><span id="l13.815">   return NS_OK;</span>
<a href="#l13.816"></a><span id="l13.816"> }</span>
<a href="#l13.817"></a><span id="l13.817"> </span>
<a href="#l13.818"></a><span id="l13.818"> // nsIUrlListener</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineminus">-NS_IMETHODIMP nsMsgShutdownService::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l13.820"></a><span id="l13.820" class="difflineminus">-{</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineplus">+NS_IMETHODIMP nsMsgShutdownService::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l13.822"></a><span id="l13.822">   return NS_OK;</span>
<a href="#l13.823"></a><span id="l13.823"> }</span>
<a href="#l13.824"></a><span id="l13.824"> </span>
<a href="#l13.825"></a><span id="l13.825" class="difflineminus">-NS_IMETHODIMP nsMsgShutdownService::OnStopRunningUrl(nsIURI *url, nsresult aExitCode)</span>
<a href="#l13.826"></a><span id="l13.826" class="difflineminus">-{</span>
<a href="#l13.827"></a><span id="l13.827" class="difflineplus">+NS_IMETHODIMP nsMsgShutdownService::OnStopRunningUrl(nsIURI *url,</span>
<a href="#l13.828"></a><span id="l13.828" class="difflineplus">+                                                     nsresult aExitCode) {</span>
<a href="#l13.829"></a><span id="l13.829">   mTaskIndex++;</span>
<a href="#l13.830"></a><span id="l13.830"> </span>
<a href="#l13.831"></a><span id="l13.831" class="difflineminus">-  if (mMsgProgress)</span>
<a href="#l13.832"></a><span id="l13.832" class="difflineminus">-  {</span>
<a href="#l13.833"></a><span id="l13.833" class="difflineplus">+  if (mMsgProgress) {</span>
<a href="#l13.834"></a><span id="l13.834">     int32_t numTasks = mShutdownTasks.Count();</span>
<a href="#l13.835"></a><span id="l13.835" class="difflineminus">-    mMsgProgress-&gt;OnProgressChange(nullptr, nullptr, 0, 0, (int32_t)mTaskIndex, numTasks);</span>
<a href="#l13.836"></a><span id="l13.836" class="difflineplus">+    mMsgProgress-&gt;OnProgressChange(nullptr, nullptr, 0, 0, (int32_t)mTaskIndex,</span>
<a href="#l13.837"></a><span id="l13.837" class="difflineplus">+                                   numTasks);</span>
<a href="#l13.838"></a><span id="l13.838">   }</span>
<a href="#l13.839"></a><span id="l13.839"> </span>
<a href="#l13.840"></a><span id="l13.840">   ProcessNextTask();</span>
<a href="#l13.841"></a><span id="l13.841">   return NS_OK;</span>
<a href="#l13.842"></a><span id="l13.842"> }</span>
<a href="#l13.843"></a><span id="l13.843"> </span>
<a href="#l13.844"></a><span id="l13.844" class="difflineminus">-NS_IMETHODIMP nsMsgShutdownService::GetNumTasks(int32_t *inNumTasks)</span>
<a href="#l13.845"></a><span id="l13.845" class="difflineminus">-{</span>
<a href="#l13.846"></a><span id="l13.846" class="difflineplus">+NS_IMETHODIMP nsMsgShutdownService::GetNumTasks(int32_t *inNumTasks) {</span>
<a href="#l13.847"></a><span id="l13.847">   *inNumTasks = mShutdownTasks.Count();</span>
<a href="#l13.848"></a><span id="l13.848">   return NS_OK;</span>
<a href="#l13.849"></a><span id="l13.849"> }</span>
<a href="#l13.850"></a><span id="l13.850"> </span>
<a href="#l13.851"></a><span id="l13.851" class="difflineminus">-NS_IMETHODIMP nsMsgShutdownService::StartShutdownTasks()</span>
<a href="#l13.852"></a><span id="l13.852" class="difflineminus">-{</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineplus">+NS_IMETHODIMP nsMsgShutdownService::StartShutdownTasks() {</span>
<a href="#l13.854"></a><span id="l13.854">   ProcessNextTask();</span>
<a href="#l13.855"></a><span id="l13.855">   return NS_OK;</span>
<a href="#l13.856"></a><span id="l13.856"> }</span>
<a href="#l13.857"></a><span id="l13.857"> </span>
<a href="#l13.858"></a><span id="l13.858" class="difflineminus">-NS_IMETHODIMP nsMsgShutdownService::CancelShutdownTasks()</span>
<a href="#l13.859"></a><span id="l13.859" class="difflineminus">-{</span>
<a href="#l13.860"></a><span id="l13.860" class="difflineplus">+NS_IMETHODIMP nsMsgShutdownService::CancelShutdownTasks() {</span>
<a href="#l13.861"></a><span id="l13.861">   AttemptShutdown();</span>
<a href="#l13.862"></a><span id="l13.862">   return NS_OK;</span>
<a href="#l13.863"></a><span id="l13.863"> }</span>
<a href="#l13.864"></a><span id="l13.864"> </span>
<a href="#l13.865"></a><span id="l13.865" class="difflineminus">-NS_IMETHODIMP nsMsgShutdownService::SetStatusText(const nsAString &amp; inStatusString)</span>
<a href="#l13.866"></a><span id="l13.866" class="difflineminus">-{</span>
<a href="#l13.867"></a><span id="l13.867" class="difflineplus">+NS_IMETHODIMP nsMsgShutdownService::SetStatusText(</span>
<a href="#l13.868"></a><span id="l13.868" class="difflineplus">+    const nsAString &amp;inStatusString) {</span>
<a href="#l13.869"></a><span id="l13.869">   nsString statusString(inStatusString);</span>
<a href="#l13.870"></a><span id="l13.870">   if (mMsgProgress)</span>
<a href="#l13.871"></a><span id="l13.871" class="difflineminus">-    mMsgProgress-&gt;OnStatusChange(nullptr, nullptr, NS_OK, nsString(statusString).get());</span>
<a href="#l13.872"></a><span id="l13.872" class="difflineplus">+    mMsgProgress-&gt;OnStatusChange(nullptr, nullptr, NS_OK,</span>
<a href="#l13.873"></a><span id="l13.873" class="difflineplus">+                                 nsString(statusString).get());</span>
<a href="#l13.874"></a><span id="l13.874">   return NS_OK;</span>
<a href="#l13.875"></a><span id="l13.875"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -17,90 +17,88 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsIMsgUserFeedbackListener.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> ///////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-// The mail session is a replacement for the old 4.x MSG_Master object. It contains</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-// mail session generic information such as the user's current mail identity, ....</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-// I'm starting this off as an empty interface and as people feel they need to</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-// add more information to it, they can. I think this is a better approach than</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-// trying to port over the old MSG_Master in its entirety as that had a lot of</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-// cruft in it....</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+// The mail session is a replacement for the old 4.x MSG_Master object. It</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+// contains mail session generic information such as the user's current mail</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+// identity, .... I'm starting this off as an empty interface and as people feel</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+// they need to add more information to it, they can. I think this is a better</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+// approach than trying to port over the old MSG_Master in its entirety as that</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+// had a lot of cruft in it....</span>
<a href="#l14.24"></a><span id="l14.24"> //////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-class nsMsgMailSession : public nsIMsgMailSession,</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-                         public nsIFolderListener</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-{</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-public:</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+class nsMsgMailSession : public nsIMsgMailSession, public nsIFolderListener {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ public:</span>
<a href="#l14.32"></a><span id="l14.32">   nsMsgMailSession();</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l14.35"></a><span id="l14.35">   NS_DECL_NSIMSGMAILSESSION</span>
<a href="#l14.36"></a><span id="l14.36">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">   nsresult Init();</span>
<a href="#l14.39"></a><span id="l14.39">   nsresult GetSelectedLocaleDataDir(nsIFile *defaultsDir);</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-protected:</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+ protected:</span>
<a href="#l14.43"></a><span id="l14.43">   virtual ~nsMsgMailSession();</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">   struct folderListener {</span>
<a href="#l14.46"></a><span id="l14.46">     nsCOMPtr&lt;nsIFolderListener&gt; mListener;</span>
<a href="#l14.47"></a><span id="l14.47">     uint32_t mNotifyFlags;</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49">     folderListener(nsIFolderListener *aListener, uint32_t aNotifyFlags)</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-      : mListener(aListener), mNotifyFlags(aNotifyFlags) {}</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+        : mListener(aListener), mNotifyFlags(aNotifyFlags) {}</span>
<a href="#l14.52"></a><span id="l14.52">     folderListener(const folderListener &amp;aListener)</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-      : mListener(aListener.mListener), mNotifyFlags(aListener.mNotifyFlags) {}</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+        : mListener(aListener.mListener),</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+          mNotifyFlags(aListener.mNotifyFlags) {}</span>
<a href="#l14.56"></a><span id="l14.56">     ~folderListener() {}</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-    int operator==(nsIFolderListener* aListener) const {</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+    int operator==(nsIFolderListener *aListener) const {</span>
<a href="#l14.60"></a><span id="l14.60">       return mListener == aListener;</span>
<a href="#l14.61"></a><span id="l14.61">     }</span>
<a href="#l14.62"></a><span id="l14.62">     int operator==(const folderListener &amp;aListener) const {</span>
<a href="#l14.63"></a><span id="l14.63">       return mListener == aListener.mListener &amp;&amp;</span>
<a href="#l14.64"></a><span id="l14.64">              mNotifyFlags == aListener.mNotifyFlags;</span>
<a href="#l14.65"></a><span id="l14.65">     }</span>
<a href="#l14.66"></a><span id="l14.66">   };</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68">   nsTObserverArray&lt;folderListener&gt; mListeners;</span>
<a href="#l14.69"></a><span id="l14.69">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgUserFeedbackListener&gt; &gt; mFeedbackListeners;</span>
<a href="#l14.70"></a><span id="l14.70"> </span>
<a href="#l14.71"></a><span id="l14.71">   nsCOMArray&lt;nsIMsgWindow&gt; mWindows;</span>
<a href="#l14.72"></a><span id="l14.72">   // stick this here temporarily</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_temporaryMsgWindow;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_temporaryMsgWindow;</span>
<a href="#l14.75"></a><span id="l14.75"> };</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77"> /********************************************************************************/</span>
<a href="#l14.78"></a><span id="l14.78"> </span>
<a href="#l14.79"></a><span id="l14.79"> class nsMsgShutdownService : public nsIMsgShutdownService,</span>
<a href="#l14.80"></a><span id="l14.80">                              public nsIUrlListener,</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-                             public nsIObserver</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-{</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-public:</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+                             public nsIObserver {</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+ public:</span>
<a href="#l14.86"></a><span id="l14.86">   nsMsgShutdownService();</span>
<a href="#l14.87"></a><span id="l14.87"> </span>
<a href="#l14.88"></a><span id="l14.88">   NS_DECL_ISUPPORTS</span>
<a href="#l14.89"></a><span id="l14.89">   NS_DECL_NSIMSGSHUTDOWNSERVICE</span>
<a href="#l14.90"></a><span id="l14.90">   NS_DECL_NSIURLLISTENER</span>
<a href="#l14.91"></a><span id="l14.91">   NS_DECL_NSIOBSERVER</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-protected:</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+ protected:</span>
<a href="#l14.95"></a><span id="l14.95">   nsresult ProcessNextTask();</span>
<a href="#l14.96"></a><span id="l14.96">   void AttemptShutdown();</span>
<a href="#l14.97"></a><span id="l14.97"> </span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-private:</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+ private:</span>
<a href="#l14.100"></a><span id="l14.100">   virtual ~nsMsgShutdownService();</span>
<a href="#l14.101"></a><span id="l14.101"> </span>
<a href="#l14.102"></a><span id="l14.102">   nsCOMArray&lt;nsIMsgShutdownTask&gt; mShutdownTasks;</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-  nsCOMPtr&lt;nsIMsgProgress&gt;       mMsgProgress;</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  uint32_t                       mTaskIndex;</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-  uint32_t                       mQuitMode;</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  nsCOMPtr&lt;nsIMsgProgress&gt; mMsgProgress;</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+  uint32_t mTaskIndex;</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+  uint32_t mQuitMode;</span>
<a href="#l14.109"></a><span id="l14.109">   bool mProcessedShutdown;</span>
<a href="#l14.110"></a><span id="l14.110">   bool mQuitForced;</span>
<a href="#l14.111"></a><span id="l14.111">   bool mReadyToQuit;</span>
<a href="#l14.112"></a><span id="l14.112"> };</span>
<a href="#l14.113"></a><span id="l14.113"> </span>
<a href="#l14.114"></a><span id="l14.114"> #endif /* nsMsgMailSession_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMsgOfflineManager.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgOfflineManager.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> /*</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">- * The offline manager service - manages going online and offline, and synchronization</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * The offline manager service - manages going online and offline, and</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ * synchronization</span>
<a href="#l15.13"></a><span id="l15.13">  */</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;msgCore.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;netCore.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsMsgOfflineManager.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -23,128 +24,106 @@</span>
<a href="#l15.22"></a><span id="l15.22"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l15.23"></a><span id="l15.23"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l15.24"></a><span id="l15.24"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l15.25"></a><span id="l15.25"> #include &quot;nsIArray.h&quot;</span>
<a href="#l15.26"></a><span id="l15.26"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> static NS_DEFINE_CID(kMsgSendLaterCID, NS_MSGSENDLATER_CID);</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgOfflineManager,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-                              nsIMsgOfflineManager,</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-                              nsIMsgSendLaterListener,</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-                              nsIObserver,</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-                              nsISupportsWeakReference,</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-                              nsIUrlListener)</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgOfflineManager, nsIMsgOfflineManager,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+                  nsIMsgSendLaterListener, nsIObserver,</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+                  nsISupportsWeakReference, nsIUrlListener)</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-nsMsgOfflineManager::nsMsgOfflineManager() :</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  m_inProgress (false),</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  m_sendUnsentMessages(false),</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-  m_downloadNews(false),</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  m_downloadMail(false),</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  m_playbackOfflineImapOps(false),</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  m_goOfflineWhenDone(false),</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  m_curState(eNoState),</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  m_curOperation(eNoOp)</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-{</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-}</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+nsMsgOfflineManager::nsMsgOfflineManager()</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+    : m_inProgress(false),</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+      m_sendUnsentMessages(false),</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+      m_downloadNews(false),</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+      m_downloadMail(false),</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+      m_playbackOfflineImapOps(false),</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+      m_goOfflineWhenDone(false),</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+      m_curState(eNoState),</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+      m_curOperation(eNoOp) {}</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-nsMsgOfflineManager::~nsMsgOfflineManager()</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-{</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-}</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+nsMsgOfflineManager::~nsMsgOfflineManager() {}</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66"> /* attribute nsIMsgWindow window; */</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineManager::GetWindow(nsIMsgWindow * *aWindow)</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-{</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineManager::GetWindow(nsIMsgWindow **aWindow) {</span>
<a href="#l15.70"></a><span id="l15.70">   NS_ENSURE_ARG(aWindow);</span>
<a href="#l15.71"></a><span id="l15.71">   NS_IF_ADDREF(*aWindow = m_window);</span>
<a href="#l15.72"></a><span id="l15.72">   return NS_OK;</span>
<a href="#l15.73"></a><span id="l15.73"> }</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineManager::SetWindow(nsIMsgWindow * aWindow)</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-{</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineManager::SetWindow(nsIMsgWindow *aWindow) {</span>
<a href="#l15.77"></a><span id="l15.77">   m_window = aWindow;</span>
<a href="#l15.78"></a><span id="l15.78">   if (m_window)</span>
<a href="#l15.79"></a><span id="l15.79">     m_window-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l15.80"></a><span id="l15.80">   else</span>
<a href="#l15.81"></a><span id="l15.81">     m_statusFeedback = nullptr;</span>
<a href="#l15.82"></a><span id="l15.82">   return NS_OK;</span>
<a href="#l15.83"></a><span id="l15.83"> }</span>
<a href="#l15.84"></a><span id="l15.84"> </span>
<a href="#l15.85"></a><span id="l15.85"> /* attribute boolean inProgress; */</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineManager::GetInProgress(bool *aInProgress)</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-{</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineManager::GetInProgress(bool *aInProgress) {</span>
<a href="#l15.89"></a><span id="l15.89">   NS_ENSURE_ARG(aInProgress);</span>
<a href="#l15.90"></a><span id="l15.90">   *aInProgress = m_inProgress;</span>
<a href="#l15.91"></a><span id="l15.91">   return NS_OK;</span>
<a href="#l15.92"></a><span id="l15.92"> }</span>
<a href="#l15.93"></a><span id="l15.93"> </span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineManager::SetInProgress(bool aInProgress)</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-{</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineManager::SetInProgress(bool aInProgress) {</span>
<a href="#l15.97"></a><span id="l15.97">   m_inProgress = aInProgress;</span>
<a href="#l15.98"></a><span id="l15.98">   return NS_OK;</span>
<a href="#l15.99"></a><span id="l15.99"> }</span>
<a href="#l15.100"></a><span id="l15.100"> </span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-nsresult nsMsgOfflineManager::StopRunning(nsresult exitStatus)</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-{</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+nsresult nsMsgOfflineManager::StopRunning(nsresult exitStatus) {</span>
<a href="#l15.104"></a><span id="l15.104">   m_inProgress = false;</span>
<a href="#l15.105"></a><span id="l15.105">   return exitStatus;</span>
<a href="#l15.106"></a><span id="l15.106"> }</span>
<a href="#l15.107"></a><span id="l15.107"> </span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-nsresult nsMsgOfflineManager::AdvanceToNextState(nsresult exitStatus)</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-{</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+nsresult nsMsgOfflineManager::AdvanceToNextState(nsresult exitStatus) {</span>
<a href="#l15.111"></a><span id="l15.111">   // NS_BINDING_ABORTED is used for the user pressing stop, which</span>
<a href="#l15.112"></a><span id="l15.112">   // should cause us to abort the offline process. Other errors</span>
<a href="#l15.113"></a><span id="l15.113">   // should allow us to continue.</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-  if (exitStatus == NS_BINDING_ABORTED)</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-  {</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+  if (exitStatus == NS_BINDING_ABORTED) {</span>
<a href="#l15.117"></a><span id="l15.117">     return StopRunning(exitStatus);</span>
<a href="#l15.118"></a><span id="l15.118">   }</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  if (m_curOperation == eGoingOnline)</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-  {</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-    switch (m_curState)</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-    {</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    case eNoState:</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+  if (m_curOperation == eGoingOnline) {</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+    switch (m_curState) {</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+      case eNoState:</span>
<a href="#l15.127"></a><span id="l15.127"> </span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-      m_curState = eSendingUnsent;</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-      if (m_sendUnsentMessages)</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-      {</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-        SendUnsentMessages();</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-      }</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-      else</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-        AdvanceToNextState(NS_OK);</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-      break;</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-    case eSendingUnsent:</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+        m_curState = eSendingUnsent;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+        if (m_sendUnsentMessages) {</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+          SendUnsentMessages();</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+        } else</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+          AdvanceToNextState(NS_OK);</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+        break;</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+      case eSendingUnsent:</span>
<a href="#l15.144"></a><span id="l15.144"> </span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-      m_curState = eSynchronizingOfflineImapChanges;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-      if (m_playbackOfflineImapOps)</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-        return SynchronizeOfflineImapChanges();</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-      else</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-        AdvanceToNextState(NS_OK); // recurse to next state.</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-      break;</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-    case eSynchronizingOfflineImapChanges:</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-      m_curState = eDone;</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-      return StopRunning(exitStatus);</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+        m_curState = eSynchronizingOfflineImapChanges;</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+        if (m_playbackOfflineImapOps)</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+          return SynchronizeOfflineImapChanges();</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+        else</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+          AdvanceToNextState(NS_OK);  // recurse to next state.</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+        break;</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+      case eSynchronizingOfflineImapChanges:</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+        m_curState = eDone;</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+        return StopRunning(exitStatus);</span>
<a href="#l15.163"></a><span id="l15.163">       default:</span>
<a href="#l15.164"></a><span id="l15.164">         NS_ASSERTION(false, &quot;unhandled current state when going online&quot;);</span>
<a href="#l15.165"></a><span id="l15.165">     }</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-  }</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-  else if (m_curOperation == eDownloadingForOffline)</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-  {</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-    switch (m_curState)</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-    {</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+  } else if (m_curOperation == eDownloadingForOffline) {</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+    switch (m_curState) {</span>
<a href="#l15.173"></a><span id="l15.173">       case eNoState:</span>
<a href="#l15.174"></a><span id="l15.174">         m_curState = eDownloadingNews;</span>
<a href="#l15.175"></a><span id="l15.175">         if (m_downloadNews)</span>
<a href="#l15.176"></a><span id="l15.176">           DownloadOfflineNewsgroups();</span>
<a href="#l15.177"></a><span id="l15.177">         else</span>
<a href="#l15.178"></a><span id="l15.178">           AdvanceToNextState(NS_OK);</span>
<a href="#l15.179"></a><span id="l15.179">         break;</span>
<a href="#l15.180"></a><span id="l15.180">       case eSendingUnsent:</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-        if (m_goOfflineWhenDone)</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-        {</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+        if (m_goOfflineWhenDone) {</span>
<a href="#l15.184"></a><span id="l15.184">           SetOnlineState(false);</span>
<a href="#l15.185"></a><span id="l15.185">         }</span>
<a href="#l15.186"></a><span id="l15.186">         break;</span>
<a href="#l15.187"></a><span id="l15.187">       case eDownloadingNews:</span>
<a href="#l15.188"></a><span id="l15.188">         m_curState = eDownloadingMail;</span>
<a href="#l15.189"></a><span id="l15.189">         if (m_downloadMail)</span>
<a href="#l15.190"></a><span id="l15.190">           DownloadMail();</span>
<a href="#l15.191"></a><span id="l15.191">         else</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineat">@@ -153,245 +132,225 @@ nsresult nsMsgOfflineManager::AdvanceToN</span>
<a href="#l15.193"></a><span id="l15.193">       case eDownloadingMail:</span>
<a href="#l15.194"></a><span id="l15.194">         m_curState = eSendingUnsent;</span>
<a href="#l15.195"></a><span id="l15.195">         if (m_sendUnsentMessages)</span>
<a href="#l15.196"></a><span id="l15.196">           SendUnsentMessages();</span>
<a href="#l15.197"></a><span id="l15.197">         else</span>
<a href="#l15.198"></a><span id="l15.198">           AdvanceToNextState(NS_OK);</span>
<a href="#l15.199"></a><span id="l15.199">         break;</span>
<a href="#l15.200"></a><span id="l15.200">       default:</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-        NS_ASSERTION(false, &quot;unhandled current state when downloading for offline&quot;);</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+        NS_ASSERTION(false,</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+                     &quot;unhandled current state when downloading for offline&quot;);</span>
<a href="#l15.204"></a><span id="l15.204">     }</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-</span>
<a href="#l15.206"></a><span id="l15.206">   }</span>
<a href="#l15.207"></a><span id="l15.207">   return NS_OK;</span>
<a href="#l15.208"></a><span id="l15.208"> }</span>
<a href="#l15.209"></a><span id="l15.209"> </span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-nsresult nsMsgOfflineManager::SynchronizeOfflineImapChanges()</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-{</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+nsresult nsMsgOfflineManager::SynchronizeOfflineImapChanges() {</span>
<a href="#l15.213"></a><span id="l15.213">   nsresult rv = NS_OK;</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+      do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.217"></a><span id="l15.217">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-  return imapService-&gt;PlaybackAllOfflineOperations(m_window, this, getter_AddRefs(mOfflineImapSync));</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineplus">+  return imapService-&gt;PlaybackAllOfflineOperations(</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineplus">+      m_window, this, getter_AddRefs(mOfflineImapSync));</span>
<a href="#l15.221"></a><span id="l15.221"> }</span>
<a href="#l15.222"></a><span id="l15.222"> </span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-nsresult nsMsgOfflineManager::SendUnsentMessages()</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-{</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+nsresult nsMsgOfflineManager::SendUnsentMessages() {</span>
<a href="#l15.226"></a><span id="l15.226">   nsresult rv;</span>
<a href="#l15.227"></a><span id="l15.227">   nsCOMPtr&lt;nsIMsgSendLater&gt; pMsgSendLater(do_GetService(kMsgSendLaterCID, &amp;rv));</span>
<a href="#l15.228"></a><span id="l15.228">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.229"></a><span id="l15.229">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.232"></a><span id="l15.232">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-  // now we have to iterate over the identities, finding the *unique* unsent messages folder</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-  // for each one, determine if they have unsent messages, and if so, add them to the list</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-  // of identities to send unsent messages from.</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-  // However, I think there's only ever one unsent messages folder at the moment,</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-  // so I think we'll go with that for now.</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+  // now we have to iterate over the identities, finding the *unique* unsent</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+  // messages folder for each one, determine if they have unsent messages, and</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+  // if so, add them to the list of identities to send unsent messages from.</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+  // However, I think there's only ever one unsent messages folder at the</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+  // moment, so I think we'll go with that for now.</span>
<a href="#l15.243"></a><span id="l15.243">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l15.244"></a><span id="l15.244"> </span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager)</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineminus">-  {</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l15.248"></a><span id="l15.248">     rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l15.249"></a><span id="l15.249">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.250"></a><span id="l15.250">   }</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIdentity&gt; identityToUse;</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; identityToUse;</span>
<a href="#l15.253"></a><span id="l15.253">   uint32_t numIndentities;</span>
<a href="#l15.254"></a><span id="l15.254">   identities-&gt;GetLength(&amp;numIndentities);</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-  for (uint32_t i = 0; i &lt; numIndentities; i++)</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-  {</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity)</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-    {</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; outboxFolder;</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-      pMsgSendLater-&gt;GetUnsentMessagesFolder(thisIdentity, getter_AddRefs(outboxFolder));</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-      if (outboxFolder)</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineminus">-      {</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+  for (uint32_t i = 0; i &lt; numIndentities; i++) {</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+        do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity) {</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; outboxFolder;</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+      pMsgSendLater-&gt;GetUnsentMessagesFolder(thisIdentity,</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+                                             getter_AddRefs(outboxFolder));</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+      if (outboxFolder) {</span>
<a href="#l15.272"></a><span id="l15.272">         int32_t numMessages;</span>
<a href="#l15.273"></a><span id="l15.273">         outboxFolder-&gt;GetTotalMessages(false, &amp;numMessages);</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-        if (numMessages &gt; 0)</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-        {</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+        if (numMessages &gt; 0) {</span>
<a href="#l15.277"></a><span id="l15.277">           identityToUse = thisIdentity;</span>
<a href="#l15.278"></a><span id="l15.278">           break;</span>
<a href="#l15.279"></a><span id="l15.279">         }</span>
<a href="#l15.280"></a><span id="l15.280">       }</span>
<a href="#l15.281"></a><span id="l15.281">     }</span>
<a href="#l15.282"></a><span id="l15.282">   }</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineminus">-  if (identityToUse)</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineminus">-  {</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+  if (identityToUse) {</span>
<a href="#l15.286"></a><span id="l15.286"> #ifdef MOZ_SUITE</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-    if (m_statusFeedback)</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineminus">-      pMsgSendLater-&gt;SetStatusFeedback(m_statusFeedback);</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineplus">+    if (m_statusFeedback) pMsgSendLater-&gt;SetStatusFeedback(m_statusFeedback);</span>
<a href="#l15.290"></a><span id="l15.290"> #endif</span>
<a href="#l15.291"></a><span id="l15.291"> </span>
<a href="#l15.292"></a><span id="l15.292">     pMsgSendLater-&gt;AddListener(this);</span>
<a href="#l15.293"></a><span id="l15.293">     rv = pMsgSendLater-&gt;SendUnsentMessages(identityToUse);</span>
<a href="#l15.294"></a><span id="l15.294">     ShowStatus(&quot;sendingUnsent&quot;);</span>
<a href="#l15.295"></a><span id="l15.295">     // if we succeeded, return - we'll run the next operation when the</span>
<a href="#l15.296"></a><span id="l15.296">     // send finishes. Otherwise, advance to the next state.</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-      return rv;</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineplus">+    if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l15.300"></a><span id="l15.300">   }</span>
<a href="#l15.301"></a><span id="l15.301">   return AdvanceToNextState(rv);</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-</span>
<a href="#l15.303"></a><span id="l15.303"> }</span>
<a href="#l15.304"></a><span id="l15.304"> </span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-#define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineplus">+#define MESSENGER_STRING_URL &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l15.307"></a><span id="l15.307"> </span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-nsresult nsMsgOfflineManager::ShowStatus(const char *statusMsgName)</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-{</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineminus">-  if (!mStringBundle)</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineminus">-  {</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+nsresult nsMsgOfflineManager::ShowStatus(const char *statusMsgName) {</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+  if (!mStringBundle) {</span>
<a href="#l15.314"></a><span id="l15.314">     nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l15.317"></a><span id="l15.317">     NS_ENSURE_TRUE(sBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-    sBundleService-&gt;CreateBundle(MESSENGER_STRING_URL, getter_AddRefs(mStringBundle));</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+    sBundleService-&gt;CreateBundle(MESSENGER_STRING_URL,</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+                                 getter_AddRefs(mStringBundle));</span>
<a href="#l15.321"></a><span id="l15.321">     return NS_OK;</span>
<a href="#l15.322"></a><span id="l15.322">   }</span>
<a href="#l15.323"></a><span id="l15.323"> </span>
<a href="#l15.324"></a><span id="l15.324">   nsString statusString;</span>
<a href="#l15.325"></a><span id="l15.325">   nsresult res = mStringBundle-&gt;GetStringFromName(statusMsgName, statusString);</span>
<a href="#l15.326"></a><span id="l15.326"> </span>
<a href="#l15.327"></a><span id="l15.327">   if (NS_SUCCEEDED(res) &amp;&amp; m_statusFeedback)</span>
<a href="#l15.328"></a><span id="l15.328">     m_statusFeedback-&gt;ShowStatusString(statusString);</span>
<a href="#l15.329"></a><span id="l15.329"> </span>
<a href="#l15.330"></a><span id="l15.330">   return res;</span>
<a href="#l15.331"></a><span id="l15.331"> }</span>
<a href="#l15.332"></a><span id="l15.332"> </span>
<a href="#l15.333"></a><span id="l15.333" class="difflineminus">-nsresult nsMsgOfflineManager::DownloadOfflineNewsgroups()</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineminus">-{</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineplus">+nsresult nsMsgOfflineManager::DownloadOfflineNewsgroups() {</span>
<a href="#l15.336"></a><span id="l15.336">   nsresult rv;</span>
<a href="#l15.337"></a><span id="l15.337">   ShowStatus(&quot;downloadingNewsgroups&quot;);</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineminus">-  nsCOMPtr&lt;nsINntpService&gt; nntpService(do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService(</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.341"></a><span id="l15.341">   if (NS_SUCCEEDED(rv) &amp;&amp; nntpService)</span>
<a href="#l15.342"></a><span id="l15.342">     rv = nntpService-&gt;DownloadNewsgroupsForOffline(m_window, this);</span>
<a href="#l15.343"></a><span id="l15.343"> </span>
<a href="#l15.344"></a><span id="l15.344" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineminus">-    return AdvanceToNextState(rv);</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineplus">+  if (NS_FAILED(rv)) return AdvanceToNextState(rv);</span>
<a href="#l15.347"></a><span id="l15.347">   return rv;</span>
<a href="#l15.348"></a><span id="l15.348"> }</span>
<a href="#l15.349"></a><span id="l15.349"> </span>
<a href="#l15.350"></a><span id="l15.350" class="difflineminus">-nsresult nsMsgOfflineManager::DownloadMail()</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineminus">-{</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineplus">+nsresult nsMsgOfflineManager::DownloadMail() {</span>
<a href="#l15.353"></a><span id="l15.353">   nsresult rv = NS_OK;</span>
<a href="#l15.354"></a><span id="l15.354">   ShowStatus(&quot;downloadingMail&quot;);</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineplus">+      do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.358"></a><span id="l15.358">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.359"></a><span id="l15.359">   return imapService-&gt;DownloadAllOffineImapFolders(m_window, this);</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-  // ### we should do get new mail on pop servers, and download imap messages for offline use.</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineplus">+  // ### we should do get new mail on pop servers, and download imap messages</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+  // for offline use.</span>
<a href="#l15.363"></a><span id="l15.363"> }</span>
<a href="#l15.364"></a><span id="l15.364"> </span>
<a href="#l15.365"></a><span id="l15.365" class="difflineminus">-/* void goOnline (in boolean sendUnsentMessages, in boolean playbackOfflineImapOperations, in nsIMsgWindow aMsgWindow); */</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineManager::GoOnline(bool sendUnsentMessages, bool playbackOfflineImapOperations, nsIMsgWindow *aMsgWindow)</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineminus">-{</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineManager::GoOnline(bool sendUnsentMessages,</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineplus">+                                            bool playbackOfflineImapOperations,</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineplus">+                                            nsIMsgWindow *aMsgWindow) {</span>
<a href="#l15.371"></a><span id="l15.371">   m_sendUnsentMessages = sendUnsentMessages;</span>
<a href="#l15.372"></a><span id="l15.372">   m_playbackOfflineImapOps = playbackOfflineImapOperations;</span>
<a href="#l15.373"></a><span id="l15.373">   m_curOperation = eGoingOnline;</span>
<a href="#l15.374"></a><span id="l15.374">   m_curState = eNoState;</span>
<a href="#l15.375"></a><span id="l15.375">   SetWindow(aMsgWindow);</span>
<a href="#l15.376"></a><span id="l15.376">   SetOnlineState(true);</span>
<a href="#l15.377"></a><span id="l15.377">   if (!m_sendUnsentMessages &amp;&amp; !playbackOfflineImapOperations)</span>
<a href="#l15.378"></a><span id="l15.378">     return NS_OK;</span>
<a href="#l15.379"></a><span id="l15.379">   else</span>
<a href="#l15.380"></a><span id="l15.380">     AdvanceToNextState(NS_OK);</span>
<a href="#l15.381"></a><span id="l15.381">   return NS_OK;</span>
<a href="#l15.382"></a><span id="l15.382"> }</span>
<a href="#l15.383"></a><span id="l15.383"> </span>
<a href="#l15.384"></a><span id="l15.384" class="difflineminus">-/* void synchronizeForOffline (in boolean downloadNews, in boolean downloadMail, in boolean sendUnsentMessages, in boolean goOfflineWhenDone, in nsIMsgWindow aMsgWindow); */</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineManager::SynchronizeForOffline(bool downloadNews, bool downloadMail, bool sendUnsentMessages, bool goOfflineWhenDone, nsIMsgWindow *aMsgWindow)</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-{</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineManager::SynchronizeForOffline(</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineplus">+    bool downloadNews, bool downloadMail, bool sendUnsentMessages,</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+    bool goOfflineWhenDone, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l15.390"></a><span id="l15.390">   m_curOperation = eDownloadingForOffline;</span>
<a href="#l15.391"></a><span id="l15.391">   m_downloadNews = downloadNews;</span>
<a href="#l15.392"></a><span id="l15.392">   m_downloadMail = downloadMail;</span>
<a href="#l15.393"></a><span id="l15.393">   m_sendUnsentMessages = sendUnsentMessages;</span>
<a href="#l15.394"></a><span id="l15.394">   SetWindow(aMsgWindow);</span>
<a href="#l15.395"></a><span id="l15.395">   m_goOfflineWhenDone = goOfflineWhenDone;</span>
<a href="#l15.396"></a><span id="l15.396">   m_curState = eNoState;</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineminus">-  if (!downloadNews &amp;&amp; !downloadMail &amp;&amp; !sendUnsentMessages)</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineminus">-  {</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineminus">-    if (goOfflineWhenDone)</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineminus">-      return SetOnlineState(false);</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-  }</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-  else</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+  if (!downloadNews &amp;&amp; !downloadMail &amp;&amp; !sendUnsentMessages) {</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+    if (goOfflineWhenDone) return SetOnlineState(false);</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+  } else</span>
<a href="#l15.406"></a><span id="l15.406">     return AdvanceToNextState(NS_OK);</span>
<a href="#l15.407"></a><span id="l15.407">   return NS_OK;</span>
<a href="#l15.408"></a><span id="l15.408"> }</span>
<a href="#l15.409"></a><span id="l15.409"> </span>
<a href="#l15.410"></a><span id="l15.410" class="difflineminus">-nsresult nsMsgOfflineManager::SetOnlineState(bool online)</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineminus">-{</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; netService =</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineplus">+nsresult nsMsgOfflineManager::SetOnlineState(bool online) {</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; netService = mozilla::services::GetIOService();</span>
<a href="#l15.416"></a><span id="l15.416">   NS_ENSURE_TRUE(netService, NS_ERROR_UNEXPECTED);</span>
<a href="#l15.417"></a><span id="l15.417">   return netService-&gt;SetOffline(!online);</span>
<a href="#l15.418"></a><span id="l15.418"> }</span>
<a href="#l15.419"></a><span id="l15.419"> </span>
<a href="#l15.420"></a><span id="l15.420" class="difflineminus">-  // nsIUrlListener methods</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineplus">+// nsIUrlListener methods</span>
<a href="#l15.422"></a><span id="l15.422"> </span>
<a href="#l15.423"></a><span id="l15.423"> NS_IMETHODIMP</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineminus">-nsMsgOfflineManager::OnStartRunningUrl(nsIURI * aUrl)</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineminus">-{</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineminus">-    return NS_OK;</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineminus">-}</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineplus">+nsMsgOfflineManager::OnStartRunningUrl(nsIURI *aUrl) { return NS_OK; }</span>
<a href="#l15.429"></a><span id="l15.429"> </span>
<a href="#l15.430"></a><span id="l15.430"> NS_IMETHODIMP</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineminus">-nsMsgOfflineManager::OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode)</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineminus">-{</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+nsMsgOfflineManager::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l15.434"></a><span id="l15.434">   mOfflineImapSync = nullptr;</span>
<a href="#l15.435"></a><span id="l15.435"> </span>
<a href="#l15.436"></a><span id="l15.436">   AdvanceToNextState(aExitCode);</span>
<a href="#l15.437"></a><span id="l15.437">   return NS_OK;</span>
<a href="#l15.438"></a><span id="l15.438"> }</span>
<a href="#l15.439"></a><span id="l15.439"> </span>
<a href="#l15.440"></a><span id="l15.440" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineManager::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineminus">-{</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineManager::Observe(nsISupports *aSubject,</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineplus">+                                           const char *aTopic,</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineplus">+                                           const char16_t *someData) {</span>
<a href="#l15.445"></a><span id="l15.445">   return NS_OK;</span>
<a href="#l15.446"></a><span id="l15.446"> }</span>
<a href="#l15.447"></a><span id="l15.447"> </span>
<a href="#l15.448"></a><span id="l15.448"> // nsIMsgSendLaterListener implementation</span>
<a href="#l15.449"></a><span id="l15.449"> NS_IMETHODIMP</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineminus">-nsMsgOfflineManager::OnStartSending(uint32_t aTotalMessageCount)</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineminus">-{</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineplus">+nsMsgOfflineManager::OnStartSending(uint32_t aTotalMessageCount) {</span>
<a href="#l15.453"></a><span id="l15.453">   return NS_OK;</span>
<a href="#l15.454"></a><span id="l15.454"> }</span>
<a href="#l15.455"></a><span id="l15.455"> </span>
<a href="#l15.456"></a><span id="l15.456"> NS_IMETHODIMP</span>
<a href="#l15.457"></a><span id="l15.457"> nsMsgOfflineManager::OnMessageStartSending(uint32_t aCurrentMessage,</span>
<a href="#l15.458"></a><span id="l15.458">                                            uint32_t aTotalMessageCount,</span>
<a href="#l15.459"></a><span id="l15.459">                                            nsIMsgDBHdr *aMessageHeader,</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-                                           nsIMsgIdentity *aIdentity)</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineminus">-{</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineplus">+                                           nsIMsgIdentity *aIdentity) {</span>
<a href="#l15.463"></a><span id="l15.463">   return NS_OK;</span>
<a href="#l15.464"></a><span id="l15.464"> }</span>
<a href="#l15.465"></a><span id="l15.465"> </span>
<a href="#l15.466"></a><span id="l15.466"> NS_IMETHODIMP</span>
<a href="#l15.467"></a><span id="l15.467"> nsMsgOfflineManager::OnMessageSendProgress(uint32_t aCurrentMessage,</span>
<a href="#l15.468"></a><span id="l15.468">                                            uint32_t aTotalMessageCount,</span>
<a href="#l15.469"></a><span id="l15.469">                                            uint32_t aMessageSendPercent,</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineminus">-                                           uint32_t aMessageCopyPercent)</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-{</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineplus">+                                           uint32_t aMessageCopyPercent) {</span>
<a href="#l15.473"></a><span id="l15.473">   if (m_statusFeedback &amp;&amp; aTotalMessageCount)</span>
<a href="#l15.474"></a><span id="l15.474">     return m_statusFeedback-&gt;ShowProgress((100 * aCurrentMessage) /</span>
<a href="#l15.475"></a><span id="l15.475">                                           aTotalMessageCount);</span>
<a href="#l15.476"></a><span id="l15.476"> </span>
<a href="#l15.477"></a><span id="l15.477">   return NS_OK;</span>
<a href="#l15.478"></a><span id="l15.478"> }</span>
<a href="#l15.479"></a><span id="l15.479"> </span>
<a href="#l15.480"></a><span id="l15.480"> NS_IMETHODIMP</span>
<a href="#l15.481"></a><span id="l15.481"> nsMsgOfflineManager::OnMessageSendError(uint32_t aCurrentMessage,</span>
<a href="#l15.482"></a><span id="l15.482">                                         nsIMsgDBHdr *aMessageHeader,</span>
<a href="#l15.483"></a><span id="l15.483">                                         nsresult aStatus,</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineminus">-                                        const char16_t *aMsg)</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineminus">-{</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineplus">+                                        const char16_t *aMsg) {</span>
<a href="#l15.487"></a><span id="l15.487">   return NS_OK;</span>
<a href="#l15.488"></a><span id="l15.488"> }</span>
<a href="#l15.489"></a><span id="l15.489"> </span>
<a href="#l15.490"></a><span id="l15.490"> NS_IMETHODIMP</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineminus">-nsMsgOfflineManager::OnStopSending(nsresult aStatus,</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineminus">-                                   const char16_t *aMsg, uint32_t aTotalTried,</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineminus">-                                   uint32_t aSuccessful)</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineminus">-{</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+nsMsgOfflineManager::OnStopSending(nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineplus">+                                   uint32_t aTotalTried, uint32_t aSuccessful) {</span>
<a href="#l15.497"></a><span id="l15.497"> #ifdef NS_DEBUG</span>
<a href="#l15.498"></a><span id="l15.498">   if (NS_SUCCEEDED(aStatus))</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineminus">-    printf(&quot;SendLaterListener::OnStopSending: Tried to send %d messages. %d successful.\n&quot;,</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineminus">-            aTotalTried, aSuccessful);</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineplus">+    printf(</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineplus">+        &quot;SendLaterListener::OnStopSending: Tried to send %d messages. %d &quot;</span>
<a href="#l15.503"></a><span id="l15.503" class="difflineplus">+        &quot;successful.\n&quot;,</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineplus">+        aTotalTried, aSuccessful);</span>
<a href="#l15.505"></a><span id="l15.505"> #endif</span>
<a href="#l15.506"></a><span id="l15.506">   return AdvanceToNextState(aStatus);</span>
<a href="#l15.507"></a><span id="l15.507"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/src/nsMsgOfflineManager.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgOfflineManager.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -11,55 +11,50 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIMsgSendLaterListener.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-class nsMsgOfflineManager</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  : public nsIMsgOfflineManager,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    public nsIObserver,</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-    public nsSupportsWeakReference,</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-    public nsIMsgSendLaterListener,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-    public nsIUrlListener</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-{</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-public:</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+class nsMsgOfflineManager : public nsIMsgOfflineManager,</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+                            public nsIObserver,</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+                            public nsSupportsWeakReference,</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+                            public nsIMsgSendLaterListener,</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+                            public nsIUrlListener {</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ public:</span>
<a href="#l16.27"></a><span id="l16.27">   nsMsgOfflineManager();</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31">   /* nsIMsgOfflineManager methods */</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">   NS_DECL_NSIMSGOFFLINEMANAGER</span>
<a href="#l16.34"></a><span id="l16.34">   NS_DECL_NSIOBSERVER</span>
<a href="#l16.35"></a><span id="l16.35">   NS_DECL_NSIURLLISTENER</span>
<a href="#l16.36"></a><span id="l16.36">   NS_DECL_NSIMSGSENDLATERLISTENER</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  typedef enum</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  {</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+  typedef enum {</span>
<a href="#l16.41"></a><span id="l16.41">     eStarting = 0,</span>
<a href="#l16.42"></a><span id="l16.42">     eSynchronizingOfflineImapChanges = 1,</span>
<a href="#l16.43"></a><span id="l16.43">     eDownloadingNews = 2,</span>
<a href="#l16.44"></a><span id="l16.44">     eDownloadingMail = 3,</span>
<a href="#l16.45"></a><span id="l16.45">     eSendingUnsent = 4,</span>
<a href="#l16.46"></a><span id="l16.46">     eDone = 5,</span>
<a href="#l16.47"></a><span id="l16.47">     eNoState = 6  // we're not doing anything</span>
<a href="#l16.48"></a><span id="l16.48">   } offlineManagerState;</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  typedef enum</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  {</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  typedef enum {</span>
<a href="#l16.53"></a><span id="l16.53">     eGoingOnline = 0,</span>
<a href="#l16.54"></a><span id="l16.54">     eDownloadingForOffline = 1,</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-    eNoOp = 2 // no operation in progress</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+    eNoOp = 2  // no operation in progress</span>
<a href="#l16.57"></a><span id="l16.57">   } offlineManagerOperation;</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-private:</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+ private:</span>
<a href="#l16.61"></a><span id="l16.61">   virtual ~nsMsgOfflineManager();</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63">   nsresult AdvanceToNextState(nsresult exitStatus);</span>
<a href="#l16.64"></a><span id="l16.64">   nsresult SynchronizeOfflineImapChanges();</span>
<a href="#l16.65"></a><span id="l16.65">   nsresult StopRunning(nsresult exitStatus);</span>
<a href="#l16.66"></a><span id="l16.66">   nsresult SendUnsentMessages();</span>
<a href="#l16.67"></a><span id="l16.67">   nsresult DownloadOfflineNewsgroups();</span>
<a href="#l16.68"></a><span id="l16.68">   nsresult DownloadMail();</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineat">@@ -70,16 +65,15 @@ private:</span>
<a href="#l16.70"></a><span id="l16.70">   bool m_inProgress;</span>
<a href="#l16.71"></a><span id="l16.71">   bool m_sendUnsentMessages;</span>
<a href="#l16.72"></a><span id="l16.72">   bool m_downloadNews;</span>
<a href="#l16.73"></a><span id="l16.73">   bool m_downloadMail;</span>
<a href="#l16.74"></a><span id="l16.74">   bool m_playbackOfflineImapOps;</span>
<a href="#l16.75"></a><span id="l16.75">   bool m_goOfflineWhenDone;</span>
<a href="#l16.76"></a><span id="l16.76">   offlineManagerState m_curState;</span>
<a href="#l16.77"></a><span id="l16.77">   offlineManagerOperation m_curOperation;</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-  nsCOMPtr &lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;   mStringBundle;</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; mStringBundle;</span>
<a href="#l16.84"></a><span id="l16.84">   nsCOMPtr&lt;nsISupports&gt; mOfflineImapSync;</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-</span>
<a href="#l16.86"></a><span id="l16.86"> };</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -35,711 +35,626 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsIBaseWindow.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsIDocShellTreeOwner.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIDocShellTreeItem.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-static const char* kPrintingPromptService = &quot;@mozilla.org/embedcomp/printingprompt-service;1&quot;;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+static const char *kPrintingPromptService =</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+    &quot;@mozilla.org/embedcomp/printingprompt-service;1&quot;;</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> /////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.17"></a><span id="l17.17"> // nsMsgPrintEngine implementation</span>
<a href="#l17.18"></a><span id="l17.18"> /////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-nsMsgPrintEngine::nsMsgPrintEngine() :</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-  mIsDoingPrintPreview(false),</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-  mMsgInx(nsIMsgPrintEngine::MNAB_START)</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-{</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+nsMsgPrintEngine::nsMsgPrintEngine()</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+    : mIsDoingPrintPreview(false), mMsgInx(nsIMsgPrintEngine::MNAB_START) {</span>
<a href="#l17.26"></a><span id="l17.26">   mCurrentlyPrintingURI = -1;</span>
<a href="#l17.27"></a><span id="l17.27"> }</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-nsMsgPrintEngine::~nsMsgPrintEngine()</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-{</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-}</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+nsMsgPrintEngine::~nsMsgPrintEngine() {}</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35"> // Implement AddRef and Release</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgPrintEngine,</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-                         nsIMsgPrintEngine,</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-                         nsIWebProgressListener,</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-                         nsIObserver,</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-                         nsISupportsWeakReference)</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgPrintEngine, nsIMsgPrintEngine, nsIWebProgressListener,</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+                  nsIObserver, nsISupportsWeakReference)</span>
<a href="#l17.43"></a><span id="l17.43"> </span>
<a href="#l17.44"></a><span id="l17.44"> // nsIWebProgressListener implementation</span>
<a href="#l17.45"></a><span id="l17.45"> NS_IMETHODIMP</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-nsMsgPrintEngine::OnStateChange(nsIWebProgress* aWebProgress,</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-                   nsIRequest *aRequest,</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-                   uint32_t progressStateFlags,</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-                   nsresult aStatus)</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-{</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+nsMsgPrintEngine::OnStateChange(nsIWebProgress *aWebProgress,</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+                                nsIRequest *aRequest,</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+                                uint32_t progressStateFlags, nsresult aStatus) {</span>
<a href="#l17.54"></a><span id="l17.54">   nsresult rv = NS_OK;</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56">   // top-level document load data</span>
<a href="#l17.57"></a><span id="l17.57">   if (progressStateFlags &amp; nsIWebProgressListener::STATE_IS_DOCUMENT) {</span>
<a href="#l17.58"></a><span id="l17.58">     if (progressStateFlags &amp; nsIWebProgressListener::STATE_START) {</span>
<a href="#l17.59"></a><span id="l17.59">       // Tell the user we are loading...</span>
<a href="#l17.60"></a><span id="l17.60">       nsString msg;</span>
<a href="#l17.61"></a><span id="l17.61">       GetString(u&quot;LoadingMessageToPrint&quot;, msg);</span>
<a href="#l17.62"></a><span id="l17.62">       SetStatusMessage(msg);</span>
<a href="#l17.63"></a><span id="l17.63">     }</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65">     if (progressStateFlags &amp; nsIWebProgressListener::STATE_STOP) {</span>
<a href="#l17.66"></a><span id="l17.66">       nsCOMPtr&lt;nsIDocumentLoader&gt; docLoader(do_QueryInterface(aWebProgress));</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-      if (docLoader)</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-      {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-        // Check to see if the document DOMWin that is finished loading is the same</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-        // one as the mail msg that we started to load.</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-        // We only want to print when the entire msg and all of its attachments</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-        // have finished loading.</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-        // The mail msg doc is the last one to receive the STATE_STOP notification</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+      if (docLoader) {</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+        // Check to see if the document DOMWin that is finished loading is the</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+        // same one as the mail msg that we started to load. We only want to</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+        // print when the entire msg and all of its attachments have finished</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+        // loading. The mail msg doc is the last one to receive the STATE_STOP</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+        // notification</span>
<a href="#l17.80"></a><span id="l17.80">         nsCOMPtr&lt;nsISupports&gt; container;</span>
<a href="#l17.81"></a><span id="l17.81">         docLoader-&gt;GetContainer(getter_AddRefs(container));</span>
<a href="#l17.82"></a><span id="l17.82">         nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow(do_GetInterface(container));</span>
<a href="#l17.83"></a><span id="l17.83">         if (domWindow.get() != mMsgDOMWin.get()) {</span>
<a href="#l17.84"></a><span id="l17.84">           return NS_OK;</span>
<a href="#l17.85"></a><span id="l17.85">         }</span>
<a href="#l17.86"></a><span id="l17.86">       }</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-      nsCOMPtr&lt;nsIWebProgressListener&gt; wpl(do_QueryInterface(mPrintPromptService));</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+      nsCOMPtr&lt;nsIWebProgressListener&gt; wpl(</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+          do_QueryInterface(mPrintPromptService));</span>
<a href="#l17.90"></a><span id="l17.90">       if (wpl) {</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-        wpl-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP|nsIWebProgressListener::STATE_IS_DOCUMENT, NS_OK);</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+        wpl-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+                           nsIWebProgressListener::STATE_STOP |</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+                               nsIWebProgressListener::STATE_IS_DOCUMENT,</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+                           NS_OK);</span>
<a href="#l17.96"></a><span id="l17.96">         mPrintProgressListener = nullptr;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-        mPrintProgress         = nullptr;</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-        mPrintProgressParams   = nullptr;</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+        mPrintProgress = nullptr;</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+        mPrintProgressParams = nullptr;</span>
<a href="#l17.101"></a><span id="l17.101">       }</span>
<a href="#l17.102"></a><span id="l17.102"> </span>
<a href="#l17.103"></a><span id="l17.103">       bool isPrintingCancelled = false;</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-      if (mPrintSettings)</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-      {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+      if (mPrintSettings) {</span>
<a href="#l17.107"></a><span id="l17.107">         mPrintSettings-&gt;GetIsCancelled(&amp;isPrintingCancelled);</span>
<a href="#l17.108"></a><span id="l17.108">       }</span>
<a href="#l17.109"></a><span id="l17.109">       if (!isPrintingCancelled) {</span>
<a href="#l17.110"></a><span id="l17.110">         // if aWebProgress is a documentloader than the notification from</span>
<a href="#l17.111"></a><span id="l17.111">         // loading the documents. If it is NULL (or not a DocLoader) then it</span>
<a href="#l17.112"></a><span id="l17.112">         // it coming from Printing</span>
<a href="#l17.113"></a><span id="l17.113">         if (docLoader) {</span>
<a href="#l17.114"></a><span id="l17.114">           // Now, fire off the print operation!</span>
<a href="#l17.115"></a><span id="l17.115">           rv = NS_ERROR_FAILURE;</span>
<a href="#l17.116"></a><span id="l17.116"> </span>
<a href="#l17.117"></a><span id="l17.117">           // Tell the user the message is loaded...</span>
<a href="#l17.118"></a><span id="l17.118">           nsString msg;</span>
<a href="#l17.119"></a><span id="l17.119">           GetString(u&quot;MessageLoaded&quot;, msg);</span>
<a href="#l17.120"></a><span id="l17.120">           SetStatusMessage(msg);</span>
<a href="#l17.121"></a><span id="l17.121"> </span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-          NS_ASSERTION(mDocShell,&quot;can't print, there is no docshell&quot;);</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-          if ( (!mDocShell) || (!aRequest) )</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-          {</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+          NS_ASSERTION(mDocShell, &quot;can't print, there is no docshell&quot;);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+          if ((!mDocShell) || (!aRequest)) {</span>
<a href="#l17.127"></a><span id="l17.127">             return StartNextPrintOperation();</span>
<a href="#l17.128"></a><span id="l17.128">           }</span>
<a href="#l17.129"></a><span id="l17.129">           nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(aRequest);</span>
<a href="#l17.130"></a><span id="l17.130">           if (!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l17.131"></a><span id="l17.131"> </span>
<a href="#l17.132"></a><span id="l17.132">           // Make sure this isn't just &quot;about:blank&quot; finishing....</span>
<a href="#l17.133"></a><span id="l17.133">           nsCOMPtr&lt;nsIURI&gt; originalURI = nullptr;</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-          if (NS_SUCCEEDED(aChannel-&gt;GetOriginalURI(getter_AddRefs(originalURI))) &amp;&amp; originalURI)</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-          {</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+          if (NS_SUCCEEDED(</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+                  aChannel-&gt;GetOriginalURI(getter_AddRefs(originalURI))) &amp;&amp;</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+              originalURI) {</span>
<a href="#l17.139"></a><span id="l17.139">             nsAutoCString spec;</span>
<a href="#l17.140"></a><span id="l17.140"> </span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-            if (NS_SUCCEEDED(originalURI-&gt;GetSpec(spec)))</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-            {</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-              if (spec.EqualsLiteral(&quot;about:blank&quot;))</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-              {</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+            if (NS_SUCCEEDED(originalURI-&gt;GetSpec(spec))) {</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+              if (spec.EqualsLiteral(&quot;about:blank&quot;)) {</span>
<a href="#l17.147"></a><span id="l17.147">                 return StartNextPrintOperation();</span>
<a href="#l17.148"></a><span id="l17.148">               }</span>
<a href="#l17.149"></a><span id="l17.149">             }</span>
<a href="#l17.150"></a><span id="l17.150">           }</span>
<a href="#l17.151"></a><span id="l17.151"> </span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-          // If something bad happens here (menaing we can fire the PLEvent, highly unlikely)</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-          // we will still ask the msg to print, but if the user &quot;cancels&quot; out of the</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-          // print dialog the hidden print window will not be &quot;closed&quot;</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-          if (!FirePrintEvent())</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-          {</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+          // If something bad happens here (menaing we can fire the PLEvent,</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+          // highly unlikely) we will still ask the msg to print, but if the</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+          // user &quot;cancels&quot; out of the print dialog the hidden print window will</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+          // not be &quot;closed&quot;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+          if (!FirePrintEvent()) {</span>
<a href="#l17.162"></a><span id="l17.162">             PrintMsgWindow();</span>
<a href="#l17.163"></a><span id="l17.163">           }</span>
<a href="#l17.164"></a><span id="l17.164">         } else {</span>
<a href="#l17.165"></a><span id="l17.165">           FireStartNextEvent();</span>
<a href="#l17.166"></a><span id="l17.166">           rv = NS_OK;</span>
<a href="#l17.167"></a><span id="l17.167">         }</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-      }</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-      else</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-      {</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+      } else {</span>
<a href="#l17.172"></a><span id="l17.172">         if (mWindow) {</span>
<a href="#l17.173"></a><span id="l17.173">           nsPIDOMWindowOuter::From(mWindow)-&gt;Close();</span>
<a href="#l17.174"></a><span id="l17.174">         }</span>
<a href="#l17.175"></a><span id="l17.175">       }</span>
<a href="#l17.176"></a><span id="l17.176">     }</span>
<a href="#l17.177"></a><span id="l17.177">   }</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179">   return rv;</span>
<a href="#l17.180"></a><span id="l17.180"> }</span>
<a href="#l17.181"></a><span id="l17.181"> </span>
<a href="#l17.182"></a><span id="l17.182"> NS_IMETHODIMP</span>
<a href="#l17.183"></a><span id="l17.183"> nsMsgPrintEngine::OnProgressChange(nsIWebProgress *aWebProgress,</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-                                     nsIRequest *aRequest,</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-                                     int32_t aCurSelfProgress,</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-                                     int32_t aMaxSelfProgress,</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-                                     int32_t aCurTotalProgress,</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-                                     int32_t aMaxTotalProgress)</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-{</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+                                   nsIRequest *aRequest,</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+                                   int32_t aCurSelfProgress,</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+                                   int32_t aMaxSelfProgress,</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+                                   int32_t aCurTotalProgress,</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+                                   int32_t aMaxTotalProgress) {</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.197"></a><span id="l17.197"> }</span>
<a href="#l17.198"></a><span id="l17.198"> </span>
<a href="#l17.199"></a><span id="l17.199"> NS_IMETHODIMP</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-nsMsgPrintEngine::OnLocationChange(nsIWebProgress* aWebProgress,</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-                      nsIRequest* aRequest,</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-                      nsIURI *location,</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-                      uint32_t aFlags)</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-{</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-    MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-}</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-nsMsgPrintEngine::OnStatusChange(nsIWebProgress* aWebProgress,</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-                    nsIRequest* aRequest,</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-                    nsresult aStatus,</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-                    const char16_t* aMessage)</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-{</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-}</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-nsMsgPrintEngine::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-                                   nsIRequest *aRequest,</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-                                   uint32_t state)</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-{</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineminus">-    MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-}</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-nsMsgPrintEngine::OnContentBlockingEvent(nsIWebProgress *aWebProgress,</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-                                         nsIRequest *aRequest, uint32_t aEvent)</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-{</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+nsMsgPrintEngine::OnLocationChange(nsIWebProgress *aWebProgress,</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+                                   nsIRequest *aRequest, nsIURI *location,</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+                                   uint32_t aFlags) {</span>
<a href="#l17.236"></a><span id="l17.236">   MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l17.237"></a><span id="l17.237">   return NS_OK;</span>
<a href="#l17.238"></a><span id="l17.238"> }</span>
<a href="#l17.239"></a><span id="l17.239"> </span>
<a href="#l17.240"></a><span id="l17.240"> NS_IMETHODIMP</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-nsMsgPrintEngine::SetWindow(mozIDOMWindowProxy *aWin)</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-{</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-  if (!aWin)</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-  {</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-    // It isn't an error to pass in null for aWin, in fact it means we are shutting</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-    // down and we should start cleaning things up...</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+nsMsgPrintEngine::OnStatusChange(nsIWebProgress *aWebProgress,</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+                                 nsIRequest *aRequest, nsresult aStatus,</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+                                 const char16_t *aMessage) {</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+}</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+nsMsgPrintEngine::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+                                   nsIRequest *aRequest, uint32_t state) {</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+  MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineplus">+}</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+nsMsgPrintEngine::OnContentBlockingEvent(nsIWebProgress *aWebProgress,</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+                                         nsIRequest *aRequest,</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+                                         uint32_t aEvent) {</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+  MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+}</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+nsMsgPrintEngine::SetWindow(mozIDOMWindowProxy *aWin) {</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+  if (!aWin) {</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+    // It isn't an error to pass in null for aWin, in fact it means we are</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+    // shutting down and we should start cleaning things up...</span>
<a href="#l17.273"></a><span id="l17.273">     return NS_OK;</span>
<a href="#l17.274"></a><span id="l17.274">   }</span>
<a href="#l17.275"></a><span id="l17.275"> </span>
<a href="#l17.276"></a><span id="l17.276">   mWindow = aWin;</span>
<a href="#l17.277"></a><span id="l17.277"> </span>
<a href="#l17.278"></a><span id="l17.278">   NS_ENSURE_TRUE(mWindow, NS_ERROR_FAILURE);</span>
<a href="#l17.279"></a><span id="l17.279">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(mWindow);</span>
<a href="#l17.280"></a><span id="l17.280"> </span>
<a href="#l17.281"></a><span id="l17.281">   window-&gt;GetDocShell()-&gt;SetAppType(nsIDocShell::APP_TYPE_MAIL);</span>
<a href="#l17.282"></a><span id="l17.282"> </span>
<a href="#l17.283"></a><span id="l17.283" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem =  window-&gt;GetDocShell();</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem = window-&gt;GetDocShell();</span>
<a href="#l17.285"></a><span id="l17.285">   NS_ENSURE_TRUE(docShellAsItem, NS_ERROR_FAILURE);</span>
<a href="#l17.286"></a><span id="l17.286"> </span>
<a href="#l17.287"></a><span id="l17.287">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootAsItem;</span>
<a href="#l17.288"></a><span id="l17.288">   docShellAsItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootAsItem));</span>
<a href="#l17.289"></a><span id="l17.289"> </span>
<a href="#l17.290"></a><span id="l17.290">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; childItem;</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineminus">-  rootAsItem-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;content&quot;), true,</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-        false, nullptr, nullptr,</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineminus">-        getter_AddRefs(childItem));</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+  rootAsItem-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;content&quot;), true, false,</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+                                nullptr, nullptr, getter_AddRefs(childItem));</span>
<a href="#l17.296"></a><span id="l17.296"> </span>
<a href="#l17.297"></a><span id="l17.297">   mDocShell = do_QueryInterface(childItem);</span>
<a href="#l17.298"></a><span id="l17.298"> </span>
<a href="#l17.299"></a><span id="l17.299" class="difflineminus">-  if(mDocShell)</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-    SetupObserver();</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineplus">+  if (mDocShell) SetupObserver();</span>
<a href="#l17.302"></a><span id="l17.302"> </span>
<a href="#l17.303"></a><span id="l17.303">   return NS_OK;</span>
<a href="#l17.304"></a><span id="l17.304"> }</span>
<a href="#l17.305"></a><span id="l17.305"> </span>
<a href="#l17.306"></a><span id="l17.306"> /* void setParentWindow (in mozIDOMWindowProxy ptr); */</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-NS_IMETHODIMP nsMsgPrintEngine::SetParentWindow(mozIDOMWindowProxy *ptr)</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-{</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+NS_IMETHODIMP nsMsgPrintEngine::SetParentWindow(mozIDOMWindowProxy *ptr) {</span>
<a href="#l17.310"></a><span id="l17.310">   mParentWindow = ptr;</span>
<a href="#l17.311"></a><span id="l17.311">   return NS_OK;</span>
<a href="#l17.312"></a><span id="l17.312"> }</span>
<a href="#l17.313"></a><span id="l17.313"> </span>
<a href="#l17.314"></a><span id="l17.314" class="difflineminus">-</span>
<a href="#l17.315"></a><span id="l17.315"> NS_IMETHODIMP</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineminus">-nsMsgPrintEngine::ShowWindow(bool aShow)</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineminus">-{</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineplus">+nsMsgPrintEngine::ShowWindow(bool aShow) {</span>
<a href="#l17.319"></a><span id="l17.319">   nsresult rv;</span>
<a href="#l17.320"></a><span id="l17.320"> </span>
<a href="#l17.321"></a><span id="l17.321">   NS_ENSURE_TRUE(mWindow, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l17.322"></a><span id="l17.322"> </span>
<a href="#l17.323"></a><span id="l17.323">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(mWindow);</span>
<a href="#l17.324"></a><span id="l17.324">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem = window-&gt;GetDocShell();</span>
<a href="#l17.325"></a><span id="l17.325">   NS_ENSURE_TRUE(treeItem, NS_ERROR_NULL_POINTER);</span>
<a href="#l17.326"></a><span id="l17.326"> </span>
<a href="#l17.327"></a><span id="l17.327" class="difflineminus">-  nsCOMPtr &lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l17.329"></a><span id="l17.329">   rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.332"></a><span id="l17.332"> </span>
<a href="#l17.333"></a><span id="l17.333">   if (treeOwner) {</span>
<a href="#l17.334"></a><span id="l17.334">     // disable (enable) the window</span>
<a href="#l17.335"></a><span id="l17.335">     nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l17.336"></a><span id="l17.336">     baseWindow = do_QueryInterface(treeOwner, &amp;rv);</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.339"></a><span id="l17.339"> </span>
<a href="#l17.340"></a><span id="l17.340">     rv = baseWindow-&gt;SetEnabled(aShow);</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.343"></a><span id="l17.343"> </span>
<a href="#l17.344"></a><span id="l17.344">     // hide or show the window</span>
<a href="#l17.345"></a><span id="l17.345">     baseWindow-&gt;SetVisibility(aShow);</span>
<a href="#l17.346"></a><span id="l17.346">   }</span>
<a href="#l17.347"></a><span id="l17.347">   return rv;</span>
<a href="#l17.348"></a><span id="l17.348"> }</span>
<a href="#l17.349"></a><span id="l17.349"> </span>
<a href="#l17.350"></a><span id="l17.350"> NS_IMETHODIMP</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineminus">-nsMsgPrintEngine::AddPrintURI(const char16_t *aMsgURI)</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-{</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+nsMsgPrintEngine::AddPrintURI(const char16_t *aMsgURI) {</span>
<a href="#l17.354"></a><span id="l17.354">   NS_ENSURE_ARG_POINTER(aMsgURI);</span>
<a href="#l17.355"></a><span id="l17.355"> </span>
<a href="#l17.356"></a><span id="l17.356">   mURIArray.AppendElement(nsDependentString(aMsgURI));</span>
<a href="#l17.357"></a><span id="l17.357">   return NS_OK;</span>
<a href="#l17.358"></a><span id="l17.358"> }</span>
<a href="#l17.359"></a><span id="l17.359"> </span>
<a href="#l17.360"></a><span id="l17.360"> NS_IMETHODIMP</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineminus">-nsMsgPrintEngine::SetPrintURICount(int32_t aCount)</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineminus">-{</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineplus">+nsMsgPrintEngine::SetPrintURICount(int32_t aCount) {</span>
<a href="#l17.364"></a><span id="l17.364">   mURICount = aCount;</span>
<a href="#l17.365"></a><span id="l17.365">   return NS_OK;</span>
<a href="#l17.366"></a><span id="l17.366"> }</span>
<a href="#l17.367"></a><span id="l17.367"> </span>
<a href="#l17.368"></a><span id="l17.368"> NS_IMETHODIMP</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineminus">-nsMsgPrintEngine::StartPrintOperation(nsIPrintSettings* aPS)</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineminus">-{</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineplus">+nsMsgPrintEngine::StartPrintOperation(nsIPrintSettings *aPS) {</span>
<a href="#l17.372"></a><span id="l17.372">   NS_ENSURE_ARG_POINTER(aPS);</span>
<a href="#l17.373"></a><span id="l17.373">   mPrintSettings = aPS;</span>
<a href="#l17.374"></a><span id="l17.374"> </span>
<a href="#l17.375"></a><span id="l17.375">   // Load the about:blank on the tail end...</span>
<a href="#l17.376"></a><span id="l17.376">   nsresult rv = AddPrintURI(u&quot;about:blank&quot;);</span>
<a href="#l17.377"></a><span id="l17.377">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.378"></a><span id="l17.378">   return StartNextPrintOperation();</span>
<a href="#l17.379"></a><span id="l17.379"> }</span>
<a href="#l17.380"></a><span id="l17.380"> </span>
<a href="#l17.381"></a><span id="l17.381"> //----------------------------------------------------------------------</span>
<a href="#l17.382"></a><span id="l17.382"> // Set up to use the &quot;pluggable&quot; Print Progress Dialog</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-nsresult</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineminus">-nsMsgPrintEngine::ShowProgressDialog(bool aIsForPrinting, bool&amp; aDoNotify)</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineminus">-{</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineplus">+nsresult nsMsgPrintEngine::ShowProgressDialog(bool aIsForPrinting,</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineplus">+                                              bool &amp;aDoNotify) {</span>
<a href="#l17.388"></a><span id="l17.388">   nsresult rv;</span>
<a href="#l17.389"></a><span id="l17.389"> </span>
<a href="#l17.390"></a><span id="l17.390">   // default to not notifying, that if something here goes wrong</span>
<a href="#l17.391"></a><span id="l17.391">   // or we aren't going to show the progress dialog we can straight into</span>
<a href="#l17.392"></a><span id="l17.392">   // reflowing the doc for printing.</span>
<a href="#l17.393"></a><span id="l17.393">   aDoNotify = false;</span>
<a href="#l17.394"></a><span id="l17.394"> </span>
<a href="#l17.395"></a><span id="l17.395">   // Assume we can't do progress and then see if we can</span>
<a href="#l17.396"></a><span id="l17.396">   bool showProgressDialog = false;</span>
<a href="#l17.397"></a><span id="l17.397"> </span>
<a href="#l17.398"></a><span id="l17.398">   // if it is already being shown then don't bother to find out if it should be</span>
<a href="#l17.399"></a><span id="l17.399">   // so skip this and leave mShowProgressDialog set to FALSE</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineminus">-  {</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.406"></a><span id="l17.406">     prefBranch-&gt;GetBoolPref(&quot;print.show_print_progress&quot;, &amp;showProgressDialog);</span>
<a href="#l17.407"></a><span id="l17.407">   }</span>
<a href="#l17.408"></a><span id="l17.408"> </span>
<a href="#l17.409"></a><span id="l17.409">   // Turning off the showing of Print Progress in Prefs overrides</span>
<a href="#l17.410"></a><span id="l17.410">   // whether the calling PS desire to have it on or off, so only check PS if</span>
<a href="#l17.411"></a><span id="l17.411">   // prefs says it's ok to be on.</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineminus">-  if (showProgressDialog)</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineminus">-  {</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+  if (showProgressDialog) {</span>
<a href="#l17.415"></a><span id="l17.415">     mPrintSettings-&gt;GetShowPrintProgress(&amp;showProgressDialog);</span>
<a href="#l17.416"></a><span id="l17.416">   }</span>
<a href="#l17.417"></a><span id="l17.417"> </span>
<a href="#l17.418"></a><span id="l17.418">   // Now open the service to get the progress dialog</span>
<a href="#l17.419"></a><span id="l17.419">   // If we don't get a service, that's ok, then just don't show progress</span>
<a href="#l17.420"></a><span id="l17.420">   if (showProgressDialog) {</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineminus">-    if (!mPrintPromptService)</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineminus">-    {</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineplus">+    if (!mPrintPromptService) {</span>
<a href="#l17.424"></a><span id="l17.424">       mPrintPromptService = do_GetService(kPrintingPromptService);</span>
<a href="#l17.425"></a><span id="l17.425">     }</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineminus">-    if (mPrintPromptService)</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineminus">-    {</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineplus">+    if (mPrintPromptService) {</span>
<a href="#l17.429"></a><span id="l17.429">       nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWin = mParentWindow;</span>
<a href="#l17.430"></a><span id="l17.430" class="difflineminus">-      if (!domWin)</span>
<a href="#l17.431"></a><span id="l17.431" class="difflineminus">-      {</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineplus">+      if (!domWin) {</span>
<a href="#l17.433"></a><span id="l17.433">         domWin = mWindow;</span>
<a href="#l17.434"></a><span id="l17.434">       }</span>
<a href="#l17.435"></a><span id="l17.435"> </span>
<a href="#l17.436"></a><span id="l17.436">       rv = mPrintPromptService-&gt;ShowPrintProgressDialog(</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineminus">-             domWin, mWebBrowserPrint, mPrintSettings, this, aIsForPrinting,</span>
<a href="#l17.438"></a><span id="l17.438" class="difflineminus">-             getter_AddRefs(mPrintProgressListener),</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineminus">-             getter_AddRefs(mPrintProgressParams),</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineminus">-             &amp;aDoNotify);</span>
<a href="#l17.441"></a><span id="l17.441" class="difflineplus">+          domWin, mWebBrowserPrint, mPrintSettings, this, aIsForPrinting,</span>
<a href="#l17.442"></a><span id="l17.442" class="difflineplus">+          getter_AddRefs(mPrintProgressListener),</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineplus">+          getter_AddRefs(mPrintProgressParams), &amp;aDoNotify);</span>
<a href="#l17.444"></a><span id="l17.444">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.445"></a><span id="l17.445" class="difflineminus">-</span>
<a href="#l17.446"></a><span id="l17.446" class="difflineminus">-        showProgressDialog = mPrintProgressListener != nullptr &amp;&amp; mPrintProgressParams != nullptr;</span>
<a href="#l17.447"></a><span id="l17.447" class="difflineplus">+        showProgressDialog = mPrintProgressListener != nullptr &amp;&amp;</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineplus">+                             mPrintProgressParams != nullptr;</span>
<a href="#l17.449"></a><span id="l17.449"> </span>
<a href="#l17.450"></a><span id="l17.450" class="difflineminus">-        if (showProgressDialog)</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineminus">-        {</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineplus">+        if (showProgressDialog) {</span>
<a href="#l17.453"></a><span id="l17.453">           nsString msg;</span>
<a href="#l17.454"></a><span id="l17.454">           if (mIsDoingPrintPreview) {</span>
<a href="#l17.455"></a><span id="l17.455">             GetString(u&quot;LoadingMailMsgForPrintPreview&quot;, msg);</span>
<a href="#l17.456"></a><span id="l17.456">           } else {</span>
<a href="#l17.457"></a><span id="l17.457">             GetString(u&quot;LoadingMailMsgForPrint&quot;, msg);</span>
<a href="#l17.458"></a><span id="l17.458">           }</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineminus">-          if (!msg.IsEmpty())</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineminus">-            mPrintProgressParams-&gt;SetDocTitle(msg);</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineplus">+          if (!msg.IsEmpty()) mPrintProgressParams-&gt;SetDocTitle(msg);</span>
<a href="#l17.462"></a><span id="l17.462">         }</span>
<a href="#l17.463"></a><span id="l17.463">       }</span>
<a href="#l17.464"></a><span id="l17.464">     }</span>
<a href="#l17.465"></a><span id="l17.465">   }</span>
<a href="#l17.466"></a><span id="l17.466">   return rv;</span>
<a href="#l17.467"></a><span id="l17.467"> }</span>
<a href="#l17.468"></a><span id="l17.468"> </span>
<a href="#l17.469"></a><span id="l17.469" class="difflineminus">-</span>
<a href="#l17.470"></a><span id="l17.470"> NS_IMETHODIMP</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineminus">-nsMsgPrintEngine::StartNextPrintOperation()</span>
<a href="#l17.472"></a><span id="l17.472" class="difflineminus">-{</span>
<a href="#l17.473"></a><span id="l17.473" class="difflineminus">-  nsresult      rv;</span>
<a href="#l17.474"></a><span id="l17.474" class="difflineplus">+nsMsgPrintEngine::StartNextPrintOperation() {</span>
<a href="#l17.475"></a><span id="l17.475" class="difflineplus">+  nsresult rv;</span>
<a href="#l17.476"></a><span id="l17.476"> </span>
<a href="#l17.477"></a><span id="l17.477">   // Only do this the first time through...</span>
<a href="#l17.478"></a><span id="l17.478" class="difflineminus">-  if (mCurrentlyPrintingURI == -1)</span>
<a href="#l17.479"></a><span id="l17.479" class="difflineminus">-    InitializeDisplayCharset();</span>
<a href="#l17.480"></a><span id="l17.480" class="difflineplus">+  if (mCurrentlyPrintingURI == -1) InitializeDisplayCharset();</span>
<a href="#l17.481"></a><span id="l17.481"> </span>
<a href="#l17.482"></a><span id="l17.482">   mCurrentlyPrintingURI++;</span>
<a href="#l17.483"></a><span id="l17.483"> </span>
<a href="#l17.484"></a><span id="l17.484">   // First, check if we are at the end of this stuff!</span>
<a href="#l17.485"></a><span id="l17.485" class="difflineminus">-  if (mCurrentlyPrintingURI &gt;= (int32_t)mURIArray.Length())</span>
<a href="#l17.486"></a><span id="l17.486" class="difflineminus">-  {</span>
<a href="#l17.487"></a><span id="l17.487" class="difflineplus">+  if (mCurrentlyPrintingURI &gt;= (int32_t)mURIArray.Length()) {</span>
<a href="#l17.488"></a><span id="l17.488">     // This is the end...dum, dum, dum....my only friend...the end</span>
<a href="#l17.489"></a><span id="l17.489">     NS_ENSURE_TRUE(mWindow, NS_ERROR_FAILURE);</span>
<a href="#l17.490"></a><span id="l17.490">     nsPIDOMWindowOuter::From(mWindow)-&gt;Close();</span>
<a href="#l17.491"></a><span id="l17.491"> </span>
<a href="#l17.492"></a><span id="l17.492">     // Tell the user we are done...</span>
<a href="#l17.493"></a><span id="l17.493">     nsString msg;</span>
<a href="#l17.494"></a><span id="l17.494">     GetString(u&quot;PrintingComplete&quot;, msg);</span>
<a href="#l17.495"></a><span id="l17.495">     SetStatusMessage(msg);</span>
<a href="#l17.496"></a><span id="l17.496">     return NS_OK;</span>
<a href="#l17.497"></a><span id="l17.497">   }</span>
<a href="#l17.498"></a><span id="l17.498"> </span>
<a href="#l17.499"></a><span id="l17.499" class="difflineminus">-  if (!mDocShell)</span>
<a href="#l17.500"></a><span id="l17.500" class="difflineminus">-    return StartNextPrintOperation();</span>
<a href="#l17.501"></a><span id="l17.501" class="difflineplus">+  if (!mDocShell) return StartNextPrintOperation();</span>
<a href="#l17.502"></a><span id="l17.502"> </span>
<a href="#l17.503"></a><span id="l17.503">   const nsString &amp;uri = mURIArray[mCurrentlyPrintingURI];</span>
<a href="#l17.504"></a><span id="l17.504">   rv = FireThatLoadOperationStartup(uri);</span>
<a href="#l17.505"></a><span id="l17.505">   if (NS_FAILED(rv))</span>
<a href="#l17.506"></a><span id="l17.506">     return StartNextPrintOperation();</span>
<a href="#l17.507"></a><span id="l17.507">   else</span>
<a href="#l17.508"></a><span id="l17.508">     return rv;</span>
<a href="#l17.509"></a><span id="l17.509"> }</span>
<a href="#l17.510"></a><span id="l17.510"> </span>
<a href="#l17.511"></a><span id="l17.511"> NS_IMETHODIMP</span>
<a href="#l17.512"></a><span id="l17.512" class="difflineminus">-nsMsgPrintEngine::SetStatusFeedback(nsIMsgStatusFeedback *aFeedback)</span>
<a href="#l17.513"></a><span id="l17.513" class="difflineminus">-{</span>
<a href="#l17.514"></a><span id="l17.514" class="difflineplus">+nsMsgPrintEngine::SetStatusFeedback(nsIMsgStatusFeedback *aFeedback) {</span>
<a href="#l17.515"></a><span id="l17.515">   mFeedback = aFeedback;</span>
<a href="#l17.516"></a><span id="l17.516">   return NS_OK;</span>
<a href="#l17.517"></a><span id="l17.517"> }</span>
<a href="#l17.518"></a><span id="l17.518"> </span>
<a href="#l17.519"></a><span id="l17.519" class="difflineminus">-#define DATA_URL_PREFIX     &quot;data:&quot;</span>
<a href="#l17.520"></a><span id="l17.520" class="difflineminus">-#define ADDBOOK_URL_PREFIX     &quot;addbook:&quot;</span>
<a href="#l17.521"></a><span id="l17.521" class="difflineplus">+#define DATA_URL_PREFIX &quot;data:&quot;</span>
<a href="#l17.522"></a><span id="l17.522" class="difflineplus">+#define ADDBOOK_URL_PREFIX &quot;addbook:&quot;</span>
<a href="#l17.523"></a><span id="l17.523"> </span>
<a href="#l17.524"></a><span id="l17.524" class="difflineminus">-nsresult</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineminus">-nsMsgPrintEngine::FireThatLoadOperationStartup(const nsString&amp; uri)</span>
<a href="#l17.526"></a><span id="l17.526" class="difflineminus">-{</span>
<a href="#l17.527"></a><span id="l17.527" class="difflineplus">+nsresult nsMsgPrintEngine::FireThatLoadOperationStartup(const nsString &amp;uri) {</span>
<a href="#l17.528"></a><span id="l17.528">   if (!uri.IsEmpty())</span>
<a href="#l17.529"></a><span id="l17.529">     mLoadURI = uri;</span>
<a href="#l17.530"></a><span id="l17.530">   else</span>
<a href="#l17.531"></a><span id="l17.531">     mLoadURI.Truncate();</span>
<a href="#l17.532"></a><span id="l17.532"> </span>
<a href="#l17.533"></a><span id="l17.533" class="difflineminus">-  bool     notify = false;</span>
<a href="#l17.534"></a><span id="l17.534" class="difflineminus">-  nsresult rv     = NS_ERROR_FAILURE;</span>
<a href="#l17.535"></a><span id="l17.535" class="difflineplus">+  bool notify = false;</span>
<a href="#l17.536"></a><span id="l17.536" class="difflineplus">+  nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l17.537"></a><span id="l17.537">   // Don't show dialog if we are out of URLs</span>
<a href="#l17.538"></a><span id="l17.538" class="difflineminus">-  //if ( mCurrentlyPrintingURI &lt; mURIArray.Length() &amp;&amp; !mIsDoingPrintPreview)</span>
<a href="#l17.539"></a><span id="l17.539" class="difflineminus">-  if ( mCurrentlyPrintingURI &lt; (int32_t)mURIArray.Length())</span>
<a href="#l17.540"></a><span id="l17.540" class="difflineplus">+  // if ( mCurrentlyPrintingURI &lt; mURIArray.Length() &amp;&amp; !mIsDoingPrintPreview)</span>
<a href="#l17.541"></a><span id="l17.541" class="difflineplus">+  if (mCurrentlyPrintingURI &lt; (int32_t)mURIArray.Length())</span>
<a href="#l17.542"></a><span id="l17.542">     rv = ShowProgressDialog(!mIsDoingPrintPreview, notify);</span>
<a href="#l17.543"></a><span id="l17.543" class="difflineminus">-  if (NS_FAILED(rv) || !notify)</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineminus">-    return FireThatLoadOperation(uri);</span>
<a href="#l17.545"></a><span id="l17.545" class="difflineplus">+  if (NS_FAILED(rv) || !notify) return FireThatLoadOperation(uri);</span>
<a href="#l17.546"></a><span id="l17.546">   return NS_OK;</span>
<a href="#l17.547"></a><span id="l17.547"> }</span>
<a href="#l17.548"></a><span id="l17.548"> </span>
<a href="#l17.549"></a><span id="l17.549" class="difflineminus">-nsresult</span>
<a href="#l17.550"></a><span id="l17.550" class="difflineminus">-nsMsgPrintEngine::FireThatLoadOperation(const nsString&amp; uri)</span>
<a href="#l17.551"></a><span id="l17.551" class="difflineminus">-{</span>
<a href="#l17.552"></a><span id="l17.552" class="difflineplus">+nsresult nsMsgPrintEngine::FireThatLoadOperation(const nsString &amp;uri) {</span>
<a href="#l17.553"></a><span id="l17.553">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l17.554"></a><span id="l17.554"> </span>
<a href="#l17.555"></a><span id="l17.555">   nsCString uriCStr;</span>
<a href="#l17.556"></a><span id="l17.556">   LossyCopyUTF16toASCII(uri, uriCStr);</span>
<a href="#l17.557"></a><span id="l17.557"> </span>
<a href="#l17.558"></a><span id="l17.558" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l17.560"></a><span id="l17.560">   // if this is a data: url, skip it, because</span>
<a href="#l17.561"></a><span id="l17.561">   // we've already got something we can print</span>
<a href="#l17.562"></a><span id="l17.562">   // and we know it is not a message.</span>
<a href="#l17.563"></a><span id="l17.563">   //</span>
<a href="#l17.564"></a><span id="l17.564">   // if this an about:blank url, skip it, because</span>
<a href="#l17.565"></a><span id="l17.565">   // ...</span>
<a href="#l17.566"></a><span id="l17.566">   //</span>
<a href="#l17.567"></a><span id="l17.567">   // if this is an addbook: url, skip it, because</span>
<a href="#l17.568"></a><span id="l17.568">   // we know that isn't a message.</span>
<a href="#l17.569"></a><span id="l17.569">   //</span>
<a href="#l17.570"></a><span id="l17.570">   // if this is a message part (or .eml file on disk)</span>
<a href="#l17.571"></a><span id="l17.571">   // skip it, because we don't want to print the parent message</span>
<a href="#l17.572"></a><span id="l17.572">   // we want to print the part.</span>
<a href="#l17.573"></a><span id="l17.573" class="difflineminus">-  // example:  imap://sspitzer@nsmail-1:143/fetch%3EUID%3E/INBOX%3E180958?part=1.1.2&amp;type=application/x-message-display&amp;filename=test&quot;</span>
<a href="#l17.574"></a><span id="l17.574" class="difflineplus">+  // example:</span>
<a href="#l17.575"></a><span id="l17.575" class="difflineplus">+  // imap://sspitzer@nsmail-1:143/fetch%3EUID%3E/INBOX%3E180958?part=1.1.2&amp;type=application/x-message-display&amp;filename=test&quot;</span>
<a href="#l17.576"></a><span id="l17.576">   if (!StringBeginsWith(uriCStr, NS_LITERAL_CSTRING(DATA_URL_PREFIX)) &amp;&amp;</span>
<a href="#l17.577"></a><span id="l17.577">       !StringBeginsWith(uriCStr, NS_LITERAL_CSTRING(ADDBOOK_URL_PREFIX)) &amp;&amp;</span>
<a href="#l17.578"></a><span id="l17.578">       !uriCStr.EqualsLiteral(&quot;about:blank&quot;) &amp;&amp;</span>
<a href="#l17.579"></a><span id="l17.579" class="difflineminus">-      uriCStr.Find(NS_LITERAL_CSTRING(&quot;type=application/x-message-display&quot;)) == -1) {</span>
<a href="#l17.580"></a><span id="l17.580" class="difflineplus">+      uriCStr.Find(NS_LITERAL_CSTRING(&quot;type=application/x-message-display&quot;)) ==</span>
<a href="#l17.581"></a><span id="l17.581" class="difflineplus">+          -1) {</span>
<a href="#l17.582"></a><span id="l17.582">     rv = GetMessageServiceFromURI(uriCStr, getter_AddRefs(messageService));</span>
<a href="#l17.583"></a><span id="l17.583">   }</span>
<a href="#l17.584"></a><span id="l17.584"> </span>
<a href="#l17.585"></a><span id="l17.585">   if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l17.586"></a><span id="l17.586">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l17.587"></a><span id="l17.587" class="difflineminus">-    rv = messageService-&gt;DisplayMessageForPrinting(uriCStr.get(), mDocShell, nullptr, nullptr,</span>
<a href="#l17.588"></a><span id="l17.588" class="difflineminus">-                                                   getter_AddRefs(dummyNull));</span>
<a href="#l17.589"></a><span id="l17.589" class="difflineplus">+    rv = messageService-&gt;DisplayMessageForPrinting(</span>
<a href="#l17.590"></a><span id="l17.590" class="difflineplus">+        uriCStr.get(), mDocShell, nullptr, nullptr, getter_AddRefs(dummyNull));</span>
<a href="#l17.591"></a><span id="l17.591">   }</span>
<a href="#l17.592"></a><span id="l17.592" class="difflineminus">-  //If it's not something we know about, then just load try loading it directly.</span>
<a href="#l17.593"></a><span id="l17.593" class="difflineminus">-  else</span>
<a href="#l17.594"></a><span id="l17.594" class="difflineminus">-  {</span>
<a href="#l17.595"></a><span id="l17.595" class="difflineplus">+  // If it's not something we know about, then just load try loading it</span>
<a href="#l17.596"></a><span id="l17.596" class="difflineplus">+  // directly.</span>
<a href="#l17.597"></a><span id="l17.597" class="difflineplus">+  else {</span>
<a href="#l17.598"></a><span id="l17.598">     nsCOMPtr&lt;nsIWebNavigation&gt; webNav(do_QueryInterface(mDocShell));</span>
<a href="#l17.599"></a><span id="l17.599">     if (webNav) {</span>
<a href="#l17.600"></a><span id="l17.600">       mozilla::dom::LoadURIOptions loadURIOptions;</span>
<a href="#l17.601"></a><span id="l17.601" class="difflineminus">-      loadURIOptions.mTriggeringPrincipal = nsContentUtils::GetSystemPrincipal();</span>
<a href="#l17.602"></a><span id="l17.602" class="difflineplus">+      loadURIOptions.mTriggeringPrincipal =</span>
<a href="#l17.603"></a><span id="l17.603" class="difflineplus">+          nsContentUtils::GetSystemPrincipal();</span>
<a href="#l17.604"></a><span id="l17.604">       rv = webNav-&gt;LoadURI(uri, loadURIOptions);</span>
<a href="#l17.605"></a><span id="l17.605">     }</span>
<a href="#l17.606"></a><span id="l17.606">   }</span>
<a href="#l17.607"></a><span id="l17.607">   return rv;</span>
<a href="#l17.608"></a><span id="l17.608"> }</span>
<a href="#l17.609"></a><span id="l17.609"> </span>
<a href="#l17.610"></a><span id="l17.610" class="difflineminus">-void</span>
<a href="#l17.611"></a><span id="l17.611" class="difflineminus">-nsMsgPrintEngine::InitializeDisplayCharset()</span>
<a href="#l17.612"></a><span id="l17.612" class="difflineminus">-{</span>
<a href="#l17.613"></a><span id="l17.613" class="difflineplus">+void nsMsgPrintEngine::InitializeDisplayCharset() {</span>
<a href="#l17.614"></a><span id="l17.614">   // libmime always converts to UTF-8 (both HTML and XML)</span>
<a href="#l17.615"></a><span id="l17.615" class="difflineminus">-  if (mDocShell)</span>
<a href="#l17.616"></a><span id="l17.616" class="difflineminus">-  {</span>
<a href="#l17.617"></a><span id="l17.617" class="difflineplus">+  if (mDocShell) {</span>
<a href="#l17.618"></a><span id="l17.618">     nsCOMPtr&lt;nsIContentViewer&gt; cv;</span>
<a href="#l17.619"></a><span id="l17.619">     mDocShell-&gt;GetContentViewer(getter_AddRefs(cv));</span>
<a href="#l17.620"></a><span id="l17.620" class="difflineminus">-    if (cv)</span>
<a href="#l17.621"></a><span id="l17.621" class="difflineminus">-    {</span>
<a href="#l17.622"></a><span id="l17.622" class="difflineplus">+    if (cv) {</span>
<a href="#l17.623"></a><span id="l17.623">       cv-&gt;SetForceCharacterSet(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l17.624"></a><span id="l17.624">     }</span>
<a href="#l17.625"></a><span id="l17.625">   }</span>
<a href="#l17.626"></a><span id="l17.626"> }</span>
<a href="#l17.627"></a><span id="l17.627"> </span>
<a href="#l17.628"></a><span id="l17.628" class="difflineminus">-void</span>
<a href="#l17.629"></a><span id="l17.629" class="difflineminus">-nsMsgPrintEngine::SetupObserver()</span>
<a href="#l17.630"></a><span id="l17.630" class="difflineminus">-{</span>
<a href="#l17.631"></a><span id="l17.631" class="difflineminus">-  if (!mDocShell)</span>
<a href="#l17.632"></a><span id="l17.632" class="difflineminus">-    return;</span>
<a href="#l17.633"></a><span id="l17.633" class="difflineplus">+void nsMsgPrintEngine::SetupObserver() {</span>
<a href="#l17.634"></a><span id="l17.634" class="difflineplus">+  if (!mDocShell) return;</span>
<a href="#l17.635"></a><span id="l17.635"> </span>
<a href="#l17.636"></a><span id="l17.636" class="difflineminus">-  if (mDocShell)</span>
<a href="#l17.637"></a><span id="l17.637" class="difflineminus">-  {</span>
<a href="#l17.638"></a><span id="l17.638" class="difflineplus">+  if (mDocShell) {</span>
<a href="#l17.639"></a><span id="l17.639">     nsCOMPtr&lt;nsIWebProgress&gt; progress(do_GetInterface(mDocShell));</span>
<a href="#l17.640"></a><span id="l17.640">     NS_ASSERTION(progress, &quot;we were expecting a nsIWebProgress&quot;);</span>
<a href="#l17.641"></a><span id="l17.641" class="difflineminus">-    if (progress)</span>
<a href="#l17.642"></a><span id="l17.642" class="difflineminus">-    {</span>
<a href="#l17.643"></a><span id="l17.643" class="difflineminus">-      (void) progress-&gt;AddProgressListener((nsIWebProgressListener *)this,</span>
<a href="#l17.644"></a><span id="l17.644" class="difflineminus">-                                        nsIWebProgress::NOTIFY_STATE_DOCUMENT);</span>
<a href="#l17.645"></a><span id="l17.645" class="difflineplus">+    if (progress) {</span>
<a href="#l17.646"></a><span id="l17.646" class="difflineplus">+      (void)progress-&gt;AddProgressListener(</span>
<a href="#l17.647"></a><span id="l17.647" class="difflineplus">+          (nsIWebProgressListener *)this,</span>
<a href="#l17.648"></a><span id="l17.648" class="difflineplus">+          nsIWebProgress::NOTIFY_STATE_DOCUMENT);</span>
<a href="#l17.649"></a><span id="l17.649">     }</span>
<a href="#l17.650"></a><span id="l17.650"> </span>
<a href="#l17.651"></a><span id="l17.651">     // Cache a pointer to the mail message's DOMWindow</span>
<a href="#l17.652"></a><span id="l17.652">     // so later we know when we can print when the</span>
<a href="#l17.653"></a><span id="l17.653">     // document &quot;loaded&quot; msgs com through via the Progress listener</span>
<a href="#l17.654"></a><span id="l17.654">     mMsgDOMWin = do_GetInterface(mDocShell);</span>
<a href="#l17.655"></a><span id="l17.655">   }</span>
<a href="#l17.656"></a><span id="l17.656"> }</span>
<a href="#l17.657"></a><span id="l17.657"> </span>
<a href="#l17.658"></a><span id="l17.658" class="difflineminus">-nsresult</span>
<a href="#l17.659"></a><span id="l17.659" class="difflineminus">-nsMsgPrintEngine::SetStatusMessage(const nsString&amp; aMsgString)</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineminus">-{</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineminus">-  if ( (!mFeedback) || (aMsgString.IsEmpty()) )</span>
<a href="#l17.662"></a><span id="l17.662" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.663"></a><span id="l17.663" class="difflineplus">+nsresult nsMsgPrintEngine::SetStatusMessage(const nsString &amp;aMsgString) {</span>
<a href="#l17.664"></a><span id="l17.664" class="difflineplus">+  if ((!mFeedback) || (aMsgString.IsEmpty())) return NS_OK;</span>
<a href="#l17.665"></a><span id="l17.665"> </span>
<a href="#l17.666"></a><span id="l17.666">   mFeedback-&gt;ShowStatusString(aMsgString);</span>
<a href="#l17.667"></a><span id="l17.667">   return NS_OK;</span>
<a href="#l17.668"></a><span id="l17.668"> }</span>
<a href="#l17.669"></a><span id="l17.669"> </span>
<a href="#l17.670"></a><span id="l17.670" class="difflineminus">-#define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l17.671"></a><span id="l17.671" class="difflineplus">+#define MESSENGER_STRING_URL &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l17.672"></a><span id="l17.672"> </span>
<a href="#l17.673"></a><span id="l17.673" class="difflineminus">-void</span>
<a href="#l17.674"></a><span id="l17.674" class="difflineminus">-nsMsgPrintEngine::GetString(const char16_t *aStringName, nsString&amp; outStr)</span>
<a href="#l17.675"></a><span id="l17.675" class="difflineminus">-{</span>
<a href="#l17.676"></a><span id="l17.676" class="difflineplus">+void nsMsgPrintEngine::GetString(const char16_t *aStringName,</span>
<a href="#l17.677"></a><span id="l17.677" class="difflineplus">+                                 nsString &amp;outStr) {</span>
<a href="#l17.678"></a><span id="l17.678">   outStr.Truncate();</span>
<a href="#l17.679"></a><span id="l17.679"> </span>
<a href="#l17.680"></a><span id="l17.680" class="difflineminus">-  if (!mStringBundle)</span>
<a href="#l17.681"></a><span id="l17.681" class="difflineminus">-  {</span>
<a href="#l17.682"></a><span id="l17.682" class="difflineplus">+  if (!mStringBundle) {</span>
<a href="#l17.683"></a><span id="l17.683">     static const char propertyURL[] = MESSENGER_STRING_URL;</span>
<a href="#l17.684"></a><span id="l17.684"> </span>
<a href="#l17.685"></a><span id="l17.685">     nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l17.686"></a><span id="l17.686" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l17.687"></a><span id="l17.687" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l17.688"></a><span id="l17.688">     if (sBundleService)</span>
<a href="#l17.689"></a><span id="l17.689">       sBundleService-&gt;CreateBundle(propertyURL, getter_AddRefs(mStringBundle));</span>
<a href="#l17.690"></a><span id="l17.690">   }</span>
<a href="#l17.691"></a><span id="l17.691"> </span>
<a href="#l17.692"></a><span id="l17.692">   if (mStringBundle)</span>
<a href="#l17.693"></a><span id="l17.693" class="difflineminus">-    mStringBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(aStringName).get(), outStr);</span>
<a href="#l17.694"></a><span id="l17.694" class="difflineplus">+    mStringBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(aStringName).get(),</span>
<a href="#l17.695"></a><span id="l17.695" class="difflineplus">+                                     outStr);</span>
<a href="#l17.696"></a><span id="l17.696">   return;</span>
<a href="#l17.697"></a><span id="l17.697"> }</span>
<a href="#l17.698"></a><span id="l17.698"> </span>
<a href="#l17.699"></a><span id="l17.699"> //-----------------------------------------------------------</span>
<a href="#l17.700"></a><span id="l17.700" class="difflineminus">-void</span>
<a href="#l17.701"></a><span id="l17.701" class="difflineminus">-nsMsgPrintEngine::PrintMsgWindow()</span>
<a href="#l17.702"></a><span id="l17.702" class="difflineminus">-{</span>
<a href="#l17.703"></a><span id="l17.703" class="difflineminus">-  const char* kMsgKeys[] = {&quot;PrintingMessage&quot;,  &quot;PrintPreviewMessage&quot;,</span>
<a href="#l17.704"></a><span id="l17.704" class="difflineplus">+void nsMsgPrintEngine::PrintMsgWindow() {</span>
<a href="#l17.705"></a><span id="l17.705" class="difflineplus">+  const char *kMsgKeys[] = {&quot;PrintingMessage&quot;,  &quot;PrintPreviewMessage&quot;,</span>
<a href="#l17.706"></a><span id="l17.706">                             &quot;PrintingContact&quot;,  &quot;PrintPreviewContact&quot;,</span>
<a href="#l17.707"></a><span id="l17.707">                             &quot;PrintingAddrBook&quot;, &quot;PrintPreviewAddrBook&quot;};</span>
<a href="#l17.708"></a><span id="l17.708"> </span>
<a href="#l17.709"></a><span id="l17.709">   mDocShell-&gt;GetContentViewer(getter_AddRefs(mContentViewer));</span>
<a href="#l17.710"></a><span id="l17.710" class="difflineminus">-  if (mContentViewer)</span>
<a href="#l17.711"></a><span id="l17.711" class="difflineminus">-  {</span>
<a href="#l17.712"></a><span id="l17.712" class="difflineplus">+  if (mContentViewer) {</span>
<a href="#l17.713"></a><span id="l17.713">     mWebBrowserPrint = do_QueryInterface(mContentViewer);</span>
<a href="#l17.714"></a><span id="l17.714" class="difflineminus">-    if (mWebBrowserPrint)</span>
<a href="#l17.715"></a><span id="l17.715" class="difflineminus">-    {</span>
<a href="#l17.716"></a><span id="l17.716" class="difflineminus">-      if (!mPrintSettings)</span>
<a href="#l17.717"></a><span id="l17.717" class="difflineminus">-      {</span>
<a href="#l17.718"></a><span id="l17.718" class="difflineminus">-        mWebBrowserPrint-&gt;GetGlobalPrintSettings(getter_AddRefs(mPrintSettings));</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineplus">+    if (mWebBrowserPrint) {</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineplus">+      if (!mPrintSettings) {</span>
<a href="#l17.721"></a><span id="l17.721" class="difflineplus">+        mWebBrowserPrint-&gt;GetGlobalPrintSettings(</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineplus">+            getter_AddRefs(mPrintSettings));</span>
<a href="#l17.723"></a><span id="l17.723">       }</span>
<a href="#l17.724"></a><span id="l17.724"> </span>
<a href="#l17.725"></a><span id="l17.725">       // fix for bug #118887 and bug #176016</span>
<a href="#l17.726"></a><span id="l17.726" class="difflineminus">-      // don't show the actual url when printing mail messages or addressbook cards.</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineminus">-      // for mail, it can review the salt.  for addrbook, it's a data:// url, which</span>
<a href="#l17.728"></a><span id="l17.728" class="difflineminus">-      // means nothing to the end user.</span>
<a href="#l17.729"></a><span id="l17.729" class="difflineminus">-      // needs to be &quot; &quot; and not &quot;&quot; or nullptr, otherwise, we'll still print the url</span>
<a href="#l17.730"></a><span id="l17.730" class="difflineplus">+      // don't show the actual url when printing mail messages or addressbook</span>
<a href="#l17.731"></a><span id="l17.731" class="difflineplus">+      // cards. for mail, it can review the salt.  for addrbook, it's a data://</span>
<a href="#l17.732"></a><span id="l17.732" class="difflineplus">+      // url, which means nothing to the end user. needs to be &quot; &quot; and not &quot;&quot; or</span>
<a href="#l17.733"></a><span id="l17.733" class="difflineplus">+      // nullptr, otherwise, we'll still print the url</span>
<a href="#l17.734"></a><span id="l17.734">       mPrintSettings-&gt;SetDocURL(NS_LITERAL_STRING(&quot; &quot;));</span>
<a href="#l17.735"></a><span id="l17.735"> </span>
<a href="#l17.736"></a><span id="l17.736">       nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l17.737"></a><span id="l17.737" class="difflineminus">-      if (mIsDoingPrintPreview)</span>
<a href="#l17.738"></a><span id="l17.738" class="difflineminus">-      {</span>
<a href="#l17.739"></a><span id="l17.739" class="difflineplus">+      if (mIsDoingPrintPreview) {</span>
<a href="#l17.740"></a><span id="l17.740">         if (mStartupPPObs) {</span>
<a href="#l17.741"></a><span id="l17.741">           rv = mStartupPPObs-&gt;Observe(nullptr, nullptr, nullptr);</span>
<a href="#l17.742"></a><span id="l17.742">         }</span>
<a href="#l17.743"></a><span id="l17.743" class="difflineminus">-      }</span>
<a href="#l17.744"></a><span id="l17.744" class="difflineminus">-      else</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineminus">-      {</span>
<a href="#l17.746"></a><span id="l17.746" class="difflineplus">+      } else {</span>
<a href="#l17.747"></a><span id="l17.747">         mPrintSettings-&gt;SetPrintSilent(mCurrentlyPrintingURI != 0);</span>
<a href="#l17.748"></a><span id="l17.748" class="difflineminus">-        rv = mWebBrowserPrint-&gt;Print(mPrintSettings, (nsIWebProgressListener *)this);</span>
<a href="#l17.749"></a><span id="l17.749" class="difflineplus">+        rv = mWebBrowserPrint-&gt;Print(mPrintSettings,</span>
<a href="#l17.750"></a><span id="l17.750" class="difflineplus">+                                     (nsIWebProgressListener *)this);</span>
<a href="#l17.751"></a><span id="l17.751">       }</span>
<a href="#l17.752"></a><span id="l17.752"> </span>
<a href="#l17.753"></a><span id="l17.753" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l17.754"></a><span id="l17.754" class="difflineminus">-      {</span>
<a href="#l17.755"></a><span id="l17.755" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l17.756"></a><span id="l17.756">         mWebBrowserPrint = nullptr;</span>
<a href="#l17.757"></a><span id="l17.757">         mContentViewer = nullptr;</span>
<a href="#l17.758"></a><span id="l17.758">         bool isPrintingCancelled = false;</span>
<a href="#l17.759"></a><span id="l17.759" class="difflineminus">-        if (mPrintSettings)</span>
<a href="#l17.760"></a><span id="l17.760" class="difflineminus">-        {</span>
<a href="#l17.761"></a><span id="l17.761" class="difflineplus">+        if (mPrintSettings) {</span>
<a href="#l17.762"></a><span id="l17.762">           mPrintSettings-&gt;GetIsCancelled(&amp;isPrintingCancelled);</span>
<a href="#l17.763"></a><span id="l17.763">         }</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineminus">-        if (!isPrintingCancelled)</span>
<a href="#l17.765"></a><span id="l17.765" class="difflineminus">-        {</span>
<a href="#l17.766"></a><span id="l17.766" class="difflineplus">+        if (!isPrintingCancelled) {</span>
<a href="#l17.767"></a><span id="l17.767">           StartNextPrintOperation();</span>
<a href="#l17.768"></a><span id="l17.768" class="difflineminus">-        }</span>
<a href="#l17.769"></a><span id="l17.769" class="difflineminus">-        else</span>
<a href="#l17.770"></a><span id="l17.770" class="difflineminus">-        {</span>
<a href="#l17.771"></a><span id="l17.771" class="difflineplus">+        } else {</span>
<a href="#l17.772"></a><span id="l17.772">           if (mWindow) {</span>
<a href="#l17.773"></a><span id="l17.773">             nsPIDOMWindowOuter::From(mWindow)-&gt;Close();</span>
<a href="#l17.774"></a><span id="l17.774">           }</span>
<a href="#l17.775"></a><span id="l17.775">         }</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineminus">-      }</span>
<a href="#l17.777"></a><span id="l17.777" class="difflineminus">-      else</span>
<a href="#l17.778"></a><span id="l17.778" class="difflineminus">-      {</span>
<a href="#l17.779"></a><span id="l17.779" class="difflineplus">+      } else {</span>
<a href="#l17.780"></a><span id="l17.780">         // Tell the user we started printing...</span>
<a href="#l17.781"></a><span id="l17.781">         nsString msg;</span>
<a href="#l17.782"></a><span id="l17.782">         GetString(NS_ConvertASCIItoUTF16(kMsgKeys[mMsgInx]).get(), msg);</span>
<a href="#l17.783"></a><span id="l17.783">         SetStatusMessage(msg);</span>
<a href="#l17.784"></a><span id="l17.784">       }</span>
<a href="#l17.785"></a><span id="l17.785">     }</span>
<a href="#l17.786"></a><span id="l17.786">   }</span>
<a href="#l17.787"></a><span id="l17.787"> }</span>
<a href="#l17.788"></a><span id="l17.788"> </span>
<a href="#l17.789"></a><span id="l17.789"> //---------------------------------------------------------------</span>
<a href="#l17.790"></a><span id="l17.790"> //-- Event Notification</span>
<a href="#l17.791"></a><span id="l17.791"> //---------------------------------------------------------------</span>
<a href="#l17.792"></a><span id="l17.792"> </span>
<a href="#l17.793"></a><span id="l17.793"> //---------------------------------------------------------------</span>
<a href="#l17.794"></a><span id="l17.794" class="difflineminus">-class nsPrintMsgWindowEvent : public mozilla::Runnable</span>
<a href="#l17.795"></a><span id="l17.795" class="difflineminus">-{</span>
<a href="#l17.796"></a><span id="l17.796" class="difflineminus">-public:</span>
<a href="#l17.797"></a><span id="l17.797" class="difflineplus">+class nsPrintMsgWindowEvent : public mozilla::Runnable {</span>
<a href="#l17.798"></a><span id="l17.798" class="difflineplus">+ public:</span>
<a href="#l17.799"></a><span id="l17.799">   explicit nsPrintMsgWindowEvent(nsMsgPrintEngine *mpe)</span>
<a href="#l17.800"></a><span id="l17.800" class="difflineminus">-    : mozilla::Runnable(&quot;nsPrintMsgWindowEvent&quot;), mMsgPrintEngine(mpe)</span>
<a href="#l17.801"></a><span id="l17.801" class="difflineminus">-  {}</span>
<a href="#l17.802"></a><span id="l17.802" class="difflineplus">+      : mozilla::Runnable(&quot;nsPrintMsgWindowEvent&quot;), mMsgPrintEngine(mpe) {}</span>
<a href="#l17.803"></a><span id="l17.803"> </span>
<a href="#l17.804"></a><span id="l17.804" class="difflineminus">-  NS_IMETHOD Run()</span>
<a href="#l17.805"></a><span id="l17.805" class="difflineminus">-  {</span>
<a href="#l17.806"></a><span id="l17.806" class="difflineminus">-    if (mMsgPrintEngine)</span>
<a href="#l17.807"></a><span id="l17.807" class="difflineminus">-      mMsgPrintEngine-&gt;PrintMsgWindow();</span>
<a href="#l17.808"></a><span id="l17.808" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l17.809"></a><span id="l17.809" class="difflineplus">+    if (mMsgPrintEngine) mMsgPrintEngine-&gt;PrintMsgWindow();</span>
<a href="#l17.810"></a><span id="l17.810">     return NS_OK;</span>
<a href="#l17.811"></a><span id="l17.811">   }</span>
<a href="#l17.812"></a><span id="l17.812"> </span>
<a href="#l17.813"></a><span id="l17.813" class="difflineminus">-private:</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineplus">+ private:</span>
<a href="#l17.815"></a><span id="l17.815">   RefPtr&lt;nsMsgPrintEngine&gt; mMsgPrintEngine;</span>
<a href="#l17.816"></a><span id="l17.816"> };</span>
<a href="#l17.817"></a><span id="l17.817"> </span>
<a href="#l17.818"></a><span id="l17.818"> //-----------------------------------------------------------</span>
<a href="#l17.819"></a><span id="l17.819" class="difflineminus">-class nsStartNextPrintOpEvent : public mozilla::Runnable</span>
<a href="#l17.820"></a><span id="l17.820" class="difflineminus">-{</span>
<a href="#l17.821"></a><span id="l17.821" class="difflineminus">-public:</span>
<a href="#l17.822"></a><span id="l17.822" class="difflineplus">+class nsStartNextPrintOpEvent : public mozilla::Runnable {</span>
<a href="#l17.823"></a><span id="l17.823" class="difflineplus">+ public:</span>
<a href="#l17.824"></a><span id="l17.824">   explicit nsStartNextPrintOpEvent(nsMsgPrintEngine *mpe)</span>
<a href="#l17.825"></a><span id="l17.825" class="difflineminus">-    : mozilla::Runnable(&quot;nsStartNextPrintOpEvent&quot;), mMsgPrintEngine(mpe)</span>
<a href="#l17.826"></a><span id="l17.826" class="difflineminus">-  {}</span>
<a href="#l17.827"></a><span id="l17.827" class="difflineplus">+      : mozilla::Runnable(&quot;nsStartNextPrintOpEvent&quot;), mMsgPrintEngine(mpe) {}</span>
<a href="#l17.828"></a><span id="l17.828"> </span>
<a href="#l17.829"></a><span id="l17.829" class="difflineminus">-  NS_IMETHOD Run()</span>
<a href="#l17.830"></a><span id="l17.830" class="difflineminus">-  {</span>
<a href="#l17.831"></a><span id="l17.831" class="difflineminus">-    if (mMsgPrintEngine)</span>
<a href="#l17.832"></a><span id="l17.832" class="difflineminus">-      mMsgPrintEngine-&gt;StartNextPrintOperation();</span>
<a href="#l17.833"></a><span id="l17.833" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l17.834"></a><span id="l17.834" class="difflineplus">+    if (mMsgPrintEngine) mMsgPrintEngine-&gt;StartNextPrintOperation();</span>
<a href="#l17.835"></a><span id="l17.835">     return NS_OK;</span>
<a href="#l17.836"></a><span id="l17.836">   }</span>
<a href="#l17.837"></a><span id="l17.837"> </span>
<a href="#l17.838"></a><span id="l17.838" class="difflineminus">-private:</span>
<a href="#l17.839"></a><span id="l17.839" class="difflineplus">+ private:</span>
<a href="#l17.840"></a><span id="l17.840">   RefPtr&lt;nsMsgPrintEngine&gt; mMsgPrintEngine;</span>
<a href="#l17.841"></a><span id="l17.841"> };</span>
<a href="#l17.842"></a><span id="l17.842"> </span>
<a href="#l17.843"></a><span id="l17.843"> //-----------------------------------------------------------</span>
<a href="#l17.844"></a><span id="l17.844" class="difflineminus">-bool</span>
<a href="#l17.845"></a><span id="l17.845" class="difflineminus">-nsMsgPrintEngine::FirePrintEvent()</span>
<a href="#l17.846"></a><span id="l17.846" class="difflineminus">-{</span>
<a href="#l17.847"></a><span id="l17.847" class="difflineplus">+bool nsMsgPrintEngine::FirePrintEvent() {</span>
<a href="#l17.848"></a><span id="l17.848">   nsCOMPtr&lt;nsIRunnable&gt; event = new nsPrintMsgWindowEvent(this);</span>
<a href="#l17.849"></a><span id="l17.849">   return NS_SUCCEEDED(NS_DispatchToCurrentThread(event));</span>
<a href="#l17.850"></a><span id="l17.850"> }</span>
<a href="#l17.851"></a><span id="l17.851"> </span>
<a href="#l17.852"></a><span id="l17.852"> //-----------------------------------------------------------</span>
<a href="#l17.853"></a><span id="l17.853" class="difflineminus">-nsresult</span>
<a href="#l17.854"></a><span id="l17.854" class="difflineminus">-nsMsgPrintEngine::FireStartNextEvent()</span>
<a href="#l17.855"></a><span id="l17.855" class="difflineminus">-{</span>
<a href="#l17.856"></a><span id="l17.856" class="difflineplus">+nsresult nsMsgPrintEngine::FireStartNextEvent() {</span>
<a href="#l17.857"></a><span id="l17.857">   nsCOMPtr&lt;nsIRunnable&gt; event = new nsStartNextPrintOpEvent(this);</span>
<a href="#l17.858"></a><span id="l17.858">   return NS_DispatchToCurrentThread(event);</span>
<a href="#l17.859"></a><span id="l17.859"> }</span>
<a href="#l17.860"></a><span id="l17.860"> </span>
<a href="#l17.861"></a><span id="l17.861"> /* void setStartupPPObserver (in nsIObserver startupPPObs); */</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineminus">-NS_IMETHODIMP nsMsgPrintEngine::SetStartupPPObserver(nsIObserver *startupPPObs)</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineminus">-{</span>
<a href="#l17.864"></a><span id="l17.864" class="difflineplus">+NS_IMETHODIMP nsMsgPrintEngine::SetStartupPPObserver(</span>
<a href="#l17.865"></a><span id="l17.865" class="difflineplus">+    nsIObserver *startupPPObs) {</span>
<a href="#l17.866"></a><span id="l17.866">   mStartupPPObs = startupPPObs;</span>
<a href="#l17.867"></a><span id="l17.867">   return NS_OK;</span>
<a href="#l17.868"></a><span id="l17.868"> }</span>
<a href="#l17.869"></a><span id="l17.869"> </span>
<a href="#l17.870"></a><span id="l17.870"> /* attribute boolean doPrintPreview; */</span>
<a href="#l17.871"></a><span id="l17.871" class="difflineminus">-NS_IMETHODIMP nsMsgPrintEngine::GetDoPrintPreview(bool *aDoPrintPreview)</span>
<a href="#l17.872"></a><span id="l17.872" class="difflineminus">-{</span>
<a href="#l17.873"></a><span id="l17.873" class="difflineplus">+NS_IMETHODIMP nsMsgPrintEngine::GetDoPrintPreview(bool *aDoPrintPreview) {</span>
<a href="#l17.874"></a><span id="l17.874">   NS_ENSURE_ARG_POINTER(aDoPrintPreview);</span>
<a href="#l17.875"></a><span id="l17.875">   *aDoPrintPreview = mIsDoingPrintPreview;</span>
<a href="#l17.876"></a><span id="l17.876">   return NS_OK;</span>
<a href="#l17.877"></a><span id="l17.877"> }</span>
<a href="#l17.878"></a><span id="l17.878" class="difflineminus">-NS_IMETHODIMP nsMsgPrintEngine::SetDoPrintPreview(bool aDoPrintPreview)</span>
<a href="#l17.879"></a><span id="l17.879" class="difflineminus">-{</span>
<a href="#l17.880"></a><span id="l17.880" class="difflineplus">+NS_IMETHODIMP nsMsgPrintEngine::SetDoPrintPreview(bool aDoPrintPreview) {</span>
<a href="#l17.881"></a><span id="l17.881">   mIsDoingPrintPreview = aDoPrintPreview;</span>
<a href="#l17.882"></a><span id="l17.882">   return NS_OK;</span>
<a href="#l17.883"></a><span id="l17.883"> }</span>
<a href="#l17.884"></a><span id="l17.884"> </span>
<a href="#l17.885"></a><span id="l17.885"> /* void setMsgType (in long aMsgType); */</span>
<a href="#l17.886"></a><span id="l17.886" class="difflineminus">-NS_IMETHODIMP nsMsgPrintEngine::SetMsgType(int32_t aMsgType)</span>
<a href="#l17.887"></a><span id="l17.887" class="difflineminus">-{</span>
<a href="#l17.888"></a><span id="l17.888" class="difflineminus">-  if (mMsgInx &gt;= nsIMsgPrintEngine::MNAB_START &amp;&amp; mMsgInx &lt; nsIMsgPrintEngine::MNAB_END)</span>
<a href="#l17.889"></a><span id="l17.889" class="difflineminus">-  {</span>
<a href="#l17.890"></a><span id="l17.890" class="difflineplus">+NS_IMETHODIMP nsMsgPrintEngine::SetMsgType(int32_t aMsgType) {</span>
<a href="#l17.891"></a><span id="l17.891" class="difflineplus">+  if (mMsgInx &gt;= nsIMsgPrintEngine::MNAB_START &amp;&amp;</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineplus">+      mMsgInx &lt; nsIMsgPrintEngine::MNAB_END) {</span>
<a href="#l17.893"></a><span id="l17.893">     mMsgInx = aMsgType;</span>
<a href="#l17.894"></a><span id="l17.894">     return NS_OK;</span>
<a href="#l17.895"></a><span id="l17.895">   }</span>
<a href="#l17.896"></a><span id="l17.896">   return NS_ERROR_FAILURE;</span>
<a href="#l17.897"></a><span id="l17.897"> }</span>
<a href="#l17.898"></a><span id="l17.898"> </span>
<a href="#l17.899"></a><span id="l17.899"> /*=============== nsIObserver Interface ======================*/</span>
<a href="#l17.900"></a><span id="l17.900" class="difflineminus">-NS_IMETHODIMP nsMsgPrintEngine::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *aData)</span>
<a href="#l17.901"></a><span id="l17.901" class="difflineminus">-{</span>
<a href="#l17.902"></a><span id="l17.902" class="difflineplus">+NS_IMETHODIMP nsMsgPrintEngine::Observe(nsISupports *aSubject,</span>
<a href="#l17.903"></a><span id="l17.903" class="difflineplus">+                                        const char *aTopic,</span>
<a href="#l17.904"></a><span id="l17.904" class="difflineplus">+                                        const char16_t *aData) {</span>
<a href="#l17.905"></a><span id="l17.905">   return FireThatLoadOperation(mLoadURI);</span>
<a href="#l17.906"></a><span id="l17.906"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPrintEngine.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPrintEngine.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -27,65 +27,64 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsIPrintProgress.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsIPrintProgressParams.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsIPrintingPromptService.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> class nsMsgPrintEngine : public nsIMsgPrintEngine,</span>
<a href="#l18.9"></a><span id="l18.9">                          public nsIWebProgressListener,</span>
<a href="#l18.10"></a><span id="l18.10">                          public nsIObserver,</span>
<a href="#l18.11"></a><span id="l18.11">                          public nsSupportsWeakReference {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-public:</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ public:</span>
<a href="#l18.15"></a><span id="l18.15">   nsMsgPrintEngine();</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17">   // nsISupports</span>
<a href="#l18.18"></a><span id="l18.18">   NS_DECL_ISUPPORTS</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20">   // nsIMsgPrintEngine interface</span>
<a href="#l18.21"></a><span id="l18.21">   NS_DECL_NSIMSGPRINTENGINE</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23">   // For nsIWebProgressListener</span>
<a href="#l18.24"></a><span id="l18.24">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26">   // For nsIObserver</span>
<a href="#l18.27"></a><span id="l18.27">   NS_DECL_NSIOBSERVER</span>
<a href="#l18.28"></a><span id="l18.28"> </span>
<a href="#l18.29"></a><span id="l18.29">   void PrintMsgWindow();</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  NS_IMETHOD  StartNextPrintOperation();</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  NS_IMETHOD StartNextPrintOperation();</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-protected:</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+ protected:</span>
<a href="#l18.35"></a><span id="l18.35">   virtual ~nsMsgPrintEngine();</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  bool        FirePrintEvent();</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-  nsresult    FireStartNextEvent();</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-  nsresult    FireThatLoadOperationStartup(const nsString&amp; uri);</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-  nsresult    FireThatLoadOperation(const nsString&amp; uri);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  void        InitializeDisplayCharset();</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  void        SetupObserver();</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-  nsresult    SetStatusMessage(const nsString&amp; aMsgString);</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-  void GetString(const char16_t *aStringName, nsString&amp; aOutString);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-  nsresult    ShowProgressDialog(bool aIsForPrinting, bool&amp; aDoNotify);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  bool FirePrintEvent();</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  nsresult FireStartNextEvent();</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+  nsresult FireThatLoadOperationStartup(const nsString&amp; uri);</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+  nsresult FireThatLoadOperation(const nsString&amp; uri);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+  void InitializeDisplayCharset();</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  void SetupObserver();</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  nsresult SetStatusMessage(const nsString&amp; aMsgString);</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+  void GetString(const char16_t* aStringName, nsString&amp; aOutString);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+  nsresult ShowProgressDialog(bool aIsForPrinting, bool&amp; aDoNotify);</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-  nsCOMPtr&lt;nsIDocShell&gt;       mDocShell;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; mDocShell;</span>
<a href="#l18.58"></a><span id="l18.58">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; mWindow;</span>
<a href="#l18.59"></a><span id="l18.59">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; mParentWindow;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-  int32_t                     mURICount;</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-  nsTArray&lt;nsString&gt;          mURIArray;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-  int32_t                     mCurrentlyPrintingURI;</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+  int32_t mURICount;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+  nsTArray&lt;nsString&gt; mURIArray;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+  int32_t mCurrentlyPrintingURI;</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-  nsCOMPtr&lt;nsIContentViewer&gt;  mContentViewer;</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;   mStringBundle;    // String bundles...</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; mFeedback;     // Tell the user something why don't ya'</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  nsCOMPtr&lt;nsIContentViewer&gt; mContentViewer;</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; mStringBundle;   // String bundles...</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; mFeedback;  // Tell the user something</span>
<a href="#l18.73"></a><span id="l18.73">   nsCOMPtr&lt;nsIWebBrowserPrint&gt; mWebBrowserPrint;</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-  nsCOMPtr&lt;nsIPrintSettings&gt;   mPrintSettings;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+  nsCOMPtr&lt;nsIPrintSettings&gt; mPrintSettings;</span>
<a href="#l18.76"></a><span id="l18.76">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; mMsgDOMWin;</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-  bool                         mIsDoingPrintPreview;</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-  nsCOMPtr&lt;nsIObserver&gt;        mStartupPPObs;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-  int32_t                      mMsgInx;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+  bool mIsDoingPrintPreview;</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  nsCOMPtr&lt;nsIObserver&gt; mStartupPPObs;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  int32_t mMsgInx;</span>
<a href="#l18.83"></a><span id="l18.83"> </span>
<a href="#l18.84"></a><span id="l18.84">   // Progress Dialog</span>
<a href="#l18.85"></a><span id="l18.85"> </span>
<a href="#l18.86"></a><span id="l18.86">   nsCOMPtr&lt;nsIPrintingPromptService&gt; mPrintPromptService;</span>
<a href="#l18.87"></a><span id="l18.87">   nsCOMPtr&lt;nsIWebProgressListener&gt; mPrintProgressListener;</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-  nsCOMPtr&lt;nsIPrintProgress&gt;       mPrintProgress;</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  nsCOMPtr&lt;nsIPrintProgress&gt; mPrintProgress;</span>
<a href="#l18.90"></a><span id="l18.90">   nsCOMPtr&lt;nsIPrintProgressParams&gt; mPrintProgressParams;</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-  nsString                         mLoadURI;</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+  nsString mLoadURI;</span>
<a href="#l18.93"></a><span id="l18.93"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/src/nsMsgProgress.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgProgress.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -15,253 +15,238 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsPIDOMWindow.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> NS_IMPL_ISUPPORTS(nsMsgProgress, nsIMsgStatusFeedback, nsIMsgProgress,</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  nsIWebProgressListener, nsIProgressEventSink, nsISupportsWeakReference)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+                  nsIWebProgressListener, nsIProgressEventSink,</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+                  nsISupportsWeakReference)</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-nsMsgProgress::nsMsgProgress()</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-{</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+nsMsgProgress::nsMsgProgress() {</span>
<a href="#l19.20"></a><span id="l19.20">   m_closeProgress = false;</span>
<a href="#l19.21"></a><span id="l19.21">   m_processCanceled = false;</span>
<a href="#l19.22"></a><span id="l19.22">   m_pendingStateFlags = -1;</span>
<a href="#l19.23"></a><span id="l19.23">   m_pendingStateValue = NS_OK;</span>
<a href="#l19.24"></a><span id="l19.24"> }</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-nsMsgProgress::~nsMsgProgress()</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-{</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-  (void)ReleaseListeners();</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-}</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+nsMsgProgress::~nsMsgProgress() { (void)ReleaseListeners(); }</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OpenProgressDialog(mozIDOMWindowProxy *parentDOMWindow,</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-                                                const char *dialogURL,</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-                                                bool inDisplayModal,</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-                                                nsISupports *parameters)</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-{</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OpenProgressDialog(</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    mozIDOMWindowProxy *parentDOMWindow, nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+    const char *dialogURL, bool inDisplayModal, nsISupports *parameters) {</span>
<a href="#l19.41"></a><span id="l19.41">   nsresult rv;</span>
<a href="#l19.42"></a><span id="l19.42"> </span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-  {</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+  if (aMsgWindow) {</span>
<a href="#l19.46"></a><span id="l19.46">     SetMsgWindow(aMsgWindow);</span>
<a href="#l19.47"></a><span id="l19.47">     aMsgWindow-&gt;SetStatusFeedback(this);</span>
<a href="#l19.48"></a><span id="l19.48">   }</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50">   NS_ENSURE_ARG_POINTER(dialogURL);</span>
<a href="#l19.51"></a><span id="l19.51">   NS_ENSURE_ARG_POINTER(parentDOMWindow);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parent = nsPIDOMWindowOuter::From(parentDOMWindow);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parent =</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+      nsPIDOMWindowOuter::From(parentDOMWindow);</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56">   // Set up window.arguments[0]...</span>
<a href="#l19.57"></a><span id="l19.57">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l19.58"></a><span id="l19.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.59"></a><span id="l19.59"> </span>
<a href="#l19.60"></a><span id="l19.60">   nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr =</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-    do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l19.63"></a><span id="l19.63">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.64"></a><span id="l19.64"> </span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-  ifptr-&gt;SetData(static_cast&lt;nsIMsgProgress*&gt;(this));</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+  ifptr-&gt;SetData(static_cast&lt;nsIMsgProgress *&gt;(this));</span>
<a href="#l19.67"></a><span id="l19.67">   ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIMsgProgress));</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69">   array-&gt;AppendElement(ifptr);</span>
<a href="#l19.70"></a><span id="l19.70">   array-&gt;AppendElement(parameters);</span>
<a href="#l19.71"></a><span id="l19.71"> </span>
<a href="#l19.72"></a><span id="l19.72">   // Open the dialog.</span>
<a href="#l19.73"></a><span id="l19.73">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; newWindow;</span>
<a href="#l19.74"></a><span id="l19.74"> </span>
<a href="#l19.75"></a><span id="l19.75">   nsString chromeOptions(NS_LITERAL_STRING(&quot;chrome,dependent,centerscreen&quot;));</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-  if (inDisplayModal)</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-    chromeOptions.AppendLiteral(&quot;,modal&quot;);</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+  if (inDisplayModal) chromeOptions.AppendLiteral(&quot;,modal&quot;);</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80">   return parent-&gt;OpenDialog(NS_ConvertASCIItoUTF16(dialogURL),</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-                            NS_LITERAL_STRING(&quot;_blank&quot;),</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-                            chromeOptions,</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-                            array, getter_AddRefs(newWindow));</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+                            NS_LITERAL_STRING(&quot;_blank&quot;), chromeOptions, array,</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+                            getter_AddRefs(newWindow));</span>
<a href="#l19.86"></a><span id="l19.86"> }</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-/* void closeProgressDialog (in boolean forceClose); */</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::CloseProgressDialog(bool forceClose)</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-{</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::CloseProgressDialog(bool forceClose) {</span>
<a href="#l19.92"></a><span id="l19.92">   m_closeProgress = true;</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-  return OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP, forceClose ? NS_ERROR_FAILURE : NS_OK);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+  return OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP,</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+                       forceClose ? NS_ERROR_FAILURE : NS_OK);</span>
<a href="#l19.96"></a><span id="l19.96"> }</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-/* attribute boolean processCanceledByUser; */</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::GetProcessCanceledByUser(bool *aProcessCanceledByUser)</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-{</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::GetProcessCanceledByUser(</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+    bool *aProcessCanceledByUser) {</span>
<a href="#l19.103"></a><span id="l19.103">   NS_ENSURE_ARG_POINTER(aProcessCanceledByUser);</span>
<a href="#l19.104"></a><span id="l19.104">   *aProcessCanceledByUser = m_processCanceled;</span>
<a href="#l19.105"></a><span id="l19.105">   return NS_OK;</span>
<a href="#l19.106"></a><span id="l19.106"> }</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::SetProcessCanceledByUser(bool aProcessCanceledByUser)</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-{</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::SetProcessCanceledByUser(</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+    bool aProcessCanceledByUser) {</span>
<a href="#l19.111"></a><span id="l19.111">   m_processCanceled = aProcessCanceledByUser;</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-  OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP, NS_BINDING_ABORTED);</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+  OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP,</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+                NS_BINDING_ABORTED);</span>
<a href="#l19.115"></a><span id="l19.115">   return NS_OK;</span>
<a href="#l19.116"></a><span id="l19.116"> }</span>
<a href="#l19.117"></a><span id="l19.117"> </span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-/* void RegisterListener (in nsIWebProgressListener listener); */</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::RegisterListener(nsIWebProgressListener * listener)</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-{</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-  if (!listener) //Nothing to do with a null listener!</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::RegisterListener(</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+    nsIWebProgressListener *listener) {</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+  if (!listener)  // Nothing to do with a null listener!</span>
<a href="#l19.125"></a><span id="l19.125">     return NS_OK;</span>
<a href="#l19.126"></a><span id="l19.126"> </span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-  NS_ENSURE_ARG(this != listener); //Check for self-reference (see bug 271700)</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+  NS_ENSURE_ARG(this != listener);  // Check for self-reference (see bug 271700)</span>
<a href="#l19.129"></a><span id="l19.129"> </span>
<a href="#l19.130"></a><span id="l19.130">   m_listenerList.AppendObject(listener);</span>
<a href="#l19.131"></a><span id="l19.131">   if (m_closeProgress || m_processCanceled)</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-    listener-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP, NS_OK);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-  else</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-  {</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+    listener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+                            nsIWebProgressListener::STATE_STOP, NS_OK);</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+  else {</span>
<a href="#l19.138"></a><span id="l19.138">     listener-&gt;OnStatusChange(nullptr, nullptr, NS_OK, m_pendingStatus.get());</span>
<a href="#l19.139"></a><span id="l19.139">     if (m_pendingStateFlags != -1)</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-      listener-&gt;OnStateChange(nullptr, nullptr, m_pendingStateFlags, m_pendingStateValue);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+      listener-&gt;OnStateChange(nullptr, nullptr, m_pendingStateFlags,</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+                              m_pendingStateValue);</span>
<a href="#l19.143"></a><span id="l19.143">   }</span>
<a href="#l19.144"></a><span id="l19.144"> </span>
<a href="#l19.145"></a><span id="l19.145">   return NS_OK;</span>
<a href="#l19.146"></a><span id="l19.146"> }</span>
<a href="#l19.147"></a><span id="l19.147"> </span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-/* void UnregisterListener (in nsIWebProgressListener listener); */</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::UnregisterListener(nsIWebProgressListener *listener)</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-{</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-  if (listener)</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-    m_listenerList.RemoveObject(listener);</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::UnregisterListener(</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+    nsIWebProgressListener *listener) {</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+  if (listener) m_listenerList.RemoveObject(listener);</span>
<a href="#l19.156"></a><span id="l19.156">   return NS_OK;</span>
<a href="#l19.157"></a><span id="l19.157"> }</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-/* void onStateChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in unsigned long aStateFlags, in nsresult aStatus); */</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OnStateChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, uint32_t aStateFlags, nsresult aStatus)</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-{</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OnStateChange(nsIWebProgress *aWebProgress,</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+                                           nsIRequest *aRequest,</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+                                           uint32_t aStateFlags,</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+                                           nsresult aStatus) {</span>
<a href="#l19.166"></a><span id="l19.166">   m_pendingStateFlags = aStateFlags;</span>
<a href="#l19.167"></a><span id="l19.167">   m_pendingStateValue = aStatus;</span>
<a href="#l19.168"></a><span id="l19.168"> </span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow (do_QueryReferent(m_msgWindow));</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-  if (aStateFlags == nsIWebProgressListener::STATE_STOP &amp;&amp; msgWindow &amp;&amp; NS_FAILED(aStatus))</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-  {</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindow));</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+  if (aStateFlags == nsIWebProgressListener::STATE_STOP &amp;&amp; msgWindow &amp;&amp;</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+      NS_FAILED(aStatus)) {</span>
<a href="#l19.175"></a><span id="l19.175">     msgWindow-&gt;StopUrls();</span>
<a href="#l19.176"></a><span id="l19.176">     msgWindow-&gt;SetStatusFeedback(nullptr);</span>
<a href="#l19.177"></a><span id="l19.177">   }</span>
<a href="#l19.178"></a><span id="l19.178"> </span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-  for (int32_t i = m_listenerList.Count() - 1; i &gt;= 0; i --)</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-    m_listenerList[i]-&gt;OnStateChange(aWebProgress, aRequest, aStateFlags, aStatus);</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+  for (int32_t i = m_listenerList.Count() - 1; i &gt;= 0; i--)</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+    m_listenerList[i]-&gt;OnStateChange(aWebProgress, aRequest, aStateFlags,</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+                                     aStatus);</span>
<a href="#l19.184"></a><span id="l19.184"> </span>
<a href="#l19.185"></a><span id="l19.185">   return NS_OK;</span>
<a href="#l19.186"></a><span id="l19.186"> }</span>
<a href="#l19.187"></a><span id="l19.187"> </span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-/* void onProgressChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in long aCurSelfProgress, in long aMaxSelfProgress, in long aCurTotalProgress, in long aMaxTotalProgress); */</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OnProgressChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, int32_t aCurSelfProgress, int32_t aMaxSelfProgress, int32_t aCurTotalProgress, int32_t aMaxTotalProgress)</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-{</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-  for (int32_t i = m_listenerList.Count() - 1; i &gt;= 0; i --)</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-    m_listenerList[i]-&gt;OnProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress);</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-}</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-/* void onLocationChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in nsIURI location, in unsigned long aFlags); */</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OnLocationChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, nsIURI *location, uint32_t aFlags)</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineminus">-{</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OnProgressChange(nsIWebProgress *aWebProgress,</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+                                              nsIRequest *aRequest,</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+                                              int32_t aCurSelfProgress,</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+                                              int32_t aMaxSelfProgress,</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+                                              int32_t aCurTotalProgress,</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+                                              int32_t aMaxTotalProgress) {</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineplus">+  for (int32_t i = m_listenerList.Count() - 1; i &gt;= 0; i--)</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineplus">+    m_listenerList[i]-&gt;OnProgressChange(aWebProgress, aRequest,</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineplus">+                                        aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineplus">+                                        aCurTotalProgress, aMaxTotalProgress);</span>
<a href="#l19.209"></a><span id="l19.209">   return NS_OK;</span>
<a href="#l19.210"></a><span id="l19.210"> }</span>
<a href="#l19.211"></a><span id="l19.211"> </span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-/* void onStatusChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in nsresult aStatus, in wstring aMessage); */</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OnStatusChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, nsresult aStatus, const char16_t *aMessage)</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-{</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-  if (aMessage &amp;&amp; *aMessage)</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-    m_pendingStatus = aMessage;</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-  for (int32_t i = m_listenerList.Count() - 1; i &gt;= 0; i --)</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-    m_listenerList[i]-&gt;OnStatusChange(aWebProgress, aRequest, aStatus, aMessage);</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OnLocationChange(nsIWebProgress *aWebProgress,</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+                                              nsIRequest *aRequest,</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+                                              nsIURI *location,</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineplus">+                                              uint32_t aFlags) {</span>
<a href="#l19.223"></a><span id="l19.223">   return NS_OK;</span>
<a href="#l19.224"></a><span id="l19.224"> }</span>
<a href="#l19.225"></a><span id="l19.225"> </span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-/* void onSecurityChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in unsigned long state); */</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OnSecurityChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, uint32_t state)</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineminus">-{</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OnStatusChange(nsIWebProgress *aWebProgress,</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+                                            nsIRequest *aRequest,</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineplus">+                                            nsresult aStatus,</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineplus">+                                            const char16_t *aMessage) {</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineplus">+  if (aMessage &amp;&amp; *aMessage) m_pendingStatus = aMessage;</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineplus">+  for (int32_t i = m_listenerList.Count() - 1; i &gt;= 0; i--)</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineplus">+    m_listenerList[i]-&gt;OnStatusChange(aWebProgress, aRequest, aStatus,</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineplus">+                                      aMessage);</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineplus">+  return NS_OK;</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+}</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineplus">+                                              nsIRequest *aRequest,</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+                                              uint32_t state) {</span>
<a href="#l19.243"></a><span id="l19.243">   return NS_OK;</span>
<a href="#l19.244"></a><span id="l19.244"> }</span>
<a href="#l19.245"></a><span id="l19.245"> </span>
<a href="#l19.246"></a><span id="l19.246"> NS_IMETHODIMP</span>
<a href="#l19.247"></a><span id="l19.247"> nsMsgProgress::OnContentBlockingEvent(nsIWebProgress *aWebProgress,</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-                                      nsIRequest *aRequest, uint32_t aEvent)</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-{</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineplus">+                                      nsIRequest *aRequest, uint32_t aEvent) {</span>
<a href="#l19.251"></a><span id="l19.251">   return NS_OK;</span>
<a href="#l19.252"></a><span id="l19.252"> }</span>
<a href="#l19.253"></a><span id="l19.253"> </span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-nsresult nsMsgProgress::ReleaseListeners()</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-{</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+nsresult nsMsgProgress::ReleaseListeners() {</span>
<a href="#l19.257"></a><span id="l19.257">   m_listenerList.Clear();</span>
<a href="#l19.258"></a><span id="l19.258">   return NS_OK;</span>
<a href="#l19.259"></a><span id="l19.259"> }</span>
<a href="#l19.260"></a><span id="l19.260"> </span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::ShowStatusString(const nsAString&amp; aStatus)</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-{</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-  return OnStatusChange(nullptr, nullptr, NS_OK, PromiseFlatString(aStatus).get());</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::ShowStatusString(const nsAString &amp;aStatus) {</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+  return OnStatusChange(nullptr, nullptr, NS_OK,</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineplus">+                        PromiseFlatString(aStatus).get());</span>
<a href="#l19.267"></a><span id="l19.267"> }</span>
<a href="#l19.268"></a><span id="l19.268"> </span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::SetStatusString(const nsAString&amp; aStatus)</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-{</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-  return OnStatusChange(nullptr, nullptr, NS_OK, PromiseFlatString(aStatus).get());</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::SetStatusString(const nsAString &amp;aStatus) {</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineplus">+  return OnStatusChange(nullptr, nullptr, NS_OK,</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+                        PromiseFlatString(aStatus).get());</span>
<a href="#l19.275"></a><span id="l19.275"> }</span>
<a href="#l19.276"></a><span id="l19.276"> </span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-/* void startMeteors (); */</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::StartMeteors()</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineminus">-{</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::StartMeteors() { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineplus">+</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::StopMeteors() { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineplus">+</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::ShowProgress(int32_t percent) {</span>
<a href="#l19.285"></a><span id="l19.285">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.286"></a><span id="l19.286"> }</span>
<a href="#l19.287"></a><span id="l19.287"> </span>
<a href="#l19.288"></a><span id="l19.288" class="difflineminus">-/* void stopMeteors (); */</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::StopMeteors()</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineminus">-{</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::SetWrappedStatusFeedback(</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineplus">+    nsIMsgStatusFeedback *aJSStatusFeedback) {</span>
<a href="#l19.293"></a><span id="l19.293">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.294"></a><span id="l19.294"> }</span>
<a href="#l19.295"></a><span id="l19.295"> </span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-/* void showProgress (in long percent); */</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::ShowProgress(int32_t percent)</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineminus">-{</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-}</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::SetWrappedStatusFeedback(nsIMsgStatusFeedback * aJSStatusFeedback)</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-{</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineminus">-}</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineminus">-</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::SetMsgWindow(nsIMsgWindow *aMsgWindow)</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-{</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::SetMsgWindow(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l19.310"></a><span id="l19.310">   m_msgWindow = do_GetWeakReference(aMsgWindow);</span>
<a href="#l19.311"></a><span id="l19.311">   return NS_OK;</span>
<a href="#l19.312"></a><span id="l19.312"> }</span>
<a href="#l19.313"></a><span id="l19.313"> </span>
<a href="#l19.314"></a><span id="l19.314" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::GetMsgWindow(nsIMsgWindow **aMsgWindow)</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineminus">-{</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::GetMsgWindow(nsIMsgWindow **aMsgWindow) {</span>
<a href="#l19.317"></a><span id="l19.317">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l19.318"></a><span id="l19.318"> </span>
<a href="#l19.319"></a><span id="l19.319">   if (m_msgWindow)</span>
<a href="#l19.320"></a><span id="l19.320">     CallQueryReferent(m_msgWindow.get(), aMsgWindow);</span>
<a href="#l19.321"></a><span id="l19.321">   else</span>
<a href="#l19.322"></a><span id="l19.322">     *aMsgWindow = nullptr;</span>
<a href="#l19.323"></a><span id="l19.323"> </span>
<a href="#l19.324"></a><span id="l19.324">   return NS_OK;</span>
<a href="#l19.325"></a><span id="l19.325"> }</span>
<a href="#l19.326"></a><span id="l19.326"> </span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OnProgress(nsIRequest *request, nsISupports* ctxt,</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-                                        int64_t aProgress, int64_t aProgressMax)</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-{</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OnProgress(nsIRequest *request, nsISupports *ctxt,</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineplus">+                                        int64_t aProgress,</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineplus">+                                        int64_t aProgressMax) {</span>
<a href="#l19.333"></a><span id="l19.333">   // XXX: What should the nsIWebProgress be?</span>
<a href="#l19.334"></a><span id="l19.334">   // XXX: This truncates 64-bit to 32-bit</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineminus">-  return OnProgressChange(nullptr, request, int32_t(aProgress), int32_t(aProgressMax),</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-                          int32_t(aProgress) /* current total progress */, int32_t(aProgressMax) /* max total progress */);</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+  return OnProgressChange(nullptr, request, int32_t(aProgress),</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+                          int32_t(aProgressMax),</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineplus">+                          int32_t(aProgress) /* current total progress */,</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineplus">+                          int32_t(aProgressMax) /* max total progress */);</span>
<a href="#l19.341"></a><span id="l19.341"> }</span>
<a href="#l19.342"></a><span id="l19.342"> </span>
<a href="#l19.343"></a><span id="l19.343" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::OnStatus(nsIRequest *request, nsISupports* ctxt,</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineminus">-                                      nsresult aStatus, const char16_t* aStatusArg)</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineminus">-{</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineplus">+NS_IMETHODIMP nsMsgProgress::OnStatus(nsIRequest *request, nsISupports *ctxt,</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+                                      nsresult aStatus,</span>
<a href="#l19.348"></a><span id="l19.348" class="difflineplus">+                                      const char16_t *aStatusArg) {</span>
<a href="#l19.349"></a><span id="l19.349">   nsresult rv;</span>
<a href="#l19.350"></a><span id="l19.350">   nsCOMPtr&lt;nsIStringBundleService&gt; sbs =</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l19.353"></a><span id="l19.353">   NS_ENSURE_TRUE(sbs, NS_ERROR_UNEXPECTED);</span>
<a href="#l19.354"></a><span id="l19.354">   nsString str;</span>
<a href="#l19.355"></a><span id="l19.355">   rv = sbs-&gt;FormatStatusMessage(aStatus, aStatusArg, str);</span>
<a href="#l19.356"></a><span id="l19.356">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.357"></a><span id="l19.357">   return ShowStatusString(str);</span>
<a href="#l19.358"></a><span id="l19.358"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/src/nsMsgProgress.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgProgress.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -14,33 +14,32 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> class nsMsgProgress : public nsIMsgProgress,</span>
<a href="#l20.10"></a><span id="l20.10">                       public nsIMsgStatusFeedback,</span>
<a href="#l20.11"></a><span id="l20.11">                       public nsIProgressEventSink,</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-                      public nsSupportsWeakReference</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-{</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-public:</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+                      public nsSupportsWeakReference {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+ public:</span>
<a href="#l20.17"></a><span id="l20.17">   nsMsgProgress();</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l20.20"></a><span id="l20.20">   NS_DECL_NSIMSGPROGRESS</span>
<a href="#l20.21"></a><span id="l20.21">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l20.22"></a><span id="l20.22">   NS_DECL_NSIMSGSTATUSFEEDBACK</span>
<a href="#l20.23"></a><span id="l20.23">   NS_DECL_NSIPROGRESSEVENTSINK</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-private:</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+ private:</span>
<a href="#l20.27"></a><span id="l20.27">   virtual ~nsMsgProgress();</span>
<a href="#l20.28"></a><span id="l20.28">   nsresult ReleaseListeners(void);</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  bool                               m_closeProgress;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  bool                               m_processCanceled;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  nsString                           m_pendingStatus;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  int32_t                            m_pendingStateFlags;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-  nsresult                           m_pendingStateValue;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-  nsWeakPtr                          m_msgWindow;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+  bool m_closeProgress;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+  bool m_processCanceled;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  nsString m_pendingStatus;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  int32_t m_pendingStateFlags;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+  nsresult m_pendingStateValue;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  nsWeakPtr m_msgWindow;</span>
<a href="#l20.42"></a><span id="l20.42">   nsCOMArray&lt;nsIWebProgressListener&gt; m_listenerList;</span>
<a href="#l20.43"></a><span id="l20.43"> };</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45"> #endif  // nsMsgProgress_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -22,466 +22,495 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> static mozilla::LazyLogModule MsgPurgeLogModule(&quot;MsgPurge&quot;);</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> NS_IMPL_ISUPPORTS(nsMsgPurgeService, nsIMsgPurgeService, nsIMsgSearchNotify)</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-void OnPurgeTimer(nsITimer *timer, void *aPurgeService)</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-{</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  nsMsgPurgeService *purgeService = (nsMsgPurgeService*)aPurgeService;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+void OnPurgeTimer(nsITimer *timer, void *aPurgeService) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  nsMsgPurgeService *purgeService = (nsMsgPurgeService *)aPurgeService;</span>
<a href="#l21.17"></a><span id="l21.17">   purgeService-&gt;PerformPurge();</span>
<a href="#l21.18"></a><span id="l21.18"> }</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-nsMsgPurgeService::nsMsgPurgeService()</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-{</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+nsMsgPurgeService::nsMsgPurgeService() {</span>
<a href="#l21.23"></a><span id="l21.23">   mHaveShutdown = false;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-  mMinDelayBetweenPurges = 480;  // never purge a folder more than once every 8 hours (60 min/hour * 8 hours)</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-  mPurgeTimerInterval = 5;  // fire the purge timer every 5 minutes, starting 5 minutes after the service is created (when we load accounts)</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+  // never purge a folder more than once every 8 hours (60 min/hour * 8 hours.</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+  mMinDelayBetweenPurges = 480;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+  // fire the purge timer every 5 minutes, starting 5 minutes after the service</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+  // is created (when we load accounts).</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+  mPurgeTimerInterval = 5;</span>
<a href="#l21.31"></a><span id="l21.31"> }</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-nsMsgPurgeService::~nsMsgPurgeService()</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-{</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  if (mPurgeTimer)</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-    mPurgeTimer-&gt;Cancel();</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+nsMsgPurgeService::~nsMsgPurgeService() {</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+  if (mPurgeTimer) mPurgeTimer-&gt;Cancel();</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-  if(!mHaveShutdown)</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-    Shutdown();</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+  if (!mHaveShutdown) Shutdown();</span>
<a href="#l21.43"></a><span id="l21.43"> }</span>
<a href="#l21.44"></a><span id="l21.44"> </span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-NS_IMETHODIMP nsMsgPurgeService::Init()</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-{</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+NS_IMETHODIMP nsMsgPurgeService::Init() {</span>
<a href="#l21.48"></a><span id="l21.48">   nsresult rv;</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50">   // these prefs are here to help QA test this feature</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-  {</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l21.57"></a><span id="l21.57">     int32_t min_delay;</span>
<a href="#l21.58"></a><span id="l21.58">     rv = prefBranch-&gt;GetIntPref(&quot;mail.purge.min_delay&quot;, &amp;min_delay);</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp;  min_delay)</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-      mMinDelayBetweenPurges = min_delay;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; min_delay) mMinDelayBetweenPurges = min_delay;</span>
<a href="#l21.62"></a><span id="l21.62"> </span>
<a href="#l21.63"></a><span id="l21.63">     int32_t purge_timer_interval;</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-    rv = prefBranch-&gt;GetIntPref(&quot;mail.purge.timer_interval&quot;, &amp;purge_timer_interval);</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp;  purge_timer_interval)</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+    rv = prefBranch-&gt;GetIntPref(&quot;mail.purge.timer_interval&quot;,</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+                                &amp;purge_timer_interval);</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; purge_timer_interval)</span>
<a href="#l21.69"></a><span id="l21.69">       mPurgeTimerInterval = purge_timer_interval;</span>
<a href="#l21.70"></a><span id="l21.70">   }</span>
<a href="#l21.71"></a><span id="l21.71"> </span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;mail.purge.min_delay=%d minutes&quot;,mMinDelayBetweenPurges));</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;mail.purge.timer_interval=%d minutes&quot;,mPurgeTimerInterval));</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+          (&quot;mail.purge.min_delay=%d minutes&quot;, mMinDelayBetweenPurges));</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+          (&quot;mail.purge.timer_interval=%d minutes&quot;, mPurgeTimerInterval));</span>
<a href="#l21.78"></a><span id="l21.78"> </span>
<a href="#l21.79"></a><span id="l21.79">   // don't start purging right away.</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-  // because the accounts aren't loaded and because the user might be trying to sign in</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-  // or startup, etc.</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+  // because the accounts aren't loaded and because the user might be trying to</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+  // sign in or startup, etc.</span>
<a href="#l21.84"></a><span id="l21.84">   SetupNextPurge();</span>
<a href="#l21.85"></a><span id="l21.85"> </span>
<a href="#l21.86"></a><span id="l21.86">   mHaveShutdown = false;</span>
<a href="#l21.87"></a><span id="l21.87">   return NS_OK;</span>
<a href="#l21.88"></a><span id="l21.88"> }</span>
<a href="#l21.89"></a><span id="l21.89"> </span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-NS_IMETHODIMP nsMsgPurgeService::Shutdown()</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-{</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-  if (mPurgeTimer)</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-  {</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+NS_IMETHODIMP nsMsgPurgeService::Shutdown() {</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+  if (mPurgeTimer) {</span>
<a href="#l21.96"></a><span id="l21.96">     mPurgeTimer-&gt;Cancel();</span>
<a href="#l21.97"></a><span id="l21.97">     mPurgeTimer = nullptr;</span>
<a href="#l21.98"></a><span id="l21.98">   }</span>
<a href="#l21.99"></a><span id="l21.99"> </span>
<a href="#l21.100"></a><span id="l21.100">   mHaveShutdown = true;</span>
<a href="#l21.101"></a><span id="l21.101">   return NS_OK;</span>
<a href="#l21.102"></a><span id="l21.102"> }</span>
<a href="#l21.103"></a><span id="l21.103"> </span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-nsresult nsMsgPurgeService::SetupNextPurge()</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-{</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;setting to check again in %d minutes&quot;,mPurgeTimerInterval));</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+nsresult nsMsgPurgeService::SetupNextPurge() {</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+          (&quot;setting to check again in %d minutes&quot;, mPurgeTimerInterval));</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111">   // Convert mPurgeTimerInterval into milliseconds</span>
<a href="#l21.112"></a><span id="l21.112">   uint32_t timeInMSUint32 = mPurgeTimerInterval * 60000;</span>
<a href="#l21.113"></a><span id="l21.113"> </span>
<a href="#l21.114"></a><span id="l21.114">   // Can't currently reset a timer when it's in the process of</span>
<a href="#l21.115"></a><span id="l21.115">   // calling Notify. So, just release the timer here and create a new one.</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-  if(mPurgeTimer)</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-    mPurgeTimer-&gt;Cancel();</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+  if (mPurgeTimer) mPurgeTimer-&gt;Cancel();</span>
<a href="#l21.119"></a><span id="l21.119"> </span>
<a href="#l21.120"></a><span id="l21.120">   mPurgeTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineminus">-  mPurgeTimer-&gt;InitWithNamedFuncCallback(OnPurgeTimer,</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-                                         (void*)this,</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineminus">-                                         timeInMSUint32,</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineminus">-                                         nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-                                         &quot;nsMsgPurgeService::OnPurgeTimer&quot;);</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+  mPurgeTimer-&gt;InitWithNamedFuncCallback(</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+      OnPurgeTimer, (void *)this, timeInMSUint32, nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+      &quot;nsMsgPurgeService::OnPurgeTimer&quot;);</span>
<a href="#l21.129"></a><span id="l21.129"> </span>
<a href="#l21.130"></a><span id="l21.130">   return NS_OK;</span>
<a href="#l21.131"></a><span id="l21.131"> }</span>
<a href="#l21.132"></a><span id="l21.132"> </span>
<a href="#l21.133"></a><span id="l21.133"> // This is the function that looks for the first folder to purge. It also</span>
<a href="#l21.134"></a><span id="l21.134"> // applies retention settings to any folder that hasn't had retention settings</span>
<a href="#l21.135"></a><span id="l21.135"> // applied in mMinDelayBetweenPurges minutes (default, 8 hours).</span>
<a href="#l21.136"></a><span id="l21.136"> // However, if we've spent more than .5 seconds in this loop, don't</span>
<a href="#l21.137"></a><span id="l21.137"> // apply any more retention settings because it might lock up the UI.</span>
<a href="#l21.138"></a><span id="l21.138"> // This might starve folders later on in the hierarchy, since we always</span>
<a href="#l21.139"></a><span id="l21.139"> // start at the top, but since we also apply retention settings when you</span>
<a href="#l21.140"></a><span id="l21.140"> // open a folder, or when you compact all folders, I think this will do</span>
<a href="#l21.141"></a><span id="l21.141"> // for now, until we have a cleanup on shutdown architecture.</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-nsresult nsMsgPurgeService::PerformPurge()</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-{</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+nsresult nsMsgPurgeService::PerformPurge() {</span>
<a href="#l21.145"></a><span id="l21.145">   MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;performing purge&quot;));</span>
<a href="#l21.146"></a><span id="l21.146"> </span>
<a href="#l21.147"></a><span id="l21.147">   nsresult rv;</span>
<a href="#l21.148"></a><span id="l21.148"> </span>
<a href="#l21.149"></a><span id="l21.149" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.154"></a><span id="l21.154">   bool keepApplyingRetentionSettings = true;</span>
<a href="#l21.155"></a><span id="l21.155"> </span>
<a href="#l21.156"></a><span id="l21.156">   nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l21.157"></a><span id="l21.157">   rv = accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; allServers)</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineminus">-  {</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; allServers) {</span>
<a href="#l21.161"></a><span id="l21.161">     uint32_t numServers;</span>
<a href="#l21.162"></a><span id="l21.162">     rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;%d servers&quot;, numServers));</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+            (&quot;%d servers&quot;, numServers));</span>
<a href="#l21.166"></a><span id="l21.166">     nsCOMPtr&lt;nsIMsgFolder&gt; folderToPurge;</span>
<a href="#l21.167"></a><span id="l21.167">     PRIntervalTime startTime = PR_IntervalNow();</span>
<a href="#l21.168"></a><span id="l21.168">     int32_t purgeIntervalToUse = 0;</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-    PRTime oldestPurgeTime = 0; // we're going to pick the least-recently purged folder</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineplus">+    PRTime oldestPurgeTime =</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineplus">+        0;  // we're going to pick the least-recently purged folder</span>
<a href="#l21.172"></a><span id="l21.172"> </span>
<a href="#l21.173"></a><span id="l21.173">     // apply retention settings to folders that haven't had retention settings</span>
<a href="#l21.174"></a><span id="l21.174">     // applied in mMinDelayBetweenPurges minutes (default 8 hours)</span>
<a href="#l21.175"></a><span id="l21.175">     // Because we get last purge time from the folder cache,</span>
<a href="#l21.176"></a><span id="l21.176">     // this code won't open db's for folders until it decides it needs</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-    // to apply retention settings, and since nsIMsgFolder::ApplyRetentionSettings</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-    // will close any db's it opens, this code won't leave db's open.</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-    for (uint32_t serverIndex=0; serverIndex &lt; numServers; serverIndex++)</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-    {</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineminus">-      nsCOMPtr &lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineminus">-        do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-      {</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-        if (keepApplyingRetentionSettings)</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-        {</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+    // to apply retention settings, and since</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+    // nsIMsgFolder::ApplyRetentionSettings will close any db's it opens, this</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineplus">+    // code won't leave db's open.</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineplus">+    for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++) {</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineplus">+          do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineplus">+        if (keepApplyingRetentionSettings) {</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l21.197"></a><span id="l21.197">           rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l21.198"></a><span id="l21.198">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.199"></a><span id="l21.199"> </span>
<a href="#l21.200"></a><span id="l21.200">           nsCOMPtr&lt;nsIArray&gt; childFolders;</span>
<a href="#l21.201"></a><span id="l21.201">           rv = rootFolder-&gt;GetDescendants(getter_AddRefs(childFolders));</span>
<a href="#l21.202"></a><span id="l21.202">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.203"></a><span id="l21.203"> </span>
<a href="#l21.204"></a><span id="l21.204">           uint32_t cnt = 0;</span>
<a href="#l21.205"></a><span id="l21.205">           childFolders-&gt;GetLength(&amp;cnt);</span>
<a href="#l21.206"></a><span id="l21.206"> </span>
<a href="#l21.207"></a><span id="l21.207">           nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l21.208"></a><span id="l21.208">           nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l21.209"></a><span id="l21.209">           nsCOMPtr&lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l21.210"></a><span id="l21.210"> </span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-          for (uint32_t index = 0; index &lt; cnt; index++)</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-          {</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineplus">+          for (uint32_t index = 0; index &lt; cnt; index++) {</span>
<a href="#l21.214"></a><span id="l21.214">             childFolder = do_QueryElementAt(childFolders, index);</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineminus">-            if (childFolder)</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineminus">-            {</span>
<a href="#l21.217"></a><span id="l21.217" class="difflineplus">+            if (childFolder) {</span>
<a href="#l21.218"></a><span id="l21.218">               uint32_t folderFlags;</span>
<a href="#l21.219"></a><span id="l21.219" class="difflineminus">-              (void) childFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l21.220"></a><span id="l21.220" class="difflineminus">-              if (folderFlags &amp; nsMsgFolderFlags::Virtual)</span>
<a href="#l21.221"></a><span id="l21.221" class="difflineminus">-                continue;</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineplus">+              (void)childFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineplus">+              if (folderFlags &amp; nsMsgFolderFlags::Virtual) continue;</span>
<a href="#l21.224"></a><span id="l21.224">               PRTime curFolderLastPurgeTime = 0;</span>
<a href="#l21.225"></a><span id="l21.225">               nsCString curFolderLastPurgeTimeString, curFolderUri;</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineminus">-              rv = childFolder-&gt;GetStringProperty(&quot;LastPurgeTime&quot;, curFolderLastPurgeTimeString);</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineplus">+              rv = childFolder-&gt;GetStringProperty(&quot;LastPurgeTime&quot;,</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+                                                  curFolderLastPurgeTimeString);</span>
<a href="#l21.229"></a><span id="l21.229">               if (NS_FAILED(rv))</span>
<a href="#l21.230"></a><span id="l21.230" class="difflineminus">-                continue; // it is ok to fail, go on to next folder</span>
<a href="#l21.231"></a><span id="l21.231" class="difflineplus">+                continue;  // it is ok to fail, go on to next folder</span>
<a href="#l21.232"></a><span id="l21.232"> </span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-              if (!curFolderLastPurgeTimeString.IsEmpty())</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-              {</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineplus">+              if (!curFolderLastPurgeTimeString.IsEmpty()) {</span>
<a href="#l21.236"></a><span id="l21.236">                 PRTime theTime;</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineminus">-                PR_ParseTimeString(curFolderLastPurgeTimeString.get(), false, &amp;theTime);</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineplus">+                PR_ParseTimeString(curFolderLastPurgeTimeString.get(), false,</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineplus">+                                   &amp;theTime);</span>
<a href="#l21.240"></a><span id="l21.240">                 curFolderLastPurgeTime = theTime;</span>
<a href="#l21.241"></a><span id="l21.241">               }</span>
<a href="#l21.242"></a><span id="l21.242"> </span>
<a href="#l21.243"></a><span id="l21.243">               childFolder-&gt;GetURI(curFolderUri);</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineminus">-              MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;%s curFolderLastPurgeTime=%s (if blank, then never)&quot;, curFolderUri.get(), curFolderLastPurgeTimeString.get()));</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineplus">+              MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineplus">+                      (&quot;%s curFolderLastPurgeTime=%s (if blank, then never)&quot;,</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineplus">+                       curFolderUri.get(), curFolderLastPurgeTimeString.get()));</span>
<a href="#l21.248"></a><span id="l21.248"> </span>
<a href="#l21.249"></a><span id="l21.249">               // check if this folder is due to purge</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineminus">-              // has to have been purged at least mMinDelayBetweenPurges minutes ago</span>
<a href="#l21.251"></a><span id="l21.251" class="difflineminus">-              // we don't want to purge the folders all the time - once a day is good enough</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineplus">+              // has to have been purged at least mMinDelayBetweenPurges minutes</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineplus">+              // ago we don't want to purge the folders all the time - once a</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineplus">+              // day is good enough</span>
<a href="#l21.255"></a><span id="l21.255">               int64_t minDelayBetweenPurges(mMinDelayBetweenPurges);</span>
<a href="#l21.256"></a><span id="l21.256">               int64_t microSecondsPerMinute(60000000);</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineminus">-              PRTime nextPurgeTime = curFolderLastPurgeTime + (minDelayBetweenPurges * microSecondsPerMinute);</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineminus">-              if (nextPurgeTime &lt; PR_Now())</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineminus">-              {</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineminus">-                MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;purging %s&quot;, curFolderUri.get()));</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineplus">+              PRTime nextPurgeTime =</span>
<a href="#l21.262"></a><span id="l21.262" class="difflineplus">+                  curFolderLastPurgeTime +</span>
<a href="#l21.263"></a><span id="l21.263" class="difflineplus">+                  (minDelayBetweenPurges * microSecondsPerMinute);</span>
<a href="#l21.264"></a><span id="l21.264" class="difflineplus">+              if (nextPurgeTime &lt; PR_Now()) {</span>
<a href="#l21.265"></a><span id="l21.265" class="difflineplus">+                MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.266"></a><span id="l21.266" class="difflineplus">+                        (&quot;purging %s&quot;, curFolderUri.get()));</span>
<a href="#l21.267"></a><span id="l21.267">                 childFolder-&gt;ApplyRetentionSettings();</span>
<a href="#l21.268"></a><span id="l21.268">               }</span>
<a href="#l21.269"></a><span id="l21.269">               PRIntervalTime elapsedTime = PR_IntervalNow() - startTime;</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineminus">-              // check if more than 500 milliseconds have elapsed in this purge process</span>
<a href="#l21.271"></a><span id="l21.271" class="difflineminus">-              if (PR_IntervalToMilliseconds(elapsedTime) &gt; 500)</span>
<a href="#l21.272"></a><span id="l21.272" class="difflineminus">-              {</span>
<a href="#l21.273"></a><span id="l21.273" class="difflineplus">+              // check if more than 500 milliseconds have elapsed in this purge</span>
<a href="#l21.274"></a><span id="l21.274" class="difflineplus">+              // process</span>
<a href="#l21.275"></a><span id="l21.275" class="difflineplus">+              if (PR_IntervalToMilliseconds(elapsedTime) &gt; 500) {</span>
<a href="#l21.276"></a><span id="l21.276">                 keepApplyingRetentionSettings = false;</span>
<a href="#l21.277"></a><span id="l21.277">                 break;</span>
<a href="#l21.278"></a><span id="l21.278">               }</span>
<a href="#l21.279"></a><span id="l21.279">             }</span>
<a href="#l21.280"></a><span id="l21.280">           }</span>
<a href="#l21.281"></a><span id="l21.281">         }</span>
<a href="#l21.282"></a><span id="l21.282">         nsCString type;</span>
<a href="#l21.283"></a><span id="l21.283">         nsresult rv = server-&gt;GetType(type);</span>
<a href="#l21.284"></a><span id="l21.284">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.285"></a><span id="l21.285"> </span>
<a href="#l21.286"></a><span id="l21.286">         nsCString realHostName;</span>
<a href="#l21.287"></a><span id="l21.287">         server-&gt;GetRealHostName(realHostName);</span>
<a href="#l21.288"></a><span id="l21.288" class="difflineminus">-        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] %s (%s)&quot;, serverIndex, realHostName.get(), type.get()));</span>
<a href="#l21.289"></a><span id="l21.289" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.290"></a><span id="l21.290" class="difflineplus">+                (&quot;[%d] %s (%s)&quot;, serverIndex, realHostName.get(), type.get()));</span>
<a href="#l21.291"></a><span id="l21.291"> </span>
<a href="#l21.292"></a><span id="l21.292" class="difflineminus">-        nsCOMPtr &lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l21.293"></a><span id="l21.293" class="difflineplus">+        nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l21.294"></a><span id="l21.294">         rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l21.295"></a><span id="l21.295">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.296"></a><span id="l21.296"> </span>
<a href="#l21.297"></a><span id="l21.297">         int32_t spamLevel;</span>
<a href="#l21.298"></a><span id="l21.298">         spamSettings-&gt;GetLevel(&amp;spamLevel);</span>
<a href="#l21.299"></a><span id="l21.299" class="difflineminus">-        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] spamLevel=%d (if 0, don't purge)&quot;, serverIndex, spamLevel));</span>
<a href="#l21.300"></a><span id="l21.300" class="difflineminus">-        if (!spamLevel)</span>
<a href="#l21.301"></a><span id="l21.301" class="difflineminus">-          continue;</span>
<a href="#l21.302"></a><span id="l21.302" class="difflineplus">+        // clang-format off</span>
<a href="#l21.303"></a><span id="l21.303" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.304"></a><span id="l21.304" class="difflineplus">+                (&quot;[%d] spamLevel=%d (if 0, don't purge)&quot;, serverIndex, spamLevel));</span>
<a href="#l21.305"></a><span id="l21.305" class="difflineplus">+        // clang-format on</span>
<a href="#l21.306"></a><span id="l21.306" class="difflineplus">+        if (!spamLevel) continue;</span>
<a href="#l21.307"></a><span id="l21.307"> </span>
<a href="#l21.308"></a><span id="l21.308">         // check if we are set up to purge for this server</span>
<a href="#l21.309"></a><span id="l21.309">         // if not, skip it.</span>
<a href="#l21.310"></a><span id="l21.310">         bool purgeSpam;</span>
<a href="#l21.311"></a><span id="l21.311">         spamSettings-&gt;GetPurge(&amp;purgeSpam);</span>
<a href="#l21.312"></a><span id="l21.312"> </span>
<a href="#l21.313"></a><span id="l21.313" class="difflineminus">-        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] purgeSpam=%s (if false, don't purge)&quot;, serverIndex, purgeSpam ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.314"></a><span id="l21.314" class="difflineminus">-        if (!purgeSpam)</span>
<a href="#l21.315"></a><span id="l21.315" class="difflineminus">-          continue;</span>
<a href="#l21.316"></a><span id="l21.316" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.317"></a><span id="l21.317" class="difflineplus">+                (&quot;[%d] purgeSpam=%s (if false, don't purge)&quot;, serverIndex,</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineplus">+                 purgeSpam ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineplus">+        if (!purgeSpam) continue;</span>
<a href="#l21.320"></a><span id="l21.320"> </span>
<a href="#l21.321"></a><span id="l21.321">         // check if the spam folder uri is set for this server</span>
<a href="#l21.322"></a><span id="l21.322">         // if not skip it.</span>
<a href="#l21.323"></a><span id="l21.323">         nsCString junkFolderURI;</span>
<a href="#l21.324"></a><span id="l21.324">         rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(junkFolderURI));</span>
<a href="#l21.325"></a><span id="l21.325" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.326"></a><span id="l21.326" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.327"></a><span id="l21.327"> </span>
<a href="#l21.328"></a><span id="l21.328" class="difflineminus">-        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] junkFolderURI=%s (if empty, don't purge)&quot;, serverIndex, junkFolderURI.get()));</span>
<a href="#l21.329"></a><span id="l21.329" class="difflineminus">-        if (junkFolderURI.IsEmpty())</span>
<a href="#l21.330"></a><span id="l21.330" class="difflineminus">-          continue;</span>
<a href="#l21.331"></a><span id="l21.331" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.332"></a><span id="l21.332" class="difflineplus">+                (&quot;[%d] junkFolderURI=%s (if empty, don't purge)&quot;, serverIndex,</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineplus">+                 junkFolderURI.get()));</span>
<a href="#l21.334"></a><span id="l21.334" class="difflineplus">+        if (junkFolderURI.IsEmpty()) continue;</span>
<a href="#l21.335"></a><span id="l21.335"> </span>
<a href="#l21.336"></a><span id="l21.336">         // if the junk folder doesn't exist</span>
<a href="#l21.337"></a><span id="l21.337">         // because the folder pane isn't built yet, for example</span>
<a href="#l21.338"></a><span id="l21.338">         // skip this account</span>
<a href="#l21.339"></a><span id="l21.339">         nsCOMPtr&lt;nsIMsgFolder&gt; junkFolder;</span>
<a href="#l21.340"></a><span id="l21.340">         rv = FindFolder(junkFolderURI, getter_AddRefs(junkFolder));</span>
<a href="#l21.341"></a><span id="l21.341">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.342"></a><span id="l21.342"> </span>
<a href="#l21.343"></a><span id="l21.343" class="difflineminus">-        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] %s exists? %s (if doesn't exist, don't purge)&quot;, serverIndex, junkFolderURI.get(), junkFolder ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.344"></a><span id="l21.344" class="difflineminus">-        if (!junkFolder)</span>
<a href="#l21.345"></a><span id="l21.345" class="difflineminus">-          continue;</span>
<a href="#l21.346"></a><span id="l21.346" class="difflineplus">+        // clang-format off</span>
<a href="#l21.347"></a><span id="l21.347" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.348"></a><span id="l21.348" class="difflineplus">+                (&quot;[%d] %s exists? %s (if doesn't exist, don't purge)&quot;, serverIndex,</span>
<a href="#l21.349"></a><span id="l21.349" class="difflineplus">+                 junkFolderURI.get(), junkFolder ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineplus">+        // clang-format on</span>
<a href="#l21.351"></a><span id="l21.351" class="difflineplus">+        if (!junkFolder) continue;</span>
<a href="#l21.352"></a><span id="l21.352"> </span>
<a href="#l21.353"></a><span id="l21.353">         PRTime curJunkFolderLastPurgeTime = 0;</span>
<a href="#l21.354"></a><span id="l21.354">         nsCString curJunkFolderLastPurgeTimeString;</span>
<a href="#l21.355"></a><span id="l21.355" class="difflineminus">-        rv = junkFolder-&gt;GetStringProperty(&quot;curJunkFolderLastPurgeTime&quot;, curJunkFolderLastPurgeTimeString);</span>
<a href="#l21.356"></a><span id="l21.356" class="difflineplus">+        rv = junkFolder-&gt;GetStringProperty(&quot;curJunkFolderLastPurgeTime&quot;,</span>
<a href="#l21.357"></a><span id="l21.357" class="difflineplus">+                                           curJunkFolderLastPurgeTimeString);</span>
<a href="#l21.358"></a><span id="l21.358">         if (NS_FAILED(rv))</span>
<a href="#l21.359"></a><span id="l21.359" class="difflineminus">-          continue; // it is ok to fail, junk folder may not exist</span>
<a href="#l21.360"></a><span id="l21.360" class="difflineplus">+          continue;  // it is ok to fail, junk folder may not exist</span>
<a href="#l21.361"></a><span id="l21.361"> </span>
<a href="#l21.362"></a><span id="l21.362" class="difflineminus">-        if (!curJunkFolderLastPurgeTimeString.IsEmpty())</span>
<a href="#l21.363"></a><span id="l21.363" class="difflineminus">-        {</span>
<a href="#l21.364"></a><span id="l21.364" class="difflineplus">+        if (!curJunkFolderLastPurgeTimeString.IsEmpty()) {</span>
<a href="#l21.365"></a><span id="l21.365">           PRTime theTime;</span>
<a href="#l21.366"></a><span id="l21.366" class="difflineminus">-          PR_ParseTimeString(curJunkFolderLastPurgeTimeString.get(), false, &amp;theTime);</span>
<a href="#l21.367"></a><span id="l21.367" class="difflineplus">+          PR_ParseTimeString(curJunkFolderLastPurgeTimeString.get(), false,</span>
<a href="#l21.368"></a><span id="l21.368" class="difflineplus">+                             &amp;theTime);</span>
<a href="#l21.369"></a><span id="l21.369">           curJunkFolderLastPurgeTime = theTime;</span>
<a href="#l21.370"></a><span id="l21.370">         }</span>
<a href="#l21.371"></a><span id="l21.371"> </span>
<a href="#l21.372"></a><span id="l21.372" class="difflineminus">-        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] %s curJunkFolderLastPurgeTime=%s (if blank, then never)&quot;, serverIndex, junkFolderURI.get(), curJunkFolderLastPurgeTimeString.get()));</span>
<a href="#l21.373"></a><span id="l21.373" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.374"></a><span id="l21.374" class="difflineplus">+                (&quot;[%d] %s curJunkFolderLastPurgeTime=%s (if blank, then never)&quot;,</span>
<a href="#l21.375"></a><span id="l21.375" class="difflineplus">+                 serverIndex, junkFolderURI.get(),</span>
<a href="#l21.376"></a><span id="l21.376" class="difflineplus">+                 curJunkFolderLastPurgeTimeString.get()));</span>
<a href="#l21.377"></a><span id="l21.377"> </span>
<a href="#l21.378"></a><span id="l21.378">         // check if this account is due to purge</span>
<a href="#l21.379"></a><span id="l21.379">         // has to have been purged at least mMinDelayBetweenPurges minutes ago</span>
<a href="#l21.380"></a><span id="l21.380">         // we don't want to purge the folders all the time</span>
<a href="#l21.381"></a><span id="l21.381" class="difflineminus">-        PRTime nextPurgeTime = curJunkFolderLastPurgeTime + mMinDelayBetweenPurges * 60000000 /* convert mMinDelayBetweenPurges to into microseconds */;</span>
<a href="#l21.382"></a><span id="l21.382" class="difflineminus">-        if (nextPurgeTime &lt; PR_Now())</span>
<a href="#l21.383"></a><span id="l21.383" class="difflineminus">-        {</span>
<a href="#l21.384"></a><span id="l21.384" class="difflineminus">-          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] last purge greater than min delay&quot;, serverIndex));</span>
<a href="#l21.385"></a><span id="l21.385" class="difflineplus">+        PRTime nextPurgeTime =</span>
<a href="#l21.386"></a><span id="l21.386" class="difflineplus">+            curJunkFolderLastPurgeTime +</span>
<a href="#l21.387"></a><span id="l21.387" class="difflineplus">+            mMinDelayBetweenPurges * 60000000  // convert to microseconds.</span>
<a href="#l21.388"></a><span id="l21.388" class="difflineplus">+            ;</span>
<a href="#l21.389"></a><span id="l21.389" class="difflineplus">+        if (nextPurgeTime &lt; PR_Now()) {</span>
<a href="#l21.390"></a><span id="l21.390" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.391"></a><span id="l21.391" class="difflineplus">+                  (&quot;[%d] last purge greater than min delay&quot;, serverIndex));</span>
<a href="#l21.392"></a><span id="l21.392"> </span>
<a href="#l21.393"></a><span id="l21.393" class="difflineminus">-          nsCOMPtr &lt;nsIMsgIncomingServer&gt; junkFolderServer;</span>
<a href="#l21.394"></a><span id="l21.394" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; junkFolderServer;</span>
<a href="#l21.395"></a><span id="l21.395">           rv = junkFolder-&gt;GetServer(getter_AddRefs(junkFolderServer));</span>
<a href="#l21.396"></a><span id="l21.396" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.397"></a><span id="l21.397" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.398"></a><span id="l21.398"> </span>
<a href="#l21.399"></a><span id="l21.399">           bool serverBusy = false;</span>
<a href="#l21.400"></a><span id="l21.400">           bool serverRequiresPassword = true;</span>
<a href="#l21.401"></a><span id="l21.401">           bool passwordPromptRequired;</span>
<a href="#l21.402"></a><span id="l21.402">           bool canSearchMessages = false;</span>
<a href="#l21.403"></a><span id="l21.403">           junkFolderServer-&gt;GetPasswordPromptRequired(&amp;passwordPromptRequired);</span>
<a href="#l21.404"></a><span id="l21.404">           junkFolderServer-&gt;GetServerBusy(&amp;serverBusy);</span>
<a href="#l21.405"></a><span id="l21.405" class="difflineminus">-          junkFolderServer-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPassword);</span>
<a href="#l21.406"></a><span id="l21.406" class="difflineplus">+          junkFolderServer-&gt;GetServerRequiresPasswordForBiff(</span>
<a href="#l21.407"></a><span id="l21.407" class="difflineplus">+              &amp;serverRequiresPassword);</span>
<a href="#l21.408"></a><span id="l21.408">           junkFolderServer-&gt;GetCanSearchMessages(&amp;canSearchMessages);</span>
<a href="#l21.409"></a><span id="l21.409" class="difflineminus">-          // Make sure we're logged on before doing the search (assuming we need to be)</span>
<a href="#l21.410"></a><span id="l21.410" class="difflineminus">-          // and make sure the server isn't already in the middle of downloading new messages</span>
<a href="#l21.411"></a><span id="l21.411" class="difflineminus">-          // and make sure a search isn't already going on</span>
<a href="#l21.412"></a><span id="l21.412" class="difflineminus">-          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (search in progress? %s)&quot;, serverIndex, mSearchSession ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.413"></a><span id="l21.413" class="difflineminus">-          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (server busy? %s)&quot;, serverIndex, serverBusy ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.414"></a><span id="l21.414" class="difflineminus">-          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (serverRequiresPassword? %s)&quot;, serverIndex, serverRequiresPassword ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.415"></a><span id="l21.415" class="difflineminus">-          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (passwordPromptRequired? %s)&quot;, serverIndex, passwordPromptRequired ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.416"></a><span id="l21.416" class="difflineminus">-          if (canSearchMessages &amp;&amp; !mSearchSession &amp;&amp; !serverBusy &amp;&amp; (!serverRequiresPassword || !passwordPromptRequired))</span>
<a href="#l21.417"></a><span id="l21.417" class="difflineminus">-          {</span>
<a href="#l21.418"></a><span id="l21.418" class="difflineplus">+          // Make sure we're logged on before doing the search (assuming we need</span>
<a href="#l21.419"></a><span id="l21.419" class="difflineplus">+          // to be) and make sure the server isn't already in the middle of</span>
<a href="#l21.420"></a><span id="l21.420" class="difflineplus">+          // downloading new messages and make sure a search isn't already going</span>
<a href="#l21.421"></a><span id="l21.421" class="difflineplus">+          // on</span>
<a href="#l21.422"></a><span id="l21.422" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.423"></a><span id="l21.423" class="difflineplus">+                  (&quot;[%d] (search in progress? %s)&quot;, serverIndex,</span>
<a href="#l21.424"></a><span id="l21.424" class="difflineplus">+                   mSearchSession ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.425"></a><span id="l21.425" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.426"></a><span id="l21.426" class="difflineplus">+                  (&quot;[%d] (server busy? %s)&quot;, serverIndex,</span>
<a href="#l21.427"></a><span id="l21.427" class="difflineplus">+                   serverBusy ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.428"></a><span id="l21.428" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.429"></a><span id="l21.429" class="difflineplus">+                  (&quot;[%d] (serverRequiresPassword? %s)&quot;, serverIndex,</span>
<a href="#l21.430"></a><span id="l21.430" class="difflineplus">+                   serverRequiresPassword ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.431"></a><span id="l21.431" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.432"></a><span id="l21.432" class="difflineplus">+                  (&quot;[%d] (passwordPromptRequired? %s)&quot;, serverIndex,</span>
<a href="#l21.433"></a><span id="l21.433" class="difflineplus">+                   passwordPromptRequired ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l21.434"></a><span id="l21.434" class="difflineplus">+          if (canSearchMessages &amp;&amp; !mSearchSession &amp;&amp; !serverBusy &amp;&amp;</span>
<a href="#l21.435"></a><span id="l21.435" class="difflineplus">+              (!serverRequiresPassword || !passwordPromptRequired)) {</span>
<a href="#l21.436"></a><span id="l21.436">             int32_t purgeInterval;</span>
<a href="#l21.437"></a><span id="l21.437">             spamSettings-&gt;GetPurgeInterval(&amp;purgeInterval);</span>
<a href="#l21.438"></a><span id="l21.438"> </span>
<a href="#l21.439"></a><span id="l21.439" class="difflineminus">-            if ((oldestPurgeTime == 0) || (curJunkFolderLastPurgeTime &lt; oldestPurgeTime))</span>
<a href="#l21.440"></a><span id="l21.440" class="difflineminus">-            {</span>
<a href="#l21.441"></a><span id="l21.441" class="difflineminus">-              MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] purging! searching for messages older than %d days&quot;, serverIndex, purgeInterval));</span>
<a href="#l21.442"></a><span id="l21.442" class="difflineplus">+            if ((oldestPurgeTime == 0) ||</span>
<a href="#l21.443"></a><span id="l21.443" class="difflineplus">+                (curJunkFolderLastPurgeTime &lt; oldestPurgeTime)) {</span>
<a href="#l21.444"></a><span id="l21.444" class="difflineplus">+              // clang-format off</span>
<a href="#l21.445"></a><span id="l21.445" class="difflineplus">+              MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.446"></a><span id="l21.446" class="difflineplus">+                      (&quot;[%d] purging! searching for messages older than %d days&quot;,</span>
<a href="#l21.447"></a><span id="l21.447" class="difflineplus">+                       serverIndex, purgeInterval));</span>
<a href="#l21.448"></a><span id="l21.448" class="difflineplus">+              // clang-format on</span>
<a href="#l21.449"></a><span id="l21.449">               oldestPurgeTime = curJunkFolderLastPurgeTime;</span>
<a href="#l21.450"></a><span id="l21.450">               purgeIntervalToUse = purgeInterval;</span>
<a href="#l21.451"></a><span id="l21.451">               folderToPurge = junkFolder;</span>
<a href="#l21.452"></a><span id="l21.452">               // if we've never purged this folder, do it...</span>
<a href="#l21.453"></a><span id="l21.453" class="difflineminus">-              if (curJunkFolderLastPurgeTime == 0)</span>
<a href="#l21.454"></a><span id="l21.454" class="difflineminus">-                break;</span>
<a href="#l21.455"></a><span id="l21.455" class="difflineplus">+              if (curJunkFolderLastPurgeTime == 0) break;</span>
<a href="#l21.456"></a><span id="l21.456">             }</span>
<a href="#l21.457"></a><span id="l21.457" class="difflineplus">+          } else {</span>
<a href="#l21.458"></a><span id="l21.458" class="difflineplus">+            NS_ASSERTION(canSearchMessages,</span>
<a href="#l21.459"></a><span id="l21.459" class="difflineplus">+                         &quot;unexpected, you should be able to search&quot;);</span>
<a href="#l21.460"></a><span id="l21.460" class="difflineplus">+            MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.461"></a><span id="l21.461" class="difflineplus">+                    (&quot;[%d] not a good time for this server, try again later&quot;,</span>
<a href="#l21.462"></a><span id="l21.462" class="difflineplus">+                     serverIndex));</span>
<a href="#l21.463"></a><span id="l21.463">           }</span>
<a href="#l21.464"></a><span id="l21.464" class="difflineminus">-          else {</span>
<a href="#l21.465"></a><span id="l21.465" class="difflineminus">-            NS_ASSERTION(canSearchMessages, &quot;unexpected, you should be able to search&quot;);</span>
<a href="#l21.466"></a><span id="l21.466" class="difflineminus">-            MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] not a good time for this server, try again later&quot;, serverIndex));</span>
<a href="#l21.467"></a><span id="l21.467" class="difflineminus">-          }</span>
<a href="#l21.468"></a><span id="l21.468" class="difflineminus">-        }</span>
<a href="#l21.469"></a><span id="l21.469" class="difflineminus">-        else {</span>
<a href="#l21.470"></a><span id="l21.470" class="difflineminus">-          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] last purge too recent&quot;, serverIndex));</span>
<a href="#l21.471"></a><span id="l21.471" class="difflineplus">+        } else {</span>
<a href="#l21.472"></a><span id="l21.472" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.473"></a><span id="l21.473" class="difflineplus">+                  (&quot;[%d] last purge too recent&quot;, serverIndex));</span>
<a href="#l21.474"></a><span id="l21.474">         }</span>
<a href="#l21.475"></a><span id="l21.475">       }</span>
<a href="#l21.476"></a><span id="l21.476">     }</span>
<a href="#l21.477"></a><span id="l21.477">     if (folderToPurge &amp;&amp; purgeIntervalToUse != 0)</span>
<a href="#l21.478"></a><span id="l21.478">       rv = SearchFolderToPurge(folderToPurge, purgeIntervalToUse);</span>
<a href="#l21.479"></a><span id="l21.479">   }</span>
<a href="#l21.480"></a><span id="l21.480"> </span>
<a href="#l21.481"></a><span id="l21.481">   // set up timer to check accounts again</span>
<a href="#l21.482"></a><span id="l21.482">   SetupNextPurge();</span>
<a href="#l21.483"></a><span id="l21.483">   return rv;</span>
<a href="#l21.484"></a><span id="l21.484"> }</span>
<a href="#l21.485"></a><span id="l21.485"> </span>
<a href="#l21.486"></a><span id="l21.486" class="difflineminus">-nsresult nsMsgPurgeService::SearchFolderToPurge(nsIMsgFolder *folder, int32_t purgeInterval)</span>
<a href="#l21.487"></a><span id="l21.487" class="difflineminus">-{</span>
<a href="#l21.488"></a><span id="l21.488" class="difflineplus">+nsresult nsMsgPurgeService::SearchFolderToPurge(nsIMsgFolder *folder,</span>
<a href="#l21.489"></a><span id="l21.489" class="difflineplus">+                                                int32_t purgeInterval) {</span>
<a href="#l21.490"></a><span id="l21.490">   nsresult rv;</span>
<a href="#l21.491"></a><span id="l21.491">   mSearchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l21.492"></a><span id="l21.492">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.493"></a><span id="l21.493" class="difflineminus">-  mSearchSession-&gt;RegisterListener(this,</span>
<a href="#l21.494"></a><span id="l21.494" class="difflineminus">-                                   nsIMsgSearchSession::allNotifications);</span>
<a href="#l21.495"></a><span id="l21.495" class="difflineplus">+  mSearchSession-&gt;RegisterListener(this, nsIMsgSearchSession::allNotifications);</span>
<a href="#l21.496"></a><span id="l21.496"> </span>
<a href="#l21.497"></a><span id="l21.497">   // update the time we attempted to purge this folder</span>
<a href="#l21.498"></a><span id="l21.498">   char dateBuf[100];</span>
<a href="#l21.499"></a><span id="l21.499">   dateBuf[0] = '\0';</span>
<a href="#l21.500"></a><span id="l21.500">   PRExplodedTime exploded;</span>
<a href="#l21.501"></a><span id="l21.501">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l21.502"></a><span id="l21.502" class="difflineminus">-  PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;exploded);</span>
<a href="#l21.503"></a><span id="l21.503" class="difflineminus">-  folder-&gt;SetStringProperty(&quot;curJunkFolderLastPurgeTime&quot;, nsDependentCString(dateBuf));</span>
<a href="#l21.504"></a><span id="l21.504" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;curJunkFolderLastPurgeTime is now %s&quot;, dateBuf));</span>
<a href="#l21.505"></a><span id="l21.505" class="difflineplus">+  PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l21.506"></a><span id="l21.506" class="difflineplus">+                         &amp;exploded);</span>
<a href="#l21.507"></a><span id="l21.507" class="difflineplus">+  folder-&gt;SetStringProperty(&quot;curJunkFolderLastPurgeTime&quot;,</span>
<a href="#l21.508"></a><span id="l21.508" class="difflineplus">+                            nsDependentCString(dateBuf));</span>
<a href="#l21.509"></a><span id="l21.509" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.510"></a><span id="l21.510" class="difflineplus">+          (&quot;curJunkFolderLastPurgeTime is now %s&quot;, dateBuf));</span>
<a href="#l21.511"></a><span id="l21.511"> </span>
<a href="#l21.512"></a><span id="l21.512">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l21.513"></a><span id="l21.513" class="difflineminus">-  rv = folder-&gt;GetServer(getter_AddRefs(server)); //we need to get the folder's server scope because imap can have local junk folder</span>
<a href="#l21.514"></a><span id="l21.514" class="difflineplus">+  // We need to get the folder's server scope because imap can have</span>
<a href="#l21.515"></a><span id="l21.515" class="difflineplus">+  // local junk folder.</span>
<a href="#l21.516"></a><span id="l21.516" class="difflineplus">+  rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l21.517"></a><span id="l21.517">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.518"></a><span id="l21.518"> </span>
<a href="#l21.519"></a><span id="l21.519">   nsMsgSearchScopeValue searchScope;</span>
<a href="#l21.520"></a><span id="l21.520">   server-&gt;GetSearchScope(&amp;searchScope);</span>
<a href="#l21.521"></a><span id="l21.521"> </span>
<a href="#l21.522"></a><span id="l21.522">   mSearchSession-&gt;AddScopeTerm(searchScope, folder);</span>
<a href="#l21.523"></a><span id="l21.523"> </span>
<a href="#l21.524"></a><span id="l21.524">   // look for messages older than the cutoff</span>
<a href="#l21.525"></a><span id="l21.525">   // you can't also search by junk status, see</span>
<a href="#l21.526"></a><span id="l21.526">   // nsMsgPurgeService::OnSearchHit()</span>
<a href="#l21.527"></a><span id="l21.527" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchTerm&gt; searchTerm;</span>
<a href="#l21.528"></a><span id="l21.528" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchTerm&gt; searchTerm;</span>
<a href="#l21.529"></a><span id="l21.529">   mSearchSession-&gt;CreateTerm(getter_AddRefs(searchTerm));</span>
<a href="#l21.530"></a><span id="l21.530" class="difflineminus">-  if (searchTerm)</span>
<a href="#l21.531"></a><span id="l21.531" class="difflineminus">-  {</span>
<a href="#l21.532"></a><span id="l21.532" class="difflineplus">+  if (searchTerm) {</span>
<a href="#l21.533"></a><span id="l21.533">     searchTerm-&gt;SetAttrib(nsMsgSearchAttrib::AgeInDays);</span>
<a href="#l21.534"></a><span id="l21.534">     searchTerm-&gt;SetOp(nsMsgSearchOp::IsGreaterThan);</span>
<a href="#l21.535"></a><span id="l21.535">     nsCOMPtr&lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l21.536"></a><span id="l21.536">     searchTerm-&gt;GetValue(getter_AddRefs(searchValue));</span>
<a href="#l21.537"></a><span id="l21.537" class="difflineminus">-    if (searchValue)</span>
<a href="#l21.538"></a><span id="l21.538" class="difflineminus">-    {</span>
<a href="#l21.539"></a><span id="l21.539" class="difflineplus">+    if (searchValue) {</span>
<a href="#l21.540"></a><span id="l21.540">       searchValue-&gt;SetAttrib(nsMsgSearchAttrib::AgeInDays);</span>
<a href="#l21.541"></a><span id="l21.541" class="difflineminus">-      searchValue-&gt;SetAge((uint32_t) purgeInterval);</span>
<a href="#l21.542"></a><span id="l21.542" class="difflineplus">+      searchValue-&gt;SetAge((uint32_t)purgeInterval);</span>
<a href="#l21.543"></a><span id="l21.543">       searchTerm-&gt;SetValue(searchValue);</span>
<a href="#l21.544"></a><span id="l21.544">     }</span>
<a href="#l21.545"></a><span id="l21.545">     searchTerm-&gt;SetBooleanAnd(false);</span>
<a href="#l21.546"></a><span id="l21.546">     mSearchSession-&gt;AppendTerm(searchTerm);</span>
<a href="#l21.547"></a><span id="l21.547">   }</span>
<a href="#l21.548"></a><span id="l21.548"> </span>
<a href="#l21.549"></a><span id="l21.549">   // we are about to search</span>
<a href="#l21.550"></a><span id="l21.550">   // create mHdrsToDelete array (if not previously created)</span>
<a href="#l21.551"></a><span id="l21.551" class="difflineminus">-  if (!mHdrsToDelete)</span>
<a href="#l21.552"></a><span id="l21.552" class="difflineminus">-  {</span>
<a href="#l21.553"></a><span id="l21.553" class="difflineplus">+  if (!mHdrsToDelete) {</span>
<a href="#l21.554"></a><span id="l21.554">     mHdrsToDelete = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l21.555"></a><span id="l21.555">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.556"></a><span id="l21.556" class="difflineminus">-  }</span>
<a href="#l21.557"></a><span id="l21.557" class="difflineminus">-  else</span>
<a href="#l21.558"></a><span id="l21.558" class="difflineminus">-  {</span>
<a href="#l21.559"></a><span id="l21.559" class="difflineplus">+  } else {</span>
<a href="#l21.560"></a><span id="l21.560">     uint32_t count;</span>
<a href="#l21.561"></a><span id="l21.561">     mHdrsToDelete-&gt;GetLength(&amp;count);</span>
<a href="#l21.562"></a><span id="l21.562">     NS_ASSERTION(count == 0, &quot;mHdrsToDelete is not empty&quot;);</span>
<a href="#l21.563"></a><span id="l21.563" class="difflineminus">-    if (count &gt; 0)</span>
<a href="#l21.564"></a><span id="l21.564" class="difflineminus">-      mHdrsToDelete-&gt;Clear();  // this shouldn't happen</span>
<a href="#l21.565"></a><span id="l21.565" class="difflineplus">+    if (count &gt; 0) mHdrsToDelete-&gt;Clear();  // this shouldn't happen</span>
<a href="#l21.566"></a><span id="l21.566">   }</span>
<a href="#l21.567"></a><span id="l21.567"> </span>
<a href="#l21.568"></a><span id="l21.568">   mSearchFolder = folder;</span>
<a href="#l21.569"></a><span id="l21.569">   return mSearchSession-&gt;Search(nullptr);</span>
<a href="#l21.570"></a><span id="l21.570"> }</span>
<a href="#l21.571"></a><span id="l21.571"> </span>
<a href="#l21.572"></a><span id="l21.572" class="difflineminus">-NS_IMETHODIMP nsMsgPurgeService::OnNewSearch()</span>
<a href="#l21.573"></a><span id="l21.573" class="difflineminus">-{</span>
<a href="#l21.574"></a><span id="l21.574" class="difflineplus">+NS_IMETHODIMP nsMsgPurgeService::OnNewSearch() {</span>
<a href="#l21.575"></a><span id="l21.575">   MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;on new search&quot;));</span>
<a href="#l21.576"></a><span id="l21.576">   return NS_OK;</span>
<a href="#l21.577"></a><span id="l21.577"> }</span>
<a href="#l21.578"></a><span id="l21.578"> </span>
<a href="#l21.579"></a><span id="l21.579" class="difflineminus">-NS_IMETHODIMP nsMsgPurgeService::OnSearchHit(nsIMsgDBHdr* aMsgHdr, nsIMsgFolder *aFolder)</span>
<a href="#l21.580"></a><span id="l21.580" class="difflineminus">-{</span>
<a href="#l21.581"></a><span id="l21.581" class="difflineplus">+NS_IMETHODIMP nsMsgPurgeService::OnSearchHit(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l21.582"></a><span id="l21.582" class="difflineplus">+                                             nsIMsgFolder *aFolder) {</span>
<a href="#l21.583"></a><span id="l21.583">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l21.584"></a><span id="l21.584"> </span>
<a href="#l21.585"></a><span id="l21.585">   nsCString messageId;</span>
<a href="#l21.586"></a><span id="l21.586">   nsCString author;</span>
<a href="#l21.587"></a><span id="l21.587">   nsCString subject;</span>
<a href="#l21.588"></a><span id="l21.588"> </span>
<a href="#l21.589"></a><span id="l21.589">   aMsgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l21.590"></a><span id="l21.590" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;messageId=%s&quot;, messageId.get()));</span>
<a href="#l21.591"></a><span id="l21.591" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.592"></a><span id="l21.592" class="difflineplus">+          (&quot;messageId=%s&quot;, messageId.get()));</span>
<a href="#l21.593"></a><span id="l21.593">   aMsgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l21.594"></a><span id="l21.594" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;subject=%s&quot;,subject.get()));</span>
<a href="#l21.595"></a><span id="l21.595" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.596"></a><span id="l21.596" class="difflineplus">+          (&quot;subject=%s&quot;, subject.get()));</span>
<a href="#l21.597"></a><span id="l21.597">   aMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l21.598"></a><span id="l21.598" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;author=%s&quot;,author.get()));</span>
<a href="#l21.599"></a><span id="l21.599" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.600"></a><span id="l21.600" class="difflineplus">+          (&quot;author=%s&quot;, author.get()));</span>
<a href="#l21.601"></a><span id="l21.601"> </span>
<a href="#l21.602"></a><span id="l21.602">   // double check that the message is junk before adding to</span>
<a href="#l21.603"></a><span id="l21.603">   // the list of messages to delete</span>
<a href="#l21.604"></a><span id="l21.604">   //</span>
<a href="#l21.605"></a><span id="l21.605">   // note, we can't just search for messages that are junk</span>
<a href="#l21.606"></a><span id="l21.606">   // because not all imap server support keywords</span>
<a href="#l21.607"></a><span id="l21.607">   // (which we use for the junk score)</span>
<a href="#l21.608"></a><span id="l21.608">   // so the junk status would be in the message db.</span>
<a href="#l21.609"></a><span id="l21.609">   //</span>
<a href="#l21.610"></a><span id="l21.610">   // see bug #194090</span>
<a href="#l21.611"></a><span id="l21.611">   nsCString junkScoreStr;</span>
<a href="#l21.612"></a><span id="l21.612" class="difflineminus">-  nsresult rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l21.613"></a><span id="l21.613" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.614"></a><span id="l21.614" class="difflineplus">+  nsresult rv =</span>
<a href="#l21.615"></a><span id="l21.615" class="difflineplus">+      aMsgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l21.616"></a><span id="l21.616" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.617"></a><span id="l21.617"> </span>
<a href="#l21.618"></a><span id="l21.618" class="difflineminus">-  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;junkScore=%s (if empty or != nsIJunkMailPlugin::IS_SPAM_SCORE, don't add to list delete)&quot;, junkScoreStr.get()));</span>
<a href="#l21.619"></a><span id="l21.619" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.620"></a><span id="l21.620" class="difflineplus">+          (&quot;junkScore=%s (if empty or != nsIJunkMailPlugin::IS_SPAM_SCORE, &quot;</span>
<a href="#l21.621"></a><span id="l21.621" class="difflineplus">+           &quot;don't add to list delete)&quot;,</span>
<a href="#l21.622"></a><span id="l21.622" class="difflineplus">+           junkScoreStr.get()));</span>
<a href="#l21.623"></a><span id="l21.623"> </span>
<a href="#l21.624"></a><span id="l21.624">   // if &quot;junkscore&quot; is not set, don't delete the message</span>
<a href="#l21.625"></a><span id="l21.625" class="difflineminus">-  if (junkScoreStr.IsEmpty())</span>
<a href="#l21.626"></a><span id="l21.626" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.627"></a><span id="l21.627" class="difflineplus">+  if (junkScoreStr.IsEmpty()) return NS_OK;</span>
<a href="#l21.628"></a><span id="l21.628"> </span>
<a href="#l21.629"></a><span id="l21.629">   if (atoi(junkScoreStr.get()) == nsIJunkMailPlugin::IS_SPAM_SCORE) {</span>
<a href="#l21.630"></a><span id="l21.630" class="difflineminus">-    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;added message to delete&quot;));</span>
<a href="#l21.631"></a><span id="l21.631" class="difflineplus">+    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.632"></a><span id="l21.632" class="difflineplus">+            (&quot;added message to delete&quot;));</span>
<a href="#l21.633"></a><span id="l21.633">     return mHdrsToDelete-&gt;AppendElement(aMsgHdr);</span>
<a href="#l21.634"></a><span id="l21.634">   }</span>
<a href="#l21.635"></a><span id="l21.635">   return NS_OK;</span>
<a href="#l21.636"></a><span id="l21.636"> }</span>
<a href="#l21.637"></a><span id="l21.637"> </span>
<a href="#l21.638"></a><span id="l21.638" class="difflineminus">-NS_IMETHODIMP nsMsgPurgeService::OnSearchDone(nsresult status)</span>
<a href="#l21.639"></a><span id="l21.639" class="difflineminus">-{</span>
<a href="#l21.640"></a><span id="l21.640" class="difflineminus">-  if (NS_SUCCEEDED(status))</span>
<a href="#l21.641"></a><span id="l21.641" class="difflineminus">-  {</span>
<a href="#l21.642"></a><span id="l21.642" class="difflineplus">+NS_IMETHODIMP nsMsgPurgeService::OnSearchDone(nsresult status) {</span>
<a href="#l21.643"></a><span id="l21.643" class="difflineplus">+  if (NS_SUCCEEDED(status)) {</span>
<a href="#l21.644"></a><span id="l21.644">     uint32_t count = 0;</span>
<a href="#l21.645"></a><span id="l21.645" class="difflineminus">-    if (mHdrsToDelete)</span>
<a href="#l21.646"></a><span id="l21.646" class="difflineminus">-      mHdrsToDelete-&gt;GetLength(&amp;count);</span>
<a href="#l21.647"></a><span id="l21.647" class="difflineminus">-    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;%d messages to delete&quot;, count));</span>
<a href="#l21.648"></a><span id="l21.648" class="difflineplus">+    if (mHdrsToDelete) mHdrsToDelete-&gt;GetLength(&amp;count);</span>
<a href="#l21.649"></a><span id="l21.649" class="difflineplus">+    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l21.650"></a><span id="l21.650" class="difflineplus">+            (&quot;%d messages to delete&quot;, count));</span>
<a href="#l21.651"></a><span id="l21.651"> </span>
<a href="#l21.652"></a><span id="l21.652">     if (count &gt; 0) {</span>
<a href="#l21.653"></a><span id="l21.653">       MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;delete messages&quot;));</span>
<a href="#l21.654"></a><span id="l21.654">       if (mSearchFolder)</span>
<a href="#l21.655"></a><span id="l21.655" class="difflineminus">-        mSearchFolder-&gt;DeleteMessages(mHdrsToDelete, nullptr, false /*delete storage*/, false /*isMove*/, nullptr, false /*allowUndo*/);</span>
<a href="#l21.656"></a><span id="l21.656" class="difflineplus">+        mSearchFolder-&gt;DeleteMessages(</span>
<a href="#l21.657"></a><span id="l21.657" class="difflineplus">+            mHdrsToDelete, nullptr, false /*delete storage*/, false /*isMove*/,</span>
<a href="#l21.658"></a><span id="l21.658" class="difflineplus">+            nullptr, false /*allowUndo*/);</span>
<a href="#l21.659"></a><span id="l21.659">     }</span>
<a href="#l21.660"></a><span id="l21.660">   }</span>
<a href="#l21.661"></a><span id="l21.661" class="difflineminus">-  if (mHdrsToDelete)</span>
<a href="#l21.662"></a><span id="l21.662" class="difflineminus">-    mHdrsToDelete-&gt;Clear();</span>
<a href="#l21.663"></a><span id="l21.663" class="difflineminus">-  if (mSearchSession)</span>
<a href="#l21.664"></a><span id="l21.664" class="difflineminus">-    mSearchSession-&gt;UnregisterListener(this);</span>
<a href="#l21.665"></a><span id="l21.665" class="difflineplus">+  if (mHdrsToDelete) mHdrsToDelete-&gt;Clear();</span>
<a href="#l21.666"></a><span id="l21.666" class="difflineplus">+  if (mSearchSession) mSearchSession-&gt;UnregisterListener(this);</span>
<a href="#l21.667"></a><span id="l21.667">   // don't cache the session</span>
<a href="#l21.668"></a><span id="l21.668" class="difflineminus">-  // just create another search session next time we search, rather than clearing scopes, terms etc.</span>
<a href="#l21.669"></a><span id="l21.669" class="difflineminus">-  // we also use mSearchSession to determine if the purge service is &quot;busy&quot;</span>
<a href="#l21.670"></a><span id="l21.670" class="difflineplus">+  // just create another search session next time we search, rather than</span>
<a href="#l21.671"></a><span id="l21.671" class="difflineplus">+  // clearing scopes, terms etc. we also use mSearchSession to determine if the</span>
<a href="#l21.672"></a><span id="l21.672" class="difflineplus">+  // purge service is &quot;busy&quot;</span>
<a href="#l21.673"></a><span id="l21.673">   mSearchSession = nullptr;</span>
<a href="#l21.674"></a><span id="l21.674">   mSearchFolder = nullptr;</span>
<a href="#l21.675"></a><span id="l21.675">   return NS_OK;</span>
<a href="#l21.676"></a><span id="l21.676"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPurgeService.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPurgeService.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -12,44 +12,41 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsITimer.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;nsIMsgSearchNotify.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsIMsgFolderCache.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-class nsMsgPurgeService</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-  : public nsIMsgPurgeService,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-    public nsIMsgSearchNotify</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-{</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-public:</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+class nsMsgPurgeService : public nsIMsgPurgeService, public nsIMsgSearchNotify {</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+ public:</span>
<a href="#l22.19"></a><span id="l22.19">   nsMsgPurgeService();</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">   NS_DECL_ISUPPORTS</span>
<a href="#l22.22"></a><span id="l22.22">   NS_DECL_NSIMSGPURGESERVICE</span>
<a href="#l22.23"></a><span id="l22.23">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25">   nsresult PerformPurge();</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-protected:</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+ protected:</span>
<a href="#l22.29"></a><span id="l22.29">   virtual ~nsMsgPurgeService();</span>
<a href="#l22.30"></a><span id="l22.30">   int32_t FindServer(nsIMsgIncomingServer *server);</span>
<a href="#l22.31"></a><span id="l22.31">   nsresult SetupNextPurge();</span>
<a href="#l22.32"></a><span id="l22.32">   nsresult PurgeSurver(nsIMsgIncomingServer *server);</span>
<a href="#l22.33"></a><span id="l22.33">   nsresult SearchFolderToPurge(nsIMsgFolder *folder, int32_t purgeInterval);</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-protected:</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+ protected:</span>
<a href="#l22.37"></a><span id="l22.37">   nsCOMPtr&lt;nsITimer&gt; mPurgeTimer;</span>
<a href="#l22.38"></a><span id="l22.38">   nsCOMPtr&lt;nsIMsgSearchSession&gt; mSearchSession;</span>
<a href="#l22.39"></a><span id="l22.39">   nsCOMPtr&lt;nsIMsgFolder&gt; mSearchFolder;</span>
<a href="#l22.40"></a><span id="l22.40">   nsCOMPtr&lt;nsIMutableArray&gt; mHdrsToDelete;</span>
<a href="#l22.41"></a><span id="l22.41">   bool mHaveShutdown;</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-private:</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-  int32_t mMinDelayBetweenPurges;  // in minutes, how long must pass between two consecutive purges on the same junk folder?</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-  int32_t mPurgeTimerInterval;  // in minutes, how often to check if we need to purge one of the junk folders?</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+ private:</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+  // in minutes, how long must pass between two consecutive purges on the</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+  // same junk folder?</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+  int32_t mMinDelayBetweenPurges;</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  // in minutes, how often to check if we need to purge one of the junk folders?</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+  int32_t mPurgeTimerInterval;</span>
<a href="#l22.52"></a><span id="l22.52"> };</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-</span>
<a href="#l22.56"></a><span id="l22.56"> #endif</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -12,867 +12,802 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-nsMsgQuickSearchDBView::nsMsgQuickSearchDBView()</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-{</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+nsMsgQuickSearchDBView::nsMsgQuickSearchDBView() {</span>
<a href="#l23.15"></a><span id="l23.15">   m_usingCachedHits = false;</span>
<a href="#l23.16"></a><span id="l23.16">   m_cacheEmpty = true;</span>
<a href="#l23.17"></a><span id="l23.17"> }</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-nsMsgQuickSearchDBView::~nsMsgQuickSearchDBView()</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-{</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-}</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+nsMsgQuickSearchDBView::~nsMsgQuickSearchDBView() {}</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsMsgQuickSearchDBView, nsMsgDBView, nsIMsgDBView,</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+                            nsIMsgSearchNotify)</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsMsgQuickSearchDBView, nsMsgDBView, nsIMsgDBView, nsIMsgSearchNotify)</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-NS_IMETHODIMP nsMsgQuickSearchDBView::Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount)</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-{</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  nsresult rv = nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+                                           nsMsgViewSortTypeValue sortType,</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+                                           nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+                                           nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+                                           int32_t *pCount) {</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+  nsresult rv =</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+      nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l23.39"></a><span id="l23.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.40"></a><span id="l23.40"> </span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-  if (!m_db)</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-  if (pCount)</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-    *pCount = 0;</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+  if (!m_db) return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+  if (pCount) *pCount = 0;</span>
<a href="#l23.47"></a><span id="l23.47">   m_viewFolder = nullptr;</span>
<a href="#l23.48"></a><span id="l23.48">   return InitThreadedView(pCount);</span>
<a href="#l23.49"></a><span id="l23.49"> }</span>
<a href="#l23.50"></a><span id="l23.50"> </span>
<a href="#l23.51"></a><span id="l23.51"> NS_IMETHODIMP</span>
<a href="#l23.52"></a><span id="l23.52"> nsMsgQuickSearchDBView::CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l23.53"></a><span id="l23.53">                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.54"></a><span id="l23.54">                                     nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-                                    nsIMsgDBView **_retval)</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-{</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-  nsMsgQuickSearchDBView* newMsgDBView = new nsMsgQuickSearchDBView();</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-  nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+                                    nsIMsgDBView **_retval) {</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+  nsMsgQuickSearchDBView *newMsgDBView = new nsMsgQuickSearchDBView();</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+  nsresult rv =</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+      CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l23.63"></a><span id="l23.63">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.64"></a><span id="l23.64"> </span>
<a href="#l23.65"></a><span id="l23.65">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l23.66"></a><span id="l23.66">   return NS_OK;</span>
<a href="#l23.67"></a><span id="l23.67"> }</span>
<a href="#l23.68"></a><span id="l23.68"> </span>
<a href="#l23.69"></a><span id="l23.69"> NS_IMETHODIMP</span>
<a href="#l23.70"></a><span id="l23.70"> nsMsgQuickSearchDBView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l23.71"></a><span id="l23.71">                                    nsIMessenger *aMessengerInstance,</span>
<a href="#l23.72"></a><span id="l23.72">                                    nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-                                   nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-{</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-  nsMsgThreadedDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-  nsMsgQuickSearchDBView* newMsgDBView = (nsMsgQuickSearchDBView *) aNewMsgDBView;</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+                                   nsIMsgDBViewCommandUpdater *aCmdUpdater) {</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+  nsMsgThreadedDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow,</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+                                  aCmdUpdater);</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+  nsMsgQuickSearchDBView *newMsgDBView =</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+      (nsMsgQuickSearchDBView *)aNewMsgDBView;</span>
<a href="#l23.82"></a><span id="l23.82"> </span>
<a href="#l23.83"></a><span id="l23.83">   // now copy all of our private member data</span>
<a href="#l23.84"></a><span id="l23.84">   newMsgDBView-&gt;m_origKeys = m_origKeys;</span>
<a href="#l23.85"></a><span id="l23.85">   return NS_OK;</span>
<a href="#l23.86"></a><span id="l23.86"> }</span>
<a href="#l23.87"></a><span id="l23.87"> </span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-nsresult nsMsgQuickSearchDBView::DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices, bool deleteStorage)</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-{</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-  for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex) numIndices; i++)</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-  {</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+nsresult nsMsgQuickSearchDBView::DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+                                                nsMsgViewIndex *indices,</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+                                                int32_t numIndices,</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+                                                bool deleteStorage) {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+  for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex)numIndices; i++) {</span>
<a href="#l23.97"></a><span id="l23.97">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-    (void) GetMsgHdrForViewIndex(indices[i],getter_AddRefs(msgHdr));</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-    if (msgHdr)</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-      RememberDeletedMsgHdr(msgHdr);</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+    (void)GetMsgHdrForViewIndex(indices[i], getter_AddRefs(msgHdr));</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+    if (msgHdr) RememberDeletedMsgHdr(msgHdr);</span>
<a href="#l23.103"></a><span id="l23.103">   }</span>
<a href="#l23.104"></a><span id="l23.104"> </span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-  return nsMsgDBView::DeleteMessages(window, indices, numIndices, deleteStorage);</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+  return nsMsgDBView::DeleteMessages(window, indices, numIndices,</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+                                     deleteStorage);</span>
<a href="#l23.108"></a><span id="l23.108"> }</span>
<a href="#l23.109"></a><span id="l23.109"> </span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-NS_IMETHODIMP nsMsgQuickSearchDBView::DoCommand(nsMsgViewCommandTypeValue aCommand)</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-{</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-  if (aCommand == nsMsgViewCommandType::markAllRead)</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-  {</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::DoCommand(</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+    nsMsgViewCommandTypeValue aCommand) {</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+  if (aCommand == nsMsgViewCommandType::markAllRead) {</span>
<a href="#l23.117"></a><span id="l23.117">     nsresult rv = NS_OK;</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications,</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+                                  false);</span>
<a href="#l23.121"></a><span id="l23.121"> </span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-    for (uint32_t i = 0; NS_SUCCEEDED(rv) &amp;&amp; i &lt; GetSize(); i++)</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-    {</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+    for (uint32_t i = 0; NS_SUCCEEDED(rv) &amp;&amp; i &lt; GetSize(); i++) {</span>
<a href="#l23.125"></a><span id="l23.125">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-      m_db-&gt;GetMsgHdrForKey(m_keys[i],getter_AddRefs(msgHdr));</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineplus">+      m_db-&gt;GetMsgHdrForKey(m_keys[i], getter_AddRefs(msgHdr));</span>
<a href="#l23.128"></a><span id="l23.128">       rv = m_db-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l23.129"></a><span id="l23.129">     }</span>
<a href="#l23.130"></a><span id="l23.130"> </span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications,</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+                                  true);</span>
<a href="#l23.134"></a><span id="l23.134"> </span>
<a href="#l23.135"></a><span id="l23.135">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l23.136"></a><span id="l23.136">     if (NS_SUCCEEDED(rv) &amp;&amp; imapFolder)</span>
<a href="#l23.137"></a><span id="l23.137">       rv = imapFolder-&gt;StoreImapFlags(kImapMsgSeenFlag, true, m_keys.Elements(),</span>
<a href="#l23.138"></a><span id="l23.138">                                       m_keys.Length(), nullptr);</span>
<a href="#l23.139"></a><span id="l23.139"> </span>
<a href="#l23.140"></a><span id="l23.140">     m_db-&gt;SetSummaryValid(true);</span>
<a href="#l23.141"></a><span id="l23.141">     return rv;</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-  }</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-  else</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+  } else</span>
<a href="#l23.145"></a><span id="l23.145">     return nsMsgDBView::DoCommand(aCommand);</span>
<a href="#l23.146"></a><span id="l23.146"> }</span>
<a href="#l23.147"></a><span id="l23.147"> </span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-NS_IMETHODIMP nsMsgQuickSearchDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-{</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-    *aViewType = nsMsgViewType::eShowQuickSearchResults;</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::GetViewType(</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+    nsMsgViewTypeValue *aViewType) {</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+  *aViewType = nsMsgViewType::eShowQuickSearchResults;</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.158"></a><span id="l23.158"> }</span>
<a href="#l23.159"></a><span id="l23.159"> </span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-nsresult nsMsgQuickSearchDBView::AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex)</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-{</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+nsresult nsMsgQuickSearchDBView::AddHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+                                        nsMsgViewIndex *resultIndex) {</span>
<a href="#l23.164"></a><span id="l23.164">   nsMsgKey msgKey;</span>
<a href="#l23.165"></a><span id="l23.165">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.166"></a><span id="l23.166">   // protect against duplication.</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-  if (m_origKeys.BinaryIndexOf(msgKey) == m_origKeys.NoIndex)</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-  {</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-    nsMsgViewIndex insertIndex = GetInsertIndexHelper(msgHdr, m_origKeys, nullptr,</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-                    nsMsgViewSortOrder::ascending, nsMsgViewSortType::byId);</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+  if (m_origKeys.BinaryIndexOf(msgKey) == m_origKeys.NoIndex) {</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineplus">+    nsMsgViewIndex insertIndex = GetInsertIndexHelper(</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineplus">+        msgHdr, m_origKeys, nullptr, nsMsgViewSortOrder::ascending,</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineplus">+        nsMsgViewSortType::byId);</span>
<a href="#l23.175"></a><span id="l23.175">     m_origKeys.InsertElementAt(insertIndex, msgKey);</span>
<a href="#l23.176"></a><span id="l23.176">   }</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-  if (m_viewFlags &amp; (nsMsgViewFlagsType::kGroupBySort|</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-                     nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-  {</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineplus">+  if (m_viewFlags &amp; (nsMsgViewFlagsType::kGroupBySort |</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineplus">+                     nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l23.182"></a><span id="l23.182">     nsMsgKey parentKey;</span>
<a href="#l23.183"></a><span id="l23.183">     msgHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l23.184"></a><span id="l23.184">     return nsMsgThreadedDBView::OnNewHeader(msgHdr, parentKey, true);</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-  }</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-  else</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineplus">+  } else</span>
<a href="#l23.188"></a><span id="l23.188">     return nsMsgDBView::AddHdr(msgHdr, resultIndex);</span>
<a href="#l23.189"></a><span id="l23.189"> }</span>
<a href="#l23.190"></a><span id="l23.190"> </span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-nsresult nsMsgQuickSearchDBView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool ensureListed)</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-{</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-  if (newHdr)</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-  {</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-    bool match=false;</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-    nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession = do_QueryReferent(m_searchSession);</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineminus">-    if (searchSession)</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-      searchSession-&gt;MatchHdr(newHdr, m_db, &amp;match);</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-    if (match)</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-    {</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineplus">+nsresult nsMsgQuickSearchDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineplus">+                                             nsMsgKey aParentKey,</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineplus">+                                             bool ensureListed) {</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineplus">+  if (newHdr) {</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineplus">+    bool match = false;</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineplus">+    nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineplus">+        do_QueryReferent(m_searchSession);</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineplus">+    if (searchSession) searchSession-&gt;MatchHdr(newHdr, m_db, &amp;match);</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+    if (match) {</span>
<a href="#l23.210"></a><span id="l23.210">       // put the new header in m_origKeys, so that expanding a thread will</span>
<a href="#l23.211"></a><span id="l23.211">       // show the newly added header.</span>
<a href="#l23.212"></a><span id="l23.212">       nsMsgKey newKey;</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineminus">-      (void) newHdr-&gt;GetMessageKey(&amp;newKey);</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineminus">-      nsMsgViewIndex insertIndex = GetInsertIndexHelper(newHdr, m_origKeys, nullptr,</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-                      nsMsgViewSortOrder::ascending, nsMsgViewSortType::byId);</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineplus">+      (void)newHdr-&gt;GetMessageKey(&amp;newKey);</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineplus">+      nsMsgViewIndex insertIndex = GetInsertIndexHelper(</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+          newHdr, m_origKeys, nullptr, nsMsgViewSortOrder::ascending,</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineplus">+          nsMsgViewSortType::byId);</span>
<a href="#l23.220"></a><span id="l23.220">       m_origKeys.InsertElementAt(insertIndex, newKey);</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-      nsMsgThreadedDBView::OnNewHeader(newHdr, aParentKey, ensureListed); // do not add a new message if there isn't a match.</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineplus">+      nsMsgThreadedDBView::OnNewHeader(</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+          newHdr, aParentKey,</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineplus">+          ensureListed);  // do not add a new message if there isn't a match.</span>
<a href="#l23.225"></a><span id="l23.225">     }</span>
<a href="#l23.226"></a><span id="l23.226">   }</span>
<a href="#l23.227"></a><span id="l23.227">   return NS_OK;</span>
<a href="#l23.228"></a><span id="l23.228"> }</span>
<a href="#l23.229"></a><span id="l23.229"> </span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-NS_IMETHODIMP nsMsgQuickSearchDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-                                       uint32_t aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-{</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineminus">-  nsresult rv = nsMsgGroupView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator);</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::OnHdrFlagsChanged(</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags,</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineplus">+  nsresult rv = nsMsgGroupView::OnHdrFlagsChanged(aHdrChanged, aOldFlags,</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+                                                  aNewFlags, aInstigator);</span>
<a href="#l23.239"></a><span id="l23.239"> </span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-  if (m_viewFolder &amp;&amp;</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-      (m_viewFolder != m_folder) &amp;&amp;</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-      (aOldFlags &amp; nsMsgMessageFlags::Read) != (aNewFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-  {</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+  if (m_viewFolder &amp;&amp; (m_viewFolder != m_folder) &amp;&amp;</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+      (aOldFlags &amp; nsMsgMessageFlags::Read) !=</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineplus">+          (aNewFlags &amp; nsMsgMessageFlags::Read)) {</span>
<a href="#l23.247"></a><span id="l23.247">     // if we're displaying a single folder virtual folder for an imap folder,</span>
<a href="#l23.248"></a><span id="l23.248">     // the search criteria might be on message body, and we might not have the</span>
<a href="#l23.249"></a><span id="l23.249">     // message body offline, in which case we can't tell if the message</span>
<a href="#l23.250"></a><span id="l23.250">     // matched or not. But if the unread flag changed, we need to update the</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-    // unread counts. Normally, VirtualFolderChangeListener::OnHdrFlagsChanged will</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-    // handle this, but it won't work for body criteria when we don't have the</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-    // body offline.</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineplus">+    // unread counts. Normally, VirtualFolderChangeListener::OnHdrFlagsChanged</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineplus">+    // will handle this, but it won't work for body criteria when we don't have</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineplus">+    // the body offline.</span>
<a href="#l23.257"></a><span id="l23.257">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_viewFolder);</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineminus">-    if (imapFolder)</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-    {</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineplus">+    if (imapFolder) {</span>
<a href="#l23.261"></a><span id="l23.261">       nsMsgViewIndex hdrIndex = FindHdr(aHdrChanged);</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-      if (hdrIndex != nsMsgViewIndex_None)</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineminus">-      {</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineminus">-        nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession = do_QueryReferent(m_searchSession);</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-        if (searchSession)</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineminus">-        {</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineplus">+      if (hdrIndex != nsMsgViewIndex_None) {</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineplus">+        nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineplus">+            do_QueryReferent(m_searchSession);</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineplus">+        if (searchSession) {</span>
<a href="#l23.271"></a><span id="l23.271">           bool oldMatch, newMatch;</span>
<a href="#l23.272"></a><span id="l23.272">           rv = searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;newMatch);</span>
<a href="#l23.273"></a><span id="l23.273">           aHdrChanged-&gt;SetFlags(aOldFlags);</span>
<a href="#l23.274"></a><span id="l23.274">           rv = searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;oldMatch);</span>
<a href="#l23.275"></a><span id="l23.275">           aHdrChanged-&gt;SetFlags(aNewFlags);</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineminus">-          // if it doesn't match the criteria, VirtualFolderChangeListener::OnHdrFlagsChanged</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineminus">-          // won't tweak the read/unread counts. So do it here:</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineminus">-          if (!oldMatch &amp;&amp; !newMatch)</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineminus">-          {</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineminus">-            nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineminus">-            nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineplus">+          // if it doesn't match the criteria,</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineplus">+          // VirtualFolderChangeListener::OnHdrFlagsChanged won't tweak the</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineplus">+          // read/unread counts. So do it here:</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineplus">+          if (!oldMatch &amp;&amp; !newMatch) {</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineplus">+            nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l23.288"></a><span id="l23.288"> </span>
<a href="#l23.289"></a><span id="l23.289" class="difflineminus">-            rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineplus">+            rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineplus">+                getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l23.292"></a><span id="l23.292">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineminus">-            dbFolderInfo-&gt;ChangeNumUnreadMessages((aOldFlags &amp; nsMsgMessageFlags::Read) ? 1 : -1);</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineminus">-            m_viewFolder-&gt;UpdateSummaryTotals(true); // force update from db.</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineplus">+            dbFolderInfo-&gt;ChangeNumUnreadMessages(</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineplus">+                (aOldFlags &amp; nsMsgMessageFlags::Read) ? 1 : -1);</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineplus">+            m_viewFolder-&gt;UpdateSummaryTotals(true);  // force update from db.</span>
<a href="#l23.298"></a><span id="l23.298">             virtDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l23.299"></a><span id="l23.299">           }</span>
<a href="#l23.300"></a><span id="l23.300">         }</span>
<a href="#l23.301"></a><span id="l23.301">       }</span>
<a href="#l23.302"></a><span id="l23.302">     }</span>
<a href="#l23.303"></a><span id="l23.303">   }</span>
<a href="#l23.304"></a><span id="l23.304">   return rv;</span>
<a href="#l23.305"></a><span id="l23.305"> }</span>
<a href="#l23.306"></a><span id="l23.306"> </span>
<a href="#l23.307"></a><span id="l23.307"> NS_IMETHODIMP</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineminus">-nsMsgQuickSearchDBView::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrChanged, bool aPreChange,</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">-                                        uint32_t *aStatus, nsIDBChangeListener *aInstigator)</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineminus">-{</span>
<a href="#l23.311"></a><span id="l23.311" class="difflineplus">+nsMsgQuickSearchDBView::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineplus">+                                             bool aPreChange, uint32_t *aStatus,</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineplus">+                                             nsIDBChangeListener *aInstigator) {</span>
<a href="#l23.314"></a><span id="l23.314">   // If the junk mail plugin just activated on a message, then</span>
<a href="#l23.315"></a><span id="l23.315">   // we'll allow filters to remove from view.</span>
<a href="#l23.316"></a><span id="l23.316">   // Otherwise, just update the view line.</span>
<a href="#l23.317"></a><span id="l23.317">   //</span>
<a href="#l23.318"></a><span id="l23.318">   // Note this will not add newly matched headers to the view. This is</span>
<a href="#l23.319"></a><span id="l23.319">   // probably a bug that needs fixing.</span>
<a href="#l23.320"></a><span id="l23.320"> </span>
<a href="#l23.321"></a><span id="l23.321">   NS_ENSURE_ARG_POINTER(aStatus);</span>
<a href="#l23.322"></a><span id="l23.322">   NS_ENSURE_ARG_POINTER(aHdrChanged);</span>
<a href="#l23.323"></a><span id="l23.323"> </span>
<a href="#l23.324"></a><span id="l23.324">   nsMsgViewIndex index = FindHdr(aHdrChanged);</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineminus">-  if (index == nsMsgViewIndex_None) // message does not appear in view</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineplus">+  if (index == nsMsgViewIndex_None)  // message does not appear in view</span>
<a href="#l23.327"></a><span id="l23.327">     return NS_OK;</span>
<a href="#l23.328"></a><span id="l23.328"> </span>
<a href="#l23.329"></a><span id="l23.329">   nsCString originStr;</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineminus">-  (void) aHdrChanged-&gt;GetStringProperty(&quot;junkscoreorigin&quot;, getter_Copies(originStr));</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineplus">+  (void)aHdrChanged-&gt;GetStringProperty(&quot;junkscoreorigin&quot;,</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineplus">+                                       getter_Copies(originStr));</span>
<a href="#l23.333"></a><span id="l23.333">   // check for &quot;plugin&quot; with only first character for performance</span>
<a href="#l23.334"></a><span id="l23.334">   bool plugin = (originStr.get()[0] == 'p');</span>
<a href="#l23.335"></a><span id="l23.335"> </span>
<a href="#l23.336"></a><span id="l23.336" class="difflineminus">-  if (aPreChange)</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineminus">-  {</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineplus">+  if (aPreChange) {</span>
<a href="#l23.339"></a><span id="l23.339">     // first call, done prior to the change</span>
<a href="#l23.340"></a><span id="l23.340">     *aStatus = plugin;</span>
<a href="#l23.341"></a><span id="l23.341">     return NS_OK;</span>
<a href="#l23.342"></a><span id="l23.342">   }</span>
<a href="#l23.343"></a><span id="l23.343"> </span>
<a href="#l23.344"></a><span id="l23.344">   // second call, done after the change</span>
<a href="#l23.345"></a><span id="l23.345">   bool wasPlugin = *aStatus;</span>
<a href="#l23.346"></a><span id="l23.346"> </span>
<a href="#l23.347"></a><span id="l23.347">   bool match = true;</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession(do_QueryReferent(m_searchSession));</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineminus">-  if (searchSession)</span>
<a href="#l23.350"></a><span id="l23.350" class="difflineminus">-    searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;match);</span>
<a href="#l23.351"></a><span id="l23.351" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession(</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineplus">+      do_QueryReferent(m_searchSession));</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineplus">+  if (searchSession) searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;match);</span>
<a href="#l23.354"></a><span id="l23.354"> </span>
<a href="#l23.355"></a><span id="l23.355">   if (!match &amp;&amp; plugin &amp;&amp; !wasPlugin)</span>
<a href="#l23.356"></a><span id="l23.356" class="difflineminus">-    RemoveByIndex(index); // remove hdr from view</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineplus">+    RemoveByIndex(index);  // remove hdr from view</span>
<a href="#l23.358"></a><span id="l23.358">   else</span>
<a href="#l23.359"></a><span id="l23.359">     NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l23.360"></a><span id="l23.360"> </span>
<a href="#l23.361"></a><span id="l23.361">   return NS_OK;</span>
<a href="#l23.362"></a><span id="l23.362"> }</span>
<a href="#l23.363"></a><span id="l23.363"> </span>
<a href="#l23.364"></a><span id="l23.364"> NS_IMETHODIMP</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineminus">-nsMsgQuickSearchDBView::GetSearchSession(nsIMsgSearchSession* *aSession)</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineminus">-{</span>
<a href="#l23.367"></a><span id="l23.367" class="difflineplus">+nsMsgQuickSearchDBView::GetSearchSession(nsIMsgSearchSession **aSession) {</span>
<a href="#l23.368"></a><span id="l23.368">   NS_ASSERTION(false, &quot;GetSearchSession method is not implemented&quot;);</span>
<a href="#l23.369"></a><span id="l23.369">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l23.370"></a><span id="l23.370"> }</span>
<a href="#l23.371"></a><span id="l23.371"> </span>
<a href="#l23.372"></a><span id="l23.372" class="difflineminus">-</span>
<a href="#l23.373"></a><span id="l23.373"> NS_IMETHODIMP</span>
<a href="#l23.374"></a><span id="l23.374" class="difflineminus">-nsMsgQuickSearchDBView::SetSearchSession(nsIMsgSearchSession *aSession)</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineminus">-{</span>
<a href="#l23.376"></a><span id="l23.376" class="difflineplus">+nsMsgQuickSearchDBView::SetSearchSession(nsIMsgSearchSession *aSession) {</span>
<a href="#l23.377"></a><span id="l23.377">   m_searchSession = do_GetWeakReference(aSession);</span>
<a href="#l23.378"></a><span id="l23.378">   return NS_OK;</span>
<a href="#l23.379"></a><span id="l23.379"> }</span>
<a href="#l23.380"></a><span id="l23.380"> </span>
<a href="#l23.381"></a><span id="l23.381"> NS_IMETHODIMP</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineminus">-nsMsgQuickSearchDBView::OnSearchHit(nsIMsgDBHdr* aMsgHdr, nsIMsgFolder *folder)</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineminus">-{</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineplus">+nsMsgQuickSearchDBView::OnSearchHit(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineplus">+                                    nsIMsgFolder *folder) {</span>
<a href="#l23.386"></a><span id="l23.386">   NS_ENSURE_ARG(aMsgHdr);</span>
<a href="#l23.387"></a><span id="l23.387" class="difflineminus">-  if (!m_db)</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineplus">+  if (!m_db) return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.390"></a><span id="l23.390">   // remember search hit and when search is done, reconcile cache</span>
<a href="#l23.391"></a><span id="l23.391">   // with new hits;</span>
<a href="#l23.392"></a><span id="l23.392">   m_hdrHits.AppendObject(aMsgHdr);</span>
<a href="#l23.393"></a><span id="l23.393">   nsMsgKey key;</span>
<a href="#l23.394"></a><span id="l23.394">   aMsgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l23.395"></a><span id="l23.395">   // Is FindKey going to be expensive here? A lot of hits could make</span>
<a href="#l23.396"></a><span id="l23.396">   // it a little bit slow to search through the view for every hit.</span>
<a href="#l23.397"></a><span id="l23.397">   if (m_cacheEmpty || FindKey(key, false) == nsMsgViewIndex_None)</span>
<a href="#l23.398"></a><span id="l23.398">     return AddHdr(aMsgHdr);</span>
<a href="#l23.399"></a><span id="l23.399">   else</span>
<a href="#l23.400"></a><span id="l23.400">     return NS_OK;</span>
<a href="#l23.401"></a><span id="l23.401"> }</span>
<a href="#l23.402"></a><span id="l23.402"> </span>
<a href="#l23.403"></a><span id="l23.403"> NS_IMETHODIMP</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineminus">-nsMsgQuickSearchDBView::OnSearchDone(nsresult status)</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineminus">-{</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineplus">+nsMsgQuickSearchDBView::OnSearchDone(nsresult status) {</span>
<a href="#l23.407"></a><span id="l23.407">   // We're a single-folder virtual folder if viewFolder != folder, and that is</span>
<a href="#l23.408"></a><span id="l23.408">   // the only case in which we want to be messing about with a results cache</span>
<a href="#l23.409"></a><span id="l23.409">   // or unread counts.</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineminus">-  if (m_db &amp;&amp; m_viewFolder &amp;&amp; m_viewFolder != m_folder)</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineminus">-  {</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineplus">+  if (m_db &amp;&amp; m_viewFolder &amp;&amp; m_viewFolder != m_folder) {</span>
<a href="#l23.413"></a><span id="l23.413">     nsTArray&lt;nsMsgKey&gt; keyArray;</span>
<a href="#l23.414"></a><span id="l23.414">     nsCString searchUri;</span>
<a href="#l23.415"></a><span id="l23.415">     m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l23.416"></a><span id="l23.416">     uint32_t count = m_hdrHits.Count();</span>
<a href="#l23.417"></a><span id="l23.417">     // Build up message keys. The hits are in descending order but the cache</span>
<a href="#l23.418"></a><span id="l23.418">     // expects them to be in ascending key order.</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineminus">-    for (uint32_t i = count; i &gt; 0; i--)</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineminus">-    {</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineplus">+    for (uint32_t i = count; i &gt; 0; i--) {</span>
<a href="#l23.422"></a><span id="l23.422">       nsMsgKey key;</span>
<a href="#l23.423"></a><span id="l23.423" class="difflineminus">-      m_hdrHits[i-1]-&gt;GetMessageKey(&amp;key);</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineplus">+      m_hdrHits[i - 1]-&gt;GetMessageKey(&amp;key);</span>
<a href="#l23.425"></a><span id="l23.425">       keyArray.AppendElement(key);</span>
<a href="#l23.426"></a><span id="l23.426">     }</span>
<a href="#l23.427"></a><span id="l23.427">     nsMsgKey *staleHits;</span>
<a href="#l23.428"></a><span id="l23.428">     uint32_t numBadHits;</span>
<a href="#l23.429"></a><span id="l23.429" class="difflineminus">-    if (m_db)</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineminus">-    {</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-      nsresult rv = m_db-&gt;RefreshCache(searchUri.get(), m_hdrHits.Count(),</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineminus">-                                       keyArray.Elements(), &amp;numBadHits, &amp;staleHits);</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineplus">+    if (m_db) {</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineplus">+      nsresult rv =</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineplus">+          m_db-&gt;RefreshCache(searchUri.get(), m_hdrHits.Count(),</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineplus">+                             keyArray.Elements(), &amp;numBadHits, &amp;staleHits);</span>
<a href="#l23.437"></a><span id="l23.437">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.438"></a><span id="l23.438">       nsCOMPtr&lt;nsIMsgDBHdr&gt; hdrDeleted;</span>
<a href="#l23.439"></a><span id="l23.439"> </span>
<a href="#l23.440"></a><span id="l23.440" class="difflineminus">-      for (uint32_t i = 0; i &lt; numBadHits; i++)</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineminus">-      {</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineplus">+      for (uint32_t i = 0; i &lt; numBadHits; i++) {</span>
<a href="#l23.443"></a><span id="l23.443">         m_db-&gt;GetMsgHdrForKey(staleHits[i], getter_AddRefs(hdrDeleted));</span>
<a href="#l23.444"></a><span id="l23.444" class="difflineminus">-        if (hdrDeleted)</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineminus">-          OnHdrDeleted(hdrDeleted, nsMsgKey_None, 0, this);</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineplus">+        if (hdrDeleted) OnHdrDeleted(hdrDeleted, nsMsgKey_None, 0, this);</span>
<a href="#l23.447"></a><span id="l23.447">       }</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineminus">-      delete [] staleHits;</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineplus">+      delete[] staleHits;</span>
<a href="#l23.450"></a><span id="l23.450">     }</span>
<a href="#l23.451"></a><span id="l23.451">     nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l23.452"></a><span id="l23.452">     nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineminus">-    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineplus">+    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineplus">+        getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l23.456"></a><span id="l23.456">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.457"></a><span id="l23.457">     uint32_t numUnread = 0;</span>
<a href="#l23.458"></a><span id="l23.458">     size_t numTotal = m_origKeys.Length();</span>
<a href="#l23.459"></a><span id="l23.459"> </span>
<a href="#l23.460"></a><span id="l23.460" class="difflineminus">-    for (size_t i = 0; i &lt; m_origKeys.Length(); i++)</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineminus">-    {</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineplus">+    for (size_t i = 0; i &lt; m_origKeys.Length(); i++) {</span>
<a href="#l23.463"></a><span id="l23.463">       bool isRead;</span>
<a href="#l23.464"></a><span id="l23.464">       m_db-&gt;IsRead(m_origKeys[i], &amp;isRead);</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineminus">-      if (!isRead)</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineminus">-        numUnread++;</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineplus">+      if (!isRead) numUnread++;</span>
<a href="#l23.468"></a><span id="l23.468">     }</span>
<a href="#l23.469"></a><span id="l23.469">     dbFolderInfo-&gt;SetNumUnreadMessages(numUnread);</span>
<a href="#l23.470"></a><span id="l23.470">     dbFolderInfo-&gt;SetNumMessages(numTotal);</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineminus">-    m_viewFolder-&gt;UpdateSummaryTotals(true); // force update from db.</span>
<a href="#l23.472"></a><span id="l23.472" class="difflineplus">+    m_viewFolder-&gt;UpdateSummaryTotals(true);  // force update from db.</span>
<a href="#l23.473"></a><span id="l23.473">     virtDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l23.474"></a><span id="l23.474">   }</span>
<a href="#l23.475"></a><span id="l23.475" class="difflineminus">-  if (m_sortType != nsMsgViewSortType::byThread)//we do not find levels for the results.</span>
<a href="#l23.476"></a><span id="l23.476" class="difflineplus">+  if (m_sortType !=</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineplus">+      nsMsgViewSortType::byThread)  // we do not find levels for the results.</span>
<a href="#l23.478"></a><span id="l23.478">   {</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineminus">-    m_sortValid = false;       //sort the results</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineplus">+    m_sortValid = false;  // sort the results</span>
<a href="#l23.481"></a><span id="l23.481">     Sort(m_sortType, m_sortOrder);</span>
<a href="#l23.482"></a><span id="l23.482">   }</span>
<a href="#l23.483"></a><span id="l23.483">   if (m_viewFolder &amp;&amp; (m_viewFolder != m_folder))</span>
<a href="#l23.484"></a><span id="l23.484">     SetMRUTimeForFolder(m_viewFolder);</span>
<a href="#l23.485"></a><span id="l23.485"> </span>
<a href="#l23.486"></a><span id="l23.486">   return NS_OK;</span>
<a href="#l23.487"></a><span id="l23.487"> }</span>
<a href="#l23.488"></a><span id="l23.488"> </span>
<a href="#l23.489"></a><span id="l23.489" class="difflineminus">-</span>
<a href="#l23.490"></a><span id="l23.490"> NS_IMETHODIMP</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineminus">-nsMsgQuickSearchDBView::OnNewSearch()</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineminus">-{</span>
<a href="#l23.493"></a><span id="l23.493" class="difflineplus">+nsMsgQuickSearchDBView::OnNewSearch() {</span>
<a href="#l23.494"></a><span id="l23.494">   int32_t oldSize = GetSize();</span>
<a href="#l23.495"></a><span id="l23.495"> </span>
<a href="#l23.496"></a><span id="l23.496">   m_keys.Clear();</span>
<a href="#l23.497"></a><span id="l23.497">   m_levels.Clear();</span>
<a href="#l23.498"></a><span id="l23.498">   m_flags.Clear();</span>
<a href="#l23.499"></a><span id="l23.499">   m_hdrHits.Clear();</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineminus">-  // this needs to happen after we remove all the keys, since RowCountChanged() will call our GetRowCount()</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineminus">-  if (mTree)</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l23.503"></a><span id="l23.503" class="difflineplus">+  // this needs to happen after we remove all the keys, since RowCountChanged()</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineplus">+  // will call our GetRowCount()</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineplus">+  if (mTree) mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l23.506"></a><span id="l23.506">   uint32_t folderFlags = 0;</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineminus">-  if (m_viewFolder)</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineminus">-    m_viewFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineplus">+  if (m_viewFolder) m_viewFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l23.510"></a><span id="l23.510">   // check if it's a virtual folder - if so, we should get the cached hits</span>
<a href="#l23.511"></a><span id="l23.511">   // from the db, and set a flag saying that we're using cached values.</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineminus">-  if (folderFlags &amp; nsMsgFolderFlags::Virtual)</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineminus">-  {</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineplus">+  if (folderFlags &amp; nsMsgFolderFlags::Virtual) {</span>
<a href="#l23.515"></a><span id="l23.515">     nsCOMPtr&lt;nsISimpleEnumerator&gt; cachedHits;</span>
<a href="#l23.516"></a><span id="l23.516">     nsCString searchUri;</span>
<a href="#l23.517"></a><span id="l23.517">     m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l23.518"></a><span id="l23.518">     m_db-&gt;GetCachedHits(searchUri.get(), getter_AddRefs(cachedHits));</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineminus">-    if (cachedHits)</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineminus">-    {</span>
<a href="#l23.521"></a><span id="l23.521" class="difflineplus">+    if (cachedHits) {</span>
<a href="#l23.522"></a><span id="l23.522">       bool hasMore;</span>
<a href="#l23.523"></a><span id="l23.523"> </span>
<a href="#l23.524"></a><span id="l23.524">       m_usingCachedHits = true;</span>
<a href="#l23.525"></a><span id="l23.525">       cachedHits-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l23.526"></a><span id="l23.526">       m_cacheEmpty = !hasMore;</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineminus">-      if (mTree)</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineminus">-        mTree-&gt;BeginUpdateBatch();</span>
<a href="#l23.529"></a><span id="l23.529" class="difflineminus">-      while (hasMore)</span>
<a href="#l23.530"></a><span id="l23.530" class="difflineminus">-      {</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineminus">-        nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l23.532"></a><span id="l23.532" class="difflineplus">+      if (mTree) mTree-&gt;BeginUpdateBatch();</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineplus">+      while (hasMore) {</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l23.535"></a><span id="l23.535">         nsresult rv = cachedHits-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l23.536"></a><span id="l23.536">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l23.539"></a><span id="l23.539">         if (pHeader &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l23.540"></a><span id="l23.540">           AddHdr(pHeader);</span>
<a href="#l23.541"></a><span id="l23.541">         else</span>
<a href="#l23.542"></a><span id="l23.542">           break;</span>
<a href="#l23.543"></a><span id="l23.543">         cachedHits-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l23.544"></a><span id="l23.544">       }</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineminus">-      if (mTree)</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineminus">-        mTree-&gt;EndUpdateBatch();</span>
<a href="#l23.547"></a><span id="l23.547" class="difflineplus">+      if (mTree) mTree-&gt;EndUpdateBatch();</span>
<a href="#l23.548"></a><span id="l23.548">     }</span>
<a href="#l23.549"></a><span id="l23.549">   }</span>
<a href="#l23.550"></a><span id="l23.550">   return NS_OK;</span>
<a href="#l23.551"></a><span id="l23.551"> }</span>
<a href="#l23.552"></a><span id="l23.552"> </span>
<a href="#l23.553"></a><span id="l23.553" class="difflineminus">-nsresult nsMsgQuickSearchDBView::GetFirstMessageHdrToDisplayInThread(nsIMsgThread *threadHdr, nsIMsgDBHdr **result)</span>
<a href="#l23.554"></a><span id="l23.554" class="difflineminus">-{</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineplus">+nsresult nsMsgQuickSearchDBView::GetFirstMessageHdrToDisplayInThread(</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineplus">+    nsIMsgThread *threadHdr, nsIMsgDBHdr **result) {</span>
<a href="#l23.557"></a><span id="l23.557">   uint32_t numChildren;</span>
<a href="#l23.558"></a><span id="l23.558">   nsresult rv = NS_OK;</span>
<a href="#l23.559"></a><span id="l23.559">   uint8_t minLevel = 0xff;</span>
<a href="#l23.560"></a><span id="l23.560">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l23.561"></a><span id="l23.561">   nsMsgKey threadRootKey;</span>
<a href="#l23.562"></a><span id="l23.562">   nsCOMPtr&lt;nsIMsgDBHdr&gt; rootParent;</span>
<a href="#l23.563"></a><span id="l23.563">   int32_t rootIndex;</span>
<a href="#l23.564"></a><span id="l23.564">   threadHdr-&gt;GetRootHdr(&amp;rootIndex, getter_AddRefs(rootParent));</span>
<a href="#l23.565"></a><span id="l23.565">   if (rootParent)</span>
<a href="#l23.566"></a><span id="l23.566">     rootParent-&gt;GetMessageKey(&amp;threadRootKey);</span>
<a href="#l23.567"></a><span id="l23.567">   else</span>
<a href="#l23.568"></a><span id="l23.568">     threadHdr-&gt;GetThreadKey(&amp;threadRootKey);</span>
<a href="#l23.569"></a><span id="l23.569"> </span>
<a href="#l23.570"></a><span id="l23.570">   nsCOMPtr&lt;nsIMsgDBHdr&gt; retHdr;</span>
<a href="#l23.571"></a><span id="l23.571"> </span>
<a href="#l23.572"></a><span id="l23.572">   // iterate over thread, finding mgsHdr in view with the lowest level.</span>
<a href="#l23.573"></a><span id="l23.573" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l23.574"></a><span id="l23.574" class="difflineminus">-  {</span>
<a href="#l23.575"></a><span id="l23.575" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l23.576"></a><span id="l23.576">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l23.577"></a><span id="l23.577">     rv = threadHdr-&gt;GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l23.579"></a><span id="l23.579" class="difflineminus">-    {</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l23.581"></a><span id="l23.581">       nsMsgKey msgKey;</span>
<a href="#l23.582"></a><span id="l23.582">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.583"></a><span id="l23.583"> </span>
<a href="#l23.584"></a><span id="l23.584">       // this works because we've already sorted m_keys by id.</span>
<a href="#l23.585"></a><span id="l23.585">       nsMsgViewIndex keyIndex = m_origKeys.BinaryIndexOf(msgKey);</span>
<a href="#l23.586"></a><span id="l23.586" class="difflineminus">-      if (keyIndex != nsMsgViewIndex_None)</span>
<a href="#l23.587"></a><span id="l23.587" class="difflineminus">-      {</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineplus">+      if (keyIndex != nsMsgViewIndex_None) {</span>
<a href="#l23.589"></a><span id="l23.589">         // this is the root, so it's the best we're going to do.</span>
<a href="#l23.590"></a><span id="l23.590" class="difflineminus">-        if (msgKey == threadRootKey)</span>
<a href="#l23.591"></a><span id="l23.591" class="difflineminus">-        {</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineplus">+        if (msgKey == threadRootKey) {</span>
<a href="#l23.593"></a><span id="l23.593">           retHdr = child;</span>
<a href="#l23.594"></a><span id="l23.594">           break;</span>
<a href="#l23.595"></a><span id="l23.595">         }</span>
<a href="#l23.596"></a><span id="l23.596">         uint8_t level = 0;</span>
<a href="#l23.597"></a><span id="l23.597">         nsMsgKey parentId;</span>
<a href="#l23.598"></a><span id="l23.598">         child-&gt;GetThreadParent(&amp;parentId);</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; parent;</span>
<a href="#l23.600"></a><span id="l23.600" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; parent;</span>
<a href="#l23.601"></a><span id="l23.601">         // count number of ancestors - that's our level</span>
<a href="#l23.602"></a><span id="l23.602" class="difflineminus">-        while (parentId != nsMsgKey_None)</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineminus">-        {</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineplus">+        while (parentId != nsMsgKey_None) {</span>
<a href="#l23.605"></a><span id="l23.605">           rv = m_db-&gt;GetMsgHdrForKey(parentId, getter_AddRefs(parent));</span>
<a href="#l23.606"></a><span id="l23.606" class="difflineminus">-          if (parent)</span>
<a href="#l23.607"></a><span id="l23.607" class="difflineminus">-          {</span>
<a href="#l23.608"></a><span id="l23.608" class="difflineplus">+          if (parent) {</span>
<a href="#l23.609"></a><span id="l23.609">             nsMsgKey saveParentId = parentId;</span>
<a href="#l23.610"></a><span id="l23.610">             parent-&gt;GetThreadParent(&amp;parentId);</span>
<a href="#l23.611"></a><span id="l23.611">             // message is it's own parent - bad, let's break out of here.</span>
<a href="#l23.612"></a><span id="l23.612">             // Or we've got some circular ancestry.</span>
<a href="#l23.613"></a><span id="l23.613" class="difflineminus">-            if (parentId == saveParentId || level &gt; numChildren)</span>
<a href="#l23.614"></a><span id="l23.614" class="difflineminus">-              break;</span>
<a href="#l23.615"></a><span id="l23.615" class="difflineplus">+            if (parentId == saveParentId || level &gt; numChildren) break;</span>
<a href="#l23.616"></a><span id="l23.616">             level++;</span>
<a href="#l23.617"></a><span id="l23.617" class="difflineminus">-          }</span>
<a href="#l23.618"></a><span id="l23.618" class="difflineminus">-          else // if we can't find the parent, don't loop forever.</span>
<a href="#l23.619"></a><span id="l23.619" class="difflineplus">+          } else  // if we can't find the parent, don't loop forever.</span>
<a href="#l23.620"></a><span id="l23.620">             break;</span>
<a href="#l23.621"></a><span id="l23.621">         }</span>
<a href="#l23.622"></a><span id="l23.622" class="difflineminus">-        if (level &lt; minLevel)</span>
<a href="#l23.623"></a><span id="l23.623" class="difflineminus">-        {</span>
<a href="#l23.624"></a><span id="l23.624" class="difflineplus">+        if (level &lt; minLevel) {</span>
<a href="#l23.625"></a><span id="l23.625">           minLevel = level;</span>
<a href="#l23.626"></a><span id="l23.626">           retHdr = child;</span>
<a href="#l23.627"></a><span id="l23.627">         }</span>
<a href="#l23.628"></a><span id="l23.628">       }</span>
<a href="#l23.629"></a><span id="l23.629">     }</span>
<a href="#l23.630"></a><span id="l23.630">   }</span>
<a href="#l23.631"></a><span id="l23.631">   retHdr.forget(result);</span>
<a href="#l23.632"></a><span id="l23.632">   return NS_OK;</span>
<a href="#l23.633"></a><span id="l23.633"> }</span>
<a href="#l23.634"></a><span id="l23.634"> </span>
<a href="#l23.635"></a><span id="l23.635" class="difflineminus">-nsresult nsMsgQuickSearchDBView::SortThreads(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l23.636"></a><span id="l23.636" class="difflineminus">-{</span>
<a href="#l23.637"></a><span id="l23.637" class="difflineplus">+nsresult nsMsgQuickSearchDBView::SortThreads(</span>
<a href="#l23.638"></a><span id="l23.638" class="difflineplus">+    nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder) {</span>
<a href="#l23.639"></a><span id="l23.639">   // don't need to sort by threads for group view.</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) return NS_OK;</span>
<a href="#l23.643"></a><span id="l23.643">   // iterate over the messages in the view, getting the thread id's</span>
<a href="#l23.644"></a><span id="l23.644">   // sort m_keys so we can quickly find if a key is in the view.</span>
<a href="#l23.645"></a><span id="l23.645">   m_keys.Sort();</span>
<a href="#l23.646"></a><span id="l23.646">   // array of the threads' root hdr keys.</span>
<a href="#l23.647"></a><span id="l23.647">   nsTArray&lt;nsMsgKey&gt; threadRootIds;</span>
<a href="#l23.648"></a><span id="l23.648" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l23.651"></a><span id="l23.651" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_keys.Length(); i++)</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineminus">-  {</span>
<a href="#l23.653"></a><span id="l23.653" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l23.654"></a><span id="l23.654" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.655"></a><span id="l23.655" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l23.656"></a><span id="l23.656" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_keys.Length(); i++) {</span>
<a href="#l23.657"></a><span id="l23.657">     GetMsgHdrForViewIndex(i, getter_AddRefs(msgHdr));</span>
<a href="#l23.658"></a><span id="l23.658">     m_db-&gt;GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(threadHdr));</span>
<a href="#l23.659"></a><span id="l23.659" class="difflineminus">-    if (threadHdr)</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineminus">-    {</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineplus">+    if (threadHdr) {</span>
<a href="#l23.662"></a><span id="l23.662">       nsMsgKey rootKey;</span>
<a href="#l23.663"></a><span id="l23.663">       threadHdr-&gt;GetChildKeyAt(0, &amp;rootKey);</span>
<a href="#l23.664"></a><span id="l23.664">       nsMsgViewIndex threadRootIndex = threadRootIds.BinaryIndexOf(rootKey);</span>
<a href="#l23.665"></a><span id="l23.665">       // if we already have that id in top level threads, ignore this msg.</span>
<a href="#l23.666"></a><span id="l23.666" class="difflineminus">-      if (threadRootIndex != nsMsgViewIndex_None)</span>
<a href="#l23.667"></a><span id="l23.667" class="difflineminus">-        continue;</span>
<a href="#l23.668"></a><span id="l23.668" class="difflineminus">-      // it would be nice if GetInsertIndexHelper always found the hdr, but it doesn't.</span>
<a href="#l23.669"></a><span id="l23.669" class="difflineplus">+      if (threadRootIndex != nsMsgViewIndex_None) continue;</span>
<a href="#l23.670"></a><span id="l23.670" class="difflineplus">+      // it would be nice if GetInsertIndexHelper always found the hdr, but it</span>
<a href="#l23.671"></a><span id="l23.671" class="difflineplus">+      // doesn't.</span>
<a href="#l23.672"></a><span id="l23.672">       threadHdr-&gt;GetChildHdrAt(0, getter_AddRefs(rootHdr));</span>
<a href="#l23.673"></a><span id="l23.673" class="difflineminus">-      if (!rootHdr)</span>
<a href="#l23.674"></a><span id="l23.674" class="difflineminus">-        continue;</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineplus">+      if (!rootHdr) continue;</span>
<a href="#l23.676"></a><span id="l23.676">       threadRootIndex = GetInsertIndexHelper(rootHdr, threadRootIds, nullptr,</span>
<a href="#l23.677"></a><span id="l23.677">                                              nsMsgViewSortOrder::ascending,</span>
<a href="#l23.678"></a><span id="l23.678">                                              nsMsgViewSortType::byId);</span>
<a href="#l23.679"></a><span id="l23.679">       threadRootIds.InsertElementAt(threadRootIndex, rootKey);</span>
<a href="#l23.680"></a><span id="l23.680">     }</span>
<a href="#l23.681"></a><span id="l23.681">   }</span>
<a href="#l23.682"></a><span id="l23.682"> </span>
<a href="#l23.683"></a><span id="l23.683" class="difflineminus">-  m_sortType = nsMsgViewSortType::byNone; // sort from scratch</span>
<a href="#l23.684"></a><span id="l23.684" class="difflineplus">+  m_sortType = nsMsgViewSortType::byNone;  // sort from scratch</span>
<a href="#l23.685"></a><span id="l23.685">   // need to sort the top level threads now by sort order, if it's not by id</span>
<a href="#l23.686"></a><span id="l23.686">   // and ascending (which is the order per above).</span>
<a href="#l23.687"></a><span id="l23.687">   if (!(sortType == nsMsgViewSortType::byId &amp;&amp;</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineminus">-        sortOrder == nsMsgViewSortOrder::ascending))</span>
<a href="#l23.689"></a><span id="l23.689" class="difflineminus">-  {</span>
<a href="#l23.690"></a><span id="l23.690" class="difflineplus">+        sortOrder == nsMsgViewSortOrder::ascending)) {</span>
<a href="#l23.691"></a><span id="l23.691">     m_keys.SwapElements(threadRootIds);</span>
<a href="#l23.692"></a><span id="l23.692">     nsMsgDBView::Sort(sortType, sortOrder);</span>
<a href="#l23.693"></a><span id="l23.693">     threadRootIds.SwapElements(m_keys);</span>
<a href="#l23.694"></a><span id="l23.694">   }</span>
<a href="#l23.695"></a><span id="l23.695">   m_keys.Clear();</span>
<a href="#l23.696"></a><span id="l23.696">   m_levels.Clear();</span>
<a href="#l23.697"></a><span id="l23.697">   m_flags.Clear();</span>
<a href="#l23.698"></a><span id="l23.698">   // now we've build up the list of thread ids - need to build the view</span>
<a href="#l23.699"></a><span id="l23.699" class="difflineminus">-  // from that. So for each thread id, we need to list the messages in the thread.</span>
<a href="#l23.700"></a><span id="l23.700" class="difflineplus">+  // from that. So for each thread id, we need to list the messages in the</span>
<a href="#l23.701"></a><span id="l23.701" class="difflineplus">+  // thread.</span>
<a href="#l23.702"></a><span id="l23.702">   uint32_t numThreads = threadRootIds.Length();</span>
<a href="#l23.703"></a><span id="l23.703" class="difflineminus">-  for (uint32_t threadIndex = 0; threadIndex &lt; numThreads; threadIndex++)</span>
<a href="#l23.704"></a><span id="l23.704" class="difflineminus">-  {</span>
<a href="#l23.705"></a><span id="l23.705" class="difflineplus">+  for (uint32_t threadIndex = 0; threadIndex &lt; numThreads; threadIndex++) {</span>
<a href="#l23.706"></a><span id="l23.706">     m_db-&gt;GetMsgHdrForKey(threadRootIds[threadIndex], getter_AddRefs(rootHdr));</span>
<a href="#l23.707"></a><span id="l23.707" class="difflineminus">-    if (rootHdr)</span>
<a href="#l23.708"></a><span id="l23.708" class="difflineminus">-    {</span>
<a href="#l23.709"></a><span id="l23.709" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; displayRootHdr;</span>
<a href="#l23.710"></a><span id="l23.710" class="difflineplus">+    if (rootHdr) {</span>
<a href="#l23.711"></a><span id="l23.711" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; displayRootHdr;</span>
<a href="#l23.712"></a><span id="l23.712">       m_db-&gt;GetThreadContainingMsgHdr(rootHdr, getter_AddRefs(threadHdr));</span>
<a href="#l23.713"></a><span id="l23.713" class="difflineminus">-      if (threadHdr)</span>
<a href="#l23.714"></a><span id="l23.714" class="difflineminus">-      {</span>
<a href="#l23.715"></a><span id="l23.715" class="difflineplus">+      if (threadHdr) {</span>
<a href="#l23.716"></a><span id="l23.716">         nsMsgKey rootKey;</span>
<a href="#l23.717"></a><span id="l23.717">         uint32_t rootFlags;</span>
<a href="#l23.718"></a><span id="l23.718" class="difflineminus">-        GetFirstMessageHdrToDisplayInThread(threadHdr, getter_AddRefs(displayRootHdr));</span>
<a href="#l23.719"></a><span id="l23.719" class="difflineminus">-        if (!displayRootHdr)</span>
<a href="#l23.720"></a><span id="l23.720" class="difflineminus">-          continue;</span>
<a href="#l23.721"></a><span id="l23.721" class="difflineplus">+        GetFirstMessageHdrToDisplayInThread(threadHdr,</span>
<a href="#l23.722"></a><span id="l23.722" class="difflineplus">+                                            getter_AddRefs(displayRootHdr));</span>
<a href="#l23.723"></a><span id="l23.723" class="difflineplus">+        if (!displayRootHdr) continue;</span>
<a href="#l23.724"></a><span id="l23.724">         displayRootHdr-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l23.725"></a><span id="l23.725">         displayRootHdr-&gt;GetFlags(&amp;rootFlags);</span>
<a href="#l23.726"></a><span id="l23.726">         rootFlags |= MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l23.727"></a><span id="l23.727">         m_keys.AppendElement(rootKey);</span>
<a href="#l23.728"></a><span id="l23.728">         m_flags.AppendElement(rootFlags);</span>
<a href="#l23.729"></a><span id="l23.729">         m_levels.AppendElement(0);</span>
<a href="#l23.730"></a><span id="l23.730"> </span>
<a href="#l23.731"></a><span id="l23.731">         nsMsgViewIndex startOfThreadViewIndex = m_keys.Length();</span>
<a href="#l23.732"></a><span id="l23.732">         nsMsgViewIndex rootIndex = startOfThreadViewIndex - 1;</span>
<a href="#l23.733"></a><span id="l23.733">         uint32_t numListed = 0;</span>
<a href="#l23.734"></a><span id="l23.734" class="difflineminus">-        ListIdsInThreadOrder(threadHdr, rootKey, 1, &amp;startOfThreadViewIndex, &amp;numListed);</span>
<a href="#l23.735"></a><span id="l23.735" class="difflineplus">+        ListIdsInThreadOrder(threadHdr, rootKey, 1, &amp;startOfThreadViewIndex,</span>
<a href="#l23.736"></a><span id="l23.736" class="difflineplus">+                             &amp;numListed);</span>
<a href="#l23.737"></a><span id="l23.737">         if (numListed &gt; 0)</span>
<a href="#l23.738"></a><span id="l23.738">           m_flags[rootIndex] = rootFlags | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l23.739"></a><span id="l23.739">       }</span>
<a href="#l23.740"></a><span id="l23.740">     }</span>
<a href="#l23.741"></a><span id="l23.741">   }</span>
<a href="#l23.742"></a><span id="l23.742"> </span>
<a href="#l23.743"></a><span id="l23.743">   // The thread state is left expanded (despite viewFlags) so at least reflect</span>
<a href="#l23.744"></a><span id="l23.744">   // the correct state.</span>
<a href="#l23.745"></a><span id="l23.745">   m_viewFlags |= nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l23.746"></a><span id="l23.746"> </span>
<a href="#l23.747"></a><span id="l23.747">   return NS_OK;</span>
<a href="#l23.748"></a><span id="l23.748"> }</span>
<a href="#l23.749"></a><span id="l23.749"> </span>
<a href="#l23.750"></a><span id="l23.750" class="difflineminus">-nsresult</span>
<a href="#l23.751"></a><span id="l23.751" class="difflineminus">-nsMsgQuickSearchDBView::ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l23.752"></a><span id="l23.752" class="difflineminus">-                                              nsIMutableArray *messageArray)</span>
<a href="#l23.753"></a><span id="l23.753" class="difflineminus">-{</span>
<a href="#l23.754"></a><span id="l23.754" class="difflineplus">+nsresult nsMsgQuickSearchDBView::ListCollapsedChildren(</span>
<a href="#l23.755"></a><span id="l23.755" class="difflineplus">+    nsMsgViewIndex viewIndex, nsIMutableArray *messageArray) {</span>
<a href="#l23.756"></a><span id="l23.756">   nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l23.757"></a><span id="l23.757">   nsresult rv = GetThreadContainingIndex(viewIndex, getter_AddRefs(threadHdr));</span>
<a href="#l23.758"></a><span id="l23.758">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.759"></a><span id="l23.759">   uint32_t numChildren;</span>
<a href="#l23.760"></a><span id="l23.760">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l23.761"></a><span id="l23.761">   nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l23.762"></a><span id="l23.762">   nsMsgKey rootKey;</span>
<a href="#l23.763"></a><span id="l23.763">   GetMsgHdrForViewIndex(viewIndex, getter_AddRefs(rootHdr));</span>
<a href="#l23.764"></a><span id="l23.764">   rootHdr-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l23.765"></a><span id="l23.765">   // group threads can have the root key twice, one for the dummy row.</span>
<a href="#l23.766"></a><span id="l23.766">   bool rootKeySkipped = false;</span>
<a href="#l23.767"></a><span id="l23.767" class="difflineminus">-  for (uint32_t i = 0; i &lt; numChildren; i++)</span>
<a href="#l23.768"></a><span id="l23.768" class="difflineminus">-  {</span>
<a href="#l23.769"></a><span id="l23.769" class="difflineplus">+  for (uint32_t i = 0; i &lt; numChildren; i++) {</span>
<a href="#l23.770"></a><span id="l23.770">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.771"></a><span id="l23.771">     threadHdr-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l23.772"></a><span id="l23.772" class="difflineminus">-    if (msgHdr)</span>
<a href="#l23.773"></a><span id="l23.773" class="difflineminus">-    {</span>
<a href="#l23.774"></a><span id="l23.774" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l23.775"></a><span id="l23.775">       nsMsgKey msgKey;</span>
<a href="#l23.776"></a><span id="l23.776">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.777"></a><span id="l23.777" class="difflineminus">-      if (msgKey != rootKey || (GroupViewUsesDummyRow() &amp;&amp; rootKeySkipped))</span>
<a href="#l23.778"></a><span id="l23.778" class="difflineminus">-      {</span>
<a href="#l23.779"></a><span id="l23.779" class="difflineplus">+      if (msgKey != rootKey || (GroupViewUsesDummyRow() &amp;&amp; rootKeySkipped)) {</span>
<a href="#l23.780"></a><span id="l23.780">         // if this hdr is in the original view, add it to new view.</span>
<a href="#l23.781"></a><span id="l23.781">         if (m_origKeys.BinaryIndexOf(msgKey) != m_origKeys.NoIndex)</span>
<a href="#l23.782"></a><span id="l23.782">           messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l23.783"></a><span id="l23.783" class="difflineminus">-      }</span>
<a href="#l23.784"></a><span id="l23.784" class="difflineminus">-      else</span>
<a href="#l23.785"></a><span id="l23.785" class="difflineminus">-      {</span>
<a href="#l23.786"></a><span id="l23.786" class="difflineplus">+      } else {</span>
<a href="#l23.787"></a><span id="l23.787">         rootKeySkipped = true;</span>
<a href="#l23.788"></a><span id="l23.788">       }</span>
<a href="#l23.789"></a><span id="l23.789">     }</span>
<a href="#l23.790"></a><span id="l23.790">   }</span>
<a href="#l23.791"></a><span id="l23.791">   return NS_OK;</span>
<a href="#l23.792"></a><span id="l23.792"> }</span>
<a href="#l23.793"></a><span id="l23.793"> </span>
<a href="#l23.794"></a><span id="l23.794" class="difflineminus">-nsresult nsMsgQuickSearchDBView::ListIdsInThread(nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex, uint32_t *pNumListed)</span>
<a href="#l23.795"></a><span id="l23.795" class="difflineminus">-{</span>
<a href="#l23.796"></a><span id="l23.796" class="difflineminus">-</span>
<a href="#l23.797"></a><span id="l23.797" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp; ! (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l23.798"></a><span id="l23.798" class="difflineminus">-  {</span>
<a href="#l23.799"></a><span id="l23.799" class="difflineplus">+nsresult nsMsgQuickSearchDBView::ListIdsInThread(</span>
<a href="#l23.800"></a><span id="l23.800" class="difflineplus">+    nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l23.801"></a><span id="l23.801" class="difflineplus">+    uint32_t *pNumListed) {</span>
<a href="#l23.802"></a><span id="l23.802" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l23.803"></a><span id="l23.803" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)) {</span>
<a href="#l23.804"></a><span id="l23.804">     nsMsgKey parentKey = m_keys[startOfThreadViewIndex++];</span>
<a href="#l23.805"></a><span id="l23.805" class="difflineminus">-    return ListIdsInThreadOrder(threadHdr, parentKey, 1, &amp;startOfThreadViewIndex, pNumListed);</span>
<a href="#l23.806"></a><span id="l23.806" class="difflineplus">+    return ListIdsInThreadOrder(threadHdr, parentKey, 1,</span>
<a href="#l23.807"></a><span id="l23.807" class="difflineplus">+                                &amp;startOfThreadViewIndex, pNumListed);</span>
<a href="#l23.808"></a><span id="l23.808">   }</span>
<a href="#l23.809"></a><span id="l23.809"> </span>
<a href="#l23.810"></a><span id="l23.810">   uint32_t numChildren;</span>
<a href="#l23.811"></a><span id="l23.811">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l23.812"></a><span id="l23.812">   uint32_t i;</span>
<a href="#l23.813"></a><span id="l23.813">   uint32_t viewIndex = startOfThreadViewIndex + 1;</span>
<a href="#l23.814"></a><span id="l23.814">   nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l23.815"></a><span id="l23.815">   nsMsgKey rootKey;</span>
<a href="#l23.816"></a><span id="l23.816">   uint32_t rootFlags = m_flags[startOfThreadViewIndex];</span>
<a href="#l23.817"></a><span id="l23.817">   *pNumListed = 0;</span>
<a href="#l23.818"></a><span id="l23.818">   GetMsgHdrForViewIndex(startOfThreadViewIndex, getter_AddRefs(rootHdr));</span>
<a href="#l23.819"></a><span id="l23.819">   rootHdr-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l23.820"></a><span id="l23.820">   // group threads can have the root key twice, one for the dummy row.</span>
<a href="#l23.821"></a><span id="l23.821">   bool rootKeySkipped = false;</span>
<a href="#l23.822"></a><span id="l23.822" class="difflineminus">-  for (i = 0; i &lt; numChildren; i++)</span>
<a href="#l23.823"></a><span id="l23.823" class="difflineminus">-  {</span>
<a href="#l23.824"></a><span id="l23.824" class="difflineplus">+  for (i = 0; i &lt; numChildren; i++) {</span>
<a href="#l23.825"></a><span id="l23.825">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.826"></a><span id="l23.826">     threadHdr-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l23.827"></a><span id="l23.827" class="difflineminus">-    if (msgHdr != nullptr)</span>
<a href="#l23.828"></a><span id="l23.828" class="difflineminus">-    {</span>
<a href="#l23.829"></a><span id="l23.829" class="difflineplus">+    if (msgHdr != nullptr) {</span>
<a href="#l23.830"></a><span id="l23.830">       nsMsgKey msgKey;</span>
<a href="#l23.831"></a><span id="l23.831">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.832"></a><span id="l23.832" class="difflineminus">-      if (msgKey != rootKey || (GroupViewUsesDummyRow() &amp;&amp; rootKeySkipped))</span>
<a href="#l23.833"></a><span id="l23.833" class="difflineminus">-      {</span>
<a href="#l23.834"></a><span id="l23.834" class="difflineplus">+      if (msgKey != rootKey || (GroupViewUsesDummyRow() &amp;&amp; rootKeySkipped)) {</span>
<a href="#l23.835"></a><span id="l23.835">         nsMsgViewIndex threadRootIndex = m_origKeys.BinaryIndexOf(msgKey);</span>
<a href="#l23.836"></a><span id="l23.836">         // if this hdr is in the original view, add it to new view.</span>
<a href="#l23.837"></a><span id="l23.837" class="difflineminus">-        if (threadRootIndex != nsMsgViewIndex_None)</span>
<a href="#l23.838"></a><span id="l23.838" class="difflineminus">-        {</span>
<a href="#l23.839"></a><span id="l23.839" class="difflineplus">+        if (threadRootIndex != nsMsgViewIndex_None) {</span>
<a href="#l23.840"></a><span id="l23.840">           uint32_t childFlags;</span>
<a href="#l23.841"></a><span id="l23.841">           msgHdr-&gt;GetFlags(&amp;childFlags);</span>
<a href="#l23.842"></a><span id="l23.842" class="difflineminus">-          InsertMsgHdrAt(viewIndex, msgHdr, msgKey, childFlags,</span>
<a href="#l23.843"></a><span id="l23.843" class="difflineminus">-                        FindLevelInThread(msgHdr, startOfThreadViewIndex, viewIndex));</span>
<a href="#l23.844"></a><span id="l23.844" class="difflineminus">-          if (! (rootFlags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l23.845"></a><span id="l23.845" class="difflineminus">-            m_flags[startOfThreadViewIndex] = rootFlags | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l23.846"></a><span id="l23.846" class="difflineplus">+          InsertMsgHdrAt(</span>
<a href="#l23.847"></a><span id="l23.847" class="difflineplus">+              viewIndex, msgHdr, msgKey, childFlags,</span>
<a href="#l23.848"></a><span id="l23.848" class="difflineplus">+              FindLevelInThread(msgHdr, startOfThreadViewIndex, viewIndex));</span>
<a href="#l23.849"></a><span id="l23.849" class="difflineplus">+          if (!(rootFlags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l23.850"></a><span id="l23.850" class="difflineplus">+            m_flags[startOfThreadViewIndex] =</span>
<a href="#l23.851"></a><span id="l23.851" class="difflineplus">+                rootFlags | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l23.852"></a><span id="l23.852"> </span>
<a href="#l23.853"></a><span id="l23.853">           viewIndex++;</span>
<a href="#l23.854"></a><span id="l23.854">           (*pNumListed)++;</span>
<a href="#l23.855"></a><span id="l23.855">         }</span>
<a href="#l23.856"></a><span id="l23.856" class="difflineminus">-      }</span>
<a href="#l23.857"></a><span id="l23.857" class="difflineminus">-      else</span>
<a href="#l23.858"></a><span id="l23.858" class="difflineminus">-      {</span>
<a href="#l23.859"></a><span id="l23.859" class="difflineplus">+      } else {</span>
<a href="#l23.860"></a><span id="l23.860">         rootKeySkipped = true;</span>
<a href="#l23.861"></a><span id="l23.861">       }</span>
<a href="#l23.862"></a><span id="l23.862">     }</span>
<a href="#l23.863"></a><span id="l23.863">   }</span>
<a href="#l23.864"></a><span id="l23.864">   return NS_OK;</span>
<a href="#l23.865"></a><span id="l23.865"> }</span>
<a href="#l23.866"></a><span id="l23.866"> </span>
<a href="#l23.867"></a><span id="l23.867" class="difflineminus">-nsresult</span>
<a href="#l23.868"></a><span id="l23.868" class="difflineminus">-nsMsgQuickSearchDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l23.869"></a><span id="l23.869" class="difflineminus">-                                             nsMsgKey parentKey, uint32_t level,</span>
<a href="#l23.870"></a><span id="l23.870" class="difflineminus">-                                             uint32_t callLevel,</span>
<a href="#l23.871"></a><span id="l23.871" class="difflineminus">-                                             nsMsgKey keyToSkip,</span>
<a href="#l23.872"></a><span id="l23.872" class="difflineminus">-                                             nsMsgViewIndex *viewIndex,</span>
<a href="#l23.873"></a><span id="l23.873" class="difflineminus">-                                             uint32_t *pNumListed)</span>
<a href="#l23.874"></a><span id="l23.874" class="difflineminus">-{</span>
<a href="#l23.875"></a><span id="l23.875" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l23.876"></a><span id="l23.876" class="difflineminus">-  nsresult rv = threadHdr-&gt;EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));</span>
<a href="#l23.877"></a><span id="l23.877" class="difflineplus">+nsresult nsMsgQuickSearchDBView::ListIdsInThreadOrder(</span>
<a href="#l23.878"></a><span id="l23.878" class="difflineplus">+    nsIMsgThread *threadHdr, nsMsgKey parentKey, uint32_t level,</span>
<a href="#l23.879"></a><span id="l23.879" class="difflineplus">+    uint32_t callLevel, nsMsgKey keyToSkip, nsMsgViewIndex *viewIndex,</span>
<a href="#l23.880"></a><span id="l23.880" class="difflineplus">+    uint32_t *pNumListed) {</span>
<a href="#l23.881"></a><span id="l23.881" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l23.882"></a><span id="l23.882" class="difflineplus">+  nsresult rv =</span>
<a href="#l23.883"></a><span id="l23.883" class="difflineplus">+      threadHdr-&gt;EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));</span>
<a href="#l23.884"></a><span id="l23.884">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.885"></a><span id="l23.885"> </span>
<a href="#l23.886"></a><span id="l23.886">   // We use the numChildren as a sanity check on the thread structure.</span>
<a href="#l23.887"></a><span id="l23.887">   uint32_t numChildren;</span>
<a href="#l23.888"></a><span id="l23.888" class="difflineminus">-  (void) threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l23.889"></a><span id="l23.889" class="difflineplus">+  (void)threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l23.890"></a><span id="l23.890">   bool hasMore;</span>
<a href="#l23.891"></a><span id="l23.891" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l23.892"></a><span id="l23.892" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.893"></a><span id="l23.893" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; NS_SUCCEEDED(rv = msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l23.894"></a><span id="l23.894" class="difflineminus">-         hasMore)</span>
<a href="#l23.895"></a><span id="l23.895" class="difflineminus">-  {</span>
<a href="#l23.896"></a><span id="l23.896" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l23.897"></a><span id="l23.897" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.898"></a><span id="l23.898" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l23.899"></a><span id="l23.899" class="difflineplus">+         NS_SUCCEEDED(rv = msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l23.900"></a><span id="l23.900" class="difflineplus">+         hasMore) {</span>
<a href="#l23.901"></a><span id="l23.901">     rv = msgEnumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l23.902"></a><span id="l23.902" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l23.903"></a><span id="l23.903" class="difflineminus">-    {</span>
<a href="#l23.904"></a><span id="l23.904" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l23.905"></a><span id="l23.905">       msgHdr = do_QueryInterface(supports);</span>
<a href="#l23.906"></a><span id="l23.906">       nsMsgKey msgKey;</span>
<a href="#l23.907"></a><span id="l23.907">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.908"></a><span id="l23.908" class="difflineminus">-      if (msgKey == keyToSkip)</span>
<a href="#l23.909"></a><span id="l23.909" class="difflineminus">-        continue;</span>
<a href="#l23.910"></a><span id="l23.910" class="difflineplus">+      if (msgKey == keyToSkip) continue;</span>
<a href="#l23.911"></a><span id="l23.911"> </span>
<a href="#l23.912"></a><span id="l23.912">       // If we discover depths of more than numChildren, it means we have</span>
<a href="#l23.913"></a><span id="l23.913">       // some sort of circular thread relationship and we bail out of the</span>
<a href="#l23.914"></a><span id="l23.914">       // while loop before overflowing the stack with recursive calls.</span>
<a href="#l23.915"></a><span id="l23.915">       // Technically, this is an error, but forcing a database rebuild</span>
<a href="#l23.916"></a><span id="l23.916">       // is too destructive so we just return.</span>
<a href="#l23.917"></a><span id="l23.917" class="difflineminus">-      if (*pNumListed &gt; numChildren || callLevel &gt; numChildren)</span>
<a href="#l23.918"></a><span id="l23.918" class="difflineminus">-      {</span>
<a href="#l23.919"></a><span id="l23.919" class="difflineplus">+      if (*pNumListed &gt; numChildren || callLevel &gt; numChildren) {</span>
<a href="#l23.920"></a><span id="l23.920">         NS_ERROR(&quot;loop in message threading while listing children&quot;);</span>
<a href="#l23.921"></a><span id="l23.921">         return NS_OK;</span>
<a href="#l23.922"></a><span id="l23.922">       }</span>
<a href="#l23.923"></a><span id="l23.923"> </span>
<a href="#l23.924"></a><span id="l23.924">       int32_t childLevel = level;</span>
<a href="#l23.925"></a><span id="l23.925" class="difflineminus">-      if (m_origKeys.BinaryIndexOf(msgKey) != m_origKeys.NoIndex)</span>
<a href="#l23.926"></a><span id="l23.926" class="difflineminus">-      {</span>
<a href="#l23.927"></a><span id="l23.927" class="difflineplus">+      if (m_origKeys.BinaryIndexOf(msgKey) != m_origKeys.NoIndex) {</span>
<a href="#l23.928"></a><span id="l23.928">         uint32_t msgFlags;</span>
<a href="#l23.929"></a><span id="l23.929">         msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l23.930"></a><span id="l23.930" class="difflineminus">-        InsertMsgHdrAt(*viewIndex, msgHdr, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS, level);</span>
<a href="#l23.931"></a><span id="l23.931" class="difflineplus">+        InsertMsgHdrAt(*viewIndex, msgHdr, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS,</span>
<a href="#l23.932"></a><span id="l23.932" class="difflineplus">+                       level);</span>
<a href="#l23.933"></a><span id="l23.933">         (*pNumListed)++;</span>
<a href="#l23.934"></a><span id="l23.934">         (*viewIndex)++;</span>
<a href="#l23.935"></a><span id="l23.935">         childLevel++;</span>
<a href="#l23.936"></a><span id="l23.936">       }</span>
<a href="#l23.937"></a><span id="l23.937">       rv = ListIdsInThreadOrder(threadHdr, msgKey, childLevel, callLevel + 1,</span>
<a href="#l23.938"></a><span id="l23.938">                                 keyToSkip, viewIndex, pNumListed);</span>
<a href="#l23.939"></a><span id="l23.939">     }</span>
<a href="#l23.940"></a><span id="l23.940">   }</span>
<a href="#l23.941"></a><span id="l23.941">   return rv;</span>
<a href="#l23.942"></a><span id="l23.942"> }</span>
<a href="#l23.943"></a><span id="l23.943"> </span>
<a href="#l23.944"></a><span id="l23.944" class="difflineminus">-nsresult</span>
<a href="#l23.945"></a><span id="l23.945" class="difflineminus">-nsMsgQuickSearchDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l23.946"></a><span id="l23.946" class="difflineminus">-                                             nsMsgKey parentKey, uint32_t level,</span>
<a href="#l23.947"></a><span id="l23.947" class="difflineminus">-                                             nsMsgViewIndex *viewIndex,</span>
<a href="#l23.948"></a><span id="l23.948" class="difflineminus">-                                             uint32_t *pNumListed)</span>
<a href="#l23.949"></a><span id="l23.949" class="difflineminus">-{</span>
<a href="#l23.950"></a><span id="l23.950" class="difflineplus">+nsresult nsMsgQuickSearchDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l23.951"></a><span id="l23.951" class="difflineplus">+                                                      nsMsgKey parentKey,</span>
<a href="#l23.952"></a><span id="l23.952" class="difflineplus">+                                                      uint32_t level,</span>
<a href="#l23.953"></a><span id="l23.953" class="difflineplus">+                                                      nsMsgViewIndex *viewIndex,</span>
<a href="#l23.954"></a><span id="l23.954" class="difflineplus">+                                                      uint32_t *pNumListed) {</span>
<a href="#l23.955"></a><span id="l23.955">   nsresult rv = ListIdsInThreadOrder(threadHdr, parentKey, level, level,</span>
<a href="#l23.956"></a><span id="l23.956">                                      nsMsgKey_None, viewIndex, pNumListed);</span>
<a href="#l23.957"></a><span id="l23.957">   // Because a quick search view might not have the actual thread root</span>
<a href="#l23.958"></a><span id="l23.958">   // as its root, and thus might have a message that potentially has siblings</span>
<a href="#l23.959"></a><span id="l23.959">   // as its root, and the enumerator will miss the siblings, we might need to</span>
<a href="#l23.960"></a><span id="l23.960">   // make a pass looking for the siblings of the non-root root. We'll put</span>
<a href="#l23.961"></a><span id="l23.961" class="difflineminus">-  // those after the potential children of the root. So we will list the children</span>
<a href="#l23.962"></a><span id="l23.962" class="difflineminus">-  // of the faux root's parent, ignoring the faux root.</span>
<a href="#l23.963"></a><span id="l23.963" class="difflineminus">-  if (level == 1)</span>
<a href="#l23.964"></a><span id="l23.964" class="difflineminus">-  {</span>
<a href="#l23.965"></a><span id="l23.965" class="difflineplus">+  // those after the potential children of the root. So we will list the</span>
<a href="#l23.966"></a><span id="l23.966" class="difflineplus">+  // children of the faux root's parent, ignoring the faux root.</span>
<a href="#l23.967"></a><span id="l23.967" class="difflineplus">+  if (level == 1) {</span>
<a href="#l23.968"></a><span id="l23.968">     nsCOMPtr&lt;nsIMsgDBHdr&gt; root;</span>
<a href="#l23.969"></a><span id="l23.969">     nsCOMPtr&lt;nsIMsgDBHdr&gt; rootParent;</span>
<a href="#l23.970"></a><span id="l23.970">     nsMsgKey rootKey;</span>
<a href="#l23.971"></a><span id="l23.971">     int32_t rootIndex;</span>
<a href="#l23.972"></a><span id="l23.972">     threadHdr-&gt;GetRootHdr(&amp;rootIndex, getter_AddRefs(rootParent));</span>
<a href="#l23.973"></a><span id="l23.973" class="difflineminus">-    if (rootParent)</span>
<a href="#l23.974"></a><span id="l23.974" class="difflineminus">-    {</span>
<a href="#l23.975"></a><span id="l23.975" class="difflineplus">+    if (rootParent) {</span>
<a href="#l23.976"></a><span id="l23.976">       rootParent-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l23.977"></a><span id="l23.977">       if (rootKey != parentKey)</span>
<a href="#l23.978"></a><span id="l23.978">         rv = ListIdsInThreadOrder(threadHdr, rootKey, level, level, parentKey,</span>
<a href="#l23.979"></a><span id="l23.979">                                   viewIndex, pNumListed);</span>
<a href="#l23.980"></a><span id="l23.980">     }</span>
<a href="#l23.981"></a><span id="l23.981">   }</span>
<a href="#l23.982"></a><span id="l23.982">   return rv;</span>
<a href="#l23.983"></a><span id="l23.983"> }</span>
<a href="#l23.984"></a><span id="l23.984"> </span>
<a href="#l23.985"></a><span id="l23.985" class="difflineminus">-nsresult nsMsgQuickSearchDBView::ExpansionDelta(nsMsgViewIndex index, int32_t *expansionDelta)</span>
<a href="#l23.986"></a><span id="l23.986" class="difflineminus">-{</span>
<a href="#l23.987"></a><span id="l23.987" class="difflineplus">+nsresult nsMsgQuickSearchDBView::ExpansionDelta(nsMsgViewIndex index,</span>
<a href="#l23.988"></a><span id="l23.988" class="difflineplus">+                                                int32_t *expansionDelta) {</span>
<a href="#l23.989"></a><span id="l23.989">   *expansionDelta = 0;</span>
<a href="#l23.990"></a><span id="l23.990" class="difflineminus">-  if (index &gt;= ((nsMsgViewIndex) m_keys.Length()))</span>
<a href="#l23.991"></a><span id="l23.991" class="difflineplus">+  if (index &gt;= ((nsMsgViewIndex)m_keys.Length()))</span>
<a href="#l23.992"></a><span id="l23.992">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l23.993"></a><span id="l23.993"> </span>
<a href="#l23.994"></a><span id="l23.994">   char flags = m_flags[index];</span>
<a href="#l23.995"></a><span id="l23.995"> </span>
<a href="#l23.996"></a><span id="l23.996" class="difflineminus">-  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l23.997"></a><span id="l23.997" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.998"></a><span id="l23.998" class="difflineplus">+  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) return NS_OK;</span>
<a href="#l23.999"></a><span id="l23.999"> </span>
<a href="#l23.1000"></a><span id="l23.1000">   nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l23.1001"></a><span id="l23.1001">   nsresult rv = GetThreadContainingIndex(index, getter_AddRefs(threadHdr));</span>
<a href="#l23.1002"></a><span id="l23.1002">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1003"></a><span id="l23.1003">   uint32_t numChildren;</span>
<a href="#l23.1004"></a><span id="l23.1004">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l23.1005"></a><span id="l23.1005">   nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l23.1006"></a><span id="l23.1006">   nsMsgKey rootKey;</span>
<a href="#l23.1007"></a><span id="l23.1007">   GetMsgHdrForViewIndex(index, getter_AddRefs(rootHdr));</span>
<a href="#l23.1008"></a><span id="l23.1008">   rootHdr-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l23.1009"></a><span id="l23.1009">   // group threads can have the root key twice, one for the dummy row.</span>
<a href="#l23.1010"></a><span id="l23.1010">   bool rootKeySkipped = false;</span>
<a href="#l23.1011"></a><span id="l23.1011" class="difflineminus">-  for (uint32_t i = 0; i &lt; numChildren; i++)</span>
<a href="#l23.1012"></a><span id="l23.1012" class="difflineminus">-  {</span>
<a href="#l23.1013"></a><span id="l23.1013" class="difflineplus">+  for (uint32_t i = 0; i &lt; numChildren; i++) {</span>
<a href="#l23.1014"></a><span id="l23.1014">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.1015"></a><span id="l23.1015">     threadHdr-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l23.1016"></a><span id="l23.1016" class="difflineminus">-    if (msgHdr)</span>
<a href="#l23.1017"></a><span id="l23.1017" class="difflineminus">-    {</span>
<a href="#l23.1018"></a><span id="l23.1018" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l23.1019"></a><span id="l23.1019">       nsMsgKey msgKey;</span>
<a href="#l23.1020"></a><span id="l23.1020">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.1021"></a><span id="l23.1021" class="difflineminus">-      if (msgKey != rootKey || (GroupViewUsesDummyRow() &amp;&amp; rootKeySkipped))</span>
<a href="#l23.1022"></a><span id="l23.1022" class="difflineminus">-      {</span>
<a href="#l23.1023"></a><span id="l23.1023" class="difflineplus">+      if (msgKey != rootKey || (GroupViewUsesDummyRow() &amp;&amp; rootKeySkipped)) {</span>
<a href="#l23.1024"></a><span id="l23.1024">         // if this hdr is in the original view, add it to new view.</span>
<a href="#l23.1025"></a><span id="l23.1025">         if (m_origKeys.BinaryIndexOf(msgKey) != m_origKeys.NoIndex)</span>
<a href="#l23.1026"></a><span id="l23.1026">           (*expansionDelta)++;</span>
<a href="#l23.1027"></a><span id="l23.1027" class="difflineminus">-      }</span>
<a href="#l23.1028"></a><span id="l23.1028" class="difflineminus">-      else</span>
<a href="#l23.1029"></a><span id="l23.1029" class="difflineminus">-      {</span>
<a href="#l23.1030"></a><span id="l23.1030" class="difflineplus">+      } else {</span>
<a href="#l23.1031"></a><span id="l23.1031">         rootKeySkipped = true;</span>
<a href="#l23.1032"></a><span id="l23.1032">       }</span>
<a href="#l23.1033"></a><span id="l23.1033">     }</span>
<a href="#l23.1034"></a><span id="l23.1034">   }</span>
<a href="#l23.1035"></a><span id="l23.1035" class="difflineminus">-  if (! (flags &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l23.1036"></a><span id="l23.1036" class="difflineminus">-    *expansionDelta = - (*expansionDelta);</span>
<a href="#l23.1037"></a><span id="l23.1037" class="difflineplus">+  if (!(flags &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l23.1038"></a><span id="l23.1038" class="difflineplus">+    *expansionDelta = -(*expansionDelta);</span>
<a href="#l23.1039"></a><span id="l23.1039">   return NS_OK;</span>
<a href="#l23.1040"></a><span id="l23.1040"> }</span>
<a href="#l23.1041"></a><span id="l23.1041"> </span>
<a href="#l23.1042"></a><span id="l23.1042"> NS_IMETHODIMP</span>
<a href="#l23.1043"></a><span id="l23.1043"> nsMsgQuickSearchDBView::OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l23.1044"></a><span id="l23.1044">                                      nsMsgViewSortTypeValue aSortType,</span>
<a href="#l23.1045"></a><span id="l23.1045">                                      nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l23.1046"></a><span id="l23.1046">                                      nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l23.1047"></a><span id="l23.1047" class="difflineminus">-                                     int32_t *aCount)</span>
<a href="#l23.1048"></a><span id="l23.1048" class="difflineminus">-{</span>
<a href="#l23.1049"></a><span id="l23.1049" class="difflineplus">+                                     int32_t *aCount) {</span>
<a href="#l23.1050"></a><span id="l23.1050">   if (aViewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l23.1051"></a><span id="l23.1051">     return nsMsgGroupView::OpenWithHdrs(aHeaders, aSortType, aSortOrder,</span>
<a href="#l23.1052"></a><span id="l23.1052">                                         aViewFlags, aCount);</span>
<a href="#l23.1053"></a><span id="l23.1053"> </span>
<a href="#l23.1054"></a><span id="l23.1054">   m_sortType = aSortType;</span>
<a href="#l23.1055"></a><span id="l23.1055">   m_sortOrder = aSortOrder;</span>
<a href="#l23.1056"></a><span id="l23.1056">   m_viewFlags = aViewFlags;</span>
<a href="#l23.1057"></a><span id="l23.1057"> </span>
<a href="#l23.1058"></a><span id="l23.1058">   bool hasMore;</span>
<a href="#l23.1059"></a><span id="l23.1059">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l23.1060"></a><span id="l23.1060">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l23.1061"></a><span id="l23.1061">   nsresult rv = NS_OK;</span>
<a href="#l23.1062"></a><span id="l23.1062" class="difflineminus">-  while (NS_SUCCEEDED(rv = aHeaders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l23.1063"></a><span id="l23.1063" class="difflineminus">-  {</span>
<a href="#l23.1064"></a><span id="l23.1064" class="difflineplus">+  while (NS_SUCCEEDED(rv = aHeaders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l23.1065"></a><span id="l23.1065">     rv = aHeaders-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l23.1066"></a><span id="l23.1066" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l23.1067"></a><span id="l23.1067" class="difflineminus">-    {</span>
<a href="#l23.1068"></a><span id="l23.1068" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l23.1069"></a><span id="l23.1069">       msgHdr = do_QueryInterface(supports);</span>
<a href="#l23.1070"></a><span id="l23.1070">       AddHdr(msgHdr);</span>
<a href="#l23.1071"></a><span id="l23.1071" class="difflineminus">-    }</span>
<a href="#l23.1072"></a><span id="l23.1072" class="difflineminus">-    else</span>
<a href="#l23.1073"></a><span id="l23.1073" class="difflineplus">+    } else</span>
<a href="#l23.1074"></a><span id="l23.1074">       break;</span>
<a href="#l23.1075"></a><span id="l23.1075">   }</span>
<a href="#l23.1076"></a><span id="l23.1076">   *aCount = m_keys.Length();</span>
<a href="#l23.1077"></a><span id="l23.1077">   return rv;</span>
<a href="#l23.1078"></a><span id="l23.1078"> }</span>
<a href="#l23.1079"></a><span id="l23.1079"> </span>
<a href="#l23.1080"></a><span id="l23.1080" class="difflineminus">-NS_IMETHODIMP nsMsgQuickSearchDBView::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags)</span>
<a href="#l23.1081"></a><span id="l23.1081" class="difflineminus">-{</span>
<a href="#l23.1082"></a><span id="l23.1082" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::SetViewFlags(</span>
<a href="#l23.1083"></a><span id="l23.1083" class="difflineplus">+    nsMsgViewFlagsTypeValue aViewFlags) {</span>
<a href="#l23.1084"></a><span id="l23.1084">   nsresult rv = NS_OK;</span>
<a href="#l23.1085"></a><span id="l23.1085">   // if the grouping has changed, rebuild the view</span>
<a href="#l23.1086"></a><span id="l23.1086">   if ((m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) ^</span>
<a href="#l23.1087"></a><span id="l23.1087">       (aViewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l23.1088"></a><span id="l23.1088">     rv = RebuildView(aViewFlags);</span>
<a href="#l23.1089"></a><span id="l23.1089">   nsMsgDBView::SetViewFlags(aViewFlags);</span>
<a href="#l23.1090"></a><span id="l23.1090"> </span>
<a href="#l23.1091"></a><span id="l23.1091">   return rv;</span>
<a href="#l23.1092"></a><span id="l23.1092"> }</span>
<a href="#l23.1093"></a><span id="l23.1093"> </span>
<a href="#l23.1094"></a><span id="l23.1094" class="difflineminus">-nsresult</span>
<a href="#l23.1095"></a><span id="l23.1095" class="difflineminus">-nsMsgQuickSearchDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l23.1096"></a><span id="l23.1096" class="difflineminus">-{</span>
<a href="#l23.1097"></a><span id="l23.1097" class="difflineplus">+nsresult nsMsgQuickSearchDBView::GetMessageEnumerator(</span>
<a href="#l23.1098"></a><span id="l23.1098" class="difflineplus">+    nsISimpleEnumerator **enumerator) {</span>
<a href="#l23.1099"></a><span id="l23.1099">   return GetViewEnumerator(enumerator);</span>
<a href="#l23.1100"></a><span id="l23.1100"> }</span>
<a href="#l23.1101"></a><span id="l23.1101"> </span>
<a href="#l23.1102"></a><span id="l23.1102"> NS_IMETHODIMP</span>
<a href="#l23.1103"></a><span id="l23.1103"> nsMsgQuickSearchDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted,</span>
<a href="#l23.1104"></a><span id="l23.1104" class="difflineminus">-                                     nsMsgKey aParentKey,</span>
<a href="#l23.1105"></a><span id="l23.1105" class="difflineminus">-                                     int32_t aFlags,</span>
<a href="#l23.1106"></a><span id="l23.1106" class="difflineminus">-                                     nsIDBChangeListener *aInstigator)</span>
<a href="#l23.1107"></a><span id="l23.1107" class="difflineminus">-{</span>
<a href="#l23.1108"></a><span id="l23.1108" class="difflineplus">+                                     nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l23.1109"></a><span id="l23.1109" class="difflineplus">+                                     nsIDBChangeListener *aInstigator) {</span>
<a href="#l23.1110"></a><span id="l23.1110">   NS_ENSURE_ARG_POINTER(aHdrDeleted);</span>
<a href="#l23.1111"></a><span id="l23.1111">   nsMsgKey msgKey;</span>
<a href="#l23.1112"></a><span id="l23.1112">   aHdrDeleted-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.1113"></a><span id="l23.1113">   size_t keyIndex = m_origKeys.BinaryIndexOf(msgKey);</span>
<a href="#l23.1114"></a><span id="l23.1114" class="difflineminus">-  if (keyIndex != m_origKeys.NoIndex)</span>
<a href="#l23.1115"></a><span id="l23.1115" class="difflineminus">-    m_origKeys.RemoveElementAt(keyIndex);</span>
<a href="#l23.1116"></a><span id="l23.1116" class="difflineplus">+  if (keyIndex != m_origKeys.NoIndex) m_origKeys.RemoveElementAt(keyIndex);</span>
<a href="#l23.1117"></a><span id="l23.1117">   return nsMsgThreadedDBView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags,</span>
<a href="#l23.1118"></a><span id="l23.1118">                                            aInstigator);</span>
<a href="#l23.1119"></a><span id="l23.1119"> }</span>
<a href="#l23.1120"></a><span id="l23.1120"> </span>
<a href="#l23.1121"></a><span id="l23.1121" class="difflineminus">-NS_IMETHODIMP nsMsgQuickSearchDBView::GetNumMsgsInView(int32_t *aNumMsgs)</span>
<a href="#l23.1122"></a><span id="l23.1122" class="difflineminus">-{</span>
<a href="#l23.1123"></a><span id="l23.1123" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::GetNumMsgsInView(int32_t *aNumMsgs) {</span>
<a href="#l23.1124"></a><span id="l23.1124">   NS_ENSURE_ARG_POINTER(aNumMsgs);</span>
<a href="#l23.1125"></a><span id="l23.1125">   *aNumMsgs = m_origKeys.Length();</span>
<a href="#l23.1126"></a><span id="l23.1126">   return NS_OK;</span>
<a href="#l23.1127"></a><span id="l23.1127"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -9,25 +9,25 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nsMsgThreadedDBView.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsIMsgSearchNotify.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-class nsMsgQuickSearchDBView : public nsMsgThreadedDBView, public nsIMsgSearchNotify</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-{</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-public:</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+class nsMsgQuickSearchDBView : public nsMsgThreadedDBView,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+                               public nsIMsgSearchNotify {</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+ public:</span>
<a href="#l24.18"></a><span id="l24.18">   nsMsgQuickSearchDBView();</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l24.21"></a><span id="l24.21">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-  virtual const char * GetViewName(void) override {return &quot;QuickSearchView&quot;; }</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+  virtual const char *GetViewName(void) override { return &quot;QuickSearchView&quot;; }</span>
<a href="#l24.25"></a><span id="l24.25">   NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l24.26"></a><span id="l24.26">                   nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l24.27"></a><span id="l24.27">                   nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l24.28"></a><span id="l24.28">   NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l24.29"></a><span id="l24.29">                           nsMsgViewSortTypeValue aSortType,</span>
<a href="#l24.30"></a><span id="l24.30">                           nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l24.31"></a><span id="l24.31">                           nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l24.32"></a><span id="l24.32">                           int32_t *aCount) override;</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineat">@@ -38,50 +38,61 @@ public:</span>
<a href="#l24.34"></a><span id="l24.34">   NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l24.35"></a><span id="l24.35">                         nsIMessenger *aMessengerInstance,</span>
<a href="#l24.36"></a><span id="l24.36">                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l24.37"></a><span id="l24.37">                         nsIMsgDBViewCommandUpdater *aCmdUpdater) override;</span>
<a href="#l24.38"></a><span id="l24.38">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue aCommand) override;</span>
<a href="#l24.39"></a><span id="l24.39">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l24.40"></a><span id="l24.40">   NS_IMETHOD SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags) override;</span>
<a href="#l24.41"></a><span id="l24.41">   NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession) override;</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-  NS_IMETHOD GetSearchSession(nsIMsgSearchSession* *aSearchSession) override;</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+  NS_IMETHOD GetSearchSession(nsIMsgSearchSession **aSearchSession) override;</span>
<a href="#l24.44"></a><span id="l24.44">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-                               uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-                                  nsIDBChangeListener * aInstigator) override;</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+                               uint32_t aNewFlags,</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+                               nsIDBChangeListener *aInstigator) override;</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange,</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+                                  uint32_t *aStatus,</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+                                  nsIDBChangeListener *aInstigator) override;</span>
<a href="#l24.53"></a><span id="l24.53">   NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-                          int32_t aFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+                          int32_t aFlags,</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+                          nsIDBChangeListener *aInstigator) override;</span>
<a href="#l24.57"></a><span id="l24.57">   NS_IMETHOD GetNumMsgsInView(int32_t *aNumMsgs) override;</span>
<a href="#l24.58"></a><span id="l24.58"> </span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-protected:</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+ protected:</span>
<a href="#l24.61"></a><span id="l24.61">   virtual ~nsMsgQuickSearchDBView();</span>
<a href="#l24.62"></a><span id="l24.62">   nsWeakPtr m_searchSession;</span>
<a href="#l24.63"></a><span id="l24.63">   nsTArray&lt;nsMsgKey&gt; m_origKeys;</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-  bool      m_usingCachedHits;</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-  bool      m_cacheEmpty;</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-  nsCOMArray &lt;nsIMsgDBHdr&gt; m_hdrHits;</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-  virtual nsresult AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex = nullptr) override;</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool ensureListed) override;</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-  virtual nsresult DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices, bool deleteStorage) override;</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  virtual nsresult SortThreads(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder) override;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-  virtual nsresult GetFirstMessageHdrToDisplayInThread(nsIMsgThread *threadHdr, nsIMsgDBHdr **result) override;</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-  virtual nsresult ExpansionDelta(nsMsgViewIndex index, int32_t *expansionDelta) override;</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-  virtual nsresult ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-                                         nsIMutableArray *messageArray) override;</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-  virtual nsresult ListIdsInThread(nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex, uint32_t *pNumListed) override;</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+  bool m_usingCachedHits;</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+  bool m_cacheEmpty;</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+  nsCOMArray&lt;nsIMsgDBHdr&gt; m_hdrHits;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+  virtual nsresult AddHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+                          nsMsgViewIndex *resultIndex = nullptr) override;</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey,</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+                               bool ensureListed) override;</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+  virtual nsresult DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices,</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+                                  int32_t numIndices,</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+                                  bool deleteStorage) override;</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+  virtual nsresult SortThreads(nsMsgViewSortTypeValue sortType,</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+                               nsMsgViewSortOrderValue sortOrder) override;</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+  virtual nsresult GetFirstMessageHdrToDisplayInThread(</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+      nsIMsgThread *threadHdr, nsIMsgDBHdr **result) override;</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+  virtual nsresult ExpansionDelta(nsMsgViewIndex index,</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+                                  int32_t *expansionDelta) override;</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+  virtual nsresult ListCollapsedChildren(</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+      nsMsgViewIndex viewIndex, nsIMutableArray *messageArray) override;</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+  virtual nsresult ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+                                   nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+                                   uint32_t *pNumListed) override;</span>
<a href="#l24.97"></a><span id="l24.97">   virtual nsresult ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l24.98"></a><span id="l24.98">                                         nsMsgKey parentKey, uint32_t level,</span>
<a href="#l24.99"></a><span id="l24.99">                                         nsMsgViewIndex *viewIndex,</span>
<a href="#l24.100"></a><span id="l24.100">                                         uint32_t *pNumListed) override;</span>
<a href="#l24.101"></a><span id="l24.101">   virtual nsresult ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l24.102"></a><span id="l24.102">                                         nsMsgKey parentKey, uint32_t level,</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-                                        uint32_t callLevel,</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-                                        nsMsgKey keyToSkip,</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+                                        uint32_t callLevel, nsMsgKey keyToSkip,</span>
<a href="#l24.106"></a><span id="l24.106">                                         nsMsgViewIndex *viewIndex,</span>
<a href="#l24.107"></a><span id="l24.107">                                         uint32_t *pNumListed);</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-  virtual nsresult GetMessageEnumerator(nsISimpleEnumerator **enumerator) override;</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-  void      SavePreSearchInfo();</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-  void      ClearPreSearchInfo();</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+  virtual nsresult GetMessageEnumerator(</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+      nsISimpleEnumerator **enumerator) override;</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+  void SavePreSearchInfo();</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+  void ClearPreSearchInfo();</span>
<a href="#l24.116"></a><span id="l24.116"> };</span>
<a href="#l24.117"></a><span id="l24.117"> </span>
<a href="#l24.118"></a><span id="l24.118"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/src/nsMsgRDFUtils.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgRDFUtils.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -3,78 +3,75 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.5"></a><span id="l25.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;nsMsgRDFUtils.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;prprf.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> #include &quot;nsMemory.h&quot;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-nsresult createNode(const char16_t *str, nsIRDFNode **node, nsIRDFService *rdfService)</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-{</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+nsresult createNode(const char16_t *str, nsIRDFNode **node,</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+                    nsIRDFService *rdfService) {</span>
<a href="#l25.16"></a><span id="l25.16">   nsresult rv;</span>
<a href="#l25.17"></a><span id="l25.17">   nsCOMPtr&lt;nsIRDFLiteral&gt; value;</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19">   NS_ASSERTION(rdfService, &quot;rdfService is null&quot;);</span>
<a href="#l25.20"></a><span id="l25.20">   if (!rdfService) return NS_OK;</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22">   if (str) {</span>
<a href="#l25.23"></a><span id="l25.23">     rv = rdfService-&gt;GetLiteral(str, getter_AddRefs(value));</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-  }</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-  else {</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+  } else {</span>
<a href="#l25.27"></a><span id="l25.27">     rv = rdfService-&gt;GetLiteral(EmptyString().get(), getter_AddRefs(value));</span>
<a href="#l25.28"></a><span id="l25.28">   }</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l25.31"></a><span id="l25.31">     value.forget(node);</span>
<a href="#l25.32"></a><span id="l25.32">   }</span>
<a href="#l25.33"></a><span id="l25.33">   return rv;</span>
<a href="#l25.34"></a><span id="l25.34"> }</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-nsresult createIntNode(int32_t value, nsIRDFNode **node, nsIRDFService *rdfService)</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-{</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+nsresult createIntNode(int32_t value, nsIRDFNode **node,</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+                       nsIRDFService *rdfService) {</span>
<a href="#l25.40"></a><span id="l25.40">   *node = nullptr;</span>
<a href="#l25.41"></a><span id="l25.41">   nsresult rv;</span>
<a href="#l25.42"></a><span id="l25.42">   if (!rdfService) return NS_ERROR_NULL_POINTER;</span>
<a href="#l25.43"></a><span id="l25.43">   nsCOMPtr&lt;nsIRDFInt&gt; num;</span>
<a href="#l25.44"></a><span id="l25.44">   rv = rdfService-&gt;GetIntLiteral(value, getter_AddRefs(num));</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-  if(NS_SUCCEEDED(rv)) {</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l25.47"></a><span id="l25.47">     num.forget(node);</span>
<a href="#l25.48"></a><span id="l25.48">   }</span>
<a href="#l25.49"></a><span id="l25.49">   return rv;</span>
<a href="#l25.50"></a><span id="l25.50"> }</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-nsresult createBlobNode(uint8_t *value, uint32_t &amp;length, nsIRDFNode **node, nsIRDFService *rdfService)</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-{</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+nsresult createBlobNode(uint8_t *value, uint32_t &amp;length, nsIRDFNode **node,</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+                        nsIRDFService *rdfService) {</span>
<a href="#l25.56"></a><span id="l25.56">   NS_ENSURE_ARG_POINTER(node);</span>
<a href="#l25.57"></a><span id="l25.57">   NS_ENSURE_ARG_POINTER(rdfService);</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59">   *node = nullptr;</span>
<a href="#l25.60"></a><span id="l25.60">   nsCOMPtr&lt;nsIRDFBlob&gt; blob;</span>
<a href="#l25.61"></a><span id="l25.61">   nsresult rv = rdfService-&gt;GetBlobLiteral(value, length, getter_AddRefs(blob));</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.64"></a><span id="l25.64">   blob.forget(node);</span>
<a href="#l25.65"></a><span id="l25.65">   return rv;</span>
<a href="#l25.66"></a><span id="l25.66"> }</span>
<a href="#l25.67"></a><span id="l25.67"> </span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource, nsIRDFResource* folderResource,</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-                               nsIRDFResource *property,bool tv, nsIRDFNode *target,bool* hasAssertion)</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-{</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource,</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+                               nsIRDFResource *folderResource,</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+                               nsIRDFResource *property, bool tv,</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+                               nsIRDFNode *target, bool *hasAssertion) {</span>
<a href="#l25.75"></a><span id="l25.75">   NS_ENSURE_ARG_POINTER(hasAssertion);</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77">   nsCOMPtr&lt;nsIRDFNode&gt; currentTarget;</span>
<a href="#l25.78"></a><span id="l25.78"> </span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-  nsresult rv = dataSource-&gt;GetTarget(folderResource, property,tv, getter_AddRefs(currentTarget));</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-  {</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+  nsresult rv = dataSource-&gt;GetTarget(folderResource, property, tv,</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+                                      getter_AddRefs(currentTarget));</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l25.85"></a><span id="l25.85">     nsCOMPtr&lt;nsIRDFLiteral&gt; value1(do_QueryInterface(target));</span>
<a href="#l25.86"></a><span id="l25.86">     nsCOMPtr&lt;nsIRDFLiteral&gt; value2(do_QueryInterface(currentTarget));</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    if(value1 &amp;&amp; value2)</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-      //If the two values are equal then it has this assertion</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+    if (value1 &amp;&amp; value2)</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+      // If the two values are equal then it has this assertion</span>
<a href="#l25.91"></a><span id="l25.91">       *hasAssertion = (value1 == value2);</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-  }</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-  else</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+  } else</span>
<a href="#l25.95"></a><span id="l25.95">     rv = NS_NOINTERFACE;</span>
<a href="#l25.96"></a><span id="l25.96"> </span>
<a href="#l25.97"></a><span id="l25.97">   return rv;</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-</span>
<a href="#l25.99"></a><span id="l25.99"> }</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/src/nsMsgRDFUtils.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgRDFUtils.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l26.5"></a><span id="l26.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.7"></a><span id="l26.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-// This file holds some useful utility functions and declarations used by our datasources.</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+// This file holds some useful utility functions and declarations used by our</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+// datasources.</span>
<a href="#l26.12"></a><span id="l26.12"> </span>
<a href="#l26.13"></a><span id="l26.13"> #include &quot;rdf.h&quot;</span>
<a href="#l26.14"></a><span id="l26.14"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15"> #include &quot;nsIRDFNode.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16"> #include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18"> #include &quot;nsString.h&quot;</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20" class="difflineat">@@ -16,16 +17,17 @@</span>
<a href="#l26.21"></a><span id="l26.21"> typedef struct _nsMsgRDFNotification {</span>
<a href="#l26.22"></a><span id="l26.22">   nsIRDFDataSource *datasource;</span>
<a href="#l26.23"></a><span id="l26.23">   nsIRDFResource *subject;</span>
<a href="#l26.24"></a><span id="l26.24">   nsIRDFResource *property;</span>
<a href="#l26.25"></a><span id="l26.25">   nsIRDFNode *newObject;</span>
<a href="#l26.26"></a><span id="l26.26">   nsIRDFNode *oldObject;</span>
<a href="#l26.27"></a><span id="l26.27"> } nsMsgRDFNotification;</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+// clang-format off</span>
<a href="#l26.30"></a><span id="l26.30"> // Some property declarations</span>
<a href="#l26.31"></a><span id="l26.31"> #define NC_RDF_CHILD                        NC_NAMESPACE_URI &quot;child&quot;</span>
<a href="#l26.32"></a><span id="l26.32"> #define NC_RDF_NAME                         NC_NAMESPACE_URI &quot;Name&quot;</span>
<a href="#l26.33"></a><span id="l26.33"> #define NC_RDF_OPEN                         NC_NAMESPACE_URI &quot;open&quot;</span>
<a href="#l26.34"></a><span id="l26.34"> #define NC_RDF_FOLDERTREENAME               NC_NAMESPACE_URI &quot;FolderTreeName&quot;</span>
<a href="#l26.35"></a><span id="l26.35"> #define NC_RDF_FOLDERTREESIMPLENAME         NC_NAMESPACE_URI &quot;FolderTreeSimpleName&quot;</span>
<a href="#l26.36"></a><span id="l26.36"> #define NC_RDF_FOLDER                       NC_NAMESPACE_URI &quot;Folder&quot;</span>
<a href="#l26.37"></a><span id="l26.37"> #define NC_RDF_SPECIALFOLDER                NC_NAMESPACE_URI &quot;SpecialFolder&quot;</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineat">@@ -80,23 +82,28 @@ typedef struct _nsMsgRDFNotification {</span>
<a href="#l26.39"></a><span id="l26.39"> #define NC_RDF_MOVE                         NC_NAMESPACE_URI &quot;Move&quot;</span>
<a href="#l26.40"></a><span id="l26.40"> #define NC_RDF_COPYFOLDER                   NC_NAMESPACE_URI &quot;CopyFolder&quot;</span>
<a href="#l26.41"></a><span id="l26.41"> #define NC_RDF_MOVEFOLDER                   NC_NAMESPACE_URI &quot;MoveFolder&quot;</span>
<a href="#l26.42"></a><span id="l26.42"> #define NC_RDF_MARKALLMESSAGESREAD          NC_NAMESPACE_URI &quot;MarkAllMessagesRead&quot;</span>
<a href="#l26.43"></a><span id="l26.43"> #define NC_RDF_COMPACT                      NC_NAMESPACE_URI &quot;Compact&quot;</span>
<a href="#l26.44"></a><span id="l26.44"> #define NC_RDF_COMPACTALL                   NC_NAMESPACE_URI &quot;CompactAll&quot;</span>
<a href="#l26.45"></a><span id="l26.45"> #define NC_RDF_RENAME                       NC_NAMESPACE_URI &quot;Rename&quot;</span>
<a href="#l26.46"></a><span id="l26.46"> #define NC_RDF_EMPTYTRASH                   NC_NAMESPACE_URI &quot;EmptyTrash&quot;</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+// clang-format on</span>
<a href="#l26.49"></a><span id="l26.49"> </span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-nsresult createNode(const char16_t *str, nsIRDFNode **, nsIRDFService *rdfService);</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+nsresult createNode(const char16_t *str, nsIRDFNode **,</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+                    nsIRDFService *rdfService);</span>
<a href="#l26.53"></a><span id="l26.53"> </span>
<a href="#l26.54"></a><span id="l26.54"> // Given an int32_t creates an nsIRDFNode that is really an int literal.</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-nsresult createIntNode(int32_t value, nsIRDFNode **node, nsIRDFService *rdfService);</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+nsresult createIntNode(int32_t value, nsIRDFNode **node,</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+                       nsIRDFService *rdfService);</span>
<a href="#l26.58"></a><span id="l26.58"> </span>
<a href="#l26.59"></a><span id="l26.59"> // Given an nsIRDFBlob creates an nsIRDFNode that is really an blob literal.</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-nsresult createBlobNode(uint8_t *value, uint32_t &amp;length,  nsIRDFNode **node, nsIRDFService *rdfService);</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+nsresult createBlobNode(uint8_t *value, uint32_t &amp;length, nsIRDFNode **node,</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+                        nsIRDFService *rdfService);</span>
<a href="#l26.63"></a><span id="l26.63"> </span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-// Assertion for a datasource that will just call GetTarget on property.  When all of our</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-// datasources derive from our datasource baseclass, this should be moved there and the first</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-// parameter will no longer be needed.</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource, nsIRDFResource* folderResource,</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-                 nsIRDFResource *property,bool tv, nsIRDFNode *target,bool* hasAssertion);</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+// Assertion for a datasource that will just call GetTarget on property.  When</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+// all of our datasources derive from our datasource baseclass, this should be</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+// moved there and the first parameter will no longer be needed.</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource,</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+                               nsIRDFResource *folderResource,</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+                               nsIRDFResource *property, bool tv,</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+                               nsIRDFNode *target, bool *hasAssertion);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

