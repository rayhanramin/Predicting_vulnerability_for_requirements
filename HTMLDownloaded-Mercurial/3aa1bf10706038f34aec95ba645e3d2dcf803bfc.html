<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2393:3aa1bf10706038f34aec95ba645e3d2dcf803bfc</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3aa1bf10706038f34aec95ba645e3d2dcf803bfc" />
<meta property="og:url" content="/comm-central/rev/3aa1bf10706038f34aec95ba645e3d2dcf803bfc" />
<meta property="og:description" content="Bug 422814 - autoconfig js cleanup, r=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3aa1bf10706038f34aec95ba645e3d2dcf803bfc 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3aa1bf10706038f34aec95ba645e3d2dcf803bfc">shortlog</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3aa1bf10706038f34aec95ba645e3d2dcf803bfc">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc">files</a> |
changeset |
<a href="/comm-central/raw-rev/3aa1bf10706038f34aec95ba645e3d2dcf803bfc">raw</a>  | <a href="/comm-central/archive/3aa1bf10706038f34aec95ba645e3d2dcf803bfc.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=422814">Bug 422814</a> - autoconfig js cleanup, r=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#32;&#82;&#105;&#110;&#103;&#110;&#97;&#108;&#100;&#97;&#32;&#60;&#112;&#104;&#105;&#108;&#114;&#105;&#110;&#103;&#110;&#97;&#108;&#100;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 15 Apr 2009 07:51:47 -0700</td></tr>

<tr>
 <td>changeset 2393</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3aa1bf10706038f34aec95ba645e3d2dcf803bfc">3aa1bf10706038f34aec95ba645e3d2dcf803bfc</a></td>
</tr>



<tr>
<td>parent 2392</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8885d1e05ac891cc1496f71f63e6f5ee317b5d54">8885d1e05ac891cc1496f71f63e6f5ee317b5d54</a>
</td>
</tr>

<tr>
<td>child 2394</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0947f535d9274207364331dbee88094f76df6686">0947f535d9274207364331dbee88094f76df6686</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3aa1bf10706038f34aec95ba645e3d2dcf803bfc">1943</a></td></tr>
<tr><td>push user</td><td>philringnalda@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 15 Apr 2009 14:52:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f525b7b9b3f5 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f525b7b9b3f5a2b84c51440763d8f16d9480fea0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f525b7b9b3f5a2b84c51440763d8f16d9480fea0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f525b7b9b3f5a2b84c51440763d8f16d9480fea0&newProject=comm-central&newRevision=3aa1bf10706038f34aec95ba645e3d2dcf803bfc&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f525b7b9b3f5a2b84c51440763d8f16d9480fea0&newProject=comm-central&newRevision=3aa1bf10706038f34aec95ba645e3d2dcf803bfc&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f525b7b9b3f5a2b84c51440763d8f16d9480fea0&newProject=comm-central&newRevision=3aa1bf10706038f34aec95ba645e3d2dcf803bfc&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=422814">422814</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=422814">Bug 422814</a> - autoconfig js cleanup, r=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">mailnews/base/prefs/resources/content/accountcreation/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">mailnews/base/prefs/resources/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">mailnews/base/prefs/resources/content/accountcreation/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">mailnews/base/prefs/resources/content/accountcreation/readFromXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/util.js">mailnews/base/prefs/resources/content/accountcreation/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/util.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/util.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/util.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/util.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/util.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/3aa1bf10706038f34aec95ba645e3d2dcf803bfc/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -167,17 +167,17 @@ function createAccountInBackend(config)</span>
<a href="#l1.4"></a><span id="l1.4">   var account = accountManager.createAccount();</span>
<a href="#l1.5"></a><span id="l1.5">   account.incomingServer = inServer;</span>
<a href="#l1.6"></a><span id="l1.6">   account.addIdentity(identity);</span>
<a href="#l1.7"></a><span id="l1.7">   if (!accountManager.defaultAccount)</span>
<a href="#l1.8"></a><span id="l1.8">     accountManager.defaultAccount = account;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   if (config.outgoing.existingServerKey)</span>
<a href="#l1.11"></a><span id="l1.11">     identity.smtpServerKey = config.outgoing.existingServerKey;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  else if ( ! config.outgoing.useGlobalPreferredServer)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  else if (!config.outgoing.useGlobalPreferredServer)</span>
<a href="#l1.14"></a><span id="l1.14">     identity.smtpServerKey = outServer.key;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   setFolders(identity, inServer);</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">   // save</span>
<a href="#l1.19"></a><span id="l1.19">   accountManager.saveAccountInfo();</span>
<a href="#l1.20"></a><span id="l1.20">   try {</span>
<a href="#l1.21"></a><span id="l1.21">     Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -352,17 +352,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l2.4"></a><span id="l2.4">             gEmailWizardLogger.info(&quot;progress callback host &quot; + hostname +</span>
<a href="#l2.5"></a><span id="l2.5">                                     &quot;port &quot; +  port + &quot; type &quot; + type);</span>
<a href="#l2.6"></a><span id="l2.6">             if (type == &quot;imap&quot; || type == &quot;pop3&quot;)</span>
<a href="#l2.7"></a><span id="l2.7">             {</span>
<a href="#l2.8"></a><span id="l2.8">               config.incoming.type = type;</span>
<a href="#l2.9"></a><span id="l2.9">               config.incoming.hostname = hostname;</span>
<a href="#l2.10"></a><span id="l2.10">               config.incoming.port = port;</span>
<a href="#l2.11"></a><span id="l2.11">               config.incoming.socketType = ssl;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-              config.incoming._inprogress = ! done; // XXX not nice to change the AccountConfig object</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+              config.incoming._inprogress = !done; // XXX not nice to change the AccountConfig object</span>
<a href="#l2.14"></a><span id="l2.14">             }</span>
<a href="#l2.15"></a><span id="l2.15">             else if (type == &quot;smtp&quot; &amp;&amp; !me._userPickedOutgoingServer)</span>
<a href="#l2.16"></a><span id="l2.16">             {</span>
<a href="#l2.17"></a><span id="l2.17">               dump(&quot;setting outgoing hostname to &quot; + hostname + &quot;\n&quot;);</span>
<a href="#l2.18"></a><span id="l2.18">               config.outgoing.hostname = hostname;</span>
<a href="#l2.19"></a><span id="l2.19">               config.outgoing.port = port;</span>
<a href="#l2.20"></a><span id="l2.20">               config.outgoing.socketType = ssl;</span>
<a href="#l2.21"></a><span id="l2.21">               config.outgoing._inprogress = !done;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -1482,17 +1482,17 @@ var gCustomFieldsDialog = null;</span>
<a href="#l2.23"></a><span id="l2.23"> * @param enableURLs {Array}   @see AccountConfig.enableURLs</span>
<a href="#l2.24"></a><span id="l2.24"> * @param alreadyVisited {Object}  Map of: URL {String} -&gt; bool</span>
<a href="#l2.25"></a><span id="l2.25"> * URLs that the user has already visited in a previous run of the dialog.</span>
<a href="#l2.26"></a><span id="l2.26"> * May be null.</span>
<a href="#l2.27"></a><span id="l2.27"> *</span>
<a href="#l2.28"></a><span id="l2.28"> */</span>
<a href="#l2.29"></a><span id="l2.29"> function EnableURLsDialog(enableURLs, alreadyVisited)</span>
<a href="#l2.30"></a><span id="l2.30"> {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  if ( ! alreadyVisited)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  if (!alreadyVisited)</span>
<a href="#l2.33"></a><span id="l2.33">     alreadyVisited = {};</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   this._visitedURLs = alreadyVisited;</span>
<a href="#l2.36"></a><span id="l2.36"> }</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38"> EnableURLsDialog.prototype =</span>
<a href="#l2.39"></a><span id="l2.39"> {</span>
<a href="#l2.40"></a><span id="l2.40">   /**</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -1500,17 +1500,17 @@ EnableURLsDialog.prototype =</span>
<a href="#l2.42"></a><span id="l2.42">    * @param successCallback, cancelCallback @see open()</span>
<a href="#l2.43"></a><span id="l2.43">    */</span>
<a href="#l2.44"></a><span id="l2.44">   openIfNeeded : function(successCallback, cancelCallback)</span>
<a href="#l2.45"></a><span id="l2.45">   {</span>
<a href="#l2.46"></a><span id="l2.46">     var needVisits = false;</span>
<a href="#l2.47"></a><span id="l2.47">     for (var i = 0; i &lt; this._enableURLs.length; i++)</span>
<a href="#l2.48"></a><span id="l2.48">     {</span>
<a href="#l2.49"></a><span id="l2.49">       let url = this._enableURLs[i].url;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      if ( ! this._visitedURLs[url])</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      if (!this._visitedURLs[url])</span>
<a href="#l2.52"></a><span id="l2.52">         needVisits = true;</span>
<a href="#l2.53"></a><span id="l2.53">     }</span>
<a href="#l2.54"></a><span id="l2.54">     if (!needVisits)</span>
<a href="#l2.55"></a><span id="l2.55">     {</span>
<a href="#l2.56"></a><span id="l2.56">       successCallback(this._visitedURLs);</span>
<a href="#l2.57"></a><span id="l2.57">       return;</span>
<a href="#l2.58"></a><span id="l2.58">     }</span>
<a href="#l2.59"></a><span id="l2.59"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -31,17 +31,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.5"></a><span id="l3.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.6"></a><span id="l3.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.7"></a><span id="l3.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.8"></a><span id="l3.8">  *</span>
<a href="#l3.9"></a><span id="l3.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> /**</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- * Tries to find a configuration for this ISP on the local harddisk, in the TB install folder.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Tries to find a configuration for this ISP on the local harddisk, in the</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * application install directory's &quot;isp&quot; subdirectory.</span>
<a href="#l3.15"></a><span id="l3.15">  * Params @see fetchConfigFromISP()</span>
<a href="#l3.16"></a><span id="l3.16">  */</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> function fetchConfigFromDisk(domain, successCallback, errorCallback)</span>
<a href="#l3.19"></a><span id="l3.19"> {</span>
<a href="#l3.20"></a><span id="l3.20">   return new TimeoutAbortable(runAsync(function()</span>
<a href="#l3.21"></a><span id="l3.21">   {</span>
<a href="#l3.22"></a><span id="l3.22">     try {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -65,39 +66,43 @@ function fetchConfigFromDisk(domain, suc</span>
<a href="#l3.24"></a><span id="l3.24">  *         The AccountConfig object will be passed in as first parameter.</span>
<a href="#l3.25"></a><span id="l3.25">  * @param errorCallback {Function(ex)}   A callback that</span>
<a href="#l3.26"></a><span id="l3.26">  *         will be called when we could not retrieve a configuration,</span>
<a href="#l3.27"></a><span id="l3.27">  *         for whatever reason. This is expected (e.g. when there's no config</span>
<a href="#l3.28"></a><span id="l3.28">  *         for this domain at this location), so do not unconditionally show this to the user.</span>
<a href="#l3.29"></a><span id="l3.29">  *         The first paramter will be an exception object or error string.</span>
<a href="#l3.30"></a><span id="l3.30">  */</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-function fetchConfigFromISP(domain, emailAddress, successCallback, errorCallback)</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+function fetchConfigFromISP(domain, emailAddress, successCallback,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+                            errorCallback)</span>
<a href="#l3.35"></a><span id="l3.35"> {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  let url = &quot;https://autoconfig.&quot; + sanitize.hostname(domain) + &quot;/mail/mozilla.xml&quot;;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  let url = &quot;https://autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+            &quot;/mail/mozilla.xml&quot;;</span>
<a href="#l3.39"></a><span id="l3.39">   let fetch = new FetchHTTP(url, { emailaddress: emailAddress }, false,</span>
<a href="#l3.40"></a><span id="l3.40">                             function(result)</span>
<a href="#l3.41"></a><span id="l3.41">                             {</span>
<a href="#l3.42"></a><span id="l3.42">                               successCallback(readFromXML(result));</span>
<a href="#l3.43"></a><span id="l3.43">                             },</span>
<a href="#l3.44"></a><span id="l3.44">                             errorCallback);</span>
<a href="#l3.45"></a><span id="l3.45">   fetch.start();</span>
<a href="#l3.46"></a><span id="l3.46">   return fetch;</span>
<a href="#l3.47"></a><span id="l3.47"> }</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49"> /**</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">- * Tries to get a configuration for this ISP from a central database at Mozilla servers.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+ * Tries to get a configuration for this ISP from a central database at</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+ * Mozilla servers.</span>
<a href="#l3.53"></a><span id="l3.53">  * Params @see fetchConfigFromISP()</span>
<a href="#l3.54"></a><span id="l3.54">  */</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56"> function fetchConfigFromDB(domain, successCallback, errorCallback)</span>
<a href="#l3.57"></a><span id="l3.57"> {</span>
<a href="#l3.58"></a><span id="l3.58">   let pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.59"></a><span id="l3.59">                                .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  let url = pref.getCharPref(&quot;mailnews.auto_config_url&quot;) + sanitize.hostname(domain);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  let url = pref.getCharPref(&quot;mailnews.auto_config_url&quot;) +</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+            sanitize.hostname(domain);</span>
<a href="#l3.63"></a><span id="l3.63">   if (!url.length)</span>
<a href="#l3.64"></a><span id="l3.64">     return errorCallback(&quot;no fetch url set&quot;);</span>
<a href="#l3.65"></a><span id="l3.65">   let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l3.66"></a><span id="l3.66">                             function(result)</span>
<a href="#l3.67"></a><span id="l3.67">                             {</span>
<a href="#l3.68"></a><span id="l3.68">                               successCallback(readFromXML(result));</span>
<a href="#l3.69"></a><span id="l3.69">                             },</span>
<a href="#l3.70"></a><span id="l3.70">                             errorCallback);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -94,24 +94,24 @@</span>
<a href="#l4.4"></a><span id="l4.4">  *   The values will be urlComponentEncoded, so pass them unencoded.</span>
<a href="#l4.5"></a><span id="l4.5">  *   This cannot be used together with |uploadBody|.</span>
<a href="#l4.6"></a><span id="l4.6">  * @param uploadbody {Object}   Arbitrary object, which to use as</span>
<a href="#l4.7"></a><span id="l4.7">  *   body of the HTTP request. Will also set the mimetype accordingly.</span>
<a href="#l4.8"></a><span id="l4.8">  *   Only supported object types, currently only E4X is supported</span>
<a href="#l4.9"></a><span id="l4.9">  *   (sending XML).</span>
<a href="#l4.10"></a><span id="l4.10">  *   Usually, you have nothing to upload, so just pass |null|.</span>
<a href="#l4.11"></a><span id="l4.11">  */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function FetchHTTP(url, urlArgs, post,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                   successCallback, errorCallback)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+function FetchHTTP(url, urlArgs, post, successCallback, errorCallback)</span>
<a href="#l4.15"></a><span id="l4.15"> {</span>
<a href="#l4.16"></a><span id="l4.16">   assert(typeof(successCallback) == &quot;function&quot;, &quot;BUG: successCallback&quot;);</span>
<a href="#l4.17"></a><span id="l4.17">   assert(typeof(errorCallback) == &quot;function&quot;, &quot;BUG: errorCallback&quot;);</span>
<a href="#l4.18"></a><span id="l4.18">   this._url = sanitize.string(url);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-  if ( ! urlArgs)</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  if (!urlArgs)</span>
<a href="#l4.21"></a><span id="l4.21">     urlArgs = {};</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+</span>
<a href="#l4.23"></a><span id="l4.23">   this._urlArgs = urlArgs;</span>
<a href="#l4.24"></a><span id="l4.24">   this._post = sanitize.boolean(post);</span>
<a href="#l4.25"></a><span id="l4.25">   this._successCallback = successCallback;</span>
<a href="#l4.26"></a><span id="l4.26">   this._errorCallback = errorCallback;</span>
<a href="#l4.27"></a><span id="l4.27"> }</span>
<a href="#l4.28"></a><span id="l4.28"> FetchHTTP.prototype =</span>
<a href="#l4.29"></a><span id="l4.29"> {</span>
<a href="#l4.30"></a><span id="l4.30">   _url : null, // URL as passed to ctor, without arguments</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineat">@@ -143,29 +143,29 @@ FetchHTTP.prototype =</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33">     var me = this;</span>
<a href="#l4.34"></a><span id="l4.34">     request.onload = function() { me._response(true); }</span>
<a href="#l4.35"></a><span id="l4.35">     request.onerror = function() { me._response(false); }</span>
<a href="#l4.36"></a><span id="l4.36">     request.send(null);</span>
<a href="#l4.37"></a><span id="l4.37">   },</span>
<a href="#l4.38"></a><span id="l4.38">   _response : function(success, exStored)</span>
<a href="#l4.39"></a><span id="l4.39">   {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    try {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    try</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    {</span>
<a href="#l4.44"></a><span id="l4.44">     var errorCode = null;</span>
<a href="#l4.45"></a><span id="l4.45">     var errorStr = null;</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">     if (success &amp;&amp; this._request.status &gt;= 200 &amp;&amp;</span>
<a href="#l4.48"></a><span id="l4.48">         this._request.status &lt; 300) // HTTP level success</span>
<a href="#l4.49"></a><span id="l4.49">     {</span>
<a href="#l4.50"></a><span id="l4.50">       try</span>
<a href="#l4.51"></a><span id="l4.51">       {</span>
<a href="#l4.52"></a><span id="l4.52">         // response</span>
<a href="#l4.53"></a><span id="l4.53">         var mimetype = this._request.getResponseHeader(&quot;Content-Type&quot;);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-        if ( ! mimetype)</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+        if (!mimetype)</span>
<a href="#l4.56"></a><span id="l4.56">           mimetype = &quot;&quot;;</span>
<a href="#l4.57"></a><span id="l4.57">         mimetype = mimetype.split(&quot;;&quot;)[0];</span>
<a href="#l4.58"></a><span id="l4.58">         if (mimetype == &quot;text/xml&quot; ||</span>
<a href="#l4.59"></a><span id="l4.59">             mimetype == &quot;application/xml&quot; ||</span>
<a href="#l4.60"></a><span id="l4.60">             mimetype == &quot;text/rdf&quot;)</span>
<a href="#l4.61"></a><span id="l4.61">         {</span>
<a href="#l4.62"></a><span id="l4.62">           // Bug 270553 prevents usage of .responseXML</span>
<a href="#l4.63"></a><span id="l4.63">           var text = this._request.responseText;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineat">@@ -178,32 +178,33 @@ FetchHTTP.prototype =</span>
<a href="#l4.65"></a><span id="l4.65">           //ddump(&quot;mimetype: &quot; + mimetype + &quot; only supported as text&quot;);</span>
<a href="#l4.66"></a><span id="l4.66">           this.result = this._request.responseText;</span>
<a href="#l4.67"></a><span id="l4.67">         }</span>
<a href="#l4.68"></a><span id="l4.68">         //ddump(&quot;result:\n&quot; + this.result);</span>
<a href="#l4.69"></a><span id="l4.69">       }</span>
<a href="#l4.70"></a><span id="l4.70">       catch (e)</span>
<a href="#l4.71"></a><span id="l4.71">       {</span>
<a href="#l4.72"></a><span id="l4.72">         success = false;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-        var stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationUtil.properties&quot;);</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+        let stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationUtil.properties&quot;);</span>
<a href="#l4.75"></a><span id="l4.75">         errorStr = stringBundle.GetStringFromName(&quot;bad_response_content.error&quot;);</span>
<a href="#l4.76"></a><span id="l4.76">         errorCode = -4;</span>
<a href="#l4.77"></a><span id="l4.77">       }</span>
<a href="#l4.78"></a><span id="l4.78">     }</span>
<a href="#l4.79"></a><span id="l4.79">     else</span>
<a href="#l4.80"></a><span id="l4.80">     {</span>
<a href="#l4.81"></a><span id="l4.81">       success = false;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-      try {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+      try</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+      {</span>
<a href="#l4.85"></a><span id="l4.85">         errorCode = this._request.status;</span>
<a href="#l4.86"></a><span id="l4.86">         errorStr = this._request.statusText;</span>
<a href="#l4.87"></a><span id="l4.87">       } catch (e) {</span>
<a href="#l4.88"></a><span id="l4.88">         // If we can't resolve the hostname in DNS etc., .statusText throws</span>
<a href="#l4.89"></a><span id="l4.89">         errorCode = -2;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-        errorStr = getStringBundle(&quot;chrome://messenger/content/accountCreationUtil.properties&quot;)</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-                        .GetStringFromName(&quot;cannot_contact_server.error&quot;);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+        let stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationUtil.properties&quot;)</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+        errorStr = stringBundle.GetStringFromName(&quot;cannot_contact_server.error&quot;);</span>
<a href="#l4.94"></a><span id="l4.94">         ddump(errorStr);</span>
<a href="#l4.95"></a><span id="l4.95">       }</span>
<a href="#l4.96"></a><span id="l4.96">     }</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">     // Callbacks</span>
<a href="#l4.99"></a><span id="l4.99">     if (success)</span>
<a href="#l4.100"></a><span id="l4.100">       this._successCallback(this.result);</span>
<a href="#l4.101"></a><span id="l4.101">     else if (exStored)</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineat">@@ -211,56 +212,58 @@ FetchHTTP.prototype =</span>
<a href="#l4.103"></a><span id="l4.103">     else</span>
<a href="#l4.104"></a><span id="l4.104">       this._errorCallback(new ServerException(errorStr, errorCode, this._url));</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">     if (this._finishedCallback)</span>
<a href="#l4.107"></a><span id="l4.107">       this._finishedCallback(this);</span>
<a href="#l4.108"></a><span id="l4.108"> </span>
<a href="#l4.109"></a><span id="l4.109">     } catch (e) {</span>
<a href="#l4.110"></a><span id="l4.110">       // error in callback or our fetchhttp._response() code</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-      try {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+      try</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+      {</span>
<a href="#l4.114"></a><span id="l4.114">         ddump(&quot;Error in errorCallback or _response(): &quot; + e);</span>
<a href="#l4.115"></a><span id="l4.115">         this._errorCallback(e);</span>
<a href="#l4.116"></a><span id="l4.116">       } catch (e) {</span>
<a href="#l4.117"></a><span id="l4.117">         //ddump(&quot;Error in errorCallback: &quot; + e);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+        // XXX TODO FIXME BOGUS</span>
<a href="#l4.119"></a><span id="l4.119">         alert(e); // error in errorCallback, too!</span>
<a href="#l4.120"></a><span id="l4.120">         throw(e); // to error console</span>
<a href="#l4.121"></a><span id="l4.121">       }</span>
<a href="#l4.122"></a><span id="l4.122">     }</span>
<a href="#l4.123"></a><span id="l4.123">   },</span>
<a href="#l4.124"></a><span id="l4.124">   /**</span>
<a href="#l4.125"></a><span id="l4.125">    * Call this between start() and finishedCallback fired.</span>
<a href="#l4.126"></a><span id="l4.126">    */</span>
<a href="#l4.127"></a><span id="l4.127">   cancel : function(ex)</span>
<a href="#l4.128"></a><span id="l4.128">   {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-    assert( ! this.result, &quot;Call already returned&quot;);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    assert(!this.result, &quot;Call already returned&quot;);</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">     this._request.abort();</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">     // Need to manually call error handler</span>
<a href="#l4.135"></a><span id="l4.135">     // &lt;https://bugzilla.mozilla.org/show_bug.cgi?id=218236#c11&gt;</span>
<a href="#l4.136"></a><span id="l4.136">     this._response(false, ex ? ex : new UserCancelledException());</span>
<a href="#l4.137"></a><span id="l4.137">   },</span>
<a href="#l4.138"></a><span id="l4.138">   /**</span>
<a href="#l4.139"></a><span id="l4.139">    * Allows caller or lib to be notified when the call is done.</span>
<a href="#l4.140"></a><span id="l4.140">    * This is useful to enable and disable a Cancel button in the UI,</span>
<a href="#l4.141"></a><span id="l4.141">    * which allows to cancel the network request.</span>
<a href="#l4.142"></a><span id="l4.142">    */</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-  setFinishedCallback : function (finishedCallback)</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+  setFinishedCallback : function(finishedCallback)</span>
<a href="#l4.145"></a><span id="l4.145">   {</span>
<a href="#l4.146"></a><span id="l4.146">     this._finishedCallback = finishedCallback;</span>
<a href="#l4.147"></a><span id="l4.147">   }</span>
<a href="#l4.148"></a><span id="l4.148"> }</span>
<a href="#l4.149"></a><span id="l4.149"> extend(FetchHTTP, Abortable);</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151"> function UserCancelledException(msg)</span>
<a href="#l4.152"></a><span id="l4.152"> {</span>
<a href="#l4.153"></a><span id="l4.153">   // The user knows they cancelled so I don't see a need</span>
<a href="#l4.154"></a><span id="l4.154">   // for a message to that effect.</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-  if ( ! msg)</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  if (!msg)</span>
<a href="#l4.157"></a><span id="l4.157">     msg = &quot;&quot;;</span>
<a href="#l4.158"></a><span id="l4.158">   Exception.call(this, msg);</span>
<a href="#l4.159"></a><span id="l4.159"> }</span>
<a href="#l4.160"></a><span id="l4.160"> UserCancelledException.prototype =</span>
<a href="#l4.161"></a><span id="l4.161"> {</span>
<a href="#l4.162"></a><span id="l4.162"> }</span>
<a href="#l4.163"></a><span id="l4.163"> extend(UserCancelledException, Exception);</span>
<a href="#l4.164"></a><span id="l4.164"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -32,18 +32,18 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.5"></a><span id="l5.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.6"></a><span id="l5.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.7"></a><span id="l5.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.8"></a><span id="l5.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.9"></a><span id="l5.9">  *</span>
<a href="#l5.10"></a><span id="l5.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var gOverrideService = Components.classes[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                            .getService(Components.interfaces.nsICertOverrideService);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+var gOverrideService = Cc[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                       .getService(Ci.nsICertOverrideService);</span>
<a href="#l5.16"></a><span id="l5.16"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> // Protocol Types</span>
<a href="#l5.19"></a><span id="l5.19"> const UNKNOWN = -1;</span>
<a href="#l5.20"></a><span id="l5.20"> const IMAP = 0;</span>
<a href="#l5.21"></a><span id="l5.21"> const POP = 1;</span>
<a href="#l5.22"></a><span id="l5.22"> const SMTP = 2;</span>
<a href="#l5.23"></a><span id="l5.23"> // Security Types</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineat">@@ -53,30 +53,29 @@ const TLS = 2; // STARTTLS</span>
<a href="#l5.25"></a><span id="l5.25"> const SSL = 3; // SSL / TLS</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27"> const TIMEOUT =  10; // in seconds</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> let IMAP4_CMDS = [&quot;1 CAPABILITY\n&quot;, &quot;2 LOGOUT\n&quot;];</span>
<a href="#l5.30"></a><span id="l5.30"> let POP3_CMDS  = [&quot;CAPA\n&quot;, &quot;QUIT\n&quot;];</span>
<a href="#l5.31"></a><span id="l5.31"> let SMTP_CMDS = [&quot;EHLO\n&quot;, &quot;QUIT\n&quot;];</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-// this is a bit ugly - we set outgoingDone to false</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+// This is a bit ugly - we set outgoingDone to false</span>
<a href="#l5.35"></a><span id="l5.35"> // when emailWizard.js cancels the outgoing probe because the user picked</span>
<a href="#l5.36"></a><span id="l5.36"> // an outoing server. It does this by poking the probeAbortable object,</span>
<a href="#l5.37"></a><span id="l5.37"> // so we need outgoingDone to have global scope.</span>
<a href="#l5.38"></a><span id="l5.38"> var outgoingDone = false;</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-</span>
<a href="#l5.41"></a><span id="l5.41"> /**</span>
<a href="#l5.42"></a><span id="l5.42">  * Try to guess the config, by:</span>
<a href="#l5.43"></a><span id="l5.43">  * - guessing hostnames (pop3.&lt;domain&gt;, pop.&lt;domain&gt;, imap.&lt;domain&gt;,</span>
<a href="#l5.44"></a><span id="l5.44">  *                       mail.&lt;domain&gt; etc.)</span>
<a href="#l5.45"></a><span id="l5.45">  * - probing known ports (143 for IMAP, 110 for POP3, 573 for SMTP, more for SSL)</span>
<a href="#l5.46"></a><span id="l5.46">  * - opening a connection via the right protocol and checking the</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">- *    protocol-specific CAPABILITIES like that the server returns.</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+ *   protocol-specific CAPABILITIES like that the server returns.</span>
<a href="#l5.49"></a><span id="l5.49">  *</span>
<a href="#l5.50"></a><span id="l5.50">  * Final verification is not done here, but in verifyConfig().</span>
<a href="#l5.51"></a><span id="l5.51">  *</span>
<a href="#l5.52"></a><span id="l5.52">  * This function is async.</span>
<a href="#l5.53"></a><span id="l5.53">  * @param domain {String} the domain part of the email address</span>
<a href="#l5.54"></a><span id="l5.54">  * @param progressCallback {function(type, hostname, port, ssl, done)}</span>
<a href="#l5.55"></a><span id="l5.55">  *   Called when we try a new hostname/port.</span>
<a href="#l5.56"></a><span id="l5.56">  *   type {String-enum} &quot;imap&quot;, &quot;pop3&quot;, &quot;smtp&quot;, like AccountConfig.incoming.type</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineat">@@ -111,27 +110,27 @@ var outgoingDone = false;</span>
<a href="#l5.58"></a><span id="l5.58">  *   filled in.</span>
<a href="#l5.59"></a><span id="l5.59">  * @param which: 'incoming', 'outgoing', or 'both'.</span>
<a href="#l5.60"></a><span id="l5.60">  * @result {Abortable}</span>
<a href="#l5.61"></a><span id="l5.61">  */</span>
<a href="#l5.62"></a><span id="l5.62"> function guessConfig(domain, progressCallback, successCallback, errorCallback,</span>
<a href="#l5.63"></a><span id="l5.63">                      incomingErrorCallback, outgoingErrorCallback,</span>
<a href="#l5.64"></a><span id="l5.64">                      resultConfig, which)</span>
<a href="#l5.65"></a><span id="l5.65"> {</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-</span>
<a href="#l5.67"></a><span id="l5.67">   resultConfig.source = AccountConfig.kSourceGuess;</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69">   var outgoingHostDetector = null;</span>
<a href="#l5.70"></a><span id="l5.70">   var incomingHostDetector = null;</span>
<a href="#l5.71"></a><span id="l5.71">   var incomingEx = null; // if incoming had error, store ex here</span>
<a href="#l5.72"></a><span id="l5.72">   var outgoingEx = null; // if incoming had error, store ex here</span>
<a href="#l5.73"></a><span id="l5.73">   var incomingDone = false;</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">   if (which == 'incoming')</span>
<a href="#l5.76"></a><span id="l5.76">     outgoingDone = true;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+</span>
<a href="#l5.78"></a><span id="l5.78">   if (which == 'outgoing')</span>
<a href="#l5.79"></a><span id="l5.79">     incomingDone = true;</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81">   var progress = function(type, hostname, port, ssl)</span>
<a href="#l5.82"></a><span id="l5.82">   {</span>
<a href="#l5.83"></a><span id="l5.83">     progressCallback(protocolToString(type), hostname, port,</span>
<a href="#l5.84"></a><span id="l5.84">                      sslConvertToSocketType(ssl), false, resultConfig);</span>
<a href="#l5.85"></a><span id="l5.85">   };</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineat">@@ -140,18 +139,20 @@ function guessConfig(domain, progressCal</span>
<a href="#l5.87"></a><span id="l5.87">   {</span>
<a href="#l5.88"></a><span id="l5.88">     resultConfig = config;</span>
<a href="#l5.89"></a><span id="l5.89">   };</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91">   var checkDone = function()</span>
<a href="#l5.92"></a><span id="l5.92">   {</span>
<a href="#l5.93"></a><span id="l5.93">     if (outgoingEx)</span>
<a href="#l5.94"></a><span id="l5.94">       outgoingErrorCallback(outgoingEx, resultConfig);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+</span>
<a href="#l5.96"></a><span id="l5.96">     if (incomingEx)</span>
<a href="#l5.97"></a><span id="l5.97">       incomingErrorCallback(incomingEx, resultConfig);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+</span>
<a href="#l5.99"></a><span id="l5.99">     if (incomingEx &amp;&amp; outgoingEx)</span>
<a href="#l5.100"></a><span id="l5.100">     {</span>
<a href="#l5.101"></a><span id="l5.101">       errorCallback(incomingEx, resultConfig);</span>
<a href="#l5.102"></a><span id="l5.102">       return;</span>
<a href="#l5.103"></a><span id="l5.103">     }</span>
<a href="#l5.104"></a><span id="l5.104">     if ((incomingDone || incomingEx) &amp;&amp; (outgoingDone || outgoingEx))</span>
<a href="#l5.105"></a><span id="l5.105">     {</span>
<a href="#l5.106"></a><span id="l5.106">       successCallback(resultConfig);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineat">@@ -179,18 +180,18 @@ function guessConfig(domain, progressCal</span>
<a href="#l5.108"></a><span id="l5.108">   {</span>
<a href="#l5.109"></a><span id="l5.109">     outgoingEx = ex;</span>
<a href="#l5.110"></a><span id="l5.110">     checkDone();</span>
<a href="#l5.111"></a><span id="l5.111">   };</span>
<a href="#l5.112"></a><span id="l5.112"> </span>
<a href="#l5.113"></a><span id="l5.113">   var incomingSuccess = function(type, hostname, port, ssl, secureAuth, badCert,</span>
<a href="#l5.114"></a><span id="l5.114">                                  targetSite)</span>
<a href="#l5.115"></a><span id="l5.115">   {</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-    dump(&quot;incomingSuccess outgoingDone = &quot; + outgoingDone + &quot;\n&quot;);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-    dump(&quot;incoming success username = &quot; + resultConfig.incoming.username + &quot;\n&quot;);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+    ddump(&quot;incomingSuccess outgoingDone = &quot; + outgoingDone + &quot;\n&quot;);</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+    ddump(&quot;incoming success username = &quot; + resultConfig.incoming.username + &quot;\n&quot;);</span>
<a href="#l5.120"></a><span id="l5.120">     resultConfig.incoming.hostname = hostname;</span>
<a href="#l5.121"></a><span id="l5.121">     resultConfig.incoming.port = port;</span>
<a href="#l5.122"></a><span id="l5.122">     resultConfig.incoming.type = protocolToString(type);</span>
<a href="#l5.123"></a><span id="l5.123">     resultConfig.incoming.socketType =  sslConvertToSocketType(ssl);</span>
<a href="#l5.124"></a><span id="l5.124">     resultConfig.incoming.badCert = badCert;</span>
<a href="#l5.125"></a><span id="l5.125">     resultConfig.incoming.targetSite = targetSite;</span>
<a href="#l5.126"></a><span id="l5.126">     resultConfig.incoming.auth = secureAuth ? 2 : 1;</span>
<a href="#l5.127"></a><span id="l5.127"> </span>
<a href="#l5.128"></a><span id="l5.128" class="difflineat">@@ -203,38 +204,40 @@ function guessConfig(domain, progressCal</span>
<a href="#l5.129"></a><span id="l5.129">   var incomingError = function(ex)</span>
<a href="#l5.130"></a><span id="l5.130">   {</span>
<a href="#l5.131"></a><span id="l5.131">     incomingEx = ex;</span>
<a href="#l5.132"></a><span id="l5.132">     checkDone();</span>
<a href="#l5.133"></a><span id="l5.133">   };</span>
<a href="#l5.134"></a><span id="l5.134"> </span>
<a href="#l5.135"></a><span id="l5.135">   let incomingHostDetector = null;</span>
<a href="#l5.136"></a><span id="l5.136">   let outgoingHostDetector = null;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-  incomingHostDetector = new IncomingHostDetector(</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-    progress, incomingSuccess, incomingError);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-  outgoingHostDetector = new OutgoingHostDetector(</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-      progress, outgoingSuccess, outgoingError);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+  incomingHostDetector = new IncomingHostDetector(progress, incomingSuccess,</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+                                                  incomingError);</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+  outgoingHostDetector = new OutgoingHostDetector(progress, outgoingSuccess,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+                                                  outgoingError);</span>
<a href="#l5.145"></a><span id="l5.145">   if (which == 'incoming' || which == 'both')</span>
<a href="#l5.146"></a><span id="l5.146">   {</span>
<a href="#l5.147"></a><span id="l5.147">     incomingHostDetector.autoDetect(domain,</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-            resultConfig.incoming.hostname ? true : false,</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-            resultConfig.incoming.protocol ? resultConfig.incoming.protocol : undefined,</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-            resultConfig.incoming.port ? resultConfig.incoming.port : undefined);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+                                    resultConfig.incoming.hostname ? true : false,</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+                                    resultConfig.incoming.protocol ? resultConfig.incoming.protocol : undefined,</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+                                    resultConfig.incoming.port ? resultConfig.incoming.port : undefined);</span>
<a href="#l5.154"></a><span id="l5.154">   }</span>
<a href="#l5.155"></a><span id="l5.155">   if (which == 'outgoing' || which == 'both')</span>
<a href="#l5.156"></a><span id="l5.156">   {</span>
<a href="#l5.157"></a><span id="l5.157">     outgoingHostDetector.autoDetect(domain,</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-            resultConfig.outgoing.hostname ? true : false,</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-            resultConfig.outgoing.port ? resultConfig.outgoing.port : undefined);</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                                    resultConfig.outgoing.hostname ? true : false,</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+                                    resultConfig.outgoing.port ? resultConfig.outgoing.port : undefined);</span>
<a href="#l5.162"></a><span id="l5.162">   }</span>
<a href="#l5.163"></a><span id="l5.163"> </span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-  return new GuessAbortable(incomingHostDetector, outgoingHostDetector, updateConfig);</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+  return new GuessAbortable(incomingHostDetector, outgoingHostDetector,</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+                            updateConfig);</span>
<a href="#l5.167"></a><span id="l5.167"> }</span>
<a href="#l5.168"></a><span id="l5.168"> </span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-function GuessAbortable(incomingHostDetector, outgoingHostDetector, updateConfig)</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+function GuessAbortable(incomingHostDetector, outgoingHostDetector,</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+                        updateConfig)</span>
<a href="#l5.172"></a><span id="l5.172"> {</span>
<a href="#l5.173"></a><span id="l5.173">   this._init(incomingHostDetector, outgoingHostDetector, updateConfig);</span>
<a href="#l5.174"></a><span id="l5.174"> }</span>
<a href="#l5.175"></a><span id="l5.175"> </span>
<a href="#l5.176"></a><span id="l5.176"> GuessAbortable.prototype =</span>
<a href="#l5.177"></a><span id="l5.177"> {</span>
<a href="#l5.178"></a><span id="l5.178">   _init : function(incomingHostDetector, outgoingHostDetector, updateConfig)</span>
<a href="#l5.179"></a><span id="l5.179">   {</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineat">@@ -251,36 +254,37 @@ GuessAbortable.prototype =</span>
<a href="#l5.181"></a><span id="l5.181">       default:</span>
<a href="#l5.182"></a><span id="l5.182">         if (this._incomingHostDetector)</span>
<a href="#l5.183"></a><span id="l5.183">           this._incomingHostDetector.cancel();</span>
<a href="#l5.184"></a><span id="l5.184">       case 'outgoing':</span>
<a href="#l5.185"></a><span id="l5.185">         if (which != 'incoming')</span>
<a href="#l5.186"></a><span id="l5.186">         {</span>
<a href="#l5.187"></a><span id="l5.187">           if (this._outgoingHostDetector)</span>
<a href="#l5.188"></a><span id="l5.188">             this._outgoingHostDetector.cancel();</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-          dump(&quot;setting outgoingDone to true\n&quot;);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+          ddump(&quot;setting outgoingDone to true\n&quot;);</span>
<a href="#l5.192"></a><span id="l5.192">           outgoingDone = true;</span>
<a href="#l5.193"></a><span id="l5.193">         }</span>
<a href="#l5.194"></a><span id="l5.194">     }</span>
<a href="#l5.195"></a><span id="l5.195">   },</span>
<a href="#l5.196"></a><span id="l5.196"> </span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-  restart : function(domain, config, which /* 'incoming' or 'outgoing', default to both */,</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+  restart : function(domain, config,</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+                     which /* 'incoming' or 'outgoing', default to both */,</span>
<a href="#l5.200"></a><span id="l5.200">                      protocol, port)</span>
<a href="#l5.201"></a><span id="l5.201">   {</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-    // calling code may have changed config (e.g., user may have changed username)</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-    //  so put new values in resultConfig.</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+    // Calling code may have changed config (e.g., user may have changed</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+    // username) so put new values in resultConfig.</span>
<a href="#l5.206"></a><span id="l5.206">     this._updateConfig(config);</span>
<a href="#l5.207"></a><span id="l5.207">     switch (which)</span>
<a href="#l5.208"></a><span id="l5.208">     {</span>
<a href="#l5.209"></a><span id="l5.209">       case 'incoming':</span>
<a href="#l5.210"></a><span id="l5.210">         if (this._incomingHostDetector)</span>
<a href="#l5.211"></a><span id="l5.211">         {</span>
<a href="#l5.212"></a><span id="l5.212">           this._incomingHostDetector.cancel();</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-          this._incomingHostDetector.autoDetect(domain, true,</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-                                                protocol, port);</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+          this._incomingHostDetector.autoDetect(domain, true, protocol, port);</span>
<a href="#l5.216"></a><span id="l5.216">         }</span>
<a href="#l5.217"></a><span id="l5.217">         else</span>
<a href="#l5.218"></a><span id="l5.218">         {</span>
<a href="#l5.219"></a><span id="l5.219">           ddump(&quot;no incoming host detector!&quot;); // TODO use assert()</span>
<a href="#l5.220"></a><span id="l5.220">         }</span>
<a href="#l5.221"></a><span id="l5.221">         break;</span>
<a href="#l5.222"></a><span id="l5.222">       case 'outgoing':</span>
<a href="#l5.223"></a><span id="l5.223">           if (this._outgoingHostDetector)</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineat">@@ -290,28 +294,26 @@ GuessAbortable.prototype =</span>
<a href="#l5.225"></a><span id="l5.225">           } else {</span>
<a href="#l5.226"></a><span id="l5.226">             ddump(&quot;no outgoing host detector!&quot;); // TODO use assert()</span>
<a href="#l5.227"></a><span id="l5.227">           }</span>
<a href="#l5.228"></a><span id="l5.228">           break</span>
<a href="#l5.229"></a><span id="l5.229">       default: // both</span>
<a href="#l5.230"></a><span id="l5.230">         if (this._incomingHostDetector)</span>
<a href="#l5.231"></a><span id="l5.231">         {</span>
<a href="#l5.232"></a><span id="l5.232">           this._incomingHostDetector.cancel();</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-          this._incomingHostDetector.autoDetect(domain, true,</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-                                                protocol, port);</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+          this._incomingHostDetector.autoDetect(domain, true, protocol, port);</span>
<a href="#l5.236"></a><span id="l5.236">         }</span>
<a href="#l5.237"></a><span id="l5.237">         if (this._outgoingHostDetector)</span>
<a href="#l5.238"></a><span id="l5.238">         {</span>
<a href="#l5.239"></a><span id="l5.239">           this._outgoingHostDetector.cancel();</span>
<a href="#l5.240"></a><span id="l5.240">           this._outgoingHostDetector.autoDetect(domain, true, port);</span>
<a href="#l5.241"></a><span id="l5.241">         }</span>
<a href="#l5.242"></a><span id="l5.242">     }</span>
<a href="#l5.243"></a><span id="l5.243">   }</span>
<a href="#l5.244"></a><span id="l5.244"> }</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-</span>
<a href="#l5.246"></a><span id="l5.246"> extend(GuessAbortable, Abortable);</span>
<a href="#l5.247"></a><span id="l5.247"> </span>
<a href="#l5.248"></a><span id="l5.248"> function sslConvertToSocketType(ssl)</span>
<a href="#l5.249"></a><span id="l5.249"> {</span>
<a href="#l5.250"></a><span id="l5.250">   if (ssl == NONE)</span>
<a href="#l5.251"></a><span id="l5.251">     return 1;</span>
<a href="#l5.252"></a><span id="l5.252">   if (ssl == SSL)</span>
<a href="#l5.253"></a><span id="l5.253">     return 2;</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineat">@@ -378,17 +380,17 @@ HostDetector.prototype =</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256">   _tryNextHost : function()</span>
<a href="#l5.257"></a><span id="l5.257">   {</span>
<a href="#l5.258"></a><span id="l5.258">     if (this._cancel)</span>
<a href="#l5.259"></a><span id="l5.259">       return;</span>
<a href="#l5.260"></a><span id="l5.260"> </span>
<a href="#l5.261"></a><span id="l5.261">     if (this._hostIndex &gt;= this._hostsToTry.length)</span>
<a href="#l5.262"></a><span id="l5.262">     {</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-      // ran out of options</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+      // Ran out of options.</span>
<a href="#l5.265"></a><span id="l5.265">       this._log.info(&quot;ran out of hosts&quot;);</span>
<a href="#l5.266"></a><span id="l5.266">       var stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationModel.properties&quot;);</span>
<a href="#l5.267"></a><span id="l5.267">       var errorMsg = stringBundle.GetStringFromName(&quot;cannot_find_server.error&quot;);</span>
<a href="#l5.268"></a><span id="l5.268">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l5.269"></a><span id="l5.269">       return;</span>
<a href="#l5.270"></a><span id="l5.270">     }</span>
<a href="#l5.271"></a><span id="l5.271">     this._host = this._hostsToTry[this._hostIndex++];</span>
<a href="#l5.272"></a><span id="l5.272">     this._log.info(&quot;hostname: &quot; + this._host);</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineat">@@ -398,17 +400,17 @@ HostDetector.prototype =</span>
<a href="#l5.274"></a><span id="l5.274">   keepTrying : function()</span>
<a href="#l5.275"></a><span id="l5.275">   {</span>
<a href="#l5.276"></a><span id="l5.276">     if (this._cancel)</span>
<a href="#l5.277"></a><span id="l5.277">         return;</span>
<a href="#l5.278"></a><span id="l5.278">     this._tryIndex++;</span>
<a href="#l5.279"></a><span id="l5.279">     var curTry = this.tryOrder[this._tryIndex];</span>
<a href="#l5.280"></a><span id="l5.280"> </span>
<a href="#l5.281"></a><span id="l5.281">     if (curTry === undefined) {</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-      // ran out of options</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+      // Ran out of options.</span>
<a href="#l5.284"></a><span id="l5.284">       this._log.info(&quot;ran out of tries&quot;);</span>
<a href="#l5.285"></a><span id="l5.285">       this._tryNextHost();</span>
<a href="#l5.286"></a><span id="l5.286">       return;</span>
<a href="#l5.287"></a><span id="l5.287">     }</span>
<a href="#l5.288"></a><span id="l5.288"> </span>
<a href="#l5.289"></a><span id="l5.289">     let curTry = this.tryOrder[this._tryIndex];</span>
<a href="#l5.290"></a><span id="l5.290">     let type = curTry[0];</span>
<a href="#l5.291"></a><span id="l5.291">     let port = curTry[2];</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineat">@@ -423,31 +425,31 @@ HostDetector.prototype =</span>
<a href="#l5.293"></a><span id="l5.293"> </span>
<a href="#l5.294"></a><span id="l5.294">   processCertError : function(socketInfo, status, targetSite)</span>
<a href="#l5.295"></a><span id="l5.295">   {</span>
<a href="#l5.296"></a><span id="l5.296">     this._log.warn(&quot;Got Cert error for &quot;+ targetSite);</span>
<a href="#l5.297"></a><span id="l5.297"> </span>
<a href="#l5.298"></a><span id="l5.298">     if (!status)</span>
<a href="#l5.299"></a><span id="l5.299">       return true;</span>
<a href="#l5.300"></a><span id="l5.300"> </span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-    let cert = status.QueryInterface(Components.interfaces.nsISSLStatus).serverCert;</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+    let cert = status.QueryInterface(Ci.nsISSLStatus).serverCert;</span>
<a href="#l5.303"></a><span id="l5.303">     let flags = 0;</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305">     if (status.isUntrusted)</span>
<a href="#l5.306"></a><span id="l5.306">       flags |= gOverrideService.ERROR_UNTRUSTED;</span>
<a href="#l5.307"></a><span id="l5.307">     if (status.isDomainMismatch)</span>
<a href="#l5.308"></a><span id="l5.308">       flags |= gOverrideService.ERROR_MISMATCH;</span>
<a href="#l5.309"></a><span id="l5.309">     if (status.isNotValidAtThisTime)</span>
<a href="#l5.310"></a><span id="l5.310">       flags |= gOverrideService.ERROR_TIME;</span>
<a href="#l5.311"></a><span id="l5.311"> </span>
<a href="#l5.312"></a><span id="l5.312">     let parts = targetSite.split(':');</span>
<a href="#l5.313"></a><span id="l5.313">     let host = parts[0];</span>
<a href="#l5.314"></a><span id="l5.314">     let port = parts[1];</span>
<a href="#l5.315"></a><span id="l5.315"> </span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-    // if domain mismatch, then we shouldn't accept, and instead try the domain</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+    // If domain mismatch, then we shouldn't accept, and instead try the domain</span>
<a href="#l5.318"></a><span id="l5.318">     // in the cert to the list of tries.</span>
<a href="#l5.319"></a><span id="l5.319">     // Not skipping mismatches for now because it's too common, and until we can</span>
<a href="#l5.320"></a><span id="l5.320">     // poke around the cert and find out what domain to try, best to live</span>
<a href="#l5.321"></a><span id="l5.321">     // w/ orange than red.</span>
<a href="#l5.322"></a><span id="l5.322"> </span>
<a href="#l5.323"></a><span id="l5.323">     this._gotCertError = true;</span>
<a href="#l5.324"></a><span id="l5.324">     this._targetSite = targetSite;</span>
<a href="#l5.325"></a><span id="l5.325">     this._certOverrideProcessed = false;</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineat">@@ -455,17 +457,17 @@ HostDetector.prototype =</span>
<a href="#l5.327"></a><span id="l5.327">         false); // last bit is temporary -- should it be true? XXX</span>
<a href="#l5.328"></a><span id="l5.328">     this._log.warn(&quot;!! Overrode bad cert temporarily &quot; + host + ' ' + port +</span>
<a href="#l5.329"></a><span id="l5.329">                    'flags = ' + flags + '\n');</span>
<a href="#l5.330"></a><span id="l5.330">     return true;</span>
<a href="#l5.331"></a><span id="l5.331">   },</span>
<a href="#l5.332"></a><span id="l5.332"> </span>
<a href="#l5.333"></a><span id="l5.333">   processSSLError : function(socketInfo, status, targetSite)</span>
<a href="#l5.334"></a><span id="l5.334">   {</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-    dump (&quot;got SSL error\n&quot;);</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+    ddump (&quot;got SSL error\n&quot;);</span>
<a href="#l5.337"></a><span id="l5.337">     // XXX record that there was an SSL error, and tell the user</span>
<a href="#l5.338"></a><span id="l5.338">     // about it somehow</span>
<a href="#l5.339"></a><span id="l5.339">     // XXX test case?</span>
<a href="#l5.340"></a><span id="l5.340">     // return true if you want to suppress the default PSM dialog</span>
<a href="#l5.341"></a><span id="l5.341">     return false;</span>
<a href="#l5.342"></a><span id="l5.342">   },</span>
<a href="#l5.343"></a><span id="l5.343"> </span>
<a href="#l5.344"></a><span id="l5.344">   onResult : function(wiredata)</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineat">@@ -544,30 +546,30 @@ HostDetector.prototype =</span>
<a href="#l5.346"></a><span id="l5.346">       return /AUTH=(CRAM-MD5|NTLM|MSN|GSSAPI)/.test(line);</span>
<a href="#l5.347"></a><span id="l5.347">     if (protocol == SMTP)</span>
<a href="#l5.348"></a><span id="l5.348">       return /AUTH (CRAM-MD5|NTLM|MSN|GSSAPI)/.test(line);</span>
<a href="#l5.349"></a><span id="l5.349">   },</span>
<a href="#l5.350"></a><span id="l5.350"> </span>
<a href="#l5.351"></a><span id="l5.351">   _matchTLS : function(curTry, result)</span>
<a href="#l5.352"></a><span id="l5.352">   {</span>
<a href="#l5.353"></a><span id="l5.353">       return curTry != null &amp;&amp; curTry[1] == TLS &amp;&amp;</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineminus">-               hasTLS(result.join(&quot;\n&quot;), curTry[0]);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+             hasTLS(result.join(&quot;\n&quot;), curTry[0]);</span>
<a href="#l5.356"></a><span id="l5.356">   }</span>
<a href="#l5.357"></a><span id="l5.357"> }</span>
<a href="#l5.358"></a><span id="l5.358"> </span>
<a href="#l5.359"></a><span id="l5.359"> function IncomingHostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l5.360"></a><span id="l5.360"> {</span>
<a href="#l5.361"></a><span id="l5.361">   this._init(progressCallback, successCallback, errorCallback);</span>
<a href="#l5.362"></a><span id="l5.362"> }</span>
<a href="#l5.363"></a><span id="l5.363"> </span>
<a href="#l5.364"></a><span id="l5.364"> IncomingHostDetector.prototype =</span>
<a href="#l5.365"></a><span id="l5.365"> {</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-  __proto__: new HostDetector(),</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+  __proto__ : new HostDetector(),</span>
<a href="#l5.368"></a><span id="l5.368"> </span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-  type: 'incoming',</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+  type : 'incoming',</span>
<a href="#l5.371"></a><span id="l5.371"> </span>
<a href="#l5.372"></a><span id="l5.372">   _loggerName : &quot;incominghostdetector&quot;,</span>
<a href="#l5.373"></a><span id="l5.373"> </span>
<a href="#l5.374"></a><span id="l5.374">   autoDetect : function(host, /* required */</span>
<a href="#l5.375"></a><span id="l5.375">                         hostIsPrecise /* false */,</span>
<a href="#l5.376"></a><span id="l5.376">                         protocol /* UNKNOWN */,</span>
<a href="#l5.377"></a><span id="l5.377">                         port /* UNKNOWN */) {</span>
<a href="#l5.378"></a><span id="l5.378">     if (hostIsPrecise === undefined)</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineat">@@ -606,19 +608,19 @@ IncomingHostDetector.prototype =</span>
<a href="#l5.380"></a><span id="l5.380">       this._hostsToTry.push(this.host);</span>
<a href="#l5.381"></a><span id="l5.381">     }</span>
<a href="#l5.382"></a><span id="l5.382">     this._hostIndex = 0;</span>
<a href="#l5.383"></a><span id="l5.383">     this._tryNextHost();</span>
<a href="#l5.384"></a><span id="l5.384">   },</span>
<a href="#l5.385"></a><span id="l5.385"> </span>
<a href="#l5.386"></a><span id="l5.386">   _tryHost : function()</span>
<a href="#l5.387"></a><span id="l5.387">   {</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-    // if the protocol was specified, trust that.</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-    // same for the port number.</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-    // otherwise, if the hostname starts with pop try POP3 protocols first</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+    // If the protocol was specified, trust that.</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+    // Same for the port number.</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+    // Otherwise, if the hostname starts with pop try POP3 protocols first,</span>
<a href="#l5.394"></a><span id="l5.394">     // otherwise check IMAP4 protocols first.</span>
<a href="#l5.395"></a><span id="l5.395"> </span>
<a href="#l5.396"></a><span id="l5.396">     var lowerCaseHost = this._host.toLowerCase();</span>
<a href="#l5.397"></a><span id="l5.397">     if (this._specifiedProtocol == POP ||</span>
<a href="#l5.398"></a><span id="l5.398">         !lowerCaseHost.indexOf(&quot;pop.&quot;) ||</span>
<a href="#l5.399"></a><span id="l5.399">         !lowerCaseHost.indexOf(&quot;pop3.&quot;))</span>
<a href="#l5.400"></a><span id="l5.400">     {</span>
<a href="#l5.401"></a><span id="l5.401">       if (this._specifiedPort == UNKNOWN)</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineat">@@ -684,17 +686,19 @@ IncomingHostDetector.prototype =</span>
<a href="#l5.403"></a><span id="l5.403"> </span>
<a href="#l5.404"></a><span id="l5.404"> function OutgoingHostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l5.405"></a><span id="l5.405"> {</span>
<a href="#l5.406"></a><span id="l5.406">   this._init(progressCallback, successCallback, errorCallback);</span>
<a href="#l5.407"></a><span id="l5.407"> }</span>
<a href="#l5.408"></a><span id="l5.408"> OutgoingHostDetector.prototype =</span>
<a href="#l5.409"></a><span id="l5.409"> {</span>
<a href="#l5.410"></a><span id="l5.410">   __proto__: new HostDetector(),</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+</span>
<a href="#l5.412"></a><span id="l5.412">   type: 'outgoing',</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+</span>
<a href="#l5.414"></a><span id="l5.414">   _loggerName : &quot;outgoinghostdetector&quot;,</span>
<a href="#l5.415"></a><span id="l5.415"> </span>
<a href="#l5.416"></a><span id="l5.416">   autoDetect : function(host, /* required */</span>
<a href="#l5.417"></a><span id="l5.417">                         hostIsPrecise /* false */,</span>
<a href="#l5.418"></a><span id="l5.418">                         port /* UNKNOWN */)</span>
<a href="#l5.419"></a><span id="l5.419">   {</span>
<a href="#l5.420"></a><span id="l5.420">     if (hostIsPrecise === undefined)</span>
<a href="#l5.421"></a><span id="l5.421">       hostIsPrecise = false;</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineat">@@ -803,34 +807,35 @@ function SocketUtil(host, port, useSSL, </span>
<a href="#l5.423"></a><span id="l5.423">     // issue occurs before the timeout can be set on the socket, this</span>
<a href="#l5.424"></a><span id="l5.424">     // ensures that the listener callback will be fired in a timely manner.</span>
<a href="#l5.425"></a><span id="l5.425">     // XXX There might to be some clean up needed after the timeout is fired</span>
<a href="#l5.426"></a><span id="l5.426">     // for socket and io resources.</span>
<a href="#l5.427"></a><span id="l5.427"> </span>
<a href="#l5.428"></a><span id="l5.428">      //The timeout value plus 2 seconds</span>
<a href="#l5.429"></a><span id="l5.429">     setTimeout(timeoutFunc, (timeout * 1000) + 2000);</span>
<a href="#l5.430"></a><span id="l5.430"> </span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-    var transportService =</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-         Components.classes[&quot;@mozilla.org/network/socket-transport-service;1&quot;]</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-               .getService(Components.interfaces.nsISocketTransportService);</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+    var transportService = Cc[&quot;@mozilla.org/network/socket-transport-service;1&quot;]</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+                           .getService(Ci.nsISocketTransportService);</span>
<a href="#l5.436"></a><span id="l5.436"> </span>
<a href="#l5.437"></a><span id="l5.437">     var transport = transportService.createTransport(useSSL ? ['ssl'] : null,</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-                             useSSL ? 1 : 0, host, port, null);</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+                                                     useSSL ? 1 : 0, host,</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+                                                     port, null);</span>
<a href="#l5.441"></a><span id="l5.441"> </span>
<a href="#l5.442"></a><span id="l5.442">     transport.setTimeout(Ci.nsISocketTransport.TIMEOUT_CONNECT, timeout);</span>
<a href="#l5.443"></a><span id="l5.443">     transport.setTimeout(Ci.nsISocketTransport.TIMEOUT_READ_WRITE, timeout);</span>
<a href="#l5.444"></a><span id="l5.444">     try {</span>
<a href="#l5.445"></a><span id="l5.445">       transport.securityCallbacks = new BadCertHandler(listener);</span>
<a href="#l5.446"></a><span id="l5.446">     } catch (e) {</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+      // XXX TODO FIXME</span>
<a href="#l5.448"></a><span id="l5.448">       alert(e);</span>
<a href="#l5.449"></a><span id="l5.449">     }</span>
<a href="#l5.450"></a><span id="l5.450">     var outstream = transport.openOutputStream(0,0,0);</span>
<a href="#l5.451"></a><span id="l5.451">     var stream = transport.openInputStream(0,0,0);</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-    var instream = Components.classes[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-              .createInstance(Components.interfaces.nsIScriptableInputStream);</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+    var instream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+                   .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l5.456"></a><span id="l5.456">     instream.init(stream);</span>
<a href="#l5.457"></a><span id="l5.457"> </span>
<a href="#l5.458"></a><span id="l5.458">     var dataListener =</span>
<a href="#l5.459"></a><span id="l5.459">     {</span>
<a href="#l5.460"></a><span id="l5.460">       data : new Array(),</span>
<a href="#l5.461"></a><span id="l5.461">       onStartRequest: function(request, context)</span>
<a href="#l5.462"></a><span id="l5.462">       {</span>
<a href="#l5.463"></a><span id="l5.463">         initialized = true;</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineat">@@ -857,21 +862,21 @@ function SocketUtil(host, port, useSSL, </span>
<a href="#l5.465"></a><span id="l5.465">           {</span>
<a href="#l5.466"></a><span id="l5.466">             //Send the next request to the server.</span>
<a href="#l5.467"></a><span id="l5.467">             let outputData = protocolData[index++];</span>
<a href="#l5.468"></a><span id="l5.468">             outstream.write(outputData, outputData.length);</span>
<a href="#l5.469"></a><span id="l5.469">           }</span>
<a href="#l5.470"></a><span id="l5.470">         }</span>
<a href="#l5.471"></a><span id="l5.471">       }</span>
<a href="#l5.472"></a><span id="l5.472">     };</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-    var pump = Components.classes[&quot;@mozilla.org/network/input-stream-pump;1&quot;]</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-             .createInstance(Components.interfaces.nsIInputStreamPump);</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+    var pump = Cc[&quot;@mozilla.org/network/input-stream-pump;1&quot;]</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+               .createInstance(Ci.nsIInputStreamPump);</span>
<a href="#l5.477"></a><span id="l5.477"> </span>
<a href="#l5.478"></a><span id="l5.478">     pump.init(stream, -1, -1, 0, 0, false);</span>
<a href="#l5.479"></a><span id="l5.479">     pump.asyncRead(dataListener, null);</span>
<a href="#l5.480"></a><span id="l5.480">    }</span>
<a href="#l5.481"></a><span id="l5.481">    catch (ex)</span>
<a href="#l5.482"></a><span id="l5.482">    {</span>
<a href="#l5.483"></a><span id="l5.483">     callListener(null);</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineminus">-    dump(ex);</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+    ddump(ex);</span>
<a href="#l5.486"></a><span id="l5.486">    }</span>
<a href="#l5.487"></a><span id="l5.487">    return null;</span>
<a href="#l5.488"></a><span id="l5.488"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -46,17 +46,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * The XML format is documented at</span>
<a href="#l6.5"></a><span id="l6.5">  * &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l6.6"></a><span id="l6.6">  *</span>
<a href="#l6.7"></a><span id="l6.7">  * @param clientConfigXML {E4X}  The &lt;clientConfig&gt; node.</span>
<a href="#l6.8"></a><span id="l6.8">  * @return AccountConfig   object filled with the data from XML</span>
<a href="#l6.9"></a><span id="l6.9">  */</span>
<a href="#l6.10"></a><span id="l6.10"> function readFromXML(clientConfigXML)</span>
<a href="#l6.11"></a><span id="l6.11"> {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  if ( ! &quot;emailProvider&quot; in clientConfigXML)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  if (!&quot;emailProvider&quot; in clientConfigXML)</span>
<a href="#l6.14"></a><span id="l6.14">   {</span>
<a href="#l6.15"></a><span id="l6.15">     var stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationModel.properties&quot;);</span>
<a href="#l6.16"></a><span id="l6.16">     throw stringBundle.GetStringFromName(&quot;no_emailProvider.error&quot;);</span>
<a href="#l6.17"></a><span id="l6.17">   }</span>
<a href="#l6.18"></a><span id="l6.18">   var xml = clientConfigXML.emailProvider;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   var d = new AccountConfig();</span>
<a href="#l6.21"></a><span id="l6.21">   d.source = AccountConfig.kSourceXML;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -84,50 +84,53 @@ function readFromXML(clientConfigXML)</span>
<a href="#l6.23"></a><span id="l6.23">       iO.leaveMessagesOnServer = sanitize.boolean(iX.pop3.leaveMessagesOnServer);</span>
<a href="#l6.24"></a><span id="l6.24">     if (&quot;daysToLeaveMessagesOnServer&quot; in iX.pop3)</span>
<a href="#l6.25"></a><span id="l6.25">       iO.daysToLeaveMessagesOnServer = iX.pop3.daysToLeaveMessagesOnServer;</span>
<a href="#l6.26"></a><span id="l6.26">   }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">   // outgoing server</span>
<a href="#l6.29"></a><span id="l6.29">   var oX = xml.outgoingServer; // input (XML)</span>
<a href="#l6.30"></a><span id="l6.30">   var oO = d.outgoing; // output (object)</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  if ( ! oX.@type == &quot;smtp&quot;)</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  if (!(oX.@type == &quot;smtp&quot;))</span>
<a href="#l6.33"></a><span id="l6.33">   {</span>
<a href="#l6.34"></a><span id="l6.34">     var stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationModel.properties&quot;);</span>
<a href="#l6.35"></a><span id="l6.35">     throw stringBundle.GetStringFromName(&quot;outgoing_not_smtp.error&quot;);</span>
<a href="#l6.36"></a><span id="l6.36">   }</span>
<a href="#l6.37"></a><span id="l6.37">   oO.hostname = sanitize.hostname(oX.hostname);</span>
<a href="#l6.38"></a><span id="l6.38">   oO.port = sanitize.integerRange(oX.port, 1, 65535);</span>
<a href="#l6.39"></a><span id="l6.39">   if (&quot;username&quot; in oX)</span>
<a href="#l6.40"></a><span id="l6.40">     oO.username = sanitize.string(oX.username);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  oO.socketType = sanitize.translate(oX.socketType, { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  oO.socketType = sanitize.translate(oX.socketType,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                                     { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l6.45"></a><span id="l6.45">   oO.auth = sanitize.translate(oX.authentication,</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-          { none : 0 /* e.g. IP-address-based */, plain : 1, secure : 2,  // TODO &quot;secure&quot;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-            &quot;smtp-after-pop&quot; : 0 /* hope for the best */});</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+                               { none : 0 /* e.g. IP-address-based */,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+                                 plain : 1, secure : 2,  // TODO &quot;secure&quot;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+                                 &quot;smtp-after-pop&quot; : 0 /* hope for the best */});</span>
<a href="#l6.51"></a><span id="l6.51">   if (&quot;addThisServer&quot; in oX)</span>
<a href="#l6.52"></a><span id="l6.52">     oO.addThisServer = sanitize.boolean(oX.addThisServer);</span>
<a href="#l6.53"></a><span id="l6.53">   if (&quot;useGlobalPreferredServer&quot; in oX)</span>
<a href="#l6.54"></a><span id="l6.54">     oO.useGlobalPreferredServer = sanitize.boolean(oX.useGlobalPreferredServer);</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">   for each (var inputField in xml.inputField)</span>
<a href="#l6.57"></a><span id="l6.57">   {</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    if ( ! d.inputFields)</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    if (!d.inputFields)</span>
<a href="#l6.60"></a><span id="l6.60">       d.inputFields = new Array();</span>
<a href="#l6.61"></a><span id="l6.61">     var fieldset =</span>
<a href="#l6.62"></a><span id="l6.62">     {</span>
<a href="#l6.63"></a><span id="l6.63">       varname : sanitize.alphanumdash(inputField.@key).toUpperCase(),</span>
<a href="#l6.64"></a><span id="l6.64">       displayName : sanitize.label(inputField.@label),</span>
<a href="#l6.65"></a><span id="l6.65">       exampleValue : sanitize.label(inputField.text())</span>
<a href="#l6.66"></a><span id="l6.66">     };</span>
<a href="#l6.67"></a><span id="l6.67">     d.inputFields.push(fieldset);</span>
<a href="#l6.68"></a><span id="l6.68">   }</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70">   for each (var enableURL in xml.enableURL)</span>
<a href="#l6.71"></a><span id="l6.71">   {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    if ( ! d.enableURLs)</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    if (!d.enableURLs)</span>
<a href="#l6.74"></a><span id="l6.74">       d.enableURLs = new Array();</span>
<a href="#l6.75"></a><span id="l6.75">     var fieldset =</span>
<a href="#l6.76"></a><span id="l6.76">     {</span>
<a href="#l6.77"></a><span id="l6.77">       url : sanitize.url(sanitize.nonemptystring(enableURL.@url)),</span>
<a href="#l6.78"></a><span id="l6.78">       instruction : sanitize.label(sanitize.nonemptystring(enableURL.@instruction))</span>
<a href="#l6.79"></a><span id="l6.79">     };</span>
<a href="#l6.80"></a><span id="l6.80">     d.enableURLs.push(fieldset);</span>
<a href="#l6.81"></a><span id="l6.81">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -45,139 +45,158 @@</span>
<a href="#l7.4"></a><span id="l7.4">  *</span>
<a href="#l7.5"></a><span id="l7.5">  * The functions take a string (unless noted otherwise) and return</span>
<a href="#l7.6"></a><span id="l7.6">  * the expected datatype in JS types. If the value is not as expected,</span>
<a href="#l7.7"></a><span id="l7.7">  * they throw exceptions.</span>
<a href="#l7.8"></a><span id="l7.8">  */</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> var sanitize =</span>
<a href="#l7.11"></a><span id="l7.11"> {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-integer : function (unchecked)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  if (typeof(unchecked) == &quot;number&quot;)</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-    return unchecked;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  var r = parseInt(unchecked);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  if (r == NaN)</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-    throw new MalformedException(&quot;no_number.error&quot;, unchecked);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  return r;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-},</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-integerRange : function (unchecked, min, max)</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-{</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  var int = this.integer(unchecked);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  if (int &lt; min)</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-    throw new MalformedException(&quot;number_too_small.error&quot;, unchecked);</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  if (int &gt; max)</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-    throw new MalformedException(&quot;number_too_large.error&quot;, unchecked);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  return int;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-},</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-boolean : function (unchecked)</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-{</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  if (typeof(unchecked) == &quot;boolean&quot;)</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-    return unchecked;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  if (unchecked == &quot;true&quot;)</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    return true;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  if (unchecked == &quot;false&quot;)</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-    return false;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  throw new MalformedException(&quot;boolean.error&quot;, unchecked);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-},</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-string : function (unchecked)</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-{</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  return String(unchecked);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-},</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-nonemptystring : function (unchecked)</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-{</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-  if ( ! unchecked)</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-    throw new MalformedException(&quot;string_empty.error&quot;, unchecked);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  return this.string(unchecked);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-},</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-/**</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">- * Allow only letters, numbers, &quot;-&quot; and &quot;_&quot;.</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">- *</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">- * Empty strings not allowed (good idea?).</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">- */</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-alphanumdash : function (unchecked)</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-{</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  var str = this.nonemptystring(unchecked);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  if ( ! /^[a-zA-Z0-9\-\_]*$/.test(str))</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    throw new MalformedException(&quot;alphanumdash.error&quot;, unchecked);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-  return str;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-},</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-/**</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">- * DNS hostnames like foo.bar.example.com</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">- * Allow only letters, numbers, &quot;-&quot; and &quot;.&quot;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">- * Empty strings not allowed.</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">- * Currently does not support IDN (international domain names).</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">- * HACK: &quot;%&quot; is allowed, because we allow placeholders in hostnames in the config file.</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">- */</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-hostname : function (unchecked)</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-{</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  var str = this.nonemptystring(unchecked);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  if ( ! /^[a-zA-Z0-9\-\.%]*$/.test(unchecked))</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-    throw new MalformedException(&quot;hostname_syntax.error&quot;, unchecked);</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  return str;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-},</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-/**</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">- * A non-chrome URL that's safe to request.</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">- */</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-url : function (unchecked)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-{</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  var str =  this.string(unchecked);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  if (str.substr(0, 4) != &quot;http&quot; &amp;&amp; str.substr(0, 5) != &quot;https&quot;)</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  integer : function(unchecked)</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    if (typeof(unchecked) == &quot;number&quot;)</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+      return unchecked;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    var r = parseInt(unchecked);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    if (r == NaN)</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+      throw new MalformedException(&quot;no_number.error&quot;, unchecked);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    return r;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  },</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+  integerRange : function(unchecked, min, max)</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+    var int = this.integer(unchecked);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+    if (int &lt; min)</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+      throw new MalformedException(&quot;number_too_small.error&quot;, unchecked);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    if (int &gt; max)</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+      throw new MalformedException(&quot;number_too_large.error&quot;, unchecked);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+    return int;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  },</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  boolean : function(unchecked)</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    if (typeof(unchecked) == &quot;boolean&quot;)</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+      return unchecked;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    if (unchecked == &quot;true&quot;)</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+      return true;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    if (unchecked == &quot;false&quot;)</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+      return false;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    throw new MalformedException(&quot;boolean.error&quot;, unchecked);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  },</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  string : function(unchecked)</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    return String(unchecked);</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  },</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  nonemptystring : function(unchecked)</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    if (!unchecked)</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+      throw new MalformedException(&quot;string_empty.error&quot;, unchecked);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+    return this.string(unchecked);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  },</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  /**</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+   * Allow only letters, numbers, &quot;-&quot; and &quot;_&quot;.</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+   *</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+   * Empty strings not allowed (good idea?).</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+   */</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  alphanumdash : function(unchecked)</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  {</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    var str = this.nonemptystring(unchecked);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    if (!/^[a-zA-Z0-9\-\_]*$/.test(str))</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+      throw new MalformedException(&quot;alphanumdash.error&quot;, unchecked);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+    return str;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  },</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  var uri;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  try {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    uri = ioService().newURI(str, null, null);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-    uri = uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-  } catch (e) {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    throw new MalformedException(&quot;url_parsing.error&quot;, unchecked);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-  }</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  //this.enum(uri.scheme, [&quot;http&quot;, &quot;https&quot;]);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-  if (uri.scheme != &quot;http&quot; &amp;&amp; uri.scheme != &quot;https&quot;)</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-    throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  return uri.spec;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-},</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+  /**</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+   * DNS hostnames like foo.bar.example.com</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+   * Allow only letters, numbers, &quot;-&quot; and &quot;.&quot;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+   * Empty strings not allowed.</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+   * Currently does not support IDN (international domain names).</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+   * HACK: &quot;%&quot; is allowed, because we allow placeholders in hostnames in the</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+   * config file.</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+   */</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+  hostname : function(unchecked)</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+    var str = this.nonemptystring(unchecked);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    if (!/^[a-zA-Z0-9\-\.%]*$/.test(unchecked))</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+      throw new MalformedException(&quot;hostname_syntax.error&quot;, unchecked);</span>
<a href="#l7.174"></a><span id="l7.174"> </span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-/**</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">- * A value which should be shown to the user in the UI as label</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">- */</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-label : function (unchecked)</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-{</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  return this.string(unchecked);</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-},</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-enum : function(unchecked, allowedValues)</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-{</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-  for each (var allowedValue in allowedValues)</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    return str;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  },</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+  /**</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+   * A non-chrome URL that's safe to request.</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+   */</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  url : function (unchecked)</span>
<a href="#l7.191"></a><span id="l7.191">   {</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-    if (allowedValue == unchecked)</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-      return allowedValue;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    var str =  this.string(unchecked);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+    if (str.substr(0, 4) != &quot;http&quot; &amp;&amp; str.substr(0, 5) != &quot;https&quot;)</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+      throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    var uri;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+    try {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      uri = ioService().newURI(str, null, null);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+      uri = uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    } catch (e) {</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+      throw new MalformedException(&quot;url_parsing.error&quot;, unchecked);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    }</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+    if (uri.scheme != &quot;http&quot; &amp;&amp; uri.scheme != &quot;https&quot;)</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+      throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+    return uri.spec;</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+  },</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+  /**</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+   * A value which should be shown to the user in the UI as label</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+   */</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+  label : function(unchecked)</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+  {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+    return this.string(unchecked);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+  },</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+  enum : function(unchecked, allowedValues)</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  {</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+    for each (var allowedValue in allowedValues)</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+    {</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+      if (allowedValue == unchecked)</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+        return allowedValue;</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+    }</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    throw new MalformedException(&quot;enum_value.error&quot;, unchecked);</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+  },</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  /**</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+   * Like enum, allows only certain (string) values as input, but allows the</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+   * caller to specify another value to return instead of the input value. E.g.,</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+   * if unchecked == &quot;foo&quot;, return 1, if unchecked == &quot;bar&quot;, return 2,</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+   * otherwise throw. This allows to translate string enums into integer enums.</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+   *</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+   * @param unchecked {Object} Associative array. property name is the input</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+   *       value, property value is the output value. E.g. the example above</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+   *       would be: { foo: 1, bar : 2 }.</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+   * Use quotes when you need freaky characters: &quot;baz-&quot; : 3.</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+   */</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  translate : function(unchecked, mapping)</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+  {</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+    for (var inputValue in mapping)</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+    {</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+      if (inputValue == unchecked)</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+        return mapping[inputValue];</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+    }</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+    throw new MalformedException(&quot;enum_value.error&quot;, unchecked);</span>
<a href="#l7.249"></a><span id="l7.249">   }</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-  throw new MalformedException(&quot;enum_value.error&quot;, unchecked);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-},</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-/**</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">- * Like enum, allows only certain (string) values as input.</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">- * But allows the caller to specify another value to return instead of the</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">- * input value. E.g.,</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">- * if unchecked == &quot;foo&quot;, return 1, if unchecked == &quot;bar&quot;, return 2,</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">- *  otherwise throw. This allows to translate string enums into integer enums.</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">- *</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">- * @param unchecked {Object} Associative array. property name is the input value,</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">- *       property value is the output value. E.g. the example above would be:</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">- *       { foo: 1, bar : 2 } .</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">- * Use quotes when you need freaky characters: &quot;baz-&quot; : 3.</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">- */</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-translate : function(unchecked, mapping)</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-{</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-  for (var inputValue in mapping)</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-  {</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-    if (inputValue == unchecked)</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-      return mapping[inputValue];</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-  }</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-  throw new MalformedException(&quot;enum_value.error&quot;, unchecked);</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-}</span>
<a href="#l7.273"></a><span id="l7.273"> };</span>
<a href="#l7.274"></a><span id="l7.274"> </span>
<a href="#l7.275"></a><span id="l7.275"> function MalformedException(msgID, uncheckedBadValue)</span>
<a href="#l7.276"></a><span id="l7.276"> {</span>
<a href="#l7.277"></a><span id="l7.277">   var stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationUtil.properties&quot;);</span>
<a href="#l7.278"></a><span id="l7.278">   this._message = stringBundle.GetStringFromName(msgID);</span>
<a href="#l7.279"></a><span id="l7.279">   if (kDebug)</span>
<a href="#l7.280"></a><span id="l7.280">     this._message += &quot; (bad value: &quot; + new String(uncheckedBadValue) + &quot;)&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/util.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/util.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -48,17 +48,17 @@ const Cu = Components.utils;</span>
<a href="#l8.4"></a><span id="l8.4">  */</span>
<a href="#l8.5"></a><span id="l8.5"> function extend(child, supertype)</span>
<a href="#l8.6"></a><span id="l8.6"> {</span>
<a href="#l8.7"></a><span id="l8.7">   child.prototype.__proto__ = supertype.prototype;</span>
<a href="#l8.8"></a><span id="l8.8"> }</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> function assert(test, errorMsg)</span>
<a href="#l8.11"></a><span id="l8.11"> {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  if ( ! test)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  if (!test)</span>
<a href="#l8.14"></a><span id="l8.14">     throw new Exception(errorMsg);</span>
<a href="#l8.15"></a><span id="l8.15"> }</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> /**</span>
<a href="#l8.19"></a><span id="l8.19">  * Runs the given function sometime later</span>
<a href="#l8.20"></a><span id="l8.20">  *</span>
<a href="#l8.21"></a><span id="l8.21">  * Currently implemented using setTimeout(), but</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -88,34 +88,34 @@ function makeNSIURI(uriStr)</span>
<a href="#l8.23"></a><span id="l8.23">  * @return {Array of String}   the contents of the file, one string per line</span>
<a href="#l8.24"></a><span id="l8.24">  */</span>
<a href="#l8.25"></a><span id="l8.25"> function readURLasUTF8(uri)</span>
<a href="#l8.26"></a><span id="l8.26"> {</span>
<a href="#l8.27"></a><span id="l8.27">   assert(uri instanceof Ci.nsIURI, &quot;uri must be an nsIURI&quot;);</span>
<a href="#l8.28"></a><span id="l8.28">   try {</span>
<a href="#l8.29"></a><span id="l8.29">     var chan = ioService().newChannelFromURI(uri);</span>
<a href="#l8.30"></a><span id="l8.30">     var is = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-      .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+             .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l8.33"></a><span id="l8.33">     is.init(chan.open(), &quot;UTF-8&quot;, 1024,</span>
<a href="#l8.34"></a><span id="l8.34">             Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">     var content = &quot;&quot;;</span>
<a href="#l8.37"></a><span id="l8.37">     var strOut = new Object();</span>
<a href="#l8.38"></a><span id="l8.38">     try {</span>
<a href="#l8.39"></a><span id="l8.39">       while (is.readString(1024, strOut) != 0)</span>
<a href="#l8.40"></a><span id="l8.40">         content += strOut.value;</span>
<a href="#l8.41"></a><span id="l8.41">     // catch in outer try/catch</span>
<a href="#l8.42"></a><span id="l8.42">     } finally {</span>
<a href="#l8.43"></a><span id="l8.43">       is.close();</span>
<a href="#l8.44"></a><span id="l8.44">     }</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46">     return content;</span>
<a href="#l8.47"></a><span id="l8.47">   } catch (e) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-  // TODO this has a numeric error message. We need to ship translations</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  // into human language.</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    // TODO this has a numeric error message. We need to ship translations</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    // into human language.</span>
<a href="#l8.52"></a><span id="l8.52">     throw e;</span>
<a href="#l8.53"></a><span id="l8.53">   }</span>
<a href="#l8.54"></a><span id="l8.54"> }</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56"> /**</span>
<a href="#l8.57"></a><span id="l8.57">  * Takes a string (which is typically the content of a file,</span>
<a href="#l8.58"></a><span id="l8.58">  * e.g. the result returned from readURLUTF8() ), and splits</span>
<a href="#l8.59"></a><span id="l8.59">  * it into lines, and returns an array with one string per line</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineat">@@ -138,31 +138,31 @@ function splitLines(content)</span>
<a href="#l8.61"></a><span id="l8.61">  * @throws all errors to caller</span>
<a href="#l8.62"></a><span id="l8.62">  */</span>
<a href="#l8.63"></a><span id="l8.63"> function ioService()</span>
<a href="#l8.64"></a><span id="l8.64"> {</span>
<a href="#l8.65"></a><span id="l8.65">   if (_gIOServiceCached)</span>
<a href="#l8.66"></a><span id="l8.66">     return _gIOServiceCached;</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">   _gIOServiceCached = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-               .getService(Ci.nsIIOService);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+                      .getService(Ci.nsIIOService);</span>
<a href="#l8.71"></a><span id="l8.71">   return _gIOServiceCached;</span>
<a href="#l8.72"></a><span id="l8.72"> }</span>
<a href="#l8.73"></a><span id="l8.73"> var _gIOServiceCached;</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75"> /**</span>
<a href="#l8.76"></a><span id="l8.76">  * @param bundleURI {String}   chrome URL to properties file</span>
<a href="#l8.77"></a><span id="l8.77">  * @return nsIStringBundle</span>
<a href="#l8.78"></a><span id="l8.78">  */</span>
<a href="#l8.79"></a><span id="l8.79"> function getStringBundle(bundleURI)</span>
<a href="#l8.80"></a><span id="l8.80"> {</span>
<a href="#l8.81"></a><span id="l8.81">   try {</span>
<a href="#l8.82"></a><span id="l8.82">     return Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-                   .getService(Ci.nsIStringBundleService)</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-                   .createBundle(bundleURI);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+           .getService(Ci.nsIStringBundleService)</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+           .createBundle(bundleURI);</span>
<a href="#l8.87"></a><span id="l8.87">   } catch (e) {</span>
<a href="#l8.88"></a><span id="l8.88">     throw new Exception(&quot;Failed to get stringbundle URI &lt;&quot; + bundleURI + &quot;&gt;. Error: &quot; + e);</span>
<a href="#l8.89"></a><span id="l8.89">   }</span>
<a href="#l8.90"></a><span id="l8.90"> }</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93"> function Exception(msg)</span>
<a href="#l8.94"></a><span id="l8.94"> {</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineat">@@ -298,17 +298,17 @@ function ddumpObject(obj, name, maxDepth</span>
<a href="#l8.96"></a><span id="l8.96">       else if (typeof(obj[prop]) == &quot;function&quot;)</span>
<a href="#l8.97"></a><span id="l8.97">         ddump(name + &quot;.&quot; + prop + &quot;=[function]&quot;);</span>
<a href="#l8.98"></a><span id="l8.98">       else</span>
<a href="#l8.99"></a><span id="l8.99">         ddump(name + &quot;.&quot; + prop + &quot;=&quot; + obj[prop]);</span>
<a href="#l8.100"></a><span id="l8.100">     } catch (e) {</span>
<a href="#l8.101"></a><span id="l8.101">       ddump(name + &quot;.&quot; + prop + &quot;-&gt; Exception(&quot; + e + &quot;)&quot;);</span>
<a href="#l8.102"></a><span id="l8.102">     }</span>
<a href="#l8.103"></a><span id="l8.103">   }</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  if ( ! i)</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  if (!i)</span>
<a href="#l8.106"></a><span id="l8.106">     ddump(name + &quot; is empty&quot;);</span>
<a href="#l8.107"></a><span id="l8.107"> }</span>
<a href="#l8.108"></a><span id="l8.108"> </span>
<a href="#l8.109"></a><span id="l8.109"> function alertPrompt(alertTitle, alertMsg)</span>
<a href="#l8.110"></a><span id="l8.110"> {</span>
<a href="#l8.111"></a><span id="l8.111">   Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l8.112"></a><span id="l8.112">                     .getService(Components.interfaces.nsIPromptService)</span>
<a href="#l8.113"></a><span id="l8.113">                     .alert(window, alertTitle, alertMsg);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -61,81 +61,84 @@</span>
<a href="#l9.4"></a><span id="l9.4"> function verifyConfig(config, alter, msgWindow, successCallback, errorCallback)</span>
<a href="#l9.5"></a><span id="l9.5"> {</span>
<a href="#l9.6"></a><span id="l9.6">   ddumpObject(config, &quot;config&quot;, 3);</span>
<a href="#l9.7"></a><span id="l9.7">   assert(config instanceof AccountConfig, &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l9.8"></a><span id="l9.8">   assert(typeof(alter) == &quot;boolean&quot;, &quot;BUG: Bad arg 'alter'&quot;);</span>
<a href="#l9.9"></a><span id="l9.9">   assert(typeof(successCallback) == &quot;function&quot;, &quot;BUG: 'successCallback' is not a function&quot;);</span>
<a href="#l9.10"></a><span id="l9.10">   assert(typeof(errorCallback) == &quot;function&quot;, &quot;BUG: 'errorCallback' is not a function&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  var accountManager =</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-          Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-          .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   if (accountManager.findRealServer(config.incoming.username,</span>
<a href="#l9.19"></a><span id="l9.19">                                     config.incoming.hostname,</span>
<a href="#l9.20"></a><span id="l9.20">                                     sanitize.enum(config.incoming.type,</span>
<a href="#l9.21"></a><span id="l9.21">                                                   [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l9.22"></a><span id="l9.22">                                     config.incoming.port))</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-    return errorCallback('Incoming server exists');</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+    return errorCallback(&quot;Incoming server exists&quot;);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+</span>
<a href="#l9.26"></a><span id="l9.26">   // incoming server</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-  var inServer = accountManager.createIncomingServer(</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-      config.incoming.username,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-      config.incoming.hostname,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-      sanitize.enum(config.incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  var inServer =</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    accountManager.createIncomingServer(config.incoming.username,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+                                        config.incoming.hostname,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+                                        sanitize.enum(config.incoming.type,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+                                                      [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l9.36"></a><span id="l9.36">   inServer.port = config.incoming.port;</span>
<a href="#l9.37"></a><span id="l9.37">   inServer.password = config.incoming.password;</span>
<a href="#l9.38"></a><span id="l9.38">   if (config.incoming.socketType == 1) // plain</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-      inServer.socketType = Ci.nsIMsgIncomingServer.defaultSocket;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+    inServer.socketType = Ci.nsIMsgIncomingServer.defaultSocket;</span>
<a href="#l9.41"></a><span id="l9.41">   else if (config.incoming.socketType == 2) // SSL</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-      inServer.socketType = Ci.nsIMsgIncomingServer.useSSL;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+    inServer.socketType = Ci.nsIMsgIncomingServer.useSSL;</span>
<a href="#l9.44"></a><span id="l9.44">   else if (config.incoming.socketType == 3) // TLS</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-      inServer.socketType = Ci.nsIMsgIncomingServer.alwaysUseTLS;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    inServer.socketType = Ci.nsIMsgIncomingServer.alwaysUseTLS;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+</span>
<a href="#l9.48"></a><span id="l9.48">   // auth</span>
<a href="#l9.49"></a><span id="l9.49">   if (config.incoming.auth == 2) // &quot;secure&quot; auth</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-      inServer.useSecAuth = true;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  //&lt;/copied&gt;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    inServer.useSecAuth = true;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+</span>
<a href="#l9.54"></a><span id="l9.54">   try {</span>
<a href="#l9.55"></a><span id="l9.55">     inServer.password = config.incoming.password;</span>
<a href="#l9.56"></a><span id="l9.56">     verifyLogon(config, inServer, alter, msgWindow, successCallback, errorCallback);</span>
<a href="#l9.57"></a><span id="l9.57">   } catch (e) {</span>
<a href="#l9.58"></a><span id="l9.58">     ddump(&quot;ERROR: verify logon shouldn't have failed&quot;);</span>
<a href="#l9.59"></a><span id="l9.59">     errorCallback(e);</span>
<a href="#l9.60"></a><span id="l9.60">     throw(e);</span>
<a href="#l9.61"></a><span id="l9.61">   }</span>
<a href="#l9.62"></a><span id="l9.62"> };</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64"> function verifyLogon(config, inServer, alter, msgWindow, successCallback,</span>
<a href="#l9.65"></a><span id="l9.65">                      errorCallback)</span>
<a href="#l9.66"></a><span id="l9.66"> {</span>
<a href="#l9.67"></a><span id="l9.67">   // hack - save away the old callbacks.</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  let saveCallbacks =   msgWindow.notificationCallbacks;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  let saveCallbacks = msgWindow.notificationCallbacks;</span>
<a href="#l9.70"></a><span id="l9.70">   // set our own callbacks - this works because verifyLogon will</span>
<a href="#l9.71"></a><span id="l9.71">   // synchronously create the transport and use the notification callbacks.</span>
<a href="#l9.72"></a><span id="l9.72">   let listener = new urlListener(config, inServer, alter, msgWindow,</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-                                       successCallback, errorCallback);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+                                 successCallback, errorCallback);</span>
<a href="#l9.75"></a><span id="l9.75">   // our listener listens both for the url and cert errors.</span>
<a href="#l9.76"></a><span id="l9.76">   msgWindow.notificationCallbacks = listener;</span>
<a href="#l9.77"></a><span id="l9.77">   // try to work around bug where backend is clearing password.</span>
<a href="#l9.78"></a><span id="l9.78">   inServer.password = config.incoming.password;</span>
<a href="#l9.79"></a><span id="l9.79">   let uri = inServer.verifyLogon(listener, msgWindow);</span>
<a href="#l9.80"></a><span id="l9.80">   // clear msgWindow so url won't prompt for passwords.</span>
<a href="#l9.81"></a><span id="l9.81">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl).msgWindow = null;</span>
<a href="#l9.82"></a><span id="l9.82">   // restore them</span>
<a href="#l9.83"></a><span id="l9.83">   msgWindow.notificationCallbacks = saveCallbacks;</span>
<a href="#l9.84"></a><span id="l9.84"> }</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86"> /**</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">- * The url listener also implements nsIBadCertListener2.  Its job is to prevent &quot;bad cert&quot;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">- * security dialogs from being shown to the user.  Currently it puts up the</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">- * cert override dialog, though we'd like to give the user more detailed</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+ * The url listener also implements nsIBadCertListener2.  Its job is to prevent</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+ * &quot;bad cert&quot; security dialogs from being shown to the user.  Currently it puts</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+ * up the cert override dialog, though we'd like to give the user more detailed</span>
<a href="#l9.93"></a><span id="l9.93">  * information in the future.</span>
<a href="#l9.94"></a><span id="l9.94">  */</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-function urlListener(config, server, alter, msgWindow, successCallback, errorCallback)</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+function urlListener(config, server, alter, msgWindow, successCallback,</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+                     errorCallback)</span>
<a href="#l9.99"></a><span id="l9.99"> {</span>
<a href="#l9.100"></a><span id="l9.100">   this.mConfig = config;</span>
<a href="#l9.101"></a><span id="l9.101">   this.mServer = server;</span>
<a href="#l9.102"></a><span id="l9.102">   this.mAlter = alter;</span>
<a href="#l9.103"></a><span id="l9.103">   this.mSuccessCallback = successCallback;</span>
<a href="#l9.104"></a><span id="l9.104">   this.mErrorCallback = errorCallback;</span>
<a href="#l9.105"></a><span id="l9.105">   this.mUsernameSaved = null;</span>
<a href="#l9.106"></a><span id="l9.106">   this.mMsgWindow = msgWindow;</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineat">@@ -144,34 +147,34 @@ function urlListener(config, server, alt</span>
<a href="#l9.108"></a><span id="l9.108"> urlListener.prototype =</span>
<a href="#l9.109"></a><span id="l9.109"> {</span>
<a href="#l9.110"></a><span id="l9.110">   OnStartRunningUrl: function(aUrl)</span>
<a href="#l9.111"></a><span id="l9.111">   {</span>
<a href="#l9.112"></a><span id="l9.112">   },</span>
<a href="#l9.113"></a><span id="l9.113"> </span>
<a href="#l9.114"></a><span id="l9.114">   OnStopRunningUrl: function(aUrl, aExitCode)</span>
<a href="#l9.115"></a><span id="l9.115">   {</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    if (! (aExitCode &amp; 0x80000000)) // logon succeeded</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+    if (Components.isSuccessCode(aExitCode))</span>
<a href="#l9.118"></a><span id="l9.118">     {</span>
<a href="#l9.119"></a><span id="l9.119">       this._cleanup();</span>
<a href="#l9.120"></a><span id="l9.120">       this.mSuccessCallback();</span>
<a href="#l9.121"></a><span id="l9.121">     }</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-    // logon failed</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    else if ( !this.mAlter) // we were asked to not try other variations</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+    // Logon failed, and we aren't supposed to try other variations.</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+    else if (!this.mAlter)</span>
<a href="#l9.126"></a><span id="l9.126">     {</span>
<a href="#l9.127"></a><span id="l9.127">       this._cleanup();</span>
<a href="#l9.128"></a><span id="l9.128">       var stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationModel.properties&quot;);</span>
<a href="#l9.129"></a><span id="l9.129">       var errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l9.130"></a><span id="l9.130">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l9.131"></a><span id="l9.131">     }</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-    // try other variations, unless there's a cert error, in which</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+    // Try other variations, unless there's a cert error, in which</span>
<a href="#l9.134"></a><span id="l9.134">     // case we'll see what the user chooses.</span>
<a href="#l9.135"></a><span id="l9.135">     else if (!this.mCertError)</span>
<a href="#l9.136"></a><span id="l9.136">     {</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-      dump(&quot;trying next logon\n&quot;);</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+      ddump(&quot;trying next logon\n&quot;);</span>
<a href="#l9.139"></a><span id="l9.139">       this.tryNextLogon()</span>
<a href="#l9.140"></a><span id="l9.140">     }</span>
<a href="#l9.141"></a><span id="l9.141">   },</span>
<a href="#l9.142"></a><span id="l9.142"> </span>
<a href="#l9.143"></a><span id="l9.143">   tryNextLogon: function()</span>
<a href="#l9.144"></a><span id="l9.144">   {</span>
<a href="#l9.145"></a><span id="l9.145">     // check if we tried full email address as username</span>
<a href="#l9.146"></a><span id="l9.146">     if (this.mConfig.incoming.username != this.mConfig.identity.emailAddress)</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineat">@@ -202,61 +205,64 @@ urlListener.prototype =</span>
<a href="#l9.148"></a><span id="l9.148">       let stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationModel.properties&quot;);</span>
<a href="#l9.149"></a><span id="l9.149">       let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l9.150"></a><span id="l9.150">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l9.151"></a><span id="l9.151">     }</span>
<a href="#l9.152"></a><span id="l9.152">   },</span>
<a href="#l9.153"></a><span id="l9.153"> </span>
<a href="#l9.154"></a><span id="l9.154">   _cleanup : function()</span>
<a href="#l9.155"></a><span id="l9.155">   {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-      // avoid pref pollution, clear out server prefs.</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-      Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-            .getService(Ci.nsIMsgAccountManager).</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-                removeIncomingServer(this.mServer, true);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-      this.mServer = null;</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+    // Avoid pref pollution, clear out server prefs.</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+    Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+    .getService(Ci.nsIMsgAccountManager)</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+    .removeIncomingServer(this.mServer, true);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+    this.mServer = null;</span>
<a href="#l9.167"></a><span id="l9.167">   },</span>
<a href="#l9.168"></a><span id="l9.168"> </span>
<a href="#l9.169"></a><span id="l9.169">   // Suppress any certificate errors</span>
<a href="#l9.170"></a><span id="l9.170">   notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l9.171"></a><span id="l9.171">     if (!status)</span>
<a href="#l9.172"></a><span id="l9.172">       return true;</span>
<a href="#l9.173"></a><span id="l9.173"> </span>
<a href="#l9.174"></a><span id="l9.174">     this.mCertError = true;</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-    dump(&quot;got cert error\n&quot;);</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+    ddump(&quot;got cert error\n&quot;);</span>
<a href="#l9.177"></a><span id="l9.177">     setTimeout(this.informUserOfCertError, 0, socketInfo, targetSite, this);</span>
<a href="#l9.178"></a><span id="l9.178">     return true;</span>
<a href="#l9.179"></a><span id="l9.179">   },</span>
<a href="#l9.180"></a><span id="l9.180"> </span>
<a href="#l9.181"></a><span id="l9.181">   informUserOfCertError : function(socketInfo, targetSite, self) {</span>
<a href="#l9.182"></a><span id="l9.182">     let params = { exceptionAdded : false };</span>
<a href="#l9.183"></a><span id="l9.183">     params.prefetchCert = true;</span>
<a href="#l9.184"></a><span id="l9.184">     params.location = targetSite;</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-    window.openDialog('chrome://pippki/content/exceptionDialog.xul',</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-                    '','chrome,centerscreen,modal', params);</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-    dump(&quot;after exception dialog\n&quot;);</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-    dump(&quot;exceptionAdded = &quot; + params.exceptionAdded + &quot;\n&quot;);</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+    window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+                      &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+    ddump(&quot;after exception dialog\n&quot;);</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+    ddump(&quot;exceptionAdded = &quot; + params.exceptionAdded + &quot;\n&quot;);</span>
<a href="#l9.193"></a><span id="l9.193">     if (!params.exceptionAdded) {</span>
<a href="#l9.194"></a><span id="l9.194">       self._cleanup();</span>
<a href="#l9.195"></a><span id="l9.195">       let stringBundle = getStringBundle(&quot;chrome://messenger/content/accountCreationModel.properties&quot;);</span>
<a href="#l9.196"></a><span id="l9.196">       let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l9.197"></a><span id="l9.197">       self.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l9.198"></a><span id="l9.198">     }</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-    else { // retry the logon now that we've added the cert exception.</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+    else {</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+      // Retry the logon now that we've added the cert exception.</span>
<a href="#l9.202"></a><span id="l9.202">       verifyLogon(self.mConfig, self.mServer, self.mAlter, self.mMsgWindow,</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-            self.mSuccessCallback, self.mErrorCallback);</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+                  self.mSuccessCallback, self.mErrorCallback);</span>
<a href="#l9.205"></a><span id="l9.205">     }</span>
<a href="#l9.206"></a><span id="l9.206">   },</span>
<a href="#l9.207"></a><span id="l9.207"> </span>
<a href="#l9.208"></a><span id="l9.208">   // nsIInterfaceRequestor</span>
<a href="#l9.209"></a><span id="l9.209">   getInterface: function(iid) {</span>
<a href="#l9.210"></a><span id="l9.210">     return this.QueryInterface(iid);</span>
<a href="#l9.211"></a><span id="l9.211">   },</span>
<a href="#l9.212"></a><span id="l9.212"> </span>
<a href="#l9.213"></a><span id="l9.213">   // nsISupports</span>
<a href="#l9.214"></a><span id="l9.214">   QueryInterface: function(iid) {</span>
<a href="#l9.215"></a><span id="l9.215">     if (!iid.equals(Components.interfaces.nsIBadCertListener2) &amp;&amp;</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-      !iid.equals(Components.interfaces.nsIInterfaceRequestor) &amp;&amp;</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-      !iid.equals(Components.interfaces.nsIUrlListener) &amp;&amp;</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-      !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+        !iid.equals(Components.interfaces.nsIInterfaceRequestor) &amp;&amp;</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+        !iid.equals(Components.interfaces.nsIUrlListener) &amp;&amp;</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+        !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l9.222"></a><span id="l9.222">       throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+</span>
<a href="#l9.224"></a><span id="l9.224">     return this;</span>
<a href="#l9.225"></a><span id="l9.225">   }</span>
<a href="#l9.226"></a><span id="l9.226"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

