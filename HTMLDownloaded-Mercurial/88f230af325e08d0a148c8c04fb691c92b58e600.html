<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26631:88f230af325e08d0a148c8c04fb691c92b58e600</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 88f230af325e08d0a148c8c04fb691c92b58e600" />
<meta property="og:url" content="/comm-central/rev/88f230af325e08d0a148c8c04fb691c92b58e600" />
<meta property="og:description" content="Bug 1518172 - Import ctypes-otr, updated by kaie/aleca. r=florian,clokep,mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 88f230af325e08d0a148c8c04fb691c92b58e600 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/88f230af325e08d0a148c8c04fb691c92b58e600">shortlog</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/88f230af325e08d0a148c8c04fb691c92b58e600">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600">files</a> |
changeset |
<a href="/comm-central/raw-rev/88f230af325e08d0a148c8c04fb691c92b58e600">raw</a>  | <a href="/comm-central/archive/88f230af325e08d0a148c8c04fb691c92b58e600.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518172">Bug 1518172</a> - Import ctypes-otr, updated by kaie/aleca. r=florian,clokep,mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#114;&#108;&#111;&#32;&#66;&#114;&#101;&#97;&#117;&#108;&#116;&#32;&#60;&#97;&#114;&#108;&#111;&#108;&#114;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;&#44;&#32;&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;&#44;&#32;&#65;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#32;&#67;&#97;&#115;&#116;&#101;&#108;&#108;&#97;&#110;&#105;&#32;&#60;&#97;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 17 May 2019 16:21:48 +0200</td></tr>

<tr>
 <td>changeset 26631</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/88f230af325e08d0a148c8c04fb691c92b58e600">88f230af325e08d0a148c8c04fb691c92b58e600</a></td>
</tr>



<tr>
<td>parent 26630</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4516cf2270f464e5e8bc19fbf2b0ca6fff10ca58">4516cf2270f464e5e8bc19fbf2b0ca6fff10ca58</a>
</td>
</tr>

<tr>
<td>child 26632</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7e3a1808d30d74cd63009b3a518d417566dd206d">7e3a1808d30d74cd63009b3a518d417566dd206d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=88f230af325e08d0a148c8c04fb691c92b58e600">15929</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Fri, 17 May 2019 14:22:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@88f230af325e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=88f230af325e08d0a148c8c04fb691c92b58e600">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=88f230af325e08d0a148c8c04fb691c92b58e600&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=88f230af325e08d0a148c8c04fb691c92b58e600&newProject=comm-central&newRevision=88f230af325e08d0a148c8c04fb691c92b58e600&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=88f230af325e08d0a148c8c04fb691c92b58e600&newProject=comm-central&newRevision=88f230af325e08d0a148c8c04fb691c92b58e600&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=88f230af325e08d0a148c8c04fb691c92b58e600&newProject=comm-central&newRevision=88f230af325e08d0a148c8c04fb691c92b58e600&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a>, <a href="/comm-central/log?rev=reviewer%28clokep%29&revcount=50">clokep</a>, <a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518172">1518172</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518172">Bug 1518172</a> - Import ctypes-otr, updated by kaie/aleca. r=florian,clokep,mkmelin

Original MPL v2 code by Arlo Breault from https://github.com/arlolra/ctypes-otr/
Ported to Thunderbird by Kai Engert, includes UI changes by Alessandro Castellani.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/jar.mn">chat/content/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/jar.mn">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/jar.mn">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/jar.mn">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/jar.mn">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.dtd">chat/content/otr-add-finger.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.dtd">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.dtd">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.dtd">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.dtd">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.properties">chat/content/otr-add-finger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.properties">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.properties">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.properties">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.properties">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-finger.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.js">chat/content/otr-add-fingerprint.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.js">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.js">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.js">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.js">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.xul">chat/content/otr-add-fingerprint.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.xul">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.xul">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.xul">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.xul">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-add-fingerprint.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.dtd">chat/content/otr-auth.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.dtd">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.dtd">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.dtd">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.dtd">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.js">chat/content/otr-auth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.js">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.js">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.js">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.js">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.properties">chat/content/otr-auth.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.properties">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.properties">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.properties">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.properties">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.xul">chat/content/otr-auth.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.xul">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.xul">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.xul">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.xul">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-auth.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-chat.dtd">chat/content/otr-chat.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-chat.dtd">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-chat.dtd">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-chat.dtd">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-chat.dtd">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-chat.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.dtd">chat/content/otr-generate-key.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.dtd">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.dtd">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.dtd">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.dtd">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.js">chat/content/otr-generate-key.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.js">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.js">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.js">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.js">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.properties">chat/content/otr-generate-key.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.properties">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.properties">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.properties">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.properties">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.xul">chat/content/otr-generate-key.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.xul">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.xul">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.xul">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.xul">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr-generate-key.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr.properties">chat/content/otr.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr.properties">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr.properties">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr.properties">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr.properties">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otr.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrUI.properties">chat/content/otrUI.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrUI.properties">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrUI.properties">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrUI.properties">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrUI.properties">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrUI.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrWorker.js">chat/content/otrWorker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrWorker.js">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrWorker.js">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrWorker.js">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrWorker.js">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/content/otrWorker.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/locales/jar.mn">chat/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/CLib.jsm">chat/modules/CLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/CLib.jsm">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/CLib.jsm">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/CLib.jsm">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/CLib.jsm">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/CLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTR.jsm">chat/modules/OTR.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTR.jsm">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTR.jsm">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTR.jsm">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTR.jsm">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTR.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRHelpers.jsm">chat/modules/OTRHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRHelpers.jsm">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRHelpers.jsm">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRLib.jsm">chat/modules/OTRLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRLib.jsm">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRLib.jsm">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRLib.jsm">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRLib.jsm">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRUI.jsm">chat/modules/OTRUI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRUI.jsm">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRUI.jsm">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRUI.jsm">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRUI.jsm">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/OTRUI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/moz.build">chat/modules/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/moz.build">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/moz.build">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/moz.build">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/moz.build">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/modules/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-encrypted.svg">chat/themes/icons/otr-connection-encrypted.svg</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-encrypted.svg">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-encrypted.svg">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-encrypted.svg">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-encrypted.svg">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-encrypted.svg">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-finished.svg">chat/themes/icons/otr-connection-finished.svg</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-finished.svg">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-finished.svg">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-finished.svg">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-finished.svg">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/icons/otr-connection-finished.svg">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/jar.mn">chat/themes/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/jar.mn">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/jar.mn">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/jar.mn">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/jar.mn">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/otr.css">chat/themes/otr.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/otr.css">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/otr.css">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/otr.css">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/otr.css">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/chat/themes/otr.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-conversation-info.js">mail/components/im/content/chat-conversation-info.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-conversation-info.js">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-conversation-info.js">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-conversation-info.js">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-conversation-info.js">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-conversation-info.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.inc.xul">mail/components/im/content/chat-messenger.inc.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.inc.xul">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.inc.xul">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.inc.xul">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.inc.xul">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.inc.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.js">mail/components/im/content/chat-messenger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.js">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.js">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.js">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.js">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/content/chat-messenger.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/themes/chat.css">mail/components/im/themes/chat.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/themes/chat.css">file</a> |
<a href="/comm-central/annotate/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/themes/chat.css">annotate</a> |
<a href="/comm-central/diff/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/themes/chat.css">diff</a> |
<a href="/comm-central/comparison/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/themes/chat.css">comparison</a> |
<a href="/comm-central/log/88f230af325e08d0a148c8c04fb691c92b58e600/mail/components/im/themes/chat.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/content/jar.mn</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/content/jar.mn</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -7,8 +7,24 @@ chat.jar:</span>
<a href="#l1.4"></a><span id="l1.4"> 	content/chat/accounts.css</span>
<a href="#l1.5"></a><span id="l1.5"> 	content/chat/browserRequest.js</span>
<a href="#l1.6"></a><span id="l1.6"> 	content/chat/browserRequest.xul</span>
<a href="#l1.7"></a><span id="l1.7"> 	content/chat/imAccountOptionsHelper.js</span>
<a href="#l1.8"></a><span id="l1.8"> 	content/chat/chat-account-richlistitem.js</span>
<a href="#l1.9"></a><span id="l1.9"> *	content/chat/imtooltip.xml</span>
<a href="#l1.10"></a><span id="l1.10"> 	content/chat/conversation-browser.js</span>
<a href="#l1.11"></a><span id="l1.11"> 	content/chat/conv.html</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+	content/chat/otr-add-fingerprint.js</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+	content/chat/otr-add-fingerprint.xul</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+	content/chat/otr-auth.js</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+	content/chat/otr-auth.xul</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+	content/chat/otr-generate-key.js</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+	content/chat/otr-generate-key.xul</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+	content/chat/otrWorker.js</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+	content/chat/otr-auth.dtd</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+	content/chat/otr-auth.properties</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+	content/chat/otr-add-finger.dtd</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+	content/chat/otr-add-finger.properties</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+	content/chat/otr.properties</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+	content/chat/otr-generate-key.dtd</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+	content/chat/otr-generate-key.properties</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+	content/chat/otrUI.properties</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+	content/chat/otr-chat.dtd</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/chat/content/otr-add-finger.dtd</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+&lt;!ENTITY addFingerDialog.title &quot;Add Fingerprint&quot;&gt;</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+&lt;!ENTITY addFingerDialog.finger &quot;Fingerprint&quot;&gt;</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+&lt;!ENTITY addFingerDialog.cancel &quot;Skip&quot;&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (addFingerDialog.tooltip): do not translate OTR which is the name of an encryption protocol --&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+&lt;!ENTITY addFingerDialog.tooltip &quot;If you know the 40 hex char fingerprint of your contact's OTR private key, enter it now.&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/chat/content/otr-add-finger.properties</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+# LOCALIZATION NOTE (addfinger.title): %S is the name of a chat contact person</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+addfinger.title=Enter the fingerprint of the OTR key used by %S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/chat/content/otr-add-fingerprint.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,50 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+const {</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+  l10nHelper,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+const {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  l10nHelper(&quot;chrome://chat/content/otr-add-finger.properties&quot;)</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+var args = window.arguments[0].wrappedJSObject;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+var otrAddFinger = {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  onload() {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    document.title = _(&quot;addfinger.title&quot;, args.screenname);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    document.addEventListener(&quot;dialogaccept&quot;, () =&gt; {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+      return this.add();</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    });</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  },</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  oninput(e) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    e.value = e.value.replace(/[^0-9a-fA-F]/gi, &quot;&quot;);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    document.documentElement.getButton(&quot;accept&quot;).disabled = (e.value.length != 40);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  },</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  add(e) {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    let hex = document.getElementById(&quot;finger&quot;).value;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    let context = OTR.getContextFromRecipient(</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+      args.account,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      args.protocol,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      args.screenname</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    );</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    let finger = OTR.addFingerprint(context, hex);</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    if (finger.isNull())</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+      return;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    try {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+      // Ignore the return, this is just a test.</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+      OTR.getUIConvFromContext(context);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+    } catch (error) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+      // We expect that a conversation may not have been started.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+      context = null;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    }</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    OTR.setTrust(finger, true, context);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  },</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/chat/content/otr-add-fingerprint.xul</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,27 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot; ?&gt;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+&lt;!DOCTYPE window SYSTEM &quot;chrome://chat/content/otr-add-finger.dtd&quot;&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+&lt;dialog id=&quot;otrAddFingerDialog&quot;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+        windowtype=&quot;OTR:AddFinger&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+        onload=&quot;otrAddFinger.onload()&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+        title=&quot;&amp;addFingerDialog.title;&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+        buttons=&quot;accept,cancel&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+        buttonlabelcancel=&quot;&amp;addFingerDialog.cancel;&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+        buttondisabledaccept=&quot;true&quot;&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://chat/content/otr-add-fingerprint.js&quot;/&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    &lt;label value=&quot;&amp;addFingerDialog.tooltip;&quot; control=&quot;name&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    &lt;hbox id=&quot;fingerBox&quot; align=&quot;baseline&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+      &lt;label value=&quot;&amp;addFingerDialog.finger;&quot; control=&quot;name&quot;/&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+      &lt;textbox id=&quot;finger&quot; oninput=&quot;otrAddFinger.oninput(this)&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/chat/content/otr-auth.dtd</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+&lt;!ENTITY authDialog.title &quot;Verify contact's identity&quot;&gt;</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+&lt;!ENTITY authDialog.authenticate &quot;Verify&quot;&gt;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+&lt;!ENTITY authDialog.help &quot;Help&quot;&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+&lt;!ENTITY authDialog.yes &quot;Yes&quot;&gt;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+&lt;!ENTITY authDialog.no &quot;No&quot;&gt;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+&lt;!ENTITY authDialog.verified &quot;I have verified that this is in fact the correct fingerprint.&quot;&gt;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+&lt;!ENTITY authDialog.manualVerification &quot;Manual fingerprint verification&quot;&gt;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+&lt;!ENTITY authDialog.questionAndAnswer &quot;Question and answer&quot;&gt;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+&lt;!ENTITY authDialog.sharedSecret &quot;Shared secret&quot;&gt;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+&lt;!ENTITY authDialog.manualInstruction &quot;To verify the fingerprint, contact your intended chat partner via some other authenticated channel, such as the telephone or GPG-signed email. Each of you should tell your fingerprint to the other. If everything matches up, you should indicate in the dialog below that you have verified the fingerprint.&quot;&gt;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+&lt;!ENTITY authDialog.how &quot;How would you like to verify your contact's identity?&quot;&gt;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+&lt;!ENTITY authDialog.qaInstruction &quot;To verify their identity, pick a question whose answer is known only to you and your contact. Enter this question and answer, then wait for your contact to enter the answer as well. If the answers do not match, then you may be talking to an imposter.&quot;&gt;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+&lt;!ENTITY authDialog.secretInstruction &quot;To verify their identity, pick a secret known only to you and your contact. Enter this secret, then wait for your contact to enter it as well. If the secrets do not match, then you may be talking to an imposter.&quot;&gt;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+&lt;!ENTITY authDialog.question &quot;Enter question here:&quot;&gt;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+&lt;!ENTITY authDialog.answer &quot;Enter secret answer here (case sensitive):&quot;&gt;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+&lt;!ENTITY authDialog.secret &quot;Enter secret here:&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/chat/content/otr-auth.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,175 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+const {</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  l10nHelper,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+const {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  l10nHelper(&quot;chrome://chat/content/otr-auth.properties&quot;)</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+var [mode, uiConv, contactInfo] = window.arguments;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+// This window implements the interactive authentication of a buddy's</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+// key. At open time, we're given several parameters, and the &quot;mode&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+// parameter tells us, from where we've been called.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+// mode == &quot;pref&quot; means that we have been opened from the preferences,</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+// and it means we cannot rely on the other user being online, and</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+// we there might be no uiConv active currently, so we fall back.</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+document.title = _(&quot;auth.title&quot;,</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+  (mode === &quot;pref&quot;) ? contactInfo.screenname : uiConv.normalizedName);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+function showSection(selected, hideMenu) {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  document.getElementById(&quot;how&quot;).hidden = !!hideMenu;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  [ &quot;questionAndAnswer&quot;,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    &quot;sharedSecret&quot;,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    &quot;manualVerification&quot;,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    &quot;ask&quot;,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  ].forEach(function(key) {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    document.getElementById(key).hidden = (key !== selected);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  });</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  window.sizeToContent();</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+}</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+function startSMP(context, answer, question) {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  OTR.sendSecret(context, answer, question);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  OTR.authUpdate(context, 10);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+}</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+function manualVerification(fingerprint, context) {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  let opts = document.getElementById(&quot;verifiedOption&quot;);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  let trust = (opts.selectedItem.value === &quot;yes&quot;);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  OTR.setTrust(fingerprint, trust, context);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+}</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+function populateFingers(context, theirs, trust) {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  let fingers = document.getElementById(&quot;fingerprints&quot;);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  let yours = OTR.privateKeyFingerprint(context.account, context.protocol);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  if (!yours)</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    throw new Error(&quot;Fingerprint should already be generated.&quot;);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  fingers.value =</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+    _(&quot;auth.yourFingerprint&quot;, context.account, yours) + &quot;\n\n&quot; +</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+    _(&quot;auth.theirFingerprint&quot;, context.username, theirs);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  let opts = document.getElementById(&quot;verifiedOption&quot;);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  let verified = trust ? &quot;yes&quot; : &quot;no&quot;;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  for (let item of opts.menupopup.childNodes) {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    if (verified === item.value) {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+      opts.selectedItem = item;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+      break;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    }</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  }</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+}</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+var otrAuth = {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  onload() {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    document.addEventListener(&quot;dialogaccept&quot;, () =&gt; {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      return this.accept();</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+    });</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    document.addEventListener(&quot;dialogcancel&quot;, () =&gt; {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      return this.cancel();</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+    });</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    document.addEventListener(&quot;dialoghelp&quot;, () =&gt; {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+      return this.help();</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    });</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    let context, theirs;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    switch (mode) {</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+      case &quot;start&quot;:</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+        context = OTR.getContext(uiConv.target);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+        theirs = OTR.hashToHuman(context.fingerprint);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+        populateFingers(context, theirs, context.trust);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+        showSection(&quot;questionAndAnswer&quot;);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+        break;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+      case &quot;pref&quot;:</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        context = OTR.getContextFromRecipient(</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+          contactInfo.account,</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+          contactInfo.protocol,</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+          contactInfo.screenname</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+        );</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+        theirs = contactInfo.fingerprint;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+        populateFingers(context, theirs, contactInfo.trust);</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+        showSection(&quot;manualVerification&quot;, true);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+        this.oninput({ value: true });</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+        break;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+      case &quot;ask&quot;:</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+        document.getElementById(&quot;askLabel&quot;).textContent = contactInfo.question ?</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+          _(&quot;auth.question&quot;, contactInfo.question)</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+          : _(&quot;auth.secret&quot;);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        showSection(&quot;ask&quot;, true);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+        break;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+    }</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+  },</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  accept() {</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    // uiConv may not be present in pref mode</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+    let context = uiConv ? OTR.getContext(uiConv.target) : null;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    if (mode === &quot;pref&quot;) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+      manualVerification(contactInfo.fpointer, context);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+    } else if (mode === &quot;start&quot;) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+      let how = document.getElementById(&quot;howOption&quot;);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+      switch (how.selectedItem.value) {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+      case &quot;questionAndAnswer&quot;:</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+        let question = document.getElementById(&quot;question&quot;).value;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+        let answer = document.getElementById(&quot;answer&quot;).value;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+        startSMP(context, answer, question);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+        break;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+      case &quot;sharedSecret&quot;:</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+        let secret = document.getElementById(&quot;secret&quot;).value;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+        startSMP(context, secret);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+        break;</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+      case &quot;manualVerification&quot;:</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+        manualVerification(context.fingerprint, context);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+        break;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+      default:</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+        throw new Error(&quot;Unreachable!&quot;);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+      }</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    } else if (mode === &quot;ask&quot;) {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+      let response = document.getElementById(&quot;response&quot;).value;</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+      OTR.sendResponse(context, response);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+      OTR.authUpdate(context, contactInfo.progress);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    } else {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+      throw new Error(&quot;Unreachable!&quot;);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+    }</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+    return true;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+  },</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+  cancel() {</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    if (mode === &quot;ask&quot;) {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+      let context = OTR.getContext(uiConv.target);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+      OTR.abortSMP(context);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+    }</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  },</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+  oninput(e) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+    document.documentElement.getButton(&quot;accept&quot;).disabled = !e.value;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  },</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  how() {</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    let how = document.getElementById(&quot;howOption&quot;).selectedItem.value;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    switch (how) {</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+    case &quot;questionAndAnswer&quot;:</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+      this.oninput(document.getElementById(&quot;answer&quot;));</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+      break;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+    case &quot;sharedSecret&quot;:</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+      this.oninput(document.getElementById(&quot;secret&quot;));</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+      break;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    case &quot;manualVerification&quot;:</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+      this.oninput({ value: true });</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+      break;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+    }</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    showSection(how);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  },</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  help() {</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    Services.prompt.alert(window, _(&quot;auth.helpTitle&quot;), _(&quot;auth.help&quot;));</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+  },</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/chat/content/otr-auth.properties</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+# LOCALIZATION NOTE (auth.title): %S is the screen name of a chat contact person</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+auth.title=Verify the identity of %S</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+# LOCALIZATION NOTE (auth.yourFingerprint): 1st %S is the user's own screen name. 2nd %S is the fingerprint (a checksum) of the user's own encryption key.</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+auth.yourFingerprint=Fingerprint for you, %S:\n%S</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+# LOCALIZATION NOTE (auth.theirFingerprint): 1st %S is the screen name of a chat contact. 2nd %S is the fingerprint (a checksum) of the chat contact's encryption key.</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+auth.theirFingerprint=Purported fingerprint for %S:\n%S</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+auth.help=Verifying a contact's identity helps ensure that the person you are talking to is who they claim to be.</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+auth.helpTitle=Verification help</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+# LOCALIZATION NOTE (auth.question): %S is a question (any text is possible) that was received from a chat contact</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+auth.question=This is the question asked by your contact:\n\n%S\n\nEnter secret answer here (case sensitive):</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+auth.secret=Enter secret here:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/chat/content/otr-auth.xul</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,71 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot; ?&gt;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+&lt;!DOCTYPE window SYSTEM &quot;chrome://chat/content/otr-auth.dtd&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+&lt;dialog</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  id=&quot;otrAuthDialog&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  windowtype=&quot;OTR:Auth&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  title=&quot;&amp;authDialog.title;&quot;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  onload=&quot;otrAuth.onload()&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  buttons=&quot;accept,cancel,help&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  buttonlabelaccept=&quot;&amp;authDialog.authenticate;&quot;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  buttonlabelhelp=&quot;&amp;authDialog.help;&quot;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  buttondisabledaccept=&quot;true&quot;&gt;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://chat/content/otr-auth.js&quot; /&gt;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  &lt;groupbox id=&quot;how&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+    &lt;caption label=&quot;&amp;authDialog.how;&quot;/&gt;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    &lt;menulist id=&quot;howOption&quot; oncommand=&quot;otrAuth.how();&quot;&gt;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+      &lt;menupopup&gt;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+        &lt;menuitem label=&quot;&amp;authDialog.questionAndAnswer;&quot; value=&quot;questionAndAnswer&quot; /&gt;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+        &lt;menuitem label=&quot;&amp;authDialog.sharedSecret;&quot; value=&quot;sharedSecret&quot; /&gt;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+        &lt;menuitem label=&quot;&amp;authDialog.manualVerification;&quot; value=&quot;manualVerification&quot; /&gt;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+      &lt;/menupopup&gt;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+    &lt;/menulist&gt;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  &lt;/groupbox&gt;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  &lt;groupbox id=&quot;questionAndAnswer&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+    &lt;caption label=&quot;&amp;authDialog.questionAndAnswer;&quot; /&gt;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+    &lt;description style=&quot;width: 300px; white-space: pre-wrap;&quot;&gt;&amp;authDialog.qaInstruction;&lt;/description&gt;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+    &lt;label value=&quot;&amp;authDialog.question;&quot; control=&quot;question&quot; flex=&quot;1&quot; /&gt;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+    &lt;textbox id=&quot;question&quot; /&gt;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+    &lt;label value=&quot;&amp;authDialog.answer;&quot; control=&quot;answer&quot; flex=&quot;1&quot; /&gt;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    &lt;textbox id=&quot;answer&quot; oninput=&quot;otrAuth.oninput(this)&quot; /&gt;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  &lt;/groupbox&gt;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  &lt;groupbox id=&quot;sharedSecret&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    &lt;caption label=&quot;&amp;authDialog.sharedSecret;&quot; /&gt;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+    &lt;description style=&quot;width: 300px; white-space: pre-wrap;&quot;&gt;&amp;authDialog.secretInstruction;&lt;/description&gt;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    &lt;label value=&quot;&amp;authDialog.secret;&quot; control=&quot;secret&quot; flex=&quot;1&quot; /&gt;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    &lt;textbox id=&quot;secret&quot; oninput=&quot;otrAuth.oninput(this)&quot; /&gt;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  &lt;/groupbox&gt;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  &lt;groupbox id=&quot;manualVerification&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    &lt;caption label=&quot;&amp;authDialog.manualVerification;&quot; /&gt;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    &lt;description style=&quot;width: 300px; white-space: pre-wrap;&quot;&gt;&amp;authDialog.manualInstruction;&lt;/description&gt;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+    &lt;html:textarea id=&quot;fingerprints&quot; rows=&quot;5&quot; readonly=&quot;true&quot; /&gt;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+    &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+      &lt;label value=&quot;&amp;authDialog.verified;&quot; /&gt;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+      &lt;menulist id=&quot;verifiedOption&quot;&gt;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+        &lt;menupopup&gt;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+          &lt;menuitem label=&quot;&amp;authDialog.yes;&quot; value=&quot;yes&quot; /&gt;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+          &lt;menuitem label=&quot;&amp;authDialog.no;&quot; value=&quot;no&quot; /&gt;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+        &lt;/menupopup&gt;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+      &lt;/menulist&gt;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  &lt;/groupbox&gt;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  &lt;groupbox id=&quot;ask&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+    &lt;description id=&quot;askLabel&quot; style=&quot;width: 300px; white-space: pre-wrap;&quot; /&gt;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    &lt;textbox id=&quot;response&quot; oninput=&quot;otrAuth.oninput(this)&quot; /&gt;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  &lt;/groupbox&gt;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/chat/content/otr-chat.dtd</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+&lt;!ENTITY state.label        &quot;Encryption Status:&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+&lt;!ENTITY start.label        &quot;Start private conversation&quot;&gt;</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+&lt;!ENTITY end.label          &quot;End private conversation&quot;&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+&lt;!ENTITY auth.label         &quot;Verify your contact's identity&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/chat/content/otr-generate-key.dtd</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+&lt;!ENTITY privDialog.title &quot;Generating private key&quot;&gt;</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+&lt;!ENTITY privDialog.done &quot;Done&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/chat/content/otr-generate-key.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,29 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+const {</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+  l10nHelper,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+const {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+  l10nHelper(&quot;chrome://chat/content/otr-generate-key.properties&quot;)</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+var otrPriv = {</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  onload() {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+    let args = window.arguments[0].wrappedJSObject;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+    let priv = document.getElementById(&quot;priv&quot;);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+    priv.textContent = _(&quot;priv.account&quot;, args.account, OTR.protocolName(args.protocol));</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+    OTR.generatePrivateKey(args.account, args.protocol).then(function() {</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+      document.documentElement.getButton(&quot;accept&quot;).disabled = false;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+      document.documentElement.acceptDialog();</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+    }).catch(function(err) {</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+      document.documentElement.getButton(&quot;accept&quot;).disabled = false;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+      priv.textContent = _(&quot;priv.failed&quot;, String(err));</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    });</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  },</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/chat/content/otr-generate-key.properties</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+# LOCALIZATION NOTE (priv.account): 1st %S is the name of the user's own chat account. 2nd %S is the chat communication protocol used by that account.</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+priv.account=Generating private key for %S (%S) …</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+# LOCALIZATION NOTE (priv.failed): %S contains an error message that describes the cause of the failure</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+priv.failed=Generating key failed: %S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/chat/content/otr-generate-key.xul</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,26 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot; ?&gt;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+&lt;!DOCTYPE dialog [</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  &lt;!ENTITY % chatPrivDTD SYSTEM &quot;chrome://chat/content/otr-generate-key.dtd&quot;&gt;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  %chatPrivDTD;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+]&gt;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+&lt;dialog</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+  id=&quot;otrPrivDialog&quot;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+  windowtype=&quot;OTR:Priv&quot;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+  title=&quot;&amp;privDialog.title;&quot;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+  buttons=&quot;accept&quot;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+  buttonlabelaccept=&quot;&amp;privDialog.done;&quot;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  onload=&quot;otrPriv.onload()&quot;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  buttondisabledaccept=&quot;true&quot;&gt;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://chat/content/otr-generate-key.js&quot; /&gt;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  &lt;description id=&quot;priv&quot; style=&quot;width: 300px; white-space: pre-wrap;&quot;&gt;&lt;/description&gt;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/chat/content/otr.properties</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,72 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+# LOCALIZATION NOTE (msgevent.encryption_required_part1): %S is the name of a chat contact</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+msgevent.encryption_required_part1=You attempted to send an unencrypted message to %S. As a policy, unencrypted messages are not allowed.</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+msgevent.encryption_required_part2=Attempting to start a private conversation. Your message will be retransmitted when the private conversation starts.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+msgevent.encryption_error=An error occurred when encrypting your message. The message was not sent.</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+# LOCALIZATION NOTE (msgevent.connection_ended): %S is the name of a chat contact</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+msgevent.connection_ended=%S has already closed their private connection to you. Your message was not sent. Either end your private conversation, or restart it.</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+# LOCALIZATION NOTE (msgevent.setup_error): %S is the name of a chat contact</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+msgevent.setup_error=An error occured while setting up a private conversation with %S.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+# LOCALIZATION NOTE (msgevent.msg_reflected): do not translate OTR which is the name of an encryption protocol</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+msgevent.msg_reflected=You are receiving your own OTR messages. You are either trying to talk to yourself, or someone is reflecting your messages back at you.</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+# LOCALIZATION NOTE (msgevent.msg_resent): %S is the name of a chat contact</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+msgevent.msg_resent=The last message to %S was resent.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+# LOCALIZATION NOTE (msgevent.rcvdmsg_not_private): %S is the name of a chat contact</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+msgevent.rcvdmsg_not_private=The encrypted message received from %S is unreadable, as you are not currently communicating privately.</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+# LOCALIZATION NOTE (msgevent.rcvdmsg_unreadable): %S is the name of a chat contact</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+msgevent.rcvdmsg_unreadable=We received an unreadable encrypted message from %S.</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+# LOCALIZATION NOTE (msgevent.rcvdmsg_malformed): %S is the name of a chat contact</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+msgevent.rcvdmsg_malformed=We received a malformed data message from %S.</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+# LOCALIZATION NOTE (msgevent.log_heartbeat_rcvd): %S is the name of a chat contact. A Heartbeat is a technical message used to keep a connection alive.</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+msgevent.log_heartbeat_rcvd=Heartbeat received from %S.</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+# LOCALIZATION NOTE (msgevent.log_heartbeat_sent): %S is the name of a chat contact. A Heartbeat is a technical message used to keep a connection alive.</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+msgevent.log_heartbeat_sent=Heartbeat sent to %S.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+# LOCALIZATION NOTE (msgevent.rcvdmsg_general_err): do not translate OTR which is the name of an encryption protocol</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+msgevent.rcvdmsg_general_err=An OTR error occured.</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+# LOCALIZATION NOTE (msgevent.rcvdmsg_unencrypted): 1st %S is the name of a chat contact. 2nd %S is the message that was received.</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+msgevent.rcvdmsg_unencrypted=The following message received from %S was not encrypted: %S</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+# LOCALIZATION NOTE (msgevent.rcvdmsg_unrecognized): do not translate OTR which is the name of an encryption protocol. %S is the name of a chat contact.</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+msgevent.rcvdmsg_unrecognized=We received an unrecognized OTR message from %S.</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+# LOCALIZATION NOTE (msgevent.rcvdmsg_for_other_instance): %S is the name of a chat contact</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+msgevent.rcvdmsg_for_other_instance=%S has sent a message intended for a different session. If you are logged in multiple times, another session may have received the message.</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+# LOCALIZATION NOTE (context.gone_secure_private): %S is the name of a chat contact</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+context.gone_secure_private=Private conversation with %S started.</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+# LOCALIZATION NOTE (context.gone_secure_unverified): %S is the name of a chat contact</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+context.gone_secure_unverified=Private conversation with %S started. However, their identity has not been verified.</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+# LOCALIZATION NOTE (context.still_secure): %S is the name of a chat contact</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+context.still_secure=Successfully refreshed the private conversation with %S.</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+error.enc=Error occurred encrypting message.</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+# LOCALIZATION NOTE (error.not_priv): %S is the name of a chat contact</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+error.not_priv=You sent encrypted data to %S, who wasn't expecting it.</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+error.unreadable=You transmitted an unreadable encrypted message.</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+error.malformed=You transmitted a malformed data message.</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+resent=[resent]</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+# LOCALIZATION NOTE (tlv.disconnected): %S is the name of a chat contact</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+tlv.disconnected=%S has ended their private conversation with you; you should do the same.</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+# LOCALIZATION NOTE (query.msg): %S is the name of a chat contact. Do not translate &quot;Off-the-Record&quot; and &quot;OTR&quot; which is the name of an encryption protocol</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+query.msg=%S has requested an Off-the-Record (OTR) private conversation. However, you do not have a plugin to support that. See https://en.wikipedia.org/wiki/Off-the-Record_Messaging for more information.</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+trust.unused=Unused</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+trust.not_private=Not Private</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+trust.unverified=Unverified</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+trust.private=Private</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+trust.finished=Finished</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/chat/content/otrUI.properties</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,59 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+start.label=Start private conversation</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+refresh.label=Refresh private conversation</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+auth.label=Verify your contact's identity</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+auth.cancel=Cancel</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+auth.cancelAccessKey=C</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+auth.error=An error occurred while verifying your contact's identity.</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+auth.success=Verifying your contact's identity completed successfully.</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+auth.successThem=Your contact has successfully verified your identity. You may want to verify their identity as well by asking your own question.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+auth.fail=Failed to verify your contact's identity.</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+auth.waiting=Waiting for contact to complete verification …</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+reauth.label=Reverify your contact's identity</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+finger.verify=Verify</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+verify.accessKey=V</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+# LOCALIZATION NOTE (buddycontextmenu.label): do not translate OTR which is the name of an encryption protocol</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+buddycontextmenu.label=Add Contact's OTR Fingerprint</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+# LOCALIZATION NOTE (alert.start): %S is the name of a chat contact</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+alert.start=Attempting to start a private conversation with %S.</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+# LOCALIZATION NOTE (alert.refresh): %S is the name of a chat contact</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+alert.refresh=Attempting to refresh the private conversation with %S.</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+# LOCALIZATION NOTE (alert.gone_insecure): %S is the name of a chat contact</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+alert.gone_insecure=Private conversation with %S ended.</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+# LOCALIZATION NOTE (finger.unseen): %S is the name of a chat contact</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+finger.unseen=The identity of %S has not been verified yet. Casual eavesdropping is not possible, but with some effort someone could be listening in. You should verify this contact's identity.</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+state.not_private=The current conversation is not private.</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+# LOCALIZATION NOTE (state.unverified): %S is the name of a chat contact</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+state.unverified=The current conversation is private but the identity of %S has not been verified.</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+# LOCALIZATION NOTE (state.private): %S is the name of a chat contact</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+state.private=The current conversation is private and the identity of %S has been verified.</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+# LOCALIZATION NOTE (state.finished): %S is the name of a chat contact</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+state.finished=%S has ended their private conversation with you; you should do the same.</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+state.not_private.label=Insecure</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+state.unverified.label=Unverified</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+state.private.label=Private</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+state.finished.label=Finished</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+# LOCALIZATION NOTE (afterauth.private): %S is the name of a chat contact</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+afterauth.private=You have verified the identity of %S.</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+# LOCALIZATION NOTE (afterauth.unverified): %S is the name of a chat contact</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+afterauth.unverified=The identity of %S has not been verified.</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+verify.title=Verify your contact's identity</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+error.title=Error</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+success.title=End to End Encryption</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+successThem.title=Verify your contact's identity</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+fail.title=Unable to verify</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+waiting.title=Verification request sent</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/chat/content/otrWorker.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,54 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+/* eslint-env mozilla/chrome-worker, node */</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+importScripts(&quot;resource://gre/modules/workers/require.js&quot;);</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+var PromiseWorker = require(&quot;resource://gre/modules/workers/PromiseWorker.js&quot;);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+var Funcs = {};</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+// Only what we need from libotr.js</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+Funcs.generateKey = function(path, otrl_version, newkeySource) {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+  // eslint-disable-next-line no-eval</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  let newkey = eval(newkeySource);  // jshint ignore:line</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  let libotr = ctypes.open(path);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  let abi = ctypes.default_abi;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  let gcry_error_t = ctypes.unsigned_int;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+  // Initialize the OTR library. Pass the version of the API you are using.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  let otrl_init = libotr.declare(</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+    &quot;otrl_init&quot;, abi, gcry_error_t,</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+    ctypes.unsigned_int, ctypes.unsigned_int, ctypes.unsigned_int</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  );</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+  // Do the private key generation calculation. You may call this from a</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  // background thread.  When it completes, call</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  // otrl_privkey_generate_finish from the _main_ thread.</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  let otrl_privkey_generate_calculate = libotr.declare(</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+    &quot;otrl_privkey_generate_calculate&quot;, abi, gcry_error_t,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+    ctypes.void_t.ptr</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  );</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+  otrl_init.apply(libotr, otrl_version);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  let err = otrl_privkey_generate_calculate(newkey);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+  libotr.close();</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+  if (err)</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+    throw new Error(&quot;otrl_privkey_generate_calculate (&quot; + err + &quot;)&quot;);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+};</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+var worker = new PromiseWorker.AbstractWorker();</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+worker.dispatch = function(method, args = []) {</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+  return Funcs[method](...args);</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+};</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+worker.postMessage = function(res, ...args) {</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+  self.postMessage(res, ...args);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+};</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+worker.close = function() {</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+  self.close();</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+};</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+self.addEventListener(&quot;message&quot;, msg =&gt; worker.handleMessage(msg));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/locales/jar.mn</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/locales/jar.mn</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -17,8 +17,16 @@</span>
<a href="#l18.4"></a><span id="l18.4"> 	locale/@AB_CD@/chat/irc.properties	(%irc.properties)</span>
<a href="#l18.5"></a><span id="l18.5"> 	locale/@AB_CD@/chat/logger.properties	(%logger.properties)</span>
<a href="#l18.6"></a><span id="l18.6"> 	locale/@AB_CD@/chat/matrix.properties	(%matrix.properties)</span>
<a href="#l18.7"></a><span id="l18.7"> 	locale/@AB_CD@/chat/skype.properties	(%skype.properties)</span>
<a href="#l18.8"></a><span id="l18.8"> 	locale/@AB_CD@/chat/status.properties	(%status.properties)</span>
<a href="#l18.9"></a><span id="l18.9"> 	locale/@AB_CD@/chat/twitter.properties	(%twitter.properties)</span>
<a href="#l18.10"></a><span id="l18.10"> 	locale/@AB_CD@/chat/xmpp.properties	(%xmpp.properties)</span>
<a href="#l18.11"></a><span id="l18.11"> 	locale/@AB_CD@/chat/yahoo.properties	(%yahoo.properties)</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#	locale/@AB_CD@/chat/otr-auth.dtd	(%otr-auth.dtd)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+#	locale/@AB_CD@/chat/otr-auth.properties	(%otr-auth.properties)</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+#	locale/@AB_CD@/chat/otr-add-finger.dtd	(%otr-add-finger.dtd)</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+#	locale/@AB_CD@/chat/otr-add-finger.properties	(%otr-add-finger.properties)</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+#	locale/@AB_CD@/chat/otr.properties	(%otr.properties)</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+#	locale/@AB_CD@/chat/otr-generate-key.dtd	(%otr-generate-key.dtd)</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+#	locale/@AB_CD@/chat/otr-generate-key.properties	(%otr-generate-key.properties)</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+#	locale/@AB_CD@/chat/otrUI.properties	(%otrUI.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/chat/modules/CLib.jsm</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+const {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+var OS = Services.appinfo.OS.toLowerCase();</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+// type defs</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+var FILE = ctypes.StructType(&quot;FILE&quot;);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+var fname_t = ctypes.char.ptr;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+var wchar_t = ctypes.char16_t;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+// Set the abi and path to CLib based on the OS.</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+var libcAbi, libcPath;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+var strdup = &quot;strdup&quot;;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+var fopen = &quot;fopen&quot;;</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+switch (OS) {</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+case &quot;win32&quot;:</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+case &quot;winnt&quot;:</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+  libcAbi = ctypes.winapi_abi;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+  libcPath = ctypes.libraryName(&quot;msvcrt&quot;);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+  strdup = &quot;_strdup&quot;;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+  fopen = &quot;_wfopen&quot;;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  fname_t = wchar_t.ptr;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+  break;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+case &quot;darwin&quot;:</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+  libcAbi = ctypes.default_abi;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  libcPath = ctypes.libraryName(&quot;c&quot;);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+  break;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+case &quot;linux&quot;:</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+  libcAbi = ctypes.default_abi;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+  libcPath = &quot;libc.so.6&quot;;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+  break;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+default:</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  throw new Error(&quot;Unknown OS&quot;);</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+}</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+var libc = ctypes.open(libcPath);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+var CLib = {</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+  FILE,</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  memcmp: libc.declare(</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+    &quot;memcmp&quot;, libcAbi, ctypes.int,</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+    ctypes.size_t</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+  ),</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  free: libc.declare(</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+    &quot;free&quot;, libcAbi, ctypes.void_t,</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+    ctypes.void_t.ptr</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+  ),</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  strdup: libc.declare(</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+    strdup, libcAbi, ctypes.char.ptr,</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+    ctypes.char.ptr</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+  ),</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  fclose: libc.declare(</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+    &quot;fclose&quot;, libcAbi, ctypes.int,</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+    FILE.ptr</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  ),</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+  fopen: libc.declare(</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+    fopen, libcAbi, FILE.ptr,</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+    fname_t,</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+    fname_t</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  ),</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+};</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+// exports</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;CLib&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/chat/modules/OTR.jsm</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,1110 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+const {BasePromiseWorker} = ChromeUtils.import(&quot;resource://gre/modules/PromiseWorker.jsm&quot;);</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+const {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+const {</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+  l10nHelper,</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+const {CLib} = ChromeUtils.import(&quot;resource:///modules/CLib.jsm&quot;);</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+const {OTRLib} = ChromeUtils.import(&quot;resource:///modules/OTRLib.jsm&quot;);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+var workerPath = &quot;chrome://chat/content/otrWorker.js&quot;;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+const {OTRHelpers} = ChromeUtils.import(&quot;resource:///modules/OTRHelpers.jsm&quot;);</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+  l10nHelper(&quot;chrome://chat/content/otr.properties&quot;)</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+);</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+// some helpers</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+function setInterval(fn, delay) {</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+  let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+  timer.init(fn, delay, Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  return timer;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+}</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+function clearInterval(timer) {</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+  timer.cancel();</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+}</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+// See: https://developer.mozilla.org/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Working_with_data#Determining_if_two_pointers_are_equal</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+function comparePointers(p, q) {</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+  p = ctypes.cast(p, ctypes.uintptr_t).value.toString();</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  q = ctypes.cast(q, ctypes.uintptr_t).value.toString();</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  return p === q;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+}</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+function trustFingerprint(fingerprint) {</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  return (!fingerprint.isNull() &amp;&amp;</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+    !fingerprint.contents.trust.isNull() &amp;&amp;</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+    fingerprint.contents.trust.readString().length &gt; 0);</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+}</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+// Report whether you think the given user is online. Return 1 if you think</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+// they are, 0 if you think they aren't, -1 if you're not sure.</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+function isOnline(conv) {</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  let ret = -1;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+  if (conv.buddy)</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+    ret = conv.buddy.online ? 1 : 0;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  return ret;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+}</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+// Use the protocol name in user facing strings. See trac #16490</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+var names;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+function protocolName(aNormalizedName) {</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  if (!names) {</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+    names = new Map();</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+    let protocols = Services.core.getProtocols();</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+    while (protocols.hasMoreElements()) {</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+      let protocol = protocols.getNext();</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+      names.set(protocol.normalizedName, protocol.name);</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+    }</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  }</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+  return names.get(aNormalizedName) || aNormalizedName;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+}</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+// OTRLib context wrapper</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+function Context(context) {</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+  this._context = context;</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+}</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+Context.prototype = {</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+  constructor: Context,</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+  get username() { return this._context.contents.username.readString(); },</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+  get account() { return this._context.contents.accountname.readString(); },</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+  get protocol() { return this._context.contents.protocol.readString(); },</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+  get msgstate() { return this._context.contents.msgstate; },</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  get fingerprint() { return this._context.contents.active_fingerprint; },</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+  get trust() { return trustFingerprint(this.fingerprint); },</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+};</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+// otr module</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+var OTR = {</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+  hasRan: false,</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+  libLoaded: false,</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+  once() {</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+    this.hasRan = true;</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+    try {</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+      if (OTRLib &amp;&amp; OTRLib.init()) {</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+        this.initUiOps();</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+        OTR.libLoaded = true;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+      }</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+    } catch (e) {</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+      console.log(e);</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+    }</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+  },</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+  privateKeyPath: OTRHelpers.profilePath(&quot;otr.private_key&quot;),</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+  fingerprintsPath: OTRHelpers.profilePath(&quot;otr.fingerprints&quot;),</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+  instanceTagsPath: OTRHelpers.profilePath(&quot;otr.instance_tags&quot;),</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+  init(opts) {</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+    opts = opts || {};</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+    if (!this.hasRan)</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+      this.once();</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+    if (!OTR.libLoaded)</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+      return;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+    this.verifyNudge = !!opts.verifyNudge;</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+    this.setPolicy(opts.requireEncryption);</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+    this.userstate = OTRLib.otrl_userstate_create();</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+    // A map of UIConvs, keyed on the target.id</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+    this._convos = new Map();</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+    this._observers = [];</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+    this._buffer = [];</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+    this._poll_timer = null;</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+    // Async sending may fail in the transport protocols, so periodically</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+    // drop old messages from the internal buffer. Should be rare.</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+    const pluck_time = 1 * 60 * 1000;</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+    this._pluck_timer = setInterval(() =&gt; {</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+      let buf = this._buffer;</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+      for (let i = 0; i &lt; buf.length;) {</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+        if ((Date.now() - buf[i].time) &gt; pluck_time) {</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+          this.log(&quot;dropping an old message: &quot; + buf[i].display);</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+          buf.splice(i, 1);</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+        } else {</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+          i += 1;</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+        }</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+      }</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+    }, pluck_time);</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+  },</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+  close() {</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+    if (this._poll_timer) {</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+      clearInterval(this._poll_timer);</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+      this._poll_timer = null;</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+    }</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+    if (this._pluck_timer) {</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+      clearInterval(this._pluck_timer);</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+      this._pluck_timer = null;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+    }</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+    this._buffer = null;</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+  },</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+  log(msg) {</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+    this.notifyObservers(msg, &quot;otr:log&quot;);</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+  },</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+  protocolName,</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+  setPolicy(requireEncryption) {</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+    if (!OTR.libLoaded)</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+      return;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+    this.policy = requireEncryption</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+      ? OTRLib.OTRL_POLICY_ALWAYS</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+      : OTRLib.OTRL_POLICY_OPPORTUNISTIC;</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+  },</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+  // load stored files from my profile</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+  loadFiles() {</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+    return Promise.all([</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+      OS.File.exists(this.privateKeyPath).then((exists) =&gt; {</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+        if (exists &amp;&amp; OTRLib.otrl_privkey_read(</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+          this.userstate, this.privateKeyPath</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+        )) throw new Error(&quot;Failed to read private keys.&quot;);</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+      }),</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+      OS.File.exists(this.fingerprintsPath).then((exists) =&gt; {</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+        if (exists &amp;&amp; OTRLib.otrl_privkey_read_fingerprints(</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+          this.userstate, this.fingerprintsPath, null, null</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+        )) throw new Error(&quot;Failed to read fingerprints.&quot;);</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+      }),</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+      OS.File.exists(this.instanceTagsPath).then((exists) =&gt; {</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+        if (exists &amp;&amp; OTRLib.otrl_instag_read(</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+          this.userstate, this.instanceTagsPath</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+        )) throw new Error(&quot;Failed to read instance tags.&quot;);</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+      }),</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+    ]);</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+  },</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+  // generate a private key in a worker</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+  generatePrivateKey(account, protocol) {</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+    let newkey = new ctypes.void_t.ptr();</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+    let err = OTRLib.otrl_privkey_generate_start(</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+      OTR.userstate, account, protocol, newkey.address()</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+    );</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineplus">+    if (err || newkey.isNull())</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+      return Promise.reject(&quot;otrl_privkey_generate_start (&quot; + err + &quot;)&quot;);</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+    let worker = new BasePromiseWorker(workerPath);</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+    return worker.post(&quot;generateKey&quot;, [</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineplus">+      OTRLib.path, OTRLib.otrl_version, newkey.toSource(),</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+    ]).then(function() {</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+      let err = OTRLib.otrl_privkey_generate_finish(</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+        OTR.userstate, newkey, OTR.privateKeyPath</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+      );</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+      if (err)</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineplus">+        throw new Error(&quot;otrl_privkey_generate_calculate (&quot; + err + &quot;)&quot;);</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+    }).catch(function(err) {</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineplus">+      if (!newkey.isNull())</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineplus">+        OTRLib.otrl_privkey_generate_cancelled(OTR.userstate, newkey);</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineplus">+      throw err;</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+    });</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+  },</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+  // write fingerprints to file synchronously</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+  writeFingerprints() {</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+    if (OTRLib.otrl_privkey_write_fingerprints(</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+      this.userstate, this.fingerprintsPath</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineplus">+    )) throw new Error(&quot;Failed to write fingerprints.&quot;);</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineplus">+  },</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+  // generate instance tag synchronously</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+  generateInstanceTag(account, protocol) {</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+    if (OTRLib.otrl_instag_generate(</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+      this.userstate, this.instanceTagsPath, account, protocol</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+    )) throw new Error(&quot;Failed to generate instance tag.&quot;);</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+  },</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+  // get my fingerprint</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+  privateKeyFingerprint(account, protocol) {</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+    let fingerprint = OTRLib.otrl_privkey_fingerprint(</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+      this.userstate, new OTRLib.fingerprint_t(), account, protocol</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+    );</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+    return fingerprint.isNull() ? null : fingerprint.readString();</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+  },</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+  // return a human readable string for a fingerprint</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+  hashToHuman(fingerprint) {</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+    let hash = fingerprint.contents.fingerprint;</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+    if (hash.isNull())</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+      throw Error(&quot;No fingerprint found.&quot;);</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineplus">+    let human = new OTRLib.fingerprint_t();</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+    OTRLib.otrl_privkey_hash_to_human(human, hash);</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineplus">+    return human.readString();</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+  },</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineplus">+</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+  base64encode(data, dataLen) {</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+    // CData objects are initialized with zeroes.  The plus one gives us</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+    // our null byte so that readString below is safe.</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineplus">+    let buf = ctypes.char.array(Math.floor((dataLen + 2) / 3) * 4 + 1)();</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineplus">+    OTRLib.otrl_base64_encode(buf, data, dataLen); // ignore returned size</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineplus">+    return buf.readString();  // str</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineplus">+  },</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineplus">+</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+  base64decode(str) {</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+    let size = str.length;</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+    // +1 here so that we're safe in calling readString on data in the tests.</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineplus">+    let data = ctypes.unsigned_char.array(Math.floor((size + 3) / 4) * 3 + 1)();</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+    OTRLib.otrl_base64_decode(data, str, size); // ignore returned len</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineplus">+    // We aren't returning the dataLen since we know the hash length in our</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+    // one use case so far.</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineplus">+    return data;</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+  },</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineplus">+</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineplus">+  getTrustLevel(context) {</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineplus">+    let level = OTR.trust(context);</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+    if (level === OTR.trustState.TRUST_PRIVATE) {</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineplus">+      return OTR.trustState.TRUST_PRIVATE;</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+    } else if (level === OTR.trustState.TRUST_UNVERIFIED) {</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineplus">+      return OTR.trustState.TRUST_UNVERIFIED;</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineplus">+    } else if (level === OTR.trustState.TRUST_FINISHED) {</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineplus">+      return OTR.trustState.TRUST_FINISHED;</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineplus">+    }</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineplus">+    return OTR.trustState.TRUST_NOT_PRIVATE;</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+  },</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineplus">+  getStatus(level) {</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineplus">+    switch (level) {</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineplus">+    case OTR.trustState.TRUST_NOT_PRIVATE:</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineplus">+      return _(&quot;trust.not_private&quot;);</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineplus">+    case OTR.trustState.TRUST_UNVERIFIED:</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineplus">+      return _(&quot;trust.unverified&quot;);</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineplus">+    case OTR.trustState.TRUST_PRIVATE:</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineplus">+      return _(&quot;trust.private&quot;);</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineplus">+    case OTR.trustState.TRUST_FINISHED:</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineplus">+      return _(&quot;trust.finished&quot;);</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineplus">+    }</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineplus">+    throw new Error(&quot;unknown level&quot;);</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineplus">+  },</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineplus">+</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineplus">+  // get list of known fingerprints</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineplus">+  knownFingerprints() {</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+    let fps = [];</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+    for (</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineplus">+      let context = this.userstate.contents.context_root;</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+      !context.isNull();</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineplus">+      context = context.contents.next</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineplus">+    ) {</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineplus">+      // skip child contexts</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineplus">+      if (!comparePointers(context.contents.m_context, context))</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineplus">+        continue;</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineplus">+      let wContext = new Context(context);</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineplus">+      for (</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineplus">+        let fingerprint = context.contents.fingerprint_root.next;</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+        !fingerprint.isNull();</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineplus">+        fingerprint = fingerprint.contents.next</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineplus">+      ) {</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineplus">+        let trust = trustFingerprint(fingerprint);</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineplus">+        let used = false;</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineplus">+        let best_level = OTR.trustState.TRUST_NOT_PRIVATE;</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineplus">+        for (</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineplus">+          let context_itr = context;</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineplus">+          !context_itr.isNull() &amp;&amp;</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineplus">+            comparePointers(context_itr.contents.m_context, context);</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineplus">+          context_itr = context_itr.contents.next</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineplus">+        ) {</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineplus">+          if (comparePointers(</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineplus">+            context_itr.contents.active_fingerprint, fingerprint</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineplus">+          )) {</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineplus">+            used = true;</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineplus">+            best_level = OTR.getTrustLevel(new Context(context_itr));</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineplus">+          }</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineplus">+        }</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineplus">+        fps.push({</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineplus">+          fpointer: fingerprint.contents.address(),</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineplus">+          fingerprint: OTR.hashToHuman(fingerprint),</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineplus">+          screenname: wContext.username,</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineplus">+          account: wContext.account,</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineplus">+          protocol: wContext.protocol,</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineplus">+          trust,</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineplus">+          status: used ? OTR.getStatus(best_level) : _(&quot;trust.unused&quot;),</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineplus">+          purge: false,</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineplus">+        });</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineplus">+      }</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+    }</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineplus">+    return fps;</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineplus">+  },</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineplus">+</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineplus">+  forgetFingerprints(fps) {</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineplus">+    let write = false;</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineplus">+    fps.forEach(function(obj, i) {</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineplus">+      if (!obj.purge)</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineplus">+        return;</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineplus">+      obj.purge = false;  // reset early</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineplus">+      let fingerprint = obj.fpointer;</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineplus">+      if (fingerprint.isNull())</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineplus">+        return;</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineplus">+      // don't do anything if fp is active and we're in an encrypted state</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineplus">+      let context = fingerprint.contents.context.contents.m_context;</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineplus">+      for (</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineplus">+        let context_itr = context;</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineplus">+        !context_itr.isNull() &amp;&amp;</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineplus">+          comparePointers(context_itr.contents.m_context, context);</span>
<a href="#l20.359"></a><span id="l20.359" class="difflineplus">+        context_itr = context_itr.contents.next</span>
<a href="#l20.360"></a><span id="l20.360" class="difflineplus">+      ) {</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineplus">+        if (</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineplus">+          context_itr.contents.msgstate === OTRLib.messageState.OTRL_MSGSTATE_ENCRYPTED &amp;&amp;</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineplus">+          comparePointers(context_itr.contents.active_fingerprint, fingerprint)</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineplus">+        ) return;</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineplus">+      }</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineplus">+      write = true;</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineplus">+      OTRLib.otrl_context_forget_fingerprint(fingerprint, 1);</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineplus">+      fps[i] = null;  // null out removed fps</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineplus">+    });</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineplus">+    if (write)</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineplus">+      OTR.writeFingerprints();</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineplus">+  },</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineplus">+</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineplus">+  addFingerprint(context, hex) {</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineplus">+    let fingerprint = new OTRLib.hash_t();</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineplus">+    if (hex.length != 40) throw new Error(&quot;Invalid fingerprint value.&quot;);</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineplus">+    let bytes = hex.match(/.{1,2}/g);</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineplus">+    for (let i = 0; i &lt; 20; i++)</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineplus">+      fingerprint[i] = parseInt(bytes[i], 16);</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineplus">+    return OTRLib.otrl_context_find_fingerprint(context._context, fingerprint, 1, null);</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+  },</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineplus">+  getFingerprintsForRecipient(account, protocol, recipient) {</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineplus">+    let fingers = OTR.knownFingerprints();</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineplus">+    return fingers.filter(function(fg) {</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineplus">+      return fg.account == account &amp;&amp;</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineplus">+             fg.protocol == protocol &amp;&amp;</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineplus">+             fg.screenname == recipient;</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineplus">+    });</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineplus">+  },</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineplus">+</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineplus">+  isFingerprintTrusted(fingerprint) {</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineplus">+    return !!OTRLib.otrl_context_is_fingerprint_trusted(fingerprint);</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineplus">+  },</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineplus">+  // update trust in fingerprint</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineplus">+  setTrust(fingerprint, trust, context) {</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineplus">+    // ignore if no change in trust</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineplus">+    if (context &amp;&amp; (trust === context.trust))</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineplus">+      return;</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineplus">+    OTRLib.otrl_context_set_trust(fingerprint, trust ? &quot;verified&quot; : &quot;&quot;);</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineplus">+    this.writeFingerprints();</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineplus">+    if (context)</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineplus">+      this.notifyTrust(context);</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineplus">+  },</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineplus">+</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineplus">+  notifyTrust(context) {</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineplus">+    this.notifyObservers(context, &quot;otr:msg-state&quot;);</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineplus">+    this.notifyObservers(context, &quot;otr:trust-state&quot;);</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineplus">+  },</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineplus">+</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineplus">+  authUpdate(context, progress, success) {</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineplus">+    this.notifyObservers({</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineplus">+      context,</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineplus">+      progress,</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineplus">+      success,</span>
<a href="#l20.417"></a><span id="l20.417" class="difflineplus">+    }, &quot;otr:auth-update&quot;);</span>
<a href="#l20.418"></a><span id="l20.418" class="difflineplus">+  },</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineplus">+</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineplus">+  // expose message states</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineplus">+  getMessageState() {</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineplus">+    return OTRLib.messageState;</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineplus">+  },</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineplus">+</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineplus">+  // get context from conv</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineplus">+  getContext(conv) {</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineplus">+    let context = OTRLib.otrl_context_find(</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineplus">+      this.userstate,</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineplus">+      conv.normalizedName,</span>
<a href="#l20.430"></a><span id="l20.430" class="difflineplus">+      conv.account.normalizedName,</span>
<a href="#l20.431"></a><span id="l20.431" class="difflineplus">+      // TODO: check why sometimes normalizedName is undefined, and if</span>
<a href="#l20.432"></a><span id="l20.432" class="difflineplus">+      // that's ok. Fallback wasn't necessary in the original code.</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineplus">+      conv.account.protocol.normalizedName || &quot;&quot;,</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_BEST, 1, null, null, null</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineplus">+    );</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineplus">+    return new Context(context);</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineplus">+  },</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineplus">+</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineplus">+  getContextFromRecipient(account, protocol, recipient) {</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineplus">+    let context = OTRLib.otrl_context_find(</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineplus">+      this.userstate, recipient, account, protocol,</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_BEST, 1, null, null, null</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineplus">+    );</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineplus">+    return new Context(context);</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineplus">+  },</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineplus">+</span>
<a href="#l20.447"></a><span id="l20.447" class="difflineplus">+  getUIConvFromContext(context) {</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineplus">+    return this.getUIConvForRecipient(</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineplus">+      context.account, context.protocol, context.username</span>
<a href="#l20.450"></a><span id="l20.450" class="difflineplus">+    );</span>
<a href="#l20.451"></a><span id="l20.451" class="difflineplus">+  },</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineplus">+</span>
<a href="#l20.453"></a><span id="l20.453" class="difflineplus">+  getUIConvForRecipient(account, protocol, recipient) {</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineplus">+    let uiConvs = this._convos.values();</span>
<a href="#l20.455"></a><span id="l20.455" class="difflineplus">+    let uiConv = uiConvs.next();</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineplus">+    while (!uiConv.done) {</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineplus">+      let conv = uiConv.value.target;</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineplus">+      if (conv.account.normalizedName === account &amp;&amp;</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineplus">+          conv.account.protocol.normalizedName === protocol &amp;&amp;</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineplus">+          conv.normalizedName === recipient) {</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineplus">+          // console.log(&quot;=== getUIConvForRecipient found, account: &quot; + account + &quot;  protocol: &quot; + protocol + &quot;  recip: &quot; + recipient);</span>
<a href="#l20.462"></a><span id="l20.462" class="difflineplus">+        return uiConv.value;</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineplus">+      }</span>
<a href="#l20.464"></a><span id="l20.464" class="difflineplus">+      uiConv = uiConvs.next();</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineplus">+    }</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineplus">+    throw new Error(&quot;Couldn't find conversation.&quot;);</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineplus">+  },</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineplus">+</span>
<a href="#l20.469"></a><span id="l20.469" class="difflineplus">+  getUIConvFromConv(conv) {</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineplus">+    // return this._convos.get(conv.id);</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineplus">+    return Services.conversations.getUIConversation(conv);</span>
<a href="#l20.472"></a><span id="l20.472" class="difflineplus">+  },</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineplus">+</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineplus">+  disconnect(conv, remove) {</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineplus">+    OTRLib.otrl_message_disconnect(</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineplus">+      this.userstate,</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineplus">+      this.uiOps.address(),</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineplus">+      null,</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineplus">+      conv.account.normalizedName,</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineplus">+      conv.account.protocol.normalizedName,</span>
<a href="#l20.481"></a><span id="l20.481" class="difflineplus">+      conv.normalizedName,</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_BEST</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineplus">+    );</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineplus">+    if (remove) {</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineplus">+      let uiConv = this.getUIConvFromConv(conv);</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineplus">+      if (uiConv)</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineplus">+        this.removeConversation(uiConv);</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineplus">+    } else</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineplus">+      this.notifyObservers(this.getContext(conv), &quot;otr:disconnected&quot;);</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineplus">+  },</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineplus">+</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineplus">+  sendQueryMsg(conv) {</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineplus">+    let query = OTRLib.otrl_proto_default_query_msg(</span>
<a href="#l20.494"></a><span id="l20.494" class="difflineplus">+      conv.account.normalizedName,</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineplus">+      this.policy</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineplus">+    );</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineplus">+    if (query.isNull()) {</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineplus">+      Cu.reportError(new Error(&quot;Sending query message failed.&quot;));</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineplus">+      return;</span>
<a href="#l20.500"></a><span id="l20.500" class="difflineplus">+    }</span>
<a href="#l20.501"></a><span id="l20.501" class="difflineplus">+    // Use the default msg to format the version.</span>
<a href="#l20.502"></a><span id="l20.502" class="difflineplus">+    // We don't supprt v1 of the protocol so this should be fine.</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineplus">+    let queryMsg = /^\?OTR.*?\?/.exec(query.readString())[0] + &quot;\n&quot;;</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineplus">+    queryMsg += _(&quot;query.msg&quot;, conv.account.normalizedName);</span>
<a href="#l20.505"></a><span id="l20.505" class="difflineplus">+    conv.sendMsg(queryMsg);</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineplus">+    OTRLib.otrl_message_free(query);</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineplus">+  },</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineplus">+</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineplus">+  trustState: {</span>
<a href="#l20.510"></a><span id="l20.510" class="difflineplus">+    TRUST_NOT_PRIVATE: 0,</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineplus">+    TRUST_UNVERIFIED: 1,</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineplus">+    TRUST_PRIVATE: 2,</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineplus">+    TRUST_FINISHED: 3,</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineplus">+  },</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineplus">+</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineplus">+  // Check the attributes of the OTR context, and derive how that maps</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineplus">+  // to one of the above trust states, which we'll show to the user.</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineplus">+  // If we have an encrypted channel, it depends on the presence of a</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineplus">+  // context.trust object, if we treat is as private or unverified.</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineplus">+  trust(context) {</span>
<a href="#l20.521"></a><span id="l20.521" class="difflineplus">+    let level = this.trustState.TRUST_NOT_PRIVATE;</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineplus">+    switch (context.msgstate) {</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineplus">+      case OTRLib.messageState.OTRL_MSGSTATE_ENCRYPTED:</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineplus">+        level = context.trust</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineplus">+          ? this.trustState.TRUST_PRIVATE</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineplus">+          : this.trustState.TRUST_UNVERIFIED;</span>
<a href="#l20.527"></a><span id="l20.527" class="difflineplus">+        break;</span>
<a href="#l20.528"></a><span id="l20.528" class="difflineplus">+      case OTRLib.messageState.OTRL_MSGSTATE_FINISHED:</span>
<a href="#l20.529"></a><span id="l20.529" class="difflineplus">+        level = this.trustState.TRUST_FINISHED;</span>
<a href="#l20.530"></a><span id="l20.530" class="difflineplus">+        break;</span>
<a href="#l20.531"></a><span id="l20.531" class="difflineplus">+    }</span>
<a href="#l20.532"></a><span id="l20.532" class="difflineplus">+    return level;</span>
<a href="#l20.533"></a><span id="l20.533" class="difflineplus">+  },</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineplus">+</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineplus">+  // uiOps callbacks</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineplus">+</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineplus">+  // Return the OTR policy for the given context.</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineplus">+  policy_cb(opdata, context) {</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineplus">+    return this.policy;</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineplus">+  },</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineplus">+</span>
<a href="#l20.542"></a><span id="l20.542" class="difflineplus">+  // Create a private key for the given accountname/protocol if desired.</span>
<a href="#l20.543"></a><span id="l20.543" class="difflineplus">+  create_privkey_cb(opdata, accountname, protocol) {</span>
<a href="#l20.544"></a><span id="l20.544" class="difflineplus">+    let args = {</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineplus">+      account: accountname.readString(),</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineplus">+      protocol: protocol.readString(),</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineplus">+    };</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineplus">+    this.notifyObservers(args, &quot;otr:generate&quot;);</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineplus">+  },</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineplus">+</span>
<a href="#l20.551"></a><span id="l20.551" class="difflineplus">+  // Report whether you think the given user is online. Return 1 if you think</span>
<a href="#l20.552"></a><span id="l20.552" class="difflineplus">+  // they are, 0 if you think they aren't, -1 if you're not sure.</span>
<a href="#l20.553"></a><span id="l20.553" class="difflineplus">+  is_logged_in_cb(opdata, accountname, protocol, recipient) {</span>
<a href="#l20.554"></a><span id="l20.554" class="difflineplus">+    let conv = this.getUIConvForRecipient(</span>
<a href="#l20.555"></a><span id="l20.555" class="difflineplus">+      accountname.readString(),</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineplus">+      protocol.readString(),</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineplus">+      recipient.readString()</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineplus">+    ).target;</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineplus">+    return isOnline(conv);</span>
<a href="#l20.560"></a><span id="l20.560" class="difflineplus">+  },</span>
<a href="#l20.561"></a><span id="l20.561" class="difflineplus">+</span>
<a href="#l20.562"></a><span id="l20.562" class="difflineplus">+  // Send the given IM to the given recipient from the given</span>
<a href="#l20.563"></a><span id="l20.563" class="difflineplus">+  // accountname/protocol.</span>
<a href="#l20.564"></a><span id="l20.564" class="difflineplus">+  inject_message_cb(opdata, accountname, protocol, recipient, message) {</span>
<a href="#l20.565"></a><span id="l20.565" class="difflineplus">+    let aMsg = message.readString();</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineplus">+    this.log(&quot;inject_message_cb (msglen:&quot; + aMsg.length + &quot;): &quot; + aMsg);</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineplus">+    this.getUIConvForRecipient(</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineplus">+      accountname.readString(),</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineplus">+      protocol.readString(),</span>
<a href="#l20.570"></a><span id="l20.570" class="difflineplus">+      recipient.readString()</span>
<a href="#l20.571"></a><span id="l20.571" class="difflineplus">+    ).target.sendMsg(aMsg);</span>
<a href="#l20.572"></a><span id="l20.572" class="difflineplus">+  },</span>
<a href="#l20.573"></a><span id="l20.573" class="difflineplus">+</span>
<a href="#l20.574"></a><span id="l20.574" class="difflineplus">+  // A new fingerprint for the given user has been received.</span>
<a href="#l20.575"></a><span id="l20.575" class="difflineplus">+  new_fingerprint_cb(opdata, us, accountname, protocol, username, fingerprint) {</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineplus">+    let context = OTRLib.otrl_context_find(</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineplus">+      us, username, accountname, protocol,</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_MASTER, 1, null, null, null</span>
<a href="#l20.579"></a><span id="l20.579" class="difflineplus">+    );</span>
<a href="#l20.580"></a><span id="l20.580" class="difflineplus">+</span>
<a href="#l20.581"></a><span id="l20.581" class="difflineplus">+    let seen = false;</span>
<a href="#l20.582"></a><span id="l20.582" class="difflineplus">+    let fp = context.contents.fingerprint_root.next;</span>
<a href="#l20.583"></a><span id="l20.583" class="difflineplus">+    while (!fp.isNull()) {</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineplus">+      if (CLib.memcmp(fingerprint, fp.contents.fingerprint, new ctypes.size_t(20))) {</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineplus">+        seen = true;</span>
<a href="#l20.586"></a><span id="l20.586" class="difflineplus">+        break;</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineplus">+      }</span>
<a href="#l20.588"></a><span id="l20.588" class="difflineplus">+      fp = fp.contents.next;</span>
<a href="#l20.589"></a><span id="l20.589" class="difflineplus">+    }</span>
<a href="#l20.590"></a><span id="l20.590" class="difflineplus">+</span>
<a href="#l20.591"></a><span id="l20.591" class="difflineplus">+    // Only nudge on new fingerprint, as opposed to always.</span>
<a href="#l20.592"></a><span id="l20.592" class="difflineplus">+    if (!this.verifyNudge)</span>
<a href="#l20.593"></a><span id="l20.593" class="difflineplus">+      this.notifyObservers(new Context(context), &quot;otr:unverified&quot;,</span>
<a href="#l20.594"></a><span id="l20.594" class="difflineplus">+        (seen ? &quot;seen&quot; : &quot;unseen&quot;));</span>
<a href="#l20.595"></a><span id="l20.595" class="difflineplus">+  },</span>
<a href="#l20.596"></a><span id="l20.596" class="difflineplus">+</span>
<a href="#l20.597"></a><span id="l20.597" class="difflineplus">+  // The list of known fingerprints has changed.  Write them to disk.</span>
<a href="#l20.598"></a><span id="l20.598" class="difflineplus">+  write_fingerprint_cb(opdata) {</span>
<a href="#l20.599"></a><span id="l20.599" class="difflineplus">+    this.writeFingerprints();</span>
<a href="#l20.600"></a><span id="l20.600" class="difflineplus">+  },</span>
<a href="#l20.601"></a><span id="l20.601" class="difflineplus">+</span>
<a href="#l20.602"></a><span id="l20.602" class="difflineplus">+  // A ConnContext has entered a secure state.</span>
<a href="#l20.603"></a><span id="l20.603" class="difflineplus">+  gone_secure_cb(opdata, context) {</span>
<a href="#l20.604"></a><span id="l20.604" class="difflineplus">+    context = new Context(context);</span>
<a href="#l20.605"></a><span id="l20.605" class="difflineplus">+    let str = &quot;context.gone_secure_&quot; + (context.trust ? &quot;private&quot; : &quot;unverified&quot;);</span>
<a href="#l20.606"></a><span id="l20.606" class="difflineplus">+    this.notifyObservers(context, &quot;otr:msg-state&quot;);</span>
<a href="#l20.607"></a><span id="l20.607" class="difflineplus">+    this.sendAlert(context, _(str, context.username));</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineplus">+    if (this.verifyNudge &amp;&amp; !context.trust)</span>
<a href="#l20.609"></a><span id="l20.609" class="difflineplus">+      this.notifyObservers(context, &quot;otr:unverified&quot;, &quot;unseen&quot;);</span>
<a href="#l20.610"></a><span id="l20.610" class="difflineplus">+  },</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineplus">+</span>
<a href="#l20.612"></a><span id="l20.612" class="difflineplus">+  // A ConnContext has left a secure state.</span>
<a href="#l20.613"></a><span id="l20.613" class="difflineplus">+  gone_insecure_cb(opdata, context) {</span>
<a href="#l20.614"></a><span id="l20.614" class="difflineplus">+    // This isn't used. See: https://bugs.otr.im/lib/libotr/issues/48</span>
<a href="#l20.615"></a><span id="l20.615" class="difflineplus">+  },</span>
<a href="#l20.616"></a><span id="l20.616" class="difflineplus">+</span>
<a href="#l20.617"></a><span id="l20.617" class="difflineplus">+  // We have completed an authentication, using the D-H keys we already knew.</span>
<a href="#l20.618"></a><span id="l20.618" class="difflineplus">+  // is_reply indicates whether we initiated the AKE.</span>
<a href="#l20.619"></a><span id="l20.619" class="difflineplus">+  still_secure_cb(opdata, context, is_reply) {</span>
<a href="#l20.620"></a><span id="l20.620" class="difflineplus">+    // Indicate the private conversation was refreshed.</span>
<a href="#l20.621"></a><span id="l20.621" class="difflineplus">+    if (!is_reply) {</span>
<a href="#l20.622"></a><span id="l20.622" class="difflineplus">+      context = new Context(context);</span>
<a href="#l20.623"></a><span id="l20.623" class="difflineplus">+      this.notifyObservers(context, &quot;otr:msg-state&quot;);</span>
<a href="#l20.624"></a><span id="l20.624" class="difflineplus">+      this.sendAlert(context, _(&quot;context.still_secure&quot;, context.username));</span>
<a href="#l20.625"></a><span id="l20.625" class="difflineplus">+    }</span>
<a href="#l20.626"></a><span id="l20.626" class="difflineplus">+  },</span>
<a href="#l20.627"></a><span id="l20.627" class="difflineplus">+</span>
<a href="#l20.628"></a><span id="l20.628" class="difflineplus">+  // Find the maximum message size supported by this protocol.</span>
<a href="#l20.629"></a><span id="l20.629" class="difflineplus">+  max_message_size_cb(opdata, context) {</span>
<a href="#l20.630"></a><span id="l20.630" class="difflineplus">+    context = new Context(context);</span>
<a href="#l20.631"></a><span id="l20.631" class="difflineplus">+    // These values are, for the most part, from pidgin-otr's mms_table.</span>
<a href="#l20.632"></a><span id="l20.632" class="difflineplus">+    switch (context.protocol) {</span>
<a href="#l20.633"></a><span id="l20.633" class="difflineplus">+    case &quot;irc&quot;:</span>
<a href="#l20.634"></a><span id="l20.634" class="difflineplus">+    case &quot;prpl-irc&quot;:</span>
<a href="#l20.635"></a><span id="l20.635" class="difflineplus">+      return 417;</span>
<a href="#l20.636"></a><span id="l20.636" class="difflineplus">+    case &quot;facebook&quot;:</span>
<a href="#l20.637"></a><span id="l20.637" class="difflineplus">+    case &quot;gtalk&quot;:</span>
<a href="#l20.638"></a><span id="l20.638" class="difflineplus">+    case &quot;odnoklassniki&quot;:</span>
<a href="#l20.639"></a><span id="l20.639" class="difflineplus">+    case &quot;jabber&quot;:</span>
<a href="#l20.640"></a><span id="l20.640" class="difflineplus">+    case &quot;xmpp&quot;:</span>
<a href="#l20.641"></a><span id="l20.641" class="difflineplus">+      return 65536;</span>
<a href="#l20.642"></a><span id="l20.642" class="difflineplus">+    case &quot;prpl-yahoo&quot;:</span>
<a href="#l20.643"></a><span id="l20.643" class="difflineplus">+      return 799;</span>
<a href="#l20.644"></a><span id="l20.644" class="difflineplus">+    case &quot;prpl-msn&quot;:</span>
<a href="#l20.645"></a><span id="l20.645" class="difflineplus">+      return 1409;</span>
<a href="#l20.646"></a><span id="l20.646" class="difflineplus">+    case &quot;prpl-icq&quot;:</span>
<a href="#l20.647"></a><span id="l20.647" class="difflineplus">+      return 2346;</span>
<a href="#l20.648"></a><span id="l20.648" class="difflineplus">+    case &quot;prpl-gg&quot;:</span>
<a href="#l20.649"></a><span id="l20.649" class="difflineplus">+      return 1999;</span>
<a href="#l20.650"></a><span id="l20.650" class="difflineplus">+    case &quot;prpl-aim&quot;:</span>
<a href="#l20.651"></a><span id="l20.651" class="difflineplus">+    case &quot;prpl-oscar&quot;:</span>
<a href="#l20.652"></a><span id="l20.652" class="difflineplus">+      return 2343;</span>
<a href="#l20.653"></a><span id="l20.653" class="difflineplus">+    case &quot;prpl-novell&quot;:</span>
<a href="#l20.654"></a><span id="l20.654" class="difflineplus">+      return 1792;</span>
<a href="#l20.655"></a><span id="l20.655" class="difflineplus">+    default:</span>
<a href="#l20.656"></a><span id="l20.656" class="difflineplus">+      return 0;</span>
<a href="#l20.657"></a><span id="l20.657" class="difflineplus">+    }</span>
<a href="#l20.658"></a><span id="l20.658" class="difflineplus">+  },</span>
<a href="#l20.659"></a><span id="l20.659" class="difflineplus">+</span>
<a href="#l20.660"></a><span id="l20.660" class="difflineplus">+  // We received a request from the buddy to use the current &quot;extra&quot; symmetric</span>
<a href="#l20.661"></a><span id="l20.661" class="difflineplus">+  // key.</span>
<a href="#l20.662"></a><span id="l20.662" class="difflineplus">+  received_symkey_cb(opdata, context, use, usedata, usedatalen, symkey) {</span>
<a href="#l20.663"></a><span id="l20.663" class="difflineplus">+    // Ignore until we have a use.</span>
<a href="#l20.664"></a><span id="l20.664" class="difflineplus">+  },</span>
<a href="#l20.665"></a><span id="l20.665" class="difflineplus">+</span>
<a href="#l20.666"></a><span id="l20.666" class="difflineplus">+  // Return a string according to the error event.</span>
<a href="#l20.667"></a><span id="l20.667" class="difflineplus">+  otr_error_message_cb(opdata, context, err_code) {</span>
<a href="#l20.668"></a><span id="l20.668" class="difflineplus">+    context = new Context(context);</span>
<a href="#l20.669"></a><span id="l20.669" class="difflineplus">+    let msg;</span>
<a href="#l20.670"></a><span id="l20.670" class="difflineplus">+    switch (err_code) {</span>
<a href="#l20.671"></a><span id="l20.671" class="difflineplus">+    case OTRLib.errorCode.OTRL_ERRCODE_ENCRYPTION_ERROR:</span>
<a href="#l20.672"></a><span id="l20.672" class="difflineplus">+      msg = _(&quot;error.enc&quot;);</span>
<a href="#l20.673"></a><span id="l20.673" class="difflineplus">+      break;</span>
<a href="#l20.674"></a><span id="l20.674" class="difflineplus">+    case OTRLib.errorCode.OTRL_ERRCODE_MSG_NOT_IN_PRIVATE:</span>
<a href="#l20.675"></a><span id="l20.675" class="difflineplus">+      msg = _(&quot;error.not_priv&quot;, context.username);</span>
<a href="#l20.676"></a><span id="l20.676" class="difflineplus">+      break;</span>
<a href="#l20.677"></a><span id="l20.677" class="difflineplus">+    case OTRLib.errorCode.OTRL_ERRCODE_MSG_UNREADABLE:</span>
<a href="#l20.678"></a><span id="l20.678" class="difflineplus">+      msg = _(&quot;error.unreadable&quot;);</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineplus">+      break;</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineplus">+    case OTRLib.errorCode.OTRL_ERRCODE_MSG_MALFORMED:</span>
<a href="#l20.681"></a><span id="l20.681" class="difflineplus">+      msg = _(&quot;error.malformed&quot;);</span>
<a href="#l20.682"></a><span id="l20.682" class="difflineplus">+      break;</span>
<a href="#l20.683"></a><span id="l20.683" class="difflineplus">+    default:</span>
<a href="#l20.684"></a><span id="l20.684" class="difflineplus">+      return null;</span>
<a href="#l20.685"></a><span id="l20.685" class="difflineplus">+    }</span>
<a href="#l20.686"></a><span id="l20.686" class="difflineplus">+    return CLib.strdup(msg);</span>
<a href="#l20.687"></a><span id="l20.687" class="difflineplus">+  },</span>
<a href="#l20.688"></a><span id="l20.688" class="difflineplus">+</span>
<a href="#l20.689"></a><span id="l20.689" class="difflineplus">+  // Deallocate a string returned by otr_error_message_cb.</span>
<a href="#l20.690"></a><span id="l20.690" class="difflineplus">+  otr_error_message_free_cb(opdata, err_msg) {</span>
<a href="#l20.691"></a><span id="l20.691" class="difflineplus">+    if (!err_msg.isNull())</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineplus">+      CLib.free(err_msg);</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineplus">+  },</span>
<a href="#l20.694"></a><span id="l20.694" class="difflineplus">+</span>
<a href="#l20.695"></a><span id="l20.695" class="difflineplus">+  // Return a string that will be prefixed to any resent message.</span>
<a href="#l20.696"></a><span id="l20.696" class="difflineplus">+  resent_msg_prefix_cb(opdata, context) {</span>
<a href="#l20.697"></a><span id="l20.697" class="difflineplus">+    return CLib.strdup(_(&quot;resent&quot;));</span>
<a href="#l20.698"></a><span id="l20.698" class="difflineplus">+  },</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineplus">+</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineplus">+  // Deallocate a string returned by resent_msg_prefix.</span>
<a href="#l20.701"></a><span id="l20.701" class="difflineplus">+  resent_msg_prefix_free_cb(opdata, prefix) {</span>
<a href="#l20.702"></a><span id="l20.702" class="difflineplus">+    if (!prefix.isNull())</span>
<a href="#l20.703"></a><span id="l20.703" class="difflineplus">+      CLib.free(prefix);</span>
<a href="#l20.704"></a><span id="l20.704" class="difflineplus">+  },</span>
<a href="#l20.705"></a><span id="l20.705" class="difflineplus">+</span>
<a href="#l20.706"></a><span id="l20.706" class="difflineplus">+  // Update the authentication UI with respect to SMP events.</span>
<a href="#l20.707"></a><span id="l20.707" class="difflineplus">+  handle_smp_event_cb(opdata, smp_event, context, progress_percent, question) {</span>
<a href="#l20.708"></a><span id="l20.708" class="difflineplus">+    context = new Context(context);</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineplus">+    switch (smp_event) {</span>
<a href="#l20.710"></a><span id="l20.710" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_NONE:</span>
<a href="#l20.711"></a><span id="l20.711" class="difflineplus">+      break;</span>
<a href="#l20.712"></a><span id="l20.712" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_ANSWER:</span>
<a href="#l20.713"></a><span id="l20.713" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_SECRET:</span>
<a href="#l20.714"></a><span id="l20.714" class="difflineplus">+      this.notifyObservers({</span>
<a href="#l20.715"></a><span id="l20.715" class="difflineplus">+        context,</span>
<a href="#l20.716"></a><span id="l20.716" class="difflineplus">+        progress: progress_percent,</span>
<a href="#l20.717"></a><span id="l20.717" class="difflineplus">+        question: question.isNull() ? null : question.readString(),</span>
<a href="#l20.718"></a><span id="l20.718" class="difflineplus">+      }, &quot;otr:auth-ask&quot;);</span>
<a href="#l20.719"></a><span id="l20.719" class="difflineplus">+      break;</span>
<a href="#l20.720"></a><span id="l20.720" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_CHEATED:</span>
<a href="#l20.721"></a><span id="l20.721" class="difflineplus">+      OTR.abortSMP(context);</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineplus">+      /* falls through */</span>
<a href="#l20.723"></a><span id="l20.723" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_IN_PROGRESS:</span>
<a href="#l20.724"></a><span id="l20.724" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_SUCCESS:</span>
<a href="#l20.725"></a><span id="l20.725" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_FAILURE:</span>
<a href="#l20.726"></a><span id="l20.726" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_ABORT:</span>
<a href="#l20.727"></a><span id="l20.727" class="difflineplus">+      this.authUpdate(context, progress_percent,</span>
<a href="#l20.728"></a><span id="l20.728" class="difflineplus">+        (smp_event === OTRLib.smpEvent.OTRL_SMPEVENT_SUCCESS));</span>
<a href="#l20.729"></a><span id="l20.729" class="difflineplus">+      break;</span>
<a href="#l20.730"></a><span id="l20.730" class="difflineplus">+    case OTRLib.smpEvent.OTRL_SMPEVENT_ERROR:</span>
<a href="#l20.731"></a><span id="l20.731" class="difflineplus">+      OTR.abortSMP(context);</span>
<a href="#l20.732"></a><span id="l20.732" class="difflineplus">+      break;</span>
<a href="#l20.733"></a><span id="l20.733" class="difflineplus">+    default:</span>
<a href="#l20.734"></a><span id="l20.734" class="difflineplus">+      this.log(&quot;smp event: &quot; + smp_event);</span>
<a href="#l20.735"></a><span id="l20.735" class="difflineplus">+    }</span>
<a href="#l20.736"></a><span id="l20.736" class="difflineplus">+  },</span>
<a href="#l20.737"></a><span id="l20.737" class="difflineplus">+</span>
<a href="#l20.738"></a><span id="l20.738" class="difflineplus">+  // Handle and send the appropriate message(s) to the sender/recipient</span>
<a href="#l20.739"></a><span id="l20.739" class="difflineplus">+  // depending on the message events.</span>
<a href="#l20.740"></a><span id="l20.740" class="difflineplus">+  handle_msg_event_cb(opdata, msg_event, context, message, err) {</span>
<a href="#l20.741"></a><span id="l20.741" class="difflineplus">+    context = new Context(context);</span>
<a href="#l20.742"></a><span id="l20.742" class="difflineplus">+    switch (msg_event) {</span>
<a href="#l20.743"></a><span id="l20.743" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_NONE:</span>
<a href="#l20.744"></a><span id="l20.744" class="difflineplus">+      break;</span>
<a href="#l20.745"></a><span id="l20.745" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_ENCRYPTION_REQUIRED:</span>
<a href="#l20.746"></a><span id="l20.746" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.encryption_required_part1&quot;, context.username));</span>
<a href="#l20.747"></a><span id="l20.747" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.encryption_required_part2&quot;));</span>
<a href="#l20.748"></a><span id="l20.748" class="difflineplus">+      break;</span>
<a href="#l20.749"></a><span id="l20.749" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_ENCRYPTION_ERROR:</span>
<a href="#l20.750"></a><span id="l20.750" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.encryption_error&quot;));</span>
<a href="#l20.751"></a><span id="l20.751" class="difflineplus">+      break;</span>
<a href="#l20.752"></a><span id="l20.752" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_CONNECTION_ENDED:</span>
<a href="#l20.753"></a><span id="l20.753" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.connection_ended&quot;, context.username));</span>
<a href="#l20.754"></a><span id="l20.754" class="difflineplus">+      break;</span>
<a href="#l20.755"></a><span id="l20.755" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_SETUP_ERROR:</span>
<a href="#l20.756"></a><span id="l20.756" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.setup_error&quot;, context.username));</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineplus">+      break;</span>
<a href="#l20.758"></a><span id="l20.758" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_MSG_REFLECTED:</span>
<a href="#l20.759"></a><span id="l20.759" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.msg_reflected&quot;));</span>
<a href="#l20.760"></a><span id="l20.760" class="difflineplus">+      break;</span>
<a href="#l20.761"></a><span id="l20.761" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_MSG_RESENT:</span>
<a href="#l20.762"></a><span id="l20.762" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.msg_resent&quot;, context.username));</span>
<a href="#l20.763"></a><span id="l20.763" class="difflineplus">+      break;</span>
<a href="#l20.764"></a><span id="l20.764" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_NOT_IN_PRIVATE:</span>
<a href="#l20.765"></a><span id="l20.765" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.rcvdmsg_not_private&quot;, context.username));</span>
<a href="#l20.766"></a><span id="l20.766" class="difflineplus">+      break;</span>
<a href="#l20.767"></a><span id="l20.767" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNREADABLE:</span>
<a href="#l20.768"></a><span id="l20.768" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.rcvdmsg_unreadable&quot;, context.username));</span>
<a href="#l20.769"></a><span id="l20.769" class="difflineplus">+      break;</span>
<a href="#l20.770"></a><span id="l20.770" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_MALFORMED:</span>
<a href="#l20.771"></a><span id="l20.771" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.rcvdmsg_malformed&quot;, context.username));</span>
<a href="#l20.772"></a><span id="l20.772" class="difflineplus">+      break;</span>
<a href="#l20.773"></a><span id="l20.773" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_LOG_HEARTBEAT_RCVD:</span>
<a href="#l20.774"></a><span id="l20.774" class="difflineplus">+      this.log(_(&quot;msgevent.log_heartbeat_rcvd&quot;, context.username));</span>
<a href="#l20.775"></a><span id="l20.775" class="difflineplus">+      break;</span>
<a href="#l20.776"></a><span id="l20.776" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_LOG_HEARTBEAT_SENT:</span>
<a href="#l20.777"></a><span id="l20.777" class="difflineplus">+      this.log(_(&quot;msgevent.log_heartbeat_sent&quot;, context.username));</span>
<a href="#l20.778"></a><span id="l20.778" class="difflineplus">+      break;</span>
<a href="#l20.779"></a><span id="l20.779" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_GENERAL_ERR:</span>
<a href="#l20.780"></a><span id="l20.780" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.rcvdmsg_general_err&quot;));</span>
<a href="#l20.781"></a><span id="l20.781" class="difflineplus">+      break;</span>
<a href="#l20.782"></a><span id="l20.782" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNENCRYPTED:</span>
<a href="#l20.783"></a><span id="l20.783" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.rcvdmsg_unencrypted&quot;, context.username, message.isNull() ? &quot;&quot; : message.readString()));</span>
<a href="#l20.784"></a><span id="l20.784" class="difflineplus">+      break;</span>
<a href="#l20.785"></a><span id="l20.785" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_UNRECOGNIZED:</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineplus">+      this.sendAlert(context, _(&quot;msgevent.rcvdmsg_unrecognized&quot;, context.username));</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineplus">+      break;</span>
<a href="#l20.788"></a><span id="l20.788" class="difflineplus">+    case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_FOR_OTHER_INSTANCE:</span>
<a href="#l20.789"></a><span id="l20.789" class="difflineplus">+      this.log(_(&quot;msgevent.rcvdmsg_for_other_instance&quot;, context.username));</span>
<a href="#l20.790"></a><span id="l20.790" class="difflineplus">+      break;</span>
<a href="#l20.791"></a><span id="l20.791" class="difflineplus">+    default:</span>
<a href="#l20.792"></a><span id="l20.792" class="difflineplus">+      this.log(&quot;msg event: &quot; + msg_event);</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineplus">+    }</span>
<a href="#l20.794"></a><span id="l20.794" class="difflineplus">+  },</span>
<a href="#l20.795"></a><span id="l20.795" class="difflineplus">+</span>
<a href="#l20.796"></a><span id="l20.796" class="difflineplus">+  // Create an instance tag for the given accountname/protocol if desired.</span>
<a href="#l20.797"></a><span id="l20.797" class="difflineplus">+  create_instag_cb(opdata, accountname, protocol) {</span>
<a href="#l20.798"></a><span id="l20.798" class="difflineplus">+    this.generateInstanceTag(accountname.readString(), protocol.readString());</span>
<a href="#l20.799"></a><span id="l20.799" class="difflineplus">+  },</span>
<a href="#l20.800"></a><span id="l20.800" class="difflineplus">+</span>
<a href="#l20.801"></a><span id="l20.801" class="difflineplus">+  // When timer_control is called, turn off any existing periodic timer.</span>
<a href="#l20.802"></a><span id="l20.802" class="difflineplus">+  // Additionally, if interval &gt; 0, set a new periodic timer to go off every</span>
<a href="#l20.803"></a><span id="l20.803" class="difflineplus">+  // interval seconds.</span>
<a href="#l20.804"></a><span id="l20.804" class="difflineplus">+  timer_control_cb(opdata, interval) {</span>
<a href="#l20.805"></a><span id="l20.805" class="difflineplus">+    if (this._poll_timer) {</span>
<a href="#l20.806"></a><span id="l20.806" class="difflineplus">+      clearInterval(this._poll_timer);</span>
<a href="#l20.807"></a><span id="l20.807" class="difflineplus">+      this._poll_timer = null;</span>
<a href="#l20.808"></a><span id="l20.808" class="difflineplus">+    }</span>
<a href="#l20.809"></a><span id="l20.809" class="difflineplus">+    if (interval &gt; 0) {</span>
<a href="#l20.810"></a><span id="l20.810" class="difflineplus">+      this._poll_timer = setInterval(() =&gt; {</span>
<a href="#l20.811"></a><span id="l20.811" class="difflineplus">+        OTRLib.otrl_message_poll(this.userstate, this.uiOps.address(), null);</span>
<a href="#l20.812"></a><span id="l20.812" class="difflineplus">+      }, interval * 1000);</span>
<a href="#l20.813"></a><span id="l20.813" class="difflineplus">+    }</span>
<a href="#l20.814"></a><span id="l20.814" class="difflineplus">+  },</span>
<a href="#l20.815"></a><span id="l20.815" class="difflineplus">+</span>
<a href="#l20.816"></a><span id="l20.816" class="difflineplus">+  // uiOps</span>
<a href="#l20.817"></a><span id="l20.817" class="difflineplus">+</span>
<a href="#l20.818"></a><span id="l20.818" class="difflineplus">+  initUiOps() {</span>
<a href="#l20.819"></a><span id="l20.819" class="difflineplus">+    this.uiOps = new OTRLib.OtrlMessageAppOps();</span>
<a href="#l20.820"></a><span id="l20.820" class="difflineplus">+</span>
<a href="#l20.821"></a><span id="l20.821" class="difflineplus">+    let methods = [</span>
<a href="#l20.822"></a><span id="l20.822" class="difflineplus">+      &quot;policy&quot;,</span>
<a href="#l20.823"></a><span id="l20.823" class="difflineplus">+      &quot;create_privkey&quot;,</span>
<a href="#l20.824"></a><span id="l20.824" class="difflineplus">+      &quot;is_logged_in&quot;,</span>
<a href="#l20.825"></a><span id="l20.825" class="difflineplus">+      &quot;inject_message&quot;,</span>
<a href="#l20.826"></a><span id="l20.826" class="difflineplus">+      &quot;update_context_list&quot;,  // not implemented</span>
<a href="#l20.827"></a><span id="l20.827" class="difflineplus">+      &quot;new_fingerprint&quot;,</span>
<a href="#l20.828"></a><span id="l20.828" class="difflineplus">+      &quot;write_fingerprint&quot;,</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineplus">+      &quot;gone_secure&quot;,</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineplus">+      &quot;gone_insecure&quot;,</span>
<a href="#l20.831"></a><span id="l20.831" class="difflineplus">+      &quot;still_secure&quot;,</span>
<a href="#l20.832"></a><span id="l20.832" class="difflineplus">+      &quot;max_message_size&quot;,</span>
<a href="#l20.833"></a><span id="l20.833" class="difflineplus">+      &quot;account_name&quot;,  // not implemented</span>
<a href="#l20.834"></a><span id="l20.834" class="difflineplus">+      &quot;account_name_free&quot;,  // not implemented</span>
<a href="#l20.835"></a><span id="l20.835" class="difflineplus">+      &quot;received_symkey&quot;,</span>
<a href="#l20.836"></a><span id="l20.836" class="difflineplus">+      &quot;otr_error_message&quot;,</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineplus">+      &quot;otr_error_message_free&quot;,</span>
<a href="#l20.838"></a><span id="l20.838" class="difflineplus">+      &quot;resent_msg_prefix&quot;,</span>
<a href="#l20.839"></a><span id="l20.839" class="difflineplus">+      &quot;resent_msg_prefix_free&quot;,</span>
<a href="#l20.840"></a><span id="l20.840" class="difflineplus">+      &quot;handle_smp_event&quot;,</span>
<a href="#l20.841"></a><span id="l20.841" class="difflineplus">+      &quot;handle_msg_event&quot;,</span>
<a href="#l20.842"></a><span id="l20.842" class="difflineplus">+      &quot;create_instag&quot;,</span>
<a href="#l20.843"></a><span id="l20.843" class="difflineplus">+      &quot;convert_msg&quot;,  // not implemented</span>
<a href="#l20.844"></a><span id="l20.844" class="difflineplus">+      &quot;convert_free&quot;,  // not implemented</span>
<a href="#l20.845"></a><span id="l20.845" class="difflineplus">+      &quot;timer_control&quot;,</span>
<a href="#l20.846"></a><span id="l20.846" class="difflineplus">+    ];</span>
<a href="#l20.847"></a><span id="l20.847" class="difflineplus">+</span>
<a href="#l20.848"></a><span id="l20.848" class="difflineplus">+    for (let i = 0; i &lt; methods.length; i++) {</span>
<a href="#l20.849"></a><span id="l20.849" class="difflineplus">+      let m = methods[i];</span>
<a href="#l20.850"></a><span id="l20.850" class="difflineplus">+      if (!this[m + &quot;_cb&quot;]) {</span>
<a href="#l20.851"></a><span id="l20.851" class="difflineplus">+        this.uiOps[m] = null;</span>
<a href="#l20.852"></a><span id="l20.852" class="difflineplus">+        continue;</span>
<a href="#l20.853"></a><span id="l20.853" class="difflineplus">+      }</span>
<a href="#l20.854"></a><span id="l20.854" class="difflineplus">+      // keep a pointer to this in memory to avoid crashing</span>
<a href="#l20.855"></a><span id="l20.855" class="difflineplus">+      this[m + &quot;_cb&quot;] = OTRLib[m + &quot;_cb_t&quot;](this[m + &quot;_cb&quot;].bind(this));</span>
<a href="#l20.856"></a><span id="l20.856" class="difflineplus">+      this.uiOps[m] = this[m + &quot;_cb&quot;];</span>
<a href="#l20.857"></a><span id="l20.857" class="difflineplus">+    }</span>
<a href="#l20.858"></a><span id="l20.858" class="difflineplus">+  },</span>
<a href="#l20.859"></a><span id="l20.859" class="difflineplus">+</span>
<a href="#l20.860"></a><span id="l20.860" class="difflineplus">+  sendAlert(context, msg) {</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineplus">+    this.getUIConvFromContext(context).systemMessage(msg);</span>
<a href="#l20.862"></a><span id="l20.862" class="difflineplus">+  },</span>
<a href="#l20.863"></a><span id="l20.863" class="difflineplus">+</span>
<a href="#l20.864"></a><span id="l20.864" class="difflineplus">+  observe(aObject, aTopic, aMsg) {</span>
<a href="#l20.865"></a><span id="l20.865" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l20.866"></a><span id="l20.866" class="difflineplus">+    case &quot;sending-message&quot;:</span>
<a href="#l20.867"></a><span id="l20.867" class="difflineplus">+      this.onSend(aObject);</span>
<a href="#l20.868"></a><span id="l20.868" class="difflineplus">+      break;</span>
<a href="#l20.869"></a><span id="l20.869" class="difflineplus">+    case &quot;received-message&quot;:</span>
<a href="#l20.870"></a><span id="l20.870" class="difflineplus">+      this.onReceive(aObject);</span>
<a href="#l20.871"></a><span id="l20.871" class="difflineplus">+      break;</span>
<a href="#l20.872"></a><span id="l20.872" class="difflineplus">+    case &quot;new-ui-conversation&quot;:</span>
<a href="#l20.873"></a><span id="l20.873" class="difflineplus">+      this.addConversation(aObject);</span>
<a href="#l20.874"></a><span id="l20.874" class="difflineplus">+      break;</span>
<a href="#l20.875"></a><span id="l20.875" class="difflineplus">+    }</span>
<a href="#l20.876"></a><span id="l20.876" class="difflineplus">+  },</span>
<a href="#l20.877"></a><span id="l20.877" class="difflineplus">+</span>
<a href="#l20.878"></a><span id="l20.878" class="difflineplus">+  addConversation(uiConv) {</span>
<a href="#l20.879"></a><span id="l20.879" class="difflineplus">+    let conv = uiConv.target;</span>
<a href="#l20.880"></a><span id="l20.880" class="difflineplus">+    if (conv.isChat)</span>
<a href="#l20.881"></a><span id="l20.881" class="difflineplus">+      return;</span>
<a href="#l20.882"></a><span id="l20.882" class="difflineplus">+    this._convos.set(conv.id, uiConv);</span>
<a href="#l20.883"></a><span id="l20.883" class="difflineplus">+    uiConv.addObserver(this);</span>
<a href="#l20.884"></a><span id="l20.884" class="difflineplus">+  },</span>
<a href="#l20.885"></a><span id="l20.885" class="difflineplus">+</span>
<a href="#l20.886"></a><span id="l20.886" class="difflineplus">+  removeConversation(uiConv) {</span>
<a href="#l20.887"></a><span id="l20.887" class="difflineplus">+    uiConv.removeObserver(this);</span>
<a href="#l20.888"></a><span id="l20.888" class="difflineplus">+    this._convos.delete(uiConv.target.id);</span>
<a href="#l20.889"></a><span id="l20.889" class="difflineplus">+    this.clearMsgs(uiConv.target.id);</span>
<a href="#l20.890"></a><span id="l20.890" class="difflineplus">+  },</span>
<a href="#l20.891"></a><span id="l20.891" class="difflineplus">+</span>
<a href="#l20.892"></a><span id="l20.892" class="difflineplus">+  sendSecret(context, secret, question) {</span>
<a href="#l20.893"></a><span id="l20.893" class="difflineplus">+    let str = ctypes.char.array()(secret);</span>
<a href="#l20.894"></a><span id="l20.894" class="difflineplus">+    let strlen = new ctypes.size_t(str.length - 1);</span>
<a href="#l20.895"></a><span id="l20.895" class="difflineplus">+    OTRLib.otrl_message_initiate_smp_q(</span>
<a href="#l20.896"></a><span id="l20.896" class="difflineplus">+      this.userstate,</span>
<a href="#l20.897"></a><span id="l20.897" class="difflineplus">+      this.uiOps.address(),</span>
<a href="#l20.898"></a><span id="l20.898" class="difflineplus">+      null,</span>
<a href="#l20.899"></a><span id="l20.899" class="difflineplus">+      context._context,</span>
<a href="#l20.900"></a><span id="l20.900" class="difflineplus">+      question ? question : null,</span>
<a href="#l20.901"></a><span id="l20.901" class="difflineplus">+      str,</span>
<a href="#l20.902"></a><span id="l20.902" class="difflineplus">+      strlen</span>
<a href="#l20.903"></a><span id="l20.903" class="difflineplus">+    );</span>
<a href="#l20.904"></a><span id="l20.904" class="difflineplus">+  },</span>
<a href="#l20.905"></a><span id="l20.905" class="difflineplus">+</span>
<a href="#l20.906"></a><span id="l20.906" class="difflineplus">+  sendResponse(context, response) {</span>
<a href="#l20.907"></a><span id="l20.907" class="difflineplus">+    let str = ctypes.char.array()(response);</span>
<a href="#l20.908"></a><span id="l20.908" class="difflineplus">+    let strlen = new ctypes.size_t(str.length - 1);</span>
<a href="#l20.909"></a><span id="l20.909" class="difflineplus">+    OTRLib.otrl_message_respond_smp(</span>
<a href="#l20.910"></a><span id="l20.910" class="difflineplus">+      this.userstate,</span>
<a href="#l20.911"></a><span id="l20.911" class="difflineplus">+      this.uiOps.address(),</span>
<a href="#l20.912"></a><span id="l20.912" class="difflineplus">+      null,</span>
<a href="#l20.913"></a><span id="l20.913" class="difflineplus">+      context._context,</span>
<a href="#l20.914"></a><span id="l20.914" class="difflineplus">+      str,</span>
<a href="#l20.915"></a><span id="l20.915" class="difflineplus">+      strlen</span>
<a href="#l20.916"></a><span id="l20.916" class="difflineplus">+    );</span>
<a href="#l20.917"></a><span id="l20.917" class="difflineplus">+  },</span>
<a href="#l20.918"></a><span id="l20.918" class="difflineplus">+</span>
<a href="#l20.919"></a><span id="l20.919" class="difflineplus">+  abortSMP(context) {</span>
<a href="#l20.920"></a><span id="l20.920" class="difflineplus">+    OTRLib.otrl_message_abort_smp(</span>
<a href="#l20.921"></a><span id="l20.921" class="difflineplus">+      this.userstate,</span>
<a href="#l20.922"></a><span id="l20.922" class="difflineplus">+      this.uiOps.address(),</span>
<a href="#l20.923"></a><span id="l20.923" class="difflineplus">+      null,</span>
<a href="#l20.924"></a><span id="l20.924" class="difflineplus">+      context._context</span>
<a href="#l20.925"></a><span id="l20.925" class="difflineplus">+    );</span>
<a href="#l20.926"></a><span id="l20.926" class="difflineplus">+  },</span>
<a href="#l20.927"></a><span id="l20.927" class="difflineplus">+</span>
<a href="#l20.928"></a><span id="l20.928" class="difflineplus">+  onSend(om) {</span>
<a href="#l20.929"></a><span id="l20.929" class="difflineplus">+    if (om.cancelled)</span>
<a href="#l20.930"></a><span id="l20.930" class="difflineplus">+      return;</span>
<a href="#l20.931"></a><span id="l20.931" class="difflineplus">+</span>
<a href="#l20.932"></a><span id="l20.932" class="difflineplus">+    let conv = om.conversation;</span>
<a href="#l20.933"></a><span id="l20.933" class="difflineplus">+    if (conv.isChat)</span>
<a href="#l20.934"></a><span id="l20.934" class="difflineplus">+      return;</span>
<a href="#l20.935"></a><span id="l20.935" class="difflineplus">+</span>
<a href="#l20.936"></a><span id="l20.936" class="difflineplus">+    // check for irc action messages</span>
<a href="#l20.937"></a><span id="l20.937" class="difflineplus">+    if (om.action) {</span>
<a href="#l20.938"></a><span id="l20.938" class="difflineplus">+      om.cancelled = true;</span>
<a href="#l20.939"></a><span id="l20.939" class="difflineplus">+      let uiConv = this.getUIConvFromConv(conv);</span>
<a href="#l20.940"></a><span id="l20.940" class="difflineplus">+      if (uiConv)</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineplus">+        uiConv.sendMsg(&quot;/me &quot; + om.message);</span>
<a href="#l20.942"></a><span id="l20.942" class="difflineplus">+      return;</span>
<a href="#l20.943"></a><span id="l20.943" class="difflineplus">+    }</span>
<a href="#l20.944"></a><span id="l20.944" class="difflineplus">+</span>
<a href="#l20.945"></a><span id="l20.945" class="difflineplus">+    let newMessage = new ctypes.char.ptr();</span>
<a href="#l20.946"></a><span id="l20.946" class="difflineplus">+</span>
<a href="#l20.947"></a><span id="l20.947" class="difflineplus">+    this.log(&quot;pre sending: &quot; + om.message);</span>
<a href="#l20.948"></a><span id="l20.948" class="difflineplus">+</span>
<a href="#l20.949"></a><span id="l20.949" class="difflineplus">+    let err = OTRLib.otrl_message_sending(</span>
<a href="#l20.950"></a><span id="l20.950" class="difflineplus">+      this.userstate,</span>
<a href="#l20.951"></a><span id="l20.951" class="difflineplus">+      this.uiOps.address(),</span>
<a href="#l20.952"></a><span id="l20.952" class="difflineplus">+      null,</span>
<a href="#l20.953"></a><span id="l20.953" class="difflineplus">+      conv.account.normalizedName,</span>
<a href="#l20.954"></a><span id="l20.954" class="difflineplus">+      conv.account.protocol.normalizedName,</span>
<a href="#l20.955"></a><span id="l20.955" class="difflineplus">+      conv.normalizedName,</span>
<a href="#l20.956"></a><span id="l20.956" class="difflineplus">+      OTRLib.instag.OTRL_INSTAG_BEST,</span>
<a href="#l20.957"></a><span id="l20.957" class="difflineplus">+      om.message,</span>
<a href="#l20.958"></a><span id="l20.958" class="difflineplus">+      null,</span>
<a href="#l20.959"></a><span id="l20.959" class="difflineplus">+      newMessage.address(),</span>
<a href="#l20.960"></a><span id="l20.960" class="difflineplus">+      OTRLib.fragPolicy.OTRL_FRAGMENT_SEND_ALL_BUT_LAST,</span>
<a href="#l20.961"></a><span id="l20.961" class="difflineplus">+      null,</span>
<a href="#l20.962"></a><span id="l20.962" class="difflineplus">+      null,</span>
<a href="#l20.963"></a><span id="l20.963" class="difflineplus">+      null</span>
<a href="#l20.964"></a><span id="l20.964" class="difflineplus">+    );</span>
<a href="#l20.965"></a><span id="l20.965" class="difflineplus">+</span>
<a href="#l20.966"></a><span id="l20.966" class="difflineplus">+    let msg = om.message;</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineplus">+</span>
<a href="#l20.968"></a><span id="l20.968" class="difflineplus">+    if (err) {</span>
<a href="#l20.969"></a><span id="l20.969" class="difflineplus">+      om.cancelled = true;</span>
<a href="#l20.970"></a><span id="l20.970" class="difflineplus">+      Cu.reportError(new Error(&quot;Failed to send message. Returned code: &quot; + err));</span>
<a href="#l20.971"></a><span id="l20.971" class="difflineplus">+    } else if (!newMessage.isNull()) {</span>
<a href="#l20.972"></a><span id="l20.972" class="difflineplus">+      msg = newMessage.readString();</span>
<a href="#l20.973"></a><span id="l20.973" class="difflineplus">+      // https://bugs.otr.im/lib/libotr/issues/52</span>
<a href="#l20.974"></a><span id="l20.974" class="difflineplus">+      if (!msg) {</span>
<a href="#l20.975"></a><span id="l20.975" class="difflineplus">+        om.cancelled = true;</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineplus">+      }</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineplus">+    }</span>
<a href="#l20.978"></a><span id="l20.978" class="difflineplus">+</span>
<a href="#l20.979"></a><span id="l20.979" class="difflineplus">+    if (!om.cancelled) {</span>
<a href="#l20.980"></a><span id="l20.980" class="difflineplus">+      // OTR handshakes only work while both peers are online.</span>
<a href="#l20.981"></a><span id="l20.981" class="difflineplus">+      // Sometimes we want to include a special whitespace suffix,</span>
<a href="#l20.982"></a><span id="l20.982" class="difflineplus">+      // which the OTR protocol uses to signal that the sender is willing</span>
<a href="#l20.983"></a><span id="l20.983" class="difflineplus">+      // to start an OTR session. Don't do that for offline messages.</span>
<a href="#l20.984"></a><span id="l20.984" class="difflineplus">+      // See: https://bugs.otr.im/lib/libotr/issues/102</span>
<a href="#l20.985"></a><span id="l20.985" class="difflineplus">+      if (isOnline(conv) === 0 ||</span>
<a href="#l20.986"></a><span id="l20.986" class="difflineplus">+          // Twitter trims tweets.</span>
<a href="#l20.987"></a><span id="l20.987" class="difflineplus">+          conv.account.protocol.normalizedName === &quot;twitter&quot;) {</span>
<a href="#l20.988"></a><span id="l20.988" class="difflineplus">+        let ind = msg.indexOf(OTRLib.OTRL_MESSAGE_TAG_BASE);</span>
<a href="#l20.989"></a><span id="l20.989" class="difflineplus">+        if (ind &gt; -1) {</span>
<a href="#l20.990"></a><span id="l20.990" class="difflineplus">+          msg = msg.substring(0, ind);</span>
<a href="#l20.991"></a><span id="l20.991" class="difflineplus">+          let context = this.getContext(conv);</span>
<a href="#l20.992"></a><span id="l20.992" class="difflineplus">+          context._context.contents.otr_offer = OTRLib.otr_offer.OFFER_NOT;</span>
<a href="#l20.993"></a><span id="l20.993" class="difflineplus">+        }</span>
<a href="#l20.994"></a><span id="l20.994" class="difflineplus">+      }</span>
<a href="#l20.995"></a><span id="l20.995" class="difflineplus">+</span>
<a href="#l20.996"></a><span id="l20.996" class="difflineplus">+      this.bufferMsg(conv.id, om.message, msg);</span>
<a href="#l20.997"></a><span id="l20.997" class="difflineplus">+      om.message = msg;</span>
<a href="#l20.998"></a><span id="l20.998" class="difflineplus">+    }</span>
<a href="#l20.999"></a><span id="l20.999" class="difflineplus">+</span>
<a href="#l20.1000"></a><span id="l20.1000" class="difflineplus">+    this.log(&quot;post sending (&quot; + !om.cancelled + &quot;): &quot; + om.message);</span>
<a href="#l20.1001"></a><span id="l20.1001" class="difflineplus">+    OTRLib.otrl_message_free(newMessage);</span>
<a href="#l20.1002"></a><span id="l20.1002" class="difflineplus">+  },</span>
<a href="#l20.1003"></a><span id="l20.1003" class="difflineplus">+</span>
<a href="#l20.1004"></a><span id="l20.1004" class="difflineplus">+  onReceive(im) {</span>
<a href="#l20.1005"></a><span id="l20.1005" class="difflineplus">+    if (im.cancelled || im.system)</span>
<a href="#l20.1006"></a><span id="l20.1006" class="difflineplus">+      return;</span>
<a href="#l20.1007"></a><span id="l20.1007" class="difflineplus">+</span>
<a href="#l20.1008"></a><span id="l20.1008" class="difflineplus">+    let conv = im.conversation;</span>
<a href="#l20.1009"></a><span id="l20.1009" class="difflineplus">+    if (conv.isChat)</span>
<a href="#l20.1010"></a><span id="l20.1010" class="difflineplus">+      return;</span>
<a href="#l20.1011"></a><span id="l20.1011" class="difflineplus">+</span>
<a href="#l20.1012"></a><span id="l20.1012" class="difflineplus">+    if (im.outgoing) {</span>
<a href="#l20.1013"></a><span id="l20.1013" class="difflineplus">+      this.log(&quot;outgoing message to display: &quot; + im.displayMessage);</span>
<a href="#l20.1014"></a><span id="l20.1014" class="difflineplus">+      this.pluckMsg(im);</span>
<a href="#l20.1015"></a><span id="l20.1015" class="difflineplus">+      return;</span>
<a href="#l20.1016"></a><span id="l20.1016" class="difflineplus">+    }</span>
<a href="#l20.1017"></a><span id="l20.1017" class="difflineplus">+</span>
<a href="#l20.1018"></a><span id="l20.1018" class="difflineplus">+    let newMessage = new ctypes.char.ptr();</span>
<a href="#l20.1019"></a><span id="l20.1019" class="difflineplus">+    let tlvs = new OTRLib.OtrlTLV.ptr();</span>
<a href="#l20.1020"></a><span id="l20.1020" class="difflineplus">+</span>
<a href="#l20.1021"></a><span id="l20.1021" class="difflineplus">+    this.log(&quot;pre receiving: &quot; + im.displayMessage);</span>
<a href="#l20.1022"></a><span id="l20.1022" class="difflineplus">+</span>
<a href="#l20.1023"></a><span id="l20.1023" class="difflineplus">+    let err = OTRLib.otrl_message_receiving(</span>
<a href="#l20.1024"></a><span id="l20.1024" class="difflineplus">+      this.userstate,</span>
<a href="#l20.1025"></a><span id="l20.1025" class="difflineplus">+      this.uiOps.address(),</span>
<a href="#l20.1026"></a><span id="l20.1026" class="difflineplus">+      null,</span>
<a href="#l20.1027"></a><span id="l20.1027" class="difflineplus">+      conv.account.normalizedName,</span>
<a href="#l20.1028"></a><span id="l20.1028" class="difflineplus">+      conv.account.protocol.normalizedName,</span>
<a href="#l20.1029"></a><span id="l20.1029" class="difflineplus">+      conv.normalizedName,</span>
<a href="#l20.1030"></a><span id="l20.1030" class="difflineplus">+      im.displayMessage,</span>
<a href="#l20.1031"></a><span id="l20.1031" class="difflineplus">+      newMessage.address(),</span>
<a href="#l20.1032"></a><span id="l20.1032" class="difflineplus">+      tlvs.address(),</span>
<a href="#l20.1033"></a><span id="l20.1033" class="difflineplus">+      null,</span>
<a href="#l20.1034"></a><span id="l20.1034" class="difflineplus">+      null,</span>
<a href="#l20.1035"></a><span id="l20.1035" class="difflineplus">+      null</span>
<a href="#l20.1036"></a><span id="l20.1036" class="difflineplus">+    );</span>
<a href="#l20.1037"></a><span id="l20.1037" class="difflineplus">+</span>
<a href="#l20.1038"></a><span id="l20.1038" class="difflineplus">+    if (!newMessage.isNull()) {</span>
<a href="#l20.1039"></a><span id="l20.1039" class="difflineplus">+      im.displayMessage = newMessage.readString();</span>
<a href="#l20.1040"></a><span id="l20.1040" class="difflineplus">+    }</span>
<a href="#l20.1041"></a><span id="l20.1041" class="difflineplus">+</span>
<a href="#l20.1042"></a><span id="l20.1042" class="difflineplus">+    // search tlvs for a disconnect msg</span>
<a href="#l20.1043"></a><span id="l20.1043" class="difflineplus">+    // https://bugs.otr.im/lib/libotr/issues/54</span>
<a href="#l20.1044"></a><span id="l20.1044" class="difflineplus">+    let tlv = OTRLib.otrl_tlv_find(tlvs, OTRLib.tlvs.OTRL_TLV_DISCONNECTED);</span>
<a href="#l20.1045"></a><span id="l20.1045" class="difflineplus">+    if (!tlv.isNull()) {</span>
<a href="#l20.1046"></a><span id="l20.1046" class="difflineplus">+      let context = this.getContext(conv);</span>
<a href="#l20.1047"></a><span id="l20.1047" class="difflineplus">+      this.notifyObservers(context, &quot;otr:disconnected&quot;);</span>
<a href="#l20.1048"></a><span id="l20.1048" class="difflineplus">+      this.sendAlert(context, _(&quot;tlv.disconnected&quot;, conv.normalizedName));</span>
<a href="#l20.1049"></a><span id="l20.1049" class="difflineplus">+    }</span>
<a href="#l20.1050"></a><span id="l20.1050" class="difflineplus">+</span>
<a href="#l20.1051"></a><span id="l20.1051" class="difflineplus">+    if (err) {</span>
<a href="#l20.1052"></a><span id="l20.1052" class="difflineplus">+      this.log(&quot;error (&quot; + err + &quot;) ignoring: &quot; + im.displayMessage);</span>
<a href="#l20.1053"></a><span id="l20.1053" class="difflineplus">+      im.cancelled = true;  // ignore</span>
<a href="#l20.1054"></a><span id="l20.1054" class="difflineplus">+    } else {</span>
<a href="#l20.1055"></a><span id="l20.1055" class="difflineplus">+      this.log(&quot;post receiving: &quot; + im.displayMessage);</span>
<a href="#l20.1056"></a><span id="l20.1056" class="difflineplus">+    }</span>
<a href="#l20.1057"></a><span id="l20.1057" class="difflineplus">+</span>
<a href="#l20.1058"></a><span id="l20.1058" class="difflineplus">+    OTRLib.otrl_tlv_free(tlvs);</span>
<a href="#l20.1059"></a><span id="l20.1059" class="difflineplus">+    OTRLib.otrl_message_free(newMessage);</span>
<a href="#l20.1060"></a><span id="l20.1060" class="difflineplus">+  },</span>
<a href="#l20.1061"></a><span id="l20.1061" class="difflineplus">+</span>
<a href="#l20.1062"></a><span id="l20.1062" class="difflineplus">+  // observer interface</span>
<a href="#l20.1063"></a><span id="l20.1063" class="difflineplus">+</span>
<a href="#l20.1064"></a><span id="l20.1064" class="difflineplus">+  addObserver(observer) {</span>
<a href="#l20.1065"></a><span id="l20.1065" class="difflineplus">+    if (!this._observers.includes(observer))</span>
<a href="#l20.1066"></a><span id="l20.1066" class="difflineplus">+      this._observers.push(observer);</span>
<a href="#l20.1067"></a><span id="l20.1067" class="difflineplus">+  },</span>
<a href="#l20.1068"></a><span id="l20.1068" class="difflineplus">+</span>
<a href="#l20.1069"></a><span id="l20.1069" class="difflineplus">+  removeObserver(observer) {</span>
<a href="#l20.1070"></a><span id="l20.1070" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== observer);</span>
<a href="#l20.1071"></a><span id="l20.1071" class="difflineplus">+  },</span>
<a href="#l20.1072"></a><span id="l20.1072" class="difflineplus">+</span>
<a href="#l20.1073"></a><span id="l20.1073" class="difflineplus">+  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l20.1074"></a><span id="l20.1074" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l20.1075"></a><span id="l20.1075" class="difflineplus">+      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l20.1076"></a><span id="l20.1076" class="difflineplus">+    }</span>
<a href="#l20.1077"></a><span id="l20.1077" class="difflineplus">+  },</span>
<a href="#l20.1078"></a><span id="l20.1078" class="difflineplus">+</span>
<a href="#l20.1079"></a><span id="l20.1079" class="difflineplus">+  // buffer messages</span>
<a href="#l20.1080"></a><span id="l20.1080" class="difflineplus">+</span>
<a href="#l20.1081"></a><span id="l20.1081" class="difflineplus">+  clearMsgs(convId) {</span>
<a href="#l20.1082"></a><span id="l20.1082" class="difflineplus">+    this._buffer = this._buffer.filter((msg) =&gt; msg.convId !== convId);</span>
<a href="#l20.1083"></a><span id="l20.1083" class="difflineplus">+  },</span>
<a href="#l20.1084"></a><span id="l20.1084" class="difflineplus">+</span>
<a href="#l20.1085"></a><span id="l20.1085" class="difflineplus">+  bufferMsg(convId, display, sent) {</span>
<a href="#l20.1086"></a><span id="l20.1086" class="difflineplus">+    this._buffer.push({</span>
<a href="#l20.1087"></a><span id="l20.1087" class="difflineplus">+      convId,</span>
<a href="#l20.1088"></a><span id="l20.1088" class="difflineplus">+      display,</span>
<a href="#l20.1089"></a><span id="l20.1089" class="difflineplus">+      sent,</span>
<a href="#l20.1090"></a><span id="l20.1090" class="difflineplus">+      time: Date.now(),</span>
<a href="#l20.1091"></a><span id="l20.1091" class="difflineplus">+    });</span>
<a href="#l20.1092"></a><span id="l20.1092" class="difflineplus">+  },</span>
<a href="#l20.1093"></a><span id="l20.1093" class="difflineplus">+</span>
<a href="#l20.1094"></a><span id="l20.1094" class="difflineplus">+  pluckMsg(im) {</span>
<a href="#l20.1095"></a><span id="l20.1095" class="difflineplus">+    let buf = this._buffer;</span>
<a href="#l20.1096"></a><span id="l20.1096" class="difflineplus">+    for (let i = 0; i &lt; buf.length; i++) {</span>
<a href="#l20.1097"></a><span id="l20.1097" class="difflineplus">+      let b = buf[i];</span>
<a href="#l20.1098"></a><span id="l20.1098" class="difflineplus">+      if (b.convId === im.conversation.id &amp;&amp; b.sent === im.displayMessage) {</span>
<a href="#l20.1099"></a><span id="l20.1099" class="difflineplus">+        im.displayMessage = b.display;</span>
<a href="#l20.1100"></a><span id="l20.1100" class="difflineplus">+        buf.splice(i, 1);</span>
<a href="#l20.1101"></a><span id="l20.1101" class="difflineplus">+        this.log(&quot;displaying: &quot; + b.display);</span>
<a href="#l20.1102"></a><span id="l20.1102" class="difflineplus">+        return;</span>
<a href="#l20.1103"></a><span id="l20.1103" class="difflineplus">+      }</span>
<a href="#l20.1104"></a><span id="l20.1104" class="difflineplus">+    }</span>
<a href="#l20.1105"></a><span id="l20.1105" class="difflineplus">+    // don't display if it wasn't buffered</span>
<a href="#l20.1106"></a><span id="l20.1106" class="difflineplus">+    im.cancelled = true;</span>
<a href="#l20.1107"></a><span id="l20.1107" class="difflineplus">+    this.log(&quot;not displaying: &quot; + im.displayMessage);</span>
<a href="#l20.1108"></a><span id="l20.1108" class="difflineplus">+  },</span>
<a href="#l20.1109"></a><span id="l20.1109" class="difflineplus">+</span>
<a href="#l20.1110"></a><span id="l20.1110" class="difflineplus">+};</span>
<a href="#l20.1111"></a><span id="l20.1111" class="difflineplus">+</span>
<a href="#l20.1112"></a><span id="l20.1112" class="difflineplus">+// exports</span>
<a href="#l20.1113"></a><span id="l20.1113" class="difflineplus">+</span>
<a href="#l20.1114"></a><span id="l20.1114" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;OTR&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/chat/modules/OTRHelpers.jsm</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,38 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+var OTRHelpers = {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+  profilePath(filename) {</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+    return OS.Path.join(OS.Constants.Path.profileDir, filename);</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  },</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  * getAccounts() {</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+    let accounts = Services.accounts.getAccounts();</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+    while (accounts.hasMoreElements())</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+      yield accounts.getNext();</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+  },</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+  readTextFile(filename) {</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+    let decoder = new TextDecoder();</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+    return OS.File.read(filename).then(function(array) {</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+      return decoder.decode(array);</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+    });</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+  },</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+  writeTextFile(filename, data) {</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+    let encoder = new TextEncoder();</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+    let array = encoder.encode(data);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+    // https://dutherenverseauborddelatable.wordpress.com/2014/02/05/is-my-data-on-the-disk-safety-properties-of-os-file-writeatomic/</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+    return OS.File.writeAtomic(filename, array, { tmpPath: `${filename}.tmp` });</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+  },</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+};</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+// exports</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;OTRHelpers&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/chat/modules/OTRLib.jsm</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,918 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+const otrl_version = [4, 1, 1];</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+const {CLib} = ChromeUtils.import(&quot;resource:///modules/CLib.jsm&quot;);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+const {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+var systemOS = Services.appinfo.OS.toLowerCase();</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+var abi = ctypes.default_abi;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+// Open libotr. Determine the path to the chrome directory and look for it</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+// there first. If not, fallback to searching the standard locations.</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+var libotr, libotrPath;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+function tryLoadOTR(name, suffix) {</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+  let filename = ctypes.libraryName(name) + suffix;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+  let binPath = Services.dirsvc.get(&quot;XpcomLib&quot;, Ci.nsIFile).path;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+  let binDir = OS.Path.dirname(binPath);</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+  libotrPath = OS.Path.join(binDir, filename);</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+  try {</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+    console.log(&quot;===&gt; trying to load &quot; + libotrPath);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    libotr = ctypes.open(libotrPath);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  } catch (e) {}</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+  if (!libotr) {</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+    try {</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+      // look in standard locations</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+      libotrPath = filename;</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+      console.log(&quot;===&gt; trying to load &quot; +</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+        libotrPath + &quot; from system's standard locations&quot;);</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+      libotr = ctypes.open(libotrPath);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+    } catch (e) {}</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+  }</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+}</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+if (!libotr &amp;&amp; (systemOS === &quot;winnt&quot; || systemOS === &quot;darwin&quot;)) {</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+  // otr.5.dll or otr.5.dylib</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+  tryLoadOTR(&quot;otr.5&quot;, &quot;&quot;);</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+}</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+if (!libotr &amp;&amp; systemOS === &quot;winnt&quot;) {</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+  // otr-5.dll</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+  tryLoadOTR(&quot;otr-5&quot;, &quot;&quot;);</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+}</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+if (!libotr &amp;&amp; systemOS === &quot;winnt&quot;) {</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+  // libotr-5.dll</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+  tryLoadOTR(&quot;libotr-5&quot;, &quot;&quot;);</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+}</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+if (!libotr &amp;&amp; !(systemOS === &quot;winnt&quot;) &amp;&amp; !(systemOS === &quot;darwin&quot;)) {</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+  // libotr.so.5</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+  tryLoadOTR(&quot;otr&quot;, &quot;.5&quot;);</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+}</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+if (!libotr) {</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+  tryLoadOTR(&quot;otr&quot;, &quot;&quot;);</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+}</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+// Helper function to open files with the path properly encoded.</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+var callWithFILEp = function() {</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+  // Windows filenames are in UTF-16.</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+  let charType = (systemOS === &quot;winnt&quot;) ? &quot;jschar&quot; : &quot;char&quot;;</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+  let args = Array.from(arguments);</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+  let func = args.shift() + &quot;_FILEp&quot;;</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+  let mode = ctypes[charType].array()(args.shift());</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+  let ind = args.shift();</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+  let filename = ctypes[charType].array()(args[ind]);</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+  let file = CLib.fopen(filename, mode);</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+  if (file.isNull())</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+    return 1;</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+  // Swap filename with file.</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+  args[ind] = file;</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+  let ret = OTRLib[func].apply(OTRLib, args);</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+  CLib.fclose(file);</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+  return ret;</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+};</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+// type defs</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineplus">+const FILE = CLib.FILE;</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+const time_t = ctypes.long;</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+const gcry_error_t = ctypes.unsigned_int;</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+const gcry_cipher_hd_t = ctypes.StructType(&quot;gcry_cipher_handle&quot;).ptr;</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+const gcry_md_hd_t = ctypes.StructType(&quot;gcry_md_handle&quot;).ptr;</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+const gcry_mpi_t = ctypes.StructType(&quot;gcry_mpi&quot;).ptr;</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+const otrl_instag_t = ctypes.unsigned_int;</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+const OtrlPolicy = ctypes.unsigned_int;</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+const OtrlTLV = ctypes.StructType(&quot;s_OtrlTLV&quot;);</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+const ConnContext = ctypes.StructType(&quot;context&quot;);</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+const ConnContextPriv = ctypes.StructType(&quot;context_priv&quot;);</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+const OtrlMessageAppOps = ctypes.StructType(&quot;s_OtrlMessageAppOps&quot;);</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+const OtrlAuthInfo = ctypes.StructType(&quot;OtrlAuthInfo&quot;);</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+const Fingerprint = ctypes.StructType(&quot;s_fingerprint&quot;);</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+const s_OtrlUserState = ctypes.StructType(&quot;s_OtrlUserState&quot;);</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+const OtrlUserState = s_OtrlUserState.ptr;</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+const OtrlSMState = ctypes.StructType(&quot;OtrlSMState&quot;);</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+const DH_keypair = ctypes.StructType(&quot;DH_keypair&quot;);</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+const OtrlPrivKey = ctypes.StructType(&quot;s_OtrlPrivKey&quot;);</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+const OtrlInsTag = ctypes.StructType(&quot;s_OtrlInsTag&quot;);</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+const OtrlPendingPrivKey = ctypes.StructType(&quot;s_OtrlPendingPrivKey&quot;);</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+const OTRL_PRIVKEY_FPRINT_HUMAN_LEN = 45;</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineplus">+const fingerprint_t = ctypes.char.array(OTRL_PRIVKEY_FPRINT_HUMAN_LEN);</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+const hash_t = ctypes.unsigned_char.array(20);</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+const app_data_free_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+]).ptr;</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+// enums</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+const OtrlErrorCode = ctypes.int;</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+const OtrlSMPEvent = ctypes.int;</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+const OtrlMessageEvent = ctypes.int;</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+const OtrlFragmentPolicy = ctypes.int;</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+const OtrlConvertType = ctypes.int;</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+const OtrlMessageState = ctypes.int;</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+const OtrlAuthState = ctypes.int;</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+const OtrlSessionIdHalf = ctypes.int;</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineplus">+const OtrlSMProgState = ctypes.int;</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+const NextExpectedSMP = ctypes.int;</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineplus">+</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+// callback signatures</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+const policy_cb_t = ctypes.FunctionType(abi, OtrlPolicy, [</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+]).ptr;</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineplus">+</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+const create_privkey_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+]).ptr;</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+const is_logged_in_cb_t = ctypes.FunctionType(abi, ctypes.int, [</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+]).ptr;</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineplus">+</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineplus">+const inject_message_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineplus">+]).ptr;</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineplus">+</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineplus">+const update_context_list_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineplus">+]).ptr;</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineplus">+</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineplus">+const new_fingerprint_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineplus">+  ctypes.void_t.ptr, OtrlUserState, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+  ctypes.char.ptr, ctypes.unsigned_char.array(20),</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+]).ptr;</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineplus">+</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+const write_fingerprint_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+  ctypes.void_t.ptr,</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineplus">+]).ptr;</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+const gone_secure_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+]).ptr;</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+const gone_insecure_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+]).ptr;</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+const still_secure_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr, ctypes.int,</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+]).ptr;</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+const max_message_size_cb_t = ctypes.FunctionType(abi, ctypes.int, [</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+]).ptr;</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+const account_name_cb_t = ctypes.FunctionType(abi, ctypes.char.ptr, [</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+]).ptr;</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+const account_name_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr,</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+]).ptr;</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+const received_symkey_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr, ctypes.unsigned_int,</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+  ctypes.unsigned_char.ptr, ctypes.size_t, ctypes.unsigned_char.ptr,</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+]).ptr;</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+const otr_error_message_cb_t = ctypes.FunctionType(abi, ctypes.char.ptr, [</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr, OtrlErrorCode,</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+]).ptr;</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineplus">+</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineplus">+const otr_error_message_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr,</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineplus">+]).ptr;</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+const resent_msg_prefix_cb_t = ctypes.FunctionType(abi, ctypes.char.ptr, [</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr,</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+]).ptr;</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineplus">+</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineplus">+const resent_msg_prefix_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr,</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineplus">+]).ptr;</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineplus">+</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+const handle_smp_event_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineplus">+  ctypes.void_t.ptr, OtrlSMPEvent, ConnContext.ptr, ctypes.unsigned_short,</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+]).ptr;</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineplus">+</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineplus">+const handle_msg_event_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineplus">+  ctypes.void_t.ptr, OtrlMessageEvent, ConnContext.ptr, ctypes.char.ptr,</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineplus">+  gcry_error_t,</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineplus">+]).ptr;</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineplus">+</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineplus">+const create_instag_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineplus">+  ctypes.void_t.ptr, ctypes.char.ptr, ctypes.char.ptr,</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineplus">+]).ptr;</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineplus">+</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineplus">+const convert_msg_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr, OtrlConvertType, ctypes.char.ptr.ptr,</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineplus">+  ctypes.char.ptr,</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineplus">+]).ptr;</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineplus">+</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineplus">+const convert_free_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+  ctypes.void_t.ptr, ConnContext.ptr, ctypes.char.ptr,</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+]).ptr;</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+const timer_control_cb_t = ctypes.FunctionType(abi, ctypes.void_t, [</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineplus">+  ctypes.void_t.ptr, ctypes.unsigned_int,</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineplus">+]).ptr;</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineplus">+</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineplus">+// defines</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineplus">+</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineplus">+s_OtrlUserState.define([</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineplus">+  { context_root: ConnContext.ptr },</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineplus">+  { privkey_root: OtrlPrivKey.ptr },</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineplus">+  { instag_root: OtrlInsTag.ptr },</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineplus">+  { pending_root: OtrlPendingPrivKey.ptr },</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+  { timer_running: ctypes.int },</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+]);</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+</span>
<a href="#l22.254"></a><span id="l22.254" class="difflineplus">+Fingerprint.define([</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineplus">+  { next: Fingerprint.ptr },</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineplus">+  { tous: Fingerprint.ptr.ptr },</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineplus">+  { fingerprint: ctypes.unsigned_char.ptr },</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineplus">+  { context: ConnContext.ptr },</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+  { trust: ctypes.char.ptr },</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+]);</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineplus">+DH_keypair.define([</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+  { groupid: ctypes.unsigned_int },</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+  { priv: gcry_mpi_t },</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineplus">+  { pub: gcry_mpi_t },</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineplus">+]);</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineplus">+</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineplus">+OtrlSMState.define([</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineplus">+  { secret: gcry_mpi_t },</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineplus">+  { x2: gcry_mpi_t },</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineplus">+  { x3: gcry_mpi_t },</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineplus">+  { g1: gcry_mpi_t },</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineplus">+  { g2: gcry_mpi_t },</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineplus">+  { g3: gcry_mpi_t },</span>
<a href="#l22.275"></a><span id="l22.275" class="difflineplus">+  { g3o: gcry_mpi_t },</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineplus">+  { p: gcry_mpi_t },</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineplus">+  { q: gcry_mpi_t },</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineplus">+  { pab: gcry_mpi_t },</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineplus">+  { qab: gcry_mpi_t },</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineplus">+  { nextExpected: NextExpectedSMP },</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineplus">+  { received_question: ctypes.int },</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineplus">+  { sm_prog_state: OtrlSMProgState },</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+]);</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+</span>
<a href="#l22.285"></a><span id="l22.285" class="difflineplus">+OtrlAuthInfo.define([</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineplus">+  { authstate: OtrlAuthState },</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineplus">+  { context: ConnContext.ptr },</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineplus">+  { our_dh: DH_keypair },</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineplus">+  { our_keyid: ctypes.unsigned_int },</span>
<a href="#l22.290"></a><span id="l22.290" class="difflineplus">+  { encgx: ctypes.unsigned_char.ptr },</span>
<a href="#l22.291"></a><span id="l22.291" class="difflineplus">+  { encgx_len: ctypes.size_t },</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineplus">+  { r: ctypes.unsigned_char.array(16) },</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineplus">+  { hashgx: ctypes.unsigned_char.array(32) },</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineplus">+  { their_pub: gcry_mpi_t },</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineplus">+  { their_keyid: ctypes.unsigned_int },</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineplus">+  { enc_c: gcry_cipher_hd_t },</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+  { enc_cp: gcry_cipher_hd_t },</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineplus">+  { mac_m1: gcry_md_hd_t },</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineplus">+  { mac_m1p: gcry_md_hd_t },</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineplus">+  { mac_m2: gcry_md_hd_t },</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineplus">+  { mac_m2p: gcry_md_hd_t },</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+  { their_fingerprint: ctypes.unsigned_char.array(20) },</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+  { initiated: ctypes.int },</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineplus">+  { protocol_version: ctypes.unsigned_int },</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineplus">+  { secure_session_id: ctypes.unsigned_char.array(20) },</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineplus">+  { secure_session_id_len: ctypes.size_t },</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineplus">+  { session_id_half: OtrlSessionIdHalf },</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineplus">+  { lastauthmsg: ctypes.char.ptr },</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineplus">+  { commit_sent_time: time_t },</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineplus">+]);</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineplus">+</span>
<a href="#l22.312"></a><span id="l22.312" class="difflineplus">+ConnContext.define([</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineplus">+  { next: ConnContext.ptr },</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineplus">+  { tous: ConnContext.ptr.ptr },</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineplus">+  { context_priv: ConnContextPriv.ptr },</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineplus">+  { username: ctypes.char.ptr },</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineplus">+  { accountname: ctypes.char.ptr },</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineplus">+  { protocol: ctypes.char.ptr },</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineplus">+  { m_context: ConnContext.ptr },</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineplus">+  { recent_rcvd_child: ConnContext.ptr },</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineplus">+  { recent_sent_child: ConnContext.ptr },</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineplus">+  { recent_child: ConnContext.ptr },</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineplus">+  { our_instance: otrl_instag_t },</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineplus">+  { their_instance: otrl_instag_t },</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineplus">+  { msgstate: OtrlMessageState },</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineplus">+  { auth: OtrlAuthInfo },</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineplus">+  { fingerprint_root: Fingerprint },</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineplus">+  { active_fingerprint: Fingerprint.ptr },</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineplus">+  { sessionid: ctypes.unsigned_char.array(20) },</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineplus">+  { sessionid_len: ctypes.size_t },</span>
<a href="#l22.331"></a><span id="l22.331" class="difflineplus">+  { sessionid_half: OtrlSessionIdHalf },</span>
<a href="#l22.332"></a><span id="l22.332" class="difflineplus">+  { protocol_version: ctypes.unsigned_int },</span>
<a href="#l22.333"></a><span id="l22.333" class="difflineplus">+  { otr_offer: ctypes.int },</span>
<a href="#l22.334"></a><span id="l22.334" class="difflineplus">+  { app_data: ctypes.void_t.ptr },</span>
<a href="#l22.335"></a><span id="l22.335" class="difflineplus">+  { app_data_free: app_data_free_t },</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineplus">+  { smstate: OtrlSMState.ptr },</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineplus">+]);</span>
<a href="#l22.338"></a><span id="l22.338" class="difflineplus">+</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineplus">+OtrlMessageAppOps.define([</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineplus">+  { policy: policy_cb_t },</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineplus">+  { create_privkey: create_privkey_cb_t },</span>
<a href="#l22.342"></a><span id="l22.342" class="difflineplus">+  { is_logged_in: is_logged_in_cb_t },</span>
<a href="#l22.343"></a><span id="l22.343" class="difflineplus">+  { inject_message: inject_message_cb_t },</span>
<a href="#l22.344"></a><span id="l22.344" class="difflineplus">+  { update_context_list: update_context_list_cb_t },</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineplus">+  { new_fingerprint: new_fingerprint_cb_t },</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineplus">+  { write_fingerprint: write_fingerprint_cb_t },</span>
<a href="#l22.347"></a><span id="l22.347" class="difflineplus">+  { gone_secure: gone_secure_cb_t },</span>
<a href="#l22.348"></a><span id="l22.348" class="difflineplus">+  { gone_insecure: gone_insecure_cb_t },</span>
<a href="#l22.349"></a><span id="l22.349" class="difflineplus">+  { still_secure: still_secure_cb_t },</span>
<a href="#l22.350"></a><span id="l22.350" class="difflineplus">+  { max_message_size: max_message_size_cb_t },</span>
<a href="#l22.351"></a><span id="l22.351" class="difflineplus">+  { account_name: account_name_cb_t },</span>
<a href="#l22.352"></a><span id="l22.352" class="difflineplus">+  { account_name_free: account_name_free_cb_t },</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineplus">+  { received_symkey: received_symkey_cb_t },</span>
<a href="#l22.354"></a><span id="l22.354" class="difflineplus">+  { otr_error_message: otr_error_message_cb_t },</span>
<a href="#l22.355"></a><span id="l22.355" class="difflineplus">+  { otr_error_message_free: otr_error_message_free_cb_t },</span>
<a href="#l22.356"></a><span id="l22.356" class="difflineplus">+  { resent_msg_prefix: resent_msg_prefix_cb_t },</span>
<a href="#l22.357"></a><span id="l22.357" class="difflineplus">+  { resent_msg_prefix_free: resent_msg_prefix_free_cb_t },</span>
<a href="#l22.358"></a><span id="l22.358" class="difflineplus">+  { handle_smp_event: handle_smp_event_cb_t },</span>
<a href="#l22.359"></a><span id="l22.359" class="difflineplus">+  { handle_msg_event: handle_msg_event_cb_t },</span>
<a href="#l22.360"></a><span id="l22.360" class="difflineplus">+  { create_instag: create_instag_cb_t },</span>
<a href="#l22.361"></a><span id="l22.361" class="difflineplus">+  { convert_msg: convert_msg_cb_t },</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineplus">+  { convert_free: convert_free_cb_t },</span>
<a href="#l22.363"></a><span id="l22.363" class="difflineplus">+  { timer_control: timer_control_cb_t },</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineplus">+]);</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineplus">+</span>
<a href="#l22.366"></a><span id="l22.366" class="difflineplus">+OtrlTLV.define([</span>
<a href="#l22.367"></a><span id="l22.367" class="difflineplus">+  { type: ctypes.unsigned_short },</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineplus">+  { len: ctypes.unsigned_short },</span>
<a href="#l22.369"></a><span id="l22.369" class="difflineplus">+  { data: ctypes.unsigned_char.ptr },</span>
<a href="#l22.370"></a><span id="l22.370" class="difflineplus">+  { next: OtrlTLV.ptr },</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineplus">+]);</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineplus">+</span>
<a href="#l22.373"></a><span id="l22.373" class="difflineplus">+// policies</span>
<a href="#l22.374"></a><span id="l22.374" class="difflineplus">+</span>
<a href="#l22.375"></a><span id="l22.375" class="difflineplus">+// const OTRL_POLICY_ALLOW_V1 = 0x01;</span>
<a href="#l22.376"></a><span id="l22.376" class="difflineplus">+const OTRL_POLICY_ALLOW_V2 = 0x02;</span>
<a href="#l22.377"></a><span id="l22.377" class="difflineplus">+</span>
<a href="#l22.378"></a><span id="l22.378" class="difflineplus">+// const OTRL_POLICY_ALLOW_V3 = 0x04;</span>
<a href="#l22.379"></a><span id="l22.379" class="difflineplus">+// See https://bugzilla.mozilla.org/show_bug.cgi?id=1550474 re v3.</span>
<a href="#l22.380"></a><span id="l22.380" class="difflineplus">+</span>
<a href="#l22.381"></a><span id="l22.381" class="difflineplus">+const OTRL_POLICY_REQUIRE_ENCRYPTION = 0x08;</span>
<a href="#l22.382"></a><span id="l22.382" class="difflineplus">+const OTRL_POLICY_SEND_WHITESPACE_TAG = 0x10;</span>
<a href="#l22.383"></a><span id="l22.383" class="difflineplus">+const OTRL_POLICY_WHITESPACE_START_AKE = 0x20;</span>
<a href="#l22.384"></a><span id="l22.384" class="difflineplus">+</span>
<a href="#l22.385"></a><span id="l22.385" class="difflineplus">+// const OTRL_POLICY_ERROR_START_AKE = 0x40;</span>
<a href="#l22.386"></a><span id="l22.386" class="difflineplus">+// Disabled to avoid automatic resend and MITM, as explained in</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineplus">+// https://github.com/arlolra/ctypes-otr/issues/55</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineplus">+</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineplus">+var OTRLib;</span>
<a href="#l22.390"></a><span id="l22.390" class="difflineplus">+</span>
<a href="#l22.391"></a><span id="l22.391" class="difflineplus">+if (libotr) OTRLib = {</span>
<a href="#l22.392"></a><span id="l22.392" class="difflineplus">+</span>
<a href="#l22.393"></a><span id="l22.393" class="difflineplus">+  path: libotrPath,</span>
<a href="#l22.394"></a><span id="l22.394" class="difflineplus">+</span>
<a href="#l22.395"></a><span id="l22.395" class="difflineplus">+  // libotr API version</span>
<a href="#l22.396"></a><span id="l22.396" class="difflineplus">+  otrl_version,</span>
<a href="#l22.397"></a><span id="l22.397" class="difflineplus">+</span>
<a href="#l22.398"></a><span id="l22.398" class="difflineplus">+  init() {</span>
<a href="#l22.399"></a><span id="l22.399" class="difflineplus">+    // console.log(&quot;===&gt; OTRLib.init()\n&quot;);</span>
<a href="#l22.400"></a><span id="l22.400" class="difflineplus">+    // apply version array as arguments to the init function</span>
<a href="#l22.401"></a><span id="l22.401" class="difflineplus">+    if (this.otrl_init.apply(this, this.otrl_version)) {</span>
<a href="#l22.402"></a><span id="l22.402" class="difflineplus">+      throw new Error(&quot;Couldn't initialize libotr.&quot;);</span>
<a href="#l22.403"></a><span id="l22.403" class="difflineplus">+    }</span>
<a href="#l22.404"></a><span id="l22.404" class="difflineplus">+    return true;</span>
<a href="#l22.405"></a><span id="l22.405" class="difflineplus">+  },</span>
<a href="#l22.406"></a><span id="l22.406" class="difflineplus">+</span>
<a href="#l22.407"></a><span id="l22.407" class="difflineplus">+  // proto.h</span>
<a href="#l22.408"></a><span id="l22.408" class="difflineplus">+</span>
<a href="#l22.409"></a><span id="l22.409" class="difflineplus">+  // If we ever see this sequence in a plaintext message, we'll assume the</span>
<a href="#l22.410"></a><span id="l22.410" class="difflineplus">+  // other side speaks OTR, and try to establish a connection.</span>
<a href="#l22.411"></a><span id="l22.411" class="difflineplus">+  OTRL_MESSAGE_TAG_BASE: &quot; \t  \t\t\t\t \t \t \t  &quot;,</span>
<a href="#l22.412"></a><span id="l22.412" class="difflineplus">+</span>
<a href="#l22.413"></a><span id="l22.413" class="difflineplus">+  OTRL_POLICY_OPPORTUNISTIC: new ctypes.unsigned_int(</span>
<a href="#l22.414"></a><span id="l22.414" class="difflineplus">+    OTRL_POLICY_ALLOW_V2 |</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineplus">+    // OTRL_POLICY_ALLOW_V3 |</span>
<a href="#l22.416"></a><span id="l22.416" class="difflineplus">+    OTRL_POLICY_SEND_WHITESPACE_TAG |</span>
<a href="#l22.417"></a><span id="l22.417" class="difflineplus">+    OTRL_POLICY_WHITESPACE_START_AKE |</span>
<a href="#l22.418"></a><span id="l22.418" class="difflineplus">+    // OTRL_POLICY_ERROR_START_AKE |</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineplus">+    0</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineplus">+  ),</span>
<a href="#l22.421"></a><span id="l22.421" class="difflineplus">+</span>
<a href="#l22.422"></a><span id="l22.422" class="difflineplus">+  OTRL_POLICY_ALWAYS: new ctypes.unsigned_int(</span>
<a href="#l22.423"></a><span id="l22.423" class="difflineplus">+    OTRL_POLICY_ALLOW_V2 |</span>
<a href="#l22.424"></a><span id="l22.424" class="difflineplus">+    // OTRL_POLICY_ALLOW_V3 |</span>
<a href="#l22.425"></a><span id="l22.425" class="difflineplus">+    OTRL_POLICY_REQUIRE_ENCRYPTION |</span>
<a href="#l22.426"></a><span id="l22.426" class="difflineplus">+    OTRL_POLICY_WHITESPACE_START_AKE |</span>
<a href="#l22.427"></a><span id="l22.427" class="difflineplus">+    // OTRL_POLICY_ERROR_START_AKE |</span>
<a href="#l22.428"></a><span id="l22.428" class="difflineplus">+    0</span>
<a href="#l22.429"></a><span id="l22.429" class="difflineplus">+  ),</span>
<a href="#l22.430"></a><span id="l22.430" class="difflineplus">+</span>
<a href="#l22.431"></a><span id="l22.431" class="difflineplus">+  fragPolicy: {</span>
<a href="#l22.432"></a><span id="l22.432" class="difflineplus">+    OTRL_FRAGMENT_SEND_SKIP: 0,</span>
<a href="#l22.433"></a><span id="l22.433" class="difflineplus">+    OTRL_FRAGMENT_SEND_ALL: 1,</span>
<a href="#l22.434"></a><span id="l22.434" class="difflineplus">+    OTRL_FRAGMENT_SEND_ALL_BUT_FIRST: 2,</span>
<a href="#l22.435"></a><span id="l22.435" class="difflineplus">+    OTRL_FRAGMENT_SEND_ALL_BUT_LAST: 3,</span>
<a href="#l22.436"></a><span id="l22.436" class="difflineplus">+  },</span>
<a href="#l22.437"></a><span id="l22.437" class="difflineplus">+</span>
<a href="#l22.438"></a><span id="l22.438" class="difflineplus">+  // Return a pointer to a newly-allocated OTR query message, customized</span>
<a href="#l22.439"></a><span id="l22.439" class="difflineplus">+  // with our name.  The caller should free() the result when he's done</span>
<a href="#l22.440"></a><span id="l22.440" class="difflineplus">+  // with it.</span>
<a href="#l22.441"></a><span id="l22.441" class="difflineplus">+  otrl_proto_default_query_msg: libotr.declare(</span>
<a href="#l22.442"></a><span id="l22.442" class="difflineplus">+    &quot;otrl_proto_default_query_msg&quot;, abi, ctypes.char.ptr,</span>
<a href="#l22.443"></a><span id="l22.443" class="difflineplus">+    ctypes.char.ptr, OtrlPolicy</span>
<a href="#l22.444"></a><span id="l22.444" class="difflineplus">+  ),</span>
<a href="#l22.445"></a><span id="l22.445" class="difflineplus">+</span>
<a href="#l22.446"></a><span id="l22.446" class="difflineplus">+  // Initialize the OTR library. Pass the version of the API you are using.</span>
<a href="#l22.447"></a><span id="l22.447" class="difflineplus">+  otrl_init: libotr.declare(</span>
<a href="#l22.448"></a><span id="l22.448" class="difflineplus">+    &quot;otrl_init&quot;, abi, gcry_error_t,</span>
<a href="#l22.449"></a><span id="l22.449" class="difflineplus">+    ctypes.unsigned_int, ctypes.unsigned_int, ctypes.unsigned_int</span>
<a href="#l22.450"></a><span id="l22.450" class="difflineplus">+  ),</span>
<a href="#l22.451"></a><span id="l22.451" class="difflineplus">+</span>
<a href="#l22.452"></a><span id="l22.452" class="difflineplus">+  // instag.h</span>
<a href="#l22.453"></a><span id="l22.453" class="difflineplus">+</span>
<a href="#l22.454"></a><span id="l22.454" class="difflineplus">+  instag: {</span>
<a href="#l22.455"></a><span id="l22.455" class="difflineplus">+    OTRL_INSTAG_MASTER: new ctypes.unsigned_int(0),</span>
<a href="#l22.456"></a><span id="l22.456" class="difflineplus">+    OTRL_INSTAG_BEST: new ctypes.unsigned_int(1),</span>
<a href="#l22.457"></a><span id="l22.457" class="difflineplus">+    OTRL_INSTAG_RECENT: new ctypes.unsigned_int(2),</span>
<a href="#l22.458"></a><span id="l22.458" class="difflineplus">+    OTRL_INSTAG_RECENT_RECEIVED: new ctypes.unsigned_int(3),</span>
<a href="#l22.459"></a><span id="l22.459" class="difflineplus">+    OTRL_INSTAG_RECENT_SENT: new ctypes.unsigned_int(4),</span>
<a href="#l22.460"></a><span id="l22.460" class="difflineplus">+    OTRL_MIN_VALID_INSTAG: new ctypes.unsigned_int(0x100),</span>
<a href="#l22.461"></a><span id="l22.461" class="difflineplus">+  },</span>
<a href="#l22.462"></a><span id="l22.462" class="difflineplus">+</span>
<a href="#l22.463"></a><span id="l22.463" class="difflineplus">+  // Get a new instance tag for the given account and write to file.  The FILE*</span>
<a href="#l22.464"></a><span id="l22.464" class="difflineplus">+  // must be open for writing.</span>
<a href="#l22.465"></a><span id="l22.465" class="difflineplus">+  otrl_instag_generate: callWithFILEp.bind(null, &quot;otrl_instag_generate&quot;, &quot;wb&quot;, 1),</span>
<a href="#l22.466"></a><span id="l22.466" class="difflineplus">+  otrl_instag_generate_FILEp: libotr.declare(</span>
<a href="#l22.467"></a><span id="l22.467" class="difflineplus">+    &quot;otrl_instag_generate_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.468"></a><span id="l22.468" class="difflineplus">+    OtrlUserState, FILE.ptr, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l22.469"></a><span id="l22.469" class="difflineplus">+  ),</span>
<a href="#l22.470"></a><span id="l22.470" class="difflineplus">+</span>
<a href="#l22.471"></a><span id="l22.471" class="difflineplus">+  // Read our instance tag from a file on disk into the given OtrlUserState.</span>
<a href="#l22.472"></a><span id="l22.472" class="difflineplus">+  // The FILE* must be open for reading.</span>
<a href="#l22.473"></a><span id="l22.473" class="difflineplus">+  otrl_instag_read: callWithFILEp.bind(null, &quot;otrl_instag_read&quot;, &quot;rb&quot;, 1),</span>
<a href="#l22.474"></a><span id="l22.474" class="difflineplus">+  otrl_instag_read_FILEp: libotr.declare(</span>
<a href="#l22.475"></a><span id="l22.475" class="difflineplus">+    &quot;otrl_instag_read_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.476"></a><span id="l22.476" class="difflineplus">+    OtrlUserState, FILE.ptr</span>
<a href="#l22.477"></a><span id="l22.477" class="difflineplus">+  ),</span>
<a href="#l22.478"></a><span id="l22.478" class="difflineplus">+</span>
<a href="#l22.479"></a><span id="l22.479" class="difflineplus">+  // Write our instance tags to a file on disk.  The FILE* must be open for</span>
<a href="#l22.480"></a><span id="l22.480" class="difflineplus">+  // writing.</span>
<a href="#l22.481"></a><span id="l22.481" class="difflineplus">+  otrl_instag_write: callWithFILEp.bind(null, &quot;otrl_instag_write&quot;, &quot;wb&quot;, 1),</span>
<a href="#l22.482"></a><span id="l22.482" class="difflineplus">+  otrl_instag_write_FILEp: libotr.declare(</span>
<a href="#l22.483"></a><span id="l22.483" class="difflineplus">+    &quot;otrl_instag_write_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.484"></a><span id="l22.484" class="difflineplus">+    OtrlUserState, FILE.ptr</span>
<a href="#l22.485"></a><span id="l22.485" class="difflineplus">+  ),</span>
<a href="#l22.486"></a><span id="l22.486" class="difflineplus">+</span>
<a href="#l22.487"></a><span id="l22.487" class="difflineplus">+  // auth.h</span>
<a href="#l22.488"></a><span id="l22.488" class="difflineplus">+</span>
<a href="#l22.489"></a><span id="l22.489" class="difflineplus">+  authState: {</span>
<a href="#l22.490"></a><span id="l22.490" class="difflineplus">+    OTRL_AUTHSTATE_NONE: 0,</span>
<a href="#l22.491"></a><span id="l22.491" class="difflineplus">+    OTRL_AUTHSTATE_AWAITING_DHKEY: 1,</span>
<a href="#l22.492"></a><span id="l22.492" class="difflineplus">+    OTRL_AUTHSTATE_AWAITING_REVEALSIG: 2,</span>
<a href="#l22.493"></a><span id="l22.493" class="difflineplus">+    OTRL_AUTHSTATE_AWAITING_SIG: 3,</span>
<a href="#l22.494"></a><span id="l22.494" class="difflineplus">+    OTRL_AUTHSTATE_V1_SETUP: 4,</span>
<a href="#l22.495"></a><span id="l22.495" class="difflineplus">+  },</span>
<a href="#l22.496"></a><span id="l22.496" class="difflineplus">+</span>
<a href="#l22.497"></a><span id="l22.497" class="difflineplus">+  // b64.h</span>
<a href="#l22.498"></a><span id="l22.498" class="difflineplus">+</span>
<a href="#l22.499"></a><span id="l22.499" class="difflineplus">+  // base64 encode data.  Insert no linebreaks or whitespace.</span>
<a href="#l22.500"></a><span id="l22.500" class="difflineplus">+  // The buffer base64data must contain at least ((datalen+2)/3)*4 bytes of</span>
<a href="#l22.501"></a><span id="l22.501" class="difflineplus">+  // space. This function will return the number of bytes actually used.</span>
<a href="#l22.502"></a><span id="l22.502" class="difflineplus">+  otrl_base64_encode: libotr.declare(</span>
<a href="#l22.503"></a><span id="l22.503" class="difflineplus">+    &quot;otrl_base64_encode&quot;, abi, ctypes.size_t,</span>
<a href="#l22.504"></a><span id="l22.504" class="difflineplus">+    ctypes.char.ptr, ctypes.unsigned_char.ptr, ctypes.size_t</span>
<a href="#l22.505"></a><span id="l22.505" class="difflineplus">+  ),</span>
<a href="#l22.506"></a><span id="l22.506" class="difflineplus">+</span>
<a href="#l22.507"></a><span id="l22.507" class="difflineplus">+  // base64 decode data.  Skip non-base64 chars, and terminate at the</span>
<a href="#l22.508"></a><span id="l22.508" class="difflineplus">+  // first '=', or the end of the buffer.</span>
<a href="#l22.509"></a><span id="l22.509" class="difflineplus">+  // The buffer data must contain at least ((base64len+3) / 4) * 3 bytes</span>
<a href="#l22.510"></a><span id="l22.510" class="difflineplus">+  // of space. This function will return the number of bytes actually</span>
<a href="#l22.511"></a><span id="l22.511" class="difflineplus">+  // used.</span>
<a href="#l22.512"></a><span id="l22.512" class="difflineplus">+  otrl_base64_decode: libotr.declare(</span>
<a href="#l22.513"></a><span id="l22.513" class="difflineplus">+    &quot;otrl_base64_decode&quot;, abi, ctypes.size_t,</span>
<a href="#l22.514"></a><span id="l22.514" class="difflineplus">+    ctypes.unsigned_char.ptr, ctypes.char.ptr, ctypes.size_t</span>
<a href="#l22.515"></a><span id="l22.515" class="difflineplus">+  ),</span>
<a href="#l22.516"></a><span id="l22.516" class="difflineplus">+</span>
<a href="#l22.517"></a><span id="l22.517" class="difflineplus">+  // context.h</span>
<a href="#l22.518"></a><span id="l22.518" class="difflineplus">+</span>
<a href="#l22.519"></a><span id="l22.519" class="difflineplus">+  otr_offer: {</span>
<a href="#l22.520"></a><span id="l22.520" class="difflineplus">+    OFFER_NOT: 0,</span>
<a href="#l22.521"></a><span id="l22.521" class="difflineplus">+    OFFER_SENT: 1,</span>
<a href="#l22.522"></a><span id="l22.522" class="difflineplus">+    OFFER_REJECTED: 2,</span>
<a href="#l22.523"></a><span id="l22.523" class="difflineplus">+    OFFER_ACCEPTED: 3,</span>
<a href="#l22.524"></a><span id="l22.524" class="difflineplus">+  },</span>
<a href="#l22.525"></a><span id="l22.525" class="difflineplus">+</span>
<a href="#l22.526"></a><span id="l22.526" class="difflineplus">+  messageState: {</span>
<a href="#l22.527"></a><span id="l22.527" class="difflineplus">+    OTRL_MSGSTATE_PLAINTEXT: 0,</span>
<a href="#l22.528"></a><span id="l22.528" class="difflineplus">+    OTRL_MSGSTATE_ENCRYPTED: 1,</span>
<a href="#l22.529"></a><span id="l22.529" class="difflineplus">+    OTRL_MSGSTATE_FINISHED: 2,</span>
<a href="#l22.530"></a><span id="l22.530" class="difflineplus">+  },</span>
<a href="#l22.531"></a><span id="l22.531" class="difflineplus">+</span>
<a href="#l22.532"></a><span id="l22.532" class="difflineplus">+  // Look up a connection context by name/account/protocol/instance from the</span>
<a href="#l22.533"></a><span id="l22.533" class="difflineplus">+  // given OtrlUserState.</span>
<a href="#l22.534"></a><span id="l22.534" class="difflineplus">+  otrl_context_find: libotr.declare(</span>
<a href="#l22.535"></a><span id="l22.535" class="difflineplus">+    &quot;otrl_context_find&quot;, abi, ConnContext.ptr,</span>
<a href="#l22.536"></a><span id="l22.536" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.537"></a><span id="l22.537" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.538"></a><span id="l22.538" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.539"></a><span id="l22.539" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.540"></a><span id="l22.540" class="difflineplus">+    otrl_instag_t,</span>
<a href="#l22.541"></a><span id="l22.541" class="difflineplus">+    ctypes.int,</span>
<a href="#l22.542"></a><span id="l22.542" class="difflineplus">+    ctypes.int.ptr,</span>
<a href="#l22.543"></a><span id="l22.543" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.544"></a><span id="l22.544" class="difflineplus">+    ctypes.void_t.ptr</span>
<a href="#l22.545"></a><span id="l22.545" class="difflineplus">+  ),</span>
<a href="#l22.546"></a><span id="l22.546" class="difflineplus">+</span>
<a href="#l22.547"></a><span id="l22.547" class="difflineplus">+  // Set the trust level for a given fingerprint.</span>
<a href="#l22.548"></a><span id="l22.548" class="difflineplus">+  otrl_context_set_trust: libotr.declare(</span>
<a href="#l22.549"></a><span id="l22.549" class="difflineplus">+    &quot;otrl_context_set_trust&quot;, abi, ctypes.void_t,</span>
<a href="#l22.550"></a><span id="l22.550" class="difflineplus">+    Fingerprint.ptr, ctypes.char.ptr</span>
<a href="#l22.551"></a><span id="l22.551" class="difflineplus">+  ),</span>
<a href="#l22.552"></a><span id="l22.552" class="difflineplus">+</span>
<a href="#l22.553"></a><span id="l22.553" class="difflineplus">+  // Find a fingerprint in a given context, perhaps adding it if not present.</span>
<a href="#l22.554"></a><span id="l22.554" class="difflineplus">+  otrl_context_find_fingerprint: libotr.declare(</span>
<a href="#l22.555"></a><span id="l22.555" class="difflineplus">+    &quot;otrl_context_find_fingerprint&quot;, abi, Fingerprint.ptr,</span>
<a href="#l22.556"></a><span id="l22.556" class="difflineplus">+    ConnContext.ptr, hash_t, ctypes.int, ctypes.int.ptr</span>
<a href="#l22.557"></a><span id="l22.557" class="difflineplus">+  ),</span>
<a href="#l22.558"></a><span id="l22.558" class="difflineplus">+</span>
<a href="#l22.559"></a><span id="l22.559" class="difflineplus">+  // Forget a fingerprint (and maybe the whole context).</span>
<a href="#l22.560"></a><span id="l22.560" class="difflineplus">+  otrl_context_forget_fingerprint: libotr.declare(</span>
<a href="#l22.561"></a><span id="l22.561" class="difflineplus">+    &quot;otrl_context_forget_fingerprint&quot;, abi, ctypes.void_t,</span>
<a href="#l22.562"></a><span id="l22.562" class="difflineplus">+    Fingerprint.ptr, ctypes.int</span>
<a href="#l22.563"></a><span id="l22.563" class="difflineplus">+  ),</span>
<a href="#l22.564"></a><span id="l22.564" class="difflineplus">+</span>
<a href="#l22.565"></a><span id="l22.565" class="difflineplus">+  // Return true iff the given fingerprint is marked as trusted.</span>
<a href="#l22.566"></a><span id="l22.566" class="difflineplus">+  otrl_context_is_fingerprint_trusted: libotr.declare(</span>
<a href="#l22.567"></a><span id="l22.567" class="difflineplus">+    &quot;otrl_context_is_fingerprint_trusted&quot;, abi, ctypes.int,</span>
<a href="#l22.568"></a><span id="l22.568" class="difflineplus">+    Fingerprint.ptr</span>
<a href="#l22.569"></a><span id="l22.569" class="difflineplus">+  ),</span>
<a href="#l22.570"></a><span id="l22.570" class="difflineplus">+</span>
<a href="#l22.571"></a><span id="l22.571" class="difflineplus">+  // dh.h</span>
<a href="#l22.572"></a><span id="l22.572" class="difflineplus">+</span>
<a href="#l22.573"></a><span id="l22.573" class="difflineplus">+  sessionIdHalf: {</span>
<a href="#l22.574"></a><span id="l22.574" class="difflineplus">+    OTRL_SESSIONID_FIRST_HALF_BOLD: 0,</span>
<a href="#l22.575"></a><span id="l22.575" class="difflineplus">+    OTRL_SESSIONID_SECOND_HALF_BOLD: 1,</span>
<a href="#l22.576"></a><span id="l22.576" class="difflineplus">+  },</span>
<a href="#l22.577"></a><span id="l22.577" class="difflineplus">+</span>
<a href="#l22.578"></a><span id="l22.578" class="difflineplus">+  // sm.h</span>
<a href="#l22.579"></a><span id="l22.579" class="difflineplus">+</span>
<a href="#l22.580"></a><span id="l22.580" class="difflineplus">+  nextExpectedSMP: {</span>
<a href="#l22.581"></a><span id="l22.581" class="difflineplus">+    OTRL_SMP_EXPECT1: 0,</span>
<a href="#l22.582"></a><span id="l22.582" class="difflineplus">+    OTRL_SMP_EXPECT2: 1,</span>
<a href="#l22.583"></a><span id="l22.583" class="difflineplus">+    OTRL_SMP_EXPECT3: 2,</span>
<a href="#l22.584"></a><span id="l22.584" class="difflineplus">+    OTRL_SMP_EXPECT4: 3,</span>
<a href="#l22.585"></a><span id="l22.585" class="difflineplus">+    OTRL_SMP_EXPECT5: 4,</span>
<a href="#l22.586"></a><span id="l22.586" class="difflineplus">+  },</span>
<a href="#l22.587"></a><span id="l22.587" class="difflineplus">+</span>
<a href="#l22.588"></a><span id="l22.588" class="difflineplus">+  smProgState: {</span>
<a href="#l22.589"></a><span id="l22.589" class="difflineplus">+    OTRL_SMP_PROG_OK: 0,</span>
<a href="#l22.590"></a><span id="l22.590" class="difflineplus">+    OTRL_SMP_PROG_CHEATED: -2,</span>
<a href="#l22.591"></a><span id="l22.591" class="difflineplus">+    OTRL_SMP_PROG_FAILED: -1,</span>
<a href="#l22.592"></a><span id="l22.592" class="difflineplus">+    OTRL_SMP_PROG_SUCCEEDED: 1,</span>
<a href="#l22.593"></a><span id="l22.593" class="difflineplus">+  },</span>
<a href="#l22.594"></a><span id="l22.594" class="difflineplus">+</span>
<a href="#l22.595"></a><span id="l22.595" class="difflineplus">+  // userstate.h</span>
<a href="#l22.596"></a><span id="l22.596" class="difflineplus">+</span>
<a href="#l22.597"></a><span id="l22.597" class="difflineplus">+  // Create a new OtrlUserState.</span>
<a href="#l22.598"></a><span id="l22.598" class="difflineplus">+  otrl_userstate_create: libotr.declare(</span>
<a href="#l22.599"></a><span id="l22.599" class="difflineplus">+    &quot;otrl_userstate_create&quot;, abi, OtrlUserState</span>
<a href="#l22.600"></a><span id="l22.600" class="difflineplus">+  ),</span>
<a href="#l22.601"></a><span id="l22.601" class="difflineplus">+</span>
<a href="#l22.602"></a><span id="l22.602" class="difflineplus">+  // privkey.h</span>
<a href="#l22.603"></a><span id="l22.603" class="difflineplus">+</span>
<a href="#l22.604"></a><span id="l22.604" class="difflineplus">+  // Generate a private DSA key for a given account, storing it into a file on</span>
<a href="#l22.605"></a><span id="l22.605" class="difflineplus">+  // disk, and loading it into the given OtrlUserState. Overwrite any</span>
<a href="#l22.606"></a><span id="l22.606" class="difflineplus">+  // previously generated keys for that account in that OtrlUserState.</span>
<a href="#l22.607"></a><span id="l22.607" class="difflineplus">+  otrl_privkey_generate: callWithFILEp.bind(null, &quot;otrl_privkey_generate&quot;, &quot;w+b&quot;, 1),</span>
<a href="#l22.608"></a><span id="l22.608" class="difflineplus">+  otrl_privkey_generate_FILEp: libotr.declare(</span>
<a href="#l22.609"></a><span id="l22.609" class="difflineplus">+    &quot;otrl_privkey_generate_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.610"></a><span id="l22.610" class="difflineplus">+    OtrlUserState, FILE.ptr, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l22.611"></a><span id="l22.611" class="difflineplus">+  ),</span>
<a href="#l22.612"></a><span id="l22.612" class="difflineplus">+</span>
<a href="#l22.613"></a><span id="l22.613" class="difflineplus">+  // Begin a private key generation that will potentially take place in</span>
<a href="#l22.614"></a><span id="l22.614" class="difflineplus">+  // a background thread. This routine must be called from the main</span>
<a href="#l22.615"></a><span id="l22.615" class="difflineplus">+  // thread. It will set *newkeyp, which you can pass to</span>
<a href="#l22.616"></a><span id="l22.616" class="difflineplus">+  // otrl_privkey_generate_calculate in a background thread.  If it</span>
<a href="#l22.617"></a><span id="l22.617" class="difflineplus">+  // returns gcry_error(GPG_ERR_EEXIST), then a privkey creation for</span>
<a href="#l22.618"></a><span id="l22.618" class="difflineplus">+  // this accountname/protocol is already in progress, and *newkeyp will</span>
<a href="#l22.619"></a><span id="l22.619" class="difflineplus">+  // be set to NULL.</span>
<a href="#l22.620"></a><span id="l22.620" class="difflineplus">+  otrl_privkey_generate_start: libotr.declare(</span>
<a href="#l22.621"></a><span id="l22.621" class="difflineplus">+    &quot;otrl_privkey_generate_start&quot;, abi, gcry_error_t,</span>
<a href="#l22.622"></a><span id="l22.622" class="difflineplus">+    OtrlUserState, ctypes.char.ptr, ctypes.char.ptr, ctypes.void_t.ptr.ptr</span>
<a href="#l22.623"></a><span id="l22.623" class="difflineplus">+  ),</span>
<a href="#l22.624"></a><span id="l22.624" class="difflineplus">+</span>
<a href="#l22.625"></a><span id="l22.625" class="difflineplus">+  // Do the private key generation calculation. You may call this from a</span>
<a href="#l22.626"></a><span id="l22.626" class="difflineplus">+  // background thread.  When it completes, call</span>
<a href="#l22.627"></a><span id="l22.627" class="difflineplus">+  // otrl_privkey_generate_finish from the _main_ thread.</span>
<a href="#l22.628"></a><span id="l22.628" class="difflineplus">+  otrl_privkey_generate_calculate: libotr.declare(</span>
<a href="#l22.629"></a><span id="l22.629" class="difflineplus">+    &quot;otrl_privkey_generate_calculate&quot;, abi, gcry_error_t,</span>
<a href="#l22.630"></a><span id="l22.630" class="difflineplus">+    ctypes.void_t.ptr</span>
<a href="#l22.631"></a><span id="l22.631" class="difflineplus">+  ),</span>
<a href="#l22.632"></a><span id="l22.632" class="difflineplus">+</span>
<a href="#l22.633"></a><span id="l22.633" class="difflineplus">+  // Call this from the main thread only. It will write the newly created</span>
<a href="#l22.634"></a><span id="l22.634" class="difflineplus">+  // private key into the given file and store it in the OtrlUserState.</span>
<a href="#l22.635"></a><span id="l22.635" class="difflineplus">+  otrl_privkey_generate_finish: callWithFILEp.bind(null, &quot;otrl_privkey_generate_finish&quot;, &quot;w+b&quot;, 2),</span>
<a href="#l22.636"></a><span id="l22.636" class="difflineplus">+  otrl_privkey_generate_finish_FILEp: libotr.declare(</span>
<a href="#l22.637"></a><span id="l22.637" class="difflineplus">+    &quot;otrl_privkey_generate_finish_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.638"></a><span id="l22.638" class="difflineplus">+    OtrlUserState, ctypes.void_t.ptr, FILE.ptr</span>
<a href="#l22.639"></a><span id="l22.639" class="difflineplus">+  ),</span>
<a href="#l22.640"></a><span id="l22.640" class="difflineplus">+</span>
<a href="#l22.641"></a><span id="l22.641" class="difflineplus">+  // Call this from the main thread only, in the event that the background</span>
<a href="#l22.642"></a><span id="l22.642" class="difflineplus">+  // thread generating the key is cancelled. The newkey is deallocated,</span>
<a href="#l22.643"></a><span id="l22.643" class="difflineplus">+  // and must not be used further.</span>
<a href="#l22.644"></a><span id="l22.644" class="difflineplus">+  otrl_privkey_generate_cancelled: libotr.declare(</span>
<a href="#l22.645"></a><span id="l22.645" class="difflineplus">+    &quot;otrl_privkey_generate_cancelled&quot;, abi, gcry_error_t,</span>
<a href="#l22.646"></a><span id="l22.646" class="difflineplus">+    OtrlUserState, ctypes.void_t.ptr</span>
<a href="#l22.647"></a><span id="l22.647" class="difflineplus">+  ),</span>
<a href="#l22.648"></a><span id="l22.648" class="difflineplus">+</span>
<a href="#l22.649"></a><span id="l22.649" class="difflineplus">+  // Read a sets of private DSA keys from a file on disk into the given</span>
<a href="#l22.650"></a><span id="l22.650" class="difflineplus">+  // OtrlUserState.</span>
<a href="#l22.651"></a><span id="l22.651" class="difflineplus">+  otrl_privkey_read: callWithFILEp.bind(null, &quot;otrl_privkey_read&quot;, &quot;rb&quot;, 1),</span>
<a href="#l22.652"></a><span id="l22.652" class="difflineplus">+  otrl_privkey_read_FILEp: libotr.declare(</span>
<a href="#l22.653"></a><span id="l22.653" class="difflineplus">+    &quot;otrl_privkey_read_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.654"></a><span id="l22.654" class="difflineplus">+    OtrlUserState, FILE.ptr</span>
<a href="#l22.655"></a><span id="l22.655" class="difflineplus">+  ),</span>
<a href="#l22.656"></a><span id="l22.656" class="difflineplus">+</span>
<a href="#l22.657"></a><span id="l22.657" class="difflineplus">+  // Read the fingerprint store from a file on disk into the given</span>
<a href="#l22.658"></a><span id="l22.658" class="difflineplus">+  // OtrlUserState.</span>
<a href="#l22.659"></a><span id="l22.659" class="difflineplus">+  otrl_privkey_read_fingerprints: callWithFILEp.bind(null, &quot;otrl_privkey_read_fingerprints&quot;, &quot;rb&quot;, 1),</span>
<a href="#l22.660"></a><span id="l22.660" class="difflineplus">+  otrl_privkey_read_fingerprints_FILEp: libotr.declare(</span>
<a href="#l22.661"></a><span id="l22.661" class="difflineplus">+    &quot;otrl_privkey_read_fingerprints_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.662"></a><span id="l22.662" class="difflineplus">+    OtrlUserState, FILE.ptr, ctypes.void_t.ptr, ctypes.void_t.ptr</span>
<a href="#l22.663"></a><span id="l22.663" class="difflineplus">+  ),</span>
<a href="#l22.664"></a><span id="l22.664" class="difflineplus">+</span>
<a href="#l22.665"></a><span id="l22.665" class="difflineplus">+  // Write the fingerprint store from a given OtrlUserState to a file on disk.</span>
<a href="#l22.666"></a><span id="l22.666" class="difflineplus">+  otrl_privkey_write_fingerprints: callWithFILEp.bind(null, &quot;otrl_privkey_write_fingerprints&quot;, &quot;wb&quot;, 1),</span>
<a href="#l22.667"></a><span id="l22.667" class="difflineplus">+  otrl_privkey_write_fingerprints_FILEp: libotr.declare(</span>
<a href="#l22.668"></a><span id="l22.668" class="difflineplus">+    &quot;otrl_privkey_write_fingerprints_FILEp&quot;, abi, gcry_error_t,</span>
<a href="#l22.669"></a><span id="l22.669" class="difflineplus">+    OtrlUserState, FILE.ptr</span>
<a href="#l22.670"></a><span id="l22.670" class="difflineplus">+  ),</span>
<a href="#l22.671"></a><span id="l22.671" class="difflineplus">+</span>
<a href="#l22.672"></a><span id="l22.672" class="difflineplus">+  // The length of a string representing a human-readable version of a</span>
<a href="#l22.673"></a><span id="l22.673" class="difflineplus">+  // fingerprint (including the trailing NUL).</span>
<a href="#l22.674"></a><span id="l22.674" class="difflineplus">+  OTRL_PRIVKEY_FPRINT_HUMAN_LEN,</span>
<a href="#l22.675"></a><span id="l22.675" class="difflineplus">+</span>
<a href="#l22.676"></a><span id="l22.676" class="difflineplus">+  // Human readable fingerprint type</span>
<a href="#l22.677"></a><span id="l22.677" class="difflineplus">+  fingerprint_t,</span>
<a href="#l22.678"></a><span id="l22.678" class="difflineplus">+</span>
<a href="#l22.679"></a><span id="l22.679" class="difflineplus">+  // fingerprint value</span>
<a href="#l22.680"></a><span id="l22.680" class="difflineplus">+  hash_t,</span>
<a href="#l22.681"></a><span id="l22.681" class="difflineplus">+</span>
<a href="#l22.682"></a><span id="l22.682" class="difflineplus">+  // Calculate a human-readable hash of our DSA public key. Return it in the</span>
<a href="#l22.683"></a><span id="l22.683" class="difflineplus">+  // passed fingerprint buffer. Return NULL on error, or a pointer to the given</span>
<a href="#l22.684"></a><span id="l22.684" class="difflineplus">+  // buffer on success.</span>
<a href="#l22.685"></a><span id="l22.685" class="difflineplus">+  otrl_privkey_fingerprint: libotr.declare(</span>
<a href="#l22.686"></a><span id="l22.686" class="difflineplus">+    &quot;otrl_privkey_fingerprint&quot;, abi, ctypes.char.ptr,</span>
<a href="#l22.687"></a><span id="l22.687" class="difflineplus">+    OtrlUserState, fingerprint_t, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l22.688"></a><span id="l22.688" class="difflineplus">+  ),</span>
<a href="#l22.689"></a><span id="l22.689" class="difflineplus">+</span>
<a href="#l22.690"></a><span id="l22.690" class="difflineplus">+  // Convert a 20-byte hash value to a 45-byte human-readable value.</span>
<a href="#l22.691"></a><span id="l22.691" class="difflineplus">+  otrl_privkey_hash_to_human: libotr.declare(</span>
<a href="#l22.692"></a><span id="l22.692" class="difflineplus">+    &quot;otrl_privkey_hash_to_human&quot;, abi, ctypes.void_t,</span>
<a href="#l22.693"></a><span id="l22.693" class="difflineplus">+    fingerprint_t, hash_t</span>
<a href="#l22.694"></a><span id="l22.694" class="difflineplus">+  ),</span>
<a href="#l22.695"></a><span id="l22.695" class="difflineplus">+</span>
<a href="#l22.696"></a><span id="l22.696" class="difflineplus">+  // Calculate a raw hash of our DSA public key.  Return it in the passed</span>
<a href="#l22.697"></a><span id="l22.697" class="difflineplus">+  // fingerprint buffer.  Return NULL on error, or a pointer to the given</span>
<a href="#l22.698"></a><span id="l22.698" class="difflineplus">+  // buffer on success.</span>
<a href="#l22.699"></a><span id="l22.699" class="difflineplus">+  otrl_privkey_fingerprint_raw: libotr.declare(</span>
<a href="#l22.700"></a><span id="l22.700" class="difflineplus">+    &quot;otrl_privkey_fingerprint_raw&quot;, abi, ctypes.unsigned_char.ptr,</span>
<a href="#l22.701"></a><span id="l22.701" class="difflineplus">+    OtrlUserState, hash_t, ctypes.char.ptr, ctypes.char.ptr</span>
<a href="#l22.702"></a><span id="l22.702" class="difflineplus">+  ),</span>
<a href="#l22.703"></a><span id="l22.703" class="difflineplus">+</span>
<a href="#l22.704"></a><span id="l22.704" class="difflineplus">+  // uiOps callbacks</span>
<a href="#l22.705"></a><span id="l22.705" class="difflineplus">+  policy_cb_t,</span>
<a href="#l22.706"></a><span id="l22.706" class="difflineplus">+  create_privkey_cb_t,</span>
<a href="#l22.707"></a><span id="l22.707" class="difflineplus">+  is_logged_in_cb_t,</span>
<a href="#l22.708"></a><span id="l22.708" class="difflineplus">+  inject_message_cb_t,</span>
<a href="#l22.709"></a><span id="l22.709" class="difflineplus">+  update_context_list_cb_t,</span>
<a href="#l22.710"></a><span id="l22.710" class="difflineplus">+  new_fingerprint_cb_t,</span>
<a href="#l22.711"></a><span id="l22.711" class="difflineplus">+  write_fingerprint_cb_t,</span>
<a href="#l22.712"></a><span id="l22.712" class="difflineplus">+  gone_secure_cb_t,</span>
<a href="#l22.713"></a><span id="l22.713" class="difflineplus">+  gone_insecure_cb_t,</span>
<a href="#l22.714"></a><span id="l22.714" class="difflineplus">+  still_secure_cb_t,</span>
<a href="#l22.715"></a><span id="l22.715" class="difflineplus">+  max_message_size_cb_t,</span>
<a href="#l22.716"></a><span id="l22.716" class="difflineplus">+  account_name_cb_t,</span>
<a href="#l22.717"></a><span id="l22.717" class="difflineplus">+  account_name_free_cb_t,</span>
<a href="#l22.718"></a><span id="l22.718" class="difflineplus">+  received_symkey_cb_t,</span>
<a href="#l22.719"></a><span id="l22.719" class="difflineplus">+  otr_error_message_cb_t,</span>
<a href="#l22.720"></a><span id="l22.720" class="difflineplus">+  otr_error_message_free_cb_t,</span>
<a href="#l22.721"></a><span id="l22.721" class="difflineplus">+  resent_msg_prefix_cb_t,</span>
<a href="#l22.722"></a><span id="l22.722" class="difflineplus">+  resent_msg_prefix_free_cb_t,</span>
<a href="#l22.723"></a><span id="l22.723" class="difflineplus">+  handle_smp_event_cb_t,</span>
<a href="#l22.724"></a><span id="l22.724" class="difflineplus">+  handle_msg_event_cb_t,</span>
<a href="#l22.725"></a><span id="l22.725" class="difflineplus">+  create_instag_cb_t,</span>
<a href="#l22.726"></a><span id="l22.726" class="difflineplus">+  convert_msg_cb_t,</span>
<a href="#l22.727"></a><span id="l22.727" class="difflineplus">+  convert_free_cb_t,</span>
<a href="#l22.728"></a><span id="l22.728" class="difflineplus">+  timer_control_cb_t,</span>
<a href="#l22.729"></a><span id="l22.729" class="difflineplus">+</span>
<a href="#l22.730"></a><span id="l22.730" class="difflineplus">+  // message.h</span>
<a href="#l22.731"></a><span id="l22.731" class="difflineplus">+</span>
<a href="#l22.732"></a><span id="l22.732" class="difflineplus">+  OtrlMessageAppOps,</span>
<a href="#l22.733"></a><span id="l22.733" class="difflineplus">+</span>
<a href="#l22.734"></a><span id="l22.734" class="difflineplus">+  errorCode: {</span>
<a href="#l22.735"></a><span id="l22.735" class="difflineplus">+    OTRL_ERRCODE_NONE: 0,</span>
<a href="#l22.736"></a><span id="l22.736" class="difflineplus">+    OTRL_ERRCODE_ENCRYPTION_ERROR: 1,</span>
<a href="#l22.737"></a><span id="l22.737" class="difflineplus">+    OTRL_ERRCODE_MSG_NOT_IN_PRIVATE: 2,</span>
<a href="#l22.738"></a><span id="l22.738" class="difflineplus">+    OTRL_ERRCODE_MSG_UNREADABLE: 3,</span>
<a href="#l22.739"></a><span id="l22.739" class="difflineplus">+    OTRL_ERRCODE_MSG_MALFORMED: 4,</span>
<a href="#l22.740"></a><span id="l22.740" class="difflineplus">+  },</span>
<a href="#l22.741"></a><span id="l22.741" class="difflineplus">+</span>
<a href="#l22.742"></a><span id="l22.742" class="difflineplus">+  smpEvent: {</span>
<a href="#l22.743"></a><span id="l22.743" class="difflineplus">+    OTRL_SMPEVENT_NONE: 0,</span>
<a href="#l22.744"></a><span id="l22.744" class="difflineplus">+    OTRL_SMPEVENT_ERROR: 1,</span>
<a href="#l22.745"></a><span id="l22.745" class="difflineplus">+    OTRL_SMPEVENT_ABORT: 2,</span>
<a href="#l22.746"></a><span id="l22.746" class="difflineplus">+    OTRL_SMPEVENT_CHEATED: 3,</span>
<a href="#l22.747"></a><span id="l22.747" class="difflineplus">+    OTRL_SMPEVENT_ASK_FOR_ANSWER: 4,</span>
<a href="#l22.748"></a><span id="l22.748" class="difflineplus">+    OTRL_SMPEVENT_ASK_FOR_SECRET: 5,</span>
<a href="#l22.749"></a><span id="l22.749" class="difflineplus">+    OTRL_SMPEVENT_IN_PROGRESS: 6,</span>
<a href="#l22.750"></a><span id="l22.750" class="difflineplus">+    OTRL_SMPEVENT_SUCCESS: 7,</span>
<a href="#l22.751"></a><span id="l22.751" class="difflineplus">+    OTRL_SMPEVENT_FAILURE: 8,</span>
<a href="#l22.752"></a><span id="l22.752" class="difflineplus">+  },</span>
<a href="#l22.753"></a><span id="l22.753" class="difflineplus">+</span>
<a href="#l22.754"></a><span id="l22.754" class="difflineplus">+  messageEvent: {</span>
<a href="#l22.755"></a><span id="l22.755" class="difflineplus">+    OTRL_MSGEVENT_NONE: 0,</span>
<a href="#l22.756"></a><span id="l22.756" class="difflineplus">+    OTRL_MSGEVENT_ENCRYPTION_REQUIRED: 1,</span>
<a href="#l22.757"></a><span id="l22.757" class="difflineplus">+    OTRL_MSGEVENT_ENCRYPTION_ERROR: 2,</span>
<a href="#l22.758"></a><span id="l22.758" class="difflineplus">+    OTRL_MSGEVENT_CONNECTION_ENDED: 3,</span>
<a href="#l22.759"></a><span id="l22.759" class="difflineplus">+    OTRL_MSGEVENT_SETUP_ERROR: 4,</span>
<a href="#l22.760"></a><span id="l22.760" class="difflineplus">+    OTRL_MSGEVENT_MSG_REFLECTED: 5,</span>
<a href="#l22.761"></a><span id="l22.761" class="difflineplus">+    OTRL_MSGEVENT_MSG_RESENT: 6,</span>
<a href="#l22.762"></a><span id="l22.762" class="difflineplus">+    OTRL_MSGEVENT_RCVDMSG_NOT_IN_PRIVATE: 7,</span>
<a href="#l22.763"></a><span id="l22.763" class="difflineplus">+    OTRL_MSGEVENT_RCVDMSG_UNREADABLE: 8,</span>
<a href="#l22.764"></a><span id="l22.764" class="difflineplus">+    OTRL_MSGEVENT_RCVDMSG_MALFORMED: 9,</span>
<a href="#l22.765"></a><span id="l22.765" class="difflineplus">+    OTRL_MSGEVENT_LOG_HEARTBEAT_RCVD: 10,</span>
<a href="#l22.766"></a><span id="l22.766" class="difflineplus">+    OTRL_MSGEVENT_LOG_HEARTBEAT_SENT: 11,</span>
<a href="#l22.767"></a><span id="l22.767" class="difflineplus">+    OTRL_MSGEVENT_RCVDMSG_GENERAL_ERR: 12,</span>
<a href="#l22.768"></a><span id="l22.768" class="difflineplus">+    OTRL_MSGEVENT_RCVDMSG_UNENCRYPTED: 13,</span>
<a href="#l22.769"></a><span id="l22.769" class="difflineplus">+    OTRL_MSGEVENT_RCVDMSG_UNRECOGNIZED: 14,</span>
<a href="#l22.770"></a><span id="l22.770" class="difflineplus">+    OTRL_MSGEVENT_RCVDMSG_FOR_OTHER_INSTANCE: 15,</span>
<a href="#l22.771"></a><span id="l22.771" class="difflineplus">+  },</span>
<a href="#l22.772"></a><span id="l22.772" class="difflineplus">+</span>
<a href="#l22.773"></a><span id="l22.773" class="difflineplus">+  convertType: {</span>
<a href="#l22.774"></a><span id="l22.774" class="difflineplus">+    OTRL_CONVERT_SENDING: 0,</span>
<a href="#l22.775"></a><span id="l22.775" class="difflineplus">+    OTRL_CONVERT_RECEIVING: 1,</span>
<a href="#l22.776"></a><span id="l22.776" class="difflineplus">+  },</span>
<a href="#l22.777"></a><span id="l22.777" class="difflineplus">+</span>
<a href="#l22.778"></a><span id="l22.778" class="difflineplus">+  // Deallocate a message allocated by other otrl_message_* routines.</span>
<a href="#l22.779"></a><span id="l22.779" class="difflineplus">+  otrl_message_free: libotr.declare(</span>
<a href="#l22.780"></a><span id="l22.780" class="difflineplus">+    &quot;otrl_message_free&quot;, abi, ctypes.void_t,</span>
<a href="#l22.781"></a><span id="l22.781" class="difflineplus">+    ctypes.char.ptr</span>
<a href="#l22.782"></a><span id="l22.782" class="difflineplus">+  ),</span>
<a href="#l22.783"></a><span id="l22.783" class="difflineplus">+</span>
<a href="#l22.784"></a><span id="l22.784" class="difflineplus">+  // Handle a message about to be sent to the network.</span>
<a href="#l22.785"></a><span id="l22.785" class="difflineplus">+  otrl_message_sending: libotr.declare(</span>
<a href="#l22.786"></a><span id="l22.786" class="difflineplus">+    &quot;otrl_message_sending&quot;, abi, gcry_error_t,</span>
<a href="#l22.787"></a><span id="l22.787" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.788"></a><span id="l22.788" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.789"></a><span id="l22.789" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.790"></a><span id="l22.790" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.791"></a><span id="l22.791" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.792"></a><span id="l22.792" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.793"></a><span id="l22.793" class="difflineplus">+    otrl_instag_t,</span>
<a href="#l22.794"></a><span id="l22.794" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.795"></a><span id="l22.795" class="difflineplus">+    OtrlTLV.ptr,</span>
<a href="#l22.796"></a><span id="l22.796" class="difflineplus">+    ctypes.char.ptr.ptr,</span>
<a href="#l22.797"></a><span id="l22.797" class="difflineplus">+    OtrlFragmentPolicy,</span>
<a href="#l22.798"></a><span id="l22.798" class="difflineplus">+    ConnContext.ptr.ptr,</span>
<a href="#l22.799"></a><span id="l22.799" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.800"></a><span id="l22.800" class="difflineplus">+    ctypes.void_t.ptr</span>
<a href="#l22.801"></a><span id="l22.801" class="difflineplus">+  ),</span>
<a href="#l22.802"></a><span id="l22.802" class="difflineplus">+</span>
<a href="#l22.803"></a><span id="l22.803" class="difflineplus">+  // Handle a message just received from the network.</span>
<a href="#l22.804"></a><span id="l22.804" class="difflineplus">+  otrl_message_receiving: libotr.declare(</span>
<a href="#l22.805"></a><span id="l22.805" class="difflineplus">+    &quot;otrl_message_receiving&quot;, abi, ctypes.int,</span>
<a href="#l22.806"></a><span id="l22.806" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.807"></a><span id="l22.807" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.808"></a><span id="l22.808" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.809"></a><span id="l22.809" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.810"></a><span id="l22.810" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.811"></a><span id="l22.811" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.812"></a><span id="l22.812" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.813"></a><span id="l22.813" class="difflineplus">+    ctypes.char.ptr.ptr,</span>
<a href="#l22.814"></a><span id="l22.814" class="difflineplus">+    OtrlTLV.ptr.ptr,</span>
<a href="#l22.815"></a><span id="l22.815" class="difflineplus">+    ConnContext.ptr.ptr,</span>
<a href="#l22.816"></a><span id="l22.816" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.817"></a><span id="l22.817" class="difflineplus">+    ctypes.void_t.ptr</span>
<a href="#l22.818"></a><span id="l22.818" class="difflineplus">+  ),</span>
<a href="#l22.819"></a><span id="l22.819" class="difflineplus">+</span>
<a href="#l22.820"></a><span id="l22.820" class="difflineplus">+  // Put a connection into the PLAINTEXT state, first sending the</span>
<a href="#l22.821"></a><span id="l22.821" class="difflineplus">+  // other side a notice that we're doing so if we're currently ENCRYPTED,</span>
<a href="#l22.822"></a><span id="l22.822" class="difflineplus">+  // and we think he's logged in. Affects only the specified instance.</span>
<a href="#l22.823"></a><span id="l22.823" class="difflineplus">+  otrl_message_disconnect: libotr.declare(</span>
<a href="#l22.824"></a><span id="l22.824" class="difflineplus">+    &quot;otrl_message_disconnect&quot;, abi, ctypes.void_t,</span>
<a href="#l22.825"></a><span id="l22.825" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.826"></a><span id="l22.826" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.827"></a><span id="l22.827" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.828"></a><span id="l22.828" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.829"></a><span id="l22.829" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.830"></a><span id="l22.830" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.831"></a><span id="l22.831" class="difflineplus">+    otrl_instag_t</span>
<a href="#l22.832"></a><span id="l22.832" class="difflineplus">+  ),</span>
<a href="#l22.833"></a><span id="l22.833" class="difflineplus">+</span>
<a href="#l22.834"></a><span id="l22.834" class="difflineplus">+  // Call this function every so often, to clean up stale private state that</span>
<a href="#l22.835"></a><span id="l22.835" class="difflineplus">+  // may otherwise stick around in memory.</span>
<a href="#l22.836"></a><span id="l22.836" class="difflineplus">+  otrl_message_poll: libotr.declare(</span>
<a href="#l22.837"></a><span id="l22.837" class="difflineplus">+    &quot;otrl_message_poll&quot;, abi, ctypes.void_t,</span>
<a href="#l22.838"></a><span id="l22.838" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.839"></a><span id="l22.839" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.840"></a><span id="l22.840" class="difflineplus">+    ctypes.void_t.ptr</span>
<a href="#l22.841"></a><span id="l22.841" class="difflineplus">+  ),</span>
<a href="#l22.842"></a><span id="l22.842" class="difflineplus">+</span>
<a href="#l22.843"></a><span id="l22.843" class="difflineplus">+  // Initiate the Socialist Millionaires' Protocol.</span>
<a href="#l22.844"></a><span id="l22.844" class="difflineplus">+  otrl_message_initiate_smp: libotr.declare(</span>
<a href="#l22.845"></a><span id="l22.845" class="difflineplus">+    &quot;otrl_message_initiate_smp&quot;, abi, ctypes.void_t,</span>
<a href="#l22.846"></a><span id="l22.846" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.847"></a><span id="l22.847" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.848"></a><span id="l22.848" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.849"></a><span id="l22.849" class="difflineplus">+    ConnContext.ptr,</span>
<a href="#l22.850"></a><span id="l22.850" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.851"></a><span id="l22.851" class="difflineplus">+    ctypes.size_t</span>
<a href="#l22.852"></a><span id="l22.852" class="difflineplus">+  ),</span>
<a href="#l22.853"></a><span id="l22.853" class="difflineplus">+</span>
<a href="#l22.854"></a><span id="l22.854" class="difflineplus">+  // Initiate the Socialist Millionaires' Protocol and send a prompt</span>
<a href="#l22.855"></a><span id="l22.855" class="difflineplus">+  // question to the buddy.</span>
<a href="#l22.856"></a><span id="l22.856" class="difflineplus">+  otrl_message_initiate_smp_q: libotr.declare(</span>
<a href="#l22.857"></a><span id="l22.857" class="difflineplus">+    &quot;otrl_message_initiate_smp_q&quot;, abi, ctypes.void_t,</span>
<a href="#l22.858"></a><span id="l22.858" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.859"></a><span id="l22.859" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.860"></a><span id="l22.860" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.861"></a><span id="l22.861" class="difflineplus">+    ConnContext.ptr,</span>
<a href="#l22.862"></a><span id="l22.862" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.863"></a><span id="l22.863" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.864"></a><span id="l22.864" class="difflineplus">+    ctypes.size_t</span>
<a href="#l22.865"></a><span id="l22.865" class="difflineplus">+  ),</span>
<a href="#l22.866"></a><span id="l22.866" class="difflineplus">+</span>
<a href="#l22.867"></a><span id="l22.867" class="difflineplus">+  // Respond to a buddy initiating the Socialist Millionaires' Protocol.</span>
<a href="#l22.868"></a><span id="l22.868" class="difflineplus">+  otrl_message_respond_smp: libotr.declare(</span>
<a href="#l22.869"></a><span id="l22.869" class="difflineplus">+    &quot;otrl_message_respond_smp&quot;, abi, ctypes.void_t,</span>
<a href="#l22.870"></a><span id="l22.870" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.871"></a><span id="l22.871" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.872"></a><span id="l22.872" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.873"></a><span id="l22.873" class="difflineplus">+    ConnContext.ptr,</span>
<a href="#l22.874"></a><span id="l22.874" class="difflineplus">+    ctypes.char.ptr,</span>
<a href="#l22.875"></a><span id="l22.875" class="difflineplus">+    ctypes.size_t</span>
<a href="#l22.876"></a><span id="l22.876" class="difflineplus">+  ),</span>
<a href="#l22.877"></a><span id="l22.877" class="difflineplus">+</span>
<a href="#l22.878"></a><span id="l22.878" class="difflineplus">+  // Abort the SMP. Called when an unexpected SMP message breaks the</span>
<a href="#l22.879"></a><span id="l22.879" class="difflineplus">+  // normal flow.</span>
<a href="#l22.880"></a><span id="l22.880" class="difflineplus">+  otrl_message_abort_smp: libotr.declare(</span>
<a href="#l22.881"></a><span id="l22.881" class="difflineplus">+    &quot;otrl_message_abort_smp&quot;, abi, ctypes.void_t,</span>
<a href="#l22.882"></a><span id="l22.882" class="difflineplus">+    OtrlUserState,</span>
<a href="#l22.883"></a><span id="l22.883" class="difflineplus">+    OtrlMessageAppOps.ptr,</span>
<a href="#l22.884"></a><span id="l22.884" class="difflineplus">+    ctypes.void_t.ptr,</span>
<a href="#l22.885"></a><span id="l22.885" class="difflineplus">+    ConnContext.ptr</span>
<a href="#l22.886"></a><span id="l22.886" class="difflineplus">+  ),</span>
<a href="#l22.887"></a><span id="l22.887" class="difflineplus">+</span>
<a href="#l22.888"></a><span id="l22.888" class="difflineplus">+  // tlv.h</span>
<a href="#l22.889"></a><span id="l22.889" class="difflineplus">+</span>
<a href="#l22.890"></a><span id="l22.890" class="difflineplus">+  tlvs: {</span>
<a href="#l22.891"></a><span id="l22.891" class="difflineplus">+    OTRL_TLV_PADDING: new ctypes.unsigned_short(0x0000),</span>
<a href="#l22.892"></a><span id="l22.892" class="difflineplus">+    OTRL_TLV_DISCONNECTED: new ctypes.unsigned_short(0x0001),</span>
<a href="#l22.893"></a><span id="l22.893" class="difflineplus">+    OTRL_TLV_SMP1: new ctypes.unsigned_short(0x0002),</span>
<a href="#l22.894"></a><span id="l22.894" class="difflineplus">+    OTRL_TLV_SMP2: new ctypes.unsigned_short(0x0003),</span>
<a href="#l22.895"></a><span id="l22.895" class="difflineplus">+    OTRL_TLV_SMP3: new ctypes.unsigned_short(0x0004),</span>
<a href="#l22.896"></a><span id="l22.896" class="difflineplus">+    OTRL_TLV_SMP4: new ctypes.unsigned_short(0x0005),</span>
<a href="#l22.897"></a><span id="l22.897" class="difflineplus">+    OTRL_TLV_SMP_ABORT: new ctypes.unsigned_short(0x0006),</span>
<a href="#l22.898"></a><span id="l22.898" class="difflineplus">+    OTRL_TLV_SMP1Q: new ctypes.unsigned_short(0x0007),</span>
<a href="#l22.899"></a><span id="l22.899" class="difflineplus">+    OTRL_TLV_SYMKEY: new ctypes.unsigned_short(0x0008),</span>
<a href="#l22.900"></a><span id="l22.900" class="difflineplus">+  },</span>
<a href="#l22.901"></a><span id="l22.901" class="difflineplus">+</span>
<a href="#l22.902"></a><span id="l22.902" class="difflineplus">+  OtrlTLV,</span>
<a href="#l22.903"></a><span id="l22.903" class="difflineplus">+</span>
<a href="#l22.904"></a><span id="l22.904" class="difflineplus">+  // Return the first TLV with the given type in the chain, or NULL if one</span>
<a href="#l22.905"></a><span id="l22.905" class="difflineplus">+  // isn't found.</span>
<a href="#l22.906"></a><span id="l22.906" class="difflineplus">+  otrl_tlv_find: libotr.declare(</span>
<a href="#l22.907"></a><span id="l22.907" class="difflineplus">+    &quot;otrl_tlv_find&quot;, abi, OtrlTLV.ptr,</span>
<a href="#l22.908"></a><span id="l22.908" class="difflineplus">+    OtrlTLV.ptr, ctypes.unsigned_short</span>
<a href="#l22.909"></a><span id="l22.909" class="difflineplus">+  ),</span>
<a href="#l22.910"></a><span id="l22.910" class="difflineplus">+</span>
<a href="#l22.911"></a><span id="l22.911" class="difflineplus">+  // Deallocate a chain of TLVs.</span>
<a href="#l22.912"></a><span id="l22.912" class="difflineplus">+  otrl_tlv_free: libotr.declare(</span>
<a href="#l22.913"></a><span id="l22.913" class="difflineplus">+    &quot;otrl_tlv_free&quot;, abi, ctypes.void_t,</span>
<a href="#l22.914"></a><span id="l22.914" class="difflineplus">+    OtrlTLV.ptr</span>
<a href="#l22.915"></a><span id="l22.915" class="difflineplus">+  ),</span>
<a href="#l22.916"></a><span id="l22.916" class="difflineplus">+</span>
<a href="#l22.917"></a><span id="l22.917" class="difflineplus">+};</span>
<a href="#l22.918"></a><span id="l22.918" class="difflineplus">+</span>
<a href="#l22.919"></a><span id="l22.919" class="difflineplus">+</span>
<a href="#l22.920"></a><span id="l22.920" class="difflineplus">+// exports</span>
<a href="#l22.921"></a><span id="l22.921" class="difflineplus">+</span>
<a href="#l22.922"></a><span id="l22.922" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;OTRLib&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/chat/modules/OTRUI.jsm</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,711 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;OTRUI&quot;];</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+const {</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  l10nHelper,</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+const {OTR}  = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+const privDialog = &quot;chrome://chat/content/otr-generate-key.xul&quot;;</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+const authDialog = &quot;chrome://chat/content/otr-auth.xul&quot;;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+const addFingerDialog = &quot;chrome://chat/content/otr-add-fingerprint.xul&quot;;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+  l10nHelper(&quot;chrome://chat/content/otrUI.properties&quot;)</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+);</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+const authVerify = &quot;otr-auth-unverified&quot;;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+var authLabelMap = new Map([</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+  [&quot;otr:auth-error&quot;, _(&quot;auth.error&quot;)],</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+  [&quot;otr:auth-success&quot;, _(&quot;auth.success&quot;)],</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+  [&quot;otr:auth-successThem&quot;, _(&quot;auth.successThem&quot;)],</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+  [&quot;otr:auth-fail&quot;, _(&quot;auth.fail&quot;)],</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+  [&quot;otr:auth-waiting&quot;, _(&quot;auth.waiting&quot;)],</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+]);</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+var authTitleMap = new Map([</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+  [&quot;otr:auth-error&quot;, &quot;error&quot;],</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+  [&quot;otr:auth-success&quot;, &quot;success&quot;],</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+  [&quot;otr:auth-successThem&quot;, &quot;successThem&quot;],</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+  [&quot;otr:auth-fail&quot;, &quot;fail&quot;],</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+  [&quot;otr:auth-waiting&quot;, &quot;waiting&quot;],</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+]);</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+var trustMap = new Map([</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+  [OTR.trustState.TRUST_NOT_PRIVATE, {</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+    startLabel: _(&quot;start.label&quot;),</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+    authLabel: _(&quot;auth.label&quot;),</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+    disableStart: false,</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+    disableEnd: true,</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+    disableAuth: true,</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+    class: &quot;not_private&quot;,</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+  }],</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+  [OTR.trustState.TRUST_UNVERIFIED, {</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    startLabel: _(&quot;refresh.label&quot;),</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+    authLabel: _(&quot;auth.label&quot;),</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+    disableStart: false,</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+    disableEnd: false,</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+    disableAuth: false,</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+    class: &quot;unverified&quot;,</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+  }],</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+  [OTR.trustState.TRUST_PRIVATE, {</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+    startLabel: _(&quot;refresh.label&quot;),</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+    authLabel: _(&quot;reauth.label&quot;),</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+    disableStart: false,</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+    disableEnd: false,</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+    disableAuth: false,</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+    class: &quot;private&quot;,</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+  }],</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+  [OTR.trustState.TRUST_FINISHED, {</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+    startLabel: _(&quot;start.label&quot;),</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+    authLabel: _(&quot;auth.label&quot;),</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+    disableStart: false,</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+    disableEnd: false,</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+    disableAuth: true,</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+    class: &quot;finished&quot;,</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+  }],</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+]);</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+var windowRefs = new Map();</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+var OTRUI = {</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+  globalDoc: null,</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+  visibleConv: null,</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+  debug: true,</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+  logMsg(msg) {</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+    if (!OTRUI.debug)</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+      return;</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+    Services.console.logStringMessage(msg);</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+  },</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+  prefs: null,</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+  setPrefs() {</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+    let branch = &quot;chat.otr.&quot;;</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+    let prefs = {</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+      requireEncryption: false,</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+      verifyNudge: true,</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+    };</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+    let defaults = Services.prefs.getDefaultBranch(branch);</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+    Object.keys(prefs).forEach(function(key) {</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+      defaults.setBoolPref(key, prefs[key]);</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineplus">+    });</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+    OTRUI.prefs = Services.prefs.getBranch(branch);</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+  },</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+  addMenuObserver() {</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+    let iter = Services.ww.getWindowEnumerator();</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+    while (iter.hasMoreElements())</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+      OTRUI.addMenus(iter.getNext());</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineplus">+    Services.obs.addObserver(OTRUI, &quot;domwindowopened&quot;);</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+  },</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+  removeMenuObserver() {</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+    let iter = Services.ww.getWindowEnumerator();</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+    while (iter.hasMoreElements())</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+      OTRUI.removeMenus(iter.getNext());</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+    Services.obs.removeObserver(OTRUI, &quot;domwindowopened&quot;);</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+  },</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineplus">+  addMenus(win) {</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+    let doc = win.document;</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+    // Account for unready windows</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+    if (doc.readyState !== &quot;complete&quot;) {</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineplus">+      let listen = function() {</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineplus">+        win.removeEventListener(&quot;load&quot;, listen);</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineplus">+        OTRUI.addMenus(win);</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+      };</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineplus">+      win.addEventListener(&quot;load&quot;, listen);</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineplus">+    }</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineplus">+  },</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+  removeMenus(win) {</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+    let doc = win.document;</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineplus">+    OTRUI.removeBuddyContextMenu(doc);</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+  },</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+  addBuddyContextMenu(buddyContextMenu, doc) {</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+    if (!buddyContextMenu || !OTR.libLoaded) {</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+      return;  // Not the buddy list context menu</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+    }</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+    OTRUI.removeBuddyContextMenu(doc);</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+    let sep = doc.createElement(&quot;menuseparator&quot;);</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineplus">+    sep.setAttribute(&quot;id&quot;, &quot;otrsep&quot;);</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineplus">+    let menuitem = doc.createElement(&quot;menuitem&quot;);</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineplus">+    menuitem.setAttribute(&quot;label&quot;, _(&quot;buddycontextmenu.label&quot;));</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineplus">+    menuitem.setAttribute(&quot;id&quot;, &quot;otrcont&quot;);</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineplus">+    menuitem.addEventListener(&quot;command&quot;, () =&gt; {</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineplus">+      let target = buddyContextMenu.triggerNode;</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineplus">+      if (target.localName == &quot;richlistitem&quot;) {</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineplus">+        let contact = target.contact;</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+        let args = OTRUI.contactWrapper(contact);</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+        args.wrappedJSObject = args;</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+        let features = &quot;chrome,modal,centerscreen,resizable=no,minimizable=no&quot;;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+        Services.ww.openWindow(null, addFingerDialog, &quot;&quot;, features, args);</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+      }</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+    });</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineplus">+</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineplus">+    buddyContextMenu.addEventListener(&quot;popupshowing&quot;, (e) =&gt; {</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineplus">+      let target = e.target.triggerNode;</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+      if (target.localName == &quot;richlistitem&quot;) {</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+        menuitem.hidden = false;</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+        sep.hidden = false;</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineplus">+      } else { /* probably imconv */</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+        menuitem.hidden = true;</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineplus">+        sep.hidden = true;</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineplus">+      }</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineplus">+    });</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineplus">+</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+    buddyContextMenu.appendChild(sep);</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineplus">+    buddyContextMenu.appendChild(menuitem);</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineplus">+  },</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineplus">+</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineplus">+  removeBuddyContextMenu(doc) {</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineplus">+    let s = doc.getElementById(&quot;otrsep&quot;);</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineplus">+    if (s) {</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineplus">+      s.remove();</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineplus">+    }</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineplus">+    let p = doc.getElementById(&quot;otrcont&quot;);</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineplus">+    if (p) {</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineplus">+      p.remove();</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineplus">+    }</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineplus">+  },</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineplus">+</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineplus">+  init() {</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineplus">+    // console.log(&quot;====&gt; OTRUI init\n&quot;);</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineplus">+    OTRUI.setPrefs();</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineplus">+    OTR.init({</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineplus">+      requireEncryption: OTRUI.prefs.getBoolPref(&quot;requireEncryption&quot;),</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineplus">+      verifyNudge: OTRUI.prefs.getBoolPref(&quot;verifyNudge&quot;),</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineplus">+    });</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineplus">+    if (!OTR.libLoaded) {</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineplus">+      return;</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineplus">+    }</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineplus">+    OTR.addObserver(OTRUI);</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineplus">+    OTR.loadFiles().then(function() {</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineplus">+      Services.obs.addObserver(OTR, &quot;new-ui-conversation&quot;);</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineplus">+      // Disabled until #76 is resolved.</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineplus">+      // Services.obs.addObserver(OTRUI, &quot;contact-added&quot;, false);</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineplus">+      Services.obs.addObserver(OTRUI, &quot;account-added&quot;);</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineplus">+      // Services.obs.addObserver(OTRUI, &quot;contact-signed-off&quot;, false);</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineplus">+      Services.obs.addObserver(OTRUI, &quot;conversation-loaded&quot;);</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineplus">+      Services.obs.addObserver(OTRUI, &quot;conversation-closed&quot;);</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineplus">+      Services.obs.addObserver(OTRUI, &quot;prpl-quit&quot;);</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineplus">+</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineplus">+      OTRUI.prefs.addObserver(&quot;&quot;, OTRUI);</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineplus">+      let conversations = Services.conversations.getConversations();</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+      while (conversations.hasMoreElements()) {</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineplus">+      let aConv = conversations.getNext();</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineplus">+      OTRUI.initConv(aConv);</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineplus">+      }</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineplus">+      OTRUI.addMenuObserver();</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineplus">+    }).catch(function(err) {</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineplus">+      // console.log(&quot;===&gt; &quot; + err + &quot;\n&quot;);</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineplus">+      throw err;</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineplus">+    });</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+  },</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineplus">+</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineplus">+  disconnect(aConv) {</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineplus">+    if (aConv)</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineplus">+      return OTR.disconnect(aConv, true);</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+    let allGood = true;</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineplus">+    let conversations = Services.conversations.getConversations();</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineplus">+    while (conversations.hasMoreElements()) {</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineplus">+      let conv = conversations.getNext();</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+      if (conv.isChat)</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineplus">+        continue;</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineplus">+      if (!OTR.disconnect(conv, true)) {</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineplus">+        allGood = false;</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineplus">+      }</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineplus">+    }</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineplus">+    return allGood;</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineplus">+  },</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineplus">+</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineplus">+  changePref(aMsg) {</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineplus">+    switch (aMsg) {</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+    case &quot;requireEncryption&quot;:</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineplus">+      OTR.setPolicy(OTRUI.prefs.getBoolPref(&quot;requireEncryption&quot;));</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineplus">+      break;</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineplus">+    case &quot;verifyNudge&quot;:</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineplus">+      OTR.verifyNudge = OTRUI.prefs.getBoolPref(&quot;verifyNudge&quot;);</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineplus">+      break;</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+    default:</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+      OTRUI.logMsg(aMsg);</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineplus">+    }</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineplus">+  },</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineplus">+</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineplus">+  openAuth(window, name, mode, uiConv, contactInfo) {</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineplus">+    let otrAuth = this.globalDoc.querySelector(&quot;.otr-auth&quot;);</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineplus">+    otrAuth.disabled = true;</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineplus">+    let win = window.openDialog(</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineplus">+      authDialog,</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineplus">+      &quot;auth=&quot; + name,</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineplus">+      &quot;centerscreen,resizable=no,minimizable=no&quot;,</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineplus">+      mode,</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineplus">+      uiConv,</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineplus">+      contactInfo</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineplus">+    );</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineplus">+    windowRefs.set(name, win);</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineplus">+    window.addEventListener(&quot;beforeunload&quot;, function() {</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+      otrAuth.disabled = false;</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+      windowRefs.delete(name);</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineplus">+    });</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineplus">+  },</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineplus">+</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineplus">+  closeAuth(context) {</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineplus">+    let win = windowRefs.get(context.username);</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineplus">+    if (win)</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineplus">+      win.close();</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineplus">+  },</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineplus">+</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineplus">+  noOtrPossible(otrContainer, context) {</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineplus">+    otrContainer.hidden = true;</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineplus">+</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineplus">+    if (context) {</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineplus">+      OTRUI.hideUserNotifications(context);</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineplus">+    } else {</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineplus">+      OTRUI.hideAllNotifications();</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineplus">+    }</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineplus">+  },</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineplus">+</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineplus">+  sendSystemAlert(uiConv, conv, bundleId) {</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineplus">+    uiConv.systemMessage(_(bundleId, conv.normalizedName));</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineplus">+  },</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineplus">+</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineplus">+  setNotificationBox(notificationbox) {</span>
<a href="#l23.288"></a><span id="l23.288" class="difflineplus">+    this.globalBox = notificationbox;</span>
<a href="#l23.289"></a><span id="l23.289" class="difflineplus">+  },</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineplus">+</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineplus">+/*</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineplus">+ *  possible states:</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineplus">+ *    tab isn't a 1:1, isChat == true</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineplus">+ *      then OTR isn't possible, hide the button</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineplus">+ *    tab is a 1:1, isChat == false</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineplus">+ *      no conversation active, uiConv cannot be found</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineplus">+ *        then OTR isn't possible YET, hide the button</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineplus">+ *      conversation active, uiConv found</span>
<a href="#l23.299"></a><span id="l23.299" class="difflineplus">+ *        disconnected?</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineplus">+ *          could the other side come back? should we keep the button?</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineplus">+ *        set the state based on the OTR library state</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineplus">+ */</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineplus">+</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineplus">+  addButton(aObject) {</span>
<a href="#l23.305"></a><span id="l23.305" class="difflineplus">+    this.globalDoc = aObject.ownerDocument;</span>
<a href="#l23.306"></a><span id="l23.306" class="difflineplus">+    let _conv = aObject._conv;</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineplus">+    OTRUI.setMsgState(_conv, null, this.globalDoc, true);</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineplus">+  },</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineplus">+</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineplus">+  hideOTRButton() {</span>
<a href="#l23.311"></a><span id="l23.311" class="difflineplus">+    if (!OTR.libLoaded)</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineplus">+      return;</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineplus">+    if (!this.globalDoc)</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineplus">+      return;</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineplus">+    OTRUI.visibleConv = null;</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineplus">+    let otrContainer = this.globalDoc.querySelector(&quot;.otr-container&quot;);</span>
<a href="#l23.317"></a><span id="l23.317" class="difflineplus">+    OTRUI.noOtrPossible(otrContainer);</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineplus">+  },</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineplus">+</span>
<a href="#l23.320"></a><span id="l23.320" class="difflineplus">+  updateOTRButton(_conv) {</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineplus">+    if (!OTR.libLoaded)</span>
<a href="#l23.322"></a><span id="l23.322" class="difflineplus">+      return;</span>
<a href="#l23.323"></a><span id="l23.323" class="difflineplus">+    if (!this.globalDoc)</span>
<a href="#l23.324"></a><span id="l23.324" class="difflineplus">+      return;</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineplus">+    OTRUI.visibleConv = _conv;</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineplus">+    let convBinding =</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineplus">+      this.globalDoc.getElementById(&quot;conversationsDeck&quot;).selectedPanel;</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineplus">+    if (convBinding &amp;&amp; convBinding._conv &amp;&amp; convBinding._conv.target) {</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineplus">+      OTRUI.setMsgState(_conv, null, this.globalDoc, false);</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineplus">+    } else {</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineplus">+      this.hideOTRButton();</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineplus">+    }</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineplus">+  },</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineplus">+</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineplus">+  // set msg state on toolbar button</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineplus">+  setMsgState(_conv, context, doc, addSystemMessage) {</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineplus">+    if (!this.visibleConv) {</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineplus">+      return;</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineplus">+    }</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineplus">+    if (_conv != null &amp;&amp; !(_conv === this.visibleConv)) {</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineplus">+      return;</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineplus">+    }</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineplus">+</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineplus">+    let otrContainer = doc.querySelector(&quot;.otr-container&quot;);</span>
<a href="#l23.345"></a><span id="l23.345" class="difflineplus">+    let otrButton = doc.querySelector(&quot;.otr-button&quot;);</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineplus">+    if (_conv != null &amp;&amp; _conv.isChat) {</span>
<a href="#l23.347"></a><span id="l23.347" class="difflineplus">+      OTRUI.noOtrPossible(otrContainer, context);</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineplus">+      return;</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineplus">+    }</span>
<a href="#l23.350"></a><span id="l23.350" class="difflineplus">+</span>
<a href="#l23.351"></a><span id="l23.351" class="difflineplus">+    if (!context &amp;&amp; _conv != null) {</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineplus">+      context = OTR.getContext(_conv);</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineplus">+      if (!context) {</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineplus">+        OTRUI.noOtrPossible(otrContainer, null);</span>
<a href="#l23.355"></a><span id="l23.355" class="difflineplus">+      }</span>
<a href="#l23.356"></a><span id="l23.356" class="difflineplus">+    }</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineplus">+</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineplus">+    try {</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineplus">+      let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineplus">+      if (uiConv != null &amp;&amp; !(uiConv === this.visibleConv)) {</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineplus">+        return;</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineplus">+      }</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineplus">+</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineplus">+      if (uiConv.isChat) {</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineplus">+        OTRUI.noOtrPossible(otrContainer, context);</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineplus">+        return;</span>
<a href="#l23.367"></a><span id="l23.367" class="difflineplus">+      }</span>
<a href="#l23.368"></a><span id="l23.368" class="difflineplus">+      if (addSystemMessage) {</span>
<a href="#l23.369"></a><span id="l23.369" class="difflineplus">+        let trust = OTRUI.getTrustSettings(context);</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineplus">+        uiConv.systemMessage(_(&quot;state.&quot; + trust.class, context.username));</span>
<a href="#l23.371"></a><span id="l23.371" class="difflineplus">+      }</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineplus">+    } catch (e) {</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineplus">+      OTRUI.noOtrPossible(otrContainer, context);</span>
<a href="#l23.374"></a><span id="l23.374" class="difflineplus">+      return;</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineplus">+    }</span>
<a href="#l23.376"></a><span id="l23.376" class="difflineplus">+</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineplus">+    otrContainer.hidden = false;</span>
<a href="#l23.378"></a><span id="l23.378" class="difflineplus">+    let otrStart = doc.querySelector(&quot;.otr-start&quot;);</span>
<a href="#l23.379"></a><span id="l23.379" class="difflineplus">+    let otrEnd = doc.querySelector(&quot;.otr-end&quot;);</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineplus">+    let otrAuth = doc.querySelector(&quot;.otr-auth&quot;);</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineplus">+    let trust = OTRUI.getTrustSettings(context);</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineplus">+    otrButton.setAttribute(&quot;tooltiptext&quot;, _(&quot;state.&quot; + trust.class, context.username));</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineplus">+    otrButton.setAttribute(&quot;label&quot;, _(&quot;state.&quot; + trust.class + &quot;.label&quot;));</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineplus">+    otrButton.className = &quot;otr-button otr-&quot; + trust.class;</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineplus">+    otrStart.setAttribute(&quot;label&quot;, trust.startLabel);</span>
<a href="#l23.386"></a><span id="l23.386" class="difflineplus">+    otrStart.setAttribute(&quot;disabled&quot;, trust.disableStart);</span>
<a href="#l23.387"></a><span id="l23.387" class="difflineplus">+    otrEnd.setAttribute(&quot;disabled&quot;, trust.disableEnd);</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineplus">+    otrAuth.setAttribute(&quot;label&quot;, trust.authLabel);</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineplus">+    otrAuth.setAttribute(&quot;disabled&quot;, trust.disableAuth);</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineplus">+    OTRUI.hideAllNotifications();</span>
<a href="#l23.391"></a><span id="l23.391" class="difflineplus">+    OTRUI.showUserNotifications(context);</span>
<a href="#l23.392"></a><span id="l23.392" class="difflineplus">+  },</span>
<a href="#l23.393"></a><span id="l23.393" class="difflineplus">+</span>
<a href="#l23.394"></a><span id="l23.394" class="difflineplus">+  alertTrust(context) {</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineplus">+    let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineplus">+    let trust = OTRUI.getTrustSettings(context);</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineplus">+    uiConv.systemMessage(_(&quot;afterauth.&quot; + trust.class, context.username));</span>
<a href="#l23.398"></a><span id="l23.398" class="difflineplus">+  },</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineplus">+</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineplus">+  getTrustSettings(context) {</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineplus">+    let result = trustMap.get(OTR.trust(context));</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineplus">+    return result;</span>
<a href="#l23.403"></a><span id="l23.403" class="difflineplus">+  },</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineplus">+</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineplus">+  askAuth(aObject) {</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineplus">+    let uiConv = OTR.getUIConvFromContext(aObject.context);</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineplus">+    if (!uiConv) return;</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineplus">+</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineplus">+    let window = this.globalDoc.defaultView;</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineplus">+    let name = uiConv.target.normalizedName;</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineplus">+    OTRUI.openAuth(window, name, &quot;ask&quot;, uiConv, aObject);</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineplus">+  },</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineplus">+</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineplus">+  closeUnverified(context) {</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineplus">+    let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineplus">+    if (!uiConv) return;</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineplus">+</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineplus">+    let notification = this.globalBox.getNotificationWithValue(authVerify);</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineplus">+    if (notification)</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineplus">+      notification.close();</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineplus">+  },</span>
<a href="#l23.422"></a><span id="l23.422" class="difflineplus">+</span>
<a href="#l23.423"></a><span id="l23.423" class="difflineplus">+  hideUserNotifications(context) {</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineplus">+    let notifications = this.globalBox.allNotifications;</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineplus">+    for (let i = notifications.length - 1; i &gt;= 0; i--) {</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineplus">+      if (context.username == notifications[i].getAttribute(&quot;user&quot;)) {</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineplus">+        notifications[i].setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l23.428"></a><span id="l23.428" class="difflineplus">+      }</span>
<a href="#l23.429"></a><span id="l23.429" class="difflineplus">+    }</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineplus">+  },</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineplus">+</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineplus">+  hideAllNotifications() {</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineplus">+    let notifications = this.globalBox.allNotifications;</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineplus">+    for (let i = notifications.length - 1; i &gt;= 0; i--) {</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineplus">+      notifications[i].setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineplus">+    }</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineplus">+  },</span>
<a href="#l23.438"></a><span id="l23.438" class="difflineplus">+</span>
<a href="#l23.439"></a><span id="l23.439" class="difflineplus">+  showUserNotifications(context) {</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineplus">+    let notifications = this.globalBox.allNotifications;</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineplus">+    for (let i = notifications.length - 1; i &gt;= 0; i--) {</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineplus">+      if (context.username == notifications[i].getAttribute(&quot;user&quot;))</span>
<a href="#l23.443"></a><span id="l23.443" class="difflineplus">+        notifications[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l23.444"></a><span id="l23.444" class="difflineplus">+    }</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineplus">+  },</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineplus">+</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineplus">+  notifyUnverified(context, seen) {</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineplus">+    let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineplus">+    if (!uiConv) return;</span>
<a href="#l23.450"></a><span id="l23.450" class="difflineplus">+</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineplus">+    if (this.globalBox.getNotificationWithValue(authVerify))</span>
<a href="#l23.452"></a><span id="l23.452" class="difflineplus">+      return;</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineplus">+</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineplus">+    let window = this.globalDoc.defaultView;</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineplus">+</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineplus">+    let msg = _(&quot;finger.&quot; + seen, context.username);</span>
<a href="#l23.457"></a><span id="l23.457" class="difflineplus">+    let buttons = [{</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineplus">+      label: _(&quot;finger.verify&quot;),</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineplus">+      accessKey: _(&quot;verify.accessKey&quot;),</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineplus">+      callback() {</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineplus">+        let name = uiConv.target.normalizedName;</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineplus">+        OTRUI.openAuth(window, name, &quot;start&quot;, uiConv);</span>
<a href="#l23.463"></a><span id="l23.463" class="difflineplus">+        // prevent closing of notification bar when the button is hit</span>
<a href="#l23.464"></a><span id="l23.464" class="difflineplus">+        return true;</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineplus">+      },</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineplus">+    }];</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineplus">+</span>
<a href="#l23.468"></a><span id="l23.468" class="difflineplus">+    let priority = this.globalBox.PRIORITY_WARNING_MEDIUM;</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineplus">+    this.globalBox.appendNotification(msg, authVerify, null, priority, buttons, null);</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineplus">+</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineplus">+    this.updateNotificationUI(context, &quot;verify&quot;, authVerify);</span>
<a href="#l23.472"></a><span id="l23.472" class="difflineplus">+  },</span>
<a href="#l23.473"></a><span id="l23.473" class="difflineplus">+</span>
<a href="#l23.474"></a><span id="l23.474" class="difflineplus">+  updateNotificationUI(context, type, value) {</span>
<a href="#l23.475"></a><span id="l23.475" class="difflineplus">+    let notification = this.globalBox.getNotificationWithValue(value);</span>
<a href="#l23.476"></a><span id="l23.476" class="difflineplus">+    notification.setAttribute(&quot;user&quot;, context.username);</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineplus">+    notification.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l23.478"></a><span id="l23.478" class="difflineplus">+    notification.messageDetails.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineplus">+    notification.messageDetails.removeAttribute(&quot;oncommand&quot;);</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineplus">+    notification.messageDetails.removeAttribute(&quot;align&quot;);</span>
<a href="#l23.481"></a><span id="l23.481" class="difflineplus">+</span>
<a href="#l23.482"></a><span id="l23.482" class="difflineplus">+    let title = this.globalDoc.createElement(&quot;title&quot;);</span>
<a href="#l23.483"></a><span id="l23.483" class="difflineplus">+    title.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l23.484"></a><span id="l23.484" class="difflineplus">+    title.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l23.485"></a><span id="l23.485" class="difflineplus">+    title.textContent = _(type + &quot;.title&quot;);</span>
<a href="#l23.486"></a><span id="l23.486" class="difflineplus">+</span>
<a href="#l23.487"></a><span id="l23.487" class="difflineplus">+    let close = notification.querySelector(&quot;toolbarbutton&quot;);</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineplus">+    close.setAttribute(&quot;oncommand&quot;, &quot;this.parentNode.parentNode.dismiss();&quot;);</span>
<a href="#l23.489"></a><span id="l23.489" class="difflineplus">+</span>
<a href="#l23.490"></a><span id="l23.490" class="difflineplus">+    let top = this.globalDoc.createElement(&quot;hbox&quot;);</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineplus">+    top.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineplus">+    top.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l23.493"></a><span id="l23.493" class="difflineplus">+    top.classList.add(&quot;otr-notification-header&quot;);</span>
<a href="#l23.494"></a><span id="l23.494" class="difflineplus">+    top.appendChild(notification.messageImage);</span>
<a href="#l23.495"></a><span id="l23.495" class="difflineplus">+    top.appendChild(title);</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineplus">+    top.appendChild(close);</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineplus">+    notification.insertBefore(top, notification.messageDetails);</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineplus">+</span>
<a href="#l23.499"></a><span id="l23.499" class="difflineplus">+    let bottom = this.globalDoc.createElement(&quot;hbox&quot;);</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineplus">+    bottom.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineplus">+    bottom.setAttribute(&quot;oncommand&quot;, &quot;this.parentNode._doButtonCommand(event);&quot;);</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineplus">+    bottom.classList.add(&quot;otr-notification-footer&quot;);</span>
<a href="#l23.503"></a><span id="l23.503" class="difflineplus">+</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineplus">+    notification.querySelectorAll(&quot;button&quot;).forEach((e) =&gt; {</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineplus">+      bottom.appendChild(e);</span>
<a href="#l23.506"></a><span id="l23.506" class="difflineplus">+    });</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineplus">+</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineplus">+    notification.appendChild(bottom);</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineplus">+  },</span>
<a href="#l23.510"></a><span id="l23.510" class="difflineplus">+</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineplus">+  closeVerification(context) {</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineplus">+    let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineplus">+    if (!uiConv) return;</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineplus">+</span>
<a href="#l23.515"></a><span id="l23.515" class="difflineplus">+    authLabelMap.forEach(function(_, key) {</span>
<a href="#l23.516"></a><span id="l23.516" class="difflineplus">+      let prevNotification = OTRUI.globalBox.getNotificationWithValue(key);</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineplus">+      if (prevNotification)</span>
<a href="#l23.518"></a><span id="l23.518" class="difflineplus">+        prevNotification.close();</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineplus">+    });</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineplus">+  },</span>
<a href="#l23.521"></a><span id="l23.521" class="difflineplus">+</span>
<a href="#l23.522"></a><span id="l23.522" class="difflineplus">+  notifyVerification(context, key, cancelable) {</span>
<a href="#l23.523"></a><span id="l23.523" class="difflineplus">+    let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l23.524"></a><span id="l23.524" class="difflineplus">+    if (!uiConv) return;</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineplus">+</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineplus">+    // TODO: maybe update the .label property on the notification instead</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineplus">+    // of closing it ... although, buttons need to be updated too.</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineplus">+    OTRUI.closeVerification(context);</span>
<a href="#l23.529"></a><span id="l23.529" class="difflineplus">+</span>
<a href="#l23.530"></a><span id="l23.530" class="difflineplus">+    let msg = authLabelMap.get(key);</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineplus">+    let type = authTitleMap.get(key);</span>
<a href="#l23.532"></a><span id="l23.532" class="difflineplus">+    let buttons = [];</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineplus">+    if (cancelable) {</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineplus">+      buttons = [{</span>
<a href="#l23.535"></a><span id="l23.535" class="difflineplus">+        label: _(&quot;auth.cancel&quot;),</span>
<a href="#l23.536"></a><span id="l23.536" class="difflineplus">+        accessKey: _(&quot;auth.cancelAccessKey&quot;),</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineplus">+        callback() {</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineplus">+          let context = OTR.getContext(uiConv.target);</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineplus">+          OTR.abortSMP(context);</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineplus">+        },</span>
<a href="#l23.541"></a><span id="l23.541" class="difflineplus">+      }];</span>
<a href="#l23.542"></a><span id="l23.542" class="difflineplus">+    }</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineplus">+</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineplus">+    // higher priority to overlay the current notifyUnverified</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineplus">+    let priority = this.globalBox.PRIORITY_WARNING_HIGH;</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineplus">+    OTRUI.closeUnverified(context);</span>
<a href="#l23.547"></a><span id="l23.547" class="difflineplus">+    this.globalBox.appendNotification(msg, key, null, priority, buttons, null);</span>
<a href="#l23.548"></a><span id="l23.548" class="difflineplus">+</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineplus">+    this.updateNotificationUI(context, type, key);</span>
<a href="#l23.550"></a><span id="l23.550" class="difflineplus">+  },</span>
<a href="#l23.551"></a><span id="l23.551" class="difflineplus">+</span>
<a href="#l23.552"></a><span id="l23.552" class="difflineplus">+  updateAuth(aObj) {</span>
<a href="#l23.553"></a><span id="l23.553" class="difflineplus">+    // let uiConv = OTR.getUIConvFromContext(aObj.context);</span>
<a href="#l23.554"></a><span id="l23.554" class="difflineplus">+    if (!aObj.progress) {</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineplus">+      OTRUI.closeAuth(aObj.context);</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineplus">+      OTRUI.notifyVerification(aObj.context, &quot;otr:auth-error&quot;, false);</span>
<a href="#l23.557"></a><span id="l23.557" class="difflineplus">+    } else if (aObj.progress === 100) {</span>
<a href="#l23.558"></a><span id="l23.558" class="difflineplus">+      let key;</span>
<a href="#l23.559"></a><span id="l23.559" class="difflineplus">+      if (aObj.success) {</span>
<a href="#l23.560"></a><span id="l23.560" class="difflineplus">+        if (aObj.context.trust) {</span>
<a href="#l23.561"></a><span id="l23.561" class="difflineplus">+          key = &quot;otr:auth-success&quot;;</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineplus">+          OTR.notifyTrust(aObj.context);</span>
<a href="#l23.563"></a><span id="l23.563" class="difflineplus">+        } else {</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineplus">+          key = &quot;otr:auth-successThem&quot;;</span>
<a href="#l23.565"></a><span id="l23.565" class="difflineplus">+        }</span>
<a href="#l23.566"></a><span id="l23.566" class="difflineplus">+      } else {</span>
<a href="#l23.567"></a><span id="l23.567" class="difflineplus">+        key = &quot;otr:auth-fail&quot;;</span>
<a href="#l23.568"></a><span id="l23.568" class="difflineplus">+        if (!aObj.context.trust)</span>
<a href="#l23.569"></a><span id="l23.569" class="difflineplus">+          OTR.notifyTrust(aObj.context);</span>
<a href="#l23.570"></a><span id="l23.570" class="difflineplus">+      }</span>
<a href="#l23.571"></a><span id="l23.571" class="difflineplus">+      OTRUI.notifyVerification(aObj.context, key, false);</span>
<a href="#l23.572"></a><span id="l23.572" class="difflineplus">+    } else {</span>
<a href="#l23.573"></a><span id="l23.573" class="difflineplus">+      // TODO: show the aObj.progress to the user with a</span>
<a href="#l23.574"></a><span id="l23.574" class="difflineplus">+      //   &lt;progressmeter mode=&quot;determined&quot; value=&quot;10&quot; /&gt;</span>
<a href="#l23.575"></a><span id="l23.575" class="difflineplus">+      OTRUI.notifyVerification(aObj.context, &quot;otr:auth-waiting&quot;, true);</span>
<a href="#l23.576"></a><span id="l23.576" class="difflineplus">+    }</span>
<a href="#l23.577"></a><span id="l23.577" class="difflineplus">+  },</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineplus">+</span>
<a href="#l23.579"></a><span id="l23.579" class="difflineplus">+  generate(args) {</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineplus">+    let features = &quot;chrome,modal,centerscreen,resizable=no,minimizable=no&quot;;</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineplus">+    args.wrappedJSObject = args;</span>
<a href="#l23.582"></a><span id="l23.582" class="difflineplus">+    Services.ww.openWindow(null, privDialog, &quot;&quot;, features, args);</span>
<a href="#l23.583"></a><span id="l23.583" class="difflineplus">+  },</span>
<a href="#l23.584"></a><span id="l23.584" class="difflineplus">+</span>
<a href="#l23.585"></a><span id="l23.585" class="difflineplus">+  onAccountCreated(acc) {</span>
<a href="#l23.586"></a><span id="l23.586" class="difflineplus">+    let account = acc.normalizedName;</span>
<a href="#l23.587"></a><span id="l23.587" class="difflineplus">+    let protocol = acc.protocol.normalizedName;</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineplus">+    Promise.resolve();</span>
<a href="#l23.589"></a><span id="l23.589" class="difflineplus">+    if (OTR.privateKeyFingerprint(account, protocol) === null)</span>
<a href="#l23.590"></a><span id="l23.590" class="difflineplus">+      OTR.generatePrivateKey(account, protocol);</span>
<a href="#l23.591"></a><span id="l23.591" class="difflineplus">+  },</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineplus">+</span>
<a href="#l23.593"></a><span id="l23.593" class="difflineplus">+  contactWrapper(contact) {</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineplus">+    let wrapper = {</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineplus">+      account: contact.preferredBuddy.preferredAccountBuddy.account.normalizedName,</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineplus">+      protocol: contact.preferredBuddy.protocol.normalizedName,</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineplus">+      screenname: contact.preferredBuddy.preferredAccountBuddy.userName,</span>
<a href="#l23.598"></a><span id="l23.598" class="difflineplus">+    };</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineplus">+    return wrapper;</span>
<a href="#l23.600"></a><span id="l23.600" class="difflineplus">+  },</span>
<a href="#l23.601"></a><span id="l23.601" class="difflineplus">+</span>
<a href="#l23.602"></a><span id="l23.602" class="difflineplus">+  onContactAdded(contact) {</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineplus">+    let args = OTRUI.contactWrapper(contact);</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineplus">+    if (OTR.getFingerprintsForRecipient(args.account, args.protocol, args.screenname).length &gt; 0)</span>
<a href="#l23.605"></a><span id="l23.605" class="difflineplus">+      return;</span>
<a href="#l23.606"></a><span id="l23.606" class="difflineplus">+    args.wrappedJSObject = args;</span>
<a href="#l23.607"></a><span id="l23.607" class="difflineplus">+    let features = &quot;chrome,modal,centerscreen,resizable=no,minimizable=no&quot;;</span>
<a href="#l23.608"></a><span id="l23.608" class="difflineplus">+    Services.ww.openWindow(null, addFingerDialog, &quot;&quot;, features, args);</span>
<a href="#l23.609"></a><span id="l23.609" class="difflineplus">+  },</span>
<a href="#l23.610"></a><span id="l23.610" class="difflineplus">+</span>
<a href="#l23.611"></a><span id="l23.611" class="difflineplus">+  observe(aObject, aTopic, aMsg) {</span>
<a href="#l23.612"></a><span id="l23.612" class="difflineplus">+    let doc;</span>
<a href="#l23.613"></a><span id="l23.613" class="difflineplus">+    // console.log(&quot;====&gt; observing topic: &quot; + aTopic + &quot; with msg: &quot; + aMsg);</span>
<a href="#l23.614"></a><span id="l23.614" class="difflineplus">+    // console.log(aObject);</span>
<a href="#l23.615"></a><span id="l23.615" class="difflineplus">+</span>
<a href="#l23.616"></a><span id="l23.616" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l23.617"></a><span id="l23.617" class="difflineplus">+    case &quot;nsPref:changed&quot;:</span>
<a href="#l23.618"></a><span id="l23.618" class="difflineplus">+      OTRUI.changePref(aMsg);</span>
<a href="#l23.619"></a><span id="l23.619" class="difflineplus">+      break;</span>
<a href="#l23.620"></a><span id="l23.620" class="difflineplus">+    case &quot;conversation-loaded&quot;:</span>
<a href="#l23.621"></a><span id="l23.621" class="difflineplus">+      doc = aObject.ownerDocument;</span>
<a href="#l23.622"></a><span id="l23.622" class="difflineplus">+      let windowtype = doc.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l23.623"></a><span id="l23.623" class="difflineplus">+      if (windowtype !== &quot;mail:3pane&quot;) {</span>
<a href="#l23.624"></a><span id="l23.624" class="difflineplus">+        return;</span>
<a href="#l23.625"></a><span id="l23.625" class="difflineplus">+      }</span>
<a href="#l23.626"></a><span id="l23.626" class="difflineplus">+      OTRUI.addButton(aObject);</span>
<a href="#l23.627"></a><span id="l23.627" class="difflineplus">+      break;</span>
<a href="#l23.628"></a><span id="l23.628" class="difflineplus">+    case &quot;conversation-closed&quot;:</span>
<a href="#l23.629"></a><span id="l23.629" class="difflineplus">+      if (aObject.isChat)</span>
<a href="#l23.630"></a><span id="l23.630" class="difflineplus">+        return;</span>
<a href="#l23.631"></a><span id="l23.631" class="difflineplus">+      this.globalBox.removeAllNotifications();</span>
<a href="#l23.632"></a><span id="l23.632" class="difflineplus">+      OTRUI.closeAuth(OTR.getContext(aObject));</span>
<a href="#l23.633"></a><span id="l23.633" class="difflineplus">+      OTRUI.disconnect(aObject);</span>
<a href="#l23.634"></a><span id="l23.634" class="difflineplus">+      break;</span>
<a href="#l23.635"></a><span id="l23.635" class="difflineplus">+    // case &quot;contact-signed-off&quot;:</span>
<a href="#l23.636"></a><span id="l23.636" class="difflineplus">+    //  break;</span>
<a href="#l23.637"></a><span id="l23.637" class="difflineplus">+    case &quot;prpl-quit&quot;:</span>
<a href="#l23.638"></a><span id="l23.638" class="difflineplus">+      OTRUI.disconnect(null);</span>
<a href="#l23.639"></a><span id="l23.639" class="difflineplus">+      break;</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineplus">+    case &quot;domwindowopened&quot;:</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineplus">+      OTRUI.addMenus(aObject);</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineplus">+      break;</span>
<a href="#l23.643"></a><span id="l23.643" class="difflineplus">+    case &quot;otr:generate&quot;:</span>
<a href="#l23.644"></a><span id="l23.644" class="difflineplus">+      OTRUI.generate(aObject);</span>
<a href="#l23.645"></a><span id="l23.645" class="difflineplus">+      break;</span>
<a href="#l23.646"></a><span id="l23.646" class="difflineplus">+    case &quot;otr:disconnected&quot;:</span>
<a href="#l23.647"></a><span id="l23.647" class="difflineplus">+    case &quot;otr:msg-state&quot;:</span>
<a href="#l23.648"></a><span id="l23.648" class="difflineplus">+      if (aTopic === &quot;otr:disconnected&quot; ||</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineplus">+          OTR.trust(aObject) !== OTR.trustState.TRUST_UNVERIFIED) {</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineplus">+        OTRUI.closeAuth(aObject);</span>
<a href="#l23.651"></a><span id="l23.651" class="difflineplus">+        OTRUI.closeUnverified(aObject);</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineplus">+        OTRUI.closeVerification(aObject);</span>
<a href="#l23.653"></a><span id="l23.653" class="difflineplus">+      }</span>
<a href="#l23.654"></a><span id="l23.654" class="difflineplus">+      OTRUI.setMsgState(null, aObject, this.globalDoc, false);</span>
<a href="#l23.655"></a><span id="l23.655" class="difflineplus">+      break;</span>
<a href="#l23.656"></a><span id="l23.656" class="difflineplus">+    case &quot;otr:unverified&quot;:</span>
<a href="#l23.657"></a><span id="l23.657" class="difflineplus">+      OTRUI.notifyUnverified(aObject, aMsg);</span>
<a href="#l23.658"></a><span id="l23.658" class="difflineplus">+      break;</span>
<a href="#l23.659"></a><span id="l23.659" class="difflineplus">+    case &quot;otr:trust-state&quot;:</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineplus">+      OTRUI.alertTrust(aObject);</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineplus">+      break;</span>
<a href="#l23.662"></a><span id="l23.662" class="difflineplus">+    case &quot;otr:log&quot;:</span>
<a href="#l23.663"></a><span id="l23.663" class="difflineplus">+      OTRUI.logMsg(&quot;otr: &quot; + aObject);</span>
<a href="#l23.664"></a><span id="l23.664" class="difflineplus">+      break;</span>
<a href="#l23.665"></a><span id="l23.665" class="difflineplus">+    case &quot;account-added&quot;:</span>
<a href="#l23.666"></a><span id="l23.666" class="difflineplus">+      OTRUI.onAccountCreated(aObject);</span>
<a href="#l23.667"></a><span id="l23.667" class="difflineplus">+      break;</span>
<a href="#l23.668"></a><span id="l23.668" class="difflineplus">+    case &quot;contact-added&quot;:</span>
<a href="#l23.669"></a><span id="l23.669" class="difflineplus">+      OTRUI.onContactAdded(aObject);</span>
<a href="#l23.670"></a><span id="l23.670" class="difflineplus">+      break;</span>
<a href="#l23.671"></a><span id="l23.671" class="difflineplus">+    case &quot;otr:auth-ask&quot;:</span>
<a href="#l23.672"></a><span id="l23.672" class="difflineplus">+      OTRUI.askAuth(aObject);</span>
<a href="#l23.673"></a><span id="l23.673" class="difflineplus">+      break;</span>
<a href="#l23.674"></a><span id="l23.674" class="difflineplus">+    case &quot;otr:auth-update&quot;:</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineplus">+      OTRUI.updateAuth(aObject);</span>
<a href="#l23.676"></a><span id="l23.676" class="difflineplus">+      break;</span>
<a href="#l23.677"></a><span id="l23.677" class="difflineplus">+    }</span>
<a href="#l23.678"></a><span id="l23.678" class="difflineplus">+  },</span>
<a href="#l23.679"></a><span id="l23.679" class="difflineplus">+</span>
<a href="#l23.680"></a><span id="l23.680" class="difflineplus">+  initConv(binding) {</span>
<a href="#l23.681"></a><span id="l23.681" class="difflineplus">+    OTR.addConversation(binding._conv);</span>
<a href="#l23.682"></a><span id="l23.682" class="difflineplus">+    OTRUI.addButton(binding);</span>
<a href="#l23.683"></a><span id="l23.683" class="difflineplus">+  },</span>
<a href="#l23.684"></a><span id="l23.684" class="difflineplus">+</span>
<a href="#l23.685"></a><span id="l23.685" class="difflineplus">+  resetConv(binding) {</span>
<a href="#l23.686"></a><span id="l23.686" class="difflineplus">+    OTR.removeConversation(binding._conv);</span>
<a href="#l23.687"></a><span id="l23.687" class="difflineplus">+    let otrButton = this.globalDoc.querySelector(&quot;.otr-button&quot;);</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineplus">+    if (!otrButton)</span>
<a href="#l23.689"></a><span id="l23.689" class="difflineplus">+      return;</span>
<a href="#l23.690"></a><span id="l23.690" class="difflineplus">+    otrButton.remove();</span>
<a href="#l23.691"></a><span id="l23.691" class="difflineplus">+  },</span>
<a href="#l23.692"></a><span id="l23.692" class="difflineplus">+</span>
<a href="#l23.693"></a><span id="l23.693" class="difflineplus">+  destroy() {</span>
<a href="#l23.694"></a><span id="l23.694" class="difflineplus">+    if (!OTR.libLoaded)</span>
<a href="#l23.695"></a><span id="l23.695" class="difflineplus">+      return;</span>
<a href="#l23.696"></a><span id="l23.696" class="difflineplus">+    OTRUI.disconnect(null);</span>
<a href="#l23.697"></a><span id="l23.697" class="difflineplus">+    Services.obs.removeObserver(OTR, &quot;new-ui-conversation&quot;);</span>
<a href="#l23.698"></a><span id="l23.698" class="difflineplus">+    // Services.obs.removeObserver(OTRUI, &quot;contact-added&quot;);</span>
<a href="#l23.699"></a><span id="l23.699" class="difflineplus">+    // Services.obs.removeObserver(OTRUI, &quot;contact-signed-off&quot;);</span>
<a href="#l23.700"></a><span id="l23.700" class="difflineplus">+    Services.obs.removeObserver(OTRUI, &quot;account-added&quot;);</span>
<a href="#l23.701"></a><span id="l23.701" class="difflineplus">+    Services.obs.removeObserver(OTRUI, &quot;conversation-loaded&quot;);</span>
<a href="#l23.702"></a><span id="l23.702" class="difflineplus">+    Services.obs.removeObserver(OTRUI, &quot;conversation-closed&quot;);</span>
<a href="#l23.703"></a><span id="l23.703" class="difflineplus">+    Services.obs.removeObserver(OTRUI, &quot;prpl-quit&quot;);</span>
<a href="#l23.704"></a><span id="l23.704" class="difflineplus">+</span>
<a href="#l23.705"></a><span id="l23.705" class="difflineplus">+    let conversations = Services.conversations.getConversations();</span>
<a href="#l23.706"></a><span id="l23.706" class="difflineplus">+    while (conversations.hasMoreElements()) {</span>
<a href="#l23.707"></a><span id="l23.707" class="difflineplus">+      OTRUI.resetConv(conversations.getNext());</span>
<a href="#l23.708"></a><span id="l23.708" class="difflineplus">+    }</span>
<a href="#l23.709"></a><span id="l23.709" class="difflineplus">+    OTRUI.prefs.removeObserver(&quot;&quot;, OTRUI);</span>
<a href="#l23.710"></a><span id="l23.710" class="difflineplus">+    OTR.removeObserver(OTRUI);</span>
<a href="#l23.711"></a><span id="l23.711" class="difflineplus">+    OTR.close();</span>
<a href="#l23.712"></a><span id="l23.712" class="difflineplus">+    OTRUI.removeMenuObserver();</span>
<a href="#l23.713"></a><span id="l23.713" class="difflineplus">+  },</span>
<a href="#l23.714"></a><span id="l23.714" class="difflineplus">+</span>
<a href="#l23.715"></a><span id="l23.715" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/modules/moz.build</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/modules/moz.build</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -3,22 +3,27 @@</span>
<a href="#l24.4"></a><span id="l24.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.5"></a><span id="l24.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> EXTRA_JS_MODULES += [</span>
<a href="#l24.10"></a><span id="l24.10">     'ArrayBufferUtils.jsm',</span>
<a href="#l24.11"></a><span id="l24.11">     'BigInteger.jsm',</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+    'CLib.jsm',</span>
<a href="#l24.13"></a><span id="l24.13">     'DNS.jsm',</span>
<a href="#l24.14"></a><span id="l24.14">     'hiddenWindow.jsm',</span>
<a href="#l24.15"></a><span id="l24.15">     'imContentSink.jsm',</span>
<a href="#l24.16"></a><span id="l24.16">     'imServices.jsm',</span>
<a href="#l24.17"></a><span id="l24.17">     'imSmileys.jsm',</span>
<a href="#l24.18"></a><span id="l24.18">     'imStatusUtils.jsm',</span>
<a href="#l24.19"></a><span id="l24.19">     'imTextboxUtils.jsm',</span>
<a href="#l24.20"></a><span id="l24.20">     'imThemes.jsm',</span>
<a href="#l24.21"></a><span id="l24.21">     'imXPCOMUtils.jsm',</span>
<a href="#l24.22"></a><span id="l24.22">     'jsProtoHelper.jsm',</span>
<a href="#l24.23"></a><span id="l24.23">     'NormalizedMap.jsm',</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+    'OTR.jsm',</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+    'OTRHelpers.jsm',</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+    'OTRLib.jsm',</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+    'OTRUI.jsm',</span>
<a href="#l24.28"></a><span id="l24.28">     'socket.jsm',</span>
<a href="#l24.29"></a><span id="l24.29">     'ToLocaleFormat.jsm',</span>
<a href="#l24.30"></a><span id="l24.30"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/chat/themes/icons/otr-connection-encrypted.svg</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 16 16&quot;&gt;</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+  &lt;path fill=&quot;context-fill&quot; d=&quot;M12,7 L13,7 C13.5522847,7 14,7.44771525 14,8 L14,14 C14,14.5522847 13.5522847,15 13,15 L3,15 C2.44771525,15 2,14.5522847 2,14 L2,8 C2,7.44771525 2.44771525,7 3,7 L4,7 L4,5.00032973 C4,2.79202307 5.79321704,1 8,1 C10.2075938,1 12,2.79481161 12,5.00032973 L12,7 Z M10,7 L10,5.00032973 C10,3.89878113 9.10242341,3 8,3 C6.89748845,3 6,3.89689088 6,5.00032973 L6,7 L10,7 Z&quot;/&gt;</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+  &lt;path style=&quot;fill:#00b22c;fill-opacity:1;stroke-width:0.99999988&quot; d=&quot;M 9.0226853,15.999039 A 0.8763328,0.8763328 0 0 1 8.403118,15.742273 L 5.7741199,13.113275 A 0.8763328,0.8763328 0 0 1 7.0132545,11.87414 l 1.8902496,1.89025 5.5349179,-7.9071509 a 0.8763328,0.8763328 0 0 1 1.436309,1.0042774 L 9.7404016,15.624844 a 0.8763328,0.8763328 0 0 1 -0.6414753,0.374195 0.75627521,0.75627521 0 0 1 -0.076241,0 z&quot;/&gt;</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+&lt;/svg&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/chat/themes/icons/otr-connection-finished.svg</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 16 16&quot;&gt;</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+  &lt;path fill=&quot;context-fill&quot; d=&quot;M12,7 L13,7 C13.5522847,7 14,7.44771525 14,8 L14,14 C14,14.5522847 13.5522847,15 13,15 L3,15 C2.44771525,15 2,14.5522847 2,14 L2,8 C2,7.44771525 2.44771525,7 3,7 L4,7 L4,5.00032973 C4,2.79202307 5.79321704,1 8,1 C10.2075938,1 12,2.79481161 12,5.00032973 L12,7 Z M10,7 L10,5.00032973 C10,3.89878113 9.10242341,3 8,3 C6.89748845,3 6,3.89689088 6,5.00032973 L6,7 L10,7 Z&quot;/&gt;</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+  &lt;path d=&quot;M 11.936582,10.734873 15.767811,6.9036441 A 0.8280753,0.8280753 0 0 0 14.59636,5.7332977 L 10.765132,9.5634223 6.9339034,5.7332977 A 0.8280753,0.8280753 0 1 0 5.763557,6.9036441 L 9.5936809,10.734873 5.763557,14.566099 a 0.8280753,0.8280753 0 1 0 1.1703464,1.170347 l 3.8312286,-3.830123 3.831228,3.831227 a 0.8280753,0.8280753 0 0 0 1.170347,-1.171451 z&quot; style=&quot;fill:#ff9400;fill-opacity:1;stroke-width:1&quot;/&gt;</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+&lt;/svg&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/chat/themes/jar.mn</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/chat/themes/jar.mn</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -15,14 +15,17 @@ chat.jar:</span>
<a href="#l27.4"></a><span id="l27.4"> 	skin/classic/chat/unknown.png</span>
<a href="#l27.5"></a><span id="l27.5"> 	skin/classic/chat/unknown-16.png</span>
<a href="#l27.6"></a><span id="l27.6"> 	skin/classic/chat/chat-16.png</span>
<a href="#l27.7"></a><span id="l27.7"> 	skin/classic/chat/chat-left-16.png</span>
<a href="#l27.8"></a><span id="l27.8"> 	skin/classic/chat/conv.css</span>
<a href="#l27.9"></a><span id="l27.9"> 	skin/classic/chat/browserRequest.css</span>
<a href="#l27.10"></a><span id="l27.10"> 	skin/classic/chat/imtooltip.css</span>
<a href="#l27.11"></a><span id="l27.11"> 	skin/classic/chat/status.css</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+	skin/classic/chat/otr.css</span>
<a href="#l27.13"></a><span id="l27.13"> 	skin/classic/chat/prpl-generic/icon32.png	(icons/prpl-generic-32.png)</span>
<a href="#l27.14"></a><span id="l27.14"> 	skin/classic/chat/prpl-generic/icon48.png	(icons/prpl-generic-48.png)</span>
<a href="#l27.15"></a><span id="l27.15"> 	skin/classic/chat/prpl-generic/icon.png		(icons/prpl-generic.png)</span>
<a href="#l27.16"></a><span id="l27.16"> 	skin/classic/chat/prpl-unknown/icon32.png	(icons/prpl-unknown-32.png)</span>
<a href="#l27.17"></a><span id="l27.17"> 	skin/classic/chat/prpl-unknown/icon48.png	(icons/prpl-unknown-48.png)</span>
<a href="#l27.18"></a><span id="l27.18"> 	skin/classic/chat/prpl-unknown/icon.png		(icons/prpl-unknown.png)</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+	skin/classic/chat/otr-connection-encrypted.svg (icons/otr-connection-encrypted.svg)</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+	skin/classic/chat/otr-connection-finished.svg  (icons/otr-connection-finished.svg)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/chat/themes/otr.css</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,142 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+.otr-container {</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+  border-top: 1px solid var(--splitter-color);</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+  min-height: 32px;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+  padding: 4px;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+}</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+.otr-label {</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+  font-weight: 600;</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+}</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+.otr-not_private &gt; image {</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/connection-insecure.svg&quot;);</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+}</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+.otr-unverified &gt; image {</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/connection-mixed.svg&quot;);</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+}</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+.otr-finished &gt; image {</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+  list-style-image: url(&quot;chrome://chat/skin/otr-connection-finished.svg&quot;);</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+}</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+.otr-private &gt; image {</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+  list-style-image: url(&quot;chrome://chat/skin/otr-connection-encrypted.svg&quot;);</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+}</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+toolbarbutton.otr-button {</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+  -moz-appearance: button !important;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+  padding: 1px !important;</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+}</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+.otr-button &gt; image {</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+  margin-inline-end: 3px;</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+  width: 14px;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+}</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+.otr-button .toolbarbutton-menu-dropmarker {</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+  -moz-appearance: none !important;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+  list-style-image: none;</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+  margin-left: 0;</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+  margin-right: 0;</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+  margin-inline-start: 3px;</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+  width: 9px;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+}</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+.otr-button .toolbarbutton-menu-dropmarker &gt; .dropmarker-icon {</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+  width: 17px;</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+  height: 7px;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/toolbarbutton-arrow.svg&quot;);</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+  background-position: center;</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+  background-repeat: no-repeat;</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+  background-size: 9px 7px;</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+}</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+/* otr botificationbox tweaks */</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;] {</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+  background: #FFF2BE !important;</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+}</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+#otr-notification-box notification {</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+  padding-inline-start: 6px !important;</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+  padding: 6px !important;</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+  border-top: 1px solid var(--splitter-color) !important;</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+  border-bottom: none !important;</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+}</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+#otr-notification-box .messageImage {</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineplus">+  margin-inline-end: 6px !important;</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+  color: #9E650C;</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+}</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineplus">+</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+#otr-notification-box .messageText {</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+  margin-inline-start: 6px !important;</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+  margin-bottom: 6px !important;</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+}</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+.otr-notification-header {</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+  display: inherit;</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+  padding: 3px 6px;</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+}</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+.otr-notification-header title {</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+  font-weight: bold;</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+  color: #9E650C;</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+  flex-grow: 1;</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+}</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+.otr-notification-header .messageCloseButton {</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineplus">+  min-height: 20px;</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+}</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineplus">+</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+.otr-notification-header .messageCloseButton &gt; .toolbarbutton-icon {</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+  margin-inline-end: 0px !important;</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+}</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+.otr-notification-footer {</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+  display: flex;</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineplus">+  justify-content: end;</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineplus">+}</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+/* waiting */</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;][value=&quot;otr:auth-waiting&quot;] &gt;</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+  hbox &gt; .messageImage {</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/help.svg&quot;) !important;</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+}</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+/* fail */</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;][value=&quot;otr:auth-fail&quot;] {</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+  background: #ffc9d5 !important;</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+}</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;][value=&quot;otr:auth-fail&quot;] &gt;</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineplus">+  hbox &gt; .messageImage {</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/error.svg&quot;) !important;</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+  color: #c93434 !important;</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+}</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;][value=&quot;otr:auth-fail&quot;]</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+  .otr-notification-header title {</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+  color: #c93434 !important;</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineplus">+}</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineplus">+</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineplus">+/* success */</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;][value=&quot;otr:auth-success&quot;] {</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineplus">+  background: #D3F4AF !important;</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+}</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;][value=&quot;otr:auth-success&quot;] &gt;</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+  hbox &gt; .messageImage {</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/check.svg&quot;) !important;</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+  color: #407501 !important;</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineplus">+}</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineplus">+</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineplus">+#otr-notification-box notification[type=&quot;warning&quot;][value=&quot;otr:auth-success&quot;]</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineplus">+  .otr-notification-header title {</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineplus">+  color: #407501 !important;</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -714,16 +714,18 @@ pref(&quot;mail.chat.show_desktop_notificatio</span>
<a href="#l29.4"></a><span id="l29.4"> // 1 == Show sender's info only (not message preview),</span>
<a href="#l29.5"></a><span id="l29.5"> // 2 == No info (fill dummy values).</span>
<a href="#l29.6"></a><span id="l29.6"> pref(&quot;mail.chat.notification_info&quot;, 0);</span>
<a href="#l29.7"></a><span id="l29.7"> pref(&quot;mail.chat.play_sound&quot;, true);</span>
<a href="#l29.8"></a><span id="l29.8"> // 0 == default system sound, 1 == user specified wav</span>
<a href="#l29.9"></a><span id="l29.9"> pref(&quot;mail.chat.play_sound.type&quot;, 0);</span>
<a href="#l29.10"></a><span id="l29.10"> // if sound is user specified, this needs to be a file url</span>
<a href="#l29.11"></a><span id="l29.11"> pref(&quot;mail.chat.play_sound.url&quot;, &quot;&quot;);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+// Enable/Disable support for OTR chat encryption.</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+pref(&quot;chat.otr.enable&quot;, false);</span>
<a href="#l29.14"></a><span id="l29.14"> </span>
<a href="#l29.15"></a><span id="l29.15"> // BigFiles</span>
<a href="#l29.16"></a><span id="l29.16"> pref(&quot;mail.cloud_files.enabled&quot;, true);</span>
<a href="#l29.17"></a><span id="l29.17"> pref(&quot;mail.cloud_files.inserted_urls.footer.link&quot;, &quot;https://www.thunderbird.net&quot;);</span>
<a href="#l29.18"></a><span id="l29.18"> pref(&quot;mail.cloud_files.learn_more_url&quot;, &quot;https://support.thunderbird.net/kb/filelink-large-attachments&quot;);</span>
<a href="#l29.19"></a><span id="l29.19"> </span>
<a href="#l29.20"></a><span id="l29.20"> // Ignore threads</span>
<a href="#l29.21"></a><span id="l29.21"> pref(&quot;mail.ignore_thread.learn_more_url&quot;, &quot;https://support.thunderbird.net/kb/ignore-threads&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/components/im/content/chat-conversation-info.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/components/im/content/chat-conversation-info.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,15 +1,29 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.5"></a><span id="l30.5">   * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.6"></a><span id="l30.6">   * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> &quot;use strict&quot;;</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-/* global MozXULElement */</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;OTR&quot;, &quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;OTRUI&quot;, &quot;resource:///modules/OTRUI.jsm&quot;);</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+/* globals MozElements MozXULElement */</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+const gNotification = {};</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+XPCOMUtils.defineLazyGetter(gNotification, &quot;notificationbox&quot;, () =&gt; {</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+  return new MozElements.NotificationBox(element =&gt; {</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+    element.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+    document.getElementById(&quot;otr-notification-box&quot;).append(element);</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+  });</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+});</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27"> /**</span>
<a href="#l30.28"></a><span id="l30.28">  * The MozChatConversationInfo widget displays information about a chat:</span>
<a href="#l30.29"></a><span id="l30.29">  * e.g. the channel name and topic of an IRC channel, or nick, user image and</span>
<a href="#l30.30"></a><span id="l30.30">  * status of a conversation partner.</span>
<a href="#l30.31"></a><span id="l30.31">  * It is typically shown at the top right of the chat UI.</span>
<a href="#l30.32"></a><span id="l30.32">  * @extends {MozXULElement}</span>
<a href="#l30.33"></a><span id="l30.33">  */</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineat">@@ -24,34 +38,64 @@ class MozChatConversationInfo extends Mo</span>
<a href="#l30.35"></a><span id="l30.35">       &quot;.statusMessage&quot;: &quot;value=statusMessage,tooltiptext=statusTooltiptext,editable=topicEditable,editing,noTopic&quot;,</span>
<a href="#l30.36"></a><span id="l30.36">     };</span>
<a href="#l30.37"></a><span id="l30.37">   }</span>
<a href="#l30.38"></a><span id="l30.38"> </span>
<a href="#l30.39"></a><span id="l30.39">   connectedCallback() {</span>
<a href="#l30.40"></a><span id="l30.40">     if (this.hasChildNodes() || this.delayConnectedCallback()) {</span>
<a href="#l30.41"></a><span id="l30.41">       return;</span>
<a href="#l30.42"></a><span id="l30.42">     }</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+    this.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+</span>
<a href="#l30.45"></a><span id="l30.45">     this.appendChild(MozXULElement.parseXULToFragment(`</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-      &lt;stack class=&quot;statusImageStack&quot;&gt;</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-        &lt;box class=&quot;userIconHolder&quot;&gt;</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-          &lt;image class=&quot;userIcon&quot; mousethrough=&quot;always&quot;&gt;&lt;/image&gt;</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-        &lt;/box&gt;</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-        &lt;image class=&quot;statusTypeIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-      &lt;/stack&gt;</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-      &lt;stack class=&quot;displayNameAndstatusMessageStack&quot; mousethrough=&quot;always&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-        &lt;hbox align=&quot;center&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-          &lt;description class=&quot;displayName&quot; flex=&quot;1&quot; crop=&quot;end&quot;&gt;</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+      &lt;hbox class=&quot;displayUserAccount&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+        &lt;stack class=&quot;statusImageStack&quot;&gt;</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+          &lt;box class=&quot;userIconHolder&quot;&gt;</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+            &lt;image class=&quot;userIcon&quot; mousethrough=&quot;always&quot;&gt;&lt;/image&gt;</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+          &lt;/box&gt;</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+          &lt;image class=&quot;statusTypeIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+        &lt;/stack&gt;</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+        &lt;stack class=&quot;displayNameAndstatusMessageStack&quot; mousethrough=&quot;always&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+          &lt;hbox align=&quot;center&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+            &lt;description class=&quot;displayName&quot; flex=&quot;1&quot; crop=&quot;end&quot;&gt;</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+            &lt;/description&gt;</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+            &lt;image class=&quot;prplIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+          &lt;description class=&quot;statusMessage&quot; mousethrough=&quot;never&quot; crop=&quot;end&quot; flex=&quot;100000&quot;&gt;</span>
<a href="#l30.69"></a><span id="l30.69">           &lt;/description&gt;</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-          &lt;image class=&quot;prplIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-        &lt;description class=&quot;statusMessage&quot; mousethrough=&quot;never&quot; crop=&quot;end&quot; flex=&quot;100000&quot;&gt;</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-        &lt;/description&gt;</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-      &lt;/stack&gt;</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-    `));</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+        &lt;/stack&gt;</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+      &lt;hbox class=&quot;otr-container&quot; align=&quot;left&quot; valign=&quot;middle&quot; flex=&quot;1&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+        &lt;label class=&quot;otr-label&quot; crop=&quot;end&quot; value=&quot;&amp;state.label;&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+        &lt;toolbarbutton id=&quot;otrButton&quot;</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+                       mode=&quot;dialog&quot;</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+                       class=&quot;otr-button toolbarbutton-1&quot;</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+                       type=&quot;menu&quot;</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+                       label=&quot;Insecure&quot;</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+                       tooltiptext=&quot;&amp;start.label;&quot;&gt;</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+          &lt;menupopup class=&quot;otr-menu-popup&quot;&gt;</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+            &lt;menuitem class=&quot;otr-start&quot; label=&quot;&amp;start.label;&quot;</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+                      oncommand='this.closest(&quot;chat-conversation-info&quot;).onOtrStartClicked();'/&gt;</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+            &lt;menuitem class=&quot;otr-end&quot; label=&quot;&amp;end.label;&quot;</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+                      oncommand='this.closest(&quot;chat-conversation-info&quot;).onOtrEndClicked();'/&gt;</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+            &lt;menuitem class=&quot;otr-auth&quot; label=&quot;&amp;auth.label;&quot;</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+                      oncommand='this.closest(&quot;chat-conversation-info&quot;).onOtrAuthClicked();'/&gt;</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+          &lt;/menupopup&gt;</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+        &lt;/toolbarbutton&gt;</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+      &lt;hbox id=&quot;otr-notification-box&quot;&gt;&lt;/hbox&gt;</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+    `, [&quot;chrome://chat/content/otr-chat.dtd&quot;]));</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+</span>
<a href="#l30.99"></a><span id="l30.99">     this.topic.addEventListener(&quot;click&quot;, this.startEditTopic.bind(this));</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;chat.otr.enable&quot;)) {</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+      let otrButton = this.querySelector(&quot;.otr-button&quot;);</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+      otrButton.addEventListener(&quot;command&quot;, this.otrButtonClicked);</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+      OTRUI.setNotificationBox(gNotification.notificationbox);</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+    }</span>
<a href="#l30.106"></a><span id="l30.106">     this.initializeAttributeInheritance();</span>
<a href="#l30.107"></a><span id="l30.107">   }</span>
<a href="#l30.108"></a><span id="l30.108"> </span>
<a href="#l30.109"></a><span id="l30.109">   get topic() {</span>
<a href="#l30.110"></a><span id="l30.110">     return this.querySelector(&quot;.statusMessage&quot;);</span>
<a href="#l30.111"></a><span id="l30.111">   }</span>
<a href="#l30.112"></a><span id="l30.112"> </span>
<a href="#l30.113"></a><span id="l30.113">   finishEditTopic(save) {</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineat">@@ -111,10 +155,45 @@ class MozChatConversationInfo extends Mo</span>
<a href="#l30.115"></a><span id="l30.115">     this._topicBlur = this.topicBlur.bind(this);</span>
<a href="#l30.116"></a><span id="l30.116">     elt.addEventListener(&quot;blur&quot;, this._topicBlur);</span>
<a href="#l30.117"></a><span id="l30.117">     elt.getBoundingClientRect();</span>
<a href="#l30.118"></a><span id="l30.118">     if (this.hasAttribute(&quot;noTopic&quot;)) {</span>
<a href="#l30.119"></a><span id="l30.119">       elt.value = &quot;&quot;;</span>
<a href="#l30.120"></a><span id="l30.120">     }</span>
<a href="#l30.121"></a><span id="l30.121">     elt.select();</span>
<a href="#l30.122"></a><span id="l30.122">   }</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+  otrButtonClicked(aEvent) {</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+    aEvent.preventDefault();</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+    let otrMenu = this.querySelector(&quot;.otr-menu-popup&quot;);</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+    otrMenu.openPopup(otrMenu.parentNode, &quot;after_start&quot;);</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+  }</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+  onOtrStartClicked() {</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+    // check if start-menu-command is disabled, if yes exit</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+    let convBinding = document.getElementById(&quot;conversationsDeck&quot;).selectedPanel;</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+    let uiConv = convBinding._conv;</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+    let conv = uiConv.target;</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+    let context = OTR.getContext(conv);</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+    let bundleId = &quot;alert.&quot; + (</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+      context.msgstate === OTR.getMessageState().OTRL_MSGSTATE_ENCRYPTED ?</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+        &quot;refresh&quot; : &quot;start&quot;);</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+    OTRUI.sendSystemAlert(uiConv, conv, bundleId);</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+    OTR.sendQueryMsg(conv);</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+  }</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+  onOtrEndClicked() {</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+    let convBinding = document.getElementById(&quot;conversationsDeck&quot;).selectedPanel;</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+    let uiConv = convBinding._conv;</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+    let conv = uiConv.target;</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+    OTR.disconnect(conv, false);</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+    let bundleId = &quot;alert.gone_insecure&quot;;</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+    OTRUI.sendSystemAlert(uiConv, conv, bundleId);</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+  }</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+  onOtrAuthClicked() {</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+    let convBinding = document.getElementById(&quot;conversationsDeck&quot;).selectedPanel;</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+    let uiConv = convBinding._conv;</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+    let conv = uiConv.target;</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineplus">+    OTRUI.openAuth(window, conv.normalizedName, &quot;start&quot;, uiConv);</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+  }</span>
<a href="#l30.158"></a><span id="l30.158"> }</span>
<a href="#l30.159"></a><span id="l30.159"> customElements.define(&quot;chat-conversation-info&quot;, MozChatConversationInfo);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/components/im/content/chat-messenger.inc.xul</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/components/im/content/chat-messenger.inc.xul</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -88,18 +88,17 @@</span>
<a href="#l31.4"></a><span id="l31.4">                              type=&quot;menu&quot;</span>
<a href="#l31.5"></a><span id="l31.5">                              class=&quot;toolbarbutton-1 button-appmenu&quot;</span>
<a href="#l31.6"></a><span id="l31.6">                              label=&quot;&amp;appmenuButton.label;&quot;</span>
<a href="#l31.7"></a><span id="l31.7">                              tooltiptext=&quot;&amp;appmenuButton1.tooltip;&quot;/&gt;</span>
<a href="#l31.8"></a><span id="l31.8">             &lt;/toolbarpalette&gt;</span>
<a href="#l31.9"></a><span id="l31.9">             &lt;toolbarset id=&quot;customChatToolbars&quot; context=&quot;chat-toolbar-context-menu&quot;/&gt;</span>
<a href="#l31.10"></a><span id="l31.10">           &lt;/toolbox&gt;</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-          &lt;vbox id=&quot;chat-notification-top&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-            &lt;!-- notificationbox will be added here lazily. --&gt;</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+          &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l31.15"></a><span id="l31.15">             &lt;hbox id=&quot;chatPanel&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.16"></a><span id="l31.16">               &lt;vbox id=&quot;listPaneBox&quot; minwidth=&quot;125&quot; width=&quot;200&quot; persist=&quot;width&quot;&gt;</span>
<a href="#l31.17"></a><span id="l31.17">                 &lt;richlistbox id=&quot;contactlistbox&quot;</span>
<a href="#l31.18"></a><span id="l31.18">                              context=&quot;buddyListContextMenu&quot;</span>
<a href="#l31.19"></a><span id="l31.19">                              tooltip=&quot;imTooltip&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.20"></a><span id="l31.20">                   &lt;richlistitem is=&quot;chat-group&quot; id=&quot;conversationsGroup&quot;</span>
<a href="#l31.21"></a><span id="l31.21">                                 name=&quot;&amp;conversationsHeader.label;&quot;/&gt;</span>
<a href="#l31.22"></a><span id="l31.22">                   &lt;richlistitem is=&quot;chat-imconv&quot; id=&quot;searchResultConv&quot;</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineat">@@ -107,69 +106,75 @@</span>
<a href="#l31.24"></a><span id="l31.24">                   &lt;richlistitem is=&quot;chat-group&quot; id=&quot;onlinecontactsGroup&quot;</span>
<a href="#l31.25"></a><span id="l31.25">                                 name=&quot;&amp;onlineContactsHeader.label;&quot;/&gt;</span>
<a href="#l31.26"></a><span id="l31.26">                   &lt;richlistitem is=&quot;chat-group&quot; id=&quot;offlinecontactsGroup&quot;</span>
<a href="#l31.27"></a><span id="l31.27">                                 name=&quot;&amp;offlineContactsHeader.label;&quot;</span>
<a href="#l31.28"></a><span id="l31.28">                                 class=&quot;closed&quot;/&gt;</span>
<a href="#l31.29"></a><span id="l31.29">                 &lt;/richlistbox&gt;</span>
<a href="#l31.30"></a><span id="l31.30">               &lt;/vbox&gt;</span>
<a href="#l31.31"></a><span id="l31.31">               &lt;splitter id=&quot;listSplitter&quot; collapse=&quot;before&quot;/&gt;</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-              &lt;deck id=&quot;conversationsDeck&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-                &lt;vbox flex=&quot;1&quot; id=&quot;noConvScreen&quot; class=&quot;im-placeholder-screen&quot; align=&quot;center&quot; pack=&quot;center&quot;&gt;</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-                  &lt;hbox id=&quot;noConvBox&quot; class=&quot;im-placeholder-box&quot; align=&quot;top&quot;&gt;</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-                    &lt;vbox id=&quot;noConvInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-                      &lt;label id=&quot;noConvTitle&quot; class=&quot;im-placeholder-title&quot;&gt;&amp;chat.noConv.title;&lt;/label&gt;</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-                      &lt;description id=&quot;noConvDesc&quot;</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-                                   class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noConv.description;&lt;/description&gt;</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-                    &lt;/vbox&gt;</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-                    &lt;vbox id=&quot;noAccountInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-                      &lt;label id=&quot;noAccountTitle&quot; class=&quot;im-placeholder-title&quot;&gt;&amp;chat.noAccount.title;&lt;/label&gt;</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-                      &lt;description id=&quot;noAccountDesc&quot;</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineminus">-                                   class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noAccount.description;&lt;/description&gt;</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-                      &lt;hbox class=&quot;im-placeholder-button-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-                        &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineminus">-                        &lt;button id=&quot;openIMAccountWizardButton&quot; label=&quot;&amp;chat.accountWizard.button;&quot;</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-                                oncommand=&quot;openIMAccountWizard();&quot;/&gt;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-                      &lt;/hbox&gt;</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-                    &lt;/vbox&gt;</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-                    &lt;vbox id=&quot;noConnectedAccountInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-                      &lt;label id=&quot;noConnectedAccountTitle&quot;</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-                             class=&quot;im-placeholder-title&quot;&gt;&amp;chat.noConnectedAccount.title;&lt;/label&gt;</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-                      &lt;description id=&quot;noConnectedAccountDesc&quot;</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-                                   class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noConnectedAccount.description;&lt;/description&gt;</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-                      &lt;hbox class=&quot;im-placeholder-button-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-                        &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-                        &lt;button id=&quot;openIMAccountManagerButton&quot; label=&quot;&amp;chat.showAccountManager.button;&quot;</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-                                oncommand=&quot;openIMAccountMgr();&quot;/&gt;</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-                      &lt;/hbox&gt;</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-                    &lt;/vbox&gt;</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-                  &lt;/hbox&gt;</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-                &lt;/vbox&gt;</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-                &lt;vbox id=&quot;logDisplay&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-                  &lt;deck id=&quot;logDisplayDeck&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-                    &lt;vbox flex=&quot;1&quot; id=&quot;noPreviousConvScreen&quot; class=&quot;im-placeholder-screen&quot; align=&quot;center&quot; pack=&quot;center&quot;&gt;</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-                      &lt;hbox id=&quot;noPreviousConvBox&quot; class=&quot;im-placeholder-box&quot; align=&quot;top&quot;&gt;</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-                        &lt;vbox id=&quot;noPreviousConvInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-                          &lt;description id=&quot;noPreviousConvDesc&quot;</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-                                       class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noPreviousConv.description;&lt;/description&gt;</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-                        &lt;/vbox&gt;</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-                      &lt;/hbox&gt;</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-                    &lt;/vbox&gt;</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-                    &lt;vbox flex=&quot;1&quot; id=&quot;logDisplayBrowserBox&quot;&gt;</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-                      &lt;browser id=&quot;conv-log-browser&quot; is=&quot;conversation-browser&quot; type=&quot;content&quot;</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-                               contextmenu=&quot;chatConversationContextMenu&quot; flex=&quot;1&quot;</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-                               tooltip=&quot;imTooltip&quot;/&gt;</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-                      &lt;html:progress id=&quot;log-browserProgress&quot; max=&quot;100&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-                      &lt;findbar id=&quot;log-findbar&quot; browserid=&quot;conv-log-browser&quot;/&gt;</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineminus">-                    &lt;/vbox&gt;</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-                  &lt;/deck&gt;</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-                  &lt;button id=&quot;goToConversation&quot; hidden=&quot;true&quot;</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-                          oncommand=&quot;chatHandler.showCurrentConversation();&quot;/&gt;</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-                &lt;/vbox&gt;</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-              &lt;/deck&gt;</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+              &lt;vbox id=&quot;chat-notification-top&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+                &lt;!-- notificationbox will be added here lazily. --&gt;</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+                &lt;deck id=&quot;conversationsDeck&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+                  &lt;vbox flex=&quot;1&quot; id=&quot;noConvScreen&quot; class=&quot;im-placeholder-screen&quot; align=&quot;center&quot; pack=&quot;center&quot;&gt;</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+                    &lt;hbox id=&quot;noConvBox&quot; class=&quot;im-placeholder-box&quot; align=&quot;top&quot;&gt;</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+                      &lt;vbox id=&quot;noConvInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+                        &lt;label id=&quot;noConvTitle&quot; class=&quot;im-placeholder-title&quot;&gt;&amp;chat.noConv.title;&lt;/label&gt;</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+                        &lt;description id=&quot;noConvDesc&quot;</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+                                     class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noConv.description;&lt;/description&gt;</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+                      &lt;/vbox&gt;</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+                      &lt;vbox id=&quot;noAccountInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+                        &lt;label id=&quot;noAccountTitle&quot; class=&quot;im-placeholder-title&quot;&gt;&amp;chat.noAccount.title;&lt;/label&gt;</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+                        &lt;description id=&quot;noAccountDesc&quot;</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+                                     class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noAccount.description;&lt;/description&gt;</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+                        &lt;hbox class=&quot;im-placeholder-button-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+                          &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+                          &lt;button id=&quot;openIMAccountWizardButton&quot; label=&quot;&amp;chat.accountWizard.button;&quot;</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+                                  oncommand=&quot;openIMAccountWizard();&quot;/&gt;</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineplus">+                        &lt;/hbox&gt;</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+                      &lt;/vbox&gt;</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+                      &lt;vbox id=&quot;noConnectedAccountInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+                        &lt;label id=&quot;noConnectedAccountTitle&quot;</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+                              class=&quot;im-placeholder-title&quot;&gt;&amp;chat.noConnectedAccount.title;&lt;/label&gt;</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+                        &lt;description id=&quot;noConnectedAccountDesc&quot;</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+                                     class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noConnectedAccount.description;&lt;/description&gt;</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+                        &lt;hbox class=&quot;im-placeholder-button-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+                          &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+                          &lt;button id=&quot;openIMAccountManagerButton&quot; label=&quot;&amp;chat.showAccountManager.button;&quot;</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+                                  oncommand=&quot;openIMAccountMgr();&quot;/&gt;</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+                        &lt;/hbox&gt;</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+                      &lt;/vbox&gt;</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+                  &lt;/vbox&gt;</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+                  &lt;vbox id=&quot;logDisplay&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+                    &lt;deck id=&quot;logDisplayDeck&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineplus">+                      &lt;vbox flex=&quot;1&quot; id=&quot;noPreviousConvScreen&quot; class=&quot;im-placeholder-screen&quot; align=&quot;center&quot; pack=&quot;center&quot;&gt;</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineplus">+                        &lt;hbox id=&quot;noPreviousConvBox&quot; class=&quot;im-placeholder-box&quot; align=&quot;top&quot;&gt;</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+                          &lt;vbox id=&quot;noPreviousConvInnerBox&quot; class=&quot;im-placeholder-innerbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+                            &lt;description id=&quot;noPreviousConvDesc&quot;</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+                                         class=&quot;im-placeholder-desc&quot;&gt;&amp;chat.noPreviousConv.description;&lt;/description&gt;</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+                          &lt;/vbox&gt;</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+                        &lt;/hbox&gt;</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+                      &lt;/vbox&gt;</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+                      &lt;vbox flex=&quot;1&quot; id=&quot;logDisplayBrowserBox&quot;&gt;</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+                        &lt;browser id=&quot;conv-log-browser&quot; is=&quot;conversation-browser&quot; type=&quot;content&quot;</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+                                contextmenu=&quot;chatConversationContextMenu&quot; flex=&quot;1&quot;</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+                                tooltip=&quot;imTooltip&quot;/&gt;</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+                        &lt;html:progress id=&quot;log-browserProgress&quot; max=&quot;100&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+                        &lt;findbar id=&quot;log-findbar&quot; browserid=&quot;conv-log-browser&quot;/&gt;</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+                      &lt;/vbox&gt;</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineplus">+                    &lt;/deck&gt;</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+                    &lt;button id=&quot;goToConversation&quot; hidden=&quot;true&quot;</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineplus">+                            oncommand=&quot;chatHandler.showCurrentConversation();&quot;/&gt;</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+                  &lt;/vbox&gt;</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+                &lt;/deck&gt;</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+              &lt;/vbox&gt;</span>
<a href="#l31.144"></a><span id="l31.144">               &lt;splitter id=&quot;contextSplitter&quot; hidden=&quot;true&quot; collapse=&quot;after&quot;/&gt;</span>
<a href="#l31.145"></a><span id="l31.145">               &lt;vbox id=&quot;contextPane&quot; hidden=&quot;true&quot; width=&quot;250&quot; persist=&quot;width&quot;&gt;</span>
<a href="#l31.146"></a><span id="l31.146">                 &lt;chat-conversation-info id=&quot;conv-top-info&quot; class=&quot;conv-top-info&quot;/&gt;</span>
<a href="#l31.147"></a><span id="l31.147">                 &lt;vbox id=&quot;contextPaneFlexibleBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.148"></a><span id="l31.148">                   &lt;vbox flex=&quot;1&quot; class=&quot;conv-chat&quot; width=&quot;150&quot;&gt;</span>
<a href="#l31.149"></a><span id="l31.149">                     &lt;hbox align=&quot;baseline&quot; class=&quot;conv-nicklist-header&quot;&gt;</span>
<a href="#l31.150"></a><span id="l31.150">                       &lt;label class=&quot;conv-nicklist-header-label&quot;</span>
<a href="#l31.151"></a><span id="l31.151">                              id=&quot;participantLabel&quot; control=&quot;participantCount&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/components/im/content/chat-messenger.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/components/im/content/chat-messenger.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -8,17 +8,19 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* globals fixIterator, MailToolboxCustomizeDone, Notifications, openIMAccountMgr,</span>
<a href="#l32.5"></a><span id="l32.5">    PROTO_TREE_VIEW, Services, Status, statusSelector, ZoomManager */</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7"> var {Notifications} = ChromeUtils.import(&quot;resource:///modules/chatNotifications.jsm&quot;);</span>
<a href="#l32.8"></a><span id="l32.8"> var { Services: imServices } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l32.9"></a><span id="l32.9"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11"> ChromeUtils.defineModuleGetter(this, &quot;OS&quot;, &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;OTRUI&quot;, &quot;resource:///modules/OTRUI.jsm&quot;);</span>
<a href="#l32.13"></a><span id="l32.13"> </span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+var gOtrEnabled = false;</span>
<a href="#l32.15"></a><span id="l32.15"> var gBuddyListContextMenu = null;</span>
<a href="#l32.16"></a><span id="l32.16"> </span>
<a href="#l32.17"></a><span id="l32.17"> function buddyListContextMenu(aXulMenu) {</span>
<a href="#l32.18"></a><span id="l32.18">   this.target = aXulMenu.triggerNode;</span>
<a href="#l32.19"></a><span id="l32.19">   this.menu = aXulMenu;</span>
<a href="#l32.20"></a><span id="l32.20">   let localName = this.target.localName;</span>
<a href="#l32.21"></a><span id="l32.21">   this.onContact = (localName == &quot;richlistitem&quot; &amp;&amp;</span>
<a href="#l32.22"></a><span id="l32.22">     this.target.getAttribute(&quot;is&quot;) == &quot;chat-contact&quot;);</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineat">@@ -30,17 +32,22 @@ function buddyListContextMenu(aXulMenu) </span>
<a href="#l32.24"></a><span id="l32.24">   [&quot;context-openconversation&quot;, &quot;context-edit-buddy-separator&quot;,</span>
<a href="#l32.25"></a><span id="l32.25">     &quot;context-alias&quot;, &quot;context-delete&quot;].forEach(function(aId) {</span>
<a href="#l32.26"></a><span id="l32.26">     document.getElementById(aId).hidden = hide;</span>
<a href="#l32.27"></a><span id="l32.27">   });</span>
<a href="#l32.28"></a><span id="l32.28"> </span>
<a href="#l32.29"></a><span id="l32.29">   document.getElementById(&quot;context-close-conversation&quot;).hidden = !this.onConv;</span>
<a href="#l32.30"></a><span id="l32.30">   document.getElementById(&quot;context-openconversation&quot;).disabled =</span>
<a href="#l32.31"></a><span id="l32.31">     !hide &amp;&amp; !this.target.canOpenConversation();</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+  if (gOtrEnabled) {</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+    OTRUI.addBuddyContextMenu(this.menu, document);</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+  }</span>
<a href="#l32.36"></a><span id="l32.36"> }</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+</span>
<a href="#l32.38"></a><span id="l32.38"> buddyListContextMenu.prototype = {</span>
<a href="#l32.39"></a><span id="l32.39">   openConversation() {</span>
<a href="#l32.40"></a><span id="l32.40">     if (this.onContact || this.onConv)</span>
<a href="#l32.41"></a><span id="l32.41">       this.target.openConversation();</span>
<a href="#l32.42"></a><span id="l32.42">   },</span>
<a href="#l32.43"></a><span id="l32.43">   closeConversation() {</span>
<a href="#l32.44"></a><span id="l32.44">     if (this.onConv)</span>
<a href="#l32.45"></a><span id="l32.45">       this.target.closeConversation();</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineat">@@ -624,16 +631,19 @@ var chatHandler = {</span>
<a href="#l32.47"></a><span id="l32.47">     let item = contactlistbox.selectedItem;</span>
<a href="#l32.48"></a><span id="l32.48">     if (!item || item.hidden ||</span>
<a href="#l32.49"></a><span id="l32.49">         (item.localName == &quot;richlistitem&quot; &amp;&amp; item.getAttribute(&quot;is&quot;) == &quot;chat-group&quot;)) {</span>
<a href="#l32.50"></a><span id="l32.50">       this._hideContextPane(true);</span>
<a href="#l32.51"></a><span id="l32.51">       document.getElementById(&quot;conversationsDeck&quot;).selectedPanel =</span>
<a href="#l32.52"></a><span id="l32.52">         document.getElementById(&quot;noConvScreen&quot;);</span>
<a href="#l32.53"></a><span id="l32.53">       this.updateTitle();</span>
<a href="#l32.54"></a><span id="l32.54">       this.observedContact = null;</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+      if (gOtrEnabled) {</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+        OTRUI.hideOTRButton();</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+      }</span>
<a href="#l32.58"></a><span id="l32.58">       return;</span>
<a href="#l32.59"></a><span id="l32.59">     }</span>
<a href="#l32.60"></a><span id="l32.60"> </span>
<a href="#l32.61"></a><span id="l32.61">     this._hideContextPane(false);</span>
<a href="#l32.62"></a><span id="l32.62"> </span>
<a href="#l32.63"></a><span id="l32.63">     if (item.getAttribute(&quot;id&quot;) == &quot;searchResultConv&quot;) {</span>
<a href="#l32.64"></a><span id="l32.64">       document.getElementById(&quot;goToConversation&quot;).hidden = true;</span>
<a href="#l32.65"></a><span id="l32.65">       document.getElementById(&quot;contextPane&quot;).removeAttribute(&quot;chat&quot;);</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineat">@@ -643,16 +653,19 @@ var chatHandler = {</span>
<a href="#l32.67"></a><span id="l32.67">       cti.removeAttribute(&quot;statusMessageWithDash&quot;);</span>
<a href="#l32.68"></a><span id="l32.68">       cti.removeAttribute(&quot;statusMessage&quot;);</span>
<a href="#l32.69"></a><span id="l32.69">       cti.removeAttribute(&quot;status&quot;);</span>
<a href="#l32.70"></a><span id="l32.70">       cti.removeAttribute(&quot;statusTypeTooltiptext&quot;);</span>
<a href="#l32.71"></a><span id="l32.71">       cti.removeAttribute(&quot;statusTooltiptext&quot;);</span>
<a href="#l32.72"></a><span id="l32.72">       cti.removeAttribute(&quot;topicEditable&quot;);</span>
<a href="#l32.73"></a><span id="l32.73">       cti.removeAttribute(&quot;noTopic&quot;);</span>
<a href="#l32.74"></a><span id="l32.74">       this.observedContact = null;</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+      if (gOtrEnabled) {</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+        OTRUI.hideOTRButton();</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+      }</span>
<a href="#l32.78"></a><span id="l32.78"> </span>
<a href="#l32.79"></a><span id="l32.79">       let path = &quot;logs/&quot; + item.log.path;</span>
<a href="#l32.80"></a><span id="l32.80">       path = OS.Path.join(OS.Constants.Path.profileDir, ...path.split(&quot;/&quot;));</span>
<a href="#l32.81"></a><span id="l32.81">       imServices.logs.getLogFromFile(path, true).then(aLog =&gt; {</span>
<a href="#l32.82"></a><span id="l32.82">         imServices.logs.getSimilarLogs(aLog, true).then(aSimilarLogs =&gt; {</span>
<a href="#l32.83"></a><span id="l32.83">           if (contactlistbox.selectedItem != item)</span>
<a href="#l32.84"></a><span id="l32.84">             return;</span>
<a href="#l32.85"></a><span id="l32.85">           this._pendingSearchTerm = item.searchTerm || undefined;</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineat">@@ -675,16 +688,20 @@ var chatHandler = {</span>
<a href="#l32.87"></a><span id="l32.87">       } else {</span>
<a href="#l32.88"></a><span id="l32.88">         item.convView.onConvResize();</span>
<a href="#l32.89"></a><span id="l32.89">       }</span>
<a href="#l32.90"></a><span id="l32.90"> </span>
<a href="#l32.91"></a><span id="l32.91">       convDeck.selectedPanel = item.convView;</span>
<a href="#l32.92"></a><span id="l32.92">       item.convView.updateConvStatus();</span>
<a href="#l32.93"></a><span id="l32.93">       item.update();</span>
<a href="#l32.94"></a><span id="l32.94"> </span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+      if (gOtrEnabled) {</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+        OTRUI.updateOTRButton(item.conv);</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+      }</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+</span>
<a href="#l32.99"></a><span id="l32.99">       imServices.logs.getLogsForConversation(item.conv, true).then(aLogs =&gt; {</span>
<a href="#l32.100"></a><span id="l32.100">         if (contactlistbox.selectedItem != item)</span>
<a href="#l32.101"></a><span id="l32.101">           return;</span>
<a href="#l32.102"></a><span id="l32.102">         this._showLogList(aLogs);</span>
<a href="#l32.103"></a><span id="l32.103">       });</span>
<a href="#l32.104"></a><span id="l32.104"> </span>
<a href="#l32.105"></a><span id="l32.105">       let contextPane = document.getElementById(&quot;contextPane&quot;);</span>
<a href="#l32.106"></a><span id="l32.106">       if (item.conv.isChat) {</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineat">@@ -695,16 +712,19 @@ var chatHandler = {</span>
<a href="#l32.108"></a><span id="l32.108">       }</span>
<a href="#l32.109"></a><span id="l32.109"> </span>
<a href="#l32.110"></a><span id="l32.110">       let button = document.getElementById(&quot;goToConversation&quot;);</span>
<a href="#l32.111"></a><span id="l32.111">       let bundle = document.getElementById(&quot;chatBundle&quot;);</span>
<a href="#l32.112"></a><span id="l32.112">       button.label = bundle.getString(&quot;goBackToCurrentConversation.button&quot;);</span>
<a href="#l32.113"></a><span id="l32.113">       button.disabled = false;</span>
<a href="#l32.114"></a><span id="l32.114">       this.observedContact = null;</span>
<a href="#l32.115"></a><span id="l32.115">     } else if (item.localName == &quot;richlistitem&quot; &amp;&amp; item.getAttribute(&quot;is&quot;) == &quot;chat-contact&quot;) {</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+      if (gOtrEnabled) {</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineplus">+        OTRUI.hideOTRButton();</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+      }</span>
<a href="#l32.119"></a><span id="l32.119">       let contact = item.contact;</span>
<a href="#l32.120"></a><span id="l32.120">       if (this.observedContact &amp;&amp; contact &amp;&amp;</span>
<a href="#l32.121"></a><span id="l32.121">           this.observedContact.id == contact.id) {</span>
<a href="#l32.122"></a><span id="l32.122">         return; // onselect has just been fired again because a status</span>
<a href="#l32.123"></a><span id="l32.123">                 // change caused the chat-contact to move.</span>
<a href="#l32.124"></a><span id="l32.124">                 // Return early to avoid flickering and changing the selected log.</span>
<a href="#l32.125"></a><span id="l32.125">       }</span>
<a href="#l32.126"></a><span id="l32.126"> </span>
<a href="#l32.127"></a><span id="l32.127" class="difflineat">@@ -1209,16 +1229,38 @@ var chatHandler = {</span>
<a href="#l32.128"></a><span id="l32.128"> </span>
<a href="#l32.129"></a><span id="l32.129">     ChromeUtils.import(&quot;resource:///modules/chatHandler.jsm&quot;, this);</span>
<a href="#l32.130"></a><span id="l32.130">     if (this.ChatCore.initialized) {</span>
<a href="#l32.131"></a><span id="l32.131">       this.initAfterChatCore();</span>
<a href="#l32.132"></a><span id="l32.132">     } else {</span>
<a href="#l32.133"></a><span id="l32.133">       this.ChatCore.init();</span>
<a href="#l32.134"></a><span id="l32.134">       this._addObserver(&quot;chat-core-initialized&quot;);</span>
<a href="#l32.135"></a><span id="l32.135">     }</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+    gOtrEnabled =</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+      Services.prefs.getBoolPref(&quot;chat.otr.enable&quot;);</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+    if (gOtrEnabled) {</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+      new Promise(resolve =&gt; {</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+        if (Services.core.initialized) {</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+          resolve();</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineplus">+          return;</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+        }</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+        function initObserver() {</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+          Services.obs.removeObserver(initObserver, &quot;prpl-init&quot;);</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+          resolve();</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+        }</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+        Services.obs.addObserver(initObserver, &quot;prpl-init&quot;);</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+      }).then(() =&gt; {</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+        let sss = Cc[&quot;@mozilla.org/content/style-sheet-service;1&quot;].getService(Ci.nsIStyleSheetService);</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineplus">+        let uri = Services.io.newURI(&quot;chrome://chat/skin/otr.css&quot;);</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+        sss.loadAndRegisterSheet(uri, sss.USER_SHEET);</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+        OTRUI.init();</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+      });</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+    }</span>
<a href="#l32.158"></a><span id="l32.158">   },</span>
<a href="#l32.159"></a><span id="l32.159"> };</span>
<a href="#l32.160"></a><span id="l32.160"> </span>
<a href="#l32.161"></a><span id="l32.161"> function chatLogTreeGroupItem(aTitle, aLogItems) {</span>
<a href="#l32.162"></a><span id="l32.162">   this._title = aTitle;</span>
<a href="#l32.163"></a><span id="l32.163">   this._children = aLogItems;</span>
<a href="#l32.164"></a><span id="l32.164">   for (let child of this._children)</span>
<a href="#l32.165"></a><span id="l32.165">     child._parent = this;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/components/im/themes/chat.css</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/components/im/themes/chat.css</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -287,17 +287,16 @@ richlistitem[is=&quot;chat-imconv&quot;]:not(:hove</span>
<a href="#l33.4"></a><span id="l33.4"> }</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> .conv-top {</span>
<a href="#l33.7"></a><span id="l33.7">   min-height: 60px;</span>
<a href="#l33.8"></a><span id="l33.8"> }</span>
<a href="#l33.9"></a><span id="l33.9"> </span>
<a href="#l33.10"></a><span id="l33.10"> .conv-top-info {</span>
<a href="#l33.11"></a><span id="l33.11">   margin: 0;</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  padding: 0.6ex;</span>
<a href="#l33.13"></a><span id="l33.13">   border-style: none;</span>
<a href="#l33.14"></a><span id="l33.14">   -moz-appearance: none;</span>
<a href="#l33.15"></a><span id="l33.15">   -moz-window-dragging: no-drag;</span>
<a href="#l33.16"></a><span id="l33.16">   border-bottom: 1px solid var(--splitter-color);</span>
<a href="#l33.17"></a><span id="l33.17"> }</span>
<a href="#l33.18"></a><span id="l33.18"> </span>
<a href="#l33.19"></a><span id="l33.19"> .userIconHolder {</span>
<a href="#l33.20"></a><span id="l33.20">   border: 2px solid rgba(0,0,0,0.15);</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineat">@@ -475,16 +474,21 @@ richlistitem[state=&quot;disconnected&quot;] .acco</span>
<a href="#l33.22"></a><span id="l33.22">   list-style-image: url('chrome://chat/skin/offline.png');</span>
<a href="#l33.23"></a><span id="l33.23"> }</span>
<a href="#l33.24"></a><span id="l33.24"> </span>
<a href="#l33.25"></a><span id="l33.25"> .status-overlay-icon[status=&quot;unknown&quot;] {</span>
<a href="#l33.26"></a><span id="l33.26">   list-style-image: url('chrome://chat/skin/unknown.png');</span>
<a href="#l33.27"></a><span id="l33.27"> }</span>
<a href="#l33.28"></a><span id="l33.28"> </span>
<a href="#l33.29"></a><span id="l33.29"> /* corresponds to im/themes/conversation.css @media all and (min-height: 251px) */</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+.displayUserAccount {</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+  padding: 4px;</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+  background-color: -moz-OddTreeRow;</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+}</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+</span>
<a href="#l33.35"></a><span id="l33.35"> .statusImageStack,</span>
<a href="#l33.36"></a><span id="l33.36"> .displayNameAndstatusMessageStack {</span>
<a href="#l33.37"></a><span id="l33.37">   margin: 2px 2px;</span>
<a href="#l33.38"></a><span id="l33.38"> }</span>
<a href="#l33.39"></a><span id="l33.39"> </span>
<a href="#l33.40"></a><span id="l33.40"> .displayName {</span>
<a href="#l33.41"></a><span id="l33.41">   font-size: 16px;</span>
<a href="#l33.42"></a><span id="l33.42">   border-bottom: 1px solid var(--splitter-color);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

