<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27969:6a279db8f7370513cd9853ece3d8cb7ce00b62e0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6a279db8f7370513cd9853ece3d8cb7ce00b62e0" />
<meta property="og:url" content="/comm-central/rev/6a279db8f7370513cd9853ece3d8cb7ce00b62e0" />
<meta property="og:description" content="Bug 1587016 - Convert import code to use new address book provider. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6a279db8f7370513cd9853ece3d8cb7ce00b62e0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6a279db8f7370513cd9853ece3d8cb7ce00b62e0">shortlog</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6a279db8f7370513cd9853ece3d8cb7ce00b62e0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0">files</a> |
changeset |
<a href="/comm-central/raw-rev/6a279db8f7370513cd9853ece3d8cb7ce00b62e0">raw</a>  | <a href="/comm-central/archive/6a279db8f7370513cd9853ece3d8cb7ce00b62e0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1587016">Bug 1587016</a> - Convert import code to use new address book provider. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 12 Oct 2019 11:26:11 +1300</td></tr>

<tr>
 <td>changeset 27969</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6a279db8f7370513cd9853ece3d8cb7ce00b62e0">6a279db8f7370513cd9853ece3d8cb7ce00b62e0</a></td>
</tr>



<tr>
<td>parent 27968</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0618eba9d869570c63b4e9d20f2d0b1911f82051">0618eba9d869570c63b4e9d20f2d0b1911f82051</a>
</td>
</tr>

<tr>
<td>child 27970</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f5a320f3ebce383190418b463937d6b0e4f57a00">f5a320f3ebce383190418b463937d6b0e4f57a00</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6a279db8f7370513cd9853ece3d8cb7ce00b62e0">16584</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 21 Oct 2019 09:07:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@caa4039d835a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=caa4039d835ac06a1e65a1b23f6951c92a7e3c73">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=caa4039d835ac06a1e65a1b23f6951c92a7e3c73&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=caa4039d835ac06a1e65a1b23f6951c92a7e3c73&newProject=comm-central&newRevision=6a279db8f7370513cd9853ece3d8cb7ce00b62e0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=caa4039d835ac06a1e65a1b23f6951c92a7e3c73&newProject=comm-central&newRevision=6a279db8f7370513cd9853ece3d8cb7ce00b62e0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=caa4039d835ac06a1e65a1b23f6951c92a7e3c73&newProject=comm-central&newRevision=6a279db8f7370513cd9853ece3d8cb7ce00b62e0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1587016">1587016</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1587016">Bug 1587016</a> - Convert import code to use new address book provider. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/public/nsIAbLDIFService.idl">mailnews/addrbook/public/nsIAbLDIFService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/public/nsIAbLDIFService.idl">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/public/nsIAbLDIFService.idl">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/public/nsIAbLDIFService.idl">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/public/nsIAbLDIFService.idl">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/public/nsIAbLDIFService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.cpp">mailnews/addrbook/src/nsAbLDIFService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.h">mailnews/addrbook/src/nsAbLDIFService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.h">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.h">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.h">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.h">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/addrbook/src/nsAbLDIFService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">mailnews/import/becky/src/nsBeckyAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookImport.cpp">mailnews/import/outlook/src/nsOutlookImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookImport.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookImport.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookImport.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookImport.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.cpp">mailnews/import/outlook/src/nsOutlookMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.h">mailnews/import/outlook/src/nsOutlookMail.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.h">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.h">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.h">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.h">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/outlook/src/nsOutlookMail.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportAddressBooks.idl">mailnews/import/public/nsIImportAddressBooks.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportAddressBooks.idl">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportAddressBooks.idl">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportAddressBooks.idl">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportAddressBooks.idl">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportAddressBooks.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportFieldMap.idl">mailnews/import/public/nsIImportFieldMap.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportFieldMap.idl">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportFieldMap.idl">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportFieldMap.idl">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportFieldMap.idl">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/public/nsIImportFieldMap.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.cpp">mailnews/import/src/nsImportAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.h">mailnews/import/src/nsImportAddressBooks.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.h">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.h">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.h">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.h">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportAddressBooks.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.cpp">mailnews/import/src/nsImportFieldMap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.h">mailnews/import/src/nsImportFieldMap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.h">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.h">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.h">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.h">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/src/nsImportFieldMap.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/test/unit/xpcshell.ini">mailnews/import/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.cpp">mailnews/import/text/src/nsTextAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.h">mailnews/import/text/src/nsTextAddress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.h">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.h">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.h">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.h">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextAddress.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextImport.cpp">mailnews/import/text/src/nsTextImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextImport.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextImport.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextImport.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextImport.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/text/src/nsTextImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.cpp">mailnews/import/vcard/src/nsVCardAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.h">mailnews/import/vcard/src/nsVCardAddress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.h">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.h">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.h">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.h">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardAddress.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardImport.cpp">mailnews/import/vcard/src/nsVCardImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardImport.cpp">file</a> |
<a href="/comm-central/annotate/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardImport.cpp">annotate</a> |
<a href="/comm-central/diff/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardImport.cpp">diff</a> |
<a href="/comm-central/comparison/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardImport.cpp">comparison</a> |
<a href="/comm-central/log/6a279db8f7370513cd9853ece3d8cb7ce00b62e0/mailnews/import/vcard/src/nsVCardImport.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbLDIFService.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbLDIFService.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.5"></a><span id="l1.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIFile;</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-interface nsIAddrDatabase;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+interface nsIAbDirectory;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> [scriptable, uuid(7afaa95f-0b1c-4d8a-a65f-bb5073ed6d39)]</span>
<a href="#l1.15"></a><span id="l1.15"> interface nsIAbLDIFService : nsISupports {</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   /**</span>
<a href="#l1.18"></a><span id="l1.18">    * Determine if a file is likely to be an LDIF file based on field</span>
<a href="#l1.19"></a><span id="l1.19">    * names that commonly appear in LDIF files.</span>
<a href="#l1.20"></a><span id="l1.20">    *</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -19,22 +19,25 @@ interface nsIAbLDIFService : nsISupports</span>
<a href="#l1.22"></a><span id="l1.22">    * @return      true if the file appears to be of LDIF type,</span>
<a href="#l1.23"></a><span id="l1.23">    *              false otherwise</span>
<a href="#l1.24"></a><span id="l1.24">    */</span>
<a href="#l1.25"></a><span id="l1.25">   boolean isLDIFFile(in nsIFile aSrc);</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">   /**</span>
<a href="#l1.28"></a><span id="l1.28">    * Imports a file into the specified address book.</span>
<a href="#l1.29"></a><span id="l1.29">    *</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-   * @param       aDb             The address book to import addresses into.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+   * @param       aDirectory      The address book to import addresses into.</span>
<a href="#l1.32"></a><span id="l1.32">    *</span>
<a href="#l1.33"></a><span id="l1.33">    * @param       aSrc            The file to import addresses from.</span>
<a href="#l1.34"></a><span id="l1.34">    *</span>
<a href="#l1.35"></a><span id="l1.35">    * @param       aStoreLocAsHome Stores the address as a home rather than work</span>
<a href="#l1.36"></a><span id="l1.36">    *                              address.</span>
<a href="#l1.37"></a><span id="l1.37">    *</span>
<a href="#l1.38"></a><span id="l1.38">    * @param       aProgress       May be null, but if a pointer is supplied,</span>
<a href="#l1.39"></a><span id="l1.39">    *                              then it will be updated regularly with the</span>
<a href="#l1.40"></a><span id="l1.40">    *                              current position of reading from the file.</span>
<a href="#l1.41"></a><span id="l1.41">    *</span>
<a href="#l1.42"></a><span id="l1.42">    */</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-  void importLDIFFile(in nsIAddrDatabase aDb, in nsIFile aSrc, in boolean aStoreLocAsHome, inout unsigned long aProgress);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  void importLDIFFile(in nsIAbDirectory aDirectory,</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+                      in nsIFile aSrc,</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+                      in boolean aStoreLocAsHome,</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                      inout unsigned long aProgress);</span>
<a href="#l1.48"></a><span id="l1.48"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.5"></a><span id="l2.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+#include &quot;nsIAbCard.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12"> #include &quot;nsString.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> #include &quot;nsAbLDIFService.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsIFile.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;mdb.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineat">@@ -47,22 +49,22 @@ static unsigned char b642nib[0x80] = {</span>
<a href="#l2.21"></a><span id="l2.21">     0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0xff, 0xff,</span>
<a href="#l2.22"></a><span id="l2.22">     0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06,</span>
<a href="#l2.23"></a><span id="l2.23">     0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12,</span>
<a href="#l2.24"></a><span id="l2.24">     0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l2.25"></a><span id="l2.25">     0xff, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24,</span>
<a href="#l2.26"></a><span id="l2.26">     0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,</span>
<a href="#l2.27"></a><span id="l2.27">     0x31, 0x32, 0x33, 0xff, 0xff, 0xff, 0xff, 0xff};</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-NS_IMETHODIMP nsAbLDIFService::ImportLDIFFile(nsIAddrDatabase *aDb,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+NS_IMETHODIMP nsAbLDIFService::ImportLDIFFile(nsIAbDirectory *aDirectory,</span>
<a href="#l2.31"></a><span id="l2.31">                                               nsIFile *aSrc,</span>
<a href="#l2.32"></a><span id="l2.32">                                               bool aStoreLocAsHome,</span>
<a href="#l2.33"></a><span id="l2.33">                                               uint32_t *aProgress) {</span>
<a href="#l2.34"></a><span id="l2.34">   NS_ENSURE_ARG_POINTER(aSrc);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDb);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">   mStoreLocAsHome = aStoreLocAsHome;</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">   char buf[1024];</span>
<a href="#l2.41"></a><span id="l2.41">   char *pBuf = &amp;buf[0];</span>
<a href="#l2.42"></a><span id="l2.42">   int32_t startPos = 0;</span>
<a href="#l2.43"></a><span id="l2.43">   uint32_t len = 0;</span>
<a href="#l2.44"></a><span id="l2.44">   nsTArray&lt;int32_t&gt; listPosArray;   // where each list/group starts in ldif file</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineat">@@ -79,32 +81,32 @@ NS_IMETHODIMP nsAbLDIFService::ImportLDI</span>
<a href="#l2.46"></a><span id="l2.46">   mLdifLine.Truncate();</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48">   while (NS_SUCCEEDED(inputStream-&gt;Available(&amp;bytesLeft)) &amp;&amp; bytesLeft &gt; 0) {</span>
<a href="#l2.49"></a><span id="l2.49">     if (NS_SUCCEEDED(inputStream-&gt;Read(pBuf, sizeof(buf), &amp;len)) &amp;&amp; len &gt; 0) {</span>
<a href="#l2.50"></a><span id="l2.50">       startPos = 0;</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">       while (NS_SUCCEEDED(GetLdifStringRecord(buf, len, startPos))) {</span>
<a href="#l2.53"></a><span id="l2.53">         if (mLdifLine.Find(&quot;groupOfNames&quot;) == -1)</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-          AddLdifRowToDatabase(aDb, false);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+          AddLdifRowToDatabase(aDirectory, false);</span>
<a href="#l2.56"></a><span id="l2.56">         else {</span>
<a href="#l2.57"></a><span id="l2.57">           // keep file position for mailing list</span>
<a href="#l2.58"></a><span id="l2.58">           listPosArray.AppendElement(savedStartPos);</span>
<a href="#l2.59"></a><span id="l2.59">           listSizeArray.AppendElement(filePos + startPos - savedStartPos);</span>
<a href="#l2.60"></a><span id="l2.60">           ClearLdifRecordBuffer();</span>
<a href="#l2.61"></a><span id="l2.61">         }</span>
<a href="#l2.62"></a><span id="l2.62">         savedStartPos = filePos + startPos;</span>
<a href="#l2.63"></a><span id="l2.63">       }</span>
<a href="#l2.64"></a><span id="l2.64">       filePos += len;</span>
<a href="#l2.65"></a><span id="l2.65">       if (aProgress) *aProgress = (uint32_t)filePos;</span>
<a href="#l2.66"></a><span id="l2.66">     }</span>
<a href="#l2.67"></a><span id="l2.67">   }</span>
<a href="#l2.68"></a><span id="l2.68">   // last row</span>
<a href="#l2.69"></a><span id="l2.69">   if (!mLdifLine.IsEmpty() &amp;&amp; mLdifLine.Find(&quot;groupOfNames&quot;) == -1)</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    AddLdifRowToDatabase(aDb, false);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    AddLdifRowToDatabase(aDirectory, false);</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73">   // mail Lists</span>
<a href="#l2.74"></a><span id="l2.74">   int32_t i, pos;</span>
<a href="#l2.75"></a><span id="l2.75">   uint32_t size;</span>
<a href="#l2.76"></a><span id="l2.76">   int32_t listTotal = listPosArray.Length();</span>
<a href="#l2.77"></a><span id="l2.77">   char *listBuf;</span>
<a href="#l2.78"></a><span id="l2.78">   ClearLdifRecordBuffer();  // make sure the buffer is clean</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80" class="difflineat">@@ -120,32 +122,31 @@ NS_IMETHODIMP nsAbLDIFService::ImportLDI</span>
<a href="#l2.81"></a><span id="l2.81">       // Allocate enough space for the lists/groups as the size varies.</span>
<a href="#l2.82"></a><span id="l2.82">       listBuf = (char *)PR_Malloc(size);</span>
<a href="#l2.83"></a><span id="l2.83">       if (!listBuf) continue;</span>
<a href="#l2.84"></a><span id="l2.84">       if (NS_SUCCEEDED(inputStream-&gt;Read(listBuf, size, &amp;len)) &amp;&amp; len &gt; 0) {</span>
<a href="#l2.85"></a><span id="l2.85">         startPos = 0;</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87">         while (NS_SUCCEEDED(GetLdifStringRecord(listBuf, len, startPos))) {</span>
<a href="#l2.88"></a><span id="l2.88">           if (mLdifLine.Find(&quot;groupOfNames&quot;) != -1) {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-            AddLdifRowToDatabase(aDb, true);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+            AddLdifRowToDatabase(aDirectory, true);</span>
<a href="#l2.91"></a><span id="l2.91">             if (NS_SUCCEEDED(</span>
<a href="#l2.92"></a><span id="l2.92">                     seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0)))</span>
<a href="#l2.93"></a><span id="l2.93">               break;</span>
<a href="#l2.94"></a><span id="l2.94">           }</span>
<a href="#l2.95"></a><span id="l2.95">         }</span>
<a href="#l2.96"></a><span id="l2.96">       }</span>
<a href="#l2.97"></a><span id="l2.97">       PR_FREEIF(listBuf);</span>
<a href="#l2.98"></a><span id="l2.98">     }</span>
<a href="#l2.99"></a><span id="l2.99">   }</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">   rv = inputStream-&gt;Close();</span>
<a href="#l2.102"></a><span id="l2.102">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-  // Finally commit everything to the database and return.</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-  return aDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  return rv;</span>
<a href="#l2.107"></a><span id="l2.107"> }</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109"> /*</span>
<a href="#l2.110"></a><span id="l2.110">  * str_parse_line - takes a line of the form &quot;type:[:] value&quot; and splits it</span>
<a href="#l2.111"></a><span id="l2.111">  * into components &quot;type&quot; and &quot;value&quot;.  if a double colon separates type from</span>
<a href="#l2.112"></a><span id="l2.112">  * value, then value is encoded in base 64, and parse_line un-decodes it</span>
<a href="#l2.113"></a><span id="l2.113">  * (in place) before returning.</span>
<a href="#l2.114"></a><span id="l2.114">  * in LDIF, non-ASCII data is treated as base64 encoded UTF-8</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineat">@@ -306,377 +307,394 @@ nsresult nsAbLDIFService::GetLdifStringR</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">   if (((stopPos == len) &amp;&amp; (mLFCount &gt; 1)) || (mCRCount &gt; 2 &amp;&amp; mLFCount) ||</span>
<a href="#l2.118"></a><span id="l2.118">       (!mLFCount &amp;&amp; mCRCount &gt; 1))</span>
<a href="#l2.119"></a><span id="l2.119">     return NS_OK;</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121">   return NS_ERROR_FAILURE;</span>
<a href="#l2.122"></a><span id="l2.122"> }</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-void nsAbLDIFService::AddLdifRowToDatabase(nsIAddrDatabase *aDatabase,</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+void nsAbLDIFService::AddLdifRowToDatabase(nsIAbDirectory *aDirectory,</span>
<a href="#l2.126"></a><span id="l2.126">                                            bool bIsList) {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  if (!aDirectory) {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    return;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  }</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+</span>
<a href="#l2.131"></a><span id="l2.131">   // If no data to process then reset CR/LF counters and return.</span>
<a href="#l2.132"></a><span id="l2.132">   if (mLdifLine.IsEmpty()) {</span>
<a href="#l2.133"></a><span id="l2.133">     mLFCount = 0;</span>
<a href="#l2.134"></a><span id="l2.134">     mCRCount = 0;</span>
<a href="#l2.135"></a><span id="l2.135">     return;</span>
<a href="#l2.136"></a><span id="l2.136">   }</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-  nsCOMPtr&lt;nsIMdbRow&gt; newRow;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-  if (aDatabase) {</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-    if (bIsList)</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-      aDatabase-&gt;GetNewListRow(getter_AddRefs(newRow));</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-    else</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-      aDatabase-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    if (!newRow) return;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-  } else</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    return;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; newCard = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+  nsTArray&lt;nsCString&gt; members;</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151">   char *cursor = ToNewCString(mLdifLine);</span>
<a href="#l2.152"></a><span id="l2.152">   char *saveCursor = cursor; /* keep for deleting */</span>
<a href="#l2.153"></a><span id="l2.153">   char *line = 0;</span>
<a href="#l2.154"></a><span id="l2.154">   char *typeSlot = 0;</span>
<a href="#l2.155"></a><span id="l2.155">   char *valueSlot = 0;</span>
<a href="#l2.156"></a><span id="l2.156">   int length = 0;  // the length  of an ldif attribute</span>
<a href="#l2.157"></a><span id="l2.157">   while ((line = str_getline(&amp;cursor)) != nullptr) {</span>
<a href="#l2.158"></a><span id="l2.158">     if (NS_SUCCEEDED(str_parse_line(line, &amp;typeSlot, &amp;valueSlot, &amp;length))) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-      AddLdifColToDatabase(aDatabase, newRow, typeSlot, valueSlot, bIsList);</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+      nsAutoCString colType(typeSlot);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+      nsAutoCString column(valueSlot);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+      // 4.x exports attributes like &quot;givenname&quot;,</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+      // mozilla does &quot;givenName&quot; to be compliant with RFC 2798</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+      ToLowerCase(colType);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+      if (colType.EqualsLiteral(&quot;member&quot;) ||</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+          colType.EqualsLiteral(&quot;uniquemember&quot;)) {</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+        members.AppendElement(column);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+      } else {</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+        AddLdifColToDatabase(aDirectory, newCard, colType, column, bIsList);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+      }</span>
<a href="#l2.173"></a><span id="l2.173">     } else</span>
<a href="#l2.174"></a><span id="l2.174">       continue;  // parse error: continue with next loop iteration</span>
<a href="#l2.175"></a><span id="l2.175">   }</span>
<a href="#l2.176"></a><span id="l2.176">   free(saveCursor);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-  aDatabase-&gt;AddCardRowToDB(newRow);</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  if (bIsList) {</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; newList =</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+        do_CreateInstance(NS_ABDIRPROPERTY_CONTRACTID);</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    newList-&gt;SetIsMailList(true);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+    nsAutoString temp;</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+    newCard-&gt;GetDisplayName(temp);</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+    newList-&gt;SetDirName(temp);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+    temp.Truncate();</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+    newCard-&gt;GetPropertyAsAString(kNicknameProperty, temp);</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    newList-&gt;SetListNickName(temp);</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+    temp.Truncate();</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    newCard-&gt;GetPropertyAsAString(kNotesProperty, temp);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    newList-&gt;SetDescription(temp);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+    nsIAbDirectory *outList;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+    aDirectory-&gt;AddMailList(newList, &amp;outList);</span>
<a href="#l2.196"></a><span id="l2.196"> </span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-  if (bIsList) aDatabase-&gt;AddListDirNode(newRow);</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    int32_t count = members.Length();</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+      nsAutoCString email;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+      int32_t emailPos = members[i].Find(&quot;mail=&quot;);</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+      emailPos += strlen(&quot;mail=&quot;);</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+      email = Substring(members[i], emailPos);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+      nsCOMPtr&lt;nsIAbCard&gt; emailCard;</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+      aDirectory-&gt;CardForEmailAddress(email, getter_AddRefs(emailCard));</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+      if (emailCard) {</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+        nsIAbCard *outCard;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+        outList-&gt;AddCard(emailCard, &amp;outCard);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+      }</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+    }</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+  } else {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+    nsIAbCard *outCard;</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+    aDirectory-&gt;AddCard(newCard, &amp;outCard);</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+  }</span>
<a href="#l2.216"></a><span id="l2.216"> </span>
<a href="#l2.217"></a><span id="l2.217">   // Clear buffer for next record</span>
<a href="#l2.218"></a><span id="l2.218">   ClearLdifRecordBuffer();</span>
<a href="#l2.219"></a><span id="l2.219"> }</span>
<a href="#l2.220"></a><span id="l2.220"> </span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-void nsAbLDIFService::AddLdifColToDatabase(nsIAddrDatabase *aDatabase,</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-                                           nsIMdbRow *newRow, char *typeSlot,</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-                                           char *valueSlot, bool bIsList) {</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-  nsAutoCString colType(typeSlot);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-  nsAutoCString column(valueSlot);</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+void nsAbLDIFService::AddLdifColToDatabase(nsIAbDirectory *aDirectory,</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+                                           nsIAbCard *newCard,</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+                                           nsCString colType, nsCString column,</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+                                           bool bIsList) {</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  nsString value = NS_ConvertUTF8toUTF16(column);</span>
<a href="#l2.231"></a><span id="l2.231"> </span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-  // 4.x exports attributes like &quot;givenname&quot;,</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-  // mozilla does &quot;givenName&quot; to be compliant with RFC 2798</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-  ToLowerCase(colType);</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-  mdb_u1 firstByte = (mdb_u1)(colType.get())[0];</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+  char firstByte = colType.get()[0];</span>
<a href="#l2.238"></a><span id="l2.238">   switch (firstByte) {</span>
<a href="#l2.239"></a><span id="l2.239">     case 'b':</span>
<a href="#l2.240"></a><span id="l2.240">       if (colType.EqualsLiteral(&quot;birthyear&quot;))</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-        aDatabase-&gt;AddBirthYear(newRow, column.get());</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kBirthYearProperty, value);</span>
<a href="#l2.243"></a><span id="l2.243">       else if (colType.EqualsLiteral(&quot;birthmonth&quot;))</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-        aDatabase-&gt;AddBirthMonth(newRow, column.get());</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kBirthMonthProperty, value);</span>
<a href="#l2.246"></a><span id="l2.246">       else if (colType.EqualsLiteral(&quot;birthday&quot;))</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-        aDatabase-&gt;AddBirthDay(newRow, column.get());</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kBirthDayProperty, value);</span>
<a href="#l2.249"></a><span id="l2.249">       break;  // 'b'</span>
<a href="#l2.250"></a><span id="l2.250"> </span>
<a href="#l2.251"></a><span id="l2.251">     case 'c':</span>
<a href="#l2.252"></a><span id="l2.252">       if (colType.EqualsLiteral(&quot;cn&quot;) || colType.EqualsLiteral(&quot;commonname&quot;)) {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        if (bIsList)</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-          aDatabase-&gt;AddListName(newRow, column.get());</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-        else</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-          aDatabase-&gt;AddDisplayName(newRow, column.get());</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+        newCard-&gt;SetDisplayName(value);</span>
<a href="#l2.258"></a><span id="l2.258">       } else if (colType.EqualsLiteral(&quot;c&quot;) ||</span>
<a href="#l2.259"></a><span id="l2.259">                  colType.EqualsLiteral(&quot;countryname&quot;)) {</span>
<a href="#l2.260"></a><span id="l2.260">         if (mStoreLocAsHome)</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-          aDatabase-&gt;AddHomeCountry(newRow, column.get());</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kHomeCountryProperty, value);</span>
<a href="#l2.263"></a><span id="l2.263">         else</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-          aDatabase-&gt;AddWorkCountry(newRow, column.get());</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kWorkCountryProperty, value);</span>
<a href="#l2.266"></a><span id="l2.266">       }</span>
<a href="#l2.267"></a><span id="l2.267"> </span>
<a href="#l2.268"></a><span id="l2.268">       else if (colType.EqualsLiteral(&quot;cellphone&quot;))</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-        aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCellularProperty, value);</span>
<a href="#l2.271"></a><span id="l2.271"> </span>
<a href="#l2.272"></a><span id="l2.272">       else if (colType.EqualsLiteral(&quot;carphone&quot;))</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-        aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCellularProperty, value);</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276">       else if (colType.EqualsLiteral(&quot;custom1&quot;))</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-        aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom1Property, value);</span>
<a href="#l2.279"></a><span id="l2.279"> </span>
<a href="#l2.280"></a><span id="l2.280">       else if (colType.EqualsLiteral(&quot;custom2&quot;))</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-        aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom2Property, value);</span>
<a href="#l2.283"></a><span id="l2.283"> </span>
<a href="#l2.284"></a><span id="l2.284">       else if (colType.EqualsLiteral(&quot;custom3&quot;))</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-        aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom3Property, value);</span>
<a href="#l2.287"></a><span id="l2.287"> </span>
<a href="#l2.288"></a><span id="l2.288">       else if (colType.EqualsLiteral(&quot;custom4&quot;))</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-        aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom4Property, value);</span>
<a href="#l2.291"></a><span id="l2.291"> </span>
<a href="#l2.292"></a><span id="l2.292">       else if (colType.EqualsLiteral(&quot;company&quot;))</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-        aDatabase-&gt;AddCompany(newRow, column.get());</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCompanyProperty, value);</span>
<a href="#l2.295"></a><span id="l2.295">       break;  // 'c'</span>
<a href="#l2.296"></a><span id="l2.296"> </span>
<a href="#l2.297"></a><span id="l2.297">     case 'd':</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-      if (colType.EqualsLiteral(&quot;description&quot;)) {</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-        if (bIsList)</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-          aDatabase-&gt;AddListDescription(newRow, column.get());</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-        else</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-          aDatabase-&gt;AddNotes(newRow, column.get());</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-      }</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+      if (colType.EqualsLiteral(&quot;description&quot;))</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kNotesProperty, value);</span>
<a href="#l2.306"></a><span id="l2.306"> </span>
<a href="#l2.307"></a><span id="l2.307">       else if (colType.EqualsLiteral(&quot;department&quot;))</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-        aDatabase-&gt;AddDepartment(newRow, column.get());</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kDepartmentProperty, value);</span>
<a href="#l2.310"></a><span id="l2.310"> </span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-      else if (colType.EqualsLiteral(&quot;displayname&quot;)) {</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-        if (bIsList)</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-          aDatabase-&gt;AddListName(newRow, column.get());</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-        else</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-          aDatabase-&gt;AddDisplayName(newRow, column.get());</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-      }</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;displayname&quot;))</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+        newCard-&gt;SetDisplayName(value);</span>
<a href="#l2.319"></a><span id="l2.319">       break;  // 'd'</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321">     case 'f':</span>
<a href="#l2.322"></a><span id="l2.322"> </span>
<a href="#l2.323"></a><span id="l2.323">       if (colType.EqualsLiteral(&quot;fax&quot;) ||</span>
<a href="#l2.324"></a><span id="l2.324">           colType.EqualsLiteral(&quot;facsimiletelephonenumber&quot;))</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-        aDatabase-&gt;AddFaxNumber(newRow, column.get());</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kFaxProperty, value);</span>
<a href="#l2.327"></a><span id="l2.327">       break;  // 'f'</span>
<a href="#l2.328"></a><span id="l2.328"> </span>
<a href="#l2.329"></a><span id="l2.329">     case 'g':</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-      if (colType.EqualsLiteral(&quot;givenname&quot;))</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-        aDatabase-&gt;AddFirstName(newRow, column.get());</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+      if (colType.EqualsLiteral(&quot;givenname&quot;)) newCard-&gt;SetFirstName(value);</span>
<a href="#l2.334"></a><span id="l2.334">       break;  // 'g'</span>
<a href="#l2.335"></a><span id="l2.335"> </span>
<a href="#l2.336"></a><span id="l2.336">     case 'h':</span>
<a href="#l2.337"></a><span id="l2.337">       if (colType.EqualsLiteral(&quot;homephone&quot;))</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-        aDatabase-&gt;AddHomePhone(newRow, column.get());</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomePhoneProperty, value);</span>
<a href="#l2.340"></a><span id="l2.340"> </span>
<a href="#l2.341"></a><span id="l2.341">       else if (colType.EqualsLiteral(&quot;homestreet&quot;))</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-        aDatabase-&gt;AddHomeAddress(newRow, column.get());</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeAddressProperty, value);</span>
<a href="#l2.344"></a><span id="l2.344"> </span>
<a href="#l2.345"></a><span id="l2.345">       else if (colType.EqualsLiteral(&quot;homeurl&quot;))</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-        aDatabase-&gt;AddWebPage2(newRow, column.get());</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeWebPageProperty, value);</span>
<a href="#l2.348"></a><span id="l2.348">       break;  // 'h'</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350">     case 'l':</span>
<a href="#l2.351"></a><span id="l2.351">       if (colType.EqualsLiteral(&quot;l&quot;) || colType.EqualsLiteral(&quot;locality&quot;)) {</span>
<a href="#l2.352"></a><span id="l2.352">         if (mStoreLocAsHome)</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-          aDatabase-&gt;AddHomeCity(newRow, column.get());</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kHomeCityProperty, value);</span>
<a href="#l2.355"></a><span id="l2.355">         else</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-          aDatabase-&gt;AddWorkCity(newRow, column.get());</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kWorkCityProperty, value);</span>
<a href="#l2.358"></a><span id="l2.358">       }</span>
<a href="#l2.359"></a><span id="l2.359">       // labeledURI contains a URI and, optionally, a label</span>
<a href="#l2.360"></a><span id="l2.360">       // This will remove the label and place the URI as the work URL</span>
<a href="#l2.361"></a><span id="l2.361">       else if (colType.EqualsLiteral(&quot;labeleduri&quot;)) {</span>
<a href="#l2.362"></a><span id="l2.362">         int32_t index = column.FindChar(' ');</span>
<a href="#l2.363"></a><span id="l2.363">         if (index != -1) column.SetLength(index);</span>
<a href="#l2.364"></a><span id="l2.364"> </span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-        aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkWebPageProperty,</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+                                      NS_ConvertUTF8toUTF16(column));</span>
<a href="#l2.368"></a><span id="l2.368">       }</span>
<a href="#l2.369"></a><span id="l2.369"> </span>
<a href="#l2.370"></a><span id="l2.370">       break;  // 'l'</span>
<a href="#l2.371"></a><span id="l2.371"> </span>
<a href="#l2.372"></a><span id="l2.372">     case 'm':</span>
<a href="#l2.373"></a><span id="l2.373">       if (colType.EqualsLiteral(&quot;mail&quot;))</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-        aDatabase-&gt;AddPrimaryEmail(newRow, column.get());</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-      else if (colType.EqualsLiteral(&quot;member&quot;) &amp;&amp; bIsList)</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-        aDatabase-&gt;AddLdifListMember(newRow, column.get());</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+        newCard-&gt;SetPrimaryEmail(value);</span>
<a href="#l2.379"></a><span id="l2.379"> </span>
<a href="#l2.380"></a><span id="l2.380">       else if (colType.EqualsLiteral(&quot;mobile&quot;))</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-        aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCellularProperty, value);</span>
<a href="#l2.383"></a><span id="l2.383"> </span>
<a href="#l2.384"></a><span id="l2.384">       else if (colType.EqualsLiteral(&quot;mozilla_aimscreenname&quot;))</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-        aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kAIMProperty, value);</span>
<a href="#l2.387"></a><span id="l2.387"> </span>
<a href="#l2.388"></a><span id="l2.388">       else if (colType.EqualsLiteral(&quot;mozillacustom1&quot;))</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-        aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom1Property, value);</span>
<a href="#l2.391"></a><span id="l2.391"> </span>
<a href="#l2.392"></a><span id="l2.392">       else if (colType.EqualsLiteral(&quot;mozillacustom2&quot;))</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-        aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom2Property, value);</span>
<a href="#l2.395"></a><span id="l2.395"> </span>
<a href="#l2.396"></a><span id="l2.396">       else if (colType.EqualsLiteral(&quot;mozillacustom3&quot;))</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-        aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom3Property, value);</span>
<a href="#l2.399"></a><span id="l2.399"> </span>
<a href="#l2.400"></a><span id="l2.400">       else if (colType.EqualsLiteral(&quot;mozillacustom4&quot;))</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-        aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCustom4Property, value);</span>
<a href="#l2.403"></a><span id="l2.403"> </span>
<a href="#l2.404"></a><span id="l2.404">       else if (colType.EqualsLiteral(&quot;mozillahomecountryname&quot;))</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-        aDatabase-&gt;AddHomeCountry(newRow, column.get());</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeCountryProperty, value);</span>
<a href="#l2.407"></a><span id="l2.407"> </span>
<a href="#l2.408"></a><span id="l2.408">       else if (colType.EqualsLiteral(&quot;mozillahomelocalityname&quot;))</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-        aDatabase-&gt;AddHomeCity(newRow, column.get());</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeCityProperty, value);</span>
<a href="#l2.411"></a><span id="l2.411"> </span>
<a href="#l2.412"></a><span id="l2.412">       else if (colType.EqualsLiteral(&quot;mozillahomestate&quot;))</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-        aDatabase-&gt;AddHomeState(newRow, column.get());</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeStateProperty, value);</span>
<a href="#l2.415"></a><span id="l2.415"> </span>
<a href="#l2.416"></a><span id="l2.416">       else if (colType.EqualsLiteral(&quot;mozillahomestreet&quot;))</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-        aDatabase-&gt;AddHomeAddress(newRow, column.get());</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeAddressProperty, value);</span>
<a href="#l2.419"></a><span id="l2.419"> </span>
<a href="#l2.420"></a><span id="l2.420">       else if (colType.EqualsLiteral(&quot;mozillahomestreet2&quot;))</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-        aDatabase-&gt;AddHomeAddress2(newRow, column.get());</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeAddress2Property, value);</span>
<a href="#l2.423"></a><span id="l2.423"> </span>
<a href="#l2.424"></a><span id="l2.424">       else if (colType.EqualsLiteral(&quot;mozillahomepostalcode&quot;))</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-        aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeZipCodeProperty, value);</span>
<a href="#l2.427"></a><span id="l2.427"> </span>
<a href="#l2.428"></a><span id="l2.428">       else if (colType.EqualsLiteral(&quot;mozillahomeurl&quot;))</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-        aDatabase-&gt;AddWebPage2(newRow, column.get());</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kHomeWebPageProperty, value);</span>
<a href="#l2.431"></a><span id="l2.431"> </span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-      else if (colType.EqualsLiteral(&quot;mozillanickname&quot;)) {</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-        if (bIsList)</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-          aDatabase-&gt;AddListNickName(newRow, column.get());</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-        else</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-          aDatabase-&gt;AddNickName(newRow, column.get());</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-      }</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillanickname&quot;))</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kNicknameProperty, value);</span>
<a href="#l2.440"></a><span id="l2.440"> </span>
<a href="#l2.441"></a><span id="l2.441">       else if (colType.EqualsLiteral(&quot;mozillasecondemail&quot;))</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-        aDatabase-&gt;Add2ndEmail(newRow, column.get());</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(k2ndEmailProperty, value);</span>
<a href="#l2.444"></a><span id="l2.444"> </span>
<a href="#l2.445"></a><span id="l2.445">       else if (colType.EqualsLiteral(&quot;mozillausehtmlmail&quot;)) {</span>
<a href="#l2.446"></a><span id="l2.446">         ToLowerCase(column);</span>
<a href="#l2.447"></a><span id="l2.447">         if (-1 != column.Find(&quot;true&quot;))</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-          aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::html);</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+          newCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+                                       nsIAbPreferMailFormat::html);</span>
<a href="#l2.451"></a><span id="l2.451">         else if (-1 != column.Find(&quot;false&quot;))</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-                                         nsIAbPreferMailFormat::plaintext);</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+          newCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+                                       nsIAbPreferMailFormat::plaintext);</span>
<a href="#l2.456"></a><span id="l2.456">         else</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-                                         nsIAbPreferMailFormat::unknown);</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+          newCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+                                       nsIAbPreferMailFormat::unknown);</span>
<a href="#l2.461"></a><span id="l2.461">       }</span>
<a href="#l2.462"></a><span id="l2.462"> </span>
<a href="#l2.463"></a><span id="l2.463">       else if (colType.EqualsLiteral(&quot;mozillaworkstreet2&quot;))</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-        aDatabase-&gt;AddWorkAddress2(newRow, column.get());</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkAddress2Property, value);</span>
<a href="#l2.466"></a><span id="l2.466"> </span>
<a href="#l2.467"></a><span id="l2.467">       else if (colType.EqualsLiteral(&quot;mozillaworkurl&quot;))</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-        aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkWebPageProperty, value);</span>
<a href="#l2.470"></a><span id="l2.470"> </span>
<a href="#l2.471"></a><span id="l2.471">       break;  // 'm'</span>
<a href="#l2.472"></a><span id="l2.472"> </span>
<a href="#l2.473"></a><span id="l2.473">     case 'n':</span>
<a href="#l2.474"></a><span id="l2.474">       if (colType.EqualsLiteral(&quot;notes&quot;))</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-        aDatabase-&gt;AddNotes(newRow, column.get());</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kNotesProperty, value);</span>
<a href="#l2.477"></a><span id="l2.477"> </span>
<a href="#l2.478"></a><span id="l2.478">       else if (colType.EqualsLiteral(&quot;nscpaimscreenname&quot;) ||</span>
<a href="#l2.479"></a><span id="l2.479">                colType.EqualsLiteral(&quot;nsaimid&quot;))</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-        aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kAIMProperty, value);</span>
<a href="#l2.482"></a><span id="l2.482"> </span>
<a href="#l2.483"></a><span id="l2.483">       break;  // 'n'</span>
<a href="#l2.484"></a><span id="l2.484"> </span>
<a href="#l2.485"></a><span id="l2.485">     case 'o':</span>
<a href="#l2.486"></a><span id="l2.486">       if (colType.EqualsLiteral(&quot;objectclass&quot;))</span>
<a href="#l2.487"></a><span id="l2.487">         break;</span>
<a href="#l2.488"></a><span id="l2.488"> </span>
<a href="#l2.489"></a><span id="l2.489">       else if (colType.EqualsLiteral(&quot;ou&quot;) || colType.EqualsLiteral(&quot;orgunit&quot;))</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-        aDatabase-&gt;AddDepartment(newRow, column.get());</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kDepartmentProperty, value);</span>
<a href="#l2.492"></a><span id="l2.492"> </span>
<a href="#l2.493"></a><span id="l2.493">       else if (colType.EqualsLiteral(&quot;o&quot;))  // organization</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-        aDatabase-&gt;AddCompany(newRow, column.get());</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kCompanyProperty, value);</span>
<a href="#l2.496"></a><span id="l2.496"> </span>
<a href="#l2.497"></a><span id="l2.497">       break;  // 'o'</span>
<a href="#l2.498"></a><span id="l2.498"> </span>
<a href="#l2.499"></a><span id="l2.499">     case 'p':</span>
<a href="#l2.500"></a><span id="l2.500">       if (colType.EqualsLiteral(&quot;postalcode&quot;)) {</span>
<a href="#l2.501"></a><span id="l2.501">         if (mStoreLocAsHome)</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-          aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kHomeZipCodeProperty, value);</span>
<a href="#l2.504"></a><span id="l2.504">         else</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-          aDatabase-&gt;AddWorkZipCode(newRow, column.get());</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kWorkZipCodeProperty, value);</span>
<a href="#l2.507"></a><span id="l2.507">       }</span>
<a href="#l2.508"></a><span id="l2.508"> </span>
<a href="#l2.509"></a><span id="l2.509">       else if (colType.EqualsLiteral(&quot;postofficebox&quot;)) {</span>
<a href="#l2.510"></a><span id="l2.510">         nsAutoCString workAddr1, workAddr2;</span>
<a href="#l2.511"></a><span id="l2.511">         SplitCRLFAddressField(column, workAddr1, workAddr2);</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-        aDatabase-&gt;AddWorkAddress(newRow, workAddr1.get());</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-        aDatabase-&gt;AddWorkAddress2(newRow, workAddr2.get());</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkAddressProperty,</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+                                      NS_ConvertUTF8toUTF16(workAddr1));</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkAddress2Property,</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+                                      NS_ConvertUTF8toUTF16(workAddr2));</span>
<a href="#l2.518"></a><span id="l2.518">       } else if (colType.EqualsLiteral(&quot;pager&quot;) ||</span>
<a href="#l2.519"></a><span id="l2.519">                  colType.EqualsLiteral(&quot;pagerphone&quot;))</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-        aDatabase-&gt;AddPagerNumber(newRow, column.get());</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kPagerProperty, value);</span>
<a href="#l2.522"></a><span id="l2.522"> </span>
<a href="#l2.523"></a><span id="l2.523">       break;  // 'p'</span>
<a href="#l2.524"></a><span id="l2.524"> </span>
<a href="#l2.525"></a><span id="l2.525">     case 'r':</span>
<a href="#l2.526"></a><span id="l2.526">       if (colType.EqualsLiteral(&quot;region&quot;)) {</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-        aDatabase-&gt;AddWorkState(newRow, column.get());</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkStateProperty, value);</span>
<a href="#l2.529"></a><span id="l2.529">       }</span>
<a href="#l2.530"></a><span id="l2.530"> </span>
<a href="#l2.531"></a><span id="l2.531">       break;  // 'r'</span>
<a href="#l2.532"></a><span id="l2.532"> </span>
<a href="#l2.533"></a><span id="l2.533">     case 's':</span>
<a href="#l2.534"></a><span id="l2.534">       if (colType.EqualsLiteral(&quot;sn&quot;) || colType.EqualsLiteral(&quot;surname&quot;))</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-        aDatabase-&gt;AddLastName(newRow, column.get());</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kLastNameProperty, value);</span>
<a href="#l2.537"></a><span id="l2.537"> </span>
<a href="#l2.538"></a><span id="l2.538">       else if (colType.EqualsLiteral(&quot;street&quot;))</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineminus">-        aDatabase-&gt;AddWorkAddress(newRow, column.get());</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkAddressProperty, value);</span>
<a href="#l2.541"></a><span id="l2.541"> </span>
<a href="#l2.542"></a><span id="l2.542">       else if (colType.EqualsLiteral(&quot;streetaddress&quot;)) {</span>
<a href="#l2.543"></a><span id="l2.543">         nsAutoCString addr1, addr2;</span>
<a href="#l2.544"></a><span id="l2.544">         SplitCRLFAddressField(column, addr1, addr2);</span>
<a href="#l2.545"></a><span id="l2.545">         if (mStoreLocAsHome) {</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-          aDatabase-&gt;AddHomeAddress(newRow, addr1.get());</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-          aDatabase-&gt;AddHomeAddress2(newRow, addr2.get());</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kHomeAddressProperty,</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+                                        NS_ConvertUTF8toUTF16(addr1));</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kHomeAddress2Property,</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+                                        NS_ConvertUTF8toUTF16(addr2));</span>
<a href="#l2.552"></a><span id="l2.552">         } else {</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-          aDatabase-&gt;AddWorkAddress(newRow, addr1.get());</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-          aDatabase-&gt;AddWorkAddress2(newRow, addr2.get());</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kWorkAddressProperty,</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+                                        NS_ConvertUTF8toUTF16(addr1));</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kWorkAddress2Property,</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+                                        NS_ConvertUTF8toUTF16(addr2));</span>
<a href="#l2.559"></a><span id="l2.559">         }</span>
<a href="#l2.560"></a><span id="l2.560">       } else if (colType.EqualsLiteral(&quot;st&quot;)) {</span>
<a href="#l2.561"></a><span id="l2.561">         if (mStoreLocAsHome)</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-          aDatabase-&gt;AddHomeState(newRow, column.get());</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kHomeStateProperty, value);</span>
<a href="#l2.564"></a><span id="l2.564">         else</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-          aDatabase-&gt;AddWorkState(newRow, column.get());</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kWorkStateProperty, value);</span>
<a href="#l2.567"></a><span id="l2.567">       }</span>
<a href="#l2.568"></a><span id="l2.568"> </span>
<a href="#l2.569"></a><span id="l2.569">       break;  // 's'</span>
<a href="#l2.570"></a><span id="l2.570"> </span>
<a href="#l2.571"></a><span id="l2.571">     case 't':</span>
<a href="#l2.572"></a><span id="l2.572">       if (colType.EqualsLiteral(&quot;title&quot;))</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-        aDatabase-&gt;AddJobTitle(newRow, column.get());</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kJobTitleProperty, value);</span>
<a href="#l2.575"></a><span id="l2.575"> </span>
<a href="#l2.576"></a><span id="l2.576">       else if (colType.EqualsLiteral(&quot;telephonenumber&quot;)) {</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineminus">-        aDatabase-&gt;AddWorkPhone(newRow, column.get());</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkPhoneProperty, value);</span>
<a href="#l2.579"></a><span id="l2.579">       }</span>
<a href="#l2.580"></a><span id="l2.580"> </span>
<a href="#l2.581"></a><span id="l2.581">       break;  // 't'</span>
<a href="#l2.582"></a><span id="l2.582"> </span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-    case 'u':</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-      if (colType.EqualsLiteral(&quot;uniquemember&quot;) &amp;&amp; bIsList)</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-        aDatabase-&gt;AddLdifListMember(newRow, column.get());</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-      break;  // 'u'</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineminus">-</span>
<a href="#l2.590"></a><span id="l2.590">     case 'w':</span>
<a href="#l2.591"></a><span id="l2.591">       if (colType.EqualsLiteral(&quot;workurl&quot;))</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineminus">-        aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kWorkWebPageProperty, value);</span>
<a href="#l2.594"></a><span id="l2.594"> </span>
<a href="#l2.595"></a><span id="l2.595">       break;  // 'w'</span>
<a href="#l2.596"></a><span id="l2.596"> </span>
<a href="#l2.597"></a><span id="l2.597">     case 'x':</span>
<a href="#l2.598"></a><span id="l2.598">       if (colType.EqualsLiteral(&quot;xmozillanickname&quot;)) {</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineminus">-        if (bIsList)</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineminus">-          aDatabase-&gt;AddListNickName(newRow, column.get());</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineminus">-        else</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineminus">-          aDatabase-&gt;AddNickName(newRow, column.get());</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineplus">+        newCard-&gt;SetPropertyAsAString(kNicknameProperty, value);</span>
<a href="#l2.604"></a><span id="l2.604">       }</span>
<a href="#l2.605"></a><span id="l2.605"> </span>
<a href="#l2.606"></a><span id="l2.606">       else if (colType.EqualsLiteral(&quot;xmozillausehtmlmail&quot;)) {</span>
<a href="#l2.607"></a><span id="l2.607">         ToLowerCase(column);</span>
<a href="#l2.608"></a><span id="l2.608">         if (-1 != column.Find(&quot;true&quot;))</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-          aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::html);</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineplus">+          newCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+                                       nsIAbPreferMailFormat::html);</span>
<a href="#l2.612"></a><span id="l2.612">         else if (-1 != column.Find(&quot;false&quot;))</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineminus">-                                         nsIAbPreferMailFormat::plaintext);</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+          newCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineplus">+                                       nsIAbPreferMailFormat::plaintext);</span>
<a href="#l2.617"></a><span id="l2.617">         else</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-                                         nsIAbPreferMailFormat::unknown);</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineplus">+          newCard-&gt;SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineplus">+                                       nsIAbPreferMailFormat::unknown);</span>
<a href="#l2.622"></a><span id="l2.622">       }</span>
<a href="#l2.623"></a><span id="l2.623"> </span>
<a href="#l2.624"></a><span id="l2.624">       break;  // 'x'</span>
<a href="#l2.625"></a><span id="l2.625"> </span>
<a href="#l2.626"></a><span id="l2.626">     case 'z':</span>
<a href="#l2.627"></a><span id="l2.627">       if (colType.EqualsLiteral(&quot;zip&quot;))  // alias for postalcode</span>
<a href="#l2.628"></a><span id="l2.628">       {</span>
<a href="#l2.629"></a><span id="l2.629">         if (mStoreLocAsHome)</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-          aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kHomeZipCodeProperty, value);</span>
<a href="#l2.632"></a><span id="l2.632">         else</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-          aDatabase-&gt;AddWorkZipCode(newRow, column.get());</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+          newCard-&gt;SetPropertyAsAString(kWorkZipCodeProperty, value);</span>
<a href="#l2.635"></a><span id="l2.635">       }</span>
<a href="#l2.636"></a><span id="l2.636"> </span>
<a href="#l2.637"></a><span id="l2.637">       break;  // 'z'</span>
<a href="#l2.638"></a><span id="l2.638"> </span>
<a href="#l2.639"></a><span id="l2.639">     default:</span>
<a href="#l2.640"></a><span id="l2.640">       break;  // default</span>
<a href="#l2.641"></a><span id="l2.641">   }</span>
<a href="#l2.642"></a><span id="l2.642"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDIFService.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDIFService.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3,34 +3,32 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.5"></a><span id="l3.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.6"></a><span id="l3.6"> #ifndef __nsAbLDIFService_h</span>
<a href="#l3.7"></a><span id="l3.7"> #define __nsAbLDIFService_h</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsIAbLDIFService.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-class nsIMdbRow;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14"> class nsAbLDIFService : public nsIAbLDIFService {</span>
<a href="#l3.15"></a><span id="l3.15">  public:</span>
<a href="#l3.16"></a><span id="l3.16">   NS_DECL_ISUPPORTS</span>
<a href="#l3.17"></a><span id="l3.17">   NS_DECL_NSIABLDIFSERVICE</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">   nsAbLDIFService();</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">  private:</span>
<a href="#l3.22"></a><span id="l3.22">   virtual ~nsAbLDIFService();</span>
<a href="#l3.23"></a><span id="l3.23">   nsresult str_parse_line(char *line, char **type, char **value,</span>
<a href="#l3.24"></a><span id="l3.24">                           int *vlen) const;</span>
<a href="#l3.25"></a><span id="l3.25">   char *str_getline(char **next) const;</span>
<a href="#l3.26"></a><span id="l3.26">   nsresult GetLdifStringRecord(char *buf, int32_t len, int32_t &amp;stopPos);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-  void AddLdifRowToDatabase(nsIAddrDatabase *aDatabase, bool aIsList);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  void AddLdifColToDatabase(nsIAddrDatabase *aDatabase, nsIMdbRow *newRow,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-                            char *typeSlot, char *valueSlot, bool bIsList);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  void AddLdifRowToDatabase(nsIAbDirectory *aDirectory, bool aIsList);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  void AddLdifColToDatabase(nsIAbDirectory *aDirectory, nsIAbCard *newCard,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                            nsCString colType, nsCString column, bool bIsList);</span>
<a href="#l3.33"></a><span id="l3.33">   void ClearLdifRecordBuffer();</span>
<a href="#l3.34"></a><span id="l3.34">   void SplitCRLFAddressField(nsCString &amp;inputAddress, nsCString &amp;outputLine1,</span>
<a href="#l3.35"></a><span id="l3.35">                              nsCString &amp;outputLine2) const;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   bool mStoreLocAsHome;</span>
<a href="#l3.38"></a><span id="l3.38">   nsCString mLdifLine;</span>
<a href="#l3.39"></a><span id="l3.39">   int32_t mLFCount;</span>
<a href="#l3.40"></a><span id="l3.40">   int32_t mCRCount;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyAddressBooks.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyAddressBooks.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -247,17 +247,17 @@ nsBeckyAddressBooks::FindAddressBooks(ns</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> NS_IMETHODIMP</span>
<a href="#l4.6"></a><span id="l4.6"> nsBeckyAddressBooks::InitFieldMap(nsIImportFieldMap *aFieldMap) {</span>
<a href="#l4.7"></a><span id="l4.7">   return NS_ERROR_FAILURE;</span>
<a href="#l4.8"></a><span id="l4.8"> }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> NS_IMETHODIMP</span>
<a href="#l4.11"></a><span id="l4.11"> nsBeckyAddressBooks::ImportAddressBook(</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    nsIImportABDescriptor *aSource, nsIAddrDatabase *aDestination,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    nsIImportABDescriptor *aSource, nsIAbDirectory *aDestination,</span>
<a href="#l4.14"></a><span id="l4.14">     nsIImportFieldMap *aFieldMap, nsISupports *aSupportService,</span>
<a href="#l4.15"></a><span id="l4.15">     char16_t **aErrorLog, char16_t **aSuccessLog, bool *aFatalError) {</span>
<a href="#l4.16"></a><span id="l4.16">   NS_ENSURE_ARG_POINTER(aSource);</span>
<a href="#l4.17"></a><span id="l4.17">   NS_ENSURE_ARG_POINTER(aDestination);</span>
<a href="#l4.18"></a><span id="l4.18">   NS_ENSURE_ARG_POINTER(aErrorLog);</span>
<a href="#l4.19"></a><span id="l4.19">   NS_ENSURE_ARG_POINTER(aSuccessLog);</span>
<a href="#l4.20"></a><span id="l4.20">   NS_ENSURE_ARG_POINTER(aFatalError);</span>
<a href="#l4.21"></a><span id="l4.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,17 +15,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIImportMail.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsXPCOM.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsOutlookSettings.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsOutlookMail.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -103,17 +103,17 @@ class ImportOutlookAddressImpl : public </span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval);</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap) {</span>
<a href="#l5.27"></a><span id="l5.27">     return NS_ERROR_FAILURE;</span>
<a href="#l5.28"></a><span id="l5.28">   }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-                               nsIAddrDatabase *destination,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                               nsIAbDirectory *destination,</span>
<a href="#l5.33"></a><span id="l5.33">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l5.34"></a><span id="l5.34">                                nsISupports *aSupportService,</span>
<a href="#l5.35"></a><span id="l5.35">                                char16_t **errorLog, char16_t **successLog,</span>
<a href="#l5.36"></a><span id="l5.36">                                bool *fatalError);</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">   NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   NS_IMETHOD GetSampleData(int32_t index, bool *pFound, char16_t **pStr) {</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineat">@@ -444,17 +444,17 @@ NS_IMETHODIMP ImportOutlookAddressImpl::</span>
<a href="#l5.42"></a><span id="l5.42">                                                          nsIArray **_retval) {</span>
<a href="#l5.43"></a><span id="l5.43">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.44"></a><span id="l5.44">   if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46">   return m_address.GetAddressBooks(_retval);</span>
<a href="#l5.47"></a><span id="l5.47"> }</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49"> NS_IMETHODIMP ImportOutlookAddressImpl::ImportAddressBook(</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    nsIImportABDescriptor *source, nsIAddrDatabase *destination,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+    nsIImportABDescriptor *source, nsIAbDirectory *destination,</span>
<a href="#l5.52"></a><span id="l5.52">     nsIImportFieldMap *fieldMap, nsISupports *aSupportService,</span>
<a href="#l5.53"></a><span id="l5.53">     char16_t **pErrorLog, char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l5.54"></a><span id="l5.54">   m_msgCount = 0;</span>
<a href="#l5.55"></a><span id="l5.55">   m_msgTotal = 0;</span>
<a href="#l5.56"></a><span id="l5.56">   NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.57"></a><span id="l5.57">   NS_ASSERTION(destination != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.58"></a><span id="l5.58">   NS_ASSERTION(fatalError != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.59"></a><span id="l5.59"> </span>
<a href="#l5.60"></a><span id="l5.60" class="difflineat">@@ -485,17 +485,17 @@ NS_IMETHODIMP ImportOutlookAddressImpl::</span>
<a href="#l5.61"></a><span id="l5.61">   if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty())</span>
<a href="#l5.62"></a><span id="l5.62">     ReportSuccess(name, &amp;success);</span>
<a href="#l5.63"></a><span id="l5.63">   else</span>
<a href="#l5.64"></a><span id="l5.64">     ImportOutlookMailImpl::ReportError(OUTLOOKIMPORT_ADDRESS_CONVERTERROR, name,</span>
<a href="#l5.65"></a><span id="l5.65">                                        &amp;error);</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67">   ImportOutlookMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l5.68"></a><span id="l5.68">   IMPORT_LOG0(&quot;*** Returning from outlook address import\n&quot;);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  return destination-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.71"></a><span id="l5.71"> }</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73"> NS_IMETHODIMP ImportOutlookAddressImpl::GetImportProgress(uint32_t *_retval) {</span>
<a href="#l5.74"></a><span id="l5.74">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.75"></a><span id="l5.75">   if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77">   uint32_t result = m_msgCount;</span>
<a href="#l5.78"></a><span id="l5.78">   if (m_msgTotal) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -490,17 +490,17 @@ BOOL nsOutlookMail::WriteData(nsIOutputS</span>
<a href="#l6.4"></a><span id="l6.4">                               int32_t len) {</span>
<a href="#l6.5"></a><span id="l6.5">   uint32_t written;</span>
<a href="#l6.6"></a><span id="l6.6">   nsresult rv = pDest-&gt;Write(pData, len, &amp;written);</span>
<a href="#l6.7"></a><span id="l6.7">   return NS_SUCCEEDED(rv) &amp;&amp; written == len;</span>
<a href="#l6.8"></a><span id="l6.8"> }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> nsresult nsOutlookMail::ImportAddresses(uint32_t *pCount, uint32_t *pTotal,</span>
<a href="#l6.11"></a><span id="l6.11">                                         const char16_t *pName, uint32_t id,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                                        nsIAddrDatabase *pDb,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                                        nsIAbDirectory *pDirectory,</span>
<a href="#l6.14"></a><span id="l6.14">                                         nsString &amp;errors) {</span>
<a href="#l6.15"></a><span id="l6.15">   if (id &gt;= (uint32_t)(m_addressList.GetSize())) {</span>
<a href="#l6.16"></a><span id="l6.16">     IMPORT_LOG0(&quot;*** Bad address identifier, unable to import\n&quot;);</span>
<a href="#l6.17"></a><span id="l6.17">     return NS_ERROR_FAILURE;</span>
<a href="#l6.18"></a><span id="l6.18">   }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   uint32_t dummyCount = 0;</span>
<a href="#l6.21"></a><span id="l6.21">   if (pCount)</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -578,58 +578,55 @@ nsresult nsOutlookMail::ImportAddresses(</span>
<a href="#l6.23"></a><span id="l6.23">         type.Truncate();</span>
<a href="#l6.24"></a><span id="l6.24">         m_mapi.GetStringFromProp(pVal, type);</span>
<a href="#l6.25"></a><span id="l6.25">         if (type.EqualsLiteral(&quot;IPM.Contact&quot;)) {</span>
<a href="#l6.26"></a><span id="l6.26">           // This is a contact, add it to the address book!</span>
<a href="#l6.27"></a><span id="l6.27">           subject.Truncate();</span>
<a href="#l6.28"></a><span id="l6.28">           pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l6.29"></a><span id="l6.29">           if (pVal) m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-          nsIMdbRow *newRow = nullptr;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-          pDb-&gt;GetNewRow(&amp;newRow);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-          // FIXME: Check with Candice about releasing the newRow if it</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-          // isn't added to the database.  Candice's code in nsAddressBook</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-          // never releases it but that doesn't seem right to me!</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-          if (newRow) {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-            if (BuildCard(subject.get(), pDb, newRow, lpMsg, pFieldMap)) {</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-              pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+          nsCOMPtr&lt;nsIAbCard&gt; newCard =</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+              do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+          if (newCard) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+            if (BuildCard(subject.get(), pDirectory, newCard, lpMsg,</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+                          pFieldMap)) {</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+              nsIAbCard *outCard;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+              pDirectory-&gt;AddCard(newCard, &amp;outCard);</span>
<a href="#l6.46"></a><span id="l6.46">             }</span>
<a href="#l6.47"></a><span id="l6.47">           }</span>
<a href="#l6.48"></a><span id="l6.48">         } else if (type.EqualsLiteral(&quot;IPM.DistList&quot;)) {</span>
<a href="#l6.49"></a><span id="l6.49">           // This is a list/group, add it to the address book!</span>
<a href="#l6.50"></a><span id="l6.50">           subject.Truncate();</span>
<a href="#l6.51"></a><span id="l6.51">           pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l6.52"></a><span id="l6.52">           if (pVal) m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-          CreateList(subject.get(), pDb, lpMsg, pFieldMap);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+          CreateList(subject, pDirectory, lpMsg, pFieldMap);</span>
<a href="#l6.55"></a><span id="l6.55">         }</span>
<a href="#l6.56"></a><span id="l6.56">       }</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">       lpMsg-&gt;Release();</span>
<a href="#l6.59"></a><span id="l6.59">     }</span>
<a href="#l6.60"></a><span id="l6.60">   }</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  rv = pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l6.63"></a><span id="l6.63">   return rv;</span>
<a href="#l6.64"></a><span id="l6.64"> }</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-nsresult nsOutlookMail::CreateList(const char16_t *pName, nsIAddrDatabase *pDb,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+nsresult nsOutlookMail::CreateList(const nsString &amp;pName,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+                                   nsIAbDirectory *pDirectory,</span>
<a href="#l6.68"></a><span id="l6.68">                                    LPMAPIPROP pUserList,</span>
<a href="#l6.69"></a><span id="l6.69">                                    nsIImportFieldMap *pFieldMap) {</span>
<a href="#l6.70"></a><span id="l6.70">   // If no name provided then we're done.</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  if (!pName || !(*pName)) return NS_OK;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  if (pName.IsEmpty()) return NS_OK;</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l6.75"></a><span id="l6.75">   // Make sure we have db to work with.</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-  if (!pDb) return rv;</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  if (!pDirectory) return rv;</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  nsCOMPtr&lt;nsIMdbRow&gt; newListRow;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-  rv = pDb-&gt;GetNewListRow(getter_AddRefs(newListRow));</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; newList =</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+      do_CreateInstance(NS_ABDIRPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l6.83"></a><span id="l6.83">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  nsAutoCString column;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  LossyCopyUTF16toASCII(nsDependentString(pName), column);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-  rv = pDb-&gt;AddListName(newListRow, column.get());</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+  rv = newList-&gt;SetDirName(pName);</span>
<a href="#l6.88"></a><span id="l6.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">   HRESULT hr;</span>
<a href="#l6.91"></a><span id="l6.91">   LPSPropValue value = NULL;</span>
<a href="#l6.92"></a><span id="l6.92">   ULONG valueCount = 0;</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94">   LPSPropTagArray properties = NULL;</span>
<a href="#l6.95"></a><span id="l6.95">   m_mapi.MAPIAllocateBuffer(CbNewSPropTagArray(1), (void **)&amp;properties);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineat">@@ -657,57 +654,38 @@ nsresult nsOutlookMail::CreateList(const</span>
<a href="#l6.97"></a><span id="l6.97">   ULONG total;</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99">   total = sa-&gt;cValues;</span>
<a href="#l6.100"></a><span id="l6.100">   for (idx = 0; idx &lt; total; idx++) {</span>
<a href="#l6.101"></a><span id="l6.101">     lpEid = (LPENTRYID)sa-&gt;lpbin[idx].lpb;</span>
<a href="#l6.102"></a><span id="l6.102">     cbEid = sa-&gt;lpbin[idx].cb;</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104">     if (!m_mapi.OpenEntry(cbEid, lpEid, (LPUNKNOWN *)&amp;lpMsg)) {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-      IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+      IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, pName.get());</span>
<a href="#l6.107"></a><span id="l6.107">       m_mapi.MAPIFreeBuffer(value);</span>
<a href="#l6.108"></a><span id="l6.108">       return NS_ERROR_FAILURE;</span>
<a href="#l6.109"></a><span id="l6.109">     }</span>
<a href="#l6.110"></a><span id="l6.110">     // This is a contact, add it to the address book!</span>
<a href="#l6.111"></a><span id="l6.111">     subject.Truncate();</span>
<a href="#l6.112"></a><span id="l6.112">     pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l6.113"></a><span id="l6.113">     if (pVal) m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-    nsCOMPtr&lt;nsIMdbRow&gt; newRow;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    nsCOMPtr&lt;nsIMdbRow&gt; oldRow;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-    pDb-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-    if (newRow) {</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-      if (BuildCard(subject.get(), pDb, newRow, lpMsg, pFieldMap)) {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; userCard;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-        userCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-        pDb-&gt;InitCardFromRow(userCard, newRow);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-        // add card to db</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-        pDb-&gt;FindRowByCard(userCard, getter_AddRefs(oldRow));</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-        if (oldRow)</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-          newRow = oldRow;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-        else</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-          pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-        // add card list</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-        pDb-&gt;AddListCardColumnsToRow(userCard, newListRow, idx + 1,</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-                                     getter_AddRefs(newCard), true, nullptr,</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-                                     nullptr);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; newCard =</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+        do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+    if (newCard) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+      if (BuildCard(subject.get(), pDirectory, newCard, lpMsg, pFieldMap)) {</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+        nsIAbCard *outCard;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+        newList-&gt;AddCard(newCard, &amp;outCard);</span>
<a href="#l6.143"></a><span id="l6.143">       }</span>
<a href="#l6.144"></a><span id="l6.144">     }</span>
<a href="#l6.145"></a><span id="l6.145">   }</span>
<a href="#l6.146"></a><span id="l6.146">   m_mapi.MAPIFreeBuffer(value);</span>
<a href="#l6.147"></a><span id="l6.147"> </span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-  rv = pDb-&gt;AddCardRowToDB(newListRow);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-  rv = pDb-&gt;SetListAddressTotal(newListRow, (uint32_t)total);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-  rv = pDb-&gt;AddListDirNode(newListRow);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+  nsIAbDirectory *outList;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  rv = pDirectory-&gt;AddMailList(newList, &amp;outList);</span>
<a href="#l6.155"></a><span id="l6.155">   return rv;</span>
<a href="#l6.156"></a><span id="l6.156"> }</span>
<a href="#l6.157"></a><span id="l6.157"> </span>
<a href="#l6.158"></a><span id="l6.158"> void nsOutlookMail::SanitizeValue(nsString &amp;val) {</span>
<a href="#l6.159"></a><span id="l6.159">   MsgReplaceSubstring(val, NS_LITERAL_STRING(&quot;\r\n&quot;), NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l6.160"></a><span id="l6.160">   MsgReplaceChar(val, &quot;\r\n&quot;, ',');</span>
<a href="#l6.161"></a><span id="l6.161"> }</span>
<a href="#l6.162"></a><span id="l6.162"> </span>
<a href="#l6.163"></a><span id="l6.163" class="difflineat">@@ -722,18 +700,18 @@ void nsOutlookMail::SplitString(nsString</span>
<a href="#l6.164"></a><span id="l6.164">   if (idx == -1) idx = val1.RFindChar(10);</span>
<a href="#l6.165"></a><span id="l6.165">   if (idx != -1) {</span>
<a href="#l6.166"></a><span id="l6.166">     val2 = Substring(val1, idx + cnt);</span>
<a href="#l6.167"></a><span id="l6.167">     val1.SetLength(idx);</span>
<a href="#l6.168"></a><span id="l6.168">     SanitizeValue(val1);</span>
<a href="#l6.169"></a><span id="l6.169">   }</span>
<a href="#l6.170"></a><span id="l6.170"> }</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-bool nsOutlookMail::BuildCard(const char16_t *pName, nsIAddrDatabase *pDb,</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-                              nsIMdbRow *newRow, LPMAPIPROP pUser,</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+bool nsOutlookMail::BuildCard(const char16_t *pName, nsIAbDirectory *pDirectory,</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+                              nsIAbCard *newCard, LPMAPIPROP pUser,</span>
<a href="#l6.176"></a><span id="l6.176">                               nsIImportFieldMap *pFieldMap) {</span>
<a href="#l6.177"></a><span id="l6.177">   nsString lastName;</span>
<a href="#l6.178"></a><span id="l6.178">   nsString firstName;</span>
<a href="#l6.179"></a><span id="l6.179">   nsString eMail;</span>
<a href="#l6.180"></a><span id="l6.180">   nsString nickName;</span>
<a href="#l6.181"></a><span id="l6.181">   nsString middleName;</span>
<a href="#l6.182"></a><span id="l6.182">   nsString secondEMail;</span>
<a href="#l6.183"></a><span id="l6.183">   ULONG emailTag;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineat">@@ -804,62 +782,62 @@ bool nsOutlookMail::BuildCard(const char</span>
<a href="#l6.185"></a><span id="l6.185">         displayName.Append(lastName);</span>
<a href="#l6.186"></a><span id="l6.186">       }</span>
<a href="#l6.187"></a><span id="l6.187">     }</span>
<a href="#l6.188"></a><span id="l6.188">   }</span>
<a href="#l6.189"></a><span id="l6.189"> </span>
<a href="#l6.190"></a><span id="l6.190">   // We now have the required fields</span>
<a href="#l6.191"></a><span id="l6.191">   // write them out followed by any optional fields!</span>
<a href="#l6.192"></a><span id="l6.192">   if (!displayName.IsEmpty()) {</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    pDb-&gt;AddDisplayName(newRow, NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+    newCard-&gt;SetDisplayName(displayName);</span>
<a href="#l6.195"></a><span id="l6.195">   }</span>
<a href="#l6.196"></a><span id="l6.196">   if (!firstName.IsEmpty()) {</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-    pDb-&gt;AddFirstName(newRow, NS_ConvertUTF16toUTF8(firstName).get());</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+    newCard-&gt;SetFirstName(firstName);</span>
<a href="#l6.199"></a><span id="l6.199">   }</span>
<a href="#l6.200"></a><span id="l6.200">   if (!lastName.IsEmpty()) {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-    pDb-&gt;AddLastName(newRow, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+    newCard-&gt;SetLastName(lastName);</span>
<a href="#l6.203"></a><span id="l6.203">   }</span>
<a href="#l6.204"></a><span id="l6.204">   if (!nickName.IsEmpty()) {</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    pDb-&gt;AddNickName(newRow, NS_ConvertUTF16toUTF8(nickName).get());</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    newCard-&gt;SetPropertyAsAString(kNicknameProperty, nickName);</span>
<a href="#l6.207"></a><span id="l6.207">   }</span>
<a href="#l6.208"></a><span id="l6.208">   if (!eMail.IsEmpty()) {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-    pDb-&gt;AddPrimaryEmail(newRow, NS_ConvertUTF16toUTF8(eMail).get());</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+    newCard-&gt;SetPrimaryEmail(eMail);</span>
<a href="#l6.211"></a><span id="l6.211">   }</span>
<a href="#l6.212"></a><span id="l6.212">   if (!secondEMail.IsEmpty()) {</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-    pDb-&gt;Add2ndEmail(newRow, NS_ConvertUTF16toUTF8(secondEMail).get());</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    newCard-&gt;SetPropertyAsAString(k2ndEmailProperty, secondEMail);</span>
<a href="#l6.215"></a><span id="l6.215">   }</span>
<a href="#l6.216"></a><span id="l6.216"> </span>
<a href="#l6.217"></a><span id="l6.217">   // Do all of the extra fields!</span>
<a href="#l6.218"></a><span id="l6.218"> </span>
<a href="#l6.219"></a><span id="l6.219">   nsString value;</span>
<a href="#l6.220"></a><span id="l6.220">   nsString line2;</span>
<a href="#l6.221"></a><span id="l6.221"> </span>
<a href="#l6.222"></a><span id="l6.222">   if (pFieldMap) {</span>
<a href="#l6.223"></a><span id="l6.223">     int max = sizeof(gMapiFields) / sizeof(MAPIFields);</span>
<a href="#l6.224"></a><span id="l6.224">     for (int i = 0; i &lt; max; i++) {</span>
<a href="#l6.225"></a><span id="l6.225">       pProp = m_mapi.GetMapiProperty(pUser, gMapiFields[i].mapiTag);</span>
<a href="#l6.226"></a><span id="l6.226">       if (pProp) {</span>
<a href="#l6.227"></a><span id="l6.227">         m_mapi.GetStringFromProp(pProp, value);</span>
<a href="#l6.228"></a><span id="l6.228">         if (!value.IsEmpty()) {</span>
<a href="#l6.229"></a><span id="l6.229">           if (gMapiFields[i].multiLine == kNoMultiLine) {</span>
<a href="#l6.230"></a><span id="l6.230">             SanitizeValue(value);</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField,</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-                                     value.get());</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+            pFieldMap-&gt;SetFieldValue(pDirectory, newCard,</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+                                     gMapiFields[i].mozField, value);</span>
<a href="#l6.235"></a><span id="l6.235">           } else if (gMapiFields[i].multiLine == kIsMultiLine) {</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField,</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-                                     value.get());</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+            pFieldMap-&gt;SetFieldValue(pDirectory, newCard,</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+                                     gMapiFields[i].mozField, value);</span>
<a href="#l6.240"></a><span id="l6.240">           } else {</span>
<a href="#l6.241"></a><span id="l6.241">             line2.Truncate();</span>
<a href="#l6.242"></a><span id="l6.242">             SplitString(value, line2);</span>
<a href="#l6.243"></a><span id="l6.243">             if (!value.IsEmpty())</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField,</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-                                       value.get());</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(pDirectory, newCard,</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+                                       gMapiFields[i].mozField, value);</span>
<a href="#l6.248"></a><span id="l6.248">             if (!line2.IsEmpty())</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].multiLine,</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-                                       line2.get());</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(pDirectory, newCard,</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+                                       gMapiFields[i].multiLine, line2);</span>
<a href="#l6.253"></a><span id="l6.253">           }</span>
<a href="#l6.254"></a><span id="l6.254">         }</span>
<a href="#l6.255"></a><span id="l6.255">       }</span>
<a href="#l6.256"></a><span id="l6.256">     }</span>
<a href="#l6.257"></a><span id="l6.257">   }</span>
<a href="#l6.258"></a><span id="l6.258"> </span>
<a href="#l6.259"></a><span id="l6.259">   return true;</span>
<a href="#l6.260"></a><span id="l6.260"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -7,46 +7,46 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #define nsOutlookMail_h___</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIArray.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsString.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsOutlookCompose.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;MapiApi.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;MapiMessage.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-class nsIAddrDatabase;</span>
<a href="#l7.17"></a><span id="l7.17"> class nsIImportFieldMap;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> class nsOutlookMail {</span>
<a href="#l7.20"></a><span id="l7.20">  public:</span>
<a href="#l7.21"></a><span id="l7.21">   nsOutlookMail();</span>
<a href="#l7.22"></a><span id="l7.22">   ~nsOutlookMail();</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   nsresult GetMailFolders(nsIArray **pArray);</span>
<a href="#l7.25"></a><span id="l7.25">   nsresult GetAddressBooks(nsIArray **pArray);</span>
<a href="#l7.26"></a><span id="l7.26">   nsresult ImportMailbox(uint32_t *pDoneSoFar, bool *pAbort, int32_t index,</span>
<a href="#l7.27"></a><span id="l7.27">                          const char16_t *pName, nsIMsgFolder *pDest,</span>
<a href="#l7.28"></a><span id="l7.28">                          int32_t *pMsgCount);</span>
<a href="#l7.29"></a><span id="l7.29">   nsresult ImportAddresses(uint32_t *pCount, uint32_t *pTotal,</span>
<a href="#l7.30"></a><span id="l7.30">                            const char16_t *pName, uint32_t id,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                           nsIAddrDatabase *pDb, nsString &amp;errors);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+                           nsIAbDirectory *pDirectory, nsString &amp;errors);</span>
<a href="#l7.33"></a><span id="l7.33">   void OpenMessageStore(CMapiFolder *pNextFolder);</span>
<a href="#l7.34"></a><span id="l7.34">   static BOOL WriteData(nsIOutputStream *pDest, const char *pData, int32_t len);</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">  private:</span>
<a href="#l7.37"></a><span id="l7.37">   bool IsAddressBookNameUnique(nsString &amp;name, nsString &amp;list);</span>
<a href="#l7.38"></a><span id="l7.38">   void MakeAddressBookNameUnique(nsString &amp;name, nsString &amp;list);</span>
<a href="#l7.39"></a><span id="l7.39">   void SanitizeValue(nsString &amp;val);</span>
<a href="#l7.40"></a><span id="l7.40">   void SplitString(nsString &amp;val1, nsString &amp;val2);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  bool BuildCard(const char16_t *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-                 LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  nsresult CreateList(const char16_t *pName, nsIAddrDatabase *pDb,</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  bool BuildCard(const char16_t *pName, nsIAbDirectory *pDirectory,</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+                 nsIAbCard *newCard, LPMAPIPROP pUser,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                 nsIImportFieldMap *pFieldMap);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  nsresult CreateList(const nsString &amp;pName, nsIAbDirectory *pDirectory,</span>
<a href="#l7.48"></a><span id="l7.48">                       LPMAPIPROP pUserList, nsIImportFieldMap *pFieldMap);</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50">  private:</span>
<a href="#l7.51"></a><span id="l7.51">   bool m_gotFolders;</span>
<a href="#l7.52"></a><span id="l7.52">   bool m_gotAddresses;</span>
<a href="#l7.53"></a><span id="l7.53">   bool m_haveMapi;</span>
<a href="#l7.54"></a><span id="l7.54">   CMapiFolderList m_addressList;</span>
<a href="#l7.55"></a><span id="l7.55">   CMapiFolderList m_storeList;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/import/public/nsIImportAddressBooks.idl</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/import/public/nsIImportAddressBooks.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -30,17 +30,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">   4) All done, maybe a what was done panel??</span>
<a href="#l8.5"></a><span id="l8.5"> */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> interface nsIFile;</span>
<a href="#l8.10"></a><span id="l8.10"> interface nsIArray;</span>
<a href="#l8.11"></a><span id="l8.11"> interface nsIImportABDescriptor;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-interface nsIAddrDatabase;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+interface nsIAbDirectory;</span>
<a href="#l8.14"></a><span id="l8.14"> interface nsIImportFieldMap;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> [scriptable, uuid(6bba48be-331c-41e3-bc9f-c2ea3754d977)]</span>
<a href="#l8.17"></a><span id="l8.17"> interface nsIImportAddressBooks : nsISupports</span>
<a href="#l8.18"></a><span id="l8.18"> {</span>
<a href="#l8.19"></a><span id="l8.19">   /*</span>
<a href="#l8.20"></a><span id="l8.20">     Does this interface supports 1 or 1..n address books.  You only</span>
<a href="#l8.21"></a><span id="l8.21">     get to choose 1 location so for formats where 1..n address books</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -103,17 +103,17 @@ interface nsIImportAddressBooks : nsISup</span>
<a href="#l8.23"></a><span id="l8.23">    *                        acceptable if it is not required), may be required</span>
<a href="#l8.24"></a><span id="l8.24">    *                        for certain import types (e.g. nsIAbLDIFService for</span>
<a href="#l8.25"></a><span id="l8.25">    *                        LDIF import).</span>
<a href="#l8.26"></a><span id="l8.26">    * @param aErrorLog       The error log from the import.</span>
<a href="#l8.27"></a><span id="l8.27">    * @param aSuccessLog     The success log from the import.</span>
<a href="#l8.28"></a><span id="l8.28">    * @param aFatalError     True if there was a fatal error doing the import.</span>
<a href="#l8.29"></a><span id="l8.29">    */</span>
<a href="#l8.30"></a><span id="l8.30">   void ImportAddressBook(in nsIImportABDescriptor aSource,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                         in nsIAddrDatabase aDestination,</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+                         in nsIAbDirectory aDestination,</span>
<a href="#l8.33"></a><span id="l8.33">                          in nsIImportFieldMap aFieldMap,</span>
<a href="#l8.34"></a><span id="l8.34">                          in nsISupports aSupportService,</span>
<a href="#l8.35"></a><span id="l8.35">                          out wstring aErrorLog,</span>
<a href="#l8.36"></a><span id="l8.36">                          out wstring aSuccessLog,</span>
<a href="#l8.37"></a><span id="l8.37">                          out boolean aFatalError);</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   /*</span>
<a href="#l8.40"></a><span id="l8.40">     Return the amount of the address book that has been imported so far.  This number</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/import/public/nsIImportFieldMap.idl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/import/public/nsIImportFieldMap.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -10,21 +10,18 @@</span>
<a href="#l9.4"></a><span id="l9.4">   The field map is used by import to map fields from the import format</span>
<a href="#l9.5"></a><span id="l9.5">   to mozilla fields.</span>
<a href="#l9.6"></a><span id="l9.6">   For export, the map contains the ordered list of mozilla fields to</span>
<a href="#l9.7"></a><span id="l9.7">   export!</span>
<a href="#l9.8"></a><span id="l9.8"> */</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-interface nsIAddrDatabase;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-[ptr] native nsIMdbRow (nsIMdbRow);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-%{C++</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-class nsIMdbRow;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-%}</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+interface nsIAbCard;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+interface nsIAbDirectory;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> [scriptable, uuid(deee9264-1fe3-47b1-b745-47b22de454e2)]</span>
<a href="#l9.21"></a><span id="l9.21"> interface nsIImportFieldMap : nsISupports</span>
<a href="#l9.22"></a><span id="l9.22"> {</span>
<a href="#l9.23"></a><span id="l9.23">   /*</span>
<a href="#l9.24"></a><span id="l9.24">     Flag to indicate whether or not to skip the first record,</span>
<a href="#l9.25"></a><span id="l9.25">     for instance csv files often have field names as the first</span>
<a href="#l9.26"></a><span id="l9.26">     record</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineat">@@ -65,10 +62,10 @@ interface nsIImportFieldMap : nsISupport</span>
<a href="#l9.28"></a><span id="l9.28">   /*</span>
<a href="#l9.29"></a><span id="l9.29">     Set the active state of this field</span>
<a href="#l9.30"></a><span id="l9.30">   */</span>
<a href="#l9.31"></a><span id="l9.31">   void SetFieldActive(in long index, in boolean active);</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33">   /*</span>
<a href="#l9.34"></a><span id="l9.34">     Set the value of the given field in the database row</span>
<a href="#l9.35"></a><span id="l9.35">   */</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  void SetFieldValue(in nsIAddrDatabase database, in nsIMdbRow row, in long fieldNum, in wstring value);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  void SetFieldValue(in nsIAbDirectory database, in nsIAbCard row, in long fieldNum, in AString value);</span>
<a href="#l9.38"></a><span id="l9.38"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -10,18 +10,18 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;msgCore.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+#include &quot;nsDirPrefs.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> nsresult NS_NewGenericAddressBooks(nsIImportGeneric **aImportGeneric) {</span>
<a href="#l10.17"></a><span id="l10.17">   NS_ASSERTION(aImportGeneric != nullptr, &quot;null ptr&quot;);</span>
<a href="#l10.18"></a><span id="l10.18">   if (!aImportGeneric) return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">   RefPtr&lt;nsImportGenericAddressBooks&gt; pGen = new nsImportGenericAddressBooks();</span>
<a href="#l10.21"></a><span id="l10.21">   return pGen-&gt;QueryInterface(NS_GET_IID(nsIImportGeneric),</span>
<a href="#l10.22"></a><span id="l10.22">                               (void **)aImportGeneric);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -315,110 +315,52 @@ void nsImportGenericAddressBooks::SetLog</span>
<a href="#l10.24"></a><span id="l10.24">   }</span>
<a href="#l10.25"></a><span id="l10.25">   if (pError) {</span>
<a href="#l10.26"></a><span id="l10.26">     pError-&gt;GetData(str);</span>
<a href="#l10.27"></a><span id="l10.27">     str.Append(error);</span>
<a href="#l10.28"></a><span id="l10.28">     pError-&gt;SetData(error);</span>
<a href="#l10.29"></a><span id="l10.29">   }</span>
<a href="#l10.30"></a><span id="l10.30"> }</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBookFromUri(const char *pUri) {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+already_AddRefed&lt;nsIAbDirectory&gt; GetAddressBookFromUri(const char *pUri) {</span>
<a href="#l10.34"></a><span id="l10.34">   if (!pUri) return nullptr;</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID);</span>
<a href="#l10.37"></a><span id="l10.37">   if (!abManager) return nullptr;</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l10.40"></a><span id="l10.40">   abManager-&gt;GetDirectory(nsDependentCString(pUri), getter_AddRefs(directory));</span>
<a href="#l10.41"></a><span id="l10.41">   if (!directory) return nullptr;</span>
<a href="#l10.42"></a><span id="l10.42"> </span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDirectory = do_QueryInterface(directory);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  if (!mdbDirectory) return nullptr;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; pDatabase;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  mdbDirectory-&gt;GetDatabase(getter_AddRefs(pDatabase));</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  return pDatabase.forget();</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  return directory.forget();</span>
<a href="#l10.50"></a><span id="l10.50"> }</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBook(const char16_t *name,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-                                                 bool makeNew) {</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+already_AddRefed&lt;nsIAbDirectory&gt; GetAddressBook(nsString name, bool makeNew) {</span>
<a href="#l10.55"></a><span id="l10.55">   if (!makeNew) {</span>
<a href="#l10.56"></a><span id="l10.56">     // FIXME: How do I get the list of address books and look for a</span>
<a href="#l10.57"></a><span id="l10.57">     // specific name.  Major bogosity!</span>
<a href="#l10.58"></a><span id="l10.58">     // For now, assume we didn't find anything with that name</span>
<a href="#l10.59"></a><span id="l10.59">   }</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61">   IMPORT_LOG0(&quot;In GetAddressBook\n&quot;);</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">   nsresult rv;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; pDatabase;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l10.67"></a><span id="l10.67">   nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l10.68"></a><span id="l10.68">       do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.69"></a><span id="l10.69">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-    /* Get the profile directory */</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    nsAutoCString dirPrefId;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    rv = abManager-&gt;NewAddressBook(name, EmptyCString(), JSDirectory,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+                                   EmptyCString(), dirPrefId);</span>
<a href="#l10.75"></a><span id="l10.75">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-      // Create a new address book file - we don't care what the file</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-      // name is, as long as it's unique</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-      rv = dbPath-&gt;Append(NS_LITERAL_STRING(&quot;impab.mab&quot;));</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-        rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-          IMPORT_LOG0(&quot;Getting the address database factory\n&quot;);</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-          nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-              do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-          if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-          IMPORT_LOG0(&quot;Opening the new address book\n&quot;);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-          rv = addrDBFactory-&gt;Open(dbPath, true, true,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-                                   getter_AddRefs(pDatabase));</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-        }</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-      }</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+      rv = abManager-&gt;GetDirectoryFromId(dirPrefId, getter_AddRefs(directory));</span>
<a href="#l10.95"></a><span id="l10.95">     }</span>
<a href="#l10.96"></a><span id="l10.96">   }</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-    IMPORT_LOG0(</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-        &quot;Failed to get the user profile directory from the address book &quot;</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-        &quot;session\n&quot;);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-  }</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-  if (pDatabase &amp;&amp; dbPath) {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-    // We made a database, add it to the UI?!?!?!?!?!?!</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-    // This is major bogosity again!  Why doesn't the address book</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-    // just handle this properly for me?  Uggggg...</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-    abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-                            getter_AddRefs(parentDir));</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-    if (parentDir) {</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-      nsAutoCString URI(&quot;moz-abmdbdirectory://&quot;);</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-      nsAutoCString leafName;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-      rv = dbPath-&gt;GetNativeLeafName(leafName);</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error: Unable to get name of database file\n&quot;);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-      else {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-        URI.Append(leafName);</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-        rv = parentDir-&gt;CreateDirectoryByURI(nsDependentString(name), URI);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-          IMPORT_LOG0(&quot;*** Error: Unable to create address book directory\n&quot;);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-      }</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-    }</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-      IMPORT_LOG0(&quot;Added new address book to the UI\n&quot;);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-    else</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-      IMPORT_LOG0(</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-          &quot;*** Error: An error occurred while adding the address book to the &quot;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-          &quot;UI\n&quot;);</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  }</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-  return pDatabase.forget();</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+  return directory.forget();</span>
<a href="#l10.135"></a><span id="l10.135"> }</span>
<a href="#l10.136"></a><span id="l10.136"> </span>
<a href="#l10.137"></a><span id="l10.137"> NS_IMETHODIMP nsImportGenericAddressBooks::BeginImport(</span>
<a href="#l10.138"></a><span id="l10.138">     nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval) {</span>
<a href="#l10.139"></a><span id="l10.139">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l10.140"></a><span id="l10.140">   if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.141"></a><span id="l10.141"> </span>
<a href="#l10.142"></a><span id="l10.142">   nsString success;</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineat">@@ -465,24 +407,24 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l10.144"></a><span id="l10.144">   m_pThreadData-&gt;successLog = m_pSuccessLog;</span>
<a href="#l10.145"></a><span id="l10.145">   m_pThreadData-&gt;pDestinationUri = m_pDestinationUri;</span>
<a href="#l10.146"></a><span id="l10.146"> </span>
<a href="#l10.147"></a><span id="l10.147">   uint32_t count = 0;</span>
<a href="#l10.148"></a><span id="l10.148">   m_Books-&gt;GetLength(&amp;count);</span>
<a href="#l10.149"></a><span id="l10.149">   // Create/obtain any address books that we need here, so that we don't need</span>
<a href="#l10.150"></a><span id="l10.150">   // to do so inside the import thread which would just proxy the create</span>
<a href="#l10.151"></a><span id="l10.151">   // operations back to the main thread anyway.</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; db = GetAddressBookFromUri(m_pDestinationUri.get());</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; db = GetAddressBookFromUri(m_pDestinationUri.get());</span>
<a href="#l10.154"></a><span id="l10.154">   for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l10.155"></a><span id="l10.155">     nsCOMPtr&lt;nsIImportABDescriptor&gt; book = do_QueryElementAt(m_Books, i);</span>
<a href="#l10.156"></a><span id="l10.156">     if (book) {</span>
<a href="#l10.157"></a><span id="l10.157">       if (!db) {</span>
<a href="#l10.158"></a><span id="l10.158">         nsString name;</span>
<a href="#l10.159"></a><span id="l10.159">         book-&gt;GetPreferredName(name);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-        db = GetAddressBook(name.get(), true);</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+        db = GetAddressBook(name, true);</span>
<a href="#l10.162"></a><span id="l10.162">       }</span>
<a href="#l10.163"></a><span id="l10.163">       m_DBs.AppendObject(db);</span>
<a href="#l10.164"></a><span id="l10.164">     }</span>
<a href="#l10.165"></a><span id="l10.165">   }</span>
<a href="#l10.166"></a><span id="l10.166">   m_pThreadData-&gt;dBs = &amp;m_DBs;</span>
<a href="#l10.167"></a><span id="l10.167"> </span>
<a href="#l10.168"></a><span id="l10.168">   m_pThreadData-&gt;stringBundle = m_stringBundle;</span>
<a href="#l10.169"></a><span id="l10.169"> </span>
<a href="#l10.170"></a><span id="l10.170" class="difflineat">@@ -596,17 +538,17 @@ static void ImportAddressThread(void *st</span>
<a href="#l10.171"></a><span id="l10.171">       size = 0;</span>
<a href="#l10.172"></a><span id="l10.172">       nsresult rv = book-&gt;GetImport(&amp;import);</span>
<a href="#l10.173"></a><span id="l10.173">       if (NS_SUCCEEDED(rv) &amp;&amp; import) rv = book-&gt;GetSize(&amp;size);</span>
<a href="#l10.174"></a><span id="l10.174"> </span>
<a href="#l10.175"></a><span id="l10.175">       if (NS_SUCCEEDED(rv) &amp;&amp; size &amp;&amp; import) {</span>
<a href="#l10.176"></a><span id="l10.176">         nsString name;</span>
<a href="#l10.177"></a><span id="l10.177">         book-&gt;GetPreferredName(name);</span>
<a href="#l10.178"></a><span id="l10.178"> </span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-        nsCOMPtr&lt;nsIAddrDatabase&gt; db = pData-&gt;dBs-&gt;ObjectAt(i);</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+        nsCOMPtr&lt;nsIAbDirectory&gt; db = pData-&gt;dBs-&gt;ObjectAt(i);</span>
<a href="#l10.181"></a><span id="l10.181"> </span>
<a href="#l10.182"></a><span id="l10.182">         bool fatalError = false;</span>
<a href="#l10.183"></a><span id="l10.183">         pData-&gt;currentSize = size;</span>
<a href="#l10.184"></a><span id="l10.184">         if (db) {</span>
<a href="#l10.185"></a><span id="l10.185">           char16_t *pSuccess = nullptr;</span>
<a href="#l10.186"></a><span id="l10.186">           char16_t *pError = nullptr;</span>
<a href="#l10.187"></a><span id="l10.187"> </span>
<a href="#l10.188"></a><span id="l10.188">           /*</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineat">@@ -639,18 +581,16 @@ static void ImportAddressThread(void *st</span>
<a href="#l10.190"></a><span id="l10.190">         } else {</span>
<a href="#l10.191"></a><span id="l10.191">           nsImportGenericAddressBooks::ReportError(name.get(), &amp;error,</span>
<a href="#l10.192"></a><span id="l10.192">                                                    pData-&gt;stringBundle);</span>
<a href="#l10.193"></a><span id="l10.193">         }</span>
<a href="#l10.194"></a><span id="l10.194"> </span>
<a href="#l10.195"></a><span id="l10.195">         pData-&gt;currentSize = 0;</span>
<a href="#l10.196"></a><span id="l10.196">         pData-&gt;currentTotal += size;</span>
<a href="#l10.197"></a><span id="l10.197"> </span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-        if (db) db-&gt;Close(true);</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-</span>
<a href="#l10.200"></a><span id="l10.200">         if (fatalError) {</span>
<a href="#l10.201"></a><span id="l10.201">           pData-&gt;fatalError = true;</span>
<a href="#l10.202"></a><span id="l10.202">           break;</span>
<a href="#l10.203"></a><span id="l10.203">         }</span>
<a href="#l10.204"></a><span id="l10.204">       }</span>
<a href="#l10.205"></a><span id="l10.205">     }</span>
<a href="#l10.206"></a><span id="l10.206">   }</span>
<a href="#l10.207"></a><span id="l10.207"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/import/src/nsImportAddressBooks.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/import/src/nsImportAddressBooks.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsString.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIFile.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsIAbLDIFService.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsIArray.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> static void ImportAddressThread(void *stuff);</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> class AddressThreadData;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -36,17 +36,17 @@ class nsImportGenericAddressBooks : publ</span>
<a href="#l11.23"></a><span id="l11.23">   static void SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l11.24"></a><span id="l11.24">                       nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l11.25"></a><span id="l11.25">   static void ReportError(const char16_t *pName, nsString *pStream,</span>
<a href="#l11.26"></a><span id="l11.26">                           nsIStringBundle *aBundle);</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">  private:</span>
<a href="#l11.29"></a><span id="l11.29">   nsCOMPtr&lt;nsIImportAddressBooks&gt; m_pInterface;</span>
<a href="#l11.30"></a><span id="l11.30">   nsCOMPtr&lt;nsIArray&gt; m_Books;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  nsCOMArray&lt;nsIAddrDatabase&gt; m_DBs;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  nsCOMArray&lt;nsIAbDirectory&gt; m_DBs;</span>
<a href="#l11.33"></a><span id="l11.33">   nsCOMPtr&lt;nsIFile&gt; m_pLocation;</span>
<a href="#l11.34"></a><span id="l11.34">   nsCOMPtr&lt;nsIImportFieldMap&gt; m_pFieldMap;</span>
<a href="#l11.35"></a><span id="l11.35">   bool m_autoFind;</span>
<a href="#l11.36"></a><span id="l11.36">   char16_t *m_description;</span>
<a href="#l11.37"></a><span id="l11.37">   bool m_gotLocation;</span>
<a href="#l11.38"></a><span id="l11.38">   bool m_found;</span>
<a href="#l11.39"></a><span id="l11.39">   bool m_userVerify;</span>
<a href="#l11.40"></a><span id="l11.40">   nsCOMPtr&lt;nsISupportsString&gt; m_pSuccessLog;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -62,17 +62,17 @@ class AddressThreadData {</span>
<a href="#l11.42"></a><span id="l11.42">  public:</span>
<a href="#l11.43"></a><span id="l11.43">   bool driverAlive;</span>
<a href="#l11.44"></a><span id="l11.44">   bool threadAlive;</span>
<a href="#l11.45"></a><span id="l11.45">   bool abort;</span>
<a href="#l11.46"></a><span id="l11.46">   bool fatalError;</span>
<a href="#l11.47"></a><span id="l11.47">   uint32_t currentTotal;</span>
<a href="#l11.48"></a><span id="l11.48">   uint32_t currentSize;</span>
<a href="#l11.49"></a><span id="l11.49">   nsCOMPtr&lt;nsIArray&gt; books;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  nsCOMArray&lt;nsIAddrDatabase&gt; *dBs;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  nsCOMArray&lt;nsIAbDirectory&gt; *dBs;</span>
<a href="#l11.52"></a><span id="l11.52">   nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService;</span>
<a href="#l11.53"></a><span id="l11.53">   nsCOMPtr&lt;nsIImportAddressBooks&gt; addressImport;</span>
<a href="#l11.54"></a><span id="l11.54">   nsCOMPtr&lt;nsIImportFieldMap&gt; fieldMap;</span>
<a href="#l11.55"></a><span id="l11.55">   nsCOMPtr&lt;nsISupportsString&gt; successLog;</span>
<a href="#l11.56"></a><span id="l11.56">   nsCOMPtr&lt;nsISupportsString&gt; errorLog;</span>
<a href="#l11.57"></a><span id="l11.57">   nsCString pDestinationUri;</span>
<a href="#l11.58"></a><span id="l11.58">   nsCOMPtr&lt;nsIStringBundle&gt; stringBundle;</span>
<a href="#l11.59"></a><span id="l11.59"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.5"></a><span id="l12.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nscore.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+#include &quot;nsIAbCard.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12"> #include &quot;nsImportFieldMap.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineat">@@ -155,155 +156,145 @@ NS_IMETHODIMP nsImportFieldMap::GetField</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> NS_IMETHODIMP nsImportFieldMap::SetFieldActive(int32_t index, bool active) {</span>
<a href="#l12.22"></a><span id="l12.22">   if ((index &lt; 0) || (index &gt;= m_numFields)) return NS_ERROR_FAILURE;</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24">   m_pActive[index] = active;</span>
<a href="#l12.25"></a><span id="l12.25">   return NS_OK;</span>
<a href="#l12.26"></a><span id="l12.26"> }</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::SetFieldValue(nsIAddrDatabase *database,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                                              nsIMdbRow *row, int32_t fieldNum,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-                                              const char16_t *value) {</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  NS_ASSERTION(database != nullptr, &quot;null ptr&quot;);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  NS_ASSERTION(row != nullptr, &quot;null ptr&quot;);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  NS_ASSERTION(value != nullptr, &quot;null ptr&quot;);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  if (!database || !row || !value) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::SetFieldValue(nsIAbDirectory *database,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+                                              nsIAbCard *row, int32_t fieldNum,</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+                                              const nsAString &amp;value) {</span>
<a href="#l12.39"></a><span id="l12.39">   // Allow the special value for a null field</span>
<a href="#l12.40"></a><span id="l12.40">   if (fieldNum == -1) return NS_OK;</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42">   if ((fieldNum &lt; 0) || (fieldNum &gt;= m_mozFieldCount)) return NS_ERROR_FAILURE;</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44">   // UGGG!!!!! lot's of typing here!</span>
<a href="#l12.45"></a><span id="l12.45">   nsresult rv;</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  nsString str(value);</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  char *pVal = ToNewUTF8String(str);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-</span>
<a href="#l12.50"></a><span id="l12.50">   switch (fieldNum) {</span>
<a href="#l12.51"></a><span id="l12.51">     case 0:</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-      rv = database-&gt;AddFirstName(row, pVal);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+      rv = row-&gt;SetFirstName(value);</span>
<a href="#l12.54"></a><span id="l12.54">       break;</span>
<a href="#l12.55"></a><span id="l12.55">     case 1:</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-      rv = database-&gt;AddLastName(row, pVal);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+      rv = row-&gt;SetLastName(value);</span>
<a href="#l12.58"></a><span id="l12.58">       break;</span>
<a href="#l12.59"></a><span id="l12.59">     case 2:</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-      rv = database-&gt;AddDisplayName(row, pVal);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+      rv = row-&gt;SetDisplayName(value);</span>
<a href="#l12.62"></a><span id="l12.62">       break;</span>
<a href="#l12.63"></a><span id="l12.63">     case 3:</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-      rv = database-&gt;AddNickName(row, pVal);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kNicknameProperty, value);</span>
<a href="#l12.66"></a><span id="l12.66">       break;</span>
<a href="#l12.67"></a><span id="l12.67">     case 4:</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-      rv = database-&gt;AddPrimaryEmail(row, pVal);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+      rv = row-&gt;SetPrimaryEmail(value);</span>
<a href="#l12.70"></a><span id="l12.70">       break;</span>
<a href="#l12.71"></a><span id="l12.71">     case 5:</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-      rv = database-&gt;Add2ndEmail(row, pVal);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(k2ndEmailProperty, value);</span>
<a href="#l12.74"></a><span id="l12.74">       break;</span>
<a href="#l12.75"></a><span id="l12.75">     case 6:</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-      rv = database-&gt;AddWorkPhone(row, pVal);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkPhoneProperty, value);</span>
<a href="#l12.78"></a><span id="l12.78">       break;</span>
<a href="#l12.79"></a><span id="l12.79">     case 7:</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-      rv = database-&gt;AddHomePhone(row, pVal);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomePhoneProperty, value);</span>
<a href="#l12.82"></a><span id="l12.82">       break;</span>
<a href="#l12.83"></a><span id="l12.83">     case 8:</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-      rv = database-&gt;AddFaxNumber(row, pVal);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kFaxProperty, value);</span>
<a href="#l12.86"></a><span id="l12.86">       break;</span>
<a href="#l12.87"></a><span id="l12.87">     case 9:</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-      rv = database-&gt;AddPagerNumber(row, pVal);</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kPagerProperty, value);</span>
<a href="#l12.90"></a><span id="l12.90">       break;</span>
<a href="#l12.91"></a><span id="l12.91">     case 10:</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-      rv = database-&gt;AddCellularNumber(row, pVal);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kCellularProperty, value);</span>
<a href="#l12.94"></a><span id="l12.94">       break;</span>
<a href="#l12.95"></a><span id="l12.95">     case 11:</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-      rv = database-&gt;AddHomeAddress(row, pVal);</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomeAddressProperty, value);</span>
<a href="#l12.98"></a><span id="l12.98">       break;</span>
<a href="#l12.99"></a><span id="l12.99">     case 12:</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-      rv = database-&gt;AddHomeAddress2(row, pVal);</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomeAddress2Property, value);</span>
<a href="#l12.102"></a><span id="l12.102">       break;</span>
<a href="#l12.103"></a><span id="l12.103">     case 13:</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-      rv = database-&gt;AddHomeCity(row, pVal);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomeCityProperty, value);</span>
<a href="#l12.106"></a><span id="l12.106">       break;</span>
<a href="#l12.107"></a><span id="l12.107">     case 14:</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-      rv = database-&gt;AddHomeState(row, pVal);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomeStateProperty, value);</span>
<a href="#l12.110"></a><span id="l12.110">       break;</span>
<a href="#l12.111"></a><span id="l12.111">     case 15:</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-      rv = database-&gt;AddHomeZipCode(row, pVal);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomeZipCodeProperty, value);</span>
<a href="#l12.114"></a><span id="l12.114">       break;</span>
<a href="#l12.115"></a><span id="l12.115">     case 16:</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-      rv = database-&gt;AddHomeCountry(row, pVal);</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomeCountryProperty, value);</span>
<a href="#l12.118"></a><span id="l12.118">       break;</span>
<a href="#l12.119"></a><span id="l12.119">     case 17:</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-      rv = database-&gt;AddWorkAddress(row, pVal);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkAddressProperty, value);</span>
<a href="#l12.122"></a><span id="l12.122">       break;</span>
<a href="#l12.123"></a><span id="l12.123">     case 18:</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-      rv = database-&gt;AddWorkAddress2(row, pVal);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkAddress2Property, value);</span>
<a href="#l12.126"></a><span id="l12.126">       break;</span>
<a href="#l12.127"></a><span id="l12.127">     case 19:</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-      rv = database-&gt;AddWorkCity(row, pVal);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkCityProperty, value);</span>
<a href="#l12.130"></a><span id="l12.130">       break;</span>
<a href="#l12.131"></a><span id="l12.131">     case 20:</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-      rv = database-&gt;AddWorkState(row, pVal);</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkStateProperty, value);</span>
<a href="#l12.134"></a><span id="l12.134">       break;</span>
<a href="#l12.135"></a><span id="l12.135">     case 21:</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-      rv = database-&gt;AddWorkZipCode(row, pVal);</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkZipCodeProperty, value);</span>
<a href="#l12.138"></a><span id="l12.138">       break;</span>
<a href="#l12.139"></a><span id="l12.139">     case 22:</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">-      rv = database-&gt;AddWorkCountry(row, pVal);</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkCountryProperty, value);</span>
<a href="#l12.142"></a><span id="l12.142">       break;</span>
<a href="#l12.143"></a><span id="l12.143">     case 23:</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-      rv = database-&gt;AddJobTitle(row, pVal);</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kJobTitleProperty, value);</span>
<a href="#l12.146"></a><span id="l12.146">       break;</span>
<a href="#l12.147"></a><span id="l12.147">     case 24:</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-      rv = database-&gt;AddDepartment(row, pVal);</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kDepartmentProperty, value);</span>
<a href="#l12.150"></a><span id="l12.150">       break;</span>
<a href="#l12.151"></a><span id="l12.151">     case 25:</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-      rv = database-&gt;AddCompany(row, pVal);</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kCompanyProperty, value);</span>
<a href="#l12.154"></a><span id="l12.154">       break;</span>
<a href="#l12.155"></a><span id="l12.155">     case 26:</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-      rv = database-&gt;AddWebPage1(row, pVal);</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kWorkWebPageProperty, value);</span>
<a href="#l12.158"></a><span id="l12.158">       break;</span>
<a href="#l12.159"></a><span id="l12.159">     case 27:</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-      rv = database-&gt;AddWebPage2(row, pVal);</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kHomeWebPageProperty, value);</span>
<a href="#l12.162"></a><span id="l12.162">       break;</span>
<a href="#l12.163"></a><span id="l12.163">     case 28:</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-      rv = database-&gt;AddBirthYear(row, pVal);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kBirthYearProperty, value);</span>
<a href="#l12.166"></a><span id="l12.166">       break;</span>
<a href="#l12.167"></a><span id="l12.167">     case 29:</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-      rv = database-&gt;AddBirthMonth(row, pVal);</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kBirthMonthProperty, value);</span>
<a href="#l12.170"></a><span id="l12.170">       break;</span>
<a href="#l12.171"></a><span id="l12.171">     case 30:</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-      rv = database-&gt;AddBirthDay(row, pVal);</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kBirthDayProperty, value);</span>
<a href="#l12.174"></a><span id="l12.174">       break;</span>
<a href="#l12.175"></a><span id="l12.175">     case 31:</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-      rv = database-&gt;AddCustom1(row, pVal);</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kCustom1Property, value);</span>
<a href="#l12.178"></a><span id="l12.178">       break;</span>
<a href="#l12.179"></a><span id="l12.179">     case 32:</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-      rv = database-&gt;AddCustom2(row, pVal);</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kCustom2Property, value);</span>
<a href="#l12.182"></a><span id="l12.182">       break;</span>
<a href="#l12.183"></a><span id="l12.183">     case 33:</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-      rv = database-&gt;AddCustom3(row, pVal);</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kCustom3Property, value);</span>
<a href="#l12.186"></a><span id="l12.186">       break;</span>
<a href="#l12.187"></a><span id="l12.187">     case 34:</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineminus">-      rv = database-&gt;AddCustom4(row, pVal);</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kCustom4Property, value);</span>
<a href="#l12.190"></a><span id="l12.190">       break;</span>
<a href="#l12.191"></a><span id="l12.191">     case 35:</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-      rv = database-&gt;AddNotes(row, pVal);</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kNotesProperty, value);</span>
<a href="#l12.194"></a><span id="l12.194">       break;</span>
<a href="#l12.195"></a><span id="l12.195">     case 36:</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-      rv = database-&gt;AddAimScreenName(row, pVal);</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+      rv = row-&gt;SetPropertyAsAString(kAIMProperty, value);</span>
<a href="#l12.198"></a><span id="l12.198">       break;</span>
<a href="#l12.199"></a><span id="l12.199">     default:</span>
<a href="#l12.200"></a><span id="l12.200">       /* Get the field description, and add it as an anonymous attr? */</span>
<a href="#l12.201"></a><span id="l12.201">       /* OR WHAT???? */</span>
<a href="#l12.202"></a><span id="l12.202">       { rv = NS_ERROR_FAILURE; }</span>
<a href="#l12.203"></a><span id="l12.203">   }</span>
<a href="#l12.204"></a><span id="l12.204"> </span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-  free(pVal);</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-</span>
<a href="#l12.207"></a><span id="l12.207">   return rv;</span>
<a href="#l12.208"></a><span id="l12.208"> }</span>
<a href="#l12.209"></a><span id="l12.209"> </span>
<a href="#l12.210"></a><span id="l12.210"> nsresult nsImportFieldMap::Allocate(int32_t newSize) {</span>
<a href="#l12.211"></a><span id="l12.211">   if (newSize &lt;= m_allocated) return NS_OK;</span>
<a href="#l12.212"></a><span id="l12.212"> </span>
<a href="#l12.213"></a><span id="l12.213">   int32_t sz = m_allocated;</span>
<a href="#l12.214"></a><span id="l12.214">   while (sz &lt; newSize) sz += 30;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/import/src/nsImportFieldMap.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/import/src/nsImportFieldMap.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -3,17 +3,16 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.5"></a><span id="l13.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> #ifndef nsImportFieldMap_h___</span>
<a href="#l13.8"></a><span id="l13.8"> #define nsImportFieldMap_h___</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nscore.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;  // For SetFieldValue() arguments</span>
<a href="#l13.13"></a><span id="l13.13"> #include &quot;nsTArray.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsString.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> class nsIStringBundle;</span>
<a href="#l13.20"></a><span id="l13.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/test/unit/xpcshell.ini</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/test/unit/xpcshell.ini</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -8,16 +8,15 @@ support-files = resources/*</span>
<a href="#l14.4"></a><span id="l14.4"> [test_csv_GetSample.js]</span>
<a href="#l14.5"></a><span id="l14.5"> [test_becky_addressbook.js]</span>
<a href="#l14.6"></a><span id="l14.6"> run-if = os == 'win'</span>
<a href="#l14.7"></a><span id="l14.7"> [test_becky_filters.js]</span>
<a href="#l14.8"></a><span id="l14.8"> run-if = os == 'win'</span>
<a href="#l14.9"></a><span id="l14.9"> [test_csv_import.js]</span>
<a href="#l14.10"></a><span id="l14.10"> [test_csv_import_quote.js]</span>
<a href="#l14.11"></a><span id="l14.11"> [test_ldif_import.js]</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-run-if = os == 'win'</span>
<a href="#l14.13"></a><span id="l14.13"> [test_outlook_settings.js]</span>
<a href="#l14.14"></a><span id="l14.14"> run-if = os == 'win'</span>
<a href="#l14.15"></a><span id="l14.15"> [test_shiftjis_csv.js]</span>
<a href="#l14.16"></a><span id="l14.16"> [test_utf16_csv.js]</span>
<a href="#l14.17"></a><span id="l14.17"> [test_vcard_import.js]</span>
<a href="#l14.18"></a><span id="l14.18"> [test_winmail.js]</span>
<a href="#l14.19"></a><span id="l14.19"> run-if = os == 'win'</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l15.5"></a><span id="l15.5">  *</span>
<a href="#l15.6"></a><span id="l15.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsTextAddress.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsIFile.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-#include &quot;mdb.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> #include &quot;nsIConverterInputStream.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22"> #include &quot;nsIUnicharLineInputStream.h&quot;</span>
<a href="#l15.23"></a><span id="l15.23"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l15.26"></a><span id="l15.26"> #include &quot;plstr.h&quot;</span>
<a href="#l15.27"></a><span id="l15.27"> #include &quot;msgCore.h&quot;</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29" class="difflineat">@@ -46,21 +46,22 @@ nsresult nsTextAddress::GetUnicharLineSt</span>
<a href="#l15.30"></a><span id="l15.30">         aInputStream, charset.get(), 8192,</span>
<a href="#l15.31"></a><span id="l15.31">         nsIConverterInputStream::DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l15.32"></a><span id="l15.32">   }</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">   return CallQueryInterface(converterStream, aStream);</span>
<a href="#l15.35"></a><span id="l15.35"> }</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37"> nsresult nsTextAddress::ImportAddresses(bool *pAbort, const char16_t *pName,</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-                                        nsIFile *pSrc, nsIAddrDatabase *pDb,</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+                                        nsIFile *pSrc,</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+                                        nsIAbDirectory *pDirectory,</span>
<a href="#l15.41"></a><span id="l15.41">                                         nsIImportFieldMap *fieldMap,</span>
<a href="#l15.42"></a><span id="l15.42">                                         nsString &amp;errors, uint32_t *pProgress) {</span>
<a href="#l15.43"></a><span id="l15.43">   // Open the source file for reading, read each line and process it!</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  m_database = pDb;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  m_directory = pDirectory;</span>
<a href="#l15.46"></a><span id="l15.46">   m_fieldMap = fieldMap;</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l15.49"></a><span id="l15.49">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pSrc);</span>
<a href="#l15.50"></a><span id="l15.50">   if (NS_FAILED(rv)) {</span>
<a href="#l15.51"></a><span id="l15.51">     IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l15.52"></a><span id="l15.52">     return rv;</span>
<a href="#l15.53"></a><span id="l15.53">   }</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineat">@@ -123,17 +124,17 @@ nsresult nsTextAddress::ImportAddresses(</span>
<a href="#l15.55"></a><span id="l15.55">   inputStream-&gt;Close();</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">   if (NS_FAILED(rv)) {</span>
<a href="#l15.58"></a><span id="l15.58">     IMPORT_LOG0(</span>
<a href="#l15.59"></a><span id="l15.59">         &quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l15.60"></a><span id="l15.60">     return NS_ERROR_FAILURE;</span>
<a href="#l15.61"></a><span id="l15.61">   }</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-  return pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.65"></a><span id="l15.65"> }</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67"> nsresult nsTextAddress::ReadRecord(nsIUnicharLineInputStream *aLineStream,</span>
<a href="#l15.68"></a><span id="l15.68">                                    nsAString &amp;aLine, bool *aMore) {</span>
<a href="#l15.69"></a><span id="l15.69">   bool more = true;</span>
<a href="#l15.70"></a><span id="l15.70">   uint32_t numQuotes = 0;</span>
<a href="#l15.71"></a><span id="l15.71">   nsresult rv;</span>
<a href="#l15.72"></a><span id="l15.72">   nsAutoString line;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineat">@@ -385,43 +386,42 @@ nsresult nsTextAddress::ProcessLine(cons</span>
<a href="#l15.74"></a><span id="l15.74">     IMPORT_LOG0(&quot;*** Error, text import needs a field map\n&quot;);</span>
<a href="#l15.75"></a><span id="l15.75">     return NS_ERROR_FAILURE;</span>
<a href="#l15.76"></a><span id="l15.76">   }</span>
<a href="#l15.77"></a><span id="l15.77"> </span>
<a href="#l15.78"></a><span id="l15.78">   nsresult rv;</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80">   // Wait until we get our first non-empty field, then create a new row,</span>
<a href="#l15.81"></a><span id="l15.81">   // fill in the data, then add the row to the database.</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-  nsCOMPtr&lt;nsIMdbRow&gt; newRow;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l15.84"></a><span id="l15.84">   nsAutoString fieldVal;</span>
<a href="#l15.85"></a><span id="l15.85">   int32_t fieldNum;</span>
<a href="#l15.86"></a><span id="l15.86">   int32_t numFields = 0;</span>
<a href="#l15.87"></a><span id="l15.87">   bool active;</span>
<a href="#l15.88"></a><span id="l15.88">   rv = m_fieldMap-&gt;GetMapSize(&amp;numFields);</span>
<a href="#l15.89"></a><span id="l15.89">   for (int32_t i = 0; (i &lt; numFields) &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l15.90"></a><span id="l15.90">     active = false;</span>
<a href="#l15.91"></a><span id="l15.91">     rv = m_fieldMap-&gt;GetFieldMap(i, &amp;fieldNum);</span>
<a href="#l15.92"></a><span id="l15.92">     if (NS_SUCCEEDED(rv)) rv = m_fieldMap-&gt;GetFieldActive(i, &amp;active);</span>
<a href="#l15.93"></a><span id="l15.93">     if (NS_SUCCEEDED(rv) &amp;&amp; active) {</span>
<a href="#l15.94"></a><span id="l15.94">       if (GetField(aLine, i, fieldVal, m_delim)) {</span>
<a href="#l15.95"></a><span id="l15.95">         if (!fieldVal.IsEmpty()) {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-          if (!newRow) {</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-            rv = m_database-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-            if (NS_FAILED(rv)) {</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-              IMPORT_LOG0(&quot;*** Error getting new address database row\n&quot;);</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-            }</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+          if (!newCard) {</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+            newCard = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l15.103"></a><span id="l15.103">           }</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-          if (newRow) {</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-            rv = m_fieldMap-&gt;SetFieldValue(m_database, newRow, fieldNum,</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-                                           fieldVal.get());</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+          if (newCard) {</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+            rv = m_fieldMap-&gt;SetFieldValue(m_directory, newCard, fieldNum,</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+                                           fieldVal);</span>
<a href="#l15.110"></a><span id="l15.110">           }</span>
<a href="#l15.111"></a><span id="l15.111">         }</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-      } else</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+      } else {</span>
<a href="#l15.114"></a><span id="l15.114">         break;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+      }</span>
<a href="#l15.116"></a><span id="l15.116">     } else if (active) {</span>
<a href="#l15.117"></a><span id="l15.117">       IMPORT_LOG1(&quot;*** Error getting field map for index %ld\n&quot;, (long)i);</span>
<a href="#l15.118"></a><span id="l15.118">     }</span>
<a href="#l15.119"></a><span id="l15.119">   }</span>
<a href="#l15.120"></a><span id="l15.120"> </span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; newRow) rv = m_database-&gt;AddCardRowToDB(newRow);</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  nsIAbCard *outCard;</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+  rv = m_directory-&gt;AddCard(newCard, &amp;outCard);</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125">   return rv;</span>
<a href="#l15.126"></a><span id="l15.126"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -7,33 +7,34 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #ifndef nsTextAddress_h__</span>
<a href="#l16.5"></a><span id="l16.5"> #define nsTextAddress_h__</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsString.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-class nsIAddrDatabase;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+class nsIAbDirectory;</span>
<a href="#l16.14"></a><span id="l16.14"> class nsIFile;</span>
<a href="#l16.15"></a><span id="l16.15"> class nsIInputStream;</span>
<a href="#l16.16"></a><span id="l16.16"> class nsIUnicharLineInputStream;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.19"></a><span id="l16.19"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.20"></a><span id="l16.20"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22"> class nsTextAddress {</span>
<a href="#l16.23"></a><span id="l16.23">  public:</span>
<a href="#l16.24"></a><span id="l16.24">   nsTextAddress();</span>
<a href="#l16.25"></a><span id="l16.25">   virtual ~nsTextAddress();</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   nsresult ImportAddresses(bool *pAbort, const char16_t *pName, nsIFile *pSrc,</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-                           nsIAddrDatabase *pDb, nsIImportFieldMap *fieldMap,</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-                           nsString &amp;errors, uint32_t *pProgress);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+                           nsIAbDirectory *pDirectory,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+                           nsIImportFieldMap *fieldMap, nsString &amp;errors,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+                           uint32_t *pProgress);</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34">   nsresult DetermineDelim(nsIFile *pSrc);</span>
<a href="#l16.35"></a><span id="l16.35">   char16_t GetDelim(void) { return m_delim; }</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">   static nsresult ReadRecordNumber(nsIFile *pSrc, nsAString &amp;aLine,</span>
<a href="#l16.38"></a><span id="l16.38">                                    int32_t rNum);</span>
<a href="#l16.39"></a><span id="l16.39">   static bool GetField(const nsAString &amp;aLine, int32_t index, nsString &amp;field,</span>
<a href="#l16.40"></a><span id="l16.40">                        char16_t delim);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineat">@@ -46,14 +47,14 @@ class nsTextAddress {</span>
<a href="#l16.42"></a><span id="l16.42">                              bool *aMore);</span>
<a href="#l16.43"></a><span id="l16.43">   static nsresult GetUnicharLineStreamForFile(</span>
<a href="#l16.44"></a><span id="l16.44">       nsIFile *aFile, nsIInputStream *aInputStream,</span>
<a href="#l16.45"></a><span id="l16.45">       nsIUnicharLineInputStream **aStream);</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47">   char16_t m_delim;</span>
<a href="#l16.48"></a><span id="l16.48">   int32_t m_LFCount;</span>
<a href="#l16.49"></a><span id="l16.49">   int32_t m_CRCount;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; m_database;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; m_directory;</span>
<a href="#l16.52"></a><span id="l16.52">   nsCOMPtr&lt;nsIImportFieldMap&gt; m_fieldMap;</span>
<a href="#l16.53"></a><span id="l16.53">   nsCOMPtr&lt;nsIImportService&gt; m_pService;</span>
<a href="#l16.54"></a><span id="l16.54"> };</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56"> #endif /* nsTextAddress_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -13,17 +13,16 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsTextImport.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13"> #include &quot;nsIAbLDIFService.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsTextAddress.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -63,17 +62,17 @@ class ImportAddressImpl final : public n</span>
<a href="#l17.22"></a><span id="l17.22">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found,</span>
<a href="#l17.23"></a><span id="l17.23">                                 bool *userVerify) override;</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval) override;</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27">   NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap) override;</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-                               nsIAddrDatabase *destination,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+                               nsIAbDirectory *destination,</span>
<a href="#l17.32"></a><span id="l17.32">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l17.33"></a><span id="l17.33">                                nsISupports *aSupportService,</span>
<a href="#l17.34"></a><span id="l17.34">                                char16_t **errorLog, char16_t **successLog,</span>
<a href="#l17.35"></a><span id="l17.35">                                bool *fatalError) override;</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">   NS_IMETHOD GetImportProgress(uint32_t *_retval) override;</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39">   NS_IMETHOD GetSampleData(int32_t index, bool *pFound,</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineat">@@ -328,17 +327,17 @@ void ImportAddressImpl::ReportError(int3</span>
<a href="#l17.41"></a><span id="l17.41"> void ImportAddressImpl::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l17.42"></a><span id="l17.42">                                 char16_t **pError, char16_t **pSuccess) {</span>
<a href="#l17.43"></a><span id="l17.43">   if (pError) *pError = ToNewUnicode(error);</span>
<a href="#l17.44"></a><span id="l17.44">   if (pSuccess) *pSuccess = ToNewUnicode(success);</span>
<a href="#l17.45"></a><span id="l17.45"> }</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47"> NS_IMETHODIMP</span>
<a href="#l17.48"></a><span id="l17.48"> ImportAddressImpl::ImportAddressBook(nsIImportABDescriptor *pSource,</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-                                     nsIAddrDatabase *pDestination,</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+                                     nsIAbDirectory *pDestination,</span>
<a href="#l17.51"></a><span id="l17.51">                                      nsIImportFieldMap *fieldMap,</span>
<a href="#l17.52"></a><span id="l17.52">                                      nsISupports *aSupportService,</span>
<a href="#l17.53"></a><span id="l17.53">                                      char16_t **pErrorLog,</span>
<a href="#l17.54"></a><span id="l17.54">                                      char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l17.55"></a><span id="l17.55">   NS_ASSERTION(pSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l17.56"></a><span id="l17.56">   NS_ASSERTION(pDestination != nullptr, &quot;null ptr&quot;);</span>
<a href="#l17.57"></a><span id="l17.57">   NS_ASSERTION(fatalError != nullptr, &quot;null ptr&quot;);</span>
<a href="#l17.58"></a><span id="l17.58"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardAddress.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardAddress.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -4,31 +4,32 @@</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsVCardAddress.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14"> #include &quot;nsIFile.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> #include &quot;plstr.h&quot;</span>
<a href="#l18.19"></a><span id="l18.19"> #include &quot;msgCore.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22"> nsVCardAddress::nsVCardAddress() {}</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24"> nsVCardAddress::~nsVCardAddress() {}</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26"> nsresult nsVCardAddress::ImportAddresses(bool *pAbort, const char16_t *pName,</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-                                         nsIFile *pSrc, nsIAddrDatabase *pDb,</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+                                         nsIFile *pSrc,</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+                                         nsIAbDirectory *pDirectory,</span>
<a href="#l18.30"></a><span id="l18.30">                                          nsString &amp;errors,</span>
<a href="#l18.31"></a><span id="l18.31">                                          uint32_t *pProgress) {</span>
<a href="#l18.32"></a><span id="l18.32">   // Open the source file for reading, read each line and process it!</span>
<a href="#l18.33"></a><span id="l18.33">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l18.34"></a><span id="l18.34">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pSrc);</span>
<a href="#l18.35"></a><span id="l18.35">   if (NS_FAILED(rv)) {</span>
<a href="#l18.36"></a><span id="l18.36">     IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l18.37"></a><span id="l18.37">     return rv;</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineat">@@ -59,17 +60,18 @@ nsresult nsVCardAddress::ImportAddresses</span>
<a href="#l18.39"></a><span id="l18.39">     rv = ReadRecord(lineStream, record, &amp;more);</span>
<a href="#l18.40"></a><span id="l18.40">     if (NS_SUCCEEDED(rv) &amp;&amp; !record.IsEmpty()) {</span>
<a href="#l18.41"></a><span id="l18.41">       // Parse the vCard and build an nsIAbCard from it</span>
<a href="#l18.42"></a><span id="l18.42">       nsCOMPtr&lt;nsIAbCard&gt; cardFromVCard;</span>
<a href="#l18.43"></a><span id="l18.43">       rv =</span>
<a href="#l18.44"></a><span id="l18.44">           ab-&gt;EscapedVCardToAbCard(record.get(), getter_AddRefs(cardFromVCard));</span>
<a href="#l18.45"></a><span id="l18.45">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.46"></a><span id="l18.46"> </span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-      rv = pDb-&gt;CreateNewCardAndAddToDB(cardFromVCard, false, nullptr);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+      nsIAbCard *outCard;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+      rv = pDirectory-&gt;AddCard(cardFromVCard, &amp;outCard);</span>
<a href="#l18.50"></a><span id="l18.50">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.51"></a><span id="l18.51"> </span>
<a href="#l18.52"></a><span id="l18.52">       if (NS_FAILED(rv)) {</span>
<a href="#l18.53"></a><span id="l18.53">         IMPORT_LOG0(&quot;*** Error processing vCard record.\n&quot;);</span>
<a href="#l18.54"></a><span id="l18.54">       }</span>
<a href="#l18.55"></a><span id="l18.55">     }</span>
<a href="#l18.56"></a><span id="l18.56">     if (NS_SUCCEEDED(rv) &amp;&amp; pProgress) {</span>
<a href="#l18.57"></a><span id="l18.57">       // This won't be totally accurate, but its the best we can do</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineat">@@ -82,17 +84,17 @@ nsresult nsVCardAddress::ImportAddresses</span>
<a href="#l18.59"></a><span id="l18.59">   inputStream-&gt;Close();</span>
<a href="#l18.60"></a><span id="l18.60"> </span>
<a href="#l18.61"></a><span id="l18.61">   if (NS_FAILED(rv)) {</span>
<a href="#l18.62"></a><span id="l18.62">     IMPORT_LOG0(</span>
<a href="#l18.63"></a><span id="l18.63">         &quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l18.64"></a><span id="l18.64">     return NS_ERROR_FAILURE;</span>
<a href="#l18.65"></a><span id="l18.65">   }</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-  return pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.69"></a><span id="l18.69"> }</span>
<a href="#l18.70"></a><span id="l18.70"> </span>
<a href="#l18.71"></a><span id="l18.71"> nsresult nsVCardAddress::ReadRecord(nsILineInputStream *aLineStream,</span>
<a href="#l18.72"></a><span id="l18.72">                                     nsCString &amp;aRecord, bool *aMore) {</span>
<a href="#l18.73"></a><span id="l18.73">   bool more = true;</span>
<a href="#l18.74"></a><span id="l18.74">   nsresult rv;</span>
<a href="#l18.75"></a><span id="l18.75">   nsCString line;</span>
<a href="#l18.76"></a><span id="l18.76"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardAddress.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardAddress.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -2,27 +2,27 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.5"></a><span id="l19.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> #ifndef nsVCardAddress_h__</span>
<a href="#l19.8"></a><span id="l19.8"> #define nsVCardAddress_h__</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-class nsIAddrDatabase;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+class nsIAbDirectory;</span>
<a href="#l19.14"></a><span id="l19.14"> class nsIFile;</span>
<a href="#l19.15"></a><span id="l19.15"> class nsILineInputStream;</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> class nsVCardAddress {</span>
<a href="#l19.18"></a><span id="l19.18">  public:</span>
<a href="#l19.19"></a><span id="l19.19">   nsVCardAddress();</span>
<a href="#l19.20"></a><span id="l19.20">   virtual ~nsVCardAddress();</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22">   nsresult ImportAddresses(bool *pAbort, const char16_t *pName, nsIFile *pSrc,</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-                           nsIAddrDatabase *pDb, nsString &amp;errors,</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+                           nsIAbDirectory *pDirectory, nsString &amp;errors,</span>
<a href="#l19.25"></a><span id="l19.25">                            uint32_t *pProgress);</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27">  private:</span>
<a href="#l19.28"></a><span id="l19.28">   static nsresult ReadRecord(nsILineInputStream *aLineStream,</span>
<a href="#l19.29"></a><span id="l19.29">                              nsCString &amp;aRecord, bool *aMore);</span>
<a href="#l19.30"></a><span id="l19.30"> };</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32"> #endif /* nsVCardAddress_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,17 +1,16 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> /*</span>
<a href="#l20.9"></a><span id="l20.9">   VCard import addressbook interfaces</span>
<a href="#l20.10"></a><span id="l20.10"> */</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;nscore.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13"> #include &quot;nsIFile.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14"> #include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15"> #include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l20.19"></a><span id="l20.19"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -55,17 +54,17 @@ class ImportVCardAddressImpl : public ns</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval) override;</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">   NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap) override {</span>
<a href="#l20.26"></a><span id="l20.26">     return NS_ERROR_FAILURE;</span>
<a href="#l20.27"></a><span id="l20.27">   }</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-                               nsIAddrDatabase *destination,</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+                               nsIAbDirectory *destination,</span>
<a href="#l20.32"></a><span id="l20.32">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l20.33"></a><span id="l20.33">                                nsISupports *aSupportService,</span>
<a href="#l20.34"></a><span id="l20.34">                                char16_t **errorLog, char16_t **successLog,</span>
<a href="#l20.35"></a><span id="l20.35">                                bool *fatalError) override;</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37">   NS_IMETHOD GetImportProgress(uint32_t *_retval) override;</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39">   NS_IMETHOD GetSampleData(int32_t index, bool *pFound,</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineat">@@ -296,17 +295,17 @@ void ImportVCardAddressImpl::ReportError</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42"> void ImportVCardAddressImpl::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l20.43"></a><span id="l20.43">                                      char16_t **pError, char16_t **pSuccess) {</span>
<a href="#l20.44"></a><span id="l20.44">   if (pError) *pError = ToNewUnicode(error);</span>
<a href="#l20.45"></a><span id="l20.45">   if (pSuccess) *pSuccess = ToNewUnicode(success);</span>
<a href="#l20.46"></a><span id="l20.46"> }</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48"> NS_IMETHODIMP ImportVCardAddressImpl::ImportAddressBook(</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-    nsIImportABDescriptor *pSource, nsIAddrDatabase *pDestination,</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+    nsIImportABDescriptor *pSource, nsIAbDirectory *pDestination,</span>
<a href="#l20.51"></a><span id="l20.51">     nsIImportFieldMap *fieldMap, nsISupports *aSupportService,</span>
<a href="#l20.52"></a><span id="l20.52">     char16_t **pErrorLog, char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l20.53"></a><span id="l20.53">   NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l20.54"></a><span id="l20.54">   NS_ENSURE_ARG_POINTER(pDestination);</span>
<a href="#l20.55"></a><span id="l20.55">   NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57">   if (!m_notProxyBundle) return NS_ERROR_FAILURE;</span>
<a href="#l20.58"></a><span id="l20.58"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

