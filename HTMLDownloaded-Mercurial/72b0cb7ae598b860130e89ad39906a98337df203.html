<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26453:72b0cb7ae598b860130e89ad39906a98337df203</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 72b0cb7ae598b860130e89ad39906a98337df203" />
<meta property="og:url" content="/comm-central/rev/72b0cb7ae598b860130e89ad39906a98337df203" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/addrbook. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 72b0cb7ae598b860130e89ad39906a98337df203 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/72b0cb7ae598b860130e89ad39906a98337df203">shortlog</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/72b0cb7ae598b860130e89ad39906a98337df203">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203">files</a> |
changeset |
<a href="/comm-central/raw-rev/72b0cb7ae598b860130e89ad39906a98337df203">raw</a>  | <a href="/comm-central/archive/72b0cb7ae598b860130e89ad39906a98337df203.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/addrbook. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 26 Apr 2019 10:14:09 +0200</td></tr>

<tr>
 <td>changeset 26453</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/72b0cb7ae598b860130e89ad39906a98337df203">72b0cb7ae598b860130e89ad39906a98337df203</a></td>
</tr>



<tr>
<td>parent 26452</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ce4e95d15d0579d4072decf4ab3bcea6a6532721">ce4e95d15d0579d4072decf4ab3bcea6a6532721</a>
</td>
</tr>

<tr>
<td>child 26454</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9a139533ba44fb8211af54a2a80e02c889263f0a">9a139533ba44fb8211af54a2a80e02c889263f0a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=72b0cb7ae598b860130e89ad39906a98337df203">15839</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 26 Apr 2019 08:28:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@87de40d001ca [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=87de40d001ca77e92342b9f1e6b5fc1f98fc4c45">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=87de40d001ca77e92342b9f1e6b5fc1f98fc4c45&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=87de40d001ca77e92342b9f1e6b5fc1f98fc4c45&newProject=comm-central&newRevision=72b0cb7ae598b860130e89ad39906a98337df203&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=87de40d001ca77e92342b9f1e6b5fc1f98fc4c45&newProject=comm-central&newRevision=72b0cb7ae598b860130e89ad39906a98337df203&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=87de40d001ca77e92342b9f1e6b5fc1f98fc4c45&newProject=comm-central&newRevision=72b0cb7ae598b860130e89ad39906a98337df203&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/addrbook. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.cpp">mailnews/addrbook/src/nsAbAddressCollector.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.h">mailnews/addrbook/src/nsAbAddressCollector.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbAddressCollector.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.cpp">mailnews/addrbook/src/nsAbBSDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.h">mailnews/addrbook/src/nsAbBSDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBSDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h">mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.cpp">mailnews/addrbook/src/nsAbBooleanExpression.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.h">mailnews/addrbook/src/nsAbBooleanExpression.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbBooleanExpression.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.cpp">mailnews/addrbook/src/nsAbCardProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.h">mailnews/addrbook/src/nsAbCardProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbCardProperty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.cpp">mailnews/addrbook/src/nsAbContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.h">mailnews/addrbook/src/nsAbContentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbContentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.cpp">mailnews/addrbook/src/nsAbDirFactoryService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.h">mailnews/addrbook/src/nsAbDirFactoryService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirFactoryService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.h">mailnews/addrbook/src/nsAbDirProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirProperty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">mailnews/addrbook/src/nsAbDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.h">mailnews/addrbook/src/nsAbDirectoryQuery.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQuery.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp">mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h">mailnews/addrbook/src/nsAbDirectoryQueryProxy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.cpp">mailnews/addrbook/src/nsAbLDAPCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.h">mailnews/addrbook/src/nsAbLDAPCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPCard.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">mailnews/addrbook/src/nsAbLDAPChangeLogData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.h">mailnews/addrbook/src/nsAbLDAPDirFactory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirFactory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.h">mailnews/addrbook/src/nsAbLDAPDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">mailnews/addrbook/src/nsAbLDAPDirectoryModify.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.h">mailnews/addrbook/src/nsAbLDAPListenerBase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPListenerBase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.h">mailnews/addrbook/src/nsAbLDAPReplicationData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationData.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h">mailnews/addrbook/src/nsAbLDAPReplicationQuery.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.h">mailnews/addrbook/src/nsAbLDAPReplicationService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDAPReplicationService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.cpp">mailnews/addrbook/src/nsAbLDIFService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.h">mailnews/addrbook/src/nsAbLDIFService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbLDIFService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.cpp">mailnews/addrbook/src/nsAbMDBCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.h">mailnews/addrbook/src/nsAbMDBCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBCard.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">mailnews/addrbook/src/nsAbMDBDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.h">mailnews/addrbook/src/nsAbMDBDirFactory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirFactory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">mailnews/addrbook/src/nsAbMDBDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.h">mailnews/addrbook/src/nsAbMDBDirProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirProperty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.cpp">mailnews/addrbook/src/nsAbMDBDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.h">mailnews/addrbook/src/nsAbMDBDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbMDBDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.cpp">mailnews/addrbook/src/nsAbManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.h">mailnews/addrbook/src/nsAbManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.h">mailnews/addrbook/src/nsAbOSXCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.mm">mailnews/addrbook/src/nsAbOSXCard.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.mm">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.mm">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.mm">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.mm">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXCard.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">mailnews/addrbook/src/nsAbOSXDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.h">mailnews/addrbook/src/nsAbOSXDirFactory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirFactory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.h">mailnews/addrbook/src/nsAbOSXDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.mm">mailnews/addrbook/src/nsAbOSXDirectory.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.mm">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.mm">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.mm">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.mm">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXDirectory.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.h">mailnews/addrbook/src/nsAbOSXUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.mm">mailnews/addrbook/src/nsAbOSXUtils.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.mm">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.mm">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.mm">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.mm">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOSXUtils.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.h">mailnews/addrbook/src/nsAbOutlookDirFactory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirFactory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">mailnews/addrbook/src/nsAbOutlookDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.h">mailnews/addrbook/src/nsAbOutlookDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbOutlookDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">mailnews/addrbook/src/nsAbQueryStringToExpression.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.h">mailnews/addrbook/src/nsAbQueryStringToExpression.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbQueryStringToExpression.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbUtils.h">mailnews/addrbook/src/nsAbUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbUtils.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbUtils.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbUtils.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbUtils.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.cpp">mailnews/addrbook/src/nsAbView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.h">mailnews/addrbook/src/nsAbView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.cpp">mailnews/addrbook/src/nsAbWinHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.h">mailnews/addrbook/src/nsAbWinHelper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAbWinHelper.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.h">mailnews/addrbook/src/nsAddbookProtocolHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookProtocolHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.cpp">mailnews/addrbook/src/nsAddbookUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.h">mailnews/addrbook/src/nsAddbookUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddbookUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.cpp">mailnews/addrbook/src/nsAddrDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.h">mailnews/addrbook/src/nsAddrDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsAddrDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.cpp">mailnews/addrbook/src/nsDirPrefs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.h">mailnews/addrbook/src/nsDirPrefs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsDirPrefs.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.cpp">mailnews/addrbook/src/nsMapiAddressBook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.h">mailnews/addrbook/src/nsMapiAddressBook.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMapiAddressBook.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.cpp">mailnews/addrbook/src/nsMsgVCardService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.h">mailnews/addrbook/src/nsMsgVCardService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsMsgVCardService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.cpp">mailnews/addrbook/src/nsVCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.h">mailnews/addrbook/src/nsVCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCard.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.cpp">mailnews/addrbook/src/nsVCardObj.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.h">mailnews/addrbook/src/nsVCardObj.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsVCardObj.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.cpp">mailnews/addrbook/src/nsWabAddressBook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.cpp">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.cpp">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.cpp">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.cpp">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.h">mailnews/addrbook/src/nsWabAddressBook.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.h">file</a> |
<a href="/comm-central/annotate/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.h">annotate</a> |
<a href="/comm-central/diff/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.h">diff</a> |
<a href="/comm-central/comparison/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.h">comparison</a> |
<a href="/comm-central/log/72b0cb7ae598b860130e89ad39906a98337df203/mailnews/addrbook/src/nsWabAddressBook.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -20,350 +20,446 @@</span>
<a href="#l1.4"></a><span id="l1.4"> // The start of the contract ID for address book directory types</span>
<a href="#l1.5"></a><span id="l1.5"> //</span>
<a href="#l1.6"></a><span id="l1.6"> #define NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX \</span>
<a href="#l1.7"></a><span id="l1.7">   &quot;@mozilla.org/addressbook/directory;1?type=&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> //</span>
<a href="#l1.10"></a><span id="l1.10"> // nsAbManager</span>
<a href="#l1.11"></a><span id="l1.11"> //</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#define NS_ABMANAGER_CONTRACTID \</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  &quot;@mozilla.org/abmanager;1&quot;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+#define NS_ABMANAGER_CONTRACTID &quot;@mozilla.org/abmanager;1&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> #define NS_ABMANAGERSTARTUPHANDLER_CONTRACTID \</span>
<a href="#l1.17"></a><span id="l1.17">   &quot;@mozilla.org/commandlinehandler/general-startup;1?type=addressbook&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-#define NS_ABMANAGER_CID      \</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-{ 0xad81b321, 0x8a8a, 0x42ca, \</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-{ 0xa5, 0x08, 0xfe, 0x65, 0x9d, 0x8e, 0x45, 0x86 }}</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+#define NS_ABMANAGER_CID                             \</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  {                                                  \</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    0xad81b321, 0x8a8a, 0x42ca, {                    \</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+      0xa5, 0x08, 0xfe, 0x65, 0x9d, 0x8e, 0x45, 0x86 \</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    }                                                \</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+  }</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> //</span>
<a href="#l1.30"></a><span id="l1.30"> // nsAbContentHandler</span>
<a href="#l1.31"></a><span id="l1.31"> //</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-#define NS_ABCONTENTHANDLER_CID \</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-{ 0xa72ad552, 0x0484, 0x4b5f,   \</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-{ 0x8d, 0x45, 0x2d, 0x79, 0x15, 0x8d, 0x22, 0xe3 }}</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+#define NS_ABCONTENTHANDLER_CID                      \</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  {                                                  \</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    0xa72ad552, 0x0484, 0x4b5f, {                    \</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+      0x8d, 0x45, 0x2d, 0x79, 0x15, 0x8d, 0x22, 0xe3 \</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    }                                                \</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  }</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43"> //</span>
<a href="#l1.44"></a><span id="l1.44"> // nsAbBSDirectory - the root address book</span>
<a href="#l1.45"></a><span id="l1.45"> //</span>
<a href="#l1.46"></a><span id="l1.46"> #define NS_ABDIRECTORY_CONTRACTID \</span>
<a href="#l1.47"></a><span id="l1.47">   NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-abdirectory&quot;</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-#define NS_ABDIRECTORY_CID   \</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-{ 0x012D3C24, 0x1DD2, 0x11B2,\</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-{ 0xBA, 0x79, 0xB4, 0xAD, 0x35, 0x9F, 0xC4, 0x61 }}</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+#define NS_ABDIRECTORY_CID                           \</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  {                                                  \</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    0x012D3C24, 0x1DD2, 0x11B2, {                    \</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+      0xBA, 0x79, 0xB4, 0xAD, 0x35, 0x9F, 0xC4, 0x61 \</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+    }                                                \</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  }</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60"> //</span>
<a href="#l1.61"></a><span id="l1.61"> // nsAddressBookDB</span>
<a href="#l1.62"></a><span id="l1.62"> //</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-#define NS_ADDRDATABASE_CONTRACTID \</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-  &quot;@mozilla.org/addressbook/carddatabase;1&quot;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+#define NS_ADDRDATABASE_CONTRACTID &quot;@mozilla.org/addressbook/carddatabase;1&quot;</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-#define NS_ADDRDATABASE_CID   \</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-{ 0x63187917, 0x1d19, 0x11d3, \</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-{ 0xa3, 0x2, 0x0, 0x10, 0x83, 0x0, 0x3d, 0xc }}</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+#define NS_ADDRDATABASE_CID                                                    \</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  {                                                                            \</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    0x63187917, 0x1d19, 0x11d3, { 0xa3, 0x2, 0x0, 0x10, 0x83, 0x0, 0x3d, 0xc } \</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  }</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75"> //</span>
<a href="#l1.76"></a><span id="l1.76"> // nsAbCardProperty</span>
<a href="#l1.77"></a><span id="l1.77"> //</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-#define NS_ABCARDPROPERTY_CONTRACTID \</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  &quot;@mozilla.org/addressbook/cardproperty;1&quot;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-#define NS_ABCARDPROPERTY_CID \</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-{ 0x2b722171, 0x2cea, 0x11d3, \</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-{ 0x9e, 0xb, 0x0, 0xa0, 0xc9, 0x2b, 0x5f, 0xd }}</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+#define NS_ABCARDPROPERTY_CONTRACTID &quot;@mozilla.org/addressbook/cardproperty;1&quot;</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+#define NS_ABCARDPROPERTY_CID                     \</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  {                                               \</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    0x2b722171, 0x2cea, 0x11d3, {                 \</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      0x9e, 0xb, 0x0, 0xa0, 0xc9, 0x2b, 0x5f, 0xd \</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    }                                             \</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  }</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91"> //</span>
<a href="#l1.92"></a><span id="l1.92"> // nsAbDirProperty</span>
<a href="#l1.93"></a><span id="l1.93"> //</span>
<a href="#l1.94"></a><span id="l1.94"> #define NS_ABDIRPROPERTY_CONTRACTID \</span>
<a href="#l1.95"></a><span id="l1.95">   &quot;@mozilla.org/addressbook/directoryproperty;1&quot;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-#define NS_ABDIRPROPERTY_CID  \</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-{ 0x6fd8ec67, 0x3965, 0x11d3, \</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-{ 0xa3, 0x16, 0x0, 0x10, 0x83, 0x0, 0x3d, 0xc }}</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+#define NS_ABDIRPROPERTY_CID                      \</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+  {                                               \</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    0x6fd8ec67, 0x3965, 0x11d3, {                 \</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+      0xa3, 0x16, 0x0, 0x10, 0x83, 0x0, 0x3d, 0xc \</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    }                                             \</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+  }</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106"> //</span>
<a href="#l1.107"></a><span id="l1.107"> // nsAbDirectoryProperties</span>
<a href="#l1.108"></a><span id="l1.108"> //</span>
<a href="#l1.109"></a><span id="l1.109"> #define NS_ABDIRECTORYPROPERTIES_CONTRACTID \</span>
<a href="#l1.110"></a><span id="l1.110">   &quot;@mozilla.org/addressbook/properties;1&quot;</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-#define NS_ABDIRECTORYPROPERTIES_CID \</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-{ 0x8b00a972, 0x1dd2, 0x11b2,        \</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-{ 0x9d, 0x9c, 0x9c, 0x37, 0x7a, 0x9c, 0x3d, 0xba }}</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+#define NS_ABDIRECTORYPROPERTIES_CID                 \</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+  {                                                  \</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    0x8b00a972, 0x1dd2, 0x11b2, {                    \</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+      0x9d, 0x9c, 0x9c, 0x37, 0x7a, 0x9c, 0x3d, 0xba \</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    }                                                \</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+  }</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121"> //</span>
<a href="#l1.122"></a><span id="l1.122"> // nsAbAddressCollector</span>
<a href="#l1.123"></a><span id="l1.123"> //</span>
<a href="#l1.124"></a><span id="l1.124"> #define NS_ABADDRESSCOLLECTOR_CONTRACTID \</span>
<a href="#l1.125"></a><span id="l1.125">   &quot;@mozilla.org/addressbook/services/addressCollector;1&quot;</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-#define NS_ABADDRESSCOLLECTOR_CID \</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-{ 0xe7702d5a, 0x99d8, 0x4648,     \</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-{ 0xba, 0xb7, 0x91, 0x9e, 0xa2, 0x9f, 0x30, 0xb6 }}</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+#define NS_ABADDRESSCOLLECTOR_CID                    \</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+  {                                                  \</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+    0xe7702d5a, 0x99d8, 0x4648, {                    \</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+      0xba, 0xb7, 0x91, 0x9e, 0xa2, 0x9f, 0x30, 0xb6 \</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+    }                                                \</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  }</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136"> //</span>
<a href="#l1.137"></a><span id="l1.137"> // addbook URL</span>
<a href="#l1.138"></a><span id="l1.138"> //</span>
<a href="#l1.139"></a><span id="l1.139"> #define NS_ADDBOOKURL_CONTRACTID \</span>
<a href="#l1.140"></a><span id="l1.140">   &quot;@mozilla.org/addressbook/services/url;1?type=addbook&quot;</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-#define NS_ADDBOOKURL_CID     \</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-{ 0xff04c8e6, 0x501e, 0x11d3, \</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-{ 0xa5, 0x27, 0x0, 0x60, 0xb0, 0xfc, 0x4, 0x44 }}</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+#define NS_ADDBOOKURL_CID                          \</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+  {                                                \</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+    0xff04c8e6, 0x501e, 0x11d3, {                  \</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+      0xa5, 0x27, 0x0, 0x60, 0xb0, 0xfc, 0x4, 0x44 \</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    }                                              \</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  }</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152"> //</span>
<a href="#l1.153"></a><span id="l1.153"> // addbook Protocol Handler</span>
<a href="#l1.154"></a><span id="l1.154"> //</span>
<a href="#l1.155"></a><span id="l1.155"> #define NS_ADDBOOK_HANDLER_CONTRACTID \</span>
<a href="#l1.156"></a><span id="l1.156">   &quot;@mozilla.org/addressbook/services/addbook;1&quot;</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-#define NS_ADDBOOK_HANDLER_CID \</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-{ 0xff04c8e6, 0x501e, 0x11d3,  \</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-{ 0xff, 0xcc, 0x0, 0x60, 0xb0, 0xfc, 0x4, 0x44 }}</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+#define NS_ADDBOOK_HANDLER_CID                     \</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+  {                                                \</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+    0xff04c8e6, 0x501e, 0x11d3, {                  \</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+      0xff, 0xcc, 0x0, 0x60, 0xb0, 0xfc, 0x4, 0x44 \</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+    }                                              \</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+  }</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167"> //</span>
<a href="#l1.168"></a><span id="l1.168"> // directory factory service</span>
<a href="#l1.169"></a><span id="l1.169"> //</span>
<a href="#l1.170"></a><span id="l1.170"> #define NS_ABDIRFACTORYSERVICE_CONTRACTID \</span>
<a href="#l1.171"></a><span id="l1.171">   &quot;@mozilla.org/addressbook/directory-factory-service;1&quot;</span>
<a href="#l1.172"></a><span id="l1.172"> </span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-#define NS_ABDIRFACTORYSERVICE_CID \</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-{ 0xF8B212F2, 0x742B, 0x4A48,      \</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-{ 0xB7, 0xA0, 0x4C, 0x44, 0xD4, 0xDD, 0xB1, 0x21 }}</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+#define NS_ABDIRFACTORYSERVICE_CID                   \</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+  {                                                  \</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+    0xF8B212F2, 0x742B, 0x4A48, {                    \</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+      0xB7, 0xA0, 0x4C, 0x44, 0xD4, 0xDD, 0xB1, 0x21 \</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+    }                                                \</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+  }</span>
<a href="#l1.182"></a><span id="l1.182"> </span>
<a href="#l1.183"></a><span id="l1.183"> //</span>
<a href="#l1.184"></a><span id="l1.184"> // mdb directory factory</span>
<a href="#l1.185"></a><span id="l1.185"> //</span>
<a href="#l1.186"></a><span id="l1.186"> #define NS_ABMDBDIRECTORY &quot;moz-abmdbdirectory&quot;</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188"> #define NS_ABMDBDIRFACTORY_CONTRACTID \</span>
<a href="#l1.189"></a><span id="l1.189">   NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX NS_ABMDBDIRECTORY</span>
<a href="#l1.190"></a><span id="l1.190"> </span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-#define NS_ABMDBDIRFACTORY_CID \</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-{ 0xE1CB9C8A, 0x722D, 0x43E4,  \</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-{ 0x9D, 0x7B, 0x7C, 0xCA, 0xE4, 0xB0, 0x33, 0x8A }}</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+#define NS_ABMDBDIRFACTORY_CID                       \</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+  {                                                  \</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+    0xE1CB9C8A, 0x722D, 0x43E4, {                    \</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+      0x9D, 0x7B, 0x7C, 0xCA, 0xE4, 0xB0, 0x33, 0x8A \</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+    }                                                \</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+  }</span>
<a href="#l1.200"></a><span id="l1.200"> </span>
<a href="#l1.201"></a><span id="l1.201"> //</span>
<a href="#l1.202"></a><span id="l1.202"> // nsAbMDBDirectory</span>
<a href="#l1.203"></a><span id="l1.203"> //</span>
<a href="#l1.204"></a><span id="l1.204"> #define NS_ABMDBDIRECTORY_CONTRACTID \</span>
<a href="#l1.205"></a><span id="l1.205">   NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABMDBDIRECTORY</span>
<a href="#l1.206"></a><span id="l1.206"> </span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-#define NS_ABMDBDIRECTORY_CID \</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-{ 0xe618f894, 0x1dd1, 0x11b2, \</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-{ 0x88, 0x9c, 0x9a, 0xae, 0xfa, 0xa9, 0x0d, 0xde }}</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+#define NS_ABMDBDIRECTORY_CID                        \</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+  {                                                  \</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+    0xe618f894, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+      0x88, 0x9c, 0x9a, 0xae, 0xfa, 0xa9, 0x0d, 0xde \</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+    }                                                \</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  }</span>
<a href="#l1.216"></a><span id="l1.216"> </span>
<a href="#l1.217"></a><span id="l1.217"> //</span>
<a href="#l1.218"></a><span id="l1.218"> // nsAbMDBCard</span>
<a href="#l1.219"></a><span id="l1.219"> //</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-#define NS_ABMDBCARD_CONTRACTID \</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-  &quot;@mozilla.org/addressbook/moz-abmdbcard;1&quot;</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+#define NS_ABMDBCARD_CONTRACTID &quot;@mozilla.org/addressbook/moz-abmdbcard;1&quot;</span>
<a href="#l1.223"></a><span id="l1.223"> </span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-#define NS_ABMDBCARD_CID      \</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-{ 0xf578a5d2, 0x1dd1, 0x11b2, \</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-{ 0x88, 0x41, 0xf4, 0x5c, 0xc5, 0xe7, 0x65, 0xf8 }}</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+#define NS_ABMDBCARD_CID                             \</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+  {                                                  \</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+    0xf578a5d2, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+      0x88, 0x41, 0xf4, 0x5c, 0xc5, 0xe7, 0x65, 0xf8 \</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+    }                                                \</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+  }</span>
<a href="#l1.233"></a><span id="l1.233"> </span>
<a href="#l1.234"></a><span id="l1.234"> #ifdef XP_WIN</span>
<a href="#l1.235"></a><span id="l1.235"> //</span>
<a href="#l1.236"></a><span id="l1.236"> // nsAbOutlookDirectory</span>
<a href="#l1.237"></a><span id="l1.237"> //</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-#define NS_ABOUTLOOKDIRECTORY_CONTRACTID \</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-aboutlookdirectory&quot;</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+#  define NS_ABOUTLOOKDIRECTORY_CONTRACTID \</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+    NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-aboutlookdirectory&quot;</span>
<a href="#l1.242"></a><span id="l1.242"> </span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-#define NS_ABOUTLOOKDIRECTORY_CID \</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-{ 0x9cc57822, 0x0599, 0x4c47,     \</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-{ 0xa3, 0x99, 0x1c, 0x6f, 0xa1, 0x85, 0xa0, 0x5c }}</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+#  define NS_ABOUTLOOKDIRECTORY_CID                    \</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+    {                                                  \</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+      0x9cc57822, 0x0599, 0x4c47, {                    \</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+        0xa3, 0x99, 0x1c, 0x6f, 0xa1, 0x85, 0xa0, 0x5c \</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+      }                                                \</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+    }</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253"> //</span>
<a href="#l1.254"></a><span id="l1.254"> // Outlook directory factory</span>
<a href="#l1.255"></a><span id="l1.255"> //</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-#define NS_ABOUTLOOKDIRFACTORY_CONTRACTID \</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-  NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;moz-aboutlookdirectory&quot;</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+#  define NS_ABOUTLOOKDIRFACTORY_CONTRACTID \</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+    NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;moz-aboutlookdirectory&quot;</span>
<a href="#l1.260"></a><span id="l1.260"> </span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-#define NS_ABOUTLOOKDIRFACTORY_CID \</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-{ 0x558ccc0f, 0x2681, 0x4dac,      \</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-{ 0xa0, 0x66, 0xde, 0xbd, 0x8d, 0x26, 0xfa, 0xf6 }}</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+#  define NS_ABOUTLOOKDIRFACTORY_CID                   \</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+    {                                                  \</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+      0x558ccc0f, 0x2681, 0x4dac, {                    \</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+        0xa0, 0x66, 0xde, 0xbd, 0x8d, 0x26, 0xfa, 0xf6 \</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+      }                                                \</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+    }</span>
<a href="#l1.270"></a><span id="l1.270"> #endif</span>
<a href="#l1.271"></a><span id="l1.271"> </span>
<a href="#l1.272"></a><span id="l1.272"> //</span>
<a href="#l1.273"></a><span id="l1.273"> //  Addressbook Query support</span>
<a href="#l1.274"></a><span id="l1.274"> //</span>
<a href="#l1.275"></a><span id="l1.275"> #define NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID \</span>
<a href="#l1.276"></a><span id="l1.276">   &quot;@mozilla.org/addressbook/directory/query-arguments;1&quot;</span>
<a href="#l1.277"></a><span id="l1.277"> </span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-#define NS_ABDIRECTORYQUERYARGUMENTS_CID \</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-{ 0xf7dc2aeb, 0x8e62, 0x4750,            \</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-{ 0x96, 0x5c, 0x24, 0xb9, 0xe0, 0x9e, 0xd8, 0xd2 }}</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+#define NS_ABDIRECTORYQUERYARGUMENTS_CID             \</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+  {                                                  \</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+    0xf7dc2aeb, 0x8e62, 0x4750, {                    \</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+      0x96, 0x5c, 0x24, 0xb9, 0xe0, 0x9e, 0xd8, 0xd2 \</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+    }                                                \</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+  }</span>
<a href="#l1.287"></a><span id="l1.287"> </span>
<a href="#l1.288"></a><span id="l1.288"> #define NS_BOOLEANCONDITIONSTRING_CONTRACTID \</span>
<a href="#l1.289"></a><span id="l1.289">   &quot;@mozilla.org/boolean-expression/condition-string;1&quot;</span>
<a href="#l1.290"></a><span id="l1.290"> </span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-#define NS_BOOLEANCONDITIONSTRING_CID \</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-{ 0xca1944a9, 0x527e, 0x4c77,         \</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-{ 0x89, 0x5d, 0xd0, 0x46, 0x6d, 0xd4, 0x1c, 0xf5 }}</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+#define NS_BOOLEANCONDITIONSTRING_CID                \</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+  {                                                  \</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+    0xca1944a9, 0x527e, 0x4c77, {                    \</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+      0x89, 0x5d, 0xd0, 0x46, 0x6d, 0xd4, 0x1c, 0xf5 \</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+    }                                                \</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+  }</span>
<a href="#l1.300"></a><span id="l1.300"> </span>
<a href="#l1.301"></a><span id="l1.301"> #define NS_BOOLEANEXPRESSION_CONTRACTID \</span>
<a href="#l1.302"></a><span id="l1.302">   &quot;@mozilla.org/boolean-expression/n-peer;1&quot;</span>
<a href="#l1.303"></a><span id="l1.303"> </span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-#define NS_BOOLEANEXPRESSION_CID \</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-{ 0x2c2e75c8, 0x6f56, 0x4a50,    \</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-{ 0xaf, 0x1c, 0x72, 0xaf, 0x5d, 0x0e, 0x8d, 0x41 }}</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+#define NS_BOOLEANEXPRESSION_CID                     \</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+  {                                                  \</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+    0x2c2e75c8, 0x6f56, 0x4a50, {                    \</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+      0xaf, 0x1c, 0x72, 0xaf, 0x5d, 0x0e, 0x8d, 0x41 \</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+    }                                                \</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+  }</span>
<a href="#l1.313"></a><span id="l1.313"> </span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-#define NS_ABDIRECTORYQUERYPROXY_CONTRACTID                     \</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+#define NS_ABDIRECTORYQUERYPROXY_CONTRACTID \</span>
<a href="#l1.316"></a><span id="l1.316">   &quot;@mozilla.org/addressbook/directory-query/proxy;1&quot;</span>
<a href="#l1.317"></a><span id="l1.317"> </span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-#define NS_ABDIRECTORYQUERYPROXY_CID \</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-{ 0xE162E335, 0x541B, 0x43B4,        \</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-{ 0xAA, 0xEA, 0xFE, 0x59, 0x1E, 0x24, 0x0C, 0xAF }}</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+#define NS_ABDIRECTORYQUERYPROXY_CID                 \</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+  {                                                  \</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+    0xE162E335, 0x541B, 0x43B4, {                    \</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+      0xAA, 0xEA, 0xFE, 0x59, 0x1E, 0x24, 0x0C, 0xAF \</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+    }                                                \</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+  }</span>
<a href="#l1.327"></a><span id="l1.327"> </span>
<a href="#l1.328"></a><span id="l1.328"> // nsAbLDAPDirectory</span>
<a href="#l1.329"></a><span id="l1.329"> //</span>
<a href="#l1.330"></a><span id="l1.330"> #define NS_ABLDAPDIRECTORY_CONTRACTID \</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX  &quot;moz-abldapdirectory&quot;</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-abldapdirectory&quot;</span>
<a href="#l1.333"></a><span id="l1.333"> </span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-#define NS_ABLDAPDIRECTORY_CID \</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-{ 0x783E2777, 0x66D7, 0x4826,  \</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-{ 0x9E, 0x4B, 0x8A, 0xB5, 0x8C, 0x22, 0x8A, 0x52 }}</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+#define NS_ABLDAPDIRECTORY_CID                       \</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+  {                                                  \</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+    0x783E2777, 0x66D7, 0x4826, {                    \</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+      0x9E, 0x4B, 0x8A, 0xB5, 0x8C, 0x22, 0x8A, 0x52 \</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+    }                                                \</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+  }</span>
<a href="#l1.343"></a><span id="l1.343"> </span>
<a href="#l1.344"></a><span id="l1.344"> // nsAbLDAPDirectoryQuery</span>
<a href="#l1.345"></a><span id="l1.345"> //</span>
<a href="#l1.346"></a><span id="l1.346"> #define NS_ABLDAPDIRECTORYQUERY_CONTRACTID \</span>
<a href="#l1.347"></a><span id="l1.347">   &quot;@mozilla.org/addressbook/ldap-directory-query;1&quot;</span>
<a href="#l1.348"></a><span id="l1.348"> </span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-#define NS_ABLDAPDIRECTORYQUERY_CID \</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-{ 0x783E2777, 0x66D7, 0x4826,       \</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-{ 0x9E, 0x4B, 0x8A, 0xB5, 0x8C, 0x22, 0x8A, 0x53 }}</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+#define NS_ABLDAPDIRECTORYQUERY_CID                  \</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+  {                                                  \</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+    0x783E2777, 0x66D7, 0x4826, {                    \</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+      0x9E, 0x4B, 0x8A, 0xB5, 0x8C, 0x22, 0x8A, 0x53 \</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+    }                                                \</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+  }</span>
<a href="#l1.358"></a><span id="l1.358"> </span>
<a href="#l1.359"></a><span id="l1.359"> //</span>
<a href="#l1.360"></a><span id="l1.360"> // nsAbLDAPCard</span>
<a href="#l1.361"></a><span id="l1.361"> //</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-#define NS_ABLDAPCARD_CONTRACTID \</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-  &quot;@mozilla.org/addressbook/moz-abldapcard&quot;</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+#define NS_ABLDAPCARD_CONTRACTID &quot;@mozilla.org/addressbook/moz-abldapcard&quot;</span>
<a href="#l1.365"></a><span id="l1.365"> </span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-#define NS_ABLDAPCARD_CID     \</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-{ 0x10307B01, 0xEBD6, 0x465F, \</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-{ 0xB9, 0x72, 0x16, 0x30, 0x41, 0x0F, 0x70, 0xE6 }}</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+#define NS_ABLDAPCARD_CID                            \</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+  {                                                  \</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+    0x10307B01, 0xEBD6, 0x465F, {                    \</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+      0xB9, 0x72, 0x16, 0x30, 0x41, 0x0F, 0x70, 0xE6 \</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+    }                                                \</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+  }</span>
<a href="#l1.375"></a><span id="l1.375"> </span>
<a href="#l1.376"></a><span id="l1.376"> //</span>
<a href="#l1.377"></a><span id="l1.377"> // LDAP directory factory</span>
<a href="#l1.378"></a><span id="l1.378"> //</span>
<a href="#l1.379"></a><span id="l1.379"> #define NS_ABLDAPDIRFACTORY_CONTRACTID \</span>
<a href="#l1.380"></a><span id="l1.380">   NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;moz-abldapdirectory&quot;</span>
<a href="#l1.381"></a><span id="l1.381"> </span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-#define NS_ABLDAPDIRFACTORY_CID \</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-{ 0x8e3701af, 0x8828, 0x426c,   \</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-{ 0x84, 0xac, 0x12, 0x48, 0x25, 0xc7, 0x78, 0xf8 }}</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+#define NS_ABLDAPDIRFACTORY_CID                      \</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+  {                                                  \</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+    0x8e3701af, 0x8828, 0x426c, {                    \</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+      0x84, 0xac, 0x12, 0x48, 0x25, 0xc7, 0x78, 0xf8 \</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+    }                                                \</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+  }</span>
<a href="#l1.391"></a><span id="l1.391"> </span>
<a href="#l1.392"></a><span id="l1.392"> //</span>
<a href="#l1.393"></a><span id="l1.393"> // LDAP autocomplete directory factory</span>
<a href="#l1.394"></a><span id="l1.394"> //</span>
<a href="#l1.395"></a><span id="l1.395"> #define NS_ABLDAPACDIRFACTORY_CONTRACTID \</span>
<a href="#l1.396"></a><span id="l1.396">   NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;ldap&quot;</span>
<a href="#l1.397"></a><span id="l1.397"> #define NS_ABLDAPSACDIRFACTORY_CONTRACTID \</span>
<a href="#l1.398"></a><span id="l1.398">   NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;ldaps&quot;</span>
<a href="#l1.399"></a><span id="l1.399"> </span>
<a href="#l1.400"></a><span id="l1.400"> // nsAbLDAPAutoCompFormatter</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-#define NS_ABLDAPAUTOCOMPFORMATTER_CID \</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-{ 0x4e276d6d, 0x9981, 0x46b4,          \</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-{ 0x90, 0x70, 0x92, 0xf3, 0x44, 0xac, 0x5f, 0x5a }}</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+#define NS_ABLDAPAUTOCOMPFORMATTER_CID               \</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineplus">+  {                                                  \</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineplus">+    0x4e276d6d, 0x9981, 0x46b4, {                    \</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineplus">+      0x90, 0x70, 0x92, 0xf3, 0x44, 0xac, 0x5f, 0x5a \</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+    }                                                \</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+  }</span>
<a href="#l1.410"></a><span id="l1.410"> </span>
<a href="#l1.411"></a><span id="l1.411"> #define NS_ABLDAPAUTOCOMPFORMATTER_CONTRACTID \</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">- &quot;@mozilla.org/ldap-autocomplete-formatter;1?type=addrbook&quot;</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+  &quot;@mozilla.org/ldap-autocomplete-formatter;1?type=addrbook&quot;</span>
<a href="#l1.414"></a><span id="l1.414"> </span>
<a href="#l1.415"></a><span id="l1.415"> // nsAbLDAPReplicationService</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-#define NS_ABLDAP_REPLICATIONSERVICE_CID \</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-{ 0xece81280, 0x2639, 0x11d6,            \</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-{ 0xb7, 0x91, 0x00, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 }}</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+#define NS_ABLDAP_REPLICATIONSERVICE_CID             \</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+  {                                                  \</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineplus">+    0xece81280, 0x2639, 0x11d6, {                    \</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineplus">+      0xb7, 0x91, 0x00, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 \</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineplus">+    }                                                \</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineplus">+  }</span>
<a href="#l1.425"></a><span id="l1.425"> </span>
<a href="#l1.426"></a><span id="l1.426"> #define NS_ABLDAP_REPLICATIONSERVICE_CONTRACTID \</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">- &quot;@mozilla.org/addressbook/ldap-replication-service;1&quot;</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineplus">+  &quot;@mozilla.org/addressbook/ldap-replication-service;1&quot;</span>
<a href="#l1.429"></a><span id="l1.429"> </span>
<a href="#l1.430"></a><span id="l1.430"> // nsAbLDAPReplicationQuery</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-#define NS_ABLDAP_REPLICATIONQUERY_CID \</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">-{ 0x5414fff0, 0x263b, 0x11d6,          \</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-{ 0xb7, 0x91, 0x00, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 }}</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+#define NS_ABLDAP_REPLICATIONQUERY_CID               \</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineplus">+  {                                                  \</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineplus">+    0x5414fff0, 0x263b, 0x11d6, {                    \</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+      0xb7, 0x91, 0x00, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 \</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+    }                                                \</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+  }</span>
<a href="#l1.440"></a><span id="l1.440"> </span>
<a href="#l1.441"></a><span id="l1.441"> #define NS_ABLDAP_REPLICATIONQUERY_CONTRACTID \</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">- &quot;@mozilla.org/addressbook/ldap-replication-query;1&quot;</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+  &quot;@mozilla.org/addressbook/ldap-replication-query;1&quot;</span>
<a href="#l1.445"></a><span id="l1.445"> </span>
<a href="#l1.446"></a><span id="l1.446"> // nsAbLDAPChangeLogQuery</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-#define NS_ABLDAP_CHANGELOGQUERY_CID \</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-{ 0x63e11d51, 0x3c9b, 0x11d6,        \</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-{ 0xb7, 0xb9, 0x0, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 }}</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+#define NS_ABLDAP_CHANGELOGQUERY_CID                \</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+  {                                                 \</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+    0x63e11d51, 0x3c9b, 0x11d6, {                   \</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+      0xb7, 0xb9, 0x0, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 \</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+    }                                               \</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineplus">+  }</span>
<a href="#l1.456"></a><span id="l1.456"> </span>
<a href="#l1.457"></a><span id="l1.457"> #define NS_ABLDAP_CHANGELOGQUERY_CONTRACTID \</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">- &quot;@mozilla.org/addressbook/ldap-changelog-query;1&quot;</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+  &quot;@mozilla.org/addressbook/ldap-changelog-query;1&quot;</span>
<a href="#l1.460"></a><span id="l1.460"> </span>
<a href="#l1.461"></a><span id="l1.461"> // nsAbLDAPProcessReplicationData</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-#define NS_ABLDAP_PROCESSREPLICATIONDATA_CID \</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-{ 0x5414fff1, 0x263b, 0x11d6,                \</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-{ 0xb7, 0x91, 0x00, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 }}</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+#define NS_ABLDAP_PROCESSREPLICATIONDATA_CID         \</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+  {                                                  \</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+    0x5414fff1, 0x263b, 0x11d6, {                    \</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+      0xb7, 0x91, 0x00, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 \</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+    }                                                \</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+  }</span>
<a href="#l1.471"></a><span id="l1.471"> </span>
<a href="#l1.472"></a><span id="l1.472"> #define NS_ABLDAP_PROCESSREPLICATIONDATA_CONTRACTID \</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">- &quot;@mozilla.org/addressbook/ldap-process-replication-data;1&quot;</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineplus">+  &quot;@mozilla.org/addressbook/ldap-process-replication-data;1&quot;</span>
<a href="#l1.475"></a><span id="l1.475"> </span>
<a href="#l1.476"></a><span id="l1.476"> // nsAbLDAPProcessChangeLogData</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-#define NS_ABLDAP_PROCESSCHANGELOGDATA_CID \</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-{ 0x63e11d52, 0x3c9b, 0x11d6,              \</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-{ 0xb7, 0xb9, 0x0, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 }}</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+#define NS_ABLDAP_PROCESSCHANGELOGDATA_CID          \</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+  {                                                 \</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+    0x63e11d52, 0x3c9b, 0x11d6, {                   \</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+      0xb7, 0xb9, 0x0, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 \</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+    }                                               \</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+  }</span>
<a href="#l1.486"></a><span id="l1.486"> </span>
<a href="#l1.487"></a><span id="l1.487"> #define NS_ABLDAP_PROCESSCHANGELOGDATA_CONTRACTID \</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">- &quot;@mozilla.org/addressbook/ldap-process-changelog-data;1&quot;</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+  &quot;@mozilla.org/addressbook/ldap-process-changelog-data;1&quot;</span>
<a href="#l1.490"></a><span id="l1.490"> </span>
<a href="#l1.491"></a><span id="l1.491"> // nsABView</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-#define NS_ABVIEW_CID         \</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-{ 0xc5eb5d6a, 0x1dd1, 0x11b2, \</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-{ 0xa0, 0x25, 0x94, 0xd1, 0x18, 0x1f, 0xc5, 0x9c }}</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+#define NS_ABVIEW_CID                                \</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+  {                                                  \</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+    0xc5eb5d6a, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+      0xa0, 0x25, 0x94, 0xd1, 0x18, 0x1f, 0xc5, 0x9c \</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+    }                                                \</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+  }</span>
<a href="#l1.501"></a><span id="l1.501"> </span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-#define NS_ABVIEW_CONTRACTID \</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">- &quot;@mozilla.org/addressbook/abview;1&quot;</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineplus">+#define NS_ABVIEW_CONTRACTID &quot;@mozilla.org/addressbook/abview;1&quot;</span>
<a href="#l1.505"></a><span id="l1.505"> </span>
<a href="#l1.506"></a><span id="l1.506"> #ifdef XP_MACOSX</span>
<a href="#l1.507"></a><span id="l1.507"> //</span>
<a href="#l1.508"></a><span id="l1.508"> // nsAbOSXDirectory</span>
<a href="#l1.509"></a><span id="l1.509"> //</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-#define NS_ABOSXDIRECTORY_PREFIX &quot;moz-abosxdirectory&quot;</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-#define NS_ABOSXCARD_PREFIX &quot;moz-abosxcard&quot;</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+#  define NS_ABOSXDIRECTORY_PREFIX &quot;moz-abosxdirectory&quot;</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+#  define NS_ABOSXCARD_PREFIX &quot;moz-abosxcard&quot;</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+#  define NS_ABOSXDIRECTORY_CONTRACTID \</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+    NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABOSXDIRECTORY_PREFIX</span>
<a href="#l1.517"></a><span id="l1.517"> </span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-#define NS_ABOSXDIRECTORY_CONTRACTID \</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineminus">-  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABOSXDIRECTORY_PREFIX</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-#define NS_ABOSXDIRECTORY_CID  \</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineminus">-{ 0x83781cc6, 0xc682, 0x11d6,  \</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-{ 0xbd, 0xeb, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8 }}</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+#  define NS_ABOSXDIRECTORY_CID                        \</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+    {                                                  \</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+      0x83781cc6, 0xc682, 0x11d6, {                    \</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+        0xbd, 0xeb, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8 \</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+      }                                                \</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+    }</span>
<a href="#l1.530"></a><span id="l1.530"> </span>
<a href="#l1.531"></a><span id="l1.531"> //</span>
<a href="#l1.532"></a><span id="l1.532"> // nsAbOSXCard</span>
<a href="#l1.533"></a><span id="l1.533"> //</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-#define NS_ABOSXCARD_CONTRACTID \</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABOSXCARD_PREFIX</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+#  define NS_ABOSXCARD_CONTRACTID \</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineplus">+    NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABOSXCARD_PREFIX</span>
<a href="#l1.538"></a><span id="l1.538"> </span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-#define NS_ABOSXCARD_CID     \</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-{ 0x89bbf582, 0xc682, 0x11d6, \</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-{ 0xbc, 0x9d, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8 }}</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+#  define NS_ABOSXCARD_CID                             \</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+    {                                                  \</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineplus">+      0x89bbf582, 0xc682, 0x11d6, {                    \</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineplus">+        0xbc, 0x9d, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8 \</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineplus">+      }                                                \</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineplus">+    }</span>
<a href="#l1.548"></a><span id="l1.548"> </span>
<a href="#l1.549"></a><span id="l1.549"> //</span>
<a href="#l1.550"></a><span id="l1.550"> // OS X directory factory</span>
<a href="#l1.551"></a><span id="l1.551"> //</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">-#define NS_ABOSXDIRFACTORY_CONTRACTID \</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-  NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX NS_ABOSXDIRECTORY_PREFIX</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineplus">+#  define NS_ABOSXDIRFACTORY_CONTRACTID \</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+    NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX NS_ABOSXDIRECTORY_PREFIX</span>
<a href="#l1.556"></a><span id="l1.556"> </span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-#define NS_ABOSXDIRFACTORY_CID \</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineminus">-{ 0x90efe2fe, 0xc682, 0x11d6,  \</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-{ 0x9c, 0x83, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8 }}</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+#  define NS_ABOSXDIRFACTORY_CID                       \</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineplus">+    {                                                  \</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineplus">+      0x90efe2fe, 0xc682, 0x11d6, {                    \</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+        0x9c, 0x83, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8 \</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineplus">+      }                                                \</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineplus">+    }</span>
<a href="#l1.566"></a><span id="l1.566"> #endif</span>
<a href="#l1.567"></a><span id="l1.567"> </span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-#define NS_MSGVCARDSERVICE_CID \</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineminus">-{ 0x3c4ac0da, 0x2cda, 0x4018,  \</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-{ 0x95, 0x51, 0xe1, 0x58, 0xb2, 0xe1, 0x22, 0xd3 }}</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+#define NS_MSGVCARDSERVICE_CID                       \</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+  {                                                  \</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineplus">+    0x3c4ac0da, 0x2cda, 0x4018, {                    \</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineplus">+      0x95, 0x51, 0xe1, 0x58, 0xb2, 0xe1, 0x22, 0xd3 \</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineplus">+    }                                                \</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineplus">+  }</span>
<a href="#l1.577"></a><span id="l1.577"> </span>
<a href="#l1.578"></a><span id="l1.578"> #define NS_MSGVCARDSERVICE_CONTRACTID \</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">- &quot;@mozilla.org/addressbook/msgvcardservice;1&quot;</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+  &quot;@mozilla.org/addressbook/msgvcardservice;1&quot;</span>
<a href="#l1.581"></a><span id="l1.581"> </span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-#define NS_ABLDIFSERVICE_CID  \</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-{ 0xdb6f46da, 0x8de3, 0x478d, \</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-{ 0xb5, 0x39, 0x80, 0x13, 0x98, 0x65, 0x6c, 0xf6 }}</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineplus">+#define NS_ABLDIFSERVICE_CID                         \</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineplus">+  {                                                  \</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineplus">+    0xdb6f46da, 0x8de3, 0x478d, {                    \</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineplus">+      0xb5, 0x39, 0x80, 0x13, 0x98, 0x65, 0x6c, 0xf6 \</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineplus">+    }                                                \</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+  }</span>
<a href="#l1.591"></a><span id="l1.591"> </span>
<a href="#l1.592"></a><span id="l1.592" class="difflineminus">-#define NS_ABLDIFSERVICE_CONTRACTID \</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">- &quot;@mozilla.org/addressbook/abldifservice;1&quot;</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineplus">+#define NS_ABLDIFSERVICE_CONTRACTID &quot;@mozilla.org/addressbook/abldifservice;1&quot;</span>
<a href="#l1.595"></a><span id="l1.595"> </span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-#endif // nsAbBaseCID_h__</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineplus">+#endif  // nsAbBaseCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAddressCollector.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAddressCollector.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -19,296 +19,260 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> using namespace mozilla::mailnews;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> NS_IMPL_ISUPPORTS(nsAbAddressCollector, nsIAbAddressCollector, nsIObserver)</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #define PREF_MAIL_COLLECT_ADDRESSBOOK &quot;mail.collect_addressbook&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-nsAbAddressCollector::nsAbAddressCollector()</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-}</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+nsAbAddressCollector::nsAbAddressCollector() {}</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-nsAbAddressCollector::~nsAbAddressCollector()</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-{</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+nsAbAddressCollector::~nsAbAddressCollector() {</span>
<a href="#l2.20"></a><span id="l2.20">   nsresult rv;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranchInt(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranchInt(</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.24"></a><span id="l2.24">   if (NS_SUCCEEDED(rv))</span>
<a href="#l2.25"></a><span id="l2.25">     pPrefBranchInt-&gt;RemoveObserver(PREF_MAIL_COLLECT_ADDRESSBOOK, this);</span>
<a href="#l2.26"></a><span id="l2.26"> }</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> /**</span>
<a href="#l2.29"></a><span id="l2.29">  * Returns the first card found with the specified email address. This</span>
<a href="#l2.30"></a><span id="l2.30">  * returns an already addrefed pointer to the card if the card is found.</span>
<a href="#l2.31"></a><span id="l2.31">  */</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-already_AddRefed&lt;nsIAbCard&gt;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-nsAbAddressCollector::GetCardForAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-                                        nsIAbDirectory **aDirectory)</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-{</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+already_AddRefed&lt;nsIAbCard&gt; nsAbAddressCollector::GetCardForAddress(</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    const nsACString &amp;aEmailAddress, nsIAbDirectory **aDirectory) {</span>
<a href="#l2.38"></a><span id="l2.38">   nsresult rv;</span>
<a href="#l2.39"></a><span id="l2.39">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l2.40"></a><span id="l2.40">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l2.43"></a><span id="l2.43">   rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l2.44"></a><span id="l2.44">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">   bool hasMore;</span>
<a href="#l2.47"></a><span id="l2.47">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.48"></a><span id="l2.48">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l2.49"></a><span id="l2.49">   nsCOMPtr&lt;nsIAbCard&gt; result;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l2.53"></a><span id="l2.53">     rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.54"></a><span id="l2.54">     NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">     directory = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-      continue;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">     // Some implementations may return NS_ERROR_NOT_IMPLEMENTED here,</span>
<a href="#l2.62"></a><span id="l2.62">     // so just catch the value and continue.</span>
<a href="#l2.63"></a><span id="l2.63">     if (NS_FAILED(directory-&gt;CardForEmailAddress(aEmailAddress,</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-                                                 getter_AddRefs(result))))</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+                                                 getter_AddRefs(result)))) {</span>
<a href="#l2.67"></a><span id="l2.67">       continue;</span>
<a href="#l2.68"></a><span id="l2.68">     }</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    if (result)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-      if (aDirectory)</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-        directory.forget(aDirectory);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    if (result) {</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+      if (aDirectory) directory.forget(aDirectory);</span>
<a href="#l2.76"></a><span id="l2.76">       return result.forget();</span>
<a href="#l2.77"></a><span id="l2.77">     }</span>
<a href="#l2.78"></a><span id="l2.78">   }</span>
<a href="#l2.79"></a><span id="l2.79">   return nullptr;</span>
<a href="#l2.80"></a><span id="l2.80"> }</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82"> NS_IMETHODIMP</span>
<a href="#l2.83"></a><span id="l2.83"> nsAbAddressCollector::CollectAddress(const nsACString &amp;aAddresses,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-                                     bool aCreateCard,</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-                                     uint32_t aSendFormat)</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-{</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                                     bool aCreateCard, uint32_t aSendFormat) {</span>
<a href="#l2.88"></a><span id="l2.88">   // If we've not got a valid directory, no point in going any further</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  if (!mDirectory)</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  if (!mDirectory) return NS_OK;</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">   // note that we're now setting the whole recipient list,</span>
<a href="#l2.94"></a><span id="l2.94">   // not just the pretty name of the first recipient.</span>
<a href="#l2.95"></a><span id="l2.95">   nsTArray&lt;nsCString&gt; names;</span>
<a href="#l2.96"></a><span id="l2.96">   nsTArray&lt;nsCString&gt; addresses;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-  ExtractAllAddresses(EncodedHeader(aAddresses),</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    UTF16ArrayAdapter&lt;&gt;(names), UTF16ArrayAdapter&lt;&gt;(addresses));</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  ExtractAllAddresses(EncodedHeader(aAddresses), UTF16ArrayAdapter&lt;&gt;(names),</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+                      UTF16ArrayAdapter&lt;&gt;(addresses));</span>
<a href="#l2.101"></a><span id="l2.101">   uint32_t numAddresses = names.Length();</span>
<a href="#l2.102"></a><span id="l2.102"> </span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  for (uint32_t i = 0; i &lt; numAddresses; i++)</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-  {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  for (uint32_t i = 0; i &lt; numAddresses; i++) {</span>
<a href="#l2.106"></a><span id="l2.106">     // Don't allow collection of addresses with no email address, it makes</span>
<a href="#l2.107"></a><span id="l2.107">     // no sense. Whilst we should never get here in most normal cases, we</span>
<a href="#l2.108"></a><span id="l2.108">     // should still be careful.</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-    if (addresses[i].IsEmpty())</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-      continue;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    if (addresses[i].IsEmpty()) continue;</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113">     CollectSingleAddress(addresses[i], names[i], aCreateCard, aSendFormat,</span>
<a href="#l2.114"></a><span id="l2.114">                          false);</span>
<a href="#l2.115"></a><span id="l2.115">   }</span>
<a href="#l2.116"></a><span id="l2.116">   return NS_OK;</span>
<a href="#l2.117"></a><span id="l2.117"> }</span>
<a href="#l2.118"></a><span id="l2.118"> </span>
<a href="#l2.119"></a><span id="l2.119"> NS_IMETHODIMP</span>
<a href="#l2.120"></a><span id="l2.120"> nsAbAddressCollector::CollectSingleAddress(const nsACString &amp;aEmail,</span>
<a href="#l2.121"></a><span id="l2.121">                                            const nsACString &amp;aDisplayName,</span>
<a href="#l2.122"></a><span id="l2.122">                                            bool aCreateCard,</span>
<a href="#l2.123"></a><span id="l2.123">                                            uint32_t aSendFormat,</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-                                           bool aSkipCheckExisting)</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-{</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-  if (!mDirectory)</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+                                           bool aSkipCheckExisting) {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  if (!mDirectory) return NS_OK;</span>
<a href="#l2.130"></a><span id="l2.130"> </span>
<a href="#l2.131"></a><span id="l2.131">   nsresult rv;</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133">   nsCOMPtr&lt;nsIAbDirectory&gt; originDirectory;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card = (!aSkipCheckExisting) ?</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-    GetCardForAddress(aEmail, getter_AddRefs(originDirectory)) : nullptr;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card =</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+      (!aSkipCheckExisting)</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+          ? GetCardForAddress(aEmail, getter_AddRefs(originDirectory))</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+          : nullptr;</span>
<a href="#l2.140"></a><span id="l2.140"> </span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-  if (!card &amp;&amp; (aCreateCard || aSkipCheckExisting))</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  {</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  if (!card &amp;&amp; (aCreateCard || aSkipCheckExisting)) {</span>
<a href="#l2.144"></a><span id="l2.144">     card = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; card)</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-    {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; card) {</span>
<a href="#l2.148"></a><span id="l2.148">       // Set up the fields for the new card.</span>
<a href="#l2.149"></a><span id="l2.149">       SetNamesForCard(card, aDisplayName);</span>
<a href="#l2.150"></a><span id="l2.150">       AutoCollectScreenName(card, aEmail);</span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-      if (NS_SUCCEEDED(card-&gt;SetPrimaryEmail(NS_ConvertUTF8toUTF16(aEmail))))</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-      {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      if (NS_SUCCEEDED(card-&gt;SetPrimaryEmail(NS_ConvertUTF8toUTF16(aEmail)))) {</span>
<a href="#l2.155"></a><span id="l2.155">         card-&gt;SetPropertyAsUint32(kPreferMailFormatProperty, aSendFormat);</span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157">         nsCOMPtr&lt;nsIAbCard&gt; addedCard;</span>
<a href="#l2.158"></a><span id="l2.158">         rv = mDirectory-&gt;AddCard(card, getter_AddRefs(addedCard));</span>
<a href="#l2.159"></a><span id="l2.159">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to add card&quot;);</span>
<a href="#l2.160"></a><span id="l2.160">       }</span>
<a href="#l2.161"></a><span id="l2.161">     }</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-  }</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-  else if (card &amp;&amp; originDirectory)</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-  {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+  } else if (card &amp;&amp; originDirectory) {</span>
<a href="#l2.166"></a><span id="l2.166">     // It could be that the origin directory is read-only, so don't try and</span>
<a href="#l2.167"></a><span id="l2.167">     // write to it if it is.</span>
<a href="#l2.168"></a><span id="l2.168">     bool readOnly;</span>
<a href="#l2.169"></a><span id="l2.169">     rv = originDirectory-&gt;GetReadOnly(&amp;readOnly);</span>
<a href="#l2.170"></a><span id="l2.170">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.171"></a><span id="l2.171"> </span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-    if (readOnly)</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-      return NS_OK;</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+    if (readOnly) return NS_OK;</span>
<a href="#l2.175"></a><span id="l2.175"> </span>
<a href="#l2.176"></a><span id="l2.176">     // address is already in the AB, so update the names</span>
<a href="#l2.177"></a><span id="l2.177">     bool modifiedCard = false;</span>
<a href="#l2.178"></a><span id="l2.178"> </span>
<a href="#l2.179"></a><span id="l2.179">     nsString displayName;</span>
<a href="#l2.180"></a><span id="l2.180">     card-&gt;GetDisplayName(displayName);</span>
<a href="#l2.181"></a><span id="l2.181">     // If we already have a display name, don't set the names on the card.</span>
<a href="#l2.182"></a><span id="l2.182">     if (displayName.IsEmpty() &amp;&amp; !aDisplayName.IsEmpty())</span>
<a href="#l2.183"></a><span id="l2.183">       modifiedCard = SetNamesForCard(card, aDisplayName);</span>
<a href="#l2.184"></a><span id="l2.184"> </span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-    if (aSendFormat != nsIAbPreferMailFormat::unknown)</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-    {</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+    if (aSendFormat != nsIAbPreferMailFormat::unknown) {</span>
<a href="#l2.188"></a><span id="l2.188">       uint32_t currentFormat;</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-      rv = card-&gt;GetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-                                     &amp;currentFormat);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+      rv = card-&gt;GetPropertyAsUint32(kPreferMailFormatProperty, &amp;currentFormat);</span>
<a href="#l2.192"></a><span id="l2.192">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to get preferred mail format&quot;);</span>
<a href="#l2.193"></a><span id="l2.193"> </span>
<a href="#l2.194"></a><span id="l2.194">       // we only want to update the AB if the current format is unknown</span>
<a href="#l2.195"></a><span id="l2.195">       if (currentFormat == nsIAbPreferMailFormat::unknown &amp;&amp;</span>
<a href="#l2.196"></a><span id="l2.196">           NS_SUCCEEDED(card-&gt;SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l2.197"></a><span id="l2.197">                                                  aSendFormat)))</span>
<a href="#l2.198"></a><span id="l2.198">         modifiedCard = true;</span>
<a href="#l2.199"></a><span id="l2.199">     }</span>
<a href="#l2.200"></a><span id="l2.200"> </span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-    if (modifiedCard)</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-      originDirectory-&gt;ModifyCard(card);</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+    if (modifiedCard) originDirectory-&gt;ModifyCard(card);</span>
<a href="#l2.204"></a><span id="l2.204">   }</span>
<a href="#l2.205"></a><span id="l2.205"> </span>
<a href="#l2.206"></a><span id="l2.206">   return NS_OK;</span>
<a href="#l2.207"></a><span id="l2.207"> }</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209"> // Works out the screen name to put on the card for some well-known addresses</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-void</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-nsAbAddressCollector::AutoCollectScreenName(nsIAbCard *aCard,</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-                                            const nsACString &amp;aEmail)</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-{</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-  if (!aCard)</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-    return;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+void nsAbAddressCollector::AutoCollectScreenName(nsIAbCard *aCard,</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+                                                 const nsACString &amp;aEmail) {</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  if (!aCard) return;</span>
<a href="#l2.219"></a><span id="l2.219"> </span>
<a href="#l2.220"></a><span id="l2.220">   int32_t atPos = aEmail.FindChar('@');</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-  if (atPos == -1)</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-    return;</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+  if (atPos == -1) return;</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-  const nsACString&amp; domain = Substring(aEmail, atPos + 1);</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+  const nsACString &amp;domain = Substring(aEmail, atPos + 1);</span>
<a href="#l2.227"></a><span id="l2.227"> </span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-  if (domain.IsEmpty())</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-    return;</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  if (domain.IsEmpty()) return;</span>
<a href="#l2.231"></a><span id="l2.231">   // username in</span>
<a href="#l2.232"></a><span id="l2.232">   // username@aol.com (America Online)</span>
<a href="#l2.233"></a><span id="l2.233">   // username@cs.com (Compuserve)</span>
<a href="#l2.234"></a><span id="l2.234">   // username@netscape.net (Netscape webmail)</span>
<a href="#l2.235"></a><span id="l2.235">   // are all AIM screennames.  autocollect that info.</span>
<a href="#l2.236"></a><span id="l2.236">   if (domain.EqualsLiteral(&quot;aol.com&quot;) || domain.EqualsLiteral(&quot;cs.com&quot;) ||</span>
<a href="#l2.237"></a><span id="l2.237">       domain.EqualsLiteral(&quot;netscape.net&quot;))</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    aCard-&gt;SetPropertyAsAUTF8String(kScreenNameProperty, Substring(aEmail, 0, atPos));</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-  else if (domain.EqualsLiteral(&quot;gmail.com&quot;) || domain.EqualsLiteral(&quot;googlemail.com&quot;))</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-    aCard-&gt;SetPropertyAsAUTF8String(kGtalkProperty, Substring(aEmail, 0, atPos));</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+    aCard-&gt;SetPropertyAsAUTF8String(kScreenNameProperty,</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+                                    Substring(aEmail, 0, atPos));</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+  else if (domain.EqualsLiteral(&quot;gmail.com&quot;) ||</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+           domain.EqualsLiteral(&quot;googlemail.com&quot;))</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+    aCard-&gt;SetPropertyAsAUTF8String(kGtalkProperty,</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+                                    Substring(aEmail, 0, atPos));</span>
<a href="#l2.247"></a><span id="l2.247"> }</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249"> // Returns true if the card was modified successfully.</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-bool</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-nsAbAddressCollector::SetNamesForCard(nsIAbCard *aSenderCard,</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-                                      const nsACString &amp;aFullName)</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-{</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+bool nsAbAddressCollector::SetNamesForCard(nsIAbCard *aSenderCard,</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+                                           const nsACString &amp;aFullName) {</span>
<a href="#l2.256"></a><span id="l2.256">   nsCString firstName;</span>
<a href="#l2.257"></a><span id="l2.257">   nsCString lastName;</span>
<a href="#l2.258"></a><span id="l2.258">   bool modifiedCard = false;</span>
<a href="#l2.259"></a><span id="l2.259"> </span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-  if (NS_SUCCEEDED(aSenderCard-&gt;SetDisplayName(NS_ConvertUTF8toUTF16(aFullName))))</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+  if (NS_SUCCEEDED(</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+          aSenderCard-&gt;SetDisplayName(NS_ConvertUTF8toUTF16(aFullName))))</span>
<a href="#l2.263"></a><span id="l2.263">     modifiedCard = true;</span>
<a href="#l2.264"></a><span id="l2.264"> </span>
<a href="#l2.265"></a><span id="l2.265">   // Now split up the full name.</span>
<a href="#l2.266"></a><span id="l2.266">   SplitFullName(nsCString(aFullName), firstName, lastName);</span>
<a href="#l2.267"></a><span id="l2.267"> </span>
<a href="#l2.268"></a><span id="l2.268">   if (!firstName.IsEmpty() &amp;&amp;</span>
<a href="#l2.269"></a><span id="l2.269">       NS_SUCCEEDED(aSenderCard-&gt;SetFirstName(NS_ConvertUTF8toUTF16(firstName))))</span>
<a href="#l2.270"></a><span id="l2.270">     modifiedCard = true;</span>
<a href="#l2.271"></a><span id="l2.271"> </span>
<a href="#l2.272"></a><span id="l2.272">   if (!lastName.IsEmpty() &amp;&amp;</span>
<a href="#l2.273"></a><span id="l2.273">       NS_SUCCEEDED(aSenderCard-&gt;SetLastName(NS_ConvertUTF8toUTF16(lastName))))</span>
<a href="#l2.274"></a><span id="l2.274">     modifiedCard = true;</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-  if (modifiedCard)</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-    aSenderCard-&gt;SetPropertyAsBool(&quot;PreferDisplayName&quot;, false);</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+  if (modifiedCard) aSenderCard-&gt;SetPropertyAsBool(&quot;PreferDisplayName&quot;, false);</span>
<a href="#l2.279"></a><span id="l2.279"> </span>
<a href="#l2.280"></a><span id="l2.280">   return modifiedCard;</span>
<a href="#l2.281"></a><span id="l2.281"> }</span>
<a href="#l2.282"></a><span id="l2.282"> </span>
<a href="#l2.283"></a><span id="l2.283"> // Splits the first and last name based on the space between them.</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-void</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-nsAbAddressCollector::SplitFullName(const nsCString &amp;aFullName, nsCString &amp;aFirstName,</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-                                    nsCString &amp;aLastName)</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-{</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+void nsAbAddressCollector::SplitFullName(const nsCString &amp;aFullName,</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+                                         nsCString &amp;aFirstName,</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+                                         nsCString &amp;aLastName) {</span>
<a href="#l2.291"></a><span id="l2.291">   int index = aFullName.RFindChar(' ');</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-  if (index != -1)</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-  {</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+  if (index != -1) {</span>
<a href="#l2.295"></a><span id="l2.295">     aLastName = Substring(aFullName, index + 1);</span>
<a href="#l2.296"></a><span id="l2.296">     aFirstName = Substring(aFullName, 0, index);</span>
<a href="#l2.297"></a><span id="l2.297">   }</span>
<a href="#l2.298"></a><span id="l2.298"> }</span>
<a href="#l2.299"></a><span id="l2.299"> </span>
<a href="#l2.300"></a><span id="l2.300"> // Observes the collected address book pref in case it changes.</span>
<a href="#l2.301"></a><span id="l2.301"> NS_IMETHODIMP</span>
<a href="#l2.302"></a><span id="l2.302"> nsAbAddressCollector::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-                              const char16_t *aData)</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-{</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+                              const char16_t *aData) {</span>
<a href="#l2.306"></a><span id="l2.306">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_QueryInterface(aSubject);</span>
<a href="#l2.307"></a><span id="l2.307">   if (!prefBranch) {</span>
<a href="#l2.308"></a><span id="l2.308">     NS_ASSERTION(prefBranch, &quot;failed to get prefs&quot;);</span>
<a href="#l2.309"></a><span id="l2.309">     return NS_OK;</span>
<a href="#l2.310"></a><span id="l2.310">   }</span>
<a href="#l2.311"></a><span id="l2.311"> </span>
<a href="#l2.312"></a><span id="l2.312">   SetUpAbFromPrefs(prefBranch);</span>
<a href="#l2.313"></a><span id="l2.313">   return NS_OK;</span>
<a href="#l2.314"></a><span id="l2.314"> }</span>
<a href="#l2.315"></a><span id="l2.315"> </span>
<a href="#l2.316"></a><span id="l2.316"> // Initialises the collector with the required items.</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-nsresult</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-nsAbAddressCollector::Init(void)</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-{</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+nsresult nsAbAddressCollector::Init(void) {</span>
<a href="#l2.321"></a><span id="l2.321">   nsresult rv;</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-                                                   &amp;rv));</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.326"></a><span id="l2.326">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.327"></a><span id="l2.327"> </span>
<a href="#l2.328"></a><span id="l2.328">   rv = prefBranch-&gt;AddObserver(PREF_MAIL_COLLECT_ADDRESSBOOK, this, false);</span>
<a href="#l2.329"></a><span id="l2.329">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.330"></a><span id="l2.330"> </span>
<a href="#l2.331"></a><span id="l2.331">   SetUpAbFromPrefs(prefBranch);</span>
<a href="#l2.332"></a><span id="l2.332">   return NS_OK;</span>
<a href="#l2.333"></a><span id="l2.333"> }</span>
<a href="#l2.334"></a><span id="l2.334"> </span>
<a href="#l2.335"></a><span id="l2.335"> // Performs the necessary changes to set up the collector for the specified</span>
<a href="#l2.336"></a><span id="l2.336"> // collected address book.</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-void</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-nsAbAddressCollector::SetUpAbFromPrefs(nsIPrefBranch *aPrefBranch)</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-{</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+void nsAbAddressCollector::SetUpAbFromPrefs(nsIPrefBranch *aPrefBranch) {</span>
<a href="#l2.341"></a><span id="l2.341">   nsCString abURI;</span>
<a href="#l2.342"></a><span id="l2.342">   aPrefBranch-&gt;GetCharPref(PREF_MAIL_COLLECT_ADDRESSBOOK, abURI);</span>
<a href="#l2.343"></a><span id="l2.343"> </span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-  if (abURI.IsEmpty())</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-    abURI.AssignLiteral(kPersonalAddressbookUri);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+  if (abURI.IsEmpty()) abURI.AssignLiteral(kPersonalAddressbookUri);</span>
<a href="#l2.347"></a><span id="l2.347"> </span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-  if (abURI == mABURI)</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-    return;</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+  if (abURI == mABURI) return;</span>
<a href="#l2.351"></a><span id="l2.351"> </span>
<a href="#l2.352"></a><span id="l2.352">   mDirectory = nullptr;</span>
<a href="#l2.353"></a><span id="l2.353">   mABURI = abURI;</span>
<a href="#l2.354"></a><span id="l2.354"> </span>
<a href="#l2.355"></a><span id="l2.355">   nsresult rv;</span>
<a href="#l2.356"></a><span id="l2.356">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l2.357"></a><span id="l2.357">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l2.358"></a><span id="l2.358"> </span>
<a href="#l2.359"></a><span id="l2.359" class="difflineat">@@ -316,15 +280,15 @@ nsAbAddressCollector::SetUpAbFromPrefs(n</span>
<a href="#l2.360"></a><span id="l2.360">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362">   bool readOnly;</span>
<a href="#l2.363"></a><span id="l2.363">   rv = mDirectory-&gt;GetReadOnly(&amp;readOnly);</span>
<a href="#l2.364"></a><span id="l2.364">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l2.365"></a><span id="l2.365"> </span>
<a href="#l2.366"></a><span id="l2.366">   // If the directory is read-only, we can't write to it, so just blank it out</span>
<a href="#l2.367"></a><span id="l2.367">   // here, and warn because we shouldn't hit this (UI is wrong).</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-  if (readOnly)</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-  {</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-    NS_ERROR(&quot;Address Collection book preferences is set to a read-only book. &quot;</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-             &quot;Address collection will not take place.&quot;);</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+  if (readOnly) {</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+    NS_ERROR(</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+        &quot;Address Collection book preferences is set to a read-only book. &quot;</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+        &quot;Address collection will not take place.&quot;);</span>
<a href="#l2.376"></a><span id="l2.376">     mDirectory = nullptr;</span>
<a href="#l2.377"></a><span id="l2.377">   }</span>
<a href="#l2.378"></a><span id="l2.378"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAddressCollector.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAddressCollector.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -10,35 +10,32 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsString.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> class nsIPrefBranch;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-class nsAbAddressCollector : public nsIAbAddressCollector,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                             public nsIObserver</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-{</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-public:</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+class nsAbAddressCollector : public nsIAbAddressCollector, public nsIObserver {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ public:</span>
<a href="#l3.18"></a><span id="l3.18">   nsAbAddressCollector();</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   NS_DECL_ISUPPORTS</span>
<a href="#l3.21"></a><span id="l3.21">   NS_DECL_NSIABADDRESSCOLLECTOR</span>
<a href="#l3.22"></a><span id="l3.22">   NS_DECL_NSIOBSERVER</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   nsresult Init();</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-private:</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ private:</span>
<a href="#l3.28"></a><span id="l3.28">   virtual ~nsAbAddressCollector();</span>
<a href="#l3.29"></a><span id="l3.29">   already_AddRefed&lt;nsIAbCard&gt; GetCardForAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l3.30"></a><span id="l3.30">                                                 nsIAbDirectory **aDirectory);</span>
<a href="#l3.31"></a><span id="l3.31">   void AutoCollectScreenName(nsIAbCard *aCard, const nsACString &amp;aEmail);</span>
<a href="#l3.32"></a><span id="l3.32">   bool SetNamesForCard(nsIAbCard *aSenderCard, const nsACString &amp;aFullName);</span>
<a href="#l3.33"></a><span id="l3.33">   void SplitFullName(const nsCString &amp;aFullName, nsCString &amp;aFirstName,</span>
<a href="#l3.34"></a><span id="l3.34">                      nsCString &amp;aLastName);</span>
<a href="#l3.35"></a><span id="l3.35">   void SetUpAbFromPrefs(nsIPrefBranch *aPrefBranch);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  nsCOMPtr &lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l3.38"></a><span id="l3.38">   nsCString mABURI;</span>
<a href="#l3.39"></a><span id="l3.39"> };</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41"> #endif  // _nsAbAddressCollector_H_</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -12,144 +12,129 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-nsAbBSDirectory::nsAbBSDirectory()</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-: mInitialized(false)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-, mServers(13)</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-{</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-}</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+nsAbBSDirectory::nsAbBSDirectory() : mInitialized(false), mServers(13) {}</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-nsAbBSDirectory::~nsAbBSDirectory()</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-{</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-}</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+nsAbBSDirectory::~nsAbBSDirectory() {}</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::Init(const char *aURI)</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-{</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::Init(const char *aURI) {</span>
<a href="#l4.27"></a><span id="l4.27">   mURI = aURI;</span>
<a href="#l4.28"></a><span id="l4.28">   return NS_OK;</span>
<a href="#l4.29"></a><span id="l4.29"> }</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31"> NS_IMPL_ISUPPORTS_INHERITED0(nsAbBSDirectory, nsAbDirProperty)</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33"> nsresult nsAbBSDirectory::CreateDirectoriesFromFactory(const nsACString &amp;aURI,</span>
<a href="#l4.34"></a><span id="l4.34">                                                        DIR_Server *aServer,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-                                                       bool aNotify)</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-{</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+                                                       bool aNotify) {</span>
<a href="#l4.38"></a><span id="l4.38">   nsresult rv;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">   // Get the directory factory service</span>
<a href="#l4.41"></a><span id="l4.41">   nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+      do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">   // Get the directory factory from the URI</span>
<a href="#l4.48"></a><span id="l4.48">   nsCOMPtr&lt;nsIAbDirFactory&gt; dirFactory;</span>
<a href="#l4.49"></a><span id="l4.49">   rv = dirFactoryService-&gt;GetDirFactory(aURI, getter_AddRefs(dirFactory));</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">   // Create the directories</span>
<a href="#l4.54"></a><span id="l4.54">   nsCOMPtr&lt;nsISimpleEnumerator&gt; newDirEnumerator;</span>
<a href="#l4.55"></a><span id="l4.55">   rv = dirFactory-&gt;GetDirectories(NS_ConvertUTF8toUTF16(aServer-&gt;description),</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-                                  aURI,</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-                                  nsDependentCString(aServer-&gt;prefName),</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+                                  aURI, nsDependentCString(aServer-&gt;prefName),</span>
<a href="#l4.59"></a><span id="l4.59">                                   getter_AddRefs(newDirEnumerator));</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">   // Enumerate through the directories adding them</span>
<a href="#l4.64"></a><span id="l4.64">   // to the sub directories array</span>
<a href="#l4.65"></a><span id="l4.65">   bool hasMore;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  while (NS_SUCCEEDED(newDirEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-  {</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  while (NS_SUCCEEDED(newDirEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l4.73"></a><span id="l4.73">     nsCOMPtr&lt;nsISupports&gt; newDirSupports;</span>
<a href="#l4.74"></a><span id="l4.74">     rv = newDirEnumerator-&gt;GetNext(getter_AddRefs(newDirSupports));</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-      continue;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79">     nsCOMPtr&lt;nsIAbDirectory&gt; childDir = do_QueryInterface(newDirSupports, &amp;rv);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-      continue;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84">     // Define a relationship between the preference</span>
<a href="#l4.85"></a><span id="l4.85">     // entry and the directory</span>
<a href="#l4.86"></a><span id="l4.86">     mServers.Put(childDir, aServer);</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">     mSubDirectories.AppendObject(childDir);</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90">     if (aNotify &amp;&amp; abManager)</span>
<a href="#l4.91"></a><span id="l4.91">       abManager-&gt;NotifyDirectoryItemAdded(this, childDir);</span>
<a href="#l4.92"></a><span id="l4.92">   }</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94">   return NS_OK;</span>
<a href="#l4.95"></a><span id="l4.95"> }</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::GetChildNodes(nsISimpleEnumerator* *aResult)</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-{</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::GetChildNodes(nsISimpleEnumerator **aResult) {</span>
<a href="#l4.100"></a><span id="l4.100">   nsresult rv = EnsureInitialized();</span>
<a href="#l4.101"></a><span id="l4.101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-  return NS_NewArrayEnumerator(aResult, mSubDirectories, NS_GET_IID(nsIAbDirectory));</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  return NS_NewArrayEnumerator(aResult, mSubDirectories,</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+                               NS_GET_IID(nsIAbDirectory));</span>
<a href="#l4.106"></a><span id="l4.106"> }</span>
<a href="#l4.107"></a><span id="l4.107"> </span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-nsresult nsAbBSDirectory::EnsureInitialized()</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-{</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-  if (mInitialized)</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+nsresult nsAbBSDirectory::EnsureInitialized() {</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  if (mInitialized) return NS_OK;</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115">   nsresult rv;</span>
<a href="#l4.116"></a><span id="l4.116">   nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-    do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.121"></a><span id="l4.121"> </span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-  nsTArray&lt;DIR_Server*&gt; *directories = DIR_GetDirectories();</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-  if (!directories)</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  nsTArray&lt;DIR_Server *&gt; *directories = DIR_GetDirectories();</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+  if (!directories) return NS_ERROR_FAILURE;</span>
<a href="#l4.127"></a><span id="l4.127"> </span>
<a href="#l4.128"></a><span id="l4.128">   int32_t count = directories-&gt;Length();</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-  for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-  {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l4.132"></a><span id="l4.132">     DIR_Server *server = directories-&gt;ElementAt(i);</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">     // if this is a 4.x, local .na2 addressbook (PABDirectory)</span>
<a href="#l4.135"></a><span id="l4.135">     // we must skip it.</span>
<a href="#l4.136"></a><span id="l4.136">     // mozilla can't handle 4.x .na2 addressbooks</span>
<a href="#l4.137"></a><span id="l4.137">     // note, the filename might be na2 for 4.x LDAP directories</span>
<a href="#l4.138"></a><span id="l4.138">     // (we used the .na2 file for replication), and we don't want to skip</span>
<a href="#l4.139"></a><span id="l4.139">     // those.  see bug #127007</span>
<a href="#l4.140"></a><span id="l4.140">     uint32_t fileNameLen = strlen(server-&gt;fileName);</span>
<a href="#l4.141"></a><span id="l4.141">     if (((fileNameLen &gt; kABFileName_PreviousSuffixLen) &amp;&amp;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-      strcmp(server-&gt;fileName + fileNameLen - kABFileName_PreviousSuffixLen,</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-             kABFileName_PreviousSuffix) == 0) &amp;&amp;</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-      (server-&gt;dirType == PABDirectory))</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+         strcmp(server-&gt;fileName + fileNameLen - kABFileName_PreviousSuffixLen,</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+                kABFileName_PreviousSuffix) == 0) &amp;&amp;</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+        (server-&gt;dirType == PABDirectory))</span>
<a href="#l4.148"></a><span id="l4.148">       continue;</span>
<a href="#l4.149"></a><span id="l4.149"> </span>
<a href="#l4.150"></a><span id="l4.150">     // Set the uri property</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-    nsAutoCString URI (server-&gt;uri);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+    nsAutoCString URI(server-&gt;uri);</span>
<a href="#l4.153"></a><span id="l4.153">     // This is in case the uri is never set</span>
<a href="#l4.154"></a><span id="l4.154">     // in the nsDirPref.cpp code.</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-    if (!server-&gt;uri)</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-    {</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+    if (!server-&gt;uri) {</span>
<a href="#l4.158"></a><span id="l4.158">       URI = NS_LITERAL_CSTRING(kMDBDirectoryRoot);</span>
<a href="#l4.159"></a><span id="l4.159">       URI += nsDependentCString(server-&gt;fileName);</span>
<a href="#l4.160"></a><span id="l4.160">     }</span>
<a href="#l4.161"></a><span id="l4.161"> </span>
<a href="#l4.162"></a><span id="l4.162">     /*</span>
<a href="#l4.163"></a><span id="l4.163">      * Check that we are not converting from a</span>
<a href="#l4.164"></a><span id="l4.164">      * a 4.x address book file e.g. pab.na2</span>
<a href="#l4.165"></a><span id="l4.165">      * check if the URI ends with &quot;.na2&quot;</span>
<a href="#l4.166"></a><span id="l4.166">      */</span>
<a href="#l4.167"></a><span id="l4.167">     if (StringEndsWith(URI, NS_LITERAL_CSTRING(kABFileName_PreviousSuffix)))</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-      URI.Replace(kMDBDirectoryRootLen, URI.Length() - kMDBDirectoryRootLen, server-&gt;fileName);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+      URI.Replace(kMDBDirectoryRootLen, URI.Length() - kMDBDirectoryRootLen,</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+                  server-&gt;fileName);</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172">     // Create the directories</span>
<a href="#l4.173"></a><span id="l4.173">     rv = CreateDirectoriesFromFactory(URI, server, false /* notify */);</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175">     // If we failed, this could be because something has set a pref for us</span>
<a href="#l4.176"></a><span id="l4.176">     // which is now broke (e.g. no factory present). So just ignore this one</span>
<a href="#l4.177"></a><span id="l4.177">     // and move on.</span>
<a href="#l4.178"></a><span id="l4.178">     if (NS_FAILED(rv))</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineat">@@ -160,18 +145,17 @@ nsresult nsAbBSDirectory::EnsureInitiali</span>
<a href="#l4.180"></a><span id="l4.180">   // sort directories by position...</span>
<a href="#l4.181"></a><span id="l4.181">   return NS_OK;</span>
<a href="#l4.182"></a><span id="l4.182"> }</span>
<a href="#l4.183"></a><span id="l4.183"> </span>
<a href="#l4.184"></a><span id="l4.184"> NS_IMETHODIMP nsAbBSDirectory::CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l4.185"></a><span id="l4.185">                                                   const nsACString &amp;aURI,</span>
<a href="#l4.186"></a><span id="l4.186">                                                   uint32_t aType,</span>
<a href="#l4.187"></a><span id="l4.187">                                                   const nsACString &amp;aPrefName,</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-                                                  nsACString &amp;aResult)</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-{</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+                                                  nsACString &amp;aResult) {</span>
<a href="#l4.191"></a><span id="l4.191">   nsresult rv = EnsureInitialized();</span>
<a href="#l4.192"></a><span id="l4.192">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.193"></a><span id="l4.193"> </span>
<a href="#l4.194"></a><span id="l4.194">   /*</span>
<a href="#l4.195"></a><span id="l4.195">    * TODO</span>
<a href="#l4.196"></a><span id="l4.196">    * This procedure is still MDB specific</span>
<a href="#l4.197"></a><span id="l4.197">    * due to the dependence on the current</span>
<a href="#l4.198"></a><span id="l4.198">    * nsDirPref.cpp code</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineat">@@ -183,140 +167,128 @@ NS_IMETHODIMP nsAbBSDirectory::CreateNew</span>
<a href="#l4.200"></a><span id="l4.200">    * The creation of the address book in the preferences</span>
<a href="#l4.201"></a><span id="l4.201">    * is very MDB implementation specific.</span>
<a href="#l4.202"></a><span id="l4.202">    * If the fileName attribute is null then it will</span>
<a href="#l4.203"></a><span id="l4.203">    * create an appropriate file name.</span>
<a href="#l4.204"></a><span id="l4.204">    * Somehow have to resolve this issue so that it</span>
<a href="#l4.205"></a><span id="l4.205">    * is more general.</span>
<a href="#l4.206"></a><span id="l4.206">    *</span>
<a href="#l4.207"></a><span id="l4.207">    */</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-  DIR_Server* server = nullptr;</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+  DIR_Server *server = nullptr;</span>
<a href="#l4.210"></a><span id="l4.210">   rv = DIR_AddNewAddressBook(aDirName, EmptyCString(), URI,</span>
<a href="#l4.211"></a><span id="l4.211">                              (DirectoryType)aType, aPrefName, &amp;server);</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.214"></a><span id="l4.214"> </span>
<a href="#l4.215"></a><span id="l4.215">   if (aType == PABDirectory) {</span>
<a href="#l4.216"></a><span id="l4.216">     // Add the URI property</span>
<a href="#l4.217"></a><span id="l4.217">     URI.AssignLiteral(kMDBDirectoryRoot);</span>
<a href="#l4.218"></a><span id="l4.218">     URI.Append(nsDependentCString(server-&gt;fileName));</span>
<a href="#l4.219"></a><span id="l4.219">   }</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221">   aResult.Assign(server-&gt;prefName);</span>
<a href="#l4.222"></a><span id="l4.222"> </span>
<a href="#l4.223"></a><span id="l4.223">   rv = CreateDirectoriesFromFactory(URI, server, true /* notify */);</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.226"></a><span id="l4.226">   return rv;</span>
<a href="#l4.227"></a><span id="l4.227"> }</span>
<a href="#l4.228"></a><span id="l4.228"> </span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::CreateDirectoryByURI(const nsAString &amp;aDisplayName,</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-                                                    const nsACString &amp;aURI)</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-{</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::CreateDirectoryByURI(</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+    const nsAString &amp;aDisplayName, const nsACString &amp;aURI) {</span>
<a href="#l4.234"></a><span id="l4.234">   nsresult rv = EnsureInitialized();</span>
<a href="#l4.235"></a><span id="l4.235">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.236"></a><span id="l4.236"> </span>
<a href="#l4.237"></a><span id="l4.237">   nsCString fileName;</span>
<a href="#l4.238"></a><span id="l4.238">   if (StringBeginsWith(aURI, NS_LITERAL_CSTRING(kMDBDirectoryRoot)))</span>
<a href="#l4.239"></a><span id="l4.239">     fileName = Substring(aURI, kMDBDirectoryRootLen);</span>
<a href="#l4.240"></a><span id="l4.240"> </span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-  DIR_Server * server = nullptr;</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-  rv = DIR_AddNewAddressBook(aDisplayName, fileName, aURI,</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-                             PABDirectory, EmptyCString(), &amp;server);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+  DIR_Server *server = nullptr;</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+  rv = DIR_AddNewAddressBook(aDisplayName, fileName, aURI, PABDirectory,</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+                             EmptyCString(), &amp;server);</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">   rv = CreateDirectoriesFromFactory(aURI, server, true /* notify */);</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.253"></a><span id="l4.253">   return rv;</span>
<a href="#l4.254"></a><span id="l4.254"> }</span>
<a href="#l4.255"></a><span id="l4.255"> </span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::DeleteDirectory(nsIAbDirectory *directory)</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-{</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l4.259"></a><span id="l4.259">   NS_ENSURE_ARG_POINTER(directory);</span>
<a href="#l4.260"></a><span id="l4.260"> </span>
<a href="#l4.261"></a><span id="l4.261">   nsresult rv = EnsureInitialized();</span>
<a href="#l4.262"></a><span id="l4.262">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264">   DIR_Server *server = nullptr;</span>
<a href="#l4.265"></a><span id="l4.265">   mServers.Get(directory, &amp;server);</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-  if (!server)</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+  if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l4.270"></a><span id="l4.270"> </span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-  struct GetDirectories</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-  {</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-    explicit GetDirectories(DIR_Server* aServer) : mServer(aServer) { }</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+  struct GetDirectories {</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+    explicit GetDirectories(DIR_Server *aServer) : mServer(aServer) {}</span>
<a href="#l4.276"></a><span id="l4.276"> </span>
<a href="#l4.277"></a><span id="l4.277">     nsCOMArray&lt;nsIAbDirectory&gt; directories;</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-    DIR_Server* mServer;</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+    DIR_Server *mServer;</span>
<a href="#l4.280"></a><span id="l4.280">   };</span>
<a href="#l4.281"></a><span id="l4.281">   GetDirectories getDirectories(server);</span>
<a href="#l4.282"></a><span id="l4.282">   for (auto iter = mServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l4.283"></a><span id="l4.283">     if (iter.UserData() == getDirectories.mServer) {</span>
<a href="#l4.284"></a><span id="l4.284">       nsCOMPtr&lt;nsIAbDirectory&gt; abDir = do_QueryInterface(iter.Key());</span>
<a href="#l4.285"></a><span id="l4.285">       getDirectories.directories.AppendObject(abDir);</span>
<a href="#l4.286"></a><span id="l4.286">     }</span>
<a href="#l4.287"></a><span id="l4.287">   }</span>
<a href="#l4.288"></a><span id="l4.288"> </span>
<a href="#l4.289"></a><span id="l4.289">   DIR_DeleteServerFromList(server);</span>
<a href="#l4.290"></a><span id="l4.290"> </span>
<a href="#l4.291"></a><span id="l4.291">   nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-    do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+      do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.296"></a><span id="l4.296"> </span>
<a href="#l4.297"></a><span id="l4.297">   uint32_t count = getDirectories.directories.Count();</span>
<a href="#l4.298"></a><span id="l4.298"> </span>
<a href="#l4.299"></a><span id="l4.299">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID);</span>
<a href="#l4.300"></a><span id="l4.300"> </span>
<a href="#l4.301"></a><span id="l4.301">   for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l4.302"></a><span id="l4.302">     nsCOMPtr&lt;nsIAbDirectory&gt; d = getDirectories.directories[i];</span>
<a href="#l4.303"></a><span id="l4.303"> </span>
<a href="#l4.304"></a><span id="l4.304">     mServers.Remove(d);</span>
<a href="#l4.305"></a><span id="l4.305">     mSubDirectories.RemoveObject(d);</span>
<a href="#l4.306"></a><span id="l4.306"> </span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-    if (abManager)</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-      abManager-&gt;NotifyDirectoryDeleted(this, d);</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+    if (abManager) abManager-&gt;NotifyDirectoryDeleted(this, d);</span>
<a href="#l4.310"></a><span id="l4.310"> </span>
<a href="#l4.311"></a><span id="l4.311">     nsCString uri;</span>
<a href="#l4.312"></a><span id="l4.312">     rv = d-&gt;GetURI(uri);</span>
<a href="#l4.313"></a><span id="l4.313">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.314"></a><span id="l4.314"> </span>
<a href="#l4.315"></a><span id="l4.315">     nsCOMPtr&lt;nsIAbDirFactory&gt; dirFactory;</span>
<a href="#l4.316"></a><span id="l4.316">     rv = dirFactoryService-&gt;GetDirFactory(uri, getter_AddRefs(dirFactory));</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-      continue;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l4.320"></a><span id="l4.320"> </span>
<a href="#l4.321"></a><span id="l4.321">     rv = dirFactory-&gt;DeleteDirectory(d);</span>
<a href="#l4.322"></a><span id="l4.322">   }</span>
<a href="#l4.323"></a><span id="l4.323"> </span>
<a href="#l4.324"></a><span id="l4.324">   return rv;</span>
<a href="#l4.325"></a><span id="l4.325"> }</span>
<a href="#l4.326"></a><span id="l4.326"> </span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::HasDirectory(nsIAbDirectory *dir, bool *hasDir)</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-{</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-  if (!hasDir)</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::HasDirectory(nsIAbDirectory *dir, bool *hasDir) {</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+  if (!hasDir) return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.333"></a><span id="l4.333"> </span>
<a href="#l4.334"></a><span id="l4.334">   nsresult rv = EnsureInitialized();</span>
<a href="#l4.335"></a><span id="l4.335">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.336"></a><span id="l4.336"> </span>
<a href="#l4.337"></a><span id="l4.337">   DIR_Server *dirServer = nullptr;</span>
<a href="#l4.338"></a><span id="l4.338">   mServers.Get(dir, &amp;dirServer);</span>
<a href="#l4.339"></a><span id="l4.339">   return DIR_ContainsServer(dirServer, hasDir);</span>
<a href="#l4.340"></a><span id="l4.340"> }</span>
<a href="#l4.341"></a><span id="l4.341"> </span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-                                                  bool *aResult)</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-{</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::UseForAutocomplete(</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+    const nsACString &amp;aIdentityKey, bool *aResult) {</span>
<a href="#l4.347"></a><span id="l4.347">   // For the &quot;root&quot; directory (kAllDirectoryRoot) always return true so that</span>
<a href="#l4.348"></a><span id="l4.348">   // we can search sub directories that may or may not be local.</span>
<a href="#l4.349"></a><span id="l4.349">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l4.350"></a><span id="l4.350">   *aResult = true;</span>
<a href="#l4.351"></a><span id="l4.351">   return NS_OK;</span>
<a href="#l4.352"></a><span id="l4.352"> }</span>
<a href="#l4.353"></a><span id="l4.353"> </span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-{</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::GetURI(nsACString &amp;aURI) {</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l4.360"></a><span id="l4.360"> </span>
<a href="#l4.361"></a><span id="l4.361">   aURI = mURI;</span>
<a href="#l4.362"></a><span id="l4.362">   return NS_OK;</span>
<a href="#l4.363"></a><span id="l4.363"> }</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBSDirectory.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,50 +1,48 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-</span>
<a href="#l5.10"></a><span id="l5.10"> #ifndef nsAbBSDirectory_h__</span>
<a href="#l5.11"></a><span id="l5.11"> #define nsAbBSDirectory_h__</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-class nsAbBSDirectory : public nsAbDirProperty</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-{</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-public:</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+class nsAbBSDirectory : public nsAbDirProperty {</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+ public:</span>
<a href="#l5.24"></a><span id="l5.24">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   nsAbBSDirectory();</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   // nsIAbDirectory methods</span>
<a href="#l5.29"></a><span id="l5.29">   NS_IMETHOD Init(const char *aURI) override;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  NS_IMETHOD GetChildNodes(nsISimpleEnumerator* *result) override;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  NS_IMETHOD GetChildNodes(nsISimpleEnumerator **result) override;</span>
<a href="#l5.32"></a><span id="l5.32">   NS_IMETHOD CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-                                const nsACString &amp;aURI,</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-                                uint32_t aType,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                                const nsACString &amp;aURI, uint32_t aType,</span>
<a href="#l5.36"></a><span id="l5.36">                                 const nsACString &amp;aPrefName,</span>
<a href="#l5.37"></a><span id="l5.37">                                 nsACString &amp;aResult) override;</span>
<a href="#l5.38"></a><span id="l5.38">   NS_IMETHOD CreateDirectoryByURI(const nsAString &amp;aDisplayName,</span>
<a href="#l5.39"></a><span id="l5.39">                                   const nsACString &amp;aURI) override;</span>
<a href="#l5.40"></a><span id="l5.40">   NS_IMETHOD DeleteDirectory(nsIAbDirectory *directory) override;</span>
<a href="#l5.41"></a><span id="l5.41">   NS_IMETHOD HasDirectory(nsIAbDirectory *dir, bool *hasDir) override;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey, bool *aResult) override;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+                                bool *aResult) override;</span>
<a href="#l5.45"></a><span id="l5.45">   NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-protected:</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+ protected:</span>
<a href="#l5.49"></a><span id="l5.49">   virtual ~nsAbBSDirectory();</span>
<a href="#l5.50"></a><span id="l5.50">   nsresult EnsureInitialized();</span>
<a href="#l5.51"></a><span id="l5.51">   nsresult CreateDirectoriesFromFactory(const nsACString &amp;aURI,</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-                                        DIR_Server* aServer, bool aNotify);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+                                        DIR_Server *aServer, bool aNotify);</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-protected:</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+ protected:</span>
<a href="#l5.57"></a><span id="l5.57">   bool mInitialized;</span>
<a href="#l5.58"></a><span id="l5.58">   nsCOMArray&lt;nsIAbDirectory&gt; mSubDirectories;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  nsDataHashtable&lt;nsISupportsHashKey, DIR_Server*&gt; mServers;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  nsDataHashtable&lt;nsISupportsHashKey, DIR_Server *&gt; mServers;</span>
<a href="#l5.61"></a><span id="l5.61"> };</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,243 +4,221 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsIAbLDAPAttributeMap.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsAbBoolExprToLDAPFilter.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsString.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIArray.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-const int nsAbBoolExprToLDAPFilter::TRANSLATE_CARD_PROPERTY = 1 &lt;&lt; 0 ;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-const int nsAbBoolExprToLDAPFilter::ALLOW_NON_CONVERTABLE_CARD_PROPERTY = 1 &lt;&lt; 1 ;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+const int nsAbBoolExprToLDAPFilter::TRANSLATE_CARD_PROPERTY = 1 &lt;&lt; 0;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+const int nsAbBoolExprToLDAPFilter::ALLOW_NON_CONVERTABLE_CARD_PROPERTY = 1</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+                                                                          &lt;&lt; 1;</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-nsresult nsAbBoolExprToLDAPFilter::Convert (</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-    nsIAbLDAPAttributeMap* map,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-    nsIAbBooleanExpression* expression,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-    nsCString&amp; filter,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-    int flags)</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-{</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-    nsCString f;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-    nsresult rv = FilterExpression (map, expression, f, flags);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+nsresult nsAbBoolExprToLDAPFilter::Convert(nsIAbLDAPAttributeMap* map,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+                                           nsIAbBooleanExpression* expression,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+                                           nsCString&amp; filter, int flags) {</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  nsCString f;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  nsresult rv = FilterExpression(map, expression, f, flags);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-    filter = f;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-    return rv;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  filter = f;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  return rv;</span>
<a href="#l6.38"></a><span id="l6.38"> }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-nsresult nsAbBoolExprToLDAPFilter::FilterExpression (</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-    nsIAbLDAPAttributeMap* map,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    nsIAbBooleanExpression* expression,</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    nsCString&amp; filter,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    int flags)</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-{</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; childExpressions;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    nsresult rv = expression-&gt;GetExpressions(getter_AddRefs(childExpressions));</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+nsresult nsAbBoolExprToLDAPFilter::FilterExpression(</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    nsIAbLDAPAttributeMap* map, nsIAbBooleanExpression* expression,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    nsCString&amp; filter, int flags) {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; childExpressions;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  nsresult rv = expression-&gt;GetExpressions(getter_AddRefs(childExpressions));</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+  uint32_t count;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  rv = childExpressions-&gt;GetLength(&amp;count);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  if (count == 0) return NS_OK;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  nsAbBooleanOperationType operation;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  rv = expression-&gt;GetOperation(&amp;operation);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    uint32_t count;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    rv = childExpressions-&gt;GetLength(&amp;count);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  /*</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+   * 3rd party query integration with Mozilla is achieved</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+   * by calling nsAbLDAPDirectoryQuery::DoQuery(). Thus</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+   * we can arrive here with a query asking for all the</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+   * ldap attributes using the card:nsIAbCard interface.</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+   *</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+   * So we need to check that we are not creating a condition</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+   * filter against this expression otherwise we will end up with an invalid</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+   * filter equal to &quot;(|)&quot;.</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+   */</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    if (count == 0)</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  if (count == 1) {</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    nsCOMPtr&lt;nsIAbBooleanConditionString&gt; childCondition(</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+        do_QueryElementAt(childExpressions, 1, &amp;rv));</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+      nsCString name;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+      rv = childCondition-&gt;GetName(getter_Copies(name));</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    nsAbBooleanOperationType operation;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    rv = expression-&gt;GetOperation(&amp;operation);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+      if (name.EqualsLiteral(&quot;card:nsIAbCard&quot;)) return NS_OK;</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+    }</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  }</span>
<a href="#l6.96"></a><span id="l6.96"> </span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    /*</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-     * 3rd party query integration with Mozilla is achieved</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-     * by calling nsAbLDAPDirectoryQuery::DoQuery(). Thus</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-     * we can arrive here with a query asking for all the</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-     * ldap attributes using the card:nsIAbCard interface.</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-     *</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-     * So we need to check that we are not creating a condition</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-     * filter against this expression otherwise we will end up with an invalid</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-     * filter equal to &quot;(|)&quot;.</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-    */</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  filter.Append('(');</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  switch (operation) {</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+    case nsIAbBooleanOperationTypes::AND:</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+      filter.Append('&amp;');</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+      rv = FilterExpressions(map, childExpressions, filter, flags);</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+      break;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    case nsIAbBooleanOperationTypes::OR:</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+      filter.Append('|');</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+      rv = FilterExpressions(map, childExpressions, filter, flags);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+      break;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+    case nsIAbBooleanOperationTypes::NOT:</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+      if (count &gt; 1) return NS_ERROR_FAILURE;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+      filter.Append('!');</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+      rv = FilterExpressions(map, childExpressions, filter, flags);</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+      break;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+    default:</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+      break;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+  }</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  filter.Append(')');</span>
<a href="#l6.126"></a><span id="l6.126"> </span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-    if (count == 1 )</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-    {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-        nsCOMPtr&lt;nsIAbBooleanConditionString&gt;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-            childCondition(do_QueryElementAt(childExpressions, 1, &amp;rv));</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-        {</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-            nsCString name;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-            rv = childCondition-&gt;GetName (getter_Copies (name));</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+  return rv;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+}</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-            if (name.EqualsLiteral(&quot;card:nsIAbCard&quot;))</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-                return NS_OK;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-        }</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+nsresult nsAbBoolExprToLDAPFilter::FilterExpressions(nsIAbLDAPAttributeMap* map,</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+                                                     nsIArray* expressions,</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+                                                     nsCString&amp; filter,</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+                                                     int flags) {</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+  uint32_t count;</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+  nsresult rv = expressions-&gt;GetLength(&amp;count);</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanConditionString&gt; childCondition;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; childExpression;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+    childCondition = do_QueryElementAt(expressions, i, &amp;rv);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+      rv = FilterCondition(map, childCondition, filter, flags);</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+      continue;</span>
<a href="#l6.158"></a><span id="l6.158">     }</span>
<a href="#l6.159"></a><span id="l6.159"> </span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    filter.Append('(');</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    switch (operation)</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-    {</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-        case nsIAbBooleanOperationTypes::AND:</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-            filter.Append('&amp;');</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-            rv = FilterExpressions (map, childExpressions, filter, flags);</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-            break;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-        case nsIAbBooleanOperationTypes::OR:</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-            filter.Append('|');</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-            rv = FilterExpressions (map, childExpressions, filter, flags);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-            break;</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-        case nsIAbBooleanOperationTypes::NOT:</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-            if (count &gt; 1)</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-                return NS_ERROR_FAILURE;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-            filter.Append('!');</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-            rv = FilterExpressions (map, childExpressions, filter, flags);</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-            break;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-        default:</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-            break;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+    childExpression = do_QueryElementAt(expressions, i, &amp;rv);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+      rv = FilterExpression(map, childExpression, filter, flags);</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+      continue;</span>
<a href="#l6.184"></a><span id="l6.184">     }</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    filter.Append(')');</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+  }</span>
<a href="#l6.187"></a><span id="l6.187"> </span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-    return rv;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+  return rv;</span>
<a href="#l6.190"></a><span id="l6.190"> }</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-nsresult nsAbBoolExprToLDAPFilter::FilterExpressions (</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    nsIAbLDAPAttributeMap *map,</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-    nsIArray* expressions,</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    nsCString&amp; filter,</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-    int flags)</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-{</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-    uint32_t count;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-    nsresult rv = expressions-&gt;GetLength(&amp;count);</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanConditionString&gt; childCondition;</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; childExpression;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    {</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-        childCondition = do_QueryElementAt(expressions, i, &amp;rv);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-        {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-            rv = FilterCondition (map, childCondition, filter, flags);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-            continue;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-        }</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-        childExpression = do_QueryElementAt(expressions, i, &amp;rv);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-        {</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-            rv = FilterExpression (map, childExpression, filter, flags);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-            continue;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-        }</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-    }</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+nsresult nsAbBoolExprToLDAPFilter::FilterCondition(</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+    nsIAbLDAPAttributeMap* map, nsIAbBooleanConditionString* condition,</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+    nsCString&amp; filter, int flags) {</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+  nsCString name;</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+  nsresult rv = condition-&gt;GetName(getter_Copies(name));</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.228"></a><span id="l6.228"> </span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    return rv;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-}</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-nsresult nsAbBoolExprToLDAPFilter::FilterCondition (</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-    nsIAbLDAPAttributeMap* map,</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-    nsIAbBooleanConditionString* condition,</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-    nsCString&amp; filter,</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-    int flags)</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-{</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    nsCString name;</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    nsresult rv = condition-&gt;GetName(getter_Copies (name));</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+  nsAutoCString ldapAttr(name);</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+  if (flags &amp; TRANSLATE_CARD_PROPERTY) {</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+    rv = map-&gt;GetFirstAttribute(name, ldapAttr);</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+    if (!(flags &amp; ALLOW_NON_CONVERTABLE_CARD_PROPERTY) &amp;&amp;</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+        !ATTRMAP_FOUND_ATTR(rv, ldapAttr))</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+      return NS_OK;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+  }</span>
<a href="#l6.248"></a><span id="l6.248"> </span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-    nsAutoCString ldapAttr(name);</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-    if (flags &amp; TRANSLATE_CARD_PROPERTY)</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-    {</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-        rv = map-&gt;GetFirstAttribute (name, ldapAttr);</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-        if (!(flags &amp; ALLOW_NON_CONVERTABLE_CARD_PROPERTY) &amp;&amp;</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-            !ATTRMAP_FOUND_ATTR(rv, ldapAttr))</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-            return NS_OK;</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-    }</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+  nsAbBooleanConditionType conditionType;</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+  rv = condition-&gt;GetCondition(&amp;conditionType);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.260"></a><span id="l6.260"> </span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-    nsAbBooleanConditionType conditionType;</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-    rv = condition-&gt;GetCondition(&amp;conditionType);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-    nsString value;</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-    rv = condition-&gt;GetValue (getter_Copies (value));</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-    NS_ConvertUTF16toUTF8 vUTF8 (value);</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+  nsString value;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+  rv = condition-&gt;GetValue(getter_Copies(value));</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+  NS_ConvertUTF16toUTF8 vUTF8(value);</span>
<a href="#l6.273"></a><span id="l6.273"> </span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-    switch (conditionType)</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-    {</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-        case nsIAbBooleanConditionTypes::DoesNotExist:</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-            filter.AppendLiteral(&quot;(!(&quot;);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-            filter.AppendLiteral(&quot;=*))&quot;);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-            break;</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-        case nsIAbBooleanConditionTypes::Exists:</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-            filter.AppendLiteral(&quot;=*)&quot;);</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-            break;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-        case nsIAbBooleanConditionTypes::Contains:</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-            filter.AppendLiteral(&quot;=*&quot;);</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-            filter.AppendLiteral(&quot;*)&quot;);</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-            break;</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-        case nsIAbBooleanConditionTypes::DoesNotContain:</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-            filter.AppendLiteral(&quot;(!(&quot;);</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-            filter.AppendLiteral(&quot;=*&quot;);</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-            filter.AppendLiteral(&quot;*))&quot;);</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-            break;</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-        case nsIAbBooleanConditionTypes::Is:</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-            filter.Append('=');</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-            filter.Append(')');</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-            break;</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-        case nsIAbBooleanConditionTypes::IsNot:</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-            filter.AppendLiteral(&quot;(!(&quot;);</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-            filter.Append('=');</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-            filter.AppendLiteral(&quot;))&quot;);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-            break;</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-        case nsIAbBooleanConditionTypes::BeginsWith:</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-            filter.Append('=');</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-            filter.AppendLiteral(&quot;*)&quot;);</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-            break;</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-        case nsIAbBooleanConditionTypes::EndsWith:</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-            filter.AppendLiteral(&quot;=*&quot;);</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-            filter.Append(')');</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-            break;</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-        case nsIAbBooleanConditionTypes::LessThan:</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-            filter.AppendLiteral(&quot;&lt;=&quot;);</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-            filter.Append(')');</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-            break;</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-        case nsIAbBooleanConditionTypes::GreaterThan:</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-            filter.AppendLiteral(&quot;&gt;=&quot;);</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-            filter.Append(')');</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-            break;</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-        case nsIAbBooleanConditionTypes::SoundsLike:</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-            filter.Append('(');</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-            filter.Append(ldapAttr);</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-            filter.AppendLiteral(&quot;~=&quot;);</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-            filter.Append(vUTF8);</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-            filter.Append(')');</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-            break;</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-        case nsIAbBooleanConditionTypes::RegExp:</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-            break;</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-        default:</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-            break;</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-    }</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+  switch (conditionType) {</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+    case nsIAbBooleanConditionTypes::DoesNotExist:</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+      filter.AppendLiteral(&quot;(!(&quot;);</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+      filter.AppendLiteral(&quot;=*))&quot;);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+      break;</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+    case nsIAbBooleanConditionTypes::Exists:</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+      filter.AppendLiteral(&quot;=*)&quot;);</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+      break;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+    case nsIAbBooleanConditionTypes::Contains:</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+      filter.AppendLiteral(&quot;=*&quot;);</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+      filter.AppendLiteral(&quot;*)&quot;);</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+      break;</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+    case nsIAbBooleanConditionTypes::DoesNotContain:</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+      filter.AppendLiteral(&quot;(!(&quot;);</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+      filter.AppendLiteral(&quot;=*&quot;);</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+      filter.AppendLiteral(&quot;*))&quot;);</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+      break;</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+    case nsIAbBooleanConditionTypes::Is:</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+      filter.Append('=');</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+      filter.Append(')');</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+      break;</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+    case nsIAbBooleanConditionTypes::IsNot:</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+      filter.AppendLiteral(&quot;(!(&quot;);</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+      filter.Append('=');</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+      filter.AppendLiteral(&quot;))&quot;);</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+      break;</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+    case nsIAbBooleanConditionTypes::BeginsWith:</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+      filter.Append('=');</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+      filter.AppendLiteral(&quot;*)&quot;);</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+      break;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+    case nsIAbBooleanConditionTypes::EndsWith:</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+      filter.AppendLiteral(&quot;=*&quot;);</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+      filter.Append(')');</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+      break;</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+    case nsIAbBooleanConditionTypes::LessThan:</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+      filter.AppendLiteral(&quot;&lt;=&quot;);</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+      filter.Append(')');</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+      break;</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+    case nsIAbBooleanConditionTypes::GreaterThan:</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+      filter.AppendLiteral(&quot;&gt;=&quot;);</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+      filter.Append(')');</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+      break;</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+    case nsIAbBooleanConditionTypes::SoundsLike:</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+      filter.Append('(');</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+      filter.Append(ldapAttr);</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+      filter.AppendLiteral(&quot;~=&quot;);</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+      filter.Append(vUTF8);</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+      filter.Append(')');</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+      break;</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+    case nsIAbBooleanConditionTypes::RegExp:</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+      break;</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+    default:</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+      break;</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+  }</span>
<a href="#l6.433"></a><span id="l6.433"> </span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-    return rv;</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+  return rv;</span>
<a href="#l6.436"></a><span id="l6.436"> }</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -7,39 +7,30 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #define nsBooleanExpressionToLDAPFilter_h__</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsString.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> class nsIAbLDAPAttributeMap;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-class nsAbBoolExprToLDAPFilter</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-public:</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-    static const int TRANSLATE_CARD_PROPERTY ;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    static const int ALLOW_NON_CONVERTABLE_CARD_PROPERTY ;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+class nsAbBoolExprToLDAPFilter {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ public:</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  static const int TRANSLATE_CARD_PROPERTY;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  static const int ALLOW_NON_CONVERTABLE_CARD_PROPERTY;</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-    static nsresult Convert (</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-            nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-            nsIAbBooleanExpression* expression,</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-            nsCString&amp; filter,</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-            int flags = TRANSLATE_CARD_PROPERTY);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+  static nsresult Convert(nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+                          nsIAbBooleanExpression* expression, nsCString&amp; filter,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+                          int flags = TRANSLATE_CARD_PROPERTY);</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-protected:</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-    static nsresult FilterExpression (</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-        nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-        nsIAbBooleanExpression* expression,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-        nsCString&amp; filter,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-        int flags);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-    static nsresult FilterExpressions (</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-        nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-        nsIArray* expressions,</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-        nsCString&amp; filter,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-        int flags);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-    static nsresult FilterCondition (</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-        nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-        nsIAbBooleanConditionString* condition,</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-        nsCString&amp; filter,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-        int flags);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+ protected:</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  static nsresult FilterExpression(nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+                                   nsIAbBooleanExpression* expression,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                                   nsCString&amp; filter, int flags);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  static nsresult FilterExpressions(nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                                    nsIArray* expressions, nsCString&amp; filter,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+                                    int flags);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  static nsresult FilterCondition(nsIAbLDAPAttributeMap* map,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                                  nsIAbBooleanConditionString* condition,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                                  nsCString&amp; filter, int flags);</span>
<a href="#l7.57"></a><span id="l7.57"> };</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBooleanExpression.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBooleanExpression.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,130 +3,105 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsAbBooleanExpression.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> NS_IMPL_ISUPPORTS(nsAbBooleanConditionString, nsIAbBooleanConditionString)</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-nsAbBooleanConditionString::nsAbBooleanConditionString() :</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    mCondition (nsIAbBooleanConditionTypes::Exists)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-{</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-}</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+nsAbBooleanConditionString::nsAbBooleanConditionString()</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    : mCondition(nsIAbBooleanConditionTypes::Exists) {}</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-nsAbBooleanConditionString::~nsAbBooleanConditionString()</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-{</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-}</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+nsAbBooleanConditionString::~nsAbBooleanConditionString() {}</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> /* attribute nsAbBooleanConditionType condition; */</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-NS_IMETHODIMP nsAbBooleanConditionString::GetCondition(nsAbBooleanConditionType *aCondition)</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-{</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-    if (!aCondition)</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+NS_IMETHODIMP nsAbBooleanConditionString::GetCondition(</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    nsAbBooleanConditionType *aCondition) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  if (!aCondition) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-    *aCondition = mCondition;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  *aCondition = mCondition;</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.38"></a><span id="l8.38"> }</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-NS_IMETHODIMP nsAbBooleanConditionString::SetCondition(nsAbBooleanConditionType aCondition)</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-{</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-    mCondition = aCondition;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+NS_IMETHODIMP nsAbBooleanConditionString::SetCondition(</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    nsAbBooleanConditionType aCondition) {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  mCondition = aCondition;</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.48"></a><span id="l8.48"> }</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50"> /* attribute string name; */</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-NS_IMETHODIMP nsAbBooleanConditionString::GetName(char** aName)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-{</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    if (!aName)</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+NS_IMETHODIMP nsAbBooleanConditionString::GetName(char **aName) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  if (!aName) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    *aName = mName.IsEmpty() ? 0 : ToNewCString(mName);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  *aName = mName.IsEmpty() ? 0 : ToNewCString(mName);</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.64"></a><span id="l8.64"> }</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-NS_IMETHODIMP nsAbBooleanConditionString::SetName(const char* aName)</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-{</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    if (!aName)</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+NS_IMETHODIMP nsAbBooleanConditionString::SetName(const char *aName) {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  if (!aName) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-    mName = aName;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  mName = aName;</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.77"></a><span id="l8.77"> }</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79"> /* attribute wstring value; */</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-NS_IMETHODIMP nsAbBooleanConditionString::GetValue(char16_t** aValue)</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-{</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-    if (!aValue)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+NS_IMETHODIMP nsAbBooleanConditionString::GetValue(char16_t **aValue) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  if (!aValue) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    *aValue = ToNewUnicode(mValue);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  *aValue = ToNewUnicode(mValue);</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.92"></a><span id="l8.92"> }</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-NS_IMETHODIMP nsAbBooleanConditionString::SetValue(const char16_t * aValue)</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-{</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-    if (!aValue)</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+NS_IMETHODIMP nsAbBooleanConditionString::SetValue(const char16_t *aValue) {</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  if (!aValue) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-    mValue = aValue;</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  mValue = aValue;</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.105"></a><span id="l8.105"> }</span>
<a href="#l8.106"></a><span id="l8.106"> </span>
<a href="#l8.107"></a><span id="l8.107"> NS_IMPL_ISUPPORTS(nsAbBooleanExpression, nsIAbBooleanExpression)</span>
<a href="#l8.108"></a><span id="l8.108"> </span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-nsAbBooleanExpression::nsAbBooleanExpression() :</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-    mOperation (nsIAbBooleanOperationTypes::AND)</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-{</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-}</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+nsAbBooleanExpression::nsAbBooleanExpression()</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+    : mOperation(nsIAbBooleanOperationTypes::AND) {}</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-nsAbBooleanExpression::~nsAbBooleanExpression()</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-{</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-}</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+nsAbBooleanExpression::~nsAbBooleanExpression() {}</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121"> /* attribute nsAbBooleanOperationType operation; */</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-NS_IMETHODIMP nsAbBooleanExpression::GetOperation(nsAbBooleanOperationType *aOperation)</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-{</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-    if (!aOperation)</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+NS_IMETHODIMP nsAbBooleanExpression::GetOperation(</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    nsAbBooleanOperationType *aOperation) {</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  if (!aOperation) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.129"></a><span id="l8.129"> </span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-    *aOperation = mOperation;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  *aOperation = mOperation;</span>
<a href="#l8.132"></a><span id="l8.132"> </span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.135"></a><span id="l8.135"> }</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-NS_IMETHODIMP nsAbBooleanExpression::SetOperation(nsAbBooleanOperationType aOperation)</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-{</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-    mOperation = aOperation;</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+NS_IMETHODIMP nsAbBooleanExpression::SetOperation(</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    nsAbBooleanOperationType aOperation) {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  mOperation = aOperation;</span>
<a href="#l8.142"></a><span id="l8.142"> </span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.145"></a><span id="l8.145"> }</span>
<a href="#l8.146"></a><span id="l8.146"> </span>
<a href="#l8.147"></a><span id="l8.147"> /* attribute nsIArray expressions; */</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-NS_IMETHODIMP nsAbBooleanExpression::GetExpressions(nsIArray **aExpressions)</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-{</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-  if (!aExpressions)</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+NS_IMETHODIMP nsAbBooleanExpression::GetExpressions(nsIArray **aExpressions) {</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  if (!aExpressions) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.154"></a><span id="l8.154"> </span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-  if (!mExpressions)</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-  {</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+  if (!mExpressions) {</span>
<a href="#l8.158"></a><span id="l8.158">     mExpressions = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l8.159"></a><span id="l8.159"> </span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-    if (!mExpressions)</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+    if (!mExpressions) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.163"></a><span id="l8.163">   }</span>
<a href="#l8.164"></a><span id="l8.164"> </span>
<a href="#l8.165"></a><span id="l8.165">   NS_ADDREF(*aExpressions = mExpressions);</span>
<a href="#l8.166"></a><span id="l8.166">   return NS_OK;</span>
<a href="#l8.167"></a><span id="l8.167"> }</span>
<a href="#l8.168"></a><span id="l8.168"> </span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-NS_IMETHODIMP nsAbBooleanExpression::SetExpressions(nsIArray *aExpressions)</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-{</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-  if (!aExpressions)</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+NS_IMETHODIMP nsAbBooleanExpression::SetExpressions(nsIArray *aExpressions) {</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+  if (!aExpressions) return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.175"></a><span id="l8.175"> </span>
<a href="#l8.176"></a><span id="l8.176">   mExpressions = aExpressions;</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178">   return NS_OK;</span>
<a href="#l8.179"></a><span id="l8.179"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBooleanExpression.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBooleanExpression.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -6,38 +6,36 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #ifndef nsAbBooleanExpression_h__</span>
<a href="#l9.5"></a><span id="l9.5"> #define nsAbBooleanExpression_h__</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsString.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsIArray.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-class nsAbBooleanConditionString : public nsIAbBooleanConditionString</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-public:</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-    NS_DECL_NSIABBOOLEANCONDITIONSTRING</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+class nsAbBooleanConditionString : public nsIAbBooleanConditionString {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ public:</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  NS_DECL_NSIABBOOLEANCONDITIONSTRING</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-    nsAbBooleanConditionString();</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  nsAbBooleanConditionString();</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-protected:</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-    virtual ~nsAbBooleanConditionString();</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    nsAbBooleanConditionType mCondition;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    nsCString mName;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    nsString mValue;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ protected:</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  virtual ~nsAbBooleanConditionString();</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  nsAbBooleanConditionType mCondition;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  nsCString mName;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  nsString mValue;</span>
<a href="#l9.35"></a><span id="l9.35"> };</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-class nsAbBooleanExpression: public nsIAbBooleanExpression</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-{</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-public:</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    NS_DECL_NSIABBOOLEANEXPRESSION</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+class nsAbBooleanExpression : public nsIAbBooleanExpression {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+ public:</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  NS_DECL_NSIABBOOLEANEXPRESSION</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-    nsAbBooleanExpression();</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  nsAbBooleanExpression();</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-protected:</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-    virtual ~nsAbBooleanExpression();</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-    nsAbBooleanOperationType mOperation;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; mExpressions;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+ protected:</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  virtual ~nsAbBooleanExpression();</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  nsAbBooleanOperationType mOperation;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; mExpressions;</span>
<a href="#l9.58"></a><span id="l9.58"> };</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -28,329 +28,303 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;prmem.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> using namespace mozilla;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> #define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-const char sAddrbookProperties[] = &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+const char sAddrbookProperties[] =</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;;</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> enum EAppendType {</span>
<a href="#l10.17"></a><span id="l10.17">   eAppendLine,</span>
<a href="#l10.18"></a><span id="l10.18">   eAppendLabel,</span>
<a href="#l10.19"></a><span id="l10.19">   eAppendCityStateZip,</span>
<a href="#l10.20"></a><span id="l10.20">   eAppendUndefined</span>
<a href="#l10.21"></a><span id="l10.21"> };</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> struct AppendItem {</span>
<a href="#l10.24"></a><span id="l10.24">   const char *mColumn;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-  const char* mLabel;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  const char *mLabel;</span>
<a href="#l10.27"></a><span id="l10.27">   EAppendType mAppendType;</span>
<a href="#l10.28"></a><span id="l10.28"> };</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30"> static const AppendItem NAME_ATTRS_ARRAY[] = {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  {kDisplayNameProperty, &quot;propertyDisplayName&quot;, eAppendLabel},</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  {kNicknameProperty, &quot;propertyNickname&quot;, eAppendLabel},</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  {kPriEmailProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+    {kDisplayNameProperty, &quot;propertyDisplayName&quot;, eAppendLabel},</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+    {kNicknameProperty, &quot;propertyNickname&quot;, eAppendLabel},</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+    {kPriEmailProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.37"></a><span id="l10.37"> #ifndef MOZ_THUNDERBIRD</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  {k2ndEmailProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  {kScreenNameProperty, &quot;propertyScreenName&quot;, eAppendLabel}</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+    {k2ndEmailProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+    {kScreenNameProperty, &quot;propertyScreenName&quot;, eAppendLabel}</span>
<a href="#l10.42"></a><span id="l10.42"> #else</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  {k2ndEmailProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+    {k2ndEmailProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l10.45"></a><span id="l10.45"> #endif</span>
<a href="#l10.46"></a><span id="l10.46"> };</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48"> static const AppendItem PHONE_ATTRS_ARRAY[] = {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  {kWorkPhoneProperty, &quot;propertyWork&quot;, eAppendLabel},</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  {kHomePhoneProperty, &quot;propertyHome&quot;, eAppendLabel},</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  {kFaxProperty, &quot;propertyFax&quot;, eAppendLabel},</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  {kPagerProperty, &quot;propertyPager&quot;, eAppendLabel},</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  {kCellularProperty, &quot;propertyCellular&quot;, eAppendLabel}</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-};</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    {kWorkPhoneProperty, &quot;propertyWork&quot;, eAppendLabel},</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+    {kHomePhoneProperty, &quot;propertyHome&quot;, eAppendLabel},</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    {kFaxProperty, &quot;propertyFax&quot;, eAppendLabel},</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    {kPagerProperty, &quot;propertyPager&quot;, eAppendLabel},</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    {kCellularProperty, &quot;propertyCellular&quot;, eAppendLabel}};</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61"> static const AppendItem HOME_ATTRS_ARRAY[] = {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-  {kHomeAddressProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-  {kHomeAddress2Property, &quot;&quot;, eAppendLine},</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  {kHomeCityProperty, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  {kHomeCountryProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  {kHomeWebPageProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-};</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    {kHomeAddressProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+    {kHomeAddress2Property, &quot;&quot;, eAppendLine},</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+    {kHomeCityProperty, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+    {kHomeCountryProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    {kHomeWebPageProperty, &quot;&quot;, eAppendLine}};</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74"> static const AppendItem WORK_ATTRS_ARRAY[] = {</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  {kJobTitleProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  {kDepartmentProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  {kCompanyProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  {kWorkAddressProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  {kWorkAddress2Property, &quot;&quot;, eAppendLine},</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-  {kWorkCityProperty, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-  {kWorkCountryProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  {kWorkWebPageProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-};</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+    {kJobTitleProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+    {kDepartmentProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+    {kCompanyProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+    {kWorkAddressProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+    {kWorkAddress2Property, &quot;&quot;, eAppendLine},</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    {kWorkCityProperty, &quot;&quot;, eAppendCityStateZip},</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+    {kWorkCountryProperty, &quot;&quot;, eAppendLine},</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    {kWorkWebPageProperty, &quot;&quot;, eAppendLine}};</span>
<a href="#l10.92"></a><span id="l10.92"> </span>
<a href="#l10.93"></a><span id="l10.93"> static const AppendItem CUSTOM_ATTRS_ARRAY[] = {</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-  {kCustom1Property, &quot;propertyCustom1&quot;, eAppendLabel},</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-  {kCustom2Property, &quot;propertyCustom2&quot;, eAppendLabel},</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-  {kCustom3Property, &quot;propertyCustom3&quot;, eAppendLabel},</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-  {kCustom4Property, &quot;propertyCustom4&quot;, eAppendLabel},</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-  {kNotesProperty, &quot;&quot;, eAppendLine}</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-};</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+    {kCustom1Property, &quot;propertyCustom1&quot;, eAppendLabel},</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    {kCustom2Property, &quot;propertyCustom2&quot;, eAppendLabel},</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    {kCustom3Property, &quot;propertyCustom3&quot;, eAppendLabel},</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+    {kCustom4Property, &quot;propertyCustom4&quot;, eAppendLabel},</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    {kNotesProperty, &quot;&quot;, eAppendLine}};</span>
<a href="#l10.105"></a><span id="l10.105"> </span>
<a href="#l10.106"></a><span id="l10.106"> #ifdef MOZ_THUNDERBIRD</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108"> static const AppendItem CHAT_ATTRS_ARRAY[] = {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-  {kGtalkProperty, &quot;propertyGtalk&quot;, eAppendLabel},</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-  {kAIMProperty, &quot;propertyAIM&quot;, eAppendLabel},</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-  {kYahooProperty, &quot;propertyYahoo&quot;, eAppendLabel},</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-  {kSkypeProperty, &quot;propertySkype&quot;, eAppendLabel},</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-  {kQQProperty, &quot;propertyQQ&quot;, eAppendLabel},</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-  {kMSNProperty, &quot;propertyMSN&quot;, eAppendLabel},</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-  {kICQProperty, &quot;propertyICQ&quot;, eAppendLabel},</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-  {kXMPPProperty, &quot;propertyXMPP&quot;, eAppendLabel},</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-  {kIRCProperty, &quot;propertyIRC&quot;, eAppendLabel}</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-};</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+    {kGtalkProperty, &quot;propertyGtalk&quot;, eAppendLabel},</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+    {kAIMProperty, &quot;propertyAIM&quot;, eAppendLabel},</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+    {kYahooProperty, &quot;propertyYahoo&quot;, eAppendLabel},</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+    {kSkypeProperty, &quot;propertySkype&quot;, eAppendLabel},</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+    {kQQProperty, &quot;propertyQQ&quot;, eAppendLabel},</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+    {kMSNProperty, &quot;propertyMSN&quot;, eAppendLabel},</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+    {kICQProperty, &quot;propertyICQ&quot;, eAppendLabel},</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+    {kXMPPProperty, &quot;propertyXMPP&quot;, eAppendLabel},</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+    {kIRCProperty, &quot;propertyIRC&quot;, eAppendLabel}};</span>
<a href="#l10.128"></a><span id="l10.128"> #endif</span>
<a href="#l10.129"></a><span id="l10.129"> </span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-nsAbCardProperty::nsAbCardProperty()</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  : m_IsMailList(false)</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-{</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+nsAbCardProperty::nsAbCardProperty() : m_IsMailList(false) {</span>
<a href="#l10.134"></a><span id="l10.134">   // Initialize some default properties</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-  SetPropertyAsUint32(kPreferMailFormatProperty, nsIAbPreferMailFormat::unknown);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  SetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+                      nsIAbPreferMailFormat::unknown);</span>
<a href="#l10.138"></a><span id="l10.138">   SetPropertyAsUint32(kPopularityIndexProperty, 0);</span>
<a href="#l10.139"></a><span id="l10.139">   // Uninitialized...</span>
<a href="#l10.140"></a><span id="l10.140">   SetPropertyAsUint32(kLastModifiedDateProperty, 0);</span>
<a href="#l10.141"></a><span id="l10.141"> }</span>
<a href="#l10.142"></a><span id="l10.142"> </span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-nsAbCardProperty::~nsAbCardProperty(void)</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-{</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-}</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+nsAbCardProperty::~nsAbCardProperty(void) {}</span>
<a href="#l10.147"></a><span id="l10.147"> </span>
<a href="#l10.148"></a><span id="l10.148"> NS_IMPL_ISUPPORTS(nsAbCardProperty, nsIAbCard, nsIAbItem)</span>
<a href="#l10.149"></a><span id="l10.149"> </span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetUuid(nsACString &amp;uuid)</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-{</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetUuid(nsACString &amp;uuid) {</span>
<a href="#l10.153"></a><span id="l10.153">   // If we have indeterminate sub-ids, return an empty uuid.</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-  if (m_directoryId.IsEmpty() || m_localId.IsEmpty())</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-  {</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+  if (m_directoryId.IsEmpty() || m_localId.IsEmpty()) {</span>
<a href="#l10.157"></a><span id="l10.157">     uuid.Truncate();</span>
<a href="#l10.158"></a><span id="l10.158">     return NS_OK;</span>
<a href="#l10.159"></a><span id="l10.159">   }</span>
<a href="#l10.160"></a><span id="l10.160"> </span>
<a href="#l10.161"></a><span id="l10.161">   nsresult rv;</span>
<a href="#l10.162"></a><span id="l10.162">   nsCOMPtr&lt;nsIAbManager&gt; manager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.163"></a><span id="l10.163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.164"></a><span id="l10.164"> </span>
<a href="#l10.165"></a><span id="l10.165">   return manager-&gt;GenerateUUID(m_directoryId, m_localId, uuid);</span>
<a href="#l10.166"></a><span id="l10.166"> }</span>
<a href="#l10.167"></a><span id="l10.167"> </span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetDirectoryId(nsACString &amp;dirId)</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-{</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetDirectoryId(nsACString &amp;dirId) {</span>
<a href="#l10.171"></a><span id="l10.171">   dirId = m_directoryId;</span>
<a href="#l10.172"></a><span id="l10.172">   return NS_OK;</span>
<a href="#l10.173"></a><span id="l10.173"> }</span>
<a href="#l10.174"></a><span id="l10.174"> </span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetDirectoryId(const nsACString &amp;aDirId)</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-{</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetDirectoryId(const nsACString &amp;aDirId) {</span>
<a href="#l10.178"></a><span id="l10.178">   m_directoryId = aDirId;</span>
<a href="#l10.179"></a><span id="l10.179">   return NS_OK;</span>
<a href="#l10.180"></a><span id="l10.180"> }</span>
<a href="#l10.181"></a><span id="l10.181"> </span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetLocalId(nsACString &amp;localId)</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-{</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetLocalId(nsACString &amp;localId) {</span>
<a href="#l10.185"></a><span id="l10.185">   localId = m_localId;</span>
<a href="#l10.186"></a><span id="l10.186">   return NS_OK;</span>
<a href="#l10.187"></a><span id="l10.187"> }</span>
<a href="#l10.188"></a><span id="l10.188"> </span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetLocalId(const nsACString &amp;aLocalId)</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-{</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetLocalId(const nsACString &amp;aLocalId) {</span>
<a href="#l10.192"></a><span id="l10.192">   m_localId = aLocalId;</span>
<a href="#l10.193"></a><span id="l10.193">   return NS_OK;</span>
<a href="#l10.194"></a><span id="l10.194"> }</span>
<a href="#l10.195"></a><span id="l10.195"> </span>
<a href="#l10.196"></a><span id="l10.196"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.197"></a><span id="l10.197"> </span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetIsMailList(bool *aIsMailList)</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-{</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-    *aIsMailList = m_IsMailList;</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetIsMailList(bool *aIsMailList) {</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+  *aIsMailList = m_IsMailList;</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.205"></a><span id="l10.205"> }</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetIsMailList(bool aIsMailList)</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-{</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-    m_IsMailList = aIsMailList;</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetIsMailList(bool aIsMailList) {</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+  m_IsMailList = aIsMailList;</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.214"></a><span id="l10.214"> }</span>
<a href="#l10.215"></a><span id="l10.215"> </span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetMailListURI(char **aMailListURI)</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-{</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-  if (aMailListURI)</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-  {</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetMailListURI(char **aMailListURI) {</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+  if (aMailListURI) {</span>
<a href="#l10.222"></a><span id="l10.222">     *aMailListURI = ToNewCString(m_MailListURI);</span>
<a href="#l10.223"></a><span id="l10.223">     return (*aMailListURI) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-  }</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-  else</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+  } else</span>
<a href="#l10.227"></a><span id="l10.227">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.228"></a><span id="l10.228"> }</span>
<a href="#l10.229"></a><span id="l10.229"> </span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetMailListURI(const char *aMailListURI)</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-{</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-  if (aMailListURI)</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-  {</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetMailListURI(const char *aMailListURI) {</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+  if (aMailListURI) {</span>
<a href="#l10.236"></a><span id="l10.236">     m_MailListURI = aMailListURI;</span>
<a href="#l10.237"></a><span id="l10.237">     return NS_OK;</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-  }</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-  else</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+  } else</span>
<a href="#l10.241"></a><span id="l10.241">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.242"></a><span id="l10.242"> }</span>
<a href="#l10.243"></a><span id="l10.243"> </span>
<a href="#l10.244"></a><span id="l10.244"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.245"></a><span id="l10.245"> // Property bag portion of nsAbCardProperty</span>
<a href="#l10.246"></a><span id="l10.246"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.247"></a><span id="l10.247"> </span>
<a href="#l10.248"></a><span id="l10.248"> class nsAbSimpleProperty final : public nsIProperty {</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-public:</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-    nsAbSimpleProperty(const nsACString&amp; aName, nsIVariant* aValue)</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-        : mName(aName), mValue(aValue)</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-    {</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-    }</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+ public:</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+  nsAbSimpleProperty(const nsACString &amp;aName, nsIVariant *aValue)</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+      : mName(aName), mValue(aValue) {}</span>
<a href="#l10.257"></a><span id="l10.257"> </span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-    NS_DECL_NSIPROPERTY</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-protected:</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-    ~nsAbSimpleProperty() {}</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-    nsCString mName;</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-    nsCOMPtr&lt;nsIVariant&gt; mValue;</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+  NS_DECL_NSIPROPERTY</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+ protected:</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+  ~nsAbSimpleProperty() {}</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+  nsCString mName;</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; mValue;</span>
<a href="#l10.270"></a><span id="l10.270"> };</span>
<a href="#l10.271"></a><span id="l10.271"> </span>
<a href="#l10.272"></a><span id="l10.272"> NS_IMPL_ISUPPORTS(nsAbSimpleProperty, nsIProperty)</span>
<a href="#l10.273"></a><span id="l10.273"> </span>
<a href="#l10.274"></a><span id="l10.274"> NS_IMETHODIMP</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-nsAbSimpleProperty::GetName(nsAString&amp; aName)</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-{</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-    aName.Assign(NS_ConvertUTF8toUTF16(mName));</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+nsAbSimpleProperty::GetName(nsAString &amp;aName) {</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+  aName.Assign(NS_ConvertUTF8toUTF16(mName));</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.282"></a><span id="l10.282"> }</span>
<a href="#l10.283"></a><span id="l10.283"> </span>
<a href="#l10.284"></a><span id="l10.284"> NS_IMETHODIMP</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-nsAbSimpleProperty::GetValue(nsIVariant* *aValue)</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-{</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineminus">-    NS_IF_ADDREF(*aValue = mValue);</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+nsAbSimpleProperty::GetValue(nsIVariant **aValue) {</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+  NS_IF_ADDREF(*aValue = mValue);</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.292"></a><span id="l10.292"> }</span>
<a href="#l10.293"></a><span id="l10.293"> </span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetProperties(nsISimpleEnumerator **props)</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-{</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetProperties(nsISimpleEnumerator **props) {</span>
<a href="#l10.297"></a><span id="l10.297">   nsCOMArray&lt;nsIProperty&gt; propertyArray(m_properties.Count());</span>
<a href="#l10.298"></a><span id="l10.298">   for (auto iter = m_properties.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-    propertyArray.AppendObject(new nsAbSimpleProperty(iter.Key(),</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-                                                      iter.UserData()));</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+    propertyArray.AppendObject(</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+        new nsAbSimpleProperty(iter.Key(), iter.UserData()));</span>
<a href="#l10.303"></a><span id="l10.303">   }</span>
<a href="#l10.304"></a><span id="l10.304">   return NS_NewArrayEnumerator(props, propertyArray, NS_GET_IID(nsIProperty));</span>
<a href="#l10.305"></a><span id="l10.305"> }</span>
<a href="#l10.306"></a><span id="l10.306"> </span>
<a href="#l10.307"></a><span id="l10.307"> NS_IMETHODIMP nsAbCardProperty::GetProperty(const nsACString &amp;name,</span>
<a href="#l10.308"></a><span id="l10.308">                                             nsIVariant *defaultValue,</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-                                            nsIVariant **value)</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-{</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-  if (!m_properties.Get(name, value))</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-    NS_ADDREF(*value = defaultValue);</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+                                            nsIVariant **value) {</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+  if (!m_properties.Get(name, value)) NS_ADDREF(*value = defaultValue);</span>
<a href="#l10.315"></a><span id="l10.315">   return NS_OK;</span>
<a href="#l10.316"></a><span id="l10.316"> }</span>
<a href="#l10.317"></a><span id="l10.317"> </span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetPropertyAsAString(const char *name, nsAString &amp;value)</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-{</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsAString(const char *name,</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+                                                     nsAString &amp;value) {</span>
<a href="#l10.322"></a><span id="l10.322">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.323"></a><span id="l10.323"> </span>
<a href="#l10.324"></a><span id="l10.324">   nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-    variant-&gt;GetAsAString(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant))</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+             ? variant-&gt;GetAsAString(value)</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+             : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.330"></a><span id="l10.330"> }</span>
<a href="#l10.331"></a><span id="l10.331"> </span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetPropertyAsAUTF8String(const char *name, nsACString &amp;value)</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-{</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsAUTF8String(const char *name,</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+                                                         nsACString &amp;value) {</span>
<a href="#l10.336"></a><span id="l10.336">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.337"></a><span id="l10.337"> </span>
<a href="#l10.338"></a><span id="l10.338">   nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-    variant-&gt;GetAsAUTF8String(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant))</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+             ? variant-&gt;GetAsAUTF8String(value)</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+             : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.344"></a><span id="l10.344"> }</span>
<a href="#l10.345"></a><span id="l10.345"> </span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetPropertyAsUint32(const char *name, uint32_t *value)</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-{</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsUint32(const char *name,</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+                                                    uint32_t *value) {</span>
<a href="#l10.350"></a><span id="l10.350">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.351"></a><span id="l10.351"> </span>
<a href="#l10.352"></a><span id="l10.352">   nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-    variant-&gt;GetAsUint32(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant))</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+             ? variant-&gt;GetAsUint32(value)</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+             : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.358"></a><span id="l10.358"> }</span>
<a href="#l10.359"></a><span id="l10.359"> </span>
<a href="#l10.360"></a><span id="l10.360" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetPropertyAsBool(const char *name, bool *value)</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineminus">-{</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPropertyAsBool(const char *name,</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+                                                  bool *value) {</span>
<a href="#l10.364"></a><span id="l10.364">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.365"></a><span id="l10.365"> </span>
<a href="#l10.366"></a><span id="l10.366">   nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant)) ?</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-    variant-&gt;GetAsBool(value) : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+  return m_properties.Get(nsDependentCString(name), getter_AddRefs(variant))</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+             ? variant-&gt;GetAsBool(value)</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+             : NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.372"></a><span id="l10.372"> }</span>
<a href="#l10.373"></a><span id="l10.373"> </span>
<a href="#l10.374"></a><span id="l10.374" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetProperty(const nsACString &amp;name, nsIVariant *value)</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineminus">-{</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetProperty(const nsACString &amp;name,</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+                                            nsIVariant *value) {</span>
<a href="#l10.378"></a><span id="l10.378">   m_properties.Put(name, value);</span>
<a href="#l10.379"></a><span id="l10.379">   return NS_OK;</span>
<a href="#l10.380"></a><span id="l10.380"> }</span>
<a href="#l10.381"></a><span id="l10.381"> </span>
<a href="#l10.382"></a><span id="l10.382" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetPropertyAsAString(const char *name, const nsAString &amp;value)</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineminus">-{</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsAString(const char *name,</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+                                                     const nsAString &amp;value) {</span>
<a href="#l10.386"></a><span id="l10.386">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.387"></a><span id="l10.387"> </span>
<a href="#l10.388"></a><span id="l10.388">   nsCOMPtr&lt;nsIWritableVariant&gt; variant = new nsVariant();</span>
<a href="#l10.389"></a><span id="l10.389">   variant-&gt;SetAsAString(value);</span>
<a href="#l10.390"></a><span id="l10.390">   m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l10.391"></a><span id="l10.391">   return NS_OK;</span>
<a href="#l10.392"></a><span id="l10.392"> }</span>
<a href="#l10.393"></a><span id="l10.393"> </span>
<a href="#l10.394"></a><span id="l10.394" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetPropertyAsAUTF8String(const char *name, const nsACString &amp;value)</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineminus">-{</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsAUTF8String(</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+    const char *name, const nsACString &amp;value) {</span>
<a href="#l10.398"></a><span id="l10.398">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.399"></a><span id="l10.399"> </span>
<a href="#l10.400"></a><span id="l10.400">   nsCOMPtr&lt;nsIWritableVariant&gt; variant = new nsVariant();</span>
<a href="#l10.401"></a><span id="l10.401">   variant-&gt;SetAsAUTF8String(value);</span>
<a href="#l10.402"></a><span id="l10.402">   m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l10.403"></a><span id="l10.403">   return NS_OK;</span>
<a href="#l10.404"></a><span id="l10.404"> }</span>
<a href="#l10.405"></a><span id="l10.405"> </span>
<a href="#l10.406"></a><span id="l10.406" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetPropertyAsUint32(const char *name, uint32_t value)</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-{</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsUint32(const char *name,</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+                                                    uint32_t value) {</span>
<a href="#l10.410"></a><span id="l10.410">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.411"></a><span id="l10.411"> </span>
<a href="#l10.412"></a><span id="l10.412">   nsCOMPtr&lt;nsIWritableVariant&gt; variant = new nsVariant();</span>
<a href="#l10.413"></a><span id="l10.413">   variant-&gt;SetAsUint32(value);</span>
<a href="#l10.414"></a><span id="l10.414">   m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l10.415"></a><span id="l10.415">   return NS_OK;</span>
<a href="#l10.416"></a><span id="l10.416"> }</span>
<a href="#l10.417"></a><span id="l10.417"> </span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetPropertyAsBool(const char *name, bool value)</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-{</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPropertyAsBool(const char *name,</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+                                                  bool value) {</span>
<a href="#l10.422"></a><span id="l10.422">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l10.423"></a><span id="l10.423"> </span>
<a href="#l10.424"></a><span id="l10.424">   nsCOMPtr&lt;nsIWritableVariant&gt; variant = new nsVariant();</span>
<a href="#l10.425"></a><span id="l10.425">   variant-&gt;SetAsBool(value);</span>
<a href="#l10.426"></a><span id="l10.426">   m_properties.Put(nsDependentCString(name), variant);</span>
<a href="#l10.427"></a><span id="l10.427">   return NS_OK;</span>
<a href="#l10.428"></a><span id="l10.428"> }</span>
<a href="#l10.429"></a><span id="l10.429"> </span>
<a href="#l10.430"></a><span id="l10.430" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::DeleteProperty(const nsACString &amp;name)</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineminus">-{</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::DeleteProperty(const nsACString &amp;name) {</span>
<a href="#l10.433"></a><span id="l10.433">   m_properties.Remove(name);</span>
<a href="#l10.434"></a><span id="l10.434">   return NS_OK;</span>
<a href="#l10.435"></a><span id="l10.435"> }</span>
<a href="#l10.436"></a><span id="l10.436"> </span>
<a href="#l10.437"></a><span id="l10.437" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetUID(nsACString &amp;uid)</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineminus">-{</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetUID(nsACString &amp;uid) {</span>
<a href="#l10.440"></a><span id="l10.440">   nsAutoString aString;</span>
<a href="#l10.441"></a><span id="l10.441">   nsresult rv = GetPropertyAsAString(kUIDProperty, aString);</span>
<a href="#l10.442"></a><span id="l10.442">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.443"></a><span id="l10.443">     uid = NS_ConvertUTF16toUTF8(aString);</span>
<a href="#l10.444"></a><span id="l10.444">     return rv;</span>
<a href="#l10.445"></a><span id="l10.445">   }</span>
<a href="#l10.446"></a><span id="l10.446"> </span>
<a href="#l10.447"></a><span id="l10.447">   nsCOMPtr&lt;nsIUUIDGenerator&gt; uuidgen = mozilla::services::GetUUIDGenerator();</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineat">@@ -362,32 +336,32 @@ NS_IMETHODIMP nsAbCardProperty::GetUID(n</span>
<a href="#l10.449"></a><span id="l10.449"> </span>
<a href="#l10.450"></a><span id="l10.450">   char idString[NSID_LENGTH];</span>
<a href="#l10.451"></a><span id="l10.451">   id.ToProvidedString(idString);</span>
<a href="#l10.452"></a><span id="l10.452"> </span>
<a href="#l10.453"></a><span id="l10.453">   uid.AppendASCII(idString + 1, NSID_LENGTH - 3);</span>
<a href="#l10.454"></a><span id="l10.454">   return SetUID(uid);</span>
<a href="#l10.455"></a><span id="l10.455"> }</span>
<a href="#l10.456"></a><span id="l10.456"> </span>
<a href="#l10.457"></a><span id="l10.457" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetUID(const nsACString &amp;aUID)</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineminus">-{</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetUID(const nsACString &amp;aUID) {</span>
<a href="#l10.460"></a><span id="l10.460">   nsresult rv = SetPropertyAsAString(kUIDProperty, NS_ConvertUTF8toUTF16(aUID));</span>
<a href="#l10.461"></a><span id="l10.461">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.462"></a><span id="l10.462"> </span>
<a href="#l10.463"></a><span id="l10.463">   if (m_directoryId.IsEmpty()) {</span>
<a href="#l10.464"></a><span id="l10.464">     return NS_OK;</span>
<a href="#l10.465"></a><span id="l10.465">   }</span>
<a href="#l10.466"></a><span id="l10.466"> </span>
<a href="#l10.467"></a><span id="l10.467">   int ampIndex = m_directoryId.FindChar('&amp;');</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineminus">-  const nsACString&amp; directoryId = Substring(m_directoryId, 0, ampIndex);</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+  const nsACString &amp;directoryId = Substring(m_directoryId, 0, ampIndex);</span>
<a href="#l10.470"></a><span id="l10.470"> </span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.474"></a><span id="l10.474">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.475"></a><span id="l10.475"> </span>
<a href="#l10.476"></a><span id="l10.476" class="difflineminus">-  nsCOMPtr &lt;nsIAbDirectory&gt; directory = nullptr;</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory = nullptr;</span>
<a href="#l10.478"></a><span id="l10.478">   rv = abManager-&gt;GetDirectoryFromId(directoryId, getter_AddRefs(directory));</span>
<a href="#l10.479"></a><span id="l10.479">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.480"></a><span id="l10.480"> </span>
<a href="#l10.481"></a><span id="l10.481">   if (!directory) {</span>
<a href="#l10.482"></a><span id="l10.482">     return NS_OK;</span>
<a href="#l10.483"></a><span id="l10.483">   }</span>
<a href="#l10.484"></a><span id="l10.484"> </span>
<a href="#l10.485"></a><span id="l10.485">   bool readOnly;</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineat">@@ -395,118 +369,103 @@ NS_IMETHODIMP nsAbCardProperty::SetUID(c</span>
<a href="#l10.487"></a><span id="l10.487">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.488"></a><span id="l10.488"> </span>
<a href="#l10.489"></a><span id="l10.489">   if (readOnly) {</span>
<a href="#l10.490"></a><span id="l10.490">     return NS_ERROR_FAILURE;</span>
<a href="#l10.491"></a><span id="l10.491">   }</span>
<a href="#l10.492"></a><span id="l10.492">   return directory-&gt;ModifyCard(this);</span>
<a href="#l10.493"></a><span id="l10.493"> }</span>
<a href="#l10.494"></a><span id="l10.494"> </span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetFirstName(nsAString &amp;aString)</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-{</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetFirstName(nsAString &amp;aString) {</span>
<a href="#l10.498"></a><span id="l10.498">   nsresult rv = GetPropertyAsAString(kFirstNameProperty, aString);</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineminus">-  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineminus">-  {</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l10.502"></a><span id="l10.502">     aString.Truncate();</span>
<a href="#l10.503"></a><span id="l10.503">     return NS_OK;</span>
<a href="#l10.504"></a><span id="l10.504">   }</span>
<a href="#l10.505"></a><span id="l10.505">   return rv;</span>
<a href="#l10.506"></a><span id="l10.506"> }</span>
<a href="#l10.507"></a><span id="l10.507"> </span>
<a href="#l10.508"></a><span id="l10.508" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetFirstName(const nsAString &amp;aString)</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineminus">-{</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetFirstName(const nsAString &amp;aString) {</span>
<a href="#l10.511"></a><span id="l10.511">   return SetPropertyAsAString(kFirstNameProperty, aString);</span>
<a href="#l10.512"></a><span id="l10.512"> }</span>
<a href="#l10.513"></a><span id="l10.513"> </span>
<a href="#l10.514"></a><span id="l10.514" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetLastName(nsAString &amp;aString)</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineminus">-{</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetLastName(nsAString &amp;aString) {</span>
<a href="#l10.517"></a><span id="l10.517">   nsresult rv = GetPropertyAsAString(kLastNameProperty, aString);</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineminus">-  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineminus">-  {</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l10.521"></a><span id="l10.521">     aString.Truncate();</span>
<a href="#l10.522"></a><span id="l10.522">     return NS_OK;</span>
<a href="#l10.523"></a><span id="l10.523">   }</span>
<a href="#l10.524"></a><span id="l10.524">   return rv;</span>
<a href="#l10.525"></a><span id="l10.525"> }</span>
<a href="#l10.526"></a><span id="l10.526"> </span>
<a href="#l10.527"></a><span id="l10.527" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetLastName(const nsAString &amp;aString)</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineminus">-{</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetLastName(const nsAString &amp;aString) {</span>
<a href="#l10.530"></a><span id="l10.530">   return SetPropertyAsAString(kLastNameProperty, aString);</span>
<a href="#l10.531"></a><span id="l10.531"> }</span>
<a href="#l10.532"></a><span id="l10.532"> </span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetDisplayName(nsAString &amp;aString)</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineminus">-{</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetDisplayName(nsAString &amp;aString) {</span>
<a href="#l10.536"></a><span id="l10.536">   nsresult rv = GetPropertyAsAString(kDisplayNameProperty, aString);</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineminus">-  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineminus">-  {</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l10.540"></a><span id="l10.540">     aString.Truncate();</span>
<a href="#l10.541"></a><span id="l10.541">     return NS_OK;</span>
<a href="#l10.542"></a><span id="l10.542">   }</span>
<a href="#l10.543"></a><span id="l10.543">   return rv;</span>
<a href="#l10.544"></a><span id="l10.544"> }</span>
<a href="#l10.545"></a><span id="l10.545"> </span>
<a href="#l10.546"></a><span id="l10.546" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetDisplayName(const nsAString &amp;aString)</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineminus">-{</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetDisplayName(const nsAString &amp;aString) {</span>
<a href="#l10.549"></a><span id="l10.549">   return SetPropertyAsAString(kDisplayNameProperty, aString);</span>
<a href="#l10.550"></a><span id="l10.550"> }</span>
<a href="#l10.551"></a><span id="l10.551"> </span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GetPrimaryEmail(nsAString &amp;aString)</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-{</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetPrimaryEmail(nsAString &amp;aString) {</span>
<a href="#l10.555"></a><span id="l10.555">   nsresult rv = GetPropertyAsAString(kPriEmailProperty, aString);</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineminus">-  if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineminus">-  {</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineplus">+  if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l10.559"></a><span id="l10.559">     aString.Truncate();</span>
<a href="#l10.560"></a><span id="l10.560">     return NS_OK;</span>
<a href="#l10.561"></a><span id="l10.561">   }</span>
<a href="#l10.562"></a><span id="l10.562">   return rv;</span>
<a href="#l10.563"></a><span id="l10.563"> }</span>
<a href="#l10.564"></a><span id="l10.564"> </span>
<a href="#l10.565"></a><span id="l10.565" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::SetPrimaryEmail(const nsAString &amp;aString)</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-{</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetPrimaryEmail(const nsAString &amp;aString) {</span>
<a href="#l10.568"></a><span id="l10.568">   return SetPropertyAsAString(kPriEmailProperty, aString);</span>
<a href="#l10.569"></a><span id="l10.569"> }</span>
<a href="#l10.570"></a><span id="l10.570"> </span>
<a href="#l10.571"></a><span id="l10.571"> NS_IMETHODIMP nsAbCardProperty::HasEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineminus">-                                                bool *aResult)</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineminus">-{</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineplus">+                                                bool *aResult) {</span>
<a href="#l10.575"></a><span id="l10.575">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.576"></a><span id="l10.576"> </span>
<a href="#l10.577"></a><span id="l10.577">   *aResult = false;</span>
<a href="#l10.578"></a><span id="l10.578"> </span>
<a href="#l10.579"></a><span id="l10.579">   nsCString emailAddress;</span>
<a href="#l10.580"></a><span id="l10.580">   nsresult rv = GetPropertyAsAUTF8String(kPriEmailProperty, emailAddress);</span>
<a href="#l10.581"></a><span id="l10.581">   if (rv != NS_ERROR_NOT_AVAILABLE &amp;&amp;</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineminus">-      emailAddress.Equals(aEmailAddress, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineminus">-  {</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineplus">+      emailAddress.Equals(aEmailAddress,</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineplus">+                          nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l10.586"></a><span id="l10.586">     *aResult = true;</span>
<a href="#l10.587"></a><span id="l10.587">     return NS_OK;</span>
<a href="#l10.588"></a><span id="l10.588">   }</span>
<a href="#l10.589"></a><span id="l10.589"> </span>
<a href="#l10.590"></a><span id="l10.590">   rv = GetPropertyAsAUTF8String(k2ndEmailProperty, emailAddress);</span>
<a href="#l10.591"></a><span id="l10.591">   if (rv != NS_ERROR_NOT_AVAILABLE &amp;&amp;</span>
<a href="#l10.592"></a><span id="l10.592">       emailAddress.Equals(aEmailAddress, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l10.593"></a><span id="l10.593">     *aResult = true;</span>
<a href="#l10.594"></a><span id="l10.594"> </span>
<a href="#l10.595"></a><span id="l10.595">   return NS_OK;</span>
<a href="#l10.596"></a><span id="l10.596"> }</span>
<a href="#l10.597"></a><span id="l10.597"> </span>
<a href="#l10.598"></a><span id="l10.598"> // This function may be overridden by derived classes for</span>
<a href="#l10.599"></a><span id="l10.599"> // nsAb*Card specific implementations.</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::Copy(nsIAbCard* srcCard)</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineminus">-{</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::Copy(nsIAbCard *srcCard) {</span>
<a href="#l10.603"></a><span id="l10.603">   NS_ENSURE_ARG_POINTER(srcCard);</span>
<a href="#l10.604"></a><span id="l10.604"> </span>
<a href="#l10.605"></a><span id="l10.605">   nsCOMPtr&lt;nsISimpleEnumerator&gt; properties;</span>
<a href="#l10.606"></a><span id="l10.606">   nsresult rv = srcCard-&gt;GetProperties(getter_AddRefs(properties));</span>
<a href="#l10.607"></a><span id="l10.607">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.608"></a><span id="l10.608"> </span>
<a href="#l10.609"></a><span id="l10.609">   bool hasMore;</span>
<a href="#l10.610"></a><span id="l10.610">   nsCOMPtr&lt;nsISupports&gt; result;</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineminus">-  while (NS_SUCCEEDED(rv = properties-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineminus">-  {</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineplus">+  while (NS_SUCCEEDED(rv = properties-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l10.614"></a><span id="l10.614">     rv = properties-&gt;GetNext(getter_AddRefs(result));</span>
<a href="#l10.615"></a><span id="l10.615">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.616"></a><span id="l10.616"> </span>
<a href="#l10.617"></a><span id="l10.617">     nsCOMPtr&lt;nsIProperty&gt; property = do_QueryInterface(result, &amp;rv);</span>
<a href="#l10.618"></a><span id="l10.618">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.619"></a><span id="l10.619"> </span>
<a href="#l10.620"></a><span id="l10.620">     nsAutoString name;</span>
<a href="#l10.621"></a><span id="l10.621">     property-&gt;GetName(name);</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineat">@@ -523,463 +482,449 @@ NS_IMETHODIMP nsAbCardProperty::Copy(nsI</span>
<a href="#l10.623"></a><span id="l10.623"> </span>
<a href="#l10.624"></a><span id="l10.624">   nsCString mailListURI;</span>
<a href="#l10.625"></a><span id="l10.625">   srcCard-&gt;GetMailListURI(getter_Copies(mailListURI));</span>
<a href="#l10.626"></a><span id="l10.626">   SetMailListURI(mailListURI.get());</span>
<a href="#l10.627"></a><span id="l10.627"> </span>
<a href="#l10.628"></a><span id="l10.628">   return NS_OK;</span>
<a href="#l10.629"></a><span id="l10.629"> }</span>
<a href="#l10.630"></a><span id="l10.630"> </span>
<a href="#l10.631"></a><span id="l10.631" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::Equals(nsIAbCard *card, bool *result)</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineminus">-{</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::Equals(nsIAbCard *card, bool *result) {</span>
<a href="#l10.634"></a><span id="l10.634">   *result = (card == this);</span>
<a href="#l10.635"></a><span id="l10.635">   return NS_OK;</span>
<a href="#l10.636"></a><span id="l10.636"> }</span>
<a href="#l10.637"></a><span id="l10.637"> </span>
<a href="#l10.638"></a><span id="l10.638"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.639"></a><span id="l10.639"> // The following methods are other views of a card</span>
<a href="#l10.640"></a><span id="l10.640"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.641"></a><span id="l10.641"> </span>
<a href="#l10.642"></a><span id="l10.642"> // XXX: Use the category manager instead of this file to implement these</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::TranslateTo(const nsACString &amp;type, nsACString &amp;result)</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineminus">-{</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::TranslateTo(const nsACString &amp;type,</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineplus">+                                            nsACString &amp;result) {</span>
<a href="#l10.647"></a><span id="l10.647">   if (type.EqualsLiteral(&quot;base64xml&quot;))</span>
<a href="#l10.648"></a><span id="l10.648">     return ConvertToBase64EncodedXML(result);</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineminus">-  else if (type.EqualsLiteral(&quot;xml&quot;))</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineminus">-  {</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineplus">+  else if (type.EqualsLiteral(&quot;xml&quot;)) {</span>
<a href="#l10.652"></a><span id="l10.652">     nsString utf16String;</span>
<a href="#l10.653"></a><span id="l10.653">     nsresult rv = ConvertToXMLPrintData(utf16String);</span>
<a href="#l10.654"></a><span id="l10.654">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.655"></a><span id="l10.655">     result = NS_ConvertUTF16toUTF8(utf16String);</span>
<a href="#l10.656"></a><span id="l10.656">     return NS_OK;</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineminus">-  }</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineminus">-  else if (type.EqualsLiteral(&quot;vcard&quot;))</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineplus">+  } else if (type.EqualsLiteral(&quot;vcard&quot;))</span>
<a href="#l10.660"></a><span id="l10.660">     return ConvertToEscapedVCard(result);</span>
<a href="#l10.661"></a><span id="l10.661"> </span>
<a href="#l10.662"></a><span id="l10.662">   return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l10.663"></a><span id="l10.663"> }</span>
<a href="#l10.664"></a><span id="l10.664"> //</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineminus">-static VObject* myAddPropValue(VObject *o, const char *propName, const char16_t *propValue, bool *aCardHasData)</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineminus">-{</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineminus">-    if (aCardHasData)</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineminus">-        *aCardHasData = true;</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineminus">-    return addPropValue(o, propName, NS_ConvertUTF16toUTF8(propValue).get());</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineplus">+static VObject *myAddPropValue(VObject *o, const char *propName,</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineplus">+                               const char16_t *propValue, bool *aCardHasData) {</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineplus">+  if (aCardHasData) *aCardHasData = true;</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineplus">+  return addPropValue(o, propName, NS_ConvertUTF16toUTF8(propValue).get());</span>
<a href="#l10.674"></a><span id="l10.674"> }</span>
<a href="#l10.675"></a><span id="l10.675"> </span>
<a href="#l10.676"></a><span id="l10.676" class="difflineminus">-nsresult nsAbCardProperty::ConvertToEscapedVCard(nsACString &amp;aResult)</span>
<a href="#l10.677"></a><span id="l10.677" class="difflineminus">-{</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineminus">-    nsString str;</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineminus">-    nsresult rv;</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineminus">-    bool vCardHasData = false;</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineminus">-    VObject* vObj = newVObject(VCCardProp);</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineminus">-    VObject* t;</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineplus">+nsresult nsAbCardProperty::ConvertToEscapedVCard(nsACString &amp;aResult) {</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineplus">+  nsString str;</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineplus">+  bool vCardHasData = false;</span>
<a href="#l10.687"></a><span id="l10.687" class="difflineplus">+  VObject *vObj = newVObject(VCCardProp);</span>
<a href="#l10.688"></a><span id="l10.688" class="difflineplus">+  VObject *t;</span>
<a href="#l10.689"></a><span id="l10.689"> </span>
<a href="#l10.690"></a><span id="l10.690" class="difflineminus">-    // [comment from 4.x]</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineminus">-    // Big flame coming....so Vobject is not designed at all to work with  an array of</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineminus">-    // attribute values. It wants you to have all of the attributes easily available. You</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineminus">-    // cannot add one attribute at a time as you find them to the vobject. Why? Because</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineminus">-    // it creates a property for a particular type like phone number and then that property</span>
<a href="#l10.695"></a><span id="l10.695" class="difflineminus">-    // has multiple values. This implementation is not pretty. I can hear my algos prof</span>
<a href="#l10.696"></a><span id="l10.696" class="difflineminus">-    // yelling from here.....I have to do a linear search through my attributes array for</span>
<a href="#l10.697"></a><span id="l10.697" class="difflineminus">-    // EACH vcard property we want to set. *sigh* One day I will have time to come back</span>
<a href="#l10.698"></a><span id="l10.698" class="difflineminus">-    // to this function and remedy this O(m*n) function where n = # attribute values and</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineminus">-    // m = # of vcard properties....</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineminus">-</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineminus">-    (void)GetDisplayName(str);</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineminus">-    if (!str.IsEmpty()) {</span>
<a href="#l10.703"></a><span id="l10.703" class="difflineminus">-        myAddPropValue(vObj, VCFullNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.704"></a><span id="l10.704" class="difflineminus">-    }</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineplus">+  // [comment from 4.x]</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineplus">+  // Big flame coming....so Vobject is not designed at all to work with  an</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineplus">+  // array of attribute values. It wants you to have all of the attributes</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineplus">+  // easily available. You cannot add one attribute at a time as you find them</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineplus">+  // to the vobject. Why? Because it creates a property for a particular type</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineplus">+  // like phone number and then that property has multiple values. This</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineplus">+  // implementation is not pretty. I can hear my algos prof yelling from</span>
<a href="#l10.712"></a><span id="l10.712" class="difflineplus">+  // here.....I have to do a linear search through my attributes array for EACH</span>
<a href="#l10.713"></a><span id="l10.713" class="difflineplus">+  // vcard property we want to set. *sigh* One day I will have time to come back</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineplus">+  // to this function and remedy this O(m*n) function where n = # attribute</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineplus">+  // values and m = # of vcard properties....</span>
<a href="#l10.716"></a><span id="l10.716"> </span>
<a href="#l10.717"></a><span id="l10.717" class="difflineminus">-    (void)GetLastName(str);</span>
<a href="#l10.718"></a><span id="l10.718" class="difflineminus">-    if (!str.IsEmpty()) {</span>
<a href="#l10.719"></a><span id="l10.719" class="difflineminus">-        t = isAPropertyOf(vObj, VCNameProp);</span>
<a href="#l10.720"></a><span id="l10.720" class="difflineminus">-        if (!t)</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineminus">-            t = addProp(vObj, VCNameProp);</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineminus">-        myAddPropValue(t, VCFamilyNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineminus">-    }</span>
<a href="#l10.724"></a><span id="l10.724" class="difflineplus">+  (void)GetDisplayName(str);</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineplus">+  if (!str.IsEmpty()) {</span>
<a href="#l10.726"></a><span id="l10.726" class="difflineplus">+    myAddPropValue(vObj, VCFullNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.727"></a><span id="l10.727" class="difflineplus">+  }</span>
<a href="#l10.728"></a><span id="l10.728"> </span>
<a href="#l10.729"></a><span id="l10.729" class="difflineminus">-    (void)GetFirstName(str);</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineminus">-    if (!str.IsEmpty()) {</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineminus">-        t = isAPropertyOf(vObj, VCNameProp);</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineminus">-        if (!t)</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineminus">-            t = addProp(vObj, VCNameProp);</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineminus">-        myAddPropValue(t, VCGivenNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineminus">-    }</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineplus">+  (void)GetLastName(str);</span>
<a href="#l10.737"></a><span id="l10.737" class="difflineplus">+  if (!str.IsEmpty()) {</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineplus">+    t = isAPropertyOf(vObj, VCNameProp);</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineplus">+    if (!t) t = addProp(vObj, VCNameProp);</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineplus">+    myAddPropValue(t, VCFamilyNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.741"></a><span id="l10.741" class="difflineplus">+  }</span>
<a href="#l10.742"></a><span id="l10.742"> </span>
<a href="#l10.743"></a><span id="l10.743" class="difflineminus">-    rv = GetPropertyAsAString(kCompanyProperty, str);</span>
<a href="#l10.744"></a><span id="l10.744" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.745"></a><span id="l10.745" class="difflineminus">-    {</span>
<a href="#l10.746"></a><span id="l10.746" class="difflineminus">-        t = isAPropertyOf(vObj, VCOrgProp);</span>
<a href="#l10.747"></a><span id="l10.747" class="difflineminus">-        if (!t)</span>
<a href="#l10.748"></a><span id="l10.748" class="difflineminus">-            t = addProp(vObj, VCOrgProp);</span>
<a href="#l10.749"></a><span id="l10.749" class="difflineminus">-        myAddPropValue(t, VCOrgNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.750"></a><span id="l10.750" class="difflineminus">-    }</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineplus">+  (void)GetFirstName(str);</span>
<a href="#l10.752"></a><span id="l10.752" class="difflineplus">+  if (!str.IsEmpty()) {</span>
<a href="#l10.753"></a><span id="l10.753" class="difflineplus">+    t = isAPropertyOf(vObj, VCNameProp);</span>
<a href="#l10.754"></a><span id="l10.754" class="difflineplus">+    if (!t) t = addProp(vObj, VCNameProp);</span>
<a href="#l10.755"></a><span id="l10.755" class="difflineplus">+    myAddPropValue(t, VCGivenNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.756"></a><span id="l10.756" class="difflineplus">+  }</span>
<a href="#l10.757"></a><span id="l10.757"> </span>
<a href="#l10.758"></a><span id="l10.758" class="difflineminus">-    rv = GetPropertyAsAString(kDepartmentProperty, str);</span>
<a href="#l10.759"></a><span id="l10.759" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.760"></a><span id="l10.760" class="difflineminus">-    {</span>
<a href="#l10.761"></a><span id="l10.761" class="difflineminus">-        t = isAPropertyOf(vObj, VCOrgProp);</span>
<a href="#l10.762"></a><span id="l10.762" class="difflineminus">-        if (!t)</span>
<a href="#l10.763"></a><span id="l10.763" class="difflineminus">-            t = addProp(vObj, VCOrgProp);</span>
<a href="#l10.764"></a><span id="l10.764" class="difflineminus">-        myAddPropValue(t, VCOrgUnitProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.765"></a><span id="l10.765" class="difflineminus">-    }</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineplus">+  rv = GetPropertyAsAString(kCompanyProperty, str);</span>
<a href="#l10.767"></a><span id="l10.767" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.768"></a><span id="l10.768" class="difflineplus">+    t = isAPropertyOf(vObj, VCOrgProp);</span>
<a href="#l10.769"></a><span id="l10.769" class="difflineplus">+    if (!t) t = addProp(vObj, VCOrgProp);</span>
<a href="#l10.770"></a><span id="l10.770" class="difflineplus">+    myAddPropValue(t, VCOrgNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.771"></a><span id="l10.771" class="difflineplus">+  }</span>
<a href="#l10.772"></a><span id="l10.772"> </span>
<a href="#l10.773"></a><span id="l10.773" class="difflineminus">-    rv = GetPropertyAsAString(kWorkAddress2Property, str);</span>
<a href="#l10.774"></a><span id="l10.774" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineminus">-    {</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineminus">-        t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineminus">-        if  (!t)</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineminus">-            t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.779"></a><span id="l10.779" class="difflineminus">-        myAddPropValue(t, VCPostalBoxProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.780"></a><span id="l10.780" class="difflineminus">-    }</span>
<a href="#l10.781"></a><span id="l10.781" class="difflineplus">+  rv = GetPropertyAsAString(kDepartmentProperty, str);</span>
<a href="#l10.782"></a><span id="l10.782" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineplus">+    t = isAPropertyOf(vObj, VCOrgProp);</span>
<a href="#l10.784"></a><span id="l10.784" class="difflineplus">+    if (!t) t = addProp(vObj, VCOrgProp);</span>
<a href="#l10.785"></a><span id="l10.785" class="difflineplus">+    myAddPropValue(t, VCOrgUnitProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.786"></a><span id="l10.786" class="difflineplus">+  }</span>
<a href="#l10.787"></a><span id="l10.787"> </span>
<a href="#l10.788"></a><span id="l10.788" class="difflineminus">-    rv = GetPropertyAsAString(kWorkAddressProperty, str);</span>
<a href="#l10.789"></a><span id="l10.789" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.790"></a><span id="l10.790" class="difflineminus">-    {</span>
<a href="#l10.791"></a><span id="l10.791" class="difflineminus">-        t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.792"></a><span id="l10.792" class="difflineminus">-        if  (!t)</span>
<a href="#l10.793"></a><span id="l10.793" class="difflineminus">-            t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.794"></a><span id="l10.794" class="difflineminus">-        myAddPropValue(t, VCStreetAddressProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.795"></a><span id="l10.795" class="difflineminus">-    }</span>
<a href="#l10.796"></a><span id="l10.796" class="difflineplus">+  rv = GetPropertyAsAString(kWorkAddress2Property, str);</span>
<a href="#l10.797"></a><span id="l10.797" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.798"></a><span id="l10.798" class="difflineplus">+    t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.799"></a><span id="l10.799" class="difflineplus">+    if (!t) t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.800"></a><span id="l10.800" class="difflineplus">+    myAddPropValue(t, VCPostalBoxProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.801"></a><span id="l10.801" class="difflineplus">+  }</span>
<a href="#l10.802"></a><span id="l10.802"> </span>
<a href="#l10.803"></a><span id="l10.803" class="difflineminus">-    rv = GetPropertyAsAString(kWorkCityProperty, str);</span>
<a href="#l10.804"></a><span id="l10.804" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.805"></a><span id="l10.805" class="difflineminus">-    {</span>
<a href="#l10.806"></a><span id="l10.806" class="difflineminus">-        t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.807"></a><span id="l10.807" class="difflineminus">-        if  (!t)</span>
<a href="#l10.808"></a><span id="l10.808" class="difflineminus">-            t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.809"></a><span id="l10.809" class="difflineminus">-        myAddPropValue(t, VCCityProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.810"></a><span id="l10.810" class="difflineminus">-    }</span>
<a href="#l10.811"></a><span id="l10.811" class="difflineplus">+  rv = GetPropertyAsAString(kWorkAddressProperty, str);</span>
<a href="#l10.812"></a><span id="l10.812" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.813"></a><span id="l10.813" class="difflineplus">+    t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.814"></a><span id="l10.814" class="difflineplus">+    if (!t) t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.815"></a><span id="l10.815" class="difflineplus">+    myAddPropValue(t, VCStreetAddressProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.816"></a><span id="l10.816" class="difflineplus">+  }</span>
<a href="#l10.817"></a><span id="l10.817" class="difflineplus">+</span>
<a href="#l10.818"></a><span id="l10.818" class="difflineplus">+  rv = GetPropertyAsAString(kWorkCityProperty, str);</span>
<a href="#l10.819"></a><span id="l10.819" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.820"></a><span id="l10.820" class="difflineplus">+    t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.821"></a><span id="l10.821" class="difflineplus">+    if (!t) t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.822"></a><span id="l10.822" class="difflineplus">+    myAddPropValue(t, VCCityProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.823"></a><span id="l10.823" class="difflineplus">+  }</span>
<a href="#l10.824"></a><span id="l10.824"> </span>
<a href="#l10.825"></a><span id="l10.825" class="difflineminus">-    rv = GetPropertyAsAString(kWorkStateProperty, str);</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.827"></a><span id="l10.827" class="difflineminus">-    {</span>
<a href="#l10.828"></a><span id="l10.828" class="difflineminus">-        t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.829"></a><span id="l10.829" class="difflineminus">-        if  (!t)</span>
<a href="#l10.830"></a><span id="l10.830" class="difflineminus">-            t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.831"></a><span id="l10.831" class="difflineminus">-        myAddPropValue(t, VCRegionProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.832"></a><span id="l10.832" class="difflineminus">-    }</span>
<a href="#l10.833"></a><span id="l10.833" class="difflineplus">+  rv = GetPropertyAsAString(kWorkStateProperty, str);</span>
<a href="#l10.834"></a><span id="l10.834" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.835"></a><span id="l10.835" class="difflineplus">+    t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.836"></a><span id="l10.836" class="difflineplus">+    if (!t) t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.837"></a><span id="l10.837" class="difflineplus">+    myAddPropValue(t, VCRegionProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.838"></a><span id="l10.838" class="difflineplus">+  }</span>
<a href="#l10.839"></a><span id="l10.839"> </span>
<a href="#l10.840"></a><span id="l10.840" class="difflineminus">-    rv = GetPropertyAsAString(kWorkZipCodeProperty, str);</span>
<a href="#l10.841"></a><span id="l10.841" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.842"></a><span id="l10.842" class="difflineminus">-    {</span>
<a href="#l10.843"></a><span id="l10.843" class="difflineminus">-        t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.844"></a><span id="l10.844" class="difflineminus">-        if  (!t)</span>
<a href="#l10.845"></a><span id="l10.845" class="difflineminus">-            t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.846"></a><span id="l10.846" class="difflineminus">-        myAddPropValue(t, VCPostalCodeProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.847"></a><span id="l10.847" class="difflineminus">-    }</span>
<a href="#l10.848"></a><span id="l10.848" class="difflineplus">+  rv = GetPropertyAsAString(kWorkZipCodeProperty, str);</span>
<a href="#l10.849"></a><span id="l10.849" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.850"></a><span id="l10.850" class="difflineplus">+    t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.851"></a><span id="l10.851" class="difflineplus">+    if (!t) t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.852"></a><span id="l10.852" class="difflineplus">+    myAddPropValue(t, VCPostalCodeProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.853"></a><span id="l10.853" class="difflineplus">+  }</span>
<a href="#l10.854"></a><span id="l10.854"> </span>
<a href="#l10.855"></a><span id="l10.855" class="difflineminus">-    rv = GetPropertyAsAString(kWorkCountryProperty, str);</span>
<a href="#l10.856"></a><span id="l10.856" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.857"></a><span id="l10.857" class="difflineminus">-    {</span>
<a href="#l10.858"></a><span id="l10.858" class="difflineminus">-        t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.859"></a><span id="l10.859" class="difflineminus">-        if  (!t)</span>
<a href="#l10.860"></a><span id="l10.860" class="difflineminus">-            t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.861"></a><span id="l10.861" class="difflineminus">-        myAddPropValue(t, VCCountryNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.862"></a><span id="l10.862" class="difflineplus">+  rv = GetPropertyAsAString(kWorkCountryProperty, str);</span>
<a href="#l10.863"></a><span id="l10.863" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.864"></a><span id="l10.864" class="difflineplus">+    t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.865"></a><span id="l10.865" class="difflineplus">+    if (!t) t = addProp(vObj, VCAdrProp);</span>
<a href="#l10.866"></a><span id="l10.866" class="difflineplus">+    myAddPropValue(t, VCCountryNameProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.867"></a><span id="l10.867" class="difflineplus">+  } else {</span>
<a href="#l10.868"></a><span id="l10.868" class="difflineplus">+    // only add this if VCAdrProp already exists</span>
<a href="#l10.869"></a><span id="l10.869" class="difflineplus">+    t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.870"></a><span id="l10.870" class="difflineplus">+    if (t) {</span>
<a href="#l10.871"></a><span id="l10.871" class="difflineplus">+      addProp(t, VCDomesticProp);</span>
<a href="#l10.872"></a><span id="l10.872">     }</span>
<a href="#l10.873"></a><span id="l10.873" class="difflineminus">-    else</span>
<a href="#l10.874"></a><span id="l10.874" class="difflineminus">-    {</span>
<a href="#l10.875"></a><span id="l10.875" class="difflineminus">-        // only add this if VCAdrProp already exists</span>
<a href="#l10.876"></a><span id="l10.876" class="difflineminus">-        t = isAPropertyOf(vObj, VCAdrProp);</span>
<a href="#l10.877"></a><span id="l10.877" class="difflineminus">-        if (t)</span>
<a href="#l10.878"></a><span id="l10.878" class="difflineminus">-        {</span>
<a href="#l10.879"></a><span id="l10.879" class="difflineminus">-            addProp(t, VCDomesticProp);</span>
<a href="#l10.880"></a><span id="l10.880" class="difflineminus">-        }</span>
<a href="#l10.881"></a><span id="l10.881" class="difflineminus">-    }</span>
<a href="#l10.882"></a><span id="l10.882" class="difflineplus">+  }</span>
<a href="#l10.883"></a><span id="l10.883"> </span>
<a href="#l10.884"></a><span id="l10.884" class="difflineminus">-    (void)GetPrimaryEmail(str);</span>
<a href="#l10.885"></a><span id="l10.885" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l10.886"></a><span id="l10.886" class="difflineminus">-    {</span>
<a href="#l10.887"></a><span id="l10.887" class="difflineminus">-        t = myAddPropValue(vObj, VCEmailAddressProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.888"></a><span id="l10.888" class="difflineminus">-        addProp(t, VCInternetProp);</span>
<a href="#l10.889"></a><span id="l10.889" class="difflineminus">-    }</span>
<a href="#l10.890"></a><span id="l10.890" class="difflineplus">+  (void)GetPrimaryEmail(str);</span>
<a href="#l10.891"></a><span id="l10.891" class="difflineplus">+  if (!str.IsEmpty()) {</span>
<a href="#l10.892"></a><span id="l10.892" class="difflineplus">+    t = myAddPropValue(vObj, VCEmailAddressProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.893"></a><span id="l10.893" class="difflineplus">+    addProp(t, VCInternetProp);</span>
<a href="#l10.894"></a><span id="l10.894" class="difflineplus">+  }</span>
<a href="#l10.895"></a><span id="l10.895"> </span>
<a href="#l10.896"></a><span id="l10.896" class="difflineminus">-    rv = GetPropertyAsAString(kJobTitleProperty, str);</span>
<a href="#l10.897"></a><span id="l10.897" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.898"></a><span id="l10.898" class="difflineminus">-    {</span>
<a href="#l10.899"></a><span id="l10.899" class="difflineminus">-        myAddPropValue(vObj, VCTitleProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.900"></a><span id="l10.900" class="difflineminus">-    }</span>
<a href="#l10.901"></a><span id="l10.901" class="difflineplus">+  rv = GetPropertyAsAString(kJobTitleProperty, str);</span>
<a href="#l10.902"></a><span id="l10.902" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.903"></a><span id="l10.903" class="difflineplus">+    myAddPropValue(vObj, VCTitleProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.904"></a><span id="l10.904" class="difflineplus">+  }</span>
<a href="#l10.905"></a><span id="l10.905"> </span>
<a href="#l10.906"></a><span id="l10.906" class="difflineminus">-    rv = GetPropertyAsAString(kWorkPhoneProperty, str);</span>
<a href="#l10.907"></a><span id="l10.907" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.908"></a><span id="l10.908" class="difflineminus">-    {</span>
<a href="#l10.909"></a><span id="l10.909" class="difflineminus">-        t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.910"></a><span id="l10.910" class="difflineminus">-        addProp(t, VCWorkProp);</span>
<a href="#l10.911"></a><span id="l10.911" class="difflineminus">-    }</span>
<a href="#l10.912"></a><span id="l10.912" class="difflineplus">+  rv = GetPropertyAsAString(kWorkPhoneProperty, str);</span>
<a href="#l10.913"></a><span id="l10.913" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.914"></a><span id="l10.914" class="difflineplus">+    t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.915"></a><span id="l10.915" class="difflineplus">+    addProp(t, VCWorkProp);</span>
<a href="#l10.916"></a><span id="l10.916" class="difflineplus">+  }</span>
<a href="#l10.917"></a><span id="l10.917"> </span>
<a href="#l10.918"></a><span id="l10.918" class="difflineminus">-    rv = GetPropertyAsAString(kFaxProperty, str);</span>
<a href="#l10.919"></a><span id="l10.919" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.920"></a><span id="l10.920" class="difflineminus">-    {</span>
<a href="#l10.921"></a><span id="l10.921" class="difflineminus">-        t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.922"></a><span id="l10.922" class="difflineminus">-        addProp(t, VCFaxProp);</span>
<a href="#l10.923"></a><span id="l10.923" class="difflineminus">-    }</span>
<a href="#l10.924"></a><span id="l10.924" class="difflineplus">+  rv = GetPropertyAsAString(kFaxProperty, str);</span>
<a href="#l10.925"></a><span id="l10.925" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.926"></a><span id="l10.926" class="difflineplus">+    t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.927"></a><span id="l10.927" class="difflineplus">+    addProp(t, VCFaxProp);</span>
<a href="#l10.928"></a><span id="l10.928" class="difflineplus">+  }</span>
<a href="#l10.929"></a><span id="l10.929"> </span>
<a href="#l10.930"></a><span id="l10.930" class="difflineminus">-    rv = GetPropertyAsAString(kPagerProperty, str);</span>
<a href="#l10.931"></a><span id="l10.931" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.932"></a><span id="l10.932" class="difflineminus">-    {</span>
<a href="#l10.933"></a><span id="l10.933" class="difflineminus">-        t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.934"></a><span id="l10.934" class="difflineminus">-        addProp(t, VCPagerProp);</span>
<a href="#l10.935"></a><span id="l10.935" class="difflineminus">-    }</span>
<a href="#l10.936"></a><span id="l10.936" class="difflineplus">+  rv = GetPropertyAsAString(kPagerProperty, str);</span>
<a href="#l10.937"></a><span id="l10.937" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.938"></a><span id="l10.938" class="difflineplus">+    t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.939"></a><span id="l10.939" class="difflineplus">+    addProp(t, VCPagerProp);</span>
<a href="#l10.940"></a><span id="l10.940" class="difflineplus">+  }</span>
<a href="#l10.941"></a><span id="l10.941"> </span>
<a href="#l10.942"></a><span id="l10.942" class="difflineminus">-    rv = GetPropertyAsAString(kHomePhoneProperty, str);</span>
<a href="#l10.943"></a><span id="l10.943" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.944"></a><span id="l10.944" class="difflineminus">-    {</span>
<a href="#l10.945"></a><span id="l10.945" class="difflineminus">-        t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.946"></a><span id="l10.946" class="difflineminus">-        addProp(t, VCHomeProp);</span>
<a href="#l10.947"></a><span id="l10.947" class="difflineminus">-    }</span>
<a href="#l10.948"></a><span id="l10.948" class="difflineplus">+  rv = GetPropertyAsAString(kHomePhoneProperty, str);</span>
<a href="#l10.949"></a><span id="l10.949" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.950"></a><span id="l10.950" class="difflineplus">+    t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.951"></a><span id="l10.951" class="difflineplus">+    addProp(t, VCHomeProp);</span>
<a href="#l10.952"></a><span id="l10.952" class="difflineplus">+  }</span>
<a href="#l10.953"></a><span id="l10.953"> </span>
<a href="#l10.954"></a><span id="l10.954" class="difflineminus">-    rv = GetPropertyAsAString(kCellularProperty, str);</span>
<a href="#l10.955"></a><span id="l10.955" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.956"></a><span id="l10.956" class="difflineminus">-    {</span>
<a href="#l10.957"></a><span id="l10.957" class="difflineminus">-        t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.958"></a><span id="l10.958" class="difflineminus">-        addProp(t, VCCellularProp);</span>
<a href="#l10.959"></a><span id="l10.959" class="difflineminus">-    }</span>
<a href="#l10.960"></a><span id="l10.960" class="difflineplus">+  rv = GetPropertyAsAString(kCellularProperty, str);</span>
<a href="#l10.961"></a><span id="l10.961" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.962"></a><span id="l10.962" class="difflineplus">+    t = myAddPropValue(vObj, VCTelephoneProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.963"></a><span id="l10.963" class="difflineplus">+    addProp(t, VCCellularProp);</span>
<a href="#l10.964"></a><span id="l10.964" class="difflineplus">+  }</span>
<a href="#l10.965"></a><span id="l10.965"> </span>
<a href="#l10.966"></a><span id="l10.966" class="difflineminus">-    rv = GetPropertyAsAString(kNotesProperty, str);</span>
<a href="#l10.967"></a><span id="l10.967" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.968"></a><span id="l10.968" class="difflineminus">-    {</span>
<a href="#l10.969"></a><span id="l10.969" class="difflineminus">-        myAddPropValue(vObj, VCNoteProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.970"></a><span id="l10.970" class="difflineminus">-    }</span>
<a href="#l10.971"></a><span id="l10.971" class="difflineplus">+  rv = GetPropertyAsAString(kNotesProperty, str);</span>
<a href="#l10.972"></a><span id="l10.972" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.973"></a><span id="l10.973" class="difflineplus">+    myAddPropValue(vObj, VCNoteProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.974"></a><span id="l10.974" class="difflineplus">+  }</span>
<a href="#l10.975"></a><span id="l10.975"> </span>
<a href="#l10.976"></a><span id="l10.976" class="difflineminus">-    uint32_t format;</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineminus">-    rv = GetPropertyAsUint32(kPreferMailFormatProperty, &amp;format);</span>
<a href="#l10.978"></a><span id="l10.978" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; format == nsIAbPreferMailFormat::html) {</span>
<a href="#l10.979"></a><span id="l10.979" class="difflineminus">-        myAddPropValue(vObj, VCUseHTML, u&quot;TRUE&quot;, &amp;vCardHasData);</span>
<a href="#l10.980"></a><span id="l10.980" class="difflineminus">-    }</span>
<a href="#l10.981"></a><span id="l10.981" class="difflineminus">-    else if (NS_SUCCEEDED(rv) &amp;&amp; format == nsIAbPreferMailFormat::plaintext) {</span>
<a href="#l10.982"></a><span id="l10.982" class="difflineminus">-        myAddPropValue(vObj, VCUseHTML, u&quot;FALSE&quot;, &amp;vCardHasData);</span>
<a href="#l10.983"></a><span id="l10.983" class="difflineminus">-    }</span>
<a href="#l10.984"></a><span id="l10.984" class="difflineplus">+  uint32_t format;</span>
<a href="#l10.985"></a><span id="l10.985" class="difflineplus">+  rv = GetPropertyAsUint32(kPreferMailFormatProperty, &amp;format);</span>
<a href="#l10.986"></a><span id="l10.986" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; format == nsIAbPreferMailFormat::html) {</span>
<a href="#l10.987"></a><span id="l10.987" class="difflineplus">+    myAddPropValue(vObj, VCUseHTML, u&quot;TRUE&quot;, &amp;vCardHasData);</span>
<a href="#l10.988"></a><span id="l10.988" class="difflineplus">+  } else if (NS_SUCCEEDED(rv) &amp;&amp; format == nsIAbPreferMailFormat::plaintext) {</span>
<a href="#l10.989"></a><span id="l10.989" class="difflineplus">+    myAddPropValue(vObj, VCUseHTML, u&quot;FALSE&quot;, &amp;vCardHasData);</span>
<a href="#l10.990"></a><span id="l10.990" class="difflineplus">+  }</span>
<a href="#l10.991"></a><span id="l10.991"> </span>
<a href="#l10.992"></a><span id="l10.992" class="difflineminus">-    rv = GetPropertyAsAString(kWorkWebPageProperty, str);</span>
<a href="#l10.993"></a><span id="l10.993" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty())</span>
<a href="#l10.994"></a><span id="l10.994" class="difflineminus">-    {</span>
<a href="#l10.995"></a><span id="l10.995" class="difflineminus">-        myAddPropValue(vObj, VCURLProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.996"></a><span id="l10.996" class="difflineminus">-    }</span>
<a href="#l10.997"></a><span id="l10.997" class="difflineplus">+  rv = GetPropertyAsAString(kWorkWebPageProperty, str);</span>
<a href="#l10.998"></a><span id="l10.998" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !str.IsEmpty()) {</span>
<a href="#l10.999"></a><span id="l10.999" class="difflineplus">+    myAddPropValue(vObj, VCURLProp, str.get(), &amp;vCardHasData);</span>
<a href="#l10.1000"></a><span id="l10.1000" class="difflineplus">+  }</span>
<a href="#l10.1001"></a><span id="l10.1001" class="difflineplus">+</span>
<a href="#l10.1002"></a><span id="l10.1002" class="difflineplus">+  myAddPropValue(vObj, VCVersionProp, u&quot;2.1&quot;, nullptr);</span>
<a href="#l10.1003"></a><span id="l10.1003"> </span>
<a href="#l10.1004"></a><span id="l10.1004" class="difflineminus">-    myAddPropValue(vObj, VCVersionProp, u&quot;2.1&quot;, nullptr);</span>
<a href="#l10.1005"></a><span id="l10.1005" class="difflineminus">-</span>
<a href="#l10.1006"></a><span id="l10.1006" class="difflineminus">-    if (!vCardHasData) {</span>
<a href="#l10.1007"></a><span id="l10.1007" class="difflineminus">-        aResult.Truncate();</span>
<a href="#l10.1008"></a><span id="l10.1008" class="difflineminus">-        cleanVObject(vObj);</span>
<a href="#l10.1009"></a><span id="l10.1009" class="difflineminus">-        return NS_OK;</span>
<a href="#l10.1010"></a><span id="l10.1010" class="difflineminus">-    }</span>
<a href="#l10.1011"></a><span id="l10.1011" class="difflineplus">+  if (!vCardHasData) {</span>
<a href="#l10.1012"></a><span id="l10.1012" class="difflineplus">+    aResult.Truncate();</span>
<a href="#l10.1013"></a><span id="l10.1013" class="difflineplus">+    cleanVObject(vObj);</span>
<a href="#l10.1014"></a><span id="l10.1014" class="difflineplus">+    return NS_OK;</span>
<a href="#l10.1015"></a><span id="l10.1015" class="difflineplus">+  }</span>
<a href="#l10.1016"></a><span id="l10.1016"> </span>
<a href="#l10.1017"></a><span id="l10.1017" class="difflineminus">-    int len = 0;</span>
<a href="#l10.1018"></a><span id="l10.1018" class="difflineminus">-    char *vCard = writeMemVObject(0, &amp;len, vObj);</span>
<a href="#l10.1019"></a><span id="l10.1019" class="difflineminus">-    if (vObj)</span>
<a href="#l10.1020"></a><span id="l10.1020" class="difflineminus">-        cleanVObject(vObj);</span>
<a href="#l10.1021"></a><span id="l10.1021" class="difflineplus">+  int len = 0;</span>
<a href="#l10.1022"></a><span id="l10.1022" class="difflineplus">+  char *vCard = writeMemVObject(0, &amp;len, vObj);</span>
<a href="#l10.1023"></a><span id="l10.1023" class="difflineplus">+  if (vObj) cleanVObject(vObj);</span>
<a href="#l10.1024"></a><span id="l10.1024"> </span>
<a href="#l10.1025"></a><span id="l10.1025" class="difflineminus">-    nsCString escResult;</span>
<a href="#l10.1026"></a><span id="l10.1026" class="difflineminus">-    MsgEscapeString(nsDependentCString(vCard), nsINetUtil::ESCAPE_URL_PATH, escResult);</span>
<a href="#l10.1027"></a><span id="l10.1027" class="difflineminus">-    aResult = escResult;</span>
<a href="#l10.1028"></a><span id="l10.1028" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.1029"></a><span id="l10.1029" class="difflineplus">+  nsCString escResult;</span>
<a href="#l10.1030"></a><span id="l10.1030" class="difflineplus">+  MsgEscapeString(nsDependentCString(vCard), nsINetUtil::ESCAPE_URL_PATH,</span>
<a href="#l10.1031"></a><span id="l10.1031" class="difflineplus">+                  escResult);</span>
<a href="#l10.1032"></a><span id="l10.1032" class="difflineplus">+  aResult = escResult;</span>
<a href="#l10.1033"></a><span id="l10.1033" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.1034"></a><span id="l10.1034"> }</span>
<a href="#l10.1035"></a><span id="l10.1035"> </span>
<a href="#l10.1036"></a><span id="l10.1036" class="difflineminus">-nsresult nsAbCardProperty::ConvertToBase64EncodedXML(nsACString &amp;result)</span>
<a href="#l10.1037"></a><span id="l10.1037" class="difflineminus">-{</span>
<a href="#l10.1038"></a><span id="l10.1038" class="difflineplus">+nsresult nsAbCardProperty::ConvertToBase64EncodedXML(nsACString &amp;result) {</span>
<a href="#l10.1039"></a><span id="l10.1039">   nsresult rv;</span>
<a href="#l10.1040"></a><span id="l10.1040">   nsString xmlStr;</span>
<a href="#l10.1041"></a><span id="l10.1041"> </span>
<a href="#l10.1042"></a><span id="l10.1042" class="difflineminus">-  xmlStr.AppendLiteral(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a href="#l10.1043"></a><span id="l10.1043" class="difflineminus">-                       &quot;&lt;?xml-stylesheet type=\&quot;text/css\&quot; href=\&quot;chrome://messagebody/content/addressbook/print.css\&quot;?&gt;\n&quot;</span>
<a href="#l10.1044"></a><span id="l10.1044" class="difflineminus">-                       &quot;&lt;directory&gt;\n&quot;);</span>
<a href="#l10.1045"></a><span id="l10.1045" class="difflineplus">+  xmlStr.AppendLiteral(</span>
<a href="#l10.1046"></a><span id="l10.1046" class="difflineplus">+      &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a href="#l10.1047"></a><span id="l10.1047" class="difflineplus">+      &quot;&lt;?xml-stylesheet type=\&quot;text/css\&quot; &quot;</span>
<a href="#l10.1048"></a><span id="l10.1048" class="difflineplus">+      &quot;href=\&quot;chrome://messagebody/content/addressbook/print.css\&quot;?&gt;\n&quot;</span>
<a href="#l10.1049"></a><span id="l10.1049" class="difflineplus">+      &quot;&lt;directory&gt;\n&quot;);</span>
<a href="#l10.1050"></a><span id="l10.1050"> </span>
<a href="#l10.1051"></a><span id="l10.1051">   // Get Address Book string and set it as title of XML document</span>
<a href="#l10.1052"></a><span id="l10.1052">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.1053"></a><span id="l10.1053">   nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l10.1054"></a><span id="l10.1054" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l10.1055"></a><span id="l10.1055" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l10.1056"></a><span id="l10.1056">   if (stringBundleService) {</span>
<a href="#l10.1057"></a><span id="l10.1057" class="difflineminus">-    rv = stringBundleService-&gt;CreateBundle(sAddrbookProperties, getter_AddRefs(bundle));</span>
<a href="#l10.1058"></a><span id="l10.1058" class="difflineplus">+    rv = stringBundleService-&gt;CreateBundle(sAddrbookProperties,</span>
<a href="#l10.1059"></a><span id="l10.1059" class="difflineplus">+                                           getter_AddRefs(bundle));</span>
<a href="#l10.1060"></a><span id="l10.1060">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.1061"></a><span id="l10.1061">       nsString addrBook;</span>
<a href="#l10.1062"></a><span id="l10.1062">       rv = bundle-&gt;GetStringFromName(&quot;addressBook&quot;, addrBook);</span>
<a href="#l10.1063"></a><span id="l10.1063">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.1064"></a><span id="l10.1064">         xmlStr.AppendLiteral(&quot;&lt;title xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;&quot;);</span>
<a href="#l10.1065"></a><span id="l10.1065">         xmlStr.Append(addrBook);</span>
<a href="#l10.1066"></a><span id="l10.1066">         xmlStr.AppendLiteral(&quot;&lt;/title&gt;\n&quot;);</span>
<a href="#l10.1067"></a><span id="l10.1067">       }</span>
<a href="#l10.1068"></a><span id="l10.1068">     }</span>
<a href="#l10.1069"></a><span id="l10.1069">   }</span>
<a href="#l10.1070"></a><span id="l10.1070"> </span>
<a href="#l10.1071"></a><span id="l10.1071">   nsString xmlSubstr;</span>
<a href="#l10.1072"></a><span id="l10.1072">   rv = ConvertToXMLPrintData(xmlSubstr);</span>
<a href="#l10.1073"></a><span id="l10.1073" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1074"></a><span id="l10.1074" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1075"></a><span id="l10.1075"> </span>
<a href="#l10.1076"></a><span id="l10.1076">   xmlStr.Append(xmlSubstr);</span>
<a href="#l10.1077"></a><span id="l10.1077">   xmlStr.AppendLiteral(&quot;&lt;/directory&gt;\n&quot;);</span>
<a href="#l10.1078"></a><span id="l10.1078"> </span>
<a href="#l10.1079"></a><span id="l10.1079" class="difflineminus">-  char *tmpRes = PL_Base64Encode(NS_ConvertUTF16toUTF8(xmlStr).get(), 0, nullptr);</span>
<a href="#l10.1080"></a><span id="l10.1080" class="difflineplus">+  char *tmpRes =</span>
<a href="#l10.1081"></a><span id="l10.1081" class="difflineplus">+      PL_Base64Encode(NS_ConvertUTF16toUTF8(xmlStr).get(), 0, nullptr);</span>
<a href="#l10.1082"></a><span id="l10.1082">   result.Assign(tmpRes);</span>
<a href="#l10.1083"></a><span id="l10.1083">   PR_Free(tmpRes);</span>
<a href="#l10.1084"></a><span id="l10.1084">   return NS_OK;</span>
<a href="#l10.1085"></a><span id="l10.1085"> }</span>
<a href="#l10.1086"></a><span id="l10.1086"> </span>
<a href="#l10.1087"></a><span id="l10.1087" class="difflineminus">-nsresult nsAbCardProperty::ConvertToXMLPrintData(nsAString &amp;aXMLSubstr)</span>
<a href="#l10.1088"></a><span id="l10.1088" class="difflineminus">-{</span>
<a href="#l10.1089"></a><span id="l10.1089" class="difflineplus">+nsresult nsAbCardProperty::ConvertToXMLPrintData(nsAString &amp;aXMLSubstr) {</span>
<a href="#l10.1090"></a><span id="l10.1090">   nsresult rv;</span>
<a href="#l10.1091"></a><span id="l10.1091" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.1092"></a><span id="l10.1092" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1093"></a><span id="l10.1093" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l10.1094"></a><span id="l10.1094" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.1095"></a><span id="l10.1095" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1096"></a><span id="l10.1096"> </span>
<a href="#l10.1097"></a><span id="l10.1097">   int32_t generatedNameFormat;</span>
<a href="#l10.1098"></a><span id="l10.1098" class="difflineminus">-  rv = prefBranch-&gt;GetIntPref(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, &amp;generatedNameFormat);</span>
<a href="#l10.1099"></a><span id="l10.1099" class="difflineplus">+  rv = prefBranch-&gt;GetIntPref(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST,</span>
<a href="#l10.1100"></a><span id="l10.1100" class="difflineplus">+                              &amp;generatedNameFormat);</span>
<a href="#l10.1101"></a><span id="l10.1101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1102"></a><span id="l10.1102"> </span>
<a href="#l10.1103"></a><span id="l10.1103">   nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l10.1104"></a><span id="l10.1104" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l10.1105"></a><span id="l10.1105" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l10.1106"></a><span id="l10.1106">   NS_ENSURE_TRUE(stringBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l10.1107"></a><span id="l10.1107"> </span>
<a href="#l10.1108"></a><span id="l10.1108">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.1109"></a><span id="l10.1109" class="difflineminus">-  rv = stringBundleService-&gt;CreateBundle(sAddrbookProperties, getter_AddRefs(bundle));</span>
<a href="#l10.1110"></a><span id="l10.1110" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1111"></a><span id="l10.1111" class="difflineplus">+  rv = stringBundleService-&gt;CreateBundle(sAddrbookProperties,</span>
<a href="#l10.1112"></a><span id="l10.1112" class="difflineplus">+                                         getter_AddRefs(bundle));</span>
<a href="#l10.1113"></a><span id="l10.1113" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1114"></a><span id="l10.1114"> </span>
<a href="#l10.1115"></a><span id="l10.1115">   nsString generatedName;</span>
<a href="#l10.1116"></a><span id="l10.1116">   rv = GenerateName(generatedNameFormat, bundle, generatedName);</span>
<a href="#l10.1117"></a><span id="l10.1117" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1118"></a><span id="l10.1118" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1119"></a><span id="l10.1119"> </span>
<a href="#l10.1120"></a><span id="l10.1120" class="difflineminus">-  nsCOMPtr&lt;mozITXTToHTMLConv&gt; conv = do_CreateInstance(MOZ_TXTTOHTMLCONV_CONTRACTID, &amp;rv);</span>
<a href="#l10.1121"></a><span id="l10.1121" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1122"></a><span id="l10.1122" class="difflineplus">+  nsCOMPtr&lt;mozITXTToHTMLConv&gt; conv =</span>
<a href="#l10.1123"></a><span id="l10.1123" class="difflineplus">+      do_CreateInstance(MOZ_TXTTOHTMLCONV_CONTRACTID, &amp;rv);</span>
<a href="#l10.1124"></a><span id="l10.1124" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1125"></a><span id="l10.1125"> </span>
<a href="#l10.1126"></a><span id="l10.1126">   nsString xmlStr;</span>
<a href="#l10.1127"></a><span id="l10.1127" class="difflineminus">-  xmlStr.SetLength(4096); // to reduce allocations. should be enough for most cards</span>
<a href="#l10.1128"></a><span id="l10.1128" class="difflineplus">+  xmlStr.SetLength(</span>
<a href="#l10.1129"></a><span id="l10.1129" class="difflineplus">+      4096);  // to reduce allocations. should be enough for most cards</span>
<a href="#l10.1130"></a><span id="l10.1130">   xmlStr.AssignLiteral(&quot;&lt;GeneratedName&gt;\n&quot;);</span>
<a href="#l10.1131"></a><span id="l10.1131"> </span>
<a href="#l10.1132"></a><span id="l10.1132">   // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l10.1133"></a><span id="l10.1133">   nsString safeText;</span>
<a href="#l10.1134"></a><span id="l10.1134">   if (!generatedName.IsEmpty()) {</span>
<a href="#l10.1135"></a><span id="l10.1135">     rv = conv-&gt;ScanTXT(generatedName, mozITXTToHTMLConv::kEntities, safeText);</span>
<a href="#l10.1136"></a><span id="l10.1136" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1137"></a><span id="l10.1137" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1138"></a><span id="l10.1138">   }</span>
<a href="#l10.1139"></a><span id="l10.1139"> </span>
<a href="#l10.1140"></a><span id="l10.1140">   if (safeText.IsEmpty()) {</span>
<a href="#l10.1141"></a><span id="l10.1141">     nsAutoString primaryEmail;</span>
<a href="#l10.1142"></a><span id="l10.1142">     GetPrimaryEmail(primaryEmail);</span>
<a href="#l10.1143"></a><span id="l10.1143"> </span>
<a href="#l10.1144"></a><span id="l10.1144">     // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l10.1145"></a><span id="l10.1145">     rv = conv-&gt;ScanTXT(primaryEmail, mozITXTToHTMLConv::kEntities, safeText);</span>
<a href="#l10.1146"></a><span id="l10.1146" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1147"></a><span id="l10.1147" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1148"></a><span id="l10.1148">   }</span>
<a href="#l10.1149"></a><span id="l10.1149">   xmlStr.Append(safeText);</span>
<a href="#l10.1150"></a><span id="l10.1150"> </span>
<a href="#l10.1151"></a><span id="l10.1151" class="difflineminus">-  xmlStr.AppendLiteral(&quot;&lt;/GeneratedName&gt;\n&quot;</span>
<a href="#l10.1152"></a><span id="l10.1152" class="difflineminus">-                       &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<a href="#l10.1153"></a><span id="l10.1153" class="difflineplus">+  xmlStr.AppendLiteral(</span>
<a href="#l10.1154"></a><span id="l10.1154" class="difflineplus">+      &quot;&lt;/GeneratedName&gt;\n&quot;</span>
<a href="#l10.1155"></a><span id="l10.1155" class="difflineplus">+      &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<a href="#l10.1156"></a><span id="l10.1156"> </span>
<a href="#l10.1157"></a><span id="l10.1157" class="difflineminus">-  rv = AppendSection(NAME_ATTRS_ARRAY, sizeof(NAME_ATTRS_ARRAY)/sizeof(AppendItem), EmptyString(), bundle, conv, xmlStr);</span>
<a href="#l10.1158"></a><span id="l10.1158" class="difflineplus">+  rv = AppendSection(NAME_ATTRS_ARRAY,</span>
<a href="#l10.1159"></a><span id="l10.1159" class="difflineplus">+                     sizeof(NAME_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l10.1160"></a><span id="l10.1160" class="difflineplus">+                     EmptyString(), bundle, conv, xmlStr);</span>
<a href="#l10.1161"></a><span id="l10.1161"> </span>
<a href="#l10.1162"></a><span id="l10.1162">   xmlStr.AppendLiteral(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<a href="#l10.1163"></a><span id="l10.1163"> </span>
<a href="#l10.1164"></a><span id="l10.1164" class="difflineminus">-  rv = AppendSection(PHONE_ATTRS_ARRAY, sizeof(PHONE_ATTRS_ARRAY)/sizeof(AppendItem), NS_LITERAL_STRING(&quot;headingPhone&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1165"></a><span id="l10.1165" class="difflineplus">+  rv = AppendSection(PHONE_ATTRS_ARRAY,</span>
<a href="#l10.1166"></a><span id="l10.1166" class="difflineplus">+                     sizeof(PHONE_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l10.1167"></a><span id="l10.1167" class="difflineplus">+                     NS_LITERAL_STRING(&quot;headingPhone&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1168"></a><span id="l10.1168"> </span>
<a href="#l10.1169"></a><span id="l10.1169">   if (!m_IsMailList) {</span>
<a href="#l10.1170"></a><span id="l10.1170" class="difflineminus">-    rv = AppendSection(CUSTOM_ATTRS_ARRAY, sizeof(CUSTOM_ATTRS_ARRAY)/sizeof(AppendItem), NS_LITERAL_STRING(&quot;headingOther&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1171"></a><span id="l10.1171" class="difflineplus">+    rv = AppendSection(CUSTOM_ATTRS_ARRAY,</span>
<a href="#l10.1172"></a><span id="l10.1172" class="difflineplus">+                       sizeof(CUSTOM_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l10.1173"></a><span id="l10.1173" class="difflineplus">+                       NS_LITERAL_STRING(&quot;headingOther&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1174"></a><span id="l10.1174"> #ifdef MOZ_THUNDERBIRD</span>
<a href="#l10.1175"></a><span id="l10.1175" class="difflineminus">-    rv = AppendSection(CHAT_ATTRS_ARRAY, sizeof(CHAT_ATTRS_ARRAY)/sizeof(AppendItem), NS_LITERAL_STRING(&quot;headingChat&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1176"></a><span id="l10.1176" class="difflineplus">+    rv = AppendSection(CHAT_ATTRS_ARRAY,</span>
<a href="#l10.1177"></a><span id="l10.1177" class="difflineplus">+                       sizeof(CHAT_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l10.1178"></a><span id="l10.1178" class="difflineplus">+                       NS_LITERAL_STRING(&quot;headingChat&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1179"></a><span id="l10.1179"> #endif</span>
<a href="#l10.1180"></a><span id="l10.1180" class="difflineminus">-  }</span>
<a href="#l10.1181"></a><span id="l10.1181" class="difflineminus">-  else {</span>
<a href="#l10.1182"></a><span id="l10.1182" class="difflineminus">-    rv = AppendSection(CUSTOM_ATTRS_ARRAY, sizeof(CUSTOM_ATTRS_ARRAY)/sizeof(AppendItem), NS_LITERAL_STRING(&quot;headingDescription&quot;),</span>
<a href="#l10.1183"></a><span id="l10.1183" class="difflineminus">-         bundle, conv, xmlStr);</span>
<a href="#l10.1184"></a><span id="l10.1184" class="difflineplus">+  } else {</span>
<a href="#l10.1185"></a><span id="l10.1185" class="difflineplus">+    rv = AppendSection(</span>
<a href="#l10.1186"></a><span id="l10.1186" class="difflineplus">+        CUSTOM_ATTRS_ARRAY, sizeof(CUSTOM_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l10.1187"></a><span id="l10.1187" class="difflineplus">+        NS_LITERAL_STRING(&quot;headingDescription&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1188"></a><span id="l10.1188"> </span>
<a href="#l10.1189"></a><span id="l10.1189">     xmlStr.AppendLiteral(&quot;&lt;section&gt;&lt;sectiontitle&gt;&quot;);</span>
<a href="#l10.1190"></a><span id="l10.1190"> </span>
<a href="#l10.1191"></a><span id="l10.1191">     nsString headingAddresses;</span>
<a href="#l10.1192"></a><span id="l10.1192">     rv = bundle-&gt;GetStringFromName(&quot;headingAddresses&quot;, headingAddresses);</span>
<a href="#l10.1193"></a><span id="l10.1193">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1194"></a><span id="l10.1194"> </span>
<a href="#l10.1195"></a><span id="l10.1195">     xmlStr.Append(headingAddresses);</span>
<a href="#l10.1196"></a><span id="l10.1196">     xmlStr.AppendLiteral(&quot;&lt;/sectiontitle&gt;&quot;);</span>
<a href="#l10.1197"></a><span id="l10.1197"> </span>
<a href="#l10.1198"></a><span id="l10.1198" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.1199"></a><span id="l10.1199" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l10.1200"></a><span id="l10.1200" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.1201"></a><span id="l10.1201">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1202"></a><span id="l10.1202"> </span>
<a href="#l10.1203"></a><span id="l10.1203" class="difflineminus">-    nsCOMPtr &lt;nsIAbDirectory&gt; mailList = nullptr;</span>
<a href="#l10.1204"></a><span id="l10.1204" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; mailList = nullptr;</span>
<a href="#l10.1205"></a><span id="l10.1205">     rv = abManager-&gt;GetDirectory(m_MailListURI, getter_AddRefs(mailList));</span>
<a href="#l10.1206"></a><span id="l10.1206">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1207"></a><span id="l10.1207"> </span>
<a href="#l10.1208"></a><span id="l10.1208">     nsCOMPtr&lt;nsIMutableArray&gt; addresses;</span>
<a href="#l10.1209"></a><span id="l10.1209">     rv = mailList-&gt;GetAddressLists(getter_AddRefs(addresses));</span>
<a href="#l10.1210"></a><span id="l10.1210">     if (addresses) {</span>
<a href="#l10.1211"></a><span id="l10.1211">       uint32_t total = 0;</span>
<a href="#l10.1212"></a><span id="l10.1212">       addresses-&gt;GetLength(&amp;total);</span>
<a href="#l10.1213"></a><span id="l10.1213">       if (total) {</span>
<a href="#l10.1214"></a><span id="l10.1214">         uint32_t i;</span>
<a href="#l10.1215"></a><span id="l10.1215">         nsAutoString displayName;</span>
<a href="#l10.1216"></a><span id="l10.1216">         nsAutoString primaryEmail;</span>
<a href="#l10.1217"></a><span id="l10.1217">         for (i = 0; i &lt; total; i++) {</span>
<a href="#l10.1218"></a><span id="l10.1218" class="difflineminus">-          nsCOMPtr &lt;nsIAbCard&gt; listCard = do_QueryElementAt(addresses, i, &amp;rv);</span>
<a href="#l10.1219"></a><span id="l10.1219" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1220"></a><span id="l10.1220" class="difflineplus">+          nsCOMPtr&lt;nsIAbCard&gt; listCard = do_QueryElementAt(addresses, i, &amp;rv);</span>
<a href="#l10.1221"></a><span id="l10.1221" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1222"></a><span id="l10.1222"> </span>
<a href="#l10.1223"></a><span id="l10.1223">           xmlStr.AppendLiteral(&quot;&lt;PrimaryEmail&gt;\n&quot;);</span>
<a href="#l10.1224"></a><span id="l10.1224"> </span>
<a href="#l10.1225"></a><span id="l10.1225">           rv = listCard-&gt;GetDisplayName(displayName);</span>
<a href="#l10.1226"></a><span id="l10.1226" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1227"></a><span id="l10.1227" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1228"></a><span id="l10.1228"> </span>
<a href="#l10.1229"></a><span id="l10.1229">           // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l10.1230"></a><span id="l10.1230">           nsString safeText;</span>
<a href="#l10.1231"></a><span id="l10.1231" class="difflineminus">-          rv = conv-&gt;ScanTXT(displayName, mozITXTToHTMLConv::kEntities, safeText);</span>
<a href="#l10.1232"></a><span id="l10.1232" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1233"></a><span id="l10.1233" class="difflineplus">+          rv = conv-&gt;ScanTXT(displayName, mozITXTToHTMLConv::kEntities,</span>
<a href="#l10.1234"></a><span id="l10.1234" class="difflineplus">+                             safeText);</span>
<a href="#l10.1235"></a><span id="l10.1235" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1236"></a><span id="l10.1236">           xmlStr.Append(safeText);</span>
<a href="#l10.1237"></a><span id="l10.1237"> </span>
<a href="#l10.1238"></a><span id="l10.1238">           xmlStr.AppendLiteral(&quot; &amp;lt;&quot;);</span>
<a href="#l10.1239"></a><span id="l10.1239"> </span>
<a href="#l10.1240"></a><span id="l10.1240">           listCard-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l10.1241"></a><span id="l10.1241"> </span>
<a href="#l10.1242"></a><span id="l10.1242">           // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l10.1243"></a><span id="l10.1243" class="difflineminus">-          rv = conv-&gt;ScanTXT(primaryEmail, mozITXTToHTMLConv::kEntities, safeText);</span>
<a href="#l10.1244"></a><span id="l10.1244" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1245"></a><span id="l10.1245" class="difflineplus">+          rv = conv-&gt;ScanTXT(primaryEmail, mozITXTToHTMLConv::kEntities,</span>
<a href="#l10.1246"></a><span id="l10.1246" class="difflineplus">+                             safeText);</span>
<a href="#l10.1247"></a><span id="l10.1247" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1248"></a><span id="l10.1248">           xmlStr.Append(safeText);</span>
<a href="#l10.1249"></a><span id="l10.1249"> </span>
<a href="#l10.1250"></a><span id="l10.1250">           xmlStr.AppendLiteral(&quot;&amp;gt;&lt;/PrimaryEmail&gt;\n&quot;);</span>
<a href="#l10.1251"></a><span id="l10.1251">         }</span>
<a href="#l10.1252"></a><span id="l10.1252">       }</span>
<a href="#l10.1253"></a><span id="l10.1253">     }</span>
<a href="#l10.1254"></a><span id="l10.1254">     xmlStr.AppendLiteral(&quot;&lt;/section&gt;&quot;);</span>
<a href="#l10.1255"></a><span id="l10.1255">   }</span>
<a href="#l10.1256"></a><span id="l10.1256"> </span>
<a href="#l10.1257"></a><span id="l10.1257">   xmlStr.AppendLiteral(&quot;&lt;/td&gt;&lt;td&gt;&quot;);</span>
<a href="#l10.1258"></a><span id="l10.1258"> </span>
<a href="#l10.1259"></a><span id="l10.1259" class="difflineminus">-  rv = AppendSection(HOME_ATTRS_ARRAY, sizeof(HOME_ATTRS_ARRAY)/sizeof(AppendItem), NS_LITERAL_STRING(&quot;headingHome&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1260"></a><span id="l10.1260" class="difflineminus">-  rv = AppendSection(WORK_ATTRS_ARRAY, sizeof(WORK_ATTRS_ARRAY)/sizeof(AppendItem), NS_LITERAL_STRING(&quot;headingWork&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1261"></a><span id="l10.1261" class="difflineplus">+  rv = AppendSection(HOME_ATTRS_ARRAY,</span>
<a href="#l10.1262"></a><span id="l10.1262" class="difflineplus">+                     sizeof(HOME_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l10.1263"></a><span id="l10.1263" class="difflineplus">+                     NS_LITERAL_STRING(&quot;headingHome&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1264"></a><span id="l10.1264" class="difflineplus">+  rv = AppendSection(WORK_ATTRS_ARRAY,</span>
<a href="#l10.1265"></a><span id="l10.1265" class="difflineplus">+                     sizeof(WORK_ATTRS_ARRAY) / sizeof(AppendItem),</span>
<a href="#l10.1266"></a><span id="l10.1266" class="difflineplus">+                     NS_LITERAL_STRING(&quot;headingWork&quot;), bundle, conv, xmlStr);</span>
<a href="#l10.1267"></a><span id="l10.1267"> </span>
<a href="#l10.1268"></a><span id="l10.1268">   xmlStr.AppendLiteral(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<a href="#l10.1269"></a><span id="l10.1269"> </span>
<a href="#l10.1270"></a><span id="l10.1270">   aXMLSubstr = xmlStr;</span>
<a href="#l10.1271"></a><span id="l10.1271"> </span>
<a href="#l10.1272"></a><span id="l10.1272">   return NS_OK;</span>
<a href="#l10.1273"></a><span id="l10.1273"> }</span>
<a href="#l10.1274"></a><span id="l10.1274"> </span>
<a href="#l10.1275"></a><span id="l10.1275" class="difflineminus">-nsresult nsAbCardProperty::AppendSection(const AppendItem *aArray, int16_t aCount, const nsString&amp; aHeading,</span>
<a href="#l10.1276"></a><span id="l10.1276" class="difflineminus">-                                         nsIStringBundle *aBundle,</span>
<a href="#l10.1277"></a><span id="l10.1277" class="difflineminus">-                                         mozITXTToHTMLConv *aConv,</span>
<a href="#l10.1278"></a><span id="l10.1278" class="difflineminus">-                                         nsString &amp;aResult)</span>
<a href="#l10.1279"></a><span id="l10.1279" class="difflineminus">-{</span>
<a href="#l10.1280"></a><span id="l10.1280" class="difflineplus">+nsresult nsAbCardProperty::AppendSection(</span>
<a href="#l10.1281"></a><span id="l10.1281" class="difflineplus">+    const AppendItem *aArray, int16_t aCount, const nsString &amp;aHeading,</span>
<a href="#l10.1282"></a><span id="l10.1282" class="difflineplus">+    nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult) {</span>
<a href="#l10.1283"></a><span id="l10.1283">   nsresult rv = NS_OK;</span>
<a href="#l10.1284"></a><span id="l10.1284"> </span>
<a href="#l10.1285"></a><span id="l10.1285">   aResult.AppendLiteral(&quot;&lt;section&gt;&quot;);</span>
<a href="#l10.1286"></a><span id="l10.1286"> </span>
<a href="#l10.1287"></a><span id="l10.1287">   nsString attrValue;</span>
<a href="#l10.1288"></a><span id="l10.1288">   bool sectionIsEmpty = true;</span>
<a href="#l10.1289"></a><span id="l10.1289"> </span>
<a href="#l10.1290"></a><span id="l10.1290">   int16_t i = 0;</span>
<a href="#l10.1291"></a><span id="l10.1291" class="difflineminus">-  for (i=0;i&lt;aCount;i++) {</span>
<a href="#l10.1292"></a><span id="l10.1292" class="difflineplus">+  for (i = 0; i &lt; aCount; i++) {</span>
<a href="#l10.1293"></a><span id="l10.1293">     rv = GetPropertyAsAString(aArray[i].mColumn, attrValue);</span>
<a href="#l10.1294"></a><span id="l10.1294" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty())</span>
<a href="#l10.1295"></a><span id="l10.1295" class="difflineminus">-      sectionIsEmpty = false;</span>
<a href="#l10.1296"></a><span id="l10.1296" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) sectionIsEmpty = false;</span>
<a href="#l10.1297"></a><span id="l10.1297">   }</span>
<a href="#l10.1298"></a><span id="l10.1298"> </span>
<a href="#l10.1299"></a><span id="l10.1299">   if (!sectionIsEmpty &amp;&amp; !aHeading.IsEmpty()) {</span>
<a href="#l10.1300"></a><span id="l10.1300">     nsString heading;</span>
<a href="#l10.1301"></a><span id="l10.1301" class="difflineminus">-    rv = aBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(aHeading).get(), heading);</span>
<a href="#l10.1302"></a><span id="l10.1302" class="difflineplus">+    rv = aBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(aHeading).get(),</span>
<a href="#l10.1303"></a><span id="l10.1303" class="difflineplus">+                                    heading);</span>
<a href="#l10.1304"></a><span id="l10.1304">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1305"></a><span id="l10.1305"> </span>
<a href="#l10.1306"></a><span id="l10.1306">     aResult.AppendLiteral(&quot;&lt;sectiontitle&gt;&quot;);</span>
<a href="#l10.1307"></a><span id="l10.1307">     aResult.Append(heading);</span>
<a href="#l10.1308"></a><span id="l10.1308">     aResult.AppendLiteral(&quot;&lt;/sectiontitle&gt;&quot;);</span>
<a href="#l10.1309"></a><span id="l10.1309">   }</span>
<a href="#l10.1310"></a><span id="l10.1310"> </span>
<a href="#l10.1311"></a><span id="l10.1311" class="difflineminus">-  for (i=0;i&lt;aCount;i++) {</span>
<a href="#l10.1312"></a><span id="l10.1312" class="difflineplus">+  for (i = 0; i &lt; aCount; i++) {</span>
<a href="#l10.1313"></a><span id="l10.1313">     switch (aArray[i].mAppendType) {</span>
<a href="#l10.1314"></a><span id="l10.1314">       case eAppendLine:</span>
<a href="#l10.1315"></a><span id="l10.1315">         rv = AppendLine(aArray[i], aConv, aResult);</span>
<a href="#l10.1316"></a><span id="l10.1316">         break;</span>
<a href="#l10.1317"></a><span id="l10.1317">       case eAppendLabel:</span>
<a href="#l10.1318"></a><span id="l10.1318">         rv = AppendLabel(aArray[i], aBundle, aConv, aResult);</span>
<a href="#l10.1319"></a><span id="l10.1319">         break;</span>
<a href="#l10.1320"></a><span id="l10.1320">       case eAppendCityStateZip:</span>
<a href="#l10.1321"></a><span id="l10.1321" class="difflineat">@@ -997,147 +942,149 @@ nsresult nsAbCardProperty::AppendSection</span>
<a href="#l10.1322"></a><span id="l10.1322">   }</span>
<a href="#l10.1323"></a><span id="l10.1323">   aResult.AppendLiteral(&quot;&lt;/section&gt;&quot;);</span>
<a href="#l10.1324"></a><span id="l10.1324"> </span>
<a href="#l10.1325"></a><span id="l10.1325">   return rv;</span>
<a href="#l10.1326"></a><span id="l10.1326"> }</span>
<a href="#l10.1327"></a><span id="l10.1327"> </span>
<a href="#l10.1328"></a><span id="l10.1328"> nsresult nsAbCardProperty::AppendLine(const AppendItem &amp;aItem,</span>
<a href="#l10.1329"></a><span id="l10.1329">                                       mozITXTToHTMLConv *aConv,</span>
<a href="#l10.1330"></a><span id="l10.1330" class="difflineminus">-                                      nsString &amp;aResult)</span>
<a href="#l10.1331"></a><span id="l10.1331" class="difflineminus">-{</span>
<a href="#l10.1332"></a><span id="l10.1332" class="difflineplus">+                                      nsString &amp;aResult) {</span>
<a href="#l10.1333"></a><span id="l10.1333">   NS_ENSURE_ARG_POINTER(aConv);</span>
<a href="#l10.1334"></a><span id="l10.1334"> </span>
<a href="#l10.1335"></a><span id="l10.1335">   nsString attrValue;</span>
<a href="#l10.1336"></a><span id="l10.1336">   nsresult rv = GetPropertyAsAString(aItem.mColumn, attrValue);</span>
<a href="#l10.1337"></a><span id="l10.1337"> </span>
<a href="#l10.1338"></a><span id="l10.1338" class="difflineminus">-  if (NS_FAILED(rv) || attrValue.IsEmpty())</span>
<a href="#l10.1339"></a><span id="l10.1339" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.1340"></a><span id="l10.1340" class="difflineplus">+  if (NS_FAILED(rv) || attrValue.IsEmpty()) return NS_OK;</span>
<a href="#l10.1341"></a><span id="l10.1341"> </span>
<a href="#l10.1342"></a><span id="l10.1342">   aResult.Append(char16_t('&lt;'));</span>
<a href="#l10.1343"></a><span id="l10.1343">   aResult.Append(NS_ConvertUTF8toUTF16(aItem.mColumn));</span>
<a href="#l10.1344"></a><span id="l10.1344">   aResult.Append(char16_t('&gt;'));</span>
<a href="#l10.1345"></a><span id="l10.1345"> </span>
<a href="#l10.1346"></a><span id="l10.1346">   // use ScanTXT to convert &lt; &gt; &amp; to safe values.</span>
<a href="#l10.1347"></a><span id="l10.1347">   nsString safeText;</span>
<a href="#l10.1348"></a><span id="l10.1348">   rv = aConv-&gt;ScanTXT(attrValue, mozITXTToHTMLConv::kEntities, safeText);</span>
<a href="#l10.1349"></a><span id="l10.1349" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1350"></a><span id="l10.1350" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1351"></a><span id="l10.1351">   aResult.Append(safeText);</span>
<a href="#l10.1352"></a><span id="l10.1352"> </span>
<a href="#l10.1353"></a><span id="l10.1353">   aResult.AppendLiteral(&quot;&lt;/&quot;);</span>
<a href="#l10.1354"></a><span id="l10.1354">   aResult.Append(NS_ConvertUTF8toUTF16(aItem.mColumn));</span>
<a href="#l10.1355"></a><span id="l10.1355">   aResult.Append(char16_t('&gt;'));</span>
<a href="#l10.1356"></a><span id="l10.1356"> </span>
<a href="#l10.1357"></a><span id="l10.1357">   return NS_OK;</span>
<a href="#l10.1358"></a><span id="l10.1358"> }</span>
<a href="#l10.1359"></a><span id="l10.1359"> </span>
<a href="#l10.1360"></a><span id="l10.1360"> nsresult nsAbCardProperty::AppendLabel(const AppendItem &amp;aItem,</span>
<a href="#l10.1361"></a><span id="l10.1361">                                        nsIStringBundle *aBundle,</span>
<a href="#l10.1362"></a><span id="l10.1362">                                        mozITXTToHTMLConv *aConv,</span>
<a href="#l10.1363"></a><span id="l10.1363" class="difflineminus">-                                       nsString &amp;aResult)</span>
<a href="#l10.1364"></a><span id="l10.1364" class="difflineminus">-{</span>
<a href="#l10.1365"></a><span id="l10.1365" class="difflineplus">+                                       nsString &amp;aResult) {</span>
<a href="#l10.1366"></a><span id="l10.1366">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l10.1367"></a><span id="l10.1367"> </span>
<a href="#l10.1368"></a><span id="l10.1368">   nsresult rv;</span>
<a href="#l10.1369"></a><span id="l10.1369">   nsString label, attrValue;</span>
<a href="#l10.1370"></a><span id="l10.1370"> </span>
<a href="#l10.1371"></a><span id="l10.1371">   rv = GetPropertyAsAString(aItem.mColumn, attrValue);</span>
<a href="#l10.1372"></a><span id="l10.1372"> </span>
<a href="#l10.1373"></a><span id="l10.1373" class="difflineminus">-  if (NS_FAILED(rv) || attrValue.IsEmpty())</span>
<a href="#l10.1374"></a><span id="l10.1374" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.1375"></a><span id="l10.1375" class="difflineplus">+  if (NS_FAILED(rv) || attrValue.IsEmpty()) return NS_OK;</span>
<a href="#l10.1376"></a><span id="l10.1376"> </span>
<a href="#l10.1377"></a><span id="l10.1377">   rv = aBundle-&gt;GetStringFromName(aItem.mLabel, label);</span>
<a href="#l10.1378"></a><span id="l10.1378">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1379"></a><span id="l10.1379"> </span>
<a href="#l10.1380"></a><span id="l10.1380">   aResult.AppendLiteral(&quot;&lt;labelrow&gt;&lt;label&gt;&quot;);</span>
<a href="#l10.1381"></a><span id="l10.1381"> </span>
<a href="#l10.1382"></a><span id="l10.1382">   aResult.Append(label);</span>
<a href="#l10.1383"></a><span id="l10.1383">   aResult.AppendLiteral(&quot;: &lt;/label&gt;&quot;);</span>
<a href="#l10.1384"></a><span id="l10.1384"> </span>
<a href="#l10.1385"></a><span id="l10.1385">   rv = AppendLine(aItem, aConv, aResult);</span>
<a href="#l10.1386"></a><span id="l10.1386" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1387"></a><span id="l10.1387" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1388"></a><span id="l10.1388"> </span>
<a href="#l10.1389"></a><span id="l10.1389">   aResult.AppendLiteral(&quot;&lt;/labelrow&gt;&quot;);</span>
<a href="#l10.1390"></a><span id="l10.1390"> </span>
<a href="#l10.1391"></a><span id="l10.1391">   return NS_OK;</span>
<a href="#l10.1392"></a><span id="l10.1392"> }</span>
<a href="#l10.1393"></a><span id="l10.1393"> </span>
<a href="#l10.1394"></a><span id="l10.1394"> nsresult nsAbCardProperty::AppendCityStateZip(const AppendItem &amp;aItem,</span>
<a href="#l10.1395"></a><span id="l10.1395">                                               nsIStringBundle *aBundle,</span>
<a href="#l10.1396"></a><span id="l10.1396">                                               mozITXTToHTMLConv *aConv,</span>
<a href="#l10.1397"></a><span id="l10.1397" class="difflineminus">-                                              nsString &amp;aResult)</span>
<a href="#l10.1398"></a><span id="l10.1398" class="difflineminus">-{</span>
<a href="#l10.1399"></a><span id="l10.1399" class="difflineplus">+                                              nsString &amp;aResult) {</span>
<a href="#l10.1400"></a><span id="l10.1400">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l10.1401"></a><span id="l10.1401"> </span>
<a href="#l10.1402"></a><span id="l10.1402">   nsresult rv;</span>
<a href="#l10.1403"></a><span id="l10.1403">   AppendItem item;</span>
<a href="#l10.1404"></a><span id="l10.1404">   const char *statePropName, *zipPropName;</span>
<a href="#l10.1405"></a><span id="l10.1405"> </span>
<a href="#l10.1406"></a><span id="l10.1406">   if (strcmp(aItem.mColumn, kHomeCityProperty) == 0) {</span>
<a href="#l10.1407"></a><span id="l10.1407">     statePropName = kHomeStateProperty;</span>
<a href="#l10.1408"></a><span id="l10.1408">     zipPropName = kHomeZipCodeProperty;</span>
<a href="#l10.1409"></a><span id="l10.1409" class="difflineminus">-  }</span>
<a href="#l10.1410"></a><span id="l10.1410" class="difflineminus">-  else {</span>
<a href="#l10.1411"></a><span id="l10.1411" class="difflineplus">+  } else {</span>
<a href="#l10.1412"></a><span id="l10.1412">     statePropName = kWorkStateProperty;</span>
<a href="#l10.1413"></a><span id="l10.1413">     zipPropName = kWorkZipCodeProperty;</span>
<a href="#l10.1414"></a><span id="l10.1414">   }</span>
<a href="#l10.1415"></a><span id="l10.1415"> </span>
<a href="#l10.1416"></a><span id="l10.1416">   nsAutoString cityResult, stateResult, zipResult;</span>
<a href="#l10.1417"></a><span id="l10.1417"> </span>
<a href="#l10.1418"></a><span id="l10.1418">   rv = AppendLine(aItem, aConv, cityResult);</span>
<a href="#l10.1419"></a><span id="l10.1419" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1420"></a><span id="l10.1420" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1421"></a><span id="l10.1421"> </span>
<a href="#l10.1422"></a><span id="l10.1422">   item.mColumn = statePropName;</span>
<a href="#l10.1423"></a><span id="l10.1423">   item.mLabel = &quot;&quot;;</span>
<a href="#l10.1424"></a><span id="l10.1424">   item.mAppendType = eAppendUndefined;</span>
<a href="#l10.1425"></a><span id="l10.1425"> </span>
<a href="#l10.1426"></a><span id="l10.1426">   rv = AppendLine(item, aConv, stateResult);</span>
<a href="#l10.1427"></a><span id="l10.1427" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1428"></a><span id="l10.1428" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1429"></a><span id="l10.1429"> </span>
<a href="#l10.1430"></a><span id="l10.1430">   item.mColumn = zipPropName;</span>
<a href="#l10.1431"></a><span id="l10.1431"> </span>
<a href="#l10.1432"></a><span id="l10.1432">   rv = AppendLine(item, aConv, zipResult);</span>
<a href="#l10.1433"></a><span id="l10.1433" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1434"></a><span id="l10.1434" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1435"></a><span id="l10.1435"> </span>
<a href="#l10.1436"></a><span id="l10.1436">   nsString formattedString;</span>
<a href="#l10.1437"></a><span id="l10.1437"> </span>
<a href="#l10.1438"></a><span id="l10.1438">   if (!cityResult.IsEmpty() &amp;&amp; !stateResult.IsEmpty() &amp;&amp; !zipResult.IsEmpty()) {</span>
<a href="#l10.1439"></a><span id="l10.1439" class="difflineminus">-    const char16_t *formatStrings[] = { cityResult.get(), stateResult.get(), zipResult.get() };</span>
<a href="#l10.1440"></a><span id="l10.1440" class="difflineminus">-    rv = aBundle-&gt;FormatStringFromName(&quot;cityAndStateAndZip&quot;, formatStrings, ArrayLength(formatStrings), formattedString);</span>
<a href="#l10.1441"></a><span id="l10.1441" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1442"></a><span id="l10.1442" class="difflineminus">-  }</span>
<a href="#l10.1443"></a><span id="l10.1443" class="difflineminus">-  else if (!cityResult.IsEmpty() &amp;&amp; !stateResult.IsEmpty() &amp;&amp; zipResult.IsEmpty()) {</span>
<a href="#l10.1444"></a><span id="l10.1444" class="difflineminus">-    const char16_t *formatStrings[] = { cityResult.get(), stateResult.get() };</span>
<a href="#l10.1445"></a><span id="l10.1445" class="difflineminus">-    rv = aBundle-&gt;FormatStringFromName(&quot;cityAndStateNoZip&quot;, formatStrings, ArrayLength(formatStrings), formattedString);</span>
<a href="#l10.1446"></a><span id="l10.1446" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1447"></a><span id="l10.1447" class="difflineminus">-  }</span>
<a href="#l10.1448"></a><span id="l10.1448" class="difflineminus">-  else if ((!cityResult.IsEmpty() &amp;&amp; stateResult.IsEmpty() &amp;&amp; !zipResult.IsEmpty()) ||</span>
<a href="#l10.1449"></a><span id="l10.1449" class="difflineminus">-          (cityResult.IsEmpty() &amp;&amp; !stateResult.IsEmpty() &amp;&amp; !zipResult.IsEmpty())) {</span>
<a href="#l10.1450"></a><span id="l10.1450" class="difflineminus">-    const char16_t *formatStrings[] = { cityResult.IsEmpty() ? stateResult.get() : cityResult.get(), zipResult.get() };</span>
<a href="#l10.1451"></a><span id="l10.1451" class="difflineminus">-    rv = aBundle-&gt;FormatStringFromName(&quot;cityOrStateAndZip&quot;, formatStrings, ArrayLength(formatStrings), formattedString);</span>
<a href="#l10.1452"></a><span id="l10.1452" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1453"></a><span id="l10.1453" class="difflineminus">-  }</span>
<a href="#l10.1454"></a><span id="l10.1454" class="difflineminus">-  else {</span>
<a href="#l10.1455"></a><span id="l10.1455" class="difflineplus">+    const char16_t *formatStrings[] = {cityResult.get(), stateResult.get(),</span>
<a href="#l10.1456"></a><span id="l10.1456" class="difflineplus">+                                       zipResult.get()};</span>
<a href="#l10.1457"></a><span id="l10.1457" class="difflineplus">+    rv = aBundle-&gt;FormatStringFromName(&quot;cityAndStateAndZip&quot;, formatStrings,</span>
<a href="#l10.1458"></a><span id="l10.1458" class="difflineplus">+                                       ArrayLength(formatStrings),</span>
<a href="#l10.1459"></a><span id="l10.1459" class="difflineplus">+                                       formattedString);</span>
<a href="#l10.1460"></a><span id="l10.1460" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1461"></a><span id="l10.1461" class="difflineplus">+  } else if (!cityResult.IsEmpty() &amp;&amp; !stateResult.IsEmpty() &amp;&amp;</span>
<a href="#l10.1462"></a><span id="l10.1462" class="difflineplus">+             zipResult.IsEmpty()) {</span>
<a href="#l10.1463"></a><span id="l10.1463" class="difflineplus">+    const char16_t *formatStrings[] = {cityResult.get(), stateResult.get()};</span>
<a href="#l10.1464"></a><span id="l10.1464" class="difflineplus">+    rv = aBundle-&gt;FormatStringFromName(&quot;cityAndStateNoZip&quot;, formatStrings,</span>
<a href="#l10.1465"></a><span id="l10.1465" class="difflineplus">+                                       ArrayLength(formatStrings),</span>
<a href="#l10.1466"></a><span id="l10.1466" class="difflineplus">+                                       formattedString);</span>
<a href="#l10.1467"></a><span id="l10.1467" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1468"></a><span id="l10.1468" class="difflineplus">+  } else if ((!cityResult.IsEmpty() &amp;&amp; stateResult.IsEmpty() &amp;&amp;</span>
<a href="#l10.1469"></a><span id="l10.1469" class="difflineplus">+              !zipResult.IsEmpty()) ||</span>
<a href="#l10.1470"></a><span id="l10.1470" class="difflineplus">+             (cityResult.IsEmpty() &amp;&amp; !stateResult.IsEmpty() &amp;&amp;</span>
<a href="#l10.1471"></a><span id="l10.1471" class="difflineplus">+              !zipResult.IsEmpty())) {</span>
<a href="#l10.1472"></a><span id="l10.1472" class="difflineplus">+    const char16_t *formatStrings[] = {</span>
<a href="#l10.1473"></a><span id="l10.1473" class="difflineplus">+        cityResult.IsEmpty() ? stateResult.get() : cityResult.get(),</span>
<a href="#l10.1474"></a><span id="l10.1474" class="difflineplus">+        zipResult.get()};</span>
<a href="#l10.1475"></a><span id="l10.1475" class="difflineplus">+    rv = aBundle-&gt;FormatStringFromName(&quot;cityOrStateAndZip&quot;, formatStrings,</span>
<a href="#l10.1476"></a><span id="l10.1476" class="difflineplus">+                                       ArrayLength(formatStrings),</span>
<a href="#l10.1477"></a><span id="l10.1477" class="difflineplus">+                                       formattedString);</span>
<a href="#l10.1478"></a><span id="l10.1478" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1479"></a><span id="l10.1479" class="difflineplus">+  } else {</span>
<a href="#l10.1480"></a><span id="l10.1480">     if (!cityResult.IsEmpty())</span>
<a href="#l10.1481"></a><span id="l10.1481">       formattedString = cityResult;</span>
<a href="#l10.1482"></a><span id="l10.1482">     else if (!stateResult.IsEmpty())</span>
<a href="#l10.1483"></a><span id="l10.1483">       formattedString = stateResult;</span>
<a href="#l10.1484"></a><span id="l10.1484">     else</span>
<a href="#l10.1485"></a><span id="l10.1485">       formattedString = zipResult;</span>
<a href="#l10.1486"></a><span id="l10.1486">   }</span>
<a href="#l10.1487"></a><span id="l10.1487"> </span>
<a href="#l10.1488"></a><span id="l10.1488">   aResult.Append(formattedString);</span>
<a href="#l10.1489"></a><span id="l10.1489"> </span>
<a href="#l10.1490"></a><span id="l10.1490">   return NS_OK;</span>
<a href="#l10.1491"></a><span id="l10.1491"> }</span>
<a href="#l10.1492"></a><span id="l10.1492"> </span>
<a href="#l10.1493"></a><span id="l10.1493"> NS_IMETHODIMP nsAbCardProperty::GenerateName(int32_t aGenerateFormat,</span>
<a href="#l10.1494"></a><span id="l10.1494" class="difflineminus">-                                             nsIStringBundle* aBundle,</span>
<a href="#l10.1495"></a><span id="l10.1495" class="difflineminus">-                                             nsAString &amp;aResult)</span>
<a href="#l10.1496"></a><span id="l10.1496" class="difflineminus">-{</span>
<a href="#l10.1497"></a><span id="l10.1497" class="difflineplus">+                                             nsIStringBundle *aBundle,</span>
<a href="#l10.1498"></a><span id="l10.1498" class="difflineplus">+                                             nsAString &amp;aResult) {</span>
<a href="#l10.1499"></a><span id="l10.1499">   aResult.Truncate();</span>
<a href="#l10.1500"></a><span id="l10.1500"> </span>
<a href="#l10.1501"></a><span id="l10.1501">   // Cache the first and last names</span>
<a href="#l10.1502"></a><span id="l10.1502">   nsAutoString firstName, lastName;</span>
<a href="#l10.1503"></a><span id="l10.1503">   GetFirstName(firstName);</span>
<a href="#l10.1504"></a><span id="l10.1504">   GetLastName(lastName);</span>
<a href="#l10.1505"></a><span id="l10.1505"> </span>
<a href="#l10.1506"></a><span id="l10.1506">   // No need to check for aBundle present straight away, only do that if we're</span>
<a href="#l10.1507"></a><span id="l10.1507" class="difflineat">@@ -1148,98 +1095,89 @@ NS_IMETHODIMP nsAbCardProperty::Generate</span>
<a href="#l10.1508"></a><span id="l10.1508">     aResult = firstName;</span>
<a href="#l10.1509"></a><span id="l10.1509">   else if (firstName.IsEmpty())</span>
<a href="#l10.1510"></a><span id="l10.1510">     aResult = lastName;</span>
<a href="#l10.1511"></a><span id="l10.1511">   else {</span>
<a href="#l10.1512"></a><span id="l10.1512">     nsresult rv;</span>
<a href="#l10.1513"></a><span id="l10.1513">     nsCOMPtr&lt;nsIStringBundle&gt; bundle(aBundle);</span>
<a href="#l10.1514"></a><span id="l10.1514">     if (!bundle) {</span>
<a href="#l10.1515"></a><span id="l10.1515">       nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l10.1516"></a><span id="l10.1516" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l10.1517"></a><span id="l10.1517" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l10.1518"></a><span id="l10.1518">       NS_ENSURE_TRUE(stringBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l10.1519"></a><span id="l10.1519"> </span>
<a href="#l10.1520"></a><span id="l10.1520">       rv = stringBundleService-&gt;CreateBundle(sAddrbookProperties,</span>
<a href="#l10.1521"></a><span id="l10.1521">                                              getter_AddRefs(bundle));</span>
<a href="#l10.1522"></a><span id="l10.1522">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1523"></a><span id="l10.1523">     }</span>
<a href="#l10.1524"></a><span id="l10.1524"> </span>
<a href="#l10.1525"></a><span id="l10.1525">     nsString result;</span>
<a href="#l10.1526"></a><span id="l10.1526"> </span>
<a href="#l10.1527"></a><span id="l10.1527">     if (aGenerateFormat == GENERATE_LAST_FIRST_ORDER) {</span>
<a href="#l10.1528"></a><span id="l10.1528">       const char16_t *stringParams[2] = {lastName.get(), firstName.get()};</span>
<a href="#l10.1529"></a><span id="l10.1529"> </span>
<a href="#l10.1530"></a><span id="l10.1530" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(&quot;lastFirstFormat&quot;,</span>
<a href="#l10.1531"></a><span id="l10.1531" class="difflineminus">-                                        stringParams, 2, result);</span>
<a href="#l10.1532"></a><span id="l10.1532" class="difflineminus">-    }</span>
<a href="#l10.1533"></a><span id="l10.1533" class="difflineminus">-    else {</span>
<a href="#l10.1534"></a><span id="l10.1534" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(&quot;lastFirstFormat&quot;, stringParams, 2,</span>
<a href="#l10.1535"></a><span id="l10.1535" class="difflineplus">+                                        result);</span>
<a href="#l10.1536"></a><span id="l10.1536" class="difflineplus">+    } else {</span>
<a href="#l10.1537"></a><span id="l10.1537">       const char16_t *stringParams[2] = {firstName.get(), lastName.get()};</span>
<a href="#l10.1538"></a><span id="l10.1538"> </span>
<a href="#l10.1539"></a><span id="l10.1539" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(&quot;firstLastFormat&quot;,</span>
<a href="#l10.1540"></a><span id="l10.1540" class="difflineminus">-                                        stringParams, 2, result);</span>
<a href="#l10.1541"></a><span id="l10.1541" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(&quot;firstLastFormat&quot;, stringParams, 2,</span>
<a href="#l10.1542"></a><span id="l10.1542" class="difflineplus">+                                        result);</span>
<a href="#l10.1543"></a><span id="l10.1543">     }</span>
<a href="#l10.1544"></a><span id="l10.1544">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1545"></a><span id="l10.1545"> </span>
<a href="#l10.1546"></a><span id="l10.1546">     aResult.Assign(result);</span>
<a href="#l10.1547"></a><span id="l10.1547">   }</span>
<a href="#l10.1548"></a><span id="l10.1548"> </span>
<a href="#l10.1549"></a><span id="l10.1549" class="difflineminus">-  if (aResult.IsEmpty())</span>
<a href="#l10.1550"></a><span id="l10.1550" class="difflineminus">-  {</span>
<a href="#l10.1551"></a><span id="l10.1551" class="difflineplus">+  if (aResult.IsEmpty()) {</span>
<a href="#l10.1552"></a><span id="l10.1552">     // The normal names have failed, does this card have a company name? If so,</span>
<a href="#l10.1553"></a><span id="l10.1553">     // use that instead, because that is likely to be more meaningful than an</span>
<a href="#l10.1554"></a><span id="l10.1554">     // email address.</span>
<a href="#l10.1555"></a><span id="l10.1555">     //</span>
<a href="#l10.1556"></a><span id="l10.1556">     // If this errors, the string isn't found and we'll fall into the next</span>
<a href="#l10.1557"></a><span id="l10.1557">     // check.</span>
<a href="#l10.1558"></a><span id="l10.1558" class="difflineminus">-    (void) GetPropertyAsAString(kCompanyProperty, aResult);</span>
<a href="#l10.1559"></a><span id="l10.1559" class="difflineplus">+    (void)GetPropertyAsAString(kCompanyProperty, aResult);</span>
<a href="#l10.1560"></a><span id="l10.1560">   }</span>
<a href="#l10.1561"></a><span id="l10.1561"> </span>
<a href="#l10.1562"></a><span id="l10.1562" class="difflineminus">-  if (aResult.IsEmpty())</span>
<a href="#l10.1563"></a><span id="l10.1563" class="difflineminus">-  {</span>
<a href="#l10.1564"></a><span id="l10.1564" class="difflineplus">+  if (aResult.IsEmpty()) {</span>
<a href="#l10.1565"></a><span id="l10.1565">     // see bug #211078</span>
<a href="#l10.1566"></a><span id="l10.1566">     // if there is no generated name at this point</span>
<a href="#l10.1567"></a><span id="l10.1567">     // use the userid from the email address</span>
<a href="#l10.1568"></a><span id="l10.1568">     // it is better than nothing.</span>
<a href="#l10.1569"></a><span id="l10.1569">     GetPrimaryEmail(aResult);</span>
<a href="#l10.1570"></a><span id="l10.1570">     int32_t index = aResult.FindChar('@');</span>
<a href="#l10.1571"></a><span id="l10.1571" class="difflineminus">-    if (index != -1)</span>
<a href="#l10.1572"></a><span id="l10.1572" class="difflineminus">-      aResult.SetLength(index);</span>
<a href="#l10.1573"></a><span id="l10.1573" class="difflineplus">+    if (index != -1) aResult.SetLength(index);</span>
<a href="#l10.1574"></a><span id="l10.1574">   }</span>
<a href="#l10.1575"></a><span id="l10.1575"> </span>
<a href="#l10.1576"></a><span id="l10.1576">   return NS_OK;</span>
<a href="#l10.1577"></a><span id="l10.1577"> }</span>
<a href="#l10.1578"></a><span id="l10.1578"> </span>
<a href="#l10.1579"></a><span id="l10.1579"> NS_IMETHODIMP nsAbCardProperty::GeneratePhoneticName(bool aLastNameFirst,</span>
<a href="#l10.1580"></a><span id="l10.1580" class="difflineminus">-                                                     nsAString &amp;aResult)</span>
<a href="#l10.1581"></a><span id="l10.1581" class="difflineminus">-{</span>
<a href="#l10.1582"></a><span id="l10.1582" class="difflineplus">+                                                     nsAString &amp;aResult) {</span>
<a href="#l10.1583"></a><span id="l10.1583">   nsAutoString firstName, lastName;</span>
<a href="#l10.1584"></a><span id="l10.1584">   GetPropertyAsAString(kPhoneticFirstNameProperty, firstName);</span>
<a href="#l10.1585"></a><span id="l10.1585">   GetPropertyAsAString(kPhoneticLastNameProperty, lastName);</span>
<a href="#l10.1586"></a><span id="l10.1586"> </span>
<a href="#l10.1587"></a><span id="l10.1587" class="difflineminus">-  if (aLastNameFirst)</span>
<a href="#l10.1588"></a><span id="l10.1588" class="difflineminus">-  {</span>
<a href="#l10.1589"></a><span id="l10.1589" class="difflineplus">+  if (aLastNameFirst) {</span>
<a href="#l10.1590"></a><span id="l10.1590">     aResult = lastName;</span>
<a href="#l10.1591"></a><span id="l10.1591">     aResult += firstName;</span>
<a href="#l10.1592"></a><span id="l10.1592" class="difflineminus">-  }</span>
<a href="#l10.1593"></a><span id="l10.1593" class="difflineminus">-  else</span>
<a href="#l10.1594"></a><span id="l10.1594" class="difflineminus">-  {</span>
<a href="#l10.1595"></a><span id="l10.1595" class="difflineplus">+  } else {</span>
<a href="#l10.1596"></a><span id="l10.1596">     aResult = firstName;</span>
<a href="#l10.1597"></a><span id="l10.1597">     aResult += lastName;</span>
<a href="#l10.1598"></a><span id="l10.1598">   }</span>
<a href="#l10.1599"></a><span id="l10.1599"> </span>
<a href="#l10.1600"></a><span id="l10.1600">   return NS_OK;</span>
<a href="#l10.1601"></a><span id="l10.1601"> }</span>
<a href="#l10.1602"></a><span id="l10.1602"> </span>
<a href="#l10.1603"></a><span id="l10.1603" class="difflineminus">-NS_IMETHODIMP nsAbCardProperty::GenerateChatName(nsAString &amp;aResult)</span>
<a href="#l10.1604"></a><span id="l10.1604" class="difflineminus">-{</span>
<a href="#l10.1605"></a><span id="l10.1605" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GenerateChatName(nsAString &amp;aResult) {</span>
<a href="#l10.1606"></a><span id="l10.1606">   aResult.Truncate();</span>
<a href="#l10.1607"></a><span id="l10.1607"> </span>
<a href="#l10.1608"></a><span id="l10.1608"> #define CHECK_CHAT_PROPERTY(aProtocol)                                       \</span>
<a href="#l10.1609"></a><span id="l10.1609">   if (NS_SUCCEEDED(GetPropertyAsAString(k##aProtocol##Property, aResult)) &amp;&amp; \</span>
<a href="#l10.1610"></a><span id="l10.1610">       !aResult.IsEmpty())                                                    \</span>
<a href="#l10.1611"></a><span id="l10.1611" class="difflineminus">-    return NS_OK</span>
<a href="#l10.1612"></a><span id="l10.1612" class="difflineplus">+  return NS_OK</span>
<a href="#l10.1613"></a><span id="l10.1613">   CHECK_CHAT_PROPERTY(Gtalk);</span>
<a href="#l10.1614"></a><span id="l10.1614">   CHECK_CHAT_PROPERTY(AIM);</span>
<a href="#l10.1615"></a><span id="l10.1615">   CHECK_CHAT_PROPERTY(Yahoo);</span>
<a href="#l10.1616"></a><span id="l10.1616">   CHECK_CHAT_PROPERTY(Skype);</span>
<a href="#l10.1617"></a><span id="l10.1617">   CHECK_CHAT_PROPERTY(QQ);</span>
<a href="#l10.1618"></a><span id="l10.1618">   CHECK_CHAT_PROPERTY(MSN);</span>
<a href="#l10.1619"></a><span id="l10.1619">   CHECK_CHAT_PROPERTY(ICQ);</span>
<a href="#l10.1620"></a><span id="l10.1620">   CHECK_CHAT_PROPERTY(XMPP);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -18,42 +18,47 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIVariant.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> class nsIStringBundle;</span>
<a href="#l11.9"></a><span id="l11.9"> class mozITXTToHTMLConv;</span>
<a href="#l11.10"></a><span id="l11.10"> struct AppendItem;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">- /*</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  * Address Book Card Property</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  */</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+/*</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * Address Book Card Property</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ */</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-class nsAbCardProperty: public nsIAbCard</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-{</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-public:</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+class nsAbCardProperty : public nsIAbCard {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ public:</span>
<a href="#l11.24"></a><span id="l11.24">   NS_DECL_ISUPPORTS</span>
<a href="#l11.25"></a><span id="l11.25">   NS_DECL_NSIABCARD</span>
<a href="#l11.26"></a><span id="l11.26">   NS_DECL_NSIABITEM</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   nsAbCardProperty();</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-protected:</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ protected:</span>
<a href="#l11.32"></a><span id="l11.32">   virtual ~nsAbCardProperty();</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  bool     m_IsMailList;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  bool m_IsMailList;</span>
<a href="#l11.35"></a><span id="l11.35">   nsCString m_MailListURI;</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37">   // Store most of the properties here</span>
<a href="#l11.38"></a><span id="l11.38">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIVariant&gt; m_properties;</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40">   nsCString m_directoryId, m_localId;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-private:</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  nsresult AppendSection(const AppendItem *aArray, int16_t aCount, const nsString&amp; aHeading, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  nsresult AppendLine(const AppendItem &amp;aItem, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  nsresult AppendLabel(const AppendItem &amp;aItem, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-  nsresult AppendCityStateZip(const AppendItem &amp;aItem, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+ private:</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+  nsresult AppendSection(const AppendItem *aArray, int16_t aCount,</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+                         const nsString &amp;aHeading, nsIStringBundle *aBundle,</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+                         mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  nsresult AppendLine(const AppendItem &amp;aItem, mozITXTToHTMLConv *aConv,</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+                      nsString &amp;aResult);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  nsresult AppendLabel(const AppendItem &amp;aItem, nsIStringBundle *aBundle,</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+                       mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  nsresult AppendCityStateZip(const AppendItem &amp;aItem, nsIStringBundle *aBundle,</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+                              mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">   nsresult ConvertToBase64EncodedXML(nsACString &amp;result);</span>
<a href="#l11.59"></a><span id="l11.59">   nsresult ConvertToXMLPrintData(nsAString &amp;result);</span>
<a href="#l11.60"></a><span id="l11.60">   nsresult ConvertToEscapedVCard(nsACString &amp;result);</span>
<a href="#l11.61"></a><span id="l11.61"> };</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbContentHandler.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbContentHandler.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -19,169 +19,162 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMsgVCardService.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsVCard.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> //</span>
<a href="#l12.10"></a><span id="l12.10"> // nsAbContentHandler</span>
<a href="#l12.11"></a><span id="l12.11"> //</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-nsAbContentHandler::nsAbContentHandler()</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-}</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+nsAbContentHandler::nsAbContentHandler() {}</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-nsAbContentHandler::~nsAbContentHandler()</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-{</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-}</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+nsAbContentHandler::~nsAbContentHandler() {}</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> NS_IMPL_ISUPPORTS(nsAbContentHandler, nsIContentHandler,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  nsIStreamLoaderObserver)</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+                  nsIStreamLoaderObserver)</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26"> NS_IMETHODIMP</span>
<a href="#l12.27"></a><span id="l12.27"> nsAbContentHandler::HandleContent(const char *aContentType,</span>
<a href="#l12.28"></a><span id="l12.28">                                   nsIInterfaceRequestor *aWindowContext,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                                  nsIRequest *request)</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-{</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+                                  nsIRequest *request) {</span>
<a href="#l12.32"></a><span id="l12.32">   NS_ENSURE_ARG_POINTER(request);</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34">   nsresult rv = NS_OK;</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  // First of all, get the content type and make sure it is a content type we know how to handle!</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+  // First of all, get the content type and make sure it is a content type we</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  // know how to handle!</span>
<a href="#l12.39"></a><span id="l12.39">   if (PL_strcasecmp(aContentType, &quot;application/x-addvcard&quot;) == 0) {</span>
<a href="#l12.40"></a><span id="l12.40">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l12.41"></a><span id="l12.41">     nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l12.42"></a><span id="l12.42">     if (!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44">     rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-    if (uri)</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-    {</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-        nsAutoCString path;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-        rv = uri-&gt;GetPathQueryRef(path);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    if (uri) {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+      nsAutoCString path;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+      rv = uri-&gt;GetPathQueryRef(path);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-        const char *startOfVCard = strstr(path.get(), &quot;add?vcard=&quot;);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-        if (startOfVCard)</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-        {</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-            nsCString unescapedData;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+      const char *startOfVCard = strstr(path.get(), &quot;add?vcard=&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+      if (startOfVCard) {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+        nsCString unescapedData;</span>
<a href="#l12.62"></a><span id="l12.62"> </span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-            // XXX todo, explain why we is escaped twice</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-            MsgUnescapeString(nsDependentCString(startOfVCard + strlen(&quot;add?vcard=&quot;)),</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-                                                 0, unescapedData);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+        // XXX todo, explain why we is escaped twice</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+        MsgUnescapeString(</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+            nsDependentCString(startOfVCard + strlen(&quot;add?vcard=&quot;)), 0,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+            unescapedData);</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-            if (!aWindowContext)</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-                return NS_ERROR_FAILURE;</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+        if (!aWindowContext) return NS_ERROR_FAILURE;</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-            nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow = do_GetInterface(aWindowContext);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-            NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-            nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+        nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow =</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+            do_GetInterface(aWindowContext);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+        NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+        nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow =</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+            nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-            nsCOMPtr&lt;nsIAbManager&gt; ab =</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-              do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+        nsCOMPtr&lt;nsIAbManager&gt; ab = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-            nsCOMPtr &lt;nsIAbCard&gt; cardFromVCard;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-            rv = ab-&gt;EscapedVCardToAbCard(unescapedData.get(),</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-                                          getter_AddRefs(cardFromVCard));</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; cardFromVCard;</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+        rv = ab-&gt;EscapedVCardToAbCard(unescapedData.get(),</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+                                      getter_AddRefs(cardFromVCard));</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-            nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr =</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-                do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+        nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr =</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+            do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-            ifptr-&gt;SetData(cardFromVCard);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-            ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIAbCard));</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+        ifptr-&gt;SetData(cardFromVCard);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+        ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIAbCard));</span>
<a href="#l12.110"></a><span id="l12.110"> </span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-            // Find a privileged chrome window to open the dialog from.</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-            nsCOMPtr&lt;nsIDocShell&gt; docShell(parentWindow-&gt;GetDocShell());</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-            nsCOMPtr&lt;nsIDocShellTreeItem&gt; root;</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-            docShell-&gt;GetRootTreeItem(getter_AddRefs(root));</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-            nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window(do_GetInterface(root));</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+        // Find a privileged chrome window to open the dialog from.</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+        nsCOMPtr&lt;nsIDocShell&gt; docShell(parentWindow-&gt;GetDocShell());</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+        nsCOMPtr&lt;nsIDocShellTreeItem&gt; root;</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+        docShell-&gt;GetRootTreeItem(getter_AddRefs(root));</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+        nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window(do_GetInterface(root));</span>
<a href="#l12.121"></a><span id="l12.121"> </span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-            nsCOMPtr&lt;nsPIDOMWindowOuter&gt; dialogWindow;</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-            rv = window-&gt;OpenDialog(</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-                NS_LITERAL_STRING(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;),</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-                EmptyString(),</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-                NS_LITERAL_STRING(&quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;),</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-                ifptr, getter_AddRefs(dialogWindow));</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-        }</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-        rv = NS_OK;</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+        nsCOMPtr&lt;nsPIDOMWindowOuter&gt; dialogWindow;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+        rv = window-&gt;OpenDialog(</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+            NS_LITERAL_STRING(</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+                &quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;),</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+            EmptyString(),</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+            NS_LITERAL_STRING(</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+                &quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;),</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+            ifptr, getter_AddRefs(dialogWindow));</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+      }</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+      rv = NS_OK;</span>
<a href="#l12.142"></a><span id="l12.142">     }</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-  }</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-  else if (PL_strcasecmp(aContentType, &quot;text/x-vcard&quot;) == 0) {</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+  } else if (PL_strcasecmp(aContentType, &quot;text/x-vcard&quot;) == 0) {</span>
<a href="#l12.146"></a><span id="l12.146">     // create a vcard stream listener that can parse the data stream</span>
<a href="#l12.147"></a><span id="l12.147">     // and bring up the appropriate UI</span>
<a href="#l12.148"></a><span id="l12.148"> </span>
<a href="#l12.149"></a><span id="l12.149">     // (1) cancel the current load operation. We'll restart it</span>
<a href="#l12.150"></a><span id="l12.150">     request-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l12.151"></a><span id="l12.151">     // get the url we were trying to open</span>
<a href="#l12.152"></a><span id="l12.152">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l12.153"></a><span id="l12.153">     nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request);</span>
<a href="#l12.154"></a><span id="l12.154">     NS_ENSURE_TRUE(channel, NS_ERROR_FAILURE);</span>
<a href="#l12.155"></a><span id="l12.155"> </span>
<a href="#l12.156"></a><span id="l12.156">     rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l12.157"></a><span id="l12.157">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159">     nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-      do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+        do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l12.162"></a><span id="l12.162">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.163"></a><span id="l12.163"> </span>
<a href="#l12.164"></a><span id="l12.164">     // create a stream loader to handle the v-card data</span>
<a href="#l12.165"></a><span id="l12.165">     nsCOMPtr&lt;nsIStreamLoader&gt; streamLoader;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-    rv = NS_NewStreamLoader(getter_AddRefs(streamLoader),</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-                            uri,</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-                            this,</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+    rv = NS_NewStreamLoader(getter_AddRefs(streamLoader), uri, this,</span>
<a href="#l12.170"></a><span id="l12.170">                             nullPrincipal,</span>
<a href="#l12.171"></a><span id="l12.171">                             nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l12.172"></a><span id="l12.172">                             nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l12.173"></a><span id="l12.173">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.174"></a><span id="l12.174"> </span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-  }</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-  else // The content-type was not application/x-addvcard...</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+  } else  // The content-type was not application/x-addvcard...</span>
<a href="#l12.178"></a><span id="l12.178">     return NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180">   return rv;</span>
<a href="#l12.181"></a><span id="l12.181"> }</span>
<a href="#l12.182"></a><span id="l12.182"> </span>
<a href="#l12.183"></a><span id="l12.183"> NS_IMETHODIMP</span>
<a href="#l12.184"></a><span id="l12.184"> nsAbContentHandler::OnStreamComplete(nsIStreamLoader *aLoader,</span>
<a href="#l12.185"></a><span id="l12.185">                                      nsISupports *aContext, nsresult aStatus,</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-                                     uint32_t datalen, const uint8_t *data)</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-{</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+                                     uint32_t datalen, const uint8_t *data) {</span>
<a href="#l12.189"></a><span id="l12.189">   NS_ENSURE_ARG_POINTER(aContext);</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-  NS_ENSURE_SUCCESS(aStatus, aStatus); // don't process the vcard if we got a status error</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+  NS_ENSURE_SUCCESS(</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+      aStatus, aStatus);  // don't process the vcard if we got a status error</span>
<a href="#l12.193"></a><span id="l12.193">   nsresult rv = NS_OK;</span>
<a href="#l12.194"></a><span id="l12.194"> </span>
<a href="#l12.195"></a><span id="l12.195">   // take our vCard string and open up an address book window based on it</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService = do_GetService(NS_MSGVCARDSERVICE_CONTRACTID);</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-  if (vCardService)</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-  {</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-    nsAutoPtr&lt;VObject&gt; vObj(vCardService-&gt;Parse_MIME((const char *)data, datalen));</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-    if (vObj)</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-    {</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService =</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+      do_GetService(NS_MSGVCARDSERVICE_CONTRACTID);</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+  if (vCardService) {</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+    nsAutoPtr&lt;VObject&gt; vObj(</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+        vCardService-&gt;Parse_MIME((const char *)data, datalen));</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+    if (vObj) {</span>
<a href="#l12.208"></a><span id="l12.208">       int32_t len = 0;</span>
<a href="#l12.209"></a><span id="l12.209">       nsCString vCard;</span>
<a href="#l12.210"></a><span id="l12.210">       vCard.Adopt(vCardService-&gt;WriteMemoryVObjects(0, &amp;len, vObj, false));</span>
<a href="#l12.211"></a><span id="l12.211"> </span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-      nsCOMPtr&lt;nsIAbManager&gt; ab =</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+      nsCOMPtr&lt;nsIAbManager&gt; ab = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.215"></a><span id="l12.215">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.216"></a><span id="l12.216"> </span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-      nsCOMPtr &lt;nsIAbCard&gt; cardFromVCard;</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineminus">-      rv = ab-&gt;EscapedVCardToAbCard(vCard.get(),</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-                                    getter_AddRefs(cardFromVCard));</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+      nsCOMPtr&lt;nsIAbCard&gt; cardFromVCard;</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+      rv = ab-&gt;EscapedVCardToAbCard(vCard.get(), getter_AddRefs(cardFromVCard));</span>
<a href="#l12.222"></a><span id="l12.222">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.223"></a><span id="l12.223"> </span>
<a href="#l12.224"></a><span id="l12.224">       nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow = do_GetInterface(aContext);</span>
<a href="#l12.225"></a><span id="l12.225">       NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-      nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+      nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow =</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+          nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l12.229"></a><span id="l12.229"> </span>
<a href="#l12.230"></a><span id="l12.230">       nsCOMPtr&lt;nsPIDOMWindowOuter&gt; dialogWindow;</span>
<a href="#l12.231"></a><span id="l12.231">       rv = parentWindow-&gt;OpenDialog(</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-           NS_LITERAL_STRING(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;),</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-           EmptyString(),</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-           NS_LITERAL_STRING(&quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;),</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-           cardFromVCard, getter_AddRefs(dialogWindow));</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+          NS_LITERAL_STRING(</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+              &quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;),</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+          EmptyString(),</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+          NS_LITERAL_STRING(&quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;),</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+          cardFromVCard, getter_AddRefs(dialogWindow));</span>
<a href="#l12.241"></a><span id="l12.241">     }</span>
<a href="#l12.242"></a><span id="l12.242">   }</span>
<a href="#l12.243"></a><span id="l12.243"> </span>
<a href="#l12.244"></a><span id="l12.244">   return rv;</span>
<a href="#l12.245"></a><span id="l12.245"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbContentHandler.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbContentHandler.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -5,22 +5,21 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> #ifndef __nsAbContentHandler_h</span>
<a href="#l13.6"></a><span id="l13.6"> #define __nsAbContentHandler_h</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIStreamLoader.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIContentHandler.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> class nsAbContentHandler : public nsIContentHandler,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-                           public nsIStreamLoaderObserver</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-public:</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                           public nsIStreamLoaderObserver {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ public:</span>
<a href="#l13.17"></a><span id="l13.17">   nsAbContentHandler();</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l13.20"></a><span id="l13.20">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l13.21"></a><span id="l13.21">   NS_DECL_NSISTREAMLOADEROBSERVER</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-private:</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ private:</span>
<a href="#l13.25"></a><span id="l13.25">   virtual ~nsAbContentHandler();</span>
<a href="#l13.26"></a><span id="l13.26"> };</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirFactoryService.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirFactoryService.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -13,36 +13,30 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> NS_IMPL_ISUPPORTS(nsAbDirFactoryService, nsIAbDirFactoryService)</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-nsAbDirFactoryService::nsAbDirFactoryService()</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-}</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+nsAbDirFactoryService::nsAbDirFactoryService() {}</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-nsAbDirFactoryService::~nsAbDirFactoryService()</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-{</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-}</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+nsAbDirFactoryService::~nsAbDirFactoryService() {}</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22"> /* nsIAbDirFactory getDirFactory (in string uri); */</span>
<a href="#l14.23"></a><span id="l14.23"> NS_IMETHODIMP</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-nsAbDirFactoryService::GetDirFactory(const nsACString &amp;aURI,</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-                                     nsIAbDirFactory** aDirFactory)</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-{</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+nsAbDirFactoryService::GetDirFactory(const nsACString&amp; aURI,</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+                                     nsIAbDirFactory** aDirFactory) {</span>
<a href="#l14.29"></a><span id="l14.29">   NS_ENSURE_ARG_POINTER(aDirFactory);</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">   nsresult rv;</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33">   // Obtain the network IO service</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; nsService =</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; nsService = mozilla::services::GetIOService();</span>
<a href="#l14.37"></a><span id="l14.37">   NS_ENSURE_TRUE(nsService, NS_ERROR_UNEXPECTED);</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   // Extract the scheme</span>
<a href="#l14.40"></a><span id="l14.40">   nsAutoCString scheme;</span>
<a href="#l14.41"></a><span id="l14.41">   rv = nsService-&gt;ExtractScheme(aURI, scheme);</span>
<a href="#l14.42"></a><span id="l14.42">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">   // Try to find a factory using the component manager.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirFactoryService.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirFactoryService.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -3,21 +3,20 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.5"></a><span id="l15.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> #ifndef nsAbDirFactoryService_h__</span>
<a href="#l15.8"></a><span id="l15.8"> #define nsAbDirFactoryService_h__</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsIAbDirFactoryService.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-class nsAbDirFactoryService : public nsIAbDirFactoryService</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-public:</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+class nsAbDirFactoryService : public nsIAbDirFactoryService {</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ public:</span>
<a href="#l15.17"></a><span id="l15.17">   NS_DECL_ISUPPORTS</span>
<a href="#l15.18"></a><span id="l15.18">   NS_DECL_NSIABDIRFACTORYSERVICE</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">   nsAbDirFactoryService();</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-private:</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ private:</span>
<a href="#l15.24"></a><span id="l15.24">   virtual ~nsAbDirFactoryService();</span>
<a href="#l15.25"></a><span id="l15.25"> };</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -17,73 +17,65 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsIUUIDGenerator.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> using namespace mozilla;</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> // From nsDirPrefs</span>
<a href="#l16.9"></a><span id="l16.9"> #define kDefaultPosition 1</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> nsAbDirProperty::nsAbDirProperty(void)</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  : m_LastModifiedDate(0),</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    mIsValidURI(false),</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    mIsQueryURI(false)</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-{</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+    : m_LastModifiedDate(0), mIsValidURI(false), mIsQueryURI(false) {</span>
<a href="#l16.17"></a><span id="l16.17">   m_IsMailList = false;</span>
<a href="#l16.18"></a><span id="l16.18">   mUID = EmptyCString();</span>
<a href="#l16.19"></a><span id="l16.19"> }</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-nsAbDirProperty::~nsAbDirProperty(void)</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-{</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+nsAbDirProperty::~nsAbDirProperty(void) {</span>
<a href="#l16.24"></a><span id="l16.24"> #if 0</span>
<a href="#l16.25"></a><span id="l16.25">   // this code causes a regression #138647</span>
<a href="#l16.26"></a><span id="l16.26">   // don't turn it on until you figure it out</span>
<a href="#l16.27"></a><span id="l16.27">   if (m_AddressList) {</span>
<a href="#l16.28"></a><span id="l16.28">     uint32_t count;</span>
<a href="#l16.29"></a><span id="l16.29">     nsresult rv;</span>
<a href="#l16.30"></a><span id="l16.30">     rv = m_AddressList-&gt;GetLength(&amp;count);</span>
<a href="#l16.31"></a><span id="l16.31">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Count failed&quot;);</span>
<a href="#l16.32"></a><span id="l16.32">     int32_t i;</span>
<a href="#l16.33"></a><span id="l16.33">     for (i = count - 1; i &gt;= 0; i--)</span>
<a href="#l16.34"></a><span id="l16.34">       m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l16.35"></a><span id="l16.35">   }</span>
<a href="#l16.36"></a><span id="l16.36"> #endif</span>
<a href="#l16.37"></a><span id="l16.37"> }</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39"> NS_IMPL_ISUPPORTS(nsAbDirProperty, nsIAbDirectory, nsISupportsWeakReference,</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-                              nsIAbCollection, nsIAbItem)</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+                  nsIAbCollection, nsIAbItem)</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetUuid(nsACString &amp;uuid)</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-{</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetUuid(nsACString &amp;uuid) {</span>
<a href="#l16.46"></a><span id="l16.46">   // XXX: not all directories have a dirPrefId...</span>
<a href="#l16.47"></a><span id="l16.47">   nsresult rv = GetDirPrefId(uuid);</span>
<a href="#l16.48"></a><span id="l16.48">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.49"></a><span id="l16.49">   uuid.Append('&amp;');</span>
<a href="#l16.50"></a><span id="l16.50">   nsString dirName;</span>
<a href="#l16.51"></a><span id="l16.51">   GetDirName(dirName);</span>
<a href="#l16.52"></a><span id="l16.52">   uuid.Append(NS_ConvertUTF16toUTF8(dirName));</span>
<a href="#l16.53"></a><span id="l16.53">   return rv;</span>
<a href="#l16.54"></a><span id="l16.54"> }</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56"> NS_IMETHODIMP nsAbDirProperty::GenerateName(int32_t aGenerateFormat,</span>
<a href="#l16.57"></a><span id="l16.57">                                             nsIStringBundle *aBundle,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-                                            nsAString &amp;name)</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-{</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+                                            nsAString &amp;name) {</span>
<a href="#l16.61"></a><span id="l16.61">   return GetDirName(name);</span>
<a href="#l16.62"></a><span id="l16.62"> }</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetPropertiesChromeURI(nsACString &amp;aResult)</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-{</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  aResult.AssignLiteral(&quot;chrome://messenger/content/addressbook/abAddressBookNameDialog.xul&quot;);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetPropertiesChromeURI(nsACString &amp;aResult) {</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+  aResult.AssignLiteral(</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+      &quot;chrome://messenger/content/addressbook/abAddressBookNameDialog.xul&quot;);</span>
<a href="#l16.70"></a><span id="l16.70">   return NS_OK;</span>
<a href="#l16.71"></a><span id="l16.71"> }</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetDirName(nsAString &amp;aDirName)</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-{</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  if (m_DirPrefId.IsEmpty())</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-  {</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetDirName(nsAString &amp;aDirName) {</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  if (m_DirPrefId.IsEmpty()) {</span>
<a href="#l16.79"></a><span id="l16.79">     aDirName = m_ListDirName;</span>
<a href="#l16.80"></a><span id="l16.80">     return NS_OK;</span>
<a href="#l16.81"></a><span id="l16.81">   }</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83">   nsCString dirName;</span>
<a href="#l16.84"></a><span id="l16.84">   nsresult rv = GetLocalizedStringValue(&quot;description&quot;, EmptyCString(), dirName);</span>
<a href="#l16.85"></a><span id="l16.85">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.86"></a><span id="l16.86"> </span>
<a href="#l16.87"></a><span id="l16.87" class="difflineat">@@ -94,70 +86,65 @@ NS_IMETHODIMP nsAbDirProperty::GetDirNam</span>
<a href="#l16.88"></a><span id="l16.88">   // non-locked pref value if it is a chrome:// URI and will get the string</span>
<a href="#l16.89"></a><span id="l16.89">   // value at that chrome URI. This breaks extensions/autoconfig that want to</span>
<a href="#l16.90"></a><span id="l16.90">   // set default pref values and allow users to change directory names.</span>
<a href="#l16.91"></a><span id="l16.91">   //</span>
<a href="#l16.92"></a><span id="l16.92">   // Now we have to support this, and so if for whatever reason we fail to get</span>
<a href="#l16.93"></a><span id="l16.93">   // the localized version, then we try and get the non-localized version</span>
<a href="#l16.94"></a><span id="l16.94">   // instead. If the string value is empty, then we'll just get the empty value</span>
<a href="#l16.95"></a><span id="l16.95">   // back here.</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-  if (dirName.IsEmpty())</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-  {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  if (dirName.IsEmpty()) {</span>
<a href="#l16.99"></a><span id="l16.99">     rv = GetStringValue(&quot;description&quot;, EmptyCString(), dirName);</span>
<a href="#l16.100"></a><span id="l16.100">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.101"></a><span id="l16.101">   }</span>
<a href="#l16.102"></a><span id="l16.102"> </span>
<a href="#l16.103"></a><span id="l16.103">   CopyUTF8toUTF16(dirName, aDirName);</span>
<a href="#l16.104"></a><span id="l16.104">   return NS_OK;</span>
<a href="#l16.105"></a><span id="l16.105"> }</span>
<a href="#l16.106"></a><span id="l16.106"> </span>
<a href="#l16.107"></a><span id="l16.107"> // XXX Although mailing lists could use the NotifyItemPropertyChanged</span>
<a href="#l16.108"></a><span id="l16.108"> // mechanism here, it requires some rework on how we write/save data</span>
<a href="#l16.109"></a><span id="l16.109"> // relating to mailing lists, so we're just using the old method of a</span>
<a href="#l16.110"></a><span id="l16.110"> // local variable to store the mailing list name.</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetDirName(const nsAString &amp;aDirName)</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-{</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-  if (m_DirPrefId.IsEmpty())</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-  {</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetDirName(const nsAString &amp;aDirName) {</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+  if (m_DirPrefId.IsEmpty()) {</span>
<a href="#l16.117"></a><span id="l16.117">     m_ListDirName = aDirName;</span>
<a href="#l16.118"></a><span id="l16.118">     return NS_OK;</span>
<a href="#l16.119"></a><span id="l16.119">   }</span>
<a href="#l16.120"></a><span id="l16.120"> </span>
<a href="#l16.121"></a><span id="l16.121">   // Store the old value.</span>
<a href="#l16.122"></a><span id="l16.122">   nsString oldDirName;</span>
<a href="#l16.123"></a><span id="l16.123">   nsresult rv = GetDirName(oldDirName);</span>
<a href="#l16.124"></a><span id="l16.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.125"></a><span id="l16.125"> </span>
<a href="#l16.126"></a><span id="l16.126">   // Save the new value</span>
<a href="#l16.127"></a><span id="l16.127">   rv = SetLocalizedStringValue(&quot;description&quot;, NS_ConvertUTF16toUTF8(aDirName));</span>
<a href="#l16.128"></a><span id="l16.128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.133"></a><span id="l16.133"> </span>
<a href="#l16.134"></a><span id="l16.134">   if (NS_SUCCEEDED(rv))</span>
<a href="#l16.135"></a><span id="l16.135">     // We inherit from nsIAbDirectory, so this static cast should be safe.</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-    abManager-&gt;NotifyItemPropertyChanged(static_cast&lt;nsIAbDirectory*&gt;(this),</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+    abManager-&gt;NotifyItemPropertyChanged(static_cast&lt;nsIAbDirectory *&gt;(this),</span>
<a href="#l16.138"></a><span id="l16.138">                                          &quot;DirName&quot;, oldDirName.get(),</span>
<a href="#l16.139"></a><span id="l16.139">                                          nsString(aDirName).get());</span>
<a href="#l16.140"></a><span id="l16.140"> </span>
<a href="#l16.141"></a><span id="l16.141">   return NS_OK;</span>
<a href="#l16.142"></a><span id="l16.142"> }</span>
<a href="#l16.143"></a><span id="l16.143"> </span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetDirType(int32_t *aDirType)</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-{</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetDirType(int32_t *aDirType) {</span>
<a href="#l16.147"></a><span id="l16.147">   return GetIntValue(&quot;dirType&quot;, LDAPDirectory, aDirType);</span>
<a href="#l16.148"></a><span id="l16.148"> }</span>
<a href="#l16.149"></a><span id="l16.149"> </span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetFileName(nsACString &amp;aFileName)</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-{</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetFileName(nsACString &amp;aFileName) {</span>
<a href="#l16.153"></a><span id="l16.153">   return GetStringValue(&quot;filename&quot;, EmptyCString(), aFileName);</span>
<a href="#l16.154"></a><span id="l16.154"> }</span>
<a href="#l16.155"></a><span id="l16.155"> </span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetUID(nsACString &amp;aUID)</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-{</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetUID(nsACString &amp;aUID) {</span>
<a href="#l16.159"></a><span id="l16.159">   nsresult rv = NS_OK;</span>
<a href="#l16.160"></a><span id="l16.160">   if (!mUID.IsEmpty()) {</span>
<a href="#l16.161"></a><span id="l16.161">     aUID = mUID;</span>
<a href="#l16.162"></a><span id="l16.162">     return rv;</span>
<a href="#l16.163"></a><span id="l16.163">   }</span>
<a href="#l16.164"></a><span id="l16.164">   if (!m_IsMailList) {</span>
<a href="#l16.165"></a><span id="l16.165">     rv = GetStringValue(&quot;uid&quot;, EmptyCString(), aUID);</span>
<a href="#l16.166"></a><span id="l16.166">     if (!aUID.IsEmpty()) {</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineat">@@ -174,109 +161,95 @@ NS_IMETHODIMP nsAbDirProperty::GetUID(ns</span>
<a href="#l16.168"></a><span id="l16.168"> </span>
<a href="#l16.169"></a><span id="l16.169">   char idString[NSID_LENGTH];</span>
<a href="#l16.170"></a><span id="l16.170">   id.ToProvidedString(idString);</span>
<a href="#l16.171"></a><span id="l16.171"> </span>
<a href="#l16.172"></a><span id="l16.172">   aUID.AppendASCII(idString + 1, NSID_LENGTH - 3);</span>
<a href="#l16.173"></a><span id="l16.173">   return SetUID(aUID);</span>
<a href="#l16.174"></a><span id="l16.174"> }</span>
<a href="#l16.175"></a><span id="l16.175"> </span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetUID(const nsACString &amp;aUID)</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-{</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetUID(const nsACString &amp;aUID) {</span>
<a href="#l16.179"></a><span id="l16.179">   mUID = aUID;</span>
<a href="#l16.180"></a><span id="l16.180">   if (m_IsMailList) {</span>
<a href="#l16.181"></a><span id="l16.181">     return NS_OK;</span>
<a href="#l16.182"></a><span id="l16.182">   }</span>
<a href="#l16.183"></a><span id="l16.183">   return SetStringValue(&quot;uid&quot;, aUID);</span>
<a href="#l16.184"></a><span id="l16.184"> }</span>
<a href="#l16.185"></a><span id="l16.185"> </span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetURI(nsACString &amp;aURI)</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-{</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetURI(nsACString &amp;aURI) {</span>
<a href="#l16.189"></a><span id="l16.189">   // XXX Should we complete this for Mailing Lists?</span>
<a href="#l16.190"></a><span id="l16.190">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.191"></a><span id="l16.191"> }</span>
<a href="#l16.192"></a><span id="l16.192"> </span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetPosition(int32_t *aPosition)</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-{</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetPosition(int32_t *aPosition) {</span>
<a href="#l16.196"></a><span id="l16.196">   return GetIntValue(&quot;position&quot;, kDefaultPosition, aPosition);</span>
<a href="#l16.197"></a><span id="l16.197"> }</span>
<a href="#l16.198"></a><span id="l16.198"> </span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetLastModifiedDate(uint32_t *aLastModifiedDate)</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-{</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetLastModifiedDate(</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+    uint32_t *aLastModifiedDate) {</span>
<a href="#l16.203"></a><span id="l16.203">   NS_ENSURE_ARG_POINTER(aLastModifiedDate);</span>
<a href="#l16.204"></a><span id="l16.204">   *aLastModifiedDate = m_LastModifiedDate;</span>
<a href="#l16.205"></a><span id="l16.205">   return NS_OK;</span>
<a href="#l16.206"></a><span id="l16.206"> }</span>
<a href="#l16.207"></a><span id="l16.207"> </span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetLastModifiedDate(uint32_t aLastModifiedDate)</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-{</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-  if (aLastModifiedDate)</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-  {</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetLastModifiedDate(uint32_t aLastModifiedDate) {</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+  if (aLastModifiedDate) {</span>
<a href="#l16.214"></a><span id="l16.214">     m_LastModifiedDate = aLastModifiedDate;</span>
<a href="#l16.215"></a><span id="l16.215">   }</span>
<a href="#l16.216"></a><span id="l16.216">   return NS_OK;</span>
<a href="#l16.217"></a><span id="l16.217"> }</span>
<a href="#l16.218"></a><span id="l16.218"> </span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetListNickName(nsAString &amp;aListNickName)</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-{</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetListNickName(nsAString &amp;aListNickName) {</span>
<a href="#l16.222"></a><span id="l16.222">   aListNickName = m_ListNickName;</span>
<a href="#l16.223"></a><span id="l16.223">   return NS_OK;</span>
<a href="#l16.224"></a><span id="l16.224"> }</span>
<a href="#l16.225"></a><span id="l16.225"> </span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetListNickName(const nsAString &amp;aListNickName)</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-{</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetListNickName(const nsAString &amp;aListNickName) {</span>
<a href="#l16.229"></a><span id="l16.229">   m_ListNickName = aListNickName;</span>
<a href="#l16.230"></a><span id="l16.230">   return NS_OK;</span>
<a href="#l16.231"></a><span id="l16.231"> }</span>
<a href="#l16.232"></a><span id="l16.232"> </span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetDescription(nsAString &amp;aDescription)</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-{</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetDescription(nsAString &amp;aDescription) {</span>
<a href="#l16.236"></a><span id="l16.236">   aDescription = m_Description;</span>
<a href="#l16.237"></a><span id="l16.237">   return NS_OK;</span>
<a href="#l16.238"></a><span id="l16.238"> }</span>
<a href="#l16.239"></a><span id="l16.239"> </span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetDescription(const nsAString &amp;aDescription)</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-{</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetDescription(const nsAString &amp;aDescription) {</span>
<a href="#l16.243"></a><span id="l16.243">   m_Description = aDescription;</span>
<a href="#l16.244"></a><span id="l16.244">   return NS_OK;</span>
<a href="#l16.245"></a><span id="l16.245"> }</span>
<a href="#l16.246"></a><span id="l16.246"> </span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetIsMailList(bool *aIsMailList)</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-{</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetIsMailList(bool *aIsMailList) {</span>
<a href="#l16.250"></a><span id="l16.250">   *aIsMailList = m_IsMailList;</span>
<a href="#l16.251"></a><span id="l16.251">   return NS_OK;</span>
<a href="#l16.252"></a><span id="l16.252"> }</span>
<a href="#l16.253"></a><span id="l16.253"> </span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetIsMailList(bool aIsMailList)</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-{</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetIsMailList(bool aIsMailList) {</span>
<a href="#l16.257"></a><span id="l16.257">   m_IsMailList = aIsMailList;</span>
<a href="#l16.258"></a><span id="l16.258">   return NS_OK;</span>
<a href="#l16.259"></a><span id="l16.259"> }</span>
<a href="#l16.260"></a><span id="l16.260"> </span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetAddressLists(nsIMutableArray * *aAddressLists)</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-{</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-  {</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetAddressLists(</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+    nsIMutableArray **aAddressLists) {</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l16.268"></a><span id="l16.268">     nsresult rv;</span>
<a href="#l16.269"></a><span id="l16.269">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l16.270"></a><span id="l16.270">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.271"></a><span id="l16.271">   }</span>
<a href="#l16.272"></a><span id="l16.272"> </span>
<a href="#l16.273"></a><span id="l16.273">   NS_ADDREF(*aAddressLists = m_AddressList);</span>
<a href="#l16.274"></a><span id="l16.274">   return NS_OK;</span>
<a href="#l16.275"></a><span id="l16.275"> }</span>
<a href="#l16.276"></a><span id="l16.276"> </span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetAddressLists(nsIMutableArray * aAddressLists)</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-{</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetAddressLists(nsIMutableArray *aAddressLists) {</span>
<a href="#l16.280"></a><span id="l16.280">   m_AddressList = aAddressLists;</span>
<a href="#l16.281"></a><span id="l16.281">   return NS_OK;</span>
<a href="#l16.282"></a><span id="l16.282"> }</span>
<a href="#l16.283"></a><span id="l16.283"> </span>
<a href="#l16.284"></a><span id="l16.284" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::CopyMailList(nsIAbDirectory* srcList)</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineminus">-{</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::CopyMailList(nsIAbDirectory *srcList) {</span>
<a href="#l16.287"></a><span id="l16.287">   SetIsMailList(true);</span>
<a href="#l16.288"></a><span id="l16.288"> </span>
<a href="#l16.289"></a><span id="l16.289">   nsString str;</span>
<a href="#l16.290"></a><span id="l16.290">   srcList-&gt;GetDirName(str);</span>
<a href="#l16.291"></a><span id="l16.291">   SetDirName(str);</span>
<a href="#l16.292"></a><span id="l16.292">   srcList-&gt;GetListNickName(str);</span>
<a href="#l16.293"></a><span id="l16.293">   SetListNickName(str);</span>
<a href="#l16.294"></a><span id="l16.294">   srcList-&gt;GetDescription(str);</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineat">@@ -287,360 +260,345 @@ NS_IMETHODIMP nsAbDirProperty::CopyMailL</span>
<a href="#l16.296"></a><span id="l16.296">   SetUID(uid);</span>
<a href="#l16.297"></a><span id="l16.297"> </span>
<a href="#l16.298"></a><span id="l16.298">   nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l16.299"></a><span id="l16.299">   srcList-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l16.300"></a><span id="l16.300">   SetAddressLists(pAddressLists);</span>
<a href="#l16.301"></a><span id="l16.301">   return NS_OK;</span>
<a href="#l16.302"></a><span id="l16.302"> }</span>
<a href="#l16.303"></a><span id="l16.303"> </span>
<a href="#l16.304"></a><span id="l16.304" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetIsQuery(bool *aResult)</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineminus">-{</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetIsQuery(bool *aResult) {</span>
<a href="#l16.307"></a><span id="l16.307">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l16.308"></a><span id="l16.308">   // Mailing lists are not queries by default, individual directory types</span>
<a href="#l16.309"></a><span id="l16.309">   // will override this.</span>
<a href="#l16.310"></a><span id="l16.310">   *aResult = false;</span>
<a href="#l16.311"></a><span id="l16.311">   return NS_OK;</span>
<a href="#l16.312"></a><span id="l16.312"> }</span>
<a href="#l16.313"></a><span id="l16.313"> </span>
<a href="#l16.314"></a><span id="l16.314"> NS_IMETHODIMP</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineminus">-nsAbDirProperty::Init(const char *aURI)</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineminus">-{</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+nsAbDirProperty::Init(const char *aURI) {</span>
<a href="#l16.318"></a><span id="l16.318">   mURINoQuery = aURI;</span>
<a href="#l16.319"></a><span id="l16.319">   mURI = aURI;</span>
<a href="#l16.320"></a><span id="l16.320">   mIsValidURI = true;</span>
<a href="#l16.321"></a><span id="l16.321"> </span>
<a href="#l16.322"></a><span id="l16.322">   int32_t searchCharLocation = mURINoQuery.FindChar('?');</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineminus">-  if (searchCharLocation &gt;= 0)</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineminus">-  {</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+  if (searchCharLocation &gt;= 0) {</span>
<a href="#l16.326"></a><span id="l16.326">     mQueryString = Substring(mURINoQuery, searchCharLocation + 1);</span>
<a href="#l16.327"></a><span id="l16.327">     mURINoQuery.SetLength(searchCharLocation);</span>
<a href="#l16.328"></a><span id="l16.328">     mIsQueryURI = true;</span>
<a href="#l16.329"></a><span id="l16.329">   }</span>
<a href="#l16.330"></a><span id="l16.330"> </span>
<a href="#l16.331"></a><span id="l16.331">   return NS_OK;</span>
<a href="#l16.332"></a><span id="l16.332"> }</span>
<a href="#l16.333"></a><span id="l16.333"> </span>
<a href="#l16.334"></a><span id="l16.334"> // nsIAbDirectory NOT IMPLEMENTED methods</span>
<a href="#l16.335"></a><span id="l16.335"> NS_IMETHODIMP</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-nsAbDirProperty::GetChildNodes(nsISimpleEnumerator **childList)</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+nsAbDirProperty::GetChildNodes(nsISimpleEnumerator **childList) {</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+}</span>
<a href="#l16.341"></a><span id="l16.341"> </span>
<a href="#l16.342"></a><span id="l16.342"> NS_IMETHODIMP</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineminus">-nsAbDirProperty::GetChildCards(nsISimpleEnumerator **childCards)</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+nsAbDirProperty::GetChildCards(nsISimpleEnumerator **childCards) {</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+}</span>
<a href="#l16.348"></a><span id="l16.348"> </span>
<a href="#l16.349"></a><span id="l16.349"> NS_IMETHODIMP</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineminus">-nsAbDirProperty::DeleteDirectory(nsIAbDirectory *directory)</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+nsAbDirProperty::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+}</span>
<a href="#l16.355"></a><span id="l16.355"> </span>
<a href="#l16.356"></a><span id="l16.356"> NS_IMETHODIMP</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineminus">-nsAbDirProperty::HasCard(nsIAbCard *cards, bool *hasCard)</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+nsAbDirProperty::HasCard(nsIAbCard *cards, bool *hasCard) {</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+}</span>
<a href="#l16.362"></a><span id="l16.362"> </span>
<a href="#l16.363"></a><span id="l16.363"> NS_IMETHODIMP</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineminus">-nsAbDirProperty::HasDirectory(nsIAbDirectory *dir, bool *hasDir)</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+nsAbDirProperty::HasDirectory(nsIAbDirectory *dir, bool *hasDir) {</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+}</span>
<a href="#l16.369"></a><span id="l16.369"> </span>
<a href="#l16.370"></a><span id="l16.370"> NS_IMETHODIMP</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineminus">-nsAbDirProperty::HasMailListWithName(const char16_t *aName, bool *aHasList)</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineminus">-{</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+nsAbDirProperty::HasMailListWithName(const char16_t *aName, bool *aHasList) {</span>
<a href="#l16.374"></a><span id="l16.374">   NS_ENSURE_ARG_POINTER(aName);</span>
<a href="#l16.375"></a><span id="l16.375">   NS_ENSURE_ARG_POINTER(aHasList);</span>
<a href="#l16.376"></a><span id="l16.376"> </span>
<a href="#l16.377"></a><span id="l16.377">   *aHasList = false;</span>
<a href="#l16.378"></a><span id="l16.378"> </span>
<a href="#l16.379"></a><span id="l16.379">   bool supportsLists = false;</span>
<a href="#l16.380"></a><span id="l16.380">   nsresult rv = GetSupportsMailingLists(&amp;supportsLists);</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineminus">-  if (NS_FAILED(rv) || !supportsLists)</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+  if (NS_FAILED(rv) || !supportsLists) return NS_OK;</span>
<a href="#l16.384"></a><span id="l16.384"> </span>
<a href="#l16.385"></a><span id="l16.385" class="difflineminus">-  if (m_IsMailList)</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+  if (m_IsMailList) return NS_OK;</span>
<a href="#l16.388"></a><span id="l16.388"> </span>
<a href="#l16.389"></a><span id="l16.389">   nsCOMPtr&lt;nsIMutableArray&gt; addressLists;</span>
<a href="#l16.390"></a><span id="l16.390">   rv = GetAddressLists(getter_AddRefs(addressLists));</span>
<a href="#l16.391"></a><span id="l16.391">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.392"></a><span id="l16.392"> </span>
<a href="#l16.393"></a><span id="l16.393">   uint32_t listCount = 0;</span>
<a href="#l16.394"></a><span id="l16.394">   rv = addressLists-&gt;GetLength(&amp;listCount);</span>
<a href="#l16.395"></a><span id="l16.395">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.396"></a><span id="l16.396"> </span>
<a href="#l16.397"></a><span id="l16.397" class="difflineminus">-  for (uint32_t i = 0; i &lt; listCount; i++)</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineminus">-  {</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+  for (uint32_t i = 0; i &lt; listCount; i++) {</span>
<a href="#l16.400"></a><span id="l16.400">     nsCOMPtr&lt;nsIAbDirectory&gt; listDir(do_QueryElementAt(addressLists, i, &amp;rv));</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; listDir)</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineminus">-    {</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; listDir) {</span>
<a href="#l16.404"></a><span id="l16.404">       nsAutoString listName;</span>
<a href="#l16.405"></a><span id="l16.405">       rv = listDir-&gt;GetDirName(listName);</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; listName.Equals(aName))</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineminus">-      {</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; listName.Equals(aName)) {</span>
<a href="#l16.409"></a><span id="l16.409">         *aHasList = true;</span>
<a href="#l16.410"></a><span id="l16.410">         return NS_OK;</span>
<a href="#l16.411"></a><span id="l16.411">       }</span>
<a href="#l16.412"></a><span id="l16.412">     }</span>
<a href="#l16.413"></a><span id="l16.413">   }</span>
<a href="#l16.414"></a><span id="l16.414">   return NS_OK;</span>
<a href="#l16.415"></a><span id="l16.415"> }</span>
<a href="#l16.416"></a><span id="l16.416"> </span>
<a href="#l16.417"></a><span id="l16.417"> NS_IMETHODIMP</span>
<a href="#l16.418"></a><span id="l16.418"> nsAbDirProperty::CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineminus">-                                    const nsACString &amp;aURI,</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineminus">-                                    uint32_t aType,</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+                                    const nsACString &amp;aURI, uint32_t aType,</span>
<a href="#l16.422"></a><span id="l16.422">                                     const nsACString &amp;aPrefName,</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineminus">-                                    nsACString &amp;aResult)</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+                                    nsACString &amp;aResult) {</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineplus">+}</span>
<a href="#l16.428"></a><span id="l16.428"> </span>
<a href="#l16.429"></a><span id="l16.429"> NS_IMETHODIMP</span>
<a href="#l16.430"></a><span id="l16.430"> nsAbDirProperty::CreateDirectoryByURI(const nsAString &amp;aDisplayName,</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineminus">-                                      const nsACString &amp;aURI)</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+                                      const nsACString &amp;aURI) {</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineplus">+}</span>
<a href="#l16.436"></a><span id="l16.436"> </span>
<a href="#l16.437"></a><span id="l16.437" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::AddMailList(nsIAbDirectory *list, nsIAbDirectory **addedList)</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::AddMailList(nsIAbDirectory *list,</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+                                           nsIAbDirectory **addedList) {</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+}</span>
<a href="#l16.443"></a><span id="l16.443"> </span>
<a href="#l16.444"></a><span id="l16.444" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::EditMailListToDatabase(nsIAbCard *listCard)</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::EditMailListToDatabase(nsIAbCard *listCard) {</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineplus">+}</span>
<a href="#l16.449"></a><span id="l16.449"> </span>
<a href="#l16.450"></a><span id="l16.450" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::AddCard(nsIAbCard *childCard, nsIAbCard **addedCard)</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::AddCard(nsIAbCard *childCard,</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+                                       nsIAbCard **addedCard) {</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+}</span>
<a href="#l16.456"></a><span id="l16.456"> </span>
<a href="#l16.457"></a><span id="l16.457" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::ModifyCard(nsIAbCard *aModifiedCard)</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::ModifyCard(nsIAbCard *aModifiedCard) {</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineplus">+}</span>
<a href="#l16.462"></a><span id="l16.462"> </span>
<a href="#l16.463"></a><span id="l16.463" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::DeleteCards(nsIArray *cards)</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::DeleteCards(nsIArray *cards) {</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineplus">+}</span>
<a href="#l16.468"></a><span id="l16.468"> </span>
<a href="#l16.469"></a><span id="l16.469" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::DropCard(nsIAbCard *childCard, bool needToCopyCard)</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::DropCard(nsIAbCard *childCard,</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+                                        bool needToCopyCard) {</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+}</span>
<a href="#l16.475"></a><span id="l16.475"> </span>
<a href="#l16.476"></a><span id="l16.476" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineminus">-                                                   nsIAbCard ** aAbCard)</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::CardForEmailAddress(</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+    const nsACString &amp;aEmailAddress, nsIAbCard **aAbCard) {</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+}</span>
<a href="#l16.483"></a><span id="l16.483"> </span>
<a href="#l16.484"></a><span id="l16.484"> NS_IMETHODIMP nsAbDirProperty::GetCardFromProperty(const char *aProperty,</span>
<a href="#l16.485"></a><span id="l16.485">                                                    const nsACString &amp;aValue,</span>
<a href="#l16.486"></a><span id="l16.486">                                                    bool caseSensitive,</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineminus">-                                                   nsIAbCard **result)</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+                                                   nsIAbCard **result) {</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+}</span>
<a href="#l16.492"></a><span id="l16.492"> </span>
<a href="#l16.493"></a><span id="l16.493" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetCardsFromProperty(const char *aProperty,</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineminus">-                                                    const nsACString &amp;aValue,</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineminus">-                                                    bool caseSensitive,</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineminus">-                                                    nsISimpleEnumerator **result)</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineminus">-{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetCardsFromProperty(</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+    const char *aProperty, const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineplus">+    nsISimpleEnumerator **result) {</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+}</span>
<a href="#l16.503"></a><span id="l16.503"> </span>
<a href="#l16.504"></a><span id="l16.504" class="difflineminus">-</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetSupportsMailingLists(bool *aSupportsMailingsLists)</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineminus">-{</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetSupportsMailingLists(</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+    bool *aSupportsMailingsLists) {</span>
<a href="#l16.509"></a><span id="l16.509">   NS_ENSURE_ARG_POINTER(aSupportsMailingsLists);</span>
<a href="#l16.510"></a><span id="l16.510">   // We don't currently support nested mailing lists, so only return true if</span>
<a href="#l16.511"></a><span id="l16.511">   // we're not a mailing list.</span>
<a href="#l16.512"></a><span id="l16.512">   *aSupportsMailingsLists = !m_IsMailList;</span>
<a href="#l16.513"></a><span id="l16.513">   return NS_OK;</span>
<a href="#l16.514"></a><span id="l16.514"> }</span>
<a href="#l16.515"></a><span id="l16.515"> </span>
<a href="#l16.516"></a><span id="l16.516" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetReadOnly(bool *aReadOnly)</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineminus">-{</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetReadOnly(bool *aReadOnly) {</span>
<a href="#l16.519"></a><span id="l16.519">   NS_ENSURE_ARG_POINTER(aReadOnly);</span>
<a href="#l16.520"></a><span id="l16.520">   // Default is that we are writable. Any implementation that is read-only must</span>
<a href="#l16.521"></a><span id="l16.521">   // override this method.</span>
<a href="#l16.522"></a><span id="l16.522">   *aReadOnly = false;</span>
<a href="#l16.523"></a><span id="l16.523">   return NS_OK;</span>
<a href="#l16.524"></a><span id="l16.524"> }</span>
<a href="#l16.525"></a><span id="l16.525"> </span>
<a href="#l16.526"></a><span id="l16.526" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetIsRemote(bool *aIsRemote)</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineminus">-{</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetIsRemote(bool *aIsRemote) {</span>
<a href="#l16.529"></a><span id="l16.529">   NS_ENSURE_ARG_POINTER(aIsRemote);</span>
<a href="#l16.530"></a><span id="l16.530">   *aIsRemote = false;</span>
<a href="#l16.531"></a><span id="l16.531">   return NS_OK;</span>
<a href="#l16.532"></a><span id="l16.532"> }</span>
<a href="#l16.533"></a><span id="l16.533"> </span>
<a href="#l16.534"></a><span id="l16.534" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetIsSecure(bool *aIsSecure)</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineminus">-{</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetIsSecure(bool *aIsSecure) {</span>
<a href="#l16.537"></a><span id="l16.537">   NS_ENSURE_ARG_POINTER(aIsSecure);</span>
<a href="#l16.538"></a><span id="l16.538">   *aIsSecure = false;</span>
<a href="#l16.539"></a><span id="l16.539">   return NS_OK;</span>
<a href="#l16.540"></a><span id="l16.540"> }</span>
<a href="#l16.541"></a><span id="l16.541"> </span>
<a href="#l16.542"></a><span id="l16.542" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineminus">-                                                  bool *aResult)</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineminus">-{</span>
<a href="#l16.545"></a><span id="l16.545" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::UseForAutocomplete(</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineplus">+    const nsACString &amp;aIdentityKey, bool *aResult) {</span>
<a href="#l16.547"></a><span id="l16.547">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l16.548"></a><span id="l16.548"> </span>
<a href="#l16.549"></a><span id="l16.549">   // Is local autocomplete enabled?</span>
<a href="#l16.550"></a><span id="l16.550">   nsresult rv;</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineminus">-                                                   &amp;rv));</span>
<a href="#l16.553"></a><span id="l16.553" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l16.554"></a><span id="l16.554" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l16.555"></a><span id="l16.555">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.556"></a><span id="l16.556"> </span>
<a href="#l16.557"></a><span id="l16.557">   rv = prefBranch-&gt;GetBoolPref(&quot;mail.enable_autocomplete&quot;, aResult);</span>
<a href="#l16.558"></a><span id="l16.558">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.559"></a><span id="l16.559"> </span>
<a href="#l16.560"></a><span id="l16.560" class="difflineminus">-  // If autocomplete is generally enabled, check if it has been disabled explicitly for this directory.</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineminus">-  if (*aResult)</span>
<a href="#l16.562"></a><span id="l16.562" class="difflineminus">-  {</span>
<a href="#l16.563"></a><span id="l16.563" class="difflineminus">-    (void) GetBoolValue(&quot;enable_autocomplete&quot;, true, aResult);</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineplus">+  // If autocomplete is generally enabled, check if it has been disabled</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineplus">+  // explicitly for this directory.</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineplus">+  if (*aResult) {</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineplus">+    (void)GetBoolValue(&quot;enable_autocomplete&quot;, true, aResult);</span>
<a href="#l16.568"></a><span id="l16.568">   }</span>
<a href="#l16.569"></a><span id="l16.569"> </span>
<a href="#l16.570"></a><span id="l16.570">   return rv;</span>
<a href="#l16.571"></a><span id="l16.571"> }</span>
<a href="#l16.572"></a><span id="l16.572"> </span>
<a href="#l16.573"></a><span id="l16.573" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetDirPrefId(nsACString &amp;aDirPrefId)</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineminus">-{</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetDirPrefId(nsACString &amp;aDirPrefId) {</span>
<a href="#l16.576"></a><span id="l16.576">   aDirPrefId = m_DirPrefId;</span>
<a href="#l16.577"></a><span id="l16.577">   return NS_OK;</span>
<a href="#l16.578"></a><span id="l16.578"> }</span>
<a href="#l16.579"></a><span id="l16.579"> </span>
<a href="#l16.580"></a><span id="l16.580" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetDirPrefId(const nsACString &amp;aDirPrefId)</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineminus">-{</span>
<a href="#l16.582"></a><span id="l16.582" class="difflineminus">-  if (!m_DirPrefId.Equals(aDirPrefId))</span>
<a href="#l16.583"></a><span id="l16.583" class="difflineminus">-  {</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetDirPrefId(const nsACString &amp;aDirPrefId) {</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineplus">+  if (!m_DirPrefId.Equals(aDirPrefId)) {</span>
<a href="#l16.586"></a><span id="l16.586">     m_DirPrefId.Assign(aDirPrefId);</span>
<a href="#l16.587"></a><span id="l16.587">     // Clear the directory pref branch so that it is re-initialized next</span>
<a href="#l16.588"></a><span id="l16.588">     // time its required.</span>
<a href="#l16.589"></a><span id="l16.589">     m_DirectoryPrefs = nullptr;</span>
<a href="#l16.590"></a><span id="l16.590">   }</span>
<a href="#l16.591"></a><span id="l16.591">   return NS_OK;</span>
<a href="#l16.592"></a><span id="l16.592"> }</span>
<a href="#l16.593"></a><span id="l16.593"> </span>
<a href="#l16.594"></a><span id="l16.594" class="difflineminus">-nsresult nsAbDirProperty::InitDirectoryPrefs()</span>
<a href="#l16.595"></a><span id="l16.595" class="difflineminus">-{</span>
<a href="#l16.596"></a><span id="l16.596" class="difflineminus">-  if (m_DirPrefId.IsEmpty())</span>
<a href="#l16.597"></a><span id="l16.597" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.598"></a><span id="l16.598" class="difflineplus">+nsresult nsAbDirProperty::InitDirectoryPrefs() {</span>
<a href="#l16.599"></a><span id="l16.599" class="difflineplus">+  if (m_DirPrefId.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.600"></a><span id="l16.600"> </span>
<a href="#l16.601"></a><span id="l16.601">   nsresult rv;</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l16.605"></a><span id="l16.605">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.606"></a><span id="l16.606"> </span>
<a href="#l16.607"></a><span id="l16.607">   nsCString realPrefId(m_DirPrefId);</span>
<a href="#l16.608"></a><span id="l16.608">   realPrefId.Append('.');</span>
<a href="#l16.609"></a><span id="l16.609"> </span>
<a href="#l16.610"></a><span id="l16.610" class="difflineminus">-  return prefService-&gt;GetBranch(realPrefId.get(), getter_AddRefs(m_DirectoryPrefs));</span>
<a href="#l16.611"></a><span id="l16.611" class="difflineplus">+  return prefService-&gt;GetBranch(realPrefId.get(),</span>
<a href="#l16.612"></a><span id="l16.612" class="difflineplus">+                                getter_AddRefs(m_DirectoryPrefs));</span>
<a href="#l16.613"></a><span id="l16.613"> }</span>
<a href="#l16.614"></a><span id="l16.614"> </span>
<a href="#l16.615"></a><span id="l16.615"> NS_IMETHODIMP nsAbDirProperty::GetIntValue(const char *aName,</span>
<a href="#l16.616"></a><span id="l16.616" class="difflineminus">-                                          int32_t aDefaultValue,</span>
<a href="#l16.617"></a><span id="l16.617" class="difflineminus">-                                          int32_t *aResult)</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineminus">-{</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineplus">+                                           int32_t aDefaultValue,</span>
<a href="#l16.620"></a><span id="l16.620" class="difflineplus">+                                           int32_t *aResult) {</span>
<a href="#l16.621"></a><span id="l16.621">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l16.622"></a><span id="l16.622"> </span>
<a href="#l16.623"></a><span id="l16.623">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.624"></a><span id="l16.624">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.625"></a><span id="l16.625"> </span>
<a href="#l16.626"></a><span id="l16.626">   if (NS_FAILED(m_DirectoryPrefs-&gt;GetIntPref(aName, aResult)))</span>
<a href="#l16.627"></a><span id="l16.627">     *aResult = aDefaultValue;</span>
<a href="#l16.628"></a><span id="l16.628"> </span>
<a href="#l16.629"></a><span id="l16.629">   return NS_OK;</span>
<a href="#l16.630"></a><span id="l16.630"> }</span>
<a href="#l16.631"></a><span id="l16.631"> </span>
<a href="#l16.632"></a><span id="l16.632"> NS_IMETHODIMP nsAbDirProperty::GetBoolValue(const char *aName,</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineminus">-                                           bool aDefaultValue,</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineminus">-                                           bool *aResult)</span>
<a href="#l16.635"></a><span id="l16.635" class="difflineminus">-{</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineplus">+                                            bool aDefaultValue, bool *aResult) {</span>
<a href="#l16.637"></a><span id="l16.637">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l16.638"></a><span id="l16.638"> </span>
<a href="#l16.639"></a><span id="l16.639">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.640"></a><span id="l16.640">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.641"></a><span id="l16.641"> </span>
<a href="#l16.642"></a><span id="l16.642">   if (NS_FAILED(m_DirectoryPrefs-&gt;GetBoolPref(aName, aResult)))</span>
<a href="#l16.643"></a><span id="l16.643">     *aResult = aDefaultValue;</span>
<a href="#l16.644"></a><span id="l16.644"> </span>
<a href="#l16.645"></a><span id="l16.645">   return NS_OK;</span>
<a href="#l16.646"></a><span id="l16.646"> }</span>
<a href="#l16.647"></a><span id="l16.647"> </span>
<a href="#l16.648"></a><span id="l16.648"> NS_IMETHODIMP nsAbDirProperty::GetStringValue(const char *aName,</span>
<a href="#l16.649"></a><span id="l16.649">                                               const nsACString &amp;aDefaultValue,</span>
<a href="#l16.650"></a><span id="l16.650" class="difflineminus">-                                              nsACString &amp;aResult)</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineminus">-{</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineplus">+                                              nsACString &amp;aResult) {</span>
<a href="#l16.653"></a><span id="l16.653">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.654"></a><span id="l16.654">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.655"></a><span id="l16.655"> </span>
<a href="#l16.656"></a><span id="l16.656">   nsCString value;</span>
<a href="#l16.657"></a><span id="l16.657"> </span>
<a href="#l16.658"></a><span id="l16.658" class="difflineminus">-    /* unfortunately, there may be some prefs out there which look like (null) */</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineplus">+  /* unfortunately, there may be some prefs out there which look like (null) */</span>
<a href="#l16.660"></a><span id="l16.660">   if (NS_SUCCEEDED(m_DirectoryPrefs-&gt;GetCharPref(aName, value)) &amp;&amp;</span>
<a href="#l16.661"></a><span id="l16.661">       !value.EqualsLiteral(&quot;(null&quot;))</span>
<a href="#l16.662"></a><span id="l16.662">     aResult = value;</span>
<a href="#l16.663"></a><span id="l16.663">   else</span>
<a href="#l16.664"></a><span id="l16.664">     aResult = aDefaultValue;</span>
<a href="#l16.665"></a><span id="l16.665"> </span>
<a href="#l16.666"></a><span id="l16.666">   return NS_OK;</span>
<a href="#l16.667"></a><span id="l16.667"> }</span>
<a href="#l16.668"></a><span id="l16.668"> /*</span>
<a href="#l16.669"></a><span id="l16.669">  * Get localized unicode string pref from properties file, convert into an</span>
<a href="#l16.670"></a><span id="l16.670">  * UTF8 string since address book prefs store as UTF8 strings. So far there</span>
<a href="#l16.671"></a><span id="l16.671">  * are 2 default prefs stored in addressbook.properties.</span>
<a href="#l16.672"></a><span id="l16.672">  * &quot;ldap_2.servers.pab.description&quot;</span>
<a href="#l16.673"></a><span id="l16.673">  * &quot;ldap_2.servers.history.description&quot;</span>
<a href="#l16.674"></a><span id="l16.674">  */</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::GetLocalizedStringValue(const char *aName,</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineminus">-                                                       const nsACString &amp;aDefaultValue,</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineminus">-                                                       nsACString &amp;aResult)</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineminus">-{</span>
<a href="#l16.679"></a><span id="l16.679" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetLocalizedStringValue(</span>
<a href="#l16.680"></a><span id="l16.680" class="difflineplus">+    const char *aName, const nsACString &amp;aDefaultValue, nsACString &amp;aResult) {</span>
<a href="#l16.681"></a><span id="l16.681">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.682"></a><span id="l16.682">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.683"></a><span id="l16.683"> </span>
<a href="#l16.684"></a><span id="l16.684">   nsString wvalue;</span>
<a href="#l16.685"></a><span id="l16.685">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; locStr;</span>
<a href="#l16.686"></a><span id="l16.686"> </span>
<a href="#l16.687"></a><span id="l16.687" class="difflineminus">-  nsresult rv = m_DirectoryPrefs-&gt;GetComplexValue(aName,</span>
<a href="#l16.688"></a><span id="l16.688" class="difflineminus">-                                                  NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l16.689"></a><span id="l16.689" class="difflineminus">-                                                  getter_AddRefs(locStr));</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineminus">-  {</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineplus">+  nsresult rv = m_DirectoryPrefs-&gt;GetComplexValue(</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineplus">+      aName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(locStr));</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l16.695"></a><span id="l16.695">     rv = locStr-&gt;ToString(getter_Copies(wvalue));</span>
<a href="#l16.696"></a><span id="l16.696">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.697"></a><span id="l16.697">   }</span>
<a href="#l16.698"></a><span id="l16.698"> </span>
<a href="#l16.699"></a><span id="l16.699">   if (wvalue.IsEmpty())</span>
<a href="#l16.700"></a><span id="l16.700">     aResult = aDefaultValue;</span>
<a href="#l16.701"></a><span id="l16.701">   else</span>
<a href="#l16.702"></a><span id="l16.702">     CopyUTF16toUTF8(wvalue, aResult);</span>
<a href="#l16.703"></a><span id="l16.703"> </span>
<a href="#l16.704"></a><span id="l16.704">   return NS_OK;</span>
<a href="#l16.705"></a><span id="l16.705"> }</span>
<a href="#l16.706"></a><span id="l16.706"> </span>
<a href="#l16.707"></a><span id="l16.707" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetIntValue(const char *aName,</span>
<a href="#l16.708"></a><span id="l16.708" class="difflineminus">-                                          int32_t aValue)</span>
<a href="#l16.709"></a><span id="l16.709" class="difflineminus">-{</span>
<a href="#l16.710"></a><span id="l16.710" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetIntValue(const char *aName, int32_t aValue) {</span>
<a href="#l16.711"></a><span id="l16.711">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.712"></a><span id="l16.712">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.713"></a><span id="l16.713"> </span>
<a href="#l16.714"></a><span id="l16.714">   return m_DirectoryPrefs-&gt;SetIntPref(aName, aValue);</span>
<a href="#l16.715"></a><span id="l16.715"> }</span>
<a href="#l16.716"></a><span id="l16.716"> </span>
<a href="#l16.717"></a><span id="l16.717" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetBoolValue(const char *aName,</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineminus">-                                           bool aValue)</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineminus">-{</span>
<a href="#l16.720"></a><span id="l16.720" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetBoolValue(const char *aName, bool aValue) {</span>
<a href="#l16.721"></a><span id="l16.721">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.722"></a><span id="l16.722">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.723"></a><span id="l16.723"> </span>
<a href="#l16.724"></a><span id="l16.724">   return m_DirectoryPrefs-&gt;SetBoolPref(aName, aValue);</span>
<a href="#l16.725"></a><span id="l16.725"> }</span>
<a href="#l16.726"></a><span id="l16.726"> </span>
<a href="#l16.727"></a><span id="l16.727"> NS_IMETHODIMP nsAbDirProperty::SetStringValue(const char *aName,</span>
<a href="#l16.728"></a><span id="l16.728" class="difflineminus">-                                              const nsACString &amp;aValue)</span>
<a href="#l16.729"></a><span id="l16.729" class="difflineminus">-{</span>
<a href="#l16.730"></a><span id="l16.730" class="difflineplus">+                                              const nsACString &amp;aValue) {</span>
<a href="#l16.731"></a><span id="l16.731">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.732"></a><span id="l16.732">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.733"></a><span id="l16.733"> </span>
<a href="#l16.734"></a><span id="l16.734">   return m_DirectoryPrefs-&gt;SetCharPref(aName, aValue);</span>
<a href="#l16.735"></a><span id="l16.735"> }</span>
<a href="#l16.736"></a><span id="l16.736"> </span>
<a href="#l16.737"></a><span id="l16.737" class="difflineminus">-NS_IMETHODIMP nsAbDirProperty::SetLocalizedStringValue(const char *aName,</span>
<a href="#l16.738"></a><span id="l16.738" class="difflineminus">-                                                       const nsACString &amp;aValue)</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineminus">-{</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::SetLocalizedStringValue(</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineplus">+    const char *aName, const nsACString &amp;aValue) {</span>
<a href="#l16.742"></a><span id="l16.742">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l16.743"></a><span id="l16.743">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.744"></a><span id="l16.744"> </span>
<a href="#l16.745"></a><span id="l16.745">   nsresult rv;</span>
<a href="#l16.746"></a><span id="l16.746">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; locStr(</span>
<a href="#l16.747"></a><span id="l16.747" class="difflineminus">-    do_CreateInstance(NS_PREFLOCALIZEDSTRING_CONTRACTID, &amp;rv));</span>
<a href="#l16.748"></a><span id="l16.748" class="difflineplus">+      do_CreateInstance(NS_PREFLOCALIZEDSTRING_CONTRACTID, &amp;rv));</span>
<a href="#l16.749"></a><span id="l16.749">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.750"></a><span id="l16.750"> </span>
<a href="#l16.751"></a><span id="l16.751">   rv = locStr-&gt;SetData(NS_ConvertUTF8toUTF16(aValue));</span>
<a href="#l16.752"></a><span id="l16.752">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.753"></a><span id="l16.753"> </span>
<a href="#l16.754"></a><span id="l16.754" class="difflineminus">-  return m_DirectoryPrefs-&gt;SetComplexValue(aName,</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineminus">-                                           NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l16.756"></a><span id="l16.756" class="difflineminus">-                                           locStr);</span>
<a href="#l16.757"></a><span id="l16.757" class="difflineplus">+  return m_DirectoryPrefs-&gt;SetComplexValue(</span>
<a href="#l16.758"></a><span id="l16.758" class="difflineplus">+      aName, NS_GET_IID(nsIPrefLocalizedString), locStr);</span>
<a href="#l16.759"></a><span id="l16.759"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -15,55 +15,52 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsIAbDirectory.h&quot; /* include the interface we are going to support */</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsString.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">- /*</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  * Address Book Directory</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  */</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+/*</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * Address Book Directory</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ */</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-class nsAbDirProperty: public nsIAbDirectory,</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-                       public nsSupportsWeakReference</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-{</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-public:</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+class nsAbDirProperty : public nsIAbDirectory, public nsSupportsWeakReference {</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ public:</span>
<a href="#l17.25"></a><span id="l17.25">   nsAbDirProperty(void);</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27">   NS_DECL_ISUPPORTS</span>
<a href="#l17.28"></a><span id="l17.28">   NS_DECL_NSIABITEM</span>
<a href="#l17.29"></a><span id="l17.29">   NS_DECL_NSIABCOLLECTION</span>
<a href="#l17.30"></a><span id="l17.30">   NS_DECL_NSIABDIRECTORY</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-protected:</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ protected:</span>
<a href="#l17.34"></a><span id="l17.34">   virtual ~nsAbDirProperty(void);</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36">   /**</span>
<a href="#l17.37"></a><span id="l17.37">    * Initialise the directory prefs for this branch</span>
<a href="#l17.38"></a><span id="l17.38">    */</span>
<a href="#l17.39"></a><span id="l17.39">   nsresult InitDirectoryPrefs();</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41">   uint32_t m_LastModifiedDate;</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43">   nsString m_ListDirName;</span>
<a href="#l17.44"></a><span id="l17.44">   nsString m_ListName;</span>
<a href="#l17.45"></a><span id="l17.45">   nsString m_ListNickName;</span>
<a href="#l17.46"></a><span id="l17.46">   nsString m_Description;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-  bool     m_IsMailList;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+  bool m_IsMailList;</span>
<a href="#l17.49"></a><span id="l17.49"> </span>
<a href="#l17.50"></a><span id="l17.50">   nsCString mURI;</span>
<a href="#l17.51"></a><span id="l17.51">   nsCString mUID;</span>
<a href="#l17.52"></a><span id="l17.52">   nsCString mQueryString;</span>
<a href="#l17.53"></a><span id="l17.53">   nsCString mURINoQuery;</span>
<a href="#l17.54"></a><span id="l17.54">   bool mIsValidURI;</span>
<a href="#l17.55"></a><span id="l17.55">   bool mIsQueryURI;</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-</span>
<a href="#l17.58"></a><span id="l17.58">   /*</span>
<a href="#l17.59"></a><span id="l17.59">    * Note that any derived implementations should ensure that this item</span>
<a href="#l17.60"></a><span id="l17.60">    * (m_DirPrefId) is correctly initialised correctly</span>
<a href="#l17.61"></a><span id="l17.61">    */</span>
<a href="#l17.62"></a><span id="l17.62">   nsCString m_DirPrefId;  // ie,&quot;ldap_2.servers.pab&quot;</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64">   nsCOMPtr&lt;nsIPrefBranch&gt; m_DirectoryPrefs;</span>
<a href="#l17.65"></a><span id="l17.65">   nsCOMPtr&lt;nsIMutableArray&gt; m_AddressList;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryQuery.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirectoryQuery.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -10,519 +10,468 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsString.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbDirectoryQuerySimpleBooleanExpression, nsIAbBooleanExpression)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+NS_IMPL_ISUPPORTS(nsAbDirectoryQuerySimpleBooleanExpression,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+                  nsIAbBooleanExpression)</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-nsAbDirectoryQuerySimpleBooleanExpression::nsAbDirectoryQuerySimpleBooleanExpression() :</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-    mOperation (nsIAbBooleanOperationTypes::AND)</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-{</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-}</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+nsAbDirectoryQuerySimpleBooleanExpression::</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+    nsAbDirectoryQuerySimpleBooleanExpression()</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+    : mOperation(nsIAbBooleanOperationTypes::AND) {}</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-nsAbDirectoryQuerySimpleBooleanExpression::~nsAbDirectoryQuerySimpleBooleanExpression()</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-{</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-}</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+nsAbDirectoryQuerySimpleBooleanExpression::</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+    ~nsAbDirectoryQuerySimpleBooleanExpression() {}</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30"> /* attribute nsAbBooleanOperationType operation; */</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::GetOperation(nsAbBooleanOperationType *aOperation)</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-{</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-    if (!aOperation)</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::GetOperation(</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+    nsAbBooleanOperationType* aOperation) {</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+  if (!aOperation) return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-    *aOperation = mOperation;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  *aOperation = mOperation;</span>
<a href="#l18.41"></a><span id="l18.41"> </span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.44"></a><span id="l18.44"> }</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::SetOperation(nsAbBooleanOperationType aOperation)</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-{</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-    if (aOperation != nsIAbBooleanOperationTypes::AND &amp;&amp;</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-        aOperation != nsIAbBooleanOperationTypes::OR)</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::SetOperation(</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    nsAbBooleanOperationType aOperation) {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  if (aOperation != nsIAbBooleanOperationTypes::AND &amp;&amp;</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+      aOperation != nsIAbBooleanOperationTypes::OR)</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-    mOperation = aOperation;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  mOperation = aOperation;</span>
<a href="#l18.58"></a><span id="l18.58"> </span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.61"></a><span id="l18.61"> }</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63"> /* attribute nsIArray expressions; */</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::GetExpressions(nsIArray **aExpressions)</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-{</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-  if (!aExpressions)</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::GetExpressions(</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    nsIArray** aExpressions) {</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  if (!aExpressions) return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.71"></a><span id="l18.71"> </span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-  if (!mExpressions)</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-  {</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  if (!mExpressions) {</span>
<a href="#l18.75"></a><span id="l18.75">     mExpressions = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-    if (!mExpressions)</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+    if (!mExpressions) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.79"></a><span id="l18.79">   }</span>
<a href="#l18.80"></a><span id="l18.80"> </span>
<a href="#l18.81"></a><span id="l18.81">   NS_ADDREF(*aExpressions = mExpressions);</span>
<a href="#l18.82"></a><span id="l18.82">   return NS_OK;</span>
<a href="#l18.83"></a><span id="l18.83"> }</span>
<a href="#l18.84"></a><span id="l18.84"> </span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::SetExpressions(nsIArray *aExpressions)</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-{</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-  if (!aExpressions)</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQuerySimpleBooleanExpression::SetExpressions(</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+    nsIArray* aExpressions) {</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+  if (!aExpressions) return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.92"></a><span id="l18.92"> </span>
<a href="#l18.93"></a><span id="l18.93">   // Ensure all the items are of the right type.</span>
<a href="#l18.94"></a><span id="l18.94">   nsresult rv;</span>
<a href="#l18.95"></a><span id="l18.95">   uint32_t count;</span>
<a href="#l18.96"></a><span id="l18.96">   rv = aExpressions-&gt;GetLength(&amp;count);</span>
<a href="#l18.97"></a><span id="l18.97">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.98"></a><span id="l18.98"> </span>
<a href="#l18.99"></a><span id="l18.99">   nsCOMPtr&lt;nsIAbBooleanConditionString&gt; queryExpression;</span>
<a href="#l18.100"></a><span id="l18.100"> </span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-  {</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l18.104"></a><span id="l18.104">     queryExpression = do_QueryElementAt(aExpressions, i, &amp;rv);</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-      return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+    if (NS_FAILED(rv)) return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l18.108"></a><span id="l18.108">   }</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110">   // Values ok, so we can just save and return.</span>
<a href="#l18.111"></a><span id="l18.111">   mExpressions = aExpressions;</span>
<a href="#l18.112"></a><span id="l18.112"> </span>
<a href="#l18.113"></a><span id="l18.113">   return NS_OK;</span>
<a href="#l18.114"></a><span id="l18.114"> }</span>
<a href="#l18.115"></a><span id="l18.115"> </span>
<a href="#l18.116"></a><span id="l18.116"> NS_IMPL_ISUPPORTS(nsAbDirectoryQueryArguments, nsIAbDirectoryQueryArguments)</span>
<a href="#l18.117"></a><span id="l18.117"> </span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-nsAbDirectoryQueryArguments::nsAbDirectoryQueryArguments() :</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-    mQuerySubDirectories(true)</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-{</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-}</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+nsAbDirectoryQueryArguments::nsAbDirectoryQueryArguments()</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+    : mQuerySubDirectories(true) {}</span>
<a href="#l18.124"></a><span id="l18.124"> </span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-nsAbDirectoryQueryArguments::~nsAbDirectoryQueryArguments()</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-{</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-}</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+nsAbDirectoryQueryArguments::~nsAbDirectoryQueryArguments() {}</span>
<a href="#l18.129"></a><span id="l18.129"> </span>
<a href="#l18.130"></a><span id="l18.130"> /* attribute nsISupports matchItems; */</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::GetExpression(nsISupports** aExpression)</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-{</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-    if (!aExpression)</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::GetExpression(</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+    nsISupports** aExpression) {</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  if (!aExpression) return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.138"></a><span id="l18.138"> </span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-    NS_IF_ADDREF(*aExpression = mExpression);</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+  NS_IF_ADDREF(*aExpression = mExpression);</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.143"></a><span id="l18.143"> }</span>
<a href="#l18.144"></a><span id="l18.144"> </span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::SetExpression(nsISupports* aExpression)</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-{</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-    mExpression = aExpression;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::SetExpression(</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+    nsISupports* aExpression) {</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+  mExpression = aExpression;</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.153"></a><span id="l18.153"> }</span>
<a href="#l18.154"></a><span id="l18.154"> </span>
<a href="#l18.155"></a><span id="l18.155"> /* attribute boolean querySubDirectories; */</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::GetQuerySubDirectories(bool* aQuerySubDirectories)</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-{</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aQuerySubDirectories);</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-    *aQuerySubDirectories = mQuerySubDirectories;</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::GetQuerySubDirectories(</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+    bool* aQuerySubDirectories) {</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aQuerySubDirectories);</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+  *aQuerySubDirectories = mQuerySubDirectories;</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+}</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::SetQuerySubDirectories(</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+    bool aQuerySubDirectories) {</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+  mQuerySubDirectories = aQuerySubDirectories;</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+}</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::GetTypeSpecificArg(</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+    nsISupports** aArg) {</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aArg);</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+  NS_IF_ADDREF(*aArg = mTypeSpecificArg);</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineplus">+}</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineplus">+</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::SetTypeSpecificArg(</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+    nsISupports* aArg) {</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+  mTypeSpecificArg = aArg;</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+}</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::GetFilter(nsACString&amp; aFilter) {</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+  aFilter.Assign(mFilter);</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.191"></a><span id="l18.191"> }</span>
<a href="#l18.192"></a><span id="l18.192"> </span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::SetQuerySubDirectories(bool aQuerySubDirectories)</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-{</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-    mQuerySubDirectories = aQuerySubDirectories;</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryArguments::SetFilter(</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+    const nsACString&amp; aFilter) {</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+  mFilter.Assign(aFilter);</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+}</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+NS_IMPL_ISUPPORTS(nsAbDirectoryQueryPropertyValue,</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+                  nsIAbDirectoryQueryPropertyValue)</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+nsAbDirectoryQueryPropertyValue::nsAbDirectoryQueryPropertyValue() {}</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+nsAbDirectoryQueryPropertyValue::nsAbDirectoryQueryPropertyValue(</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+    const char* aName, const char16_t* aValue) {</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+  mName = aName;</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+  mValue = aValue;</span>
<a href="#l18.212"></a><span id="l18.212"> }</span>
<a href="#l18.213"></a><span id="l18.213"> </span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::GetTypeSpecificArg(nsISupports** aArg)</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-{</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aArg);</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineminus">-</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineminus">-    NS_IF_ADDREF(*aArg = mTypeSpecificArg);</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+nsAbDirectoryQueryPropertyValue::nsAbDirectoryQueryPropertyValue(</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+    const char* aName, nsISupports* aValueISupports) {</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+  mName = aName;</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+  mValueISupports = aValueISupports;</span>
<a href="#l18.224"></a><span id="l18.224"> }</span>
<a href="#l18.225"></a><span id="l18.225"> </span>
<a href="#l18.226"></a><span id="l18.226" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::SetTypeSpecificArg(nsISupports* aArg)</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineminus">-{</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineminus">-    mTypeSpecificArg = aArg;</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+nsAbDirectoryQueryPropertyValue::~nsAbDirectoryQueryPropertyValue() {}</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+/* read only attribute string name; */</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetName(char** aName) {</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+  *aName = mName.IsEmpty() ? 0 : ToNewCString(mName);</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineplus">+}</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+/* read only attribute wstring value; */</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetValue(char16_t** aValue) {</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+  *aValue = ToNewUnicode(mValue);</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineplus">+  if (!(*aValue))</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineplus">+  else</span>
<a href="#l18.244"></a><span id="l18.244">     return NS_OK;</span>
<a href="#l18.245"></a><span id="l18.245"> }</span>
<a href="#l18.246"></a><span id="l18.246"> </span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::GetFilter(nsACString &amp; aFilter)</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineminus">-{</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-    aFilter.Assign(mFilter);</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-}</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryArguments::SetFilter(const nsACString &amp; aFilter)</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineminus">-{</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineminus">-    mFilter.Assign(aFilter);</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineminus">-}</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbDirectoryQueryPropertyValue, nsIAbDirectoryQueryPropertyValue)</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineminus">-</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineminus">-nsAbDirectoryQueryPropertyValue::nsAbDirectoryQueryPropertyValue()</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineminus">-{</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineminus">-}</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineminus">-</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-nsAbDirectoryQueryPropertyValue::nsAbDirectoryQueryPropertyValue(const char* aName,</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineminus">-      const char16_t* aValue)</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineminus">-{</span>
<a href="#l18.268"></a><span id="l18.268" class="difflineminus">-    mName = aName;</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineminus">-    mValue = aValue;</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineminus">-}</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineplus">+/* readonly attribute nsISupports valueISupports; */</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetValueISupports(</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineplus">+    nsISupports** aValueISupports) {</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineplus">+  if (!mValueISupports) return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.275"></a><span id="l18.275"> </span>
<a href="#l18.276"></a><span id="l18.276" class="difflineminus">-nsAbDirectoryQueryPropertyValue::nsAbDirectoryQueryPropertyValue(const char* aName,</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineminus">-      nsISupports* aValueISupports)</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineminus">-{</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineminus">-    mName = aName;</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineminus">-    mValueISupports = aValueISupports;</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineminus">-}</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineminus">-</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineminus">-nsAbDirectoryQueryPropertyValue::~nsAbDirectoryQueryPropertyValue()</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-{</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineminus">-}</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-/* read only attribute string name; */</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetName(char*  *aName)</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineminus">-{</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-    *aName = mName.IsEmpty() ? 0 : ToNewCString(mName);</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineminus">-</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-}</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineminus">-/* read only attribute wstring value; */</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetValue(char16_t*  *aValue)</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineminus">-{</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineminus">-    *aValue = ToNewUnicode(mValue);</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineminus">-    if (!(*aValue))</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineminus">-    else</span>
<a href="#l18.302"></a><span id="l18.302" class="difflineminus">-        return NS_OK;</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineminus">-}</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineminus">-</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineminus">-/* readonly attribute nsISupports valueISupports; */</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetValueISupports(nsISupports*  *aValueISupports)</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineminus">-{</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineminus">-    if (!mValueISupports)</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineminus">-</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineminus">-    NS_IF_ADDREF(*aValueISupports = mValueISupports);</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+  NS_IF_ADDREF(*aValueISupports = mValueISupports);</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.315"></a><span id="l18.315"> }</span>
<a href="#l18.316"></a><span id="l18.316"> </span>
<a href="#l18.317"></a><span id="l18.317"> /* Implementation file */</span>
<a href="#l18.318"></a><span id="l18.318"> NS_IMPL_ISUPPORTS(nsAbDirectoryQuery, nsIAbDirectoryQuery)</span>
<a href="#l18.319"></a><span id="l18.319"> </span>
<a href="#l18.320"></a><span id="l18.320" class="difflineminus">-nsAbDirectoryQuery::nsAbDirectoryQuery()</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineminus">-{</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineminus">-}</span>
<a href="#l18.323"></a><span id="l18.323" class="difflineplus">+nsAbDirectoryQuery::nsAbDirectoryQuery() {}</span>
<a href="#l18.324"></a><span id="l18.324" class="difflineplus">+</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineplus">+nsAbDirectoryQuery::~nsAbDirectoryQuery() {}</span>
<a href="#l18.326"></a><span id="l18.326"> </span>
<a href="#l18.327"></a><span id="l18.327" class="difflineminus">-nsAbDirectoryQuery::~nsAbDirectoryQuery()</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineminus">-{</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineminus">-}</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineminus">-</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQuery::DoQuery(nsIAbDirectory *aDirectory,</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineminus">-                                          nsIAbDirectoryQueryArguments* arguments,</span>
<a href="#l18.333"></a><span id="l18.333" class="difflineminus">-                                          nsIAbDirSearchListener* listener,</span>
<a href="#l18.334"></a><span id="l18.334" class="difflineminus">-                                          int32_t resultLimit, int32_t timeOut,</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineminus">-                                          int32_t* _retval)</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineminus">-{</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQuery::DoQuery(</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineplus">+    nsIAbDirectory* aDirectory, nsIAbDirectoryQueryArguments* arguments,</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineplus">+    nsIAbDirSearchListener* listener, int32_t resultLimit, int32_t timeOut,</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineplus">+    int32_t* _retval) {</span>
<a href="#l18.341"></a><span id="l18.341">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l18.342"></a><span id="l18.342"> </span>
<a href="#l18.343"></a><span id="l18.343">   nsCOMPtr&lt;nsISupports&gt; supportsExpression;</span>
<a href="#l18.344"></a><span id="l18.344">   nsresult rv = arguments-&gt;GetExpression(getter_AddRefs(supportsExpression));</span>
<a href="#l18.345"></a><span id="l18.345">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.346"></a><span id="l18.346"> </span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-  nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression(do_QueryInterface(supportsExpression, &amp;rv));</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression(</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineplus">+      do_QueryInterface(supportsExpression, &amp;rv));</span>
<a href="#l18.350"></a><span id="l18.350">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.351"></a><span id="l18.351"> </span>
<a href="#l18.352"></a><span id="l18.352">   bool doSubDirectories;</span>
<a href="#l18.353"></a><span id="l18.353">   rv = arguments-&gt;GetQuerySubDirectories(&amp;doSubDirectories);</span>
<a href="#l18.354"></a><span id="l18.354">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.355"></a><span id="l18.355"> </span>
<a href="#l18.356"></a><span id="l18.356">   rv = query(aDirectory, expression, listener, doSubDirectories, &amp;resultLimit);</span>
<a href="#l18.357"></a><span id="l18.357"> </span>
<a href="#l18.358"></a><span id="l18.358">   rv = NS_FAILED(rv) ? queryError(listener) : queryFinished(listener);</span>
<a href="#l18.359"></a><span id="l18.359"> </span>
<a href="#l18.360"></a><span id="l18.360">   *_retval = 0;</span>
<a href="#l18.361"></a><span id="l18.361">   return rv;</span>
<a href="#l18.362"></a><span id="l18.362"> }</span>
<a href="#l18.363"></a><span id="l18.363"> </span>
<a href="#l18.364"></a><span id="l18.364"> /* void stopQuery (in long contextID); */</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQuery::StopQuery(int32_t contextID)</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineminus">-{</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineminus">-}</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineminus">-</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQuery::StopQuery(int32_t contextID) { return NS_OK; }</span>
<a href="#l18.371"></a><span id="l18.371"> </span>
<a href="#l18.372"></a><span id="l18.372"> nsresult nsAbDirectoryQuery::query(nsIAbDirectory* directory,</span>
<a href="#l18.373"></a><span id="l18.373">                                    nsIAbBooleanExpression* expression,</span>
<a href="#l18.374"></a><span id="l18.374">                                    nsIAbDirSearchListener* listener,</span>
<a href="#l18.375"></a><span id="l18.375">                                    bool doSubDirectories,</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineminus">-                                   int32_t* resultLimit)</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineminus">-{</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineminus">-  if (*resultLimit == 0)</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineplus">+                                   int32_t* resultLimit) {</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineplus">+  if (*resultLimit == 0) return NS_OK;</span>
<a href="#l18.382"></a><span id="l18.382"> </span>
<a href="#l18.383"></a><span id="l18.383">   nsresult rv = queryCards(directory, expression, listener, resultLimit);</span>
<a href="#l18.384"></a><span id="l18.384">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.385"></a><span id="l18.385"> </span>
<a href="#l18.386"></a><span id="l18.386" class="difflineminus">-  if (doSubDirectories &amp;&amp; resultLimit != 0)</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineminus">-  {</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineplus">+  if (doSubDirectories &amp;&amp; resultLimit != 0) {</span>
<a href="#l18.389"></a><span id="l18.389">     rv = queryChildren(directory, expression, listener, doSubDirectories,</span>
<a href="#l18.390"></a><span id="l18.390">                        resultLimit);</span>
<a href="#l18.391"></a><span id="l18.391">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.392"></a><span id="l18.392">   }</span>
<a href="#l18.393"></a><span id="l18.393"> </span>
<a href="#l18.394"></a><span id="l18.394">   return rv;</span>
<a href="#l18.395"></a><span id="l18.395"> }</span>
<a href="#l18.396"></a><span id="l18.396"> </span>
<a href="#l18.397"></a><span id="l18.397"> nsresult nsAbDirectoryQuery::queryChildren(nsIAbDirectory* directory,</span>
<a href="#l18.398"></a><span id="l18.398">                                            nsIAbBooleanExpression* expression,</span>
<a href="#l18.399"></a><span id="l18.399">                                            nsIAbDirSearchListener* listener,</span>
<a href="#l18.400"></a><span id="l18.400">                                            bool doSubDirectories,</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineminus">-                                           int32_t* resultLimit)</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineminus">-{</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineplus">+                                           int32_t* resultLimit) {</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l18.406"></a><span id="l18.406"> </span>
<a href="#l18.407"></a><span id="l18.407" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; subDirectories;</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-    rv = directory-&gt;GetChildNodes(getter_AddRefs(subDirectories));</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; subDirectories;</span>
<a href="#l18.410"></a><span id="l18.410" class="difflineplus">+  rv = directory-&gt;GetChildNodes(getter_AddRefs(subDirectories));</span>
<a href="#l18.411"></a><span id="l18.411" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.412"></a><span id="l18.412" class="difflineplus">+</span>
<a href="#l18.413"></a><span id="l18.413" class="difflineplus">+  bool hasMore;</span>
<a href="#l18.414"></a><span id="l18.414" class="difflineplus">+  while (NS_SUCCEEDED(rv = subDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l18.415"></a><span id="l18.415" class="difflineplus">+         hasMore) {</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineplus">+    rv = subDirectories-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l18.418"></a><span id="l18.418">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.419"></a><span id="l18.419"> </span>
<a href="#l18.420"></a><span id="l18.420" class="difflineminus">-    bool hasMore;</span>
<a href="#l18.421"></a><span id="l18.421" class="difflineminus">-    while (NS_SUCCEEDED(rv = subDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineminus">-    {</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l18.424"></a><span id="l18.424" class="difflineminus">-        rv = subDirectories-&gt;GetNext (getter_AddRefs (item));</span>
<a href="#l18.425"></a><span id="l18.425" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.426"></a><span id="l18.426" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; subDirectory(do_QueryInterface(item, &amp;rv));</span>
<a href="#l18.427"></a><span id="l18.427" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.428"></a><span id="l18.428"> </span>
<a href="#l18.429"></a><span id="l18.429" class="difflineminus">-        nsCOMPtr&lt;nsIAbDirectory&gt; subDirectory(do_QueryInterface(item, &amp;rv));</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.431"></a><span id="l18.431" class="difflineminus">-</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineminus">-        rv = query(subDirectory, expression, listener, doSubDirectories, resultLimit);</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineminus">-</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineminus">-    }</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.437"></a><span id="l18.437" class="difflineplus">+    rv = query(subDirectory, expression, listener, doSubDirectories,</span>
<a href="#l18.438"></a><span id="l18.438" class="difflineplus">+               resultLimit);</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.440"></a><span id="l18.440" class="difflineplus">+  }</span>
<a href="#l18.441"></a><span id="l18.441" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.442"></a><span id="l18.442"> }</span>
<a href="#l18.443"></a><span id="l18.443"> </span>
<a href="#l18.444"></a><span id="l18.444"> nsresult nsAbDirectoryQuery::queryCards(nsIAbDirectory* directory,</span>
<a href="#l18.445"></a><span id="l18.445">                                         nsIAbBooleanExpression* expression,</span>
<a href="#l18.446"></a><span id="l18.446">                                         nsIAbDirSearchListener* listener,</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineminus">-                                        int32_t* resultLimit)</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-{</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineplus">+                                        int32_t* resultLimit) {</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l18.452"></a><span id="l18.452"> </span>
<a href="#l18.453"></a><span id="l18.453" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; cards;</span>
<a href="#l18.454"></a><span id="l18.454" class="difflineminus">-    rv = directory-&gt;GetChildCards(getter_AddRefs(cards));</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineminus">-    {</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineminus">-        if (rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-        else</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineminus">-            return NS_OK;</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineminus">-    }</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; cards;</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineplus">+  rv = directory-&gt;GetChildCards(getter_AddRefs(cards));</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineplus">+    if (rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineplus">+    else</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineplus">+      return NS_OK;</span>
<a href="#l18.469"></a><span id="l18.469" class="difflineplus">+  }</span>
<a href="#l18.470"></a><span id="l18.470"> </span>
<a href="#l18.471"></a><span id="l18.471" class="difflineminus">-    if (!cards)</span>
<a href="#l18.472"></a><span id="l18.472" class="difflineminus">-        return NS_OK;</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineplus">+  if (!cards) return NS_OK;</span>
<a href="#l18.474"></a><span id="l18.474"> </span>
<a href="#l18.475"></a><span id="l18.475" class="difflineminus">-    bool more;</span>
<a href="#l18.476"></a><span id="l18.476" class="difflineminus">-    while (NS_SUCCEEDED(cards-&gt;HasMoreElements(&amp;more)) &amp;&amp; more)</span>
<a href="#l18.477"></a><span id="l18.477" class="difflineminus">-    {</span>
<a href="#l18.478"></a><span id="l18.478" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineminus">-        rv = cards-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineplus">+  bool more;</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineplus">+  while (NS_SUCCEEDED(cards-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineplus">+    rv = cards-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l18.485"></a><span id="l18.485" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.486"></a><span id="l18.486"> </span>
<a href="#l18.487"></a><span id="l18.487" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(item, &amp;rv));</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineminus">-</span>
<a href="#l18.490"></a><span id="l18.490" class="difflineminus">-        rv = matchCard (card, expression, listener, resultLimit);</span>
<a href="#l18.491"></a><span id="l18.491" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.492"></a><span id="l18.492" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(item, &amp;rv));</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.494"></a><span id="l18.494"> </span>
<a href="#l18.495"></a><span id="l18.495" class="difflineminus">-        if (*resultLimit == 0)</span>
<a href="#l18.496"></a><span id="l18.496" class="difflineminus">-            return NS_OK;</span>
<a href="#l18.497"></a><span id="l18.497" class="difflineminus">-    }</span>
<a href="#l18.498"></a><span id="l18.498" class="difflineplus">+    rv = matchCard(card, expression, listener, resultLimit);</span>
<a href="#l18.499"></a><span id="l18.499" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.500"></a><span id="l18.500"> </span>
<a href="#l18.501"></a><span id="l18.501" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.502"></a><span id="l18.502" class="difflineplus">+    if (*resultLimit == 0) return NS_OK;</span>
<a href="#l18.503"></a><span id="l18.503" class="difflineplus">+  }</span>
<a href="#l18.504"></a><span id="l18.504" class="difflineplus">+</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.506"></a><span id="l18.506"> }</span>
<a href="#l18.507"></a><span id="l18.507"> </span>
<a href="#l18.508"></a><span id="l18.508"> nsresult nsAbDirectoryQuery::matchCard(nsIAbCard* card,</span>
<a href="#l18.509"></a><span id="l18.509">                                        nsIAbBooleanExpression* expression,</span>
<a href="#l18.510"></a><span id="l18.510">                                        nsIAbDirSearchListener* listener,</span>
<a href="#l18.511"></a><span id="l18.511" class="difflineminus">-                                       int32_t* resultLimit)</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineminus">-{</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineminus">-    bool matchFound = false;</span>
<a href="#l18.514"></a><span id="l18.514" class="difflineminus">-    nsresult rv = matchCardExpression(card, expression, &amp;matchFound);</span>
<a href="#l18.515"></a><span id="l18.515" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.516"></a><span id="l18.516" class="difflineplus">+                                       int32_t* resultLimit) {</span>
<a href="#l18.517"></a><span id="l18.517" class="difflineplus">+  bool matchFound = false;</span>
<a href="#l18.518"></a><span id="l18.518" class="difflineplus">+  nsresult rv = matchCardExpression(card, expression, &amp;matchFound);</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.520"></a><span id="l18.520"> </span>
<a href="#l18.521"></a><span id="l18.521" class="difflineminus">-    if (matchFound)</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineminus">-    {</span>
<a href="#l18.523"></a><span id="l18.523" class="difflineminus">-        (*resultLimit)--;</span>
<a href="#l18.524"></a><span id="l18.524" class="difflineminus">-        rv = queryMatch(card, listener);</span>
<a href="#l18.525"></a><span id="l18.525" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.526"></a><span id="l18.526" class="difflineminus">-    }</span>
<a href="#l18.527"></a><span id="l18.527" class="difflineplus">+  if (matchFound) {</span>
<a href="#l18.528"></a><span id="l18.528" class="difflineplus">+    (*resultLimit)--;</span>
<a href="#l18.529"></a><span id="l18.529" class="difflineplus">+    rv = queryMatch(card, listener);</span>
<a href="#l18.530"></a><span id="l18.530" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.531"></a><span id="l18.531" class="difflineplus">+  }</span>
<a href="#l18.532"></a><span id="l18.532"> </span>
<a href="#l18.533"></a><span id="l18.533" class="difflineminus">-    return rv;</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineplus">+  return rv;</span>
<a href="#l18.535"></a><span id="l18.535"> }</span>
<a href="#l18.536"></a><span id="l18.536"> </span>
<a href="#l18.537"></a><span id="l18.537" class="difflineminus">-nsresult nsAbDirectoryQuery::matchCardExpression(nsIAbCard* card,</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineminus">-                                                 nsIAbBooleanExpression* expression,</span>
<a href="#l18.539"></a><span id="l18.539" class="difflineminus">-                                                 bool* result)</span>
<a href="#l18.540"></a><span id="l18.540" class="difflineminus">-{</span>
<a href="#l18.541"></a><span id="l18.541" class="difflineminus">-    nsAbBooleanOperationType operation;</span>
<a href="#l18.542"></a><span id="l18.542" class="difflineminus">-    nsresult rv = expression-&gt;GetOperation (&amp;operation);</span>
<a href="#l18.543"></a><span id="l18.543" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineplus">+nsresult nsAbDirectoryQuery::matchCardExpression(</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineplus">+    nsIAbCard* card, nsIAbBooleanExpression* expression, bool* result) {</span>
<a href="#l18.546"></a><span id="l18.546" class="difflineplus">+  nsAbBooleanOperationType operation;</span>
<a href="#l18.547"></a><span id="l18.547" class="difflineplus">+  nsresult rv = expression-&gt;GetOperation(&amp;operation);</span>
<a href="#l18.548"></a><span id="l18.548" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.549"></a><span id="l18.549"> </span>
<a href="#l18.550"></a><span id="l18.550" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; childExpressions;</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineminus">-    rv = expression-&gt;GetExpressions (getter_AddRefs (childExpressions));</span>
<a href="#l18.552"></a><span id="l18.552" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.553"></a><span id="l18.553" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; childExpressions;</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineplus">+  rv = expression-&gt;GetExpressions(getter_AddRefs(childExpressions));</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.556"></a><span id="l18.556"> </span>
<a href="#l18.557"></a><span id="l18.557" class="difflineminus">-    uint32_t count;</span>
<a href="#l18.558"></a><span id="l18.558" class="difflineminus">-    rv = childExpressions-&gt;GetLength(&amp;count);</span>
<a href="#l18.559"></a><span id="l18.559" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.560"></a><span id="l18.560" class="difflineplus">+  uint32_t count;</span>
<a href="#l18.561"></a><span id="l18.561" class="difflineplus">+  rv = childExpressions-&gt;GetLength(&amp;count);</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.563"></a><span id="l18.563"> </span>
<a href="#l18.564"></a><span id="l18.564" class="difflineminus">-    if (operation == nsIAbBooleanOperationTypes::NOT &amp;&amp;</span>
<a href="#l18.565"></a><span id="l18.565" class="difflineminus">-        count &gt; 1)</span>
<a href="#l18.566"></a><span id="l18.566" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l18.567"></a><span id="l18.567" class="difflineplus">+  if (operation == nsIAbBooleanOperationTypes::NOT &amp;&amp; count &gt; 1)</span>
<a href="#l18.568"></a><span id="l18.568" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l18.569"></a><span id="l18.569"> </span>
<a href="#l18.570"></a><span id="l18.570" class="difflineminus">-    bool value = *result = false;</span>
<a href="#l18.571"></a><span id="l18.571" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanConditionString&gt; childCondition;</span>
<a href="#l18.572"></a><span id="l18.572" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; childExpression;</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineplus">+  bool value = *result = false;</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanConditionString&gt; childCondition;</span>
<a href="#l18.575"></a><span id="l18.575" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; childExpression;</span>
<a href="#l18.576"></a><span id="l18.576"> </span>
<a href="#l18.577"></a><span id="l18.577" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l18.578"></a><span id="l18.578" class="difflineminus">-    {</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineminus">-        childCondition = do_QueryElementAt(childExpressions, i, &amp;rv);</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineminus">-        {</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineminus">-            rv = matchCardCondition (card, childCondition, &amp;value);</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.584"></a><span id="l18.584" class="difflineminus">-        }</span>
<a href="#l18.585"></a><span id="l18.585" class="difflineminus">-        else</span>
<a href="#l18.586"></a><span id="l18.586" class="difflineminus">-        {</span>
<a href="#l18.587"></a><span id="l18.587" class="difflineminus">-            childExpression = do_QueryElementAt(childExpressions, i, &amp;rv);</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l18.589"></a><span id="l18.589" class="difflineminus">-            {</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineminus">-                rv = matchCardExpression (card, childExpression, &amp;value);</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineminus">-                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineminus">-            }</span>
<a href="#l18.593"></a><span id="l18.593" class="difflineminus">-            else</span>
<a href="#l18.594"></a><span id="l18.594" class="difflineminus">-                return NS_ERROR_FAILURE;</span>
<a href="#l18.595"></a><span id="l18.595" class="difflineminus">-        }</span>
<a href="#l18.596"></a><span id="l18.596" class="difflineminus">-        if (operation == nsIAbBooleanOperationTypes::OR &amp;&amp; value)</span>
<a href="#l18.597"></a><span id="l18.597" class="difflineminus">-            break;</span>
<a href="#l18.598"></a><span id="l18.598" class="difflineminus">-        else if (operation == nsIAbBooleanOperationTypes::AND &amp;&amp; !value)</span>
<a href="#l18.599"></a><span id="l18.599" class="difflineminus">-            break;</span>
<a href="#l18.600"></a><span id="l18.600" class="difflineminus">-        else if (operation == nsIAbBooleanOperationTypes::NOT)</span>
<a href="#l18.601"></a><span id="l18.601" class="difflineminus">-            value = !value;</span>
<a href="#l18.602"></a><span id="l18.602" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l18.603"></a><span id="l18.603" class="difflineplus">+    childCondition = do_QueryElementAt(childExpressions, i, &amp;rv);</span>
<a href="#l18.604"></a><span id="l18.604" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.605"></a><span id="l18.605" class="difflineplus">+      rv = matchCardCondition(card, childCondition, &amp;value);</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.607"></a><span id="l18.607" class="difflineplus">+    } else {</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineplus">+      childExpression = do_QueryElementAt(childExpressions, i, &amp;rv);</span>
<a href="#l18.609"></a><span id="l18.609" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.610"></a><span id="l18.610" class="difflineplus">+        rv = matchCardExpression(card, childExpression, &amp;value);</span>
<a href="#l18.611"></a><span id="l18.611" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.612"></a><span id="l18.612" class="difflineplus">+      } else</span>
<a href="#l18.613"></a><span id="l18.613" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l18.614"></a><span id="l18.614">     }</span>
<a href="#l18.615"></a><span id="l18.615" class="difflineminus">-    *result = value;</span>
<a href="#l18.616"></a><span id="l18.616" class="difflineplus">+    if (operation == nsIAbBooleanOperationTypes::OR &amp;&amp; value)</span>
<a href="#l18.617"></a><span id="l18.617" class="difflineplus">+      break;</span>
<a href="#l18.618"></a><span id="l18.618" class="difflineplus">+    else if (operation == nsIAbBooleanOperationTypes::AND &amp;&amp; !value)</span>
<a href="#l18.619"></a><span id="l18.619" class="difflineplus">+      break;</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineplus">+    else if (operation == nsIAbBooleanOperationTypes::NOT)</span>
<a href="#l18.621"></a><span id="l18.621" class="difflineplus">+      value = !value;</span>
<a href="#l18.622"></a><span id="l18.622" class="difflineplus">+  }</span>
<a href="#l18.623"></a><span id="l18.623" class="difflineplus">+  *result = value;</span>
<a href="#l18.624"></a><span id="l18.624"> </span>
<a href="#l18.625"></a><span id="l18.625" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.627"></a><span id="l18.627"> }</span>
<a href="#l18.628"></a><span id="l18.628"> </span>
<a href="#l18.629"></a><span id="l18.629" class="difflineminus">-nsresult nsAbDirectoryQuery::matchCardCondition(nsIAbCard* card,</span>
<a href="#l18.630"></a><span id="l18.630" class="difflineminus">-                                                nsIAbBooleanConditionString* condition,</span>
<a href="#l18.631"></a><span id="l18.631" class="difflineminus">-                                                bool* matchFound)</span>
<a href="#l18.632"></a><span id="l18.632" class="difflineminus">-{</span>
<a href="#l18.633"></a><span id="l18.633" class="difflineminus">-    nsAbBooleanConditionType conditionType;</span>
<a href="#l18.634"></a><span id="l18.634" class="difflineminus">-    nsresult rv = condition-&gt;GetCondition (&amp;conditionType);</span>
<a href="#l18.635"></a><span id="l18.635" class="difflineplus">+nsresult nsAbDirectoryQuery::matchCardCondition(</span>
<a href="#l18.636"></a><span id="l18.636" class="difflineplus">+    nsIAbCard* card, nsIAbBooleanConditionString* condition, bool* matchFound) {</span>
<a href="#l18.637"></a><span id="l18.637" class="difflineplus">+  nsAbBooleanConditionType conditionType;</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineplus">+  nsresult rv = condition-&gt;GetCondition(&amp;conditionType);</span>
<a href="#l18.639"></a><span id="l18.639" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.640"></a><span id="l18.640" class="difflineplus">+</span>
<a href="#l18.641"></a><span id="l18.641" class="difflineplus">+  nsCString name;</span>
<a href="#l18.642"></a><span id="l18.642" class="difflineplus">+  rv = condition-&gt;GetName(getter_Copies(name));</span>
<a href="#l18.643"></a><span id="l18.643" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.644"></a><span id="l18.644" class="difflineplus">+</span>
<a href="#l18.645"></a><span id="l18.645" class="difflineplus">+  if (name.Equals(&quot;card:nsIAbCard&quot;)) {</span>
<a href="#l18.646"></a><span id="l18.646" class="difflineplus">+    *matchFound = (conditionType == nsIAbBooleanConditionTypes::Exists);</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineplus">+  }</span>
<a href="#l18.649"></a><span id="l18.649" class="difflineplus">+</span>
<a href="#l18.650"></a><span id="l18.650" class="difflineplus">+  nsString matchValue;</span>
<a href="#l18.651"></a><span id="l18.651" class="difflineplus">+  rv = condition-&gt;GetValue(getter_Copies(matchValue));</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.653"></a><span id="l18.653" class="difflineplus">+</span>
<a href="#l18.654"></a><span id="l18.654" class="difflineplus">+  if (name.EqualsLiteral(&quot;IsMailList&quot;)) {</span>
<a href="#l18.655"></a><span id="l18.655" class="difflineplus">+    bool isMailList;</span>
<a href="#l18.656"></a><span id="l18.656" class="difflineplus">+    rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l18.657"></a><span id="l18.657">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.658"></a><span id="l18.658"> </span>
<a href="#l18.659"></a><span id="l18.659" class="difflineminus">-    nsCString name;</span>
<a href="#l18.660"></a><span id="l18.660" class="difflineminus">-    rv = condition-&gt;GetName (getter_Copies (name));</span>
<a href="#l18.661"></a><span id="l18.661" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.662"></a><span id="l18.662" class="difflineplus">+    // Only equals is supported.</span>
<a href="#l18.663"></a><span id="l18.663" class="difflineplus">+    if (conditionType != nsIAbBooleanConditionTypes::Is)</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l18.665"></a><span id="l18.665"> </span>
<a href="#l18.666"></a><span id="l18.666" class="difflineminus">-    if (name.Equals (&quot;card:nsIAbCard&quot;))</span>
<a href="#l18.667"></a><span id="l18.667" class="difflineminus">-    {</span>
<a href="#l18.668"></a><span id="l18.668" class="difflineminus">-      *matchFound = (conditionType == nsIAbBooleanConditionTypes::Exists);</span>
<a href="#l18.669"></a><span id="l18.669" class="difflineminus">-      return NS_OK;</span>
<a href="#l18.670"></a><span id="l18.670" class="difflineminus">-    }</span>
<a href="#l18.671"></a><span id="l18.671" class="difflineminus">-</span>
<a href="#l18.672"></a><span id="l18.672" class="difflineminus">-    nsString matchValue;</span>
<a href="#l18.673"></a><span id="l18.673" class="difflineminus">-    rv = condition-&gt;GetValue (getter_Copies (matchValue));</span>
<a href="#l18.674"></a><span id="l18.674" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.675"></a><span id="l18.675" class="difflineplus">+    *matchFound = isMailList ? matchValue.EqualsLiteral(&quot;TRUE&quot;)</span>
<a href="#l18.676"></a><span id="l18.676" class="difflineplus">+                             : matchValue.EqualsLiteral(&quot;FALSE&quot;);</span>
<a href="#l18.677"></a><span id="l18.677" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.678"></a><span id="l18.678" class="difflineplus">+  }</span>
<a href="#l18.679"></a><span id="l18.679"> </span>
<a href="#l18.680"></a><span id="l18.680" class="difflineminus">-    if (name.EqualsLiteral(&quot;IsMailList&quot;))</span>
<a href="#l18.681"></a><span id="l18.681" class="difflineminus">-    {</span>
<a href="#l18.682"></a><span id="l18.682" class="difflineminus">-      bool isMailList;</span>
<a href="#l18.683"></a><span id="l18.683" class="difflineminus">-      rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l18.684"></a><span id="l18.684" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.685"></a><span id="l18.685" class="difflineminus">-</span>
<a href="#l18.686"></a><span id="l18.686" class="difflineminus">-      // Only equals is supported.</span>
<a href="#l18.687"></a><span id="l18.687" class="difflineminus">-      if (conditionType != nsIAbBooleanConditionTypes::Is)</span>
<a href="#l18.688"></a><span id="l18.688" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l18.689"></a><span id="l18.689" class="difflineplus">+  nsString value;</span>
<a href="#l18.690"></a><span id="l18.690" class="difflineplus">+  (void)card-&gt;GetPropertyAsAString(name.get(), value);</span>
<a href="#l18.691"></a><span id="l18.691"> </span>
<a href="#l18.692"></a><span id="l18.692" class="difflineminus">-      *matchFound = isMailList ? matchValue.EqualsLiteral(&quot;TRUE&quot;) :</span>
<a href="#l18.693"></a><span id="l18.693" class="difflineminus">-                                 matchValue.EqualsLiteral(&quot;FALSE&quot;);</span>
<a href="#l18.694"></a><span id="l18.694" class="difflineminus">-      return NS_OK;</span>
<a href="#l18.695"></a><span id="l18.695" class="difflineminus">-    }</span>
<a href="#l18.696"></a><span id="l18.696" class="difflineminus">-</span>
<a href="#l18.697"></a><span id="l18.697" class="difflineminus">-    nsString value;</span>
<a href="#l18.698"></a><span id="l18.698" class="difflineminus">-    (void)card-&gt;GetPropertyAsAString(name.get(), value);</span>
<a href="#l18.699"></a><span id="l18.699" class="difflineminus">-</span>
<a href="#l18.700"></a><span id="l18.700" class="difflineminus">-    if (value.IsEmpty())</span>
<a href="#l18.701"></a><span id="l18.701" class="difflineminus">-    {</span>
<a href="#l18.702"></a><span id="l18.702" class="difflineminus">-      *matchFound = (conditionType == nsIAbBooleanConditionTypes::DoesNotExist) ?</span>
<a href="#l18.703"></a><span id="l18.703" class="difflineminus">-          true : false;</span>
<a href="#l18.704"></a><span id="l18.704" class="difflineminus">-      return NS_OK;</span>
<a href="#l18.705"></a><span id="l18.705" class="difflineminus">-    }</span>
<a href="#l18.706"></a><span id="l18.706" class="difflineplus">+  if (value.IsEmpty()) {</span>
<a href="#l18.707"></a><span id="l18.707" class="difflineplus">+    *matchFound = (conditionType == nsIAbBooleanConditionTypes::DoesNotExist)</span>
<a href="#l18.708"></a><span id="l18.708" class="difflineplus">+                      ? true</span>
<a href="#l18.709"></a><span id="l18.709" class="difflineplus">+                      : false;</span>
<a href="#l18.710"></a><span id="l18.710" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.711"></a><span id="l18.711" class="difflineplus">+  }</span>
<a href="#l18.712"></a><span id="l18.712"> </span>
<a href="#l18.713"></a><span id="l18.713" class="difflineminus">-    /* TODO</span>
<a href="#l18.714"></a><span id="l18.714" class="difflineminus">-     * What about allowing choice between case insensitive</span>
<a href="#l18.715"></a><span id="l18.715" class="difflineminus">-     * and case sensitive comparisons?</span>
<a href="#l18.716"></a><span id="l18.716" class="difflineminus">-     *</span>
<a href="#l18.717"></a><span id="l18.717" class="difflineminus">-     */</span>
<a href="#l18.718"></a><span id="l18.718" class="difflineminus">-    switch (conditionType)</span>
<a href="#l18.719"></a><span id="l18.719" class="difflineminus">-    {</span>
<a href="#l18.720"></a><span id="l18.720" class="difflineminus">-        case nsIAbBooleanConditionTypes::Exists:</span>
<a href="#l18.721"></a><span id="l18.721" class="difflineminus">-            *matchFound = true;</span>
<a href="#l18.722"></a><span id="l18.722" class="difflineminus">-            break;</span>
<a href="#l18.723"></a><span id="l18.723" class="difflineminus">-        case nsIAbBooleanConditionTypes::Contains:</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineminus">-            *matchFound = CaseInsensitiveFindInReadable(matchValue, value);</span>
<a href="#l18.725"></a><span id="l18.725" class="difflineminus">-            break;</span>
<a href="#l18.726"></a><span id="l18.726" class="difflineminus">-        case nsIAbBooleanConditionTypes::DoesNotContain:</span>
<a href="#l18.727"></a><span id="l18.727" class="difflineminus">-            *matchFound = !CaseInsensitiveFindInReadable(matchValue, value);</span>
<a href="#l18.728"></a><span id="l18.728" class="difflineminus">-            break;</span>
<a href="#l18.729"></a><span id="l18.729" class="difflineminus">-        case nsIAbBooleanConditionTypes::Is:</span>
<a href="#l18.730"></a><span id="l18.730" class="difflineminus">-            *matchFound = value.Equals(matchValue, nsCaseInsensitiveStringComparator());</span>
<a href="#l18.731"></a><span id="l18.731" class="difflineminus">-            break;</span>
<a href="#l18.732"></a><span id="l18.732" class="difflineminus">-        case nsIAbBooleanConditionTypes::IsNot:</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineminus">-            *matchFound = !value.Equals(matchValue, nsCaseInsensitiveStringComparator());</span>
<a href="#l18.734"></a><span id="l18.734" class="difflineminus">-            break;</span>
<a href="#l18.735"></a><span id="l18.735" class="difflineminus">-        case nsIAbBooleanConditionTypes::BeginsWith:</span>
<a href="#l18.736"></a><span id="l18.736" class="difflineminus">-            *matchFound = StringBeginsWith(value, matchValue, nsCaseInsensitiveStringComparator());</span>
<a href="#l18.737"></a><span id="l18.737" class="difflineminus">-            break;</span>
<a href="#l18.738"></a><span id="l18.738" class="difflineminus">-        case nsIAbBooleanConditionTypes::LessThan:</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineminus">-            *matchFound = Compare(value, matchValue, nsCaseInsensitiveStringComparator()) &lt; 0;</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineminus">-            break;</span>
<a href="#l18.741"></a><span id="l18.741" class="difflineminus">-        case nsIAbBooleanConditionTypes::GreaterThan:</span>
<a href="#l18.742"></a><span id="l18.742" class="difflineminus">-            *matchFound = Compare(value, matchValue, nsCaseInsensitiveStringComparator()) &gt; 0;</span>
<a href="#l18.743"></a><span id="l18.743" class="difflineminus">-            break;</span>
<a href="#l18.744"></a><span id="l18.744" class="difflineminus">-        case nsIAbBooleanConditionTypes::EndsWith:</span>
<a href="#l18.745"></a><span id="l18.745" class="difflineminus">-            *matchFound = StringEndsWith(value, matchValue, nsCaseInsensitiveStringComparator());</span>
<a href="#l18.746"></a><span id="l18.746" class="difflineminus">-            break;</span>
<a href="#l18.747"></a><span id="l18.747" class="difflineminus">-        case nsIAbBooleanConditionTypes::SoundsLike:</span>
<a href="#l18.748"></a><span id="l18.748" class="difflineminus">-        case nsIAbBooleanConditionTypes::RegExp:</span>
<a href="#l18.749"></a><span id="l18.749" class="difflineminus">-            *matchFound = false;</span>
<a href="#l18.750"></a><span id="l18.750" class="difflineminus">-            break;</span>
<a href="#l18.751"></a><span id="l18.751" class="difflineminus">-        default:</span>
<a href="#l18.752"></a><span id="l18.752" class="difflineminus">-            *matchFound = false;</span>
<a href="#l18.753"></a><span id="l18.753" class="difflineminus">-    }</span>
<a href="#l18.754"></a><span id="l18.754" class="difflineplus">+  /* TODO</span>
<a href="#l18.755"></a><span id="l18.755" class="difflineplus">+   * What about allowing choice between case insensitive</span>
<a href="#l18.756"></a><span id="l18.756" class="difflineplus">+   * and case sensitive comparisons?</span>
<a href="#l18.757"></a><span id="l18.757" class="difflineplus">+   *</span>
<a href="#l18.758"></a><span id="l18.758" class="difflineplus">+   */</span>
<a href="#l18.759"></a><span id="l18.759" class="difflineplus">+  switch (conditionType) {</span>
<a href="#l18.760"></a><span id="l18.760" class="difflineplus">+    case nsIAbBooleanConditionTypes::Exists:</span>
<a href="#l18.761"></a><span id="l18.761" class="difflineplus">+      *matchFound = true;</span>
<a href="#l18.762"></a><span id="l18.762" class="difflineplus">+      break;</span>
<a href="#l18.763"></a><span id="l18.763" class="difflineplus">+    case nsIAbBooleanConditionTypes::Contains:</span>
<a href="#l18.764"></a><span id="l18.764" class="difflineplus">+      *matchFound = CaseInsensitiveFindInReadable(matchValue, value);</span>
<a href="#l18.765"></a><span id="l18.765" class="difflineplus">+      break;</span>
<a href="#l18.766"></a><span id="l18.766" class="difflineplus">+    case nsIAbBooleanConditionTypes::DoesNotContain:</span>
<a href="#l18.767"></a><span id="l18.767" class="difflineplus">+      *matchFound = !CaseInsensitiveFindInReadable(matchValue, value);</span>
<a href="#l18.768"></a><span id="l18.768" class="difflineplus">+      break;</span>
<a href="#l18.769"></a><span id="l18.769" class="difflineplus">+    case nsIAbBooleanConditionTypes::Is:</span>
<a href="#l18.770"></a><span id="l18.770" class="difflineplus">+      *matchFound =</span>
<a href="#l18.771"></a><span id="l18.771" class="difflineplus">+          value.Equals(matchValue, nsCaseInsensitiveStringComparator());</span>
<a href="#l18.772"></a><span id="l18.772" class="difflineplus">+      break;</span>
<a href="#l18.773"></a><span id="l18.773" class="difflineplus">+    case nsIAbBooleanConditionTypes::IsNot:</span>
<a href="#l18.774"></a><span id="l18.774" class="difflineplus">+      *matchFound =</span>
<a href="#l18.775"></a><span id="l18.775" class="difflineplus">+          !value.Equals(matchValue, nsCaseInsensitiveStringComparator());</span>
<a href="#l18.776"></a><span id="l18.776" class="difflineplus">+      break;</span>
<a href="#l18.777"></a><span id="l18.777" class="difflineplus">+    case nsIAbBooleanConditionTypes::BeginsWith:</span>
<a href="#l18.778"></a><span id="l18.778" class="difflineplus">+      *matchFound = StringBeginsWith(value, matchValue,</span>
<a href="#l18.779"></a><span id="l18.779" class="difflineplus">+                                     nsCaseInsensitiveStringComparator());</span>
<a href="#l18.780"></a><span id="l18.780" class="difflineplus">+      break;</span>
<a href="#l18.781"></a><span id="l18.781" class="difflineplus">+    case nsIAbBooleanConditionTypes::LessThan:</span>
<a href="#l18.782"></a><span id="l18.782" class="difflineplus">+      *matchFound =</span>
<a href="#l18.783"></a><span id="l18.783" class="difflineplus">+          Compare(value, matchValue, nsCaseInsensitiveStringComparator()) &lt; 0;</span>
<a href="#l18.784"></a><span id="l18.784" class="difflineplus">+      break;</span>
<a href="#l18.785"></a><span id="l18.785" class="difflineplus">+    case nsIAbBooleanConditionTypes::GreaterThan:</span>
<a href="#l18.786"></a><span id="l18.786" class="difflineplus">+      *matchFound =</span>
<a href="#l18.787"></a><span id="l18.787" class="difflineplus">+          Compare(value, matchValue, nsCaseInsensitiveStringComparator()) &gt; 0;</span>
<a href="#l18.788"></a><span id="l18.788" class="difflineplus">+      break;</span>
<a href="#l18.789"></a><span id="l18.789" class="difflineplus">+    case nsIAbBooleanConditionTypes::EndsWith:</span>
<a href="#l18.790"></a><span id="l18.790" class="difflineplus">+      *matchFound = StringEndsWith(value, matchValue,</span>
<a href="#l18.791"></a><span id="l18.791" class="difflineplus">+                                   nsCaseInsensitiveStringComparator());</span>
<a href="#l18.792"></a><span id="l18.792" class="difflineplus">+      break;</span>
<a href="#l18.793"></a><span id="l18.793" class="difflineplus">+    case nsIAbBooleanConditionTypes::SoundsLike:</span>
<a href="#l18.794"></a><span id="l18.794" class="difflineplus">+    case nsIAbBooleanConditionTypes::RegExp:</span>
<a href="#l18.795"></a><span id="l18.795" class="difflineplus">+      *matchFound = false;</span>
<a href="#l18.796"></a><span id="l18.796" class="difflineplus">+      break;</span>
<a href="#l18.797"></a><span id="l18.797" class="difflineplus">+    default:</span>
<a href="#l18.798"></a><span id="l18.798" class="difflineplus">+      *matchFound = false;</span>
<a href="#l18.799"></a><span id="l18.799" class="difflineplus">+  }</span>
<a href="#l18.800"></a><span id="l18.800"> </span>
<a href="#l18.801"></a><span id="l18.801" class="difflineminus">-    return rv;</span>
<a href="#l18.802"></a><span id="l18.802" class="difflineplus">+  return rv;</span>
<a href="#l18.803"></a><span id="l18.803"> }</span>
<a href="#l18.804"></a><span id="l18.804"> </span>
<a href="#l18.805"></a><span id="l18.805"> nsresult nsAbDirectoryQuery::queryMatch(nsIAbCard* card,</span>
<a href="#l18.806"></a><span id="l18.806" class="difflineminus">-    nsIAbDirSearchListener* listener)</span>
<a href="#l18.807"></a><span id="l18.807" class="difflineminus">-{</span>
<a href="#l18.808"></a><span id="l18.808" class="difflineplus">+                                        nsIAbDirSearchListener* listener) {</span>
<a href="#l18.809"></a><span id="l18.809">   return listener-&gt;OnSearchFoundCard(card);</span>
<a href="#l18.810"></a><span id="l18.810"> }</span>
<a href="#l18.811"></a><span id="l18.811"> </span>
<a href="#l18.812"></a><span id="l18.812" class="difflineminus">-nsresult nsAbDirectoryQuery::queryFinished(nsIAbDirSearchListener* listener)</span>
<a href="#l18.813"></a><span id="l18.813" class="difflineminus">-{</span>
<a href="#l18.814"></a><span id="l18.814" class="difflineminus">-    return listener-&gt;OnSearchFinished(nsIAbDirectoryQueryResultListener::queryResultComplete, EmptyString());</span>
<a href="#l18.815"></a><span id="l18.815" class="difflineplus">+nsresult nsAbDirectoryQuery::queryFinished(nsIAbDirSearchListener* listener) {</span>
<a href="#l18.816"></a><span id="l18.816" class="difflineplus">+  return listener-&gt;OnSearchFinished(</span>
<a href="#l18.817"></a><span id="l18.817" class="difflineplus">+      nsIAbDirectoryQueryResultListener::queryResultComplete, EmptyString());</span>
<a href="#l18.818"></a><span id="l18.818"> }</span>
<a href="#l18.819"></a><span id="l18.819"> </span>
<a href="#l18.820"></a><span id="l18.820" class="difflineminus">-nsresult nsAbDirectoryQuery::queryError(nsIAbDirSearchListener* listener)</span>
<a href="#l18.821"></a><span id="l18.821" class="difflineminus">-{</span>
<a href="#l18.822"></a><span id="l18.822" class="difflineminus">-    return listener-&gt;OnSearchFinished(nsIAbDirectoryQueryResultListener::queryResultError, EmptyString());</span>
<a href="#l18.823"></a><span id="l18.823" class="difflineplus">+nsresult nsAbDirectoryQuery::queryError(nsIAbDirSearchListener* listener) {</span>
<a href="#l18.824"></a><span id="l18.824" class="difflineplus">+  return listener-&gt;OnSearchFinished(</span>
<a href="#l18.825"></a><span id="l18.825" class="difflineplus">+      nsIAbDirectoryQueryResultListener::queryResultError, EmptyString());</span>
<a href="#l18.826"></a><span id="l18.826"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryQuery.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirectoryQuery.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -8,106 +8,93 @@</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsIAbDirectoryQuery.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsString.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsIArray.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-class nsAbDirectoryQuerySimpleBooleanExpression : public nsIAbBooleanExpression</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-public:</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-    NS_DECL_NSIABBOOLEANEXPRESSION</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+class nsAbDirectoryQuerySimpleBooleanExpression</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+    : public nsIAbBooleanExpression {</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+ public:</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  NS_DECL_NSIABBOOLEANEXPRESSION</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-    nsAbDirectoryQuerySimpleBooleanExpression();</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+  nsAbDirectoryQuerySimpleBooleanExpression();</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-private:</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-    virtual ~nsAbDirectoryQuerySimpleBooleanExpression();</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+ private:</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+  virtual ~nsAbDirectoryQuerySimpleBooleanExpression();</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-public:</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; mExpressions;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-    nsAbBooleanOperationType mOperation;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+ public:</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; mExpressions;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  nsAbBooleanOperationType mOperation;</span>
<a href="#l19.37"></a><span id="l19.37"> };</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+class nsAbDirectoryQueryArguments : public nsIAbDirectoryQueryArguments {</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+ public:</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  NS_DECL_NSIABDIRECTORYQUERYARGUMENTS</span>
<a href="#l19.43"></a><span id="l19.43"> </span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-class nsAbDirectoryQueryArguments : public nsIAbDirectoryQueryArguments</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-{</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-public:</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-    NS_DECL_NSIABDIRECTORYQUERYARGUMENTS</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-    nsAbDirectoryQueryArguments();</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+  nsAbDirectoryQueryArguments();</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-private:</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-    virtual ~nsAbDirectoryQueryArguments();</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+ private:</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  virtual ~nsAbDirectoryQueryArguments();</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-protected:</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; mExpression;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; mTypeSpecificArg;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-    bool mQuerySubDirectories;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-    nsCString mFilter;</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+ protected:</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; mExpression;</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; mTypeSpecificArg;</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+  bool mQuerySubDirectories;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  nsCString mFilter;</span>
<a href="#l19.68"></a><span id="l19.68"> };</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-class nsAbDirectoryQueryPropertyValue : public nsIAbDirectoryQueryPropertyValue</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-{</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-public:</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-    NS_DECL_NSIABDIRECTORYQUERYPROPERTYVALUE</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+class nsAbDirectoryQueryPropertyValue</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+    : public nsIAbDirectoryQueryPropertyValue {</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+ public:</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+  NS_DECL_NSIABDIRECTORYQUERYPROPERTYVALUE</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-    nsAbDirectoryQueryPropertyValue();</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-    nsAbDirectoryQueryPropertyValue(const char* aName,</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-          const char16_t* aValue);</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-    nsAbDirectoryQueryPropertyValue(const char* aName,</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-          nsISupports* aValueISupports);</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+  nsAbDirectoryQueryPropertyValue();</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+  nsAbDirectoryQueryPropertyValue(const char* aName, const char16_t* aValue);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+  nsAbDirectoryQueryPropertyValue(const char* aName,</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+                                  nsISupports* aValueISupports);</span>
<a href="#l19.91"></a><span id="l19.91"> </span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-protected:</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-    virtual ~nsAbDirectoryQueryPropertyValue();</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-    nsCString mName;</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-    nsString mValue;</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; mValueISupports;</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+ protected:</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+  virtual ~nsAbDirectoryQueryPropertyValue();</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+  nsCString mName;</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+  nsString mValue;</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; mValueISupports;</span>
<a href="#l19.102"></a><span id="l19.102"> };</span>
<a href="#l19.103"></a><span id="l19.103"> </span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+class nsAbDirectoryQuery : public nsIAbDirectoryQuery {</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+ public:</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+  NS_DECL_NSIABDIRECTORYQUERY</span>
<a href="#l19.108"></a><span id="l19.108"> </span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-class nsAbDirectoryQuery : public nsIAbDirectoryQuery</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-{</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-public:</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-    NS_DECL_NSIABDIRECTORYQUERY</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-    nsAbDirectoryQuery();</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+  nsAbDirectoryQuery();</span>
<a href="#l19.117"></a><span id="l19.117"> </span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-protected:</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-    virtual ~nsAbDirectoryQuery();</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-    nsresult query(nsIAbDirectory* directory,</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-                   nsIAbBooleanExpression* expression,</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-                   nsIAbDirSearchListener* listener,</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-                   bool doSubDirectories,</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-                   int32_t* resultLimit);</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-    nsresult queryChildren(nsIAbDirectory* directory,</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-                           nsIAbBooleanExpression* expression,</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-                           nsIAbDirSearchListener* listener,</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-                           bool doSubDirectories,</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-                           int32_t* resultLimit);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-    nsresult queryCards(nsIAbDirectory* directory,</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-                        nsIAbBooleanExpression* expression,</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-                        nsIAbDirSearchListener* listener,</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-                        int32_t* resultLimit);</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-    nsresult matchCard(nsIAbCard* card,</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-                       nsIAbBooleanExpression* expression,</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-                       nsIAbDirSearchListener* listener,</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-                       int32_t* resultLimit);</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-    nsresult matchCardExpression(nsIAbCard* card,</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-                                 nsIAbBooleanExpression* expression,</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-                                 bool* result);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-    nsresult matchCardCondition(nsIAbCard* card,</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-                                nsIAbBooleanConditionString* condition,</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-                                bool* matchFound);</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+ protected:</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+  virtual ~nsAbDirectoryQuery();</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+  nsresult query(nsIAbDirectory* directory, nsIAbBooleanExpression* expression,</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+                 nsIAbDirSearchListener* listener, bool doSubDirectories,</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+                 int32_t* resultLimit);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+  nsresult queryChildren(nsIAbDirectory* directory,</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+                         nsIAbBooleanExpression* expression,</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+                         nsIAbDirSearchListener* listener,</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+                         bool doSubDirectories, int32_t* resultLimit);</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+  nsresult queryCards(nsIAbDirectory* directory,</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+                      nsIAbBooleanExpression* expression,</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+                      nsIAbDirSearchListener* listener, int32_t* resultLimit);</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+  nsresult matchCard(nsIAbCard* card, nsIAbBooleanExpression* expression,</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+                     nsIAbDirSearchListener* listener, int32_t* resultLimit);</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+  nsresult matchCardExpression(nsIAbCard* card,</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+                               nsIAbBooleanExpression* expression,</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+                               bool* result);</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+  nsresult matchCardCondition(nsIAbCard* card,</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+                              nsIAbBooleanConditionString* condition,</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+                              bool* matchFound);</span>
<a href="#l19.164"></a><span id="l19.164"> </span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-    nsresult queryMatch (nsIAbCard* card,</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-        nsIAbDirSearchListener* listener);</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-    nsresult queryFinished(nsIAbDirSearchListener* listener);</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-    nsresult queryError(nsIAbDirSearchListener* listener);</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineplus">+  nsresult queryMatch(nsIAbCard* card, nsIAbDirSearchListener* listener);</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+  nsresult queryFinished(nsIAbDirSearchListener* listener);</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+  nsresult queryError(nsIAbDirSearchListener* listener);</span>
<a href="#l19.172"></a><span id="l19.172"> };</span>
<a href="#l19.173"></a><span id="l19.173"> </span>
<a href="#l19.174"></a><span id="l19.174"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirectoryQueryProxy.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,33 +1,25 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l20.5"></a><span id="l20.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsAbDirectoryQueryProxy.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbDirectoryQueryProxy, nsIAbDirectoryQueryProxy, nsIAbDirectoryQuery)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+NS_IMPL_ISUPPORTS(nsAbDirectoryQueryProxy, nsIAbDirectoryQueryProxy,</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+                  nsIAbDirectoryQuery)</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-nsAbDirectoryQueryProxy::nsAbDirectoryQueryProxy() :</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-    mInitiated (false)</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-{</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-}</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+nsAbDirectoryQueryProxy::nsAbDirectoryQueryProxy() : mInitiated(false) {}</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-nsAbDirectoryQueryProxy::~nsAbDirectoryQueryProxy()</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-{</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-}</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+nsAbDirectoryQueryProxy::~nsAbDirectoryQueryProxy() {}</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27"> /* void initiate (in nsIAbDirectory directory); */</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryQueryProxy::Initiate()</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-{</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-    if (mInitiated)</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-        return NS_OK;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+NS_IMETHODIMP nsAbDirectoryQueryProxy::Initiate() {</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+  if (mInitiated) return NS_OK;</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-    mDirectoryQuery = new nsAbDirectoryQuery();</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+  mDirectoryQuery = new nsAbDirectoryQuery();</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-    mInitiated = true;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  mInitiated = true;</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-    return NS_OK;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  return NS_OK;</span>
<a href="#l20.43"></a><span id="l20.43"> }</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirectoryQueryProxy.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -4,24 +4,23 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> #ifndef nsAbDirectoryQueryProxy_h__</span>
<a href="#l21.7"></a><span id="l21.7"> #define nsAbDirectoryQueryProxy_h__</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsIAbDirectoryQueryProxy.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-class nsAbDirectoryQueryProxy : public nsIAbDirectoryQueryProxy</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-{</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-public:</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-    NS_FORWARD_NSIABDIRECTORYQUERY(mDirectoryQuery-&gt;)</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-    NS_DECL_NSIABDIRECTORYQUERYPROXY</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+class nsAbDirectoryQueryProxy : public nsIAbDirectoryQueryProxy {</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+ public:</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+  NS_FORWARD_NSIABDIRECTORYQUERY(mDirectoryQuery-&gt;)</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+  NS_DECL_NSIABDIRECTORYQUERYPROXY</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-    nsAbDirectoryQueryProxy();</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+  nsAbDirectoryQueryProxy();</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-protected:</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-    virtual ~nsAbDirectoryQueryProxy();</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-    bool mInitiated;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectoryQuery&gt; mDirectoryQuery;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+ protected:</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  virtual ~nsAbDirectoryQueryProxy();</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+  bool mInitiated;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectoryQuery&gt; mDirectoryQuery;</span>
<a href="#l21.35"></a><span id="l21.35"> };</span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -15,23 +15,19 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> #include &lt;stdio.h&gt;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> #define kDNColumn &quot;DN&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-nsAbLDAPCard::nsAbLDAPCard()</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-}</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+nsAbLDAPCard::nsAbLDAPCard() {}</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-nsAbLDAPCard::~nsAbLDAPCard()</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-{</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-}</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+nsAbLDAPCard::~nsAbLDAPCard() {}</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22"> NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPCard, nsAbCardProperty, nsIAbLDAPCard)</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> /* Retrieves the changes to the LDAP card and stores them in an LDAP</span>
<a href="#l22.25"></a><span id="l22.25">  * update message.</span>
<a href="#l22.26"></a><span id="l22.26">  *</span>
<a href="#l22.27"></a><span id="l22.27">  * Calling this method changes the LDAP card, it updates the</span>
<a href="#l22.28"></a><span id="l22.28">  * meta-properties (m_*) to reflect what the LDAP contents will be once</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineat">@@ -43,61 +39,54 @@ NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPCard</span>
<a href="#l22.30"></a><span id="l22.30">  * XXX: We need to take care when integrating this code with the asynchronous</span>
<a href="#l22.31"></a><span id="l22.31">  * update dialogs, as the current code in nsAbLDAPDirectory has a problem</span>
<a href="#l22.32"></a><span id="l22.32">  * when an update fails: the modified card still gets stored and shown to</span>
<a href="#l22.33"></a><span id="l22.33">  * the user instead of being discarded. There is one especially tricky case:</span>
<a href="#l22.34"></a><span id="l22.34">  * when you do an update on a card which changes its DN, you have two</span>
<a href="#l22.35"></a><span id="l22.35">  * operations (rename, then update the other attributes). If the rename</span>
<a href="#l22.36"></a><span id="l22.36">  * operation succeeds and not the update of the attributes, you are</span>
<a href="#l22.37"></a><span id="l22.37">  * &quot;somewhere in between&quot; the original card and the updated card.</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-*/</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+ */</span>
<a href="#l22.40"></a><span id="l22.40"> NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessageInfo(</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  nsIAbLDAPAttributeMap *aAttributeMap,</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-  const uint32_t aClassCount,</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-  const char **aClasses,</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-  int32_t aType,</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-  nsIArray **aLDAPAddMessageInfo)</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-{</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+    nsIAbLDAPAttributeMap *aAttributeMap, const uint32_t aClassCount,</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    const char **aClasses, int32_t aType, nsIArray **aLDAPAddMessageInfo) {</span>
<a href="#l22.49"></a><span id="l22.49">   NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l22.50"></a><span id="l22.50">   NS_ENSURE_ARG_POINTER(aClasses);</span>
<a href="#l22.51"></a><span id="l22.51">   NS_ENSURE_ARG_POINTER(aLDAPAddMessageInfo);</span>
<a href="#l22.52"></a><span id="l22.52"> </span>
<a href="#l22.53"></a><span id="l22.53">   nsresult rv;</span>
<a href="#l22.54"></a><span id="l22.54">   nsCOMPtr&lt;nsIMutableArray&gt; modArray =</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l22.57"></a><span id="l22.57">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.58"></a><span id="l22.58"> </span>
<a href="#l22.59"></a><span id="l22.59">   // Add any missing object classes. We never remove any object</span>
<a href="#l22.60"></a><span id="l22.60">   // classes: if an entry has additional object classes, it's probably</span>
<a href="#l22.61"></a><span id="l22.61">   // for a good reason.</span>
<a href="#l22.62"></a><span id="l22.62">   nsAutoCString oclass;</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-  for (uint32_t i = 0; i &lt; aClassCount; ++i)</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-  {</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+  for (uint32_t i = 0; i &lt; aClassCount; ++i) {</span>
<a href="#l22.66"></a><span id="l22.66">     oclass.Assign(nsDependentCString(aClasses[i]));</span>
<a href="#l22.67"></a><span id="l22.67">     ToLowerCase(oclass);</span>
<a href="#l22.68"></a><span id="l22.68"> </span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    if (!m_objectClass.Contains(oclass))</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-    {</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+    if (!m_objectClass.Contains(oclass)) {</span>
<a href="#l22.72"></a><span id="l22.72">       m_objectClass.AppendElement(oclass);</span>
<a href="#l22.73"></a><span id="l22.73">       printf(&quot;LDAP : adding objectClass %s\n&quot;, oclass.get());</span>
<a href="#l22.74"></a><span id="l22.74">     }</span>
<a href="#l22.75"></a><span id="l22.75">   }</span>
<a href="#l22.76"></a><span id="l22.76"> </span>
<a href="#l22.77"></a><span id="l22.77">   nsCOMPtr&lt;nsILDAPModification&gt; mod =</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l22.80"></a><span id="l22.80">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.81"></a><span id="l22.81"> </span>
<a href="#l22.82"></a><span id="l22.82">   nsCOMPtr&lt;nsIMutableArray&gt; values =</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-    do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l22.85"></a><span id="l22.85">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.86"></a><span id="l22.86"> </span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_objectClass.Length(); ++i)</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-  {</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_objectClass.Length(); ++i) {</span>
<a href="#l22.90"></a><span id="l22.90">     nsCOMPtr&lt;nsILDAPBERValue&gt; value =</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-      do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+        do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l22.93"></a><span id="l22.93">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.94"></a><span id="l22.94"> </span>
<a href="#l22.95"></a><span id="l22.95">     rv = value-&gt;SetFromUTF8(m_objectClass.ElementAt(i));</span>
<a href="#l22.96"></a><span id="l22.96">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.97"></a><span id="l22.97"> </span>
<a href="#l22.98"></a><span id="l22.98">     rv = values-&gt;AppendElement(value);</span>
<a href="#l22.99"></a><span id="l22.99">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.100"></a><span id="l22.100">   }</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineat">@@ -105,82 +94,75 @@ NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessa</span>
<a href="#l22.102"></a><span id="l22.102">   rv = mod-&gt;SetUpModification(aType, NS_LITERAL_CSTRING(&quot;objectClass&quot;), values);</span>
<a href="#l22.103"></a><span id="l22.103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.104"></a><span id="l22.104"> </span>
<a href="#l22.105"></a><span id="l22.105">   modArray-&gt;AppendElement(mod);</span>
<a href="#l22.106"></a><span id="l22.106"> </span>
<a href="#l22.107"></a><span id="l22.107">   // Add card properties</span>
<a href="#l22.108"></a><span id="l22.108">   CharPtrArrayGuard props;</span>
<a href="#l22.109"></a><span id="l22.109">   rv = aAttributeMap-&gt;GetAllCardProperties(props.GetSizeAddr(),</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-    props.GetArrayAddr());</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+                                           props.GetArrayAddr());</span>
<a href="#l22.112"></a><span id="l22.112">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.113"></a><span id="l22.113"> </span>
<a href="#l22.114"></a><span id="l22.114">   nsAutoCString attr;</span>
<a href="#l22.115"></a><span id="l22.115">   nsCString propvalue;</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-  for (uint32_t i = 0; i &lt; props.GetSize(); ++i)</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-  {</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+  for (uint32_t i = 0; i &lt; props.GetSize(); ++i) {</span>
<a href="#l22.119"></a><span id="l22.119">     // Skip some attributes that don't map to LDAP.</span>
<a href="#l22.120"></a><span id="l22.120">     //</span>
<a href="#l22.121"></a><span id="l22.121">     // BirthYear : by default this is mapped to 'birthyear',</span>
<a href="#l22.122"></a><span id="l22.122">     // which is not part of mozillaAbPersonAlpha</span>
<a href="#l22.123"></a><span id="l22.123">     //</span>
<a href="#l22.124"></a><span id="l22.124">     // LastModifiedDate : by default this is mapped to 'modifytimestamp',</span>
<a href="#l22.125"></a><span id="l22.125">     // which cannot be modified</span>
<a href="#l22.126"></a><span id="l22.126">     //</span>
<a href="#l22.127"></a><span id="l22.127">     // PreferMailFormat : by default this is mapped to 'mozillaUseHtmlMail',</span>
<a href="#l22.128"></a><span id="l22.128">     // which is a boolean, not plaintext/html/unknown</span>
<a href="#l22.129"></a><span id="l22.129">     if (!strcmp(props[i], kBirthYearProperty) ||</span>
<a href="#l22.130"></a><span id="l22.130">         !strcmp(props[i], kLastModifiedDateProperty) ||</span>
<a href="#l22.131"></a><span id="l22.131">         !strcmp(props[i], kPreferMailFormatProperty))</span>
<a href="#l22.132"></a><span id="l22.132">       continue;</span>
<a href="#l22.133"></a><span id="l22.133"> </span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-    rv = aAttributeMap-&gt;GetFirstAttribute(nsDependentCString(props[i]),</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-      attr);</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+    rv = aAttributeMap-&gt;GetFirstAttribute(nsDependentCString(props[i]), attr);</span>
<a href="#l22.137"></a><span id="l22.137">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.138"></a><span id="l22.138">     ToLowerCase(attr);</span>
<a href="#l22.139"></a><span id="l22.139"> </span>
<a href="#l22.140"></a><span id="l22.140">     // If the property is not mapped to an attribute, skip it.</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-    if (attr.IsEmpty())</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-      continue;</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+    if (attr.IsEmpty()) continue;</span>
<a href="#l22.144"></a><span id="l22.144"> </span>
<a href="#l22.145"></a><span id="l22.145">     nsCOMPtr&lt;nsILDAPModification&gt; mod =</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-      do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+        do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l22.148"></a><span id="l22.148">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.149"></a><span id="l22.149"> </span>
<a href="#l22.150"></a><span id="l22.150">     size_t index = m_attributes.IndexOf(attr);</span>
<a href="#l22.151"></a><span id="l22.151"> </span>
<a href="#l22.152"></a><span id="l22.152">     rv = GetPropertyAsAUTF8String(props[i], propvalue);</span>
<a href="#l22.153"></a><span id="l22.153"> </span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp;!propvalue.IsEmpty())</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-    {</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !propvalue.IsEmpty()) {</span>
<a href="#l22.157"></a><span id="l22.157">       // If the new value is not empty, add/update it</span>
<a href="#l22.158"></a><span id="l22.158">       nsCOMPtr&lt;nsILDAPBERValue&gt; value =</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+          do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l22.161"></a><span id="l22.161">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.162"></a><span id="l22.162"> </span>
<a href="#l22.163"></a><span id="l22.163">       rv = value-&gt;SetFromUTF8(propvalue);</span>
<a href="#l22.164"></a><span id="l22.164">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.165"></a><span id="l22.165"> </span>
<a href="#l22.166"></a><span id="l22.166">       rv = mod-&gt;SetUpModificationOneValue(aType, attr, value);</span>
<a href="#l22.167"></a><span id="l22.167">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.168"></a><span id="l22.168"> </span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-      printf(&quot;LDAP : setting attribute %s (%s) to '%s'\n&quot;, attr.get(),</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-        props[i], propvalue.get());</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+      printf(&quot;LDAP : setting attribute %s (%s) to '%s'\n&quot;, attr.get(), props[i],</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+             propvalue.get());</span>
<a href="#l22.173"></a><span id="l22.173">       modArray-&gt;AppendElement(mod);</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineminus">-      if (index != m_attributes.NoIndex)</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-        m_attributes.AppendElement(attr);</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+      if (index != m_attributes.NoIndex) m_attributes.AppendElement(attr);</span>
<a href="#l22.177"></a><span id="l22.177"> </span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-    }</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-    else if (aType == nsILDAPModification::MOD_REPLACE &amp;&amp;</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-             index != m_attributes.NoIndex)</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-    {</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+    } else if (aType == nsILDAPModification::MOD_REPLACE &amp;&amp;</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+               index != m_attributes.NoIndex) {</span>
<a href="#l22.184"></a><span id="l22.184">       // If the new value is empty, we are performing an update</span>
<a href="#l22.185"></a><span id="l22.185">       // and the attribute was previously set, clear it</span>
<a href="#l22.186"></a><span id="l22.186">       nsCOMPtr&lt;nsIMutableArray&gt; novalues =</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineminus">-        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l22.189"></a><span id="l22.189">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.190"></a><span id="l22.190"> </span>
<a href="#l22.191"></a><span id="l22.191">       rv = mod-&gt;SetUpModification(aType, attr, novalues);</span>
<a href="#l22.192"></a><span id="l22.192">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.193"></a><span id="l22.193"> </span>
<a href="#l22.194"></a><span id="l22.194">       printf(&quot;LDAP : removing attribute %s (%s)\n&quot;, attr.get(), props[i]);</span>
<a href="#l22.195"></a><span id="l22.195">       modArray-&gt;AppendElement(mod);</span>
<a href="#l22.196"></a><span id="l22.196">       m_attributes.RemoveElementAt(index);</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineat">@@ -190,108 +172,98 @@ NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessa</span>
<a href="#l22.198"></a><span id="l22.198">   modArray.forget(aLDAPAddMessageInfo);</span>
<a href="#l22.199"></a><span id="l22.199"> </span>
<a href="#l22.200"></a><span id="l22.200">   return NS_OK;</span>
<a href="#l22.201"></a><span id="l22.201"> }</span>
<a href="#l22.202"></a><span id="l22.202"> </span>
<a href="#l22.203"></a><span id="l22.203"> NS_IMETHODIMP nsAbLDAPCard::BuildRdn(nsIAbLDAPAttributeMap *aAttributeMap,</span>
<a href="#l22.204"></a><span id="l22.204">                                      const uint32_t aAttrCount,</span>
<a href="#l22.205"></a><span id="l22.205">                                      const char **aAttributes,</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineminus">-                                     nsACString &amp;aRdn)</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-{</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+                                     nsACString &amp;aRdn) {</span>
<a href="#l22.209"></a><span id="l22.209">   NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l22.210"></a><span id="l22.210">   NS_ENSURE_ARG_POINTER(aAttributes);</span>
<a href="#l22.211"></a><span id="l22.211"> </span>
<a href="#l22.212"></a><span id="l22.212">   nsresult rv;</span>
<a href="#l22.213"></a><span id="l22.213">   nsCString attr;</span>
<a href="#l22.214"></a><span id="l22.214">   nsAutoCString prop;</span>
<a href="#l22.215"></a><span id="l22.215">   nsCString propvalue;</span>
<a href="#l22.216"></a><span id="l22.216"> </span>
<a href="#l22.217"></a><span id="l22.217">   aRdn.Truncate();</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-  for (uint32_t i = 0; i &lt; aAttrCount; ++i)</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-  {</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+  for (uint32_t i = 0; i &lt; aAttrCount; ++i) {</span>
<a href="#l22.221"></a><span id="l22.221">     attr.Assign(nsDependentCString(aAttributes[i]));</span>
<a href="#l22.222"></a><span id="l22.222"> </span>
<a href="#l22.223"></a><span id="l22.223">     // Lookup the property corresponding to the attribute</span>
<a href="#l22.224"></a><span id="l22.224">     rv = aAttributeMap-&gt;GetProperty(attr, prop);</span>
<a href="#l22.225"></a><span id="l22.225">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.226"></a><span id="l22.226"> </span>
<a href="#l22.227"></a><span id="l22.227">     // Get the property value</span>
<a href="#l22.228"></a><span id="l22.228">     rv = GetPropertyAsAUTF8String(prop.get(), propvalue);</span>
<a href="#l22.229"></a><span id="l22.229"> </span>
<a href="#l22.230"></a><span id="l22.230">     // XXX The case where an attribute needed to build the Relative</span>
<a href="#l22.231"></a><span id="l22.231">     // Distinguished Name is not set needs to be handled by the caller,</span>
<a href="#l22.232"></a><span id="l22.232">     // so as to let the user know what is missing.</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineminus">-    if (NS_FAILED(rv) || propvalue.IsEmpty())</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-    {</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineplus">+    if (NS_FAILED(rv) || propvalue.IsEmpty()) {</span>
<a href="#l22.236"></a><span id="l22.236">       NS_ERROR(&quot;nsAbLDAPCard::BuildRdn: a required attribute is not set&quot;);</span>
<a href="#l22.237"></a><span id="l22.237">       return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l22.238"></a><span id="l22.238">     }</span>
<a href="#l22.239"></a><span id="l22.239"> </span>
<a href="#l22.240"></a><span id="l22.240">     aRdn.Append(attr);</span>
<a href="#l22.241"></a><span id="l22.241">     aRdn.Append('=');</span>
<a href="#l22.242"></a><span id="l22.242">     aRdn.Append(propvalue);</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineminus">-    if (i &lt; aAttrCount - 1)</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineminus">-      aRdn.Append('+');</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineplus">+    if (i &lt; aAttrCount - 1) aRdn.Append('+');</span>
<a href="#l22.246"></a><span id="l22.246">   }</span>
<a href="#l22.247"></a><span id="l22.247">   return NS_OK;</span>
<a href="#l22.248"></a><span id="l22.248"> }</span>
<a href="#l22.249"></a><span id="l22.249"> </span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::GetDn(nsACString &amp;aDN)</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineminus">-{</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+NS_IMETHODIMP nsAbLDAPCard::GetDn(nsACString &amp;aDN) {</span>
<a href="#l22.253"></a><span id="l22.253">   return GetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l22.254"></a><span id="l22.254"> }</span>
<a href="#l22.255"></a><span id="l22.255"> </span>
<a href="#l22.256"></a><span id="l22.256" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::SetDn(const nsACString &amp;aDN)</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineminus">-{</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineplus">+NS_IMETHODIMP nsAbLDAPCard::SetDn(const nsACString &amp;aDN) {</span>
<a href="#l22.259"></a><span id="l22.259">   SetLocalId(aDN);</span>
<a href="#l22.260"></a><span id="l22.260">   return SetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l22.261"></a><span id="l22.261"> }</span>
<a href="#l22.262"></a><span id="l22.262"> </span>
<a href="#l22.263"></a><span id="l22.263" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::SetMetaProperties(nsILDAPMessage *aMessage)</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineminus">-{</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineplus">+NS_IMETHODIMP nsAbLDAPCard::SetMetaProperties(nsILDAPMessage *aMessage) {</span>
<a href="#l22.266"></a><span id="l22.266">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l22.267"></a><span id="l22.267"> </span>
<a href="#l22.268"></a><span id="l22.268">   // Get DN</span>
<a href="#l22.269"></a><span id="l22.269">   nsAutoCString dn;</span>
<a href="#l22.270"></a><span id="l22.270">   nsresult rv = aMessage-&gt;GetDn(dn);</span>
<a href="#l22.271"></a><span id="l22.271">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.272"></a><span id="l22.272"> </span>
<a href="#l22.273"></a><span id="l22.273">   SetDn(dn);</span>
<a href="#l22.274"></a><span id="l22.274"> </span>
<a href="#l22.275"></a><span id="l22.275">   // Get the list of set attributes</span>
<a href="#l22.276"></a><span id="l22.276">   CharPtrArrayGuard attrs;</span>
<a href="#l22.277"></a><span id="l22.277">   rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l22.278"></a><span id="l22.278">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.279"></a><span id="l22.279"> </span>
<a href="#l22.280"></a><span id="l22.280">   nsAutoCString attr;</span>
<a href="#l22.281"></a><span id="l22.281">   m_attributes.Clear();</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineminus">-  for (uint32_t i = 0; i &lt; attrs.GetSize(); ++i)</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineminus">-  {</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+  for (uint32_t i = 0; i &lt; attrs.GetSize(); ++i) {</span>
<a href="#l22.285"></a><span id="l22.285">     attr.Assign(nsDependentCString(attrs[i]));</span>
<a href="#l22.286"></a><span id="l22.286">     ToLowerCase(attr);</span>
<a href="#l22.287"></a><span id="l22.287">     m_attributes.AppendElement(attr);</span>
<a href="#l22.288"></a><span id="l22.288">   }</span>
<a href="#l22.289"></a><span id="l22.289"> </span>
<a href="#l22.290"></a><span id="l22.290">   // Get the objectClass values</span>
<a href="#l22.291"></a><span id="l22.291">   m_objectClass.Clear();</span>
<a href="#l22.292"></a><span id="l22.292">   PRUnicharPtrArrayGuard vals;</span>
<a href="#l22.293"></a><span id="l22.293">   rv = aMessage-&gt;GetValues(&quot;objectClass&quot;, vals.GetSizeAddr(),</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineminus">-    vals.GetArrayAddr());</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineplus">+                           vals.GetArrayAddr());</span>
<a href="#l22.296"></a><span id="l22.296"> </span>
<a href="#l22.297"></a><span id="l22.297">   // objectClass is not always included in search result entries and</span>
<a href="#l22.298"></a><span id="l22.298">   // nsILDAPMessage::GetValues returns NS_ERROR_LDAP_DECODING_ERROR if the</span>
<a href="#l22.299"></a><span id="l22.299">   // requested attribute doesn't exist.</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineminus">-  if (rv ==  NS_ERROR_LDAP_DECODING_ERROR)</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+  if (rv == NS_ERROR_LDAP_DECODING_ERROR) return NS_OK;</span>
<a href="#l22.303"></a><span id="l22.303"> </span>
<a href="#l22.304"></a><span id="l22.304">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.305"></a><span id="l22.305"> </span>
<a href="#l22.306"></a><span id="l22.306">   nsAutoCString oclass;</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineminus">-  for (uint32_t i = 0; i &lt; vals.GetSize(); ++i)</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineminus">-  {</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineplus">+  for (uint32_t i = 0; i &lt; vals.GetSize(); ++i) {</span>
<a href="#l22.310"></a><span id="l22.310">     oclass.Assign(NS_LossyConvertUTF16toASCII(nsDependentString(vals[i])));</span>
<a href="#l22.311"></a><span id="l22.311">     ToLowerCase(oclass);</span>
<a href="#l22.312"></a><span id="l22.312">     m_objectClass.AppendElement(oclass);</span>
<a href="#l22.313"></a><span id="l22.313">   }</span>
<a href="#l22.314"></a><span id="l22.314"> </span>
<a href="#l22.315"></a><span id="l22.315">   return NS_OK;</span>
<a href="#l22.316"></a><span id="l22.316"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPCard.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -5,24 +5,22 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> #ifndef nsAbLDAPCard_h__</span>
<a href="#l23.6"></a><span id="l23.6"> #define nsAbLDAPCard_h__</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsIAbLDAPCard.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-class nsAbLDAPCard : public nsAbCardProperty,</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                     public nsIAbLDAPCard</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-{</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-public:</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+class nsAbLDAPCard : public nsAbCardProperty, public nsIAbLDAPCard {</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+ public:</span>
<a href="#l23.18"></a><span id="l23.18">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l23.19"></a><span id="l23.19">   NS_DECL_NSIABLDAPCARD</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">   nsAbLDAPCard();</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-protected:</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+ protected:</span>
<a href="#l23.25"></a><span id="l23.25">   virtual ~nsAbLDAPCard();</span>
<a href="#l23.26"></a><span id="l23.26">   nsTArray&lt;nsCString&gt; m_attributes;</span>
<a href="#l23.27"></a><span id="l23.27">   nsTArray&lt;nsCString&gt; m_objectClass;</span>
<a href="#l23.28"></a><span id="l23.28"> };</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -18,524 +18,482 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;plstr.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;prmem.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> // Defined here since to be used</span>
<a href="#l24.11"></a><span id="l24.11"> // only locally to this file.</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-enum UpdateOp {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">- NO_OP,</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">- ENTRY_ADD,</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">- ENTRY_DELETE,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">- ENTRY_MODIFY</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-};</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+enum UpdateOp { NO_OP, ENTRY_ADD, ENTRY_DELETE, ENTRY_MODIFY };</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20"> nsAbLDAPProcessChangeLogData::nsAbLDAPProcessChangeLogData()</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-: mUseChangeLog(false),</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-  mChangeLogEntriesCount(0),</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-  mEntriesAddedQueryCount(0)</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-{</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-   mRootDSEEntry.firstChangeNumber = 0;</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-   mRootDSEEntry.lastChangeNumber = 0;</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+    : mUseChangeLog(false),</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+      mChangeLogEntriesCount(0),</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+      mEntriesAddedQueryCount(0) {</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+  mRootDSEEntry.firstChangeNumber = 0;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+  mRootDSEEntry.lastChangeNumber = 0;</span>
<a href="#l24.32"></a><span id="l24.32"> }</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-nsAbLDAPProcessChangeLogData::~nsAbLDAPProcessChangeLogData()</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-{</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+nsAbLDAPProcessChangeLogData::~nsAbLDAPProcessChangeLogData() {}</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-}</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessChangeLogData::Init(nsIAbLDAPReplicationQuery * query, nsIWebProgressListener *progressListener)</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-{</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-   NS_ENSURE_ARG_POINTER(query);</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+NS_IMETHODIMP nsAbLDAPProcessChangeLogData::Init(</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+    nsIAbLDAPReplicationQuery *query,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+    nsIWebProgressListener *progressListener) {</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+  NS_ENSURE_ARG_POINTER(query);</span>
<a href="#l24.47"></a><span id="l24.47"> </span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-   // Here we are assuming that the caller will pass a nsAbLDAPChangeLogQuery object,</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-   // an implementation derived from the implementation of nsIAbLDAPReplicationQuery.</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-   nsresult rv = NS_OK;</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-   mChangeLogQuery = do_QueryInterface(query, &amp;rv);</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-   if(NS_FAILED(rv))</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-       return rv;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+  // Here we are assuming that the caller will pass a nsAbLDAPChangeLogQuery</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+  // object, an implementation derived from the implementation of</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+  // nsIAbLDAPReplicationQuery.</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+  mChangeLogQuery = do_QueryInterface(query, &amp;rv);</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.60"></a><span id="l24.60"> </span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-   // Call the parent's Init now.</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-   return nsAbLDAPProcessReplicationData::Init(query, progressListener);</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+  // Call the parent's Init now.</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+  return nsAbLDAPProcessReplicationData::Init(query, progressListener);</span>
<a href="#l24.65"></a><span id="l24.65"> }</span>
<a href="#l24.66"></a><span id="l24.66"> </span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnLDAPBind(nsILDAPMessage *aMessage)</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-{</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::OnLDAPBind(nsILDAPMessage *aMessage) {</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+  int32_t errCode;</span>
<a href="#l24.77"></a><span id="l24.77"> </span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-    int32_t errCode;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+  nsresult rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    Done(false);</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    return rv;</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+  }</span>
<a href="#l24.84"></a><span id="l24.84"> </span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-    nsresult rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-    if(NS_FAILED(rv)) {</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-        Done(false);</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-        return rv;</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-    }</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+  if (errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+    Done(false);</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+  }</span>
<a href="#l24.94"></a><span id="l24.94"> </span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-    if(errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-        Done(false);</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-    }</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+  switch (mState) {</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+    case kAnonymousBinding:</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+      rv = GetAuthData();</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+      if (NS_SUCCEEDED(rv)) rv = mChangeLogQuery-&gt;QueryAuthDN(mAuthUserID);</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+      if (NS_SUCCEEDED(rv)) mState = kSearchingAuthDN;</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+      break;</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+    case kAuthenticatedBinding:</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+      rv = mChangeLogQuery-&gt;QueryRootDSE();</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+      if (NS_SUCCEEDED(rv)) mState = kSearchingRootDSE;</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+      break;</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+  }  // end of switch</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+  if (NS_FAILED(rv)) Abort();</span>
<a href="#l24.112"></a><span id="l24.112"> </span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-    switch(mState) {</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-    case kAnonymousBinding :</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-        rv = GetAuthData();</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-        if(NS_SUCCEEDED(rv))</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-            rv = mChangeLogQuery-&gt;QueryAuthDN(mAuthUserID);</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-        if(NS_SUCCEEDED(rv))</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-            mState = kSearchingAuthDN;</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-        break;</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-    case kAuthenticatedBinding :</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-        rv = mChangeLogQuery-&gt;QueryRootDSE();</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-        if(NS_SUCCEEDED(rv))</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-            mState = kSearchingRootDSE;</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-        break;</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-    } //end of switch</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+  return rv;</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+}</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchEntry(</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l24.136"></a><span id="l24.136"> </span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-        Abort();</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+  switch (mState) {</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+    case kSearchingAuthDN: {</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+      nsAutoCString authDN;</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+      rv = aMessage-&gt;GetDn(authDN);</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !authDN.IsEmpty()) mAuthDN = authDN.get();</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineplus">+    } break;</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineplus">+    case kSearchingRootDSE:</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+      rv = ParseRootDSEEntry(aMessage);</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+      break;</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+    case kFindingChanges:</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+      rv = ParseChangeLogEntries(aMessage);</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineplus">+      break;</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineplus">+    // Fall through since we only add (for updates we delete and add)</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineplus">+    case kReplicatingChanges:</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+    case kReplicatingAll:</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+      return nsAbLDAPProcessReplicationData::OnLDAPSearchEntry(aMessage);</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+  }</span>
<a href="#l24.156"></a><span id="l24.156"> </span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-    return rv;</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+  if (NS_FAILED(rv)) Abort();</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineplus">+  return rv;</span>
<a href="#l24.161"></a><span id="l24.161"> }</span>
<a href="#l24.162"></a><span id="l24.162"> </span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchEntry(nsILDAPMessage *aMessage)</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-{</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchResult(</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+  int32_t errorCode;</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+  nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l24.176"></a><span id="l24.176"> </span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+    if (errorCode == nsILDAPErrors::SUCCESS ||</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineplus">+        errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+      switch (mState) {</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+        case kSearchingAuthDN:</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+          rv = OnSearchAuthDNDone();</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+          break;</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineplus">+        case kSearchingRootDSE: {</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+          // Before starting the changeLog check the DB file, if its not there</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+          // or bogus we need to create a new one and set to all.</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+          nsCOMPtr&lt;nsIAddrBookSession&gt; abSession =</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineplus">+              do_GetService(NS_ADDRBOOKSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineplus">+          nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+          rv = abSession-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l24.194"></a><span id="l24.194"> </span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-    switch(mState)</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-    {</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-    case kSearchingAuthDN :</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-        {</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineminus">-            nsAutoCString authDN;</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-            rv = aMessage-&gt;GetDn(authDN);</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-            if(NS_SUCCEEDED(rv) &amp;&amp; !authDN.IsEmpty())</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">-                mAuthDN = authDN.get();</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineplus">+          nsAutoCString fileName;</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+          rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineplus">+          rv = dbPath-&gt;AppendNative(fileName);</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineplus">+</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineplus">+          bool fileExists;</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineplus">+          rv = dbPath-&gt;Exists(&amp;fileExists);</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+          int64_t fileSize;</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineplus">+          rv = dbPath-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineplus">+</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineplus">+          if (!fileExists || !fileSize) mUseChangeLog = false;</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineplus">+</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineplus">+          // Open / create the AB here since it calls Done,</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineplus">+          // just return from here.</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineplus">+          if (mUseChangeLog)</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineplus">+            rv = OpenABForReplicatedDir(false);</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineplus">+          else</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+            rv = OpenABForReplicatedDir(true);</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+          if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+          // Now start the appropriate query</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+          rv = OnSearchRootDSEDone();</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineplus">+          break;</span>
<a href="#l24.231"></a><span id="l24.231">         }</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineminus">-        break;</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineminus">-    case kSearchingRootDSE:</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-        rv = ParseRootDSEEntry(aMessage);</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-        break;</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-    case kFindingChanges:</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-        rv = ParseChangeLogEntries(aMessage);</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-        break;</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-    // Fall through since we only add (for updates we delete and add)</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineminus">-    case kReplicatingChanges:</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-    case kReplicatingAll :</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineminus">-        return nsAbLDAPProcessReplicationData::OnLDAPSearchEntry(aMessage);</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-    }</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineplus">+        case kFindingChanges:</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineplus">+          rv = OnFindingChangesDone();</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineplus">+          // If success we return from here since</span>
<a href="#l24.247"></a><span id="l24.247" class="difflineplus">+          // this changes state to kReplicatingChanges</span>
<a href="#l24.248"></a><span id="l24.248" class="difflineplus">+          // and it falls through into the if clause below.</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineplus">+          if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineplus">+          break;</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineplus">+        case kReplicatingAll:</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineplus">+          return nsAbLDAPProcessReplicationData::OnLDAPSearchResult(aMessage);</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineplus">+      }  // end of switch</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineplus">+    } else</span>
<a href="#l24.255"></a><span id="l24.255" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineplus">+    // If one of the changed entry in changelog is not found,</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineplus">+    // continue with replicating the next one.</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineplus">+    if (mState == kReplicatingChanges) rv = OnReplicatingChangeDone();</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineplus">+  }  // end of outer if</span>
<a href="#l24.260"></a><span id="l24.260"> </span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-        Abort();</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineplus">+  if (NS_FAILED(rv)) Abort();</span>
<a href="#l24.264"></a><span id="l24.264"> </span>
<a href="#l24.265"></a><span id="l24.265" class="difflineminus">-    return rv;</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineplus">+  return rv;</span>
<a href="#l24.267"></a><span id="l24.267"> }</span>
<a href="#l24.268"></a><span id="l24.268"> </span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-{</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-    if (!mInitialized)</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.274"></a><span id="l24.274" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::GetAuthData() {</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineplus">+</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineplus">+  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineplus">+  if (!wwatch) return NS_ERROR_FAILURE;</span>
<a href="#l24.279"></a><span id="l24.279"> </span>
<a href="#l24.280"></a><span id="l24.280" class="difflineminus">-    int32_t errorCode;</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineplus">+  nsCOMPtr&lt;nsIAuthPrompt&gt; dialog;</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineplus">+  nsresult rv = wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l24.283"></a><span id="l24.283" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineplus">+  if (!dialog) return NS_ERROR_FAILURE;</span>
<a href="#l24.285"></a><span id="l24.285"> </span>
<a href="#l24.286"></a><span id="l24.286" class="difflineminus">-    nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineplus">+  nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineplus">+  rv = mQuery-&gt;GetReplicationURL(getter_AddRefs(url));</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.290"></a><span id="l24.290"> </span>
<a href="#l24.291"></a><span id="l24.291" class="difflineminus">-    if(NS_SUCCEEDED(rv))</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineminus">-    {</span>
<a href="#l24.293"></a><span id="l24.293" class="difflineminus">-        if(errorCode == nsILDAPErrors::SUCCESS || errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l24.294"></a><span id="l24.294" class="difflineminus">-            switch(mState) {</span>
<a href="#l24.295"></a><span id="l24.295" class="difflineminus">-            case kSearchingAuthDN :</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineminus">-                rv = OnSearchAuthDNDone();</span>
<a href="#l24.297"></a><span id="l24.297" class="difflineminus">-                break;</span>
<a href="#l24.298"></a><span id="l24.298" class="difflineminus">-            case kSearchingRootDSE:</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineminus">-             {</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineminus">-                // Before starting the changeLog check the DB file, if its not there or bogus</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineminus">-                // we need to create a new one and set to all.</span>
<a href="#l24.302"></a><span id="l24.302" class="difflineminus">-                nsCOMPtr&lt;nsIAddrBookSession&gt; abSession = do_GetService(NS_ADDRBOOKSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l24.303"></a><span id="l24.303" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l24.304"></a><span id="l24.304" class="difflineminus">-                    break;</span>
<a href="#l24.305"></a><span id="l24.305" class="difflineminus">-                nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-                rv = abSession-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineminus">-                    break;</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineplus">+  nsAutoCString serverUri;</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineplus">+  rv = url-&gt;GetSpec(serverUri);</span>
<a href="#l24.311"></a><span id="l24.311" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.312"></a><span id="l24.312"> </span>
<a href="#l24.313"></a><span id="l24.313" class="difflineminus">-                nsAutoCString fileName;</span>
<a href="#l24.314"></a><span id="l24.314" class="difflineminus">-                rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l24.315"></a><span id="l24.315" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineminus">-                  break;</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineplus">+  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineplus">+      &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l24.324"></a><span id="l24.324" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.325"></a><span id="l24.325"> </span>
<a href="#l24.326"></a><span id="l24.326" class="difflineminus">-                rv = dbPath-&gt;AppendNative(fileName);</span>
<a href="#l24.327"></a><span id="l24.327" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineminus">-                    break;</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineminus">-</span>
<a href="#l24.330"></a><span id="l24.330" class="difflineminus">-                bool fileExists;</span>
<a href="#l24.331"></a><span id="l24.331" class="difflineminus">-                rv = dbPath-&gt;Exists(&amp;fileExists);</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineminus">-                    break;</span>
<a href="#l24.334"></a><span id="l24.334" class="difflineplus">+  nsString title;</span>
<a href="#l24.335"></a><span id="l24.335" class="difflineplus">+  rv = bundle-&gt;GetStringFromName(&quot;AuthDlgTitle&quot;, title);</span>
<a href="#l24.336"></a><span id="l24.336" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.337"></a><span id="l24.337"> </span>
<a href="#l24.338"></a><span id="l24.338" class="difflineminus">-                int64_t fileSize;</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineminus">-                rv = dbPath-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l24.340"></a><span id="l24.340" class="difflineminus">-                if(NS_FAILED(rv))</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineminus">-                    break;</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineminus">-</span>
<a href="#l24.343"></a><span id="l24.343" class="difflineminus">-                if (!fileExists || !fileSize)</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineminus">-                    mUseChangeLog = false;</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineminus">-</span>
<a href="#l24.346"></a><span id="l24.346" class="difflineminus">-                // Open / create the AB here since it calls Done,</span>
<a href="#l24.347"></a><span id="l24.347" class="difflineminus">-                // just return from here.</span>
<a href="#l24.348"></a><span id="l24.348" class="difflineminus">-                if (mUseChangeLog)</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineminus">-                   rv = OpenABForReplicatedDir(false);</span>
<a href="#l24.350"></a><span id="l24.350" class="difflineminus">-                else</span>
<a href="#l24.351"></a><span id="l24.351" class="difflineminus">-                   rv = OpenABForReplicatedDir(true);</span>
<a href="#l24.352"></a><span id="l24.352" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l24.353"></a><span id="l24.353" class="difflineminus">-                   return rv;</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineplus">+  nsString desc;</span>
<a href="#l24.355"></a><span id="l24.355" class="difflineplus">+  rv = bundle-&gt;GetStringFromName(&quot;AuthDlgDesc&quot;, desc);</span>
<a href="#l24.356"></a><span id="l24.356" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.357"></a><span id="l24.357"> </span>
<a href="#l24.358"></a><span id="l24.358" class="difflineminus">-                // Now start the appropriate query</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineminus">-                rv = OnSearchRootDSEDone();</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineminus">-                break;</span>
<a href="#l24.361"></a><span id="l24.361" class="difflineminus">-             }</span>
<a href="#l24.362"></a><span id="l24.362" class="difflineminus">-            case kFindingChanges:</span>
<a href="#l24.363"></a><span id="l24.363" class="difflineminus">-                rv = OnFindingChangesDone();</span>
<a href="#l24.364"></a><span id="l24.364" class="difflineminus">-                // If success we return from here since</span>
<a href="#l24.365"></a><span id="l24.365" class="difflineminus">-                // this changes state to kReplicatingChanges</span>
<a href="#l24.366"></a><span id="l24.366" class="difflineminus">-                // and it falls through into the if clause below.</span>
<a href="#l24.367"></a><span id="l24.367" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l24.368"></a><span id="l24.368" class="difflineminus">-                    return rv;</span>
<a href="#l24.369"></a><span id="l24.369" class="difflineminus">-                break;</span>
<a href="#l24.370"></a><span id="l24.370" class="difflineminus">-            case kReplicatingAll :</span>
<a href="#l24.371"></a><span id="l24.371" class="difflineminus">-                return nsAbLDAPProcessReplicationData::OnLDAPSearchResult(aMessage);</span>
<a href="#l24.372"></a><span id="l24.372" class="difflineminus">-            } // end of switch</span>
<a href="#l24.373"></a><span id="l24.373" class="difflineminus">-        }</span>
<a href="#l24.374"></a><span id="l24.374" class="difflineminus">-        else</span>
<a href="#l24.375"></a><span id="l24.375" class="difflineminus">-            rv = NS_ERROR_FAILURE;</span>
<a href="#l24.376"></a><span id="l24.376" class="difflineminus">-        // If one of the changed entry in changelog is not found,</span>
<a href="#l24.377"></a><span id="l24.377" class="difflineminus">-        // continue with replicating the next one.</span>
<a href="#l24.378"></a><span id="l24.378" class="difflineminus">-        if(mState == kReplicatingChanges)</span>
<a href="#l24.379"></a><span id="l24.379" class="difflineminus">-            rv = OnReplicatingChangeDone();</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineminus">-    } // end of outer if</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineplus">+  nsString username;</span>
<a href="#l24.382"></a><span id="l24.382" class="difflineplus">+  nsString password;</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineplus">+  bool btnResult = false;</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineplus">+  rv = dialog-&gt;PromptUsernameAndPassword(</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineplus">+      title, desc, NS_ConvertUTF8toUTF16(serverUri).get(),</span>
<a href="#l24.386"></a><span id="l24.386" class="difflineplus">+      nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY, getter_Copies(username),</span>
<a href="#l24.387"></a><span id="l24.387" class="difflineplus">+      getter_Copies(password), &amp;btnResult);</span>
<a href="#l24.388"></a><span id="l24.388" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; btnResult) {</span>
<a href="#l24.389"></a><span id="l24.389" class="difflineplus">+    CopyUTF16toUTF8(username, mAuthUserID);</span>
<a href="#l24.390"></a><span id="l24.390" class="difflineplus">+    CopyUTF16toUTF8(password, mAuthPswd);</span>
<a href="#l24.391"></a><span id="l24.391" class="difflineplus">+  } else</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineplus">+    rv = NS_ERROR_FAILURE;</span>
<a href="#l24.393"></a><span id="l24.393"> </span>
<a href="#l24.394"></a><span id="l24.394" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineminus">-        Abort();</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineplus">+  return rv;</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineplus">+}</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineplus">+</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::OnSearchAuthDNDone() {</span>
<a href="#l24.400"></a><span id="l24.400" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.401"></a><span id="l24.401"> </span>
<a href="#l24.402"></a><span id="l24.402" class="difflineminus">-    return rv;</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineplus">+  nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineplus">+  nsresult rv = mQuery-&gt;GetReplicationURL(getter_AddRefs(url));</span>
<a href="#l24.405"></a><span id="l24.405" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = mQuery-&gt;ConnectToLDAPServer(url, mAuthDN);</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineplus">+    mState = kAuthenticatedBinding;</span>
<a href="#l24.408"></a><span id="l24.408" class="difflineplus">+    rv = mDirectory-&gt;SetAuthDn(mAuthDN);</span>
<a href="#l24.409"></a><span id="l24.409" class="difflineplus">+  }</span>
<a href="#l24.410"></a><span id="l24.410" class="difflineplus">+</span>
<a href="#l24.411"></a><span id="l24.411" class="difflineplus">+  return rv;</span>
<a href="#l24.412"></a><span id="l24.412"> }</span>
<a href="#l24.413"></a><span id="l24.413"> </span>
<a href="#l24.414"></a><span id="l24.414" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::GetAuthData()</span>
<a href="#l24.415"></a><span id="l24.415" class="difflineminus">-{</span>
<a href="#l24.416"></a><span id="l24.416" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.418"></a><span id="l24.418" class="difflineminus">-</span>
<a href="#l24.419"></a><span id="l24.419" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l24.420"></a><span id="l24.420" class="difflineminus">-    if (!wwatch)</span>
<a href="#l24.421"></a><span id="l24.421" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l24.422"></a><span id="l24.422" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::ParseRootDSEEntry(</span>
<a href="#l24.423"></a><span id="l24.423" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l24.424"></a><span id="l24.424" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.425"></a><span id="l24.425" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.426"></a><span id="l24.426"> </span>
<a href="#l24.427"></a><span id="l24.427" class="difflineminus">-    nsCOMPtr&lt;nsIAuthPrompt&gt; dialog;</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineminus">-    nsresult rv = wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineminus">-        return rv;</span>
<a href="#l24.431"></a><span id="l24.431" class="difflineminus">-    if (!dialog)</span>
<a href="#l24.432"></a><span id="l24.432" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineminus">-</span>
<a href="#l24.434"></a><span id="l24.434" class="difflineminus">-    nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l24.435"></a><span id="l24.435" class="difflineminus">-    rv = mQuery-&gt;GetReplicationURL(getter_AddRefs(url));</span>
<a href="#l24.436"></a><span id="l24.436" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.437"></a><span id="l24.437" class="difflineminus">-        return rv;</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineminus">-</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineminus">-    nsAutoCString serverUri;</span>
<a href="#l24.440"></a><span id="l24.440" class="difflineminus">-    rv = url-&gt;GetSpec(serverUri);</span>
<a href="#l24.441"></a><span id="l24.441" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.442"></a><span id="l24.442" class="difflineminus">-        return rv;</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineplus">+  // Populate the RootDSEChangeLogEntry</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineplus">+  CharPtrArrayGuard attrs;</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineplus">+  nsresult rv =</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineplus">+      aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineplus">+  // No attributes</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.449"></a><span id="l24.449"> </span>
<a href="#l24.450"></a><span id="l24.450" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l24.451"></a><span id="l24.451" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l24.452"></a><span id="l24.452" class="difflineminus">-    NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l24.454"></a><span id="l24.454" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l24.455"></a><span id="l24.455" class="difflineminus">-    if (NS_FAILED (rv))</span>
<a href="#l24.456"></a><span id="l24.456" class="difflineminus">-        return rv ;</span>
<a href="#l24.457"></a><span id="l24.457" class="difflineminus">-</span>
<a href="#l24.458"></a><span id="l24.458" class="difflineminus">-    nsString title;</span>
<a href="#l24.459"></a><span id="l24.459" class="difflineminus">-    rv = bundle-&gt;GetStringFromName(&quot;AuthDlgTitle&quot;, title);</span>
<a href="#l24.460"></a><span id="l24.460" class="difflineminus">-    if (NS_FAILED (rv))</span>
<a href="#l24.461"></a><span id="l24.461" class="difflineminus">-        return rv ;</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineplus">+  for (int32_t i = attrs.GetSize() - 1; i &gt;= 0; i--) {</span>
<a href="#l24.463"></a><span id="l24.463" class="difflineplus">+    PRUnicharPtrArrayGuard vals;</span>
<a href="#l24.464"></a><span id="l24.464" class="difflineplus">+    rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(),</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineplus">+                             vals.GetArrayAddr());</span>
<a href="#l24.466"></a><span id="l24.466" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l24.467"></a><span id="l24.467" class="difflineplus">+    if (vals.GetSize()) {</span>
<a href="#l24.468"></a><span id="l24.468" class="difflineplus">+      if (!PL_strcasecmp(attrs[i], &quot;changelog&quot;))</span>
<a href="#l24.469"></a><span id="l24.469" class="difflineplus">+        CopyUTF16toUTF8(vals[0], mRootDSEEntry.changeLogDN);</span>
<a href="#l24.470"></a><span id="l24.470" class="difflineplus">+      if (!PL_strcasecmp(attrs[i], &quot;firstChangeNumber&quot;))</span>
<a href="#l24.471"></a><span id="l24.471" class="difflineplus">+        mRootDSEEntry.firstChangeNumber =</span>
<a href="#l24.472"></a><span id="l24.472" class="difflineplus">+            atol(NS_LossyConvertUTF16toASCII(vals[0]).get());</span>
<a href="#l24.473"></a><span id="l24.473" class="difflineplus">+      if (!PL_strcasecmp(attrs[i], &quot;lastChangeNumber&quot;))</span>
<a href="#l24.474"></a><span id="l24.474" class="difflineplus">+        mRootDSEEntry.lastChangeNumber =</span>
<a href="#l24.475"></a><span id="l24.475" class="difflineplus">+            atol(NS_LossyConvertUTF16toASCII(vals[0]).get());</span>
<a href="#l24.476"></a><span id="l24.476" class="difflineplus">+      if (!PL_strcasecmp(attrs[i], &quot;dataVersion&quot;))</span>
<a href="#l24.477"></a><span id="l24.477" class="difflineplus">+        CopyUTF16toUTF8(vals[0], mRootDSEEntry.dataVersion);</span>
<a href="#l24.478"></a><span id="l24.478" class="difflineplus">+    }</span>
<a href="#l24.479"></a><span id="l24.479" class="difflineplus">+  }</span>
<a href="#l24.480"></a><span id="l24.480"> </span>
<a href="#l24.481"></a><span id="l24.481" class="difflineminus">-    nsString desc;</span>
<a href="#l24.482"></a><span id="l24.482" class="difflineminus">-    rv = bundle-&gt;GetStringFromName(&quot;AuthDlgDesc&quot;, desc);</span>
<a href="#l24.483"></a><span id="l24.483" class="difflineminus">-    if (NS_FAILED (rv))</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineminus">-        return rv ;</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineplus">+  int32_t lastChangeNumber;</span>
<a href="#l24.486"></a><span id="l24.486" class="difflineplus">+  mDirectory-&gt;GetLastChangeNumber(&amp;lastChangeNumber);</span>
<a href="#l24.487"></a><span id="l24.487" class="difflineplus">+</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineplus">+  if ((mRootDSEEntry.lastChangeNumber &gt; 0) &amp;&amp;</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineplus">+      (lastChangeNumber &lt; mRootDSEEntry.lastChangeNumber) &amp;&amp;</span>
<a href="#l24.490"></a><span id="l24.490" class="difflineplus">+      (lastChangeNumber &gt; mRootDSEEntry.firstChangeNumber))</span>
<a href="#l24.491"></a><span id="l24.491" class="difflineplus">+    mUseChangeLog = true;</span>
<a href="#l24.492"></a><span id="l24.492"> </span>
<a href="#l24.493"></a><span id="l24.493" class="difflineminus">-    nsString username;</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineminus">-    nsString password;</span>
<a href="#l24.495"></a><span id="l24.495" class="difflineminus">-    bool btnResult = false;</span>
<a href="#l24.496"></a><span id="l24.496" class="difflineminus">-    rv = dialog-&gt;PromptUsernameAndPassword(title, desc,</span>
<a href="#l24.497"></a><span id="l24.497" class="difflineminus">-                                            NS_ConvertUTF8toUTF16(serverUri).get(),</span>
<a href="#l24.498"></a><span id="l24.498" class="difflineminus">-                                            nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l24.499"></a><span id="l24.499" class="difflineminus">-                                            getter_Copies(username), getter_Copies(password),</span>
<a href="#l24.500"></a><span id="l24.500" class="difflineminus">-                                            &amp;btnResult);</span>
<a href="#l24.501"></a><span id="l24.501" class="difflineminus">-    if(NS_SUCCEEDED(rv) &amp;&amp; btnResult) {</span>
<a href="#l24.502"></a><span id="l24.502" class="difflineminus">-        CopyUTF16toUTF8(username, mAuthUserID);</span>
<a href="#l24.503"></a><span id="l24.503" class="difflineminus">-        CopyUTF16toUTF8(password, mAuthPswd);</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineminus">-    }</span>
<a href="#l24.505"></a><span id="l24.505" class="difflineminus">-    else</span>
<a href="#l24.506"></a><span id="l24.506" class="difflineminus">-        rv = NS_ERROR_FAILURE;</span>
<a href="#l24.507"></a><span id="l24.507" class="difflineplus">+  if (mRootDSEEntry.lastChangeNumber &amp;&amp;</span>
<a href="#l24.508"></a><span id="l24.508" class="difflineplus">+      (lastChangeNumber == mRootDSEEntry.lastChangeNumber)) {</span>
<a href="#l24.509"></a><span id="l24.509" class="difflineplus">+    Done(true);  // We are up to date no need to replicate, db not open yet so</span>
<a href="#l24.510"></a><span id="l24.510" class="difflineplus">+                 // call Done</span>
<a href="#l24.511"></a><span id="l24.511" class="difflineplus">+    return NS_OK;</span>
<a href="#l24.512"></a><span id="l24.512" class="difflineplus">+  }</span>
<a href="#l24.513"></a><span id="l24.513"> </span>
<a href="#l24.514"></a><span id="l24.514" class="difflineminus">-    return rv;</span>
<a href="#l24.515"></a><span id="l24.515" class="difflineplus">+  return rv;</span>
<a href="#l24.516"></a><span id="l24.516"> }</span>
<a href="#l24.517"></a><span id="l24.517"> </span>
<a href="#l24.518"></a><span id="l24.518" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnSearchAuthDNDone()</span>
<a href="#l24.519"></a><span id="l24.519" class="difflineminus">-{</span>
<a href="#l24.520"></a><span id="l24.520" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l24.521"></a><span id="l24.521" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.522"></a><span id="l24.522" class="difflineminus">-</span>
<a href="#l24.523"></a><span id="l24.523" class="difflineminus">-    nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l24.524"></a><span id="l24.524" class="difflineminus">-    nsresult rv = mQuery-&gt;GetReplicationURL(getter_AddRefs(url));</span>
<a href="#l24.525"></a><span id="l24.525" class="difflineminus">-    if(NS_SUCCEEDED(rv))</span>
<a href="#l24.526"></a><span id="l24.526" class="difflineminus">-        rv = mQuery-&gt;ConnectToLDAPServer(url, mAuthDN);</span>
<a href="#l24.527"></a><span id="l24.527" class="difflineminus">-    if(NS_SUCCEEDED(rv)) {</span>
<a href="#l24.528"></a><span id="l24.528" class="difflineminus">-        mState = kAuthenticatedBinding;</span>
<a href="#l24.529"></a><span id="l24.529" class="difflineminus">-        rv = mDirectory-&gt;SetAuthDn(mAuthDN);</span>
<a href="#l24.530"></a><span id="l24.530" class="difflineminus">-    }</span>
<a href="#l24.531"></a><span id="l24.531" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::OnSearchRootDSEDone() {</span>
<a href="#l24.532"></a><span id="l24.532" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.533"></a><span id="l24.533"> </span>
<a href="#l24.534"></a><span id="l24.534" class="difflineminus">-    return rv;</span>
<a href="#l24.535"></a><span id="l24.535" class="difflineminus">-}</span>
<a href="#l24.536"></a><span id="l24.536" class="difflineminus">-</span>
<a href="#l24.537"></a><span id="l24.537" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::ParseRootDSEEntry(nsILDAPMessage *aMessage)</span>
<a href="#l24.538"></a><span id="l24.538" class="difflineminus">-{</span>
<a href="#l24.539"></a><span id="l24.539" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.540"></a><span id="l24.540" class="difflineminus">-    if (!mInitialized)</span>
<a href="#l24.541"></a><span id="l24.541" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.542"></a><span id="l24.542" class="difflineminus">-</span>
<a href="#l24.543"></a><span id="l24.543" class="difflineminus">-    // Populate the RootDSEChangeLogEntry</span>
<a href="#l24.544"></a><span id="l24.544" class="difflineminus">-    CharPtrArrayGuard attrs;</span>
<a href="#l24.545"></a><span id="l24.545" class="difflineminus">-    nsresult rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l24.546"></a><span id="l24.546" class="difflineminus">-    // No attributes</span>
<a href="#l24.547"></a><span id="l24.547" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l24.548"></a><span id="l24.548" class="difflineminus">-        return rv;</span>
<a href="#l24.549"></a><span id="l24.549" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l24.550"></a><span id="l24.550"> </span>
<a href="#l24.551"></a><span id="l24.551" class="difflineminus">-    for(int32_t i=attrs.GetSize()-1; i &gt;= 0; i--) {</span>
<a href="#l24.552"></a><span id="l24.552" class="difflineminus">-        PRUnicharPtrArrayGuard vals;</span>
<a href="#l24.553"></a><span id="l24.553" class="difflineminus">-        rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(), vals.GetArrayAddr());</span>
<a href="#l24.554"></a><span id="l24.554" class="difflineminus">-        if(NS_FAILED(rv))</span>
<a href="#l24.555"></a><span id="l24.555" class="difflineminus">-            continue;</span>
<a href="#l24.556"></a><span id="l24.556" class="difflineminus">-        if(vals.GetSize()) {</span>
<a href="#l24.557"></a><span id="l24.557" class="difflineminus">-            if (!PL_strcasecmp(attrs[i], &quot;changelog&quot;))</span>
<a href="#l24.558"></a><span id="l24.558" class="difflineminus">-                CopyUTF16toUTF8(vals[0], mRootDSEEntry.changeLogDN);</span>
<a href="#l24.559"></a><span id="l24.559" class="difflineminus">-            if (!PL_strcasecmp(attrs[i], &quot;firstChangeNumber&quot;))</span>
<a href="#l24.560"></a><span id="l24.560" class="difflineminus">-                mRootDSEEntry.firstChangeNumber = atol(NS_LossyConvertUTF16toASCII(vals[0]).get());</span>
<a href="#l24.561"></a><span id="l24.561" class="difflineminus">-            if (!PL_strcasecmp(attrs[i], &quot;lastChangeNumber&quot;))</span>
<a href="#l24.562"></a><span id="l24.562" class="difflineminus">-                mRootDSEEntry.lastChangeNumber = atol(NS_LossyConvertUTF16toASCII(vals[0]).get());</span>
<a href="#l24.563"></a><span id="l24.563" class="difflineminus">-            if (!PL_strcasecmp(attrs[i], &quot;dataVersion&quot;))</span>
<a href="#l24.564"></a><span id="l24.564" class="difflineminus">-                CopyUTF16toUTF8(vals[0], mRootDSEEntry.dataVersion);</span>
<a href="#l24.565"></a><span id="l24.565" class="difflineminus">-        }</span>
<a href="#l24.566"></a><span id="l24.566" class="difflineminus">-    }</span>
<a href="#l24.567"></a><span id="l24.567" class="difflineplus">+  if (mUseChangeLog) {</span>
<a href="#l24.568"></a><span id="l24.568" class="difflineplus">+    rv = mChangeLogQuery-&gt;QueryChangeLog(mRootDSEEntry.changeLogDN,</span>
<a href="#l24.569"></a><span id="l24.569" class="difflineplus">+                                         mRootDSEEntry.lastChangeNumber);</span>
<a href="#l24.570"></a><span id="l24.570" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.571"></a><span id="l24.571" class="difflineplus">+    mState = kFindingChanges;</span>
<a href="#l24.572"></a><span id="l24.572" class="difflineplus">+    if (mListener)</span>
<a href="#l24.573"></a><span id="l24.573" class="difflineplus">+      mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l24.574"></a><span id="l24.574" class="difflineplus">+                               nsIWebProgressListener::STATE_START, false);</span>
<a href="#l24.575"></a><span id="l24.575" class="difflineplus">+  } else {</span>
<a href="#l24.576"></a><span id="l24.576" class="difflineplus">+    rv = mQuery-&gt;QueryAllEntries();</span>
<a href="#l24.577"></a><span id="l24.577" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.578"></a><span id="l24.578" class="difflineplus">+    mState = kReplicatingAll;</span>
<a href="#l24.579"></a><span id="l24.579" class="difflineplus">+    if (mListener)</span>
<a href="#l24.580"></a><span id="l24.580" class="difflineplus">+      mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l24.581"></a><span id="l24.581" class="difflineplus">+                               nsIWebProgressListener::STATE_START, true);</span>
<a href="#l24.582"></a><span id="l24.582" class="difflineplus">+  }</span>
<a href="#l24.583"></a><span id="l24.583"> </span>
<a href="#l24.584"></a><span id="l24.584" class="difflineminus">-    int32_t lastChangeNumber;</span>
<a href="#l24.585"></a><span id="l24.585" class="difflineminus">-    mDirectory-&gt;GetLastChangeNumber(&amp;lastChangeNumber);</span>
<a href="#l24.586"></a><span id="l24.586" class="difflineminus">-</span>
<a href="#l24.587"></a><span id="l24.587" class="difflineminus">-    if ((mRootDSEEntry.lastChangeNumber &gt; 0) &amp;&amp;</span>
<a href="#l24.588"></a><span id="l24.588" class="difflineminus">-        (lastChangeNumber &lt; mRootDSEEntry.lastChangeNumber) &amp;&amp;</span>
<a href="#l24.589"></a><span id="l24.589" class="difflineminus">-        (lastChangeNumber &gt; mRootDSEEntry.firstChangeNumber))</span>
<a href="#l24.590"></a><span id="l24.590" class="difflineminus">-        mUseChangeLog = true;</span>
<a href="#l24.591"></a><span id="l24.591" class="difflineplus">+  rv = mDirectory-&gt;SetLastChangeNumber(mRootDSEEntry.lastChangeNumber);</span>
<a href="#l24.592"></a><span id="l24.592" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.593"></a><span id="l24.593"> </span>
<a href="#l24.594"></a><span id="l24.594" class="difflineminus">-    if (mRootDSEEntry.lastChangeNumber &amp;&amp;</span>
<a href="#l24.595"></a><span id="l24.595" class="difflineminus">-        (lastChangeNumber == mRootDSEEntry.lastChangeNumber)) {</span>
<a href="#l24.596"></a><span id="l24.596" class="difflineminus">-        Done(true); // We are up to date no need to replicate, db not open yet so call Done</span>
<a href="#l24.597"></a><span id="l24.597" class="difflineminus">-        return NS_OK;</span>
<a href="#l24.598"></a><span id="l24.598" class="difflineminus">-    }</span>
<a href="#l24.599"></a><span id="l24.599" class="difflineplus">+  rv = mDirectory-&gt;SetDataVersion(mRootDSEEntry.dataVersion);</span>
<a href="#l24.600"></a><span id="l24.600"> </span>
<a href="#l24.601"></a><span id="l24.601" class="difflineminus">-    return rv;</span>
<a href="#l24.602"></a><span id="l24.602" class="difflineplus">+  return rv;</span>
<a href="#l24.603"></a><span id="l24.603"> }</span>
<a href="#l24.604"></a><span id="l24.604"> </span>
<a href="#l24.605"></a><span id="l24.605" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnSearchRootDSEDone()</span>
<a href="#l24.606"></a><span id="l24.606" class="difflineminus">-{</span>
<a href="#l24.607"></a><span id="l24.607" class="difflineminus">-    if (!mInitialized)</span>
<a href="#l24.608"></a><span id="l24.608" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.609"></a><span id="l24.609" class="difflineminus">-</span>
<a href="#l24.610"></a><span id="l24.610" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l24.611"></a><span id="l24.611" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::ParseChangeLogEntries(</span>
<a href="#l24.612"></a><span id="l24.612" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l24.613"></a><span id="l24.613" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.614"></a><span id="l24.614" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.615"></a><span id="l24.615"> </span>
<a href="#l24.616"></a><span id="l24.616" class="difflineminus">-    if(mUseChangeLog) {</span>
<a href="#l24.617"></a><span id="l24.617" class="difflineminus">-        rv = mChangeLogQuery-&gt;QueryChangeLog(mRootDSEEntry.changeLogDN, mRootDSEEntry.lastChangeNumber);</span>
<a href="#l24.618"></a><span id="l24.618" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l24.619"></a><span id="l24.619" class="difflineminus">-           return rv;</span>
<a href="#l24.620"></a><span id="l24.620" class="difflineminus">-        mState = kFindingChanges;</span>
<a href="#l24.621"></a><span id="l24.621" class="difflineminus">-        if(mListener)</span>
<a href="#l24.622"></a><span id="l24.622" class="difflineminus">-            mListener-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_START, false);</span>
<a href="#l24.623"></a><span id="l24.623" class="difflineminus">-    }</span>
<a href="#l24.624"></a><span id="l24.624" class="difflineminus">-    else {</span>
<a href="#l24.625"></a><span id="l24.625" class="difflineminus">-        rv = mQuery-&gt;QueryAllEntries();</span>
<a href="#l24.626"></a><span id="l24.626" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l24.627"></a><span id="l24.627" class="difflineminus">-           return rv;</span>
<a href="#l24.628"></a><span id="l24.628" class="difflineminus">-        mState = kReplicatingAll;</span>
<a href="#l24.629"></a><span id="l24.629" class="difflineminus">-        if(mListener)</span>
<a href="#l24.630"></a><span id="l24.630" class="difflineminus">-            mListener-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_START, true);</span>
<a href="#l24.631"></a><span id="l24.631" class="difflineminus">-    }</span>
<a href="#l24.632"></a><span id="l24.632" class="difflineminus">-</span>
<a href="#l24.633"></a><span id="l24.633" class="difflineminus">-    rv = mDirectory-&gt;SetLastChangeNumber(mRootDSEEntry.lastChangeNumber);</span>
<a href="#l24.634"></a><span id="l24.634" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.635"></a><span id="l24.635" class="difflineminus">-</span>
<a href="#l24.636"></a><span id="l24.636" class="difflineminus">-    rv = mDirectory-&gt;SetDataVersion(mRootDSEEntry.dataVersion);</span>
<a href="#l24.637"></a><span id="l24.637" class="difflineminus">-</span>
<a href="#l24.638"></a><span id="l24.638" class="difflineminus">-    return rv;</span>
<a href="#l24.639"></a><span id="l24.639" class="difflineminus">-}</span>
<a href="#l24.640"></a><span id="l24.640" class="difflineplus">+  // Populate the RootDSEChangeLogEntry</span>
<a href="#l24.641"></a><span id="l24.641" class="difflineplus">+  CharPtrArrayGuard attrs;</span>
<a href="#l24.642"></a><span id="l24.642" class="difflineplus">+  nsresult rv =</span>
<a href="#l24.643"></a><span id="l24.643" class="difflineplus">+      aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l24.644"></a><span id="l24.644" class="difflineplus">+  // No attributes</span>
<a href="#l24.645"></a><span id="l24.645" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.646"></a><span id="l24.646"> </span>
<a href="#l24.647"></a><span id="l24.647" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::ParseChangeLogEntries(nsILDAPMessage *aMessage)</span>
<a href="#l24.648"></a><span id="l24.648" class="difflineminus">-{</span>
<a href="#l24.649"></a><span id="l24.649" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l24.650"></a><span id="l24.650" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l24.651"></a><span id="l24.651" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.652"></a><span id="l24.652" class="difflineminus">-</span>
<a href="#l24.653"></a><span id="l24.653" class="difflineminus">-    // Populate the RootDSEChangeLogEntry</span>
<a href="#l24.654"></a><span id="l24.654" class="difflineminus">-    CharPtrArrayGuard attrs;</span>
<a href="#l24.655"></a><span id="l24.655" class="difflineminus">-    nsresult rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l24.656"></a><span id="l24.656" class="difflineminus">-    // No attributes</span>
<a href="#l24.657"></a><span id="l24.657" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l24.658"></a><span id="l24.658" class="difflineminus">-        return rv;</span>
<a href="#l24.659"></a><span id="l24.659" class="difflineplus">+  nsAutoString targetDN;</span>
<a href="#l24.660"></a><span id="l24.660" class="difflineplus">+  UpdateOp operation = NO_OP;</span>
<a href="#l24.661"></a><span id="l24.661" class="difflineplus">+  for (int32_t i = attrs.GetSize() - 1; i &gt;= 0; i--) {</span>
<a href="#l24.662"></a><span id="l24.662" class="difflineplus">+    PRUnicharPtrArrayGuard vals;</span>
<a href="#l24.663"></a><span id="l24.663" class="difflineplus">+    rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(),</span>
<a href="#l24.664"></a><span id="l24.664" class="difflineplus">+                             vals.GetArrayAddr());</span>
<a href="#l24.665"></a><span id="l24.665" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l24.666"></a><span id="l24.666" class="difflineplus">+    if (vals.GetSize()) {</span>
<a href="#l24.667"></a><span id="l24.667" class="difflineplus">+      if (!PL_strcasecmp(attrs[i], &quot;targetdn&quot;)) targetDN = vals[0];</span>
<a href="#l24.668"></a><span id="l24.668" class="difflineplus">+      if (!PL_strcasecmp(attrs[i], &quot;changetype&quot;)) {</span>
<a href="#l24.669"></a><span id="l24.669" class="difflineplus">+        if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;add&quot;),</span>
<a href="#l24.670"></a><span id="l24.670" class="difflineplus">+                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l24.671"></a><span id="l24.671" class="difflineplus">+          operation = ENTRY_ADD;</span>
<a href="#l24.672"></a><span id="l24.672" class="difflineplus">+        if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;modify&quot;),</span>
<a href="#l24.673"></a><span id="l24.673" class="difflineplus">+                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l24.674"></a><span id="l24.674" class="difflineplus">+          operation = ENTRY_MODIFY;</span>
<a href="#l24.675"></a><span id="l24.675" class="difflineplus">+        if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;delete&quot;),</span>
<a href="#l24.676"></a><span id="l24.676" class="difflineplus">+                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l24.677"></a><span id="l24.677" class="difflineplus">+          operation = ENTRY_DELETE;</span>
<a href="#l24.678"></a><span id="l24.678" class="difflineplus">+      }</span>
<a href="#l24.679"></a><span id="l24.679" class="difflineplus">+    }</span>
<a href="#l24.680"></a><span id="l24.680" class="difflineplus">+  }</span>
<a href="#l24.681"></a><span id="l24.681"> </span>
<a href="#l24.682"></a><span id="l24.682" class="difflineminus">-    nsAutoString targetDN;</span>
<a href="#l24.683"></a><span id="l24.683" class="difflineminus">-    UpdateOp operation = NO_OP;</span>
<a href="#l24.684"></a><span id="l24.684" class="difflineminus">-    for(int32_t i = attrs.GetSize()-1; i &gt;= 0; i--) {</span>
<a href="#l24.685"></a><span id="l24.685" class="difflineminus">-        PRUnicharPtrArrayGuard vals;</span>
<a href="#l24.686"></a><span id="l24.686" class="difflineminus">-        rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(), vals.GetArrayAddr());</span>
<a href="#l24.687"></a><span id="l24.687" class="difflineminus">-        if(NS_FAILED(rv))</span>
<a href="#l24.688"></a><span id="l24.688" class="difflineminus">-            continue;</span>
<a href="#l24.689"></a><span id="l24.689" class="difflineminus">-        if(vals.GetSize()) {</span>
<a href="#l24.690"></a><span id="l24.690" class="difflineminus">-            if (!PL_strcasecmp(attrs[i], &quot;targetdn&quot;))</span>
<a href="#l24.691"></a><span id="l24.691" class="difflineminus">-                targetDN = vals[0];</span>
<a href="#l24.692"></a><span id="l24.692" class="difflineminus">-            if (!PL_strcasecmp(attrs[i], &quot;changetype&quot;)) {</span>
<a href="#l24.693"></a><span id="l24.693" class="difflineminus">-                if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;add&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l24.694"></a><span id="l24.694" class="difflineminus">-                    operation = ENTRY_ADD;</span>
<a href="#l24.695"></a><span id="l24.695" class="difflineminus">-                if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;modify&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l24.696"></a><span id="l24.696" class="difflineminus">-                    operation = ENTRY_MODIFY;</span>
<a href="#l24.697"></a><span id="l24.697" class="difflineminus">-                if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;delete&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l24.698"></a><span id="l24.698" class="difflineminus">-                    operation = ENTRY_DELETE;</span>
<a href="#l24.699"></a><span id="l24.699" class="difflineminus">-            }</span>
<a href="#l24.700"></a><span id="l24.700" class="difflineminus">-        }</span>
<a href="#l24.701"></a><span id="l24.701" class="difflineminus">-    }</span>
<a href="#l24.702"></a><span id="l24.702" class="difflineminus">-</span>
<a href="#l24.703"></a><span id="l24.703" class="difflineminus">-    mChangeLogEntriesCount++;</span>
<a href="#l24.704"></a><span id="l24.704" class="difflineminus">-    if(!(mChangeLogEntriesCount % 10)) { // Inform the listener every 10 entries</span>
<a href="#l24.705"></a><span id="l24.705" class="difflineminus">-        mListener-&gt;OnProgressChange(nullptr,nullptr,mChangeLogEntriesCount, -1, mChangeLogEntriesCount, -1);</span>
<a href="#l24.706"></a><span id="l24.706" class="difflineminus">-        // In case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l24.707"></a><span id="l24.707" class="difflineminus">-        // uncomment this one and try.</span>
<a href="#l24.708"></a><span id="l24.708" class="difflineminus">-        // PR_Sleep(PR_INTERVAL_NO_WAIT); // give others a chance</span>
<a href="#l24.709"></a><span id="l24.709" class="difflineminus">-    }</span>
<a href="#l24.710"></a><span id="l24.710" class="difflineplus">+  mChangeLogEntriesCount++;</span>
<a href="#l24.711"></a><span id="l24.711" class="difflineplus">+  if (!(mChangeLogEntriesCount % 10)) {  // Inform the listener every 10 entries</span>
<a href="#l24.712"></a><span id="l24.712" class="difflineplus">+    mListener-&gt;OnProgressChange(nullptr, nullptr, mChangeLogEntriesCount, -1,</span>
<a href="#l24.713"></a><span id="l24.713" class="difflineplus">+                                mChangeLogEntriesCount, -1);</span>
<a href="#l24.714"></a><span id="l24.714" class="difflineplus">+    // In case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l24.715"></a><span id="l24.715" class="difflineplus">+    // uncomment this one and try.</span>
<a href="#l24.716"></a><span id="l24.716" class="difflineplus">+    // PR_Sleep(PR_INTERVAL_NO_WAIT); // give others a chance</span>
<a href="#l24.717"></a><span id="l24.717" class="difflineplus">+  }</span>
<a href="#l24.718"></a><span id="l24.718"> </span>
<a href="#l24.719"></a><span id="l24.719"> #ifdef DEBUG_rdayal</span>
<a href="#l24.720"></a><span id="l24.720" class="difflineminus">-    printf (&quot;ChangeLog Replication : Updated Entry : %s for OpType : %u\n&quot;,</span>
<a href="#l24.721"></a><span id="l24.721" class="difflineminus">-                                    NS_ConvertUTF16toUTF8(targetDN).get(), operation);</span>
<a href="#l24.722"></a><span id="l24.722" class="difflineplus">+  printf(&quot;ChangeLog Replication : Updated Entry : %s for OpType : %u\n&quot;,</span>
<a href="#l24.723"></a><span id="l24.723" class="difflineplus">+         NS_ConvertUTF16toUTF8(targetDN).get(), operation);</span>
<a href="#l24.724"></a><span id="l24.724"> #endif</span>
<a href="#l24.725"></a><span id="l24.725"> </span>
<a href="#l24.726"></a><span id="l24.726" class="difflineminus">-    switch(operation) {</span>
<a href="#l24.727"></a><span id="l24.727" class="difflineplus">+  switch (operation) {</span>
<a href="#l24.728"></a><span id="l24.728">     case ENTRY_ADD:</span>
<a href="#l24.729"></a><span id="l24.729" class="difflineminus">-        // Add the DN to the add list if not already in the list</span>
<a href="#l24.730"></a><span id="l24.730" class="difflineminus">-        if(!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l24.731"></a><span id="l24.731" class="difflineminus">-            mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l24.732"></a><span id="l24.732" class="difflineminus">-        break;</span>
<a href="#l24.733"></a><span id="l24.733" class="difflineplus">+      // Add the DN to the add list if not already in the list</span>
<a href="#l24.734"></a><span id="l24.734" class="difflineplus">+      if (!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l24.735"></a><span id="l24.735" class="difflineplus">+        mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l24.736"></a><span id="l24.736" class="difflineplus">+      break;</span>
<a href="#l24.737"></a><span id="l24.737">     case ENTRY_DELETE:</span>
<a href="#l24.738"></a><span id="l24.738" class="difflineminus">-        // Do not check the return here since delete may fail if</span>
<a href="#l24.739"></a><span id="l24.739" class="difflineminus">-        // entry deleted in changelog does not exist in DB</span>
<a href="#l24.740"></a><span id="l24.740" class="difflineminus">-        // for e.g if the user specifies a filter, so go next entry</span>
<a href="#l24.741"></a><span id="l24.741" class="difflineminus">-        DeleteCard(targetDN);</span>
<a href="#l24.742"></a><span id="l24.742" class="difflineminus">-        break;</span>
<a href="#l24.743"></a><span id="l24.743" class="difflineplus">+      // Do not check the return here since delete may fail if</span>
<a href="#l24.744"></a><span id="l24.744" class="difflineplus">+      // entry deleted in changelog does not exist in DB</span>
<a href="#l24.745"></a><span id="l24.745" class="difflineplus">+      // for e.g if the user specifies a filter, so go next entry</span>
<a href="#l24.746"></a><span id="l24.746" class="difflineplus">+      DeleteCard(targetDN);</span>
<a href="#l24.747"></a><span id="l24.747" class="difflineplus">+      break;</span>
<a href="#l24.748"></a><span id="l24.748">     case ENTRY_MODIFY:</span>
<a href="#l24.749"></a><span id="l24.749" class="difflineminus">-        // For modify, delete the entry from DB and add updated entry</span>
<a href="#l24.750"></a><span id="l24.750" class="difflineminus">-        // we do this since we cannot access the changes attribs of changelog</span>
<a href="#l24.751"></a><span id="l24.751" class="difflineminus">-        rv = DeleteCard(targetDN);</span>
<a href="#l24.752"></a><span id="l24.752" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l24.753"></a><span id="l24.753" class="difflineminus">-            if(!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l24.754"></a><span id="l24.754" class="difflineminus">-                mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l24.755"></a><span id="l24.755" class="difflineminus">-        break;</span>
<a href="#l24.756"></a><span id="l24.756" class="difflineplus">+      // For modify, delete the entry from DB and add updated entry</span>
<a href="#l24.757"></a><span id="l24.757" class="difflineplus">+      // we do this since we cannot access the changes attribs of changelog</span>
<a href="#l24.758"></a><span id="l24.758" class="difflineplus">+      rv = DeleteCard(targetDN);</span>
<a href="#l24.759"></a><span id="l24.759" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l24.760"></a><span id="l24.760" class="difflineplus">+        if (!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l24.761"></a><span id="l24.761" class="difflineplus">+          mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l24.762"></a><span id="l24.762" class="difflineplus">+      break;</span>
<a href="#l24.763"></a><span id="l24.763">     default:</span>
<a href="#l24.764"></a><span id="l24.764" class="difflineminus">-        // Should not come here, would come here only</span>
<a href="#l24.765"></a><span id="l24.765" class="difflineminus">-        // if the entry is not a changeLog entry</span>
<a href="#l24.766"></a><span id="l24.766" class="difflineminus">-        NS_WARNING(&quot;nsAbLDAPProcessChangeLogData::ParseChangeLogEntries&quot;</span>
<a href="#l24.767"></a><span id="l24.767" class="difflineminus">-           &quot;Not an changelog entry&quot;);</span>
<a href="#l24.768"></a><span id="l24.768" class="difflineminus">-    }</span>
<a href="#l24.769"></a><span id="l24.769" class="difflineplus">+      // Should not come here, would come here only</span>
<a href="#l24.770"></a><span id="l24.770" class="difflineplus">+      // if the entry is not a changeLog entry</span>
<a href="#l24.771"></a><span id="l24.771" class="difflineplus">+      NS_WARNING(</span>
<a href="#l24.772"></a><span id="l24.772" class="difflineplus">+          &quot;nsAbLDAPProcessChangeLogData::ParseChangeLogEntries&quot;</span>
<a href="#l24.773"></a><span id="l24.773" class="difflineplus">+          &quot;Not an changelog entry&quot;);</span>
<a href="#l24.774"></a><span id="l24.774" class="difflineplus">+  }</span>
<a href="#l24.775"></a><span id="l24.775"> </span>
<a href="#l24.776"></a><span id="l24.776" class="difflineminus">-    // Go ahead processing the next entry, a modify or delete DB operation</span>
<a href="#l24.777"></a><span id="l24.777" class="difflineminus">-    // can 'correctly' fail if the entry is not present in the DB,</span>
<a href="#l24.778"></a><span id="l24.778" class="difflineminus">-    // e.g. in case a filter is specified.</span>
<a href="#l24.779"></a><span id="l24.779" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.780"></a><span id="l24.780" class="difflineplus">+  // Go ahead processing the next entry, a modify or delete DB operation</span>
<a href="#l24.781"></a><span id="l24.781" class="difflineplus">+  // can 'correctly' fail if the entry is not present in the DB,</span>
<a href="#l24.782"></a><span id="l24.782" class="difflineplus">+  // e.g. in case a filter is specified.</span>
<a href="#l24.783"></a><span id="l24.783" class="difflineplus">+  return NS_OK;</span>
<a href="#l24.784"></a><span id="l24.784"> }</span>
<a href="#l24.785"></a><span id="l24.785"> </span>
<a href="#l24.786"></a><span id="l24.786" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnFindingChangesDone()</span>
<a href="#l24.787"></a><span id="l24.787" class="difflineminus">-{</span>
<a href="#l24.788"></a><span id="l24.788" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l24.789"></a><span id="l24.789" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.790"></a><span id="l24.790" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::OnFindingChangesDone() {</span>
<a href="#l24.791"></a><span id="l24.791" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.792"></a><span id="l24.792"> </span>
<a href="#l24.793"></a><span id="l24.793"> #ifdef DEBUG_rdayal</span>
<a href="#l24.794"></a><span id="l24.794" class="difflineminus">-    printf (&quot;ChangeLog Replication : Finding Changes Done \n&quot;);</span>
<a href="#l24.795"></a><span id="l24.795" class="difflineplus">+  printf(&quot;ChangeLog Replication : Finding Changes Done \n&quot;);</span>
<a href="#l24.796"></a><span id="l24.796"> #endif</span>
<a href="#l24.797"></a><span id="l24.797"> </span>
<a href="#l24.798"></a><span id="l24.798" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l24.799"></a><span id="l24.799" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l24.800"></a><span id="l24.800"> </span>
<a href="#l24.801"></a><span id="l24.801" class="difflineminus">-    // No entries to add/update (for updates too we delete and add) entries,</span>
<a href="#l24.802"></a><span id="l24.802" class="difflineminus">-    // we took care of deletes in ParseChangeLogEntries, all Done!</span>
<a href="#l24.803"></a><span id="l24.803" class="difflineminus">-    mEntriesAddedQueryCount = mEntriesToAdd.Count();</span>
<a href="#l24.804"></a><span id="l24.804" class="difflineminus">-    if(mEntriesAddedQueryCount &lt;= 0) {</span>
<a href="#l24.805"></a><span id="l24.805" class="difflineminus">-        if(mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l24.806"></a><span id="l24.806" class="difflineminus">-            // Close the DB, no need to commit since we have not made</span>
<a href="#l24.807"></a><span id="l24.807" class="difflineminus">-            // any changes yet to the DB.</span>
<a href="#l24.808"></a><span id="l24.808" class="difflineminus">-            rv = mReplicationDB-&gt;Close(false);</span>
<a href="#l24.809"></a><span id="l24.809" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication DB Close(no commit) on Success failed&quot;);</span>
<a href="#l24.810"></a><span id="l24.810" class="difflineminus">-            mDBOpen = false;</span>
<a href="#l24.811"></a><span id="l24.811" class="difflineminus">-            // Once are done with the replication file, delete the backup file</span>
<a href="#l24.812"></a><span id="l24.812" class="difflineminus">-            if(mBackupReplicationFile) {</span>
<a href="#l24.813"></a><span id="l24.813" class="difflineminus">-                rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l24.814"></a><span id="l24.814" class="difflineminus">-                NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l24.815"></a><span id="l24.815" class="difflineminus">-            }</span>
<a href="#l24.816"></a><span id="l24.816" class="difflineminus">-        }</span>
<a href="#l24.817"></a><span id="l24.817" class="difflineminus">-        Done(true);</span>
<a href="#l24.818"></a><span id="l24.818" class="difflineminus">-        return NS_OK;</span>
<a href="#l24.819"></a><span id="l24.819" class="difflineplus">+  // No entries to add/update (for updates too we delete and add) entries,</span>
<a href="#l24.820"></a><span id="l24.820" class="difflineplus">+  // we took care of deletes in ParseChangeLogEntries, all Done!</span>
<a href="#l24.821"></a><span id="l24.821" class="difflineplus">+  mEntriesAddedQueryCount = mEntriesToAdd.Count();</span>
<a href="#l24.822"></a><span id="l24.822" class="difflineplus">+  if (mEntriesAddedQueryCount &lt;= 0) {</span>
<a href="#l24.823"></a><span id="l24.823" class="difflineplus">+    if (mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l24.824"></a><span id="l24.824" class="difflineplus">+      // Close the DB, no need to commit since we have not made</span>
<a href="#l24.825"></a><span id="l24.825" class="difflineplus">+      // any changes yet to the DB.</span>
<a href="#l24.826"></a><span id="l24.826" class="difflineplus">+      rv = mReplicationDB-&gt;Close(false);</span>
<a href="#l24.827"></a><span id="l24.827" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l24.828"></a><span id="l24.828" class="difflineplus">+                   &quot;Replication DB Close(no commit) on Success failed&quot;);</span>
<a href="#l24.829"></a><span id="l24.829" class="difflineplus">+      mDBOpen = false;</span>
<a href="#l24.830"></a><span id="l24.830" class="difflineplus">+      // Once are done with the replication file, delete the backup file</span>
<a href="#l24.831"></a><span id="l24.831" class="difflineplus">+      if (mBackupReplicationFile) {</span>
<a href="#l24.832"></a><span id="l24.832" class="difflineplus">+        rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l24.833"></a><span id="l24.833" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l24.834"></a><span id="l24.834" class="difflineplus">+                     &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l24.835"></a><span id="l24.835" class="difflineplus">+      }</span>
<a href="#l24.836"></a><span id="l24.836">     }</span>
<a href="#l24.837"></a><span id="l24.837" class="difflineplus">+    Done(true);</span>
<a href="#l24.838"></a><span id="l24.838" class="difflineplus">+    return NS_OK;</span>
<a href="#l24.839"></a><span id="l24.839" class="difflineplus">+  }</span>
<a href="#l24.840"></a><span id="l24.840"> </span>
<a href="#l24.841"></a><span id="l24.841" class="difflineminus">-    // Decrement the count first to get the correct array element</span>
<a href="#l24.842"></a><span id="l24.842" class="difflineminus">-    mEntriesAddedQueryCount--;</span>
<a href="#l24.843"></a><span id="l24.843" class="difflineminus">-    rv = mChangeLogQuery-&gt;QueryChangedEntries(NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l24.844"></a><span id="l24.844" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.845"></a><span id="l24.845" class="difflineminus">-        return rv;</span>
<a href="#l24.846"></a><span id="l24.846" class="difflineplus">+  // Decrement the count first to get the correct array element</span>
<a href="#l24.847"></a><span id="l24.847" class="difflineplus">+  mEntriesAddedQueryCount--;</span>
<a href="#l24.848"></a><span id="l24.848" class="difflineplus">+  rv = mChangeLogQuery-&gt;QueryChangedEntries(</span>
<a href="#l24.849"></a><span id="l24.849" class="difflineplus">+      NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l24.850"></a><span id="l24.850" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.851"></a><span id="l24.851"> </span>
<a href="#l24.852"></a><span id="l24.852" class="difflineminus">-    if(mListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l24.853"></a><span id="l24.853" class="difflineminus">-        mListener-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_START, true);</span>
<a href="#l24.854"></a><span id="l24.854" class="difflineplus">+  if (mListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l24.855"></a><span id="l24.855" class="difflineplus">+    mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l24.856"></a><span id="l24.856" class="difflineplus">+                             nsIWebProgressListener::STATE_START, true);</span>
<a href="#l24.857"></a><span id="l24.857"> </span>
<a href="#l24.858"></a><span id="l24.858" class="difflineminus">-    mState = kReplicatingChanges;</span>
<a href="#l24.859"></a><span id="l24.859" class="difflineminus">-    return rv;</span>
<a href="#l24.860"></a><span id="l24.860" class="difflineplus">+  mState = kReplicatingChanges;</span>
<a href="#l24.861"></a><span id="l24.861" class="difflineplus">+  return rv;</span>
<a href="#l24.862"></a><span id="l24.862"> }</span>
<a href="#l24.863"></a><span id="l24.863"> </span>
<a href="#l24.864"></a><span id="l24.864" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnReplicatingChangeDone()</span>
<a href="#l24.865"></a><span id="l24.865" class="difflineminus">-{</span>
<a href="#l24.866"></a><span id="l24.866" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l24.867"></a><span id="l24.867" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.868"></a><span id="l24.868" class="difflineplus">+nsresult nsAbLDAPProcessChangeLogData::OnReplicatingChangeDone() {</span>
<a href="#l24.869"></a><span id="l24.869" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l24.870"></a><span id="l24.870"> </span>
<a href="#l24.871"></a><span id="l24.871" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l24.872"></a><span id="l24.872" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l24.873"></a><span id="l24.873"> </span>
<a href="#l24.874"></a><span id="l24.874" class="difflineminus">-    if(!mEntriesAddedQueryCount)</span>
<a href="#l24.875"></a><span id="l24.875" class="difflineminus">-    {</span>
<a href="#l24.876"></a><span id="l24.876" class="difflineminus">-        if(mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l24.877"></a><span id="l24.877" class="difflineminus">-            rv = mReplicationDB-&gt;Close(true); // Commit and close the DB</span>
<a href="#l24.878"></a><span id="l24.878" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication DB Close (commit) on Success failed&quot;);</span>
<a href="#l24.879"></a><span id="l24.879" class="difflineminus">-            mDBOpen = false;</span>
<a href="#l24.880"></a><span id="l24.880" class="difflineminus">-        }</span>
<a href="#l24.881"></a><span id="l24.881" class="difflineminus">-        // Once we done with the replication file, delete the backup file.</span>
<a href="#l24.882"></a><span id="l24.882" class="difflineminus">-        if(mBackupReplicationFile) {</span>
<a href="#l24.883"></a><span id="l24.883" class="difflineminus">-            rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l24.884"></a><span id="l24.884" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l24.885"></a><span id="l24.885" class="difflineminus">-        }</span>
<a href="#l24.886"></a><span id="l24.886" class="difflineminus">-        Done(true);  // All data is received</span>
<a href="#l24.887"></a><span id="l24.887" class="difflineminus">-        return NS_OK;</span>
<a href="#l24.888"></a><span id="l24.888" class="difflineplus">+  if (!mEntriesAddedQueryCount) {</span>
<a href="#l24.889"></a><span id="l24.889" class="difflineplus">+    if (mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l24.890"></a><span id="l24.890" class="difflineplus">+      rv = mReplicationDB-&gt;Close(true);  // Commit and close the DB</span>
<a href="#l24.891"></a><span id="l24.891" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l24.892"></a><span id="l24.892" class="difflineplus">+                   &quot;Replication DB Close (commit) on Success failed&quot;);</span>
<a href="#l24.893"></a><span id="l24.893" class="difflineplus">+      mDBOpen = false;</span>
<a href="#l24.894"></a><span id="l24.894" class="difflineplus">+    }</span>
<a href="#l24.895"></a><span id="l24.895" class="difflineplus">+    // Once we done with the replication file, delete the backup file.</span>
<a href="#l24.896"></a><span id="l24.896" class="difflineplus">+    if (mBackupReplicationFile) {</span>
<a href="#l24.897"></a><span id="l24.897" class="difflineplus">+      rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l24.898"></a><span id="l24.898" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l24.899"></a><span id="l24.899" class="difflineplus">+                   &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l24.900"></a><span id="l24.900">     }</span>
<a href="#l24.901"></a><span id="l24.901" class="difflineplus">+    Done(true);  // All data is received</span>
<a href="#l24.902"></a><span id="l24.902" class="difflineplus">+    return NS_OK;</span>
<a href="#l24.903"></a><span id="l24.903" class="difflineplus">+  }</span>
<a href="#l24.904"></a><span id="l24.904"> </span>
<a href="#l24.905"></a><span id="l24.905" class="difflineminus">-    // Remove the entry already added from the list and query the next one.</span>
<a href="#l24.906"></a><span id="l24.906" class="difflineminus">-    if(mEntriesAddedQueryCount &lt; mEntriesToAdd.Count() &amp;&amp; mEntriesAddedQueryCount &gt;= 0)</span>
<a href="#l24.907"></a><span id="l24.907" class="difflineminus">-        mEntriesToAdd.RemoveStringAt(mEntriesAddedQueryCount);</span>
<a href="#l24.908"></a><span id="l24.908" class="difflineminus">-    mEntriesAddedQueryCount--;</span>
<a href="#l24.909"></a><span id="l24.909" class="difflineminus">-    rv = mChangeLogQuery-&gt;QueryChangedEntries(NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l24.910"></a><span id="l24.910" class="difflineplus">+  // Remove the entry already added from the list and query the next one.</span>
<a href="#l24.911"></a><span id="l24.911" class="difflineplus">+  if (mEntriesAddedQueryCount &lt; mEntriesToAdd.Count() &amp;&amp;</span>
<a href="#l24.912"></a><span id="l24.912" class="difflineplus">+      mEntriesAddedQueryCount &gt;= 0)</span>
<a href="#l24.913"></a><span id="l24.913" class="difflineplus">+    mEntriesToAdd.RemoveStringAt(mEntriesAddedQueryCount);</span>
<a href="#l24.914"></a><span id="l24.914" class="difflineplus">+  mEntriesAddedQueryCount--;</span>
<a href="#l24.915"></a><span id="l24.915" class="difflineplus">+  rv = mChangeLogQuery-&gt;QueryChangedEntries(</span>
<a href="#l24.916"></a><span id="l24.916" class="difflineplus">+      NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l24.917"></a><span id="l24.917"> </span>
<a href="#l24.918"></a><span id="l24.918" class="difflineminus">-    return rv;</span>
<a href="#l24.919"></a><span id="l24.919" class="difflineplus">+  return rv;</span>
<a href="#l24.920"></a><span id="l24.920"> }</span>
<a href="#l24.921"></a><span id="l24.921" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogData.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -5,53 +5,50 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #ifndef nsAbLDAPChangeLogData_h__</span>
<a href="#l25.5"></a><span id="l25.5"> #define nsAbLDAPChangeLogData_h__</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsAbLDAPReplicationData.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> typedef struct {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  nsCString     changeLogDN;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  int32_t       firstChangeNumber;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-  int32_t       lastChangeNumber;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-  nsCString     dataVersion;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+  nsCString changeLogDN;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+  int32_t firstChangeNumber;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  int32_t lastChangeNumber;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+  nsCString dataVersion;</span>
<a href="#l25.20"></a><span id="l25.20"> } RootDSEChangeLogEntry;</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-class nsAbLDAPProcessChangeLogData : public nsAbLDAPProcessReplicationData</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-{</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-public :</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+class nsAbLDAPProcessChangeLogData : public nsAbLDAPProcessReplicationData {</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+ public:</span>
<a href="#l25.28"></a><span id="l25.28">   nsAbLDAPProcessChangeLogData();</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-  NS_IMETHOD Init(nsIAbLDAPReplicationQuery * query, nsIWebProgressListener *progressListener);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+  NS_IMETHOD Init(nsIAbLDAPReplicationQuery *query,</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+                  nsIWebProgressListener *progressListener);</span>
<a href="#l25.33"></a><span id="l25.33"> </span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-protected :</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+ protected:</span>
<a href="#l25.36"></a><span id="l25.36">   ~nsAbLDAPProcessChangeLogData();</span>
<a href="#l25.37"></a><span id="l25.37"> </span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-  nsCOMPtr &lt;nsIAbLDAPChangeLogQuery&gt; mChangeLogQuery;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPChangeLogQuery&gt; mChangeLogQuery;</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41">   nsresult OnLDAPBind(nsILDAPMessage *aMessage);</span>
<a href="#l25.42"></a><span id="l25.42">   nsresult OnLDAPSearchEntry(nsILDAPMessage *aMessage) override;</span>
<a href="#l25.43"></a><span id="l25.43">   nsresult OnLDAPSearchResult(nsILDAPMessage *aMessage) override;</span>
<a href="#l25.44"></a><span id="l25.44"> </span>
<a href="#l25.45"></a><span id="l25.45">   nsresult ParseChangeLogEntries(nsILDAPMessage *aMessage);</span>
<a href="#l25.46"></a><span id="l25.46">   nsresult ParseRootDSEEntry(nsILDAPMessage *aMessage);</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-  nsresult  GetAuthData(); // displays username and password prompt</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+  nsresult GetAuthData();  // displays username and password prompt</span>
<a href="#l25.50"></a><span id="l25.50">   nsCString mAuthUserID;   // user id of the user making the connection</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52">   nsresult OnSearchAuthDNDone();</span>
<a href="#l25.53"></a><span id="l25.53">   nsresult OnSearchRootDSEDone();</span>
<a href="#l25.54"></a><span id="l25.54">   nsresult OnFindingChangesDone();</span>
<a href="#l25.55"></a><span id="l25.55">   nsresult OnReplicatingChangeDone();</span>
<a href="#l25.56"></a><span id="l25.56"> </span>
<a href="#l25.57"></a><span id="l25.57">   RootDSEChangeLogEntry mRootDSEEntry;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-  bool    mUseChangeLog;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+  bool mUseChangeLog;</span>
<a href="#l25.60"></a><span id="l25.60">   int32_t mChangeLogEntriesCount;</span>
<a href="#l25.61"></a><span id="l25.61"> </span>
<a href="#l25.62"></a><span id="l25.62">   int32_t mEntriesAddedQueryCount;</span>
<a href="#l25.63"></a><span id="l25.63">   nsStringArray mEntriesToAdd;</span>
<a href="#l25.64"></a><span id="l25.64"> };</span>
<a href="#l25.65"></a><span id="l25.65"> </span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-#endif // nsAbLDAPChangeLogData_h__</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+#endif  // nsAbLDAPChangeLogData_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,180 +1,148 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l26.5"></a><span id="l26.5">  *</span>
<a href="#l26.6"></a><span id="l26.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.7"></a><span id="l26.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.8"></a><span id="l26.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-</span>
<a href="#l26.11"></a><span id="l26.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l26.12"></a><span id="l26.12"> #include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l26.13"></a><span id="l26.13"> #include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l26.14"></a><span id="l26.14"> #include &quot;nsAbLDAPChangeLogData.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16"> #include &quot;prprf.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-</span>
<a href="#l26.21"></a><span id="l26.21"> // The tables below were originally in nsAbLDAPProperties.cpp, which has since</span>
<a href="#l26.22"></a><span id="l26.22"> // gone away.</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-static const char * sChangeLogRootDSEAttribs[] =</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-{</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-  &quot;changelog&quot;,</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-  &quot;firstChangeNumber&quot;,</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-  &quot;lastChangeNumber&quot;,</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-  &quot;dataVersion&quot;</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-};</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-static const char * sChangeLogEntryAttribs[] =</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-{</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  &quot;targetdn&quot;,</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-  &quot;changetype&quot;</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-};</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+static const char *sChangeLogRootDSEAttribs[] = {</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+    &quot;changelog&quot;, &quot;firstChangeNumber&quot;, &quot;lastChangeNumber&quot;, &quot;dataVersion&quot;};</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+static const char *sChangeLogEntryAttribs[] = {&quot;targetdn&quot;, &quot;changetype&quot;};</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPChangeLogQuery, nsAbLDAPReplicationQuery,</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+                            nsIAbLDAPChangeLogQuery)</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPChangeLogQuery, nsAbLDAPReplicationQuery, nsIAbLDAPChangeLogQuery)</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-nsAbLDAPChangeLogQuery::nsAbLDAPChangeLogQuery()</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-{</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-}</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+nsAbLDAPChangeLogQuery::nsAbLDAPChangeLogQuery() {}</span>
<a href="#l26.49"></a><span id="l26.49"> </span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-nsAbLDAPChangeLogQuery::~nsAbLDAPChangeLogQuery()</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-{</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+nsAbLDAPChangeLogQuery::~nsAbLDAPChangeLogQuery() {}</span>
<a href="#l26.53"></a><span id="l26.53"> </span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-}</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-// this is to be defined only till this is not hooked to SSL to get authDN and authPswd</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+// this is to be defined only till this is not hooked to SSL to get authDN and</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+// authPswd</span>
<a href="#l26.59"></a><span id="l26.59"> #define USE_AUTHDLG</span>
<a href="#l26.60"></a><span id="l26.60"> </span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::Init(const nsACString &amp; aPrefName, nsIWebProgressListener *aProgressListener)</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-{</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-    if(aPrefName.IsEmpty())</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+NS_IMETHODIMP nsAbLDAPChangeLogQuery::Init(</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+    const nsACString &amp;aPrefName, nsIWebProgressListener *aProgressListener) {</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+  if (aPrefName.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.68"></a><span id="l26.68"> </span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-    mDirPrefName = aPrefName;</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+  mDirPrefName = aPrefName;</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  nsresult rv = InitLDAPData();</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.74"></a><span id="l26.74"> </span>
<a href="#l26.75"></a><span id="l26.75" class="difflineminus">-    nsresult rv = InitLDAPData();</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineminus">-        return rv;</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+  // create the ChangeLog Data Processor</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+  mDataProcessor =</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+      do_CreateInstance(NS_ABLDAP_PROCESSCHANGELOGDATA_CONTRACTID, &amp;rv);</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.82"></a><span id="l26.82"> </span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-    // create the ChangeLog Data Processor</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineminus">-    mDataProcessor =  do_CreateInstance(NS_ABLDAP_PROCESSCHANGELOGDATA_CONTRACTID, &amp;rv);</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-        return rv;</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+  // 'this' initialized</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+  mInitialized = true;</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90" class="difflineminus">-    // 'this' initialized</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-    mInitialized = true;</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-    return mDataProcessor-&gt;Init(this, aProgressListener);</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+  return mDataProcessor-&gt;Init(this, aProgressListener);</span>
<a href="#l26.95"></a><span id="l26.95"> }</span>
<a href="#l26.96"></a><span id="l26.96"> </span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::DoReplicationQuery()</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-{</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+NS_IMETHODIMP nsAbLDAPChangeLogQuery::DoReplicationQuery() {</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.103"></a><span id="l26.103"> </span>
<a href="#l26.104"></a><span id="l26.104"> #ifdef USE_AUTHDLG</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-    return ConnectToLDAPServer(mURL, EmptyCString());</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+  return ConnectToLDAPServer(mURL, EmptyCString());</span>
<a href="#l26.107"></a><span id="l26.107"> #else</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-    mDataProcessor-&gt;PopulateAuthData();</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-    return ConnectToLDAPServer(mURL, mAuthDN);</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+  mDataProcessor-&gt;PopulateAuthData();</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+  return ConnectToLDAPServer(mURL, mAuthDN);</span>
<a href="#l26.112"></a><span id="l26.112"> #endif</span>
<a href="#l26.113"></a><span id="l26.113"> }</span>
<a href="#l26.114"></a><span id="l26.114"> </span>
<a href="#l26.115"></a><span id="l26.115" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryAuthDN(const nsACString &amp; aValueUsedToFindDn)</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineminus">-{</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineplus">+NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryAuthDN(</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+    const nsACString &amp;aValueUsedToFindDn) {</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.122"></a><span id="l26.122"> </span>
<a href="#l26.123"></a><span id="l26.123">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l26.124"></a><span id="l26.124">   nsresult rv = mDirectory-&gt;GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l26.125"></a><span id="l26.125">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.126"></a><span id="l26.126"> </span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-    nsAutoCString filter;</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-    rv = attrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(&quot;PrimaryEmail&quot;), filter);</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+  nsAutoCString filter;</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+  rv = attrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(&quot;PrimaryEmail&quot;), filter);</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.133"></a><span id="l26.133"> </span>
<a href="#l26.134"></a><span id="l26.134" class="difflineminus">-    filter += '=';</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineminus">-    filter += aValueUsedToFindDn;</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineplus">+  filter += '=';</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineplus">+  filter += aValueUsedToFindDn;</span>
<a href="#l26.138"></a><span id="l26.138"> </span>
<a href="#l26.139"></a><span id="l26.139" class="difflineminus">-    nsAutoCString dn;</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineminus">-    rv = mURL-&gt;GetDn(dn);</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineminus">-        return rv;</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineplus">+  nsAutoCString dn;</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineplus">+  rv = mURL-&gt;GetDn(dn);</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.146"></a><span id="l26.146"> </span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-    rv = CreateNewLDAPOperation();</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+  rv = CreateNewLDAPOperation();</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.151"></a><span id="l26.151"> </span>
<a href="#l26.152"></a><span id="l26.152" class="difflineminus">-    // XXX We really should be using LDAP_NO_ATTRS here once its exposed via</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineminus">-    // the XPCOM layer of the directory code.</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineminus">-    return mOperation-&gt;SearchExt(dn, nsILDAPURL::SCOPE_SUBTREE, filter,</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineminus">-                               0, nullptr,</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineminus">-                               0, 0);</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineplus">+  // XXX We really should be using LDAP_NO_ATTRS here once its exposed via</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineplus">+  // the XPCOM layer of the directory code.</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineplus">+  return mOperation-&gt;SearchExt(dn, nsILDAPURL::SCOPE_SUBTREE, filter, 0,</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineplus">+                               nullptr, 0, 0);</span>
<a href="#l26.161"></a><span id="l26.161"> }</span>
<a href="#l26.162"></a><span id="l26.162"> </span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryRootDSE()</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-{</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineplus">+NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryRootDSE() {</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.169"></a><span id="l26.169"> </span>
<a href="#l26.170"></a><span id="l26.170" class="difflineminus">-    nsresult rv = CreateNewLDAPOperation();</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineminus">-    return mOperation-&gt;SearchExt(EmptyCString(), nsILDAPURL::SCOPE_BASE,</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-                                 NS_LITERAL_CSTRING(&quot;objectclass=*&quot;),</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-                                 sizeof(sChangeLogRootDSEAttribs),</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineminus">-                                 sChangeLogRootDSEAttribs, 0, 0);</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineplus">+  nsresult rv = CreateNewLDAPOperation();</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+  return mOperation-&gt;SearchExt(EmptyCString(), nsILDAPURL::SCOPE_BASE,</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineplus">+                               NS_LITERAL_CSTRING(&quot;objectclass=*&quot;),</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineplus">+                               sizeof(sChangeLogRootDSEAttribs),</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineplus">+                               sChangeLogRootDSEAttribs, 0, 0);</span>
<a href="#l26.182"></a><span id="l26.182"> }</span>
<a href="#l26.183"></a><span id="l26.183"> </span>
<a href="#l26.184"></a><span id="l26.184" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangeLog(const nsACString &amp; aChangeLogDN, int32_t aLastChangeNo)</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineminus">-{</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineminus">-  if (aChangeLogDN.IsEmpty())</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineplus">+NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangeLog(</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineplus">+    const nsACString &amp;aChangeLogDN, int32_t aLastChangeNo) {</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineplus">+  if (aChangeLogDN.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.194"></a><span id="l26.194"> </span>
<a href="#l26.195"></a><span id="l26.195">   int32_t lastChangeNumber;</span>
<a href="#l26.196"></a><span id="l26.196">   nsresult rv = mDirectory-&gt;GetLastChangeNumber(&amp;lastChangeNumber);</span>
<a href="#l26.197"></a><span id="l26.197">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.198"></a><span id="l26.198"> </span>
<a href="#l26.199"></a><span id="l26.199">   // make sure that the filter here just have one condition</span>
<a href="#l26.200"></a><span id="l26.200">   // and should not be enclosed in enclosing brackets.</span>
<a href="#l26.201"></a><span id="l26.201">   // also condition '&gt;' does not work, it should be '&gt;='/</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineminus">-  nsAutoCString filter (NS_LITERAL_CSTRING(&quot;changenumber&gt;=&quot;));</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineplus">+  nsAutoCString filter(NS_LITERAL_CSTRING(&quot;changenumber&gt;=&quot;));</span>
<a href="#l26.204"></a><span id="l26.204">   filter.AppendInt(lastChangeNumber + 1);</span>
<a href="#l26.205"></a><span id="l26.205"> </span>
<a href="#l26.206"></a><span id="l26.206">   rv = CreateNewLDAPOperation();</span>
<a href="#l26.207"></a><span id="l26.207">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.208"></a><span id="l26.208"> </span>
<a href="#l26.209"></a><span id="l26.209">   return mOperation-&gt;SearchExt(aChangeLogDN, nsILDAPURL::SCOPE_ONELEVEL, filter,</span>
<a href="#l26.210"></a><span id="l26.210">                                sizeof(sChangeLogEntryAttribs),</span>
<a href="#l26.211"></a><span id="l26.211">                                sChangeLogEntryAttribs, 0, 0);</span>
<a href="#l26.212"></a><span id="l26.212"> }</span>
<a href="#l26.213"></a><span id="l26.213"> </span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangedEntries(const nsACString &amp; aChangedEntryDN)</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineminus">-{</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-    if(aChangedEntryDN.IsEmpty())</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineplus">+NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangedEntries(</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+    const nsACString &amp;aChangedEntryDN) {</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineplus">+  if (aChangedEntryDN.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.224"></a><span id="l26.224"> </span>
<a href="#l26.225"></a><span id="l26.225" class="difflineminus">-    nsAutoCString urlFilter;</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineminus">-    nsresult rv = mURL-&gt;GetFilter(urlFilter);</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-        return rv;</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineplus">+  nsAutoCString urlFilter;</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineplus">+  nsresult rv = mURL-&gt;GetFilter(urlFilter);</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.232"></a><span id="l26.232"> </span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-    int32_t scope;</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-    rv = mURL-&gt;GetScope(&amp;scope);</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineminus">-        return rv;</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineplus">+  int32_t scope;</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineplus">+  rv = mURL-&gt;GetScope(&amp;scope);</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.240"></a><span id="l26.240"> </span>
<a href="#l26.241"></a><span id="l26.241" class="difflineminus">-    CharPtrArrayGuard attributes;</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineminus">-    rv = mURL-&gt;GetAttributes(attributes.GetSizeAddr(), attributes.GetArrayAddr());</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineminus">-        return rv;</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineplus">+  CharPtrArrayGuard attributes;</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineplus">+  rv = mURL-&gt;GetAttributes(attributes.GetSizeAddr(), attributes.GetArrayAddr());</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.248"></a><span id="l26.248"> </span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-    rv = CreateNewLDAPOperation();</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineminus">-    return mOperation-&gt;SearchExt(aChangedEntryDN, scope, urlFilter,</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineminus">-                               attributes.GetSize(), attributes.GetArray(),</span>
<a href="#l26.253"></a><span id="l26.253" class="difflineminus">-                               0, 0);</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineplus">+  rv = CreateNewLDAPOperation();</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineplus">+  return mOperation-&gt;SearchExt(aChangedEntryDN, scope, urlFilter,</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineplus">+                               attributes.GetSize(), attributes.GetArray(), 0,</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineplus">+                               0);</span>
<a href="#l26.259"></a><span id="l26.259"> }</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -7,22 +7,22 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #ifndef nsAbLDAPChangeLogQuery_h__</span>
<a href="#l27.5"></a><span id="l27.5"> #define nsAbLDAPChangeLogQuery_h__</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l27.8"></a><span id="l27.8"> #include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l27.9"></a><span id="l27.9"> #include &quot;nsString.h&quot;</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> class nsAbLDAPChangeLogQuery : public nsIAbLDAPChangeLogQuery,</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-                               public nsAbLDAPReplicationQuery</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-{</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-public :</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+                               public nsAbLDAPReplicationQuery {</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+ public:</span>
<a href="#l27.17"></a><span id="l27.17">   NS_DECL_ISUPPORTS</span>
<a href="#l27.18"></a><span id="l27.18">   NS_DECL_NSIABLDAPCHANGELOGQUERY</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   nsAbLDAPChangeLogQuery();</span>
<a href="#l27.21"></a><span id="l27.21">   virtual ~nsAbLDAPChangeLogQuery();</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23">   NS_IMETHOD DoReplicationQuery() override;</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-  NS_IMETHOD Init(const nsACString &amp; aPrefName, nsIWebProgressListener *aProgressListener);</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+  NS_IMETHOD Init(const nsACString &amp;aPrefName,</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+                  nsIWebProgressListener *aProgressListener);</span>
<a href="#l27.27"></a><span id="l27.27"> };</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-#endif // nsAbLDAPChangeLogQuery_h__</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+#endif  // nsAbLDAPChangeLogQuery_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -11,30 +11,25 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsAbLDAPDirectory.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> NS_IMPL_ISUPPORTS(nsAbLDAPDirFactory, nsIAbDirFactory)</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-nsAbLDAPDirFactory::nsAbLDAPDirFactory()</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-{</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-}</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+nsAbLDAPDirFactory::nsAbLDAPDirFactory() {}</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-nsAbLDAPDirFactory::~nsAbLDAPDirFactory()</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-{</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-}</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+nsAbLDAPDirFactory::~nsAbLDAPDirFactory() {}</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22"> NS_IMETHODIMP</span>
<a href="#l28.23"></a><span id="l28.23"> nsAbLDAPDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l28.24"></a><span id="l28.24">                                    const nsACString &amp;aURI,</span>
<a href="#l28.25"></a><span id="l28.25">                                    const nsACString &amp;aPrefName,</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-                                   nsISimpleEnumerator **aDirectories)</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-{</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+                                   nsISimpleEnumerator **aDirectories) {</span>
<a href="#l28.29"></a><span id="l28.29">   NS_ENSURE_ARG_POINTER(aDirectories);</span>
<a href="#l28.30"></a><span id="l28.30"> </span>
<a href="#l28.31"></a><span id="l28.31">   nsresult rv;</span>
<a href="#l28.32"></a><span id="l28.32">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l28.33"></a><span id="l28.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l28.36"></a><span id="l28.36">   if (Substring(aURI, 0, 5).EqualsLiteral(&quot;ldap:&quot;) ||</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineat">@@ -54,26 +49,24 @@ nsAbLDAPDirFactory::GetDirectories(const</span>
<a href="#l28.38"></a><span id="l28.38">      * and when we need the hostname, basedn, port, etc,</span>
<a href="#l28.39"></a><span id="l28.39">      * we'll use the &lt;prefName&gt; to get the necessary prefs.</span>
<a href="#l28.40"></a><span id="l28.40">      * note, &lt;prefName&gt; does not change.</span>
<a href="#l28.41"></a><span id="l28.41">      */</span>
<a href="#l28.42"></a><span id="l28.42">     nsAutoCString bridgeURI;</span>
<a href="#l28.43"></a><span id="l28.43">     bridgeURI = NS_LITERAL_CSTRING(kLDAPDirectoryRoot);</span>
<a href="#l28.44"></a><span id="l28.44">     bridgeURI += aPrefName;</span>
<a href="#l28.45"></a><span id="l28.45">     rv = abManager-&gt;GetDirectory(bridgeURI, getter_AddRefs(directory));</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-  }</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-  else {</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+  } else {</span>
<a href="#l28.49"></a><span id="l28.49">     rv = abManager-&gt;GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l28.50"></a><span id="l28.50">   }</span>
<a href="#l28.51"></a><span id="l28.51">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53">   return NS_NewSingletonEnumerator(aDirectories, directory);</span>
<a href="#l28.54"></a><span id="l28.54"> }</span>
<a href="#l28.55"></a><span id="l28.55"> </span>
<a href="#l28.56"></a><span id="l28.56"> /* void deleteDirectory (in nsIAbDirectory directory); */</span>
<a href="#l28.57"></a><span id="l28.57"> NS_IMETHODIMP</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-nsAbLDAPDirFactory::DeleteDirectory(nsIAbDirectory *directory)</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-{</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+nsAbLDAPDirFactory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l28.61"></a><span id="l28.61">   // No actual deletion - as the LDAP Address Book is not physically</span>
<a href="#l28.62"></a><span id="l28.62">   // created in the corresponding CreateDirectory() unlike the Personal</span>
<a href="#l28.63"></a><span id="l28.63">   // Address Books. But we still need to return NS_OK from here.</span>
<a href="#l28.64"></a><span id="l28.64">   return NS_OK;</span>
<a href="#l28.65"></a><span id="l28.65"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirFactory.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirFactory.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -3,21 +3,20 @@</span>
<a href="#l29.4"></a><span id="l29.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.5"></a><span id="l29.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> #ifndef nsAbLDAPDirFactory_h__</span>
<a href="#l29.8"></a><span id="l29.8"> #define nsAbLDAPDirFactory_h__</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10"> #include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-class nsAbLDAPDirFactory : public nsIAbDirFactory</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-{</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-public:</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+class nsAbLDAPDirFactory : public nsIAbDirFactory {</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+ public:</span>
<a href="#l29.17"></a><span id="l29.17">   NS_DECL_ISUPPORTS</span>
<a href="#l29.18"></a><span id="l29.18">   NS_DECL_NSIABDIRFACTORY</span>
<a href="#l29.19"></a><span id="l29.19"> </span>
<a href="#l29.20"></a><span id="l29.20">   nsAbLDAPDirFactory();</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-private:</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+ private:</span>
<a href="#l29.24"></a><span id="l29.24">   virtual ~nsAbLDAPDirFactory();</span>
<a href="#l29.25"></a><span id="l29.25"> };</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -35,167 +35,147 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l30.5"></a><span id="l30.5"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> #define kDefaultMaxHits 100</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> using namespace mozilla;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-nsAbLDAPDirectory::nsAbLDAPDirectory() :</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  nsAbDirProperty(),</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-  mPerformingQuery(false),</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-  mContext(0),</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-  mLock(&quot;nsAbLDAPDirectory.mLock&quot;)</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-{</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-}</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+nsAbLDAPDirectory::nsAbLDAPDirectory()</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+    : nsAbDirProperty(),</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+      mPerformingQuery(false),</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+      mContext(0),</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+      mLock(&quot;nsAbLDAPDirectory.mLock&quot;) {}</span>
<a href="#l30.24"></a><span id="l30.24"> </span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-nsAbLDAPDirectory::~nsAbLDAPDirectory()</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-{</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-}</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+nsAbLDAPDirectory::~nsAbLDAPDirectory() {}</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30"> NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPDirectory, nsAbDirProperty,</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-                             nsISupportsWeakReference, nsIAbDirSearchListener,</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-                             nsIAbLDAPDirectory)</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+                            nsISupportsWeakReference, nsIAbDirSearchListener,</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+                            nsIAbLDAPDirectory)</span>
<a href="#l30.35"></a><span id="l30.35"> </span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetPropertiesChromeURI(nsACString &amp;aResult)</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-{</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-  aResult.AssignLiteral(&quot;chrome://messenger/content/addressbook/pref-directory-add.xul&quot;);</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetPropertiesChromeURI(nsACString &amp;aResult) {</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+  aResult.AssignLiteral(</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+      &quot;chrome://messenger/content/addressbook/pref-directory-add.xul&quot;);</span>
<a href="#l30.42"></a><span id="l30.42">   return NS_OK;</span>
<a href="#l30.43"></a><span id="l30.43"> }</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::Init(const char* aURI)</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-{</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::Init(const char *aURI) {</span>
<a href="#l30.48"></a><span id="l30.48">   // We need to ensure that the m_DirPrefId is initialized properly</span>
<a href="#l30.49"></a><span id="l30.49">   nsAutoCString uri(aURI);</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51">   // Find the first ? (of the search params) if there is one.</span>
<a href="#l30.52"></a><span id="l30.52">   // We know we can start at the end of the moz-abldapdirectory:// because</span>
<a href="#l30.53"></a><span id="l30.53">   // that's the URI we should have been passed.</span>
<a href="#l30.54"></a><span id="l30.54">   int32_t searchCharLocation = uri.FindChar('?', kLDAPDirectoryRootLen);</span>
<a href="#l30.55"></a><span id="l30.55"> </span>
<a href="#l30.56"></a><span id="l30.56">   if (searchCharLocation == -1)</span>
<a href="#l30.57"></a><span id="l30.57">     m_DirPrefId = Substring(uri, kLDAPDirectoryRootLen);</span>
<a href="#l30.58"></a><span id="l30.58">   else</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-    m_DirPrefId = Substring(uri, kLDAPDirectoryRootLen, searchCharLocation - kLDAPDirectoryRootLen);</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+    m_DirPrefId = Substring(uri, kLDAPDirectoryRootLen,</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+                            searchCharLocation - kLDAPDirectoryRootLen);</span>
<a href="#l30.62"></a><span id="l30.62"> </span>
<a href="#l30.63"></a><span id="l30.63">   return nsAbDirProperty::Init(aURI);</span>
<a href="#l30.64"></a><span id="l30.64"> }</span>
<a href="#l30.65"></a><span id="l30.65"> </span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-nsresult nsAbLDAPDirectory::Initiate()</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-{</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-  return NS_OK;</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-}</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+nsresult nsAbLDAPDirectory::Initiate() { return NS_OK; }</span>
<a href="#l30.71"></a><span id="l30.71"> </span>
<a href="#l30.72"></a><span id="l30.72"> /*</span>
<a href="#l30.73"></a><span id="l30.73">  *</span>
<a href="#l30.74"></a><span id="l30.74">  * nsIAbDirectory methods</span>
<a href="#l30.75"></a><span id="l30.75">  *</span>
<a href="#l30.76"></a><span id="l30.76">  */</span>
<a href="#l30.77"></a><span id="l30.77"> </span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-{</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetURI(nsACString &amp;aURI) {</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.84"></a><span id="l30.84"> </span>
<a href="#l30.85"></a><span id="l30.85">   aURI = mURI;</span>
<a href="#l30.86"></a><span id="l30.86">   return NS_OK;</span>
<a href="#l30.87"></a><span id="l30.87"> }</span>
<a href="#l30.88"></a><span id="l30.88"> </span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetChildNodes(nsISimpleEnumerator* *aResult)</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-{</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetChildNodes(nsISimpleEnumerator **aResult) {</span>
<a href="#l30.92"></a><span id="l30.92">   return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l30.93"></a><span id="l30.93"> }</span>
<a href="#l30.94"></a><span id="l30.94"> </span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetChildCards(nsISimpleEnumerator** result)</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-{</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-    nsresult rv;</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetChildCards(nsISimpleEnumerator **result) {</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+  nsresult rv;</span>
<a href="#l30.100"></a><span id="l30.100"> </span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-    // when offline, we need to get the child cards for the local, replicated mdb directory</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-    bool offline;</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-    nsCOMPtr &lt;nsIIOService&gt; ioService =</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-      mozilla::services::GetIOService();</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-    NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-    rv = ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-    if (offline) {</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-      nsCString fileName;</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-      rv = GetReplicationFileName(fileName);</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-      // if there is no fileName, bail out now.</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-      if (fileName.IsEmpty())</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-        return NS_OK;</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+  // when offline, we need to get the child cards for the local, replicated mdb</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+  // directory</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+  bool offline;</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+  NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+  rv = ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.124"></a><span id="l30.124"> </span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">-      // perform the same query, but on the local directory</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineminus">-      nsAutoCString localDirectoryURI(NS_LITERAL_CSTRING(kMDBDirectoryRoot));</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineminus">-      localDirectoryURI.Append(fileName);</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-      if (mIsQueryURI)</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-      {</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineminus">-        localDirectoryURI.Append('?');</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineminus">-        localDirectoryURI.Append(mQueryString);</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-      }</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineminus">-</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineminus">-      nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">-                                                     &amp;rv));</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+  if (offline) {</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+    nsCString fileName;</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+    rv = GetReplicationFileName(fileName);</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.141"></a><span id="l30.141"> </span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-      nsCOMPtr &lt;nsIAbDirectory&gt; directory;</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-      rv = abManager-&gt;GetDirectory(localDirectoryURI,</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-                                   getter_AddRefs(directory));</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+    // if there is no fileName, bail out now.</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+    if (fileName.IsEmpty()) return NS_OK;</span>
<a href="#l30.148"></a><span id="l30.148"> </span>
<a href="#l30.149"></a><span id="l30.149" class="difflineminus">-      rv = directory-&gt;GetChildCards(result);</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineminus">-    }</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineminus">-    else {</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-      // Start the search</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-      rv = StartSearch();</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineminus">-</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-      rv = NS_NewEmptyEnumerator(result);</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+    // perform the same query, but on the local directory</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+    nsAutoCString localDirectoryURI(NS_LITERAL_CSTRING(kMDBDirectoryRoot));</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+    localDirectoryURI.Append(fileName);</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineplus">+    if (mIsQueryURI) {</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineplus">+      localDirectoryURI.Append('?');</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+      localDirectoryURI.Append(mQueryString);</span>
<a href="#l30.163"></a><span id="l30.163">     }</span>
<a href="#l30.164"></a><span id="l30.164"> </span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-    return rv;</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+    rv = abManager-&gt;GetDirectory(localDirectoryURI, getter_AddRefs(directory));</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+    rv = directory-&gt;GetChildCards(result);</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+  } else {</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+    // Start the search</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineplus">+    rv = StartSearch();</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+    rv = NS_NewEmptyEnumerator(result);</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+  }</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+  return rv;</span>
<a href="#l30.186"></a><span id="l30.186"> }</span>
<a href="#l30.187"></a><span id="l30.187"> </span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetIsQuery(bool *aResult)</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-{</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetIsQuery(bool *aResult) {</span>
<a href="#l30.191"></a><span id="l30.191">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l30.192"></a><span id="l30.192">   *aResult = mIsQueryURI;</span>
<a href="#l30.193"></a><span id="l30.193">   return NS_OK;</span>
<a href="#l30.194"></a><span id="l30.194"> }</span>
<a href="#l30.195"></a><span id="l30.195"> </span>
<a href="#l30.196"></a><span id="l30.196" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::HasCard(nsIAbCard* card, bool* hasCard)</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineminus">-{</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineminus">-  nsresult rv = Initiate ();</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::HasCard(nsIAbCard *card, bool *hasCard) {</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+  nsresult rv = Initiate();</span>
<a href="#l30.201"></a><span id="l30.201">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.202"></a><span id="l30.202"> </span>
<a href="#l30.203"></a><span id="l30.203">   // Enter lock</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-  MutexAutoLock lock (mLock);</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+  MutexAutoLock lock(mLock);</span>
<a href="#l30.206"></a><span id="l30.206"> </span>
<a href="#l30.207"></a><span id="l30.207">   *hasCard = mCache.Get(card, nullptr);</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineminus">-  if (!*hasCard &amp;&amp; mPerformingQuery)</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+  if (!*hasCard &amp;&amp; mPerformingQuery) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l30.211"></a><span id="l30.211"> </span>
<a href="#l30.212"></a><span id="l30.212">   return NS_OK;</span>
<a href="#l30.213"></a><span id="l30.213"> }</span>
<a href="#l30.214"></a><span id="l30.214"> </span>
<a href="#l30.215"></a><span id="l30.215" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetLDAPURL(nsILDAPURL** aResult)</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineminus">-{</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetLDAPURL(nsILDAPURL **aResult) {</span>
<a href="#l30.218"></a><span id="l30.218">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l30.219"></a><span id="l30.219"> </span>
<a href="#l30.220"></a><span id="l30.220">   // Rather than using GetURI here we call GetStringValue directly so</span>
<a href="#l30.221"></a><span id="l30.221">   // we can handle the case where the URI isn't specified (see comments</span>
<a href="#l30.222"></a><span id="l30.222">   // below)</span>
<a href="#l30.223"></a><span id="l30.223">   nsAutoCString URI;</span>
<a href="#l30.224"></a><span id="l30.224">   nsresult rv = GetStringValue(&quot;uri&quot;, EmptyCString(), URI);</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineminus">-  if (NS_FAILED(rv) || URI.IsEmpty())</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineminus">-  {</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineplus">+  if (NS_FAILED(rv) || URI.IsEmpty()) {</span>
<a href="#l30.228"></a><span id="l30.228">     /*</span>
<a href="#l30.229"></a><span id="l30.229">      * A recent change in Mozilla now means that the LDAP Address Book</span>
<a href="#l30.230"></a><span id="l30.230">      * URI is based on the unique preference name value i.e.</span>
<a href="#l30.231"></a><span id="l30.231">      * [moz-abldapdirectory://prefName]</span>
<a href="#l30.232"></a><span id="l30.232">      * Prior to this valid change it was based on the actual uri i.e.</span>
<a href="#l30.233"></a><span id="l30.233">      * [moz-abldapdirectory://host:port/basedn]</span>
<a href="#l30.234"></a><span id="l30.234">      * Basing the resource on the prefName allows these attributes to</span>
<a href="#l30.235"></a><span id="l30.235">      * change.</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineat">@@ -209,29 +189,27 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetLDAP</span>
<a href="#l30.237"></a><span id="l30.237">      * case where it is not a preference, we need to replace the</span>
<a href="#l30.238"></a><span id="l30.238">      * &quot;moz-abldapdirectory&quot;.</span>
<a href="#l30.239"></a><span id="l30.239">      */</span>
<a href="#l30.240"></a><span id="l30.240">     URI = mURINoQuery;</span>
<a href="#l30.241"></a><span id="l30.241">     if (StringBeginsWith(URI, NS_LITERAL_CSTRING(kLDAPDirectoryRoot)))</span>
<a href="#l30.242"></a><span id="l30.242">       URI.Replace(0, kLDAPDirectoryRootLen, NS_LITERAL_CSTRING(&quot;ldap://&quot;));</span>
<a href="#l30.243"></a><span id="l30.243">   }</span>
<a href="#l30.244"></a><span id="l30.244"> </span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l30.248"></a><span id="l30.248">   NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l30.249"></a><span id="l30.249"> </span>
<a href="#l30.250"></a><span id="l30.250">   nsCOMPtr&lt;nsIURI&gt; result;</span>
<a href="#l30.251"></a><span id="l30.251">   rv = ioService-&gt;NewURI(URI, nullptr, nullptr, getter_AddRefs(result));</span>
<a href="#l30.252"></a><span id="l30.252">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.253"></a><span id="l30.253"> </span>
<a href="#l30.254"></a><span id="l30.254">   return CallQueryInterface(result, aResult);</span>
<a href="#l30.255"></a><span id="l30.255"> }</span>
<a href="#l30.256"></a><span id="l30.256"> </span>
<a href="#l30.257"></a><span id="l30.257" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetLDAPURL(nsILDAPURL *aUrl)</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineminus">-{</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetLDAPURL(nsILDAPURL *aUrl) {</span>
<a href="#l30.260"></a><span id="l30.260">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l30.261"></a><span id="l30.261"> </span>
<a href="#l30.262"></a><span id="l30.262">   nsAutoCString oldUrl;</span>
<a href="#l30.263"></a><span id="l30.263">   // Note, it doesn't matter if GetStringValue fails - we'll just send an</span>
<a href="#l30.264"></a><span id="l30.264">   // update if its blank (i.e. old value not set).</span>
<a href="#l30.265"></a><span id="l30.265">   GetStringValue(&quot;uri&quot;, EmptyCString(), oldUrl);</span>
<a href="#l30.266"></a><span id="l30.266"> </span>
<a href="#l30.267"></a><span id="l30.267">   // Actually set the new value.</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineat">@@ -241,479 +219,448 @@ NS_IMETHODIMP nsAbLDAPDirectory::SetLDAP</span>
<a href="#l30.269"></a><span id="l30.269"> </span>
<a href="#l30.270"></a><span id="l30.270">   rv = SetStringValue(&quot;uri&quot;, tempLDAPURL);</span>
<a href="#l30.271"></a><span id="l30.271">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.272"></a><span id="l30.272"> </span>
<a href="#l30.273"></a><span id="l30.273">   // Now we need to send an update which will ensure our indicators and</span>
<a href="#l30.274"></a><span id="l30.274">   // listeners get updated correctly.</span>
<a href="#l30.275"></a><span id="l30.275"> </span>
<a href="#l30.276"></a><span id="l30.276">   // See if they both start with ldaps: or ldap:</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineminus">-  bool newIsNotSecure = StringBeginsWith(tempLDAPURL, NS_LITERAL_CSTRING(&quot;ldap:&quot;));</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+  bool newIsNotSecure =</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+      StringBeginsWith(tempLDAPURL, NS_LITERAL_CSTRING(&quot;ldap:&quot;));</span>
<a href="#l30.280"></a><span id="l30.280"> </span>
<a href="#l30.281"></a><span id="l30.281">   if (oldUrl.IsEmpty() ||</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-      StringBeginsWith(oldUrl, NS_LITERAL_CSTRING(&quot;ldap:&quot;)) != newIsNotSecure)</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-  {</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+      StringBeginsWith(oldUrl, NS_LITERAL_CSTRING(&quot;ldap:&quot;)) != newIsNotSecure) {</span>
<a href="#l30.285"></a><span id="l30.285">     // They don't so its time to send round an update.</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.289"></a><span id="l30.289">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.290"></a><span id="l30.290"> </span>
<a href="#l30.291"></a><span id="l30.291">     // We inherit from nsIAbDirectory, so this static cast should be safe.</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-    abManager-&gt;NotifyItemPropertyChanged(static_cast&lt;nsIAbDirectory*&gt;(this),</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-      &quot;IsSecure&quot;,</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-      (newIsNotSecure ? u&quot;true&quot; : u&quot;false&quot;),</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-      (newIsNotSecure ? u&quot;false&quot; : u&quot;true&quot;));</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+    abManager-&gt;NotifyItemPropertyChanged(static_cast&lt;nsIAbDirectory *&gt;(this),</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+                                         &quot;IsSecure&quot;,</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineplus">+                                         (newIsNotSecure ? u&quot;true&quot; : u&quot;false&quot;),</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineplus">+                                         (newIsNotSecure ? u&quot;false&quot; : u&quot;true&quot;));</span>
<a href="#l30.300"></a><span id="l30.300">   }</span>
<a href="#l30.301"></a><span id="l30.301"> </span>
<a href="#l30.302"></a><span id="l30.302">   return NS_OK;</span>
<a href="#l30.303"></a><span id="l30.303"> }</span>
<a href="#l30.304"></a><span id="l30.304"> </span>
<a href="#l30.305"></a><span id="l30.305"> /*</span>
<a href="#l30.306"></a><span id="l30.306">  *</span>
<a href="#l30.307"></a><span id="l30.307">  * nsIAbDirectorySearch methods</span>
<a href="#l30.308"></a><span id="l30.308">  *</span>
<a href="#l30.309"></a><span id="l30.309">  */</span>
<a href="#l30.310"></a><span id="l30.310"> </span>
<a href="#l30.311"></a><span id="l30.311" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::StartSearch ()</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineminus">-{</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineminus">-    if (!mIsQueryURI || mQueryString.IsEmpty())</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineminus">-        return NS_OK;</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::StartSearch() {</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineplus">+  if (!mIsQueryURI || mQueryString.IsEmpty()) return NS_OK;</span>
<a href="#l30.317"></a><span id="l30.317"> </span>
<a href="#l30.318"></a><span id="l30.318" class="difflineminus">-    nsresult rv = Initiate();</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineplus">+  nsresult rv = Initiate();</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.322"></a><span id="l30.322"> </span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-    rv = StopSearch();</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineplus">+  rv = StopSearch();</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.327"></a><span id="l30.327"> </span>
<a href="#l30.328"></a><span id="l30.328" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments = do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID,&amp;rv);</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments =</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineplus">+      do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;rv);</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.333"></a><span id="l30.333"> </span>
<a href="#l30.334"></a><span id="l30.334" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-    rv = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineminus">-                                              getter_AddRefs(expression));</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+  rv = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineplus">+                                            getter_AddRefs(expression));</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.342"></a><span id="l30.342"> </span>
<a href="#l30.343"></a><span id="l30.343" class="difflineminus">-    rv = arguments-&gt;SetExpression(expression);</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineplus">+  rv = arguments-&gt;SetExpression(expression);</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.347"></a><span id="l30.347"> </span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-    rv = arguments-&gt;SetQuerySubDirectories(true);</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineplus">+  rv = arguments-&gt;SetQuerySubDirectories(true);</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.352"></a><span id="l30.352"> </span>
<a href="#l30.353"></a><span id="l30.353" class="difflineminus">-    // Get the max hits to return</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineminus">-    int32_t maxHits;</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineminus">-    rv = GetMaxHits(&amp;maxHits);</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-      maxHits = kDefaultMaxHits;</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineplus">+  // Get the max hits to return</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineplus">+  int32_t maxHits;</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineplus">+  rv = GetMaxHits(&amp;maxHits);</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineplus">+  if (NS_FAILED(rv)) maxHits = kDefaultMaxHits;</span>
<a href="#l30.362"></a><span id="l30.362"> </span>
<a href="#l30.363"></a><span id="l30.363" class="difflineminus">-    // get the appropriate ldap attribute map, and pass it in via the</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineminus">-    // TypeSpecificArgument</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineminus">-    nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineminus">-    rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineplus">+  // get the appropriate ldap attribute map, and pass it in via the</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineplus">+  // TypeSpecificArgument</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineplus">+  rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.373"></a><span id="l30.373"> </span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-    rv = arguments-&gt;SetTypeSpecificArg(attrMap);</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineplus">+  rv = arguments-&gt;SetTypeSpecificArg(attrMap);</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.378"></a><span id="l30.378"> </span>
<a href="#l30.379"></a><span id="l30.379" class="difflineminus">-    if (!mDirectoryQuery)</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineminus">-    {</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineminus">-      mDirectoryQuery = do_CreateInstance(NS_ABLDAPDIRECTORYQUERY_CONTRACTID,</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineminus">-                                          &amp;rv);</span>
<a href="#l30.383"></a><span id="l30.383" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineminus">-    }</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineplus">+  if (!mDirectoryQuery) {</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineplus">+    mDirectoryQuery =</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineplus">+        do_CreateInstance(NS_ABLDAPDIRECTORYQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineplus">+  }</span>
<a href="#l30.390"></a><span id="l30.390"> </span>
<a href="#l30.391"></a><span id="l30.391" class="difflineminus">-    // Perform the query</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineminus">-    rv = mDirectoryQuery-&gt;DoQuery(this, arguments, this, maxHits, 0, &amp;mContext);</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineplus">+  // Perform the query</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineplus">+  rv = mDirectoryQuery-&gt;DoQuery(this, arguments, this, maxHits, 0, &amp;mContext);</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.397"></a><span id="l30.397"> </span>
<a href="#l30.398"></a><span id="l30.398" class="difflineminus">-    // Enter lock</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineminus">-    MutexAutoLock lock(mLock);</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineminus">-    mPerformingQuery = true;</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineminus">-    mCache.Clear();</span>
<a href="#l30.402"></a><span id="l30.402" class="difflineplus">+  // Enter lock</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineplus">+  MutexAutoLock lock(mLock);</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineplus">+  mPerformingQuery = true;</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineplus">+  mCache.Clear();</span>
<a href="#l30.406"></a><span id="l30.406"> </span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-    return rv;</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineplus">+  return rv;</span>
<a href="#l30.409"></a><span id="l30.409"> }</span>
<a href="#l30.410"></a><span id="l30.410"> </span>
<a href="#l30.411"></a><span id="l30.411" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::StopSearch ()</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">-{</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::StopSearch() {</span>
<a href="#l30.414"></a><span id="l30.414">   nsresult rv = Initiate();</span>
<a href="#l30.415"></a><span id="l30.415">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.416"></a><span id="l30.416"> </span>
<a href="#l30.417"></a><span id="l30.417">   // Enter lock</span>
<a href="#l30.418"></a><span id="l30.418">   {</span>
<a href="#l30.419"></a><span id="l30.419">     MutexAutoLock lockGuard(mLock);</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineminus">-    if (!mPerformingQuery)</span>
<a href="#l30.421"></a><span id="l30.421" class="difflineminus">-      return NS_OK;</span>
<a href="#l30.422"></a><span id="l30.422" class="difflineplus">+    if (!mPerformingQuery) return NS_OK;</span>
<a href="#l30.423"></a><span id="l30.423">     mPerformingQuery = false;</span>
<a href="#l30.424"></a><span id="l30.424">   }</span>
<a href="#l30.425"></a><span id="l30.425">   // Exit lock</span>
<a href="#l30.426"></a><span id="l30.426"> </span>
<a href="#l30.427"></a><span id="l30.427" class="difflineminus">-  if (!mDirectoryQuery)</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineplus">+  if (!mDirectoryQuery) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.430"></a><span id="l30.430"> </span>
<a href="#l30.431"></a><span id="l30.431">   return mDirectoryQuery-&gt;StopQuery(mContext);</span>
<a href="#l30.432"></a><span id="l30.432"> }</span>
<a href="#l30.433"></a><span id="l30.433"> </span>
<a href="#l30.434"></a><span id="l30.434"> /*</span>
<a href="#l30.435"></a><span id="l30.435">  *</span>
<a href="#l30.436"></a><span id="l30.436">  * nsAbDirSearchListenerContext methods</span>
<a href="#l30.437"></a><span id="l30.437">  *</span>
<a href="#l30.438"></a><span id="l30.438">  */</span>
<a href="#l30.439"></a><span id="l30.439" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::OnSearchFinished(int32_t aResult, const nsAString &amp;aErrorMessage)</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineminus">-{</span>
<a href="#l30.441"></a><span id="l30.441" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::OnSearchFinished(</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineplus">+    int32_t aResult, const nsAString &amp;aErrorMessage) {</span>
<a href="#l30.443"></a><span id="l30.443">   nsresult rv = Initiate();</span>
<a href="#l30.444"></a><span id="l30.444">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.445"></a><span id="l30.445"> </span>
<a href="#l30.446"></a><span id="l30.446">   MutexAutoLock lock(mLock);</span>
<a href="#l30.447"></a><span id="l30.447">   mPerformingQuery = false;</span>
<a href="#l30.448"></a><span id="l30.448"> </span>
<a href="#l30.449"></a><span id="l30.449">   return NS_OK;</span>
<a href="#l30.450"></a><span id="l30.450"> }</span>
<a href="#l30.451"></a><span id="l30.451"> </span>
<a href="#l30.452"></a><span id="l30.452" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::OnSearchFoundCard(nsIAbCard* card)</span>
<a href="#l30.453"></a><span id="l30.453" class="difflineminus">-{</span>
<a href="#l30.454"></a><span id="l30.454" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::OnSearchFoundCard(nsIAbCard *card) {</span>
<a href="#l30.455"></a><span id="l30.455">   nsresult rv = Initiate();</span>
<a href="#l30.456"></a><span id="l30.456">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.457"></a><span id="l30.457"> </span>
<a href="#l30.458"></a><span id="l30.458">   // Enter lock</span>
<a href="#l30.459"></a><span id="l30.459">   {</span>
<a href="#l30.460"></a><span id="l30.460">     MutexAutoLock lock(mLock);</span>
<a href="#l30.461"></a><span id="l30.461">     mCache.Put(card, card);</span>
<a href="#l30.462"></a><span id="l30.462">   }</span>
<a href="#l30.463"></a><span id="l30.463">   // Exit lock</span>
<a href="#l30.464"></a><span id="l30.464"> </span>
<a href="#l30.465"></a><span id="l30.465" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.466"></a><span id="l30.466" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l30.467"></a><span id="l30.467" class="difflineminus">-    abManager-&gt;NotifyDirectoryItemAdded(this, card);</span>
<a href="#l30.468"></a><span id="l30.468" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l30.469"></a><span id="l30.469" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.470"></a><span id="l30.470" class="difflineplus">+  if (NS_SUCCEEDED(rv)) abManager-&gt;NotifyDirectoryItemAdded(this, card);</span>
<a href="#l30.471"></a><span id="l30.471"> </span>
<a href="#l30.472"></a><span id="l30.472">   return NS_OK;</span>
<a href="#l30.473"></a><span id="l30.473"> }</span>
<a href="#l30.474"></a><span id="l30.474"> </span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetSupportsMailingLists(bool *aSupportsMailingsLists)</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineminus">-{</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetSupportsMailingLists(</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineplus">+    bool *aSupportsMailingsLists) {</span>
<a href="#l30.479"></a><span id="l30.479">   NS_ENSURE_ARG_POINTER(aSupportsMailingsLists);</span>
<a href="#l30.480"></a><span id="l30.480">   *aSupportsMailingsLists = false;</span>
<a href="#l30.481"></a><span id="l30.481">   return NS_OK;</span>
<a href="#l30.482"></a><span id="l30.482"> }</span>
<a href="#l30.483"></a><span id="l30.483"> </span>
<a href="#l30.484"></a><span id="l30.484" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetReadOnly(bool *aReadOnly)</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineminus">-{</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetReadOnly(bool *aReadOnly) {</span>
<a href="#l30.487"></a><span id="l30.487">   NS_ENSURE_ARG_POINTER(aReadOnly);</span>
<a href="#l30.488"></a><span id="l30.488"> </span>
<a href="#l30.489"></a><span id="l30.489">   *aReadOnly = true;</span>
<a href="#l30.490"></a><span id="l30.490"> </span>
<a href="#l30.491"></a><span id="l30.491"> #ifdef MOZ_EXPERIMENTAL_WRITEABLE_LDAP</span>
<a href="#l30.492"></a><span id="l30.492">   bool readOnly;</span>
<a href="#l30.493"></a><span id="l30.493">   nsresult rv = GetBoolValue(&quot;readonly&quot;, false, &amp;readOnly);</span>
<a href="#l30.494"></a><span id="l30.494">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.495"></a><span id="l30.495"> </span>
<a href="#l30.496"></a><span id="l30.496" class="difflineminus">-  if (readOnly)</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineplus">+  if (readOnly) return NS_OK;</span>
<a href="#l30.499"></a><span id="l30.499"> </span>
<a href="#l30.500"></a><span id="l30.500">   // when online, we'll allow writing as well</span>
<a href="#l30.501"></a><span id="l30.501">   bool offline;</span>
<a href="#l30.502"></a><span id="l30.502" class="difflineminus">-  nsCOMPtr &lt;nsIIOService&gt; ioService =</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l30.505"></a><span id="l30.505">   NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l30.506"></a><span id="l30.506"> </span>
<a href="#l30.507"></a><span id="l30.507">   rv = ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.510"></a><span id="l30.510"> </span>
<a href="#l30.511"></a><span id="l30.511" class="difflineminus">-  if (!offline)</span>
<a href="#l30.512"></a><span id="l30.512" class="difflineminus">-    *aReadOnly = false;</span>
<a href="#l30.513"></a><span id="l30.513" class="difflineplus">+  if (!offline) *aReadOnly = false;</span>
<a href="#l30.514"></a><span id="l30.514"> #endif</span>
<a href="#l30.515"></a><span id="l30.515"> </span>
<a href="#l30.516"></a><span id="l30.516">   return NS_OK;</span>
<a href="#l30.517"></a><span id="l30.517"> }</span>
<a href="#l30.518"></a><span id="l30.518"> </span>
<a href="#l30.519"></a><span id="l30.519" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetIsRemote(bool *aIsRemote)</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineminus">-{</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetIsRemote(bool *aIsRemote) {</span>
<a href="#l30.522"></a><span id="l30.522">   NS_ENSURE_ARG_POINTER(aIsRemote);</span>
<a href="#l30.523"></a><span id="l30.523">   *aIsRemote = true;</span>
<a href="#l30.524"></a><span id="l30.524">   return NS_OK;</span>
<a href="#l30.525"></a><span id="l30.525"> }</span>
<a href="#l30.526"></a><span id="l30.526"> </span>
<a href="#l30.527"></a><span id="l30.527" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetIsSecure(bool *aIsSecure)</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineminus">-{</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetIsSecure(bool *aIsSecure) {</span>
<a href="#l30.530"></a><span id="l30.530">   NS_ENSURE_ARG_POINTER(aIsSecure);</span>
<a href="#l30.531"></a><span id="l30.531"> </span>
<a href="#l30.532"></a><span id="l30.532">   nsAutoCString URI;</span>
<a href="#l30.533"></a><span id="l30.533">   nsresult rv = GetStringValue(&quot;uri&quot;, EmptyCString(), URI);</span>
<a href="#l30.534"></a><span id="l30.534">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.535"></a><span id="l30.535"> </span>
<a href="#l30.536"></a><span id="l30.536" class="difflineminus">-  // to determine if this is a secure directory, check if the uri is ldaps:// or not</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineplus">+  // to determine if this is a secure directory, check if the uri is ldaps:// or</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineplus">+  // not</span>
<a href="#l30.539"></a><span id="l30.539">   *aIsSecure = (strncmp(URI.get(), &quot;ldaps:&quot;, 6) == 0);</span>
<a href="#l30.540"></a><span id="l30.540">   return NS_OK;</span>
<a href="#l30.541"></a><span id="l30.541"> }</span>
<a href="#l30.542"></a><span id="l30.542"> </span>
<a href="#l30.543"></a><span id="l30.543" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l30.544"></a><span id="l30.544" class="difflineminus">-                                                    bool *aResult)</span>
<a href="#l30.545"></a><span id="l30.545" class="difflineminus">-{</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::UseForAutocomplete(</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineplus">+    const nsACString &amp;aIdentityKey, bool *aResult) {</span>
<a href="#l30.548"></a><span id="l30.548">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l30.549"></a><span id="l30.549"> </span>
<a href="#l30.550"></a><span id="l30.550">   // Set this to false by default to make the code easier below.</span>
<a href="#l30.551"></a><span id="l30.551">   *aResult = false;</span>
<a href="#l30.552"></a><span id="l30.552"> </span>
<a href="#l30.553"></a><span id="l30.553">   nsresult rv;</span>
<a href="#l30.554"></a><span id="l30.554">   bool offline = false;</span>
<a href="#l30.555"></a><span id="l30.555" class="difflineminus">-  nsCOMPtr &lt;nsIIOService&gt; ioService =</span>
<a href="#l30.556"></a><span id="l30.556" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l30.557"></a><span id="l30.557" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l30.558"></a><span id="l30.558">   NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l30.559"></a><span id="l30.559"> </span>
<a href="#l30.560"></a><span id="l30.560">   rv = ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l30.561"></a><span id="l30.561">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.562"></a><span id="l30.562"> </span>
<a href="#l30.563"></a><span id="l30.563">   // If we're online, then don't allow search during local autocomplete - must</span>
<a href="#l30.564"></a><span id="l30.564">   // use the separate LDAP autocomplete session due to the current interfaces</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineminus">-  if (!offline)</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineplus">+  if (!offline) return NS_OK;</span>
<a href="#l30.568"></a><span id="l30.568"> </span>
<a href="#l30.569"></a><span id="l30.569">   // Is the use directory pref set for autocompletion?</span>
<a href="#l30.570"></a><span id="l30.570" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineminus">-                                              &amp;rv));</span>
<a href="#l30.572"></a><span id="l30.572" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.573"></a><span id="l30.573">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.574"></a><span id="l30.574"> </span>
<a href="#l30.575"></a><span id="l30.575">   bool useDirectory = false;</span>
<a href="#l30.576"></a><span id="l30.576">   rv = prefs-&gt;GetBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;, &amp;useDirectory);</span>
<a href="#l30.577"></a><span id="l30.577">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.578"></a><span id="l30.578"> </span>
<a href="#l30.579"></a><span id="l30.579">   // No need to search if not set up globally for LDAP autocompletion and we've</span>
<a href="#l30.580"></a><span id="l30.580">   // not been given an identity.</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineminus">-  if (!useDirectory &amp;&amp; aIdentityKey.IsEmpty())</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineplus">+  if (!useDirectory &amp;&amp; aIdentityKey.IsEmpty()) return NS_OK;</span>
<a href="#l30.584"></a><span id="l30.584"> </span>
<a href="#l30.585"></a><span id="l30.585">   nsCString prefName;</span>
<a href="#l30.586"></a><span id="l30.586" class="difflineminus">-  if (!aIdentityKey.IsEmpty())</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineminus">-  {</span>
<a href="#l30.588"></a><span id="l30.588" class="difflineplus">+  if (!aIdentityKey.IsEmpty()) {</span>
<a href="#l30.589"></a><span id="l30.589">     // If we have an identity string, try and find out the required directory</span>
<a href="#l30.590"></a><span id="l30.590">     // server.</span>
<a href="#l30.591"></a><span id="l30.591">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l30.592"></a><span id="l30.592" class="difflineminus">-      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.594"></a><span id="l30.594"> </span>
<a href="#l30.595"></a><span id="l30.595">     // If we failed, just return, we can't do much about this.</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l30.597"></a><span id="l30.597" class="difflineminus">-    {</span>
<a href="#l30.598"></a><span id="l30.598" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.599"></a><span id="l30.599">       nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l30.600"></a><span id="l30.600">       rv = accountManager-&gt;GetIdentity(aIdentityKey, getter_AddRefs(identity));</span>
<a href="#l30.601"></a><span id="l30.601" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l30.602"></a><span id="l30.602" class="difflineminus">-      {</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.604"></a><span id="l30.604">         bool overrideGlobalPref = false;</span>
<a href="#l30.605"></a><span id="l30.605">         identity-&gt;GetOverrideGlobalPref(&amp;overrideGlobalPref);</span>
<a href="#l30.606"></a><span id="l30.606" class="difflineminus">-        if (overrideGlobalPref)</span>
<a href="#l30.607"></a><span id="l30.607" class="difflineminus">-          identity-&gt;GetDirectoryServer(prefName);</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineplus">+        if (overrideGlobalPref) identity-&gt;GetDirectoryServer(prefName);</span>
<a href="#l30.609"></a><span id="l30.609">       }</span>
<a href="#l30.610"></a><span id="l30.610">     }</span>
<a href="#l30.611"></a><span id="l30.611"> </span>
<a href="#l30.612"></a><span id="l30.612">     // If the preference name is still empty but useDirectory is false, then</span>
<a href="#l30.613"></a><span id="l30.613">     // the global one is not available, nor is the overridden one.</span>
<a href="#l30.614"></a><span id="l30.614" class="difflineminus">-    if (prefName.IsEmpty() &amp;&amp; !useDirectory)</span>
<a href="#l30.615"></a><span id="l30.615" class="difflineminus">-      return NS_OK;</span>
<a href="#l30.616"></a><span id="l30.616" class="difflineplus">+    if (prefName.IsEmpty() &amp;&amp; !useDirectory) return NS_OK;</span>
<a href="#l30.617"></a><span id="l30.617">   }</span>
<a href="#l30.618"></a><span id="l30.618"> </span>
<a href="#l30.619"></a><span id="l30.619">   // If we failed to get the identity preference, or the pref name is empty</span>
<a href="#l30.620"></a><span id="l30.620">   // try the global preference.</span>
<a href="#l30.621"></a><span id="l30.621" class="difflineminus">-  if (prefName.IsEmpty())</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineminus">-  {</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineminus">-    nsresult rv = prefs-&gt;GetCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineminus">-                                     prefName);</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineplus">+  if (prefName.IsEmpty()) {</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineplus">+    nsresult rv =</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineplus">+        prefs-&gt;GetCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;, prefName);</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.630"></a><span id="l30.630">   }</span>
<a href="#l30.631"></a><span id="l30.631"> </span>
<a href="#l30.632"></a><span id="l30.632">   // Now see if the pref name matches our pref id.</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineminus">-  if (prefName.Equals(m_DirPrefId))</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineminus">-  {</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineplus">+  if (prefName.Equals(m_DirPrefId)) {</span>
<a href="#l30.636"></a><span id="l30.636">     // Yes it does, one last check - does the replication file exist?</span>
<a href="#l30.637"></a><span id="l30.637">     nsresult rv;</span>
<a href="#l30.638"></a><span id="l30.638">     nsCOMPtr&lt;nsIFile&gt; databaseFile;</span>
<a href="#l30.639"></a><span id="l30.639">     // If we can't get the file, then there is no database to use</span>
<a href="#l30.640"></a><span id="l30.640">     if (NS_FAILED(GetReplicationFile(getter_AddRefs(databaseFile))))</span>
<a href="#l30.641"></a><span id="l30.641">       return NS_OK;</span>
<a href="#l30.642"></a><span id="l30.642"> </span>
<a href="#l30.643"></a><span id="l30.643">     bool exists;</span>
<a href="#l30.644"></a><span id="l30.644">     rv = databaseFile-&gt;Exists(&amp;exists);</span>
<a href="#l30.645"></a><span id="l30.645">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.646"></a><span id="l30.646"> </span>
<a href="#l30.647"></a><span id="l30.647">     *aResult = exists;</span>
<a href="#l30.648"></a><span id="l30.648">   }</span>
<a href="#l30.649"></a><span id="l30.649">   return NS_OK;</span>
<a href="#l30.650"></a><span id="l30.650"> }</span>
<a href="#l30.651"></a><span id="l30.651"> </span>
<a href="#l30.652"></a><span id="l30.652" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetSearchClientControls(nsIMutableArray **aControls)</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineminus">-{</span>
<a href="#l30.654"></a><span id="l30.654" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetSearchClientControls(</span>
<a href="#l30.655"></a><span id="l30.655" class="difflineplus">+    nsIMutableArray **aControls) {</span>
<a href="#l30.656"></a><span id="l30.656">   NS_IF_ADDREF(*aControls = mSearchClientControls);</span>
<a href="#l30.657"></a><span id="l30.657">   return NS_OK;</span>
<a href="#l30.658"></a><span id="l30.658"> }</span>
<a href="#l30.659"></a><span id="l30.659"> </span>
<a href="#l30.660"></a><span id="l30.660" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetSearchClientControls(nsIMutableArray *aControls)</span>
<a href="#l30.661"></a><span id="l30.661" class="difflineminus">-{</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetSearchClientControls(</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineplus">+    nsIMutableArray *aControls) {</span>
<a href="#l30.664"></a><span id="l30.664">   mSearchClientControls = aControls;</span>
<a href="#l30.665"></a><span id="l30.665">   return NS_OK;</span>
<a href="#l30.666"></a><span id="l30.666"> }</span>
<a href="#l30.667"></a><span id="l30.667"> </span>
<a href="#l30.668"></a><span id="l30.668" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetSearchServerControls(nsIMutableArray **aControls)</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineminus">-{</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetSearchServerControls(</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineplus">+    nsIMutableArray **aControls) {</span>
<a href="#l30.672"></a><span id="l30.672">   NS_IF_ADDREF(*aControls = mSearchServerControls);</span>
<a href="#l30.673"></a><span id="l30.673">   return NS_OK;</span>
<a href="#l30.674"></a><span id="l30.674"> }</span>
<a href="#l30.675"></a><span id="l30.675"> </span>
<a href="#l30.676"></a><span id="l30.676" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetSearchServerControls(nsIMutableArray *aControls)</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineminus">-{</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetSearchServerControls(</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineplus">+    nsIMutableArray *aControls) {</span>
<a href="#l30.680"></a><span id="l30.680">   mSearchServerControls = aControls;</span>
<a href="#l30.681"></a><span id="l30.681">   return NS_OK;</span>
<a href="#l30.682"></a><span id="l30.682"> }</span>
<a href="#l30.683"></a><span id="l30.683"> </span>
<a href="#l30.684"></a><span id="l30.684" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetProtocolVersion(uint32_t *aProtocolVersion)</span>
<a href="#l30.685"></a><span id="l30.685" class="difflineminus">-{</span>
<a href="#l30.686"></a><span id="l30.686" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetProtocolVersion(</span>
<a href="#l30.687"></a><span id="l30.687" class="difflineplus">+    uint32_t *aProtocolVersion) {</span>
<a href="#l30.688"></a><span id="l30.688">   nsAutoCString versionString;</span>
<a href="#l30.689"></a><span id="l30.689"> </span>
<a href="#l30.690"></a><span id="l30.690" class="difflineminus">-  nsresult rv = GetStringValue(&quot;protocolVersion&quot;, NS_LITERAL_CSTRING(&quot;3&quot;), versionString);</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineplus">+  nsresult rv =</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineplus">+      GetStringValue(&quot;protocolVersion&quot;, NS_LITERAL_CSTRING(&quot;3&quot;), versionString);</span>
<a href="#l30.693"></a><span id="l30.693">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.694"></a><span id="l30.694"> </span>
<a href="#l30.695"></a><span id="l30.695" class="difflineminus">-  *aProtocolVersion = versionString.EqualsLiteral(&quot;3&quot;) ?</span>
<a href="#l30.696"></a><span id="l30.696" class="difflineminus">-    (uint32_t)nsILDAPConnection::VERSION3 :</span>
<a href="#l30.697"></a><span id="l30.697" class="difflineminus">-    (uint32_t)nsILDAPConnection::VERSION2;</span>
<a href="#l30.698"></a><span id="l30.698" class="difflineplus">+  *aProtocolVersion = versionString.EqualsLiteral(&quot;3&quot;)</span>
<a href="#l30.699"></a><span id="l30.699" class="difflineplus">+                          ? (uint32_t)nsILDAPConnection::VERSION3</span>
<a href="#l30.700"></a><span id="l30.700" class="difflineplus">+                          : (uint32_t)nsILDAPConnection::VERSION2;</span>
<a href="#l30.701"></a><span id="l30.701"> </span>
<a href="#l30.702"></a><span id="l30.702">   return NS_OK;</span>
<a href="#l30.703"></a><span id="l30.703"> }</span>
<a href="#l30.704"></a><span id="l30.704"> </span>
<a href="#l30.705"></a><span id="l30.705" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetProtocolVersion(uint32_t aProtocolVersion)</span>
<a href="#l30.706"></a><span id="l30.706" class="difflineminus">-{</span>
<a href="#l30.707"></a><span id="l30.707" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetProtocolVersion(uint32_t aProtocolVersion) {</span>
<a href="#l30.708"></a><span id="l30.708">   // XXX We should cancel any existing LDAP connections here and</span>
<a href="#l30.709"></a><span id="l30.709">   // be ready to re-initialise them with the new auth details.</span>
<a href="#l30.710"></a><span id="l30.710">   return SetStringValue(&quot;protocolVersion&quot;,</span>
<a href="#l30.711"></a><span id="l30.711" class="difflineminus">-                        aProtocolVersion == nsILDAPConnection::VERSION3 ?</span>
<a href="#l30.712"></a><span id="l30.712" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;3&quot;) : NS_LITERAL_CSTRING(&quot;2&quot;));</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineplus">+                        aProtocolVersion == nsILDAPConnection::VERSION3</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineplus">+                            ? NS_LITERAL_CSTRING(&quot;3&quot;)</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineplus">+                            : NS_LITERAL_CSTRING(&quot;2&quot;));</span>
<a href="#l30.716"></a><span id="l30.716"> }</span>
<a href="#l30.717"></a><span id="l30.717"> </span>
<a href="#l30.718"></a><span id="l30.718" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetMaxHits(int32_t *aMaxHits)</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineminus">-{</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetMaxHits(int32_t *aMaxHits) {</span>
<a href="#l30.721"></a><span id="l30.721">   return GetIntValue(&quot;maxHits&quot;, kDefaultMaxHits, aMaxHits);</span>
<a href="#l30.722"></a><span id="l30.722"> }</span>
<a href="#l30.723"></a><span id="l30.723"> </span>
<a href="#l30.724"></a><span id="l30.724" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetMaxHits(int32_t aMaxHits)</span>
<a href="#l30.725"></a><span id="l30.725" class="difflineminus">-{</span>
<a href="#l30.726"></a><span id="l30.726" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetMaxHits(int32_t aMaxHits) {</span>
<a href="#l30.727"></a><span id="l30.727">   return SetIntValue(&quot;maxHits&quot;, aMaxHits);</span>
<a href="#l30.728"></a><span id="l30.728"> }</span>
<a href="#l30.729"></a><span id="l30.729"> </span>
<a href="#l30.730"></a><span id="l30.730" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetReplicationFileName(nsACString &amp;aReplicationFileName)</span>
<a href="#l30.731"></a><span id="l30.731" class="difflineminus">-{</span>
<a href="#l30.732"></a><span id="l30.732" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetReplicationFileName(</span>
<a href="#l30.733"></a><span id="l30.733" class="difflineplus">+    nsACString &amp;aReplicationFileName) {</span>
<a href="#l30.734"></a><span id="l30.734">   return GetStringValue(&quot;filename&quot;, EmptyCString(), aReplicationFileName);</span>
<a href="#l30.735"></a><span id="l30.735"> }</span>
<a href="#l30.736"></a><span id="l30.736"> </span>
<a href="#l30.737"></a><span id="l30.737" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetReplicationFileName(const nsACString &amp;aReplicationFileName)</span>
<a href="#l30.738"></a><span id="l30.738" class="difflineminus">-{</span>
<a href="#l30.739"></a><span id="l30.739" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetReplicationFileName(</span>
<a href="#l30.740"></a><span id="l30.740" class="difflineplus">+    const nsACString &amp;aReplicationFileName) {</span>
<a href="#l30.741"></a><span id="l30.741">   return SetStringValue(&quot;filename&quot;, aReplicationFileName);</span>
<a href="#l30.742"></a><span id="l30.742"> }</span>
<a href="#l30.743"></a><span id="l30.743"> </span>
<a href="#l30.744"></a><span id="l30.744" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetAuthDn(nsACString &amp;aAuthDn)</span>
<a href="#l30.745"></a><span id="l30.745" class="difflineminus">-{</span>
<a href="#l30.746"></a><span id="l30.746" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetAuthDn(nsACString &amp;aAuthDn) {</span>
<a href="#l30.747"></a><span id="l30.747">   return GetStringValue(&quot;auth.dn&quot;, EmptyCString(), aAuthDn);</span>
<a href="#l30.748"></a><span id="l30.748"> }</span>
<a href="#l30.749"></a><span id="l30.749"> </span>
<a href="#l30.750"></a><span id="l30.750" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetAuthDn(const nsACString &amp;aAuthDn)</span>
<a href="#l30.751"></a><span id="l30.751" class="difflineminus">-{</span>
<a href="#l30.752"></a><span id="l30.752" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetAuthDn(const nsACString &amp;aAuthDn) {</span>
<a href="#l30.753"></a><span id="l30.753">   // XXX We should cancel any existing LDAP connections here and</span>
<a href="#l30.754"></a><span id="l30.754">   // be ready to re-initialise them with the new auth details.</span>
<a href="#l30.755"></a><span id="l30.755">   return SetStringValue(&quot;auth.dn&quot;, aAuthDn);</span>
<a href="#l30.756"></a><span id="l30.756"> }</span>
<a href="#l30.757"></a><span id="l30.757"> </span>
<a href="#l30.758"></a><span id="l30.758" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetSaslMechanism(nsACString &amp;aSaslMechanism)</span>
<a href="#l30.759"></a><span id="l30.759" class="difflineminus">-{</span>
<a href="#l30.760"></a><span id="l30.760" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetSaslMechanism(nsACString &amp;aSaslMechanism) {</span>
<a href="#l30.761"></a><span id="l30.761">   return GetStringValue(&quot;auth.saslmech&quot;, EmptyCString(), aSaslMechanism);</span>
<a href="#l30.762"></a><span id="l30.762"> }</span>
<a href="#l30.763"></a><span id="l30.763"> </span>
<a href="#l30.764"></a><span id="l30.764" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetSaslMechanism(const nsACString &amp;aSaslMechanism)</span>
<a href="#l30.765"></a><span id="l30.765" class="difflineminus">-{</span>
<a href="#l30.766"></a><span id="l30.766" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetSaslMechanism(</span>
<a href="#l30.767"></a><span id="l30.767" class="difflineplus">+    const nsACString &amp;aSaslMechanism) {</span>
<a href="#l30.768"></a><span id="l30.768">   return SetStringValue(&quot;auth.saslmech&quot;, aSaslMechanism);</span>
<a href="#l30.769"></a><span id="l30.769"> }</span>
<a href="#l30.770"></a><span id="l30.770"> </span>
<a href="#l30.771"></a><span id="l30.771" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetLastChangeNumber(int32_t *aLastChangeNumber)</span>
<a href="#l30.772"></a><span id="l30.772" class="difflineminus">-{</span>
<a href="#l30.773"></a><span id="l30.773" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetLastChangeNumber(</span>
<a href="#l30.774"></a><span id="l30.774" class="difflineplus">+    int32_t *aLastChangeNumber) {</span>
<a href="#l30.775"></a><span id="l30.775">   return GetIntValue(&quot;lastChangeNumber&quot;, -1, aLastChangeNumber);</span>
<a href="#l30.776"></a><span id="l30.776"> }</span>
<a href="#l30.777"></a><span id="l30.777"> </span>
<a href="#l30.778"></a><span id="l30.778" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetLastChangeNumber(int32_t aLastChangeNumber)</span>
<a href="#l30.779"></a><span id="l30.779" class="difflineminus">-{</span>
<a href="#l30.780"></a><span id="l30.780" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetLastChangeNumber(</span>
<a href="#l30.781"></a><span id="l30.781" class="difflineplus">+    int32_t aLastChangeNumber) {</span>
<a href="#l30.782"></a><span id="l30.782">   return SetIntValue(&quot;lastChangeNumber&quot;, aLastChangeNumber);</span>
<a href="#l30.783"></a><span id="l30.783"> }</span>
<a href="#l30.784"></a><span id="l30.784"> </span>
<a href="#l30.785"></a><span id="l30.785" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetDataVersion(nsACString &amp;aDataVersion)</span>
<a href="#l30.786"></a><span id="l30.786" class="difflineminus">-{</span>
<a href="#l30.787"></a><span id="l30.787" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetDataVersion(nsACString &amp;aDataVersion) {</span>
<a href="#l30.788"></a><span id="l30.788">   return GetStringValue(&quot;dataVersion&quot;, EmptyCString(), aDataVersion);</span>
<a href="#l30.789"></a><span id="l30.789"> }</span>
<a href="#l30.790"></a><span id="l30.790"> </span>
<a href="#l30.791"></a><span id="l30.791" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetDataVersion(const nsACString &amp;aDataVersion)</span>
<a href="#l30.792"></a><span id="l30.792" class="difflineminus">-{</span>
<a href="#l30.793"></a><span id="l30.793" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetDataVersion(</span>
<a href="#l30.794"></a><span id="l30.794" class="difflineplus">+    const nsACString &amp;aDataVersion) {</span>
<a href="#l30.795"></a><span id="l30.795">   return SetStringValue(&quot;dataVersion&quot;, aDataVersion);</span>
<a href="#l30.796"></a><span id="l30.796"> }</span>
<a href="#l30.797"></a><span id="l30.797"> </span>
<a href="#l30.798"></a><span id="l30.798" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetAttributeMap(nsIAbLDAPAttributeMap **aAttributeMap)</span>
<a href="#l30.799"></a><span id="l30.799" class="difflineminus">-{</span>
<a href="#l30.800"></a><span id="l30.800" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetAttributeMap(</span>
<a href="#l30.801"></a><span id="l30.801" class="difflineplus">+    nsIAbLDAPAttributeMap **aAttributeMap) {</span>
<a href="#l30.802"></a><span id="l30.802">   NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l30.803"></a><span id="l30.803"> </span>
<a href="#l30.804"></a><span id="l30.804">   nsresult rv;</span>
<a href="#l30.805"></a><span id="l30.805" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMapService&gt; mapSvc =</span>
<a href="#l30.806"></a><span id="l30.806" class="difflineminus">-    do_GetService(&quot;@mozilla.org/addressbook/ldap-attribute-map-service;1&quot;, &amp;rv);</span>
<a href="#l30.807"></a><span id="l30.807" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPAttributeMapService&gt; mapSvc = do_GetService(</span>
<a href="#l30.808"></a><span id="l30.808" class="difflineplus">+      &quot;@mozilla.org/addressbook/ldap-attribute-map-service;1&quot;, &amp;rv);</span>
<a href="#l30.809"></a><span id="l30.809">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.810"></a><span id="l30.810"> </span>
<a href="#l30.811"></a><span id="l30.811">   return mapSvc-&gt;GetMapForPrefBranch(m_DirPrefId, aAttributeMap);</span>
<a href="#l30.812"></a><span id="l30.812"> }</span>
<a href="#l30.813"></a><span id="l30.813"> </span>
<a href="#l30.814"></a><span id="l30.814" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetReplicationFile(nsIFile **aResult)</span>
<a href="#l30.815"></a><span id="l30.815" class="difflineminus">-{</span>
<a href="#l30.816"></a><span id="l30.816" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetReplicationFile(nsIFile **aResult) {</span>
<a href="#l30.817"></a><span id="l30.817">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l30.818"></a><span id="l30.818"> </span>
<a href="#l30.819"></a><span id="l30.819">   nsCString fileName;</span>
<a href="#l30.820"></a><span id="l30.820">   nsresult rv = GetStringValue(&quot;filename&quot;, EmptyCString(), fileName);</span>
<a href="#l30.821"></a><span id="l30.821">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.822"></a><span id="l30.822"> </span>
<a href="#l30.823"></a><span id="l30.823" class="difflineminus">- if (fileName.IsEmpty())</span>
<a href="#l30.824"></a><span id="l30.824" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.825"></a><span id="l30.825" class="difflineplus">+  if (fileName.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.826"></a><span id="l30.826"> </span>
<a href="#l30.827"></a><span id="l30.827">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l30.828"></a><span id="l30.828">   rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l30.829"></a><span id="l30.829">                               getter_AddRefs(profileDir));</span>
<a href="#l30.830"></a><span id="l30.830">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.831"></a><span id="l30.831"> </span>
<a href="#l30.832"></a><span id="l30.832">   rv = profileDir-&gt;AppendNative(fileName);</span>
<a href="#l30.833"></a><span id="l30.833">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.834"></a><span id="l30.834"> </span>
<a href="#l30.835"></a><span id="l30.835">   profileDir.forget(aResult);</span>
<a href="#l30.836"></a><span id="l30.836"> </span>
<a href="#l30.837"></a><span id="l30.837">   return NS_OK;</span>
<a href="#l30.838"></a><span id="l30.838"> }</span>
<a href="#l30.839"></a><span id="l30.839"> </span>
<a href="#l30.840"></a><span id="l30.840" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetReplicationDatabase(nsIAddrDatabase **aResult)</span>
<a href="#l30.841"></a><span id="l30.841" class="difflineminus">-{</span>
<a href="#l30.842"></a><span id="l30.842" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetReplicationDatabase(</span>
<a href="#l30.843"></a><span id="l30.843" class="difflineplus">+    nsIAddrDatabase **aResult) {</span>
<a href="#l30.844"></a><span id="l30.844">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l30.845"></a><span id="l30.845"> </span>
<a href="#l30.846"></a><span id="l30.846">   nsresult rv;</span>
<a href="#l30.847"></a><span id="l30.847">   nsCOMPtr&lt;nsIFile&gt; databaseFile;</span>
<a href="#l30.848"></a><span id="l30.848" class="difflineminus">- rv = GetReplicationFile(getter_AddRefs(databaseFile));</span>
<a href="#l30.849"></a><span id="l30.849" class="difflineplus">+  rv = GetReplicationFile(getter_AddRefs(databaseFile));</span>
<a href="#l30.850"></a><span id="l30.850">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.851"></a><span id="l30.851"> </span>
<a href="#l30.852"></a><span id="l30.852">   nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l30.853"></a><span id="l30.853" class="difflineminus">-    do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l30.854"></a><span id="l30.854" class="difflineplus">+      do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l30.855"></a><span id="l30.855">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.856"></a><span id="l30.856"> </span>
<a href="#l30.857"></a><span id="l30.857">   return addrDBFactory-&gt;Open(databaseFile, false /* no create */, true,</span>
<a href="#l30.858"></a><span id="l30.858" class="difflineminus">-                           aResult);</span>
<a href="#l30.859"></a><span id="l30.859" class="difflineplus">+                             aResult);</span>
<a href="#l30.860"></a><span id="l30.860"> }</span>
<a href="#l30.861"></a><span id="l30.861"> </span>
<a href="#l30.862"></a><span id="l30.862"> NS_IMETHODIMP nsAbLDAPDirectory::AddCard(nsIAbCard *aUpdatedCard,</span>
<a href="#l30.863"></a><span id="l30.863" class="difflineminus">-                                         nsIAbCard **aAddedCard)</span>
<a href="#l30.864"></a><span id="l30.864" class="difflineminus">-{</span>
<a href="#l30.865"></a><span id="l30.865" class="difflineplus">+                                         nsIAbCard **aAddedCard) {</span>
<a href="#l30.866"></a><span id="l30.866">   NS_ENSURE_ARG_POINTER(aUpdatedCard);</span>
<a href="#l30.867"></a><span id="l30.867">   NS_ENSURE_ARG_POINTER(aAddedCard);</span>
<a href="#l30.868"></a><span id="l30.868"> </span>
<a href="#l30.869"></a><span id="l30.869">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l30.870"></a><span id="l30.870">   nsresult rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l30.871"></a><span id="l30.871">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.872"></a><span id="l30.872"> </span>
<a href="#l30.873"></a><span id="l30.873">   // Create a new LDAP card</span>
<a href="#l30.874"></a><span id="l30.874">   nsCOMPtr&lt;nsIAbLDAPCard&gt; card =</span>
<a href="#l30.875"></a><span id="l30.875" class="difflineminus">-    do_CreateInstance(NS_ABLDAPCARD_CONTRACTID, &amp;rv);</span>
<a href="#l30.876"></a><span id="l30.876" class="difflineplus">+      do_CreateInstance(NS_ABLDAPCARD_CONTRACTID, &amp;rv);</span>
<a href="#l30.877"></a><span id="l30.877">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.878"></a><span id="l30.878"> </span>
<a href="#l30.879"></a><span id="l30.879">   rv = Initiate();</span>
<a href="#l30.880"></a><span id="l30.880">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.881"></a><span id="l30.881"> </span>
<a href="#l30.882"></a><span id="l30.882">   // Copy over the card data</span>
<a href="#l30.883"></a><span id="l30.883">   nsCOMPtr&lt;nsIAbCard&gt; copyToCard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l30.884"></a><span id="l30.884">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.885"></a><span id="l30.885" class="difflineat">@@ -723,46 +670,46 @@ NS_IMETHODIMP nsAbLDAPDirectory::AddCard</span>
<a href="#l30.886"></a><span id="l30.886"> </span>
<a href="#l30.887"></a><span id="l30.887">   // Retrieve preferences</span>
<a href="#l30.888"></a><span id="l30.888">   nsAutoCString prefString;</span>
<a href="#l30.889"></a><span id="l30.889">   rv = GetRdnAttributes(prefString);</span>
<a href="#l30.890"></a><span id="l30.890">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.891"></a><span id="l30.891"> </span>
<a href="#l30.892"></a><span id="l30.892">   CharPtrArrayGuard rdnAttrs;</span>
<a href="#l30.893"></a><span id="l30.893">   rv = SplitStringList(prefString, rdnAttrs.GetSizeAddr(),</span>
<a href="#l30.894"></a><span id="l30.894" class="difflineminus">-    rdnAttrs.GetArrayAddr());</span>
<a href="#l30.895"></a><span id="l30.895" class="difflineplus">+                       rdnAttrs.GetArrayAddr());</span>
<a href="#l30.896"></a><span id="l30.896">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.897"></a><span id="l30.897"> </span>
<a href="#l30.898"></a><span id="l30.898">   rv = GetObjectClasses(prefString);</span>
<a href="#l30.899"></a><span id="l30.899">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.900"></a><span id="l30.900"> </span>
<a href="#l30.901"></a><span id="l30.901">   CharPtrArrayGuard objClass;</span>
<a href="#l30.902"></a><span id="l30.902">   rv = SplitStringList(prefString, objClass.GetSizeAddr(),</span>
<a href="#l30.903"></a><span id="l30.903" class="difflineminus">-    objClass.GetArrayAddr());</span>
<a href="#l30.904"></a><span id="l30.904" class="difflineplus">+                       objClass.GetArrayAddr());</span>
<a href="#l30.905"></a><span id="l30.905">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.906"></a><span id="l30.906"> </span>
<a href="#l30.907"></a><span id="l30.907">   // Process updates</span>
<a href="#l30.908"></a><span id="l30.908">   nsCOMPtr&lt;nsIArray&gt; modArray;</span>
<a href="#l30.909"></a><span id="l30.909" class="difflineminus">-  rv = card-&gt;GetLDAPMessageInfo(attrMap, objClass.GetSize(), objClass.GetArray(),</span>
<a href="#l30.910"></a><span id="l30.910" class="difflineminus">-    nsILDAPModification::MOD_ADD, getter_AddRefs(modArray));</span>
<a href="#l30.911"></a><span id="l30.911" class="difflineplus">+  rv = card-&gt;GetLDAPMessageInfo(</span>
<a href="#l30.912"></a><span id="l30.912" class="difflineplus">+      attrMap, objClass.GetSize(), objClass.GetArray(),</span>
<a href="#l30.913"></a><span id="l30.913" class="difflineplus">+      nsILDAPModification::MOD_ADD, getter_AddRefs(modArray));</span>
<a href="#l30.914"></a><span id="l30.914">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.915"></a><span id="l30.915"> </span>
<a href="#l30.916"></a><span id="l30.916">   // For new cards, the base DN is the search base DN</span>
<a href="#l30.917"></a><span id="l30.917">   nsCOMPtr&lt;nsILDAPURL&gt; currentUrl;</span>
<a href="#l30.918"></a><span id="l30.918">   rv = GetLDAPURL(getter_AddRefs(currentUrl));</span>
<a href="#l30.919"></a><span id="l30.919">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.920"></a><span id="l30.920"> </span>
<a href="#l30.921"></a><span id="l30.921">   nsAutoCString baseDN;</span>
<a href="#l30.922"></a><span id="l30.922">   rv = currentUrl-&gt;GetDn(baseDN);</span>
<a href="#l30.923"></a><span id="l30.923">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.924"></a><span id="l30.924"> </span>
<a href="#l30.925"></a><span id="l30.925">   // Calculate DN</span>
<a href="#l30.926"></a><span id="l30.926">   nsAutoCString cardDN;</span>
<a href="#l30.927"></a><span id="l30.927" class="difflineminus">-  rv = card-&gt;BuildRdn(attrMap, rdnAttrs.GetSize(), rdnAttrs.GetArray(),</span>
<a href="#l30.928"></a><span id="l30.928" class="difflineminus">-    cardDN);</span>
<a href="#l30.929"></a><span id="l30.929" class="difflineplus">+  rv = card-&gt;BuildRdn(attrMap, rdnAttrs.GetSize(), rdnAttrs.GetArray(), cardDN);</span>
<a href="#l30.930"></a><span id="l30.930">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.931"></a><span id="l30.931">   cardDN.Append(',');</span>
<a href="#l30.932"></a><span id="l30.932">   cardDN.Append(baseDN);</span>
<a href="#l30.933"></a><span id="l30.933"> </span>
<a href="#l30.934"></a><span id="l30.934">   rv = card-&gt;SetDn(cardDN);</span>
<a href="#l30.935"></a><span id="l30.935">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.936"></a><span id="l30.936"> </span>
<a href="#l30.937"></a><span id="l30.937">   nsAutoCString ourUuid;</span>
<a href="#l30.938"></a><span id="l30.938" class="difflineat">@@ -773,30 +720,27 @@ NS_IMETHODIMP nsAbLDAPDirectory::AddCard</span>
<a href="#l30.939"></a><span id="l30.939">   rv = DoModify(this, nsILDAPModification::MOD_ADD, cardDN, modArray,</span>
<a href="#l30.940"></a><span id="l30.940">                 EmptyCString(), EmptyCString());</span>
<a href="#l30.941"></a><span id="l30.941">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.942"></a><span id="l30.942"> </span>
<a href="#l30.943"></a><span id="l30.943">   copyToCard.forget(aAddedCard);</span>
<a href="#l30.944"></a><span id="l30.944">   return NS_OK;</span>
<a href="#l30.945"></a><span id="l30.945"> }</span>
<a href="#l30.946"></a><span id="l30.946"> </span>
<a href="#l30.947"></a><span id="l30.947" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::DeleteCards(nsIArray *aCards)</span>
<a href="#l30.948"></a><span id="l30.948" class="difflineminus">-{</span>
<a href="#l30.949"></a><span id="l30.949" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::DeleteCards(nsIArray *aCards) {</span>
<a href="#l30.950"></a><span id="l30.950">   uint32_t cardCount;</span>
<a href="#l30.951"></a><span id="l30.951">   uint32_t i;</span>
<a href="#l30.952"></a><span id="l30.952">   nsAutoCString cardDN;</span>
<a href="#l30.953"></a><span id="l30.953"> </span>
<a href="#l30.954"></a><span id="l30.954">   nsresult rv = aCards-&gt;GetLength(&amp;cardCount);</span>
<a href="#l30.955"></a><span id="l30.955">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.956"></a><span id="l30.956"> </span>
<a href="#l30.957"></a><span id="l30.957" class="difflineminus">-  for (i = 0; i &lt; cardCount; ++i)</span>
<a href="#l30.958"></a><span id="l30.958" class="difflineminus">-  {</span>
<a href="#l30.959"></a><span id="l30.959" class="difflineplus">+  for (i = 0; i &lt; cardCount; ++i) {</span>
<a href="#l30.960"></a><span id="l30.960">     nsCOMPtr&lt;nsIAbLDAPCard&gt; card(do_QueryElementAt(aCards, i, &amp;rv));</span>
<a href="#l30.961"></a><span id="l30.961" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.962"></a><span id="l30.962" class="difflineminus">-    {</span>
<a href="#l30.963"></a><span id="l30.963" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l30.964"></a><span id="l30.964">       NS_WARNING(&quot;Wrong type of card passed to nsAbLDAPDirectory::DeleteCards&quot;);</span>
<a href="#l30.965"></a><span id="l30.965">       break;</span>
<a href="#l30.966"></a><span id="l30.966">     }</span>
<a href="#l30.967"></a><span id="l30.967"> </span>
<a href="#l30.968"></a><span id="l30.968">     // Set up the search ldap url - this is mURL</span>
<a href="#l30.969"></a><span id="l30.969">     rv = Initiate();</span>
<a href="#l30.970"></a><span id="l30.970">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.971"></a><span id="l30.971"> </span>
<a href="#l30.972"></a><span id="l30.972" class="difflineat">@@ -810,18 +754,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::DeleteC</span>
<a href="#l30.973"></a><span id="l30.973">     rv = DoModify(this, nsILDAPModification::MOD_DELETE, cardDN, nullptr,</span>
<a href="#l30.974"></a><span id="l30.974">                   EmptyCString(), EmptyCString());</span>
<a href="#l30.975"></a><span id="l30.975">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.976"></a><span id="l30.976">   }</span>
<a href="#l30.977"></a><span id="l30.977"> </span>
<a href="#l30.978"></a><span id="l30.978">   return NS_OK;</span>
<a href="#l30.979"></a><span id="l30.979"> }</span>
<a href="#l30.980"></a><span id="l30.980"> </span>
<a href="#l30.981"></a><span id="l30.981" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::ModifyCard(nsIAbCard *aUpdatedCard)</span>
<a href="#l30.982"></a><span id="l30.982" class="difflineminus">-{</span>
<a href="#l30.983"></a><span id="l30.983" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::ModifyCard(nsIAbCard *aUpdatedCard) {</span>
<a href="#l30.984"></a><span id="l30.984">   NS_ENSURE_ARG_POINTER(aUpdatedCard);</span>
<a href="#l30.985"></a><span id="l30.985"> </span>
<a href="#l30.986"></a><span id="l30.986">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l30.987"></a><span id="l30.987">   nsresult rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l30.988"></a><span id="l30.988">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.989"></a><span id="l30.989"> </span>
<a href="#l30.990"></a><span id="l30.990">   // Get the LDAP card</span>
<a href="#l30.991"></a><span id="l30.991">   nsCOMPtr&lt;nsIAbLDAPCard&gt; card = do_QueryInterface(aUpdatedCard, &amp;rv);</span>
<a href="#l30.992"></a><span id="l30.992" class="difflineat">@@ -832,116 +775,107 @@ NS_IMETHODIMP nsAbLDAPDirectory::ModifyC</span>
<a href="#l30.993"></a><span id="l30.993"> </span>
<a href="#l30.994"></a><span id="l30.994">   // Retrieve preferences</span>
<a href="#l30.995"></a><span id="l30.995">   nsAutoCString prefString;</span>
<a href="#l30.996"></a><span id="l30.996">   rv = GetObjectClasses(prefString);</span>
<a href="#l30.997"></a><span id="l30.997">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.998"></a><span id="l30.998"> </span>
<a href="#l30.999"></a><span id="l30.999">   CharPtrArrayGuard objClass;</span>
<a href="#l30.1000"></a><span id="l30.1000">   rv = SplitStringList(prefString, objClass.GetSizeAddr(),</span>
<a href="#l30.1001"></a><span id="l30.1001" class="difflineminus">-    objClass.GetArrayAddr());</span>
<a href="#l30.1002"></a><span id="l30.1002" class="difflineplus">+                       objClass.GetArrayAddr());</span>
<a href="#l30.1003"></a><span id="l30.1003">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1004"></a><span id="l30.1004"> </span>
<a href="#l30.1005"></a><span id="l30.1005">   // Process updates</span>
<a href="#l30.1006"></a><span id="l30.1006">   nsCOMPtr&lt;nsIArray&gt; modArray;</span>
<a href="#l30.1007"></a><span id="l30.1007" class="difflineminus">-  rv = card-&gt;GetLDAPMessageInfo(attrMap, objClass.GetSize(), objClass.GetArray(),</span>
<a href="#l30.1008"></a><span id="l30.1008" class="difflineminus">-    nsILDAPModification::MOD_REPLACE, getter_AddRefs(modArray));</span>
<a href="#l30.1009"></a><span id="l30.1009" class="difflineplus">+  rv = card-&gt;GetLDAPMessageInfo(</span>
<a href="#l30.1010"></a><span id="l30.1010" class="difflineplus">+      attrMap, objClass.GetSize(), objClass.GetArray(),</span>
<a href="#l30.1011"></a><span id="l30.1011" class="difflineplus">+      nsILDAPModification::MOD_REPLACE, getter_AddRefs(modArray));</span>
<a href="#l30.1012"></a><span id="l30.1012">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1013"></a><span id="l30.1013"> </span>
<a href="#l30.1014"></a><span id="l30.1014">   // Get current DN</span>
<a href="#l30.1015"></a><span id="l30.1015">   nsAutoCString oldDN;</span>
<a href="#l30.1016"></a><span id="l30.1016">   rv = card-&gt;GetDn(oldDN);</span>
<a href="#l30.1017"></a><span id="l30.1017">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1018"></a><span id="l30.1018"> </span>
<a href="#l30.1019"></a><span id="l30.1019" class="difflineminus">-  nsCOMPtr&lt;nsILDAPService&gt; ldapSvc = do_GetService(</span>
<a href="#l30.1020"></a><span id="l30.1020" class="difflineminus">-    &quot;@mozilla.org/network/ldap-service;1&quot;, &amp;rv);</span>
<a href="#l30.1021"></a><span id="l30.1021" class="difflineplus">+  nsCOMPtr&lt;nsILDAPService&gt; ldapSvc =</span>
<a href="#l30.1022"></a><span id="l30.1022" class="difflineplus">+      do_GetService(&quot;@mozilla.org/network/ldap-service;1&quot;, &amp;rv);</span>
<a href="#l30.1023"></a><span id="l30.1023">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1024"></a><span id="l30.1024"> </span>
<a href="#l30.1025"></a><span id="l30.1025">   // Retrieve base DN and RDN attributes</span>
<a href="#l30.1026"></a><span id="l30.1026">   nsAutoCString baseDN;</span>
<a href="#l30.1027"></a><span id="l30.1027">   nsAutoCString oldRDN;</span>
<a href="#l30.1028"></a><span id="l30.1028">   CharPtrArrayGuard rdnAttrs;</span>
<a href="#l30.1029"></a><span id="l30.1029" class="difflineminus">-  rv = ldapSvc-&gt;ParseDn(oldDN.get(), oldRDN, baseDN,</span>
<a href="#l30.1030"></a><span id="l30.1030" class="difflineminus">-                        rdnAttrs.GetSizeAddr(), rdnAttrs.GetArrayAddr());</span>
<a href="#l30.1031"></a><span id="l30.1031" class="difflineplus">+  rv = ldapSvc-&gt;ParseDn(oldDN.get(), oldRDN, baseDN, rdnAttrs.GetSizeAddr(),</span>
<a href="#l30.1032"></a><span id="l30.1032" class="difflineplus">+                        rdnAttrs.GetArrayAddr());</span>
<a href="#l30.1033"></a><span id="l30.1033">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1034"></a><span id="l30.1034"> </span>
<a href="#l30.1035"></a><span id="l30.1035">   // Calculate new RDN and check whether it has changed</span>
<a href="#l30.1036"></a><span id="l30.1036">   nsAutoCString newRDN;</span>
<a href="#l30.1037"></a><span id="l30.1037" class="difflineminus">-  rv = card-&gt;BuildRdn(attrMap, rdnAttrs.GetSize(), rdnAttrs.GetArray(),</span>
<a href="#l30.1038"></a><span id="l30.1038" class="difflineminus">-    newRDN);</span>
<a href="#l30.1039"></a><span id="l30.1039" class="difflineplus">+  rv = card-&gt;BuildRdn(attrMap, rdnAttrs.GetSize(), rdnAttrs.GetArray(), newRDN);</span>
<a href="#l30.1040"></a><span id="l30.1040">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1041"></a><span id="l30.1041"> </span>
<a href="#l30.1042"></a><span id="l30.1042" class="difflineminus">-  if (newRDN.Equals(oldRDN))</span>
<a href="#l30.1043"></a><span id="l30.1043" class="difflineminus">-  {</span>
<a href="#l30.1044"></a><span id="l30.1044" class="difflineplus">+  if (newRDN.Equals(oldRDN)) {</span>
<a href="#l30.1045"></a><span id="l30.1045">     // Launch query</span>
<a href="#l30.1046"></a><span id="l30.1046">     rv = DoModify(this, nsILDAPModification::MOD_REPLACE, oldDN, modArray,</span>
<a href="#l30.1047"></a><span id="l30.1047">                   EmptyCString(), EmptyCString());</span>
<a href="#l30.1048"></a><span id="l30.1048" class="difflineminus">-  }</span>
<a href="#l30.1049"></a><span id="l30.1049" class="difflineminus">-  else</span>
<a href="#l30.1050"></a><span id="l30.1050" class="difflineminus">-  {</span>
<a href="#l30.1051"></a><span id="l30.1051" class="difflineplus">+  } else {</span>
<a href="#l30.1052"></a><span id="l30.1052">     // Build and store the new DN</span>
<a href="#l30.1053"></a><span id="l30.1053">     nsAutoCString newDN(newRDN);</span>
<a href="#l30.1054"></a><span id="l30.1054">     newDN.Append(',');</span>
<a href="#l30.1055"></a><span id="l30.1055">     newDN.Append(baseDN);</span>
<a href="#l30.1056"></a><span id="l30.1056"> </span>
<a href="#l30.1057"></a><span id="l30.1057">     rv = card-&gt;SetDn(newDN);</span>
<a href="#l30.1058"></a><span id="l30.1058">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1059"></a><span id="l30.1059"> </span>
<a href="#l30.1060"></a><span id="l30.1060">     // Launch query</span>
<a href="#l30.1061"></a><span id="l30.1061">     rv = DoModify(this, nsILDAPModification::MOD_REPLACE, oldDN, modArray,</span>
<a href="#l30.1062"></a><span id="l30.1062">                   newRDN, baseDN);</span>
<a href="#l30.1063"></a><span id="l30.1063">   }</span>
<a href="#l30.1064"></a><span id="l30.1064">   return rv;</span>
<a href="#l30.1065"></a><span id="l30.1065"> }</span>
<a href="#l30.1066"></a><span id="l30.1066"> </span>
<a href="#l30.1067"></a><span id="l30.1067" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetRdnAttributes(nsACString &amp;aRdnAttributes)</span>
<a href="#l30.1068"></a><span id="l30.1068" class="difflineminus">-{</span>
<a href="#l30.1069"></a><span id="l30.1069" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetRdnAttributes(nsACString &amp;aRdnAttributes) {</span>
<a href="#l30.1070"></a><span id="l30.1070">   return GetStringValue(&quot;rdnAttributes&quot;, NS_LITERAL_CSTRING(&quot;cn&quot;),</span>
<a href="#l30.1071"></a><span id="l30.1071" class="difflineminus">-    aRdnAttributes);</span>
<a href="#l30.1072"></a><span id="l30.1072" class="difflineplus">+                        aRdnAttributes);</span>
<a href="#l30.1073"></a><span id="l30.1073"> }</span>
<a href="#l30.1074"></a><span id="l30.1074"> </span>
<a href="#l30.1075"></a><span id="l30.1075" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetRdnAttributes(const nsACString &amp;aRdnAttributes)</span>
<a href="#l30.1076"></a><span id="l30.1076" class="difflineminus">-{</span>
<a href="#l30.1077"></a><span id="l30.1077" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetRdnAttributes(</span>
<a href="#l30.1078"></a><span id="l30.1078" class="difflineplus">+    const nsACString &amp;aRdnAttributes) {</span>
<a href="#l30.1079"></a><span id="l30.1079">   return SetStringValue(&quot;rdnAttributes&quot;, aRdnAttributes);</span>
<a href="#l30.1080"></a><span id="l30.1080"> }</span>
<a href="#l30.1081"></a><span id="l30.1081"> </span>
<a href="#l30.1082"></a><span id="l30.1082" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetObjectClasses(nsACString &amp;aObjectClasses)</span>
<a href="#l30.1083"></a><span id="l30.1083" class="difflineminus">-{</span>
<a href="#l30.1084"></a><span id="l30.1084" class="difflineminus">-  return GetStringValue(&quot;objectClasses&quot;, NS_LITERAL_CSTRING(</span>
<a href="#l30.1085"></a><span id="l30.1085" class="difflineminus">-    &quot;top,person,organizationalPerson,inetOrgPerson,mozillaAbPersonAlpha&quot;),</span>
<a href="#l30.1086"></a><span id="l30.1086" class="difflineminus">-    aObjectClasses);</span>
<a href="#l30.1087"></a><span id="l30.1087" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetObjectClasses(nsACString &amp;aObjectClasses) {</span>
<a href="#l30.1088"></a><span id="l30.1088" class="difflineplus">+  return GetStringValue(</span>
<a href="#l30.1089"></a><span id="l30.1089" class="difflineplus">+      &quot;objectClasses&quot;,</span>
<a href="#l30.1090"></a><span id="l30.1090" class="difflineplus">+      NS_LITERAL_CSTRING(</span>
<a href="#l30.1091"></a><span id="l30.1091" class="difflineplus">+          &quot;top,person,organizationalPerson,inetOrgPerson,mozillaAbPersonAlpha&quot;),</span>
<a href="#l30.1092"></a><span id="l30.1092" class="difflineplus">+      aObjectClasses);</span>
<a href="#l30.1093"></a><span id="l30.1093"> }</span>
<a href="#l30.1094"></a><span id="l30.1094"> </span>
<a href="#l30.1095"></a><span id="l30.1095" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetObjectClasses(const nsACString &amp;aObjectClasses)</span>
<a href="#l30.1096"></a><span id="l30.1096" class="difflineminus">-{</span>
<a href="#l30.1097"></a><span id="l30.1097" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::SetObjectClasses(</span>
<a href="#l30.1098"></a><span id="l30.1098" class="difflineplus">+    const nsACString &amp;aObjectClasses) {</span>
<a href="#l30.1099"></a><span id="l30.1099">   return SetStringValue(&quot;objectClasses&quot;, aObjectClasses);</span>
<a href="#l30.1100"></a><span id="l30.1100"> }</span>
<a href="#l30.1101"></a><span id="l30.1101"> </span>
<a href="#l30.1102"></a><span id="l30.1102" class="difflineminus">-nsresult nsAbLDAPDirectory::SplitStringList(</span>
<a href="#l30.1103"></a><span id="l30.1103" class="difflineminus">-  const nsACString&amp; aString,</span>
<a href="#l30.1104"></a><span id="l30.1104" class="difflineminus">-  uint32_t *aCount,</span>
<a href="#l30.1105"></a><span id="l30.1105" class="difflineminus">-  char ***aValues)</span>
<a href="#l30.1106"></a><span id="l30.1106" class="difflineminus">-{</span>
<a href="#l30.1107"></a><span id="l30.1107" class="difflineplus">+nsresult nsAbLDAPDirectory::SplitStringList(const nsACString &amp;aString,</span>
<a href="#l30.1108"></a><span id="l30.1108" class="difflineplus">+                                            uint32_t *aCount, char ***aValues) {</span>
<a href="#l30.1109"></a><span id="l30.1109">   NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l30.1110"></a><span id="l30.1110">   NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l30.1111"></a><span id="l30.1111"> </span>
<a href="#l30.1112"></a><span id="l30.1112">   nsTArray&lt;nsCString&gt; strarr;</span>
<a href="#l30.1113"></a><span id="l30.1113">   ParseString(aString, ',', strarr);</span>
<a href="#l30.1114"></a><span id="l30.1114"> </span>
<a href="#l30.1115"></a><span id="l30.1115">   char **cArray = nullptr;</span>
<a href="#l30.1116"></a><span id="l30.1116" class="difflineminus">-  if (!(cArray = static_cast&lt;char **&gt;(moz_xmalloc(</span>
<a href="#l30.1117"></a><span id="l30.1117" class="difflineminus">-      strarr.Length() * sizeof(char *)))))</span>
<a href="#l30.1118"></a><span id="l30.1118" class="difflineplus">+  if (!(cArray = static_cast&lt;char **&gt;(</span>
<a href="#l30.1119"></a><span id="l30.1119" class="difflineplus">+            moz_xmalloc(strarr.Length() * sizeof(char *)))))</span>
<a href="#l30.1120"></a><span id="l30.1120">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l30.1121"></a><span id="l30.1121"> </span>
<a href="#l30.1122"></a><span id="l30.1122" class="difflineminus">-  for (uint32_t i = 0; i &lt; strarr.Length(); ++i)</span>
<a href="#l30.1123"></a><span id="l30.1123" class="difflineminus">-  {</span>
<a href="#l30.1124"></a><span id="l30.1124" class="difflineminus">-    if (!(cArray[i] = ToNewCString(strarr[i])))</span>
<a href="#l30.1125"></a><span id="l30.1125" class="difflineminus">-    {</span>
<a href="#l30.1126"></a><span id="l30.1126" class="difflineplus">+  for (uint32_t i = 0; i &lt; strarr.Length(); ++i) {</span>
<a href="#l30.1127"></a><span id="l30.1127" class="difflineplus">+    if (!(cArray[i] = ToNewCString(strarr[i]))) {</span>
<a href="#l30.1128"></a><span id="l30.1128">       NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(strarr.Length(), cArray);</span>
<a href="#l30.1129"></a><span id="l30.1129">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l30.1130"></a><span id="l30.1130">     }</span>
<a href="#l30.1131"></a><span id="l30.1131">   }</span>
<a href="#l30.1132"></a><span id="l30.1132"> </span>
<a href="#l30.1133"></a><span id="l30.1133">   *aCount = strarr.Length();</span>
<a href="#l30.1134"></a><span id="l30.1134">   *aValues = cArray;</span>
<a href="#l30.1135"></a><span id="l30.1135">   return NS_OK;</span>
<a href="#l30.1136"></a><span id="l30.1136"> }</span>
<a href="#l30.1137"></a><span id="l30.1137" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -12,57 +12,55 @@</span>
<a href="#l31.4"></a><span id="l31.4"> #include &quot;nsIAbDirectoryQuery.h&quot;</span>
<a href="#l31.5"></a><span id="l31.5"> #include &quot;nsIAbDirectorySearch.h&quot;</span>
<a href="#l31.6"></a><span id="l31.6"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l31.7"></a><span id="l31.7"> #include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l31.8"></a><span id="l31.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l31.9"></a><span id="l31.9"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-class nsAbLDAPDirectory :</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-  public nsAbDirProperty,             // nsIAbDirectory</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-  public nsAbLDAPDirectoryModify,</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-  public nsIAbDirectorySearch,</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-  public nsIAbLDAPDirectory,</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-  public nsIAbDirSearchListener</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-{</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-public:</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+class nsAbLDAPDirectory : public nsAbDirProperty,  // nsIAbDirectory</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+                          public nsAbLDAPDirectoryModify,</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+                          public nsIAbDirectorySearch,</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+                          public nsIAbLDAPDirectory,</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+                          public nsIAbDirSearchListener {</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+ public:</span>
<a href="#l31.26"></a><span id="l31.26">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l31.27"></a><span id="l31.27"> </span>
<a href="#l31.28"></a><span id="l31.28">   nsAbLDAPDirectory();</span>
<a href="#l31.29"></a><span id="l31.29"> </span>
<a href="#l31.30"></a><span id="l31.30">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l31.31"></a><span id="l31.31"> </span>
<a href="#l31.32"></a><span id="l31.32">   // nsIAbDirectory methods</span>
<a href="#l31.33"></a><span id="l31.33">   NS_IMETHOD GetPropertiesChromeURI(nsACString &amp;aResult) override;</span>
<a href="#l31.34"></a><span id="l31.34">   NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-  NS_IMETHOD GetChildNodes(nsISimpleEnumerator* *result) override;</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-  NS_IMETHOD GetChildCards(nsISimpleEnumerator* *result) override;</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+  NS_IMETHOD GetChildNodes(nsISimpleEnumerator **result) override;</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+  NS_IMETHOD GetChildCards(nsISimpleEnumerator **result) override;</span>
<a href="#l31.39"></a><span id="l31.39">   NS_IMETHOD GetIsQuery(bool *aResult) override;</span>
<a href="#l31.40"></a><span id="l31.40">   NS_IMETHOD HasCard(nsIAbCard *cards, bool *hasCard) override;</span>
<a href="#l31.41"></a><span id="l31.41">   NS_IMETHOD GetSupportsMailingLists(bool *aSupportsMailingsLists) override;</span>
<a href="#l31.42"></a><span id="l31.42">   NS_IMETHOD GetReadOnly(bool *aReadOnly) override;</span>
<a href="#l31.43"></a><span id="l31.43">   NS_IMETHOD GetIsRemote(bool *aIsRemote) override;</span>
<a href="#l31.44"></a><span id="l31.44">   NS_IMETHOD GetIsSecure(bool *aIsRemote) override;</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-  NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey, bool *aResult) override;</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+  NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+                                bool *aResult) override;</span>
<a href="#l31.48"></a><span id="l31.48">   NS_IMETHOD AddCard(nsIAbCard *aChildCard, nsIAbCard **aAddedCard) override;</span>
<a href="#l31.49"></a><span id="l31.49">   NS_IMETHOD ModifyCard(nsIAbCard *aModifiedCard) override;</span>
<a href="#l31.50"></a><span id="l31.50">   NS_IMETHOD DeleteCards(nsIArray *aCards) override;</span>
<a href="#l31.51"></a><span id="l31.51"> </span>
<a href="#l31.52"></a><span id="l31.52">   // nsIAbDirectorySearch methods</span>
<a href="#l31.53"></a><span id="l31.53">   NS_DECL_NSIABDIRECTORYSEARCH</span>
<a href="#l31.54"></a><span id="l31.54">   NS_DECL_NSIABLDAPDIRECTORY</span>
<a href="#l31.55"></a><span id="l31.55">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l31.56"></a><span id="l31.56"> </span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-protected:</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+ protected:</span>
<a href="#l31.59"></a><span id="l31.59">   virtual ~nsAbLDAPDirectory();</span>
<a href="#l31.60"></a><span id="l31.60">   nsresult Initiate();</span>
<a href="#l31.61"></a><span id="l31.61"> </span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-  nsresult SplitStringList(const nsACString&amp; aString,</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-                           uint32_t *aCount,</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+  nsresult SplitStringList(const nsACString &amp;aString, uint32_t *aCount,</span>
<a href="#l31.65"></a><span id="l31.65">                            char ***aValues);</span>
<a href="#l31.66"></a><span id="l31.66"> </span>
<a href="#l31.67"></a><span id="l31.67">   bool mPerformingQuery;</span>
<a href="#l31.68"></a><span id="l31.68">   int32_t mContext;</span>
<a href="#l31.69"></a><span id="l31.69">   int32_t mMaxHits;</span>
<a href="#l31.70"></a><span id="l31.70"> </span>
<a href="#l31.71"></a><span id="l31.71">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIAbCard&gt; mCache;</span>
<a href="#l31.72"></a><span id="l31.72"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -13,36 +13,33 @@</span>
<a href="#l32.4"></a><span id="l32.4"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l32.5"></a><span id="l32.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l32.6"></a><span id="l32.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> #include &lt;stdio.h&gt;</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> using namespace mozilla;</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-class nsAbModifyLDAPMessageListener : public nsAbLDAPListenerBase</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-{</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-public:</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+class nsAbModifyLDAPMessageListener : public nsAbLDAPListenerBase {</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ public:</span>
<a href="#l32.17"></a><span id="l32.17">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-  nsAbModifyLDAPMessageListener(const int32_t type,</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-                                const nsACString &amp;cardDN,</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-                                nsIArray* modArray,</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-                                const nsACString &amp;newRDN,</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+  nsAbModifyLDAPMessageListener(const int32_t type, const nsACString &amp;cardDN,</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+                                nsIArray *modArray, const nsACString &amp;newRDN,</span>
<a href="#l32.25"></a><span id="l32.25">                                 const nsACString &amp;newBaseDN,</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-                                nsILDAPURL* directoryUrl,</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-                                nsILDAPConnection* connection,</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-                                nsIMutableArray* serverSearchControls,</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-                                nsIMutableArray* clientSearchControls,</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+                                nsILDAPURL *directoryUrl,</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+                                nsILDAPConnection *connection,</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+                                nsIMutableArray *serverSearchControls,</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+                                nsIMutableArray *clientSearchControls,</span>
<a href="#l32.34"></a><span id="l32.34">                                 const nsACString &amp;login,</span>
<a href="#l32.35"></a><span id="l32.35">                                 const int32_t timeOut = 0);</span>
<a href="#l32.36"></a><span id="l32.36">   // nsILDAPMessageListener</span>
<a href="#l32.37"></a><span id="l32.37">   NS_IMETHOD OnLDAPMessage(nsILDAPMessage *aMessage) override;</span>
<a href="#l32.38"></a><span id="l32.38"> </span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-protected:</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+ protected:</span>
<a href="#l32.41"></a><span id="l32.41">   virtual ~nsAbModifyLDAPMessageListener();</span>
<a href="#l32.42"></a><span id="l32.42"> </span>
<a href="#l32.43"></a><span id="l32.43">   nsresult Cancel();</span>
<a href="#l32.44"></a><span id="l32.44">   virtual void InitFailed(bool aCancelled = false) override;</span>
<a href="#l32.45"></a><span id="l32.45">   virtual nsresult DoTask() override;</span>
<a href="#l32.46"></a><span id="l32.46">   nsresult DoMainTask();</span>
<a href="#l32.47"></a><span id="l32.47">   nsresult OnLDAPMessageModifyResult(nsILDAPMessage *aMessage);</span>
<a href="#l32.48"></a><span id="l32.48">   nsresult OnLDAPMessageRenameResult(nsILDAPMessage *aMessage);</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineat">@@ -57,272 +54,242 @@ protected:</span>
<a href="#l32.50"></a><span id="l32.50">   bool mCanceled;</span>
<a href="#l32.51"></a><span id="l32.51">   bool mFlagRename;</span>
<a href="#l32.52"></a><span id="l32.52"> </span>
<a href="#l32.53"></a><span id="l32.53">   nsCOMPtr&lt;nsILDAPOperation&gt; mModifyOperation;</span>
<a href="#l32.54"></a><span id="l32.54">   nsCOMPtr&lt;nsIMutableArray&gt; mServerSearchControls;</span>
<a href="#l32.55"></a><span id="l32.55">   nsCOMPtr&lt;nsIMutableArray&gt; mClientSearchControls;</span>
<a href="#l32.56"></a><span id="l32.56"> };</span>
<a href="#l32.57"></a><span id="l32.57"> </span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-</span>
<a href="#l32.59"></a><span id="l32.59"> NS_IMPL_ISUPPORTS(nsAbModifyLDAPMessageListener, nsILDAPMessageListener)</span>
<a href="#l32.60"></a><span id="l32.60"> </span>
<a href="#l32.61"></a><span id="l32.61"> nsAbModifyLDAPMessageListener::nsAbModifyLDAPMessageListener(</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-    const int32_t type,</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-    const nsACString &amp;cardDN,</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-    nsIArray* modArray,</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-    const nsACString &amp;newRDN,</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-    const nsACString &amp;newBaseDN,</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-    nsILDAPURL* directoryUrl,</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-    nsILDAPConnection* connection,</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-    nsIMutableArray* serverSearchControls,</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-    nsIMutableArray* clientSearchControls,</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-    const nsACString &amp;login,</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-    const int32_t timeOut) :</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-    nsAbLDAPListenerBase(directoryUrl, connection, login, timeOut),</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-    mType(type),</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-    mCardDN(cardDN),</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-    mModification(modArray),</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-    mNewRDN(newRDN),</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-    mNewBaseDN(newBaseDN),</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-    mFinished(false),</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-    mCanceled(false),</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-    mFlagRename(false),</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-    mServerSearchControls(serverSearchControls),</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-    mClientSearchControls(clientSearchControls)</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-{</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-  if (mType == nsILDAPModification::MOD_REPLACE &amp;&amp;</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-      !mNewRDN.IsEmpty() &amp;&amp; !mNewBaseDN.IsEmpty())</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+    const int32_t type, const nsACString &amp;cardDN, nsIArray *modArray,</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+    const nsACString &amp;newRDN, const nsACString &amp;newBaseDN,</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+    nsILDAPURL *directoryUrl, nsILDAPConnection *connection,</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+    nsIMutableArray *serverSearchControls,</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+    nsIMutableArray *clientSearchControls, const nsACString &amp;login,</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+    const int32_t timeOut)</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+    : nsAbLDAPListenerBase(directoryUrl, connection, login, timeOut),</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+      mType(type),</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+      mCardDN(cardDN),</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+      mModification(modArray),</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+      mNewRDN(newRDN),</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+      mNewBaseDN(newBaseDN),</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineplus">+      mFinished(false),</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+      mCanceled(false),</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineplus">+      mFlagRename(false),</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineplus">+      mServerSearchControls(serverSearchControls),</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+      mClientSearchControls(clientSearchControls) {</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+  if (mType == nsILDAPModification::MOD_REPLACE &amp;&amp; !mNewRDN.IsEmpty() &amp;&amp;</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+      !mNewBaseDN.IsEmpty())</span>
<a href="#l32.106"></a><span id="l32.106">     mFlagRename = true;</span>
<a href="#l32.107"></a><span id="l32.107"> }</span>
<a href="#l32.108"></a><span id="l32.108"> </span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-nsAbModifyLDAPMessageListener::~nsAbModifyLDAPMessageListener ()</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineminus">-{</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineminus">-}</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineplus">+nsAbModifyLDAPMessageListener::~nsAbModifyLDAPMessageListener() {}</span>
<a href="#l32.113"></a><span id="l32.113"> </span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::Cancel ()</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-{</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+nsresult nsAbModifyLDAPMessageListener::Cancel() {</span>
<a href="#l32.117"></a><span id="l32.117">   nsresult rv = Initiate();</span>
<a href="#l32.118"></a><span id="l32.118">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.119"></a><span id="l32.119"> </span>
<a href="#l32.120"></a><span id="l32.120">   MutexAutoLock lock(mLock);</span>
<a href="#l32.121"></a><span id="l32.121"> </span>
<a href="#l32.122"></a><span id="l32.122" class="difflineminus">-  if (mFinished || mCanceled)</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+  if (mFinished || mCanceled) return NS_OK;</span>
<a href="#l32.125"></a><span id="l32.125"> </span>
<a href="#l32.126"></a><span id="l32.126">   mCanceled = true;</span>
<a href="#l32.127"></a><span id="l32.127"> </span>
<a href="#l32.128"></a><span id="l32.128">   return NS_OK;</span>
<a href="#l32.129"></a><span id="l32.129"> }</span>
<a href="#l32.130"></a><span id="l32.130"> </span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-NS_IMETHODIMP nsAbModifyLDAPMessageListener::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-{</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+NS_IMETHODIMP nsAbModifyLDAPMessageListener::OnLDAPMessage(</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l32.135"></a><span id="l32.135">   nsresult rv = Initiate();</span>
<a href="#l32.136"></a><span id="l32.136">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.137"></a><span id="l32.137"> </span>
<a href="#l32.138"></a><span id="l32.138">   int32_t messageType;</span>
<a href="#l32.139"></a><span id="l32.139">   rv = aMessage-&gt;GetType(&amp;messageType);</span>
<a href="#l32.140"></a><span id="l32.140">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.141"></a><span id="l32.141"> </span>
<a href="#l32.142"></a><span id="l32.142">   bool cancelOperation = false;</span>
<a href="#l32.143"></a><span id="l32.143"> </span>
<a href="#l32.144"></a><span id="l32.144">   // Enter lock</span>
<a href="#l32.145"></a><span id="l32.145">   {</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineminus">-    MutexAutoLock lock (mLock);</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+    MutexAutoLock lock(mLock);</span>
<a href="#l32.148"></a><span id="l32.148"> </span>
<a href="#l32.149"></a><span id="l32.149" class="difflineminus">-    if (mFinished)</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineminus">-      return NS_OK;</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+    if (mFinished) return NS_OK;</span>
<a href="#l32.152"></a><span id="l32.152"> </span>
<a href="#l32.153"></a><span id="l32.153">     // for these messages, no matter the outcome, we're done</span>
<a href="#l32.154"></a><span id="l32.154">     if ((messageType == nsILDAPMessage::RES_ADD) ||</span>
<a href="#l32.155"></a><span id="l32.155">         (messageType == nsILDAPMessage::RES_DELETE) ||</span>
<a href="#l32.156"></a><span id="l32.156">         (messageType == nsILDAPMessage::RES_MODIFY))</span>
<a href="#l32.157"></a><span id="l32.157">       mFinished = true;</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineminus">-    else if (mCanceled)</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineminus">-    {</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineplus">+    else if (mCanceled) {</span>
<a href="#l32.161"></a><span id="l32.161">       mFinished = true;</span>
<a href="#l32.162"></a><span id="l32.162">       cancelOperation = true;</span>
<a href="#l32.163"></a><span id="l32.163">     }</span>
<a href="#l32.164"></a><span id="l32.164">   }</span>
<a href="#l32.165"></a><span id="l32.165">   // Leave lock</span>
<a href="#l32.166"></a><span id="l32.166"> </span>
<a href="#l32.167"></a><span id="l32.167">   //    nsCOMPtr&lt;nsIAbDirectoryQueryResult&gt; queryResult;</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-  if (!cancelOperation)</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineminus">-  {</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineminus">-    switch (messageType)</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineminus">-    {</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineminus">-    case nsILDAPMessage::RES_BIND:</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineminus">-      rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-        // We know the bind failed and hence the message has an error, so we</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineminus">-        // can just call ModifyResult with the message and that'll sort it out</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineminus">-        // for us.</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineplus">+  if (!cancelOperation) {</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineplus">+    switch (messageType) {</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+      case nsILDAPMessage::RES_BIND:</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineplus">+        rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+          // We know the bind failed and hence the message has an error, so we</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineplus">+          // can just call ModifyResult with the message and that'll sort it out</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineplus">+          // for us.</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineplus">+          rv = OnLDAPMessageModifyResult(aMessage);</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+        break;</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+      case nsILDAPMessage::RES_ADD:</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineplus">+      case nsILDAPMessage::RES_MODIFY:</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineplus">+      case nsILDAPMessage::RES_DELETE:</span>
<a href="#l32.191"></a><span id="l32.191">         rv = OnLDAPMessageModifyResult(aMessage);</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineminus">-      break;</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineminus">-    case nsILDAPMessage::RES_ADD:</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineminus">-    case nsILDAPMessage::RES_MODIFY:</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineminus">-    case nsILDAPMessage::RES_DELETE:</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineminus">-      rv = OnLDAPMessageModifyResult(aMessage);</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineminus">-      break;</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-    case nsILDAPMessage::RES_MODDN:</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineminus">-      mFlagRename = false;</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineminus">-      rv = OnLDAPMessageRenameResult(aMessage);</span>
<a href="#l32.201"></a><span id="l32.201" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l32.202"></a><span id="l32.202" class="difflineminus">-        // Rename failed, so we stop here</span>
<a href="#l32.203"></a><span id="l32.203" class="difflineminus">-        mFinished = true;</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineminus">-      break;</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineminus">-    default:</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineminus">-      break;</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineplus">+        break;</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineplus">+      case nsILDAPMessage::RES_MODDN:</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineplus">+        mFlagRename = false;</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineplus">+        rv = OnLDAPMessageRenameResult(aMessage);</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineplus">+          // Rename failed, so we stop here</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineplus">+          mFinished = true;</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineplus">+        break;</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineplus">+      default:</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineplus">+        break;</span>
<a href="#l32.217"></a><span id="l32.217">     }</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineminus">-  }</span>
<a href="#l32.219"></a><span id="l32.219" class="difflineminus">-  else</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineminus">-  {</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineminus">-    if (mModifyOperation)</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineminus">-      rv = mModifyOperation-&gt;AbandonExt();</span>
<a href="#l32.223"></a><span id="l32.223" class="difflineplus">+  } else {</span>
<a href="#l32.224"></a><span id="l32.224" class="difflineplus">+    if (mModifyOperation) rv = mModifyOperation-&gt;AbandonExt();</span>
<a href="#l32.225"></a><span id="l32.225"> </span>
<a href="#l32.226"></a><span id="l32.226">     // reset because we might re-use this listener...except don't do this</span>
<a href="#l32.227"></a><span id="l32.227">     // until the search is done, so we'll ignore results from a previous</span>
<a href="#l32.228"></a><span id="l32.228">     // search.</span>
<a href="#l32.229"></a><span id="l32.229">     mCanceled = mFinished = false;</span>
<a href="#l32.230"></a><span id="l32.230">   }</span>
<a href="#l32.231"></a><span id="l32.231"> </span>
<a href="#l32.232"></a><span id="l32.232">   return rv;</span>
<a href="#l32.233"></a><span id="l32.233"> }</span>
<a href="#l32.234"></a><span id="l32.234"> </span>
<a href="#l32.235"></a><span id="l32.235" class="difflineminus">-void nsAbModifyLDAPMessageListener::InitFailed(bool aCancelled)</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineminus">-{</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineplus">+void nsAbModifyLDAPMessageListener::InitFailed(bool aCancelled) {</span>
<a href="#l32.238"></a><span id="l32.238">   // XXX Just cancel the operation for now</span>
<a href="#l32.239"></a><span id="l32.239">   // we'll need to review this when we've got the proper listeners in place.</span>
<a href="#l32.240"></a><span id="l32.240">   Cancel();</span>
<a href="#l32.241"></a><span id="l32.241"> }</span>
<a href="#l32.242"></a><span id="l32.242"> </span>
<a href="#l32.243"></a><span id="l32.243" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::DoTask()</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineminus">-{</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineplus">+nsresult nsAbModifyLDAPMessageListener::DoTask() {</span>
<a href="#l32.246"></a><span id="l32.246">   nsresult rv;</span>
<a href="#l32.247"></a><span id="l32.247">   mCanceled = mFinished = false;</span>
<a href="#l32.248"></a><span id="l32.248"> </span>
<a href="#l32.249"></a><span id="l32.249">   mModifyOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l32.250"></a><span id="l32.250">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.251"></a><span id="l32.251"> </span>
<a href="#l32.252"></a><span id="l32.252" class="difflineminus">-  rv = mModifyOperation-&gt;Init (mConnection, this, nullptr);</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineplus">+  rv = mModifyOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l32.254"></a><span id="l32.254">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.255"></a><span id="l32.255"> </span>
<a href="#l32.256"></a><span id="l32.256">   // XXX do we need the search controls?</span>
<a href="#l32.257"></a><span id="l32.257">   rv = mModifyOperation-&gt;SetServerControls(mServerSearchControls);</span>
<a href="#l32.258"></a><span id="l32.258">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.259"></a><span id="l32.259"> </span>
<a href="#l32.260"></a><span id="l32.260">   rv = mModifyOperation-&gt;SetClientControls(mClientSearchControls);</span>
<a href="#l32.261"></a><span id="l32.261">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.262"></a><span id="l32.262"> </span>
<a href="#l32.263"></a><span id="l32.263">   if (mFlagRename)</span>
<a href="#l32.264"></a><span id="l32.264">     return mModifyOperation-&gt;Rename(mCardDN, mNewRDN, mNewBaseDN, true);</span>
<a href="#l32.265"></a><span id="l32.265"> </span>
<a href="#l32.266"></a><span id="l32.266" class="difflineminus">-  switch (mType)</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineminus">-  {</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineplus">+  switch (mType) {</span>
<a href="#l32.269"></a><span id="l32.269">     case nsILDAPModification::MOD_ADD:</span>
<a href="#l32.270"></a><span id="l32.270">       return mModifyOperation-&gt;AddExt(mCardDN, mModification);</span>
<a href="#l32.271"></a><span id="l32.271">     case nsILDAPModification::MOD_DELETE:</span>
<a href="#l32.272"></a><span id="l32.272">       return mModifyOperation-&gt;DeleteExt(mCardDN);</span>
<a href="#l32.273"></a><span id="l32.273">     case nsILDAPModification::MOD_REPLACE:</span>
<a href="#l32.274"></a><span id="l32.274">       return mModifyOperation-&gt;ModifyExt(mCardDN, mModification);</span>
<a href="#l32.275"></a><span id="l32.275">     default:</span>
<a href="#l32.276"></a><span id="l32.276">       NS_ERROR(&quot;Bad LDAP modification requested&quot;);</span>
<a href="#l32.277"></a><span id="l32.277">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l32.278"></a><span id="l32.278">   }</span>
<a href="#l32.279"></a><span id="l32.279"> }</span>
<a href="#l32.280"></a><span id="l32.280"> </span>
<a href="#l32.281"></a><span id="l32.281" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageModifyResult(nsILDAPMessage *aMessage)</span>
<a href="#l32.282"></a><span id="l32.282" class="difflineminus">-{</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineplus">+nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageModifyResult(</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l32.285"></a><span id="l32.285">   nsresult rv;</span>
<a href="#l32.286"></a><span id="l32.286">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l32.287"></a><span id="l32.287"> </span>
<a href="#l32.288"></a><span id="l32.288">   int32_t errCode;</span>
<a href="#l32.289"></a><span id="l32.289">   rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l32.290"></a><span id="l32.290">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.291"></a><span id="l32.291"> </span>
<a href="#l32.292"></a><span id="l32.292" class="difflineminus">-  if (errCode != nsILDAPErrors::SUCCESS)</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineminus">-  {</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineplus">+  if (errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l32.295"></a><span id="l32.295">     nsAutoCString errMessage;</span>
<a href="#l32.296"></a><span id="l32.296">     rv = aMessage-&gt;GetErrorMessage(errMessage);</span>
<a href="#l32.297"></a><span id="l32.297">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.298"></a><span id="l32.298"> </span>
<a href="#l32.299"></a><span id="l32.299" class="difflineminus">-    printf(&quot;LDAP modification failed (code: %i, message: %s)\n&quot;,</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineminus">-           errCode, errMessage.get());</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineplus">+    printf(&quot;LDAP modification failed (code: %i, message: %s)\n&quot;, errCode,</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineplus">+           errMessage.get());</span>
<a href="#l32.303"></a><span id="l32.303">     return NS_ERROR_FAILURE;</span>
<a href="#l32.304"></a><span id="l32.304">   }</span>
<a href="#l32.305"></a><span id="l32.305"> </span>
<a href="#l32.306"></a><span id="l32.306">   printf(&quot;LDAP modification succeeded\n&quot;);</span>
<a href="#l32.307"></a><span id="l32.307">   return NS_OK;</span>
<a href="#l32.308"></a><span id="l32.308"> }</span>
<a href="#l32.309"></a><span id="l32.309"> </span>
<a href="#l32.310"></a><span id="l32.310" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageRenameResult(nsILDAPMessage *aMessage)</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineminus">-{</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineplus">+nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageRenameResult(</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l32.314"></a><span id="l32.314">   nsresult rv;</span>
<a href="#l32.315"></a><span id="l32.315">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l32.316"></a><span id="l32.316"> </span>
<a href="#l32.317"></a><span id="l32.317">   int32_t errCode;</span>
<a href="#l32.318"></a><span id="l32.318">   rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l32.319"></a><span id="l32.319">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.320"></a><span id="l32.320"> </span>
<a href="#l32.321"></a><span id="l32.321" class="difflineminus">-  if (errCode != nsILDAPErrors::SUCCESS)</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineminus">-  {</span>
<a href="#l32.323"></a><span id="l32.323" class="difflineplus">+  if (errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l32.324"></a><span id="l32.324">     nsAutoCString errMessage;</span>
<a href="#l32.325"></a><span id="l32.325">     rv = aMessage-&gt;GetErrorMessage(errMessage);</span>
<a href="#l32.326"></a><span id="l32.326">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.327"></a><span id="l32.327"> </span>
<a href="#l32.328"></a><span id="l32.328" class="difflineminus">-    printf(&quot;LDAP rename failed (code: %i, message: %s)\n&quot;,</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineminus">-           errCode, errMessage.get());</span>
<a href="#l32.330"></a><span id="l32.330" class="difflineplus">+    printf(&quot;LDAP rename failed (code: %i, message: %s)\n&quot;, errCode,</span>
<a href="#l32.331"></a><span id="l32.331" class="difflineplus">+           errMessage.get());</span>
<a href="#l32.332"></a><span id="l32.332">     return NS_ERROR_FAILURE;</span>
<a href="#l32.333"></a><span id="l32.333">   }</span>
<a href="#l32.334"></a><span id="l32.334"> </span>
<a href="#l32.335"></a><span id="l32.335">   // Rename succeeded, now update the card DN and</span>
<a href="#l32.336"></a><span id="l32.336">   // process the main task</span>
<a href="#l32.337"></a><span id="l32.337">   mCardDN.Assign(mNewRDN);</span>
<a href="#l32.338"></a><span id="l32.338">   mCardDN.Append(',');</span>
<a href="#l32.339"></a><span id="l32.339">   mCardDN.Append(mNewBaseDN);</span>
<a href="#l32.340"></a><span id="l32.340"> </span>
<a href="#l32.341"></a><span id="l32.341">   printf(&quot;LDAP rename succeeded\n&quot;);</span>
<a href="#l32.342"></a><span id="l32.342">   return DoTask();</span>
<a href="#l32.343"></a><span id="l32.343"> }</span>
<a href="#l32.344"></a><span id="l32.344"> </span>
<a href="#l32.345"></a><span id="l32.345" class="difflineminus">-nsAbLDAPDirectoryModify::nsAbLDAPDirectoryModify()</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineminus">-{</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineminus">-}</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineplus">+nsAbLDAPDirectoryModify::nsAbLDAPDirectoryModify() {}</span>
<a href="#l32.349"></a><span id="l32.349"> </span>
<a href="#l32.350"></a><span id="l32.350" class="difflineminus">-nsAbLDAPDirectoryModify::~nsAbLDAPDirectoryModify()</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineminus">-{</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineminus">-}</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineplus">+nsAbLDAPDirectoryModify::~nsAbLDAPDirectoryModify() {}</span>
<a href="#l32.354"></a><span id="l32.354"> </span>
<a href="#l32.355"></a><span id="l32.355"> nsresult nsAbLDAPDirectoryModify::DoModify(nsIAbLDAPDirectory *directory,</span>
<a href="#l32.356"></a><span id="l32.356">                                            const int32_t &amp;updateType,</span>
<a href="#l32.357"></a><span id="l32.357">                                            const nsACString &amp;cardDN,</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineminus">-                                           nsIArray* modArray,</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineplus">+                                           nsIArray *modArray,</span>
<a href="#l32.360"></a><span id="l32.360">                                            const nsACString &amp;newRDN,</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineminus">-                                           const nsACString &amp;newBaseDN)</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineminus">-{</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineplus">+                                           const nsACString &amp;newBaseDN) {</span>
<a href="#l32.364"></a><span id="l32.364">   NS_ENSURE_ARG_POINTER(directory);</span>
<a href="#l32.365"></a><span id="l32.365">   // modArray may be null in the delete operation case.</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineminus">-  if (!modArray &amp;&amp;</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineminus">-      (updateType == nsILDAPModification::MOD_ADD ||</span>
<a href="#l32.368"></a><span id="l32.368" class="difflineminus">-       updateType == nsILDAPModification::MOD_REPLACE))</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineplus">+  if (!modArray &amp;&amp; (updateType == nsILDAPModification::MOD_ADD ||</span>
<a href="#l32.370"></a><span id="l32.370" class="difflineplus">+                    updateType == nsILDAPModification::MOD_REPLACE))</span>
<a href="#l32.371"></a><span id="l32.371">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.372"></a><span id="l32.372"> </span>
<a href="#l32.373"></a><span id="l32.373">   nsresult rv;</span>
<a href="#l32.374"></a><span id="l32.374"> </span>
<a href="#l32.375"></a><span id="l32.375">   // it's an error if we don't have a dn</span>
<a href="#l32.376"></a><span id="l32.376" class="difflineminus">-  if (cardDN.IsEmpty())</span>
<a href="#l32.377"></a><span id="l32.377" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l32.378"></a><span id="l32.378" class="difflineplus">+  if (cardDN.IsEmpty()) return NS_ERROR_INVALID_ARG;</span>
<a href="#l32.379"></a><span id="l32.379"> </span>
<a href="#l32.380"></a><span id="l32.380">   nsCOMPtr&lt;nsILDAPURL&gt; currentUrl;</span>
<a href="#l32.381"></a><span id="l32.381">   rv = directory-&gt;GetLDAPURL(getter_AddRefs(currentUrl));</span>
<a href="#l32.382"></a><span id="l32.382">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.383"></a><span id="l32.383"> </span>
<a href="#l32.384"></a><span id="l32.384">   // Get the ldap connection</span>
<a href="#l32.385"></a><span id="l32.385">   nsCOMPtr&lt;nsILDAPConnection&gt; ldapConnection =</span>
<a href="#l32.386"></a><span id="l32.386" class="difflineminus">-    do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineplus">+      do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l32.388"></a><span id="l32.388"> </span>
<a href="#l32.389"></a><span id="l32.389">   nsCOMPtr&lt;nsIMutableArray&gt; serverSearchControls;</span>
<a href="#l32.390"></a><span id="l32.390">   rv = directory-&gt;GetSearchServerControls(getter_AddRefs(serverSearchControls));</span>
<a href="#l32.391"></a><span id="l32.391">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.392"></a><span id="l32.392"> </span>
<a href="#l32.393"></a><span id="l32.393">   nsCOMPtr&lt;nsIMutableArray&gt; clientSearchControls;</span>
<a href="#l32.394"></a><span id="l32.394">   rv = directory-&gt;GetSearchClientControls(getter_AddRefs(clientSearchControls));</span>
<a href="#l32.395"></a><span id="l32.395">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineat">@@ -347,26 +314,19 @@ nsresult nsAbLDAPDirectoryModify::DoModi</span>
<a href="#l32.397"></a><span id="l32.397">   rv = directory-&gt;GetAuthDn(login);</span>
<a href="#l32.398"></a><span id="l32.398">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.399"></a><span id="l32.399"> </span>
<a href="#l32.400"></a><span id="l32.400">   uint32_t protocolVersion;</span>
<a href="#l32.401"></a><span id="l32.401">   rv = directory-&gt;GetProtocolVersion(&amp;protocolVersion);</span>
<a href="#l32.402"></a><span id="l32.402">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.403"></a><span id="l32.403"> </span>
<a href="#l32.404"></a><span id="l32.404">   // Initiate LDAP message listener</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineminus">-  nsAbModifyLDAPMessageListener* _messageListener =</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineminus">-    new nsAbModifyLDAPMessageListener(updateType, cardDN, modArray,</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineminus">-                                      newRDN, newBaseDN,</span>
<a href="#l32.408"></a><span id="l32.408" class="difflineminus">-                                      currentUrl,</span>
<a href="#l32.409"></a><span id="l32.409" class="difflineminus">-                                      ldapConnection,</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineminus">-                                      serverSearchControls,</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineminus">-                                      clientSearchControls,</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineminus">-                                      login,</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineminus">-                                      0);</span>
<a href="#l32.414"></a><span id="l32.414" class="difflineminus">-  if (_messageListener == NULL)</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineplus">+  nsAbModifyLDAPMessageListener *_messageListener =</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineplus">+      new nsAbModifyLDAPMessageListener(</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineplus">+          updateType, cardDN, modArray, newRDN, newBaseDN, currentUrl,</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineplus">+          ldapConnection, serverSearchControls, clientSearchControls, login, 0);</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineplus">+  if (_messageListener == NULL) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.421"></a><span id="l32.421"> </span>
<a href="#l32.422"></a><span id="l32.422">   // Now lets initialize the LDAP connection properly. We'll kick</span>
<a href="#l32.423"></a><span id="l32.423">   // off the bind operation in the callback function, |OnLDAPInit()|.</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineminus">-  return ldapConnection-&gt;Init(currentUrl, login,</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineminus">-                              _messageListener, nullptr, protocolVersion);</span>
<a href="#l32.426"></a><span id="l32.426" class="difflineplus">+  return ldapConnection-&gt;Init(currentUrl, login, _messageListener, nullptr,</span>
<a href="#l32.427"></a><span id="l32.427" class="difflineplus">+                              protocolVersion);</span>
<a href="#l32.428"></a><span id="l32.428"> }</span>
<a href="#l32.429"></a><span id="l32.429" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -4,24 +4,20 @@</span>
<a href="#l33.4"></a><span id="l33.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> #ifndef nsAbLDAPDirectoryModify_h__</span>
<a href="#l33.7"></a><span id="l33.7"> #define nsAbLDAPDirectoryModify_h__</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> #include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l33.10"></a><span id="l33.10"> #include &quot;nsIArray.h&quot;</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-class nsAbLDAPDirectoryModify</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-{</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-public:</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+class nsAbLDAPDirectoryModify {</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+ public:</span>
<a href="#l33.17"></a><span id="l33.17">   nsAbLDAPDirectoryModify();</span>
<a href="#l33.18"></a><span id="l33.18">   virtual ~nsAbLDAPDirectoryModify();</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-protected:</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-  nsresult DoModify(nsIAbLDAPDirectory *directory,</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-                    const int32_t &amp;aUpdateType,</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-                    const nsACString &amp;aCardDN,</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-                    nsIArray* modArray,</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-                    const nsACString &amp;aNewRDN,</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-                    const nsACString &amp;aNewBaseDN);</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+ protected:</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+  nsresult DoModify(nsIAbLDAPDirectory *directory, const int32_t &amp;aUpdateType,</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+                    const nsACString &amp;aCardDN, nsIArray *modArray,</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+                    const nsACString &amp;aNewRDN, const nsACString &amp;aNewBaseDN);</span>
<a href="#l33.31"></a><span id="l33.31"> };</span>
<a href="#l33.32"></a><span id="l33.32"> </span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-#endif // nsAbLDAPDirectoryModify_h__</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+#endif  // nsAbLDAPDirectoryModify_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -21,42 +21,39 @@</span>
<a href="#l34.4"></a><span id="l34.4"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l34.5"></a><span id="l34.5"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> using namespace mozilla;</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> extern mozilla::LazyLogModule gLDAPLogModule;  // defined in nsLDAPService.cpp</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11"> // nsAbLDAPListenerBase inherits nsILDAPMessageListener</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-class nsAbQueryLDAPMessageListener : public nsAbLDAPListenerBase</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-{</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-public:</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+class nsAbQueryLDAPMessageListener : public nsAbLDAPListenerBase {</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+ public:</span>
<a href="#l34.17"></a><span id="l34.17">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19">   // Note that the directoryUrl is the details of the ldap directory</span>
<a href="#l34.20"></a><span id="l34.20">   // without any search params or return attributes specified. The searchUrl</span>
<a href="#l34.21"></a><span id="l34.21">   // therefore has the search params and return attributes specified.</span>
<a href="#l34.22"></a><span id="l34.22">   //  nsAbQueryLDAPMessageListener(nsIAbDirectoryQuery* directoryQuery,</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-  nsAbQueryLDAPMessageListener(nsIAbDirectoryQueryResultListener* resultListener,</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-                               nsILDAPURL* directoryUrl,</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-                               nsILDAPURL* searchUrl,</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-                               nsILDAPConnection* connection,</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-                               nsIAbDirectoryQueryArguments* queryArguments,</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-                               nsIMutableArray* serverSearchControls,</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-                               nsIMutableArray* clientSearchControls,</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-                               const nsACString &amp;login,</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-                               const nsACString &amp;mechanism,</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-                               const int32_t resultLimit = -1,</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-                               const int32_t timeOut = 0);</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+  nsAbQueryLDAPMessageListener(</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+      nsIAbDirectoryQueryResultListener *resultListener,</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+      nsILDAPURL *directoryUrl, nsILDAPURL *searchUrl,</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+      nsILDAPConnection *connection,</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+      nsIAbDirectoryQueryArguments *queryArguments,</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+      nsIMutableArray *serverSearchControls,</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+      nsIMutableArray *clientSearchControls, const nsACString &amp;login,</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+      const nsACString &amp;mechanism, const int32_t resultLimit = -1,</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+      const int32_t timeOut = 0);</span>
<a href="#l34.43"></a><span id="l34.43"> </span>
<a href="#l34.44"></a><span id="l34.44">   // nsILDAPMessageListener</span>
<a href="#l34.45"></a><span id="l34.45">   NS_IMETHOD OnLDAPMessage(nsILDAPMessage *aMessage) override;</span>
<a href="#l34.46"></a><span id="l34.46"> </span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-protected:</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-  virtual ~nsAbQueryLDAPMessageListener ();</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+ protected:</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+  virtual ~nsAbQueryLDAPMessageListener();</span>
<a href="#l34.51"></a><span id="l34.51">   nsresult OnLDAPMessageSearchEntry(nsILDAPMessage *aMessage);</span>
<a href="#l34.52"></a><span id="l34.52">   nsresult OnLDAPMessageSearchResult(nsILDAPMessage *aMessage);</span>
<a href="#l34.53"></a><span id="l34.53"> </span>
<a href="#l34.54"></a><span id="l34.54">   friend class nsAbLDAPDirectoryQuery;</span>
<a href="#l34.55"></a><span id="l34.55"> </span>
<a href="#l34.56"></a><span id="l34.56">   nsresult Cancel();</span>
<a href="#l34.57"></a><span id="l34.57">   virtual nsresult DoTask() override;</span>
<a href="#l34.58"></a><span id="l34.58">   virtual void InitFailed(bool aCancelled = false) override;</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineat">@@ -69,147 +66,128 @@ protected:</span>
<a href="#l34.60"></a><span id="l34.60"> </span>
<a href="#l34.61"></a><span id="l34.61">   bool mFinished;</span>
<a href="#l34.62"></a><span id="l34.62">   bool mCanceled;</span>
<a href="#l34.63"></a><span id="l34.63"> </span>
<a href="#l34.64"></a><span id="l34.64">   nsCOMPtr&lt;nsIMutableArray&gt; mServerSearchControls;</span>
<a href="#l34.65"></a><span id="l34.65">   nsCOMPtr&lt;nsIMutableArray&gt; mClientSearchControls;</span>
<a href="#l34.66"></a><span id="l34.66"> };</span>
<a href="#l34.67"></a><span id="l34.67"> </span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-</span>
<a href="#l34.69"></a><span id="l34.69"> NS_IMPL_ISUPPORTS(nsAbQueryLDAPMessageListener, nsILDAPMessageListener)</span>
<a href="#l34.70"></a><span id="l34.70"> </span>
<a href="#l34.71"></a><span id="l34.71"> nsAbQueryLDAPMessageListener::nsAbQueryLDAPMessageListener(</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-        nsIAbDirectoryQueryResultListener *resultListener,</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-        nsILDAPURL* directoryUrl,</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-        nsILDAPURL* searchUrl,</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-        nsILDAPConnection* connection,</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-        nsIAbDirectoryQueryArguments* queryArguments,</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-        nsIMutableArray* serverSearchControls,</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-        nsIMutableArray* clientSearchControls,</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-        const nsACString &amp;login,</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-        const nsACString &amp;mechanism,</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-        const int32_t resultLimit,</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-        const int32_t timeOut) :</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-  nsAbLDAPListenerBase(directoryUrl, connection, login, timeOut),</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineminus">-  mSearchUrl(searchUrl),</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineminus">-  mResultListener(resultListener),</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-  mQueryArguments(queryArguments),</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-  mResultLimit(resultLimit),</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineminus">-  mFinished(false),</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-  mCanceled(false),</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineminus">-  mServerSearchControls(serverSearchControls),</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-  mClientSearchControls(clientSearchControls)</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-{</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+    nsIAbDirectoryQueryResultListener *resultListener, nsILDAPURL *directoryUrl,</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+    nsILDAPURL *searchUrl, nsILDAPConnection *connection,</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+    nsIAbDirectoryQueryArguments *queryArguments,</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+    nsIMutableArray *serverSearchControls,</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+    nsIMutableArray *clientSearchControls, const nsACString &amp;login,</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+    const nsACString &amp;mechanism, const int32_t resultLimit,</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+    const int32_t timeOut)</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+    : nsAbLDAPListenerBase(directoryUrl, connection, login, timeOut),</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+      mSearchUrl(searchUrl),</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+      mResultListener(resultListener),</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+      mQueryArguments(queryArguments),</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+      mResultLimit(resultLimit),</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+      mFinished(false),</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+      mCanceled(false),</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+      mServerSearchControls(serverSearchControls),</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+      mClientSearchControls(clientSearchControls) {</span>
<a href="#l34.109"></a><span id="l34.109">   mSaslMechanism.Assign(mechanism);</span>
<a href="#l34.110"></a><span id="l34.110"> }</span>
<a href="#l34.111"></a><span id="l34.111"> </span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-nsAbQueryLDAPMessageListener::~nsAbQueryLDAPMessageListener ()</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-{</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineplus">+nsAbQueryLDAPMessageListener::~nsAbQueryLDAPMessageListener() {}</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+nsresult nsAbQueryLDAPMessageListener::Cancel() {</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+  nsresult rv = Initiate();</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+  MutexAutoLock lock(mLock);</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineplus">+  if (mFinished || mCanceled) return NS_OK;</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineplus">+</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineplus">+  mCanceled = true;</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineplus">+  return NS_OK;</span>
<a href="#l34.126"></a><span id="l34.126"> }</span>
<a href="#l34.127"></a><span id="l34.127"> </span>
<a href="#l34.128"></a><span id="l34.128" class="difflineminus">-nsresult nsAbQueryLDAPMessageListener::Cancel ()</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineminus">-{</span>
<a href="#l34.130"></a><span id="l34.130" class="difflineminus">-    nsresult rv = Initiate();</span>
<a href="#l34.131"></a><span id="l34.131" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-    MutexAutoLock lock(mLock);</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineminus">-    if (mFinished || mCanceled)</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-        return NS_OK;</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-    mCanceled = true;</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineminus">-}</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineminus">-</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-NS_IMETHODIMP nsAbQueryLDAPMessageListener::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-{</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineplus">+NS_IMETHODIMP nsAbQueryLDAPMessageListener::OnLDAPMessage(</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l34.146"></a><span id="l34.146">   nsresult rv = Initiate();</span>
<a href="#l34.147"></a><span id="l34.147">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.148"></a><span id="l34.148"> </span>
<a href="#l34.149"></a><span id="l34.149">   int32_t messageType;</span>
<a href="#l34.150"></a><span id="l34.150">   rv = aMessage-&gt;GetType(&amp;messageType);</span>
<a href="#l34.151"></a><span id="l34.151">   uint32_t requestNum;</span>
<a href="#l34.152"></a><span id="l34.152">   mOperation-&gt;GetRequestNum(&amp;requestNum);</span>
<a href="#l34.153"></a><span id="l34.153">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.154"></a><span id="l34.154"> </span>
<a href="#l34.155"></a><span id="l34.155">   bool cancelOperation = false;</span>
<a href="#l34.156"></a><span id="l34.156"> </span>
<a href="#l34.157"></a><span id="l34.157">   // Enter lock</span>
<a href="#l34.158"></a><span id="l34.158">   {</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-    MutexAutoLock lock (mLock);</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineplus">+    MutexAutoLock lock(mLock);</span>
<a href="#l34.161"></a><span id="l34.161"> </span>
<a href="#l34.162"></a><span id="l34.162">     if (requestNum != sCurrentRequestNum) {</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-      MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-           (&quot;nsAbQueryLDAPMessageListener::OnLDAPMessage: Ignoring message with &quot;</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineminus">-            &quot;request num %&quot; PRIu32 &quot;, current request num is %&quot; PRIu32 &quot;.&quot;,</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineminus">-            requestNum, sCurrentRequestNum));</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineplus">+      MOZ_LOG(</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineplus">+          gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineplus">+          (&quot;nsAbQueryLDAPMessageListener::OnLDAPMessage: Ignoring message with &quot;</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineplus">+           &quot;request num %&quot; PRIu32 &quot;, current request num is %&quot; PRIu32 &quot;.&quot;,</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineplus">+           requestNum, sCurrentRequestNum));</span>
<a href="#l34.172"></a><span id="l34.172">       return NS_OK;</span>
<a href="#l34.173"></a><span id="l34.173">     }</span>
<a href="#l34.174"></a><span id="l34.174"> </span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-    if (mFinished)</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineminus">-      return NS_OK;</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineplus">+    if (mFinished) return NS_OK;</span>
<a href="#l34.178"></a><span id="l34.178"> </span>
<a href="#l34.179"></a><span id="l34.179">     if (messageType == nsILDAPMessage::RES_SEARCH_RESULT)</span>
<a href="#l34.180"></a><span id="l34.180">       mFinished = true;</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineminus">-    else if (mCanceled)</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineminus">-    {</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineplus">+    else if (mCanceled) {</span>
<a href="#l34.184"></a><span id="l34.184">       mFinished = true;</span>
<a href="#l34.185"></a><span id="l34.185">       cancelOperation = true;</span>
<a href="#l34.186"></a><span id="l34.186">     }</span>
<a href="#l34.187"></a><span id="l34.187">   }</span>
<a href="#l34.188"></a><span id="l34.188">   // Leave lock</span>
<a href="#l34.189"></a><span id="l34.189"> </span>
<a href="#l34.190"></a><span id="l34.190" class="difflineminus">-  if (!mResultListener)</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineplus">+  if (!mResultListener) return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.193"></a><span id="l34.193"> </span>
<a href="#l34.194"></a><span id="l34.194" class="difflineminus">-  if (!cancelOperation)</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-  {</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineminus">-    switch (messageType)</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineminus">-    {</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-    case nsILDAPMessage::RES_BIND:</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-      rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineminus">-        // We know the bind failed and hence the message has an error, so we</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineminus">-        // can just call SearchResult with the message and that'll sort it out</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineminus">-        // for us.</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineplus">+  if (!cancelOperation) {</span>
<a href="#l34.205"></a><span id="l34.205" class="difflineplus">+    switch (messageType) {</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineplus">+      case nsILDAPMessage::RES_BIND:</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineplus">+        rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineplus">+          // We know the bind failed and hence the message has an error, so we</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineplus">+          // can just call SearchResult with the message and that'll sort it out</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineplus">+          // for us.</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineplus">+          rv = OnLDAPMessageSearchResult(aMessage);</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineplus">+        break;</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineplus">+      case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineplus">+        if (!mFinished) rv = OnLDAPMessageSearchEntry(aMessage);</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineplus">+        break;</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineplus">+      case nsILDAPMessage::RES_SEARCH_RESULT:</span>
<a href="#l34.218"></a><span id="l34.218">         rv = OnLDAPMessageSearchResult(aMessage);</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineminus">-      break;</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineminus">-    case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-      if (!mFinished)</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-        rv = OnLDAPMessageSearchEntry(aMessage);</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineminus">-      break;</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineminus">-    case nsILDAPMessage::RES_SEARCH_RESULT:</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineminus">-      rv = OnLDAPMessageSearchResult(aMessage);</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineminus">-      break;</span>
<a href="#l34.228"></a><span id="l34.228" class="difflineminus">-    default:</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineminus">-      break;</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineplus">+        break;</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineplus">+      default:</span>
<a href="#l34.233"></a><span id="l34.233" class="difflineplus">+        break;</span>
<a href="#l34.234"></a><span id="l34.234">     }</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineminus">-  }</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineminus">-  else</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineminus">-  {</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineminus">-    if (mOperation)</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineminus">-      rv = mOperation-&gt;AbandonExt();</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineplus">+  } else {</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineplus">+    if (mOperation) rv = mOperation-&gt;AbandonExt();</span>
<a href="#l34.242"></a><span id="l34.242"> </span>
<a href="#l34.243"></a><span id="l34.243">     rv = mResultListener-&gt;OnQueryResult(</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineminus">-      nsIAbDirectoryQueryResultListener::queryResultStopped, 0);</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineplus">+        nsIAbDirectoryQueryResultListener::queryResultStopped, 0);</span>
<a href="#l34.246"></a><span id="l34.246"> </span>
<a href="#l34.247"></a><span id="l34.247">     // reset because we might re-use this listener...except don't do this</span>
<a href="#l34.248"></a><span id="l34.248">     // until the search is done, so we'll ignore results from a previous</span>
<a href="#l34.249"></a><span id="l34.249">     // search.</span>
<a href="#l34.250"></a><span id="l34.250">     if (messageType == nsILDAPMessage::RES_SEARCH_RESULT)</span>
<a href="#l34.251"></a><span id="l34.251">       mCanceled = mFinished = false;</span>
<a href="#l34.252"></a><span id="l34.252">   }</span>
<a href="#l34.253"></a><span id="l34.253"> </span>
<a href="#l34.254"></a><span id="l34.254">   return rv;</span>
<a href="#l34.255"></a><span id="l34.255"> }</span>
<a href="#l34.256"></a><span id="l34.256"> </span>
<a href="#l34.257"></a><span id="l34.257" class="difflineminus">-nsresult nsAbQueryLDAPMessageListener::DoTask()</span>
<a href="#l34.258"></a><span id="l34.258" class="difflineminus">-{</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineplus">+nsresult nsAbQueryLDAPMessageListener::DoTask() {</span>
<a href="#l34.260"></a><span id="l34.260">   nsresult rv;</span>
<a href="#l34.261"></a><span id="l34.261">   mCanceled = mFinished = false;</span>
<a href="#l34.262"></a><span id="l34.262"> </span>
<a href="#l34.263"></a><span id="l34.263">   mOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l34.264"></a><span id="l34.264">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.265"></a><span id="l34.265"> </span>
<a href="#l34.266"></a><span id="l34.266">   rv = mOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l34.267"></a><span id="l34.267">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineat">@@ -237,34 +215,32 @@ nsresult nsAbQueryLDAPMessageListener::D</span>
<a href="#l34.269"></a><span id="l34.269"> </span>
<a href="#l34.270"></a><span id="l34.270">   rv = mOperation-&gt;SetClientControls(mClientSearchControls);</span>
<a href="#l34.271"></a><span id="l34.271">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.272"></a><span id="l34.272"> </span>
<a href="#l34.273"></a><span id="l34.273">   return mOperation-&gt;SearchExt(dn, scope, filter, attributes, mTimeOut,</span>
<a href="#l34.274"></a><span id="l34.274">                                mResultLimit);</span>
<a href="#l34.275"></a><span id="l34.275"> }</span>
<a href="#l34.276"></a><span id="l34.276"> </span>
<a href="#l34.277"></a><span id="l34.277" class="difflineminus">-void nsAbQueryLDAPMessageListener::InitFailed(bool aCancelled)</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineminus">-{</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineminus">-  if (!mResultListener)</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineminus">-    return;</span>
<a href="#l34.281"></a><span id="l34.281" class="difflineplus">+void nsAbQueryLDAPMessageListener::InitFailed(bool aCancelled) {</span>
<a href="#l34.282"></a><span id="l34.282" class="difflineplus">+  if (!mResultListener) return;</span>
<a href="#l34.283"></a><span id="l34.283"> </span>
<a href="#l34.284"></a><span id="l34.284">   // In the !aCancelled case we know there was an error, but we won't be</span>
<a href="#l34.285"></a><span id="l34.285">   // able to translate it, so just return an error code of zero.</span>
<a href="#l34.286"></a><span id="l34.286">   mResultListener-&gt;OnQueryResult(</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineminus">-      aCancelled ? nsIAbDirectoryQueryResultListener::queryResultStopped :</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineminus">-                   nsIAbDirectoryQueryResultListener::queryResultError, 0);</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineplus">+      aCancelled ? nsIAbDirectoryQueryResultListener::queryResultStopped</span>
<a href="#l34.290"></a><span id="l34.290" class="difflineplus">+                 : nsIAbDirectoryQueryResultListener::queryResultError,</span>
<a href="#l34.291"></a><span id="l34.291" class="difflineplus">+      0);</span>
<a href="#l34.292"></a><span id="l34.292"> }</span>
<a href="#l34.293"></a><span id="l34.293"> </span>
<a href="#l34.294"></a><span id="l34.294" class="difflineminus">-nsresult nsAbQueryLDAPMessageListener::OnLDAPMessageSearchEntry(nsILDAPMessage *aMessage)</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineminus">-{</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineplus">+nsresult nsAbQueryLDAPMessageListener::OnLDAPMessageSearchEntry(</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l34.298"></a><span id="l34.298">   nsresult rv;</span>
<a href="#l34.299"></a><span id="l34.299"> </span>
<a href="#l34.300"></a><span id="l34.300" class="difflineminus">-  if (!mResultListener)</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineplus">+  if (!mResultListener) return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.303"></a><span id="l34.303"> </span>
<a href="#l34.304"></a><span id="l34.304">   // the map for translating between LDAP attrs &lt;-&gt; addrbook fields</span>
<a href="#l34.305"></a><span id="l34.305">   nsCOMPtr&lt;nsISupports&gt; iSupportsMap;</span>
<a href="#l34.306"></a><span id="l34.306">   rv = mQueryArguments-&gt;GetTypeSpecificArg(getter_AddRefs(iSupportsMap));</span>
<a href="#l34.307"></a><span id="l34.307">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.308"></a><span id="l34.308"> </span>
<a href="#l34.309"></a><span id="l34.309">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; map = do_QueryInterface(iSupportsMap, &amp;rv);</span>
<a href="#l34.310"></a><span id="l34.310">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.311"></a><span id="l34.311" class="difflineat">@@ -279,51 +255,44 @@ nsresult nsAbQueryLDAPMessageListener::O</span>
<a href="#l34.312"></a><span id="l34.312">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.313"></a><span id="l34.313"> </span>
<a href="#l34.314"></a><span id="l34.314">   rv = ldapCard-&gt;SetMetaProperties(aMessage);</span>
<a href="#l34.315"></a><span id="l34.315">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.316"></a><span id="l34.316"> </span>
<a href="#l34.317"></a><span id="l34.317">   return mResultListener-&gt;OnQueryFoundCard(card);</span>
<a href="#l34.318"></a><span id="l34.318"> }</span>
<a href="#l34.319"></a><span id="l34.319"> </span>
<a href="#l34.320"></a><span id="l34.320" class="difflineminus">-nsresult nsAbQueryLDAPMessageListener::OnLDAPMessageSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineminus">-{</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineplus">+nsresult nsAbQueryLDAPMessageListener::OnLDAPMessageSearchResult(</span>
<a href="#l34.323"></a><span id="l34.323" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l34.324"></a><span id="l34.324">   int32_t errorCode;</span>
<a href="#l34.325"></a><span id="l34.325">   nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l34.326"></a><span id="l34.326">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.327"></a><span id="l34.327"> </span>
<a href="#l34.328"></a><span id="l34.328" class="difflineminus">-  if (errorCode == nsILDAPErrors::SUCCESS || errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED)</span>
<a href="#l34.329"></a><span id="l34.329" class="difflineplus">+  if (errorCode == nsILDAPErrors::SUCCESS ||</span>
<a href="#l34.330"></a><span id="l34.330" class="difflineplus">+      errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED)</span>
<a href="#l34.331"></a><span id="l34.331">     return mResultListener-&gt;OnQueryResult(</span>
<a href="#l34.332"></a><span id="l34.332" class="difflineminus">-      nsIAbDirectoryQueryResultListener::queryResultComplete, 0);</span>
<a href="#l34.333"></a><span id="l34.333" class="difflineplus">+        nsIAbDirectoryQueryResultListener::queryResultComplete, 0);</span>
<a href="#l34.334"></a><span id="l34.334"> </span>
<a href="#l34.335"></a><span id="l34.335">   return mResultListener-&gt;OnQueryResult(</span>
<a href="#l34.336"></a><span id="l34.336">       nsIAbDirectoryQueryResultListener::queryResultError, errorCode);</span>
<a href="#l34.337"></a><span id="l34.337"> }</span>
<a href="#l34.338"></a><span id="l34.338"> </span>
<a href="#l34.339"></a><span id="l34.339"> // nsAbLDAPDirectoryQuery</span>
<a href="#l34.340"></a><span id="l34.340"> </span>
<a href="#l34.341"></a><span id="l34.341"> NS_IMPL_ISUPPORTS(nsAbLDAPDirectoryQuery, nsIAbDirectoryQuery,</span>
<a href="#l34.342"></a><span id="l34.342" class="difflineminus">-                              nsIAbDirectoryQueryResultListener)</span>
<a href="#l34.343"></a><span id="l34.343" class="difflineplus">+                  nsIAbDirectoryQueryResultListener)</span>
<a href="#l34.344"></a><span id="l34.344"> </span>
<a href="#l34.345"></a><span id="l34.345" class="difflineminus">-nsAbLDAPDirectoryQuery::nsAbLDAPDirectoryQuery() :</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineminus">-    mInitialized(false)</span>
<a href="#l34.347"></a><span id="l34.347" class="difflineminus">-{</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineminus">-}</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineplus">+nsAbLDAPDirectoryQuery::nsAbLDAPDirectoryQuery() : mInitialized(false) {}</span>
<a href="#l34.350"></a><span id="l34.350"> </span>
<a href="#l34.351"></a><span id="l34.351" class="difflineminus">-nsAbLDAPDirectoryQuery::~nsAbLDAPDirectoryQuery()</span>
<a href="#l34.352"></a><span id="l34.352" class="difflineminus">-{</span>
<a href="#l34.353"></a><span id="l34.353" class="difflineminus">-}</span>
<a href="#l34.354"></a><span id="l34.354" class="difflineplus">+nsAbLDAPDirectoryQuery::~nsAbLDAPDirectoryQuery() {}</span>
<a href="#l34.355"></a><span id="l34.355"> </span>
<a href="#l34.356"></a><span id="l34.356" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectoryQuery::DoQuery(nsIAbDirectory *aDirectory,</span>
<a href="#l34.357"></a><span id="l34.357" class="difflineminus">-  nsIAbDirectoryQueryArguments* aArguments,</span>
<a href="#l34.358"></a><span id="l34.358" class="difflineminus">-  nsIAbDirSearchListener* aListener,</span>
<a href="#l34.359"></a><span id="l34.359" class="difflineminus">-  int32_t aResultLimit,</span>
<a href="#l34.360"></a><span id="l34.360" class="difflineminus">-  int32_t aTimeOut,</span>
<a href="#l34.361"></a><span id="l34.361" class="difflineminus">-  int32_t* _retval)</span>
<a href="#l34.362"></a><span id="l34.362" class="difflineminus">-{</span>
<a href="#l34.363"></a><span id="l34.363" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectoryQuery::DoQuery(</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineplus">+    nsIAbDirectory *aDirectory, nsIAbDirectoryQueryArguments *aArguments,</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineplus">+    nsIAbDirSearchListener *aListener, int32_t aResultLimit, int32_t aTimeOut,</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineplus">+    int32_t *_retval) {</span>
<a href="#l34.367"></a><span id="l34.367">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l34.368"></a><span id="l34.368">   NS_ENSURE_ARG_POINTER(aArguments);</span>
<a href="#l34.369"></a><span id="l34.369"> </span>
<a href="#l34.370"></a><span id="l34.370">   mListeners.AppendObject(aListener);</span>
<a href="#l34.371"></a><span id="l34.371"> </span>
<a href="#l34.372"></a><span id="l34.372">   // Ensure existing query is stopped. Context id doesn't matter here</span>
<a href="#l34.373"></a><span id="l34.373">   nsresult rv = StopQuery(0);</span>
<a href="#l34.374"></a><span id="l34.374">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.375"></a><span id="l34.375" class="difflineat">@@ -353,47 +322,39 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l34.376"></a><span id="l34.376"> </span>
<a href="#l34.377"></a><span id="l34.377">   // To do:</span>
<a href="#l34.378"></a><span id="l34.378">   // Ensure query is stopped</span>
<a href="#l34.379"></a><span id="l34.379">   // If connection params have changed re-create connection</span>
<a href="#l34.380"></a><span id="l34.380">   // else reuse existing connection</span>
<a href="#l34.381"></a><span id="l34.381"> </span>
<a href="#l34.382"></a><span id="l34.382">   bool redoConnection = false;</span>
<a href="#l34.383"></a><span id="l34.383"> </span>
<a href="#l34.384"></a><span id="l34.384" class="difflineminus">-  if (!mConnection || !mDirectoryUrl)</span>
<a href="#l34.385"></a><span id="l34.385" class="difflineminus">-  {</span>
<a href="#l34.386"></a><span id="l34.386" class="difflineplus">+  if (!mConnection || !mDirectoryUrl) {</span>
<a href="#l34.387"></a><span id="l34.387">     mDirectoryUrl = currentUrl;</span>
<a href="#l34.388"></a><span id="l34.388">     aDirectory-&gt;GetUuid(mDirectoryId);</span>
<a href="#l34.389"></a><span id="l34.389">     mCurrentLogin = login;</span>
<a href="#l34.390"></a><span id="l34.390">     mCurrentMechanism = saslMechanism;</span>
<a href="#l34.391"></a><span id="l34.391">     mCurrentProtocolVersion = protocolVersion;</span>
<a href="#l34.392"></a><span id="l34.392">     redoConnection = true;</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineminus">-  }</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineminus">-  else</span>
<a href="#l34.395"></a><span id="l34.395" class="difflineminus">-  {</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineplus">+  } else {</span>
<a href="#l34.397"></a><span id="l34.397">     bool equal;</span>
<a href="#l34.398"></a><span id="l34.398">     rv = mDirectoryUrl-&gt;Equals(currentUrl, &amp;equal);</span>
<a href="#l34.399"></a><span id="l34.399">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.400"></a><span id="l34.400"> </span>
<a href="#l34.401"></a><span id="l34.401" class="difflineminus">-    if (!equal)</span>
<a href="#l34.402"></a><span id="l34.402" class="difflineminus">-    {</span>
<a href="#l34.403"></a><span id="l34.403" class="difflineplus">+    if (!equal) {</span>
<a href="#l34.404"></a><span id="l34.404">       mDirectoryUrl = currentUrl;</span>
<a href="#l34.405"></a><span id="l34.405">       aDirectory-&gt;GetUuid(mDirectoryId);</span>
<a href="#l34.406"></a><span id="l34.406">       mCurrentLogin = login;</span>
<a href="#l34.407"></a><span id="l34.407">       mCurrentMechanism = saslMechanism;</span>
<a href="#l34.408"></a><span id="l34.408">       mCurrentProtocolVersion = protocolVersion;</span>
<a href="#l34.409"></a><span id="l34.409">       redoConnection = true;</span>
<a href="#l34.410"></a><span id="l34.410" class="difflineminus">-    }</span>
<a href="#l34.411"></a><span id="l34.411" class="difflineminus">-    else</span>
<a href="#l34.412"></a><span id="l34.412" class="difflineminus">-    {</span>
<a href="#l34.413"></a><span id="l34.413" class="difflineplus">+    } else {</span>
<a href="#l34.414"></a><span id="l34.414">       // Has login or version changed?</span>
<a href="#l34.415"></a><span id="l34.415" class="difflineminus">-      if (login != mCurrentLogin ||</span>
<a href="#l34.416"></a><span id="l34.416" class="difflineminus">-          saslMechanism != mCurrentMechanism ||</span>
<a href="#l34.417"></a><span id="l34.417" class="difflineminus">-          protocolVersion != mCurrentProtocolVersion)</span>
<a href="#l34.418"></a><span id="l34.418" class="difflineminus">-      {</span>
<a href="#l34.419"></a><span id="l34.419" class="difflineplus">+      if (login != mCurrentLogin || saslMechanism != mCurrentMechanism ||</span>
<a href="#l34.420"></a><span id="l34.420" class="difflineplus">+          protocolVersion != mCurrentProtocolVersion) {</span>
<a href="#l34.421"></a><span id="l34.421">         redoConnection = true;</span>
<a href="#l34.422"></a><span id="l34.422">         mCurrentLogin = login;</span>
<a href="#l34.423"></a><span id="l34.423">         mCurrentMechanism = saslMechanism;</span>
<a href="#l34.424"></a><span id="l34.424">         mCurrentProtocolVersion = protocolVersion;</span>
<a href="#l34.425"></a><span id="l34.425">       }</span>
<a href="#l34.426"></a><span id="l34.426">     }</span>
<a href="#l34.427"></a><span id="l34.427">   }</span>
<a href="#l34.428"></a><span id="l34.428"> </span>
<a href="#l34.429"></a><span id="l34.429" class="difflineat">@@ -432,17 +393,18 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l34.430"></a><span id="l34.430">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.431"></a><span id="l34.431"> </span>
<a href="#l34.432"></a><span id="l34.432">   if (filter.IsEmpty()) {</span>
<a href="#l34.433"></a><span id="l34.433">     // Get the filter</span>
<a href="#l34.434"></a><span id="l34.434">     nsCOMPtr&lt;nsISupports&gt; supportsExpression;</span>
<a href="#l34.435"></a><span id="l34.435">     rv = aArguments-&gt;GetExpression(getter_AddRefs(supportsExpression));</span>
<a href="#l34.436"></a><span id="l34.436">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.437"></a><span id="l34.437"> </span>
<a href="#l34.438"></a><span id="l34.438" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression(do_QueryInterface(supportsExpression, &amp;rv));</span>
<a href="#l34.439"></a><span id="l34.439" class="difflineplus">+    nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression(</span>
<a href="#l34.440"></a><span id="l34.440" class="difflineplus">+        do_QueryInterface(supportsExpression, &amp;rv));</span>
<a href="#l34.441"></a><span id="l34.441"> </span>
<a href="#l34.442"></a><span id="l34.442">     // figure out how we map attribute names to addressbook fields for this</span>
<a href="#l34.443"></a><span id="l34.443">     // query</span>
<a href="#l34.444"></a><span id="l34.444">     rv = nsAbBoolExprToLDAPFilter::Convert(map, expression, filter);</span>
<a href="#l34.445"></a><span id="l34.445">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.446"></a><span id="l34.446">   }</span>
<a href="#l34.447"></a><span id="l34.447"> </span>
<a href="#l34.448"></a><span id="l34.448">   /*</span>
<a href="#l34.449"></a><span id="l34.449" class="difflineat">@@ -453,78 +415,71 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l34.450"></a><span id="l34.450">    *</span>
<a href="#l34.451"></a><span id="l34.451">    * Default the filter string if blank, otherwise it gets</span>
<a href="#l34.452"></a><span id="l34.452">    * set to (objectclass=*) which returns everything. Set</span>
<a href="#l34.453"></a><span id="l34.453">    * the default to (objectclass=inetorgperson) as this</span>
<a href="#l34.454"></a><span id="l34.454">    * is the most appropriate default objectclass which is</span>
<a href="#l34.455"></a><span id="l34.455">    * central to the makeup of the mozilla ldap address book</span>
<a href="#l34.456"></a><span id="l34.456">    * entries.</span>
<a href="#l34.457"></a><span id="l34.457">    */</span>
<a href="#l34.458"></a><span id="l34.458" class="difflineminus">-  if (filter.IsEmpty())</span>
<a href="#l34.459"></a><span id="l34.459" class="difflineminus">-  {</span>
<a href="#l34.460"></a><span id="l34.460" class="difflineplus">+  if (filter.IsEmpty()) {</span>
<a href="#l34.461"></a><span id="l34.461">     filter.AssignLiteral(&quot;(objectclass=inetorgperson)&quot;);</span>
<a href="#l34.462"></a><span id="l34.462">   }</span>
<a href="#l34.463"></a><span id="l34.463"> </span>
<a href="#l34.464"></a><span id="l34.464">   // get the directoryFilter from the directory url and merge it with the user's</span>
<a href="#l34.465"></a><span id="l34.465">   // search filter</span>
<a href="#l34.466"></a><span id="l34.466">   nsAutoCString urlFilter;</span>
<a href="#l34.467"></a><span id="l34.467">   rv = mDirectoryUrl-&gt;GetFilter(urlFilter);</span>
<a href="#l34.468"></a><span id="l34.468"> </span>
<a href="#l34.469"></a><span id="l34.469">   // if urlFilter is unset (or set to the default &quot;objectclass=*&quot;), there's</span>
<a href="#l34.470"></a><span id="l34.470">   // no need to AND in an empty search term, so leave prefix and suffix empty</span>
<a href="#l34.471"></a><span id="l34.471"> </span>
<a href="#l34.472"></a><span id="l34.472">   nsAutoCString searchFilter;</span>
<a href="#l34.473"></a><span id="l34.473" class="difflineminus">-  if (urlFilter.Length() &amp;&amp; !urlFilter.EqualsLiteral(&quot;(objectclass=*)&quot;))</span>
<a href="#l34.474"></a><span id="l34.474" class="difflineminus">-  {</span>
<a href="#l34.475"></a><span id="l34.475" class="difflineplus">+  if (urlFilter.Length() &amp;&amp; !urlFilter.EqualsLiteral(&quot;(objectclass=*)&quot;)) {</span>
<a href="#l34.476"></a><span id="l34.476">     // if urlFilter isn't parenthesized, we need to add in parens so that</span>
<a href="#l34.477"></a><span id="l34.477">     // the filter works as a term to &amp;</span>
<a href="#l34.478"></a><span id="l34.478">     //</span>
<a href="#l34.479"></a><span id="l34.479" class="difflineminus">-    if (urlFilter[0] != '(')</span>
<a href="#l34.480"></a><span id="l34.480" class="difflineminus">-    {</span>
<a href="#l34.481"></a><span id="l34.481" class="difflineplus">+    if (urlFilter[0] != '(') {</span>
<a href="#l34.482"></a><span id="l34.482">       searchFilter.AssignLiteral(&quot;(&amp;(&quot;);</span>
<a href="#l34.483"></a><span id="l34.483">       searchFilter.Append(urlFilter);</span>
<a href="#l34.484"></a><span id="l34.484">       searchFilter.Append(')');</span>
<a href="#l34.485"></a><span id="l34.485" class="difflineminus">-    }</span>
<a href="#l34.486"></a><span id="l34.486" class="difflineminus">-    else</span>
<a href="#l34.487"></a><span id="l34.487" class="difflineminus">-    {</span>
<a href="#l34.488"></a><span id="l34.488" class="difflineplus">+    } else {</span>
<a href="#l34.489"></a><span id="l34.489">       searchFilter.AssignLiteral(&quot;(&amp;&quot;);</span>
<a href="#l34.490"></a><span id="l34.490">       searchFilter.Append(urlFilter);</span>
<a href="#l34.491"></a><span id="l34.491">     }</span>
<a href="#l34.492"></a><span id="l34.492"> </span>
<a href="#l34.493"></a><span id="l34.493">     searchFilter += filter;</span>
<a href="#l34.494"></a><span id="l34.494">     searchFilter += ')';</span>
<a href="#l34.495"></a><span id="l34.495" class="difflineminus">-  }</span>
<a href="#l34.496"></a><span id="l34.496" class="difflineminus">-  else</span>
<a href="#l34.497"></a><span id="l34.497" class="difflineplus">+  } else</span>
<a href="#l34.498"></a><span id="l34.498">     searchFilter = filter;</span>
<a href="#l34.499"></a><span id="l34.499"> </span>
<a href="#l34.500"></a><span id="l34.500">   rv = url-&gt;SetFilter(searchFilter);</span>
<a href="#l34.501"></a><span id="l34.501">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.502"></a><span id="l34.502"> </span>
<a href="#l34.503"></a><span id="l34.503">   // Now formulate the search string</span>
<a href="#l34.504"></a><span id="l34.504"> </span>
<a href="#l34.505"></a><span id="l34.505">   // Get the scope</span>
<a href="#l34.506"></a><span id="l34.506">   int32_t scope;</span>
<a href="#l34.507"></a><span id="l34.507">   bool doSubDirectories;</span>
<a href="#l34.508"></a><span id="l34.508" class="difflineminus">-  rv = aArguments-&gt;GetQuerySubDirectories (&amp;doSubDirectories);</span>
<a href="#l34.509"></a><span id="l34.509" class="difflineplus">+  rv = aArguments-&gt;GetQuerySubDirectories(&amp;doSubDirectories);</span>
<a href="#l34.510"></a><span id="l34.510">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.511"></a><span id="l34.511" class="difflineminus">-  scope = doSubDirectories ? nsILDAPURL::SCOPE_SUBTREE :</span>
<a href="#l34.512"></a><span id="l34.512" class="difflineminus">-                             nsILDAPURL::SCOPE_ONELEVEL;</span>
<a href="#l34.513"></a><span id="l34.513" class="difflineplus">+  scope =</span>
<a href="#l34.514"></a><span id="l34.514" class="difflineplus">+      doSubDirectories ? nsILDAPURL::SCOPE_SUBTREE : nsILDAPURL::SCOPE_ONELEVEL;</span>
<a href="#l34.515"></a><span id="l34.515"> </span>
<a href="#l34.516"></a><span id="l34.516">   rv = url-&gt;SetScope(scope);</span>
<a href="#l34.517"></a><span id="l34.517">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.518"></a><span id="l34.518"> </span>
<a href="#l34.519"></a><span id="l34.519">   // too soon? Do we need a new listener?</span>
<a href="#l34.520"></a><span id="l34.520">   // If we already have a connection, and don't need to re-do it, give it the</span>
<a href="#l34.521"></a><span id="l34.521">   // new search details and go for it...</span>
<a href="#l34.522"></a><span id="l34.522" class="difflineminus">-  if (!redoConnection)</span>
<a href="#l34.523"></a><span id="l34.523" class="difflineminus">-  {</span>
<a href="#l34.524"></a><span id="l34.524" class="difflineplus">+  if (!redoConnection) {</span>
<a href="#l34.525"></a><span id="l34.525">     nsAbQueryLDAPMessageListener *msgListener =</span>
<a href="#l34.526"></a><span id="l34.526" class="difflineminus">-      static_cast&lt;nsAbQueryLDAPMessageListener *&gt;(static_cast&lt;nsILDAPMessageListener *&gt;(mListener.get()));</span>
<a href="#l34.527"></a><span id="l34.527" class="difflineminus">-    if (msgListener)</span>
<a href="#l34.528"></a><span id="l34.528" class="difflineminus">-    {</span>
<a href="#l34.529"></a><span id="l34.529" class="difflineplus">+        static_cast&lt;nsAbQueryLDAPMessageListener *&gt;(</span>
<a href="#l34.530"></a><span id="l34.530" class="difflineplus">+            static_cast&lt;nsILDAPMessageListener *&gt;(mListener.get()));</span>
<a href="#l34.531"></a><span id="l34.531" class="difflineplus">+    if (msgListener) {</span>
<a href="#l34.532"></a><span id="l34.532">       // Ensure the urls are correct</span>
<a href="#l34.533"></a><span id="l34.533">       msgListener-&gt;mDirectoryUrl = mDirectoryUrl;</span>
<a href="#l34.534"></a><span id="l34.534">       msgListener-&gt;mSearchUrl = url;</span>
<a href="#l34.535"></a><span id="l34.535">       // Also ensure we set the correct result limit</span>
<a href="#l34.536"></a><span id="l34.536">       msgListener-&gt;mResultLimit = aResultLimit;</span>
<a href="#l34.537"></a><span id="l34.537">       return msgListener-&gt;DoTask();</span>
<a href="#l34.538"></a><span id="l34.538">     }</span>
<a href="#l34.539"></a><span id="l34.539">   }</span>
<a href="#l34.540"></a><span id="l34.540" class="difflineat">@@ -535,84 +490,78 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l34.541"></a><span id="l34.541">   nsCOMPtr&lt;nsIMutableArray&gt; serverSearchControls;</span>
<a href="#l34.542"></a><span id="l34.542">   rv = abLDAPDir-&gt;GetSearchServerControls(getter_AddRefs(serverSearchControls));</span>
<a href="#l34.543"></a><span id="l34.543">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.544"></a><span id="l34.544"> </span>
<a href="#l34.545"></a><span id="l34.545">   nsCOMPtr&lt;nsIMutableArray&gt; clientSearchControls;</span>
<a href="#l34.546"></a><span id="l34.546">   rv = abLDAPDir-&gt;GetSearchClientControls(getter_AddRefs(clientSearchControls));</span>
<a href="#l34.547"></a><span id="l34.547">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.548"></a><span id="l34.548"> </span>
<a href="#l34.549"></a><span id="l34.549" class="difflineminus">-  // Create the new connection (which cause the old one to be dropped if necessary)</span>
<a href="#l34.550"></a><span id="l34.550" class="difflineplus">+  // Create the new connection (which cause the old one to be dropped if</span>
<a href="#l34.551"></a><span id="l34.551" class="difflineplus">+  // necessary)</span>
<a href="#l34.552"></a><span id="l34.552">   mConnection = do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l34.553"></a><span id="l34.553">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.554"></a><span id="l34.554"> </span>
<a href="#l34.555"></a><span id="l34.555">   nsCOMPtr&lt;nsIAbDirectoryQueryResultListener&gt; resultListener =</span>
<a href="#l34.556"></a><span id="l34.556" class="difflineminus">-    do_QueryInterface((nsIAbDirectoryQuery*)this, &amp;rv);</span>
<a href="#l34.557"></a><span id="l34.557" class="difflineplus">+      do_QueryInterface((nsIAbDirectoryQuery *)this, &amp;rv);</span>
<a href="#l34.558"></a><span id="l34.558">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.559"></a><span id="l34.559"> </span>
<a href="#l34.560"></a><span id="l34.560">   // Initiate LDAP message listener</span>
<a href="#l34.561"></a><span id="l34.561" class="difflineminus">-  nsAbQueryLDAPMessageListener* _messageListener =</span>
<a href="#l34.562"></a><span id="l34.562" class="difflineminus">-    new nsAbQueryLDAPMessageListener(resultListener, mDirectoryUrl, url,</span>
<a href="#l34.563"></a><span id="l34.563" class="difflineminus">-                                     mConnection, aArguments,</span>
<a href="#l34.564"></a><span id="l34.564" class="difflineminus">-                                     serverSearchControls, clientSearchControls,</span>
<a href="#l34.565"></a><span id="l34.565" class="difflineminus">-                                     mCurrentLogin, mCurrentMechanism,</span>
<a href="#l34.566"></a><span id="l34.566" class="difflineminus">-                                     aResultLimit, aTimeOut);</span>
<a href="#l34.567"></a><span id="l34.567" class="difflineminus">-  if (_messageListener == NULL)</span>
<a href="#l34.568"></a><span id="l34.568" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.569"></a><span id="l34.569" class="difflineplus">+  nsAbQueryLDAPMessageListener *_messageListener =</span>
<a href="#l34.570"></a><span id="l34.570" class="difflineplus">+      new nsAbQueryLDAPMessageListener(</span>
<a href="#l34.571"></a><span id="l34.571" class="difflineplus">+          resultListener, mDirectoryUrl, url, mConnection, aArguments,</span>
<a href="#l34.572"></a><span id="l34.572" class="difflineplus">+          serverSearchControls, clientSearchControls, mCurrentLogin,</span>
<a href="#l34.573"></a><span id="l34.573" class="difflineplus">+          mCurrentMechanism, aResultLimit, aTimeOut);</span>
<a href="#l34.574"></a><span id="l34.574" class="difflineplus">+  if (_messageListener == NULL) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.575"></a><span id="l34.575"> </span>
<a href="#l34.576"></a><span id="l34.576">   mListener = _messageListener;</span>
<a href="#l34.577"></a><span id="l34.577">   *_retval = 1;</span>
<a href="#l34.578"></a><span id="l34.578"> </span>
<a href="#l34.579"></a><span id="l34.579">   // Now lets initialize the LDAP connection properly. We'll kick</span>
<a href="#l34.580"></a><span id="l34.580">   // off the bind operation in the callback function, |OnLDAPInit()|.</span>
<a href="#l34.581"></a><span id="l34.581" class="difflineminus">-  rv = mConnection-&gt;Init(mDirectoryUrl, mCurrentLogin,</span>
<a href="#l34.582"></a><span id="l34.582" class="difflineminus">-                         mListener, nullptr, mCurrentProtocolVersion);</span>
<a href="#l34.583"></a><span id="l34.583" class="difflineplus">+  rv = mConnection-&gt;Init(mDirectoryUrl, mCurrentLogin, mListener, nullptr,</span>
<a href="#l34.584"></a><span id="l34.584" class="difflineplus">+                         mCurrentProtocolVersion);</span>
<a href="#l34.585"></a><span id="l34.585">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.586"></a><span id="l34.586"> </span>
<a href="#l34.587"></a><span id="l34.587">   return rv;</span>
<a href="#l34.588"></a><span id="l34.588"> }</span>
<a href="#l34.589"></a><span id="l34.589"> </span>
<a href="#l34.590"></a><span id="l34.590"> /* void stopQuery (in long contextID); */</span>
<a href="#l34.591"></a><span id="l34.591" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectoryQuery::StopQuery(int32_t contextID)</span>
<a href="#l34.592"></a><span id="l34.592" class="difflineminus">-{</span>
<a href="#l34.593"></a><span id="l34.593" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectoryQuery::StopQuery(int32_t contextID) {</span>
<a href="#l34.594"></a><span id="l34.594">   mInitialized = true;</span>
<a href="#l34.595"></a><span id="l34.595"> </span>
<a href="#l34.596"></a><span id="l34.596" class="difflineminus">-  if (!mListener)</span>
<a href="#l34.597"></a><span id="l34.597" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.598"></a><span id="l34.598" class="difflineplus">+  if (!mListener) return NS_OK;</span>
<a href="#l34.599"></a><span id="l34.599"> </span>
<a href="#l34.600"></a><span id="l34.600">   nsAbQueryLDAPMessageListener *listener =</span>
<a href="#l34.601"></a><span id="l34.601" class="difflineminus">-    static_cast&lt;nsAbQueryLDAPMessageListener *&gt;(static_cast&lt;nsILDAPMessageListener *&gt;(mListener.get()));</span>
<a href="#l34.602"></a><span id="l34.602" class="difflineminus">-  if (listener)</span>
<a href="#l34.603"></a><span id="l34.603" class="difflineminus">-    return listener-&gt;Cancel();</span>
<a href="#l34.604"></a><span id="l34.604" class="difflineplus">+      static_cast&lt;nsAbQueryLDAPMessageListener *&gt;(</span>
<a href="#l34.605"></a><span id="l34.605" class="difflineplus">+          static_cast&lt;nsILDAPMessageListener *&gt;(mListener.get()));</span>
<a href="#l34.606"></a><span id="l34.606" class="difflineplus">+  if (listener) return listener-&gt;Cancel();</span>
<a href="#l34.607"></a><span id="l34.607"> </span>
<a href="#l34.608"></a><span id="l34.608">   return NS_OK;</span>
<a href="#l34.609"></a><span id="l34.609"> }</span>
<a href="#l34.610"></a><span id="l34.610"> </span>
<a href="#l34.611"></a><span id="l34.611" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectoryQuery::OnQueryFoundCard(nsIAbCard *aCard)</span>
<a href="#l34.612"></a><span id="l34.612" class="difflineminus">-{</span>
<a href="#l34.613"></a><span id="l34.613" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectoryQuery::OnQueryFoundCard(nsIAbCard *aCard) {</span>
<a href="#l34.614"></a><span id="l34.614">   aCard-&gt;SetDirectoryId(mDirectoryId);</span>
<a href="#l34.615"></a><span id="l34.615"> </span>
<a href="#l34.616"></a><span id="l34.616">   for (int32_t i = 0; i &lt; mListeners.Count(); ++i)</span>
<a href="#l34.617"></a><span id="l34.617">     mListeners[i]-&gt;OnSearchFoundCard(aCard);</span>
<a href="#l34.618"></a><span id="l34.618"> </span>
<a href="#l34.619"></a><span id="l34.619">   return NS_OK;</span>
<a href="#l34.620"></a><span id="l34.620"> }</span>
<a href="#l34.621"></a><span id="l34.621"> </span>
<a href="#l34.622"></a><span id="l34.622"> NS_IMETHODIMP nsAbLDAPDirectoryQuery::OnQueryResult(int32_t aResult,</span>
<a href="#l34.623"></a><span id="l34.623" class="difflineminus">-                                                    int32_t aErrorCode)</span>
<a href="#l34.624"></a><span id="l34.624" class="difflineminus">-{</span>
<a href="#l34.625"></a><span id="l34.625" class="difflineplus">+                                                    int32_t aErrorCode) {</span>
<a href="#l34.626"></a><span id="l34.626">   uint32_t count = mListeners.Count();</span>
<a href="#l34.627"></a><span id="l34.627"> </span>
<a href="#l34.628"></a><span id="l34.628">   // XXX: Temporary fix for crasher needs reviewing as part of bug 135231.</span>
<a href="#l34.629"></a><span id="l34.629">   // Temporarily add a reference to ourselves, in case the only thing</span>
<a href="#l34.630"></a><span id="l34.630">   // keeping us alive is the link with the listener.</span>
<a href="#l34.631"></a><span id="l34.631">   NS_ADDREF_THIS();</span>
<a href="#l34.632"></a><span id="l34.632"> </span>
<a href="#l34.633"></a><span id="l34.633" class="difflineminus">-  for (int32_t i = count - 1; i &gt;= 0; --i)</span>
<a href="#l34.634"></a><span id="l34.634" class="difflineminus">-  {</span>
<a href="#l34.635"></a><span id="l34.635" class="difflineplus">+  for (int32_t i = count - 1; i &gt;= 0; --i) {</span>
<a href="#l34.636"></a><span id="l34.636">     mListeners[i]-&gt;OnSearchFinished(aResult, EmptyString());</span>
<a href="#l34.637"></a><span id="l34.637">     mListeners.RemoveObjectAt(i);</span>
<a href="#l34.638"></a><span id="l34.638">   }</span>
<a href="#l34.639"></a><span id="l34.639"> </span>
<a href="#l34.640"></a><span id="l34.640">   NS_RELEASE_THIS();</span>
<a href="#l34.641"></a><span id="l34.641"> </span>
<a href="#l34.642"></a><span id="l34.642">   return NS_OK;</span>
<a href="#l34.643"></a><span id="l34.643"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -11,34 +11,33 @@</span>
<a href="#l35.4"></a><span id="l35.4"> #include &quot;nsILDAPMessageListener.h&quot;</span>
<a href="#l35.5"></a><span id="l35.5"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l35.6"></a><span id="l35.6"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> #include &quot;nsString.h&quot;</span>
<a href="#l35.9"></a><span id="l35.9"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l35.10"></a><span id="l35.10"> </span>
<a href="#l35.11"></a><span id="l35.11"> class nsAbLDAPDirectoryQuery : public nsIAbDirectoryQuery,</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-                             public nsIAbDirectoryQueryResultListener</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-{</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-public:</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+                               public nsIAbDirectoryQueryResultListener {</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ public:</span>
<a href="#l35.17"></a><span id="l35.17">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l35.18"></a><span id="l35.18">   NS_DECL_NSIABDIRECTORYQUERY</span>
<a href="#l35.19"></a><span id="l35.19">   NS_DECL_NSIABDIRECTORYQUERYRESULTLISTENER</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21">   nsAbLDAPDirectoryQuery();</span>
<a href="#l35.22"></a><span id="l35.22"> </span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-protected:</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ protected:</span>
<a href="#l35.25"></a><span id="l35.25">   nsCOMPtr&lt;nsILDAPMessageListener&gt; mListener;</span>
<a href="#l35.26"></a><span id="l35.26"> </span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-private:</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ private:</span>
<a href="#l35.29"></a><span id="l35.29">   virtual ~nsAbLDAPDirectoryQuery();</span>
<a href="#l35.30"></a><span id="l35.30">   nsCOMPtr&lt;nsILDAPConnection&gt; mConnection;</span>
<a href="#l35.31"></a><span id="l35.31">   nsCOMPtr&lt;nsILDAPURL&gt; mDirectoryUrl;</span>
<a href="#l35.32"></a><span id="l35.32">   nsCString mDirectoryId;</span>
<a href="#l35.33"></a><span id="l35.33">   nsCOMArray&lt;nsIAbDirSearchListener&gt; mListeners;</span>
<a href="#l35.34"></a><span id="l35.34">   nsCString mCurrentLogin;</span>
<a href="#l35.35"></a><span id="l35.35">   nsCString mCurrentMechanism;</span>
<a href="#l35.36"></a><span id="l35.36">   uint32_t mCurrentProtocolVersion;</span>
<a href="#l35.37"></a><span id="l35.37"> </span>
<a href="#l35.38"></a><span id="l35.38">   bool mInitialized;</span>
<a href="#l35.39"></a><span id="l35.39"> };</span>
<a href="#l35.40"></a><span id="l35.40"> </span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-#endif // nsAbLDAPDirectoryQuery_h__</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+#endif  // nsAbLDAPDirectoryQuery_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -18,330 +18,314 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l36.5"></a><span id="l36.5"> #include &quot;nsMemory.h&quot;</span>
<a href="#l36.6"></a><span id="l36.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> using namespace mozilla;</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10"> uint32_t nsAbLDAPListenerBase::sCurrentRequestNum = 0;</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-nsAbLDAPListenerBase::nsAbLDAPListenerBase(nsILDAPURL* url,</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-                                           nsILDAPConnection* connection,</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+nsAbLDAPListenerBase::nsAbLDAPListenerBase(nsILDAPURL *url,</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+                                           nsILDAPConnection *connection,</span>
<a href="#l36.16"></a><span id="l36.16">                                            const nsACString &amp;login,</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineminus">-                                           const int32_t timeOut) :</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineminus">-  mDirectoryUrl(url), mConnection(connection), mLogin(login),</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-  mTimeOut(timeOut), mBound(false), mInitialized(false),</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-  mLock(&quot;nsAbLDAPListenerBase.mLock&quot;)</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineminus">-{</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineminus">-}</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+                                           const int32_t timeOut)</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+    : mDirectoryUrl(url),</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+      mConnection(connection),</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+      mLogin(login),</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+      mTimeOut(timeOut),</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+      mBound(false),</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+      mInitialized(false),</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+      mLock(&quot;nsAbLDAPListenerBase.mLock&quot;) {}</span>
<a href="#l36.31"></a><span id="l36.31"> </span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-nsAbLDAPListenerBase::~nsAbLDAPListenerBase()</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-{</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-}</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+nsAbLDAPListenerBase::~nsAbLDAPListenerBase() {}</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">-nsresult nsAbLDAPListenerBase::Initiate()</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-{</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-  if (!mConnection || !mDirectoryUrl)</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+nsresult nsAbLDAPListenerBase::Initiate() {</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+  if (!mConnection || !mDirectoryUrl) return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.43"></a><span id="l36.43"> </span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-  if (mInitialized)</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+  if (mInitialized) return NS_OK;</span>
<a href="#l36.47"></a><span id="l36.47"> </span>
<a href="#l36.48"></a><span id="l36.48">   mInitialized = true;</span>
<a href="#l36.49"></a><span id="l36.49"> </span>
<a href="#l36.50"></a><span id="l36.50">   return NS_OK;</span>
<a href="#l36.51"></a><span id="l36.51"> }</span>
<a href="#l36.52"></a><span id="l36.52"> </span>
<a href="#l36.53"></a><span id="l36.53"> // If something fails in this function, we must call InitFailed() so that the</span>
<a href="#l36.54"></a><span id="l36.54"> // derived class (and listener) knows to cancel what its doing as there is</span>
<a href="#l36.55"></a><span id="l36.55"> // a problem.</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-NS_IMETHODIMP nsAbLDAPListenerBase::OnLDAPInit(nsILDAPConnection *aConn, nsresult aStatus)</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-{</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-  if (!mConnection || !mDirectoryUrl)</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-  {</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+NS_IMETHODIMP nsAbLDAPListenerBase::OnLDAPInit(nsILDAPConnection *aConn,</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+                                               nsresult aStatus) {</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+  if (!mConnection || !mDirectoryUrl) {</span>
<a href="#l36.63"></a><span id="l36.63">     InitFailed();</span>
<a href="#l36.64"></a><span id="l36.64">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.65"></a><span id="l36.65">   }</span>
<a href="#l36.66"></a><span id="l36.66"> </span>
<a href="#l36.67"></a><span id="l36.67">   nsresult rv;</span>
<a href="#l36.68"></a><span id="l36.68">   nsString passwd;</span>
<a href="#l36.69"></a><span id="l36.69"> </span>
<a href="#l36.70"></a><span id="l36.70">   // Make sure that the Init() worked properly</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-  if (NS_FAILED(aStatus))</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-  {</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+  if (NS_FAILED(aStatus)) {</span>
<a href="#l36.74"></a><span id="l36.74">     InitFailed();</span>
<a href="#l36.75"></a><span id="l36.75">     return NS_OK;</span>
<a href="#l36.76"></a><span id="l36.76">   }</span>
<a href="#l36.77"></a><span id="l36.77"> </span>
<a href="#l36.78"></a><span id="l36.78">   // If mLogin is set, we're expected to use it to get a password.</span>
<a href="#l36.79"></a><span id="l36.79">   //</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-  if (!mLogin.IsEmpty() &amp;&amp; !mSaslMechanism.EqualsLiteral(&quot;GSSAPI&quot;))</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-  {</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+  if (!mLogin.IsEmpty() &amp;&amp; !mSaslMechanism.EqualsLiteral(&quot;GSSAPI&quot;)) {</span>
<a href="#l36.83"></a><span id="l36.83">     // get the string bundle service</span>
<a href="#l36.84"></a><span id="l36.84">     //</span>
<a href="#l36.85"></a><span id="l36.85">     nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleSvc =</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-    if (!stringBundleSvc)</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-    {</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineminus">-               &quot; error getting string bundle service&quot;);</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+    if (!stringBundleSvc) {</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+          &quot; error getting string bundle service&quot;);</span>
<a href="#l36.96"></a><span id="l36.96">       InitFailed();</span>
<a href="#l36.97"></a><span id="l36.97">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l36.98"></a><span id="l36.98">     }</span>
<a href="#l36.99"></a><span id="l36.99"> </span>
<a href="#l36.100"></a><span id="l36.100">     // get the LDAP string bundle</span>
<a href="#l36.101"></a><span id="l36.101">     //</span>
<a href="#l36.102"></a><span id="l36.102">     nsCOMPtr&lt;nsIStringBundle&gt; ldapBundle;</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-    rv = stringBundleSvc-&gt;CreateBundle(&quot;chrome://mozldap/locale/ldap.properties&quot;,</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-                                       getter_AddRefs(ldapBundle));</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineminus">-    {</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit(): error creating string&quot;</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineminus">-               &quot;bundle chrome://mozldap/locale/ldap.properties&quot;);</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+    rv = stringBundleSvc-&gt;CreateBundle(</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+        &quot;chrome://mozldap/locale/ldap.properties&quot;, getter_AddRefs(ldapBundle));</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit(): error creating string&quot;</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+          &quot;bundle chrome://mozldap/locale/ldap.properties&quot;);</span>
<a href="#l36.115"></a><span id="l36.115">       InitFailed();</span>
<a href="#l36.116"></a><span id="l36.116">       return rv;</span>
<a href="#l36.117"></a><span id="l36.117">     }</span>
<a href="#l36.118"></a><span id="l36.118"> </span>
<a href="#l36.119"></a><span id="l36.119">     // get the title for the authentication prompt</span>
<a href="#l36.120"></a><span id="l36.120">     //</span>
<a href="#l36.121"></a><span id="l36.121">     nsString authPromptTitle;</span>
<a href="#l36.122"></a><span id="l36.122">     rv = ldapBundle-&gt;GetStringFromName(&quot;authPromptTitle&quot;, authPromptTitle);</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineminus">-    {</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit(): error getting&quot;</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineminus">-               &quot;'authPromptTitle' string from bundle &quot;</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineminus">-               &quot;chrome://mozldap/locale/ldap.properties&quot;);</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit(): error getting&quot;</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+          &quot;'authPromptTitle' string from bundle &quot;</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+          &quot;chrome://mozldap/locale/ldap.properties&quot;);</span>
<a href="#l36.133"></a><span id="l36.133">       InitFailed();</span>
<a href="#l36.134"></a><span id="l36.134">       return rv;</span>
<a href="#l36.135"></a><span id="l36.135">     }</span>
<a href="#l36.136"></a><span id="l36.136"> </span>
<a href="#l36.137"></a><span id="l36.137">     // get the host name for the auth prompt</span>
<a href="#l36.138"></a><span id="l36.138">     //</span>
<a href="#l36.139"></a><span id="l36.139">     nsAutoCString host;</span>
<a href="#l36.140"></a><span id="l36.140">     rv = mDirectoryUrl-&gt;GetAsciiHost(host);</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-    {</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit(): error getting ascii host&quot;</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-               &quot;name from directory url&quot;);</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit(): error getting ascii host&quot;</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+          &quot;name from directory url&quot;);</span>
<a href="#l36.149"></a><span id="l36.149">       InitFailed();</span>
<a href="#l36.150"></a><span id="l36.150">       return rv;</span>
<a href="#l36.151"></a><span id="l36.151">     }</span>
<a href="#l36.152"></a><span id="l36.152"> </span>
<a href="#l36.153"></a><span id="l36.153">     // hostTemp is only necessary to work around a code-generation</span>
<a href="#l36.154"></a><span id="l36.154">     // bug in egcs 1.1.2 (the version of gcc that comes with Red Hat 6.2),</span>
<a href="#l36.155"></a><span id="l36.155">     // which is the default compiler for Mozilla on linux at the moment.</span>
<a href="#l36.156"></a><span id="l36.156">     //</span>
<a href="#l36.157"></a><span id="l36.157">     NS_ConvertASCIItoUTF16 hostTemp(host);</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineminus">-    const char16_t *hostArray[1] = { hostTemp.get() };</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+    const char16_t *hostArray[1] = {hostTemp.get()};</span>
<a href="#l36.160"></a><span id="l36.160"> </span>
<a href="#l36.161"></a><span id="l36.161">     // format the hostname into the authprompt text string</span>
<a href="#l36.162"></a><span id="l36.162">     //</span>
<a href="#l36.163"></a><span id="l36.163">     nsString authPromptText;</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineminus">-    rv = ldapBundle-&gt;FormatStringFromName(&quot;authPromptText&quot;,</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineminus">-                                          hostArray,</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineminus">-                                          sizeof(hostArray) / sizeof(const char16_t *),</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineminus">-                                          authPromptText);</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineminus">-    {</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineminus">-               &quot;error getting 'authPromptText' string from bundle &quot;</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineminus">-               &quot;chrome://mozldap/locale/ldap.properties&quot;);</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineplus">+    rv = ldapBundle-&gt;FormatStringFromName(</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineplus">+        &quot;authPromptText&quot;, hostArray,</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+        sizeof(hostArray) / sizeof(const char16_t *), authPromptText);</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+          &quot;error getting 'authPromptText' string from bundle &quot;</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+          &quot;chrome://mozldap/locale/ldap.properties&quot;);</span>
<a href="#l36.181"></a><span id="l36.181">       InitFailed();</span>
<a href="#l36.182"></a><span id="l36.182">       return rv;</span>
<a href="#l36.183"></a><span id="l36.183">     }</span>
<a href="#l36.184"></a><span id="l36.184"> </span>
<a href="#l36.185"></a><span id="l36.185">     // get the window mediator service, so we can get an auth prompter</span>
<a href="#l36.186"></a><span id="l36.186">     //</span>
<a href="#l36.187"></a><span id="l36.187">     nsCOMPtr&lt;nsIWindowMediator&gt; windowMediator =</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineminus">-      do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv);</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineminus">-    {</span>
<a href="#l36.191"></a><span id="l36.191" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineminus">-               &quot; couldn't get window mediator service.&quot;);</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineplus">+        do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv);</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+          &quot; couldn't get window mediator service.&quot;);</span>
<a href="#l36.198"></a><span id="l36.198">       InitFailed();</span>
<a href="#l36.199"></a><span id="l36.199">       return rv;</span>
<a href="#l36.200"></a><span id="l36.200">     }</span>
<a href="#l36.201"></a><span id="l36.201"> </span>
<a href="#l36.202"></a><span id="l36.202">     // get the addressbook window, as it will be used to parent the auth</span>
<a href="#l36.203"></a><span id="l36.203">     // prompter dialog</span>
<a href="#l36.204"></a><span id="l36.204">     //</span>
<a href="#l36.205"></a><span id="l36.205">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; window;</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineminus">-    rv = windowMediator-&gt;GetMostRecentWindow(nullptr,</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineminus">-                                             getter_AddRefs(window));</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineminus">-    {</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineminus">-               &quot; error getting most recent window&quot;);</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineplus">+    rv = windowMediator-&gt;GetMostRecentWindow(nullptr, getter_AddRefs(window));</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineplus">+          &quot; error getting most recent window&quot;);</span>
<a href="#l36.217"></a><span id="l36.217">       InitFailed();</span>
<a href="#l36.218"></a><span id="l36.218">       return rv;</span>
<a href="#l36.219"></a><span id="l36.219">     }</span>
<a href="#l36.220"></a><span id="l36.220"> </span>
<a href="#l36.221"></a><span id="l36.221">     // get the window watcher service, so we can get an auth prompter</span>
<a href="#l36.222"></a><span id="l36.222">     //</span>
<a href="#l36.223"></a><span id="l36.223">     nsCOMPtr&lt;nsIWindowWatcher&gt; windowWatcherSvc =</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineminus">-      do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineminus">-    {</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineminus">-               &quot; couldn't get window watcher service.&quot;);</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineplus">+          &quot;nsAbLDAPListenerBase::OnLDAPInit():&quot;</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineplus">+          &quot; couldn't get window watcher service.&quot;);</span>
<a href="#l36.234"></a><span id="l36.234">       InitFailed();</span>
<a href="#l36.235"></a><span id="l36.235">       return rv;</span>
<a href="#l36.236"></a><span id="l36.236">     }</span>
<a href="#l36.237"></a><span id="l36.237"> </span>
<a href="#l36.238"></a><span id="l36.238">     // get the auth prompter itself</span>
<a href="#l36.239"></a><span id="l36.239">     //</span>
<a href="#l36.240"></a><span id="l36.240">     nsCOMPtr&lt;nsIAuthPrompt&gt; authPrompter;</span>
<a href="#l36.241"></a><span id="l36.241">     rv = windowWatcherSvc-&gt;GetNewAuthPrompter(window,</span>
<a href="#l36.242"></a><span id="l36.242">                                               getter_AddRefs(authPrompter));</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineminus">-    {</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit():&quot;</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineminus">-               &quot; error getting auth prompter&quot;);</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineplus">+          &quot;nsAbLDAPMessageBase::OnLDAPInit():&quot;</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+          &quot; error getting auth prompter&quot;);</span>
<a href="#l36.251"></a><span id="l36.251">       InitFailed();</span>
<a href="#l36.252"></a><span id="l36.252">       return rv;</span>
<a href="#l36.253"></a><span id="l36.253">     }</span>
<a href="#l36.254"></a><span id="l36.254"> </span>
<a href="#l36.255"></a><span id="l36.255">     // get authentication password, prompting the user if necessary</span>
<a href="#l36.256"></a><span id="l36.256">     //</span>
<a href="#l36.257"></a><span id="l36.257">     // we're going to use the URL spec of the server as the &quot;realm&quot; for</span>
<a href="#l36.258"></a><span id="l36.258">     // wallet to remember the password by / for.</span>
<a href="#l36.259"></a><span id="l36.259"> </span>
<a href="#l36.260"></a><span id="l36.260">     // Get the specification</span>
<a href="#l36.261"></a><span id="l36.261">     nsCString spec;</span>
<a href="#l36.262"></a><span id="l36.262">     rv = mDirectoryUrl-&gt;GetSpec(spec);</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineminus">-    {</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit():&quot;</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineminus">-               &quot; error getting directory url spec&quot;);</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineplus">+          &quot;nsAbLDAPMessageBase::OnLDAPInit():&quot;</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineplus">+          &quot; error getting directory url spec&quot;);</span>
<a href="#l36.271"></a><span id="l36.271">       InitFailed();</span>
<a href="#l36.272"></a><span id="l36.272">       return rv;</span>
<a href="#l36.273"></a><span id="l36.273">     }</span>
<a href="#l36.274"></a><span id="l36.274"> </span>
<a href="#l36.275"></a><span id="l36.275">     bool status;</span>
<a href="#l36.276"></a><span id="l36.276">     rv = authPrompter-&gt;PromptPassword(authPromptTitle.get(),</span>
<a href="#l36.277"></a><span id="l36.277">                                       authPromptText.get(),</span>
<a href="#l36.278"></a><span id="l36.278">                                       NS_ConvertUTF8toUTF16(spec).get(),</span>
<a href="#l36.279"></a><span id="l36.279">                                       nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineminus">-                                      getter_Copies(passwd),</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineminus">-                                      &amp;status);</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineminus">-    {</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to prompt for&quot;</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineminus">-               &quot; password&quot;);</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineplus">+                                      getter_Copies(passwd), &amp;status);</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.289"></a><span id="l36.289" class="difflineplus">+          &quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to prompt for&quot;</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineplus">+          &quot; password&quot;);</span>
<a href="#l36.291"></a><span id="l36.291">       InitFailed();</span>
<a href="#l36.292"></a><span id="l36.292">       return rv;</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineminus">-    }</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineminus">-    else if (!status)</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineminus">-    {</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineplus">+    } else if (!status) {</span>
<a href="#l36.297"></a><span id="l36.297">       InitFailed(true);</span>
<a href="#l36.298"></a><span id="l36.298">       return NS_OK;</span>
<a href="#l36.299"></a><span id="l36.299">     }</span>
<a href="#l36.300"></a><span id="l36.300">   }</span>
<a href="#l36.301"></a><span id="l36.301"> </span>
<a href="#l36.302"></a><span id="l36.302">   // Initiate the LDAP operation</span>
<a href="#l36.303"></a><span id="l36.303">   mOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineminus">-  {</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineminus">-    NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to create ldap operation&quot;);</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineplus">+    NS_ERROR(</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineplus">+        &quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to create ldap operation&quot;);</span>
<a href="#l36.310"></a><span id="l36.310">     InitFailed();</span>
<a href="#l36.311"></a><span id="l36.311">     return rv;</span>
<a href="#l36.312"></a><span id="l36.312">   }</span>
<a href="#l36.313"></a><span id="l36.313"> </span>
<a href="#l36.314"></a><span id="l36.314">   rv = mOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l36.316"></a><span id="l36.316" class="difflineminus">-  {</span>
<a href="#l36.317"></a><span id="l36.317" class="difflineminus">-    NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to Initialise operation&quot;);</span>
<a href="#l36.318"></a><span id="l36.318" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l36.319"></a><span id="l36.319" class="difflineplus">+    NS_ERROR(</span>
<a href="#l36.320"></a><span id="l36.320" class="difflineplus">+        &quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to Initialise operation&quot;);</span>
<a href="#l36.321"></a><span id="l36.321">     InitFailed();</span>
<a href="#l36.322"></a><span id="l36.322">     return rv;</span>
<a href="#l36.323"></a><span id="l36.323">   }</span>
<a href="#l36.324"></a><span id="l36.324">   mOperation-&gt;SetRequestNum(++sCurrentRequestNum);</span>
<a href="#l36.325"></a><span id="l36.325"> </span>
<a href="#l36.326"></a><span id="l36.326">   // Try non-password mechanisms first</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineminus">-  if (mSaslMechanism.EqualsLiteral(&quot;GSSAPI&quot;))</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineminus">-  {</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineplus">+  if (mSaslMechanism.EqualsLiteral(&quot;GSSAPI&quot;)) {</span>
<a href="#l36.330"></a><span id="l36.330">     nsAutoCString service;</span>
<a href="#l36.331"></a><span id="l36.331">     rv = mDirectoryUrl-&gt;GetAsciiHost(service);</span>
<a href="#l36.332"></a><span id="l36.332">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.333"></a><span id="l36.333"> </span>
<a href="#l36.334"></a><span id="l36.334">     service.InsertLiteral(&quot;ldap@&quot;, 0);</span>
<a href="#l36.335"></a><span id="l36.335"> </span>
<a href="#l36.336"></a><span id="l36.336">     nsCOMPtr&lt;nsIAuthModule&gt; authModule =</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineminus">-      nsIAuthModule::CreateInstance(&quot;sasl-gssapi&quot;);</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineplus">+        nsIAuthModule::CreateInstance(&quot;sasl-gssapi&quot;);</span>
<a href="#l36.339"></a><span id="l36.339"> </span>
<a href="#l36.340"></a><span id="l36.340">     rv = mOperation-&gt;SaslBind(service, mSaslMechanism, authModule);</span>
<a href="#l36.341"></a><span id="l36.341" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineminus">-    {</span>
<a href="#l36.343"></a><span id="l36.343" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): &quot;</span>
<a href="#l36.344"></a><span id="l36.344" class="difflineminus">-               &quot;failed to perform GSSAPI bind&quot;);</span>
<a href="#l36.345"></a><span id="l36.345" class="difflineminus">-      mOperation = nullptr; // Break Listener -&gt; Operation -&gt; Listener ref cycle</span>
<a href="#l36.346"></a><span id="l36.346" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineplus">+      NS_ERROR(</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineplus">+          &quot;nsAbLDAPMessageBase::OnLDAPInit(): &quot;</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineplus">+          &quot;failed to perform GSSAPI bind&quot;);</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineplus">+      mOperation =</span>
<a href="#l36.351"></a><span id="l36.351" class="difflineplus">+          nullptr;  // Break Listener -&gt; Operation -&gt; Listener ref cycle</span>
<a href="#l36.352"></a><span id="l36.352">       InitFailed();</span>
<a href="#l36.353"></a><span id="l36.353">     }</span>
<a href="#l36.354"></a><span id="l36.354">     return rv;</span>
<a href="#l36.355"></a><span id="l36.355">   }</span>
<a href="#l36.356"></a><span id="l36.356"> </span>
<a href="#l36.357"></a><span id="l36.357">   // Bind</span>
<a href="#l36.358"></a><span id="l36.358">   rv = mOperation-&gt;SimpleBind(NS_ConvertUTF16toUTF8(passwd));</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineminus">-  {</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineminus">-    NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to perform bind operation&quot;);</span>
<a href="#l36.362"></a><span id="l36.362" class="difflineminus">-    mOperation = nullptr; // Break Listener-&gt;Operation-&gt;Listener reference cycle</span>
<a href="#l36.363"></a><span id="l36.363" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l36.364"></a><span id="l36.364" class="difflineplus">+    NS_ERROR(</span>
<a href="#l36.365"></a><span id="l36.365" class="difflineplus">+        &quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to perform bind operation&quot;);</span>
<a href="#l36.366"></a><span id="l36.366" class="difflineplus">+    mOperation =</span>
<a href="#l36.367"></a><span id="l36.367" class="difflineplus">+        nullptr;  // Break Listener-&gt;Operation-&gt;Listener reference cycle</span>
<a href="#l36.368"></a><span id="l36.368">     InitFailed();</span>
<a href="#l36.369"></a><span id="l36.369">   }</span>
<a href="#l36.370"></a><span id="l36.370">   return rv;</span>
<a href="#l36.371"></a><span id="l36.371"> }</span>
<a href="#l36.372"></a><span id="l36.372"> </span>
<a href="#l36.373"></a><span id="l36.373" class="difflineminus">-nsresult nsAbLDAPListenerBase::OnLDAPMessageBind(nsILDAPMessage *aMessage)</span>
<a href="#l36.374"></a><span id="l36.374" class="difflineminus">-{</span>
<a href="#l36.375"></a><span id="l36.375" class="difflineminus">-  if (mBound)</span>
<a href="#l36.376"></a><span id="l36.376" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineplus">+nsresult nsAbLDAPListenerBase::OnLDAPMessageBind(nsILDAPMessage *aMessage) {</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineplus">+  if (mBound) return NS_OK;</span>
<a href="#l36.379"></a><span id="l36.379"> </span>
<a href="#l36.380"></a><span id="l36.380">   // see whether the bind actually succeeded</span>
<a href="#l36.381"></a><span id="l36.381">   //</span>
<a href="#l36.382"></a><span id="l36.382">   int32_t errCode;</span>
<a href="#l36.383"></a><span id="l36.383">   nsresult rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l36.384"></a><span id="l36.384">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.385"></a><span id="l36.385"> </span>
<a href="#l36.386"></a><span id="l36.386" class="difflineminus">-  if (errCode != nsILDAPErrors::SUCCESS)</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineminus">-  {</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineplus">+  if (errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l36.389"></a><span id="l36.389">     // if the login failed, tell the wallet to forget this password</span>
<a href="#l36.390"></a><span id="l36.390">     //</span>
<a href="#l36.391"></a><span id="l36.391">     if (errCode == nsILDAPErrors::INAPPROPRIATE_AUTH ||</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineminus">-        errCode == nsILDAPErrors::INVALID_CREDENTIALS)</span>
<a href="#l36.393"></a><span id="l36.393" class="difflineminus">-    {</span>
<a href="#l36.394"></a><span id="l36.394" class="difflineplus">+        errCode == nsILDAPErrors::INVALID_CREDENTIALS) {</span>
<a href="#l36.395"></a><span id="l36.395">       // Login failed, so try again - but first remove the existing login(s)</span>
<a href="#l36.396"></a><span id="l36.396">       // so that the user gets prompted. This may not be the best way of doing</span>
<a href="#l36.397"></a><span id="l36.397">       // things, we need to review that later.</span>
<a href="#l36.398"></a><span id="l36.398"> </span>
<a href="#l36.399"></a><span id="l36.399">       nsCOMPtr&lt;nsILoginManager&gt; loginMgr =</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineminus">-        do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineplus">+          do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l36.402"></a><span id="l36.402">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.403"></a><span id="l36.403"> </span>
<a href="#l36.404"></a><span id="l36.404">       nsCString spec;</span>
<a href="#l36.405"></a><span id="l36.405">       rv = mDirectoryUrl-&gt;GetSpec(spec);</span>
<a href="#l36.406"></a><span id="l36.406">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.407"></a><span id="l36.407"> </span>
<a href="#l36.408"></a><span id="l36.408">       nsCString prePath;</span>
<a href="#l36.409"></a><span id="l36.409">       rv = mDirectoryUrl-&gt;GetPrePath(prePath);</span>
<a href="#l36.410"></a><span id="l36.410">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.411"></a><span id="l36.411"> </span>
<a href="#l36.412"></a><span id="l36.412">       uint32_t count;</span>
<a href="#l36.413"></a><span id="l36.413" class="difflineminus">-      nsILoginInfo** logins;</span>
<a href="#l36.414"></a><span id="l36.414" class="difflineplus">+      nsILoginInfo **logins;</span>
<a href="#l36.415"></a><span id="l36.415"> </span>
<a href="#l36.416"></a><span id="l36.416">       rv = loginMgr-&gt;FindLogins(&amp;count, NS_ConvertUTF8toUTF16(prePath),</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineminus">-                                EmptyString(),</span>
<a href="#l36.418"></a><span id="l36.418" class="difflineminus">-                                NS_ConvertUTF8toUTF16(spec), &amp;logins);</span>
<a href="#l36.419"></a><span id="l36.419" class="difflineplus">+                                EmptyString(), NS_ConvertUTF8toUTF16(spec),</span>
<a href="#l36.420"></a><span id="l36.420" class="difflineplus">+                                &amp;logins);</span>
<a href="#l36.421"></a><span id="l36.421">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.422"></a><span id="l36.422"> </span>
<a href="#l36.423"></a><span id="l36.423">       // Typically there should only be one-login stored for this url, however,</span>
<a href="#l36.424"></a><span id="l36.424">       // just in case there isn't.</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineminus">-      for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l36.426"></a><span id="l36.426" class="difflineminus">-      {</span>
<a href="#l36.427"></a><span id="l36.427" class="difflineplus">+      for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l36.428"></a><span id="l36.428">         rv = loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l36.429"></a><span id="l36.429" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l36.430"></a><span id="l36.430" class="difflineminus">-        {</span>
<a href="#l36.431"></a><span id="l36.431" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l36.432"></a><span id="l36.432">           NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l36.433"></a><span id="l36.433">           return rv;</span>
<a href="#l36.434"></a><span id="l36.434">         }</span>
<a href="#l36.435"></a><span id="l36.435">       }</span>
<a href="#l36.436"></a><span id="l36.436">       NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l36.437"></a><span id="l36.437"> </span>
<a href="#l36.438"></a><span id="l36.438">       // XXX We should probably pop up an error dialog telling</span>
<a href="#l36.439"></a><span id="l36.439">       // the user that the login failed here, rather than just bringing</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPListenerBase.h</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPListenerBase.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -10,42 +10,41 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsILDAPMessageListener.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l37.8"></a><span id="l37.8"> #include &quot;nsILDAPOperation.h&quot;</span>
<a href="#l37.9"></a><span id="l37.9"> #include &quot;nsString.h&quot;</span>
<a href="#l37.10"></a><span id="l37.10"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-class nsAbLDAPListenerBase : public nsILDAPMessageListener</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-{</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-public:</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+class nsAbLDAPListenerBase : public nsILDAPMessageListener {</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+ public:</span>
<a href="#l37.17"></a><span id="l37.17">   // Note that the directoryUrl is the details of the ldap directory</span>
<a href="#l37.18"></a><span id="l37.18">   // without any search params or attributes specified.</span>
<a href="#l37.19"></a><span id="l37.19">   nsAbLDAPListenerBase(nsILDAPURL* directoryUrl = nullptr,</span>
<a href="#l37.20"></a><span id="l37.20">                        nsILDAPConnection* connection = nullptr,</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-                       const nsACString &amp;login = EmptyCString(),</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+                       const nsACString&amp; login = EmptyCString(),</span>
<a href="#l37.23"></a><span id="l37.23">                        const int32_t timeOut = 0);</span>
<a href="#l37.24"></a><span id="l37.24">   virtual ~nsAbLDAPListenerBase();</span>
<a href="#l37.25"></a><span id="l37.25"> </span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-  NS_IMETHOD OnLDAPInit(nsILDAPConnection *aConn, nsresult aStatus) override;</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+  NS_IMETHOD OnLDAPInit(nsILDAPConnection* aConn, nsresult aStatus) override;</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-protected:</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-  nsresult OnLDAPMessageBind(nsILDAPMessage *aMessage);</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+ protected:</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+  nsresult OnLDAPMessageBind(nsILDAPMessage* aMessage);</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34">   nsresult Initiate();</span>
<a href="#l37.35"></a><span id="l37.35"> </span>
<a href="#l37.36"></a><span id="l37.36">   // Called if an LDAP initialization fails.</span>
<a href="#l37.37"></a><span id="l37.37">   virtual void InitFailed(bool aCancelled = false) = 0;</span>
<a href="#l37.38"></a><span id="l37.38"> </span>
<a href="#l37.39"></a><span id="l37.39">   // Called to start off the required task after a bind.</span>
<a href="#l37.40"></a><span id="l37.40">   virtual nsresult DoTask() = 0;</span>
<a href="#l37.41"></a><span id="l37.41"> </span>
<a href="#l37.42"></a><span id="l37.42">   nsCOMPtr&lt;nsILDAPURL&gt; mDirectoryUrl;</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-  nsCOMPtr&lt;nsILDAPOperation&gt; mOperation;        // current ldap op</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+  nsCOMPtr&lt;nsILDAPOperation&gt; mOperation;  // current ldap op</span>
<a href="#l37.45"></a><span id="l37.45">   nsILDAPConnection* mConnection;</span>
<a href="#l37.46"></a><span id="l37.46">   nsCString mLogin;</span>
<a href="#l37.47"></a><span id="l37.47">   nsCString mSaslMechanism;</span>
<a href="#l37.48"></a><span id="l37.48">   int32_t mTimeOut;</span>
<a href="#l37.49"></a><span id="l37.49">   bool mBound;</span>
<a href="#l37.50"></a><span id="l37.50">   bool mInitialized;</span>
<a href="#l37.51"></a><span id="l37.51">   static uint32_t sCurrentRequestNum;</span>
<a href="#l37.52"></a><span id="l37.52"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -8,45 +8,40 @@</span>
<a href="#l38.4"></a><span id="l38.4"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l38.5"></a><span id="l38.5"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l38.6"></a><span id="l38.6"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l38.7"></a><span id="l38.7"> #include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l38.8"></a><span id="l38.8"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l38.9"></a><span id="l38.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l38.10"></a><span id="l38.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-// once bug # 101252 gets fixed, this should be reverted back to be non threadsafe</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-// implementation is not really thread safe since each object should exist</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-// independently along with its related independent nsAbLDAPReplicationQuery object.</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbLDAPProcessReplicationData, nsIAbLDAPProcessReplicationData, nsILDAPMessageListener)</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+// once bug # 101252 gets fixed, this should be reverted back to be non</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+// threadsafe implementation is not really thread safe since each object should</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+// exist independently along with its related independent</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+// nsAbLDAPReplicationQuery object.</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+NS_IMPL_ISUPPORTS(nsAbLDAPProcessReplicationData,</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+                  nsIAbLDAPProcessReplicationData, nsILDAPMessageListener)</span>
<a href="#l38.22"></a><span id="l38.22"> </span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-nsAbLDAPProcessReplicationData::nsAbLDAPProcessReplicationData() :</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-  nsAbLDAPListenerBase(),</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-  mState(kIdle),</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-  mProtocol(-1),</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-  mCount(0),</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-  mDBOpen(false),</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-  mInitialized(false)</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-{</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-}</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+nsAbLDAPProcessReplicationData::nsAbLDAPProcessReplicationData()</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+    : nsAbLDAPListenerBase(),</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+      mState(kIdle),</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+      mProtocol(-1),</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+      mCount(0),</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+      mDBOpen(false),</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+      mInitialized(false) {}</span>
<a href="#l38.39"></a><span id="l38.39"> </span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-nsAbLDAPProcessReplicationData::~nsAbLDAPProcessReplicationData()</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-{</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+nsAbLDAPProcessReplicationData::~nsAbLDAPProcessReplicationData() {</span>
<a href="#l38.43"></a><span id="l38.43">   /* destructor code */</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-  if(mDBOpen &amp;&amp; mReplicationDB)</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineminus">-      mReplicationDB-&gt;Close(false);</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+  if (mDBOpen &amp;&amp; mReplicationDB) mReplicationDB-&gt;Close(false);</span>
<a href="#l38.47"></a><span id="l38.47"> }</span>
<a href="#l38.48"></a><span id="l38.48"> </span>
<a href="#l38.49"></a><span id="l38.49"> NS_IMETHODIMP nsAbLDAPProcessReplicationData::Init(</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-  nsIAbLDAPDirectory *aDirectory,</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-  nsILDAPConnection *aConnection,</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-  nsILDAPURL* aURL,</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-  nsIAbLDAPReplicationQuery *aQuery,</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-  nsIWebProgressListener *aProgressListener)</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-{</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+    nsIAbLDAPDirectory *aDirectory, nsILDAPConnection *aConnection,</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+    nsILDAPURL *aURL, nsIAbLDAPReplicationQuery *aQuery,</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+    nsIWebProgressListener *aProgressListener) {</span>
<a href="#l38.59"></a><span id="l38.59">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l38.60"></a><span id="l38.60">   NS_ENSURE_ARG_POINTER(aConnection);</span>
<a href="#l38.61"></a><span id="l38.61">   NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l38.62"></a><span id="l38.62">   NS_ENSURE_ARG_POINTER(aQuery);</span>
<a href="#l38.63"></a><span id="l38.63"> </span>
<a href="#l38.64"></a><span id="l38.64">   mDirectory = aDirectory;</span>
<a href="#l38.65"></a><span id="l38.65">   mConnection = aConnection;</span>
<a href="#l38.66"></a><span id="l38.66">   mDirectoryUrl = aURL;</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineat">@@ -72,77 +67,71 @@ NS_IMETHODIMP nsAbLDAPProcessReplication</span>
<a href="#l38.68"></a><span id="l38.68">     return rv;</span>
<a href="#l38.69"></a><span id="l38.69">   }</span>
<a href="#l38.70"></a><span id="l38.70"> </span>
<a href="#l38.71"></a><span id="l38.71">   mInitialized = true;</span>
<a href="#l38.72"></a><span id="l38.72"> </span>
<a href="#l38.73"></a><span id="l38.73">   return rv;</span>
<a href="#l38.74"></a><span id="l38.74"> }</span>
<a href="#l38.75"></a><span id="l38.75"> </span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetReplicationState(int32_t *aReplicationState)</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineminus">-{</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aReplicationState);</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineminus">-    *aReplicationState = mState;</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetReplicationState(</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+    int32_t *aReplicationState) {</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aReplicationState);</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+  *aReplicationState = mState;</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.86"></a><span id="l38.86"> }</span>
<a href="#l38.87"></a><span id="l38.87"> </span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetProtocolUsed(int32_t *aProtocolUsed)</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineminus">-{</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aProtocolUsed);</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineminus">-    *aProtocolUsed = mProtocol;</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetProtocolUsed(</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+    int32_t *aProtocolUsed) {</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aProtocolUsed);</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+  *aProtocolUsed = mProtocol;</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.98"></a><span id="l38.98"> }</span>
<a href="#l38.99"></a><span id="l38.99"> </span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessReplicationData::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-{</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+NS_IMETHODIMP nsAbLDAPProcessReplicationData::OnLDAPMessage(</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l38.104"></a><span id="l38.104">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l38.105"></a><span id="l38.105"> </span>
<a href="#l38.106"></a><span id="l38.106" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.109"></a><span id="l38.109"> </span>
<a href="#l38.110"></a><span id="l38.110">   int32_t messageType;</span>
<a href="#l38.111"></a><span id="l38.111">   nsresult rv = aMessage-&gt;GetType(&amp;messageType);</span>
<a href="#l38.112"></a><span id="l38.112">   if (NS_FAILED(rv)) {</span>
<a href="#l38.113"></a><span id="l38.113">     Done(false);</span>
<a href="#l38.114"></a><span id="l38.114">     return rv;</span>
<a href="#l38.115"></a><span id="l38.115">   }</span>
<a href="#l38.116"></a><span id="l38.116"> </span>
<a href="#l38.117"></a><span id="l38.117" class="difflineminus">-  switch (messageType)</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineminus">-  {</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineminus">-  case nsILDAPMessage::RES_BIND:</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineminus">-    rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineminus">-      rv = Abort();</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineminus">-    break;</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineminus">-  case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineminus">-    rv = OnLDAPSearchEntry(aMessage);</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-    break;</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineminus">-  case nsILDAPMessage::RES_SEARCH_RESULT:</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineminus">-    rv = OnLDAPSearchResult(aMessage);</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineminus">-    break;</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-  default:</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-    // for messageTypes we do not handle return NS_OK to LDAP and move ahead.</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineminus">-    break;</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+  switch (messageType) {</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+    case nsILDAPMessage::RES_BIND:</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineplus">+      rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+      if (NS_FAILED(rv)) rv = Abort();</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+      break;</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+    case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineplus">+      rv = OnLDAPSearchEntry(aMessage);</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+      break;</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+    case nsILDAPMessage::RES_SEARCH_RESULT:</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+      rv = OnLDAPSearchResult(aMessage);</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineplus">+      break;</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineplus">+    default:</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+      // for messageTypes we do not handle return NS_OK to LDAP and move ahead.</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineplus">+      rv = NS_OK;</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineplus">+      break;</span>
<a href="#l38.149"></a><span id="l38.149">   }</span>
<a href="#l38.150"></a><span id="l38.150"> </span>
<a href="#l38.151"></a><span id="l38.151">   return rv;</span>
<a href="#l38.152"></a><span id="l38.152"> }</span>
<a href="#l38.153"></a><span id="l38.153"> </span>
<a href="#l38.154"></a><span id="l38.154" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessReplicationData::Abort()</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineminus">-{</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+NS_IMETHODIMP nsAbLDAPProcessReplicationData::Abort() {</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.160"></a><span id="l38.160"> </span>
<a href="#l38.161"></a><span id="l38.161">   nsresult rv = NS_OK;</span>
<a href="#l38.162"></a><span id="l38.162"> </span>
<a href="#l38.163"></a><span id="l38.163">   if (mState != kIdle &amp;&amp; mOperation) {</span>
<a href="#l38.164"></a><span id="l38.164">     rv = mOperation-&gt;AbandonExt();</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineminus">-      mState = kIdle;</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineplus">+    if (NS_SUCCEEDED(rv)) mState = kIdle;</span>
<a href="#l38.168"></a><span id="l38.168">   }</span>
<a href="#l38.169"></a><span id="l38.169"> </span>
<a href="#l38.170"></a><span id="l38.170">   if (mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l38.171"></a><span id="l38.171">     // force close since we need to delete the file.</span>
<a href="#l38.172"></a><span id="l38.172">     mReplicationDB-&gt;ForceClosed();</span>
<a href="#l38.173"></a><span id="l38.173">     mDBOpen = false;</span>
<a href="#l38.174"></a><span id="l38.174"> </span>
<a href="#l38.175"></a><span id="l38.175">     // delete the unsaved replication file</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineat">@@ -158,328 +147,312 @@ NS_IMETHODIMP nsAbLDAPProcessReplication</span>
<a href="#l38.177"></a><span id="l38.177">     }</span>
<a href="#l38.178"></a><span id="l38.178">   }</span>
<a href="#l38.179"></a><span id="l38.179"> </span>
<a href="#l38.180"></a><span id="l38.180">   Done(false);</span>
<a href="#l38.181"></a><span id="l38.181"> </span>
<a href="#l38.182"></a><span id="l38.182">   return rv;</span>
<a href="#l38.183"></a><span id="l38.183"> }</span>
<a href="#l38.184"></a><span id="l38.184"> </span>
<a href="#l38.185"></a><span id="l38.185" class="difflineminus">-nsresult nsAbLDAPProcessReplicationData::DoTask()</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineminus">-{</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineplus">+nsresult nsAbLDAPProcessReplicationData::DoTask() {</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.191"></a><span id="l38.191"> </span>
<a href="#l38.192"></a><span id="l38.192">   nsresult rv = OpenABForReplicatedDir(true);</span>
<a href="#l38.193"></a><span id="l38.193">   if (NS_FAILED(rv))</span>
<a href="#l38.194"></a><span id="l38.194">     // do not call done here since it is called by OpenABForReplicationDir</span>
<a href="#l38.195"></a><span id="l38.195">     return rv;</span>
<a href="#l38.196"></a><span id="l38.196"> </span>
<a href="#l38.197"></a><span id="l38.197">   mOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l38.198"></a><span id="l38.198">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.199"></a><span id="l38.199"> </span>
<a href="#l38.200"></a><span id="l38.200">   rv = mOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l38.201"></a><span id="l38.201">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.202"></a><span id="l38.202"> </span>
<a href="#l38.203"></a><span id="l38.203">   // get the relevant attributes associated with the directory server url</span>
<a href="#l38.204"></a><span id="l38.204">   nsAutoCString urlFilter;</span>
<a href="#l38.205"></a><span id="l38.205">   rv = mDirectoryUrl-&gt;GetFilter(urlFilter);</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineminus">-    return rv;</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.209"></a><span id="l38.209"> </span>
<a href="#l38.210"></a><span id="l38.210">   nsAutoCString dn;</span>
<a href="#l38.211"></a><span id="l38.211">   rv = mDirectoryUrl-&gt;GetDn(dn);</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineminus">-    return rv;</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.215"></a><span id="l38.215"> </span>
<a href="#l38.216"></a><span id="l38.216" class="difflineminus">-  if (dn.IsEmpty())</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineplus">+  if (dn.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.219"></a><span id="l38.219"> </span>
<a href="#l38.220"></a><span id="l38.220">   int32_t scope;</span>
<a href="#l38.221"></a><span id="l38.221">   rv = mDirectoryUrl-&gt;GetScope(&amp;scope);</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.223"></a><span id="l38.223" class="difflineminus">-    return rv;</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.225"></a><span id="l38.225"> </span>
<a href="#l38.226"></a><span id="l38.226">   nsAutoCString attributes;</span>
<a href="#l38.227"></a><span id="l38.227">   rv = mDirectoryUrl-&gt;GetAttributes(attributes);</span>
<a href="#l38.228"></a><span id="l38.228" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineminus">-    return rv;</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.231"></a><span id="l38.231"> </span>
<a href="#l38.232"></a><span id="l38.232">   mState = kReplicatingAll;</span>
<a href="#l38.233"></a><span id="l38.233"> </span>
<a href="#l38.234"></a><span id="l38.234">   if (mListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l38.235"></a><span id="l38.235">     // XXX Cast from bool to nsresult</span>
<a href="#l38.236"></a><span id="l38.236">     mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l38.237"></a><span id="l38.237">                              nsIWebProgressListener::STATE_START,</span>
<a href="#l38.238"></a><span id="l38.238">                              static_cast&lt;nsresult&gt;(true));</span>
<a href="#l38.239"></a><span id="l38.239"> </span>
<a href="#l38.240"></a><span id="l38.240">   return mOperation-&gt;SearchExt(dn, scope, urlFilter, attributes, 0, 0);</span>
<a href="#l38.241"></a><span id="l38.241"> }</span>
<a href="#l38.242"></a><span id="l38.242"> </span>
<a href="#l38.243"></a><span id="l38.243" class="difflineminus">-void nsAbLDAPProcessReplicationData::InitFailed(bool aCancelled)</span>
<a href="#l38.244"></a><span id="l38.244" class="difflineminus">-{</span>
<a href="#l38.245"></a><span id="l38.245" class="difflineplus">+void nsAbLDAPProcessReplicationData::InitFailed(bool aCancelled) {</span>
<a href="#l38.246"></a><span id="l38.246">   // Just call Done() which will ensure everything is tidied up nicely.</span>
<a href="#l38.247"></a><span id="l38.247">   Done(false);</span>
<a href="#l38.248"></a><span id="l38.248"> }</span>
<a href="#l38.249"></a><span id="l38.249"> </span>
<a href="#l38.250"></a><span id="l38.250" class="difflineminus">-nsresult nsAbLDAPProcessReplicationData::OnLDAPSearchEntry(nsILDAPMessage *aMessage)</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineminus">-{</span>
<a href="#l38.252"></a><span id="l38.252" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l38.253"></a><span id="l38.253" class="difflineminus">-    if (!mInitialized)</span>
<a href="#l38.254"></a><span id="l38.254" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineminus">-    // since this runs on the main thread and is single threaded, this will</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineminus">-    // take care of entries returned by LDAP Connection thread after Abort.</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineminus">-    if (!mReplicationDB || !mDBOpen)</span>
<a href="#l38.258"></a><span id="l38.258" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l38.259"></a><span id="l38.259" class="difflineplus">+nsresult nsAbLDAPProcessReplicationData::OnLDAPSearchEntry(</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineplus">+  // since this runs on the main thread and is single threaded, this will</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineplus">+  // take care of entries returned by LDAP Connection thread after Abort.</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineplus">+  if (!mReplicationDB || !mDBOpen) return NS_ERROR_FAILURE;</span>
<a href="#l38.266"></a><span id="l38.266"> </span>
<a href="#l38.267"></a><span id="l38.267" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l38.269"></a><span id="l38.269"> </span>
<a href="#l38.270"></a><span id="l38.270" class="difflineminus">-    // Although we would may naturally create an nsIAbLDAPCard here, we don't</span>
<a href="#l38.271"></a><span id="l38.271" class="difflineminus">-    // need to as we are writing this straight to the database, so just create</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineminus">-    // the database version instead.</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; newCard(do_CreateInstance(NS_ABMDBCARD_CONTRACTID,</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineminus">-                                                  &amp;rv));</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineminus">-      Abort();</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineminus">-      return rv;</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineminus">-    }</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineplus">+  // Although we would may naturally create an nsIAbLDAPCard here, we don't</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineplus">+  // need to as we are writing this straight to the database, so just create</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineplus">+  // the database version instead.</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; newCard(do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv));</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineplus">+    Abort();</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineplus">+    return rv;</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineplus">+  }</span>
<a href="#l38.287"></a><span id="l38.287"> </span>
<a href="#l38.288"></a><span id="l38.288" class="difflineminus">-    rv = mAttrMap-&gt;SetCardPropertiesFromLDAPMessage(aMessage, newCard);</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineminus">-    {</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineminus">-        NS_WARNING(&quot;nsAbLDAPProcessReplicationData::OnLDAPSearchEntry&quot;</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineminus">-           &quot;No card properties could be set&quot;);</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineminus">-        // if some entries are bogus for us, continue with next one</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineminus">-        return NS_OK;</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineminus">-    }</span>
<a href="#l38.296"></a><span id="l38.296" class="difflineplus">+  rv = mAttrMap-&gt;SetCardPropertiesFromLDAPMessage(aMessage, newCard);</span>
<a href="#l38.297"></a><span id="l38.297" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineplus">+    NS_WARNING(</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineplus">+        &quot;nsAbLDAPProcessReplicationData::OnLDAPSearchEntry&quot;</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineplus">+        &quot;No card properties could be set&quot;);</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineplus">+    // if some entries are bogus for us, continue with next one</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineplus">+  }</span>
<a href="#l38.304"></a><span id="l38.304"> </span>
<a href="#l38.305"></a><span id="l38.305" class="difflineminus">-    rv = mReplicationDB-&gt;CreateNewCardAndAddToDB(newCard, false, nullptr);</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineminus">-    if(NS_FAILED(rv)) {</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineminus">-        Abort();</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineminus">-        return rv;</span>
<a href="#l38.309"></a><span id="l38.309" class="difflineminus">-    }</span>
<a href="#l38.310"></a><span id="l38.310" class="difflineplus">+  rv = mReplicationDB-&gt;CreateNewCardAndAddToDB(newCard, false, nullptr);</span>
<a href="#l38.311"></a><span id="l38.311" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineplus">+    Abort();</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineplus">+    return rv;</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineplus">+  }</span>
<a href="#l38.315"></a><span id="l38.315"> </span>
<a href="#l38.316"></a><span id="l38.316" class="difflineminus">-    // now set the attribute for the DN of the entry in the card in the DB</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineminus">-    nsAutoCString authDN;</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-    rv = aMessage-&gt;GetDn(authDN);</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-    if(NS_SUCCEEDED(rv) &amp;&amp; !authDN.IsEmpty())</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineminus">-    {</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineminus">-        newCard-&gt;SetPropertyAsAUTF8String(&quot;_DN&quot;, authDN);</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineminus">-    }</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineplus">+  // now set the attribute for the DN of the entry in the card in the DB</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineplus">+  nsAutoCString authDN;</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineplus">+  rv = aMessage-&gt;GetDn(authDN);</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !authDN.IsEmpty()) {</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineplus">+    newCard-&gt;SetPropertyAsAUTF8String(&quot;_DN&quot;, authDN);</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineplus">+  }</span>
<a href="#l38.329"></a><span id="l38.329"> </span>
<a href="#l38.330"></a><span id="l38.330" class="difflineminus">-    rv = mReplicationDB-&gt;EditCard(newCard, false, nullptr);</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineminus">-    if(NS_FAILED(rv)) {</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineminus">-        Abort();</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineminus">-        return rv;</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineminus">-    }</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineplus">+  rv = mReplicationDB-&gt;EditCard(newCard, false, nullptr);</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineplus">+    Abort();</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineplus">+    return rv;</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineplus">+  }</span>
<a href="#l38.340"></a><span id="l38.340"> </span>
<a href="#l38.341"></a><span id="l38.341" class="difflineminus">-</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineminus">-    mCount ++;</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineplus">+  mCount++;</span>
<a href="#l38.344"></a><span id="l38.344"> </span>
<a href="#l38.345"></a><span id="l38.345" class="difflineminus">-    if (mListener &amp;&amp; !(mCount % 10)) // inform the listener every 10 entries</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineminus">-    {</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineminus">-        mListener-&gt;OnProgressChange(nullptr,nullptr,mCount, -1, mCount, -1);</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineminus">-        // in case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineminus">-        // uncomment this one and try.</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineminus">-        // PR_Sleep(PR_INTERVAL_NO_WAIT); // give others a chance</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineminus">-    }</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineplus">+  if (mListener &amp;&amp; !(mCount % 10))  // inform the listener every 10 entries</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineplus">+  {</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineplus">+    mListener-&gt;OnProgressChange(nullptr, nullptr, mCount, -1, mCount, -1);</span>
<a href="#l38.355"></a><span id="l38.355" class="difflineplus">+    // in case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineplus">+    // uncomment this one and try.</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineplus">+    // PR_Sleep(PR_INTERVAL_NO_WAIT); // give others a chance</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineplus">+  }</span>
<a href="#l38.359"></a><span id="l38.359"> </span>
<a href="#l38.360"></a><span id="l38.360" class="difflineminus">-    return rv;</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineplus">+  return rv;</span>
<a href="#l38.362"></a><span id="l38.362"> }</span>
<a href="#l38.363"></a><span id="l38.363"> </span>
<a href="#l38.364"></a><span id="l38.364" class="difflineminus">-</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineminus">-nsresult nsAbLDAPProcessReplicationData::OnLDAPSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineminus">-{</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineplus">+nsresult nsAbLDAPProcessReplicationData::OnLDAPSearchResult(</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineplus">+    nsILDAPMessage *aMessage) {</span>
<a href="#l38.369"></a><span id="l38.369"> #ifdef DEBUG_rdayal</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineminus">-    printf(&quot;LDAP Replication : Got Results for Completion&quot;);</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineplus">+  printf(&quot;LDAP Replication : Got Results for Completion&quot;);</span>
<a href="#l38.372"></a><span id="l38.372"> #endif</span>
<a href="#l38.373"></a><span id="l38.373"> </span>
<a href="#l38.374"></a><span id="l38.374" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l38.375"></a><span id="l38.375" class="difflineminus">-    if(!mInitialized)</span>
<a href="#l38.376"></a><span id="l38.376" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.379"></a><span id="l38.379"> </span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-    int32_t errorCode;</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineminus">-    nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineplus">+  int32_t errorCode;</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineplus">+  nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l38.384"></a><span id="l38.384"> </span>
<a href="#l38.385"></a><span id="l38.385" class="difflineminus">-    if(NS_SUCCEEDED(rv)) {</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-        // We are done with the LDAP search for all entries.</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineminus">-        if(errorCode == nsILDAPErrors::SUCCESS || errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineminus">-            Done(true);</span>
<a href="#l38.389"></a><span id="l38.389" class="difflineminus">-            if(mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineminus">-                rv = mReplicationDB-&gt;Close(true);</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineminus">-                NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication DB Close on Success failed&quot;);</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-                mDBOpen = false;</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineminus">-                // once we have saved the new replication file, delete the backup file</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineminus">-                if(mBackupReplicationFile)</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineminus">-                {</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineminus">-                    rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineminus">-                    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineminus">-                }</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineminus">-            }</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineminus">-            return NS_OK;</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineplus">+    // We are done with the LDAP search for all entries.</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineplus">+    if (errorCode == nsILDAPErrors::SUCCESS ||</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineplus">+        errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineplus">+      Done(true);</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineplus">+      if (mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineplus">+        rv = mReplicationDB-&gt;Close(true);</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineplus">+                     &quot;Replication DB Close on Success failed&quot;);</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineplus">+        mDBOpen = false;</span>
<a href="#l38.411"></a><span id="l38.411" class="difflineplus">+        // once we have saved the new replication file, delete the backup file</span>
<a href="#l38.412"></a><span id="l38.412" class="difflineplus">+        if (mBackupReplicationFile) {</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineplus">+          rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineplus">+          NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineplus">+                       &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l38.416"></a><span id="l38.416">         }</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineplus">+      }</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineplus">+      return NS_OK;</span>
<a href="#l38.419"></a><span id="l38.419">     }</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineplus">+  }</span>
<a href="#l38.421"></a><span id="l38.421"> </span>
<a href="#l38.422"></a><span id="l38.422" class="difflineminus">-    // in case if GetErrorCode returned error or errorCode is not SUCCESS / SIZELIMIT_EXCEEDED</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineminus">-    if(mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineminus">-        // if error result is returned close the DB without saving ???</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineminus">-        // should we commit anyway ??? whatever is returned is not lost then !!</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineminus">-        rv = mReplicationDB-&gt;ForceClosed(); // force close since we need to delete the file.</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication DB ForceClosed on Failure failed&quot;);</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineminus">-        mDBOpen = false;</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineminus">-        // if error result is returned remove the replicated file</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineminus">-        if(mReplicationFile) {</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineminus">-            rv = mReplicationFile-&gt;Remove(false);</span>
<a href="#l38.432"></a><span id="l38.432" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication File Remove on Failure failed&quot;);</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineminus">-            if(NS_SUCCEEDED(rv)) {</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineminus">-                // now put back the backed up replicated file</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineminus">-                if(mBackupReplicationFile &amp;&amp; mDirectory)</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineminus">-                {</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineminus">-                  nsAutoCString fileName;</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineminus">-                  rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineminus">-                  if (NS_SUCCEEDED(rv) &amp;&amp; !fileName.IsEmpty())</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineminus">-                  {</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineminus">-                    rv = mBackupReplicationFile-&gt;MoveToNative(nullptr, fileName);</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineminus">-                    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication Backup File Move back on Failure failed&quot;);</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineminus">-                  }</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineminus">-                }</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineminus">-            }</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineplus">+  // in case if GetErrorCode returned error or errorCode is not SUCCESS /</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineplus">+  // SIZELIMIT_EXCEEDED</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineplus">+  if (mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l38.449"></a><span id="l38.449" class="difflineplus">+    // if error result is returned close the DB without saving ???</span>
<a href="#l38.450"></a><span id="l38.450" class="difflineplus">+    // should we commit anyway ??? whatever is returned is not lost then !!</span>
<a href="#l38.451"></a><span id="l38.451" class="difflineplus">+    rv = mReplicationDB</span>
<a href="#l38.452"></a><span id="l38.452" class="difflineplus">+             -&gt;ForceClosed();  // force close since we need to delete the file.</span>
<a href="#l38.453"></a><span id="l38.453" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l38.454"></a><span id="l38.454" class="difflineplus">+                 &quot;Replication DB ForceClosed on Failure failed&quot;);</span>
<a href="#l38.455"></a><span id="l38.455" class="difflineplus">+    mDBOpen = false;</span>
<a href="#l38.456"></a><span id="l38.456" class="difflineplus">+    // if error result is returned remove the replicated file</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineplus">+    if (mReplicationFile) {</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineplus">+      rv = mReplicationFile-&gt;Remove(false);</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l38.460"></a><span id="l38.460" class="difflineplus">+                   &quot;Replication File Remove on Failure failed&quot;);</span>
<a href="#l38.461"></a><span id="l38.461" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.462"></a><span id="l38.462" class="difflineplus">+        // now put back the backed up replicated file</span>
<a href="#l38.463"></a><span id="l38.463" class="difflineplus">+        if (mBackupReplicationFile &amp;&amp; mDirectory) {</span>
<a href="#l38.464"></a><span id="l38.464" class="difflineplus">+          nsAutoCString fileName;</span>
<a href="#l38.465"></a><span id="l38.465" class="difflineplus">+          rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; !fileName.IsEmpty()) {</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineplus">+            rv = mBackupReplicationFile-&gt;MoveToNative(nullptr, fileName);</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineplus">+            NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l38.469"></a><span id="l38.469" class="difflineplus">+                         &quot;Replication Backup File Move back on Failure failed&quot;);</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineplus">+          }</span>
<a href="#l38.471"></a><span id="l38.471">         }</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineminus">-        Done(false);</span>
<a href="#l38.473"></a><span id="l38.473" class="difflineplus">+      }</span>
<a href="#l38.474"></a><span id="l38.474">     }</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineplus">+    Done(false);</span>
<a href="#l38.476"></a><span id="l38.476" class="difflineplus">+  }</span>
<a href="#l38.477"></a><span id="l38.477"> </span>
<a href="#l38.478"></a><span id="l38.478" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.479"></a><span id="l38.479" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.480"></a><span id="l38.480"> }</span>
<a href="#l38.481"></a><span id="l38.481"> </span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-nsresult nsAbLDAPProcessReplicationData::OpenABForReplicatedDir(bool aCreate)</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineminus">-{</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l38.485"></a><span id="l38.485" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.486"></a><span id="l38.486" class="difflineplus">+nsresult nsAbLDAPProcessReplicationData::OpenABForReplicatedDir(bool aCreate) {</span>
<a href="#l38.487"></a><span id="l38.487" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.488"></a><span id="l38.488"> </span>
<a href="#l38.489"></a><span id="l38.489" class="difflineminus">-  nsresult rv = mDirectory-&gt;GetReplicationFile(getter_AddRefs(mReplicationFile));</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-  {</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineminus">-     Done(false);</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineminus">-     return NS_ERROR_FAILURE;</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineplus">+  nsresult rv =</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineplus">+      mDirectory-&gt;GetReplicationFile(getter_AddRefs(mReplicationFile));</span>
<a href="#l38.496"></a><span id="l38.496" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.497"></a><span id="l38.497" class="difflineplus">+    Done(false);</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l38.499"></a><span id="l38.499">   }</span>
<a href="#l38.500"></a><span id="l38.500"> </span>
<a href="#l38.501"></a><span id="l38.501">   nsCString fileName;</span>
<a href="#l38.502"></a><span id="l38.502">   rv = mReplicationFile-&gt;GetNativeLeafName(fileName);</span>
<a href="#l38.503"></a><span id="l38.503">   if (NS_FAILED(rv)) {</span>
<a href="#l38.504"></a><span id="l38.504">     Done(false);</span>
<a href="#l38.505"></a><span id="l38.505">     return rv;</span>
<a href="#l38.506"></a><span id="l38.506">   }</span>
<a href="#l38.507"></a><span id="l38.507"> </span>
<a href="#l38.508"></a><span id="l38.508" class="difflineminus">-    // if the AB DB already exists backup existing one,</span>
<a href="#l38.509"></a><span id="l38.509" class="difflineminus">-    // in case if the user cancels or Abort put back the backed up file</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineminus">-    bool fileExists;</span>
<a href="#l38.511"></a><span id="l38.511" class="difflineminus">-    rv = mReplicationFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l38.512"></a><span id="l38.512" class="difflineminus">-    if(NS_SUCCEEDED(rv) &amp;&amp; fileExists) {</span>
<a href="#l38.513"></a><span id="l38.513" class="difflineminus">-        // create the backup file object same as the Replication file object.</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineminus">-        // we create a backup file here since we need to cleanup the existing file</span>
<a href="#l38.515"></a><span id="l38.515" class="difflineminus">-        // for create and then commit so instead of deleting existing cards we just</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineminus">-        // clone the existing one for a much better performance - for Download All.</span>
<a href="#l38.517"></a><span id="l38.517" class="difflineminus">-        // And also important in case if replication fails we donot lose user's existing</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineminus">-        // replicated data for both Download all and Changelog.</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; clone;</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineminus">-        rv = mReplicationFile-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineminus">-        if(NS_FAILED(rv))  {</span>
<a href="#l38.522"></a><span id="l38.522" class="difflineminus">-            Done(false);</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-            return rv;</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineminus">-        }</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineminus">-        mBackupReplicationFile = clone;</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineminus">-        rv = mBackupReplicationFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0777);</span>
<a href="#l38.527"></a><span id="l38.527" class="difflineminus">-        if(NS_FAILED(rv))  {</span>
<a href="#l38.528"></a><span id="l38.528" class="difflineminus">-            Done(false);</span>
<a href="#l38.529"></a><span id="l38.529" class="difflineminus">-            return rv;</span>
<a href="#l38.530"></a><span id="l38.530" class="difflineminus">-        }</span>
<a href="#l38.531"></a><span id="l38.531" class="difflineminus">-        nsAutoString backupFileLeafName;</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-        rv = mBackupReplicationFile-&gt;GetLeafName(backupFileLeafName);</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineminus">-        if(NS_FAILED(rv))  {</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineminus">-            Done(false);</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineminus">-            return rv;</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineminus">-        }</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineminus">-        // remove the newly created unique backup file so that move and copy succeeds.</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineminus">-        rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineminus">-        if(NS_FAILED(rv))  {</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineminus">-            Done(false);</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineminus">-            return rv;</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineminus">-        }</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineminus">-</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineminus">-        if(aCreate) {</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineminus">-            // set backup file to existing replication file for move</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineminus">-            mBackupReplicationFile-&gt;SetNativeLeafName(fileName);</span>
<a href="#l38.547"></a><span id="l38.547" class="difflineminus">-</span>
<a href="#l38.548"></a><span id="l38.548" class="difflineminus">-            rv = mBackupReplicationFile-&gt;MoveTo(nullptr, backupFileLeafName);</span>
<a href="#l38.549"></a><span id="l38.549" class="difflineminus">-            // set the backup file leaf name now</span>
<a href="#l38.550"></a><span id="l38.550" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-                mBackupReplicationFile-&gt;SetLeafName(backupFileLeafName);</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-        }</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-        else {</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineminus">-            // set backup file to existing replication file for copy</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineminus">-            mBackupReplicationFile-&gt;SetNativeLeafName(fileName);</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineminus">-</span>
<a href="#l38.557"></a><span id="l38.557" class="difflineminus">-            // specify the parent here specifically,</span>
<a href="#l38.558"></a><span id="l38.558" class="difflineminus">-            // passing nullptr to copy to the same dir actually renames existing file</span>
<a href="#l38.559"></a><span id="l38.559" class="difflineminus">-            // instead of making another copy of the existing file.</span>
<a href="#l38.560"></a><span id="l38.560" class="difflineminus">-            nsCOMPtr&lt;nsIFile&gt; parent;</span>
<a href="#l38.561"></a><span id="l38.561" class="difflineminus">-            rv = mBackupReplicationFile-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l38.562"></a><span id="l38.562" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l38.563"></a><span id="l38.563" class="difflineminus">-                rv = mBackupReplicationFile-&gt;CopyTo(parent, backupFileLeafName);</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineminus">-            // set the backup file leaf name now</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineminus">-                mBackupReplicationFile-&gt;SetLeafName(backupFileLeafName);</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineminus">-        }</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineminus">-        if(NS_FAILED(rv))  {</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineminus">-            Done(false);</span>
<a href="#l38.570"></a><span id="l38.570" class="difflineminus">-            return rv;</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineminus">-        }</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineplus">+  // if the AB DB already exists backup existing one,</span>
<a href="#l38.573"></a><span id="l38.573" class="difflineplus">+  // in case if the user cancels or Abort put back the backed up file</span>
<a href="#l38.574"></a><span id="l38.574" class="difflineplus">+  bool fileExists;</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineplus">+  rv = mReplicationFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l38.576"></a><span id="l38.576" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; fileExists) {</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineplus">+    // create the backup file object same as the Replication file object.</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineplus">+    // we create a backup file here since we need to cleanup the existing file</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineplus">+    // for create and then commit so instead of deleting existing cards we just</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineplus">+    // clone the existing one for a much better performance - for Download All.</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineplus">+    // And also important in case if replication fails we donot lose user's</span>
<a href="#l38.582"></a><span id="l38.582" class="difflineplus">+    // existing replicated data for both Download all and Changelog.</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; clone;</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineplus">+    rv = mReplicationFile-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineplus">+      Done(false);</span>
<a href="#l38.587"></a><span id="l38.587" class="difflineplus">+      return rv;</span>
<a href="#l38.588"></a><span id="l38.588" class="difflineplus">+    }</span>
<a href="#l38.589"></a><span id="l38.589" class="difflineplus">+    mBackupReplicationFile = clone;</span>
<a href="#l38.590"></a><span id="l38.590" class="difflineplus">+    rv = mBackupReplicationFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0777);</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineplus">+      Done(false);</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineplus">+      return rv;</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineplus">+    }</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineplus">+    nsAutoString backupFileLeafName;</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineplus">+    rv = mBackupReplicationFile-&gt;GetLeafName(backupFileLeafName);</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineplus">+      Done(false);</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineplus">+      return rv;</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineplus">+    }</span>
<a href="#l38.601"></a><span id="l38.601" class="difflineplus">+    // remove the newly created unique backup file so that move and copy</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineplus">+    // succeeds.</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineplus">+    rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.604"></a><span id="l38.604" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l38.605"></a><span id="l38.605" class="difflineplus">+      Done(false);</span>
<a href="#l38.606"></a><span id="l38.606" class="difflineplus">+      return rv;</span>
<a href="#l38.607"></a><span id="l38.607">     }</span>
<a href="#l38.608"></a><span id="l38.608"> </span>
<a href="#l38.609"></a><span id="l38.609" class="difflineminus">-    nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l38.610"></a><span id="l38.610" class="difflineminus">-             do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l38.611"></a><span id="l38.611" class="difflineminus">-    if(NS_FAILED(rv)) {</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineminus">-        if (mBackupReplicationFile)</span>
<a href="#l38.613"></a><span id="l38.613" class="difflineminus">-            mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.614"></a><span id="l38.614" class="difflineminus">-        Done(false);</span>
<a href="#l38.615"></a><span id="l38.615" class="difflineminus">-        return rv;</span>
<a href="#l38.616"></a><span id="l38.616" class="difflineminus">-    }</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineplus">+    if (aCreate) {</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineplus">+      // set backup file to existing replication file for move</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineplus">+      mBackupReplicationFile-&gt;SetNativeLeafName(fileName);</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineplus">+</span>
<a href="#l38.621"></a><span id="l38.621" class="difflineplus">+      rv = mBackupReplicationFile-&gt;MoveTo(nullptr, backupFileLeafName);</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineplus">+      // set the backup file leaf name now</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineplus">+        mBackupReplicationFile-&gt;SetLeafName(backupFileLeafName);</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineplus">+    } else {</span>
<a href="#l38.626"></a><span id="l38.626" class="difflineplus">+      // set backup file to existing replication file for copy</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineplus">+      mBackupReplicationFile-&gt;SetNativeLeafName(fileName);</span>
<a href="#l38.628"></a><span id="l38.628"> </span>
<a href="#l38.629"></a><span id="l38.629" class="difflineminus">-    rv = addrDBFactory-&gt;Open(mReplicationFile, aCreate, true, getter_AddRefs(mReplicationDB));</span>
<a href="#l38.630"></a><span id="l38.630" class="difflineminus">-    if(NS_FAILED(rv)) {</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-        Done(false);</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-        if (mBackupReplicationFile)</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineminus">-            mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.634"></a><span id="l38.634" class="difflineminus">-        return rv;</span>
<a href="#l38.635"></a><span id="l38.635" class="difflineplus">+      // specify the parent here specifically,</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineplus">+      // passing nullptr to copy to the same dir actually renames existing file</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineplus">+      // instead of making another copy of the existing file.</span>
<a href="#l38.638"></a><span id="l38.638" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; parent;</span>
<a href="#l38.639"></a><span id="l38.639" class="difflineplus">+      rv = mBackupReplicationFile-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l38.640"></a><span id="l38.640" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l38.641"></a><span id="l38.641" class="difflineplus">+        rv = mBackupReplicationFile-&gt;CopyTo(parent, backupFileLeafName);</span>
<a href="#l38.642"></a><span id="l38.642" class="difflineplus">+      // set the backup file leaf name now</span>
<a href="#l38.643"></a><span id="l38.643" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l38.644"></a><span id="l38.644" class="difflineplus">+        mBackupReplicationFile-&gt;SetLeafName(backupFileLeafName);</span>
<a href="#l38.645"></a><span id="l38.645" class="difflineplus">+    }</span>
<a href="#l38.646"></a><span id="l38.646" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l38.647"></a><span id="l38.647" class="difflineplus">+      Done(false);</span>
<a href="#l38.648"></a><span id="l38.648" class="difflineplus">+      return rv;</span>
<a href="#l38.649"></a><span id="l38.649">     }</span>
<a href="#l38.650"></a><span id="l38.650" class="difflineplus">+  }</span>
<a href="#l38.651"></a><span id="l38.651"> </span>
<a href="#l38.652"></a><span id="l38.652" class="difflineminus">-    mDBOpen = true;  // replication DB is now Open</span>
<a href="#l38.653"></a><span id="l38.653" class="difflineplus">+  nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l38.654"></a><span id="l38.654" class="difflineplus">+      do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l38.655"></a><span id="l38.655" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.656"></a><span id="l38.656" class="difflineplus">+    if (mBackupReplicationFile) mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.657"></a><span id="l38.657" class="difflineplus">+    Done(false);</span>
<a href="#l38.658"></a><span id="l38.658">     return rv;</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineplus">+  }</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineplus">+</span>
<a href="#l38.661"></a><span id="l38.661" class="difflineplus">+  rv = addrDBFactory-&gt;Open(mReplicationFile, aCreate, true,</span>
<a href="#l38.662"></a><span id="l38.662" class="difflineplus">+                           getter_AddRefs(mReplicationDB));</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineplus">+    Done(false);</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineplus">+    if (mBackupReplicationFile) mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineplus">+    return rv;</span>
<a href="#l38.667"></a><span id="l38.667" class="difflineplus">+  }</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineplus">+</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineplus">+  mDBOpen = true;  // replication DB is now Open</span>
<a href="#l38.670"></a><span id="l38.670" class="difflineplus">+  return rv;</span>
<a href="#l38.671"></a><span id="l38.671"> }</span>
<a href="#l38.672"></a><span id="l38.672"> </span>
<a href="#l38.673"></a><span id="l38.673" class="difflineminus">-void nsAbLDAPProcessReplicationData::Done(bool aSuccess)</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineminus">-{</span>
<a href="#l38.675"></a><span id="l38.675" class="difflineminus">-   if (!mInitialized)</span>
<a href="#l38.676"></a><span id="l38.676" class="difflineminus">-       return;</span>
<a href="#l38.677"></a><span id="l38.677" class="difflineplus">+void nsAbLDAPProcessReplicationData::Done(bool aSuccess) {</span>
<a href="#l38.678"></a><span id="l38.678" class="difflineplus">+  if (!mInitialized) return;</span>
<a href="#l38.679"></a><span id="l38.679"> </span>
<a href="#l38.680"></a><span id="l38.680" class="difflineminus">-   mState = kReplicationDone;</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineplus">+  mState = kReplicationDone;</span>
<a href="#l38.682"></a><span id="l38.682"> </span>
<a href="#l38.683"></a><span id="l38.683" class="difflineminus">-   if (mQuery)</span>
<a href="#l38.684"></a><span id="l38.684" class="difflineminus">-     mQuery-&gt;Done(aSuccess);</span>
<a href="#l38.685"></a><span id="l38.685" class="difflineplus">+  if (mQuery) mQuery-&gt;Done(aSuccess);</span>
<a href="#l38.686"></a><span id="l38.686"> </span>
<a href="#l38.687"></a><span id="l38.687" class="difflineminus">-   if (mListener)</span>
<a href="#l38.688"></a><span id="l38.688" class="difflineminus">-       // XXX Cast from bool to nsresult</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineminus">-       mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l38.690"></a><span id="l38.690" class="difflineminus">-           nsIWebProgressListener::STATE_STOP,</span>
<a href="#l38.691"></a><span id="l38.691" class="difflineminus">-           static_cast&lt;nsresult&gt;(aSuccess));</span>
<a href="#l38.692"></a><span id="l38.692" class="difflineplus">+  if (mListener)</span>
<a href="#l38.693"></a><span id="l38.693" class="difflineplus">+    // XXX Cast from bool to nsresult</span>
<a href="#l38.694"></a><span id="l38.694" class="difflineplus">+    mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l38.695"></a><span id="l38.695" class="difflineplus">+                             nsIWebProgressListener::STATE_STOP,</span>
<a href="#l38.696"></a><span id="l38.696" class="difflineplus">+                             static_cast&lt;nsresult&gt;(aSuccess));</span>
<a href="#l38.697"></a><span id="l38.697"> </span>
<a href="#l38.698"></a><span id="l38.698" class="difflineminus">-   // since this is called when all is done here, either on success,</span>
<a href="#l38.699"></a><span id="l38.699" class="difflineminus">-   // failure or abort release the query now.</span>
<a href="#l38.700"></a><span id="l38.700" class="difflineminus">-   mQuery = nullptr;</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineplus">+  // since this is called when all is done here, either on success,</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineplus">+  // failure or abort release the query now.</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineplus">+  mQuery = nullptr;</span>
<a href="#l38.704"></a><span id="l38.704"> }</span>
<a href="#l38.705"></a><span id="l38.705"> </span>
<a href="#l38.706"></a><span id="l38.706" class="difflineminus">-nsresult nsAbLDAPProcessReplicationData::DeleteCard(nsString &amp; aDn)</span>
<a href="#l38.707"></a><span id="l38.707" class="difflineminus">-{</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; cardToDelete;</span>
<a href="#l38.709"></a><span id="l38.709" class="difflineminus">-    mReplicationDB-&gt;GetCardFromAttribute(nullptr, &quot;_DN&quot;, NS_ConvertUTF16toUTF8(aDn),</span>
<a href="#l38.710"></a><span id="l38.710" class="difflineminus">-                                         false, getter_AddRefs(cardToDelete));</span>
<a href="#l38.711"></a><span id="l38.711" class="difflineminus">-    return mReplicationDB-&gt;DeleteCard(cardToDelete, false, nullptr);</span>
<a href="#l38.712"></a><span id="l38.712" class="difflineplus">+nsresult nsAbLDAPProcessReplicationData::DeleteCard(nsString &amp;aDn) {</span>
<a href="#l38.713"></a><span id="l38.713" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; cardToDelete;</span>
<a href="#l38.714"></a><span id="l38.714" class="difflineplus">+  mReplicationDB-&gt;GetCardFromAttribute(nullptr, &quot;_DN&quot;,</span>
<a href="#l38.715"></a><span id="l38.715" class="difflineplus">+                                       NS_ConvertUTF16toUTF8(aDn), false,</span>
<a href="#l38.716"></a><span id="l38.716" class="difflineplus">+                                       getter_AddRefs(cardToDelete));</span>
<a href="#l38.717"></a><span id="l38.717" class="difflineplus">+  return mReplicationDB-&gt;DeleteCard(cardToDelete, false, nullptr);</span>
<a href="#l38.718"></a><span id="l38.718"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.h</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.h</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,66 +1,63 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.5"></a><span id="l39.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.6"></a><span id="l39.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8" class="difflineminus">-</span>
<a href="#l39.9"></a><span id="l39.9"> #ifndef nsAbLDAPReplicationData_h__</span>
<a href="#l39.10"></a><span id="l39.10"> #define nsAbLDAPReplicationData_h__</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l39.13"></a><span id="l39.13"> #include &quot;nsIAbLDAPReplicationData.h&quot;</span>
<a href="#l39.14"></a><span id="l39.14"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l39.15"></a><span id="l39.15"> #include &quot;nsIAbLDAPReplicationQuery.h&quot;</span>
<a href="#l39.16"></a><span id="l39.16"> #include &quot;nsAbLDAPListenerBase.h&quot;</span>
<a href="#l39.17"></a><span id="l39.17"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l39.18"></a><span id="l39.18"> #include &quot;nsIFile.h&quot;</span>
<a href="#l39.19"></a><span id="l39.19"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l39.20"></a><span id="l39.20"> #include &quot;nsIAbLDAPAttributeMap.h&quot;</span>
<a href="#l39.21"></a><span id="l39.21"> #include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l39.22"></a><span id="l39.22"> #include &quot;nsString.h&quot;</span>
<a href="#l39.23"></a><span id="l39.23"> </span>
<a href="#l39.24"></a><span id="l39.24"> class nsAbLDAPProcessReplicationData : public nsIAbLDAPProcessReplicationData,</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-                                       public nsAbLDAPListenerBase</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineminus">-{</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-public:</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+                                       public nsAbLDAPListenerBase {</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+ public:</span>
<a href="#l39.30"></a><span id="l39.30">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l39.31"></a><span id="l39.31">   NS_DECL_NSIABLDAPPROCESSREPLICATIONDATA</span>
<a href="#l39.32"></a><span id="l39.32"> </span>
<a href="#l39.33"></a><span id="l39.33">   nsAbLDAPProcessReplicationData();</span>
<a href="#l39.34"></a><span id="l39.34"> </span>
<a href="#l39.35"></a><span id="l39.35">   // nsILDAPMessageListener</span>
<a href="#l39.36"></a><span id="l39.36">   NS_IMETHOD OnLDAPMessage(nsILDAPMessage *aMessage) override;</span>
<a href="#l39.37"></a><span id="l39.37"> </span>
<a href="#l39.38"></a><span id="l39.38" class="difflineminus">-protected:</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+ protected:</span>
<a href="#l39.40"></a><span id="l39.40">   virtual ~nsAbLDAPProcessReplicationData();</span>
<a href="#l39.41"></a><span id="l39.41">   virtual nsresult DoTask() override;</span>
<a href="#l39.42"></a><span id="l39.42">   virtual void InitFailed(bool aCancelled = false) override;</span>
<a href="#l39.43"></a><span id="l39.43"> </span>
<a href="#l39.44"></a><span id="l39.44">   // pointer to the interfaces used by this object</span>
<a href="#l39.45"></a><span id="l39.45">   nsCOMPtr&lt;nsIWebProgressListener&gt; mListener;</span>
<a href="#l39.46"></a><span id="l39.46">   // pointer to the query to call back to once we've finished</span>
<a href="#l39.47"></a><span id="l39.47">   nsCOMPtr&lt;nsIAbLDAPReplicationQuery&gt; mQuery;</span>
<a href="#l39.48"></a><span id="l39.48"> </span>
<a href="#l39.49"></a><span id="l39.49">   nsCOMPtr&lt;nsIAddrDatabase&gt; mReplicationDB;</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; mReplicationFile;</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; mBackupReplicationFile;</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mReplicationFile;</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mBackupReplicationFile;</span>
<a href="#l39.54"></a><span id="l39.54"> </span>
<a href="#l39.55"></a><span id="l39.55">   // state of processing, protocol used and count of results</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineminus">-  int32_t         mState;</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-  int32_t         mProtocol;</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-  int32_t         mCount;</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-  bool            mDBOpen;</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineminus">-  bool            mInitialized;</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+  int32_t mState;</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+  int32_t mProtocol;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+  int32_t mCount;</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+  bool mDBOpen;</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+  bool mInitialized;</span>
<a href="#l39.66"></a><span id="l39.66"> </span>
<a href="#l39.67"></a><span id="l39.67">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; mDirectory;</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; mAttrMap; // maps ab properties to ldap attrs</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; mAttrMap;  // maps ab properties to ldap attrs</span>
<a href="#l39.70"></a><span id="l39.70"> </span>
<a href="#l39.71"></a><span id="l39.71">   virtual nsresult OnLDAPSearchEntry(nsILDAPMessage *aMessage);</span>
<a href="#l39.72"></a><span id="l39.72">   virtual nsresult OnLDAPSearchResult(nsILDAPMessage *aMessage);</span>
<a href="#l39.73"></a><span id="l39.73"> </span>
<a href="#l39.74"></a><span id="l39.74">   nsresult OpenABForReplicatedDir(bool bCreate);</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-  nsresult DeleteCard(nsString &amp; aDn);</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+  nsresult DeleteCard(nsString &amp;aDn);</span>
<a href="#l39.77"></a><span id="l39.77">   void Done(bool aSuccess);</span>
<a href="#l39.78"></a><span id="l39.78"> };</span>
<a href="#l39.79"></a><span id="l39.79"> </span>
<a href="#l39.80"></a><span id="l39.80" class="difflineminus">-</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-#endif // nsAbLDAPReplicationData_h__</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+#endif  // nsAbLDAPReplicationData_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,152 +1,130 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l40.5"></a><span id="l40.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.6"></a><span id="l40.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.7"></a><span id="l40.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-</span>
<a href="#l40.10"></a><span id="l40.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l40.11"></a><span id="l40.11"> #include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l40.12"></a><span id="l40.12"> #include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l40.13"></a><span id="l40.13"> #include &quot;nsAbLDAPReplicationData.h&quot;</span>
<a href="#l40.14"></a><span id="l40.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l40.15"></a><span id="l40.15"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l40.16"></a><span id="l40.16"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l40.17"></a><span id="l40.17"> #include &quot;prmem.h&quot;</span>
<a href="#l40.18"></a><span id="l40.18"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l40.19"></a><span id="l40.19"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l40.20"></a><span id="l40.20"> </span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbLDAPReplicationQuery,</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-                              nsIAbLDAPReplicationQuery)</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+NS_IMPL_ISUPPORTS(nsAbLDAPReplicationQuery, nsIAbLDAPReplicationQuery)</span>
<a href="#l40.24"></a><span id="l40.24"> </span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-nsAbLDAPReplicationQuery::nsAbLDAPReplicationQuery()</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-    :  mInitialized(false)</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-{</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-}</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+nsAbLDAPReplicationQuery::nsAbLDAPReplicationQuery() : mInitialized(false) {}</span>
<a href="#l40.30"></a><span id="l40.30"> </span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-nsresult nsAbLDAPReplicationQuery::InitLDAPData()</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">-{</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+nsresult nsAbLDAPReplicationQuery::InitLDAPData() {</span>
<a href="#l40.34"></a><span id="l40.34">   nsAutoCString fileName;</span>
<a href="#l40.35"></a><span id="l40.35">   nsresult rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l40.36"></a><span id="l40.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.37"></a><span id="l40.37"> </span>
<a href="#l40.38"></a><span id="l40.38">   // this is done here to take care of the problem related to bug # 99124.</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">-  // earlier versions of Mozilla could have the fileName associated with the directory</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineminus">-  // to be abook.mab which is the profile's personal addressbook. If the pref points to</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineminus">-  // it, calls nsDirPrefs to generate a new server filename.</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-  if (fileName.IsEmpty() || fileName.EqualsLiteral(kPersonalAddressbook))</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-  {</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+  // earlier versions of Mozilla could have the fileName associated with the</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+  // directory to be abook.mab which is the profile's personal addressbook. If</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+  // the pref points to it, calls nsDirPrefs to generate a new server filename.</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+  if (fileName.IsEmpty() || fileName.EqualsLiteral(kPersonalAddressbook)) {</span>
<a href="#l40.48"></a><span id="l40.48">     // Ensure fileName is empty for DIR_GenerateAbFileName to work</span>
<a href="#l40.49"></a><span id="l40.49">     // correctly.</span>
<a href="#l40.50"></a><span id="l40.50">     fileName.Truncate();</span>
<a href="#l40.51"></a><span id="l40.51"> </span>
<a href="#l40.52"></a><span id="l40.52">     nsCOMPtr&lt;nsIAbDirectory&gt; standardDir(do_QueryInterface(mDirectory, &amp;rv));</span>
<a href="#l40.53"></a><span id="l40.53">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.54"></a><span id="l40.54"> </span>
<a href="#l40.55"></a><span id="l40.55">     nsCString dirPrefId;</span>
<a href="#l40.56"></a><span id="l40.56">     rv = standardDir-&gt;GetDirPrefId(dirPrefId);</span>
<a href="#l40.57"></a><span id="l40.57">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.58"></a><span id="l40.58"> </span>
<a href="#l40.59"></a><span id="l40.59">     // XXX This should be replaced by a local function at some stage.</span>
<a href="#l40.60"></a><span id="l40.60">     // For now we'll continue using the nsDirPrefs version.</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineminus">-    DIR_Server* server = DIR_GetServerFromList(dirPrefId.get());</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineminus">-    if (server)</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineminus">-    {</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+    DIR_Server *server = DIR_GetServerFromList(dirPrefId.get());</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+    if (server) {</span>
<a href="#l40.66"></a><span id="l40.66">       DIR_SetServerFileName(server);</span>
<a href="#l40.67"></a><span id="l40.67">       // Now ensure the prefs are saved</span>
<a href="#l40.68"></a><span id="l40.68">       DIR_SavePrefsForOneServer(server);</span>
<a href="#l40.69"></a><span id="l40.69">     }</span>
<a href="#l40.70"></a><span id="l40.70">   }</span>
<a href="#l40.71"></a><span id="l40.71"> </span>
<a href="#l40.72"></a><span id="l40.72">   rv = mDirectory-&gt;SetReplicationFileName(fileName);</span>
<a href="#l40.73"></a><span id="l40.73">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.74"></a><span id="l40.74"> </span>
<a href="#l40.75"></a><span id="l40.75">   rv = mDirectory-&gt;GetLDAPURL(getter_AddRefs(mURL));</span>
<a href="#l40.76"></a><span id="l40.76">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.77"></a><span id="l40.77"> </span>
<a href="#l40.78"></a><span id="l40.78">   rv = mDirectory-&gt;GetAuthDn(mLogin);</span>
<a href="#l40.79"></a><span id="l40.79">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.80"></a><span id="l40.80"> </span>
<a href="#l40.81"></a><span id="l40.81">   mConnection = do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">-    return rv;</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.85"></a><span id="l40.85"> </span>
<a href="#l40.86"></a><span id="l40.86">   mOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l40.87"></a><span id="l40.87"> </span>
<a href="#l40.88"></a><span id="l40.88">   return rv;</span>
<a href="#l40.89"></a><span id="l40.89"> }</span>
<a href="#l40.90"></a><span id="l40.90"> </span>
<a href="#l40.91"></a><span id="l40.91" class="difflineminus">-nsresult nsAbLDAPReplicationQuery::ConnectToLDAPServer()</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineminus">-{</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">-    if (!mInitialized || !mURL)</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+nsresult nsAbLDAPReplicationQuery::ConnectToLDAPServer() {</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+  if (!mInitialized || !mURL) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l40.97"></a><span id="l40.97"> </span>
<a href="#l40.98"></a><span id="l40.98" class="difflineminus">-    nsresult rv;</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineminus">-    nsCOMPtr&lt;nsILDAPMessageListener&gt; mDp = do_QueryInterface(mDataProcessor,</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineminus">-                                                             &amp;rv);</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+  nsresult rv;</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+  nsCOMPtr&lt;nsILDAPMessageListener&gt; mDp = do_QueryInterface(mDataProcessor, &amp;rv);</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+  if (NS_FAILED(rv)) return NS_ERROR_UNEXPECTED;</span>
<a href="#l40.106"></a><span id="l40.106"> </span>
<a href="#l40.107"></a><span id="l40.107" class="difflineminus">-    // this could be a rebind call</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineminus">-    int32_t replicationState = nsIAbLDAPProcessReplicationData::kIdle;</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineminus">-    rv = mDataProcessor-&gt;GetReplicationState(&amp;replicationState);</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineminus">-    if (NS_FAILED(rv) ||</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineminus">-        replicationState != nsIAbLDAPProcessReplicationData::kIdle)</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineminus">-        return rv;</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+  // this could be a rebind call</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+  int32_t replicationState = nsIAbLDAPProcessReplicationData::kIdle;</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+  rv = mDataProcessor-&gt;GetReplicationState(&amp;replicationState);</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+  if (NS_FAILED(rv) ||</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+      replicationState != nsIAbLDAPProcessReplicationData::kIdle)</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineplus">+    return rv;</span>
<a href="#l40.119"></a><span id="l40.119"> </span>
<a href="#l40.120"></a><span id="l40.120" class="difflineminus">-    uint32_t protocolVersion;</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineminus">-    rv = mDirectory-&gt;GetProtocolVersion(&amp;protocolVersion);</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineplus">+  uint32_t protocolVersion;</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineplus">+  rv = mDirectory-&gt;GetProtocolVersion(&amp;protocolVersion);</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.126"></a><span id="l40.126"> </span>
<a href="#l40.127"></a><span id="l40.127" class="difflineminus">-    // initialize the LDAP connection</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineminus">-    return mConnection-&gt;Init(mURL, mLogin, mDp, nullptr, protocolVersion);</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineplus">+  // initialize the LDAP connection</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineplus">+  return mConnection-&gt;Init(mURL, mLogin, mDp, nullptr, protocolVersion);</span>
<a href="#l40.131"></a><span id="l40.131"> }</span>
<a href="#l40.132"></a><span id="l40.132"> </span>
<a href="#l40.133"></a><span id="l40.133" class="difflineminus">-NS_IMETHODIMP nsAbLDAPReplicationQuery::Init(nsIAbLDAPDirectory *aDirectory,</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineminus">-                                             nsIWebProgressListener *aProgressListener)</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineminus">-{</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineplus">+NS_IMETHODIMP nsAbLDAPReplicationQuery::Init(</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineplus">+    nsIAbLDAPDirectory *aDirectory, nsIWebProgressListener *aProgressListener) {</span>
<a href="#l40.138"></a><span id="l40.138">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l40.139"></a><span id="l40.139"> </span>
<a href="#l40.140"></a><span id="l40.140">   mDirectory = aDirectory;</span>
<a href="#l40.141"></a><span id="l40.141"> </span>
<a href="#l40.142"></a><span id="l40.142">   nsresult rv = InitLDAPData();</span>
<a href="#l40.143"></a><span id="l40.143" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineminus">-    return rv;</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.146"></a><span id="l40.146"> </span>
<a href="#l40.147"></a><span id="l40.147">   mDataProcessor =</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineminus">-    do_CreateInstance(NS_ABLDAP_PROCESSREPLICATIONDATA_CONTRACTID, &amp;rv);</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineminus">-    return rv;</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineplus">+      do_CreateInstance(NS_ABLDAP_PROCESSREPLICATIONDATA_CONTRACTID, &amp;rv);</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.153"></a><span id="l40.153"> </span>
<a href="#l40.154"></a><span id="l40.154">   // 'this' initialized</span>
<a href="#l40.155"></a><span id="l40.155">   mInitialized = true;</span>
<a href="#l40.156"></a><span id="l40.156"> </span>
<a href="#l40.157"></a><span id="l40.157">   return mDataProcessor-&gt;Init(mDirectory, mConnection, mURL, this,</span>
<a href="#l40.158"></a><span id="l40.158">                               aProgressListener);</span>
<a href="#l40.159"></a><span id="l40.159"> }</span>
<a href="#l40.160"></a><span id="l40.160"> </span>
<a href="#l40.161"></a><span id="l40.161" class="difflineminus">-NS_IMETHODIMP nsAbLDAPReplicationQuery::DoReplicationQuery()</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineminus">-{</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineminus">-    return ConnectToLDAPServer();</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+NS_IMETHODIMP nsAbLDAPReplicationQuery::DoReplicationQuery() {</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineplus">+  return ConnectToLDAPServer();</span>
<a href="#l40.166"></a><span id="l40.166"> }</span>
<a href="#l40.167"></a><span id="l40.167"> </span>
<a href="#l40.168"></a><span id="l40.168" class="difflineminus">-NS_IMETHODIMP nsAbLDAPReplicationQuery::CancelQuery()</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineminus">-{</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineminus">-    if (!mInitialized)</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineplus">+NS_IMETHODIMP nsAbLDAPReplicationQuery::CancelQuery() {</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l40.174"></a><span id="l40.174"> </span>
<a href="#l40.175"></a><span id="l40.175" class="difflineminus">-    return mDataProcessor-&gt;Abort();</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineplus">+  return mDataProcessor-&gt;Abort();</span>
<a href="#l40.177"></a><span id="l40.177"> }</span>
<a href="#l40.178"></a><span id="l40.178"> </span>
<a href="#l40.179"></a><span id="l40.179" class="difflineminus">-NS_IMETHODIMP nsAbLDAPReplicationQuery::Done(bool aSuccess)</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineminus">-{</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineminus">-   if (!mInitialized)</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineminus">-       return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineplus">+NS_IMETHODIMP nsAbLDAPReplicationQuery::Done(bool aSuccess) {</span>
<a href="#l40.184"></a><span id="l40.184" class="difflineplus">+  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l40.185"></a><span id="l40.185"> </span>
<a href="#l40.186"></a><span id="l40.186" class="difflineminus">-   nsresult rv = NS_OK;</span>
<a href="#l40.187"></a><span id="l40.187" class="difflineminus">-   nsCOMPtr&lt;nsIAbLDAPReplicationService&gt; replicationService =</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineminus">-                            do_GetService(NS_ABLDAP_REPLICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l40.189"></a><span id="l40.189" class="difflineminus">-   if (NS_SUCCEEDED(rv))</span>
<a href="#l40.190"></a><span id="l40.190" class="difflineminus">-      replicationService-&gt;Done(aSuccess);</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l40.192"></a><span id="l40.192" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPReplicationService&gt; replicationService =</span>
<a href="#l40.193"></a><span id="l40.193" class="difflineplus">+      do_GetService(NS_ABLDAP_REPLICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l40.194"></a><span id="l40.194" class="difflineplus">+  if (NS_SUCCEEDED(rv)) replicationService-&gt;Done(aSuccess);</span>
<a href="#l40.195"></a><span id="l40.195"> </span>
<a href="#l40.196"></a><span id="l40.196" class="difflineminus">-   return rv;</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineplus">+  return rv;</span>
<a href="#l40.198"></a><span id="l40.198"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationQuery.h</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,43 +1,41 @@</span>
<a href="#l41.4"></a><span id="l41.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.5"></a><span id="l41.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.6"></a><span id="l41.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8" class="difflineminus">-</span>
<a href="#l41.9"></a><span id="l41.9"> #ifndef nsAbLDAPReplicationQuery_h__</span>
<a href="#l41.10"></a><span id="l41.10"> #define nsAbLDAPReplicationQuery_h__</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12"> #include &quot;nsIAbLDAPReplicationQuery.h&quot;</span>
<a href="#l41.13"></a><span id="l41.13"> #include &quot;nsIAbLDAPReplicationData.h&quot;</span>
<a href="#l41.14"></a><span id="l41.14"> #include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l41.15"></a><span id="l41.15"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l41.16"></a><span id="l41.16"> #include &quot;nsILDAPOperation.h&quot;</span>
<a href="#l41.17"></a><span id="l41.17"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l41.18"></a><span id="l41.18"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l41.19"></a><span id="l41.19"> #include &quot;nsString.h&quot;</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-class nsAbLDAPReplicationQuery final : public nsIAbLDAPReplicationQuery</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-{</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-public:</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+class nsAbLDAPReplicationQuery final : public nsIAbLDAPReplicationQuery {</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+ public:</span>
<a href="#l41.26"></a><span id="l41.26">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l41.27"></a><span id="l41.27">   NS_DECL_NSIABLDAPREPLICATIONQUERY</span>
<a href="#l41.28"></a><span id="l41.28"> </span>
<a href="#l41.29"></a><span id="l41.29">   nsAbLDAPReplicationQuery();</span>
<a href="#l41.30"></a><span id="l41.30"> </span>
<a href="#l41.31"></a><span id="l41.31">   nsresult InitLDAPData();</span>
<a href="#l41.32"></a><span id="l41.32">   nsresult ConnectToLDAPServer();</span>
<a href="#l41.33"></a><span id="l41.33"> </span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-protected :</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+ protected:</span>
<a href="#l41.36"></a><span id="l41.36">   ~nsAbLDAPReplicationQuery() {}</span>
<a href="#l41.37"></a><span id="l41.37">   // pointer to interfaces used by this object</span>
<a href="#l41.38"></a><span id="l41.38">   nsCOMPtr&lt;nsILDAPConnection&gt; mConnection;</span>
<a href="#l41.39"></a><span id="l41.39">   nsCOMPtr&lt;nsILDAPOperation&gt; mOperation;</span>
<a href="#l41.40"></a><span id="l41.40">   nsCOMPtr&lt;nsILDAPURL&gt; mURL;</span>
<a href="#l41.41"></a><span id="l41.41">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; mDirectory;</span>
<a href="#l41.42"></a><span id="l41.42"> </span>
<a href="#l41.43"></a><span id="l41.43">   nsCOMPtr&lt;nsIAbLDAPProcessReplicationData&gt; mDataProcessor;</span>
<a href="#l41.44"></a><span id="l41.44"> </span>
<a href="#l41.45"></a><span id="l41.45">   bool mInitialized;</span>
<a href="#l41.46"></a><span id="l41.46">   nsCString mLogin;</span>
<a href="#l41.47"></a><span id="l41.47"> };</span>
<a href="#l41.48"></a><span id="l41.48"> </span>
<a href="#l41.49"></a><span id="l41.49" class="difflineminus">-#endif // nsAbLDAPReplicationQuery_h__</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+#endif  // nsAbLDAPReplicationQuery_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l42.4"></a><span id="l42.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.5"></a><span id="l42.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.6"></a><span id="l42.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8" class="difflineminus">-</span>
<a href="#l42.9"></a><span id="l42.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l42.10"></a><span id="l42.10"> #include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l42.11"></a><span id="l42.11"> #include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l42.12"></a><span id="l42.12"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l42.13"></a><span id="l42.13"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l42.14"></a><span id="l42.14"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l42.15"></a><span id="l42.15"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l42.16"></a><span id="l42.16"> </span>
<a href="#l42.17"></a><span id="l42.17" class="difflineat">@@ -15,122 +14,102 @@</span>
<a href="#l42.18"></a><span id="l42.18"> //#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l42.19"></a><span id="l42.19"> #include &quot;nsIAbLDAPReplicationData.h&quot;</span>
<a href="#l42.20"></a><span id="l42.20"> </span>
<a href="#l42.21"></a><span id="l42.21"> /*** implementation of the service ******/</span>
<a href="#l42.22"></a><span id="l42.22"> </span>
<a href="#l42.23"></a><span id="l42.23"> NS_IMPL_ISUPPORTS(nsAbLDAPReplicationService, nsIAbLDAPReplicationService)</span>
<a href="#l42.24"></a><span id="l42.24"> </span>
<a href="#l42.25"></a><span id="l42.25"> nsAbLDAPReplicationService::nsAbLDAPReplicationService()</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-    : mReplicating(false)</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">-{</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineminus">-}</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+    : mReplicating(false) {}</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+nsAbLDAPReplicationService::~nsAbLDAPReplicationService() {}</span>
<a href="#l42.32"></a><span id="l42.32"> </span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-nsAbLDAPReplicationService::~nsAbLDAPReplicationService()</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-{</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-}</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-/* void startReplication(in string aURI, in nsIWebProgressListener progressListener); */</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-NS_IMETHODIMP nsAbLDAPReplicationService::StartReplication(nsIAbLDAPDirectory *aDirectory,</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-                 nsIWebProgressListener *progressListener)</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-{</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+/* void startReplication(in string aURI, in nsIWebProgressListener</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+ * progressListener); */</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+NS_IMETHODIMP nsAbLDAPReplicationService::StartReplication(</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+    nsIAbLDAPDirectory *aDirectory, nsIWebProgressListener *progressListener) {</span>
<a href="#l42.45"></a><span id="l42.45">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l42.46"></a><span id="l42.46"> </span>
<a href="#l42.47"></a><span id="l42.47"> #ifdef DEBUG_rdayal</span>
<a href="#l42.48"></a><span id="l42.48">   printf(&quot;Start Replication called&quot;);</span>
<a href="#l42.49"></a><span id="l42.49"> #endif</span>
<a href="#l42.50"></a><span id="l42.50"> </span>
<a href="#l42.51"></a><span id="l42.51">   // Makes sure to allow only one replication at a time.</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-  if(mReplicating)</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+  if (mReplicating) return NS_ERROR_FAILURE;</span>
<a href="#l42.55"></a><span id="l42.55"> </span>
<a href="#l42.56"></a><span id="l42.56">   mDirectory = aDirectory;</span>
<a href="#l42.57"></a><span id="l42.57"> </span>
<a href="#l42.58"></a><span id="l42.58">   nsresult rv = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.59"></a><span id="l42.59"> </span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-  switch (DecideProtocol())</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-  {</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-  case nsIAbLDAPProcessReplicationData::kDefaultDownloadAll:</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-    mQuery = do_CreateInstance(NS_ABLDAP_REPLICATIONQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-    break;</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-// XXX Change log replication doesn't work. Bug 311632 should fix it.</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-//case nsIAbLDAPProcessReplicationData::kChangeLogProtocol:</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-//  mQuery = do_CreateInstance (NS_ABLDAP_CHANGELOGQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-//  break;</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineminus">-  default:</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-    break;</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+  switch (DecideProtocol()) {</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+    case nsIAbLDAPProcessReplicationData::kDefaultDownloadAll:</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+      mQuery = do_CreateInstance(NS_ABLDAP_REPLICATIONQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+      break;</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+      // XXX Change log replication doesn't work. Bug 311632 should fix it.</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+      // case nsIAbLDAPProcessReplicationData::kChangeLogProtocol:</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+      //  mQuery = do_CreateInstance (NS_ABLDAP_CHANGELOGQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+      //  break;</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+    default:</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+      break;</span>
<a href="#l42.81"></a><span id="l42.81">   }</span>
<a href="#l42.82"></a><span id="l42.82"> </span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mQuery)</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-  {</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mQuery) {</span>
<a href="#l42.86"></a><span id="l42.86">     rv = mQuery-&gt;Init(mDirectory, progressListener);</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-    {</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.90"></a><span id="l42.90">       rv = mQuery-&gt;DoReplicationQuery();</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineminus">-      {</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.94"></a><span id="l42.94">         mReplicating = true;</span>
<a href="#l42.95"></a><span id="l42.95">         return rv;</span>
<a href="#l42.96"></a><span id="l42.96">       }</span>
<a href="#l42.97"></a><span id="l42.97">     }</span>
<a href="#l42.98"></a><span id="l42.98">   }</span>
<a href="#l42.99"></a><span id="l42.99"> </span>
<a href="#l42.100"></a><span id="l42.100">   if (progressListener &amp;&amp; NS_FAILED(rv))</span>
<a href="#l42.101"></a><span id="l42.101">     progressListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineminus">-            nsIWebProgressListener::STATE_STOP,</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-            NS_OK);</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+                                    nsIWebProgressListener::STATE_STOP, NS_OK);</span>
<a href="#l42.105"></a><span id="l42.105"> </span>
<a href="#l42.106"></a><span id="l42.106" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineminus">-  {</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l42.109"></a><span id="l42.109">     mDirectory = nullptr;</span>
<a href="#l42.110"></a><span id="l42.110">     mQuery = nullptr;</span>
<a href="#l42.111"></a><span id="l42.111">   }</span>
<a href="#l42.112"></a><span id="l42.112"> </span>
<a href="#l42.113"></a><span id="l42.113">   return rv;</span>
<a href="#l42.114"></a><span id="l42.114"> }</span>
<a href="#l42.115"></a><span id="l42.115"> </span>
<a href="#l42.116"></a><span id="l42.116"> /* void cancelReplication(in string aURI); */</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-NS_IMETHODIMP nsAbLDAPReplicationService::CancelReplication(nsIAbLDAPDirectory *aDirectory)</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineminus">-{</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+NS_IMETHODIMP nsAbLDAPReplicationService::CancelReplication(</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+    nsIAbLDAPDirectory *aDirectory) {</span>
<a href="#l42.121"></a><span id="l42.121">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l42.122"></a><span id="l42.122"> </span>
<a href="#l42.123"></a><span id="l42.123">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l42.124"></a><span id="l42.124"> </span>
<a href="#l42.125"></a><span id="l42.125" class="difflineminus">-  if (aDirectory == mDirectory)</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineminus">-  {</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineminus">-    if (mQuery &amp;&amp; mReplicating)</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineminus">-      rv = mQuery-&gt;CancelQuery();</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineplus">+  if (aDirectory == mDirectory) {</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+    if (mQuery &amp;&amp; mReplicating) rv = mQuery-&gt;CancelQuery();</span>
<a href="#l42.131"></a><span id="l42.131">   }</span>
<a href="#l42.132"></a><span id="l42.132"> </span>
<a href="#l42.133"></a><span id="l42.133">   // If query has been cancelled successfully</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineminus">-    Done(false);</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+  if (NS_SUCCEEDED(rv)) Done(false);</span>
<a href="#l42.137"></a><span id="l42.137"> </span>
<a href="#l42.138"></a><span id="l42.138">   return rv;</span>
<a href="#l42.139"></a><span id="l42.139"> }</span>
<a href="#l42.140"></a><span id="l42.140"> </span>
<a href="#l42.141"></a><span id="l42.141" class="difflineminus">-NS_IMETHODIMP nsAbLDAPReplicationService::Done(bool aSuccess)</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineminus">-{</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineplus">+NS_IMETHODIMP nsAbLDAPReplicationService::Done(bool aSuccess) {</span>
<a href="#l42.144"></a><span id="l42.144">   mReplicating = false;</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-  if (mQuery)</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineminus">-  {</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineminus">-    mQuery = nullptr;  // Release query obj</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineminus">-    mDirectory = nullptr; // Release directory</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineplus">+  if (mQuery) {</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineplus">+    mQuery = nullptr;      // Release query obj</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+    mDirectory = nullptr;  // Release directory</span>
<a href="#l42.152"></a><span id="l42.152">   }</span>
<a href="#l42.153"></a><span id="l42.153"> </span>
<a href="#l42.154"></a><span id="l42.154">   return NS_OK;</span>
<a href="#l42.155"></a><span id="l42.155"> }</span>
<a href="#l42.156"></a><span id="l42.156"> </span>
<a href="#l42.157"></a><span id="l42.157" class="difflineminus">-</span>
<a href="#l42.158"></a><span id="l42.158"> // XXX: This method should query the RootDSE for the changeLog attribute,</span>
<a href="#l42.159"></a><span id="l42.159"> // if it exists ChangeLog protocol is supported.</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineminus">-int32_t nsAbLDAPReplicationService::DecideProtocol()</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineminus">-{</span>
<a href="#l42.162"></a><span id="l42.162" class="difflineplus">+int32_t nsAbLDAPReplicationService::DecideProtocol() {</span>
<a href="#l42.163"></a><span id="l42.163">   // Do the changeLog, it will decide if there is a need to replicate all</span>
<a href="#l42.164"></a><span id="l42.164">   // entries or only update existing DB and will do the appropriate thing.</span>
<a href="#l42.165"></a><span id="l42.165">   //</span>
<a href="#l42.166"></a><span id="l42.166">   // XXX: Bug 231965 changed this from kChangeLogProtocol to</span>
<a href="#l42.167"></a><span id="l42.167">   // kDefaultDownloadAll because of a problem with ldap replication not</span>
<a href="#l42.168"></a><span id="l42.168">   // working correctly. We need to change this back at some stage (bug 311632).</span>
<a href="#l42.169"></a><span id="l42.169">   return nsIAbLDAPProcessReplicationData::kDefaultDownloadAll;</span>
<a href="#l42.170"></a><span id="l42.170"> }</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineminus">-</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationService.h</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationService.h</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -1,33 +1,28 @@</span>
<a href="#l43.4"></a><span id="l43.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l43.5"></a><span id="l43.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l43.6"></a><span id="l43.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8" class="difflineminus">-</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineminus">-</span>
<a href="#l43.10"></a><span id="l43.10"> #ifndef nsAbLDAPReplicationService_h___</span>
<a href="#l43.11"></a><span id="l43.11"> #define nsAbLDAPReplicationService_h___</span>
<a href="#l43.12"></a><span id="l43.12"> </span>
<a href="#l43.13"></a><span id="l43.13"> #include &quot;nsIAbLDAPReplicationService.h&quot;</span>
<a href="#l43.14"></a><span id="l43.14"> #include &quot;nsIAbLDAPReplicationQuery.h&quot;</span>
<a href="#l43.15"></a><span id="l43.15"> #include &quot;nsString.h&quot;</span>
<a href="#l43.16"></a><span id="l43.16"> </span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-class nsAbLDAPReplicationService : public nsIAbLDAPReplicationService</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineminus">-{</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineminus">-public:</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+class nsAbLDAPReplicationService : public nsIAbLDAPReplicationService {</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+ public:</span>
<a href="#l43.22"></a><span id="l43.22">   NS_DECL_ISUPPORTS</span>
<a href="#l43.23"></a><span id="l43.23">   NS_DECL_NSIABLDAPREPLICATIONSERVICE</span>
<a href="#l43.24"></a><span id="l43.24"> </span>
<a href="#l43.25"></a><span id="l43.25">   nsAbLDAPReplicationService();</span>
<a href="#l43.26"></a><span id="l43.26"> </span>
<a href="#l43.27"></a><span id="l43.27">   int32_t DecideProtocol();</span>
<a href="#l43.28"></a><span id="l43.28"> </span>
<a href="#l43.29"></a><span id="l43.29" class="difflineminus">-protected:</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+ protected:</span>
<a href="#l43.31"></a><span id="l43.31">   virtual ~nsAbLDAPReplicationService();</span>
<a href="#l43.32"></a><span id="l43.32">   nsCOMPtr&lt;nsIAbLDAPReplicationQuery&gt; mQuery;</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">-  bool           mReplicating;</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+  bool mReplicating;</span>
<a href="#l43.35"></a><span id="l43.35">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; mDirectory;</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineminus">-</span>
<a href="#l43.37"></a><span id="l43.37"> };</span>
<a href="#l43.38"></a><span id="l43.38"> </span>
<a href="#l43.39"></a><span id="l43.39" class="difflineminus">-</span>
<a href="#l43.40"></a><span id="l43.40"> #endif /* nsAbLDAPReplicationService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -17,142 +17,127 @@</span>
<a href="#l44.4"></a><span id="l44.4"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l44.5"></a><span id="l44.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l44.6"></a><span id="l44.6"> </span>
<a href="#l44.7"></a><span id="l44.7"> #include &lt;ctype.h&gt;</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9"> NS_IMPL_ISUPPORTS(nsAbLDIFService, nsIAbLDIFService)</span>
<a href="#l44.10"></a><span id="l44.10"> </span>
<a href="#l44.11"></a><span id="l44.11"> // If we get a line longer than 32K it's just toooooo bad!</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-#define kTextAddressBufferSz    (64 * 1024)</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+#define kTextAddressBufferSz (64 * 1024)</span>
<a href="#l44.14"></a><span id="l44.14"> </span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-nsAbLDIFService::nsAbLDIFService()</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineminus">-{</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+nsAbLDIFService::nsAbLDIFService() {</span>
<a href="#l44.18"></a><span id="l44.18">   mStoreLocAsHome = false;</span>
<a href="#l44.19"></a><span id="l44.19">   mLFCount = 0;</span>
<a href="#l44.20"></a><span id="l44.20">   mCRCount = 0;</span>
<a href="#l44.21"></a><span id="l44.21"> }</span>
<a href="#l44.22"></a><span id="l44.22"> </span>
<a href="#l44.23"></a><span id="l44.23" class="difflineminus">-nsAbLDIFService::~nsAbLDIFService()</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineminus">-{</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineminus">-}</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+nsAbLDIFService::~nsAbLDIFService() {}</span>
<a href="#l44.27"></a><span id="l44.27"> </span>
<a href="#l44.28"></a><span id="l44.28" class="difflineminus">-#define RIGHT2            0x03</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineminus">-#define RIGHT4            0x0f</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineminus">-#define CONTINUED_LINE_MARKER    '\001'</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+#define RIGHT2 0x03</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+#define RIGHT4 0x0f</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+#define CONTINUED_LINE_MARKER '\001'</span>
<a href="#l44.34"></a><span id="l44.34"> </span>
<a href="#l44.35"></a><span id="l44.35"> // XXX TODO fix me</span>
<a href="#l44.36"></a><span id="l44.36"> // use the NSPR base64 library.  see plbase64.h</span>
<a href="#l44.37"></a><span id="l44.37"> // see bug #145367</span>
<a href="#l44.38"></a><span id="l44.38"> static unsigned char b642nib[0x80] = {</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineminus">-    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineminus">-    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineminus">-    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineminus">-    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineminus">-    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineminus">-    0xff, 0xff, 0xff, 0x3e, 0xff, 0xff, 0xff, 0x3f,</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineminus">-    0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b,</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineminus">-    0x3c, 0x3d, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineminus">-    0xff, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06,</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineminus">-    0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e,</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineminus">-    0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16,</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineminus">-    0x17, 0x18, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineminus">-    0xff, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineminus">-    0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineminus">-    0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineminus">-    0x31, 0x32, 0x33, 0xff, 0xff, 0xff, 0xff, 0xff</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineminus">-};</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3e, 0xff, 0xff, 0xff, 0x3f,</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+    0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0xff, 0xff,</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+    0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06,</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+    0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12,</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+    0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff,</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+    0xff, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24,</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+    0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+    0x31, 0x32, 0x33, 0xff, 0xff, 0xff, 0xff, 0xff};</span>
<a href="#l44.67"></a><span id="l44.67"> </span>
<a href="#l44.68"></a><span id="l44.68" class="difflineminus">-NS_IMETHODIMP nsAbLDIFService::ImportLDIFFile(nsIAddrDatabase *aDb, nsIFile *aSrc, bool aStoreLocAsHome, uint32_t *aProgress)</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineminus">-{</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineplus">+NS_IMETHODIMP nsAbLDIFService::ImportLDIFFile(nsIAddrDatabase *aDb,</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+                                              nsIFile *aSrc,</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+                                              bool aStoreLocAsHome,</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+                                              uint32_t *aProgress) {</span>
<a href="#l44.74"></a><span id="l44.74">   NS_ENSURE_ARG_POINTER(aSrc);</span>
<a href="#l44.75"></a><span id="l44.75">   NS_ENSURE_ARG_POINTER(aDb);</span>
<a href="#l44.76"></a><span id="l44.76"> </span>
<a href="#l44.77"></a><span id="l44.77">   mStoreLocAsHome = aStoreLocAsHome;</span>
<a href="#l44.78"></a><span id="l44.78"> </span>
<a href="#l44.79"></a><span id="l44.79">   char buf[1024];</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineminus">-  char* pBuf = &amp;buf[0];</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+  char *pBuf = &amp;buf[0];</span>
<a href="#l44.82"></a><span id="l44.82">   int32_t startPos = 0;</span>
<a href="#l44.83"></a><span id="l44.83">   uint32_t len = 0;</span>
<a href="#l44.84"></a><span id="l44.84">   nsTArray&lt;int32_t&gt; listPosArray;   // where each list/group starts in ldif file</span>
<a href="#l44.85"></a><span id="l44.85">   nsTArray&lt;int32_t&gt; listSizeArray;  // size of the list/group info</span>
<a href="#l44.86"></a><span id="l44.86">   int32_t savedStartPos = 0;</span>
<a href="#l44.87"></a><span id="l44.87">   int32_t filePos = 0;</span>
<a href="#l44.88"></a><span id="l44.88">   uint64_t bytesLeft = 0;</span>
<a href="#l44.89"></a><span id="l44.89"> </span>
<a href="#l44.90"></a><span id="l44.90">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l44.91"></a><span id="l44.91">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aSrc);</span>
<a href="#l44.92"></a><span id="l44.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.93"></a><span id="l44.93"> </span>
<a href="#l44.94"></a><span id="l44.94">   // Initialize the parser for a run...</span>
<a href="#l44.95"></a><span id="l44.95">   mLdifLine.Truncate();</span>
<a href="#l44.96"></a><span id="l44.96"> </span>
<a href="#l44.97"></a><span id="l44.97" class="difflineminus">-  while (NS_SUCCEEDED(inputStream-&gt;Available(&amp;bytesLeft)) &amp;&amp; bytesLeft &gt; 0)</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineminus">-  {</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineminus">-    if (NS_SUCCEEDED(inputStream-&gt;Read(pBuf, sizeof(buf), &amp;len)) &amp;&amp; len &gt; 0)</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineminus">-    {</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+  while (NS_SUCCEEDED(inputStream-&gt;Available(&amp;bytesLeft)) &amp;&amp; bytesLeft &gt; 0) {</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+    if (NS_SUCCEEDED(inputStream-&gt;Read(pBuf, sizeof(buf), &amp;len)) &amp;&amp; len &gt; 0) {</span>
<a href="#l44.103"></a><span id="l44.103">       startPos = 0;</span>
<a href="#l44.104"></a><span id="l44.104"> </span>
<a href="#l44.105"></a><span id="l44.105" class="difflineminus">-      while (NS_SUCCEEDED(GetLdifStringRecord(buf, len, startPos)))</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineminus">-      {</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+      while (NS_SUCCEEDED(GetLdifStringRecord(buf, len, startPos))) {</span>
<a href="#l44.108"></a><span id="l44.108">         if (mLdifLine.Find(&quot;groupOfNames&quot;) == -1)</span>
<a href="#l44.109"></a><span id="l44.109">           AddLdifRowToDatabase(aDb, false);</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineminus">-        else</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineminus">-        {</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineminus">-          //keep file position for mailing list</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+        else {</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+          // keep file position for mailing list</span>
<a href="#l44.115"></a><span id="l44.115">           listPosArray.AppendElement(savedStartPos);</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineminus">-          listSizeArray.AppendElement(filePos + startPos-savedStartPos);</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+          listSizeArray.AppendElement(filePos + startPos - savedStartPos);</span>
<a href="#l44.118"></a><span id="l44.118">           ClearLdifRecordBuffer();</span>
<a href="#l44.119"></a><span id="l44.119">         }</span>
<a href="#l44.120"></a><span id="l44.120">         savedStartPos = filePos + startPos;</span>
<a href="#l44.121"></a><span id="l44.121">       }</span>
<a href="#l44.122"></a><span id="l44.122">       filePos += len;</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineminus">-      if (aProgress)</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineminus">-        *aProgress = (uint32_t)filePos;</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+      if (aProgress) *aProgress = (uint32_t)filePos;</span>
<a href="#l44.126"></a><span id="l44.126">     }</span>
<a href="#l44.127"></a><span id="l44.127">   }</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineminus">-  //last row</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineplus">+  // last row</span>
<a href="#l44.130"></a><span id="l44.130">   if (!mLdifLine.IsEmpty() &amp;&amp; mLdifLine.Find(&quot;groupOfNames&quot;) == -1)</span>
<a href="#l44.131"></a><span id="l44.131">     AddLdifRowToDatabase(aDb, false);</span>
<a href="#l44.132"></a><span id="l44.132"> </span>
<a href="#l44.133"></a><span id="l44.133">   // mail Lists</span>
<a href="#l44.134"></a><span id="l44.134">   int32_t i, pos;</span>
<a href="#l44.135"></a><span id="l44.135">   uint32_t size;</span>
<a href="#l44.136"></a><span id="l44.136">   int32_t listTotal = listPosArray.Length();</span>
<a href="#l44.137"></a><span id="l44.137">   char *listBuf;</span>
<a href="#l44.138"></a><span id="l44.138">   ClearLdifRecordBuffer();  // make sure the buffer is clean</span>
<a href="#l44.139"></a><span id="l44.139"> </span>
<a href="#l44.140"></a><span id="l44.140" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(inputStream, &amp;rv);</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+      do_QueryInterface(inputStream, &amp;rv);</span>
<a href="#l44.143"></a><span id="l44.143">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.144"></a><span id="l44.144"> </span>
<a href="#l44.145"></a><span id="l44.145" class="difflineminus">-  for (i = 0; i &lt; listTotal; i++)</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineminus">-  {</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineminus">-    pos  = listPosArray[i];</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineplus">+  for (i = 0; i &lt; listTotal; i++) {</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineplus">+    pos = listPosArray[i];</span>
<a href="#l44.150"></a><span id="l44.150">     size = listSizeArray[i];</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineminus">-    if (NS_SUCCEEDED(seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, pos)))</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineminus">-    {</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+    if (NS_SUCCEEDED(</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+            seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, pos))) {</span>
<a href="#l44.155"></a><span id="l44.155">       // Allocate enough space for the lists/groups as the size varies.</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineminus">-      listBuf = (char *) PR_Malloc(size);</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineminus">-      if (!listBuf)</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineminus">-        continue;</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineminus">-      if (NS_SUCCEEDED(inputStream-&gt;Read(listBuf, size, &amp;len)) &amp;&amp; len &gt; 0)</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineminus">-      {</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+      listBuf = (char *)PR_Malloc(size);</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+      if (!listBuf) continue;</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+      if (NS_SUCCEEDED(inputStream-&gt;Read(listBuf, size, &amp;len)) &amp;&amp; len &gt; 0) {</span>
<a href="#l44.164"></a><span id="l44.164">         startPos = 0;</span>
<a href="#l44.165"></a><span id="l44.165"> </span>
<a href="#l44.166"></a><span id="l44.166" class="difflineminus">-        while (NS_SUCCEEDED(GetLdifStringRecord(listBuf, len, startPos)))</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineminus">-        {</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineminus">-          if (mLdifLine.Find(&quot;groupOfNames&quot;) != -1)</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineminus">-          {</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineplus">+        while (NS_SUCCEEDED(GetLdifStringRecord(listBuf, len, startPos))) {</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineplus">+          if (mLdifLine.Find(&quot;groupOfNames&quot;) != -1) {</span>
<a href="#l44.172"></a><span id="l44.172">             AddLdifRowToDatabase(aDb, true);</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineminus">-            if (NS_SUCCEEDED(seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0)))</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineplus">+            if (NS_SUCCEEDED(</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineplus">+                    seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0)))</span>
<a href="#l44.176"></a><span id="l44.176">               break;</span>
<a href="#l44.177"></a><span id="l44.177">           }</span>
<a href="#l44.178"></a><span id="l44.178">         }</span>
<a href="#l44.179"></a><span id="l44.179">       }</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineminus">-    PR_FREEIF(listBuf);</span>
<a href="#l44.181"></a><span id="l44.181" class="difflineplus">+      PR_FREEIF(listBuf);</span>
<a href="#l44.182"></a><span id="l44.182">     }</span>
<a href="#l44.183"></a><span id="l44.183">   }</span>
<a href="#l44.184"></a><span id="l44.184"> </span>
<a href="#l44.185"></a><span id="l44.185">   rv = inputStream-&gt;Close();</span>
<a href="#l44.186"></a><span id="l44.186">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.187"></a><span id="l44.187"> </span>
<a href="#l44.188"></a><span id="l44.188">   // Finally commit everything to the database and return.</span>
<a href="#l44.189"></a><span id="l44.189">   return aDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineat">@@ -161,106 +146,104 @@ NS_IMETHODIMP nsAbLDIFService::ImportLDI</span>
<a href="#l44.191"></a><span id="l44.191"> /*</span>
<a href="#l44.192"></a><span id="l44.192">  * str_parse_line - takes a line of the form &quot;type:[:] value&quot; and splits it</span>
<a href="#l44.193"></a><span id="l44.193">  * into components &quot;type&quot; and &quot;value&quot;.  if a double colon separates type from</span>
<a href="#l44.194"></a><span id="l44.194">  * value, then value is encoded in base 64, and parse_line un-decodes it</span>
<a href="#l44.195"></a><span id="l44.195">  * (in place) before returning.</span>
<a href="#l44.196"></a><span id="l44.196">  * in LDIF, non-ASCII data is treated as base64 encoded UTF-8</span>
<a href="#l44.197"></a><span id="l44.197">  */</span>
<a href="#l44.198"></a><span id="l44.198"> </span>
<a href="#l44.199"></a><span id="l44.199" class="difflineminus">-nsresult nsAbLDIFService::str_parse_line(char *line, char **type, char **value, int *vlen) const</span>
<a href="#l44.200"></a><span id="l44.200" class="difflineminus">-{</span>
<a href="#l44.201"></a><span id="l44.201" class="difflineminus">-  char    *p, *s, *d, *byte, *stop;</span>
<a href="#l44.202"></a><span id="l44.202" class="difflineminus">-  char    nib;</span>
<a href="#l44.203"></a><span id="l44.203" class="difflineminus">-  int    i, b64;</span>
<a href="#l44.204"></a><span id="l44.204" class="difflineplus">+nsresult nsAbLDIFService::str_parse_line(char *line, char **type, char **value,</span>
<a href="#l44.205"></a><span id="l44.205" class="difflineplus">+                                         int *vlen) const {</span>
<a href="#l44.206"></a><span id="l44.206" class="difflineplus">+  char *p, *s, *d, *byte, *stop;</span>
<a href="#l44.207"></a><span id="l44.207" class="difflineplus">+  char nib;</span>
<a href="#l44.208"></a><span id="l44.208" class="difflineplus">+  int i, b64;</span>
<a href="#l44.209"></a><span id="l44.209"> </span>
<a href="#l44.210"></a><span id="l44.210">   /* skip any leading space */</span>
<a href="#l44.211"></a><span id="l44.211" class="difflineminus">-  while ( isspace( *line ) ) {</span>
<a href="#l44.212"></a><span id="l44.212" class="difflineplus">+  while (isspace(*line)) {</span>
<a href="#l44.213"></a><span id="l44.213">     line++;</span>
<a href="#l44.214"></a><span id="l44.214">   }</span>
<a href="#l44.215"></a><span id="l44.215">   *type = line;</span>
<a href="#l44.216"></a><span id="l44.216"> </span>
<a href="#l44.217"></a><span id="l44.217" class="difflineminus">-  for ( s = line; *s &amp;&amp; *s != ':'; s++ )</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineminus">-    ;    /* NULL */</span>
<a href="#l44.219"></a><span id="l44.219" class="difflineminus">-  if ( *s == '\0' ) {</span>
<a href="#l44.220"></a><span id="l44.220" class="difflineplus">+  for (s = line; *s &amp;&amp; *s != ':'; s++)</span>
<a href="#l44.221"></a><span id="l44.221" class="difflineplus">+    ; /* NULL */</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineplus">+  if (*s == '\0') {</span>
<a href="#l44.223"></a><span id="l44.223">     return NS_ERROR_FAILURE;</span>
<a href="#l44.224"></a><span id="l44.224">   }</span>
<a href="#l44.225"></a><span id="l44.225"> </span>
<a href="#l44.226"></a><span id="l44.226">   /* trim any space between type and : */</span>
<a href="#l44.227"></a><span id="l44.227" class="difflineminus">-  for ( p = s - 1; p &gt; line &amp;&amp; isspace( *p ); p-- ) {</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineplus">+  for (p = s - 1; p &gt; line &amp;&amp; isspace(*p); p--) {</span>
<a href="#l44.229"></a><span id="l44.229">     *p = '\0';</span>
<a href="#l44.230"></a><span id="l44.230">   }</span>
<a href="#l44.231"></a><span id="l44.231">   *s++ = '\0';</span>
<a href="#l44.232"></a><span id="l44.232"> </span>
<a href="#l44.233"></a><span id="l44.233">   /* check for double : - indicates base 64 encoded value */</span>
<a href="#l44.234"></a><span id="l44.234" class="difflineminus">-  if ( *s == ':' ) {</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineplus">+  if (*s == ':') {</span>
<a href="#l44.236"></a><span id="l44.236">     s++;</span>
<a href="#l44.237"></a><span id="l44.237">     b64 = 1;</span>
<a href="#l44.238"></a><span id="l44.238" class="difflineminus">-  /* single : - normally encoded value */</span>
<a href="#l44.239"></a><span id="l44.239" class="difflineplus">+    /* single : - normally encoded value */</span>
<a href="#l44.240"></a><span id="l44.240">   } else {</span>
<a href="#l44.241"></a><span id="l44.241">     b64 = 0;</span>
<a href="#l44.242"></a><span id="l44.242">   }</span>
<a href="#l44.243"></a><span id="l44.243"> </span>
<a href="#l44.244"></a><span id="l44.244">   /* skip space between : and value */</span>
<a href="#l44.245"></a><span id="l44.245" class="difflineminus">-  while ( isspace( *s ) ) {</span>
<a href="#l44.246"></a><span id="l44.246" class="difflineplus">+  while (isspace(*s)) {</span>
<a href="#l44.247"></a><span id="l44.247">     s++;</span>
<a href="#l44.248"></a><span id="l44.248">   }</span>
<a href="#l44.249"></a><span id="l44.249"> </span>
<a href="#l44.250"></a><span id="l44.250">   /* if no value is present, error out */</span>
<a href="#l44.251"></a><span id="l44.251" class="difflineminus">-  if ( *s == '\0' ) {</span>
<a href="#l44.252"></a><span id="l44.252" class="difflineplus">+  if (*s == '\0') {</span>
<a href="#l44.253"></a><span id="l44.253">     return NS_ERROR_FAILURE;</span>
<a href="#l44.254"></a><span id="l44.254">   }</span>
<a href="#l44.255"></a><span id="l44.255"> </span>
<a href="#l44.256"></a><span id="l44.256">   /* check for continued line markers that should be deleted */</span>
<a href="#l44.257"></a><span id="l44.257" class="difflineminus">-  for ( p = s, d = s; *p; p++ ) {</span>
<a href="#l44.258"></a><span id="l44.258" class="difflineminus">-    if ( *p != CONTINUED_LINE_MARKER )</span>
<a href="#l44.259"></a><span id="l44.259" class="difflineminus">-      *d++ = *p;</span>
<a href="#l44.260"></a><span id="l44.260" class="difflineplus">+  for (p = s, d = s; *p; p++) {</span>
<a href="#l44.261"></a><span id="l44.261" class="difflineplus">+    if (*p != CONTINUED_LINE_MARKER) *d++ = *p;</span>
<a href="#l44.262"></a><span id="l44.262">   }</span>
<a href="#l44.263"></a><span id="l44.263">   *d = '\0';</span>
<a href="#l44.264"></a><span id="l44.264"> </span>
<a href="#l44.265"></a><span id="l44.265">   *value = s;</span>
<a href="#l44.266"></a><span id="l44.266" class="difflineminus">-  if ( b64 ) {</span>
<a href="#l44.267"></a><span id="l44.267" class="difflineminus">-    stop = PL_strchr( s, '\0' );</span>
<a href="#l44.268"></a><span id="l44.268" class="difflineplus">+  if (b64) {</span>
<a href="#l44.269"></a><span id="l44.269" class="difflineplus">+    stop = PL_strchr(s, '\0');</span>
<a href="#l44.270"></a><span id="l44.270">     byte = s;</span>
<a href="#l44.271"></a><span id="l44.271" class="difflineminus">-    for ( p = s, *vlen = 0; p &lt; stop; p += 4, *vlen += 3 ) {</span>
<a href="#l44.272"></a><span id="l44.272" class="difflineminus">-      for ( i = 0; i &lt; 3; i++ ) {</span>
<a href="#l44.273"></a><span id="l44.273" class="difflineminus">-        if ( p[i] != '=' &amp;&amp; (p[i] &amp; 0x80 ||</span>
<a href="#l44.274"></a><span id="l44.274" class="difflineminus">-             b642nib[ p[i] &amp; 0x7f ] &gt; 0x3f) ) {</span>
<a href="#l44.275"></a><span id="l44.275" class="difflineplus">+    for (p = s, *vlen = 0; p &lt; stop; p += 4, *vlen += 3) {</span>
<a href="#l44.276"></a><span id="l44.276" class="difflineplus">+      for (i = 0; i &lt; 3; i++) {</span>
<a href="#l44.277"></a><span id="l44.277" class="difflineplus">+        if (p[i] != '=' &amp;&amp; (p[i] &amp; 0x80 || b642nib[p[i] &amp; 0x7f] &gt; 0x3f)) {</span>
<a href="#l44.278"></a><span id="l44.278">           return NS_ERROR_FAILURE;</span>
<a href="#l44.279"></a><span id="l44.279">         }</span>
<a href="#l44.280"></a><span id="l44.280">       }</span>
<a href="#l44.281"></a><span id="l44.281"> </span>
<a href="#l44.282"></a><span id="l44.282">       /* first digit */</span>
<a href="#l44.283"></a><span id="l44.283" class="difflineminus">-      nib = b642nib[ p[0] &amp; 0x7f ];</span>
<a href="#l44.284"></a><span id="l44.284" class="difflineplus">+      nib = b642nib[p[0] &amp; 0x7f];</span>
<a href="#l44.285"></a><span id="l44.285">       byte[0] = nib &lt;&lt; 2;</span>
<a href="#l44.286"></a><span id="l44.286">       /* second digit */</span>
<a href="#l44.287"></a><span id="l44.287" class="difflineminus">-      nib = b642nib[ p[1] &amp; 0x7f ];</span>
<a href="#l44.288"></a><span id="l44.288" class="difflineplus">+      nib = b642nib[p[1] &amp; 0x7f];</span>
<a href="#l44.289"></a><span id="l44.289">       byte[0] |= nib &gt;&gt; 4;</span>
<a href="#l44.290"></a><span id="l44.290">       byte[1] = (nib &amp; RIGHT4) &lt;&lt; 4;</span>
<a href="#l44.291"></a><span id="l44.291">       /* third digit */</span>
<a href="#l44.292"></a><span id="l44.292" class="difflineminus">-      if ( p[2] == '=' ) {</span>
<a href="#l44.293"></a><span id="l44.293" class="difflineplus">+      if (p[2] == '=') {</span>
<a href="#l44.294"></a><span id="l44.294">         *vlen += 1;</span>
<a href="#l44.295"></a><span id="l44.295">         break;</span>
<a href="#l44.296"></a><span id="l44.296">       }</span>
<a href="#l44.297"></a><span id="l44.297" class="difflineminus">-      nib = b642nib[ p[2] &amp; 0x7f ];</span>
<a href="#l44.298"></a><span id="l44.298" class="difflineplus">+      nib = b642nib[p[2] &amp; 0x7f];</span>
<a href="#l44.299"></a><span id="l44.299">       byte[1] |= nib &gt;&gt; 2;</span>
<a href="#l44.300"></a><span id="l44.300">       byte[2] = (nib &amp; RIGHT2) &lt;&lt; 6;</span>
<a href="#l44.301"></a><span id="l44.301">       /* fourth digit */</span>
<a href="#l44.302"></a><span id="l44.302" class="difflineminus">-      if ( p[3] == '=' ) {</span>
<a href="#l44.303"></a><span id="l44.303" class="difflineplus">+      if (p[3] == '=') {</span>
<a href="#l44.304"></a><span id="l44.304">         *vlen += 2;</span>
<a href="#l44.305"></a><span id="l44.305">         break;</span>
<a href="#l44.306"></a><span id="l44.306">       }</span>
<a href="#l44.307"></a><span id="l44.307" class="difflineminus">-      nib = b642nib[ p[3] &amp; 0x7f ];</span>
<a href="#l44.308"></a><span id="l44.308" class="difflineplus">+      nib = b642nib[p[3] &amp; 0x7f];</span>
<a href="#l44.309"></a><span id="l44.309">       byte[2] |= nib;</span>
<a href="#l44.310"></a><span id="l44.310"> </span>
<a href="#l44.311"></a><span id="l44.311">       byte += 3;</span>
<a href="#l44.312"></a><span id="l44.312">     }</span>
<a href="#l44.313"></a><span id="l44.313" class="difflineminus">-    s[ *vlen ] = '\0';</span>
<a href="#l44.314"></a><span id="l44.314" class="difflineplus">+    s[*vlen] = '\0';</span>
<a href="#l44.315"></a><span id="l44.315">   } else {</span>
<a href="#l44.316"></a><span id="l44.316" class="difflineminus">-    *vlen = (int) (d - s);</span>
<a href="#l44.317"></a><span id="l44.317" class="difflineplus">+    *vlen = (int)(d - s);</span>
<a href="#l44.318"></a><span id="l44.318">   }</span>
<a href="#l44.319"></a><span id="l44.319">   return NS_OK;</span>
<a href="#l44.320"></a><span id="l44.320"> }</span>
<a href="#l44.321"></a><span id="l44.321"> </span>
<a href="#l44.322"></a><span id="l44.322"> /*</span>
<a href="#l44.323"></a><span id="l44.323">  * str_getline - return the next &quot;line&quot; (minus newline) of input from a</span>
<a href="#l44.324"></a><span id="l44.324">  * string buffer of lines separated by newlines, terminated by \n\n</span>
<a href="#l44.325"></a><span id="l44.325">  * or \0.  this routine handles continued lines, bundling them into</span>
<a href="#l44.326"></a><span id="l44.326" class="difflineat">@@ -269,600 +252,542 @@ nsresult nsAbLDIFService::str_parse_line</span>
<a href="#l44.327"></a><span id="l44.327">  * space character (nb: only one char), and preceding newline are changed</span>
<a href="#l44.328"></a><span id="l44.328">  * into CONTINUED_LINE_MARKER chars, to be deleted later by the</span>
<a href="#l44.329"></a><span id="l44.329">  * str_parse_line() routine above.</span>
<a href="#l44.330"></a><span id="l44.330">  *</span>
<a href="#l44.331"></a><span id="l44.331">  * it takes a pointer to a pointer to the buffer on the first call,</span>
<a href="#l44.332"></a><span id="l44.332">  * which it updates and must be supplied on subsequent calls.</span>
<a href="#l44.333"></a><span id="l44.333">  */</span>
<a href="#l44.334"></a><span id="l44.334"> </span>
<a href="#l44.335"></a><span id="l44.335" class="difflineminus">-char* nsAbLDIFService::str_getline(char **next) const</span>
<a href="#l44.336"></a><span id="l44.336" class="difflineminus">-{</span>
<a href="#l44.337"></a><span id="l44.337" class="difflineminus">-  char    *lineStr;</span>
<a href="#l44.338"></a><span id="l44.338" class="difflineminus">-  char    c;</span>
<a href="#l44.339"></a><span id="l44.339" class="difflineplus">+char *nsAbLDIFService::str_getline(char **next) const {</span>
<a href="#l44.340"></a><span id="l44.340" class="difflineplus">+  char *lineStr;</span>
<a href="#l44.341"></a><span id="l44.341" class="difflineplus">+  char c;</span>
<a href="#l44.342"></a><span id="l44.342"> </span>
<a href="#l44.343"></a><span id="l44.343" class="difflineminus">-  if ( *next == nullptr || **next == '\n' || **next == '\0' ) {</span>
<a href="#l44.344"></a><span id="l44.344" class="difflineminus">-    return( nullptr);</span>
<a href="#l44.345"></a><span id="l44.345" class="difflineplus">+  if (*next == nullptr || **next == '\n' || **next == '\0') {</span>
<a href="#l44.346"></a><span id="l44.346" class="difflineplus">+    return (nullptr);</span>
<a href="#l44.347"></a><span id="l44.347">   }</span>
<a href="#l44.348"></a><span id="l44.348"> </span>
<a href="#l44.349"></a><span id="l44.349">   lineStr = *next;</span>
<a href="#l44.350"></a><span id="l44.350" class="difflineminus">-  while ( (*next = PL_strchr( *next, '\n' )) != NULL ) {</span>
<a href="#l44.351"></a><span id="l44.351" class="difflineplus">+  while ((*next = PL_strchr(*next, '\n')) != NULL) {</span>
<a href="#l44.352"></a><span id="l44.352">     c = *(*next + 1);</span>
<a href="#l44.353"></a><span id="l44.353" class="difflineminus">-    if ( isspace( c ) &amp;&amp; c != '\n' ) {</span>
<a href="#l44.354"></a><span id="l44.354" class="difflineplus">+    if (isspace(c) &amp;&amp; c != '\n') {</span>
<a href="#l44.355"></a><span id="l44.355">       **next = CONTINUED_LINE_MARKER;</span>
<a href="#l44.356"></a><span id="l44.356" class="difflineminus">-      *(*next+1) = CONTINUED_LINE_MARKER;</span>
<a href="#l44.357"></a><span id="l44.357" class="difflineplus">+      *(*next + 1) = CONTINUED_LINE_MARKER;</span>
<a href="#l44.358"></a><span id="l44.358">     } else {</span>
<a href="#l44.359"></a><span id="l44.359">       *(*next)++ = '\0';</span>
<a href="#l44.360"></a><span id="l44.360">       break;</span>
<a href="#l44.361"></a><span id="l44.361">     }</span>
<a href="#l44.362"></a><span id="l44.362">   }</span>
<a href="#l44.363"></a><span id="l44.363"> </span>
<a href="#l44.364"></a><span id="l44.364" class="difflineminus">-  return( lineStr );</span>
<a href="#l44.365"></a><span id="l44.365" class="difflineplus">+  return (lineStr);</span>
<a href="#l44.366"></a><span id="l44.366"> }</span>
<a href="#l44.367"></a><span id="l44.367"> </span>
<a href="#l44.368"></a><span id="l44.368" class="difflineminus">-nsresult nsAbLDIFService::GetLdifStringRecord(char* buf, int32_t len, int32_t&amp; stopPos)</span>
<a href="#l44.369"></a><span id="l44.369" class="difflineminus">-{</span>
<a href="#l44.370"></a><span id="l44.370" class="difflineminus">-  for (; stopPos &lt; len; stopPos++)</span>
<a href="#l44.371"></a><span id="l44.371" class="difflineminus">-  {</span>
<a href="#l44.372"></a><span id="l44.372" class="difflineplus">+nsresult nsAbLDIFService::GetLdifStringRecord(char *buf, int32_t len,</span>
<a href="#l44.373"></a><span id="l44.373" class="difflineplus">+                                              int32_t &amp;stopPos) {</span>
<a href="#l44.374"></a><span id="l44.374" class="difflineplus">+  for (; stopPos &lt; len; stopPos++) {</span>
<a href="#l44.375"></a><span id="l44.375">     char c = buf[stopPos];</span>
<a href="#l44.376"></a><span id="l44.376"> </span>
<a href="#l44.377"></a><span id="l44.377" class="difflineminus">-    if (c == 0xA)</span>
<a href="#l44.378"></a><span id="l44.378" class="difflineminus">-    {</span>
<a href="#l44.379"></a><span id="l44.379" class="difflineplus">+    if (c == 0xA) {</span>
<a href="#l44.380"></a><span id="l44.380">       mLFCount++;</span>
<a href="#l44.381"></a><span id="l44.381" class="difflineminus">-    }</span>
<a href="#l44.382"></a><span id="l44.382" class="difflineminus">-    else if (c == 0xD)</span>
<a href="#l44.383"></a><span id="l44.383" class="difflineminus">-    {</span>
<a href="#l44.384"></a><span id="l44.384" class="difflineplus">+    } else if (c == 0xD) {</span>
<a href="#l44.385"></a><span id="l44.385">       mCRCount++;</span>
<a href="#l44.386"></a><span id="l44.386" class="difflineminus">-    }</span>
<a href="#l44.387"></a><span id="l44.387" class="difflineminus">-    else</span>
<a href="#l44.388"></a><span id="l44.388" class="difflineminus">-    {</span>
<a href="#l44.389"></a><span id="l44.389" class="difflineplus">+    } else {</span>
<a href="#l44.390"></a><span id="l44.390">       if (mLFCount == 0 &amp;&amp; mCRCount == 0)</span>
<a href="#l44.391"></a><span id="l44.391">         mLdifLine.Append(c);</span>
<a href="#l44.392"></a><span id="l44.392" class="difflineminus">-      else if (( mLFCount &gt; 1) || ( mCRCount &gt; 2 &amp;&amp; mLFCount ) ||</span>
<a href="#l44.393"></a><span id="l44.393" class="difflineminus">-               ( !mLFCount &amp;&amp; mCRCount &gt; 1 ))</span>
<a href="#l44.394"></a><span id="l44.394" class="difflineminus">-      {</span>
<a href="#l44.395"></a><span id="l44.395" class="difflineplus">+      else if ((mLFCount &gt; 1) || (mCRCount &gt; 2 &amp;&amp; mLFCount) ||</span>
<a href="#l44.396"></a><span id="l44.396" class="difflineplus">+               (!mLFCount &amp;&amp; mCRCount &gt; 1)) {</span>
<a href="#l44.397"></a><span id="l44.397">         return NS_OK;</span>
<a href="#l44.398"></a><span id="l44.398" class="difflineminus">-      }</span>
<a href="#l44.399"></a><span id="l44.399" class="difflineminus">-      else if ((mLFCount == 1 || mCRCount == 1))</span>
<a href="#l44.400"></a><span id="l44.400" class="difflineminus">-      {</span>
<a href="#l44.401"></a><span id="l44.401" class="difflineplus">+      } else if ((mLFCount == 1 || mCRCount == 1)) {</span>
<a href="#l44.402"></a><span id="l44.402">         mLdifLine.Append('\n');</span>
<a href="#l44.403"></a><span id="l44.403">         mLdifLine.Append(c);</span>
<a href="#l44.404"></a><span id="l44.404">         mLFCount = 0;</span>
<a href="#l44.405"></a><span id="l44.405">         mCRCount = 0;</span>
<a href="#l44.406"></a><span id="l44.406">       }</span>
<a href="#l44.407"></a><span id="l44.407">     }</span>
<a href="#l44.408"></a><span id="l44.408">   }</span>
<a href="#l44.409"></a><span id="l44.409"> </span>
<a href="#l44.410"></a><span id="l44.410">   if (((stopPos == len) &amp;&amp; (mLFCount &gt; 1)) || (mCRCount &gt; 2 &amp;&amp; mLFCount) ||</span>
<a href="#l44.411"></a><span id="l44.411">       (!mLFCount &amp;&amp; mCRCount &gt; 1))</span>
<a href="#l44.412"></a><span id="l44.412">     return NS_OK;</span>
<a href="#l44.413"></a><span id="l44.413"> </span>
<a href="#l44.414"></a><span id="l44.414">   return NS_ERROR_FAILURE;</span>
<a href="#l44.415"></a><span id="l44.415"> }</span>
<a href="#l44.416"></a><span id="l44.416"> </span>
<a href="#l44.417"></a><span id="l44.417"> void nsAbLDIFService::AddLdifRowToDatabase(nsIAddrDatabase *aDatabase,</span>
<a href="#l44.418"></a><span id="l44.418" class="difflineminus">-                                           bool bIsList)</span>
<a href="#l44.419"></a><span id="l44.419" class="difflineminus">-{</span>
<a href="#l44.420"></a><span id="l44.420" class="difflineplus">+                                           bool bIsList) {</span>
<a href="#l44.421"></a><span id="l44.421">   // If no data to process then reset CR/LF counters and return.</span>
<a href="#l44.422"></a><span id="l44.422" class="difflineminus">-  if (mLdifLine.IsEmpty())</span>
<a href="#l44.423"></a><span id="l44.423" class="difflineminus">-  {</span>
<a href="#l44.424"></a><span id="l44.424" class="difflineplus">+  if (mLdifLine.IsEmpty()) {</span>
<a href="#l44.425"></a><span id="l44.425">     mLFCount = 0;</span>
<a href="#l44.426"></a><span id="l44.426">     mCRCount = 0;</span>
<a href="#l44.427"></a><span id="l44.427">     return;</span>
<a href="#l44.428"></a><span id="l44.428">   }</span>
<a href="#l44.429"></a><span id="l44.429"> </span>
<a href="#l44.430"></a><span id="l44.430" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l44.431"></a><span id="l44.431" class="difflineminus">-  if (aDatabase)</span>
<a href="#l44.432"></a><span id="l44.432" class="difflineminus">-  {</span>
<a href="#l44.433"></a><span id="l44.433" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; newRow;</span>
<a href="#l44.434"></a><span id="l44.434" class="difflineplus">+  if (aDatabase) {</span>
<a href="#l44.435"></a><span id="l44.435">     if (bIsList)</span>
<a href="#l44.436"></a><span id="l44.436">       aDatabase-&gt;GetNewListRow(getter_AddRefs(newRow));</span>
<a href="#l44.437"></a><span id="l44.437">     else</span>
<a href="#l44.438"></a><span id="l44.438">       aDatabase-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l44.439"></a><span id="l44.439"> </span>
<a href="#l44.440"></a><span id="l44.440" class="difflineminus">-    if (!newRow)</span>
<a href="#l44.441"></a><span id="l44.441" class="difflineminus">-      return;</span>
<a href="#l44.442"></a><span id="l44.442" class="difflineminus">-  }</span>
<a href="#l44.443"></a><span id="l44.443" class="difflineminus">-  else</span>
<a href="#l44.444"></a><span id="l44.444" class="difflineplus">+    if (!newRow) return;</span>
<a href="#l44.445"></a><span id="l44.445" class="difflineplus">+  } else</span>
<a href="#l44.446"></a><span id="l44.446">     return;</span>
<a href="#l44.447"></a><span id="l44.447"> </span>
<a href="#l44.448"></a><span id="l44.448" class="difflineminus">-  char* cursor = ToNewCString(mLdifLine);</span>
<a href="#l44.449"></a><span id="l44.449" class="difflineminus">-  char* saveCursor = cursor;  /* keep for deleting */</span>
<a href="#l44.450"></a><span id="l44.450" class="difflineminus">-  char* line = 0;</span>
<a href="#l44.451"></a><span id="l44.451" class="difflineminus">-  char* typeSlot = 0;</span>
<a href="#l44.452"></a><span id="l44.452" class="difflineminus">-  char* valueSlot = 0;</span>
<a href="#l44.453"></a><span id="l44.453" class="difflineplus">+  char *cursor = ToNewCString(mLdifLine);</span>
<a href="#l44.454"></a><span id="l44.454" class="difflineplus">+  char *saveCursor = cursor; /* keep for deleting */</span>
<a href="#l44.455"></a><span id="l44.455" class="difflineplus">+  char *line = 0;</span>
<a href="#l44.456"></a><span id="l44.456" class="difflineplus">+  char *typeSlot = 0;</span>
<a href="#l44.457"></a><span id="l44.457" class="difflineplus">+  char *valueSlot = 0;</span>
<a href="#l44.458"></a><span id="l44.458">   int length = 0;  // the length  of an ldif attribute</span>
<a href="#l44.459"></a><span id="l44.459" class="difflineminus">-  while ( (line = str_getline(&amp;cursor)) != nullptr)</span>
<a href="#l44.460"></a><span id="l44.460" class="difflineminus">-  {</span>
<a href="#l44.461"></a><span id="l44.461" class="difflineplus">+  while ((line = str_getline(&amp;cursor)) != nullptr) {</span>
<a href="#l44.462"></a><span id="l44.462">     if (NS_SUCCEEDED(str_parse_line(line, &amp;typeSlot, &amp;valueSlot, &amp;length))) {</span>
<a href="#l44.463"></a><span id="l44.463">       AddLdifColToDatabase(aDatabase, newRow, typeSlot, valueSlot, bIsList);</span>
<a href="#l44.464"></a><span id="l44.464" class="difflineminus">-    }</span>
<a href="#l44.465"></a><span id="l44.465" class="difflineminus">-    else</span>
<a href="#l44.466"></a><span id="l44.466" class="difflineminus">-      continue; // parse error: continue with next loop iteration</span>
<a href="#l44.467"></a><span id="l44.467" class="difflineplus">+    } else</span>
<a href="#l44.468"></a><span id="l44.468" class="difflineplus">+      continue;  // parse error: continue with next loop iteration</span>
<a href="#l44.469"></a><span id="l44.469">   }</span>
<a href="#l44.470"></a><span id="l44.470">   free(saveCursor);</span>
<a href="#l44.471"></a><span id="l44.471">   aDatabase-&gt;AddCardRowToDB(newRow);</span>
<a href="#l44.472"></a><span id="l44.472"> </span>
<a href="#l44.473"></a><span id="l44.473" class="difflineminus">-  if (bIsList)</span>
<a href="#l44.474"></a><span id="l44.474" class="difflineminus">-    aDatabase-&gt;AddListDirNode(newRow);</span>
<a href="#l44.475"></a><span id="l44.475" class="difflineplus">+  if (bIsList) aDatabase-&gt;AddListDirNode(newRow);</span>
<a href="#l44.476"></a><span id="l44.476"> </span>
<a href="#l44.477"></a><span id="l44.477">   // Clear buffer for next record</span>
<a href="#l44.478"></a><span id="l44.478">   ClearLdifRecordBuffer();</span>
<a href="#l44.479"></a><span id="l44.479"> }</span>
<a href="#l44.480"></a><span id="l44.480"> </span>
<a href="#l44.481"></a><span id="l44.481"> void nsAbLDIFService::AddLdifColToDatabase(nsIAddrDatabase *aDatabase,</span>
<a href="#l44.482"></a><span id="l44.482" class="difflineminus">-                                           nsIMdbRow* newRow, char* typeSlot,</span>
<a href="#l44.483"></a><span id="l44.483" class="difflineminus">-                                           char* valueSlot, bool bIsList)</span>
<a href="#l44.484"></a><span id="l44.484" class="difflineminus">-{</span>
<a href="#l44.485"></a><span id="l44.485" class="difflineplus">+                                           nsIMdbRow *newRow, char *typeSlot,</span>
<a href="#l44.486"></a><span id="l44.486" class="difflineplus">+                                           char *valueSlot, bool bIsList) {</span>
<a href="#l44.487"></a><span id="l44.487">   nsAutoCString colType(typeSlot);</span>
<a href="#l44.488"></a><span id="l44.488">   nsAutoCString column(valueSlot);</span>
<a href="#l44.489"></a><span id="l44.489"> </span>
<a href="#l44.490"></a><span id="l44.490">   // 4.x exports attributes like &quot;givenname&quot;,</span>
<a href="#l44.491"></a><span id="l44.491">   // mozilla does &quot;givenName&quot; to be compliant with RFC 2798</span>
<a href="#l44.492"></a><span id="l44.492">   ToLowerCase(colType);</span>
<a href="#l44.493"></a><span id="l44.493"> </span>
<a href="#l44.494"></a><span id="l44.494">   mdb_u1 firstByte = (mdb_u1)(colType.get())[0];</span>
<a href="#l44.495"></a><span id="l44.495" class="difflineminus">-  switch ( firstByte )</span>
<a href="#l44.496"></a><span id="l44.496" class="difflineminus">-  {</span>
<a href="#l44.497"></a><span id="l44.497" class="difflineminus">-  case 'b':</span>
<a href="#l44.498"></a><span id="l44.498" class="difflineminus">-    if (colType.EqualsLiteral(&quot;birthyear&quot;))</span>
<a href="#l44.499"></a><span id="l44.499" class="difflineminus">-      aDatabase-&gt;AddBirthYear(newRow, column.get());</span>
<a href="#l44.500"></a><span id="l44.500" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;birthmonth&quot;))</span>
<a href="#l44.501"></a><span id="l44.501" class="difflineminus">-      aDatabase-&gt;AddBirthMonth(newRow, column.get());</span>
<a href="#l44.502"></a><span id="l44.502" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;birthday&quot;))</span>
<a href="#l44.503"></a><span id="l44.503" class="difflineminus">-      aDatabase-&gt;AddBirthDay(newRow, column.get());</span>
<a href="#l44.504"></a><span id="l44.504" class="difflineminus">-    break; // 'b'</span>
<a href="#l44.505"></a><span id="l44.505" class="difflineplus">+  switch (firstByte) {</span>
<a href="#l44.506"></a><span id="l44.506" class="difflineplus">+    case 'b':</span>
<a href="#l44.507"></a><span id="l44.507" class="difflineplus">+      if (colType.EqualsLiteral(&quot;birthyear&quot;))</span>
<a href="#l44.508"></a><span id="l44.508" class="difflineplus">+        aDatabase-&gt;AddBirthYear(newRow, column.get());</span>
<a href="#l44.509"></a><span id="l44.509" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;birthmonth&quot;))</span>
<a href="#l44.510"></a><span id="l44.510" class="difflineplus">+        aDatabase-&gt;AddBirthMonth(newRow, column.get());</span>
<a href="#l44.511"></a><span id="l44.511" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;birthday&quot;))</span>
<a href="#l44.512"></a><span id="l44.512" class="difflineplus">+        aDatabase-&gt;AddBirthDay(newRow, column.get());</span>
<a href="#l44.513"></a><span id="l44.513" class="difflineplus">+      break;  // 'b'</span>
<a href="#l44.514"></a><span id="l44.514"> </span>
<a href="#l44.515"></a><span id="l44.515" class="difflineminus">-  case 'c':</span>
<a href="#l44.516"></a><span id="l44.516" class="difflineminus">-    if (colType.EqualsLiteral(&quot;cn&quot;) || colType.EqualsLiteral(&quot;commonname&quot;))</span>
<a href="#l44.517"></a><span id="l44.517" class="difflineminus">-    {</span>
<a href="#l44.518"></a><span id="l44.518" class="difflineminus">-      if (bIsList)</span>
<a href="#l44.519"></a><span id="l44.519" class="difflineminus">-        aDatabase-&gt;AddListName(newRow, column.get());</span>
<a href="#l44.520"></a><span id="l44.520" class="difflineminus">-      else</span>
<a href="#l44.521"></a><span id="l44.521" class="difflineminus">-        aDatabase-&gt;AddDisplayName(newRow, column.get());</span>
<a href="#l44.522"></a><span id="l44.522" class="difflineminus">-    }</span>
<a href="#l44.523"></a><span id="l44.523" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;c&quot;) || colType.EqualsLiteral(&quot;countryname&quot;))</span>
<a href="#l44.524"></a><span id="l44.524" class="difflineminus">-    {</span>
<a href="#l44.525"></a><span id="l44.525" class="difflineminus">-      if (mStoreLocAsHome )</span>
<a href="#l44.526"></a><span id="l44.526" class="difflineminus">-        aDatabase-&gt;AddHomeCountry(newRow, column.get());</span>
<a href="#l44.527"></a><span id="l44.527" class="difflineminus">-      else</span>
<a href="#l44.528"></a><span id="l44.528" class="difflineminus">-        aDatabase-&gt;AddWorkCountry(newRow, column.get());</span>
<a href="#l44.529"></a><span id="l44.529" class="difflineminus">-    }</span>
<a href="#l44.530"></a><span id="l44.530" class="difflineplus">+    case 'c':</span>
<a href="#l44.531"></a><span id="l44.531" class="difflineplus">+      if (colType.EqualsLiteral(&quot;cn&quot;) || colType.EqualsLiteral(&quot;commonname&quot;)) {</span>
<a href="#l44.532"></a><span id="l44.532" class="difflineplus">+        if (bIsList)</span>
<a href="#l44.533"></a><span id="l44.533" class="difflineplus">+          aDatabase-&gt;AddListName(newRow, column.get());</span>
<a href="#l44.534"></a><span id="l44.534" class="difflineplus">+        else</span>
<a href="#l44.535"></a><span id="l44.535" class="difflineplus">+          aDatabase-&gt;AddDisplayName(newRow, column.get());</span>
<a href="#l44.536"></a><span id="l44.536" class="difflineplus">+      } else if (colType.EqualsLiteral(&quot;c&quot;) ||</span>
<a href="#l44.537"></a><span id="l44.537" class="difflineplus">+                 colType.EqualsLiteral(&quot;countryname&quot;)) {</span>
<a href="#l44.538"></a><span id="l44.538" class="difflineplus">+        if (mStoreLocAsHome)</span>
<a href="#l44.539"></a><span id="l44.539" class="difflineplus">+          aDatabase-&gt;AddHomeCountry(newRow, column.get());</span>
<a href="#l44.540"></a><span id="l44.540" class="difflineplus">+        else</span>
<a href="#l44.541"></a><span id="l44.541" class="difflineplus">+          aDatabase-&gt;AddWorkCountry(newRow, column.get());</span>
<a href="#l44.542"></a><span id="l44.542" class="difflineplus">+      }</span>
<a href="#l44.543"></a><span id="l44.543"> </span>
<a href="#l44.544"></a><span id="l44.544" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;cellphone&quot;) )</span>
<a href="#l44.545"></a><span id="l44.545" class="difflineminus">-      aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l44.546"></a><span id="l44.546" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;cellphone&quot;))</span>
<a href="#l44.547"></a><span id="l44.547" class="difflineplus">+        aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l44.548"></a><span id="l44.548" class="difflineplus">+</span>
<a href="#l44.549"></a><span id="l44.549" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;carphone&quot;))</span>
<a href="#l44.550"></a><span id="l44.550" class="difflineplus">+        aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l44.551"></a><span id="l44.551"> </span>
<a href="#l44.552"></a><span id="l44.552" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;carphone&quot;))</span>
<a href="#l44.553"></a><span id="l44.553" class="difflineminus">-      aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l44.554"></a><span id="l44.554" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;custom1&quot;))</span>
<a href="#l44.555"></a><span id="l44.555" class="difflineplus">+        aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l44.556"></a><span id="l44.556"> </span>
<a href="#l44.557"></a><span id="l44.557" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;custom1&quot;))</span>
<a href="#l44.558"></a><span id="l44.558" class="difflineminus">-      aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l44.559"></a><span id="l44.559" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;custom2&quot;))</span>
<a href="#l44.560"></a><span id="l44.560" class="difflineplus">+        aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l44.561"></a><span id="l44.561"> </span>
<a href="#l44.562"></a><span id="l44.562" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;custom2&quot;))</span>
<a href="#l44.563"></a><span id="l44.563" class="difflineminus">-      aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l44.564"></a><span id="l44.564" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;custom3&quot;))</span>
<a href="#l44.565"></a><span id="l44.565" class="difflineplus">+        aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l44.566"></a><span id="l44.566"> </span>
<a href="#l44.567"></a><span id="l44.567" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;custom3&quot;))</span>
<a href="#l44.568"></a><span id="l44.568" class="difflineminus">-      aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l44.569"></a><span id="l44.569" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;custom4&quot;))</span>
<a href="#l44.570"></a><span id="l44.570" class="difflineplus">+        aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l44.571"></a><span id="l44.571"> </span>
<a href="#l44.572"></a><span id="l44.572" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;custom4&quot;))</span>
<a href="#l44.573"></a><span id="l44.573" class="difflineminus">-      aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l44.574"></a><span id="l44.574" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;company&quot;))</span>
<a href="#l44.575"></a><span id="l44.575" class="difflineplus">+        aDatabase-&gt;AddCompany(newRow, column.get());</span>
<a href="#l44.576"></a><span id="l44.576" class="difflineplus">+      break;  // 'c'</span>
<a href="#l44.577"></a><span id="l44.577"> </span>
<a href="#l44.578"></a><span id="l44.578" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;company&quot;))</span>
<a href="#l44.579"></a><span id="l44.579" class="difflineminus">-      aDatabase-&gt;AddCompany(newRow, column.get());</span>
<a href="#l44.580"></a><span id="l44.580" class="difflineminus">-    break; // 'c'</span>
<a href="#l44.581"></a><span id="l44.581" class="difflineplus">+    case 'd':</span>
<a href="#l44.582"></a><span id="l44.582" class="difflineplus">+      if (colType.EqualsLiteral(&quot;description&quot;)) {</span>
<a href="#l44.583"></a><span id="l44.583" class="difflineplus">+        if (bIsList)</span>
<a href="#l44.584"></a><span id="l44.584" class="difflineplus">+          aDatabase-&gt;AddListDescription(newRow, column.get());</span>
<a href="#l44.585"></a><span id="l44.585" class="difflineplus">+        else</span>
<a href="#l44.586"></a><span id="l44.586" class="difflineplus">+          aDatabase-&gt;AddNotes(newRow, column.get());</span>
<a href="#l44.587"></a><span id="l44.587" class="difflineplus">+      }</span>
<a href="#l44.588"></a><span id="l44.588"> </span>
<a href="#l44.589"></a><span id="l44.589" class="difflineminus">-  case 'd':</span>
<a href="#l44.590"></a><span id="l44.590" class="difflineminus">-    if (colType.EqualsLiteral(&quot;description&quot;))</span>
<a href="#l44.591"></a><span id="l44.591" class="difflineminus">-    {</span>
<a href="#l44.592"></a><span id="l44.592" class="difflineminus">-      if (bIsList)</span>
<a href="#l44.593"></a><span id="l44.593" class="difflineminus">-        aDatabase-&gt;AddListDescription(newRow, column.get());</span>
<a href="#l44.594"></a><span id="l44.594" class="difflineminus">-      else</span>
<a href="#l44.595"></a><span id="l44.595" class="difflineminus">-        aDatabase-&gt;AddNotes(newRow, column.get());</span>
<a href="#l44.596"></a><span id="l44.596" class="difflineminus">-    }</span>
<a href="#l44.597"></a><span id="l44.597" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;department&quot;))</span>
<a href="#l44.598"></a><span id="l44.598" class="difflineplus">+        aDatabase-&gt;AddDepartment(newRow, column.get());</span>
<a href="#l44.599"></a><span id="l44.599"> </span>
<a href="#l44.600"></a><span id="l44.600" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;department&quot;))</span>
<a href="#l44.601"></a><span id="l44.601" class="difflineminus">-      aDatabase-&gt;AddDepartment(newRow, column.get());</span>
<a href="#l44.602"></a><span id="l44.602" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;displayname&quot;)) {</span>
<a href="#l44.603"></a><span id="l44.603" class="difflineplus">+        if (bIsList)</span>
<a href="#l44.604"></a><span id="l44.604" class="difflineplus">+          aDatabase-&gt;AddListName(newRow, column.get());</span>
<a href="#l44.605"></a><span id="l44.605" class="difflineplus">+        else</span>
<a href="#l44.606"></a><span id="l44.606" class="difflineplus">+          aDatabase-&gt;AddDisplayName(newRow, column.get());</span>
<a href="#l44.607"></a><span id="l44.607" class="difflineplus">+      }</span>
<a href="#l44.608"></a><span id="l44.608" class="difflineplus">+      break;  // 'd'</span>
<a href="#l44.609"></a><span id="l44.609"> </span>
<a href="#l44.610"></a><span id="l44.610" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;displayname&quot;))</span>
<a href="#l44.611"></a><span id="l44.611" class="difflineminus">-    {</span>
<a href="#l44.612"></a><span id="l44.612" class="difflineminus">-      if (bIsList)</span>
<a href="#l44.613"></a><span id="l44.613" class="difflineminus">-        aDatabase-&gt;AddListName(newRow, column.get());</span>
<a href="#l44.614"></a><span id="l44.614" class="difflineminus">-      else</span>
<a href="#l44.615"></a><span id="l44.615" class="difflineminus">-        aDatabase-&gt;AddDisplayName(newRow, column.get());</span>
<a href="#l44.616"></a><span id="l44.616" class="difflineminus">-    }</span>
<a href="#l44.617"></a><span id="l44.617" class="difflineminus">-    break; // 'd'</span>
<a href="#l44.618"></a><span id="l44.618" class="difflineplus">+    case 'f':</span>
<a href="#l44.619"></a><span id="l44.619"> </span>
<a href="#l44.620"></a><span id="l44.620" class="difflineminus">-  case 'f':</span>
<a href="#l44.621"></a><span id="l44.621" class="difflineplus">+      if (colType.EqualsLiteral(&quot;fax&quot;) ||</span>
<a href="#l44.622"></a><span id="l44.622" class="difflineplus">+          colType.EqualsLiteral(&quot;facsimiletelephonenumber&quot;))</span>
<a href="#l44.623"></a><span id="l44.623" class="difflineplus">+        aDatabase-&gt;AddFaxNumber(newRow, column.get());</span>
<a href="#l44.624"></a><span id="l44.624" class="difflineplus">+      break;  // 'f'</span>
<a href="#l44.625"></a><span id="l44.625"> </span>
<a href="#l44.626"></a><span id="l44.626" class="difflineminus">-    if (colType.EqualsLiteral(&quot;fax&quot;) ||</span>
<a href="#l44.627"></a><span id="l44.627" class="difflineminus">-        colType.EqualsLiteral(&quot;facsimiletelephonenumber&quot;))</span>
<a href="#l44.628"></a><span id="l44.628" class="difflineminus">-      aDatabase-&gt;AddFaxNumber(newRow, column.get());</span>
<a href="#l44.629"></a><span id="l44.629" class="difflineminus">-    break; // 'f'</span>
<a href="#l44.630"></a><span id="l44.630" class="difflineplus">+    case 'g':</span>
<a href="#l44.631"></a><span id="l44.631" class="difflineplus">+      if (colType.EqualsLiteral(&quot;givenname&quot;))</span>
<a href="#l44.632"></a><span id="l44.632" class="difflineplus">+        aDatabase-&gt;AddFirstName(newRow, column.get());</span>
<a href="#l44.633"></a><span id="l44.633"> </span>
<a href="#l44.634"></a><span id="l44.634" class="difflineminus">-  case 'g':</span>
<a href="#l44.635"></a><span id="l44.635" class="difflineminus">-    if (colType.EqualsLiteral(&quot;givenname&quot;))</span>
<a href="#l44.636"></a><span id="l44.636" class="difflineminus">-      aDatabase-&gt;AddFirstName(newRow, column.get());</span>
<a href="#l44.637"></a><span id="l44.637" class="difflineplus">+      break;  // 'g'</span>
<a href="#l44.638"></a><span id="l44.638"> </span>
<a href="#l44.639"></a><span id="l44.639" class="difflineminus">-    break; // 'g'</span>
<a href="#l44.640"></a><span id="l44.640" class="difflineplus">+    case 'h':</span>
<a href="#l44.641"></a><span id="l44.641" class="difflineplus">+      if (colType.EqualsLiteral(&quot;homephone&quot;))</span>
<a href="#l44.642"></a><span id="l44.642" class="difflineplus">+        aDatabase-&gt;AddHomePhone(newRow, column.get());</span>
<a href="#l44.643"></a><span id="l44.643"> </span>
<a href="#l44.644"></a><span id="l44.644" class="difflineminus">-  case 'h':</span>
<a href="#l44.645"></a><span id="l44.645" class="difflineminus">-    if (colType.EqualsLiteral(&quot;homephone&quot;))</span>
<a href="#l44.646"></a><span id="l44.646" class="difflineminus">-      aDatabase-&gt;AddHomePhone(newRow, column.get());</span>
<a href="#l44.647"></a><span id="l44.647" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;homestreet&quot;))</span>
<a href="#l44.648"></a><span id="l44.648" class="difflineplus">+        aDatabase-&gt;AddHomeAddress(newRow, column.get());</span>
<a href="#l44.649"></a><span id="l44.649"> </span>
<a href="#l44.650"></a><span id="l44.650" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;homestreet&quot;))</span>
<a href="#l44.651"></a><span id="l44.651" class="difflineminus">-      aDatabase-&gt;AddHomeAddress(newRow, column.get());</span>
<a href="#l44.652"></a><span id="l44.652" class="difflineminus">-</span>
<a href="#l44.653"></a><span id="l44.653" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;homeurl&quot;))</span>
<a href="#l44.654"></a><span id="l44.654" class="difflineminus">-      aDatabase-&gt;AddWebPage2(newRow, column.get());</span>
<a href="#l44.655"></a><span id="l44.655" class="difflineminus">-    break; // 'h'</span>
<a href="#l44.656"></a><span id="l44.656" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;homeurl&quot;))</span>
<a href="#l44.657"></a><span id="l44.657" class="difflineplus">+        aDatabase-&gt;AddWebPage2(newRow, column.get());</span>
<a href="#l44.658"></a><span id="l44.658" class="difflineplus">+      break;  // 'h'</span>
<a href="#l44.659"></a><span id="l44.659"> </span>
<a href="#l44.660"></a><span id="l44.660" class="difflineminus">-  case 'l':</span>
<a href="#l44.661"></a><span id="l44.661" class="difflineminus">-    if (colType.EqualsLiteral(&quot;l&quot;) || colType.EqualsLiteral(&quot;locality&quot;))</span>
<a href="#l44.662"></a><span id="l44.662" class="difflineminus">-    {</span>
<a href="#l44.663"></a><span id="l44.663" class="difflineminus">-      if (mStoreLocAsHome)</span>
<a href="#l44.664"></a><span id="l44.664" class="difflineminus">-        aDatabase-&gt;AddHomeCity(newRow, column.get());</span>
<a href="#l44.665"></a><span id="l44.665" class="difflineminus">-      else</span>
<a href="#l44.666"></a><span id="l44.666" class="difflineminus">-        aDatabase-&gt;AddWorkCity(newRow, column.get());</span>
<a href="#l44.667"></a><span id="l44.667" class="difflineminus">-    }</span>
<a href="#l44.668"></a><span id="l44.668" class="difflineminus">-    // labeledURI contains a URI and, optionally, a label</span>
<a href="#l44.669"></a><span id="l44.669" class="difflineminus">-    // This will remove the label and place the URI as the work URL</span>
<a href="#l44.670"></a><span id="l44.670" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;labeleduri&quot;))</span>
<a href="#l44.671"></a><span id="l44.671" class="difflineminus">-    {</span>
<a href="#l44.672"></a><span id="l44.672" class="difflineminus">-      int32_t index = column.FindChar(' ');</span>
<a href="#l44.673"></a><span id="l44.673" class="difflineminus">-      if (index != -1)</span>
<a href="#l44.674"></a><span id="l44.674" class="difflineminus">-        column.SetLength(index);</span>
<a href="#l44.675"></a><span id="l44.675" class="difflineplus">+    case 'l':</span>
<a href="#l44.676"></a><span id="l44.676" class="difflineplus">+      if (colType.EqualsLiteral(&quot;l&quot;) || colType.EqualsLiteral(&quot;locality&quot;)) {</span>
<a href="#l44.677"></a><span id="l44.677" class="difflineplus">+        if (mStoreLocAsHome)</span>
<a href="#l44.678"></a><span id="l44.678" class="difflineplus">+          aDatabase-&gt;AddHomeCity(newRow, column.get());</span>
<a href="#l44.679"></a><span id="l44.679" class="difflineplus">+        else</span>
<a href="#l44.680"></a><span id="l44.680" class="difflineplus">+          aDatabase-&gt;AddWorkCity(newRow, column.get());</span>
<a href="#l44.681"></a><span id="l44.681" class="difflineplus">+      }</span>
<a href="#l44.682"></a><span id="l44.682" class="difflineplus">+      // labeledURI contains a URI and, optionally, a label</span>
<a href="#l44.683"></a><span id="l44.683" class="difflineplus">+      // This will remove the label and place the URI as the work URL</span>
<a href="#l44.684"></a><span id="l44.684" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;labeleduri&quot;)) {</span>
<a href="#l44.685"></a><span id="l44.685" class="difflineplus">+        int32_t index = column.FindChar(' ');</span>
<a href="#l44.686"></a><span id="l44.686" class="difflineplus">+        if (index != -1) column.SetLength(index);</span>
<a href="#l44.687"></a><span id="l44.687"> </span>
<a href="#l44.688"></a><span id="l44.688" class="difflineminus">-      aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l44.689"></a><span id="l44.689" class="difflineminus">-    }</span>
<a href="#l44.690"></a><span id="l44.690" class="difflineplus">+        aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l44.691"></a><span id="l44.691" class="difflineplus">+      }</span>
<a href="#l44.692"></a><span id="l44.692" class="difflineplus">+</span>
<a href="#l44.693"></a><span id="l44.693" class="difflineplus">+      break;  // 'l'</span>
<a href="#l44.694"></a><span id="l44.694"> </span>
<a href="#l44.695"></a><span id="l44.695" class="difflineminus">-    break; // 'l'</span>
<a href="#l44.696"></a><span id="l44.696" class="difflineplus">+    case 'm':</span>
<a href="#l44.697"></a><span id="l44.697" class="difflineplus">+      if (colType.EqualsLiteral(&quot;mail&quot;))</span>
<a href="#l44.698"></a><span id="l44.698" class="difflineplus">+        aDatabase-&gt;AddPrimaryEmail(newRow, column.get());</span>
<a href="#l44.699"></a><span id="l44.699"> </span>
<a href="#l44.700"></a><span id="l44.700" class="difflineminus">-  case 'm':</span>
<a href="#l44.701"></a><span id="l44.701" class="difflineminus">-    if (colType.EqualsLiteral(&quot;mail&quot;))</span>
<a href="#l44.702"></a><span id="l44.702" class="difflineminus">-      aDatabase-&gt;AddPrimaryEmail(newRow, column.get());</span>
<a href="#l44.703"></a><span id="l44.703" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;member&quot;) &amp;&amp; bIsList)</span>
<a href="#l44.704"></a><span id="l44.704" class="difflineplus">+        aDatabase-&gt;AddLdifListMember(newRow, column.get());</span>
<a href="#l44.705"></a><span id="l44.705"> </span>
<a href="#l44.706"></a><span id="l44.706" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;member&quot;) &amp;&amp; bIsList)</span>
<a href="#l44.707"></a><span id="l44.707" class="difflineminus">-      aDatabase-&gt;AddLdifListMember(newRow, column.get());</span>
<a href="#l44.708"></a><span id="l44.708" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mobile&quot;))</span>
<a href="#l44.709"></a><span id="l44.709" class="difflineplus">+        aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l44.710"></a><span id="l44.710"> </span>
<a href="#l44.711"></a><span id="l44.711" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mobile&quot;))</span>
<a href="#l44.712"></a><span id="l44.712" class="difflineminus">-      aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l44.713"></a><span id="l44.713" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozilla_aimscreenname&quot;))</span>
<a href="#l44.714"></a><span id="l44.714" class="difflineplus">+        aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l44.715"></a><span id="l44.715"> </span>
<a href="#l44.716"></a><span id="l44.716" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozilla_aimscreenname&quot;))</span>
<a href="#l44.717"></a><span id="l44.717" class="difflineminus">-      aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l44.718"></a><span id="l44.718" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillacustom1&quot;))</span>
<a href="#l44.719"></a><span id="l44.719" class="difflineplus">+        aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l44.720"></a><span id="l44.720"> </span>
<a href="#l44.721"></a><span id="l44.721" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillacustom1&quot;))</span>
<a href="#l44.722"></a><span id="l44.722" class="difflineminus">-      aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l44.723"></a><span id="l44.723" class="difflineminus">-</span>
<a href="#l44.724"></a><span id="l44.724" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillacustom2&quot;))</span>
<a href="#l44.725"></a><span id="l44.725" class="difflineminus">-      aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l44.726"></a><span id="l44.726" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillacustom2&quot;))</span>
<a href="#l44.727"></a><span id="l44.727" class="difflineplus">+        aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l44.728"></a><span id="l44.728"> </span>
<a href="#l44.729"></a><span id="l44.729" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillacustom3&quot;))</span>
<a href="#l44.730"></a><span id="l44.730" class="difflineminus">-      aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l44.731"></a><span id="l44.731" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillacustom3&quot;))</span>
<a href="#l44.732"></a><span id="l44.732" class="difflineplus">+        aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l44.733"></a><span id="l44.733"> </span>
<a href="#l44.734"></a><span id="l44.734" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillacustom4&quot;))</span>
<a href="#l44.735"></a><span id="l44.735" class="difflineminus">-      aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l44.736"></a><span id="l44.736" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillacustom4&quot;))</span>
<a href="#l44.737"></a><span id="l44.737" class="difflineplus">+        aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l44.738"></a><span id="l44.738"> </span>
<a href="#l44.739"></a><span id="l44.739" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillahomecountryname&quot;))</span>
<a href="#l44.740"></a><span id="l44.740" class="difflineminus">-      aDatabase-&gt;AddHomeCountry(newRow, column.get());</span>
<a href="#l44.741"></a><span id="l44.741" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillahomecountryname&quot;))</span>
<a href="#l44.742"></a><span id="l44.742" class="difflineplus">+        aDatabase-&gt;AddHomeCountry(newRow, column.get());</span>
<a href="#l44.743"></a><span id="l44.743"> </span>
<a href="#l44.744"></a><span id="l44.744" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillahomelocalityname&quot;))</span>
<a href="#l44.745"></a><span id="l44.745" class="difflineminus">-      aDatabase-&gt;AddHomeCity(newRow, column.get());</span>
<a href="#l44.746"></a><span id="l44.746" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillahomelocalityname&quot;))</span>
<a href="#l44.747"></a><span id="l44.747" class="difflineplus">+        aDatabase-&gt;AddHomeCity(newRow, column.get());</span>
<a href="#l44.748"></a><span id="l44.748"> </span>
<a href="#l44.749"></a><span id="l44.749" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillahomestate&quot;))</span>
<a href="#l44.750"></a><span id="l44.750" class="difflineminus">-      aDatabase-&gt;AddHomeState(newRow, column.get());</span>
<a href="#l44.751"></a><span id="l44.751" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillahomestate&quot;))</span>
<a href="#l44.752"></a><span id="l44.752" class="difflineplus">+        aDatabase-&gt;AddHomeState(newRow, column.get());</span>
<a href="#l44.753"></a><span id="l44.753"> </span>
<a href="#l44.754"></a><span id="l44.754" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillahomestreet&quot;))</span>
<a href="#l44.755"></a><span id="l44.755" class="difflineminus">-      aDatabase-&gt;AddHomeAddress(newRow, column.get());</span>
<a href="#l44.756"></a><span id="l44.756" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillahomestreet&quot;))</span>
<a href="#l44.757"></a><span id="l44.757" class="difflineplus">+        aDatabase-&gt;AddHomeAddress(newRow, column.get());</span>
<a href="#l44.758"></a><span id="l44.758"> </span>
<a href="#l44.759"></a><span id="l44.759" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillahomestreet2&quot;))</span>
<a href="#l44.760"></a><span id="l44.760" class="difflineminus">-      aDatabase-&gt;AddHomeAddress2(newRow, column.get());</span>
<a href="#l44.761"></a><span id="l44.761" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillahomestreet2&quot;))</span>
<a href="#l44.762"></a><span id="l44.762" class="difflineplus">+        aDatabase-&gt;AddHomeAddress2(newRow, column.get());</span>
<a href="#l44.763"></a><span id="l44.763"> </span>
<a href="#l44.764"></a><span id="l44.764" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillahomepostalcode&quot;))</span>
<a href="#l44.765"></a><span id="l44.765" class="difflineminus">-      aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l44.766"></a><span id="l44.766" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillahomepostalcode&quot;))</span>
<a href="#l44.767"></a><span id="l44.767" class="difflineplus">+        aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l44.768"></a><span id="l44.768"> </span>
<a href="#l44.769"></a><span id="l44.769" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillahomeurl&quot;))</span>
<a href="#l44.770"></a><span id="l44.770" class="difflineminus">-      aDatabase-&gt;AddWebPage2(newRow, column.get());</span>
<a href="#l44.771"></a><span id="l44.771" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillahomeurl&quot;))</span>
<a href="#l44.772"></a><span id="l44.772" class="difflineplus">+        aDatabase-&gt;AddWebPage2(newRow, column.get());</span>
<a href="#l44.773"></a><span id="l44.773"> </span>
<a href="#l44.774"></a><span id="l44.774" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillanickname&quot;))</span>
<a href="#l44.775"></a><span id="l44.775" class="difflineminus">-    {</span>
<a href="#l44.776"></a><span id="l44.776" class="difflineminus">-      if (bIsList)</span>
<a href="#l44.777"></a><span id="l44.777" class="difflineminus">-        aDatabase-&gt;AddListNickName(newRow, column.get());</span>
<a href="#l44.778"></a><span id="l44.778" class="difflineminus">-      else</span>
<a href="#l44.779"></a><span id="l44.779" class="difflineminus">-        aDatabase-&gt;AddNickName(newRow, column.get());</span>
<a href="#l44.780"></a><span id="l44.780" class="difflineminus">-    }</span>
<a href="#l44.781"></a><span id="l44.781" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillanickname&quot;)) {</span>
<a href="#l44.782"></a><span id="l44.782" class="difflineplus">+        if (bIsList)</span>
<a href="#l44.783"></a><span id="l44.783" class="difflineplus">+          aDatabase-&gt;AddListNickName(newRow, column.get());</span>
<a href="#l44.784"></a><span id="l44.784" class="difflineplus">+        else</span>
<a href="#l44.785"></a><span id="l44.785" class="difflineplus">+          aDatabase-&gt;AddNickName(newRow, column.get());</span>
<a href="#l44.786"></a><span id="l44.786" class="difflineplus">+      }</span>
<a href="#l44.787"></a><span id="l44.787"> </span>
<a href="#l44.788"></a><span id="l44.788" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillasecondemail&quot;))</span>
<a href="#l44.789"></a><span id="l44.789" class="difflineminus">-      aDatabase-&gt;Add2ndEmail(newRow, column.get());</span>
<a href="#l44.790"></a><span id="l44.790" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillasecondemail&quot;))</span>
<a href="#l44.791"></a><span id="l44.791" class="difflineplus">+        aDatabase-&gt;Add2ndEmail(newRow, column.get());</span>
<a href="#l44.792"></a><span id="l44.792"> </span>
<a href="#l44.793"></a><span id="l44.793" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillausehtmlmail&quot;))</span>
<a href="#l44.794"></a><span id="l44.794" class="difflineminus">-    {</span>
<a href="#l44.795"></a><span id="l44.795" class="difflineminus">-      ToLowerCase(column);</span>
<a href="#l44.796"></a><span id="l44.796" class="difflineminus">-      if (-1 != column.Find(&quot;true&quot;))</span>
<a href="#l44.797"></a><span id="l44.797" class="difflineminus">-        aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::html);</span>
<a href="#l44.798"></a><span id="l44.798" class="difflineminus">-      else if (-1 != column.Find(&quot;false&quot;))</span>
<a href="#l44.799"></a><span id="l44.799" class="difflineminus">-        aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::plaintext);</span>
<a href="#l44.800"></a><span id="l44.800" class="difflineminus">-      else</span>
<a href="#l44.801"></a><span id="l44.801" class="difflineminus">-        aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::unknown);</span>
<a href="#l44.802"></a><span id="l44.802" class="difflineminus">-    }</span>
<a href="#l44.803"></a><span id="l44.803" class="difflineminus">-</span>
<a href="#l44.804"></a><span id="l44.804" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillaworkstreet2&quot;))</span>
<a href="#l44.805"></a><span id="l44.805" class="difflineminus">-      aDatabase-&gt;AddWorkAddress2(newRow, column.get());</span>
<a href="#l44.806"></a><span id="l44.806" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillausehtmlmail&quot;)) {</span>
<a href="#l44.807"></a><span id="l44.807" class="difflineplus">+        ToLowerCase(column);</span>
<a href="#l44.808"></a><span id="l44.808" class="difflineplus">+        if (-1 != column.Find(&quot;true&quot;))</span>
<a href="#l44.809"></a><span id="l44.809" class="difflineplus">+          aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::html);</span>
<a href="#l44.810"></a><span id="l44.810" class="difflineplus">+        else if (-1 != column.Find(&quot;false&quot;))</span>
<a href="#l44.811"></a><span id="l44.811" class="difflineplus">+          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l44.812"></a><span id="l44.812" class="difflineplus">+                                         nsIAbPreferMailFormat::plaintext);</span>
<a href="#l44.813"></a><span id="l44.813" class="difflineplus">+        else</span>
<a href="#l44.814"></a><span id="l44.814" class="difflineplus">+          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l44.815"></a><span id="l44.815" class="difflineplus">+                                         nsIAbPreferMailFormat::unknown);</span>
<a href="#l44.816"></a><span id="l44.816" class="difflineplus">+      }</span>
<a href="#l44.817"></a><span id="l44.817"> </span>
<a href="#l44.818"></a><span id="l44.818" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;mozillaworkurl&quot;))</span>
<a href="#l44.819"></a><span id="l44.819" class="difflineminus">-      aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l44.820"></a><span id="l44.820" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillaworkstreet2&quot;))</span>
<a href="#l44.821"></a><span id="l44.821" class="difflineplus">+        aDatabase-&gt;AddWorkAddress2(newRow, column.get());</span>
<a href="#l44.822"></a><span id="l44.822"> </span>
<a href="#l44.823"></a><span id="l44.823" class="difflineminus">-    break; // 'm'</span>
<a href="#l44.824"></a><span id="l44.824" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;mozillaworkurl&quot;))</span>
<a href="#l44.825"></a><span id="l44.825" class="difflineplus">+        aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l44.826"></a><span id="l44.826" class="difflineplus">+</span>
<a href="#l44.827"></a><span id="l44.827" class="difflineplus">+      break;  // 'm'</span>
<a href="#l44.828"></a><span id="l44.828"> </span>
<a href="#l44.829"></a><span id="l44.829" class="difflineminus">-  case 'n':</span>
<a href="#l44.830"></a><span id="l44.830" class="difflineminus">-    if (colType.EqualsLiteral(&quot;notes&quot;))</span>
<a href="#l44.831"></a><span id="l44.831" class="difflineminus">-      aDatabase-&gt;AddNotes(newRow, column.get());</span>
<a href="#l44.832"></a><span id="l44.832" class="difflineplus">+    case 'n':</span>
<a href="#l44.833"></a><span id="l44.833" class="difflineplus">+      if (colType.EqualsLiteral(&quot;notes&quot;))</span>
<a href="#l44.834"></a><span id="l44.834" class="difflineplus">+        aDatabase-&gt;AddNotes(newRow, column.get());</span>
<a href="#l44.835"></a><span id="l44.835"> </span>
<a href="#l44.836"></a><span id="l44.836" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;nscpaimscreenname&quot;) ||</span>
<a href="#l44.837"></a><span id="l44.837" class="difflineminus">-             colType.EqualsLiteral(&quot;nsaimid&quot;))</span>
<a href="#l44.838"></a><span id="l44.838" class="difflineminus">-      aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l44.839"></a><span id="l44.839" class="difflineminus">-</span>
<a href="#l44.840"></a><span id="l44.840" class="difflineminus">-    break; // 'n'</span>
<a href="#l44.841"></a><span id="l44.841" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;nscpaimscreenname&quot;) ||</span>
<a href="#l44.842"></a><span id="l44.842" class="difflineplus">+               colType.EqualsLiteral(&quot;nsaimid&quot;))</span>
<a href="#l44.843"></a><span id="l44.843" class="difflineplus">+        aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l44.844"></a><span id="l44.844"> </span>
<a href="#l44.845"></a><span id="l44.845" class="difflineminus">-  case 'o':</span>
<a href="#l44.846"></a><span id="l44.846" class="difflineminus">-    if (colType.EqualsLiteral(&quot;objectclass&quot;))</span>
<a href="#l44.847"></a><span id="l44.847" class="difflineminus">-      break;</span>
<a href="#l44.848"></a><span id="l44.848" class="difflineplus">+      break;  // 'n'</span>
<a href="#l44.849"></a><span id="l44.849"> </span>
<a href="#l44.850"></a><span id="l44.850" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;ou&quot;) || colType.EqualsLiteral(&quot;orgunit&quot;))</span>
<a href="#l44.851"></a><span id="l44.851" class="difflineminus">-      aDatabase-&gt;AddDepartment(newRow, column.get());</span>
<a href="#l44.852"></a><span id="l44.852" class="difflineminus">-</span>
<a href="#l44.853"></a><span id="l44.853" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;o&quot;)) // organization</span>
<a href="#l44.854"></a><span id="l44.854" class="difflineminus">-      aDatabase-&gt;AddCompany(newRow, column.get());</span>
<a href="#l44.855"></a><span id="l44.855" class="difflineplus">+    case 'o':</span>
<a href="#l44.856"></a><span id="l44.856" class="difflineplus">+      if (colType.EqualsLiteral(&quot;objectclass&quot;))</span>
<a href="#l44.857"></a><span id="l44.857" class="difflineplus">+        break;</span>
<a href="#l44.858"></a><span id="l44.858"> </span>
<a href="#l44.859"></a><span id="l44.859" class="difflineminus">-    break; // 'o'</span>
<a href="#l44.860"></a><span id="l44.860" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;ou&quot;) || colType.EqualsLiteral(&quot;orgunit&quot;))</span>
<a href="#l44.861"></a><span id="l44.861" class="difflineplus">+        aDatabase-&gt;AddDepartment(newRow, column.get());</span>
<a href="#l44.862"></a><span id="l44.862"> </span>
<a href="#l44.863"></a><span id="l44.863" class="difflineminus">-  case 'p':</span>
<a href="#l44.864"></a><span id="l44.864" class="difflineminus">-    if (colType.EqualsLiteral(&quot;postalcode&quot;))</span>
<a href="#l44.865"></a><span id="l44.865" class="difflineminus">-    {</span>
<a href="#l44.866"></a><span id="l44.866" class="difflineminus">-      if (mStoreLocAsHome)</span>
<a href="#l44.867"></a><span id="l44.867" class="difflineminus">-        aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l44.868"></a><span id="l44.868" class="difflineminus">-      else</span>
<a href="#l44.869"></a><span id="l44.869" class="difflineminus">-        aDatabase-&gt;AddWorkZipCode(newRow, column.get());</span>
<a href="#l44.870"></a><span id="l44.870" class="difflineminus">-    }</span>
<a href="#l44.871"></a><span id="l44.871" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;o&quot;))  // organization</span>
<a href="#l44.872"></a><span id="l44.872" class="difflineplus">+        aDatabase-&gt;AddCompany(newRow, column.get());</span>
<a href="#l44.873"></a><span id="l44.873" class="difflineplus">+</span>
<a href="#l44.874"></a><span id="l44.874" class="difflineplus">+      break;  // 'o'</span>
<a href="#l44.875"></a><span id="l44.875"> </span>
<a href="#l44.876"></a><span id="l44.876" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;postofficebox&quot;))</span>
<a href="#l44.877"></a><span id="l44.877" class="difflineminus">-    {</span>
<a href="#l44.878"></a><span id="l44.878" class="difflineminus">-      nsAutoCString workAddr1, workAddr2;</span>
<a href="#l44.879"></a><span id="l44.879" class="difflineminus">-      SplitCRLFAddressField(column, workAddr1, workAddr2);</span>
<a href="#l44.880"></a><span id="l44.880" class="difflineminus">-      aDatabase-&gt;AddWorkAddress(newRow, workAddr1.get());</span>
<a href="#l44.881"></a><span id="l44.881" class="difflineminus">-      aDatabase-&gt;AddWorkAddress2(newRow, workAddr2.get());</span>
<a href="#l44.882"></a><span id="l44.882" class="difflineminus">-    }</span>
<a href="#l44.883"></a><span id="l44.883" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;pager&quot;) || colType.EqualsLiteral(&quot;pagerphone&quot;))</span>
<a href="#l44.884"></a><span id="l44.884" class="difflineminus">-      aDatabase-&gt;AddPagerNumber(newRow, column.get());</span>
<a href="#l44.885"></a><span id="l44.885" class="difflineminus">-</span>
<a href="#l44.886"></a><span id="l44.886" class="difflineminus">-    break; // 'p'</span>
<a href="#l44.887"></a><span id="l44.887" class="difflineplus">+    case 'p':</span>
<a href="#l44.888"></a><span id="l44.888" class="difflineplus">+      if (colType.EqualsLiteral(&quot;postalcode&quot;)) {</span>
<a href="#l44.889"></a><span id="l44.889" class="difflineplus">+        if (mStoreLocAsHome)</span>
<a href="#l44.890"></a><span id="l44.890" class="difflineplus">+          aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l44.891"></a><span id="l44.891" class="difflineplus">+        else</span>
<a href="#l44.892"></a><span id="l44.892" class="difflineplus">+          aDatabase-&gt;AddWorkZipCode(newRow, column.get());</span>
<a href="#l44.893"></a><span id="l44.893" class="difflineplus">+      }</span>
<a href="#l44.894"></a><span id="l44.894"> </span>
<a href="#l44.895"></a><span id="l44.895" class="difflineminus">-  case 'r':</span>
<a href="#l44.896"></a><span id="l44.896" class="difflineminus">-    if (colType.EqualsLiteral(&quot;region&quot;))</span>
<a href="#l44.897"></a><span id="l44.897" class="difflineminus">-    {</span>
<a href="#l44.898"></a><span id="l44.898" class="difflineminus">-      aDatabase-&gt;AddWorkState(newRow, column.get());</span>
<a href="#l44.899"></a><span id="l44.899" class="difflineminus">-    }</span>
<a href="#l44.900"></a><span id="l44.900" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;postofficebox&quot;)) {</span>
<a href="#l44.901"></a><span id="l44.901" class="difflineplus">+        nsAutoCString workAddr1, workAddr2;</span>
<a href="#l44.902"></a><span id="l44.902" class="difflineplus">+        SplitCRLFAddressField(column, workAddr1, workAddr2);</span>
<a href="#l44.903"></a><span id="l44.903" class="difflineplus">+        aDatabase-&gt;AddWorkAddress(newRow, workAddr1.get());</span>
<a href="#l44.904"></a><span id="l44.904" class="difflineplus">+        aDatabase-&gt;AddWorkAddress2(newRow, workAddr2.get());</span>
<a href="#l44.905"></a><span id="l44.905" class="difflineplus">+      } else if (colType.EqualsLiteral(&quot;pager&quot;) ||</span>
<a href="#l44.906"></a><span id="l44.906" class="difflineplus">+                 colType.EqualsLiteral(&quot;pagerphone&quot;))</span>
<a href="#l44.907"></a><span id="l44.907" class="difflineplus">+        aDatabase-&gt;AddPagerNumber(newRow, column.get());</span>
<a href="#l44.908"></a><span id="l44.908"> </span>
<a href="#l44.909"></a><span id="l44.909" class="difflineminus">-    break; // 'r'</span>
<a href="#l44.910"></a><span id="l44.910" class="difflineplus">+      break;  // 'p'</span>
<a href="#l44.911"></a><span id="l44.911"> </span>
<a href="#l44.912"></a><span id="l44.912" class="difflineminus">-  case 's':</span>
<a href="#l44.913"></a><span id="l44.913" class="difflineminus">-    if (colType.EqualsLiteral(&quot;sn&quot;) || colType.EqualsLiteral(&quot;surname&quot;))</span>
<a href="#l44.914"></a><span id="l44.914" class="difflineminus">-      aDatabase-&gt;AddLastName(newRow, column.get());</span>
<a href="#l44.915"></a><span id="l44.915" class="difflineplus">+    case 'r':</span>
<a href="#l44.916"></a><span id="l44.916" class="difflineplus">+      if (colType.EqualsLiteral(&quot;region&quot;)) {</span>
<a href="#l44.917"></a><span id="l44.917" class="difflineplus">+        aDatabase-&gt;AddWorkState(newRow, column.get());</span>
<a href="#l44.918"></a><span id="l44.918" class="difflineplus">+      }</span>
<a href="#l44.919"></a><span id="l44.919" class="difflineplus">+</span>
<a href="#l44.920"></a><span id="l44.920" class="difflineplus">+      break;  // 'r'</span>
<a href="#l44.921"></a><span id="l44.921"> </span>
<a href="#l44.922"></a><span id="l44.922" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;street&quot;))</span>
<a href="#l44.923"></a><span id="l44.923" class="difflineminus">-      aDatabase-&gt;AddWorkAddress(newRow, column.get());</span>
<a href="#l44.924"></a><span id="l44.924" class="difflineplus">+    case 's':</span>
<a href="#l44.925"></a><span id="l44.925" class="difflineplus">+      if (colType.EqualsLiteral(&quot;sn&quot;) || colType.EqualsLiteral(&quot;surname&quot;))</span>
<a href="#l44.926"></a><span id="l44.926" class="difflineplus">+        aDatabase-&gt;AddLastName(newRow, column.get());</span>
<a href="#l44.927"></a><span id="l44.927" class="difflineplus">+</span>
<a href="#l44.928"></a><span id="l44.928" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;street&quot;))</span>
<a href="#l44.929"></a><span id="l44.929" class="difflineplus">+        aDatabase-&gt;AddWorkAddress(newRow, column.get());</span>
<a href="#l44.930"></a><span id="l44.930"> </span>
<a href="#l44.931"></a><span id="l44.931" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;streetaddress&quot;))</span>
<a href="#l44.932"></a><span id="l44.932" class="difflineminus">-    {</span>
<a href="#l44.933"></a><span id="l44.933" class="difflineminus">-      nsAutoCString addr1, addr2;</span>
<a href="#l44.934"></a><span id="l44.934" class="difflineminus">-      SplitCRLFAddressField(column, addr1, addr2);</span>
<a href="#l44.935"></a><span id="l44.935" class="difflineminus">-      if (mStoreLocAsHome)</span>
<a href="#l44.936"></a><span id="l44.936" class="difflineminus">-      {</span>
<a href="#l44.937"></a><span id="l44.937" class="difflineminus">-        aDatabase-&gt;AddHomeAddress(newRow, addr1.get());</span>
<a href="#l44.938"></a><span id="l44.938" class="difflineminus">-        aDatabase-&gt;AddHomeAddress2(newRow, addr2.get());</span>
<a href="#l44.939"></a><span id="l44.939" class="difflineminus">-      }</span>
<a href="#l44.940"></a><span id="l44.940" class="difflineminus">-      else</span>
<a href="#l44.941"></a><span id="l44.941" class="difflineminus">-      {</span>
<a href="#l44.942"></a><span id="l44.942" class="difflineminus">-        aDatabase-&gt;AddWorkAddress(newRow, addr1.get());</span>
<a href="#l44.943"></a><span id="l44.943" class="difflineminus">-        aDatabase-&gt;AddWorkAddress2(newRow, addr2.get());</span>
<a href="#l44.944"></a><span id="l44.944" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;streetaddress&quot;)) {</span>
<a href="#l44.945"></a><span id="l44.945" class="difflineplus">+        nsAutoCString addr1, addr2;</span>
<a href="#l44.946"></a><span id="l44.946" class="difflineplus">+        SplitCRLFAddressField(column, addr1, addr2);</span>
<a href="#l44.947"></a><span id="l44.947" class="difflineplus">+        if (mStoreLocAsHome) {</span>
<a href="#l44.948"></a><span id="l44.948" class="difflineplus">+          aDatabase-&gt;AddHomeAddress(newRow, addr1.get());</span>
<a href="#l44.949"></a><span id="l44.949" class="difflineplus">+          aDatabase-&gt;AddHomeAddress2(newRow, addr2.get());</span>
<a href="#l44.950"></a><span id="l44.950" class="difflineplus">+        } else {</span>
<a href="#l44.951"></a><span id="l44.951" class="difflineplus">+          aDatabase-&gt;AddWorkAddress(newRow, addr1.get());</span>
<a href="#l44.952"></a><span id="l44.952" class="difflineplus">+          aDatabase-&gt;AddWorkAddress2(newRow, addr2.get());</span>
<a href="#l44.953"></a><span id="l44.953" class="difflineplus">+        }</span>
<a href="#l44.954"></a><span id="l44.954" class="difflineplus">+      } else if (colType.EqualsLiteral(&quot;st&quot;)) {</span>
<a href="#l44.955"></a><span id="l44.955" class="difflineplus">+        if (mStoreLocAsHome)</span>
<a href="#l44.956"></a><span id="l44.956" class="difflineplus">+          aDatabase-&gt;AddHomeState(newRow, column.get());</span>
<a href="#l44.957"></a><span id="l44.957" class="difflineplus">+        else</span>
<a href="#l44.958"></a><span id="l44.958" class="difflineplus">+          aDatabase-&gt;AddWorkState(newRow, column.get());</span>
<a href="#l44.959"></a><span id="l44.959">       }</span>
<a href="#l44.960"></a><span id="l44.960" class="difflineminus">-    }</span>
<a href="#l44.961"></a><span id="l44.961" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;st&quot;))</span>
<a href="#l44.962"></a><span id="l44.962" class="difflineminus">-    {</span>
<a href="#l44.963"></a><span id="l44.963" class="difflineminus">-    if (mStoreLocAsHome)</span>
<a href="#l44.964"></a><span id="l44.964" class="difflineminus">-      aDatabase-&gt;AddHomeState(newRow, column.get());</span>
<a href="#l44.965"></a><span id="l44.965" class="difflineminus">-    else</span>
<a href="#l44.966"></a><span id="l44.966" class="difflineminus">-      aDatabase-&gt;AddWorkState(newRow, column.get());</span>
<a href="#l44.967"></a><span id="l44.967" class="difflineminus">-    }</span>
<a href="#l44.968"></a><span id="l44.968" class="difflineplus">+</span>
<a href="#l44.969"></a><span id="l44.969" class="difflineplus">+      break;  // 's'</span>
<a href="#l44.970"></a><span id="l44.970"> </span>
<a href="#l44.971"></a><span id="l44.971" class="difflineminus">-    break; // 's'</span>
<a href="#l44.972"></a><span id="l44.972" class="difflineplus">+    case 't':</span>
<a href="#l44.973"></a><span id="l44.973" class="difflineplus">+      if (colType.EqualsLiteral(&quot;title&quot;))</span>
<a href="#l44.974"></a><span id="l44.974" class="difflineplus">+        aDatabase-&gt;AddJobTitle(newRow, column.get());</span>
<a href="#l44.975"></a><span id="l44.975"> </span>
<a href="#l44.976"></a><span id="l44.976" class="difflineminus">-  case 't':</span>
<a href="#l44.977"></a><span id="l44.977" class="difflineminus">-    if (colType.EqualsLiteral(&quot;title&quot;))</span>
<a href="#l44.978"></a><span id="l44.978" class="difflineminus">-      aDatabase-&gt;AddJobTitle(newRow, column.get());</span>
<a href="#l44.979"></a><span id="l44.979" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;telephonenumber&quot;)) {</span>
<a href="#l44.980"></a><span id="l44.980" class="difflineplus">+        aDatabase-&gt;AddWorkPhone(newRow, column.get());</span>
<a href="#l44.981"></a><span id="l44.981" class="difflineplus">+      }</span>
<a href="#l44.982"></a><span id="l44.982"> </span>
<a href="#l44.983"></a><span id="l44.983" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;telephonenumber&quot;) )</span>
<a href="#l44.984"></a><span id="l44.984" class="difflineminus">-    {</span>
<a href="#l44.985"></a><span id="l44.985" class="difflineminus">-      aDatabase-&gt;AddWorkPhone(newRow, column.get());</span>
<a href="#l44.986"></a><span id="l44.986" class="difflineminus">-    }</span>
<a href="#l44.987"></a><span id="l44.987" class="difflineplus">+      break;  // 't'</span>
<a href="#l44.988"></a><span id="l44.988"> </span>
<a href="#l44.989"></a><span id="l44.989" class="difflineminus">-    break; // 't'</span>
<a href="#l44.990"></a><span id="l44.990" class="difflineplus">+    case 'u':</span>
<a href="#l44.991"></a><span id="l44.991"> </span>
<a href="#l44.992"></a><span id="l44.992" class="difflineminus">-  case 'u':</span>
<a href="#l44.993"></a><span id="l44.993" class="difflineminus">-</span>
<a href="#l44.994"></a><span id="l44.994" class="difflineminus">-    if (colType.EqualsLiteral(&quot;uniquemember&quot;) &amp;&amp; bIsList)</span>
<a href="#l44.995"></a><span id="l44.995" class="difflineminus">-      aDatabase-&gt;AddLdifListMember(newRow, column.get());</span>
<a href="#l44.996"></a><span id="l44.996" class="difflineplus">+      if (colType.EqualsLiteral(&quot;uniquemember&quot;) &amp;&amp; bIsList)</span>
<a href="#l44.997"></a><span id="l44.997" class="difflineplus">+        aDatabase-&gt;AddLdifListMember(newRow, column.get());</span>
<a href="#l44.998"></a><span id="l44.998"> </span>
<a href="#l44.999"></a><span id="l44.999" class="difflineminus">-    break; // 'u'</span>
<a href="#l44.1000"></a><span id="l44.1000" class="difflineplus">+      break;  // 'u'</span>
<a href="#l44.1001"></a><span id="l44.1001"> </span>
<a href="#l44.1002"></a><span id="l44.1002" class="difflineminus">-  case 'w':</span>
<a href="#l44.1003"></a><span id="l44.1003" class="difflineminus">-    if (colType.EqualsLiteral(&quot;workurl&quot;))</span>
<a href="#l44.1004"></a><span id="l44.1004" class="difflineminus">-      aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l44.1005"></a><span id="l44.1005" class="difflineplus">+    case 'w':</span>
<a href="#l44.1006"></a><span id="l44.1006" class="difflineplus">+      if (colType.EqualsLiteral(&quot;workurl&quot;))</span>
<a href="#l44.1007"></a><span id="l44.1007" class="difflineplus">+        aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l44.1008"></a><span id="l44.1008"> </span>
<a href="#l44.1009"></a><span id="l44.1009" class="difflineminus">-    break; // 'w'</span>
<a href="#l44.1010"></a><span id="l44.1010" class="difflineplus">+      break;  // 'w'</span>
<a href="#l44.1011"></a><span id="l44.1011"> </span>
<a href="#l44.1012"></a><span id="l44.1012" class="difflineminus">-  case 'x':</span>
<a href="#l44.1013"></a><span id="l44.1013" class="difflineminus">-    if (colType.EqualsLiteral(&quot;xmozillanickname&quot;))</span>
<a href="#l44.1014"></a><span id="l44.1014" class="difflineminus">-    {</span>
<a href="#l44.1015"></a><span id="l44.1015" class="difflineminus">-      if (bIsList)</span>
<a href="#l44.1016"></a><span id="l44.1016" class="difflineminus">-        aDatabase-&gt;AddListNickName(newRow, column.get());</span>
<a href="#l44.1017"></a><span id="l44.1017" class="difflineminus">-      else</span>
<a href="#l44.1018"></a><span id="l44.1018" class="difflineminus">-        aDatabase-&gt;AddNickName(newRow, column.get());</span>
<a href="#l44.1019"></a><span id="l44.1019" class="difflineminus">-    }</span>
<a href="#l44.1020"></a><span id="l44.1020" class="difflineplus">+    case 'x':</span>
<a href="#l44.1021"></a><span id="l44.1021" class="difflineplus">+      if (colType.EqualsLiteral(&quot;xmozillanickname&quot;)) {</span>
<a href="#l44.1022"></a><span id="l44.1022" class="difflineplus">+        if (bIsList)</span>
<a href="#l44.1023"></a><span id="l44.1023" class="difflineplus">+          aDatabase-&gt;AddListNickName(newRow, column.get());</span>
<a href="#l44.1024"></a><span id="l44.1024" class="difflineplus">+        else</span>
<a href="#l44.1025"></a><span id="l44.1025" class="difflineplus">+          aDatabase-&gt;AddNickName(newRow, column.get());</span>
<a href="#l44.1026"></a><span id="l44.1026" class="difflineplus">+      }</span>
<a href="#l44.1027"></a><span id="l44.1027"> </span>
<a href="#l44.1028"></a><span id="l44.1028" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;xmozillausehtmlmail&quot;))</span>
<a href="#l44.1029"></a><span id="l44.1029" class="difflineminus">-    {</span>
<a href="#l44.1030"></a><span id="l44.1030" class="difflineminus">-      ToLowerCase(column);</span>
<a href="#l44.1031"></a><span id="l44.1031" class="difflineminus">-      if (-1 != column.Find(&quot;true&quot;))</span>
<a href="#l44.1032"></a><span id="l44.1032" class="difflineminus">-        aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::html);</span>
<a href="#l44.1033"></a><span id="l44.1033" class="difflineminus">-      else if (-1 != column.Find(&quot;false&quot;))</span>
<a href="#l44.1034"></a><span id="l44.1034" class="difflineminus">-        aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::plaintext);</span>
<a href="#l44.1035"></a><span id="l44.1035" class="difflineminus">-      else</span>
<a href="#l44.1036"></a><span id="l44.1036" class="difflineminus">-        aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::unknown);</span>
<a href="#l44.1037"></a><span id="l44.1037" class="difflineminus">-    }</span>
<a href="#l44.1038"></a><span id="l44.1038" class="difflineplus">+      else if (colType.EqualsLiteral(&quot;xmozillausehtmlmail&quot;)) {</span>
<a href="#l44.1039"></a><span id="l44.1039" class="difflineplus">+        ToLowerCase(column);</span>
<a href="#l44.1040"></a><span id="l44.1040" class="difflineplus">+        if (-1 != column.Find(&quot;true&quot;))</span>
<a href="#l44.1041"></a><span id="l44.1041" class="difflineplus">+          aDatabase-&gt;AddPreferMailFormat(newRow, nsIAbPreferMailFormat::html);</span>
<a href="#l44.1042"></a><span id="l44.1042" class="difflineplus">+        else if (-1 != column.Find(&quot;false&quot;))</span>
<a href="#l44.1043"></a><span id="l44.1043" class="difflineplus">+          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l44.1044"></a><span id="l44.1044" class="difflineplus">+                                         nsIAbPreferMailFormat::plaintext);</span>
<a href="#l44.1045"></a><span id="l44.1045" class="difflineplus">+        else</span>
<a href="#l44.1046"></a><span id="l44.1046" class="difflineplus">+          aDatabase-&gt;AddPreferMailFormat(newRow,</span>
<a href="#l44.1047"></a><span id="l44.1047" class="difflineplus">+                                         nsIAbPreferMailFormat::unknown);</span>
<a href="#l44.1048"></a><span id="l44.1048" class="difflineplus">+      }</span>
<a href="#l44.1049"></a><span id="l44.1049"> </span>
<a href="#l44.1050"></a><span id="l44.1050" class="difflineminus">-    break; // 'x'</span>
<a href="#l44.1051"></a><span id="l44.1051" class="difflineplus">+      break;  // 'x'</span>
<a href="#l44.1052"></a><span id="l44.1052"> </span>
<a href="#l44.1053"></a><span id="l44.1053" class="difflineminus">-  case 'z':</span>
<a href="#l44.1054"></a><span id="l44.1054" class="difflineminus">-    if (colType.EqualsLiteral(&quot;zip&quot;)) // alias for postalcode</span>
<a href="#l44.1055"></a><span id="l44.1055" class="difflineminus">-    {</span>
<a href="#l44.1056"></a><span id="l44.1056" class="difflineminus">-      if (mStoreLocAsHome)</span>
<a href="#l44.1057"></a><span id="l44.1057" class="difflineminus">-        aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l44.1058"></a><span id="l44.1058" class="difflineminus">-      else</span>
<a href="#l44.1059"></a><span id="l44.1059" class="difflineminus">-        aDatabase-&gt;AddWorkZipCode(newRow, column.get());</span>
<a href="#l44.1060"></a><span id="l44.1060" class="difflineminus">-    }</span>
<a href="#l44.1061"></a><span id="l44.1061" class="difflineplus">+    case 'z':</span>
<a href="#l44.1062"></a><span id="l44.1062" class="difflineplus">+      if (colType.EqualsLiteral(&quot;zip&quot;))  // alias for postalcode</span>
<a href="#l44.1063"></a><span id="l44.1063" class="difflineplus">+      {</span>
<a href="#l44.1064"></a><span id="l44.1064" class="difflineplus">+        if (mStoreLocAsHome)</span>
<a href="#l44.1065"></a><span id="l44.1065" class="difflineplus">+          aDatabase-&gt;AddHomeZipCode(newRow, column.get());</span>
<a href="#l44.1066"></a><span id="l44.1066" class="difflineplus">+        else</span>
<a href="#l44.1067"></a><span id="l44.1067" class="difflineplus">+          aDatabase-&gt;AddWorkZipCode(newRow, column.get());</span>
<a href="#l44.1068"></a><span id="l44.1068" class="difflineplus">+      }</span>
<a href="#l44.1069"></a><span id="l44.1069"> </span>
<a href="#l44.1070"></a><span id="l44.1070" class="difflineminus">-    break; // 'z'</span>
<a href="#l44.1071"></a><span id="l44.1071" class="difflineplus">+      break;  // 'z'</span>
<a href="#l44.1072"></a><span id="l44.1072"> </span>
<a href="#l44.1073"></a><span id="l44.1073" class="difflineminus">-  default:</span>
<a href="#l44.1074"></a><span id="l44.1074" class="difflineminus">-    break; // default</span>
<a href="#l44.1075"></a><span id="l44.1075" class="difflineplus">+    default:</span>
<a href="#l44.1076"></a><span id="l44.1076" class="difflineplus">+      break;  // default</span>
<a href="#l44.1077"></a><span id="l44.1077">   }</span>
<a href="#l44.1078"></a><span id="l44.1078"> }</span>
<a href="#l44.1079"></a><span id="l44.1079"> </span>
<a href="#l44.1080"></a><span id="l44.1080" class="difflineminus">-void nsAbLDIFService::ClearLdifRecordBuffer()</span>
<a href="#l44.1081"></a><span id="l44.1081" class="difflineminus">-{</span>
<a href="#l44.1082"></a><span id="l44.1082" class="difflineminus">-  if (!mLdifLine.IsEmpty())</span>
<a href="#l44.1083"></a><span id="l44.1083" class="difflineminus">-  {</span>
<a href="#l44.1084"></a><span id="l44.1084" class="difflineplus">+void nsAbLDIFService::ClearLdifRecordBuffer() {</span>
<a href="#l44.1085"></a><span id="l44.1085" class="difflineplus">+  if (!mLdifLine.IsEmpty()) {</span>
<a href="#l44.1086"></a><span id="l44.1086">     mLdifLine.Truncate();</span>
<a href="#l44.1087"></a><span id="l44.1087">     mLFCount = 0;</span>
<a href="#l44.1088"></a><span id="l44.1088">     mCRCount = 0;</span>
<a href="#l44.1089"></a><span id="l44.1089">   }</span>
<a href="#l44.1090"></a><span id="l44.1090"> }</span>
<a href="#l44.1091"></a><span id="l44.1091"> </span>
<a href="#l44.1092"></a><span id="l44.1092"> // Some common ldif fields, it an ldif file has NONE of these entries</span>
<a href="#l44.1093"></a><span id="l44.1093"> // then it is most likely NOT an ldif file!</span>
<a href="#l44.1094"></a><span id="l44.1094" class="difflineminus">-static const char *const sLDIFFields[] = {</span>
<a href="#l44.1095"></a><span id="l44.1095" class="difflineminus">-    &quot;objectclass&quot;,</span>
<a href="#l44.1096"></a><span id="l44.1096" class="difflineminus">-    &quot;sn&quot;,</span>
<a href="#l44.1097"></a><span id="l44.1097" class="difflineminus">-    &quot;dn&quot;,</span>
<a href="#l44.1098"></a><span id="l44.1098" class="difflineminus">-    &quot;cn&quot;,</span>
<a href="#l44.1099"></a><span id="l44.1099" class="difflineminus">-    &quot;givenName&quot;,</span>
<a href="#l44.1100"></a><span id="l44.1100" class="difflineminus">-    &quot;mail&quot;,</span>
<a href="#l44.1101"></a><span id="l44.1101" class="difflineminus">-    nullptr</span>
<a href="#l44.1102"></a><span id="l44.1102" class="difflineminus">-};</span>
<a href="#l44.1103"></a><span id="l44.1103" class="difflineminus">-#define kMaxLDIFLen        14</span>
<a href="#l44.1104"></a><span id="l44.1104" class="difflineplus">+static const char *const sLDIFFields[] = {&quot;objectclass&quot;, &quot;sn&quot;,   &quot;dn&quot;,   &quot;cn&quot;,</span>
<a href="#l44.1105"></a><span id="l44.1105" class="difflineplus">+                                          &quot;givenName&quot;,   &quot;mail&quot;, nullptr};</span>
<a href="#l44.1106"></a><span id="l44.1106" class="difflineplus">+#define kMaxLDIFLen 14</span>
<a href="#l44.1107"></a><span id="l44.1107"> </span>
<a href="#l44.1108"></a><span id="l44.1108" class="difflineminus">-// Count total number of legal ldif fields and records in the first 100 lines of the</span>
<a href="#l44.1109"></a><span id="l44.1109" class="difflineminus">-// file and if the average legal ldif field is 3 or higher than it's a valid ldif file.</span>
<a href="#l44.1110"></a><span id="l44.1110" class="difflineminus">-NS_IMETHODIMP nsAbLDIFService::IsLDIFFile(nsIFile *pSrc, bool *_retval)</span>
<a href="#l44.1111"></a><span id="l44.1111" class="difflineminus">-{</span>
<a href="#l44.1112"></a><span id="l44.1112" class="difflineplus">+// Count total number of legal ldif fields and records in the first 100 lines of</span>
<a href="#l44.1113"></a><span id="l44.1113" class="difflineplus">+// the file and if the average legal ldif field is 3 or higher than it's a valid</span>
<a href="#l44.1114"></a><span id="l44.1114" class="difflineplus">+// ldif file.</span>
<a href="#l44.1115"></a><span id="l44.1115" class="difflineplus">+NS_IMETHODIMP nsAbLDIFService::IsLDIFFile(nsIFile *pSrc, bool *_retval) {</span>
<a href="#l44.1116"></a><span id="l44.1116">   NS_ENSURE_ARG_POINTER(pSrc);</span>
<a href="#l44.1117"></a><span id="l44.1117">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l44.1118"></a><span id="l44.1118"> </span>
<a href="#l44.1119"></a><span id="l44.1119">   *_retval = false;</span>
<a href="#l44.1120"></a><span id="l44.1120"> </span>
<a href="#l44.1121"></a><span id="l44.1121">   nsresult rv = NS_OK;</span>
<a href="#l44.1122"></a><span id="l44.1122"> </span>
<a href="#l44.1123"></a><span id="l44.1123">   nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l44.1124"></a><span id="l44.1124">   rv = NS_NewLocalFileInputStream(getter_AddRefs(fileStream), pSrc);</span>
<a href="#l44.1125"></a><span id="l44.1125">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.1126"></a><span id="l44.1126"> </span>
<a href="#l44.1127"></a><span id="l44.1127" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l44.1128"></a><span id="l44.1128" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(</span>
<a href="#l44.1129"></a><span id="l44.1129" class="difflineplus">+      do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l44.1130"></a><span id="l44.1130">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.1131"></a><span id="l44.1131"> </span>
<a href="#l44.1132"></a><span id="l44.1132">   int32_t lineLen = 0;</span>
<a href="#l44.1133"></a><span id="l44.1133">   int32_t lineCount = 0;</span>
<a href="#l44.1134"></a><span id="l44.1134">   int32_t ldifFields = 0;  // total number of legal ldif fields.</span>
<a href="#l44.1135"></a><span id="l44.1135">   char field[kMaxLDIFLen];</span>
<a href="#l44.1136"></a><span id="l44.1136">   int32_t fLen = 0;</span>
<a href="#l44.1137"></a><span id="l44.1137">   const char *pChar;</span>
<a href="#l44.1138"></a><span id="l44.1138">   int32_t recCount = 0;  // total number of records.</span>
<a href="#l44.1139"></a><span id="l44.1139">   int32_t i;</span>
<a href="#l44.1140"></a><span id="l44.1140">   bool gotLDIF = false;</span>
<a href="#l44.1141"></a><span id="l44.1141">   bool more = true;</span>
<a href="#l44.1142"></a><span id="l44.1142">   nsCString line;</span>
<a href="#l44.1143"></a><span id="l44.1143"> </span>
<a href="#l44.1144"></a><span id="l44.1144" class="difflineminus">-  while (more &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; (lineCount &lt; 100))</span>
<a href="#l44.1145"></a><span id="l44.1145" class="difflineminus">-  {</span>
<a href="#l44.1146"></a><span id="l44.1146" class="difflineplus">+  while (more &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; (lineCount &lt; 100)) {</span>
<a href="#l44.1147"></a><span id="l44.1147">     rv = lineInputStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l44.1148"></a><span id="l44.1148"> </span>
<a href="#l44.1149"></a><span id="l44.1149" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; more)</span>
<a href="#l44.1150"></a><span id="l44.1150" class="difflineminus">-    {</span>
<a href="#l44.1151"></a><span id="l44.1151" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; more) {</span>
<a href="#l44.1152"></a><span id="l44.1152">       pChar = line.get();</span>
<a href="#l44.1153"></a><span id="l44.1153">       lineLen = line.Length();</span>
<a href="#l44.1154"></a><span id="l44.1154" class="difflineminus">-      if (!lineLen &amp;&amp; gotLDIF)</span>
<a href="#l44.1155"></a><span id="l44.1155" class="difflineminus">-      {</span>
<a href="#l44.1156"></a><span id="l44.1156" class="difflineplus">+      if (!lineLen &amp;&amp; gotLDIF) {</span>
<a href="#l44.1157"></a><span id="l44.1157">         recCount++;</span>
<a href="#l44.1158"></a><span id="l44.1158">         gotLDIF = false;</span>
<a href="#l44.1159"></a><span id="l44.1159">       }</span>
<a href="#l44.1160"></a><span id="l44.1160"> </span>
<a href="#l44.1161"></a><span id="l44.1161" class="difflineminus">-      if (lineLen &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t'))</span>
<a href="#l44.1162"></a><span id="l44.1162" class="difflineminus">-      {</span>
<a href="#l44.1163"></a><span id="l44.1163" class="difflineplus">+      if (lineLen &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t')) {</span>
<a href="#l44.1164"></a><span id="l44.1164">         fLen = 0;</span>
<a href="#l44.1165"></a><span id="l44.1165"> </span>
<a href="#l44.1166"></a><span id="l44.1166" class="difflineminus">-        while (lineLen &amp;&amp; (fLen &lt; (kMaxLDIFLen - 1)) &amp;&amp; (*pChar != ':'))</span>
<a href="#l44.1167"></a><span id="l44.1167" class="difflineminus">-        {</span>
<a href="#l44.1168"></a><span id="l44.1168" class="difflineplus">+        while (lineLen &amp;&amp; (fLen &lt; (kMaxLDIFLen - 1)) &amp;&amp; (*pChar != ':')) {</span>
<a href="#l44.1169"></a><span id="l44.1169">           field[fLen] = *pChar;</span>
<a href="#l44.1170"></a><span id="l44.1170">           pChar++;</span>
<a href="#l44.1171"></a><span id="l44.1171">           fLen++;</span>
<a href="#l44.1172"></a><span id="l44.1172">           lineLen--;</span>
<a href="#l44.1173"></a><span id="l44.1173">         }</span>
<a href="#l44.1174"></a><span id="l44.1174"> </span>
<a href="#l44.1175"></a><span id="l44.1175">         field[fLen] = 0;</span>
<a href="#l44.1176"></a><span id="l44.1176"> </span>
<a href="#l44.1177"></a><span id="l44.1177" class="difflineminus">-        if (lineLen &amp;&amp; (*pChar == ':') &amp;&amp; (fLen &lt; (kMaxLDIFLen - 1)))</span>
<a href="#l44.1178"></a><span id="l44.1178" class="difflineminus">-        {</span>
<a href="#l44.1179"></a><span id="l44.1179" class="difflineplus">+        if (lineLen &amp;&amp; (*pChar == ':') &amp;&amp; (fLen &lt; (kMaxLDIFLen - 1))) {</span>
<a href="#l44.1180"></a><span id="l44.1180">           // see if this is an ldif field (case insensitive)?</span>
<a href="#l44.1181"></a><span id="l44.1181">           i = 0;</span>
<a href="#l44.1182"></a><span id="l44.1182" class="difflineminus">-          while (sLDIFFields[i])</span>
<a href="#l44.1183"></a><span id="l44.1183" class="difflineminus">-          {</span>
<a href="#l44.1184"></a><span id="l44.1184" class="difflineminus">-            if (!PL_strcasecmp( sLDIFFields[i], field))</span>
<a href="#l44.1185"></a><span id="l44.1185" class="difflineminus">-            {</span>
<a href="#l44.1186"></a><span id="l44.1186" class="difflineplus">+          while (sLDIFFields[i]) {</span>
<a href="#l44.1187"></a><span id="l44.1187" class="difflineplus">+            if (!PL_strcasecmp(sLDIFFields[i], field)) {</span>
<a href="#l44.1188"></a><span id="l44.1188">               ldifFields++;</span>
<a href="#l44.1189"></a><span id="l44.1189">               gotLDIF = true;</span>
<a href="#l44.1190"></a><span id="l44.1190">               break;</span>
<a href="#l44.1191"></a><span id="l44.1191">             }</span>
<a href="#l44.1192"></a><span id="l44.1192">             i++;</span>
<a href="#l44.1193"></a><span id="l44.1193">           }</span>
<a href="#l44.1194"></a><span id="l44.1194">         }</span>
<a href="#l44.1195"></a><span id="l44.1195">       }</span>
<a href="#l44.1196"></a><span id="l44.1196">     }</span>
<a href="#l44.1197"></a><span id="l44.1197">     lineCount++;</span>
<a href="#l44.1198"></a><span id="l44.1198">   }</span>
<a href="#l44.1199"></a><span id="l44.1199"> </span>
<a href="#l44.1200"></a><span id="l44.1200">   // If we just saw ldif address, increment recCount.</span>
<a href="#l44.1201"></a><span id="l44.1201" class="difflineminus">-  if (gotLDIF)</span>
<a href="#l44.1202"></a><span id="l44.1202" class="difflineminus">-    recCount++;</span>
<a href="#l44.1203"></a><span id="l44.1203" class="difflineplus">+  if (gotLDIF) recCount++;</span>
<a href="#l44.1204"></a><span id="l44.1204"> </span>
<a href="#l44.1205"></a><span id="l44.1205">   rv = fileStream-&gt;Close();</span>
<a href="#l44.1206"></a><span id="l44.1206"> </span>
<a href="#l44.1207"></a><span id="l44.1207" class="difflineminus">-  if (recCount &gt; 1)</span>
<a href="#l44.1208"></a><span id="l44.1208" class="difflineminus">-    ldifFields /= recCount;</span>
<a href="#l44.1209"></a><span id="l44.1209" class="difflineplus">+  if (recCount &gt; 1) ldifFields /= recCount;</span>
<a href="#l44.1210"></a><span id="l44.1210"> </span>
<a href="#l44.1211"></a><span id="l44.1211">   // If the average field number &gt;= 3 then it's a good ldif file.</span>
<a href="#l44.1212"></a><span id="l44.1212" class="difflineminus">-  if (ldifFields &gt;= 3)</span>
<a href="#l44.1213"></a><span id="l44.1213" class="difflineminus">-  {</span>
<a href="#l44.1214"></a><span id="l44.1214" class="difflineplus">+  if (ldifFields &gt;= 3) {</span>
<a href="#l44.1215"></a><span id="l44.1215">     *_retval = true;</span>
<a href="#l44.1216"></a><span id="l44.1216">   }</span>
<a href="#l44.1217"></a><span id="l44.1217"> </span>
<a href="#l44.1218"></a><span id="l44.1218">   return rv;</span>
<a href="#l44.1219"></a><span id="l44.1219"> }</span>
<a href="#l44.1220"></a><span id="l44.1220"> </span>
<a href="#l44.1221"></a><span id="l44.1221" class="difflineminus">-void nsAbLDIFService::SplitCRLFAddressField(nsCString &amp;inputAddress, nsCString &amp;outputLine1, nsCString &amp;outputLine2) const</span>
<a href="#l44.1222"></a><span id="l44.1222" class="difflineminus">-{</span>
<a href="#l44.1223"></a><span id="l44.1223" class="difflineplus">+void nsAbLDIFService::SplitCRLFAddressField(nsCString &amp;inputAddress,</span>
<a href="#l44.1224"></a><span id="l44.1224" class="difflineplus">+                                            nsCString &amp;outputLine1,</span>
<a href="#l44.1225"></a><span id="l44.1225" class="difflineplus">+                                            nsCString &amp;outputLine2) const {</span>
<a href="#l44.1226"></a><span id="l44.1226">   int32_t crlfPos = inputAddress.Find(&quot;\r\n&quot;);</span>
<a href="#l44.1227"></a><span id="l44.1227" class="difflineminus">-  if (crlfPos != -1)</span>
<a href="#l44.1228"></a><span id="l44.1228" class="difflineminus">-  {</span>
<a href="#l44.1229"></a><span id="l44.1229" class="difflineplus">+  if (crlfPos != -1) {</span>
<a href="#l44.1230"></a><span id="l44.1230">     outputLine1 = Substring(inputAddress, 0, crlfPos);</span>
<a href="#l44.1231"></a><span id="l44.1231">     outputLine2 = Substring(inputAddress, crlfPos + 2);</span>
<a href="#l44.1232"></a><span id="l44.1232" class="difflineminus">-  }</span>
<a href="#l44.1233"></a><span id="l44.1233" class="difflineminus">-  else</span>
<a href="#l44.1234"></a><span id="l44.1234" class="difflineplus">+  } else</span>
<a href="#l44.1235"></a><span id="l44.1235">     outputLine1.Assign(inputAddress);</span>
<a href="#l44.1236"></a><span id="l44.1236"> }</span>
<a href="#l44.1237"></a><span id="l44.1237" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDIFService.h</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDIFService.h</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -5,33 +5,35 @@</span>
<a href="#l45.4"></a><span id="l45.4"> #ifndef __nsAbLDIFService_h</span>
<a href="#l45.5"></a><span id="l45.5"> #define __nsAbLDIFService_h</span>
<a href="#l45.6"></a><span id="l45.6"> </span>
<a href="#l45.7"></a><span id="l45.7"> #include &quot;nsIAbLDIFService.h&quot;</span>
<a href="#l45.8"></a><span id="l45.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l45.9"></a><span id="l45.9"> </span>
<a href="#l45.10"></a><span id="l45.10"> class nsIMdbRow;</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-class nsAbLDIFService : public nsIAbLDIFService</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-{</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-public:</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+class nsAbLDIFService : public nsIAbLDIFService {</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+ public:</span>
<a href="#l45.17"></a><span id="l45.17">   NS_DECL_ISUPPORTS</span>
<a href="#l45.18"></a><span id="l45.18">   NS_DECL_NSIABLDIFSERVICE</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20">   nsAbLDIFService();</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineminus">-private:</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineplus">+ private:</span>
<a href="#l45.24"></a><span id="l45.24">   virtual ~nsAbLDIFService();</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineminus">-  nsresult        str_parse_line(char *line, char **type, char **value, int *vlen) const;</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineminus">-  char *          str_getline(char **next) const;</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineminus">-  nsresult        GetLdifStringRecord(char* buf, int32_t len, int32_t&amp; stopPos);</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+  nsresult str_parse_line(char *line, char **type, char **value,</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+                          int *vlen) const;</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+  char *str_getline(char **next) const;</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+  nsresult GetLdifStringRecord(char *buf, int32_t len, int32_t &amp;stopPos);</span>
<a href="#l45.32"></a><span id="l45.32">   void AddLdifRowToDatabase(nsIAddrDatabase *aDatabase, bool aIsList);</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineminus">-  void AddLdifColToDatabase(nsIAddrDatabase *aDatabase, nsIMdbRow* newRow,</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineminus">-                            char* typeSlot, char* valueSlot, bool bIsList);</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-  void            ClearLdifRecordBuffer();</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineminus">-  void            SplitCRLFAddressField(nsCString &amp;inputAddress, nsCString &amp;outputLine1, nsCString &amp;outputLine2) const;</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+  void AddLdifColToDatabase(nsIAddrDatabase *aDatabase, nsIMdbRow *newRow,</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+                            char *typeSlot, char *valueSlot, bool bIsList);</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+  void ClearLdifRecordBuffer();</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+  void SplitCRLFAddressField(nsCString &amp;inputAddress, nsCString &amp;outputLine1,</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineplus">+                             nsCString &amp;outputLine2) const;</span>
<a href="#l45.42"></a><span id="l45.42"> </span>
<a href="#l45.43"></a><span id="l45.43" class="difflineminus">-  bool            mStoreLocAsHome;</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineminus">-  nsCString       mLdifLine;</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineminus">-  int32_t         mLFCount;</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineminus">-  int32_t         mCRCount;</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineplus">+  bool mStoreLocAsHome;</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+  nsCString mLdifLine;</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+  int32_t mLFCount;</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+  int32_t mCRCount;</span>
<a href="#l45.51"></a><span id="l45.51"> };</span>
<a href="#l45.52"></a><span id="l45.52"> </span>
<a href="#l45.53"></a><span id="l45.53"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBCard.cpp</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBCard.cpp</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -1,27 +1,22 @@</span>
<a href="#l46.4"></a><span id="l46.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l46.5"></a><span id="l46.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.6"></a><span id="l46.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l46.7"></a><span id="l46.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9"> #include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l46.10"></a><span id="l46.10"> </span>
<a href="#l46.11"></a><span id="l46.11" class="difflineminus">-nsAbMDBCard::nsAbMDBCard(void)</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-{</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-}</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+nsAbMDBCard::nsAbMDBCard(void) {}</span>
<a href="#l46.15"></a><span id="l46.15"> </span>
<a href="#l46.16"></a><span id="l46.16" class="difflineminus">-nsAbMDBCard::~nsAbMDBCard(void)</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineminus">-{</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineminus">-}</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+nsAbMDBCard::~nsAbMDBCard(void) {}</span>
<a href="#l46.20"></a><span id="l46.20"> </span>
<a href="#l46.21"></a><span id="l46.21"> NS_IMPL_ISUPPORTS_INHERITED0(nsAbMDBCard, nsAbCardProperty)</span>
<a href="#l46.22"></a><span id="l46.22"> </span>
<a href="#l46.23"></a><span id="l46.23" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::Equals(nsIAbCard *card, bool *result)</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineminus">-{</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+NS_IMETHODIMP nsAbMDBCard::Equals(nsIAbCard *card, bool *result) {</span>
<a href="#l46.26"></a><span id="l46.26">   NS_ENSURE_ARG_POINTER(card);</span>
<a href="#l46.27"></a><span id="l46.27">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l46.28"></a><span id="l46.28"> </span>
<a href="#l46.29"></a><span id="l46.29">   if (this == card) {</span>
<a href="#l46.30"></a><span id="l46.30">     *result = true;</span>
<a href="#l46.31"></a><span id="l46.31">     return NS_OK;</span>
<a href="#l46.32"></a><span id="l46.32">   }</span>
<a href="#l46.33"></a><span id="l46.33"> </span>
<a href="#l46.34"></a><span id="l46.34" class="difflineat">@@ -35,18 +30,17 @@ NS_IMETHODIMP nsAbMDBCard::Equals(nsIAbC</span>
<a href="#l46.35"></a><span id="l46.35">   // making this call.</span>
<a href="#l46.36"></a><span id="l46.36">   // However, if we make the wrong assumption, one of two things will happen.</span>
<a href="#l46.37"></a><span id="l46.37">   // If the other directory is a local address book, we could return a spurious</span>
<a href="#l46.38"></a><span id="l46.38">   // true result. If not, then DbRowID should be unset and we can definitively</span>
<a href="#l46.39"></a><span id="l46.39">   // return false.</span>
<a href="#l46.40"></a><span id="l46.40"> </span>
<a href="#l46.41"></a><span id="l46.41">   uint32_t row;</span>
<a href="#l46.42"></a><span id="l46.42">   nsresult rv = card-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;row);</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineminus">-  {</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l46.46"></a><span id="l46.46">     *result = false;</span>
<a href="#l46.47"></a><span id="l46.47">     return NS_OK;</span>
<a href="#l46.48"></a><span id="l46.48">   }</span>
<a href="#l46.49"></a><span id="l46.49"> </span>
<a href="#l46.50"></a><span id="l46.50">   uint32_t ourRow;</span>
<a href="#l46.51"></a><span id="l46.51">   rv = GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;ourRow);</span>
<a href="#l46.52"></a><span id="l46.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.53"></a><span id="l46.53"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBCard.h</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBCard.h</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -5,22 +5,21 @@</span>
<a href="#l47.4"></a><span id="l47.4"> </span>
<a href="#l47.5"></a><span id="l47.5"> #ifndef nsAbMDBCard_h__</span>
<a href="#l47.6"></a><span id="l47.6"> #define nsAbMDBCard_h__</span>
<a href="#l47.7"></a><span id="l47.7"> </span>
<a href="#l47.8"></a><span id="l47.8"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l47.9"></a><span id="l47.9"> #include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l47.10"></a><span id="l47.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-class nsAbMDBCard: public nsAbCardProperty</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-{</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-public:</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+class nsAbMDBCard : public nsAbCardProperty {</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+ public:</span>
<a href="#l47.17"></a><span id="l47.17">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l47.18"></a><span id="l47.18"> </span>
<a href="#l47.19"></a><span id="l47.19">   nsAbMDBCard(void);</span>
<a href="#l47.20"></a><span id="l47.20"> </span>
<a href="#l47.21"></a><span id="l47.21">   NS_IMETHOD Equals(nsIAbCard *card, bool *result) override;</span>
<a href="#l47.22"></a><span id="l47.22"> </span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-private:</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineplus">+ private:</span>
<a href="#l47.25"></a><span id="l47.25">   virtual ~nsAbMDBCard();</span>
<a href="#l47.26"></a><span id="l47.26"> };</span>
<a href="#l47.27"></a><span id="l47.27"> </span>
<a href="#l47.28"></a><span id="l47.28"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirFactory.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirFactory.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -14,104 +14,93 @@</span>
<a href="#l48.4"></a><span id="l48.4"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l48.5"></a><span id="l48.5"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l48.6"></a><span id="l48.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l48.7"></a><span id="l48.7"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l48.8"></a><span id="l48.8"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> NS_IMPL_ISUPPORTS(nsAbMDBDirFactory, nsIAbDirFactory)</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-nsAbMDBDirFactory::nsAbMDBDirFactory()</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-{</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-}</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+nsAbMDBDirFactory::nsAbMDBDirFactory() {}</span>
<a href="#l48.16"></a><span id="l48.16"> </span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-nsAbMDBDirFactory::~nsAbMDBDirFactory()</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-{</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineminus">-}</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+nsAbMDBDirFactory::~nsAbMDBDirFactory() {}</span>
<a href="#l48.21"></a><span id="l48.21"> </span>
<a href="#l48.22"></a><span id="l48.22"> NS_IMETHODIMP nsAbMDBDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l48.23"></a><span id="l48.23">                                                 const nsACString &amp;aURI,</span>
<a href="#l48.24"></a><span id="l48.24">                                                 const nsACString &amp;aPrefName,</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineminus">-                                                nsISimpleEnumerator **_retval)</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineminus">-{</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+                                                nsISimpleEnumerator **_retval) {</span>
<a href="#l48.28"></a><span id="l48.28">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l48.29"></a><span id="l48.29"> </span>
<a href="#l48.30"></a><span id="l48.30">   nsresult rv;</span>
<a href="#l48.31"></a><span id="l48.31"> </span>
<a href="#l48.32"></a><span id="l48.32" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l48.35"></a><span id="l48.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.36"></a><span id="l48.36"> </span>
<a href="#l48.37"></a><span id="l48.37">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l48.38"></a><span id="l48.38">   rv = abManager-&gt;GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l48.39"></a><span id="l48.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.40"></a><span id="l48.40"> </span>
<a href="#l48.41"></a><span id="l48.41">   rv = directory-&gt;SetDirPrefId(aPrefName);</span>
<a href="#l48.42"></a><span id="l48.42">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.43"></a><span id="l48.43"> </span>
<a href="#l48.44"></a><span id="l48.44">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l48.45"></a><span id="l48.45">   rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l48.46"></a><span id="l48.46"> </span>
<a href="#l48.47"></a><span id="l48.47">   nsCOMPtr&lt;nsIAddrDatabase&gt; listDatabase;</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-  {</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l48.51"></a><span id="l48.51">     nsAutoCString fileName;</span>
<a href="#l48.52"></a><span id="l48.52"> </span>
<a href="#l48.53"></a><span id="l48.53">     if (StringBeginsWith(aURI, NS_LITERAL_CSTRING(kMDBDirectoryRoot)))</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineminus">-      fileName = Substring(aURI, kMDBDirectoryRootLen, aURI.Length() - kMDBDirectoryRootLen);</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+      fileName = Substring(aURI, kMDBDirectoryRootLen,</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+                           aURI.Length() - kMDBDirectoryRootLen);</span>
<a href="#l48.57"></a><span id="l48.57"> </span>
<a href="#l48.58"></a><span id="l48.58">     rv = dbPath-&gt;AppendNative(fileName);</span>
<a href="#l48.59"></a><span id="l48.59">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.60"></a><span id="l48.60"> </span>
<a href="#l48.61"></a><span id="l48.61" class="difflineminus">-    nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory = do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+    nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+        do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l48.64"></a><span id="l48.64">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.65"></a><span id="l48.65"> </span>
<a href="#l48.66"></a><span id="l48.66">     rv = addrDBFactory-&gt;Open(dbPath, true, true, getter_AddRefs(listDatabase));</span>
<a href="#l48.67"></a><span id="l48.67">   }</span>
<a href="#l48.68"></a><span id="l48.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.69"></a><span id="l48.69"> </span>
<a href="#l48.70"></a><span id="l48.70">   rv = listDatabase-&gt;GetMailingListsFromDB(directory);</span>
<a href="#l48.71"></a><span id="l48.71">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.72"></a><span id="l48.72"> </span>
<a href="#l48.73"></a><span id="l48.73">   return NS_NewSingletonEnumerator(_retval, directory);</span>
<a href="#l48.74"></a><span id="l48.74"> }</span>
<a href="#l48.75"></a><span id="l48.75"> </span>
<a href="#l48.76"></a><span id="l48.76"> /* void deleteDirectory (in nsIAbDirectory directory); */</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirFactory::DeleteDirectory(nsIAbDirectory *directory)</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineminus">-{</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineminus">-    if (!directory)</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirFactory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+  if (!directory) return NS_ERROR_NULL_POINTER;</span>
<a href="#l48.83"></a><span id="l48.83"> </span>
<a href="#l48.84"></a><span id="l48.84" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l48.86"></a><span id="l48.86"> </span>
<a href="#l48.87"></a><span id="l48.87" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineminus">-    rv = directory-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+  rv = directory-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.93"></a><span id="l48.93"> </span>
<a href="#l48.94"></a><span id="l48.94" class="difflineminus">-    uint32_t total;</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineminus">-    rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+  uint32_t total;</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+  rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.100"></a><span id="l48.100"> </span>
<a href="#l48.101"></a><span id="l48.101" class="difflineminus">-    for (uint32_t i = 0; i &lt; total; i++)</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineminus">-    {</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineminus">-        nsCOMPtr&lt;nsIAbDirectory&gt; listDir(do_QueryElementAt(pAddressLists, i, &amp;rv));</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineminus">-            break;</span>
<a href="#l48.106"></a><span id="l48.106" class="difflineplus">+  for (uint32_t i = 0; i &lt; total; i++) {</span>
<a href="#l48.107"></a><span id="l48.107" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; listDir(do_QueryElementAt(pAddressLists, i, &amp;rv));</span>
<a href="#l48.108"></a><span id="l48.108" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l48.109"></a><span id="l48.109"> </span>
<a href="#l48.110"></a><span id="l48.110" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblistDir(do_QueryInterface(listDir, &amp;rv));</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l48.112"></a><span id="l48.112" class="difflineminus">-            break;</span>
<a href="#l48.113"></a><span id="l48.113" class="difflineplus">+    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblistDir(do_QueryInterface(listDir, &amp;rv));</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l48.115"></a><span id="l48.115"> </span>
<a href="#l48.116"></a><span id="l48.116" class="difflineminus">-        rv = directory-&gt;DeleteDirectory(listDir);</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineminus">-            break;</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineplus">+    rv = directory-&gt;DeleteDirectory(listDir);</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l48.121"></a><span id="l48.121"> </span>
<a href="#l48.122"></a><span id="l48.122" class="difflineminus">-        rv = dblistDir-&gt;RemoveElementsFromAddressList();</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineminus">-            break;</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineminus">-    }</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineminus">-    pAddressLists-&gt;Clear();</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineplus">+    rv = dblistDir-&gt;RemoveElementsFromAddressList();</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineplus">+  }</span>
<a href="#l48.130"></a><span id="l48.130" class="difflineplus">+  pAddressLists-&gt;Clear();</span>
<a href="#l48.131"></a><span id="l48.131"> </span>
<a href="#l48.132"></a><span id="l48.132" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l48.135"></a><span id="l48.135" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.136"></a><span id="l48.136"> </span>
<a href="#l48.137"></a><span id="l48.137" class="difflineminus">-    return dbdirectory-&gt;ClearDatabase();</span>
<a href="#l48.138"></a><span id="l48.138" class="difflineplus">+  return dbdirectory-&gt;ClearDatabase();</span>
<a href="#l48.139"></a><span id="l48.139"> }</span>
<a href="#l48.140"></a><span id="l48.140" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirFactory.h</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirFactory.h</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -3,22 +3,20 @@</span>
<a href="#l49.4"></a><span id="l49.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.5"></a><span id="l49.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.6"></a><span id="l49.6"> </span>
<a href="#l49.7"></a><span id="l49.7"> #ifndef nsAbMDBDirFactory_h__</span>
<a href="#l49.8"></a><span id="l49.8"> #define nsAbMDBDirFactory_h__</span>
<a href="#l49.9"></a><span id="l49.9"> </span>
<a href="#l49.10"></a><span id="l49.10"> #include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-class nsAbMDBDirFactory : public nsIAbDirFactory</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-{</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-public:</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+class nsAbMDBDirFactory : public nsIAbDirFactory {</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+ public:</span>
<a href="#l49.17"></a><span id="l49.17">   NS_DECL_ISUPPORTS</span>
<a href="#l49.18"></a><span id="l49.18">   NS_DECL_NSIABDIRFACTORY</span>
<a href="#l49.19"></a><span id="l49.19"> </span>
<a href="#l49.20"></a><span id="l49.20">   nsAbMDBDirFactory();</span>
<a href="#l49.21"></a><span id="l49.21"> </span>
<a href="#l49.22"></a><span id="l49.22" class="difflineminus">-private:</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+ private:</span>
<a href="#l49.24"></a><span id="l49.24">   virtual ~nsAbMDBDirFactory();</span>
<a href="#l49.25"></a><span id="l49.25"> };</span>
<a href="#l49.26"></a><span id="l49.26"> </span>
<a href="#l49.27"></a><span id="l49.27" class="difflineminus">-</span>
<a href="#l49.28"></a><span id="l49.28"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -9,136 +9,113 @@</span>
<a href="#l50.4"></a><span id="l50.4"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l50.5"></a><span id="l50.5"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l50.6"></a><span id="l50.6"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l50.7"></a><span id="l50.7"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l50.8"></a><span id="l50.8"> #include &quot;mdb.h&quot;</span>
<a href="#l50.9"></a><span id="l50.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l50.10"></a><span id="l50.10"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-nsAbMDBDirProperty::nsAbMDBDirProperty(void)</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineminus">-  : nsAbDirProperty()</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-{</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+nsAbMDBDirProperty::nsAbMDBDirProperty(void) : nsAbDirProperty() {</span>
<a href="#l50.16"></a><span id="l50.16">   m_dbRowID = 0;</span>
<a href="#l50.17"></a><span id="l50.17"> }</span>
<a href="#l50.18"></a><span id="l50.18"> </span>
<a href="#l50.19"></a><span id="l50.19" class="difflineminus">-nsAbMDBDirProperty::~nsAbMDBDirProperty(void)</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineminus">-{</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineminus">-}</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+nsAbMDBDirProperty::~nsAbMDBDirProperty(void) {}</span>
<a href="#l50.23"></a><span id="l50.23"> </span>
<a href="#l50.24"></a><span id="l50.24" class="difflineminus">-</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbMDBDirProperty, nsAbDirProperty,</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineminus">-                             nsIAbDirectory,</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineminus">-                             nsISupportsWeakReference, nsIAbMDBDirectory)</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsAbMDBDirProperty, nsAbDirProperty, nsIAbDirectory,</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+                            nsISupportsWeakReference, nsIAbMDBDirectory)</span>
<a href="#l50.30"></a><span id="l50.30"> </span>
<a href="#l50.31"></a><span id="l50.31"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l50.32"></a><span id="l50.32"> </span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-</span>
<a href="#l50.35"></a><span id="l50.35"> // nsIAbMDBDirectory attributes</span>
<a href="#l50.36"></a><span id="l50.36"> </span>
<a href="#l50.37"></a><span id="l50.37" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::GetDbRowID(uint32_t *aDbRowID)</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineminus">-{</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::GetDbRowID(uint32_t *aDbRowID) {</span>
<a href="#l50.40"></a><span id="l50.40">   *aDbRowID = m_dbRowID;</span>
<a href="#l50.41"></a><span id="l50.41">   return NS_OK;</span>
<a href="#l50.42"></a><span id="l50.42"> }</span>
<a href="#l50.43"></a><span id="l50.43"> </span>
<a href="#l50.44"></a><span id="l50.44" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::SetDbRowID(uint32_t aDbRowID)</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineminus">-{</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::SetDbRowID(uint32_t aDbRowID) {</span>
<a href="#l50.47"></a><span id="l50.47">   m_dbRowID = aDbRowID;</span>
<a href="#l50.48"></a><span id="l50.48">   return NS_OK;</span>
<a href="#l50.49"></a><span id="l50.49"> }</span>
<a href="#l50.50"></a><span id="l50.50"> </span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-</span>
<a href="#l50.52"></a><span id="l50.52"> // nsIAbMDBDirectory methods</span>
<a href="#l50.53"></a><span id="l50.53"> </span>
<a href="#l50.54"></a><span id="l50.54"> /* add mailing list to the parent directory */</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::AddMailListToDirectory(nsIAbDirectory *mailList)</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineminus">-{</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-  {</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::AddMailListToDirectory(</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineplus">+    nsIAbDirectory *mailList) {</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l50.62"></a><span id="l50.62">     nsresult rv;</span>
<a href="#l50.63"></a><span id="l50.63">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l50.64"></a><span id="l50.64">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.65"></a><span id="l50.65">   }</span>
<a href="#l50.66"></a><span id="l50.66"> </span>
<a href="#l50.67"></a><span id="l50.67">   uint32_t position;</span>
<a href="#l50.68"></a><span id="l50.68">   if (NS_FAILED(m_AddressList-&gt;IndexOf(0, mailList, &amp;position)))</span>
<a href="#l50.69"></a><span id="l50.69">     m_AddressList-&gt;AppendElement(mailList);</span>
<a href="#l50.70"></a><span id="l50.70"> </span>
<a href="#l50.71"></a><span id="l50.71">   return NS_OK;</span>
<a href="#l50.72"></a><span id="l50.72"> }</span>
<a href="#l50.73"></a><span id="l50.73"> </span>
<a href="#l50.74"></a><span id="l50.74"> /* add addresses to the mailing list */</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::AddAddressToList(nsIAbCard *card)</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineminus">-{</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineminus">-  {</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::AddAddressToList(nsIAbCard *card) {</span>
<a href="#l50.80"></a><span id="l50.80" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l50.81"></a><span id="l50.81">     nsresult rv;</span>
<a href="#l50.82"></a><span id="l50.82">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l50.83"></a><span id="l50.83">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.84"></a><span id="l50.84">   }</span>
<a href="#l50.85"></a><span id="l50.85"> </span>
<a href="#l50.86"></a><span id="l50.86">   uint32_t position;</span>
<a href="#l50.87"></a><span id="l50.87">   if (NS_FAILED(m_AddressList-&gt;IndexOf(0, card, &amp;position)))</span>
<a href="#l50.88"></a><span id="l50.88">     m_AddressList-&gt;AppendElement(card);</span>
<a href="#l50.89"></a><span id="l50.89"> </span>
<a href="#l50.90"></a><span id="l50.90">   return NS_OK;</span>
<a href="#l50.91"></a><span id="l50.91"> }</span>
<a href="#l50.92"></a><span id="l50.92"> </span>
<a href="#l50.93"></a><span id="l50.93" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::CopyDBMailList(nsIAbMDBDirectory* srcListDB)</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineminus">-{</span>
<a href="#l50.95"></a><span id="l50.95" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::CopyDBMailList(nsIAbMDBDirectory *srcListDB) {</span>
<a href="#l50.96"></a><span id="l50.96">   nsresult err = NS_OK;</span>
<a href="#l50.97"></a><span id="l50.97">   nsCOMPtr&lt;nsIAbDirectory&gt; srcList(do_QueryInterface(srcListDB));</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineplus">+  if (NS_FAILED(err)) return NS_ERROR_NULL_POINTER;</span>
<a href="#l50.101"></a><span id="l50.101"> </span>
<a href="#l50.102"></a><span id="l50.102" class="difflineminus">-  CopyMailList (srcList);</span>
<a href="#l50.103"></a><span id="l50.103" class="difflineplus">+  CopyMailList(srcList);</span>
<a href="#l50.104"></a><span id="l50.104"> </span>
<a href="#l50.105"></a><span id="l50.105">   uint32_t rowID;</span>
<a href="#l50.106"></a><span id="l50.106">   srcListDB-&gt;GetDbRowID(&amp;rowID);</span>
<a href="#l50.107"></a><span id="l50.107">   SetDbRowID(rowID);</span>
<a href="#l50.108"></a><span id="l50.108"> </span>
<a href="#l50.109"></a><span id="l50.109">   return NS_OK;</span>
<a href="#l50.110"></a><span id="l50.110"> }</span>
<a href="#l50.111"></a><span id="l50.111"> </span>
<a href="#l50.112"></a><span id="l50.112" class="difflineminus">-</span>
<a href="#l50.113"></a><span id="l50.113"> // nsIAbMDBDirectory NOT IMPLEMENTED methods</span>
<a href="#l50.114"></a><span id="l50.114"> </span>
<a href="#l50.115"></a><span id="l50.115"> /* nsIAbDirectory addDirectory (in string uriName); */</span>
<a href="#l50.116"></a><span id="l50.116" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::AddDirectory(const char *uriName, nsIAbDirectory **_retval)</span>
<a href="#l50.117"></a><span id="l50.117" class="difflineminus">-{</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::AddDirectory(const char *uriName,</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineplus">+                                               nsIAbDirectory **_retval) {</span>
<a href="#l50.121"></a><span id="l50.121" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.122"></a><span id="l50.122"> }</span>
<a href="#l50.123"></a><span id="l50.123"> </span>
<a href="#l50.124"></a><span id="l50.124"> /* [noscript] void removeElementsFromAddressList (); */</span>
<a href="#l50.125"></a><span id="l50.125" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::RemoveElementsFromAddressList()</span>
<a href="#l50.126"></a><span id="l50.126" class="difflineminus">-{</span>
<a href="#l50.127"></a><span id="l50.127" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.128"></a><span id="l50.128" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::RemoveElementsFromAddressList() {</span>
<a href="#l50.129"></a><span id="l50.129" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.130"></a><span id="l50.130"> }</span>
<a href="#l50.131"></a><span id="l50.131"> </span>
<a href="#l50.132"></a><span id="l50.132"> /* void removeEmailAddressAt (in unsigned long aIndex); */</span>
<a href="#l50.133"></a><span id="l50.133" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::RemoveEmailAddressAt(uint32_t aIndex)</span>
<a href="#l50.134"></a><span id="l50.134" class="difflineminus">-{</span>
<a href="#l50.135"></a><span id="l50.135" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.136"></a><span id="l50.136" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::RemoveEmailAddressAt(uint32_t aIndex) {</span>
<a href="#l50.137"></a><span id="l50.137" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.138"></a><span id="l50.138"> }</span>
<a href="#l50.139"></a><span id="l50.139"> </span>
<a href="#l50.140"></a><span id="l50.140"> /* [noscript] void notifyDirItemAdded (in nsISupports item); */</span>
<a href="#l50.141"></a><span id="l50.141" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::NotifyDirItemAdded(nsISupports *item)</span>
<a href="#l50.142"></a><span id="l50.142" class="difflineminus">-{</span>
<a href="#l50.143"></a><span id="l50.143" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.144"></a><span id="l50.144" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::NotifyDirItemAdded(nsISupports *item) {</span>
<a href="#l50.145"></a><span id="l50.145" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.146"></a><span id="l50.146"> }</span>
<a href="#l50.147"></a><span id="l50.147"> </span>
<a href="#l50.148"></a><span id="l50.148"> /* [noscript] void clearDatabase (); */</span>
<a href="#l50.149"></a><span id="l50.149" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::ClearDatabase()</span>
<a href="#l50.150"></a><span id="l50.150" class="difflineminus">-{</span>
<a href="#l50.151"></a><span id="l50.151" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.152"></a><span id="l50.152" class="difflineminus">-}</span>
<a href="#l50.153"></a><span id="l50.153" class="difflineminus">-</span>
<a href="#l50.154"></a><span id="l50.154" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::GetDatabaseFile(nsIFile **aResult)</span>
<a href="#l50.155"></a><span id="l50.155" class="difflineminus">-{</span>
<a href="#l50.156"></a><span id="l50.156" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::ClearDatabase() {</span>
<a href="#l50.157"></a><span id="l50.157">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.158"></a><span id="l50.158"> }</span>
<a href="#l50.159"></a><span id="l50.159"> </span>
<a href="#l50.160"></a><span id="l50.160" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::GetDatabase(nsIAddrDatabase **aResult)</span>
<a href="#l50.161"></a><span id="l50.161" class="difflineminus">-{</span>
<a href="#l50.162"></a><span id="l50.162" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::GetDatabaseFile(nsIFile **aResult) {</span>
<a href="#l50.163"></a><span id="l50.163">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.164"></a><span id="l50.164"> }</span>
<a href="#l50.165"></a><span id="l50.165" class="difflineplus">+</span>
<a href="#l50.166"></a><span id="l50.166" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirProperty::GetDatabase(nsIAddrDatabase **aResult) {</span>
<a href="#l50.167"></a><span id="l50.167" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l50.168"></a><span id="l50.168" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.h</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.h</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -11,27 +11,26 @@</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5"> #ifndef nsAbMDBDirProperty_h__</span>
<a href="#l51.6"></a><span id="l51.6"> #define nsAbMDBDirProperty_h__</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l51.9"></a><span id="l51.9"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l51.10"></a><span id="l51.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">- /*</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-  * Address Book Directory</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-  */</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+/*</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+ * Address Book Directory</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+ */</span>
<a href="#l51.18"></a><span id="l51.18"> </span>
<a href="#l51.19"></a><span id="l51.19" class="difflineminus">-class nsAbMDBDirProperty: public nsIAbMDBDirectory, public nsAbDirProperty</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineminus">-{</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineminus">-public:</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineplus">+class nsAbMDBDirProperty : public nsIAbMDBDirectory, public nsAbDirProperty {</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+ public:</span>
<a href="#l51.24"></a><span id="l51.24">   nsAbMDBDirProperty(void);</span>
<a href="#l51.25"></a><span id="l51.25"> </span>
<a href="#l51.26"></a><span id="l51.26">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l51.27"></a><span id="l51.27">   NS_DECL_NSIABMDBDIRECTORY</span>
<a href="#l51.28"></a><span id="l51.28"> </span>
<a href="#l51.29"></a><span id="l51.29" class="difflineminus">-protected:</span>
<a href="#l51.30"></a><span id="l51.30" class="difflineplus">+ protected:</span>
<a href="#l51.31"></a><span id="l51.31">   virtual ~nsAbMDBDirProperty();</span>
<a href="#l51.32"></a><span id="l51.32"> </span>
<a href="#l51.33"></a><span id="l51.33">   uint32_t m_dbRowID;</span>
<a href="#l51.34"></a><span id="l51.34"> };</span>
<a href="#l51.35"></a><span id="l51.35"> </span>
<a href="#l51.36"></a><span id="l51.36"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -25,95 +25,82 @@</span>
<a href="#l52.4"></a><span id="l52.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l52.5"></a><span id="l52.5"> #include &quot;nsMemory.h&quot;</span>
<a href="#l52.6"></a><span id="l52.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l52.7"></a><span id="l52.7"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l52.8"></a><span id="l52.8"> #include &quot;mozilla/DebugOnly.h&quot;</span>
<a href="#l52.9"></a><span id="l52.9"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l52.10"></a><span id="l52.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-nsAbMDBDirectory::nsAbMDBDirectory(void):</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-     nsAbMDBDirProperty(),</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-     mPerformingQuery(false)</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineminus">-{</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineminus">-}</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+nsAbMDBDirectory::nsAbMDBDirectory(void)</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+    : nsAbMDBDirProperty(), mPerformingQuery(false) {}</span>
<a href="#l52.19"></a><span id="l52.19"> </span>
<a href="#l52.20"></a><span id="l52.20" class="difflineminus">-nsAbMDBDirectory::~nsAbMDBDirectory(void)</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineminus">-{</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineplus">+nsAbMDBDirectory::~nsAbMDBDirectory(void) {</span>
<a href="#l52.23"></a><span id="l52.23">   if (mDatabase) {</span>
<a href="#l52.24"></a><span id="l52.24">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l52.25"></a><span id="l52.25">   }</span>
<a href="#l52.26"></a><span id="l52.26"> }</span>
<a href="#l52.27"></a><span id="l52.27"> </span>
<a href="#l52.28"></a><span id="l52.28"> NS_IMPL_ISUPPORTS_INHERITED(nsAbMDBDirectory, nsAbMDBDirProperty,</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineminus">-                             nsIAbDirSearchListener,</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineminus">-                             nsIAbDirectorySearch,</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineminus">-                             nsIAddrDBListener)</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+                            nsIAbDirSearchListener, nsIAbDirectorySearch,</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+                            nsIAddrDBListener)</span>
<a href="#l52.34"></a><span id="l52.34"> </span>
<a href="#l52.35"></a><span id="l52.35" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::Init(const char *aUri)</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineminus">-{</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::Init(const char *aUri) {</span>
<a href="#l52.38"></a><span id="l52.38">   // We need to ensure  that the m_DirPrefId is initialized properly</span>
<a href="#l52.39"></a><span id="l52.39">   nsDependentCString uri(aUri);</span>
<a href="#l52.40"></a><span id="l52.40"> </span>
<a href="#l52.41"></a><span id="l52.41">   // Find the first ? (of the search params) if there is one.</span>
<a href="#l52.42"></a><span id="l52.42">   // We know we can start at the end of the moz-abmdbdirectory:// because</span>
<a href="#l52.43"></a><span id="l52.43">   // that's the URI we should have been passed.</span>
<a href="#l52.44"></a><span id="l52.44">   int32_t searchCharLocation = uri.FindChar('?', kMDBDirectoryRootLen);</span>
<a href="#l52.45"></a><span id="l52.45">   nsAutoCString URINoQuery;</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineminus">-  if (searchCharLocation != kNotFound)</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineminus">-  {</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineplus">+  if (searchCharLocation != kNotFound) {</span>
<a href="#l52.49"></a><span id="l52.49">     URINoQuery = Substring(uri, 0, searchCharLocation);</span>
<a href="#l52.50"></a><span id="l52.50">   } else {</span>
<a href="#l52.51"></a><span id="l52.51">     URINoQuery.Assign(uri);</span>
<a href="#l52.52"></a><span id="l52.52">   }</span>
<a href="#l52.53"></a><span id="l52.53"> </span>
<a href="#l52.54"></a><span id="l52.54">   // In the non-query part of the URI, check if we are a mailinglist</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-  if (URINoQuery.Find(&quot;MailList&quot;) != kNotFound)</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-    m_IsMailList = true;</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineplus">+  if (URINoQuery.Find(&quot;MailList&quot;) != kNotFound) m_IsMailList = true;</span>
<a href="#l52.58"></a><span id="l52.58"> </span>
<a href="#l52.59"></a><span id="l52.59">   // Mailing lists don't have their own prefs.</span>
<a href="#l52.60"></a><span id="l52.60" class="difflineminus">-  if (m_DirPrefId.IsEmpty() &amp;&amp; !m_IsMailList)</span>
<a href="#l52.61"></a><span id="l52.61" class="difflineminus">-  {</span>
<a href="#l52.62"></a><span id="l52.62" class="difflineplus">+  if (m_DirPrefId.IsEmpty() &amp;&amp; !m_IsMailList) {</span>
<a href="#l52.63"></a><span id="l52.63">     nsAutoCString filename;</span>
<a href="#l52.64"></a><span id="l52.64"> </span>
<a href="#l52.65"></a><span id="l52.65">     // Extract the filename from the uri.</span>
<a href="#l52.66"></a><span id="l52.66">     filename = Substring(URINoQuery, kMDBDirectoryRootLen);</span>
<a href="#l52.67"></a><span id="l52.67"> </span>
<a href="#l52.68"></a><span id="l52.68">     // Get the pref servers and the address book directory branch</span>
<a href="#l52.69"></a><span id="l52.69">     nsresult rv;</span>
<a href="#l52.70"></a><span id="l52.70" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineplus">+    nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l52.73"></a><span id="l52.73">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.74"></a><span id="l52.74"> </span>
<a href="#l52.75"></a><span id="l52.75">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l52.76"></a><span id="l52.76">     rv = prefService-&gt;GetBranch(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;,</span>
<a href="#l52.77"></a><span id="l52.77">                                 getter_AddRefs(prefBranch));</span>
<a href="#l52.78"></a><span id="l52.78">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.79"></a><span id="l52.79"> </span>
<a href="#l52.80"></a><span id="l52.80" class="difflineminus">-    char** childArray;</span>
<a href="#l52.81"></a><span id="l52.81" class="difflineplus">+    char **childArray;</span>
<a href="#l52.82"></a><span id="l52.82">     uint32_t childCount, i;</span>
<a href="#l52.83"></a><span id="l52.83">     int32_t dotOffset;</span>
<a href="#l52.84"></a><span id="l52.84">     nsCString childValue;</span>
<a href="#l52.85"></a><span id="l52.85">     nsDependentCString child;</span>
<a href="#l52.86"></a><span id="l52.86"> </span>
<a href="#l52.87"></a><span id="l52.87">     rv = prefBranch-&gt;GetChildList(&quot;&quot;, &amp;childCount, &amp;childArray);</span>
<a href="#l52.88"></a><span id="l52.88">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.89"></a><span id="l52.89"> </span>
<a href="#l52.90"></a><span id="l52.90" class="difflineminus">-    for (i = 0; i &lt; childCount; ++i)</span>
<a href="#l52.91"></a><span id="l52.91" class="difflineminus">-    {</span>
<a href="#l52.92"></a><span id="l52.92" class="difflineplus">+    for (i = 0; i &lt; childCount; ++i) {</span>
<a href="#l52.93"></a><span id="l52.93">       child.Assign(childArray[i]);</span>
<a href="#l52.94"></a><span id="l52.94"> </span>
<a href="#l52.95"></a><span id="l52.95" class="difflineminus">-      if (StringEndsWith(child, NS_LITERAL_CSTRING(&quot;.filename&quot;)))</span>
<a href="#l52.96"></a><span id="l52.96" class="difflineminus">-      {</span>
<a href="#l52.97"></a><span id="l52.97" class="difflineminus">-        if (NS_SUCCEEDED(prefBranch-&gt;GetCharPref(child.get(), childValue)))</span>
<a href="#l52.98"></a><span id="l52.98" class="difflineminus">-        {</span>
<a href="#l52.99"></a><span id="l52.99" class="difflineminus">-          if (childValue == filename)</span>
<a href="#l52.100"></a><span id="l52.100" class="difflineminus">-          {</span>
<a href="#l52.101"></a><span id="l52.101" class="difflineplus">+      if (StringEndsWith(child, NS_LITERAL_CSTRING(&quot;.filename&quot;))) {</span>
<a href="#l52.102"></a><span id="l52.102" class="difflineplus">+        if (NS_SUCCEEDED(prefBranch-&gt;GetCharPref(child.get(), childValue))) {</span>
<a href="#l52.103"></a><span id="l52.103" class="difflineplus">+          if (childValue == filename) {</span>
<a href="#l52.104"></a><span id="l52.104">             dotOffset = child.RFindChar('.');</span>
<a href="#l52.105"></a><span id="l52.105" class="difflineminus">-            if (dotOffset != -1)</span>
<a href="#l52.106"></a><span id="l52.106" class="difflineminus">-            {</span>
<a href="#l52.107"></a><span id="l52.107" class="difflineplus">+            if (dotOffset != -1) {</span>
<a href="#l52.108"></a><span id="l52.108">               nsAutoCString prefName(StringHead(child, dotOffset));</span>
<a href="#l52.109"></a><span id="l52.109">               m_DirPrefId.AssignLiteral(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;);</span>
<a href="#l52.110"></a><span id="l52.110">               m_DirPrefId.Append(prefName);</span>
<a href="#l52.111"></a><span id="l52.111">             }</span>
<a href="#l52.112"></a><span id="l52.112">           }</span>
<a href="#l52.113"></a><span id="l52.113">         }</span>
<a href="#l52.114"></a><span id="l52.114">       }</span>
<a href="#l52.115"></a><span id="l52.115">     }</span>
<a href="#l52.116"></a><span id="l52.116" class="difflineat">@@ -123,324 +110,292 @@ NS_IMETHODIMP nsAbMDBDirectory::Init(con</span>
<a href="#l52.117"></a><span id="l52.117">                  &quot;Error, Could not set m_DirPrefId in nsAbMDBDirectory::Init&quot;);</span>
<a href="#l52.118"></a><span id="l52.118">   }</span>
<a href="#l52.119"></a><span id="l52.119"> </span>
<a href="#l52.120"></a><span id="l52.120">   return nsAbDirProperty::Init(aUri);</span>
<a href="#l52.121"></a><span id="l52.121"> }</span>
<a href="#l52.122"></a><span id="l52.122"> </span>
<a href="#l52.123"></a><span id="l52.123"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l52.124"></a><span id="l52.124"> </span>
<a href="#l52.125"></a><span id="l52.125" class="difflineminus">-nsresult nsAbMDBDirectory::RemoveCardFromAddressList(nsIAbCard* card)</span>
<a href="#l52.126"></a><span id="l52.126" class="difflineminus">-{</span>
<a href="#l52.127"></a><span id="l52.127" class="difflineplus">+nsresult nsAbMDBDirectory::RemoveCardFromAddressList(nsIAbCard *card) {</span>
<a href="#l52.128"></a><span id="l52.128">   nsresult rv = NS_OK;</span>
<a href="#l52.129"></a><span id="l52.129">   uint32_t listTotal;</span>
<a href="#l52.130"></a><span id="l52.130">   int32_t i, j;</span>
<a href="#l52.131"></a><span id="l52.131"> </span>
<a href="#l52.132"></a><span id="l52.132">   // These checks ensure we don't run into null pointers</span>
<a href="#l52.133"></a><span id="l52.133">   // as we did when we caused bug 280463.</span>
<a href="#l52.134"></a><span id="l52.134" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.135"></a><span id="l52.135" class="difflineminus">-  {</span>
<a href="#l52.136"></a><span id="l52.136" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l52.137"></a><span id="l52.137">     rv = GetAbDatabase();</span>
<a href="#l52.138"></a><span id="l52.138">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.139"></a><span id="l52.139">   }</span>
<a href="#l52.140"></a><span id="l52.140"> </span>
<a href="#l52.141"></a><span id="l52.141" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l52.142"></a><span id="l52.142" class="difflineminus">-  {</span>
<a href="#l52.143"></a><span id="l52.143" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l52.144"></a><span id="l52.144">     rv = mDatabase-&gt;GetMailingListsFromDB(this);</span>
<a href="#l52.145"></a><span id="l52.145">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.146"></a><span id="l52.146"> </span>
<a href="#l52.147"></a><span id="l52.147">     // If the previous call didn't gives us an m_AddressList (and succeeded)</span>
<a href="#l52.148"></a><span id="l52.148">     // then we haven't got any mailing lists to try and remove the card from.</span>
<a href="#l52.149"></a><span id="l52.149">     // So just return without doing anything</span>
<a href="#l52.150"></a><span id="l52.150" class="difflineminus">-    if (!m_AddressList)</span>
<a href="#l52.151"></a><span id="l52.151" class="difflineminus">-      return NS_OK;</span>
<a href="#l52.152"></a><span id="l52.152" class="difflineplus">+    if (!m_AddressList) return NS_OK;</span>
<a href="#l52.153"></a><span id="l52.153">   }</span>
<a href="#l52.154"></a><span id="l52.154"> </span>
<a href="#l52.155"></a><span id="l52.155">   rv = m_AddressList-&gt;GetLength(&amp;listTotal);</span>
<a href="#l52.156"></a><span id="l52.156" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.157"></a><span id="l52.157" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.158"></a><span id="l52.158"> </span>
<a href="#l52.159"></a><span id="l52.159" class="difflineminus">-  for (i = listTotal - 1; i &gt;= 0; i--)</span>
<a href="#l52.160"></a><span id="l52.160" class="difflineminus">-  {</span>
<a href="#l52.161"></a><span id="l52.161" class="difflineplus">+  for (i = listTotal - 1; i &gt;= 0; i--) {</span>
<a href="#l52.162"></a><span id="l52.162">     nsCOMPtr&lt;nsIAbDirectory&gt; listDir(do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l52.163"></a><span id="l52.163" class="difflineminus">-    if (listDir)</span>
<a href="#l52.164"></a><span id="l52.164" class="difflineminus">-    {</span>
<a href="#l52.165"></a><span id="l52.165" class="difflineplus">+    if (listDir) {</span>
<a href="#l52.166"></a><span id="l52.166">       // First remove the instance in the database</span>
<a href="#l52.167"></a><span id="l52.167">       mDatabase-&gt;DeleteCardFromMailList(listDir, card, false);</span>
<a href="#l52.168"></a><span id="l52.168"> </span>
<a href="#l52.169"></a><span id="l52.169">       // Now remove the instance in any lists we hold.</span>
<a href="#l52.170"></a><span id="l52.170">       nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l52.171"></a><span id="l52.171">       listDir-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l52.172"></a><span id="l52.172" class="difflineminus">-      if (pAddressLists)</span>
<a href="#l52.173"></a><span id="l52.173" class="difflineminus">-      {</span>
<a href="#l52.174"></a><span id="l52.174" class="difflineplus">+      if (pAddressLists) {</span>
<a href="#l52.175"></a><span id="l52.175">         uint32_t total;</span>
<a href="#l52.176"></a><span id="l52.176">         rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l52.177"></a><span id="l52.177" class="difflineminus">-        for (j = total - 1; j &gt;= 0; j--)</span>
<a href="#l52.178"></a><span id="l52.178" class="difflineminus">-        {</span>
<a href="#l52.179"></a><span id="l52.179" class="difflineminus">-          nsCOMPtr&lt;nsIAbCard&gt; cardInList(do_QueryElementAt(pAddressLists, j, &amp;rv));</span>
<a href="#l52.180"></a><span id="l52.180" class="difflineplus">+        for (j = total - 1; j &gt;= 0; j--) {</span>
<a href="#l52.181"></a><span id="l52.181" class="difflineplus">+          nsCOMPtr&lt;nsIAbCard&gt; cardInList(</span>
<a href="#l52.182"></a><span id="l52.182" class="difflineplus">+              do_QueryElementAt(pAddressLists, j, &amp;rv));</span>
<a href="#l52.183"></a><span id="l52.183">           bool equals;</span>
<a href="#l52.184"></a><span id="l52.184">           rv = cardInList-&gt;Equals(card, &amp;equals);  // should we checking email?</span>
<a href="#l52.185"></a><span id="l52.185" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; equals)</span>
<a href="#l52.186"></a><span id="l52.186" class="difflineminus">-            pAddressLists-&gt;RemoveElementAt(j);</span>
<a href="#l52.187"></a><span id="l52.187" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; equals) pAddressLists-&gt;RemoveElementAt(j);</span>
<a href="#l52.188"></a><span id="l52.188">         }</span>
<a href="#l52.189"></a><span id="l52.189">       }</span>
<a href="#l52.190"></a><span id="l52.190">     }</span>
<a href="#l52.191"></a><span id="l52.191">   }</span>
<a href="#l52.192"></a><span id="l52.192">   return NS_OK;</span>
<a href="#l52.193"></a><span id="l52.193"> }</span>
<a href="#l52.194"></a><span id="l52.194"> </span>
<a href="#l52.195"></a><span id="l52.195" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::DeleteDirectory(nsIAbDirectory *directory)</span>
<a href="#l52.196"></a><span id="l52.196" class="difflineminus">-{</span>
<a href="#l52.197"></a><span id="l52.197" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l52.198"></a><span id="l52.198">   NS_ENSURE_ARG_POINTER(directory);</span>
<a href="#l52.199"></a><span id="l52.199"> </span>
<a href="#l52.200"></a><span id="l52.200">   nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l52.201"></a><span id="l52.201">   nsresult rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l52.202"></a><span id="l52.202">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.203"></a><span id="l52.203"> </span>
<a href="#l52.204"></a><span id="l52.204">   rv = database-&gt;DeleteMailList(directory, this);</span>
<a href="#l52.205"></a><span id="l52.205"> </span>
<a href="#l52.206"></a><span id="l52.206" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l52.207"></a><span id="l52.207" class="difflineminus">-    database-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.208"></a><span id="l52.208" class="difflineplus">+  if (NS_SUCCEEDED(rv)) database-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.209"></a><span id="l52.209"> </span>
<a href="#l52.210"></a><span id="l52.210">   uint32_t dirIndex;</span>
<a href="#l52.211"></a><span id="l52.211" class="difflineminus">-  if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, directory, &amp;dirIndex)))</span>
<a href="#l52.212"></a><span id="l52.212" class="difflineplus">+  if (m_AddressList &amp;&amp;</span>
<a href="#l52.213"></a><span id="l52.213" class="difflineplus">+      NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, directory, &amp;dirIndex)))</span>
<a href="#l52.214"></a><span id="l52.214">     m_AddressList-&gt;RemoveElementAt(dirIndex);</span>
<a href="#l52.215"></a><span id="l52.215">   // XXX Cast from bool to nsresult</span>
<a href="#l52.216"></a><span id="l52.216">   rv = static_cast&lt;nsresult&gt;(mSubDirectories.RemoveObject(directory));</span>
<a href="#l52.217"></a><span id="l52.217"> </span>
<a href="#l52.218"></a><span id="l52.218">   NotifyItemDeleted(directory);</span>
<a href="#l52.219"></a><span id="l52.219">   return rv;</span>
<a href="#l52.220"></a><span id="l52.220"> }</span>
<a href="#l52.221"></a><span id="l52.221"> </span>
<a href="#l52.222"></a><span id="l52.222" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyItemChanged(nsISupports *item)</span>
<a href="#l52.223"></a><span id="l52.223" class="difflineminus">-{</span>
<a href="#l52.224"></a><span id="l52.224" class="difflineplus">+nsresult nsAbMDBDirectory::NotifyItemChanged(nsISupports *item) {</span>
<a href="#l52.225"></a><span id="l52.225">   nsresult rv;</span>
<a href="#l52.226"></a><span id="l52.226" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.227"></a><span id="l52.227" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.228"></a><span id="l52.228" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.229"></a><span id="l52.229" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.230"></a><span id="l52.230" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.231"></a><span id="l52.231"> </span>
<a href="#l52.232"></a><span id="l52.232">   rv = abManager-&gt;NotifyItemPropertyChanged(item, nullptr, nullptr, nullptr);</span>
<a href="#l52.233"></a><span id="l52.233" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.234"></a><span id="l52.234" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.235"></a><span id="l52.235">   return rv;</span>
<a href="#l52.236"></a><span id="l52.236"> }</span>
<a href="#l52.237"></a><span id="l52.237"> </span>
<a href="#l52.238"></a><span id="l52.238" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyPropertyChanged(nsIAbDirectory *list, const char *property, const char16_t* oldValue, const char16_t* newValue)</span>
<a href="#l52.239"></a><span id="l52.239" class="difflineminus">-{</span>
<a href="#l52.240"></a><span id="l52.240" class="difflineplus">+nsresult nsAbMDBDirectory::NotifyPropertyChanged(nsIAbDirectory *list,</span>
<a href="#l52.241"></a><span id="l52.241" class="difflineplus">+                                                 const char *property,</span>
<a href="#l52.242"></a><span id="l52.242" class="difflineplus">+                                                 const char16_t *oldValue,</span>
<a href="#l52.243"></a><span id="l52.243" class="difflineplus">+                                                 const char16_t *newValue) {</span>
<a href="#l52.244"></a><span id="l52.244">   nsresult rv;</span>
<a href="#l52.245"></a><span id="l52.245">   nsCOMPtr&lt;nsISupports&gt; supports = do_QueryInterface(list, &amp;rv);</span>
<a href="#l52.246"></a><span id="l52.246" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.247"></a><span id="l52.247" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.248"></a><span id="l52.248"> </span>
<a href="#l52.249"></a><span id="l52.249" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.250"></a><span id="l52.250" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.251"></a><span id="l52.251" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.252"></a><span id="l52.252" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.253"></a><span id="l52.253" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.254"></a><span id="l52.254"> </span>
<a href="#l52.255"></a><span id="l52.255" class="difflineminus">-  rv = abManager-&gt;NotifyItemPropertyChanged(supports, property, oldValue, newValue);</span>
<a href="#l52.256"></a><span id="l52.256" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.257"></a><span id="l52.257" class="difflineplus">+  rv = abManager-&gt;NotifyItemPropertyChanged(supports, property, oldValue,</span>
<a href="#l52.258"></a><span id="l52.258" class="difflineplus">+                                            newValue);</span>
<a href="#l52.259"></a><span id="l52.259" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.260"></a><span id="l52.260">   return rv;</span>
<a href="#l52.261"></a><span id="l52.261"> }</span>
<a href="#l52.262"></a><span id="l52.262"> </span>
<a href="#l52.263"></a><span id="l52.263" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyItemAdded(nsISupports *item)</span>
<a href="#l52.264"></a><span id="l52.264" class="difflineminus">-{</span>
<a href="#l52.265"></a><span id="l52.265" class="difflineplus">+nsresult nsAbMDBDirectory::NotifyItemAdded(nsISupports *item) {</span>
<a href="#l52.266"></a><span id="l52.266">   nsresult rv = NS_OK;</span>
<a href="#l52.267"></a><span id="l52.267" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.268"></a><span id="l52.268" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l52.269"></a><span id="l52.269" class="difflineminus">-    abManager-&gt;NotifyDirectoryItemAdded(this, item);</span>
<a href="#l52.270"></a><span id="l52.270" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.271"></a><span id="l52.271" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.272"></a><span id="l52.272" class="difflineplus">+  if (NS_SUCCEEDED(rv)) abManager-&gt;NotifyDirectoryItemAdded(this, item);</span>
<a href="#l52.273"></a><span id="l52.273">   return NS_OK;</span>
<a href="#l52.274"></a><span id="l52.274"> }</span>
<a href="#l52.275"></a><span id="l52.275"> </span>
<a href="#l52.276"></a><span id="l52.276" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyItemDeleted(nsISupports *item)</span>
<a href="#l52.277"></a><span id="l52.277" class="difflineminus">-{</span>
<a href="#l52.278"></a><span id="l52.278" class="difflineplus">+nsresult nsAbMDBDirectory::NotifyItemDeleted(nsISupports *item) {</span>
<a href="#l52.279"></a><span id="l52.279">   nsresult rv = NS_OK;</span>
<a href="#l52.280"></a><span id="l52.280" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.281"></a><span id="l52.281" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l52.282"></a><span id="l52.282" class="difflineminus">-    abManager-&gt;NotifyDirectoryItemDeleted(this, item);</span>
<a href="#l52.283"></a><span id="l52.283" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.284"></a><span id="l52.284" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.285"></a><span id="l52.285" class="difflineplus">+  if (NS_SUCCEEDED(rv)) abManager-&gt;NotifyDirectoryItemDeleted(this, item);</span>
<a href="#l52.286"></a><span id="l52.286"> </span>
<a href="#l52.287"></a><span id="l52.287">   return NS_OK;</span>
<a href="#l52.288"></a><span id="l52.288"> }</span>
<a href="#l52.289"></a><span id="l52.289"> </span>
<a href="#l52.290"></a><span id="l52.290"> // nsIAbMDBDirectory methods</span>
<a href="#l52.291"></a><span id="l52.291"> </span>
<a href="#l52.292"></a><span id="l52.292" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::ClearDatabase()</span>
<a href="#l52.293"></a><span id="l52.293" class="difflineminus">-{</span>
<a href="#l52.294"></a><span id="l52.294" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.295"></a><span id="l52.295" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.296"></a><span id="l52.296" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::ClearDatabase() {</span>
<a href="#l52.297"></a><span id="l52.297" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.298"></a><span id="l52.298"> </span>
<a href="#l52.299"></a><span id="l52.299" class="difflineminus">-  if (mDatabase)</span>
<a href="#l52.300"></a><span id="l52.300" class="difflineminus">-  {</span>
<a href="#l52.301"></a><span id="l52.301" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l52.302"></a><span id="l52.302">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l52.303"></a><span id="l52.303">     mDatabase = nullptr;</span>
<a href="#l52.304"></a><span id="l52.304">   }</span>
<a href="#l52.305"></a><span id="l52.305">   return NS_OK;</span>
<a href="#l52.306"></a><span id="l52.306"> }</span>
<a href="#l52.307"></a><span id="l52.307"> </span>
<a href="#l52.308"></a><span id="l52.308" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::RemoveElementsFromAddressList()</span>
<a href="#l52.309"></a><span id="l52.309" class="difflineminus">-{</span>
<a href="#l52.310"></a><span id="l52.310" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.311"></a><span id="l52.311" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.312"></a><span id="l52.312" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::RemoveElementsFromAddressList() {</span>
<a href="#l52.313"></a><span id="l52.313" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.314"></a><span id="l52.314"> </span>
<a href="#l52.315"></a><span id="l52.315" class="difflineminus">-  if (m_AddressList)</span>
<a href="#l52.316"></a><span id="l52.316" class="difflineminus">-  {</span>
<a href="#l52.317"></a><span id="l52.317" class="difflineplus">+  if (m_AddressList) {</span>
<a href="#l52.318"></a><span id="l52.318">     uint32_t count;</span>
<a href="#l52.319"></a><span id="l52.319">     mozilla::DebugOnly&lt;nsresult&gt; rv = m_AddressList-&gt;GetLength(&amp;count);</span>
<a href="#l52.320"></a><span id="l52.320">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Count failed&quot;);</span>
<a href="#l52.321"></a><span id="l52.321">     int32_t i;</span>
<a href="#l52.322"></a><span id="l52.322" class="difflineminus">-    for (i = count - 1; i &gt;= 0; i--)</span>
<a href="#l52.323"></a><span id="l52.323" class="difflineminus">-      m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l52.324"></a><span id="l52.324" class="difflineplus">+    for (i = count - 1; i &gt;= 0; i--) m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l52.325"></a><span id="l52.325">   }</span>
<a href="#l52.326"></a><span id="l52.326">   m_AddressList = nullptr;</span>
<a href="#l52.327"></a><span id="l52.327">   return NS_OK;</span>
<a href="#l52.328"></a><span id="l52.328"> }</span>
<a href="#l52.329"></a><span id="l52.329"> </span>
<a href="#l52.330"></a><span id="l52.330" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::RemoveEmailAddressAt(uint32_t aIndex)</span>
<a href="#l52.331"></a><span id="l52.331" class="difflineminus">-{</span>
<a href="#l52.332"></a><span id="l52.332" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.333"></a><span id="l52.333" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.334"></a><span id="l52.334" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::RemoveEmailAddressAt(uint32_t aIndex) {</span>
<a href="#l52.335"></a><span id="l52.335" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.336"></a><span id="l52.336"> </span>
<a href="#l52.337"></a><span id="l52.337" class="difflineminus">-  if (m_AddressList)</span>
<a href="#l52.338"></a><span id="l52.338" class="difflineminus">-  {</span>
<a href="#l52.339"></a><span id="l52.339" class="difflineplus">+  if (m_AddressList) {</span>
<a href="#l52.340"></a><span id="l52.340">     return m_AddressList-&gt;RemoveElementAt(aIndex);</span>
<a href="#l52.341"></a><span id="l52.341" class="difflineminus">-  }</span>
<a href="#l52.342"></a><span id="l52.342" class="difflineminus">-  else</span>
<a href="#l52.343"></a><span id="l52.343" class="difflineplus">+  } else</span>
<a href="#l52.344"></a><span id="l52.344">     return NS_ERROR_FAILURE;</span>
<a href="#l52.345"></a><span id="l52.345"> }</span>
<a href="#l52.346"></a><span id="l52.346"> </span>
<a href="#l52.347"></a><span id="l52.347" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::AddDirectory(const char *uriName, nsIAbDirectory **childDir)</span>
<a href="#l52.348"></a><span id="l52.348" class="difflineminus">-{</span>
<a href="#l52.349"></a><span id="l52.349" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.350"></a><span id="l52.350" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.351"></a><span id="l52.351" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::AddDirectory(const char *uriName,</span>
<a href="#l52.352"></a><span id="l52.352" class="difflineplus">+                                             nsIAbDirectory **childDir) {</span>
<a href="#l52.353"></a><span id="l52.353" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.354"></a><span id="l52.354"> </span>
<a href="#l52.355"></a><span id="l52.355" class="difflineminus">-  if (!childDir || !uriName)</span>
<a href="#l52.356"></a><span id="l52.356" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l52.357"></a><span id="l52.357" class="difflineplus">+  if (!childDir || !uriName) return NS_ERROR_NULL_POINTER;</span>
<a href="#l52.358"></a><span id="l52.358"> </span>
<a href="#l52.359"></a><span id="l52.359" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l52.360"></a><span id="l52.360" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.361"></a><span id="l52.361" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.362"></a><span id="l52.362"> </span>
<a href="#l52.363"></a><span id="l52.363">   nsresult rv = NS_OK;</span>
<a href="#l52.364"></a><span id="l52.364" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.365"></a><span id="l52.365" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.366"></a><span id="l52.366" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.367"></a><span id="l52.367">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.368"></a><span id="l52.368"> </span>
<a href="#l52.369"></a><span id="l52.369">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l52.370"></a><span id="l52.370" class="difflineminus">-  rv = abManager-&gt;GetDirectory(nsDependentCString(uriName), getter_AddRefs(directory));</span>
<a href="#l52.371"></a><span id="l52.371" class="difflineplus">+  rv = abManager-&gt;GetDirectory(nsDependentCString(uriName),</span>
<a href="#l52.372"></a><span id="l52.372" class="difflineplus">+                               getter_AddRefs(directory));</span>
<a href="#l52.373"></a><span id="l52.373">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.374"></a><span id="l52.374"> </span>
<a href="#l52.375"></a><span id="l52.375">   if (mSubDirectories.IndexOf(directory) == -1)</span>
<a href="#l52.376"></a><span id="l52.376">     mSubDirectories.AppendObject(directory);</span>
<a href="#l52.377"></a><span id="l52.377">   directory.forget(childDir);</span>
<a href="#l52.378"></a><span id="l52.378">   return rv;</span>
<a href="#l52.379"></a><span id="l52.379"> }</span>
<a href="#l52.380"></a><span id="l52.380"> </span>
<a href="#l52.381"></a><span id="l52.381" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetDatabaseFile(nsIFile **aResult)</span>
<a href="#l52.382"></a><span id="l52.382" class="difflineminus">-{</span>
<a href="#l52.383"></a><span id="l52.383" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::GetDatabaseFile(nsIFile **aResult) {</span>
<a href="#l52.384"></a><span id="l52.384">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l52.385"></a><span id="l52.385"> </span>
<a href="#l52.386"></a><span id="l52.386">   nsCString fileName;</span>
<a href="#l52.387"></a><span id="l52.387">   nsresult rv = GetStringValue(&quot;filename&quot;, EmptyCString(), fileName);</span>
<a href="#l52.388"></a><span id="l52.388">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.389"></a><span id="l52.389"> </span>
<a href="#l52.390"></a><span id="l52.390" class="difflineminus">-  if (fileName.IsEmpty())</span>
<a href="#l52.391"></a><span id="l52.391" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.392"></a><span id="l52.392" class="difflineplus">+  if (fileName.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.393"></a><span id="l52.393"> </span>
<a href="#l52.394"></a><span id="l52.394">   nsCOMPtr&lt;nsIFile&gt; dbFile;</span>
<a href="#l52.395"></a><span id="l52.395">   rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l52.396"></a><span id="l52.396">                               getter_AddRefs(dbFile));</span>
<a href="#l52.397"></a><span id="l52.397">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.398"></a><span id="l52.398"> </span>
<a href="#l52.399"></a><span id="l52.399">   rv = dbFile-&gt;AppendNative(fileName);</span>
<a href="#l52.400"></a><span id="l52.400">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.401"></a><span id="l52.401"> </span>
<a href="#l52.402"></a><span id="l52.402">   dbFile.forget(aResult);</span>
<a href="#l52.403"></a><span id="l52.403"> </span>
<a href="#l52.404"></a><span id="l52.404">   return NS_OK;</span>
<a href="#l52.405"></a><span id="l52.405"> }</span>
<a href="#l52.406"></a><span id="l52.406"> </span>
<a href="#l52.407"></a><span id="l52.407" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetDatabase(nsIAddrDatabase **aResult)</span>
<a href="#l52.408"></a><span id="l52.408" class="difflineminus">-{</span>
<a href="#l52.409"></a><span id="l52.409" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::GetDatabase(nsIAddrDatabase **aResult) {</span>
<a href="#l52.410"></a><span id="l52.410">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l52.411"></a><span id="l52.411"> </span>
<a href="#l52.412"></a><span id="l52.412">   nsresult rv;</span>
<a href="#l52.413"></a><span id="l52.413">   nsCOMPtr&lt;nsIFile&gt; databaseFile;</span>
<a href="#l52.414"></a><span id="l52.414">   rv = GetDatabaseFile(getter_AddRefs(databaseFile));</span>
<a href="#l52.415"></a><span id="l52.415">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.416"></a><span id="l52.416"> </span>
<a href="#l52.417"></a><span id="l52.417">   nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l52.418"></a><span id="l52.418" class="difflineminus">-    do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l52.419"></a><span id="l52.419" class="difflineplus">+      do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l52.420"></a><span id="l52.420">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.421"></a><span id="l52.421"> </span>
<a href="#l52.422"></a><span id="l52.422">   return addrDBFactory-&gt;Open(databaseFile, false /* no create */, true,</span>
<a href="#l52.423"></a><span id="l52.423" class="difflineminus">-                           aResult);</span>
<a href="#l52.424"></a><span id="l52.424" class="difflineplus">+                             aResult);</span>
<a href="#l52.425"></a><span id="l52.425"> }</span>
<a href="#l52.426"></a><span id="l52.426"> </span>
<a href="#l52.427"></a><span id="l52.427"> // nsIAbDirectory methods</span>
<a href="#l52.428"></a><span id="l52.428"> </span>
<a href="#l52.429"></a><span id="l52.429" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l52.430"></a><span id="l52.430" class="difflineminus">-{</span>
<a href="#l52.431"></a><span id="l52.431" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l52.432"></a><span id="l52.432" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.433"></a><span id="l52.433" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::GetURI(nsACString &amp;aURI) {</span>
<a href="#l52.434"></a><span id="l52.434" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.435"></a><span id="l52.435"> </span>
<a href="#l52.436"></a><span id="l52.436">   aURI = mURI;</span>
<a href="#l52.437"></a><span id="l52.437">   return NS_OK;</span>
<a href="#l52.438"></a><span id="l52.438"> }</span>
<a href="#l52.439"></a><span id="l52.439"> </span>
<a href="#l52.440"></a><span id="l52.440" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetChildNodes(nsISimpleEnumerator* *aResult)</span>
<a href="#l52.441"></a><span id="l52.441" class="difflineminus">-{</span>
<a href="#l52.442"></a><span id="l52.442" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.443"></a><span id="l52.443" class="difflineminus">-    return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l52.444"></a><span id="l52.444" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::GetChildNodes(nsISimpleEnumerator **aResult) {</span>
<a href="#l52.445"></a><span id="l52.445" class="difflineplus">+  if (mIsQueryURI) return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l52.446"></a><span id="l52.446"> </span>
<a href="#l52.447"></a><span id="l52.447" class="difflineminus">-  return NS_NewArrayEnumerator(aResult, mSubDirectories, NS_GET_IID(nsIAbDirectory));</span>
<a href="#l52.448"></a><span id="l52.448" class="difflineplus">+  return NS_NewArrayEnumerator(aResult, mSubDirectories,</span>
<a href="#l52.449"></a><span id="l52.449" class="difflineplus">+                               NS_GET_IID(nsIAbDirectory));</span>
<a href="#l52.450"></a><span id="l52.450"> }</span>
<a href="#l52.451"></a><span id="l52.451"> </span>
<a href="#l52.452"></a><span id="l52.452" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetChildCards(nsISimpleEnumerator* *result)</span>
<a href="#l52.453"></a><span id="l52.453" class="difflineminus">-{</span>
<a href="#l52.454"></a><span id="l52.454" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::GetChildCards(nsISimpleEnumerator **result) {</span>
<a href="#l52.455"></a><span id="l52.455">   nsresult rv;</span>
<a href="#l52.456"></a><span id="l52.456"> </span>
<a href="#l52.457"></a><span id="l52.457" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.458"></a><span id="l52.458" class="difflineminus">-  {</span>
<a href="#l52.459"></a><span id="l52.459" class="difflineplus">+  if (mIsQueryURI) {</span>
<a href="#l52.460"></a><span id="l52.460">     rv = StartSearch();</span>
<a href="#l52.461"></a><span id="l52.461">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.462"></a><span id="l52.462"> </span>
<a href="#l52.463"></a><span id="l52.463">     // TODO</span>
<a href="#l52.464"></a><span id="l52.464">     // Search is synchronous so need to return</span>
<a href="#l52.465"></a><span id="l52.465">     // results after search is complete</span>
<a href="#l52.466"></a><span id="l52.466">     nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l52.467"></a><span id="l52.467">     for (auto iter = mSearchCache.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l52.468"></a><span id="l52.468">       array-&gt;AppendElement(iter.Data());</span>
<a href="#l52.469"></a><span id="l52.469">     }</span>
<a href="#l52.470"></a><span id="l52.470">     return NS_NewArrayEnumerator(result, array, NS_GET_IID(nsIAbCard));</span>
<a href="#l52.471"></a><span id="l52.471">   }</span>
<a href="#l52.472"></a><span id="l52.472"> </span>
<a href="#l52.473"></a><span id="l52.473">   rv = GetAbDatabase();</span>
<a href="#l52.474"></a><span id="l52.474"> </span>
<a href="#l52.475"></a><span id="l52.475" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase)</span>
<a href="#l52.476"></a><span id="l52.476" class="difflineminus">-    return rv;</span>
<a href="#l52.477"></a><span id="l52.477" class="difflineplus">+  if (NS_FAILED(rv) || !mDatabase) return rv;</span>
<a href="#l52.478"></a><span id="l52.478"> </span>
<a href="#l52.479"></a><span id="l52.479" class="difflineminus">-  return m_IsMailList ? mDatabase-&gt;EnumerateListAddresses(this, result) :</span>
<a href="#l52.480"></a><span id="l52.480" class="difflineminus">-                        mDatabase-&gt;EnumerateCards(this, result);</span>
<a href="#l52.481"></a><span id="l52.481" class="difflineplus">+  return m_IsMailList ? mDatabase-&gt;EnumerateListAddresses(this, result)</span>
<a href="#l52.482"></a><span id="l52.482" class="difflineplus">+                      : mDatabase-&gt;EnumerateCards(this, result);</span>
<a href="#l52.483"></a><span id="l52.483"> }</span>
<a href="#l52.484"></a><span id="l52.484"> </span>
<a href="#l52.485"></a><span id="l52.485" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetIsQuery(bool *aResult)</span>
<a href="#l52.486"></a><span id="l52.486" class="difflineminus">-{</span>
<a href="#l52.487"></a><span id="l52.487" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::GetIsQuery(bool *aResult) {</span>
<a href="#l52.488"></a><span id="l52.488">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l52.489"></a><span id="l52.489">   *aResult = mIsQueryURI;</span>
<a href="#l52.490"></a><span id="l52.490">   return NS_OK;</span>
<a href="#l52.491"></a><span id="l52.491"> }</span>
<a href="#l52.492"></a><span id="l52.492"> </span>
<a href="#l52.493"></a><span id="l52.493" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::DeleteCards(nsIArray *aCards)</span>
<a href="#l52.494"></a><span id="l52.494" class="difflineminus">-{</span>
<a href="#l52.495"></a><span id="l52.495" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::DeleteCards(nsIArray *aCards) {</span>
<a href="#l52.496"></a><span id="l52.496">   NS_ENSURE_ARG_POINTER(aCards);</span>
<a href="#l52.497"></a><span id="l52.497">   nsresult rv = NS_OK;</span>
<a href="#l52.498"></a><span id="l52.498"> </span>
<a href="#l52.499"></a><span id="l52.499" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.500"></a><span id="l52.500" class="difflineminus">-  {</span>
<a href="#l52.501"></a><span id="l52.501" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l52.502"></a><span id="l52.502">     rv = GetAbDatabase();</span>
<a href="#l52.503"></a><span id="l52.503" class="difflineminus">-    if (NS_FAILED(rv) || !mDatabase)</span>
<a href="#l52.504"></a><span id="l52.504" class="difflineminus">-      return rv;</span>
<a href="#l52.505"></a><span id="l52.505" class="difflineplus">+    if (NS_FAILED(rv) || !mDatabase) return rv;</span>
<a href="#l52.506"></a><span id="l52.506">   }</span>
<a href="#l52.507"></a><span id="l52.507"> </span>
<a href="#l52.508"></a><span id="l52.508">   if (mIsQueryURI) {</span>
<a href="#l52.509"></a><span id="l52.509" class="difflineminus">-    // if this is a query, delete the cards from the directory (without the query)</span>
<a href="#l52.510"></a><span id="l52.510" class="difflineminus">-    // before we do the delete, make this directory (which represents the search)</span>
<a href="#l52.511"></a><span id="l52.511" class="difflineminus">-    // a listener on the database, so that it will get notified when the cards are deleted</span>
<a href="#l52.512"></a><span id="l52.512" class="difflineminus">-    // after delete, remove this query as a listener.</span>
<a href="#l52.513"></a><span id="l52.513" class="difflineplus">+    // if this is a query, delete the cards from the directory (without the</span>
<a href="#l52.514"></a><span id="l52.514" class="difflineplus">+    // query) before we do the delete, make this directory (which represents the</span>
<a href="#l52.515"></a><span id="l52.515" class="difflineplus">+    // search) a listener on the database, so that it will get notified when the</span>
<a href="#l52.516"></a><span id="l52.516" class="difflineplus">+    // cards are deleted after delete, remove this query as a listener.</span>
<a href="#l52.517"></a><span id="l52.517">     nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.518"></a><span id="l52.518">         do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.519"></a><span id="l52.519">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.520"></a><span id="l52.520"> </span>
<a href="#l52.521"></a><span id="l52.521">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l52.522"></a><span id="l52.522">     rv = abManager-&gt;GetDirectory(mURINoQuery, getter_AddRefs(directory));</span>
<a href="#l52.523"></a><span id="l52.523">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.524"></a><span id="l52.524"> </span>
<a href="#l52.525"></a><span id="l52.525" class="difflineat">@@ -449,266 +404,236 @@ NS_IMETHODIMP nsAbMDBDirectory::DeleteCa</span>
<a href="#l52.526"></a><span id="l52.526"> </span>
<a href="#l52.527"></a><span id="l52.527">     return rv;</span>
<a href="#l52.528"></a><span id="l52.528">   }</span>
<a href="#l52.529"></a><span id="l52.529"> </span>
<a href="#l52.530"></a><span id="l52.530">   uint32_t cardCount;</span>
<a href="#l52.531"></a><span id="l52.531">   uint32_t i;</span>
<a href="#l52.532"></a><span id="l52.532">   rv = aCards-&gt;GetLength(&amp;cardCount);</span>
<a href="#l52.533"></a><span id="l52.533">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.534"></a><span id="l52.534" class="difflineminus">-  for (i = 0; i &lt; cardCount; i++)</span>
<a href="#l52.535"></a><span id="l52.535" class="difflineminus">-  {</span>
<a href="#l52.536"></a><span id="l52.536" class="difflineplus">+  for (i = 0; i &lt; cardCount; i++) {</span>
<a href="#l52.537"></a><span id="l52.537">     nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(aCards, i, &amp;rv));</span>
<a href="#l52.538"></a><span id="l52.538">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.539"></a><span id="l52.539"> </span>
<a href="#l52.540"></a><span id="l52.540" class="difflineminus">-    if (card)</span>
<a href="#l52.541"></a><span id="l52.541" class="difflineminus">-    {</span>
<a href="#l52.542"></a><span id="l52.542" class="difflineplus">+    if (card) {</span>
<a href="#l52.543"></a><span id="l52.543">       uint32_t rowID;</span>
<a href="#l52.544"></a><span id="l52.544">       rv = card-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;rowID);</span>
<a href="#l52.545"></a><span id="l52.545">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.546"></a><span id="l52.546"> </span>
<a href="#l52.547"></a><span id="l52.547" class="difflineminus">-      if (m_IsMailList)</span>
<a href="#l52.548"></a><span id="l52.548" class="difflineminus">-      {</span>
<a href="#l52.549"></a><span id="l52.549" class="difflineplus">+      if (m_IsMailList) {</span>
<a href="#l52.550"></a><span id="l52.550">         mDatabase-&gt;DeleteCardFromMailList(this, card, true);</span>
<a href="#l52.551"></a><span id="l52.551"> </span>
<a href="#l52.552"></a><span id="l52.552">         uint32_t cardTotal = 0;</span>
<a href="#l52.553"></a><span id="l52.553">         int32_t i;</span>
<a href="#l52.554"></a><span id="l52.554" class="difflineminus">-        if (m_AddressList)</span>
<a href="#l52.555"></a><span id="l52.555" class="difflineminus">-          rv = m_AddressList-&gt;GetLength(&amp;cardTotal);</span>
<a href="#l52.556"></a><span id="l52.556" class="difflineminus">-        for (i = cardTotal - 1; i &gt;= 0; i--)</span>
<a href="#l52.557"></a><span id="l52.557" class="difflineminus">-        {</span>
<a href="#l52.558"></a><span id="l52.558" class="difflineminus">-          nsCOMPtr&lt;nsIAbCard&gt; arrayCard(do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l52.559"></a><span id="l52.559" class="difflineminus">-          if (arrayCard)</span>
<a href="#l52.560"></a><span id="l52.560" class="difflineminus">-          {</span>
<a href="#l52.561"></a><span id="l52.561" class="difflineplus">+        if (m_AddressList) rv = m_AddressList-&gt;GetLength(&amp;cardTotal);</span>
<a href="#l52.562"></a><span id="l52.562" class="difflineplus">+        for (i = cardTotal - 1; i &gt;= 0; i--) {</span>
<a href="#l52.563"></a><span id="l52.563" class="difflineplus">+          nsCOMPtr&lt;nsIAbCard&gt; arrayCard(</span>
<a href="#l52.564"></a><span id="l52.564" class="difflineplus">+              do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l52.565"></a><span id="l52.565" class="difflineplus">+          if (arrayCard) {</span>
<a href="#l52.566"></a><span id="l52.566">             // No card can have a row ID of 0</span>
<a href="#l52.567"></a><span id="l52.567">             uint32_t arrayRowID = 0;</span>
<a href="#l52.568"></a><span id="l52.568">             arrayCard-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;arrayRowID);</span>
<a href="#l52.569"></a><span id="l52.569" class="difflineminus">-            if (rowID == arrayRowID)</span>
<a href="#l52.570"></a><span id="l52.570" class="difflineminus">-              m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l52.571"></a><span id="l52.571" class="difflineplus">+            if (rowID == arrayRowID) m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l52.572"></a><span id="l52.572">           }</span>
<a href="#l52.573"></a><span id="l52.573">         }</span>
<a href="#l52.574"></a><span id="l52.574" class="difflineminus">-      }</span>
<a href="#l52.575"></a><span id="l52.575" class="difflineminus">-      else</span>
<a href="#l52.576"></a><span id="l52.576" class="difflineminus">-      {</span>
<a href="#l52.577"></a><span id="l52.577" class="difflineplus">+      } else {</span>
<a href="#l52.578"></a><span id="l52.578">         mDatabase-&gt;DeleteCard(card, true, this);</span>
<a href="#l52.579"></a><span id="l52.579">         bool bIsMailList = false;</span>
<a href="#l52.580"></a><span id="l52.580">         card-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l52.581"></a><span id="l52.581" class="difflineminus">-        if (bIsMailList)</span>
<a href="#l52.582"></a><span id="l52.582" class="difflineminus">-        {</span>
<a href="#l52.583"></a><span id="l52.583" class="difflineminus">-          //to do, get mailing list dir side uri and notify nsIAbManager to remove it</span>
<a href="#l52.584"></a><span id="l52.584" class="difflineplus">+        if (bIsMailList) {</span>
<a href="#l52.585"></a><span id="l52.585" class="difflineplus">+          // to do, get mailing list dir side uri and notify nsIAbManager to</span>
<a href="#l52.586"></a><span id="l52.586" class="difflineplus">+          // remove it</span>
<a href="#l52.587"></a><span id="l52.587">           nsAutoCString listUri(mURI);</span>
<a href="#l52.588"></a><span id="l52.588">           listUri.AppendLiteral(&quot;/MailList&quot;);</span>
<a href="#l52.589"></a><span id="l52.589">           listUri.AppendInt(rowID);</span>
<a href="#l52.590"></a><span id="l52.590" class="difflineminus">-          if (!listUri.IsEmpty())</span>
<a href="#l52.591"></a><span id="l52.591" class="difflineminus">-          {</span>
<a href="#l52.592"></a><span id="l52.592" class="difflineplus">+          if (!listUri.IsEmpty()) {</span>
<a href="#l52.593"></a><span id="l52.593">             nsresult rv = NS_OK;</span>
<a href="#l52.594"></a><span id="l52.594"> </span>
<a href="#l52.595"></a><span id="l52.595">             nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.596"></a><span id="l52.596">                 do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.597"></a><span id="l52.597">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.598"></a><span id="l52.598"> </span>
<a href="#l52.599"></a><span id="l52.599">             nsCOMPtr&lt;nsIAbDirectory&gt; listDir;</span>
<a href="#l52.600"></a><span id="l52.600">             rv = abManager-&gt;GetDirectory(listUri, getter_AddRefs(listDir));</span>
<a href="#l52.601"></a><span id="l52.601">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.602"></a><span id="l52.602"> </span>
<a href="#l52.603"></a><span id="l52.603">             uint32_t dirIndex;</span>
<a href="#l52.604"></a><span id="l52.604" class="difflineminus">-            if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, listDir, &amp;dirIndex)))</span>
<a href="#l52.605"></a><span id="l52.605" class="difflineplus">+            if (m_AddressList &amp;&amp;</span>
<a href="#l52.606"></a><span id="l52.606" class="difflineplus">+                NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, listDir, &amp;dirIndex)))</span>
<a href="#l52.607"></a><span id="l52.607">               m_AddressList-&gt;RemoveElementAt(dirIndex);</span>
<a href="#l52.608"></a><span id="l52.608"> </span>
<a href="#l52.609"></a><span id="l52.609">             mSubDirectories.RemoveObject(listDir);</span>
<a href="#l52.610"></a><span id="l52.610"> </span>
<a href="#l52.611"></a><span id="l52.611" class="difflineminus">-            if (listDir)</span>
<a href="#l52.612"></a><span id="l52.612" class="difflineminus">-              NotifyItemDeleted(listDir);</span>
<a href="#l52.613"></a><span id="l52.613" class="difflineplus">+            if (listDir) NotifyItemDeleted(listDir);</span>
<a href="#l52.614"></a><span id="l52.614">           }</span>
<a href="#l52.615"></a><span id="l52.615" class="difflineminus">-        }</span>
<a href="#l52.616"></a><span id="l52.616" class="difflineminus">-        else</span>
<a href="#l52.617"></a><span id="l52.617" class="difflineminus">-        {</span>
<a href="#l52.618"></a><span id="l52.618" class="difflineplus">+        } else {</span>
<a href="#l52.619"></a><span id="l52.619">           rv = RemoveCardFromAddressList(card);</span>
<a href="#l52.620"></a><span id="l52.620" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.621"></a><span id="l52.621" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.622"></a><span id="l52.622">         }</span>
<a href="#l52.623"></a><span id="l52.623">       }</span>
<a href="#l52.624"></a><span id="l52.624">     }</span>
<a href="#l52.625"></a><span id="l52.625">   }</span>
<a href="#l52.626"></a><span id="l52.626">   mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.627"></a><span id="l52.627">   return rv;</span>
<a href="#l52.628"></a><span id="l52.628"> }</span>
<a href="#l52.629"></a><span id="l52.629"> </span>
<a href="#l52.630"></a><span id="l52.630" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::HasCard(nsIAbCard *cards, bool *hasCard)</span>
<a href="#l52.631"></a><span id="l52.631" class="difflineminus">-{</span>
<a href="#l52.632"></a><span id="l52.632" class="difflineminus">-  if(!hasCard)</span>
<a href="#l52.633"></a><span id="l52.633" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l52.634"></a><span id="l52.634" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::HasCard(nsIAbCard *cards, bool *hasCard) {</span>
<a href="#l52.635"></a><span id="l52.635" class="difflineplus">+  if (!hasCard) return NS_ERROR_NULL_POINTER;</span>
<a href="#l52.636"></a><span id="l52.636"> </span>
<a href="#l52.637"></a><span id="l52.637" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.638"></a><span id="l52.638" class="difflineminus">-  {</span>
<a href="#l52.639"></a><span id="l52.639" class="difflineplus">+  if (mIsQueryURI) {</span>
<a href="#l52.640"></a><span id="l52.640">     *hasCard = mSearchCache.Get(cards, nullptr);</span>
<a href="#l52.641"></a><span id="l52.641">     return NS_OK;</span>
<a href="#l52.642"></a><span id="l52.642">   }</span>
<a href="#l52.643"></a><span id="l52.643"> </span>
<a href="#l52.644"></a><span id="l52.644">   nsresult rv = NS_OK;</span>
<a href="#l52.645"></a><span id="l52.645" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.646"></a><span id="l52.646" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l52.647"></a><span id="l52.647" class="difflineplus">+  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l52.648"></a><span id="l52.648"> </span>
<a href="#l52.649"></a><span id="l52.649" class="difflineminus">-  if(NS_SUCCEEDED(rv) &amp;&amp; mDatabase)</span>
<a href="#l52.650"></a><span id="l52.650" class="difflineminus">-  {</span>
<a href="#l52.651"></a><span id="l52.651" class="difflineminus">-    if(NS_SUCCEEDED(rv))</span>
<a href="#l52.652"></a><span id="l52.652" class="difflineminus">-      rv = mDatabase-&gt;ContainsCard(cards, hasCard);</span>
<a href="#l52.653"></a><span id="l52.653" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mDatabase) {</span>
<a href="#l52.654"></a><span id="l52.654" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = mDatabase-&gt;ContainsCard(cards, hasCard);</span>
<a href="#l52.655"></a><span id="l52.655">   }</span>
<a href="#l52.656"></a><span id="l52.656">   return rv;</span>
<a href="#l52.657"></a><span id="l52.657"> }</span>
<a href="#l52.658"></a><span id="l52.658"> </span>
<a href="#l52.659"></a><span id="l52.659" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::HasDirectory(nsIAbDirectory *dir, bool *hasDir)</span>
<a href="#l52.660"></a><span id="l52.660" class="difflineminus">-{</span>
<a href="#l52.661"></a><span id="l52.661" class="difflineminus">-  if (!hasDir)</span>
<a href="#l52.662"></a><span id="l52.662" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l52.663"></a><span id="l52.663" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::HasDirectory(nsIAbDirectory *dir,</span>
<a href="#l52.664"></a><span id="l52.664" class="difflineplus">+                                             bool *hasDir) {</span>
<a href="#l52.665"></a><span id="l52.665" class="difflineplus">+  if (!hasDir) return NS_ERROR_NULL_POINTER;</span>
<a href="#l52.666"></a><span id="l52.666"> </span>
<a href="#l52.667"></a><span id="l52.667">   nsresult rv;</span>
<a href="#l52.668"></a><span id="l52.668"> </span>
<a href="#l52.669"></a><span id="l52.669">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdir(do_QueryInterface(dir, &amp;rv));</span>
<a href="#l52.670"></a><span id="l52.670">   mozilla::Unused &lt;&lt; dbdir;</span>
<a href="#l52.671"></a><span id="l52.671">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.672"></a><span id="l52.672"> </span>
<a href="#l52.673"></a><span id="l52.673" class="difflineminus">-  bool bIsMailingList  = false;</span>
<a href="#l52.674"></a><span id="l52.674" class="difflineplus">+  bool bIsMailingList = false;</span>
<a href="#l52.675"></a><span id="l52.675">   dir-&gt;GetIsMailList(&amp;bIsMailingList);</span>
<a href="#l52.676"></a><span id="l52.676" class="difflineminus">-  if (bIsMailingList)</span>
<a href="#l52.677"></a><span id="l52.677" class="difflineminus">-  {</span>
<a href="#l52.678"></a><span id="l52.678" class="difflineplus">+  if (bIsMailingList) {</span>
<a href="#l52.679"></a><span id="l52.679">     nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l52.680"></a><span id="l52.680">     rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l52.681"></a><span id="l52.681"> </span>
<a href="#l52.682"></a><span id="l52.682" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l52.683"></a><span id="l52.683" class="difflineminus">-      rv = database-&gt;ContainsMailList(dir, hasDir);</span>
<a href="#l52.684"></a><span id="l52.684" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = database-&gt;ContainsMailList(dir, hasDir);</span>
<a href="#l52.685"></a><span id="l52.685">   }</span>
<a href="#l52.686"></a><span id="l52.686"> </span>
<a href="#l52.687"></a><span id="l52.687">   return rv;</span>
<a href="#l52.688"></a><span id="l52.688"> }</span>
<a href="#l52.689"></a><span id="l52.689"> </span>
<a href="#l52.690"></a><span id="l52.690" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::HasMailListWithName(const char16_t *aName, bool *aHasList)</span>
<a href="#l52.691"></a><span id="l52.691" class="difflineminus">-{</span>
<a href="#l52.692"></a><span id="l52.692" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::HasMailListWithName(const char16_t *aName,</span>
<a href="#l52.693"></a><span id="l52.693" class="difflineplus">+                                                    bool *aHasList) {</span>
<a href="#l52.694"></a><span id="l52.694">   NS_ENSURE_ARG_POINTER(aHasList);</span>
<a href="#l52.695"></a><span id="l52.695"> </span>
<a href="#l52.696"></a><span id="l52.696">   nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l52.697"></a><span id="l52.697">   nsresult rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l52.698"></a><span id="l52.698" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l52.699"></a><span id="l52.699" class="difflineminus">-  {</span>
<a href="#l52.700"></a><span id="l52.700" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l52.701"></a><span id="l52.701">     rv = database-&gt;FindMailListbyUnicodeName(aName, aHasList);</span>
<a href="#l52.702"></a><span id="l52.702" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *aHasList)</span>
<a href="#l52.703"></a><span id="l52.703" class="difflineminus">-      return NS_OK;</span>
<a href="#l52.704"></a><span id="l52.704" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; *aHasList) return NS_OK;</span>
<a href="#l52.705"></a><span id="l52.705">   }</span>
<a href="#l52.706"></a><span id="l52.706"> </span>
<a href="#l52.707"></a><span id="l52.707">   return rv;</span>
<a href="#l52.708"></a><span id="l52.708"> }</span>
<a href="#l52.709"></a><span id="l52.709"> </span>
<a href="#l52.710"></a><span id="l52.710" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::AddMailList(nsIAbDirectory *list, nsIAbDirectory **addedList)</span>
<a href="#l52.711"></a><span id="l52.711" class="difflineminus">-{</span>
<a href="#l52.712"></a><span id="l52.712" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::AddMailList(nsIAbDirectory *list,</span>
<a href="#l52.713"></a><span id="l52.713" class="difflineplus">+                                            nsIAbDirectory **addedList) {</span>
<a href="#l52.714"></a><span id="l52.714">   NS_ENSURE_ARG_POINTER(addedList);</span>
<a href="#l52.715"></a><span id="l52.715"> </span>
<a href="#l52.716"></a><span id="l52.716" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.717"></a><span id="l52.717" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.718"></a><span id="l52.718" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.719"></a><span id="l52.719"> </span>
<a href="#l52.720"></a><span id="l52.720">   nsresult rv = NS_OK;</span>
<a href="#l52.721"></a><span id="l52.721" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.722"></a><span id="l52.722" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l52.723"></a><span id="l52.723" class="difflineplus">+  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l52.724"></a><span id="l52.724"> </span>
<a href="#l52.725"></a><span id="l52.725" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase)</span>
<a href="#l52.726"></a><span id="l52.726" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l52.727"></a><span id="l52.727" class="difflineplus">+  if (NS_FAILED(rv) || !mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l52.728"></a><span id="l52.728"> </span>
<a href="#l52.729"></a><span id="l52.729">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list, &amp;rv));</span>
<a href="#l52.730"></a><span id="l52.730" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l52.731"></a><span id="l52.731" class="difflineminus">-  {</span>
<a href="#l52.732"></a><span id="l52.732" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l52.733"></a><span id="l52.733">     nsCOMPtr&lt;nsIAbDirectory&gt; newlist(new nsAbMDBDirProperty);</span>
<a href="#l52.734"></a><span id="l52.734" class="difflineminus">-    if (!newlist)</span>
<a href="#l52.735"></a><span id="l52.735" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l52.736"></a><span id="l52.736" class="difflineplus">+    if (!newlist) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l52.737"></a><span id="l52.737"> </span>
<a href="#l52.738"></a><span id="l52.738">     rv = newlist-&gt;CopyMailList(list);</span>
<a href="#l52.739"></a><span id="l52.739">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.740"></a><span id="l52.740"> </span>
<a href="#l52.741"></a><span id="l52.741">     dblist = do_QueryInterface(newlist, &amp;rv);</span>
<a href="#l52.742"></a><span id="l52.742">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.743"></a><span id="l52.743"> </span>
<a href="#l52.744"></a><span id="l52.744">     mDatabase-&gt;CreateMailListAndAddToDB(newlist, true, this);</span>
<a href="#l52.745"></a><span id="l52.745" class="difflineminus">-  }</span>
<a href="#l52.746"></a><span id="l52.746" class="difflineminus">-  else</span>
<a href="#l52.747"></a><span id="l52.747" class="difflineplus">+  } else</span>
<a href="#l52.748"></a><span id="l52.748">     mDatabase-&gt;CreateMailListAndAddToDB(list, true, this);</span>
<a href="#l52.749"></a><span id="l52.749"> </span>
<a href="#l52.750"></a><span id="l52.750">   mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.751"></a><span id="l52.751"> </span>
<a href="#l52.752"></a><span id="l52.752">   uint32_t dbRowID;</span>
<a href="#l52.753"></a><span id="l52.753">   dblist-&gt;GetDbRowID(&amp;dbRowID);</span>
<a href="#l52.754"></a><span id="l52.754"> </span>
<a href="#l52.755"></a><span id="l52.755">   nsAutoCString listUri(mURI);</span>
<a href="#l52.756"></a><span id="l52.756">   listUri.AppendLiteral(&quot;/MailList&quot;);</span>
<a href="#l52.757"></a><span id="l52.757">   listUri.AppendInt(dbRowID);</span>
<a href="#l52.758"></a><span id="l52.758"> </span>
<a href="#l52.759"></a><span id="l52.759">   nsCOMPtr&lt;nsIAbDirectory&gt; newList;</span>
<a href="#l52.760"></a><span id="l52.760">   rv = AddDirectory(listUri.get(), getter_AddRefs(newList));</span>
<a href="#l52.761"></a><span id="l52.761" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; newList)</span>
<a href="#l52.762"></a><span id="l52.762" class="difflineminus">-  {</span>
<a href="#l52.763"></a><span id="l52.763" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; newList) {</span>
<a href="#l52.764"></a><span id="l52.764">     nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbnewList(do_QueryInterface(newList, &amp;rv));</span>
<a href="#l52.765"></a><span id="l52.765">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.766"></a><span id="l52.766"> </span>
<a href="#l52.767"></a><span id="l52.767">     dbnewList-&gt;CopyDBMailList(dblist);</span>
<a href="#l52.768"></a><span id="l52.768">     AddMailListToDirectory(newList);</span>
<a href="#l52.769"></a><span id="l52.769">     NotifyItemAdded(newList);</span>
<a href="#l52.770"></a><span id="l52.770">   }</span>
<a href="#l52.771"></a><span id="l52.771"> </span>
<a href="#l52.772"></a><span id="l52.772">   newList.forget(addedList);</span>
<a href="#l52.773"></a><span id="l52.773">   return rv;</span>
<a href="#l52.774"></a><span id="l52.774"> }</span>
<a href="#l52.775"></a><span id="l52.775"> </span>
<a href="#l52.776"></a><span id="l52.776" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::AddCard(nsIAbCard* card, nsIAbCard **addedCard)</span>
<a href="#l52.777"></a><span id="l52.777" class="difflineminus">-{</span>
<a href="#l52.778"></a><span id="l52.778" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.779"></a><span id="l52.779" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.780"></a><span id="l52.780" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::AddCard(nsIAbCard *card,</span>
<a href="#l52.781"></a><span id="l52.781" class="difflineplus">+                                        nsIAbCard **addedCard) {</span>
<a href="#l52.782"></a><span id="l52.782" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.783"></a><span id="l52.783"> </span>
<a href="#l52.784"></a><span id="l52.784">   nsresult rv = NS_OK;</span>
<a href="#l52.785"></a><span id="l52.785" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.786"></a><span id="l52.786" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l52.787"></a><span id="l52.787" class="difflineplus">+  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l52.788"></a><span id="l52.788"> </span>
<a href="#l52.789"></a><span id="l52.789" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase)</span>
<a href="#l52.790"></a><span id="l52.790" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l52.791"></a><span id="l52.791" class="difflineplus">+  if (NS_FAILED(rv) || !mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l52.792"></a><span id="l52.792"> </span>
<a href="#l52.793"></a><span id="l52.793">   if (m_IsMailList) {</span>
<a href="#l52.794"></a><span id="l52.794" class="difflineminus">-    rv = mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, card, true /* notify */);</span>
<a href="#l52.795"></a><span id="l52.795" class="difflineplus">+    rv = mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, card,</span>
<a href="#l52.796"></a><span id="l52.796" class="difflineplus">+                                                true /* notify */);</span>
<a href="#l52.797"></a><span id="l52.797">   } else {</span>
<a href="#l52.798"></a><span id="l52.798">     rv = mDatabase-&gt;CreateNewCardAndAddToDB(card, true, this);</span>
<a href="#l52.799"></a><span id="l52.799" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService = mozilla::services::GetObserverService();</span>
<a href="#l52.800"></a><span id="l52.800" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l52.801"></a><span id="l52.801" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l52.802"></a><span id="l52.802">     if (observerService) {</span>
<a href="#l52.803"></a><span id="l52.803">       nsAutoCString thisUID;</span>
<a href="#l52.804"></a><span id="l52.804">       this-&gt;GetUID(thisUID);</span>
<a href="#l52.805"></a><span id="l52.805" class="difflineminus">-      observerService-&gt;NotifyObservers(card, &quot;addrbook-contact-created&quot;, NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.806"></a><span id="l52.806" class="difflineplus">+      observerService-&gt;NotifyObservers(card, &quot;addrbook-contact-created&quot;,</span>
<a href="#l52.807"></a><span id="l52.807" class="difflineplus">+                                       NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.808"></a><span id="l52.808">     }</span>
<a href="#l52.809"></a><span id="l52.809">   }</span>
<a href="#l52.810"></a><span id="l52.810">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.811"></a><span id="l52.811"> </span>
<a href="#l52.812"></a><span id="l52.812">   mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.813"></a><span id="l52.813"> </span>
<a href="#l52.814"></a><span id="l52.814">   NS_IF_ADDREF(*addedCard = card);</span>
<a href="#l52.815"></a><span id="l52.815">   return NS_OK;</span>
<a href="#l52.816"></a><span id="l52.816"> }</span>
<a href="#l52.817"></a><span id="l52.817"> </span>
<a href="#l52.818"></a><span id="l52.818" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::ModifyCard(nsIAbCard *aModifiedCard)</span>
<a href="#l52.819"></a><span id="l52.819" class="difflineminus">-{</span>
<a href="#l52.820"></a><span id="l52.820" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::ModifyCard(nsIAbCard *aModifiedCard) {</span>
<a href="#l52.821"></a><span id="l52.821">   NS_ENSURE_ARG_POINTER(aModifiedCard);</span>
<a href="#l52.822"></a><span id="l52.822"> </span>
<a href="#l52.823"></a><span id="l52.823">   nsresult rv;</span>
<a href="#l52.824"></a><span id="l52.824" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.825"></a><span id="l52.825" class="difflineminus">-  {</span>
<a href="#l52.826"></a><span id="l52.826" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l52.827"></a><span id="l52.827">     rv = GetAbDatabase();</span>
<a href="#l52.828"></a><span id="l52.828">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.829"></a><span id="l52.829">   }</span>
<a href="#l52.830"></a><span id="l52.830"> </span>
<a href="#l52.831"></a><span id="l52.831">   rv = mDatabase-&gt;EditCard(aModifiedCard, true, this);</span>
<a href="#l52.832"></a><span id="l52.832">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.833"></a><span id="l52.833"> </span>
<a href="#l52.834"></a><span id="l52.834" class="difflineminus">-  // If it's a mailing list's card, ensure the related nsIAbDirectory has the same UID.</span>
<a href="#l52.835"></a><span id="l52.835" class="difflineplus">+  // If it's a mailing list's card, ensure the related nsIAbDirectory has the</span>
<a href="#l52.836"></a><span id="l52.836" class="difflineplus">+  // same UID.</span>
<a href="#l52.837"></a><span id="l52.837">   bool isMailList;</span>
<a href="#l52.838"></a><span id="l52.838">   rv = aModifiedCard-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l52.839"></a><span id="l52.839">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.840"></a><span id="l52.840" class="difflineminus">-  if (isMailList)</span>
<a href="#l52.841"></a><span id="l52.841" class="difflineminus">-  {</span>
<a href="#l52.842"></a><span id="l52.842" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.843"></a><span id="l52.843" class="difflineplus">+  if (isMailList) {</span>
<a href="#l52.844"></a><span id="l52.844" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.845"></a><span id="l52.845" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.846"></a><span id="l52.846">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.847"></a><span id="l52.847"> </span>
<a href="#l52.848"></a><span id="l52.848">     nsAutoCString uri;</span>
<a href="#l52.849"></a><span id="l52.849">     rv = aModifiedCard-&gt;GetMailListURI(getter_Copies(uri));</span>
<a href="#l52.850"></a><span id="l52.850">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.851"></a><span id="l52.851"> </span>
<a href="#l52.852"></a><span id="l52.852">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l52.853"></a><span id="l52.853">     rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(directory));</span>
<a href="#l52.854"></a><span id="l52.854" class="difflineat">@@ -717,251 +642,240 @@ NS_IMETHODIMP nsAbMDBDirectory::ModifyCa</span>
<a href="#l52.855"></a><span id="l52.855">     nsAutoCString uid;</span>
<a href="#l52.856"></a><span id="l52.856">     rv = aModifiedCard-&gt;GetUID(uid);</span>
<a href="#l52.857"></a><span id="l52.857">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.858"></a><span id="l52.858"> </span>
<a href="#l52.859"></a><span id="l52.859">     rv = directory-&gt;SetUID(uid);</span>
<a href="#l52.860"></a><span id="l52.860">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.861"></a><span id="l52.861">   }</span>
<a href="#l52.862"></a><span id="l52.862"> </span>
<a href="#l52.863"></a><span id="l52.863" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; observerService = mozilla::services::GetObserverService();</span>
<a href="#l52.864"></a><span id="l52.864" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l52.865"></a><span id="l52.865" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l52.866"></a><span id="l52.866">   if (observerService) {</span>
<a href="#l52.867"></a><span id="l52.867">     nsAutoCString thisUID;</span>
<a href="#l52.868"></a><span id="l52.868">     this-&gt;GetUID(thisUID);</span>
<a href="#l52.869"></a><span id="l52.869" class="difflineminus">-    observerService-&gt;NotifyObservers(aModifiedCard, &quot;addrbook-contact-updated&quot;, NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.870"></a><span id="l52.870" class="difflineplus">+    observerService-&gt;NotifyObservers(aModifiedCard, &quot;addrbook-contact-updated&quot;,</span>
<a href="#l52.871"></a><span id="l52.871" class="difflineplus">+                                     NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.872"></a><span id="l52.872">   }</span>
<a href="#l52.873"></a><span id="l52.873"> </span>
<a href="#l52.874"></a><span id="l52.874">   return mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.875"></a><span id="l52.875"> }</span>
<a href="#l52.876"></a><span id="l52.876"> </span>
<a href="#l52.877"></a><span id="l52.877" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::DropCard(nsIAbCard* aCard, bool needToCopyCard)</span>
<a href="#l52.878"></a><span id="l52.878" class="difflineminus">-{</span>
<a href="#l52.879"></a><span id="l52.879" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::DropCard(nsIAbCard *aCard,</span>
<a href="#l52.880"></a><span id="l52.880" class="difflineplus">+                                         bool needToCopyCard) {</span>
<a href="#l52.881"></a><span id="l52.881">   NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l52.882"></a><span id="l52.882"> </span>
<a href="#l52.883"></a><span id="l52.883" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.884"></a><span id="l52.884" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.885"></a><span id="l52.885" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.886"></a><span id="l52.886"> </span>
<a href="#l52.887"></a><span id="l52.887">   nsresult rv = NS_OK;</span>
<a href="#l52.888"></a><span id="l52.888"> </span>
<a href="#l52.889"></a><span id="l52.889" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.890"></a><span id="l52.890" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l52.891"></a><span id="l52.891" class="difflineplus">+  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l52.892"></a><span id="l52.892"> </span>
<a href="#l52.893"></a><span id="l52.893" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase)</span>
<a href="#l52.894"></a><span id="l52.894" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l52.895"></a><span id="l52.895" class="difflineplus">+  if (NS_FAILED(rv) || !mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l52.896"></a><span id="l52.896"> </span>
<a href="#l52.897"></a><span id="l52.897">   nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l52.898"></a><span id="l52.898"> </span>
<a href="#l52.899"></a><span id="l52.899">   if (needToCopyCard) {</span>
<a href="#l52.900"></a><span id="l52.900">     newCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l52.901"></a><span id="l52.901">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.902"></a><span id="l52.902"> </span>
<a href="#l52.903"></a><span id="l52.903">     rv = newCard-&gt;Copy(aCard);</span>
<a href="#l52.904"></a><span id="l52.904">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.905"></a><span id="l52.905" class="difflineminus">-  }</span>
<a href="#l52.906"></a><span id="l52.906" class="difflineminus">-  else {</span>
<a href="#l52.907"></a><span id="l52.907" class="difflineplus">+  } else {</span>
<a href="#l52.908"></a><span id="l52.908">     newCard = aCard;</span>
<a href="#l52.909"></a><span id="l52.909">   }</span>
<a href="#l52.910"></a><span id="l52.910"> </span>
<a href="#l52.911"></a><span id="l52.911">   if (m_IsMailList) {</span>
<a href="#l52.912"></a><span id="l52.912">     if (needToCopyCard) {</span>
<a href="#l52.913"></a><span id="l52.913" class="difflineminus">-      nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l52.914"></a><span id="l52.914" class="difflineplus">+      nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l52.915"></a><span id="l52.915">       // if card doesn't exist in db, add the card to the directory that</span>
<a href="#l52.916"></a><span id="l52.916">       // contains the mailing list.</span>
<a href="#l52.917"></a><span id="l52.917">       mDatabase-&gt;FindRowByCard(newCard, getter_AddRefs(cardRow));</span>
<a href="#l52.918"></a><span id="l52.918">       if (!cardRow)</span>
<a href="#l52.919"></a><span id="l52.919">         mDatabase-&gt;CreateNewCardAndAddToDB(newCard, true /* notify */, this);</span>
<a href="#l52.920"></a><span id="l52.920">       else</span>
<a href="#l52.921"></a><span id="l52.921">         mDatabase-&gt;InitCardFromRow(newCard, cardRow);</span>
<a href="#l52.922"></a><span id="l52.922">     }</span>
<a href="#l52.923"></a><span id="l52.923" class="difflineminus">-    // since we didn't copy the card, we don't have to notify that it was inserted</span>
<a href="#l52.924"></a><span id="l52.924" class="difflineminus">-    mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, newCard, false /* notify */);</span>
<a href="#l52.925"></a><span id="l52.925" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService = mozilla::services::GetObserverService();</span>
<a href="#l52.926"></a><span id="l52.926" class="difflineplus">+    // since we didn't copy the card, we don't have to notify that it was</span>
<a href="#l52.927"></a><span id="l52.927" class="difflineplus">+    // inserted</span>
<a href="#l52.928"></a><span id="l52.928" class="difflineplus">+    mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, newCard,</span>
<a href="#l52.929"></a><span id="l52.929" class="difflineplus">+                                           false /* notify */);</span>
<a href="#l52.930"></a><span id="l52.930" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l52.931"></a><span id="l52.931" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l52.932"></a><span id="l52.932">     if (observerService) {</span>
<a href="#l52.933"></a><span id="l52.933">       nsAutoCString thisUID;</span>
<a href="#l52.934"></a><span id="l52.934">       this-&gt;GetUID(thisUID);</span>
<a href="#l52.935"></a><span id="l52.935" class="difflineminus">-      observerService-&gt;NotifyObservers(newCard, &quot;addrbook-list-member-added&quot;, NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.936"></a><span id="l52.936" class="difflineplus">+      observerService-&gt;NotifyObservers(newCard, &quot;addrbook-list-member-added&quot;,</span>
<a href="#l52.937"></a><span id="l52.937" class="difflineplus">+                                       NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.938"></a><span id="l52.938">     }</span>
<a href="#l52.939"></a><span id="l52.939" class="difflineminus">-  }</span>
<a href="#l52.940"></a><span id="l52.940" class="difflineminus">-  else {</span>
<a href="#l52.941"></a><span id="l52.941" class="difflineplus">+  } else {</span>
<a href="#l52.942"></a><span id="l52.942">     mDatabase-&gt;CreateNewCardAndAddToDB(newCard, true /* notify */, this);</span>
<a href="#l52.943"></a><span id="l52.943" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService = mozilla::services::GetObserverService();</span>
<a href="#l52.944"></a><span id="l52.944" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l52.945"></a><span id="l52.945" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l52.946"></a><span id="l52.946">     if (observerService) {</span>
<a href="#l52.947"></a><span id="l52.947">       nsAutoCString thisUID;</span>
<a href="#l52.948"></a><span id="l52.948">       this-&gt;GetUID(thisUID);</span>
<a href="#l52.949"></a><span id="l52.949" class="difflineminus">-      observerService-&gt;NotifyObservers(newCard, &quot;addrbook-contact-created&quot;, NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.950"></a><span id="l52.950" class="difflineplus">+      observerService-&gt;NotifyObservers(newCard, &quot;addrbook-contact-created&quot;,</span>
<a href="#l52.951"></a><span id="l52.951" class="difflineplus">+                                       NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l52.952"></a><span id="l52.952">     }</span>
<a href="#l52.953"></a><span id="l52.953">   }</span>
<a href="#l52.954"></a><span id="l52.954">   mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.955"></a><span id="l52.955">   return NS_OK;</span>
<a href="#l52.956"></a><span id="l52.956"> }</span>
<a href="#l52.957"></a><span id="l52.957"> </span>
<a href="#l52.958"></a><span id="l52.958" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::EditMailListToDatabase(nsIAbCard *listCard)</span>
<a href="#l52.959"></a><span id="l52.959" class="difflineminus">-{</span>
<a href="#l52.960"></a><span id="l52.960" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l52.961"></a><span id="l52.961" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.962"></a><span id="l52.962" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::EditMailListToDatabase(nsIAbCard *listCard) {</span>
<a href="#l52.963"></a><span id="l52.963" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l52.964"></a><span id="l52.964"> </span>
<a href="#l52.965"></a><span id="l52.965" class="difflineminus">-  if (!m_IsMailList)</span>
<a href="#l52.966"></a><span id="l52.966" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l52.967"></a><span id="l52.967" class="difflineplus">+  if (!m_IsMailList) return NS_ERROR_UNEXPECTED;</span>
<a href="#l52.968"></a><span id="l52.968"> </span>
<a href="#l52.969"></a><span id="l52.969">   nsresult rv = GetAbDatabase();</span>
<a href="#l52.970"></a><span id="l52.970">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.971"></a><span id="l52.971"> </span>
<a href="#l52.972"></a><span id="l52.972">   mDatabase-&gt;EditMailList(this, listCard, true);</span>
<a href="#l52.973"></a><span id="l52.973">   mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l52.974"></a><span id="l52.974"> </span>
<a href="#l52.975"></a><span id="l52.975">   return NS_OK;</span>
<a href="#l52.976"></a><span id="l52.976"> }</span>
<a href="#l52.977"></a><span id="l52.977"> </span>
<a href="#l52.978"></a><span id="l52.978" class="difflineminus">-static bool ContainsDirectory(nsIAbDirectory *parent, nsIAbDirectory *directory)</span>
<a href="#l52.979"></a><span id="l52.979" class="difflineminus">-{</span>
<a href="#l52.980"></a><span id="l52.980" class="difflineplus">+static bool ContainsDirectory(nsIAbDirectory *parent,</span>
<a href="#l52.981"></a><span id="l52.981" class="difflineplus">+                              nsIAbDirectory *directory) {</span>
<a href="#l52.982"></a><span id="l52.982">   // If parent is a maillist, 'addressLists' contains AbCards.</span>
<a href="#l52.983"></a><span id="l52.983">   bool bIsMailList = false;</span>
<a href="#l52.984"></a><span id="l52.984">   nsresult rv = parent-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l52.985"></a><span id="l52.985">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l52.986"></a><span id="l52.986"> </span>
<a href="#l52.987"></a><span id="l52.987" class="difflineminus">-  if (bIsMailList)</span>
<a href="#l52.988"></a><span id="l52.988" class="difflineminus">-    return false;</span>
<a href="#l52.989"></a><span id="l52.989" class="difflineplus">+  if (bIsMailList) return false;</span>
<a href="#l52.990"></a><span id="l52.990"> </span>
<a href="#l52.991"></a><span id="l52.991">   nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l52.992"></a><span id="l52.992">   parent-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l52.993"></a><span id="l52.993" class="difflineminus">-  if (pAddressLists)</span>
<a href="#l52.994"></a><span id="l52.994" class="difflineminus">-  {</span>
<a href="#l52.995"></a><span id="l52.995" class="difflineplus">+  if (pAddressLists) {</span>
<a href="#l52.996"></a><span id="l52.996">     uint32_t total;</span>
<a href="#l52.997"></a><span id="l52.997">     rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l52.998"></a><span id="l52.998" class="difflineminus">-    for (uint32_t i = 0; i &lt; total; ++i)</span>
<a href="#l52.999"></a><span id="l52.999" class="difflineminus">-    {</span>
<a href="#l52.1000"></a><span id="l52.1000" class="difflineplus">+    for (uint32_t i = 0; i &lt; total; ++i) {</span>
<a href="#l52.1001"></a><span id="l52.1001">       nsCOMPtr&lt;nsIAbDirectory&gt; pList(do_QueryElementAt(pAddressLists, i, &amp;rv));</span>
<a href="#l52.1002"></a><span id="l52.1002"> </span>
<a href="#l52.1003"></a><span id="l52.1003" class="difflineminus">-      if (directory == pList)</span>
<a href="#l52.1004"></a><span id="l52.1004" class="difflineminus">-          return true;</span>
<a href="#l52.1005"></a><span id="l52.1005" class="difflineplus">+      if (directory == pList) return true;</span>
<a href="#l52.1006"></a><span id="l52.1006">     }</span>
<a href="#l52.1007"></a><span id="l52.1007">   }</span>
<a href="#l52.1008"></a><span id="l52.1008"> </span>
<a href="#l52.1009"></a><span id="l52.1009">   return false;</span>
<a href="#l52.1010"></a><span id="l52.1010"> }</span>
<a href="#l52.1011"></a><span id="l52.1011"> </span>
<a href="#l52.1012"></a><span id="l52.1012"> // nsIAddrDBListener methods</span>
<a href="#l52.1013"></a><span id="l52.1013"> </span>
<a href="#l52.1014"></a><span id="l52.1014" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnCardAttribChange(uint32_t abCode)</span>
<a href="#l52.1015"></a><span id="l52.1015" class="difflineminus">-{</span>
<a href="#l52.1016"></a><span id="l52.1016" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::OnCardAttribChange(uint32_t abCode) {</span>
<a href="#l52.1017"></a><span id="l52.1017">   return NS_OK;</span>
<a href="#l52.1018"></a><span id="l52.1018"> }</span>
<a href="#l52.1019"></a><span id="l52.1019"> </span>
<a href="#l52.1020"></a><span id="l52.1020" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnCardEntryChange</span>
<a href="#l52.1021"></a><span id="l52.1021" class="difflineminus">-(uint32_t aAbCode, nsIAbCard *aCard, nsIAbDirectory *aParent)</span>
<a href="#l52.1022"></a><span id="l52.1022" class="difflineminus">-{</span>
<a href="#l52.1023"></a><span id="l52.1023" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::OnCardEntryChange(uint32_t aAbCode,</span>
<a href="#l52.1024"></a><span id="l52.1024" class="difflineplus">+                                                  nsIAbCard *aCard,</span>
<a href="#l52.1025"></a><span id="l52.1025" class="difflineplus">+                                                  nsIAbDirectory *aParent) {</span>
<a href="#l52.1026"></a><span id="l52.1026">   // Don't notify AbManager unless we have the parent</span>
<a href="#l52.1027"></a><span id="l52.1027" class="difflineminus">-  if (!aParent)</span>
<a href="#l52.1028"></a><span id="l52.1028" class="difflineminus">-    return NS_OK;</span>
<a href="#l52.1029"></a><span id="l52.1029" class="difflineplus">+  if (!aParent) return NS_OK;</span>
<a href="#l52.1030"></a><span id="l52.1030"> </span>
<a href="#l52.1031"></a><span id="l52.1031">   NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l52.1032"></a><span id="l52.1032">   nsCOMPtr&lt;nsISupports&gt; cardSupports(do_QueryInterface(aCard));</span>
<a href="#l52.1033"></a><span id="l52.1033">   nsresult rv;</span>
<a href="#l52.1034"></a><span id="l52.1034"> </span>
<a href="#l52.1035"></a><span id="l52.1035">   // Notify when</span>
<a href="#l52.1036"></a><span id="l52.1036">   // - any operation is done to a card belonging to this</span>
<a href="#l52.1037"></a><span id="l52.1037">   //        =&gt; if &lt;this&gt; is &lt;aParent&gt;, or</span>
<a href="#l52.1038"></a><span id="l52.1038">   // - a card belonging to a directory which is parent of this is deleted</span>
<a href="#l52.1039"></a><span id="l52.1039" class="difflineminus">-  //        =&gt; if aAbCode is AB_NotifyDeleted &amp;&amp; &lt;this&gt; is child of &lt;aParent&gt;, or</span>
<a href="#l52.1040"></a><span id="l52.1040" class="difflineplus">+  //        =&gt; if aAbCode is AB_NotifyDeleted &amp;&amp; &lt;this&gt; is child of &lt;aParent&gt;,</span>
<a href="#l52.1041"></a><span id="l52.1041" class="difflineplus">+  //        or</span>
<a href="#l52.1042"></a><span id="l52.1042">   // - a card belonging to a directory which is child of this is added/modified</span>
<a href="#l52.1043"></a><span id="l52.1043">   //        =&gt; if aAbCode is !AB_NotifyDeleted &amp;&amp; &lt;this&gt; is parent of &lt;aParent&gt;</span>
<a href="#l52.1044"></a><span id="l52.1044"> </span>
<a href="#l52.1045"></a><span id="l52.1045" class="difflineminus">-  if (aParent != this)</span>
<a href="#l52.1046"></a><span id="l52.1046" class="difflineminus">-  {</span>
<a href="#l52.1047"></a><span id="l52.1047" class="difflineplus">+  if (aParent != this) {</span>
<a href="#l52.1048"></a><span id="l52.1048">     bool isChild = false;</span>
<a href="#l52.1049"></a><span id="l52.1049">     if (aAbCode != AB_NotifyDeleted)</span>
<a href="#l52.1050"></a><span id="l52.1050">       isChild = ContainsDirectory(this, aParent);</span>
<a href="#l52.1051"></a><span id="l52.1051">     else</span>
<a href="#l52.1052"></a><span id="l52.1052">       isChild = ContainsDirectory(aParent, this);</span>
<a href="#l52.1053"></a><span id="l52.1053"> </span>
<a href="#l52.1054"></a><span id="l52.1054" class="difflineminus">-    if (!isChild)</span>
<a href="#l52.1055"></a><span id="l52.1055" class="difflineminus">-      return NS_OK;</span>
<a href="#l52.1056"></a><span id="l52.1056" class="difflineplus">+    if (!isChild) return NS_OK;</span>
<a href="#l52.1057"></a><span id="l52.1057">   }</span>
<a href="#l52.1058"></a><span id="l52.1058"> </span>
<a href="#l52.1059"></a><span id="l52.1059">   switch (aAbCode) {</span>
<a href="#l52.1060"></a><span id="l52.1060" class="difflineminus">-  case AB_NotifyInserted:</span>
<a href="#l52.1061"></a><span id="l52.1061" class="difflineminus">-    rv = NotifyItemAdded(cardSupports);</span>
<a href="#l52.1062"></a><span id="l52.1062" class="difflineminus">-    break;</span>
<a href="#l52.1063"></a><span id="l52.1063" class="difflineminus">-  case AB_NotifyDeleted:</span>
<a href="#l52.1064"></a><span id="l52.1064" class="difflineminus">-    rv = NotifyItemDeleted(cardSupports);</span>
<a href="#l52.1065"></a><span id="l52.1065" class="difflineminus">-    break;</span>
<a href="#l52.1066"></a><span id="l52.1066" class="difflineminus">-  case AB_NotifyPropertyChanged:</span>
<a href="#l52.1067"></a><span id="l52.1067" class="difflineminus">-    rv = NotifyItemChanged(cardSupports);</span>
<a href="#l52.1068"></a><span id="l52.1068" class="difflineminus">-    break;</span>
<a href="#l52.1069"></a><span id="l52.1069" class="difflineminus">-  default:</span>
<a href="#l52.1070"></a><span id="l52.1070" class="difflineminus">-    rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l52.1071"></a><span id="l52.1071" class="difflineminus">-    break;</span>
<a href="#l52.1072"></a><span id="l52.1072" class="difflineplus">+    case AB_NotifyInserted:</span>
<a href="#l52.1073"></a><span id="l52.1073" class="difflineplus">+      rv = NotifyItemAdded(cardSupports);</span>
<a href="#l52.1074"></a><span id="l52.1074" class="difflineplus">+      break;</span>
<a href="#l52.1075"></a><span id="l52.1075" class="difflineplus">+    case AB_NotifyDeleted:</span>
<a href="#l52.1076"></a><span id="l52.1076" class="difflineplus">+      rv = NotifyItemDeleted(cardSupports);</span>
<a href="#l52.1077"></a><span id="l52.1077" class="difflineplus">+      break;</span>
<a href="#l52.1078"></a><span id="l52.1078" class="difflineplus">+    case AB_NotifyPropertyChanged:</span>
<a href="#l52.1079"></a><span id="l52.1079" class="difflineplus">+      rv = NotifyItemChanged(cardSupports);</span>
<a href="#l52.1080"></a><span id="l52.1080" class="difflineplus">+      break;</span>
<a href="#l52.1081"></a><span id="l52.1081" class="difflineplus">+    default:</span>
<a href="#l52.1082"></a><span id="l52.1082" class="difflineplus">+      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l52.1083"></a><span id="l52.1083" class="difflineplus">+      break;</span>
<a href="#l52.1084"></a><span id="l52.1084">   }</span>
<a href="#l52.1085"></a><span id="l52.1085"> </span>
<a href="#l52.1086"></a><span id="l52.1086">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1087"></a><span id="l52.1087">   return rv;</span>
<a href="#l52.1088"></a><span id="l52.1088"> }</span>
<a href="#l52.1089"></a><span id="l52.1089"> </span>
<a href="#l52.1090"></a><span id="l52.1090" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnListEntryChange</span>
<a href="#l52.1091"></a><span id="l52.1091" class="difflineminus">-(uint32_t abCode, nsIAbDirectory *list)</span>
<a href="#l52.1092"></a><span id="l52.1092" class="difflineminus">-{</span>
<a href="#l52.1093"></a><span id="l52.1093" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::OnListEntryChange(uint32_t abCode,</span>
<a href="#l52.1094"></a><span id="l52.1094" class="difflineplus">+                                                  nsIAbDirectory *list) {</span>
<a href="#l52.1095"></a><span id="l52.1095">   nsresult rv = NS_OK;</span>
<a href="#l52.1096"></a><span id="l52.1096"> </span>
<a href="#l52.1097"></a><span id="l52.1097" class="difflineminus">-  if (abCode == AB_NotifyPropertyChanged &amp;&amp; list)</span>
<a href="#l52.1098"></a><span id="l52.1098" class="difflineminus">-  {</span>
<a href="#l52.1099"></a><span id="l52.1099" class="difflineplus">+  if (abCode == AB_NotifyPropertyChanged &amp;&amp; list) {</span>
<a href="#l52.1100"></a><span id="l52.1100">     bool bIsMailList = false;</span>
<a href="#l52.1101"></a><span id="l52.1101">     rv = list-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l52.1102"></a><span id="l52.1102" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.1103"></a><span id="l52.1103" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1104"></a><span id="l52.1104"> </span>
<a href="#l52.1105"></a><span id="l52.1105">     nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list, &amp;rv));</span>
<a href="#l52.1106"></a><span id="l52.1106">     mozilla::Unused &lt;&lt; dblist;</span>
<a href="#l52.1107"></a><span id="l52.1107" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.1108"></a><span id="l52.1108" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1109"></a><span id="l52.1109"> </span>
<a href="#l52.1110"></a><span id="l52.1110">     if (bIsMailList) {</span>
<a href="#l52.1111"></a><span id="l52.1111">       nsString listName;</span>
<a href="#l52.1112"></a><span id="l52.1112">       rv = list-&gt;GetDirName(listName);</span>
<a href="#l52.1113"></a><span id="l52.1113" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.1114"></a><span id="l52.1114" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1115"></a><span id="l52.1115"> </span>
<a href="#l52.1116"></a><span id="l52.1116">       rv = NotifyPropertyChanged(list, &quot;DirName&quot;, nullptr, listName.get());</span>
<a href="#l52.1117"></a><span id="l52.1117" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.1118"></a><span id="l52.1118" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1119"></a><span id="l52.1119">     }</span>
<a href="#l52.1120"></a><span id="l52.1120">   }</span>
<a href="#l52.1121"></a><span id="l52.1121">   return rv;</span>
<a href="#l52.1122"></a><span id="l52.1122"> }</span>
<a href="#l52.1123"></a><span id="l52.1123"> </span>
<a href="#l52.1124"></a><span id="l52.1124" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnAnnouncerGoingAway()</span>
<a href="#l52.1125"></a><span id="l52.1125" class="difflineminus">-{</span>
<a href="#l52.1126"></a><span id="l52.1126" class="difflineminus">-  if (mDatabase)</span>
<a href="#l52.1127"></a><span id="l52.1127" class="difflineminus">-      mDatabase-&gt;RemoveListener(this);</span>
<a href="#l52.1128"></a><span id="l52.1128" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::OnAnnouncerGoingAway() {</span>
<a href="#l52.1129"></a><span id="l52.1129" class="difflineplus">+  if (mDatabase) mDatabase-&gt;RemoveListener(this);</span>
<a href="#l52.1130"></a><span id="l52.1130">   return NS_OK;</span>
<a href="#l52.1131"></a><span id="l52.1131"> }</span>
<a href="#l52.1132"></a><span id="l52.1132"> </span>
<a href="#l52.1133"></a><span id="l52.1133"> // nsIAbDirectorySearch methods</span>
<a href="#l52.1134"></a><span id="l52.1134"> </span>
<a href="#l52.1135"></a><span id="l52.1135" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::StartSearch()</span>
<a href="#l52.1136"></a><span id="l52.1136" class="difflineminus">-{</span>
<a href="#l52.1137"></a><span id="l52.1137" class="difflineminus">-  if (!mIsQueryURI)</span>
<a href="#l52.1138"></a><span id="l52.1138" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l52.1139"></a><span id="l52.1139" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::StartSearch() {</span>
<a href="#l52.1140"></a><span id="l52.1140" class="difflineplus">+  if (!mIsQueryURI) return NS_ERROR_FAILURE;</span>
<a href="#l52.1141"></a><span id="l52.1141"> </span>
<a href="#l52.1142"></a><span id="l52.1142">   nsresult rv;</span>
<a href="#l52.1143"></a><span id="l52.1143"> </span>
<a href="#l52.1144"></a><span id="l52.1144">   mPerformingQuery = true;</span>
<a href="#l52.1145"></a><span id="l52.1145">   mSearchCache.Clear();</span>
<a href="#l52.1146"></a><span id="l52.1146"> </span>
<a href="#l52.1147"></a><span id="l52.1147" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments = do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID,&amp;rv);</span>
<a href="#l52.1148"></a><span id="l52.1148" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments =</span>
<a href="#l52.1149"></a><span id="l52.1149" class="difflineplus">+      do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;rv);</span>
<a href="#l52.1150"></a><span id="l52.1150">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1151"></a><span id="l52.1151"> </span>
<a href="#l52.1152"></a><span id="l52.1152">   nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l52.1153"></a><span id="l52.1153">   rv = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l52.1154"></a><span id="l52.1154" class="difflineminus">-    getter_AddRefs(expression));</span>
<a href="#l52.1155"></a><span id="l52.1155" class="difflineplus">+                                            getter_AddRefs(expression));</span>
<a href="#l52.1156"></a><span id="l52.1156">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1157"></a><span id="l52.1157"> </span>
<a href="#l52.1158"></a><span id="l52.1158">   rv = arguments-&gt;SetExpression(expression);</span>
<a href="#l52.1159"></a><span id="l52.1159">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1160"></a><span id="l52.1160"> </span>
<a href="#l52.1161"></a><span id="l52.1161">   // don't search the subdirectories</span>
<a href="#l52.1162"></a><span id="l52.1162" class="difflineminus">-  // if the current directory is a mailing list, it won't have any subdirectories</span>
<a href="#l52.1163"></a><span id="l52.1163" class="difflineminus">-  // if the current directory is a addressbook, searching both it</span>
<a href="#l52.1164"></a><span id="l52.1164" class="difflineplus">+  // if the current directory is a mailing list, it won't have any</span>
<a href="#l52.1165"></a><span id="l52.1165" class="difflineplus">+  // subdirectories if the current directory is a addressbook, searching both it</span>
<a href="#l52.1166"></a><span id="l52.1166">   // and the subdirectories (the mailing lists), will yield duplicate results</span>
<a href="#l52.1167"></a><span id="l52.1167" class="difflineminus">-  // because every entry in a mailing list will be an entry in the parent addressbook</span>
<a href="#l52.1168"></a><span id="l52.1168" class="difflineplus">+  // because every entry in a mailing list will be an entry in the parent</span>
<a href="#l52.1169"></a><span id="l52.1169" class="difflineplus">+  // addressbook</span>
<a href="#l52.1170"></a><span id="l52.1170">   rv = arguments-&gt;SetQuerySubDirectories(false);</span>
<a href="#l52.1171"></a><span id="l52.1171">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1172"></a><span id="l52.1172"> </span>
<a href="#l52.1173"></a><span id="l52.1173">   nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.1174"></a><span id="l52.1174">       do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.1175"></a><span id="l52.1175">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1176"></a><span id="l52.1176"> </span>
<a href="#l52.1177"></a><span id="l52.1177">   // Get the directory without the query</span>
<a href="#l52.1178"></a><span id="l52.1178" class="difflineat">@@ -972,199 +886,173 @@ NS_IMETHODIMP nsAbMDBDirectory::StartSea</span>
<a href="#l52.1179"></a><span id="l52.1179">   // Bug 280232 - something was causing continuous loops in searching. Add a</span>
<a href="#l52.1180"></a><span id="l52.1180">   // check here for the directory to search not being a query uri as well in</span>
<a href="#l52.1181"></a><span id="l52.1181">   // the hopes that will at least break us out of the continuous loop even if</span>
<a href="#l52.1182"></a><span id="l52.1182">   // we don't know how we got into it.</span>
<a href="#l52.1183"></a><span id="l52.1183">   bool isQuery;</span>
<a href="#l52.1184"></a><span id="l52.1184">   rv = directory-&gt;GetIsQuery(&amp;isQuery);</span>
<a href="#l52.1185"></a><span id="l52.1185">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1186"></a><span id="l52.1186"> </span>
<a href="#l52.1187"></a><span id="l52.1187" class="difflineminus">-  if (isQuery)</span>
<a href="#l52.1188"></a><span id="l52.1188" class="difflineminus">-  {</span>
<a href="#l52.1189"></a><span id="l52.1189" class="difflineplus">+  if (isQuery) {</span>
<a href="#l52.1190"></a><span id="l52.1190">     NS_ERROR(&quot;Attempting to search a directory within a search&quot;);</span>
<a href="#l52.1191"></a><span id="l52.1191">     return NS_ERROR_FAILURE;</span>
<a href="#l52.1192"></a><span id="l52.1192">   }</span>
<a href="#l52.1193"></a><span id="l52.1193"> </span>
<a href="#l52.1194"></a><span id="l52.1194">   // Initiate the proxy query with the no query directory</span>
<a href="#l52.1195"></a><span id="l52.1195">   nsCOMPtr&lt;nsIAbDirectoryQueryProxy&gt; queryProxy =</span>
<a href="#l52.1196"></a><span id="l52.1196">       do_CreateInstance(NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l52.1197"></a><span id="l52.1197">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1198"></a><span id="l52.1198"> </span>
<a href="#l52.1199"></a><span id="l52.1199">   rv = queryProxy-&gt;Initiate();</span>
<a href="#l52.1200"></a><span id="l52.1200">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1201"></a><span id="l52.1201"> </span>
<a href="#l52.1202"></a><span id="l52.1202">   rv = queryProxy-&gt;DoQuery(directory, arguments, this, -1, 0, &amp;mContext);</span>
<a href="#l52.1203"></a><span id="l52.1203">   return NS_OK;</span>
<a href="#l52.1204"></a><span id="l52.1204"> }</span>
<a href="#l52.1205"></a><span id="l52.1205"> </span>
<a href="#l52.1206"></a><span id="l52.1206" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::StopSearch()</span>
<a href="#l52.1207"></a><span id="l52.1207" class="difflineminus">-{</span>
<a href="#l52.1208"></a><span id="l52.1208" class="difflineminus">-  if (!mIsQueryURI)</span>
<a href="#l52.1209"></a><span id="l52.1209" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l52.1210"></a><span id="l52.1210" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::StopSearch() {</span>
<a href="#l52.1211"></a><span id="l52.1211" class="difflineplus">+  if (!mIsQueryURI) return NS_ERROR_FAILURE;</span>
<a href="#l52.1212"></a><span id="l52.1212"> </span>
<a href="#l52.1213"></a><span id="l52.1213">   return NS_OK;</span>
<a href="#l52.1214"></a><span id="l52.1214"> }</span>
<a href="#l52.1215"></a><span id="l52.1215"> </span>
<a href="#l52.1216"></a><span id="l52.1216" class="difflineminus">-</span>
<a href="#l52.1217"></a><span id="l52.1217"> // nsAbDirSearchListenerContext methods</span>
<a href="#l52.1218"></a><span id="l52.1218"> </span>
<a href="#l52.1219"></a><span id="l52.1219"> NS_IMETHODIMP nsAbMDBDirectory::OnSearchFinished(int32_t aResult,</span>
<a href="#l52.1220"></a><span id="l52.1220" class="difflineminus">-                                                 const nsAString &amp;aErrorMsg)</span>
<a href="#l52.1221"></a><span id="l52.1221" class="difflineminus">-{</span>
<a href="#l52.1222"></a><span id="l52.1222" class="difflineplus">+                                                 const nsAString &amp;aErrorMsg) {</span>
<a href="#l52.1223"></a><span id="l52.1223">   mPerformingQuery = false;</span>
<a href="#l52.1224"></a><span id="l52.1224">   return NS_OK;</span>
<a href="#l52.1225"></a><span id="l52.1225"> }</span>
<a href="#l52.1226"></a><span id="l52.1226"> </span>
<a href="#l52.1227"></a><span id="l52.1227" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnSearchFoundCard(nsIAbCard* card)</span>
<a href="#l52.1228"></a><span id="l52.1228" class="difflineminus">-{</span>
<a href="#l52.1229"></a><span id="l52.1229" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::OnSearchFoundCard(nsIAbCard *card) {</span>
<a href="#l52.1230"></a><span id="l52.1230">   mSearchCache.Put(card, card);</span>
<a href="#l52.1231"></a><span id="l52.1231"> </span>
<a href="#l52.1232"></a><span id="l52.1232">   // TODO</span>
<a href="#l52.1233"></a><span id="l52.1233">   // Search is synchronous so asserting on the</span>
<a href="#l52.1234"></a><span id="l52.1234">   // datasource will not work since the getChildCards</span>
<a href="#l52.1235"></a><span id="l52.1235">   // method will not have returned with results.</span>
<a href="#l52.1236"></a><span id="l52.1236">   // NotifyItemAdded (card);</span>
<a href="#l52.1237"></a><span id="l52.1237">   return NS_OK;</span>
<a href="#l52.1238"></a><span id="l52.1238"> }</span>
<a href="#l52.1239"></a><span id="l52.1239"> </span>
<a href="#l52.1240"></a><span id="l52.1240" class="difflineminus">-nsresult nsAbMDBDirectory::GetAbDatabase()</span>
<a href="#l52.1241"></a><span id="l52.1241" class="difflineminus">-{</span>
<a href="#l52.1242"></a><span id="l52.1242" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l52.1243"></a><span id="l52.1243" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.1244"></a><span id="l52.1244" class="difflineplus">+nsresult nsAbMDBDirectory::GetAbDatabase() {</span>
<a href="#l52.1245"></a><span id="l52.1245" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l52.1246"></a><span id="l52.1246"> </span>
<a href="#l52.1247"></a><span id="l52.1247" class="difflineminus">-  if (mDatabase)</span>
<a href="#l52.1248"></a><span id="l52.1248" class="difflineminus">-    return NS_OK;</span>
<a href="#l52.1249"></a><span id="l52.1249" class="difflineplus">+  if (mDatabase) return NS_OK;</span>
<a href="#l52.1250"></a><span id="l52.1250"> </span>
<a href="#l52.1251"></a><span id="l52.1251">   nsresult rv;</span>
<a href="#l52.1252"></a><span id="l52.1252"> </span>
<a href="#l52.1253"></a><span id="l52.1253" class="difflineminus">-  if (m_IsMailList)</span>
<a href="#l52.1254"></a><span id="l52.1254" class="difflineminus">-  {</span>
<a href="#l52.1255"></a><span id="l52.1255" class="difflineplus">+  if (m_IsMailList) {</span>
<a href="#l52.1256"></a><span id="l52.1256">     // Get the database of the parent directory.</span>
<a href="#l52.1257"></a><span id="l52.1257">     nsAutoCString parentURI(mURINoQuery);</span>
<a href="#l52.1258"></a><span id="l52.1258"> </span>
<a href="#l52.1259"></a><span id="l52.1259">     int32_t pos = parentURI.RFindChar('/');</span>
<a href="#l52.1260"></a><span id="l52.1260"> </span>
<a href="#l52.1261"></a><span id="l52.1261">     // If we didn't find a / something really bad has happened</span>
<a href="#l52.1262"></a><span id="l52.1262" class="difflineminus">-    if (pos == -1)</span>
<a href="#l52.1263"></a><span id="l52.1263" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l52.1264"></a><span id="l52.1264" class="difflineplus">+    if (pos == -1) return NS_ERROR_FAILURE;</span>
<a href="#l52.1265"></a><span id="l52.1265"> </span>
<a href="#l52.1266"></a><span id="l52.1266">     parentURI = StringHead(parentURI, pos);</span>
<a href="#l52.1267"></a><span id="l52.1267"> </span>
<a href="#l52.1268"></a><span id="l52.1268">     nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l52.1269"></a><span id="l52.1269">         do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l52.1270"></a><span id="l52.1270">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1271"></a><span id="l52.1271"> </span>
<a href="#l52.1272"></a><span id="l52.1272">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l52.1273"></a><span id="l52.1273">     rv = abManager-&gt;GetDirectory(parentURI, getter_AddRefs(directory));</span>
<a href="#l52.1274"></a><span id="l52.1274">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1275"></a><span id="l52.1275"> </span>
<a href="#l52.1276"></a><span id="l52.1276">     nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDir(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l52.1277"></a><span id="l52.1277">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1278"></a><span id="l52.1278"> </span>
<a href="#l52.1279"></a><span id="l52.1279">     rv = mdbDir-&gt;GetDatabase(getter_AddRefs(mDatabase));</span>
<a href="#l52.1280"></a><span id="l52.1280" class="difflineminus">-  }</span>
<a href="#l52.1281"></a><span id="l52.1281" class="difflineminus">-  else</span>
<a href="#l52.1282"></a><span id="l52.1282" class="difflineplus">+  } else</span>
<a href="#l52.1283"></a><span id="l52.1283">     rv = GetDatabase(getter_AddRefs(mDatabase));</span>
<a href="#l52.1284"></a><span id="l52.1284"> </span>
<a href="#l52.1285"></a><span id="l52.1285" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l52.1286"></a><span id="l52.1286" class="difflineminus">-    rv = mDatabase-&gt;AddListener(this);</span>
<a href="#l52.1287"></a><span id="l52.1287" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = mDatabase-&gt;AddListener(this);</span>
<a href="#l52.1288"></a><span id="l52.1288"> </span>
<a href="#l52.1289"></a><span id="l52.1289">   return rv;</span>
<a href="#l52.1290"></a><span id="l52.1290"> }</span>
<a href="#l52.1291"></a><span id="l52.1291"> </span>
<a href="#l52.1292"></a><span id="l52.1292" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::CardForEmailAddress(const nsACString &amp;aEmailAddress, nsIAbCard ** aAbCard)</span>
<a href="#l52.1293"></a><span id="l52.1293" class="difflineminus">-{</span>
<a href="#l52.1294"></a><span id="l52.1294" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::CardForEmailAddress(</span>
<a href="#l52.1295"></a><span id="l52.1295" class="difflineplus">+    const nsACString &amp;aEmailAddress, nsIAbCard **aAbCard) {</span>
<a href="#l52.1296"></a><span id="l52.1296">   NS_ENSURE_ARG_POINTER(aAbCard);</span>
<a href="#l52.1297"></a><span id="l52.1297"> </span>
<a href="#l52.1298"></a><span id="l52.1298">   *aAbCard = nullptr;</span>
<a href="#l52.1299"></a><span id="l52.1299"> </span>
<a href="#l52.1300"></a><span id="l52.1300">   // Ensure that if we've not been given an email address we never match</span>
<a href="#l52.1301"></a><span id="l52.1301">   // so that we don't fail out unnecessarily and we don't match a blank email</span>
<a href="#l52.1302"></a><span id="l52.1302">   // address against random cards that the user hasn't supplied an email for.</span>
<a href="#l52.1303"></a><span id="l52.1303" class="difflineminus">-  if (aEmailAddress.IsEmpty())</span>
<a href="#l52.1304"></a><span id="l52.1304" class="difflineminus">-    return NS_OK;</span>
<a href="#l52.1305"></a><span id="l52.1305" class="difflineplus">+  if (aEmailAddress.IsEmpty()) return NS_OK;</span>
<a href="#l52.1306"></a><span id="l52.1306"> </span>
<a href="#l52.1307"></a><span id="l52.1307">   nsresult rv = NS_OK;</span>
<a href="#l52.1308"></a><span id="l52.1308" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.1309"></a><span id="l52.1309" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l52.1310"></a><span id="l52.1310" class="difflineminus">-  if (rv == NS_ERROR_FILE_NOT_FOUND)</span>
<a href="#l52.1311"></a><span id="l52.1311" class="difflineminus">-  {</span>
<a href="#l52.1312"></a><span id="l52.1312" class="difflineplus">+  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l52.1313"></a><span id="l52.1313" class="difflineplus">+  if (rv == NS_ERROR_FILE_NOT_FOUND) {</span>
<a href="#l52.1314"></a><span id="l52.1314">     // If file wasn't found, the card cannot exist.</span>
<a href="#l52.1315"></a><span id="l52.1315">     return NS_OK;</span>
<a href="#l52.1316"></a><span id="l52.1316">   }</span>
<a href="#l52.1317"></a><span id="l52.1317">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1318"></a><span id="l52.1318"> </span>
<a href="#l52.1319"></a><span id="l52.1319">   // Convert Email to lower case in UTF-16 format. This correctly lower-cases</span>
<a href="#l52.1320"></a><span id="l52.1320">   // it and doing this change means that we can use a hash lookup in the</span>
<a href="#l52.1321"></a><span id="l52.1321">   // database rather than searching and comparing each line individually.</span>
<a href="#l52.1322"></a><span id="l52.1322">   NS_ConvertUTF8toUTF16 lowerEmail(aEmailAddress);</span>
<a href="#l52.1323"></a><span id="l52.1323">   ToLowerCase(lowerEmail);</span>
<a href="#l52.1324"></a><span id="l52.1324"> </span>
<a href="#l52.1325"></a><span id="l52.1325" class="difflineminus">-  // If lower email is empty, something went wrong somewhere, e.g. the conversion.</span>
<a href="#l52.1326"></a><span id="l52.1326" class="difflineminus">-  // Hence, don't go looking for a card with no email address. Something is wrong.</span>
<a href="#l52.1327"></a><span id="l52.1327" class="difflineminus">-  if (lowerEmail.IsEmpty())</span>
<a href="#l52.1328"></a><span id="l52.1328" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l52.1329"></a><span id="l52.1329" class="difflineplus">+  // If lower email is empty, something went wrong somewhere, e.g. the</span>
<a href="#l52.1330"></a><span id="l52.1330" class="difflineplus">+  // conversion. Hence, don't go looking for a card with no email address.</span>
<a href="#l52.1331"></a><span id="l52.1331" class="difflineplus">+  // Something is wrong.</span>
<a href="#l52.1332"></a><span id="l52.1332" class="difflineplus">+  if (lowerEmail.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l52.1333"></a><span id="l52.1333"> </span>
<a href="#l52.1334"></a><span id="l52.1334">   mDatabase-&gt;GetCardFromAttribute(this, kLowerPriEmailColumn,</span>
<a href="#l52.1335"></a><span id="l52.1335" class="difflineminus">-                                  NS_ConvertUTF16toUTF8(lowerEmail),</span>
<a href="#l52.1336"></a><span id="l52.1336" class="difflineminus">-                                  false, aAbCard);</span>
<a href="#l52.1337"></a><span id="l52.1337" class="difflineminus">-  if (!*aAbCard)</span>
<a href="#l52.1338"></a><span id="l52.1338" class="difflineminus">-  {</span>
<a href="#l52.1339"></a><span id="l52.1339" class="difflineplus">+                                  NS_ConvertUTF16toUTF8(lowerEmail), false,</span>
<a href="#l52.1340"></a><span id="l52.1340" class="difflineplus">+                                  aAbCard);</span>
<a href="#l52.1341"></a><span id="l52.1341" class="difflineplus">+  if (!*aAbCard) {</span>
<a href="#l52.1342"></a><span id="l52.1342">     mDatabase-&gt;GetCardFromAttribute(this, kLower2ndEmailColumn,</span>
<a href="#l52.1343"></a><span id="l52.1343" class="difflineminus">-                                    NS_ConvertUTF16toUTF8(lowerEmail),</span>
<a href="#l52.1344"></a><span id="l52.1344" class="difflineminus">-                                    false, aAbCard);</span>
<a href="#l52.1345"></a><span id="l52.1345" class="difflineplus">+                                    NS_ConvertUTF16toUTF8(lowerEmail), false,</span>
<a href="#l52.1346"></a><span id="l52.1346" class="difflineplus">+                                    aAbCard);</span>
<a href="#l52.1347"></a><span id="l52.1347">   }</span>
<a href="#l52.1348"></a><span id="l52.1348">   return NS_OK;</span>
<a href="#l52.1349"></a><span id="l52.1349"> }</span>
<a href="#l52.1350"></a><span id="l52.1350"> </span>
<a href="#l52.1351"></a><span id="l52.1351"> NS_IMETHODIMP nsAbMDBDirectory::GetCardFromProperty(const char *aProperty,</span>
<a href="#l52.1352"></a><span id="l52.1352">                                                     const nsACString &amp;aValue,</span>
<a href="#l52.1353"></a><span id="l52.1353">                                                     bool caseSensitive,</span>
<a href="#l52.1354"></a><span id="l52.1354" class="difflineminus">-                                                    nsIAbCard **result)</span>
<a href="#l52.1355"></a><span id="l52.1355" class="difflineminus">-{</span>
<a href="#l52.1356"></a><span id="l52.1356" class="difflineplus">+                                                    nsIAbCard **result) {</span>
<a href="#l52.1357"></a><span id="l52.1357">   NS_ENSURE_ARG(aProperty);</span>
<a href="#l52.1358"></a><span id="l52.1358">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l52.1359"></a><span id="l52.1359"> </span>
<a href="#l52.1360"></a><span id="l52.1360">   *result = nullptr;</span>
<a href="#l52.1361"></a><span id="l52.1361"> </span>
<a href="#l52.1362"></a><span id="l52.1362">   // If the value is empty, don't match.</span>
<a href="#l52.1363"></a><span id="l52.1363" class="difflineminus">-  if (aValue.IsEmpty())</span>
<a href="#l52.1364"></a><span id="l52.1364" class="difflineminus">-    return NS_OK;</span>
<a href="#l52.1365"></a><span id="l52.1365" class="difflineplus">+  if (aValue.IsEmpty()) return NS_OK;</span>
<a href="#l52.1366"></a><span id="l52.1366"> </span>
<a href="#l52.1367"></a><span id="l52.1367">   nsresult rv;</span>
<a href="#l52.1368"></a><span id="l52.1368" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.1369"></a><span id="l52.1369" class="difflineminus">-  {</span>
<a href="#l52.1370"></a><span id="l52.1370" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l52.1371"></a><span id="l52.1371">     rv = GetAbDatabase();</span>
<a href="#l52.1372"></a><span id="l52.1372">     // We can't find the database file, so we can't find the card at all.</span>
<a href="#l52.1373"></a><span id="l52.1373" class="difflineminus">-    if (rv == NS_ERROR_FILE_NOT_FOUND)</span>
<a href="#l52.1374"></a><span id="l52.1374" class="difflineminus">-      return NS_OK;</span>
<a href="#l52.1375"></a><span id="l52.1375" class="difflineplus">+    if (rv == NS_ERROR_FILE_NOT_FOUND) return NS_OK;</span>
<a href="#l52.1376"></a><span id="l52.1376">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1377"></a><span id="l52.1377">   }</span>
<a href="#l52.1378"></a><span id="l52.1378"> </span>
<a href="#l52.1379"></a><span id="l52.1379">   // nsIAddrDatabase has aCaseInsensitive as its parameter</span>
<a href="#l52.1380"></a><span id="l52.1380">   return mDatabase-&gt;GetCardFromAttribute(this, aProperty, aValue,</span>
<a href="#l52.1381"></a><span id="l52.1381">                                          !caseSensitive, result);</span>
<a href="#l52.1382"></a><span id="l52.1382"> }</span>
<a href="#l52.1383"></a><span id="l52.1383"> </span>
<a href="#l52.1384"></a><span id="l52.1384" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetCardsFromProperty(const char *aProperty,</span>
<a href="#l52.1385"></a><span id="l52.1385" class="difflineminus">-                                                     const nsACString &amp;aValue,</span>
<a href="#l52.1386"></a><span id="l52.1386" class="difflineminus">-                                                     bool caseSensitive,</span>
<a href="#l52.1387"></a><span id="l52.1387" class="difflineminus">-                                                     nsISimpleEnumerator **result)</span>
<a href="#l52.1388"></a><span id="l52.1388" class="difflineminus">-{</span>
<a href="#l52.1389"></a><span id="l52.1389" class="difflineplus">+NS_IMETHODIMP nsAbMDBDirectory::GetCardsFromProperty(</span>
<a href="#l52.1390"></a><span id="l52.1390" class="difflineplus">+    const char *aProperty, const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l52.1391"></a><span id="l52.1391" class="difflineplus">+    nsISimpleEnumerator **result) {</span>
<a href="#l52.1392"></a><span id="l52.1392">   NS_ENSURE_ARG(aProperty);</span>
<a href="#l52.1393"></a><span id="l52.1393">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l52.1394"></a><span id="l52.1394"> </span>
<a href="#l52.1395"></a><span id="l52.1395">   *result = nullptr;</span>
<a href="#l52.1396"></a><span id="l52.1396"> </span>
<a href="#l52.1397"></a><span id="l52.1397" class="difflineminus">-  if (aValue.IsEmpty())</span>
<a href="#l52.1398"></a><span id="l52.1398" class="difflineminus">-    return NS_OK;</span>
<a href="#l52.1399"></a><span id="l52.1399" class="difflineplus">+  if (aValue.IsEmpty()) return NS_OK;</span>
<a href="#l52.1400"></a><span id="l52.1400"> </span>
<a href="#l52.1401"></a><span id="l52.1401" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l52.1402"></a><span id="l52.1402" class="difflineminus">-  {</span>
<a href="#l52.1403"></a><span id="l52.1403" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l52.1404"></a><span id="l52.1404">     nsresult rv = GetAbDatabase();</span>
<a href="#l52.1405"></a><span id="l52.1405" class="difflineminus">-    if (rv == NS_ERROR_FILE_NOT_FOUND)</span>
<a href="#l52.1406"></a><span id="l52.1406" class="difflineminus">-      return NS_OK;</span>
<a href="#l52.1407"></a><span id="l52.1407" class="difflineplus">+    if (rv == NS_ERROR_FILE_NOT_FOUND) return NS_OK;</span>
<a href="#l52.1408"></a><span id="l52.1408">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.1409"></a><span id="l52.1409">   }</span>
<a href="#l52.1410"></a><span id="l52.1410"> </span>
<a href="#l52.1411"></a><span id="l52.1411">   return mDatabase-&gt;GetCardsFromAttribute(this, aProperty, aValue,</span>
<a href="#l52.1412"></a><span id="l52.1412">                                           !caseSensitive, result);</span>
<a href="#l52.1413"></a><span id="l52.1413"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.h</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.h</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -22,78 +22,83 @@</span>
<a href="#l53.4"></a><span id="l53.4"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l53.5"></a><span id="l53.5"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l53.6"></a><span id="l53.6"> #include &quot;nsIAddrDBListener.h&quot;</span>
<a href="#l53.7"></a><span id="l53.7"> </span>
<a href="#l53.8"></a><span id="l53.8"> /*</span>
<a href="#l53.9"></a><span id="l53.9">  * Address Book Directory</span>
<a href="#l53.10"></a><span id="l53.10">  */</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-class nsAbMDBDirectory:</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-  public nsAbMDBDirProperty,  // nsIAbDirectory, nsIAbMDBDirectory</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-  public nsIAbDirSearchListener,</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineminus">-  public nsIAddrDBListener,</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineminus">-  public nsIAbDirectorySearch</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineminus">-{</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineminus">-public:</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+class nsAbMDBDirectory</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+    : public nsAbMDBDirProperty,  // nsIAbDirectory, nsIAbMDBDirectory</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+      public nsIAbDirSearchListener,</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+      public nsIAddrDBListener,</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+      public nsIAbDirectorySearch {</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+ public:</span>
<a href="#l53.25"></a><span id="l53.25">   nsAbMDBDirectory(void);</span>
<a href="#l53.26"></a><span id="l53.26"> </span>
<a href="#l53.27"></a><span id="l53.27">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l53.28"></a><span id="l53.28">   NS_DECL_NSIADDRDBLISTENER</span>
<a href="#l53.29"></a><span id="l53.29"> </span>
<a href="#l53.30"></a><span id="l53.30">   // Override nsAbMDBDirProperty::Init</span>
<a href="#l53.31"></a><span id="l53.31">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l53.32"></a><span id="l53.32"> </span>
<a href="#l53.33"></a><span id="l53.33">   // nsIAbMDBDirectory methods</span>
<a href="#l53.34"></a><span id="l53.34">   NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l53.35"></a><span id="l53.35">   NS_IMETHOD ClearDatabase() override;</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-  NS_IMETHOD NotifyDirItemAdded(nsISupports *item) override { return NotifyItemAdded(item);}</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineplus">+  NS_IMETHOD NotifyDirItemAdded(nsISupports *item) override {</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineplus">+    return NotifyItemAdded(item);</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+  }</span>
<a href="#l53.40"></a><span id="l53.40">   NS_IMETHOD RemoveElementsFromAddressList() override;</span>
<a href="#l53.41"></a><span id="l53.41">   NS_IMETHOD RemoveEmailAddressAt(uint32_t aIndex) override;</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineminus">-  NS_IMETHOD AddDirectory(const char *uriName, nsIAbDirectory **childDir) override;</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineplus">+  NS_IMETHOD AddDirectory(const char *uriName,</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineplus">+                          nsIAbDirectory **childDir) override;</span>
<a href="#l53.45"></a><span id="l53.45">   NS_IMETHOD GetDatabaseFile(nsIFile **aResult) override;</span>
<a href="#l53.46"></a><span id="l53.46">   NS_IMETHOD GetDatabase(nsIAddrDatabase **aResult) override;</span>
<a href="#l53.47"></a><span id="l53.47"> </span>
<a href="#l53.48"></a><span id="l53.48">   // nsIAbDirectory methods:</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineminus">-  NS_IMETHOD GetChildNodes(nsISimpleEnumerator* *result) override;</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-  NS_IMETHOD GetChildCards(nsISimpleEnumerator* *result) override;</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+  NS_IMETHOD GetChildNodes(nsISimpleEnumerator **result) override;</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineplus">+  NS_IMETHOD GetChildCards(nsISimpleEnumerator **result) override;</span>
<a href="#l53.53"></a><span id="l53.53">   NS_IMETHOD GetIsQuery(bool *aResult) override;</span>
<a href="#l53.54"></a><span id="l53.54">   NS_IMETHOD DeleteDirectory(nsIAbDirectory *directory) override;</span>
<a href="#l53.55"></a><span id="l53.55">   NS_IMETHOD DeleteCards(nsIArray *cards) override;</span>
<a href="#l53.56"></a><span id="l53.56">   NS_IMETHOD HasCard(nsIAbCard *cards, bool *hasCard) override;</span>
<a href="#l53.57"></a><span id="l53.57">   NS_IMETHOD HasDirectory(nsIAbDirectory *dir, bool *hasDir) override;</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineminus">-  NS_IMETHOD HasMailListWithName(const char16_t *aName, bool *aHasList) override;</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineminus">-  NS_IMETHOD AddMailList(nsIAbDirectory *list, nsIAbDirectory **addedList) override;</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineplus">+  NS_IMETHOD HasMailListWithName(const char16_t *aName,</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineplus">+                                 bool *aHasList) override;</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+  NS_IMETHOD AddMailList(nsIAbDirectory *list,</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+                         nsIAbDirectory **addedList) override;</span>
<a href="#l53.64"></a><span id="l53.64">   NS_IMETHOD AddCard(nsIAbCard *card, nsIAbCard **addedCard) override;</span>
<a href="#l53.65"></a><span id="l53.65">   NS_IMETHOD ModifyCard(nsIAbCard *aModifiedCard) override;</span>
<a href="#l53.66"></a><span id="l53.66">   NS_IMETHOD DropCard(nsIAbCard *card, bool needToCopyCard) override;</span>
<a href="#l53.67"></a><span id="l53.67">   NS_IMETHOD EditMailListToDatabase(nsIAbCard *listCard) override;</span>
<a href="#l53.68"></a><span id="l53.68">   NS_IMETHOD CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineminus">-                                 nsIAbCard ** aAbCard) override;</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+                                 nsIAbCard **aAbCard) override;</span>
<a href="#l53.71"></a><span id="l53.71">   NS_IMETHOD GetCardFromProperty(const char *aProperty,</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineminus">-                                 const nsACString &amp;aValue,</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineminus">-                                 bool caseSensitive, nsIAbCard **result) override;</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineplus">+                                 const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineplus">+                                 nsIAbCard **result) override;</span>
<a href="#l53.76"></a><span id="l53.76">   NS_IMETHOD GetCardsFromProperty(const char *aProperty,</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineminus">-                                  const nsACString &amp;aValue,</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineminus">-                                  bool caseSensitive,</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineplus">+                                  const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l53.80"></a><span id="l53.80">                                   nsISimpleEnumerator **result) override;</span>
<a href="#l53.81"></a><span id="l53.81"> </span>
<a href="#l53.82"></a><span id="l53.82">   // nsIAbDirectorySearch methods</span>
<a href="#l53.83"></a><span id="l53.83">   NS_DECL_NSIABDIRECTORYSEARCH</span>
<a href="#l53.84"></a><span id="l53.84"> </span>
<a href="#l53.85"></a><span id="l53.85">   // nsIAbDirSearchListener methods</span>
<a href="#l53.86"></a><span id="l53.86">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l53.87"></a><span id="l53.87"> </span>
<a href="#l53.88"></a><span id="l53.88" class="difflineminus">-protected:</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineplus">+ protected:</span>
<a href="#l53.90"></a><span id="l53.90">   virtual ~nsAbMDBDirectory();</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineminus">-  nsresult NotifyPropertyChanged(nsIAbDirectory *list, const char *property, const char16_t* oldValue, const char16_t* newValue);</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineplus">+  nsresult NotifyPropertyChanged(nsIAbDirectory *list, const char *property,</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineplus">+                                 const char16_t *oldValue,</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineplus">+                                 const char16_t *newValue);</span>
<a href="#l53.95"></a><span id="l53.95">   nsresult NotifyItemAdded(nsISupports *item);</span>
<a href="#l53.96"></a><span id="l53.96">   nsresult NotifyItemDeleted(nsISupports *item);</span>
<a href="#l53.97"></a><span id="l53.97">   nsresult NotifyItemChanged(nsISupports *item);</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineminus">-  nsresult RemoveCardFromAddressList(nsIAbCard* card);</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineplus">+  nsresult RemoveCardFromAddressList(nsIAbCard *card);</span>
<a href="#l53.100"></a><span id="l53.100"> </span>
<a href="#l53.101"></a><span id="l53.101">   nsresult GetAbDatabase();</span>
<a href="#l53.102"></a><span id="l53.102">   nsCOMPtr&lt;nsIAddrDatabase&gt; mDatabase;</span>
<a href="#l53.103"></a><span id="l53.103"> </span>
<a href="#l53.104"></a><span id="l53.104">   nsCOMArray&lt;nsIAbDirectory&gt; mSubDirectories;</span>
<a href="#l53.105"></a><span id="l53.105"> </span>
<a href="#l53.106"></a><span id="l53.106">   int32_t mContext;</span>
<a href="#l53.107"></a><span id="l53.107">   bool mPerformingQuery;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -30,19 +30,18 @@</span>
<a href="#l54.4"></a><span id="l54.4"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l54.5"></a><span id="l54.5"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l54.6"></a><span id="l54.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l54.7"></a><span id="l54.7"> #include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l54.8"></a><span id="l54.8"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l54.9"></a><span id="l54.9"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l54.10"></a><span id="l54.10"> using namespace mozilla;</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-struct ExportAttributesTableStruct</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-{</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-  const char* abPropertyName;</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+struct ExportAttributesTableStruct {</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+  const char *abPropertyName;</span>
<a href="#l54.17"></a><span id="l54.17">   uint32_t plainTextStringID;</span>
<a href="#l54.18"></a><span id="l54.18"> };</span>
<a href="#l54.19"></a><span id="l54.19"> </span>
<a href="#l54.20"></a><span id="l54.20"> // our schema is not fixed yet, but we still want some sort of objectclass</span>
<a href="#l54.21"></a><span id="l54.21"> // for now, use obsolete in the class name, hinting that this will change</span>
<a href="#l54.22"></a><span id="l54.22"> // see bugs bug #116692 and #118454</span>
<a href="#l54.23"></a><span id="l54.23"> #define MOZ_AB_OBJECTCLASS &quot;mozillaAbPersonAlpha&quot;</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25" class="difflineat">@@ -56,131 +55,97 @@ struct ExportAttributesTableStruct</span>
<a href="#l54.26"></a><span id="l54.26"> // here's how we're coming up with the ldapPropertyName values</span>
<a href="#l54.27"></a><span id="l54.27"> // if they are specified in RFC 2798, use them</span>
<a href="#l54.28"></a><span id="l54.28"> // else use the 4.x LDIF attribute names (for example, &quot;xmozillanickname&quot;</span>
<a href="#l54.29"></a><span id="l54.29"> // as we want to allow export from mozilla back to 4.x, and other apps</span>
<a href="#l54.30"></a><span id="l54.30"> // are probably out there that can handle 4.x LDIF)</span>
<a href="#l54.31"></a><span id="l54.31"> // else use the MOZ_AB_LDIF_PREFIX prefix, see nsIAddrDatabase.idl</span>
<a href="#l54.32"></a><span id="l54.32"> </span>
<a href="#l54.33"></a><span id="l54.33"> const ExportAttributesTableStruct EXPORT_ATTRIBUTES_TABLE[] = {</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineminus">-  {kFirstNameProperty, 2100},</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineminus">-  {kLastNameProperty, 2101},</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineminus">-  {kDisplayNameProperty, 2102},</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineminus">-  {kNicknameProperty, 2103},</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineminus">-  {kPriEmailProperty, 2104},</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineminus">-  {k2ndEmailProperty, 2105},</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineminus">-  {kScreenNameProperty, 2136},</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineminus">-  {kPreferMailFormatProperty, 0},</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineminus">-  {kLastModifiedDateProperty, 0},</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineminus">-  {kWorkPhoneProperty, 2106},</span>
<a href="#l54.44"></a><span id="l54.44" class="difflineminus">-  {kWorkPhoneTypeProperty, 0},</span>
<a href="#l54.45"></a><span id="l54.45" class="difflineminus">-  {kHomePhoneProperty, 2107},</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineminus">-  {kHomePhoneTypeProperty, 0},</span>
<a href="#l54.47"></a><span id="l54.47" class="difflineminus">-  {kFaxProperty, 2108},</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineminus">-  {kFaxTypeProperty, 0},</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineminus">-  {kPagerProperty, 2109},</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineminus">-  {kPagerTypeProperty, 0},</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">-  {kCellularProperty, 2110},</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineminus">-  {kCellularTypeProperty, 0},</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineminus">-  {kHomeAddressProperty, 2111},</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineminus">-  {kHomeAddress2Property, 2112},</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineminus">-  {kHomeCityProperty, 2113},</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineminus">-  {kHomeStateProperty, 2114},</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineminus">-  {kHomeZipCodeProperty, 2115},</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineminus">-  {kHomeCountryProperty, 2116},</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineminus">-  {kWorkAddressProperty, 2117},</span>
<a href="#l54.60"></a><span id="l54.60" class="difflineminus">-  {kWorkAddress2Property, 2118},</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineminus">-  {kWorkCityProperty, 2119},</span>
<a href="#l54.62"></a><span id="l54.62" class="difflineminus">-  {kWorkStateProperty, 2120},</span>
<a href="#l54.63"></a><span id="l54.63" class="difflineminus">-  {kWorkZipCodeProperty, 2121},</span>
<a href="#l54.64"></a><span id="l54.64" class="difflineminus">-  {kWorkCountryProperty, 2122},</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineminus">-  {kJobTitleProperty, 2123},</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineminus">-  {kDepartmentProperty, 2124},</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineminus">-  {kCompanyProperty, 2125},</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineminus">-  {kWorkWebPageProperty, 2126},</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineminus">-  {kHomeWebPageProperty, 2127},</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineminus">-  {kBirthYearProperty, 2128}, // unused for now</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineminus">-  {kBirthMonthProperty, 2129}, // unused for now</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineminus">-  {kBirthDayProperty, 2130}, // unused for now</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineminus">-  {kCustom1Property, 2131},</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineminus">-  {kCustom2Property, 2132},</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineminus">-  {kCustom3Property, 2133},</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineminus">-  {kCustom4Property, 2134},</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineminus">-  {kNotesProperty, 2135},</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineminus">-  {kAnniversaryYearProperty, 0},</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineminus">-  {kAnniversaryMonthProperty, 0},</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineminus">-  {kAnniversaryDayProperty, 0},</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineminus">-  {kSpouseNameProperty, 0},</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineminus">-  {kFamilyNameProperty, 0},</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineplus">+    {kFirstNameProperty, 2100},     {kLastNameProperty, 2101},</span>
<a href="#l54.84"></a><span id="l54.84" class="difflineplus">+    {kDisplayNameProperty, 2102},   {kNicknameProperty, 2103},</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineplus">+    {kPriEmailProperty, 2104},      {k2ndEmailProperty, 2105},</span>
<a href="#l54.86"></a><span id="l54.86" class="difflineplus">+    {kScreenNameProperty, 2136},    {kPreferMailFormatProperty, 0},</span>
<a href="#l54.87"></a><span id="l54.87" class="difflineplus">+    {kLastModifiedDateProperty, 0}, {kWorkPhoneProperty, 2106},</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineplus">+    {kWorkPhoneTypeProperty, 0},    {kHomePhoneProperty, 2107},</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineplus">+    {kHomePhoneTypeProperty, 0},    {kFaxProperty, 2108},</span>
<a href="#l54.90"></a><span id="l54.90" class="difflineplus">+    {kFaxTypeProperty, 0},          {kPagerProperty, 2109},</span>
<a href="#l54.91"></a><span id="l54.91" class="difflineplus">+    {kPagerTypeProperty, 0},        {kCellularProperty, 2110},</span>
<a href="#l54.92"></a><span id="l54.92" class="difflineplus">+    {kCellularTypeProperty, 0},     {kHomeAddressProperty, 2111},</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineplus">+    {kHomeAddress2Property, 2112},  {kHomeCityProperty, 2113},</span>
<a href="#l54.94"></a><span id="l54.94" class="difflineplus">+    {kHomeStateProperty, 2114},     {kHomeZipCodeProperty, 2115},</span>
<a href="#l54.95"></a><span id="l54.95" class="difflineplus">+    {kHomeCountryProperty, 2116},   {kWorkAddressProperty, 2117},</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineplus">+    {kWorkAddress2Property, 2118},  {kWorkCityProperty, 2119},</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineplus">+    {kWorkStateProperty, 2120},     {kWorkZipCodeProperty, 2121},</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineplus">+    {kWorkCountryProperty, 2122},   {kJobTitleProperty, 2123},</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+    {kDepartmentProperty, 2124},    {kCompanyProperty, 2125},</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineplus">+    {kWorkWebPageProperty, 2126},   {kHomeWebPageProperty, 2127},</span>
<a href="#l54.101"></a><span id="l54.101" class="difflineplus">+    {kBirthYearProperty, 2128},   // unused for now</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineplus">+    {kBirthMonthProperty, 2129},  // unused for now</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineplus">+    {kBirthDayProperty, 2130},    // unused for now</span>
<a href="#l54.104"></a><span id="l54.104" class="difflineplus">+    {kCustom1Property, 2131},       {kCustom2Property, 2132},</span>
<a href="#l54.105"></a><span id="l54.105" class="difflineplus">+    {kCustom3Property, 2133},       {kCustom4Property, 2134},</span>
<a href="#l54.106"></a><span id="l54.106" class="difflineplus">+    {kNotesProperty, 2135},         {kAnniversaryYearProperty, 0},</span>
<a href="#l54.107"></a><span id="l54.107" class="difflineplus">+    {kAnniversaryMonthProperty, 0}, {kAnniversaryDayProperty, 0},</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineplus">+    {kSpouseNameProperty, 0},       {kFamilyNameProperty, 0},</span>
<a href="#l54.109"></a><span id="l54.109"> };</span>
<a href="#l54.110"></a><span id="l54.110"> </span>
<a href="#l54.111"></a><span id="l54.111"> //</span>
<a href="#l54.112"></a><span id="l54.112"> // nsAbManager</span>
<a href="#l54.113"></a><span id="l54.113"> //</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineminus">-nsAbManager::nsAbManager()</span>
<a href="#l54.115"></a><span id="l54.115" class="difflineminus">-{</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineminus">-}</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineplus">+nsAbManager::nsAbManager() {}</span>
<a href="#l54.118"></a><span id="l54.118" class="difflineplus">+</span>
<a href="#l54.119"></a><span id="l54.119" class="difflineplus">+nsAbManager::~nsAbManager() {}</span>
<a href="#l54.120"></a><span id="l54.120"> </span>
<a href="#l54.121"></a><span id="l54.121" class="difflineminus">-nsAbManager::~nsAbManager()</span>
<a href="#l54.122"></a><span id="l54.122" class="difflineminus">-{</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineminus">-}</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineplus">+NS_IMPL_ISUPPORTS(nsAbManager, nsIAbManager, nsICommandLineHandler, nsIObserver)</span>
<a href="#l54.125"></a><span id="l54.125"> </span>
<a href="#l54.126"></a><span id="l54.126" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbManager, nsIAbManager, nsICommandLineHandler,</span>
<a href="#l54.127"></a><span id="l54.127" class="difflineminus">-  nsIObserver)</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineminus">-</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineminus">-nsresult nsAbManager::Init()</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineminus">-{</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineplus">+nsresult nsAbManager::Init() {</span>
<a href="#l54.132"></a><span id="l54.132">   NS_ENSURE_TRUE(NS_IsMainThread(), NS_ERROR_FAILURE);</span>
<a href="#l54.133"></a><span id="l54.133"> </span>
<a href="#l54.134"></a><span id="l54.134">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l54.137"></a><span id="l54.137">   NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l54.138"></a><span id="l54.138"> </span>
<a href="#l54.139"></a><span id="l54.139">   nsresult rv = observerService-&gt;AddObserver(this, &quot;profile-do-change&quot;, false);</span>
<a href="#l54.140"></a><span id="l54.140">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.141"></a><span id="l54.141"> </span>
<a href="#l54.142"></a><span id="l54.142">   rv = observerService-&gt;AddObserver(this, &quot;addrbook-reload&quot;, false);</span>
<a href="#l54.143"></a><span id="l54.143">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.144"></a><span id="l54.144"> </span>
<a href="#l54.145"></a><span id="l54.145" class="difflineminus">-  rv = observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID,</span>
<a href="#l54.146"></a><span id="l54.146" class="difflineminus">-                                    false);</span>
<a href="#l54.147"></a><span id="l54.147" class="difflineplus">+  rv = observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l54.148"></a><span id="l54.148">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.149"></a><span id="l54.149"> </span>
<a href="#l54.150"></a><span id="l54.150">   return NS_OK;</span>
<a href="#l54.151"></a><span id="l54.151"> }</span>
<a href="#l54.152"></a><span id="l54.152"> </span>
<a href="#l54.153"></a><span id="l54.153"> NS_IMETHODIMP nsAbManager::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineminus">-                                   const char16_t *someData)</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineminus">-{</span>
<a href="#l54.156"></a><span id="l54.156" class="difflineplus">+                                   const char16_t *someData) {</span>
<a href="#l54.157"></a><span id="l54.157">   // The nsDirPrefs code caches all the directories that it got</span>
<a href="#l54.158"></a><span id="l54.158">   // from the first profiles prefs.js.</span>
<a href="#l54.159"></a><span id="l54.159">   // When we profile switch, we need to force it to shut down.</span>
<a href="#l54.160"></a><span id="l54.160">   // We'll re-load all the directories from the second profiles prefs.js</span>
<a href="#l54.161"></a><span id="l54.161">   // that happens in nsAbBSDirectory::GetChildNodes()</span>
<a href="#l54.162"></a><span id="l54.162">   // when we call DIR_GetDirectories().</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineminus">-  if (!strcmp(aTopic, &quot;profile-do-change&quot;))</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineminus">-  {</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineplus">+  if (!strcmp(aTopic, &quot;profile-do-change&quot;)) {</span>
<a href="#l54.166"></a><span id="l54.166">     DIR_ShutDown();</span>
<a href="#l54.167"></a><span id="l54.167">     return NS_OK;</span>
<a href="#l54.168"></a><span id="l54.168">   }</span>
<a href="#l54.169"></a><span id="l54.169"> </span>
<a href="#l54.170"></a><span id="l54.170" class="difflineminus">-  if (!strcmp(aTopic, &quot;addrbook-reload&quot;))</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineminus">-  {</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineplus">+  if (!strcmp(aTopic, &quot;addrbook-reload&quot;)) {</span>
<a href="#l54.173"></a><span id="l54.173">     DIR_ShutDown();</span>
<a href="#l54.174"></a><span id="l54.174">     mCacheTopLevelAb = nullptr;</span>
<a href="#l54.175"></a><span id="l54.175">     mAbStore.Clear();</span>
<a href="#l54.176"></a><span id="l54.176">     return NS_OK;</span>
<a href="#l54.177"></a><span id="l54.177">   }</span>
<a href="#l54.178"></a><span id="l54.178"> </span>
<a href="#l54.179"></a><span id="l54.179" class="difflineminus">-  if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l54.180"></a><span id="l54.180" class="difflineminus">-  {</span>
<a href="#l54.181"></a><span id="l54.181" class="difflineplus">+  if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID)) {</span>
<a href="#l54.182"></a><span id="l54.182">     DIR_ShutDown();</span>
<a href="#l54.183"></a><span id="l54.183"> </span>
<a href="#l54.184"></a><span id="l54.184">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l54.185"></a><span id="l54.185" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l54.186"></a><span id="l54.186" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l54.187"></a><span id="l54.187">     NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l54.188"></a><span id="l54.188"> </span>
<a href="#l54.189"></a><span id="l54.189">     nsresult rv = observerService-&gt;RemoveObserver(this, &quot;profile-do-change&quot;);</span>
<a href="#l54.190"></a><span id="l54.190">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.191"></a><span id="l54.191"> </span>
<a href="#l54.192"></a><span id="l54.192">     rv = observerService-&gt;RemoveObserver(this, &quot;addrbook-reload&quot;);</span>
<a href="#l54.193"></a><span id="l54.193">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.194"></a><span id="l54.194"> </span>
<a href="#l54.195"></a><span id="l54.195" class="difflineat">@@ -190,112 +155,105 @@ NS_IMETHODIMP nsAbManager::Observe(nsISu</span>
<a href="#l54.196"></a><span id="l54.196"> </span>
<a href="#l54.197"></a><span id="l54.197">   return NS_OK;</span>
<a href="#l54.198"></a><span id="l54.198"> }</span>
<a href="#l54.199"></a><span id="l54.199"> </span>
<a href="#l54.200"></a><span id="l54.200"> //</span>
<a href="#l54.201"></a><span id="l54.201"> // nsIAbManager</span>
<a href="#l54.202"></a><span id="l54.202"> //</span>
<a href="#l54.203"></a><span id="l54.203"> </span>
<a href="#l54.204"></a><span id="l54.204" class="difflineminus">-NS_IMETHODIMP nsAbManager::GetDirectories(nsISimpleEnumerator **aResult)</span>
<a href="#l54.205"></a><span id="l54.205" class="difflineminus">-{</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineplus">+NS_IMETHODIMP nsAbManager::GetDirectories(nsISimpleEnumerator **aResult) {</span>
<a href="#l54.207"></a><span id="l54.207">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l54.208"></a><span id="l54.208"> </span>
<a href="#l54.209"></a><span id="l54.209">   // We cache the top level AB to ensure that nsIAbDirectory items are not</span>
<a href="#l54.210"></a><span id="l54.210">   // created and dumped every time GetDirectories is called. This was causing</span>
<a href="#l54.211"></a><span id="l54.211">   // performance problems, especially with the content policy on messages</span>
<a href="#l54.212"></a><span id="l54.212">   // with lots of urls.</span>
<a href="#l54.213"></a><span id="l54.213">   nsresult rv;</span>
<a href="#l54.214"></a><span id="l54.214">   nsCOMPtr&lt;nsIAbDirectory&gt; rootAddressBook;</span>
<a href="#l54.215"></a><span id="l54.215">   rv = GetRootDirectory(getter_AddRefs(rootAddressBook));</span>
<a href="#l54.216"></a><span id="l54.216">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.217"></a><span id="l54.217"> </span>
<a href="#l54.218"></a><span id="l54.218">   return rootAddressBook-&gt;GetChildNodes(aResult);</span>
<a href="#l54.219"></a><span id="l54.219"> }</span>
<a href="#l54.220"></a><span id="l54.220"> </span>
<a href="#l54.221"></a><span id="l54.221" class="difflineminus">-nsresult</span>
<a href="#l54.222"></a><span id="l54.222" class="difflineminus">-nsAbManager::GetRootDirectory(nsIAbDirectory **aResult)</span>
<a href="#l54.223"></a><span id="l54.223" class="difflineminus">-{</span>
<a href="#l54.224"></a><span id="l54.224" class="difflineplus">+nsresult nsAbManager::GetRootDirectory(nsIAbDirectory **aResult) {</span>
<a href="#l54.225"></a><span id="l54.225">   // We cache the top level AB to ensure that nsIAbDirectory items are not</span>
<a href="#l54.226"></a><span id="l54.226">   // created and dumped every time GetDirectories is called. This was causing</span>
<a href="#l54.227"></a><span id="l54.227">   // performance problems, especially with the content policy on messages</span>
<a href="#l54.228"></a><span id="l54.228">   // with lots of urls.</span>
<a href="#l54.229"></a><span id="l54.229">   nsresult rv;</span>
<a href="#l54.230"></a><span id="l54.230"> </span>
<a href="#l54.231"></a><span id="l54.231" class="difflineminus">-  if (!mCacheTopLevelAb)</span>
<a href="#l54.232"></a><span id="l54.232" class="difflineminus">-  {</span>
<a href="#l54.233"></a><span id="l54.233" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; rootAddressBook(do_GetService(NS_ABDIRECTORY_CONTRACTID, &amp;rv));</span>
<a href="#l54.234"></a><span id="l54.234" class="difflineplus">+  if (!mCacheTopLevelAb) {</span>
<a href="#l54.235"></a><span id="l54.235" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; rootAddressBook(</span>
<a href="#l54.236"></a><span id="l54.236" class="difflineplus">+        do_GetService(NS_ABDIRECTORY_CONTRACTID, &amp;rv));</span>
<a href="#l54.237"></a><span id="l54.237">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.238"></a><span id="l54.238">     mCacheTopLevelAb = rootAddressBook;</span>
<a href="#l54.239"></a><span id="l54.239">   }</span>
<a href="#l54.240"></a><span id="l54.240"> </span>
<a href="#l54.241"></a><span id="l54.241">   NS_IF_ADDREF(*aResult = mCacheTopLevelAb);</span>
<a href="#l54.242"></a><span id="l54.242">   return NS_OK;</span>
<a href="#l54.243"></a><span id="l54.243"> }</span>
<a href="#l54.244"></a><span id="l54.244"> </span>
<a href="#l54.245"></a><span id="l54.245"> NS_IMETHODIMP nsAbManager::GetDirectoryFromId(const nsACString &amp;aDirPrefId,</span>
<a href="#l54.246"></a><span id="l54.246" class="difflineminus">-                                              nsIAbDirectory **aResult)</span>
<a href="#l54.247"></a><span id="l54.247" class="difflineminus">-{</span>
<a href="#l54.248"></a><span id="l54.248" class="difflineplus">+                                              nsIAbDirectory **aResult) {</span>
<a href="#l54.249"></a><span id="l54.249">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l54.250"></a><span id="l54.250"> </span>
<a href="#l54.251"></a><span id="l54.251">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l54.252"></a><span id="l54.252">   nsresult rv = GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l54.253"></a><span id="l54.253">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.254"></a><span id="l54.254">   nsCOMPtr&lt;nsISupports&gt; support;</span>
<a href="#l54.255"></a><span id="l54.255">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l54.256"></a><span id="l54.256"> </span>
<a href="#l54.257"></a><span id="l54.257">   bool hasMore = false;</span>
<a href="#l54.258"></a><span id="l54.258">   while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l54.259"></a><span id="l54.259">     rv = enumerator-&gt;GetNext(getter_AddRefs(support));</span>
<a href="#l54.260"></a><span id="l54.260">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.261"></a><span id="l54.261">     directory = do_QueryInterface(support, &amp;rv);</span>
<a href="#l54.262"></a><span id="l54.262">     if (NS_FAILED(rv)) {</span>
<a href="#l54.263"></a><span id="l54.263" class="difflineminus">-      NS_WARNING(&quot;Unable to select Address book nsAbManager::GetDirectoryFromId()&quot;);</span>
<a href="#l54.264"></a><span id="l54.264" class="difflineplus">+      NS_WARNING(</span>
<a href="#l54.265"></a><span id="l54.265" class="difflineplus">+          &quot;Unable to select Address book nsAbManager::GetDirectoryFromId()&quot;);</span>
<a href="#l54.266"></a><span id="l54.266">       continue;</span>
<a href="#l54.267"></a><span id="l54.267">     }</span>
<a href="#l54.268"></a><span id="l54.268"> </span>
<a href="#l54.269"></a><span id="l54.269">     nsCString dirPrefId;</span>
<a href="#l54.270"></a><span id="l54.270">     directory-&gt;GetDirPrefId(dirPrefId);</span>
<a href="#l54.271"></a><span id="l54.271">     if (dirPrefId.Equals(aDirPrefId)) {</span>
<a href="#l54.272"></a><span id="l54.272">       directory.forget(aResult);</span>
<a href="#l54.273"></a><span id="l54.273">       return NS_OK;</span>
<a href="#l54.274"></a><span id="l54.274">     }</span>
<a href="#l54.275"></a><span id="l54.275">   }</span>
<a href="#l54.276"></a><span id="l54.276"> </span>
<a href="#l54.277"></a><span id="l54.277">   return NS_OK;</span>
<a href="#l54.278"></a><span id="l54.278"> }</span>
<a href="#l54.279"></a><span id="l54.279"> </span>
<a href="#l54.280"></a><span id="l54.280"> NS_IMETHODIMP nsAbManager::GetDirectory(const nsACString &amp;aURI,</span>
<a href="#l54.281"></a><span id="l54.281" class="difflineminus">-                                        nsIAbDirectory **aResult)</span>
<a href="#l54.282"></a><span id="l54.282" class="difflineminus">-{</span>
<a href="#l54.283"></a><span id="l54.283" class="difflineplus">+                                        nsIAbDirectory **aResult) {</span>
<a href="#l54.284"></a><span id="l54.284">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l54.285"></a><span id="l54.285"> </span>
<a href="#l54.286"></a><span id="l54.286">   nsresult rv;</span>
<a href="#l54.287"></a><span id="l54.287">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l54.288"></a><span id="l54.288"> </span>
<a href="#l54.289"></a><span id="l54.289">   // Was the directory root requested?</span>
<a href="#l54.290"></a><span id="l54.290" class="difflineminus">-  if (aURI.EqualsLiteral(kAllDirectoryRoot))</span>
<a href="#l54.291"></a><span id="l54.291" class="difflineminus">-  {</span>
<a href="#l54.292"></a><span id="l54.292" class="difflineplus">+  if (aURI.EqualsLiteral(kAllDirectoryRoot)) {</span>
<a href="#l54.293"></a><span id="l54.293">     rv = GetRootDirectory(getter_AddRefs(directory));</span>
<a href="#l54.294"></a><span id="l54.294">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.295"></a><span id="l54.295">     directory.forget(aResult);</span>
<a href="#l54.296"></a><span id="l54.296">     return NS_OK;</span>
<a href="#l54.297"></a><span id="l54.297">   }</span>
<a href="#l54.298"></a><span id="l54.298"> </span>
<a href="#l54.299"></a><span id="l54.299">   // Do we have a copy of this directory already within our look-up table?</span>
<a href="#l54.300"></a><span id="l54.300" class="difflineminus">-  if (!mAbStore.Get(aURI, getter_AddRefs(directory)))</span>
<a href="#l54.301"></a><span id="l54.301" class="difflineminus">-  {</span>
<a href="#l54.302"></a><span id="l54.302" class="difflineplus">+  if (!mAbStore.Get(aURI, getter_AddRefs(directory))) {</span>
<a href="#l54.303"></a><span id="l54.303">     // The directory wasn't in our look-up table, so we need to instantiate</span>
<a href="#l54.304"></a><span id="l54.304">     // it. First, extract the scheme from the URI...</span>
<a href="#l54.305"></a><span id="l54.305"> </span>
<a href="#l54.306"></a><span id="l54.306">     nsAutoCString scheme;</span>
<a href="#l54.307"></a><span id="l54.307"> </span>
<a href="#l54.308"></a><span id="l54.308">     int32_t colon = aURI.FindChar(':');</span>
<a href="#l54.309"></a><span id="l54.309" class="difflineminus">-    if (colon &lt;= 0)</span>
<a href="#l54.310"></a><span id="l54.310" class="difflineminus">-      return NS_ERROR_MALFORMED_URI;</span>
<a href="#l54.311"></a><span id="l54.311" class="difflineplus">+    if (colon &lt;= 0) return NS_ERROR_MALFORMED_URI;</span>
<a href="#l54.312"></a><span id="l54.312">     scheme = Substring(aURI, 0, colon);</span>
<a href="#l54.313"></a><span id="l54.313"> </span>
<a href="#l54.314"></a><span id="l54.314">     // Construct the appropriate nsIAbDirectory...</span>
<a href="#l54.315"></a><span id="l54.315">     nsAutoCString contractID;</span>
<a href="#l54.316"></a><span id="l54.316">     contractID.AssignLiteral(NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX);</span>
<a href="#l54.317"></a><span id="l54.317">     contractID.Append(scheme);</span>
<a href="#l54.318"></a><span id="l54.318">     directory = do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l54.319"></a><span id="l54.319">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.320"></a><span id="l54.320" class="difflineat">@@ -305,40 +263,38 @@ NS_IMETHODIMP nsAbManager::GetDirectory(</span>
<a href="#l54.321"></a><span id="l54.321">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.322"></a><span id="l54.322"> </span>
<a href="#l54.323"></a><span id="l54.323">     // Check if this directory was initiated with a search query.  If so,</span>
<a href="#l54.324"></a><span id="l54.324">     // we don't cache it.</span>
<a href="#l54.325"></a><span id="l54.325">     bool isQuery = false;</span>
<a href="#l54.326"></a><span id="l54.326">     rv = directory-&gt;GetIsQuery(&amp;isQuery);</span>
<a href="#l54.327"></a><span id="l54.327">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.328"></a><span id="l54.328"> </span>
<a href="#l54.329"></a><span id="l54.329" class="difflineminus">-    if (!isQuery)</span>
<a href="#l54.330"></a><span id="l54.330" class="difflineminus">-      mAbStore.Put(aURI, directory);</span>
<a href="#l54.331"></a><span id="l54.331" class="difflineplus">+    if (!isQuery) mAbStore.Put(aURI, directory);</span>
<a href="#l54.332"></a><span id="l54.332">   }</span>
<a href="#l54.333"></a><span id="l54.333">   directory.forget(aResult);</span>
<a href="#l54.334"></a><span id="l54.334"> </span>
<a href="#l54.335"></a><span id="l54.335">   return NS_OK;</span>
<a href="#l54.336"></a><span id="l54.336"> }</span>
<a href="#l54.337"></a><span id="l54.337"> </span>
<a href="#l54.338"></a><span id="l54.338"> NS_IMETHODIMP nsAbManager::NewAddressBook(const nsAString &amp;aDirName,</span>
<a href="#l54.339"></a><span id="l54.339" class="difflineminus">-                                            const nsACString &amp;aURI,</span>
<a href="#l54.340"></a><span id="l54.340" class="difflineminus">-                                            const uint32_t aType,</span>
<a href="#l54.341"></a><span id="l54.341" class="difflineminus">-                                            const nsACString &amp;aPrefName,</span>
<a href="#l54.342"></a><span id="l54.342" class="difflineminus">-                                            nsACString &amp;aResult)</span>
<a href="#l54.343"></a><span id="l54.343" class="difflineminus">-{</span>
<a href="#l54.344"></a><span id="l54.344" class="difflineplus">+                                          const nsACString &amp;aURI,</span>
<a href="#l54.345"></a><span id="l54.345" class="difflineplus">+                                          const uint32_t aType,</span>
<a href="#l54.346"></a><span id="l54.346" class="difflineplus">+                                          const nsACString &amp;aPrefName,</span>
<a href="#l54.347"></a><span id="l54.347" class="difflineplus">+                                          nsACString &amp;aResult) {</span>
<a href="#l54.348"></a><span id="l54.348">   nsresult rv;</span>
<a href="#l54.349"></a><span id="l54.349"> </span>
<a href="#l54.350"></a><span id="l54.350">   nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l54.351"></a><span id="l54.351">   rv = GetRootDirectory(getter_AddRefs(parentDir));</span>
<a href="#l54.352"></a><span id="l54.352">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.353"></a><span id="l54.353" class="difflineminus">-  return parentDir-&gt;CreateNewDirectory(aDirName, aURI, aType, aPrefName, aResult);</span>
<a href="#l54.354"></a><span id="l54.354" class="difflineplus">+  return parentDir-&gt;CreateNewDirectory(aDirName, aURI, aType, aPrefName,</span>
<a href="#l54.355"></a><span id="l54.355" class="difflineplus">+                                       aResult);</span>
<a href="#l54.356"></a><span id="l54.356"> }</span>
<a href="#l54.357"></a><span id="l54.357"> </span>
<a href="#l54.358"></a><span id="l54.358" class="difflineminus">-NS_IMETHODIMP nsAbManager::DeleteAddressBook(const nsACString &amp;aURI)</span>
<a href="#l54.359"></a><span id="l54.359" class="difflineminus">-{</span>
<a href="#l54.360"></a><span id="l54.360" class="difflineplus">+NS_IMETHODIMP nsAbManager::DeleteAddressBook(const nsACString &amp;aURI) {</span>
<a href="#l54.361"></a><span id="l54.361">   // Find the address book</span>
<a href="#l54.362"></a><span id="l54.362">   nsresult rv;</span>
<a href="#l54.363"></a><span id="l54.363"> </span>
<a href="#l54.364"></a><span id="l54.364">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l54.365"></a><span id="l54.365">   rv = GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l54.366"></a><span id="l54.366">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.367"></a><span id="l54.367"> </span>
<a href="#l54.368"></a><span id="l54.368">   nsCOMPtr&lt;nsIAbDirectory&gt; rootDirectory;</span>
<a href="#l54.369"></a><span id="l54.369" class="difflineat">@@ -350,24 +306,22 @@ NS_IMETHODIMP nsAbManager::DeleteAddress</span>
<a href="#l54.370"></a><span id="l54.370">   // the look up table.</span>
<a href="#l54.371"></a><span id="l54.371">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l54.372"></a><span id="l54.372">   rv = directory-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l54.373"></a><span id="l54.373">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.374"></a><span id="l54.374"> </span>
<a href="#l54.375"></a><span id="l54.375">   nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l54.376"></a><span id="l54.376">   nsCOMPtr&lt;nsIAbDirectory&gt; childDirectory;</span>
<a href="#l54.377"></a><span id="l54.377">   bool hasMore = false;</span>
<a href="#l54.378"></a><span id="l54.378" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l54.379"></a><span id="l54.379" class="difflineminus">-  {</span>
<a href="#l54.380"></a><span id="l54.380" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l54.381"></a><span id="l54.381">     rv = enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l54.382"></a><span id="l54.382">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.383"></a><span id="l54.383"> </span>
<a href="#l54.384"></a><span id="l54.384">     childDirectory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.385"></a><span id="l54.385" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l54.386"></a><span id="l54.386" class="difflineminus">-    {</span>
<a href="#l54.387"></a><span id="l54.387" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l54.388"></a><span id="l54.388">       nsCString childURI;</span>
<a href="#l54.389"></a><span id="l54.389">       rv = childDirectory-&gt;GetURI(childURI);</span>
<a href="#l54.390"></a><span id="l54.390">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.391"></a><span id="l54.391"> </span>
<a href="#l54.392"></a><span id="l54.392">       mAbStore.Remove(childURI);</span>
<a href="#l54.393"></a><span id="l54.393">     }</span>
<a href="#l54.394"></a><span id="l54.394">   }</span>
<a href="#l54.395"></a><span id="l54.395"> </span>
<a href="#l54.396"></a><span id="l54.396" class="difflineat">@@ -382,134 +336,123 @@ NS_IMETHODIMP nsAbManager::DeleteAddress</span>
<a href="#l54.397"></a><span id="l54.397">     // must be the root address book directory.</span>
<a href="#l54.398"></a><span id="l54.398">     return rootDirectory-&gt;DeleteDirectory(directory);</span>
<a href="#l54.399"></a><span id="l54.399"> </span>
<a href="#l54.400"></a><span id="l54.400">   nsCString parentUri;</span>
<a href="#l54.401"></a><span id="l54.401">   parentUri.Append(aURI);</span>
<a href="#l54.402"></a><span id="l54.402">   int32_t pos = parentUri.RFindChar('/');</span>
<a href="#l54.403"></a><span id="l54.403"> </span>
<a href="#l54.404"></a><span id="l54.404">   // If we didn't find a /, we're in trouble.</span>
<a href="#l54.405"></a><span id="l54.405" class="difflineminus">-  if (pos == -1)</span>
<a href="#l54.406"></a><span id="l54.406" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l54.407"></a><span id="l54.407" class="difflineplus">+  if (pos == -1) return NS_ERROR_FAILURE;</span>
<a href="#l54.408"></a><span id="l54.408"> </span>
<a href="#l54.409"></a><span id="l54.409">   parentUri = StringHead(parentUri, pos);</span>
<a href="#l54.410"></a><span id="l54.410">   nsCOMPtr&lt;nsIAbDirectory&gt; parentDirectory;</span>
<a href="#l54.411"></a><span id="l54.411">   rv = GetDirectory(parentUri, getter_AddRefs(parentDirectory));</span>
<a href="#l54.412"></a><span id="l54.412">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.413"></a><span id="l54.413"> </span>
<a href="#l54.414"></a><span id="l54.414">   return parentDirectory-&gt;DeleteDirectory(directory);</span>
<a href="#l54.415"></a><span id="l54.415"> }</span>
<a href="#l54.416"></a><span id="l54.416"> </span>
<a href="#l54.417"></a><span id="l54.417" class="difflineminus">-NS_IMETHODIMP nsAbManager::AddAddressBookListener(nsIAbListener *aListener,</span>
<a href="#l54.418"></a><span id="l54.418" class="difflineminus">-                                                  abListenerNotifyFlagValue aNotifyFlags)</span>
<a href="#l54.419"></a><span id="l54.419" class="difflineminus">-{</span>
<a href="#l54.420"></a><span id="l54.420" class="difflineplus">+NS_IMETHODIMP nsAbManager::AddAddressBookListener(</span>
<a href="#l54.421"></a><span id="l54.421" class="difflineplus">+    nsIAbListener *aListener, abListenerNotifyFlagValue aNotifyFlags) {</span>
<a href="#l54.422"></a><span id="l54.422">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l54.423"></a><span id="l54.423"> </span>
<a href="#l54.424"></a><span id="l54.424">   abListener newListener(aListener, aNotifyFlags);</span>
<a href="#l54.425"></a><span id="l54.425">   mListeners.AppendElementUnlessExists(newListener);</span>
<a href="#l54.426"></a><span id="l54.426">   return NS_OK;</span>
<a href="#l54.427"></a><span id="l54.427"> }</span>
<a href="#l54.428"></a><span id="l54.428"> </span>
<a href="#l54.429"></a><span id="l54.429" class="difflineminus">-NS_IMETHODIMP nsAbManager::RemoveAddressBookListener(nsIAbListener *aListener)</span>
<a href="#l54.430"></a><span id="l54.430" class="difflineminus">-{</span>
<a href="#l54.431"></a><span id="l54.431" class="difflineplus">+NS_IMETHODIMP nsAbManager::RemoveAddressBookListener(nsIAbListener *aListener) {</span>
<a href="#l54.432"></a><span id="l54.432">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l54.433"></a><span id="l54.433"> </span>
<a href="#l54.434"></a><span id="l54.434">   mListeners.RemoveElement(aListener);</span>
<a href="#l54.435"></a><span id="l54.435">   return NS_OK;</span>
<a href="#l54.436"></a><span id="l54.436"> }</span>
<a href="#l54.437"></a><span id="l54.437"> </span>
<a href="#l54.438"></a><span id="l54.438"> #define NOTIFY_AB_LISTENERS(propertyflag_, propertyfunc_, params_) \</span>
<a href="#l54.439"></a><span id="l54.439" class="difflineminus">-  PR_BEGIN_MACRO                                                       \</span>
<a href="#l54.440"></a><span id="l54.440" class="difflineminus">-  nsTObserverArray&lt;abListener&gt;::ForwardIterator iter(mListeners);      \</span>
<a href="#l54.441"></a><span id="l54.441" class="difflineminus">-  while (iter.HasMore()) {                                             \</span>
<a href="#l54.442"></a><span id="l54.442" class="difflineminus">-    const abListener &amp;abL = iter.GetNext();                            \</span>
<a href="#l54.443"></a><span id="l54.443" class="difflineminus">-    if (abL.mNotifyFlags &amp; nsIAbListener::propertyflag_)               \</span>
<a href="#l54.444"></a><span id="l54.444" class="difflineminus">-      abL.mListener-&gt;propertyfunc_ params_;                            \</span>
<a href="#l54.445"></a><span id="l54.445" class="difflineminus">-  }                                                                    \</span>
<a href="#l54.446"></a><span id="l54.446" class="difflineplus">+  PR_BEGIN_MACRO                                                   \</span>
<a href="#l54.447"></a><span id="l54.447" class="difflineplus">+  nsTObserverArray&lt;abListener&gt;::ForwardIterator iter(mListeners);  \</span>
<a href="#l54.448"></a><span id="l54.448" class="difflineplus">+  while (iter.HasMore()) {                                         \</span>
<a href="#l54.449"></a><span id="l54.449" class="difflineplus">+    const abListener &amp;abL = iter.GetNext();                        \</span>
<a href="#l54.450"></a><span id="l54.450" class="difflineplus">+    if (abL.mNotifyFlags &amp; nsIAbListener::propertyflag_)           \</span>
<a href="#l54.451"></a><span id="l54.451" class="difflineplus">+      abL.mListener-&gt;propertyfunc_ params_;                        \</span>
<a href="#l54.452"></a><span id="l54.452" class="difflineplus">+  }                                                                \</span>
<a href="#l54.453"></a><span id="l54.453">   PR_END_MACRO</span>
<a href="#l54.454"></a><span id="l54.454"> </span>
<a href="#l54.455"></a><span id="l54.455" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyItemPropertyChanged(nsISupports *aItem,</span>
<a href="#l54.456"></a><span id="l54.456" class="difflineminus">-                                                     const char *aProperty,</span>
<a href="#l54.457"></a><span id="l54.457" class="difflineminus">-                                                     const char16_t* aOldValue,</span>
<a href="#l54.458"></a><span id="l54.458" class="difflineminus">-                                                     const char16_t* aNewValue)</span>
<a href="#l54.459"></a><span id="l54.459" class="difflineminus">-{</span>
<a href="#l54.460"></a><span id="l54.460" class="difflineplus">+NS_IMETHODIMP nsAbManager::NotifyItemPropertyChanged(</span>
<a href="#l54.461"></a><span id="l54.461" class="difflineplus">+    nsISupports *aItem, const char *aProperty, const char16_t *aOldValue,</span>
<a href="#l54.462"></a><span id="l54.462" class="difflineplus">+    const char16_t *aNewValue) {</span>
<a href="#l54.463"></a><span id="l54.463">   NOTIFY_AB_LISTENERS(itemChanged, OnItemPropertyChanged,</span>
<a href="#l54.464"></a><span id="l54.464">                       (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l54.465"></a><span id="l54.465">   return NS_OK;</span>
<a href="#l54.466"></a><span id="l54.466"> }</span>
<a href="#l54.467"></a><span id="l54.467"> </span>
<a href="#l54.468"></a><span id="l54.468" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyDirectoryItemAdded(nsIAbDirectory *aParentDirectory,</span>
<a href="#l54.469"></a><span id="l54.469" class="difflineminus">-                                                    nsISupports *aItem)</span>
<a href="#l54.470"></a><span id="l54.470" class="difflineminus">-{</span>
<a href="#l54.471"></a><span id="l54.471" class="difflineplus">+NS_IMETHODIMP nsAbManager::NotifyDirectoryItemAdded(</span>
<a href="#l54.472"></a><span id="l54.472" class="difflineplus">+    nsIAbDirectory *aParentDirectory, nsISupports *aItem) {</span>
<a href="#l54.473"></a><span id="l54.473">   NOTIFY_AB_LISTENERS(itemAdded, OnItemAdded, (aParentDirectory, aItem));</span>
<a href="#l54.474"></a><span id="l54.474">   return NS_OK;</span>
<a href="#l54.475"></a><span id="l54.475"> }</span>
<a href="#l54.476"></a><span id="l54.476"> </span>
<a href="#l54.477"></a><span id="l54.477" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyDirectoryItemDeleted(nsIAbDirectory *aParentDirectory,</span>
<a href="#l54.478"></a><span id="l54.478" class="difflineminus">-                                                      nsISupports *aItem)</span>
<a href="#l54.479"></a><span id="l54.479" class="difflineminus">-{</span>
<a href="#l54.480"></a><span id="l54.480" class="difflineplus">+NS_IMETHODIMP nsAbManager::NotifyDirectoryItemDeleted(</span>
<a href="#l54.481"></a><span id="l54.481" class="difflineplus">+    nsIAbDirectory *aParentDirectory, nsISupports *aItem) {</span>
<a href="#l54.482"></a><span id="l54.482">   NOTIFY_AB_LISTENERS(directoryItemRemoved, OnItemRemoved,</span>
<a href="#l54.483"></a><span id="l54.483">                       (aParentDirectory, aItem));</span>
<a href="#l54.484"></a><span id="l54.484">   return NS_OK;</span>
<a href="#l54.485"></a><span id="l54.485"> }</span>
<a href="#l54.486"></a><span id="l54.486"> </span>
<a href="#l54.487"></a><span id="l54.487" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyDirectoryDeleted(nsIAbDirectory *aParentDirectory,</span>
<a href="#l54.488"></a><span id="l54.488" class="difflineminus">-                                                  nsISupports *aDirectory)</span>
<a href="#l54.489"></a><span id="l54.489" class="difflineminus">-{</span>
<a href="#l54.490"></a><span id="l54.490" class="difflineplus">+NS_IMETHODIMP nsAbManager::NotifyDirectoryDeleted(</span>
<a href="#l54.491"></a><span id="l54.491" class="difflineplus">+    nsIAbDirectory *aParentDirectory, nsISupports *aDirectory) {</span>
<a href="#l54.492"></a><span id="l54.492">   NOTIFY_AB_LISTENERS(directoryRemoved, OnItemRemoved,</span>
<a href="#l54.493"></a><span id="l54.493">                       (aParentDirectory, aDirectory));</span>
<a href="#l54.494"></a><span id="l54.494">   return NS_OK;</span>
<a href="#l54.495"></a><span id="l54.495"> }</span>
<a href="#l54.496"></a><span id="l54.496"> </span>
<a href="#l54.497"></a><span id="l54.497" class="difflineminus">-NS_IMETHODIMP nsAbManager::GetUserProfileDirectory(nsIFile **userDir)</span>
<a href="#l54.498"></a><span id="l54.498" class="difflineminus">-{</span>
<a href="#l54.499"></a><span id="l54.499" class="difflineplus">+NS_IMETHODIMP nsAbManager::GetUserProfileDirectory(nsIFile **userDir) {</span>
<a href="#l54.500"></a><span id="l54.500">   NS_ENSURE_ARG_POINTER(userDir);</span>
<a href="#l54.501"></a><span id="l54.501">   *userDir = nullptr;</span>
<a href="#l54.502"></a><span id="l54.502"> </span>
<a href="#l54.503"></a><span id="l54.503">   nsresult rv;</span>
<a href="#l54.504"></a><span id="l54.504">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l54.505"></a><span id="l54.505">   nsAutoCString pathBuf;</span>
<a href="#l54.506"></a><span id="l54.506"> </span>
<a href="#l54.507"></a><span id="l54.507" class="difflineminus">-  rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(profileDir));</span>
<a href="#l54.508"></a><span id="l54.508" class="difflineplus">+  rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l54.509"></a><span id="l54.509" class="difflineplus">+                              getter_AddRefs(profileDir));</span>
<a href="#l54.510"></a><span id="l54.510">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.511"></a><span id="l54.511"> </span>
<a href="#l54.512"></a><span id="l54.512">   profileDir.forget(userDir);</span>
<a href="#l54.513"></a><span id="l54.513">   return NS_OK;</span>
<a href="#l54.514"></a><span id="l54.514"> }</span>
<a href="#l54.515"></a><span id="l54.515"> </span>
<a href="#l54.516"></a><span id="l54.516" class="difflineminus">-NS_IMETHODIMP nsAbManager::MailListNameExists(const char16_t *aName, bool *aExists)</span>
<a href="#l54.517"></a><span id="l54.517" class="difflineminus">-{</span>
<a href="#l54.518"></a><span id="l54.518" class="difflineplus">+NS_IMETHODIMP nsAbManager::MailListNameExists(const char16_t *aName,</span>
<a href="#l54.519"></a><span id="l54.519" class="difflineplus">+                                              bool *aExists) {</span>
<a href="#l54.520"></a><span id="l54.520">   nsresult rv;</span>
<a href="#l54.521"></a><span id="l54.521">   NS_ENSURE_ARG_POINTER(aExists);</span>
<a href="#l54.522"></a><span id="l54.522"> </span>
<a href="#l54.523"></a><span id="l54.523">   *aExists = false;</span>
<a href="#l54.524"></a><span id="l54.524"> </span>
<a href="#l54.525"></a><span id="l54.525">   // now get the top-level book</span>
<a href="#l54.526"></a><span id="l54.526">   nsCOMPtr&lt;nsIAbDirectory&gt; topDirectory;</span>
<a href="#l54.527"></a><span id="l54.527">   rv = GetRootDirectory(getter_AddRefs(topDirectory));</span>
<a href="#l54.528"></a><span id="l54.528"> </span>
<a href="#l54.529"></a><span id="l54.529">   // now go through the address books</span>
<a href="#l54.530"></a><span id="l54.530">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l54.531"></a><span id="l54.531">   rv = topDirectory-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l54.532"></a><span id="l54.532">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.533"></a><span id="l54.533"> </span>
<a href="#l54.534"></a><span id="l54.534">   bool hasMore;</span>
<a href="#l54.535"></a><span id="l54.535" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l54.536"></a><span id="l54.536" class="difflineminus">-  {</span>
<a href="#l54.537"></a><span id="l54.537" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l54.538"></a><span id="l54.538">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l54.539"></a><span id="l54.539">     rv = enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l54.540"></a><span id="l54.540">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.541"></a><span id="l54.541"> </span>
<a href="#l54.542"></a><span id="l54.542">     nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.543"></a><span id="l54.543" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l54.544"></a><span id="l54.544" class="difflineminus">-      continue;</span>
<a href="#l54.545"></a><span id="l54.545" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l54.546"></a><span id="l54.546"> </span>
<a href="#l54.547"></a><span id="l54.547">     rv = directory-&gt;HasMailListWithName(aName, aExists);</span>
<a href="#l54.548"></a><span id="l54.548" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *aExists)</span>
<a href="#l54.549"></a><span id="l54.549" class="difflineminus">-      return NS_OK;</span>
<a href="#l54.550"></a><span id="l54.550" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; *aExists) return NS_OK;</span>
<a href="#l54.551"></a><span id="l54.551">   }</span>
<a href="#l54.552"></a><span id="l54.552"> </span>
<a href="#l54.553"></a><span id="l54.553">   *aExists = false;</span>
<a href="#l54.554"></a><span id="l54.554">   return NS_OK;</span>
<a href="#l54.555"></a><span id="l54.555"> }</span>
<a href="#l54.556"></a><span id="l54.556"> </span>
<a href="#l54.557"></a><span id="l54.557"> #define CSV_DELIM &quot;,&quot;</span>
<a href="#l54.558"></a><span id="l54.558"> #define CSV_DELIM_LEN 1</span>
<a href="#l54.559"></a><span id="l54.559" class="difflineat">@@ -518,54 +461,55 @@ NS_IMETHODIMP nsAbManager::MailListNameE</span>
<a href="#l54.560"></a><span id="l54.560"> </span>
<a href="#l54.561"></a><span id="l54.561"> #define CSV_FILE_EXTENSION &quot;.csv&quot;</span>
<a href="#l54.562"></a><span id="l54.562"> #define TAB_FILE_EXTENSION &quot;.tab&quot;</span>
<a href="#l54.563"></a><span id="l54.563"> #define TXT_FILE_EXTENSION &quot;.txt&quot;</span>
<a href="#l54.564"></a><span id="l54.564"> #define VCF_FILE_EXTENSION &quot;.vcf&quot;</span>
<a href="#l54.565"></a><span id="l54.565"> #define LDIF_FILE_EXTENSION &quot;.ldi&quot;</span>
<a href="#l54.566"></a><span id="l54.566"> #define LDIF_FILE_EXTENSION2 &quot;.ldif&quot;</span>
<a href="#l54.567"></a><span id="l54.567"> </span>
<a href="#l54.568"></a><span id="l54.568" class="difflineminus">-enum ADDRESSBOOK_EXPORT_FILE_TYPE</span>
<a href="#l54.569"></a><span id="l54.569" class="difflineminus">-{</span>
<a href="#l54.570"></a><span id="l54.570" class="difflineminus">- CSV_EXPORT_TYPE      = 0,</span>
<a href="#l54.571"></a><span id="l54.571" class="difflineminus">- CSV_EXPORT_TYPE_UTF8 = 1,</span>
<a href="#l54.572"></a><span id="l54.572" class="difflineminus">- TAB_EXPORT_TYPE      = 2,</span>
<a href="#l54.573"></a><span id="l54.573" class="difflineminus">- TAB_EXPORT_TYPE_UTF8 = 3,</span>
<a href="#l54.574"></a><span id="l54.574" class="difflineminus">- VCF_EXPORT_TYPE      = 4,</span>
<a href="#l54.575"></a><span id="l54.575" class="difflineminus">- LDIF_EXPORT_TYPE     = 5,</span>
<a href="#l54.576"></a><span id="l54.576" class="difflineplus">+enum ADDRESSBOOK_EXPORT_FILE_TYPE {</span>
<a href="#l54.577"></a><span id="l54.577" class="difflineplus">+  CSV_EXPORT_TYPE = 0,</span>
<a href="#l54.578"></a><span id="l54.578" class="difflineplus">+  CSV_EXPORT_TYPE_UTF8 = 1,</span>
<a href="#l54.579"></a><span id="l54.579" class="difflineplus">+  TAB_EXPORT_TYPE = 2,</span>
<a href="#l54.580"></a><span id="l54.580" class="difflineplus">+  TAB_EXPORT_TYPE_UTF8 = 3,</span>
<a href="#l54.581"></a><span id="l54.581" class="difflineplus">+  VCF_EXPORT_TYPE = 4,</span>
<a href="#l54.582"></a><span id="l54.582" class="difflineplus">+  LDIF_EXPORT_TYPE = 5,</span>
<a href="#l54.583"></a><span id="l54.583"> };</span>
<a href="#l54.584"></a><span id="l54.584"> </span>
<a href="#l54.585"></a><span id="l54.585"> NS_IMPL_ISUPPORTS(nsAbManager::nsFilePickerShownCallback,</span>
<a href="#l54.586"></a><span id="l54.586">                   nsIFilePickerShownCallback)</span>
<a href="#l54.587"></a><span id="l54.587"> nsAbManager::nsFilePickerShownCallback::nsFilePickerShownCallback(</span>
<a href="#l54.588"></a><span id="l54.588" class="difflineminus">-  nsAbManager* aAbManager, nsIFilePicker* aFilePicker, nsIAbDirectory *aDirectory)</span>
<a href="#l54.589"></a><span id="l54.589" class="difflineminus">-  : mFilePicker(aFilePicker)</span>
<a href="#l54.590"></a><span id="l54.590" class="difflineminus">-  , mAbManager(aAbManager)</span>
<a href="#l54.591"></a><span id="l54.591" class="difflineminus">-  , mDirectory(aDirectory)</span>
<a href="#l54.592"></a><span id="l54.592" class="difflineminus">-{</span>
<a href="#l54.593"></a><span id="l54.593" class="difflineminus">-}</span>
<a href="#l54.594"></a><span id="l54.594" class="difflineplus">+    nsAbManager *aAbManager, nsIFilePicker *aFilePicker,</span>
<a href="#l54.595"></a><span id="l54.595" class="difflineplus">+    nsIAbDirectory *aDirectory)</span>
<a href="#l54.596"></a><span id="l54.596" class="difflineplus">+    : mFilePicker(aFilePicker),</span>
<a href="#l54.597"></a><span id="l54.597" class="difflineplus">+      mAbManager(aAbManager),</span>
<a href="#l54.598"></a><span id="l54.598" class="difflineplus">+      mDirectory(aDirectory) {}</span>
<a href="#l54.599"></a><span id="l54.599"> </span>
<a href="#l54.600"></a><span id="l54.600" class="difflineminus">-NS_IMETHODIMP nsAbManager::ExportAddressBook(mozIDOMWindowProxy *aParentWin, nsIAbDirectory *aDirectory)</span>
<a href="#l54.601"></a><span id="l54.601" class="difflineminus">-{</span>
<a href="#l54.602"></a><span id="l54.602" class="difflineplus">+NS_IMETHODIMP nsAbManager::ExportAddressBook(mozIDOMWindowProxy *aParentWin,</span>
<a href="#l54.603"></a><span id="l54.603" class="difflineplus">+                                             nsIAbDirectory *aDirectory) {</span>
<a href="#l54.604"></a><span id="l54.604">   NS_ENSURE_ARG_POINTER(aParentWin);</span>
<a href="#l54.605"></a><span id="l54.605"> </span>
<a href="#l54.606"></a><span id="l54.606">   nsresult rv;</span>
<a href="#l54.607"></a><span id="l54.607" class="difflineminus">-  nsCOMPtr&lt;nsIFilePicker&gt; filePicker = do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l54.608"></a><span id="l54.608" class="difflineplus">+  nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l54.609"></a><span id="l54.609" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l54.610"></a><span id="l54.610">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.611"></a><span id="l54.611"> </span>
<a href="#l54.612"></a><span id="l54.612">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l54.613"></a><span id="l54.613" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l54.614"></a><span id="l54.614" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l54.615"></a><span id="l54.615">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l54.616"></a><span id="l54.616">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l54.617"></a><span id="l54.617" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l54.618"></a><span id="l54.618" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l54.619"></a><span id="l54.619" class="difflineplus">+      &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l54.620"></a><span id="l54.620" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l54.621"></a><span id="l54.621">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.622"></a><span id="l54.622"> </span>
<a href="#l54.623"></a><span id="l54.623">   nsString dirName;</span>
<a href="#l54.624"></a><span id="l54.624">   aDirectory-&gt;GetDirName(dirName);</span>
<a href="#l54.625"></a><span id="l54.625" class="difflineminus">-  const char16_t *formatStrings[] = { dirName.get() };</span>
<a href="#l54.626"></a><span id="l54.626" class="difflineplus">+  const char16_t *formatStrings[] = {dirName.get()};</span>
<a href="#l54.627"></a><span id="l54.627"> </span>
<a href="#l54.628"></a><span id="l54.628">   nsString title;</span>
<a href="#l54.629"></a><span id="l54.629">   rv = bundle-&gt;FormatStringFromName(&quot;ExportAddressBookNameTitle&quot;, formatStrings,</span>
<a href="#l54.630"></a><span id="l54.630">                                     ArrayLength(formatStrings), title);</span>
<a href="#l54.631"></a><span id="l54.631">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.632"></a><span id="l54.632"> </span>
<a href="#l54.633"></a><span id="l54.633">   rv = filePicker-&gt;Init(aParentWin, title, nsIFilePicker::modeSave);</span>
<a href="#l54.634"></a><span id="l54.634">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.635"></a><span id="l54.635" class="difflineat">@@ -582,44 +526,45 @@ NS_IMETHODIMP nsAbManager::ExportAddress</span>
<a href="#l54.636"></a><span id="l54.636">   rv = bundle-&gt;GetStringFromName(&quot;CSVFilesUTF8&quot;, filterString);</span>
<a href="#l54.637"></a><span id="l54.637">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.638"></a><span id="l54.638">   rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.csv&quot;));</span>
<a href="#l54.639"></a><span id="l54.639">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.640"></a><span id="l54.640"> </span>
<a href="#l54.641"></a><span id="l54.641">   // Tab separated: System charset and UTF-8.</span>
<a href="#l54.642"></a><span id="l54.642">   rv = bundle-&gt;GetStringFromName(&quot;TABFilesSysCharset&quot;, filterString);</span>
<a href="#l54.643"></a><span id="l54.643">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.644"></a><span id="l54.644" class="difflineminus">-  rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.tab; *.txt&quot;));</span>
<a href="#l54.645"></a><span id="l54.645" class="difflineplus">+  rv =</span>
<a href="#l54.646"></a><span id="l54.646" class="difflineplus">+      filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.tab; *.txt&quot;));</span>
<a href="#l54.647"></a><span id="l54.647">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.648"></a><span id="l54.648">   rv = bundle-&gt;GetStringFromName(&quot;TABFilesUTF8&quot;, filterString);</span>
<a href="#l54.649"></a><span id="l54.649">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.650"></a><span id="l54.650" class="difflineminus">-  rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.tab; *.txt&quot;));</span>
<a href="#l54.651"></a><span id="l54.651" class="difflineplus">+  rv =</span>
<a href="#l54.652"></a><span id="l54.652" class="difflineplus">+      filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.tab; *.txt&quot;));</span>
<a href="#l54.653"></a><span id="l54.653">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.654"></a><span id="l54.654"> </span>
<a href="#l54.655"></a><span id="l54.655">   rv = bundle-&gt;GetStringFromName(&quot;VCFFiles&quot;, filterString);</span>
<a href="#l54.656"></a><span id="l54.656">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.657"></a><span id="l54.657">   rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.vcf&quot;));</span>
<a href="#l54.658"></a><span id="l54.658">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.659"></a><span id="l54.659"> </span>
<a href="#l54.660"></a><span id="l54.660">   rv = bundle-&gt;GetStringFromName(&quot;LDIFFiles&quot;, filterString);</span>
<a href="#l54.661"></a><span id="l54.661">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.662"></a><span id="l54.662" class="difflineminus">-  rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.ldi; *.ldif&quot;));</span>
<a href="#l54.663"></a><span id="l54.663" class="difflineplus">+  rv = filePicker-&gt;AppendFilter(filterString,</span>
<a href="#l54.664"></a><span id="l54.664" class="difflineplus">+                                NS_LITERAL_STRING(&quot;*.ldi; *.ldif&quot;));</span>
<a href="#l54.665"></a><span id="l54.665">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.666"></a><span id="l54.666"> </span>
<a href="#l54.667"></a><span id="l54.667">   nsCOMPtr&lt;nsIFilePickerShownCallback&gt; callback =</span>
<a href="#l54.668"></a><span id="l54.668" class="difflineminus">-    new nsAbManager::nsFilePickerShownCallback(this, filePicker, aDirectory);</span>
<a href="#l54.669"></a><span id="l54.669" class="difflineplus">+      new nsAbManager::nsFilePickerShownCallback(this, filePicker, aDirectory);</span>
<a href="#l54.670"></a><span id="l54.670">   return filePicker-&gt;Open(callback);</span>
<a href="#l54.671"></a><span id="l54.671"> }</span>
<a href="#l54.672"></a><span id="l54.672"> </span>
<a href="#l54.673"></a><span id="l54.673"> NS_IMETHODIMP</span>
<a href="#l54.674"></a><span id="l54.674" class="difflineminus">-nsAbManager::nsFilePickerShownCallback::Done(int16_t aResult)</span>
<a href="#l54.675"></a><span id="l54.675" class="difflineminus">-{</span>
<a href="#l54.676"></a><span id="l54.676" class="difflineplus">+nsAbManager::nsFilePickerShownCallback::Done(int16_t aResult) {</span>
<a href="#l54.677"></a><span id="l54.677">   nsresult rv;</span>
<a href="#l54.678"></a><span id="l54.678" class="difflineminus">-  if (aResult == nsIFilePicker::returnCancel)</span>
<a href="#l54.679"></a><span id="l54.679" class="difflineminus">-    return NS_OK;</span>
<a href="#l54.680"></a><span id="l54.680" class="difflineplus">+  if (aResult == nsIFilePicker::returnCancel) return NS_OK;</span>
<a href="#l54.681"></a><span id="l54.681"> </span>
<a href="#l54.682"></a><span id="l54.682">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l54.683"></a><span id="l54.683">   rv = mFilePicker-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l54.684"></a><span id="l54.684">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.685"></a><span id="l54.685"> </span>
<a href="#l54.686"></a><span id="l54.686">   if (aResult == nsIFilePicker::returnReplace) {</span>
<a href="#l54.687"></a><span id="l54.687">     // be extra safe and only delete when the file is really a file</span>
<a href="#l54.688"></a><span id="l54.688">     bool isFile;</span>
<a href="#l54.689"></a><span id="l54.689" class="difflineat">@@ -629,556 +574,536 @@ nsAbManager::nsFilePickerShownCallback::</span>
<a href="#l54.690"></a><span id="l54.690">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.691"></a><span id="l54.691">     }</span>
<a href="#l54.692"></a><span id="l54.692">   }</span>
<a href="#l54.693"></a><span id="l54.693"> </span>
<a href="#l54.694"></a><span id="l54.694">   // The type of export is determined by the drop-down in</span>
<a href="#l54.695"></a><span id="l54.695">   // the file picker dialog.</span>
<a href="#l54.696"></a><span id="l54.696">   int32_t exportType;</span>
<a href="#l54.697"></a><span id="l54.697">   rv = mFilePicker-&gt;GetFilterIndex(&amp;exportType);</span>
<a href="#l54.698"></a><span id="l54.698" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.699"></a><span id="l54.699" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.700"></a><span id="l54.700"> </span>
<a href="#l54.701"></a><span id="l54.701">   nsAutoString fileName;</span>
<a href="#l54.702"></a><span id="l54.702">   rv = localFile-&gt;GetLeafName(fileName);</span>
<a href="#l54.703"></a><span id="l54.703">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.704"></a><span id="l54.704"> </span>
<a href="#l54.705"></a><span id="l54.705" class="difflineminus">-  switch ( exportType )</span>
<a href="#l54.706"></a><span id="l54.706" class="difflineminus">-  {</span>
<a href="#l54.707"></a><span id="l54.707" class="difflineplus">+  switch (exportType) {</span>
<a href="#l54.708"></a><span id="l54.708">     default:</span>
<a href="#l54.709"></a><span id="l54.709" class="difflineminus">-    case LDIF_EXPORT_TYPE: // ldif</span>
<a href="#l54.710"></a><span id="l54.710" class="difflineplus">+    case LDIF_EXPORT_TYPE:  // ldif</span>
<a href="#l54.711"></a><span id="l54.711">       // If filename does not have the correct ext, add one.</span>
<a href="#l54.712"></a><span id="l54.712" class="difflineminus">-      if ((MsgFind(fileName, LDIF_FILE_EXTENSION, true, fileName.Length() - strlen(LDIF_FILE_EXTENSION)) == -1) &amp;&amp;</span>
<a href="#l54.713"></a><span id="l54.713" class="difflineminus">-          (MsgFind(fileName, LDIF_FILE_EXTENSION2, true, fileName.Length() - strlen(LDIF_FILE_EXTENSION2)) == -1)) {</span>
<a href="#l54.714"></a><span id="l54.714" class="difflineminus">-</span>
<a href="#l54.715"></a><span id="l54.715" class="difflineplus">+      if ((MsgFind(fileName, LDIF_FILE_EXTENSION, true,</span>
<a href="#l54.716"></a><span id="l54.716" class="difflineplus">+                   fileName.Length() - strlen(LDIF_FILE_EXTENSION)) == -1) &amp;&amp;</span>
<a href="#l54.717"></a><span id="l54.717" class="difflineplus">+          (MsgFind(fileName, LDIF_FILE_EXTENSION2, true,</span>
<a href="#l54.718"></a><span id="l54.718" class="difflineplus">+                   fileName.Length() - strlen(LDIF_FILE_EXTENSION2)) == -1)) {</span>
<a href="#l54.719"></a><span id="l54.719">         // Add the extension and build a new localFile.</span>
<a href="#l54.720"></a><span id="l54.720">         fileName.AppendLiteral(LDIF_FILE_EXTENSION2);</span>
<a href="#l54.721"></a><span id="l54.721">         localFile-&gt;SetLeafName(fileName);</span>
<a href="#l54.722"></a><span id="l54.722">       }</span>
<a href="#l54.723"></a><span id="l54.723">       rv = mAbManager-&gt;ExportDirectoryToLDIF(mDirectory, localFile);</span>
<a href="#l54.724"></a><span id="l54.724">       break;</span>
<a href="#l54.725"></a><span id="l54.725"> </span>
<a href="#l54.726"></a><span id="l54.726" class="difflineminus">-    case CSV_EXPORT_TYPE: // csv</span>
<a href="#l54.727"></a><span id="l54.727" class="difflineplus">+    case CSV_EXPORT_TYPE:  // csv</span>
<a href="#l54.728"></a><span id="l54.728">     case CSV_EXPORT_TYPE_UTF8:</span>
<a href="#l54.729"></a><span id="l54.729">       // If filename does not have the correct ext, add one.</span>
<a href="#l54.730"></a><span id="l54.730" class="difflineminus">-      if (MsgFind(fileName, CSV_FILE_EXTENSION, true, fileName.Length() - strlen(CSV_FILE_EXTENSION)) == -1) {</span>
<a href="#l54.731"></a><span id="l54.731" class="difflineminus">-</span>
<a href="#l54.732"></a><span id="l54.732" class="difflineplus">+      if (MsgFind(fileName, CSV_FILE_EXTENSION, true,</span>
<a href="#l54.733"></a><span id="l54.733" class="difflineplus">+                  fileName.Length() - strlen(CSV_FILE_EXTENSION)) == -1) {</span>
<a href="#l54.734"></a><span id="l54.734">         // Add the extension and build a new localFile.</span>
<a href="#l54.735"></a><span id="l54.735">         fileName.AppendLiteral(CSV_FILE_EXTENSION);</span>
<a href="#l54.736"></a><span id="l54.736">         localFile-&gt;SetLeafName(fileName);</span>
<a href="#l54.737"></a><span id="l54.737">       }</span>
<a href="#l54.738"></a><span id="l54.738">       rv = mAbManager-&gt;ExportDirectoryToDelimitedText(</span>
<a href="#l54.739"></a><span id="l54.739" class="difflineminus">-                                          mDirectory, CSV_DELIM, CSV_DELIM_LEN, localFile,</span>
<a href="#l54.740"></a><span id="l54.740" class="difflineminus">-                                          exportType==CSV_EXPORT_TYPE_UTF8);</span>
<a href="#l54.741"></a><span id="l54.741" class="difflineplus">+          mDirectory, CSV_DELIM, CSV_DELIM_LEN, localFile,</span>
<a href="#l54.742"></a><span id="l54.742" class="difflineplus">+          exportType == CSV_EXPORT_TYPE_UTF8);</span>
<a href="#l54.743"></a><span id="l54.743">       break;</span>
<a href="#l54.744"></a><span id="l54.744"> </span>
<a href="#l54.745"></a><span id="l54.745" class="difflineminus">-    case TAB_EXPORT_TYPE: // tab &amp; text</span>
<a href="#l54.746"></a><span id="l54.746" class="difflineplus">+    case TAB_EXPORT_TYPE:  // tab &amp; text</span>
<a href="#l54.747"></a><span id="l54.747">     case TAB_EXPORT_TYPE_UTF8:</span>
<a href="#l54.748"></a><span id="l54.748">       // If filename does not have the correct ext, add one.</span>
<a href="#l54.749"></a><span id="l54.749" class="difflineminus">-      if ((MsgFind(fileName, TXT_FILE_EXTENSION, true, fileName.Length() - strlen(TXT_FILE_EXTENSION)) == -1) &amp;&amp;</span>
<a href="#l54.750"></a><span id="l54.750" class="difflineminus">-          (MsgFind(fileName, TAB_FILE_EXTENSION, true, fileName.Length() - strlen(TAB_FILE_EXTENSION)) == -1)) {</span>
<a href="#l54.751"></a><span id="l54.751" class="difflineminus">-</span>
<a href="#l54.752"></a><span id="l54.752" class="difflineplus">+      if ((MsgFind(fileName, TXT_FILE_EXTENSION, true,</span>
<a href="#l54.753"></a><span id="l54.753" class="difflineplus">+                   fileName.Length() - strlen(TXT_FILE_EXTENSION)) == -1) &amp;&amp;</span>
<a href="#l54.754"></a><span id="l54.754" class="difflineplus">+          (MsgFind(fileName, TAB_FILE_EXTENSION, true,</span>
<a href="#l54.755"></a><span id="l54.755" class="difflineplus">+                   fileName.Length() - strlen(TAB_FILE_EXTENSION)) == -1)) {</span>
<a href="#l54.756"></a><span id="l54.756">         // Add the extension and build a new localFile.</span>
<a href="#l54.757"></a><span id="l54.757">         fileName.AppendLiteral(TXT_FILE_EXTENSION);</span>
<a href="#l54.758"></a><span id="l54.758">         localFile-&gt;SetLeafName(fileName);</span>
<a href="#l54.759"></a><span id="l54.759">       }</span>
<a href="#l54.760"></a><span id="l54.760">       rv = mAbManager-&gt;ExportDirectoryToDelimitedText(</span>
<a href="#l54.761"></a><span id="l54.761" class="difflineminus">-                                          mDirectory, TAB_DELIM, TAB_DELIM_LEN, localFile,</span>
<a href="#l54.762"></a><span id="l54.762" class="difflineminus">-                                          exportType==TAB_EXPORT_TYPE_UTF8);</span>
<a href="#l54.763"></a><span id="l54.763" class="difflineplus">+          mDirectory, TAB_DELIM, TAB_DELIM_LEN, localFile,</span>
<a href="#l54.764"></a><span id="l54.764" class="difflineplus">+          exportType == TAB_EXPORT_TYPE_UTF8);</span>
<a href="#l54.765"></a><span id="l54.765">       break;</span>
<a href="#l54.766"></a><span id="l54.766"> </span>
<a href="#l54.767"></a><span id="l54.767" class="difflineminus">-    case VCF_EXPORT_TYPE: // vCard</span>
<a href="#l54.768"></a><span id="l54.768" class="difflineplus">+    case VCF_EXPORT_TYPE:  // vCard</span>
<a href="#l54.769"></a><span id="l54.769">       // If filename does not have the correct ext, add one.</span>
<a href="#l54.770"></a><span id="l54.770" class="difflineminus">-      if (MsgFind(fileName, VCF_FILE_EXTENSION, true, fileName.Length() - strlen(VCF_FILE_EXTENSION)) == -1) {</span>
<a href="#l54.771"></a><span id="l54.771" class="difflineminus">-</span>
<a href="#l54.772"></a><span id="l54.772" class="difflineplus">+      if (MsgFind(fileName, VCF_FILE_EXTENSION, true,</span>
<a href="#l54.773"></a><span id="l54.773" class="difflineplus">+                  fileName.Length() - strlen(VCF_FILE_EXTENSION)) == -1) {</span>
<a href="#l54.774"></a><span id="l54.774">         // Add the extension and build a new localFile.</span>
<a href="#l54.775"></a><span id="l54.775">         fileName.AppendLiteral(VCF_FILE_EXTENSION);</span>
<a href="#l54.776"></a><span id="l54.776">         localFile-&gt;SetLeafName(fileName);</span>
<a href="#l54.777"></a><span id="l54.777">       }</span>
<a href="#l54.778"></a><span id="l54.778">       rv = mAbManager-&gt;ExportDirectoryToVCard(mDirectory, localFile);</span>
<a href="#l54.779"></a><span id="l54.779">       break;</span>
<a href="#l54.780"></a><span id="l54.780">   };</span>
<a href="#l54.781"></a><span id="l54.781"> </span>
<a href="#l54.782"></a><span id="l54.782">   return rv;</span>
<a href="#l54.783"></a><span id="l54.783"> }</span>
<a href="#l54.784"></a><span id="l54.784"> </span>
<a href="#l54.785"></a><span id="l54.785" class="difflineminus">-nsresult</span>
<a href="#l54.786"></a><span id="l54.786" class="difflineminus">-nsAbManager::ExportDirectoryToDelimitedText(nsIAbDirectory *aDirectory,</span>
<a href="#l54.787"></a><span id="l54.787" class="difflineminus">-                                            const char *aDelim,</span>
<a href="#l54.788"></a><span id="l54.788" class="difflineminus">-                                            uint32_t aDelimLen,</span>
<a href="#l54.789"></a><span id="l54.789" class="difflineminus">-                                            nsIFile *aLocalFile,</span>
<a href="#l54.790"></a><span id="l54.790" class="difflineminus">-                                            bool useUTF8)</span>
<a href="#l54.791"></a><span id="l54.791" class="difflineminus">-{</span>
<a href="#l54.792"></a><span id="l54.792" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l54.793"></a><span id="l54.793" class="difflineminus">-  nsCOMPtr &lt;nsIAbCard&gt; card;</span>
<a href="#l54.794"></a><span id="l54.794" class="difflineplus">+nsresult nsAbManager::ExportDirectoryToDelimitedText(nsIAbDirectory *aDirectory,</span>
<a href="#l54.795"></a><span id="l54.795" class="difflineplus">+                                                     const char *aDelim,</span>
<a href="#l54.796"></a><span id="l54.796" class="difflineplus">+                                                     uint32_t aDelimLen,</span>
<a href="#l54.797"></a><span id="l54.797" class="difflineplus">+                                                     nsIFile *aLocalFile,</span>
<a href="#l54.798"></a><span id="l54.798" class="difflineplus">+                                                     bool useUTF8) {</span>
<a href="#l54.799"></a><span id="l54.799" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l54.800"></a><span id="l54.800" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l54.801"></a><span id="l54.801"> </span>
<a href="#l54.802"></a><span id="l54.802">   nsresult rv;</span>
<a href="#l54.803"></a><span id="l54.803"> </span>
<a href="#l54.804"></a><span id="l54.804" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l54.805"></a><span id="l54.805" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream),</span>
<a href="#l54.806"></a><span id="l54.806" class="difflineminus">-                                      aLocalFile,</span>
<a href="#l54.807"></a><span id="l54.807" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l54.808"></a><span id="l54.808" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), aLocalFile,</span>
<a href="#l54.809"></a><span id="l54.809">                                       PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l54.810"></a><span id="l54.810">                                       0664);</span>
<a href="#l54.811"></a><span id="l54.811"> </span>
<a href="#l54.812"></a><span id="l54.812">   // the desired file may be read only</span>
<a href="#l54.813"></a><span id="l54.813" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l54.814"></a><span id="l54.814" class="difflineminus">-    return rv;</span>
<a href="#l54.815"></a><span id="l54.815" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.816"></a><span id="l54.816"> </span>
<a href="#l54.817"></a><span id="l54.817">   uint32_t i;</span>
<a href="#l54.818"></a><span id="l54.818">   uint32_t writeCount;</span>
<a href="#l54.819"></a><span id="l54.819">   uint32_t length;</span>
<a href="#l54.820"></a><span id="l54.820"> </span>
<a href="#l54.821"></a><span id="l54.821">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l54.822"></a><span id="l54.822" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l54.823"></a><span id="l54.823" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l54.824"></a><span id="l54.824">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l54.825"></a><span id="l54.825"> </span>
<a href="#l54.826"></a><span id="l54.826">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l54.827"></a><span id="l54.827" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/importMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l54.828"></a><span id="l54.828" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l54.829"></a><span id="l54.829" class="difflineplus">+      &quot;chrome://messenger/locale/importMsgs.properties&quot;,</span>
<a href="#l54.830"></a><span id="l54.830" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l54.831"></a><span id="l54.831">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.832"></a><span id="l54.832"> </span>
<a href="#l54.833"></a><span id="l54.833">   nsCString revisedName;</span>
<a href="#l54.834"></a><span id="l54.834">   nsString columnName;</span>
<a href="#l54.835"></a><span id="l54.835"> </span>
<a href="#l54.836"></a><span id="l54.836">   for (i = 0; i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l54.837"></a><span id="l54.837">     if (EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID != 0) {</span>
<a href="#l54.838"></a><span id="l54.838" class="difflineminus">-</span>
<a href="#l54.839"></a><span id="l54.839">       // We don't need to truncate the string here as getter_Copies will</span>
<a href="#l54.840"></a><span id="l54.840">       // do that for us.</span>
<a href="#l54.841"></a><span id="l54.841" class="difflineminus">-      if (NS_FAILED(bundle-&gt;GetStringFromID(EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID, columnName)))</span>
<a href="#l54.842"></a><span id="l54.842" class="difflineplus">+      if (NS_FAILED(bundle-&gt;GetStringFromID(</span>
<a href="#l54.843"></a><span id="l54.843" class="difflineplus">+              EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID, columnName)))</span>
<a href="#l54.844"></a><span id="l54.844">         columnName.AppendInt(EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID);</span>
<a href="#l54.845"></a><span id="l54.845"> </span>
<a href="#l54.846"></a><span id="l54.846">       if (useUTF8)</span>
<a href="#l54.847"></a><span id="l54.847">         CopyUTF16toUTF8(columnName, revisedName);</span>
<a href="#l54.848"></a><span id="l54.848">       else</span>
<a href="#l54.849"></a><span id="l54.849">         NS_CopyUnicodeToNative(columnName, revisedName);</span>
<a href="#l54.850"></a><span id="l54.850"> </span>
<a href="#l54.851"></a><span id="l54.851" class="difflineminus">-      rv = outputStream-&gt;Write(revisedName.get(),</span>
<a href="#l54.852"></a><span id="l54.852" class="difflineminus">-                               revisedName.Length(),</span>
<a href="#l54.853"></a><span id="l54.853" class="difflineplus">+      rv = outputStream-&gt;Write(revisedName.get(), revisedName.Length(),</span>
<a href="#l54.854"></a><span id="l54.854">                                &amp;writeCount);</span>
<a href="#l54.855"></a><span id="l54.855" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.856"></a><span id="l54.856" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.857"></a><span id="l54.857"> </span>
<a href="#l54.858"></a><span id="l54.858" class="difflineminus">-      if (revisedName.Length() != writeCount)</span>
<a href="#l54.859"></a><span id="l54.859" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l54.860"></a><span id="l54.860" class="difflineplus">+      if (revisedName.Length() != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.861"></a><span id="l54.861"> </span>
<a href="#l54.862"></a><span id="l54.862">       if (i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE) - 1) {</span>
<a href="#l54.863"></a><span id="l54.863">         rv = outputStream-&gt;Write(aDelim, aDelimLen, &amp;writeCount);</span>
<a href="#l54.864"></a><span id="l54.864" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.865"></a><span id="l54.865" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.866"></a><span id="l54.866"> </span>
<a href="#l54.867"></a><span id="l54.867" class="difflineminus">-        if (aDelimLen != writeCount)</span>
<a href="#l54.868"></a><span id="l54.868" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l54.869"></a><span id="l54.869" class="difflineplus">+        if (aDelimLen != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.870"></a><span id="l54.870">       }</span>
<a href="#l54.871"></a><span id="l54.871">     }</span>
<a href="#l54.872"></a><span id="l54.872">   }</span>
<a href="#l54.873"></a><span id="l54.873">   rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;writeCount);</span>
<a href="#l54.874"></a><span id="l54.874" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.875"></a><span id="l54.875" class="difflineminus">-  if (MSG_LINEBREAK_LEN != writeCount)</span>
<a href="#l54.876"></a><span id="l54.876" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l54.877"></a><span id="l54.877" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.878"></a><span id="l54.878" class="difflineplus">+  if (MSG_LINEBREAK_LEN != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.879"></a><span id="l54.879"> </span>
<a href="#l54.880"></a><span id="l54.880">   rv = aDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l54.881"></a><span id="l54.881">   if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l54.882"></a><span id="l54.882">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l54.883"></a><span id="l54.883">     bool more;</span>
<a href="#l54.884"></a><span id="l54.884">     while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l54.885"></a><span id="l54.885">       rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l54.886"></a><span id="l54.886">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l54.887"></a><span id="l54.887" class="difflineminus">-        nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.888"></a><span id="l54.888" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.889"></a><span id="l54.889" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.890"></a><span id="l54.890" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.891"></a><span id="l54.891"> </span>
<a href="#l54.892"></a><span id="l54.892">         bool isMailList;</span>
<a href="#l54.893"></a><span id="l54.893">         rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l54.894"></a><span id="l54.894" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.895"></a><span id="l54.895" class="difflineminus">-</span>
<a href="#l54.896"></a><span id="l54.896" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.897"></a><span id="l54.897"> </span>
<a href="#l54.898"></a><span id="l54.898">         if (isMailList) {</span>
<a href="#l54.899"></a><span id="l54.899">           // .tab, .txt and .csv aren't able to export mailing lists</span>
<a href="#l54.900"></a><span id="l54.900">           // use LDIF for that.</span>
<a href="#l54.901"></a><span id="l54.901" class="difflineminus">-        }</span>
<a href="#l54.902"></a><span id="l54.902" class="difflineminus">-        else {</span>
<a href="#l54.903"></a><span id="l54.903" class="difflineplus">+        } else {</span>
<a href="#l54.904"></a><span id="l54.904">           nsString value;</span>
<a href="#l54.905"></a><span id="l54.905">           nsCString valueCStr;</span>
<a href="#l54.906"></a><span id="l54.906"> </span>
<a href="#l54.907"></a><span id="l54.907">           for (i = 0; i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l54.908"></a><span id="l54.908">             if (EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID != 0) {</span>
<a href="#l54.909"></a><span id="l54.909" class="difflineminus">-              rv = card-&gt;GetPropertyAsAString(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l54.910"></a><span id="l54.910" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l54.911"></a><span id="l54.911" class="difflineminus">-                value.Truncate();</span>
<a href="#l54.912"></a><span id="l54.912" class="difflineplus">+              rv = card-&gt;GetPropertyAsAString(</span>
<a href="#l54.913"></a><span id="l54.913" class="difflineplus">+                  EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l54.914"></a><span id="l54.914" class="difflineplus">+              if (NS_FAILED(rv)) value.Truncate();</span>
<a href="#l54.915"></a><span id="l54.915"> </span>
<a href="#l54.916"></a><span id="l54.916" class="difflineminus">-              // If a string contains at least one comma, tab or double quote then</span>
<a href="#l54.917"></a><span id="l54.917" class="difflineminus">-              // we need to quote the entire string. Also if double quote is part</span>
<a href="#l54.918"></a><span id="l54.918" class="difflineminus">-              // of the string we need to quote the double quote(s) as well.</span>
<a href="#l54.919"></a><span id="l54.919" class="difflineplus">+              // If a string contains at least one comma, tab or double quote</span>
<a href="#l54.920"></a><span id="l54.920" class="difflineplus">+              // then we need to quote the entire string. Also if double quote</span>
<a href="#l54.921"></a><span id="l54.921" class="difflineplus">+              // is part of the string we need to quote the double quote(s) as</span>
<a href="#l54.922"></a><span id="l54.922" class="difflineplus">+              // well.</span>
<a href="#l54.923"></a><span id="l54.923">               nsAutoString newValue(value);</span>
<a href="#l54.924"></a><span id="l54.924">               bool needsQuotes = false;</span>
<a href="#l54.925"></a><span id="l54.925" class="difflineminus">-              if(newValue.FindChar('&quot;') != -1)</span>
<a href="#l54.926"></a><span id="l54.926" class="difflineminus">-              {</span>
<a href="#l54.927"></a><span id="l54.927" class="difflineplus">+              if (newValue.FindChar('&quot;') != -1) {</span>
<a href="#l54.928"></a><span id="l54.928">                 needsQuotes = true;</span>
<a href="#l54.929"></a><span id="l54.929"> </span>
<a href="#l54.930"></a><span id="l54.930">                 int32_t match = 0;</span>
<a href="#l54.931"></a><span id="l54.931">                 uint32_t offset = 0;</span>
<a href="#l54.932"></a><span id="l54.932">                 nsString oldSubstr = NS_LITERAL_STRING(&quot;\&quot;&quot;);</span>
<a href="#l54.933"></a><span id="l54.933">                 nsString newSubstr = NS_LITERAL_STRING(&quot;\&quot;\&quot;&quot;);</span>
<a href="#l54.934"></a><span id="l54.934">                 while (offset &lt; newValue.Length()) {</span>
<a href="#l54.935"></a><span id="l54.935" class="difflineminus">-                    match = newValue.Find(oldSubstr, offset);</span>
<a href="#l54.936"></a><span id="l54.936" class="difflineminus">-                    if (match == -1)</span>
<a href="#l54.937"></a><span id="l54.937" class="difflineminus">-                        break;</span>
<a href="#l54.938"></a><span id="l54.938" class="difflineplus">+                  match = newValue.Find(oldSubstr, offset);</span>
<a href="#l54.939"></a><span id="l54.939" class="difflineplus">+                  if (match == -1) break;</span>
<a href="#l54.940"></a><span id="l54.940"> </span>
<a href="#l54.941"></a><span id="l54.941" class="difflineminus">-                    newValue.Replace(offset + match, oldSubstr.Length(), newSubstr);</span>
<a href="#l54.942"></a><span id="l54.942" class="difflineminus">-                    offset += (match + newSubstr.Length());</span>
<a href="#l54.943"></a><span id="l54.943" class="difflineplus">+                  newValue.Replace(offset + match, oldSubstr.Length(),</span>
<a href="#l54.944"></a><span id="l54.944" class="difflineplus">+                                   newSubstr);</span>
<a href="#l54.945"></a><span id="l54.945" class="difflineplus">+                  offset += (match + newSubstr.Length());</span>
<a href="#l54.946"></a><span id="l54.946">                 }</span>
<a href="#l54.947"></a><span id="l54.947">               }</span>
<a href="#l54.948"></a><span id="l54.948" class="difflineminus">-              if (!needsQuotes &amp;&amp; (newValue.FindChar(',') != -1 || newValue.FindChar('\x09') != -1))</span>
<a href="#l54.949"></a><span id="l54.949" class="difflineplus">+              if (!needsQuotes &amp;&amp; (newValue.FindChar(',') != -1 ||</span>
<a href="#l54.950"></a><span id="l54.950" class="difflineplus">+                                   newValue.FindChar('\x09') != -1))</span>
<a href="#l54.951"></a><span id="l54.951">                 needsQuotes = true;</span>
<a href="#l54.952"></a><span id="l54.952"> </span>
<a href="#l54.953"></a><span id="l54.953">               // Make sure we quote if containing CR/LF.</span>
<a href="#l54.954"></a><span id="l54.954">               if (newValue.FindChar('\r') != -1 ||</span>
<a href="#l54.955"></a><span id="l54.955">                   newValue.FindChar('\n') != -1)</span>
<a href="#l54.956"></a><span id="l54.956" class="difflineminus">-                  needsQuotes = true;</span>
<a href="#l54.957"></a><span id="l54.957" class="difflineplus">+                needsQuotes = true;</span>
<a href="#l54.958"></a><span id="l54.958"> </span>
<a href="#l54.959"></a><span id="l54.959" class="difflineminus">-              if (needsQuotes)</span>
<a href="#l54.960"></a><span id="l54.960" class="difflineminus">-              {</span>
<a href="#l54.961"></a><span id="l54.961" class="difflineplus">+              if (needsQuotes) {</span>
<a href="#l54.962"></a><span id="l54.962">                 newValue.InsertLiteral(u&quot;\&quot;&quot;, 0);</span>
<a href="#l54.963"></a><span id="l54.963">                 newValue.Append(u'&quot;');</span>
<a href="#l54.964"></a><span id="l54.964">               }</span>
<a href="#l54.965"></a><span id="l54.965"> </span>
<a href="#l54.966"></a><span id="l54.966">               if (useUTF8)</span>
<a href="#l54.967"></a><span id="l54.967">                 CopyUTF16toUTF8(newValue, valueCStr);</span>
<a href="#l54.968"></a><span id="l54.968">               else</span>
<a href="#l54.969"></a><span id="l54.969">                 NS_CopyUnicodeToNative(newValue, valueCStr);</span>
<a href="#l54.970"></a><span id="l54.970"> </span>
<a href="#l54.971"></a><span id="l54.971">               length = valueCStr.Length();</span>
<a href="#l54.972"></a><span id="l54.972">               if (length) {</span>
<a href="#l54.973"></a><span id="l54.973">                 rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l54.974"></a><span id="l54.974" class="difflineminus">-                NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.975"></a><span id="l54.975" class="difflineminus">-                if (length != writeCount)</span>
<a href="#l54.976"></a><span id="l54.976" class="difflineminus">-                  return NS_ERROR_FAILURE;</span>
<a href="#l54.977"></a><span id="l54.977" class="difflineplus">+                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.978"></a><span id="l54.978" class="difflineplus">+                if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.979"></a><span id="l54.979">               }</span>
<a href="#l54.980"></a><span id="l54.980">               valueCStr = &quot;&quot;;</span>
<a href="#l54.981"></a><span id="l54.981" class="difflineminus">-            }</span>
<a href="#l54.982"></a><span id="l54.982" class="difflineminus">-            else {</span>
<a href="#l54.983"></a><span id="l54.983" class="difflineplus">+            } else {</span>
<a href="#l54.984"></a><span id="l54.984">               // something we don't support for the current export</span>
<a href="#l54.985"></a><span id="l54.985">               // for example, .tab doesn't export preferred html format</span>
<a href="#l54.986"></a><span id="l54.986" class="difflineminus">-              continue; // go to next field</span>
<a href="#l54.987"></a><span id="l54.987" class="difflineplus">+              continue;  // go to next field</span>
<a href="#l54.988"></a><span id="l54.988">             }</span>
<a href="#l54.989"></a><span id="l54.989"> </span>
<a href="#l54.990"></a><span id="l54.990">             if (i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE) - 1) {</span>
<a href="#l54.991"></a><span id="l54.991">               rv = outputStream-&gt;Write(aDelim, aDelimLen, &amp;writeCount);</span>
<a href="#l54.992"></a><span id="l54.992" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.993"></a><span id="l54.993" class="difflineminus">-              if (aDelimLen != writeCount)</span>
<a href="#l54.994"></a><span id="l54.994" class="difflineminus">-                return NS_ERROR_FAILURE;</span>
<a href="#l54.995"></a><span id="l54.995" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.996"></a><span id="l54.996" class="difflineplus">+              if (aDelimLen != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.997"></a><span id="l54.997">             }</span>
<a href="#l54.998"></a><span id="l54.998">           }</span>
<a href="#l54.999"></a><span id="l54.999"> </span>
<a href="#l54.1000"></a><span id="l54.1000">           // write out the linebreak that separates the cards</span>
<a href="#l54.1001"></a><span id="l54.1001" class="difflineminus">-          rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;writeCount);</span>
<a href="#l54.1002"></a><span id="l54.1002" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1003"></a><span id="l54.1003" class="difflineminus">-          if (MSG_LINEBREAK_LEN != writeCount)</span>
<a href="#l54.1004"></a><span id="l54.1004" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l54.1005"></a><span id="l54.1005" class="difflineplus">+          rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN,</span>
<a href="#l54.1006"></a><span id="l54.1006" class="difflineplus">+                                   &amp;writeCount);</span>
<a href="#l54.1007"></a><span id="l54.1007" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1008"></a><span id="l54.1008" class="difflineplus">+          if (MSG_LINEBREAK_LEN != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.1009"></a><span id="l54.1009">         }</span>
<a href="#l54.1010"></a><span id="l54.1010">       }</span>
<a href="#l54.1011"></a><span id="l54.1011">     }</span>
<a href="#l54.1012"></a><span id="l54.1012">   }</span>
<a href="#l54.1013"></a><span id="l54.1013"> </span>
<a href="#l54.1014"></a><span id="l54.1014">   rv = outputStream-&gt;Flush();</span>
<a href="#l54.1015"></a><span id="l54.1015" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1016"></a><span id="l54.1016" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1017"></a><span id="l54.1017"> </span>
<a href="#l54.1018"></a><span id="l54.1018">   rv = outputStream-&gt;Close();</span>
<a href="#l54.1019"></a><span id="l54.1019" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1020"></a><span id="l54.1020" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1021"></a><span id="l54.1021">   return NS_OK;</span>
<a href="#l54.1022"></a><span id="l54.1022"> }</span>
<a href="#l54.1023"></a><span id="l54.1023"> </span>
<a href="#l54.1024"></a><span id="l54.1024" class="difflineminus">-nsresult</span>
<a href="#l54.1025"></a><span id="l54.1025" class="difflineminus">-nsAbManager::ExportDirectoryToVCard(nsIAbDirectory *aDirectory, nsIFile *aLocalFile)</span>
<a href="#l54.1026"></a><span id="l54.1026" class="difflineminus">-{</span>
<a href="#l54.1027"></a><span id="l54.1027" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l54.1028"></a><span id="l54.1028" class="difflineminus">-  nsCOMPtr &lt;nsIAbCard&gt; card;</span>
<a href="#l54.1029"></a><span id="l54.1029" class="difflineplus">+nsresult nsAbManager::ExportDirectoryToVCard(nsIAbDirectory *aDirectory,</span>
<a href="#l54.1030"></a><span id="l54.1030" class="difflineplus">+                                             nsIFile *aLocalFile) {</span>
<a href="#l54.1031"></a><span id="l54.1031" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l54.1032"></a><span id="l54.1032" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l54.1033"></a><span id="l54.1033"> </span>
<a href="#l54.1034"></a><span id="l54.1034">   nsresult rv;</span>
<a href="#l54.1035"></a><span id="l54.1035"> </span>
<a href="#l54.1036"></a><span id="l54.1036" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l54.1037"></a><span id="l54.1037" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream),</span>
<a href="#l54.1038"></a><span id="l54.1038" class="difflineminus">-                                      aLocalFile,</span>
<a href="#l54.1039"></a><span id="l54.1039" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l54.1040"></a><span id="l54.1040" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), aLocalFile,</span>
<a href="#l54.1041"></a><span id="l54.1041">                                       PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l54.1042"></a><span id="l54.1042">                                       0664);</span>
<a href="#l54.1043"></a><span id="l54.1043"> </span>
<a href="#l54.1044"></a><span id="l54.1044">   // the desired file may be read only</span>
<a href="#l54.1045"></a><span id="l54.1045" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l54.1046"></a><span id="l54.1046" class="difflineminus">-    return rv;</span>
<a href="#l54.1047"></a><span id="l54.1047" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.1048"></a><span id="l54.1048"> </span>
<a href="#l54.1049"></a><span id="l54.1049">   uint32_t writeCount;</span>
<a href="#l54.1050"></a><span id="l54.1050">   uint32_t length;</span>
<a href="#l54.1051"></a><span id="l54.1051"> </span>
<a href="#l54.1052"></a><span id="l54.1052">   rv = aDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l54.1053"></a><span id="l54.1053">   if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l54.1054"></a><span id="l54.1054">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l54.1055"></a><span id="l54.1055">     bool more;</span>
<a href="#l54.1056"></a><span id="l54.1056">     while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l54.1057"></a><span id="l54.1057">       rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l54.1058"></a><span id="l54.1058">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l54.1059"></a><span id="l54.1059" class="difflineminus">-        nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.1060"></a><span id="l54.1060" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1061"></a><span id="l54.1061" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.1062"></a><span id="l54.1062" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1063"></a><span id="l54.1063"> </span>
<a href="#l54.1064"></a><span id="l54.1064">         bool isMailList;</span>
<a href="#l54.1065"></a><span id="l54.1065">         rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l54.1066"></a><span id="l54.1066" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1067"></a><span id="l54.1067" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1068"></a><span id="l54.1068"> </span>
<a href="#l54.1069"></a><span id="l54.1069">         if (isMailList) {</span>
<a href="#l54.1070"></a><span id="l54.1070">           // we don't know how to export mailing lists to vcf</span>
<a href="#l54.1071"></a><span id="l54.1071">           // use LDIF for that.</span>
<a href="#l54.1072"></a><span id="l54.1072" class="difflineminus">-        }</span>
<a href="#l54.1073"></a><span id="l54.1073" class="difflineminus">-        else {</span>
<a href="#l54.1074"></a><span id="l54.1074" class="difflineplus">+        } else {</span>
<a href="#l54.1075"></a><span id="l54.1075">           nsCString escapedValue;</span>
<a href="#l54.1076"></a><span id="l54.1076">           rv = card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;vcard&quot;), escapedValue);</span>
<a href="#l54.1077"></a><span id="l54.1077" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1078"></a><span id="l54.1078" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1079"></a><span id="l54.1079"> </span>
<a href="#l54.1080"></a><span id="l54.1080">           nsCString valueCStr;</span>
<a href="#l54.1081"></a><span id="l54.1081">           MsgUnescapeString(escapedValue, 0, valueCStr);</span>
<a href="#l54.1082"></a><span id="l54.1082"> </span>
<a href="#l54.1083"></a><span id="l54.1083">           length = valueCStr.Length();</span>
<a href="#l54.1084"></a><span id="l54.1084">           rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l54.1085"></a><span id="l54.1085" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1086"></a><span id="l54.1086" class="difflineminus">-          if (length != writeCount)</span>
<a href="#l54.1087"></a><span id="l54.1087" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l54.1088"></a><span id="l54.1088" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1089"></a><span id="l54.1089" class="difflineplus">+          if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.1090"></a><span id="l54.1090">         }</span>
<a href="#l54.1091"></a><span id="l54.1091">       }</span>
<a href="#l54.1092"></a><span id="l54.1092">     }</span>
<a href="#l54.1093"></a><span id="l54.1093">   }</span>
<a href="#l54.1094"></a><span id="l54.1094"> </span>
<a href="#l54.1095"></a><span id="l54.1095">   rv = outputStream-&gt;Flush();</span>
<a href="#l54.1096"></a><span id="l54.1096" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1097"></a><span id="l54.1097" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1098"></a><span id="l54.1098"> </span>
<a href="#l54.1099"></a><span id="l54.1099">   rv = outputStream-&gt;Close();</span>
<a href="#l54.1100"></a><span id="l54.1100" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1101"></a><span id="l54.1101" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1102"></a><span id="l54.1102">   return NS_OK;</span>
<a href="#l54.1103"></a><span id="l54.1103"> }</span>
<a href="#l54.1104"></a><span id="l54.1104"> </span>
<a href="#l54.1105"></a><span id="l54.1105" class="difflineminus">-</span>
<a href="#l54.1106"></a><span id="l54.1106" class="difflineminus">-nsresult</span>
<a href="#l54.1107"></a><span id="l54.1107" class="difflineminus">-nsAbManager::ExportDirectoryToLDIF(nsIAbDirectory *aDirectory, nsIFile *aLocalFile)</span>
<a href="#l54.1108"></a><span id="l54.1108" class="difflineminus">-{</span>
<a href="#l54.1109"></a><span id="l54.1109" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l54.1110"></a><span id="l54.1110" class="difflineminus">-  nsCOMPtr &lt;nsIAbCard&gt; card;</span>
<a href="#l54.1111"></a><span id="l54.1111" class="difflineplus">+nsresult nsAbManager::ExportDirectoryToLDIF(nsIAbDirectory *aDirectory,</span>
<a href="#l54.1112"></a><span id="l54.1112" class="difflineplus">+                                            nsIFile *aLocalFile) {</span>
<a href="#l54.1113"></a><span id="l54.1113" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l54.1114"></a><span id="l54.1114" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l54.1115"></a><span id="l54.1115"> </span>
<a href="#l54.1116"></a><span id="l54.1116">   nsresult rv;</span>
<a href="#l54.1117"></a><span id="l54.1117"> </span>
<a href="#l54.1118"></a><span id="l54.1118" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l54.1119"></a><span id="l54.1119" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream),</span>
<a href="#l54.1120"></a><span id="l54.1120" class="difflineminus">-                                      aLocalFile,</span>
<a href="#l54.1121"></a><span id="l54.1121" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l54.1122"></a><span id="l54.1122" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), aLocalFile,</span>
<a href="#l54.1123"></a><span id="l54.1123">                                       PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l54.1124"></a><span id="l54.1124">                                       0664);</span>
<a href="#l54.1125"></a><span id="l54.1125"> </span>
<a href="#l54.1126"></a><span id="l54.1126">   // the desired file may be read only</span>
<a href="#l54.1127"></a><span id="l54.1127" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l54.1128"></a><span id="l54.1128" class="difflineminus">-    return rv;</span>
<a href="#l54.1129"></a><span id="l54.1129" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.1130"></a><span id="l54.1130"> </span>
<a href="#l54.1131"></a><span id="l54.1131">   // Get the default attribute map for ldap. We use the default attribute</span>
<a href="#l54.1132"></a><span id="l54.1132">   // map rather than one for a specific server because if people want an</span>
<a href="#l54.1133"></a><span id="l54.1133">   // ldif export using a servers specific schema, then they can use ldapsearch</span>
<a href="#l54.1134"></a><span id="l54.1134" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMapService&gt; mapSrv =</span>
<a href="#l54.1135"></a><span id="l54.1135" class="difflineminus">-    do_GetService(&quot;@mozilla.org/addressbook/ldap-attribute-map-service;1&quot;, &amp;rv);</span>
<a href="#l54.1136"></a><span id="l54.1136" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPAttributeMapService&gt; mapSrv = do_GetService(</span>
<a href="#l54.1137"></a><span id="l54.1137" class="difflineplus">+      &quot;@mozilla.org/addressbook/ldap-attribute-map-service;1&quot;, &amp;rv);</span>
<a href="#l54.1138"></a><span id="l54.1138">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1139"></a><span id="l54.1139"> </span>
<a href="#l54.1140"></a><span id="l54.1140">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l54.1141"></a><span id="l54.1141" class="difflineminus">-  rv = mapSrv-&gt;GetMapForPrefBranch(NS_LITERAL_CSTRING(&quot;ldap_2.servers.default.attrmap&quot;),</span>
<a href="#l54.1142"></a><span id="l54.1142" class="difflineminus">-                                   getter_AddRefs(attrMap));</span>
<a href="#l54.1143"></a><span id="l54.1143" class="difflineplus">+  rv = mapSrv-&gt;GetMapForPrefBranch(</span>
<a href="#l54.1144"></a><span id="l54.1144" class="difflineplus">+      NS_LITERAL_CSTRING(&quot;ldap_2.servers.default.attrmap&quot;),</span>
<a href="#l54.1145"></a><span id="l54.1145" class="difflineplus">+      getter_AddRefs(attrMap));</span>
<a href="#l54.1146"></a><span id="l54.1146">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1147"></a><span id="l54.1147"> </span>
<a href="#l54.1148"></a><span id="l54.1148">   uint32_t i;</span>
<a href="#l54.1149"></a><span id="l54.1149">   uint32_t writeCount;</span>
<a href="#l54.1150"></a><span id="l54.1150">   uint32_t length;</span>
<a href="#l54.1151"></a><span id="l54.1151"> </span>
<a href="#l54.1152"></a><span id="l54.1152">   rv = aDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l54.1153"></a><span id="l54.1153">   if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l54.1154"></a><span id="l54.1154">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l54.1155"></a><span id="l54.1155">     bool more;</span>
<a href="#l54.1156"></a><span id="l54.1156">     while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l54.1157"></a><span id="l54.1157">       rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l54.1158"></a><span id="l54.1158">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l54.1159"></a><span id="l54.1159" class="difflineminus">-        nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.1160"></a><span id="l54.1160" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1161"></a><span id="l54.1161" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l54.1162"></a><span id="l54.1162" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1163"></a><span id="l54.1163"> </span>
<a href="#l54.1164"></a><span id="l54.1164">         bool isMailList;</span>
<a href="#l54.1165"></a><span id="l54.1165">         rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l54.1166"></a><span id="l54.1166" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1167"></a><span id="l54.1167" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1168"></a><span id="l54.1168"> </span>
<a href="#l54.1169"></a><span id="l54.1169">         if (isMailList) {</span>
<a href="#l54.1170"></a><span id="l54.1170">           nsCString mailListCStr;</span>
<a href="#l54.1171"></a><span id="l54.1171"> </span>
<a href="#l54.1172"></a><span id="l54.1172">           rv = AppendLDIFForMailList(card, attrMap, mailListCStr);</span>
<a href="#l54.1173"></a><span id="l54.1173" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1174"></a><span id="l54.1174" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1175"></a><span id="l54.1175"> </span>
<a href="#l54.1176"></a><span id="l54.1176">           length = mailListCStr.Length();</span>
<a href="#l54.1177"></a><span id="l54.1177">           rv = outputStream-&gt;Write(mailListCStr.get(), length, &amp;writeCount);</span>
<a href="#l54.1178"></a><span id="l54.1178" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1179"></a><span id="l54.1179" class="difflineminus">-          if (length != writeCount)</span>
<a href="#l54.1180"></a><span id="l54.1180" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l54.1181"></a><span id="l54.1181" class="difflineminus">-        }</span>
<a href="#l54.1182"></a><span id="l54.1182" class="difflineminus">-        else {</span>
<a href="#l54.1183"></a><span id="l54.1183" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1184"></a><span id="l54.1184" class="difflineplus">+          if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.1185"></a><span id="l54.1185" class="difflineplus">+        } else {</span>
<a href="#l54.1186"></a><span id="l54.1186">           nsString value;</span>
<a href="#l54.1187"></a><span id="l54.1187">           nsCString valueCStr;</span>
<a href="#l54.1188"></a><span id="l54.1188"> </span>
<a href="#l54.1189"></a><span id="l54.1189">           rv = AppendBasicLDIFForCard(card, attrMap, valueCStr);</span>
<a href="#l54.1190"></a><span id="l54.1190" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1191"></a><span id="l54.1191" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1192"></a><span id="l54.1192"> </span>
<a href="#l54.1193"></a><span id="l54.1193">           length = valueCStr.Length();</span>
<a href="#l54.1194"></a><span id="l54.1194">           rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l54.1195"></a><span id="l54.1195" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1196"></a><span id="l54.1196" class="difflineminus">-          if (length != writeCount)</span>
<a href="#l54.1197"></a><span id="l54.1197" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l54.1198"></a><span id="l54.1198" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1199"></a><span id="l54.1199" class="difflineplus">+          if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.1200"></a><span id="l54.1200"> </span>
<a href="#l54.1201"></a><span id="l54.1201">           valueCStr.Truncate();</span>
<a href="#l54.1202"></a><span id="l54.1202"> </span>
<a href="#l54.1203"></a><span id="l54.1203">           nsAutoCString ldapAttribute;</span>
<a href="#l54.1204"></a><span id="l54.1204"> </span>
<a href="#l54.1205"></a><span id="l54.1205">           for (i = 0; i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l54.1206"></a><span id="l54.1206" class="difflineminus">-            if (NS_SUCCEEDED(attrMap-&gt;GetFirstAttribute(nsDependentCString(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName),</span>
<a href="#l54.1207"></a><span id="l54.1207" class="difflineminus">-                                                        ldapAttribute)) &amp;&amp;</span>
<a href="#l54.1208"></a><span id="l54.1208" class="difflineplus">+            if (NS_SUCCEEDED(attrMap-&gt;GetFirstAttribute(</span>
<a href="#l54.1209"></a><span id="l54.1209" class="difflineplus">+                    nsDependentCString(</span>
<a href="#l54.1210"></a><span id="l54.1210" class="difflineplus">+                        EXPORT_ATTRIBUTES_TABLE[i].abPropertyName),</span>
<a href="#l54.1211"></a><span id="l54.1211" class="difflineplus">+                    ldapAttribute)) &amp;&amp;</span>
<a href="#l54.1212"></a><span id="l54.1212">                 !ldapAttribute.IsEmpty()) {</span>
<a href="#l54.1213"></a><span id="l54.1213" class="difflineplus">+              rv = card-&gt;GetPropertyAsAString(</span>
<a href="#l54.1214"></a><span id="l54.1214" class="difflineplus">+                  EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l54.1215"></a><span id="l54.1215" class="difflineplus">+              if (NS_FAILED(rv)) value.Truncate();</span>
<a href="#l54.1216"></a><span id="l54.1216"> </span>
<a href="#l54.1217"></a><span id="l54.1217" class="difflineminus">-              rv = card-&gt;GetPropertyAsAString(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l54.1218"></a><span id="l54.1218" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l54.1219"></a><span id="l54.1219" class="difflineminus">-                value.Truncate();</span>
<a href="#l54.1220"></a><span id="l54.1220" class="difflineminus">-</span>
<a href="#l54.1221"></a><span id="l54.1221" class="difflineminus">-              if (!PL_strcmp(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, kPreferMailFormatProperty)) {</span>
<a href="#l54.1222"></a><span id="l54.1222" class="difflineplus">+              if (!PL_strcmp(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName,</span>
<a href="#l54.1223"></a><span id="l54.1223" class="difflineplus">+                             kPreferMailFormatProperty)) {</span>
<a href="#l54.1224"></a><span id="l54.1224">                 if (value.EqualsLiteral(&quot;html&quot;))</span>
<a href="#l54.1225"></a><span id="l54.1225">                   value.AssignLiteral(&quot;true&quot;);</span>
<a href="#l54.1226"></a><span id="l54.1226">                 else if (value.EqualsLiteral(&quot;plaintext&quot;))</span>
<a href="#l54.1227"></a><span id="l54.1227">                   value.AssignLiteral(&quot;false&quot;);</span>
<a href="#l54.1228"></a><span id="l54.1228">                 else</span>
<a href="#l54.1229"></a><span id="l54.1229" class="difflineminus">-                  value.Truncate(); // unknown.</span>
<a href="#l54.1230"></a><span id="l54.1230" class="difflineplus">+                  value.Truncate();  // unknown.</span>
<a href="#l54.1231"></a><span id="l54.1231">               }</span>
<a href="#l54.1232"></a><span id="l54.1232"> </span>
<a href="#l54.1233"></a><span id="l54.1233">               if (!value.IsEmpty()) {</span>
<a href="#l54.1234"></a><span id="l54.1234" class="difflineminus">-                rv = AppendProperty(ldapAttribute.get(), value.get(), valueCStr);</span>
<a href="#l54.1235"></a><span id="l54.1235" class="difflineminus">-                NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1236"></a><span id="l54.1236" class="difflineplus">+                rv =</span>
<a href="#l54.1237"></a><span id="l54.1237" class="difflineplus">+                    AppendProperty(ldapAttribute.get(), value.get(), valueCStr);</span>
<a href="#l54.1238"></a><span id="l54.1238" class="difflineplus">+                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1239"></a><span id="l54.1239"> </span>
<a href="#l54.1240"></a><span id="l54.1240">                 valueCStr += MSG_LINEBREAK;</span>
<a href="#l54.1241"></a><span id="l54.1241" class="difflineminus">-              }</span>
<a href="#l54.1242"></a><span id="l54.1242" class="difflineminus">-              else</span>
<a href="#l54.1243"></a><span id="l54.1243" class="difflineplus">+              } else</span>
<a href="#l54.1244"></a><span id="l54.1244">                 valueCStr.Truncate();</span>
<a href="#l54.1245"></a><span id="l54.1245"> </span>
<a href="#l54.1246"></a><span id="l54.1246">               length = valueCStr.Length();</span>
<a href="#l54.1247"></a><span id="l54.1247">               if (length) {</span>
<a href="#l54.1248"></a><span id="l54.1248">                 rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l54.1249"></a><span id="l54.1249" class="difflineminus">-                NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1250"></a><span id="l54.1250" class="difflineminus">-                if (length != writeCount)</span>
<a href="#l54.1251"></a><span id="l54.1251" class="difflineminus">-                  return NS_ERROR_FAILURE;</span>
<a href="#l54.1252"></a><span id="l54.1252" class="difflineplus">+                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1253"></a><span id="l54.1253" class="difflineplus">+                if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.1254"></a><span id="l54.1254">               }</span>
<a href="#l54.1255"></a><span id="l54.1255">               valueCStr.Truncate();</span>
<a href="#l54.1256"></a><span id="l54.1256" class="difflineminus">-            }</span>
<a href="#l54.1257"></a><span id="l54.1257" class="difflineminus">-            else {</span>
<a href="#l54.1258"></a><span id="l54.1258" class="difflineplus">+            } else {</span>
<a href="#l54.1259"></a><span id="l54.1259">               // something we don't support yet</span>
<a href="#l54.1260"></a><span id="l54.1260">               // ldif doesn't export multiple addresses</span>
<a href="#l54.1261"></a><span id="l54.1261">             }</span>
<a href="#l54.1262"></a><span id="l54.1262">           }</span>
<a href="#l54.1263"></a><span id="l54.1263"> </span>
<a href="#l54.1264"></a><span id="l54.1264">           // write out the linebreak that separates the cards</span>
<a href="#l54.1265"></a><span id="l54.1265" class="difflineminus">-          rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;writeCount);</span>
<a href="#l54.1266"></a><span id="l54.1266" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1267"></a><span id="l54.1267" class="difflineminus">-          if (MSG_LINEBREAK_LEN != writeCount)</span>
<a href="#l54.1268"></a><span id="l54.1268" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l54.1269"></a><span id="l54.1269" class="difflineplus">+          rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN,</span>
<a href="#l54.1270"></a><span id="l54.1270" class="difflineplus">+                                   &amp;writeCount);</span>
<a href="#l54.1271"></a><span id="l54.1271" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1272"></a><span id="l54.1272" class="difflineplus">+          if (MSG_LINEBREAK_LEN != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l54.1273"></a><span id="l54.1273">         }</span>
<a href="#l54.1274"></a><span id="l54.1274">       }</span>
<a href="#l54.1275"></a><span id="l54.1275">     }</span>
<a href="#l54.1276"></a><span id="l54.1276">   }</span>
<a href="#l54.1277"></a><span id="l54.1277"> </span>
<a href="#l54.1278"></a><span id="l54.1278">   rv = outputStream-&gt;Flush();</span>
<a href="#l54.1279"></a><span id="l54.1279" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1280"></a><span id="l54.1280" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1281"></a><span id="l54.1281"> </span>
<a href="#l54.1282"></a><span id="l54.1282">   rv = outputStream-&gt;Close();</span>
<a href="#l54.1283"></a><span id="l54.1283" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1284"></a><span id="l54.1284" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1285"></a><span id="l54.1285">   return NS_OK;</span>
<a href="#l54.1286"></a><span id="l54.1286"> }</span>
<a href="#l54.1287"></a><span id="l54.1287"> </span>
<a href="#l54.1288"></a><span id="l54.1288" class="difflineminus">-nsresult nsAbManager::AppendLDIFForMailList(nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult)</span>
<a href="#l54.1289"></a><span id="l54.1289" class="difflineminus">-{</span>
<a href="#l54.1290"></a><span id="l54.1290" class="difflineplus">+nsresult nsAbManager::AppendLDIFForMailList(nsIAbCard *aCard,</span>
<a href="#l54.1291"></a><span id="l54.1291" class="difflineplus">+                                            nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l54.1292"></a><span id="l54.1292" class="difflineplus">+                                            nsACString &amp;aResult) {</span>
<a href="#l54.1293"></a><span id="l54.1293">   nsresult rv;</span>
<a href="#l54.1294"></a><span id="l54.1294">   nsString attrValue;</span>
<a href="#l54.1295"></a><span id="l54.1295"> </span>
<a href="#l54.1296"></a><span id="l54.1296">   rv = AppendDNForCard(&quot;dn&quot;, aCard, aAttrMap, aResult);</span>
<a href="#l54.1297"></a><span id="l54.1297" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1298"></a><span id="l54.1298" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1299"></a><span id="l54.1299"> </span>
<a href="#l54.1300"></a><span id="l54.1300" class="difflineminus">-  aResult += MSG_LINEBREAK \</span>
<a href="#l54.1301"></a><span id="l54.1301" class="difflineminus">-             &quot;objectclass: top&quot; MSG_LINEBREAK \</span>
<a href="#l54.1302"></a><span id="l54.1302" class="difflineminus">-             &quot;objectclass: groupOfNames&quot; MSG_LINEBREAK;</span>
<a href="#l54.1303"></a><span id="l54.1303" class="difflineplus">+  aResult += MSG_LINEBREAK &quot;objectclass: top&quot; MSG_LINEBREAK</span>
<a href="#l54.1304"></a><span id="l54.1304" class="difflineplus">+                           &quot;objectclass: groupOfNames&quot; MSG_LINEBREAK;</span>
<a href="#l54.1305"></a><span id="l54.1305"> </span>
<a href="#l54.1306"></a><span id="l54.1306">   rv = aCard-&gt;GetDisplayName(attrValue);</span>
<a href="#l54.1307"></a><span id="l54.1307" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1308"></a><span id="l54.1308" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1309"></a><span id="l54.1309"> </span>
<a href="#l54.1310"></a><span id="l54.1310">   nsAutoCString ldapAttributeName;</span>
<a href="#l54.1311"></a><span id="l54.1311"> </span>
<a href="#l54.1312"></a><span id="l54.1312">   rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameProperty),</span>
<a href="#l54.1313"></a><span id="l54.1313" class="difflineminus">-                                  ldapAttributeName);</span>
<a href="#l54.1314"></a><span id="l54.1314" class="difflineplus">+                                   ldapAttributeName);</span>
<a href="#l54.1315"></a><span id="l54.1315">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1316"></a><span id="l54.1316"> </span>
<a href="#l54.1317"></a><span id="l54.1317">   rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l54.1318"></a><span id="l54.1318" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1319"></a><span id="l54.1319" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1320"></a><span id="l54.1320">   aResult += MSG_LINEBREAK;</span>
<a href="#l54.1321"></a><span id="l54.1321"> </span>
<a href="#l54.1322"></a><span id="l54.1322">   rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNicknameProperty),</span>
<a href="#l54.1323"></a><span id="l54.1323" class="difflineminus">-                                  ldapAttributeName);</span>
<a href="#l54.1324"></a><span id="l54.1324" class="difflineplus">+                                   ldapAttributeName);</span>
<a href="#l54.1325"></a><span id="l54.1325">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1326"></a><span id="l54.1326"> </span>
<a href="#l54.1327"></a><span id="l54.1327">   rv = aCard-&gt;GetPropertyAsAString(kNicknameProperty, attrValue);</span>
<a href="#l54.1328"></a><span id="l54.1328">   if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) {</span>
<a href="#l54.1329"></a><span id="l54.1329">     rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l54.1330"></a><span id="l54.1330" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1331"></a><span id="l54.1331" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1332"></a><span id="l54.1332">     aResult += MSG_LINEBREAK;</span>
<a href="#l54.1333"></a><span id="l54.1333">   }</span>
<a href="#l54.1334"></a><span id="l54.1334"> </span>
<a href="#l54.1335"></a><span id="l54.1335">   rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNotesProperty),</span>
<a href="#l54.1336"></a><span id="l54.1336" class="difflineminus">-                                  ldapAttributeName);</span>
<a href="#l54.1337"></a><span id="l54.1337" class="difflineplus">+                                   ldapAttributeName);</span>
<a href="#l54.1338"></a><span id="l54.1338">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1339"></a><span id="l54.1339"> </span>
<a href="#l54.1340"></a><span id="l54.1340">   rv = aCard-&gt;GetPropertyAsAString(kNotesProperty, attrValue);</span>
<a href="#l54.1341"></a><span id="l54.1341">   if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) {</span>
<a href="#l54.1342"></a><span id="l54.1342">     rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l54.1343"></a><span id="l54.1343" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1344"></a><span id="l54.1344" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1345"></a><span id="l54.1345">     aResult += MSG_LINEBREAK;</span>
<a href="#l54.1346"></a><span id="l54.1346">   }</span>
<a href="#l54.1347"></a><span id="l54.1347"> </span>
<a href="#l54.1348"></a><span id="l54.1348">   nsCString mailListURI;</span>
<a href="#l54.1349"></a><span id="l54.1349">   rv = aCard-&gt;GetMailListURI(getter_Copies(mailListURI));</span>
<a href="#l54.1350"></a><span id="l54.1350">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1351"></a><span id="l54.1351"> </span>
<a href="#l54.1352"></a><span id="l54.1352" class="difflineminus">-  nsCOMPtr &lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l54.1353"></a><span id="l54.1353" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l54.1354"></a><span id="l54.1354">   rv = GetDirectory(mailListURI, getter_AddRefs(mailList));</span>
<a href="#l54.1355"></a><span id="l54.1355" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1356"></a><span id="l54.1356" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1357"></a><span id="l54.1357"> </span>
<a href="#l54.1358"></a><span id="l54.1358">   nsCOMPtr&lt;nsIMutableArray&gt; addresses;</span>
<a href="#l54.1359"></a><span id="l54.1359">   rv = mailList-&gt;GetAddressLists(getter_AddRefs(addresses));</span>
<a href="#l54.1360"></a><span id="l54.1360">   if (addresses) {</span>
<a href="#l54.1361"></a><span id="l54.1361">     uint32_t total = 0;</span>
<a href="#l54.1362"></a><span id="l54.1362">     addresses-&gt;GetLength(&amp;total);</span>
<a href="#l54.1363"></a><span id="l54.1363">     if (total) {</span>
<a href="#l54.1364"></a><span id="l54.1364">       uint32_t i;</span>
<a href="#l54.1365"></a><span id="l54.1365">       for (i = 0; i &lt; total; i++) {</span>
<a href="#l54.1366"></a><span id="l54.1366" class="difflineminus">-        nsCOMPtr &lt;nsIAbCard&gt; listCard = do_QueryElementAt(addresses, i, &amp;rv);</span>
<a href="#l54.1367"></a><span id="l54.1367" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1368"></a><span id="l54.1368" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; listCard = do_QueryElementAt(addresses, i, &amp;rv);</span>
<a href="#l54.1369"></a><span id="l54.1369" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1370"></a><span id="l54.1370"> </span>
<a href="#l54.1371"></a><span id="l54.1371">         rv = AppendDNForCard(&quot;member&quot;, listCard, aAttrMap, aResult);</span>
<a href="#l54.1372"></a><span id="l54.1372" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1373"></a><span id="l54.1373" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1374"></a><span id="l54.1374"> </span>
<a href="#l54.1375"></a><span id="l54.1375">         aResult += MSG_LINEBREAK;</span>
<a href="#l54.1376"></a><span id="l54.1376">       }</span>
<a href="#l54.1377"></a><span id="l54.1377">     }</span>
<a href="#l54.1378"></a><span id="l54.1378">   }</span>
<a href="#l54.1379"></a><span id="l54.1379"> </span>
<a href="#l54.1380"></a><span id="l54.1380">   aResult += MSG_LINEBREAK;</span>
<a href="#l54.1381"></a><span id="l54.1381">   return NS_OK;</span>
<a href="#l54.1382"></a><span id="l54.1382"> }</span>
<a href="#l54.1383"></a><span id="l54.1383"> </span>
<a href="#l54.1384"></a><span id="l54.1384" class="difflineminus">-nsresult nsAbManager::AppendDNForCard(const char *aProperty, nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult)</span>
<a href="#l54.1385"></a><span id="l54.1385" class="difflineminus">-{</span>
<a href="#l54.1386"></a><span id="l54.1386" class="difflineplus">+nsresult nsAbManager::AppendDNForCard(const char *aProperty, nsIAbCard *aCard,</span>
<a href="#l54.1387"></a><span id="l54.1387" class="difflineplus">+                                      nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l54.1388"></a><span id="l54.1388" class="difflineplus">+                                      nsACString &amp;aResult) {</span>
<a href="#l54.1389"></a><span id="l54.1389">   nsString email;</span>
<a href="#l54.1390"></a><span id="l54.1390">   nsString displayName;</span>
<a href="#l54.1391"></a><span id="l54.1391">   nsAutoCString ldapAttributeName;</span>
<a href="#l54.1392"></a><span id="l54.1392"> </span>
<a href="#l54.1393"></a><span id="l54.1393">   nsresult rv = aCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l54.1394"></a><span id="l54.1394" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1395"></a><span id="l54.1395" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1396"></a><span id="l54.1396"> </span>
<a href="#l54.1397"></a><span id="l54.1397">   rv = aCard-&gt;GetDisplayName(displayName);</span>
<a href="#l54.1398"></a><span id="l54.1398" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1399"></a><span id="l54.1399" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1400"></a><span id="l54.1400"> </span>
<a href="#l54.1401"></a><span id="l54.1401">   nsString cnStr;</span>
<a href="#l54.1402"></a><span id="l54.1402"> </span>
<a href="#l54.1403"></a><span id="l54.1403">   rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameProperty),</span>
<a href="#l54.1404"></a><span id="l54.1404">                                    ldapAttributeName);</span>
<a href="#l54.1405"></a><span id="l54.1405">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1406"></a><span id="l54.1406"> </span>
<a href="#l54.1407"></a><span id="l54.1407">   if (!displayName.IsEmpty()) {</span>
<a href="#l54.1408"></a><span id="l54.1408" class="difflineat">@@ -1196,251 +1121,235 @@ nsresult nsAbManager::AppendDNForCard(co</span>
<a href="#l54.1409"></a><span id="l54.1409"> </span>
<a href="#l54.1410"></a><span id="l54.1410">   if (!email.IsEmpty()) {</span>
<a href="#l54.1411"></a><span id="l54.1411">     cnStr += NS_ConvertUTF8toUTF16(ldapAttributeName).get();</span>
<a href="#l54.1412"></a><span id="l54.1412">     cnStr.Append('=');</span>
<a href="#l54.1413"></a><span id="l54.1413">     cnStr.Append(email);</span>
<a href="#l54.1414"></a><span id="l54.1414">   }</span>
<a href="#l54.1415"></a><span id="l54.1415"> </span>
<a href="#l54.1416"></a><span id="l54.1416">   rv = AppendProperty(aProperty, cnStr.get(), aResult);</span>
<a href="#l54.1417"></a><span id="l54.1417" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1418"></a><span id="l54.1418" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1419"></a><span id="l54.1419">   return rv;</span>
<a href="#l54.1420"></a><span id="l54.1420"> }</span>
<a href="#l54.1421"></a><span id="l54.1421"> </span>
<a href="#l54.1422"></a><span id="l54.1422" class="difflineminus">-nsresult nsAbManager::AppendBasicLDIFForCard(nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult)</span>
<a href="#l54.1423"></a><span id="l54.1423" class="difflineminus">-{</span>
<a href="#l54.1424"></a><span id="l54.1424" class="difflineplus">+nsresult nsAbManager::AppendBasicLDIFForCard(nsIAbCard *aCard,</span>
<a href="#l54.1425"></a><span id="l54.1425" class="difflineplus">+                                             nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l54.1426"></a><span id="l54.1426" class="difflineplus">+                                             nsACString &amp;aResult) {</span>
<a href="#l54.1427"></a><span id="l54.1427">   nsresult rv = AppendDNForCard(&quot;dn&quot;, aCard, aAttrMap, aResult);</span>
<a href="#l54.1428"></a><span id="l54.1428" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l54.1429"></a><span id="l54.1429" class="difflineminus">-  aResult += MSG_LINEBREAK \</span>
<a href="#l54.1430"></a><span id="l54.1430" class="difflineminus">-    &quot;objectclass: top&quot; MSG_LINEBREAK \</span>
<a href="#l54.1431"></a><span id="l54.1431" class="difflineminus">-    &quot;objectclass: person&quot; MSG_LINEBREAK \</span>
<a href="#l54.1432"></a><span id="l54.1432" class="difflineminus">-    &quot;objectclass: organizationalPerson&quot; MSG_LINEBREAK \</span>
<a href="#l54.1433"></a><span id="l54.1433" class="difflineminus">-    &quot;objectclass: inetOrgPerson&quot; MSG_LINEBREAK \</span>
<a href="#l54.1434"></a><span id="l54.1434" class="difflineminus">-    &quot;objectclass: &quot; MOZ_AB_OBJECTCLASS MSG_LINEBREAK;</span>
<a href="#l54.1435"></a><span id="l54.1435" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1436"></a><span id="l54.1436" class="difflineplus">+  aResult += MSG_LINEBREAK &quot;objectclass: top&quot; MSG_LINEBREAK</span>
<a href="#l54.1437"></a><span id="l54.1437" class="difflineplus">+                           &quot;objectclass: person&quot; MSG_LINEBREAK</span>
<a href="#l54.1438"></a><span id="l54.1438" class="difflineplus">+                           &quot;objectclass: organizationalPerson&quot; MSG_LINEBREAK</span>
<a href="#l54.1439"></a><span id="l54.1439" class="difflineplus">+                           &quot;objectclass: inetOrgPerson&quot; MSG_LINEBREAK</span>
<a href="#l54.1440"></a><span id="l54.1440" class="difflineplus">+                           &quot;objectclass: &quot; MOZ_AB_OBJECTCLASS MSG_LINEBREAK;</span>
<a href="#l54.1441"></a><span id="l54.1441">   return rv;</span>
<a href="#l54.1442"></a><span id="l54.1442"> }</span>
<a href="#l54.1443"></a><span id="l54.1443"> </span>
<a href="#l54.1444"></a><span id="l54.1444" class="difflineminus">-bool nsAbManager::IsSafeLDIFString(const char16_t *aStr)</span>
<a href="#l54.1445"></a><span id="l54.1445" class="difflineminus">-{</span>
<a href="#l54.1446"></a><span id="l54.1446" class="difflineplus">+bool nsAbManager::IsSafeLDIFString(const char16_t *aStr) {</span>
<a href="#l54.1447"></a><span id="l54.1447">   // follow RFC 2849 to determine if something is safe &quot;as is&quot; for LDIF</span>
<a href="#l54.1448"></a><span id="l54.1448" class="difflineminus">-  if (aStr[0] == char16_t(' ') ||</span>
<a href="#l54.1449"></a><span id="l54.1449" class="difflineminus">-      aStr[0] == char16_t(':') ||</span>
<a href="#l54.1450"></a><span id="l54.1450" class="difflineplus">+  if (aStr[0] == char16_t(' ') || aStr[0] == char16_t(':') ||</span>
<a href="#l54.1451"></a><span id="l54.1451">       aStr[0] == char16_t('&lt;'))</span>
<a href="#l54.1452"></a><span id="l54.1452">     return false;</span>
<a href="#l54.1453"></a><span id="l54.1453"> </span>
<a href="#l54.1454"></a><span id="l54.1454">   uint32_t i;</span>
<a href="#l54.1455"></a><span id="l54.1455">   uint32_t len = NS_strlen(aStr);</span>
<a href="#l54.1456"></a><span id="l54.1456" class="difflineminus">-  for (i=0; i&lt;len; i++) {</span>
<a href="#l54.1457"></a><span id="l54.1457" class="difflineplus">+  for (i = 0; i &lt; len; i++) {</span>
<a href="#l54.1458"></a><span id="l54.1458">     // If string contains CR or LF, it is not safe for LDIF</span>
<a href="#l54.1459"></a><span id="l54.1459">     // and MUST be base64 encoded</span>
<a href="#l54.1460"></a><span id="l54.1460" class="difflineminus">-    if ((aStr[i] == char16_t('\n')) ||</span>
<a href="#l54.1461"></a><span id="l54.1461" class="difflineminus">-        (aStr[i] == char16_t('\r')) ||</span>
<a href="#l54.1462"></a><span id="l54.1462" class="difflineplus">+    if ((aStr[i] == char16_t('\n')) || (aStr[i] == char16_t('\r')) ||</span>
<a href="#l54.1463"></a><span id="l54.1463">         (!mozilla::IsAscii(aStr[i])))</span>
<a href="#l54.1464"></a><span id="l54.1464">       return false;</span>
<a href="#l54.1465"></a><span id="l54.1465">   }</span>
<a href="#l54.1466"></a><span id="l54.1466">   return true;</span>
<a href="#l54.1467"></a><span id="l54.1467"> }</span>
<a href="#l54.1468"></a><span id="l54.1468"> </span>
<a href="#l54.1469"></a><span id="l54.1469" class="difflineminus">-nsresult nsAbManager::AppendProperty(const char *aProperty, const char16_t *aValue, nsACString &amp;aResult)</span>
<a href="#l54.1470"></a><span id="l54.1470" class="difflineminus">-{</span>
<a href="#l54.1471"></a><span id="l54.1471" class="difflineplus">+nsresult nsAbManager::AppendProperty(const char *aProperty,</span>
<a href="#l54.1472"></a><span id="l54.1472" class="difflineplus">+                                     const char16_t *aValue,</span>
<a href="#l54.1473"></a><span id="l54.1473" class="difflineplus">+                                     nsACString &amp;aResult) {</span>
<a href="#l54.1474"></a><span id="l54.1474">   NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l54.1475"></a><span id="l54.1475"> </span>
<a href="#l54.1476"></a><span id="l54.1476">   aResult += aProperty;</span>
<a href="#l54.1477"></a><span id="l54.1477"> </span>
<a href="#l54.1478"></a><span id="l54.1478">   // if the string is not safe &quot;as is&quot;, base64 encode it</span>
<a href="#l54.1479"></a><span id="l54.1479">   if (IsSafeLDIFString(aValue)) {</span>
<a href="#l54.1480"></a><span id="l54.1480">     aResult.AppendLiteral(&quot;: &quot;);</span>
<a href="#l54.1481"></a><span id="l54.1481">     aResult.Append(NS_LossyConvertUTF16toASCII(aValue));</span>
<a href="#l54.1482"></a><span id="l54.1482" class="difflineminus">-  }</span>
<a href="#l54.1483"></a><span id="l54.1483" class="difflineminus">-  else {</span>
<a href="#l54.1484"></a><span id="l54.1484" class="difflineminus">-    char *base64Str = PL_Base64Encode(NS_ConvertUTF16toUTF8(aValue).get(), 0, nullptr);</span>
<a href="#l54.1485"></a><span id="l54.1485" class="difflineminus">-    if (!base64Str)</span>
<a href="#l54.1486"></a><span id="l54.1486" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l54.1487"></a><span id="l54.1487" class="difflineplus">+  } else {</span>
<a href="#l54.1488"></a><span id="l54.1488" class="difflineplus">+    char *base64Str =</span>
<a href="#l54.1489"></a><span id="l54.1489" class="difflineplus">+        PL_Base64Encode(NS_ConvertUTF16toUTF8(aValue).get(), 0, nullptr);</span>
<a href="#l54.1490"></a><span id="l54.1490" class="difflineplus">+    if (!base64Str) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l54.1491"></a><span id="l54.1491"> </span>
<a href="#l54.1492"></a><span id="l54.1492">     aResult.AppendLiteral(&quot;:: &quot;);</span>
<a href="#l54.1493"></a><span id="l54.1493">     aResult.Append(nsDependentCString(base64Str));</span>
<a href="#l54.1494"></a><span id="l54.1494">     PR_Free(base64Str);</span>
<a href="#l54.1495"></a><span id="l54.1495">   }</span>
<a href="#l54.1496"></a><span id="l54.1496"> </span>
<a href="#l54.1497"></a><span id="l54.1497">   return NS_OK;</span>
<a href="#l54.1498"></a><span id="l54.1498"> }</span>
<a href="#l54.1499"></a><span id="l54.1499"> </span>
<a href="#l54.1500"></a><span id="l54.1500" class="difflineminus">-char *getCString(VObject *vObj)</span>
<a href="#l54.1501"></a><span id="l54.1501" class="difflineminus">-{</span>
<a href="#l54.1502"></a><span id="l54.1502" class="difflineminus">-    if (VALUE_TYPE(vObj) == VCVT_USTRINGZ)</span>
<a href="#l54.1503"></a><span id="l54.1503" class="difflineminus">-        return fakeCString(vObjectUStringZValue(vObj));</span>
<a href="#l54.1504"></a><span id="l54.1504" class="difflineminus">-    if (VALUE_TYPE(vObj) == VCVT_STRINGZ)</span>
<a href="#l54.1505"></a><span id="l54.1505" class="difflineminus">-        return PL_strdup(vObjectStringZValue(vObj));</span>
<a href="#l54.1506"></a><span id="l54.1506" class="difflineminus">-    return NULL;</span>
<a href="#l54.1507"></a><span id="l54.1507" class="difflineplus">+char *getCString(VObject *vObj) {</span>
<a href="#l54.1508"></a><span id="l54.1508" class="difflineplus">+  if (VALUE_TYPE(vObj) == VCVT_USTRINGZ)</span>
<a href="#l54.1509"></a><span id="l54.1509" class="difflineplus">+    return fakeCString(vObjectUStringZValue(vObj));</span>
<a href="#l54.1510"></a><span id="l54.1510" class="difflineplus">+  if (VALUE_TYPE(vObj) == VCVT_STRINGZ)</span>
<a href="#l54.1511"></a><span id="l54.1511" class="difflineplus">+    return PL_strdup(vObjectStringZValue(vObj));</span>
<a href="#l54.1512"></a><span id="l54.1512" class="difflineplus">+  return NULL;</span>
<a href="#l54.1513"></a><span id="l54.1513"> }</span>
<a href="#l54.1514"></a><span id="l54.1514"> </span>
<a href="#l54.1515"></a><span id="l54.1515" class="difflineminus">-static void convertNameValue(VObject *vObj, nsIAbCard *aCard)</span>
<a href="#l54.1516"></a><span id="l54.1516" class="difflineminus">-{</span>
<a href="#l54.1517"></a><span id="l54.1517" class="difflineplus">+static void convertNameValue(VObject *vObj, nsIAbCard *aCard) {</span>
<a href="#l54.1518"></a><span id="l54.1518">   const char *cardPropName = NULL;</span>
<a href="#l54.1519"></a><span id="l54.1519"> </span>
<a href="#l54.1520"></a><span id="l54.1520" class="difflineminus">-  // if the vCard property is not a root property then we need to determine its exact property.</span>
<a href="#l54.1521"></a><span id="l54.1521" class="difflineminus">-  // a good example of this is VCTelephoneProp, this prop has four objects underneath it:</span>
<a href="#l54.1522"></a><span id="l54.1522" class="difflineminus">-  // fax, work and home and cellular.</span>
<a href="#l54.1523"></a><span id="l54.1523" class="difflineplus">+  // if the vCard property is not a root property then we need to determine its</span>
<a href="#l54.1524"></a><span id="l54.1524" class="difflineplus">+  // exact property. a good example of this is VCTelephoneProp, this prop has</span>
<a href="#l54.1525"></a><span id="l54.1525" class="difflineplus">+  // four objects underneath it: fax, work and home and cellular.</span>
<a href="#l54.1526"></a><span id="l54.1526">   if (PL_strcasecmp(VCCityProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1527"></a><span id="l54.1527" class="difflineminus">-      cardPropName = kWorkCityProperty;</span>
<a href="#l54.1528"></a><span id="l54.1528" class="difflineminus">-  else if (PL_strcasecmp(VCTelephoneProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1529"></a><span id="l54.1529" class="difflineminus">-  {</span>
<a href="#l54.1530"></a><span id="l54.1530" class="difflineminus">-      if (isAPropertyOf(vObj, VCFaxProp))</span>
<a href="#l54.1531"></a><span id="l54.1531" class="difflineminus">-          cardPropName = kFaxProperty;</span>
<a href="#l54.1532"></a><span id="l54.1532" class="difflineminus">-      else if (isAPropertyOf(vObj, VCWorkProp))</span>
<a href="#l54.1533"></a><span id="l54.1533" class="difflineminus">-          cardPropName = kWorkPhoneProperty;</span>
<a href="#l54.1534"></a><span id="l54.1534" class="difflineminus">-      else if (isAPropertyOf(vObj, VCHomeProp))</span>
<a href="#l54.1535"></a><span id="l54.1535" class="difflineminus">-          cardPropName = kHomePhoneProperty;</span>
<a href="#l54.1536"></a><span id="l54.1536" class="difflineminus">-      else if (isAPropertyOf(vObj, VCCellularProp))</span>
<a href="#l54.1537"></a><span id="l54.1537" class="difflineminus">-          cardPropName = kCellularProperty;</span>
<a href="#l54.1538"></a><span id="l54.1538" class="difflineminus">-      else if (isAPropertyOf(vObj, VCPagerProp))</span>
<a href="#l54.1539"></a><span id="l54.1539" class="difflineminus">-          cardPropName = kPagerProperty;</span>
<a href="#l54.1540"></a><span id="l54.1540" class="difflineminus">-      else</span>
<a href="#l54.1541"></a><span id="l54.1541" class="difflineminus">-          return;</span>
<a href="#l54.1542"></a><span id="l54.1542" class="difflineminus">-  }</span>
<a href="#l54.1543"></a><span id="l54.1543" class="difflineminus">-  else if (PL_strcasecmp(VCEmailAddressProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1544"></a><span id="l54.1544" class="difflineminus">-      cardPropName = kPriEmailProperty;</span>
<a href="#l54.1545"></a><span id="l54.1545" class="difflineplus">+    cardPropName = kWorkCityProperty;</span>
<a href="#l54.1546"></a><span id="l54.1546" class="difflineplus">+  else if (PL_strcasecmp(VCTelephoneProp, vObjectName(vObj)) == 0) {</span>
<a href="#l54.1547"></a><span id="l54.1547" class="difflineplus">+    if (isAPropertyOf(vObj, VCFaxProp))</span>
<a href="#l54.1548"></a><span id="l54.1548" class="difflineplus">+      cardPropName = kFaxProperty;</span>
<a href="#l54.1549"></a><span id="l54.1549" class="difflineplus">+    else if (isAPropertyOf(vObj, VCWorkProp))</span>
<a href="#l54.1550"></a><span id="l54.1550" class="difflineplus">+      cardPropName = kWorkPhoneProperty;</span>
<a href="#l54.1551"></a><span id="l54.1551" class="difflineplus">+    else if (isAPropertyOf(vObj, VCHomeProp))</span>
<a href="#l54.1552"></a><span id="l54.1552" class="difflineplus">+      cardPropName = kHomePhoneProperty;</span>
<a href="#l54.1553"></a><span id="l54.1553" class="difflineplus">+    else if (isAPropertyOf(vObj, VCCellularProp))</span>
<a href="#l54.1554"></a><span id="l54.1554" class="difflineplus">+      cardPropName = kCellularProperty;</span>
<a href="#l54.1555"></a><span id="l54.1555" class="difflineplus">+    else if (isAPropertyOf(vObj, VCPagerProp))</span>
<a href="#l54.1556"></a><span id="l54.1556" class="difflineplus">+      cardPropName = kPagerProperty;</span>
<a href="#l54.1557"></a><span id="l54.1557" class="difflineplus">+    else</span>
<a href="#l54.1558"></a><span id="l54.1558" class="difflineplus">+      return;</span>
<a href="#l54.1559"></a><span id="l54.1559" class="difflineplus">+  } else if (PL_strcasecmp(VCEmailAddressProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1560"></a><span id="l54.1560" class="difflineplus">+    cardPropName = kPriEmailProperty;</span>
<a href="#l54.1561"></a><span id="l54.1561">   else if (PL_strcasecmp(VCFamilyNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1562"></a><span id="l54.1562" class="difflineminus">-      cardPropName = kLastNameProperty;</span>
<a href="#l54.1563"></a><span id="l54.1563" class="difflineplus">+    cardPropName = kLastNameProperty;</span>
<a href="#l54.1564"></a><span id="l54.1564">   else if (PL_strcasecmp(VCFullNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1565"></a><span id="l54.1565" class="difflineminus">-      cardPropName = kDisplayNameProperty;</span>
<a href="#l54.1566"></a><span id="l54.1566" class="difflineplus">+    cardPropName = kDisplayNameProperty;</span>
<a href="#l54.1567"></a><span id="l54.1567">   else if (PL_strcasecmp(VCGivenNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1568"></a><span id="l54.1568" class="difflineminus">-      cardPropName = kFirstNameProperty;</span>
<a href="#l54.1569"></a><span id="l54.1569" class="difflineplus">+    cardPropName = kFirstNameProperty;</span>
<a href="#l54.1570"></a><span id="l54.1570">   else if (PL_strcasecmp(VCOrgNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1571"></a><span id="l54.1571" class="difflineminus">-      cardPropName = kCompanyProperty;</span>
<a href="#l54.1572"></a><span id="l54.1572" class="difflineplus">+    cardPropName = kCompanyProperty;</span>
<a href="#l54.1573"></a><span id="l54.1573">   else if (PL_strcasecmp(VCOrgUnitProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1574"></a><span id="l54.1574" class="difflineminus">-      cardPropName = kDepartmentProperty;</span>
<a href="#l54.1575"></a><span id="l54.1575" class="difflineplus">+    cardPropName = kDepartmentProperty;</span>
<a href="#l54.1576"></a><span id="l54.1576">   else if (PL_strcasecmp(VCPostalCodeProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1577"></a><span id="l54.1577" class="difflineminus">-      cardPropName = kWorkZipCodeProperty;</span>
<a href="#l54.1578"></a><span id="l54.1578" class="difflineplus">+    cardPropName = kWorkZipCodeProperty;</span>
<a href="#l54.1579"></a><span id="l54.1579">   else if (PL_strcasecmp(VCRegionProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1580"></a><span id="l54.1580" class="difflineminus">-      cardPropName = kWorkStateProperty;</span>
<a href="#l54.1581"></a><span id="l54.1581" class="difflineplus">+    cardPropName = kWorkStateProperty;</span>
<a href="#l54.1582"></a><span id="l54.1582">   else if (PL_strcasecmp(VCStreetAddressProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1583"></a><span id="l54.1583" class="difflineminus">-      cardPropName = kWorkAddressProperty;</span>
<a href="#l54.1584"></a><span id="l54.1584" class="difflineplus">+    cardPropName = kWorkAddressProperty;</span>
<a href="#l54.1585"></a><span id="l54.1585">   else if (PL_strcasecmp(VCPostalBoxProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1586"></a><span id="l54.1586" class="difflineminus">-      cardPropName = kWorkAddress2Property;</span>
<a href="#l54.1587"></a><span id="l54.1587" class="difflineplus">+    cardPropName = kWorkAddress2Property;</span>
<a href="#l54.1588"></a><span id="l54.1588">   else if (PL_strcasecmp(VCCountryNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1589"></a><span id="l54.1589" class="difflineminus">-      cardPropName = kWorkCountryProperty;</span>
<a href="#l54.1590"></a><span id="l54.1590" class="difflineplus">+    cardPropName = kWorkCountryProperty;</span>
<a href="#l54.1591"></a><span id="l54.1591">   else if (PL_strcasecmp(VCTitleProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1592"></a><span id="l54.1592" class="difflineminus">-      cardPropName = kJobTitleProperty;</span>
<a href="#l54.1593"></a><span id="l54.1593" class="difflineplus">+    cardPropName = kJobTitleProperty;</span>
<a href="#l54.1594"></a><span id="l54.1594">   else if (PL_strcasecmp(VCUseHTML, vObjectName(vObj)) == 0)</span>
<a href="#l54.1595"></a><span id="l54.1595" class="difflineminus">-      cardPropName = kPreferMailFormatProperty;</span>
<a href="#l54.1596"></a><span id="l54.1596" class="difflineplus">+    cardPropName = kPreferMailFormatProperty;</span>
<a href="#l54.1597"></a><span id="l54.1597">   else if (PL_strcasecmp(VCNoteProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1598"></a><span id="l54.1598" class="difflineminus">-      cardPropName = kNotesProperty;</span>
<a href="#l54.1599"></a><span id="l54.1599" class="difflineplus">+    cardPropName = kNotesProperty;</span>
<a href="#l54.1600"></a><span id="l54.1600">   else if (PL_strcasecmp(VCURLProp, vObjectName(vObj)) == 0)</span>
<a href="#l54.1601"></a><span id="l54.1601" class="difflineminus">-      cardPropName = kWorkWebPageProperty;</span>
<a href="#l54.1602"></a><span id="l54.1602" class="difflineplus">+    cardPropName = kWorkWebPageProperty;</span>
<a href="#l54.1603"></a><span id="l54.1603">   else</span>
<a href="#l54.1604"></a><span id="l54.1604" class="difflineminus">-      return;</span>
<a href="#l54.1605"></a><span id="l54.1605" class="difflineplus">+    return;</span>
<a href="#l54.1606"></a><span id="l54.1606"> </span>
<a href="#l54.1607"></a><span id="l54.1607" class="difflineminus">-  if (!VALUE_TYPE(vObj))</span>
<a href="#l54.1608"></a><span id="l54.1608" class="difflineminus">-      return;</span>
<a href="#l54.1609"></a><span id="l54.1609" class="difflineplus">+  if (!VALUE_TYPE(vObj)) return;</span>
<a href="#l54.1610"></a><span id="l54.1610"> </span>
<a href="#l54.1611"></a><span id="l54.1611">   char *cardPropValue = getCString(vObj);</span>
<a href="#l54.1612"></a><span id="l54.1612">   if (PL_strcmp(cardPropName, kPreferMailFormatProperty)) {</span>
<a href="#l54.1613"></a><span id="l54.1613" class="difflineminus">-    aCard-&gt;SetPropertyAsAUTF8String(cardPropName, nsDependentCString(cardPropValue));</span>
<a href="#l54.1614"></a><span id="l54.1614" class="difflineplus">+    aCard-&gt;SetPropertyAsAUTF8String(cardPropName,</span>
<a href="#l54.1615"></a><span id="l54.1615" class="difflineplus">+                                    nsDependentCString(cardPropValue));</span>
<a href="#l54.1616"></a><span id="l54.1616">   } else {</span>
<a href="#l54.1617"></a><span id="l54.1617">     if (!PL_strcmp(cardPropValue, &quot;TRUE&quot;))</span>
<a href="#l54.1618"></a><span id="l54.1618">       aCard-&gt;SetPropertyAsUint32(cardPropName, nsIAbPreferMailFormat::html);</span>
<a href="#l54.1619"></a><span id="l54.1619">     else if (!PL_strcmp(cardPropValue, &quot;FALSE&quot;))</span>
<a href="#l54.1620"></a><span id="l54.1620" class="difflineminus">-      aCard-&gt;SetPropertyAsUint32(cardPropName, nsIAbPreferMailFormat::plaintext);</span>
<a href="#l54.1621"></a><span id="l54.1621" class="difflineplus">+      aCard-&gt;SetPropertyAsUint32(cardPropName,</span>
<a href="#l54.1622"></a><span id="l54.1622" class="difflineplus">+                                 nsIAbPreferMailFormat::plaintext);</span>
<a href="#l54.1623"></a><span id="l54.1623">     else</span>
<a href="#l54.1624"></a><span id="l54.1624">       aCard-&gt;SetPropertyAsUint32(cardPropName, nsIAbPreferMailFormat::unknown);</span>
<a href="#l54.1625"></a><span id="l54.1625">   }</span>
<a href="#l54.1626"></a><span id="l54.1626">   PR_FREEIF(cardPropValue);</span>
<a href="#l54.1627"></a><span id="l54.1627">   return;</span>
<a href="#l54.1628"></a><span id="l54.1628"> }</span>
<a href="#l54.1629"></a><span id="l54.1629"> </span>
<a href="#l54.1630"></a><span id="l54.1630" class="difflineminus">-static void convertFromVObject(VObject *vObj, nsIAbCard *aCard)</span>
<a href="#l54.1631"></a><span id="l54.1631" class="difflineminus">-{</span>
<a href="#l54.1632"></a><span id="l54.1632" class="difflineminus">-    if (vObj)</span>
<a href="#l54.1633"></a><span id="l54.1633" class="difflineminus">-    {</span>
<a href="#l54.1634"></a><span id="l54.1634" class="difflineminus">-        VObjectIterator t;</span>
<a href="#l54.1635"></a><span id="l54.1635" class="difflineplus">+static void convertFromVObject(VObject *vObj, nsIAbCard *aCard) {</span>
<a href="#l54.1636"></a><span id="l54.1636" class="difflineplus">+  if (vObj) {</span>
<a href="#l54.1637"></a><span id="l54.1637" class="difflineplus">+    VObjectIterator t;</span>
<a href="#l54.1638"></a><span id="l54.1638"> </span>
<a href="#l54.1639"></a><span id="l54.1639" class="difflineminus">-        convertNameValue(vObj, aCard);</span>
<a href="#l54.1640"></a><span id="l54.1640" class="difflineplus">+    convertNameValue(vObj, aCard);</span>
<a href="#l54.1641"></a><span id="l54.1641"> </span>
<a href="#l54.1642"></a><span id="l54.1642" class="difflineminus">-        initPropIterator(&amp;t, vObj);</span>
<a href="#l54.1643"></a><span id="l54.1643" class="difflineminus">-        while (moreIteration(&amp;t))</span>
<a href="#l54.1644"></a><span id="l54.1644" class="difflineminus">-        {</span>
<a href="#l54.1645"></a><span id="l54.1645" class="difflineminus">-            VObject * nextObject = nextVObject(&amp;t);</span>
<a href="#l54.1646"></a><span id="l54.1646" class="difflineminus">-            convertFromVObject(nextObject, aCard);</span>
<a href="#l54.1647"></a><span id="l54.1647" class="difflineminus">-        }</span>
<a href="#l54.1648"></a><span id="l54.1648" class="difflineplus">+    initPropIterator(&amp;t, vObj);</span>
<a href="#l54.1649"></a><span id="l54.1649" class="difflineplus">+    while (moreIteration(&amp;t)) {</span>
<a href="#l54.1650"></a><span id="l54.1650" class="difflineplus">+      VObject *nextObject = nextVObject(&amp;t);</span>
<a href="#l54.1651"></a><span id="l54.1651" class="difflineplus">+      convertFromVObject(nextObject, aCard);</span>
<a href="#l54.1652"></a><span id="l54.1652">     }</span>
<a href="#l54.1653"></a><span id="l54.1653" class="difflineminus">-    return;</span>
<a href="#l54.1654"></a><span id="l54.1654" class="difflineplus">+  }</span>
<a href="#l54.1655"></a><span id="l54.1655" class="difflineplus">+  return;</span>
<a href="#l54.1656"></a><span id="l54.1656"> }</span>
<a href="#l54.1657"></a><span id="l54.1657"> </span>
<a href="#l54.1658"></a><span id="l54.1658" class="difflineminus">-NS_IMETHODIMP nsAbManager::EscapedVCardToAbCard(const char *aEscapedVCardStr, nsIAbCard **aCard)</span>
<a href="#l54.1659"></a><span id="l54.1659" class="difflineminus">-{</span>
<a href="#l54.1660"></a><span id="l54.1660" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aEscapedVCardStr);</span>
<a href="#l54.1661"></a><span id="l54.1661" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l54.1662"></a><span id="l54.1662" class="difflineplus">+NS_IMETHODIMP nsAbManager::EscapedVCardToAbCard(const char *aEscapedVCardStr,</span>
<a href="#l54.1663"></a><span id="l54.1663" class="difflineplus">+                                                nsIAbCard **aCard) {</span>
<a href="#l54.1664"></a><span id="l54.1664" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aEscapedVCardStr);</span>
<a href="#l54.1665"></a><span id="l54.1665" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l54.1666"></a><span id="l54.1666"> </span>
<a href="#l54.1667"></a><span id="l54.1667" class="difflineminus">-    nsCOMPtr &lt;nsIAbCard&gt; cardFromVCard = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID);</span>
<a href="#l54.1668"></a><span id="l54.1668" class="difflineminus">-    if (!cardFromVCard)</span>
<a href="#l54.1669"></a><span id="l54.1669" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l54.1670"></a><span id="l54.1670" class="difflineminus">-</span>
<a href="#l54.1671"></a><span id="l54.1671" class="difflineminus">-    // aEscapedVCardStr will be &quot;&quot; the first time, before you have a vCard</span>
<a href="#l54.1672"></a><span id="l54.1672" class="difflineminus">-    if (*aEscapedVCardStr != '\0') {</span>
<a href="#l54.1673"></a><span id="l54.1673" class="difflineminus">-        nsCString unescapedData;</span>
<a href="#l54.1674"></a><span id="l54.1674" class="difflineminus">-        MsgUnescapeString(nsDependentCString(aEscapedVCardStr), 0, unescapedData);</span>
<a href="#l54.1675"></a><span id="l54.1675" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; cardFromVCard =</span>
<a href="#l54.1676"></a><span id="l54.1676" class="difflineplus">+      do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID);</span>
<a href="#l54.1677"></a><span id="l54.1677" class="difflineplus">+  if (!cardFromVCard) return NS_ERROR_FAILURE;</span>
<a href="#l54.1678"></a><span id="l54.1678"> </span>
<a href="#l54.1679"></a><span id="l54.1679" class="difflineminus">-        VObject *vObj = parse_MIME(unescapedData.get(), unescapedData.Length());</span>
<a href="#l54.1680"></a><span id="l54.1680" class="difflineminus">-        if (vObj)</span>
<a href="#l54.1681"></a><span id="l54.1681" class="difflineminus">-        {</span>
<a href="#l54.1682"></a><span id="l54.1682" class="difflineminus">-          convertFromVObject(vObj, cardFromVCard);</span>
<a href="#l54.1683"></a><span id="l54.1683" class="difflineplus">+  // aEscapedVCardStr will be &quot;&quot; the first time, before you have a vCard</span>
<a href="#l54.1684"></a><span id="l54.1684" class="difflineplus">+  if (*aEscapedVCardStr != '\0') {</span>
<a href="#l54.1685"></a><span id="l54.1685" class="difflineplus">+    nsCString unescapedData;</span>
<a href="#l54.1686"></a><span id="l54.1686" class="difflineplus">+    MsgUnescapeString(nsDependentCString(aEscapedVCardStr), 0, unescapedData);</span>
<a href="#l54.1687"></a><span id="l54.1687"> </span>
<a href="#l54.1688"></a><span id="l54.1688" class="difflineminus">-          cleanVObject(vObj);</span>
<a href="#l54.1689"></a><span id="l54.1689" class="difflineminus">-        }</span>
<a href="#l54.1690"></a><span id="l54.1690" class="difflineminus">-        else</span>
<a href="#l54.1691"></a><span id="l54.1691" class="difflineminus">-          NS_WARNING(&quot;Parse of vCard failed&quot;);</span>
<a href="#l54.1692"></a><span id="l54.1692" class="difflineminus">-    }</span>
<a href="#l54.1693"></a><span id="l54.1693" class="difflineplus">+    VObject *vObj = parse_MIME(unescapedData.get(), unescapedData.Length());</span>
<a href="#l54.1694"></a><span id="l54.1694" class="difflineplus">+    if (vObj) {</span>
<a href="#l54.1695"></a><span id="l54.1695" class="difflineplus">+      convertFromVObject(vObj, cardFromVCard);</span>
<a href="#l54.1696"></a><span id="l54.1696"> </span>
<a href="#l54.1697"></a><span id="l54.1697" class="difflineminus">-    cardFromVCard.forget(aCard);</span>
<a href="#l54.1698"></a><span id="l54.1698" class="difflineminus">-    return NS_OK;</span>
<a href="#l54.1699"></a><span id="l54.1699" class="difflineplus">+      cleanVObject(vObj);</span>
<a href="#l54.1700"></a><span id="l54.1700" class="difflineplus">+    } else</span>
<a href="#l54.1701"></a><span id="l54.1701" class="difflineplus">+      NS_WARNING(&quot;Parse of vCard failed&quot;);</span>
<a href="#l54.1702"></a><span id="l54.1702" class="difflineplus">+  }</span>
<a href="#l54.1703"></a><span id="l54.1703" class="difflineplus">+</span>
<a href="#l54.1704"></a><span id="l54.1704" class="difflineplus">+  cardFromVCard.forget(aCard);</span>
<a href="#l54.1705"></a><span id="l54.1705" class="difflineplus">+  return NS_OK;</span>
<a href="#l54.1706"></a><span id="l54.1706"> }</span>
<a href="#l54.1707"></a><span id="l54.1707"> </span>
<a href="#l54.1708"></a><span id="l54.1708"> NS_IMETHODIMP</span>
<a href="#l54.1709"></a><span id="l54.1709" class="difflineminus">-nsAbManager::Handle(nsICommandLine* aCmdLine)</span>
<a href="#l54.1710"></a><span id="l54.1710" class="difflineminus">-{</span>
<a href="#l54.1711"></a><span id="l54.1711" class="difflineplus">+nsAbManager::Handle(nsICommandLine *aCmdLine) {</span>
<a href="#l54.1712"></a><span id="l54.1712">   nsresult rv;</span>
<a href="#l54.1713"></a><span id="l54.1713">   bool found;</span>
<a href="#l54.1714"></a><span id="l54.1714"> </span>
<a href="#l54.1715"></a><span id="l54.1715">   rv = aCmdLine-&gt;HandleFlag(NS_LITERAL_STRING(&quot;addressbook&quot;), false, &amp;found);</span>
<a href="#l54.1716"></a><span id="l54.1716">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.1717"></a><span id="l54.1717"> </span>
<a href="#l54.1718"></a><span id="l54.1718" class="difflineminus">-  if (!found)</span>
<a href="#l54.1719"></a><span id="l54.1719" class="difflineminus">-    return NS_OK;</span>
<a href="#l54.1720"></a><span id="l54.1720" class="difflineplus">+  if (!found) return NS_OK;</span>
<a href="#l54.1721"></a><span id="l54.1721"> </span>
<a href="#l54.1722"></a><span id="l54.1722" class="difflineminus">-  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch (do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l54.1723"></a><span id="l54.1723" class="difflineplus">+  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l54.1724"></a><span id="l54.1724">   NS_ENSURE_TRUE(wwatch, NS_ERROR_FAILURE);</span>
<a href="#l54.1725"></a><span id="l54.1725"> </span>
<a href="#l54.1726"></a><span id="l54.1726">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; opened;</span>
<a href="#l54.1727"></a><span id="l54.1727" class="difflineminus">-  wwatch-&gt;OpenWindow(nullptr,</span>
<a href="#l54.1728"></a><span id="l54.1728" class="difflineminus">-                     &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;,</span>
<a href="#l54.1729"></a><span id="l54.1729" class="difflineminus">-                     &quot;_blank&quot;,</span>
<a href="#l54.1730"></a><span id="l54.1730" class="difflineminus">-                     &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;,</span>
<a href="#l54.1731"></a><span id="l54.1731" class="difflineminus">-                     nullptr, getter_AddRefs(opened));</span>
<a href="#l54.1732"></a><span id="l54.1732" class="difflineplus">+  wwatch-&gt;OpenWindow(</span>
<a href="#l54.1733"></a><span id="l54.1733" class="difflineplus">+      nullptr, &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;,</span>
<a href="#l54.1734"></a><span id="l54.1734" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l54.1735"></a><span id="l54.1735" class="difflineplus">+      &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;, nullptr,</span>
<a href="#l54.1736"></a><span id="l54.1736" class="difflineplus">+      getter_AddRefs(opened));</span>
<a href="#l54.1737"></a><span id="l54.1737">   aCmdLine-&gt;SetPreventDefault(true);</span>
<a href="#l54.1738"></a><span id="l54.1738">   return NS_OK;</span>
<a href="#l54.1739"></a><span id="l54.1739"> }</span>
<a href="#l54.1740"></a><span id="l54.1740"> </span>
<a href="#l54.1741"></a><span id="l54.1741"> NS_IMETHODIMP</span>
<a href="#l54.1742"></a><span id="l54.1742" class="difflineminus">-nsAbManager::GetHelpInfo(nsACString&amp; aResult)</span>
<a href="#l54.1743"></a><span id="l54.1743" class="difflineminus">-{</span>
<a href="#l54.1744"></a><span id="l54.1744" class="difflineminus">-  aResult.AssignLiteral(&quot;  -addressbook       Open the address book at startup.\n&quot;);</span>
<a href="#l54.1745"></a><span id="l54.1745" class="difflineplus">+nsAbManager::GetHelpInfo(nsACString &amp;aResult) {</span>
<a href="#l54.1746"></a><span id="l54.1746" class="difflineplus">+  aResult.AssignLiteral(</span>
<a href="#l54.1747"></a><span id="l54.1747" class="difflineplus">+      &quot;  -addressbook       Open the address book at startup.\n&quot;);</span>
<a href="#l54.1748"></a><span id="l54.1748">   return NS_OK;</span>
<a href="#l54.1749"></a><span id="l54.1749"> }</span>
<a href="#l54.1750"></a><span id="l54.1750"> </span>
<a href="#l54.1751"></a><span id="l54.1751"> NS_IMETHODIMP</span>
<a href="#l54.1752"></a><span id="l54.1752"> nsAbManager::GenerateUUID(const nsACString &amp;aDirectoryId,</span>
<a href="#l54.1753"></a><span id="l54.1753" class="difflineminus">-                          const nsACString &amp;aLocalId, nsACString &amp;uuid)</span>
<a href="#l54.1754"></a><span id="l54.1754" class="difflineminus">-{</span>
<a href="#l54.1755"></a><span id="l54.1755" class="difflineplus">+                          const nsACString &amp;aLocalId, nsACString &amp;uuid) {</span>
<a href="#l54.1756"></a><span id="l54.1756">   uuid.Assign(aDirectoryId);</span>
<a href="#l54.1757"></a><span id="l54.1757">   uuid.Append('#');</span>
<a href="#l54.1758"></a><span id="l54.1758">   uuid.Append(aLocalId);</span>
<a href="#l54.1759"></a><span id="l54.1759">   return NS_OK;</span>
<a href="#l54.1760"></a><span id="l54.1760"> }</span>
<a href="#l54.1761"></a><span id="l54.1761"> </span>
<a href="#l54.1762"></a><span id="l54.1762"> NS_IMETHODIMP</span>
<a href="#l54.1763"></a><span id="l54.1763"> nsAbManager::ConvertQueryStringToExpression(const nsACString &amp;aQueryString,</span>
<a href="#l54.1764"></a><span id="l54.1764" class="difflineminus">-                                            nsIAbBooleanExpression **_retval)</span>
<a href="#l54.1765"></a><span id="l54.1765" class="difflineminus">-{</span>
<a href="#l54.1766"></a><span id="l54.1766" class="difflineplus">+                                            nsIAbBooleanExpression **_retval) {</span>
<a href="#l54.1767"></a><span id="l54.1767">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l54.1768"></a><span id="l54.1768" class="difflineminus">-  return nsAbQueryStringToExpression::Convert(aQueryString,</span>
<a href="#l54.1769"></a><span id="l54.1769" class="difflineminus">-                                              _retval);</span>
<a href="#l54.1770"></a><span id="l54.1770" class="difflineplus">+  return nsAbQueryStringToExpression::Convert(aQueryString, _retval);</span>
<a href="#l54.1771"></a><span id="l54.1771"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.h</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.h</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -14,75 +14,81 @@</span>
<a href="#l55.4"></a><span id="l55.4"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l55.5"></a><span id="l55.5"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l55.6"></a><span id="l55.6"> #include &quot;nsIFilePicker.h&quot;</span>
<a href="#l55.7"></a><span id="l55.7"> </span>
<a href="#l55.8"></a><span id="l55.8"> class nsIAbLDAPAttributeMap;</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10"> class nsAbManager : public nsIAbManager,</span>
<a href="#l55.11"></a><span id="l55.11">                     public nsICommandLineHandler,</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-                    public nsIObserver</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-{</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-public:</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+                    public nsIObserver {</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineplus">+ public:</span>
<a href="#l55.18"></a><span id="l55.18">   nsAbManager();</span>
<a href="#l55.19"></a><span id="l55.19"> </span>
<a href="#l55.20"></a><span id="l55.20">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l55.21"></a><span id="l55.21">   NS_DECL_NSIABMANAGER</span>
<a href="#l55.22"></a><span id="l55.22">   NS_DECL_NSIOBSERVER</span>
<a href="#l55.23"></a><span id="l55.23">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l55.24"></a><span id="l55.24"> </span>
<a href="#l55.25"></a><span id="l55.25">   nsresult Init();</span>
<a href="#l55.26"></a><span id="l55.26"> </span>
<a href="#l55.27"></a><span id="l55.27" class="difflineminus">-private:</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+ private:</span>
<a href="#l55.29"></a><span id="l55.29">   virtual ~nsAbManager();</span>
<a href="#l55.30"></a><span id="l55.30">   nsresult GetRootDirectory(nsIAbDirectory **aResult);</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-  nsresult ExportDirectoryToDelimitedText(nsIAbDirectory *aDirectory, const char *aDelim,</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineminus">-                                          uint32_t aDelimLen, nsIFile *aLocalFile, bool useUTF8);</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineminus">-  nsresult ExportDirectoryToVCard(nsIAbDirectory *aDirectory, nsIFile *aLocalFile);</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineminus">-  nsresult ExportDirectoryToLDIF(nsIAbDirectory *aDirectory, nsIFile *aLocalFile);</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineminus">-  nsresult AppendLDIFForMailList(nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult);</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineminus">-  nsresult AppendDNForCard(const char *aProperty, nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult);</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineminus">-  nsresult AppendBasicLDIFForCard(nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult);</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineminus">-  nsresult AppendProperty(const char *aProperty, const char16_t *aValue, nsACString &amp;aResult);</span>
<a href="#l55.39"></a><span id="l55.39" class="difflineplus">+  nsresult ExportDirectoryToDelimitedText(nsIAbDirectory *aDirectory,</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineplus">+                                          const char *aDelim,</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineplus">+                                          uint32_t aDelimLen,</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+                                          nsIFile *aLocalFile, bool useUTF8);</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineplus">+  nsresult ExportDirectoryToVCard(nsIAbDirectory *aDirectory,</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineplus">+                                  nsIFile *aLocalFile);</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+  nsresult ExportDirectoryToLDIF(nsIAbDirectory *aDirectory,</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+                                 nsIFile *aLocalFile);</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+  nsresult AppendLDIFForMailList(nsIAbCard *aCard,</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineplus">+                                 nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineplus">+                                 nsACString &amp;aResult);</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineplus">+  nsresult AppendDNForCard(const char *aProperty, nsIAbCard *aCard,</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+                           nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineplus">+                           nsACString &amp;aResult);</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+  nsresult AppendBasicLDIFForCard(nsIAbCard *aCard,</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineplus">+                                  nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+                                  nsACString &amp;aResult);</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineplus">+  nsresult AppendProperty(const char *aProperty, const char16_t *aValue,</span>
<a href="#l55.57"></a><span id="l55.57" class="difflineplus">+                          nsACString &amp;aResult);</span>
<a href="#l55.58"></a><span id="l55.58">   bool IsSafeLDIFString(const char16_t *aStr);</span>
<a href="#l55.59"></a><span id="l55.59"> </span>
<a href="#l55.60"></a><span id="l55.60">   struct abListener {</span>
<a href="#l55.61"></a><span id="l55.61">     nsCOMPtr&lt;nsIAbListener&gt; mListener;</span>
<a href="#l55.62"></a><span id="l55.62">     uint32_t mNotifyFlags;</span>
<a href="#l55.63"></a><span id="l55.63"> </span>
<a href="#l55.64"></a><span id="l55.64">     abListener(nsIAbListener *aListener, uint32_t aNotifyFlags)</span>
<a href="#l55.65"></a><span id="l55.65" class="difflineminus">-      : mListener(aListener), mNotifyFlags(aNotifyFlags) {}</span>
<a href="#l55.66"></a><span id="l55.66" class="difflineplus">+        : mListener(aListener), mNotifyFlags(aNotifyFlags) {}</span>
<a href="#l55.67"></a><span id="l55.67">     abListener(const abListener &amp;aListener)</span>
<a href="#l55.68"></a><span id="l55.68" class="difflineminus">-      : mListener(aListener.mListener), mNotifyFlags(aListener.mNotifyFlags) {}</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineplus">+        : mListener(aListener.mListener),</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+          mNotifyFlags(aListener.mNotifyFlags) {}</span>
<a href="#l55.71"></a><span id="l55.71">     ~abListener() {}</span>
<a href="#l55.72"></a><span id="l55.72"> </span>
<a href="#l55.73"></a><span id="l55.73" class="difflineminus">-    int operator==(nsIAbListener* aListener) const {</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineplus">+    int operator==(nsIAbListener *aListener) const {</span>
<a href="#l55.75"></a><span id="l55.75">       return mListener == aListener;</span>
<a href="#l55.76"></a><span id="l55.76">     }</span>
<a href="#l55.77"></a><span id="l55.77">     int operator==(const abListener &amp;aListener) const {</span>
<a href="#l55.78"></a><span id="l55.78">       return mListener == aListener.mListener;</span>
<a href="#l55.79"></a><span id="l55.79">     }</span>
<a href="#l55.80"></a><span id="l55.80">   };</span>
<a href="#l55.81"></a><span id="l55.81"> </span>
<a href="#l55.82"></a><span id="l55.82" class="difflineminus">-  class nsFilePickerShownCallback</span>
<a href="#l55.83"></a><span id="l55.83" class="difflineminus">-    : public nsIFilePickerShownCallback</span>
<a href="#l55.84"></a><span id="l55.84" class="difflineminus">-  {</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineminus">-    virtual ~nsFilePickerShownCallback()</span>
<a href="#l55.86"></a><span id="l55.86" class="difflineminus">-    { }</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineplus">+  class nsFilePickerShownCallback : public nsIFilePickerShownCallback {</span>
<a href="#l55.88"></a><span id="l55.88" class="difflineplus">+    virtual ~nsFilePickerShownCallback() {}</span>
<a href="#l55.89"></a><span id="l55.89"> </span>
<a href="#l55.90"></a><span id="l55.90" class="difflineminus">-  public:</span>
<a href="#l55.91"></a><span id="l55.91" class="difflineminus">-    nsFilePickerShownCallback(nsAbManager* aInput,</span>
<a href="#l55.92"></a><span id="l55.92" class="difflineminus">-                              nsIFilePicker* aFilePicker,</span>
<a href="#l55.93"></a><span id="l55.93" class="difflineplus">+   public:</span>
<a href="#l55.94"></a><span id="l55.94" class="difflineplus">+    nsFilePickerShownCallback(nsAbManager *aInput, nsIFilePicker *aFilePicker,</span>
<a href="#l55.95"></a><span id="l55.95">                               nsIAbDirectory *aDirectory);</span>
<a href="#l55.96"></a><span id="l55.96">     NS_DECL_ISUPPORTS</span>
<a href="#l55.97"></a><span id="l55.97"> </span>
<a href="#l55.98"></a><span id="l55.98">     NS_IMETHOD Done(int16_t aResult) override;</span>
<a href="#l55.99"></a><span id="l55.99"> </span>
<a href="#l55.100"></a><span id="l55.100" class="difflineminus">-  private:</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+   private:</span>
<a href="#l55.102"></a><span id="l55.102">     nsCOMPtr&lt;nsIFilePicker&gt; mFilePicker;</span>
<a href="#l55.103"></a><span id="l55.103">     RefPtr&lt;nsAbManager&gt; mAbManager;</span>
<a href="#l55.104"></a><span id="l55.104">     RefPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l55.105"></a><span id="l55.105">   };</span>
<a href="#l55.106"></a><span id="l55.106"> </span>
<a href="#l55.107"></a><span id="l55.107">   nsTObserverArray&lt;abListener&gt; mListeners;</span>
<a href="#l55.108"></a><span id="l55.108">   nsCOMPtr&lt;nsIAbDirectory&gt; mCacheTopLevelAb;</span>
<a href="#l55.109"></a><span id="l55.109">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIAbDirectory&gt; mAbStore;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.h</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.h</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -6,42 +6,43 @@</span>
<a href="#l56.4"></a><span id="l56.4"> #ifndef nsAbOSXCard_h___</span>
<a href="#l56.5"></a><span id="l56.5"> #define nsAbOSXCard_h___</span>
<a href="#l56.6"></a><span id="l56.6"> </span>
<a href="#l56.7"></a><span id="l56.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l56.8"></a><span id="l56.8"> #include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l56.9"></a><span id="l56.9"> </span>
<a href="#l56.10"></a><span id="l56.10"> #define NS_ABOSXCARD_URI_PREFIX NS_ABOSXCARD_PREFIX &quot;://&quot;</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-#define NS_IABOSXCARD_IID \</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-  { 0xa7e5b697, 0x772d, 0x4fb5, \</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineminus">-    { 0x81, 0x16, 0x23, 0xb7, 0x5a, 0xac, 0x94, 0x56 } }</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+#define NS_IABOSXCARD_IID                            \</span>
<a href="#l56.16"></a><span id="l56.16" class="difflineplus">+  {                                                  \</span>
<a href="#l56.17"></a><span id="l56.17" class="difflineplus">+    0xa7e5b697, 0x772d, 0x4fb5, {                    \</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineplus">+      0x81, 0x16, 0x23, 0xb7, 0x5a, 0xac, 0x94, 0x56 \</span>
<a href="#l56.19"></a><span id="l56.19" class="difflineplus">+    }                                                \</span>
<a href="#l56.20"></a><span id="l56.20" class="difflineplus">+  }</span>
<a href="#l56.21"></a><span id="l56.21"> </span>
<a href="#l56.22"></a><span id="l56.22" class="difflineminus">-class nsIAbOSXCard : public nsISupports</span>
<a href="#l56.23"></a><span id="l56.23" class="difflineminus">-{</span>
<a href="#l56.24"></a><span id="l56.24" class="difflineminus">-public:</span>
<a href="#l56.25"></a><span id="l56.25" class="difflineplus">+class nsIAbOSXCard : public nsISupports {</span>
<a href="#l56.26"></a><span id="l56.26" class="difflineplus">+ public:</span>
<a href="#l56.27"></a><span id="l56.27">   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IABOSXCARD_IID)</span>
<a href="#l56.28"></a><span id="l56.28"> </span>
<a href="#l56.29"></a><span id="l56.29">   virtual nsresult Init(const char *aUri) = 0;</span>
<a href="#l56.30"></a><span id="l56.30">   virtual nsresult Update(bool aNotify) = 0;</span>
<a href="#l56.31"></a><span id="l56.31">   virtual nsresult GetURI(nsACString &amp;aURI) = 0;</span>
<a href="#l56.32"></a><span id="l56.32"> };</span>
<a href="#l56.33"></a><span id="l56.33"> </span>
<a href="#l56.34"></a><span id="l56.34"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIAbOSXCard, NS_IABOSXCARD_IID)</span>
<a href="#l56.35"></a><span id="l56.35"> </span>
<a href="#l56.36"></a><span id="l56.36" class="difflineminus">-class nsAbOSXCard : public nsAbCardProperty,</span>
<a href="#l56.37"></a><span id="l56.37" class="difflineminus">-                    public nsIAbOSXCard</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineminus">-{</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineminus">-public:</span>
<a href="#l56.40"></a><span id="l56.40" class="difflineplus">+class nsAbOSXCard : public nsAbCardProperty, public nsIAbOSXCard {</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineplus">+ public:</span>
<a href="#l56.42"></a><span id="l56.42">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l56.43"></a><span id="l56.43"> </span>
<a href="#l56.44"></a><span id="l56.44">   nsresult Update(bool aNotify) override;</span>
<a href="#l56.45"></a><span id="l56.45">   nsresult GetURI(nsACString &amp;aURI) override;</span>
<a href="#l56.46"></a><span id="l56.46">   nsresult Init(const char *aUri) override;</span>
<a href="#l56.47"></a><span id="l56.47">   // this is needed so nsAbOSXUtils.mm can get at nsAbCardProperty</span>
<a href="#l56.48"></a><span id="l56.48">   friend class nsAbOSXUtils;</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineminus">-private:</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineplus">+</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineplus">+ private:</span>
<a href="#l56.52"></a><span id="l56.52">   nsCString mURI;</span>
<a href="#l56.53"></a><span id="l56.53"> </span>
<a href="#l56.54"></a><span id="l56.54">   virtual ~nsAbOSXCard() {}</span>
<a href="#l56.55"></a><span id="l56.55"> };</span>
<a href="#l56.56"></a><span id="l56.56"> </span>
<a href="#l56.57"></a><span id="l56.57" class="difflineminus">-#endif // nsAbOSXCard_h___</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineplus">+#endif  // nsAbOSXCard_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -8,142 +8,111 @@</span>
<a href="#l57.4"></a><span id="l57.4"> #include &quot;nsAbOSXUtils.h&quot;</span>
<a href="#l57.5"></a><span id="l57.5"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l57.6"></a><span id="l57.6"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l57.7"></a><span id="l57.7"> #include &quot;nsObjCExceptions.h&quot;</span>
<a href="#l57.8"></a><span id="l57.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l57.9"></a><span id="l57.9"> </span>
<a href="#l57.10"></a><span id="l57.10"> #include &lt;AddressBook/AddressBook.h&gt;</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbOSXCard,</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-                             nsAbCardProperty,</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineminus">-                             nsIAbOSXCard)</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsAbOSXCard, nsAbCardProperty, nsIAbOSXCard)</span>
<a href="#l57.16"></a><span id="l57.16"> </span>
<a href="#l57.17"></a><span id="l57.17"> #ifdef DEBUG</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineminus">-static ABPropertyType</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineminus">-GetPropertType(ABRecord *aCard, NSString *aProperty)</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineminus">-{</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineplus">+static ABPropertyType GetPropertType(ABRecord *aCard, NSString *aProperty) {</span>
<a href="#l57.22"></a><span id="l57.22">   ABPropertyType propertyType = kABErrorInProperty;</span>
<a href="#l57.23"></a><span id="l57.23">   if ([aCard isKindOfClass:[ABPerson class]])</span>
<a href="#l57.24"></a><span id="l57.24">     propertyType = [ABPerson typeOfProperty:aProperty];</span>
<a href="#l57.25"></a><span id="l57.25">   else if ([aCard isKindOfClass:[ABGroup class]])</span>
<a href="#l57.26"></a><span id="l57.26">     propertyType = [ABGroup typeOfProperty:aProperty];</span>
<a href="#l57.27"></a><span id="l57.27">   return propertyType;</span>
<a href="#l57.28"></a><span id="l57.28"> }</span>
<a href="#l57.29"></a><span id="l57.29"> #endif</span>
<a href="#l57.30"></a><span id="l57.30"> </span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-static void</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineminus">-SetStringProperty(nsAbOSXCard *aCard, const nsString &amp;aValue,</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineminus">-                  const char *aMemberName, bool aNotify,</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineminus">-                  nsIAbManager *aAbManager)</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineminus">-{</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineplus">+static void SetStringProperty(nsAbOSXCard *aCard, const nsString &amp;aValue, const char *aMemberName,</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineplus">+                              bool aNotify, nsIAbManager *aAbManager) {</span>
<a href="#l57.38"></a><span id="l57.38">   nsString oldValue;</span>
<a href="#l57.39"></a><span id="l57.39">   nsresult rv = aCard-&gt;GetPropertyAsAString(aMemberName, oldValue);</span>
<a href="#l57.40"></a><span id="l57.40" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l57.41"></a><span id="l57.41" class="difflineminus">-    oldValue.Truncate();</span>
<a href="#l57.42"></a><span id="l57.42" class="difflineplus">+  if (NS_FAILED(rv)) oldValue.Truncate();</span>
<a href="#l57.43"></a><span id="l57.43"> </span>
<a href="#l57.44"></a><span id="l57.44">   if (!aNotify) {</span>
<a href="#l57.45"></a><span id="l57.45">     aCard-&gt;SetPropertyAsAString(aMemberName, aValue);</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-  }</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineminus">-  else if (!oldValue.Equals(aValue)) {</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineplus">+  } else if (!oldValue.Equals(aValue)) {</span>
<a href="#l57.49"></a><span id="l57.49">     aCard-&gt;SetPropertyAsAString(aMemberName, aValue);</span>
<a href="#l57.50"></a><span id="l57.50"> </span>
<a href="#l57.51"></a><span id="l57.51" class="difflineminus">-    nsISupports *supports = NS_ISUPPORTS_CAST(nsAbCardProperty*, aCard);</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineplus">+    nsISupports *supports = NS_ISUPPORTS_CAST(nsAbCardProperty *, aCard);</span>
<a href="#l57.53"></a><span id="l57.53"> </span>
<a href="#l57.54"></a><span id="l57.54" class="difflineminus">-    aAbManager-&gt;NotifyItemPropertyChanged(supports, aMemberName,</span>
<a href="#l57.55"></a><span id="l57.55" class="difflineminus">-                                          oldValue.get(), aValue.get());</span>
<a href="#l57.56"></a><span id="l57.56" class="difflineplus">+    aAbManager-&gt;NotifyItemPropertyChanged(supports, aMemberName, oldValue.get(), aValue.get());</span>
<a href="#l57.57"></a><span id="l57.57">   }</span>
<a href="#l57.58"></a><span id="l57.58"> }</span>
<a href="#l57.59"></a><span id="l57.59"> </span>
<a href="#l57.60"></a><span id="l57.60" class="difflineminus">-static void</span>
<a href="#l57.61"></a><span id="l57.61" class="difflineminus">-SetStringProperty(nsAbOSXCard *aCard, NSString *aValue, const char *aMemberName,</span>
<a href="#l57.62"></a><span id="l57.62" class="difflineminus">-                  bool aNotify, nsIAbManager *aAbManager)</span>
<a href="#l57.63"></a><span id="l57.63" class="difflineminus">-{</span>
<a href="#l57.64"></a><span id="l57.64" class="difflineplus">+static void SetStringProperty(nsAbOSXCard *aCard, NSString *aValue, const char *aMemberName,</span>
<a href="#l57.65"></a><span id="l57.65" class="difflineplus">+                              bool aNotify, nsIAbManager *aAbManager) {</span>
<a href="#l57.66"></a><span id="l57.66">   nsAutoString value;</span>
<a href="#l57.67"></a><span id="l57.67" class="difflineminus">-  if (aValue)</span>
<a href="#l57.68"></a><span id="l57.68" class="difflineminus">-    AppendToString(aValue, value);</span>
<a href="#l57.69"></a><span id="l57.69" class="difflineplus">+  if (aValue) AppendToString(aValue, value);</span>
<a href="#l57.70"></a><span id="l57.70"> </span>
<a href="#l57.71"></a><span id="l57.71">   SetStringProperty(aCard, value, aMemberName, aNotify, aAbManager);</span>
<a href="#l57.72"></a><span id="l57.72"> }</span>
<a href="#l57.73"></a><span id="l57.73"> </span>
<a href="#l57.74"></a><span id="l57.74" class="difflineminus">-static void</span>
<a href="#l57.75"></a><span id="l57.75" class="difflineminus">-MapStringProperty(nsAbOSXCard *aCard, ABRecord *aOSXCard, NSString *aProperty,</span>
<a href="#l57.76"></a><span id="l57.76" class="difflineminus">-                  const char *aMemberName, bool aNotify,</span>
<a href="#l57.77"></a><span id="l57.77" class="difflineminus">-                  nsIAbManager *aAbManager)</span>
<a href="#l57.78"></a><span id="l57.78" class="difflineminus">-{</span>
<a href="#l57.79"></a><span id="l57.79" class="difflineplus">+static void MapStringProperty(nsAbOSXCard *aCard, ABRecord *aOSXCard, NSString *aProperty,</span>
<a href="#l57.80"></a><span id="l57.80" class="difflineplus">+                              const char *aMemberName, bool aNotify, nsIAbManager *aAbManager) {</span>
<a href="#l57.81"></a><span id="l57.81">   NS_ASSERTION(aProperty, &quot;This is bad! You asked for an unresolved symbol.&quot;);</span>
<a href="#l57.82"></a><span id="l57.82" class="difflineminus">-  NS_ASSERTION(GetPropertType(aOSXCard, aProperty) == kABStringProperty,</span>
<a href="#l57.83"></a><span id="l57.83" class="difflineminus">-               &quot;Wrong type!&quot;);</span>
<a href="#l57.84"></a><span id="l57.84" class="difflineplus">+  NS_ASSERTION(GetPropertType(aOSXCard, aProperty) == kABStringProperty, &quot;Wrong type!&quot;);</span>
<a href="#l57.85"></a><span id="l57.85"> </span>
<a href="#l57.86"></a><span id="l57.86" class="difflineminus">-  SetStringProperty(aCard, [aOSXCard valueForProperty:aProperty], aMemberName,</span>
<a href="#l57.87"></a><span id="l57.87" class="difflineminus">-                    aNotify, aAbManager);</span>
<a href="#l57.88"></a><span id="l57.88" class="difflineplus">+  SetStringProperty(aCard, [aOSXCard valueForProperty:aProperty], aMemberName, aNotify, aAbManager);</span>
<a href="#l57.89"></a><span id="l57.89"> }</span>
<a href="#l57.90"></a><span id="l57.90"> </span>
<a href="#l57.91"></a><span id="l57.91" class="difflineminus">-static ABMutableMultiValue*</span>
<a href="#l57.92"></a><span id="l57.92" class="difflineminus">-GetMultiValue(ABRecord *aCard, NSString *aProperty)</span>
<a href="#l57.93"></a><span id="l57.93" class="difflineminus">-{</span>
<a href="#l57.94"></a><span id="l57.94" class="difflineplus">+static ABMutableMultiValue *GetMultiValue(ABRecord *aCard, NSString *aProperty) {</span>
<a href="#l57.95"></a><span id="l57.95">   NS_ASSERTION(aProperty, &quot;This is bad! You asked for an unresolved symbol.&quot;);</span>
<a href="#l57.96"></a><span id="l57.96" class="difflineminus">-  NS_ASSERTION(GetPropertType(aCard, aProperty) &amp; kABMultiValueMask,</span>
<a href="#l57.97"></a><span id="l57.97" class="difflineminus">-               &quot;Wrong type!&quot;);</span>
<a href="#l57.98"></a><span id="l57.98" class="difflineplus">+  NS_ASSERTION(GetPropertType(aCard, aProperty) &amp; kABMultiValueMask, &quot;Wrong type!&quot;);</span>
<a href="#l57.99"></a><span id="l57.99"> </span>
<a href="#l57.100"></a><span id="l57.100">   return [aCard valueForProperty:aProperty];</span>
<a href="#l57.101"></a><span id="l57.101"> }</span>
<a href="#l57.102"></a><span id="l57.102"> </span>
<a href="#l57.103"></a><span id="l57.103" class="difflineminus">-static void</span>
<a href="#l57.104"></a><span id="l57.104" class="difflineminus">-MapDate(nsAbOSXCard *aCard, NSDate *aDate, const char *aYearPropName,</span>
<a href="#l57.105"></a><span id="l57.105" class="difflineminus">-        const char *aMonthPropName, const char *aDayPropName, bool aNotify,</span>
<a href="#l57.106"></a><span id="l57.106" class="difflineminus">-        nsIAbManager *aAbManager)</span>
<a href="#l57.107"></a><span id="l57.107" class="difflineminus">-{</span>
<a href="#l57.108"></a><span id="l57.108" class="difflineplus">+static void MapDate(nsAbOSXCard *aCard, NSDate *aDate, const char *aYearPropName,</span>
<a href="#l57.109"></a><span id="l57.109" class="difflineplus">+                    const char *aMonthPropName, const char *aDayPropName, bool aNotify,</span>
<a href="#l57.110"></a><span id="l57.110" class="difflineplus">+                    nsIAbManager *aAbManager) {</span>
<a href="#l57.111"></a><span id="l57.111">   // XXX Should we pass a format and timezone?</span>
<a href="#l57.112"></a><span id="l57.112">   NSCalendarDate *date = [aDate dateWithCalendarFormat:nil timeZone:nil];</span>
<a href="#l57.113"></a><span id="l57.113"> </span>
<a href="#l57.114"></a><span id="l57.114">   nsAutoString value;</span>
<a href="#l57.115"></a><span id="l57.115">   value.AppendInt(static_cast&lt;int32_t&gt;([date yearOfCommonEra]));</span>
<a href="#l57.116"></a><span id="l57.116">   SetStringProperty(aCard, value, aYearPropName, aNotify, aAbManager);</span>
<a href="#l57.117"></a><span id="l57.117">   value.Truncate();</span>
<a href="#l57.118"></a><span id="l57.118">   value.AppendInt(static_cast&lt;int32_t&gt;([date monthOfYear]));</span>
<a href="#l57.119"></a><span id="l57.119">   SetStringProperty(aCard, value, aMonthPropName, aNotify, aAbManager);</span>
<a href="#l57.120"></a><span id="l57.120">   value.Truncate();</span>
<a href="#l57.121"></a><span id="l57.121">   value.AppendInt(static_cast&lt;int32_t&gt;([date dayOfMonth]));</span>
<a href="#l57.122"></a><span id="l57.122">   SetStringProperty(aCard, value, aDayPropName, aNotify, aAbManager);</span>
<a href="#l57.123"></a><span id="l57.123"> }</span>
<a href="#l57.124"></a><span id="l57.124"> </span>
<a href="#l57.125"></a><span id="l57.125" class="difflineminus">-static bool</span>
<a href="#l57.126"></a><span id="l57.126" class="difflineminus">-MapMultiValue(nsAbOSXCard *aCard, ABRecord *aOSXCard,</span>
<a href="#l57.127"></a><span id="l57.127" class="difflineminus">-              const nsAbOSXPropertyMap &amp;aMap, bool aNotify,</span>
<a href="#l57.128"></a><span id="l57.128" class="difflineminus">-              nsIAbManager *aAbManager)</span>
<a href="#l57.129"></a><span id="l57.129" class="difflineminus">-{</span>
<a href="#l57.130"></a><span id="l57.130" class="difflineplus">+static bool MapMultiValue(nsAbOSXCard *aCard, ABRecord *aOSXCard, const nsAbOSXPropertyMap &amp;aMap,</span>
<a href="#l57.131"></a><span id="l57.131" class="difflineplus">+                          bool aNotify, nsIAbManager *aAbManager) {</span>
<a href="#l57.132"></a><span id="l57.132">   ABMultiValue *value = GetMultiValue(aOSXCard, aMap.mOSXProperty);</span>
<a href="#l57.133"></a><span id="l57.133">   if (value) {</span>
<a href="#l57.134"></a><span id="l57.134">     unsigned int j;</span>
<a href="#l57.135"></a><span id="l57.135">     unsigned int count = [value count];</span>
<a href="#l57.136"></a><span id="l57.136">     for (j = 0; j &lt; count; ++j) {</span>
<a href="#l57.137"></a><span id="l57.137">       if ([[value labelAtIndex:j] isEqualToString:aMap.mOSXLabel]) {</span>
<a href="#l57.138"></a><span id="l57.138" class="difflineminus">-        NSString *stringValue = (aMap.mOSXKey)</span>
<a href="#l57.139"></a><span id="l57.139" class="difflineminus">-          ? [[value valueAtIndex:j] objectForKey:aMap.mOSXKey]</span>
<a href="#l57.140"></a><span id="l57.140" class="difflineminus">-          : [value valueAtIndex:j];</span>
<a href="#l57.141"></a><span id="l57.141" class="difflineplus">+        NSString *stringValue = (aMap.mOSXKey) ? [[value valueAtIndex:j] objectForKey:aMap.mOSXKey]</span>
<a href="#l57.142"></a><span id="l57.142" class="difflineplus">+                                               : [value valueAtIndex:j];</span>
<a href="#l57.143"></a><span id="l57.143"> </span>
<a href="#l57.144"></a><span id="l57.144" class="difflineminus">-        SetStringProperty(aCard, stringValue, aMap.mPropertyName, aNotify,</span>
<a href="#l57.145"></a><span id="l57.145" class="difflineminus">-                          aAbManager);</span>
<a href="#l57.146"></a><span id="l57.146" class="difflineplus">+        SetStringProperty(aCard, stringValue, aMap.mPropertyName, aNotify, aAbManager);</span>
<a href="#l57.147"></a><span id="l57.147"> </span>
<a href="#l57.148"></a><span id="l57.148">         return true;</span>
<a href="#l57.149"></a><span id="l57.149">       }</span>
<a href="#l57.150"></a><span id="l57.150">     }</span>
<a href="#l57.151"></a><span id="l57.151">   }</span>
<a href="#l57.152"></a><span id="l57.152">   // String wasn't found, set value of card to empty if it was set previously</span>
<a href="#l57.153"></a><span id="l57.153" class="difflineminus">-  SetStringProperty(aCard, EmptyString(), aMap.mPropertyName, aNotify,</span>
<a href="#l57.154"></a><span id="l57.154" class="difflineminus">-                    aAbManager);</span>
<a href="#l57.155"></a><span id="l57.155" class="difflineplus">+  SetStringProperty(aCard, EmptyString(), aMap.mPropertyName, aNotify, aAbManager);</span>
<a href="#l57.156"></a><span id="l57.156"> </span>
<a href="#l57.157"></a><span id="l57.157">   return false;</span>
<a href="#l57.158"></a><span id="l57.158"> }</span>
<a href="#l57.159"></a><span id="l57.159"> </span>
<a href="#l57.160"></a><span id="l57.160"> // Maps Address Book's instant messenger name to the corresponding nsIAbCard field name.</span>
<a href="#l57.161"></a><span id="l57.161" class="difflineminus">-static const char*</span>
<a href="#l57.162"></a><span id="l57.162" class="difflineminus">-InstantMessengerFieldName(NSString* aInstantMessengerName)</span>
<a href="#l57.163"></a><span id="l57.163" class="difflineminus">-{</span>
<a href="#l57.164"></a><span id="l57.164" class="difflineplus">+static const char *InstantMessengerFieldName(NSString *aInstantMessengerName) {</span>
<a href="#l57.165"></a><span id="l57.165">   if ([aInstantMessengerName isEqualToString:@&quot;AIMInstant&quot;]) {</span>
<a href="#l57.166"></a><span id="l57.166">     return &quot;_AimScreenName&quot;;</span>
<a href="#l57.167"></a><span id="l57.167">   }</span>
<a href="#l57.168"></a><span id="l57.168">   if ([aInstantMessengerName isEqualToString:@&quot;GoogleTalkInstant&quot;]) {</span>
<a href="#l57.169"></a><span id="l57.169">     return &quot;_GoogleTalk&quot;;</span>
<a href="#l57.170"></a><span id="l57.170">   }</span>
<a href="#l57.171"></a><span id="l57.171">   if ([aInstantMessengerName isEqualToString:@&quot;ICQInstant&quot;]) {</span>
<a href="#l57.172"></a><span id="l57.172">     return &quot;_ICQ&quot;;</span>
<a href="#l57.173"></a><span id="l57.173" class="difflineat">@@ -164,43 +133,35 @@ InstantMessengerFieldName(NSString* aIns</span>
<a href="#l57.174"></a><span id="l57.174">     return &quot;_Yahoo&quot;;</span>
<a href="#l57.175"></a><span id="l57.175">   }</span>
<a href="#l57.176"></a><span id="l57.176"> </span>
<a href="#l57.177"></a><span id="l57.177">   // Fall back to AIM for everything else.</span>
<a href="#l57.178"></a><span id="l57.178">   // We don't have nsIAbCard fields for FacebookInstant and GaduGaduInstant.</span>
<a href="#l57.179"></a><span id="l57.179">   return &quot;_AimScreenName&quot;;</span>
<a href="#l57.180"></a><span id="l57.180"> }</span>
<a href="#l57.181"></a><span id="l57.181"> </span>
<a href="#l57.182"></a><span id="l57.182" class="difflineminus">-nsresult</span>
<a href="#l57.183"></a><span id="l57.183" class="difflineminus">-nsAbOSXCard::Init(const char *aUri)</span>
<a href="#l57.184"></a><span id="l57.184" class="difflineminus">-{</span>
<a href="#l57.185"></a><span id="l57.185" class="difflineminus">-  if (strncmp(aUri, NS_ABOSXCARD_URI_PREFIX,</span>
<a href="#l57.186"></a><span id="l57.186" class="difflineminus">-              sizeof(NS_ABOSXCARD_URI_PREFIX) - 1) != 0)</span>
<a href="#l57.187"></a><span id="l57.187" class="difflineplus">+nsresult nsAbOSXCard::Init(const char *aUri) {</span>
<a href="#l57.188"></a><span id="l57.188" class="difflineplus">+  if (strncmp(aUri, NS_ABOSXCARD_URI_PREFIX, sizeof(NS_ABOSXCARD_URI_PREFIX) - 1) != 0)</span>
<a href="#l57.189"></a><span id="l57.189">     return NS_ERROR_FAILURE;</span>
<a href="#l57.190"></a><span id="l57.190"> </span>
<a href="#l57.191"></a><span id="l57.191">   mURI = aUri;</span>
<a href="#l57.192"></a><span id="l57.192"> </span>
<a href="#l57.193"></a><span id="l57.193">   SetLocalId(nsDependentCString(aUri));</span>
<a href="#l57.194"></a><span id="l57.194"> </span>
<a href="#l57.195"></a><span id="l57.195">   return Update(false);</span>
<a href="#l57.196"></a><span id="l57.196"> }</span>
<a href="#l57.197"></a><span id="l57.197"> </span>
<a href="#l57.198"></a><span id="l57.198" class="difflineminus">-nsresult</span>
<a href="#l57.199"></a><span id="l57.199" class="difflineminus">-nsAbOSXCard::GetURI(nsACString &amp;aURI)</span>
<a href="#l57.200"></a><span id="l57.200" class="difflineminus">-{</span>
<a href="#l57.201"></a><span id="l57.201" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l57.202"></a><span id="l57.202" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l57.203"></a><span id="l57.203" class="difflineplus">+nsresult nsAbOSXCard::GetURI(nsACString &amp;aURI) {</span>
<a href="#l57.204"></a><span id="l57.204" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l57.205"></a><span id="l57.205"> </span>
<a href="#l57.206"></a><span id="l57.206">   aURI = mURI;</span>
<a href="#l57.207"></a><span id="l57.207">   return NS_OK;</span>
<a href="#l57.208"></a><span id="l57.208"> }</span>
<a href="#l57.209"></a><span id="l57.209"> </span>
<a href="#l57.210"></a><span id="l57.210" class="difflineminus">-nsresult</span>
<a href="#l57.211"></a><span id="l57.211" class="difflineminus">-nsAbOSXCard::Update(bool aNotify)</span>
<a href="#l57.212"></a><span id="l57.212" class="difflineminus">-{</span>
<a href="#l57.213"></a><span id="l57.213" class="difflineplus">+nsresult nsAbOSXCard::Update(bool aNotify) {</span>
<a href="#l57.214"></a><span id="l57.214">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l57.215"></a><span id="l57.215"> </span>
<a href="#l57.216"></a><span id="l57.216">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l57.217"></a><span id="l57.217"> </span>
<a href="#l57.218"></a><span id="l57.218">   const char *uid = &amp;((mURI.get())[16]);</span>
<a href="#l57.219"></a><span id="l57.219">   ABRecord *card = [addressBook recordForUniqueId:[NSString stringWithUTF8String:uid]];</span>
<a href="#l57.220"></a><span id="l57.220">   NS_ENSURE_TRUE(card, NS_ERROR_FAILURE);</span>
<a href="#l57.221"></a><span id="l57.221"> </span>
<a href="#l57.222"></a><span id="l57.222" class="difflineat">@@ -210,170 +171,149 @@ nsAbOSXCard::Update(bool aNotify)</span>
<a href="#l57.223"></a><span id="l57.223">     abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l57.224"></a><span id="l57.224">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l57.225"></a><span id="l57.225">   }</span>
<a href="#l57.226"></a><span id="l57.226"> </span>
<a href="#l57.227"></a><span id="l57.227">   if ([card isKindOfClass:[ABGroup class]]) {</span>
<a href="#l57.228"></a><span id="l57.228">     m_IsMailList = true;</span>
<a href="#l57.229"></a><span id="l57.229">     m_MailListURI.AssignLiteral(NS_ABOSXDIRECTORY_URI_PREFIX);</span>
<a href="#l57.230"></a><span id="l57.230">     m_MailListURI.Append(uid);</span>
<a href="#l57.231"></a><span id="l57.231" class="difflineminus">-    MapStringProperty(this, card, kABGroupNameProperty, &quot;DisplayName&quot;, aNotify,</span>
<a href="#l57.232"></a><span id="l57.232" class="difflineminus">-                      abManager);</span>
<a href="#l57.233"></a><span id="l57.233" class="difflineminus">-    MapStringProperty(this, card, kABGroupNameProperty, &quot;LastName&quot;, aNotify,</span>
<a href="#l57.234"></a><span id="l57.234" class="difflineminus">-                      abManager);</span>
<a href="#l57.235"></a><span id="l57.235" class="difflineplus">+    MapStringProperty(this, card, kABGroupNameProperty, &quot;DisplayName&quot;, aNotify, abManager);</span>
<a href="#l57.236"></a><span id="l57.236" class="difflineplus">+    MapStringProperty(this, card, kABGroupNameProperty, &quot;LastName&quot;, aNotify, abManager);</span>
<a href="#l57.237"></a><span id="l57.237"> </span>
<a href="#l57.238"></a><span id="l57.238">     return NS_OK;</span>
<a href="#l57.239"></a><span id="l57.239">   }</span>
<a href="#l57.240"></a><span id="l57.240"> </span>
<a href="#l57.241"></a><span id="l57.241">   bool foundHome = false, foundWork = false;</span>
<a href="#l57.242"></a><span id="l57.242"> </span>
<a href="#l57.243"></a><span id="l57.243">   uint32_t i;</span>
<a href="#l57.244"></a><span id="l57.244">   for (i = 0; i &lt; nsAbOSXUtils::kPropertyMapSize; ++i) {</span>
<a href="#l57.245"></a><span id="l57.245">     const nsAbOSXPropertyMap &amp;propertyMap = nsAbOSXUtils::kPropertyMap[i];</span>
<a href="#l57.246"></a><span id="l57.246" class="difflineminus">-    if (!propertyMap.mOSXProperty)</span>
<a href="#l57.247"></a><span id="l57.247" class="difflineminus">-      continue;</span>
<a href="#l57.248"></a><span id="l57.248" class="difflineplus">+    if (!propertyMap.mOSXProperty) continue;</span>
<a href="#l57.249"></a><span id="l57.249"> </span>
<a href="#l57.250"></a><span id="l57.250">     if (propertyMap.mOSXLabel) {</span>
<a href="#l57.251"></a><span id="l57.251" class="difflineminus">-      if (MapMultiValue(this, card, propertyMap, aNotify,</span>
<a href="#l57.252"></a><span id="l57.252" class="difflineminus">-                        abManager) &amp;&amp; propertyMap.mOSXProperty == kABAddressProperty) {</span>
<a href="#l57.253"></a><span id="l57.253" class="difflineplus">+      if (MapMultiValue(this, card, propertyMap, aNotify, abManager) &amp;&amp;</span>
<a href="#l57.254"></a><span id="l57.254" class="difflineplus">+          propertyMap.mOSXProperty == kABAddressProperty) {</span>
<a href="#l57.255"></a><span id="l57.255">         if (propertyMap.mOSXLabel == kABAddressHomeLabel)</span>
<a href="#l57.256"></a><span id="l57.256">           foundHome = true;</span>
<a href="#l57.257"></a><span id="l57.257">         else</span>
<a href="#l57.258"></a><span id="l57.258">           foundWork = true;</span>
<a href="#l57.259"></a><span id="l57.259">       }</span>
<a href="#l57.260"></a><span id="l57.260" class="difflineminus">-    }</span>
<a href="#l57.261"></a><span id="l57.261" class="difflineminus">-    else {</span>
<a href="#l57.262"></a><span id="l57.262" class="difflineminus">-      MapStringProperty(this, card, propertyMap.mOSXProperty,</span>
<a href="#l57.263"></a><span id="l57.263" class="difflineminus">-                        propertyMap.mPropertyName, aNotify, abManager);</span>
<a href="#l57.264"></a><span id="l57.264" class="difflineplus">+    } else {</span>
<a href="#l57.265"></a><span id="l57.265" class="difflineplus">+      MapStringProperty(this, card, propertyMap.mOSXProperty, propertyMap.mPropertyName, aNotify,</span>
<a href="#l57.266"></a><span id="l57.266" class="difflineplus">+                        abManager);</span>
<a href="#l57.267"></a><span id="l57.267">     }</span>
<a href="#l57.268"></a><span id="l57.268">   }</span>
<a href="#l57.269"></a><span id="l57.269"> </span>
<a href="#l57.270"></a><span id="l57.270">   int flags = 0;</span>
<a href="#l57.271"></a><span id="l57.271" class="difflineminus">-  if (kABPersonFlags)</span>
<a href="#l57.272"></a><span id="l57.272" class="difflineminus">-    flags = [[card valueForProperty:kABPersonFlags] intValue];</span>
<a href="#l57.273"></a><span id="l57.273" class="difflineplus">+  if (kABPersonFlags) flags = [[card valueForProperty:kABPersonFlags] intValue];</span>
<a href="#l57.274"></a><span id="l57.274"> </span>
<a href="#l57.275"></a><span id="l57.275"> #define SET_STRING(_value, _name, _notify, _session) \</span>
<a href="#l57.276"></a><span id="l57.276">   SetStringProperty(this, _value, #_name, _notify, _session)</span>
<a href="#l57.277"></a><span id="l57.277"> </span>
<a href="#l57.278"></a><span id="l57.278" class="difflineminus">-    // If kABShowAsCompany is set we use the company name as display name.</span>
<a href="#l57.279"></a><span id="l57.279" class="difflineminus">-    if (kABPersonFlags &amp;&amp; (flags &amp; kABShowAsCompany)) {</span>
<a href="#l57.280"></a><span id="l57.280" class="difflineminus">-      nsString company;</span>
<a href="#l57.281"></a><span id="l57.281" class="difflineminus">-      nsresult rv = GetPropertyAsAString(kCompanyProperty, company);</span>
<a href="#l57.282"></a><span id="l57.282" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l57.283"></a><span id="l57.283" class="difflineminus">-        company.Truncate();</span>
<a href="#l57.284"></a><span id="l57.284" class="difflineminus">-      SET_STRING(company, DisplayName, aNotify, abManager);</span>
<a href="#l57.285"></a><span id="l57.285" class="difflineminus">-    }</span>
<a href="#l57.286"></a><span id="l57.286" class="difflineminus">-  else {</span>
<a href="#l57.287"></a><span id="l57.287" class="difflineplus">+  // If kABShowAsCompany is set we use the company name as display name.</span>
<a href="#l57.288"></a><span id="l57.288" class="difflineplus">+  if (kABPersonFlags &amp;&amp; (flags &amp; kABShowAsCompany)) {</span>
<a href="#l57.289"></a><span id="l57.289" class="difflineplus">+    nsString company;</span>
<a href="#l57.290"></a><span id="l57.290" class="difflineplus">+    nsresult rv = GetPropertyAsAString(kCompanyProperty, company);</span>
<a href="#l57.291"></a><span id="l57.291" class="difflineplus">+    if (NS_FAILED(rv)) company.Truncate();</span>
<a href="#l57.292"></a><span id="l57.292" class="difflineplus">+    SET_STRING(company, DisplayName, aNotify, abManager);</span>
<a href="#l57.293"></a><span id="l57.293" class="difflineplus">+  } else {</span>
<a href="#l57.294"></a><span id="l57.294">     // Use the order used in the OS X address book to set DisplayName.</span>
<a href="#l57.295"></a><span id="l57.295">     int order = kABPersonFlags &amp;&amp; (flags &amp; kABNameOrderingMask);</span>
<a href="#l57.296"></a><span id="l57.296">     if (kABPersonFlags &amp;&amp; (order == kABDefaultNameOrdering)) {</span>
<a href="#l57.297"></a><span id="l57.297">       order = [addressBook defaultNameOrdering];</span>
<a href="#l57.298"></a><span id="l57.298">     }</span>
<a href="#l57.299"></a><span id="l57.299"> </span>
<a href="#l57.300"></a><span id="l57.300">     nsAutoString displayName, tempName;</span>
<a href="#l57.301"></a><span id="l57.301">     if (kABPersonFlags &amp;&amp; (order == kABFirstNameFirst)) {</span>
<a href="#l57.302"></a><span id="l57.302">       GetFirstName(tempName);</span>
<a href="#l57.303"></a><span id="l57.303">       displayName.Append(tempName);</span>
<a href="#l57.304"></a><span id="l57.304"> </span>
<a href="#l57.305"></a><span id="l57.305">       GetLastName(tempName);</span>
<a href="#l57.306"></a><span id="l57.306"> </span>
<a href="#l57.307"></a><span id="l57.307">       // Only append a space if the last name and the first name are not empty</span>
<a href="#l57.308"></a><span id="l57.308" class="difflineminus">-      if (!tempName.IsEmpty() &amp;&amp; !displayName.IsEmpty())</span>
<a href="#l57.309"></a><span id="l57.309" class="difflineminus">-        displayName.Append(' ');</span>
<a href="#l57.310"></a><span id="l57.310" class="difflineplus">+      if (!tempName.IsEmpty() &amp;&amp; !displayName.IsEmpty()) displayName.Append(' ');</span>
<a href="#l57.311"></a><span id="l57.311"> </span>
<a href="#l57.312"></a><span id="l57.312">       displayName.Append(tempName);</span>
<a href="#l57.313"></a><span id="l57.313" class="difflineminus">-    }</span>
<a href="#l57.314"></a><span id="l57.314" class="difflineminus">-    else {</span>
<a href="#l57.315"></a><span id="l57.315" class="difflineplus">+    } else {</span>
<a href="#l57.316"></a><span id="l57.316">       GetLastName(tempName);</span>
<a href="#l57.317"></a><span id="l57.317">       displayName.Append(tempName);</span>
<a href="#l57.318"></a><span id="l57.318"> </span>
<a href="#l57.319"></a><span id="l57.319">       GetFirstName(tempName);</span>
<a href="#l57.320"></a><span id="l57.320"> </span>
<a href="#l57.321"></a><span id="l57.321">       // Only append a space if the last name and the first name are not empty</span>
<a href="#l57.322"></a><span id="l57.322" class="difflineminus">-      if (!tempName.IsEmpty() &amp;&amp; !displayName.IsEmpty())</span>
<a href="#l57.323"></a><span id="l57.323" class="difflineminus">-        displayName.Append(' ');</span>
<a href="#l57.324"></a><span id="l57.324" class="difflineplus">+      if (!tempName.IsEmpty() &amp;&amp; !displayName.IsEmpty()) displayName.Append(' ');</span>
<a href="#l57.325"></a><span id="l57.325"> </span>
<a href="#l57.326"></a><span id="l57.326">       displayName.Append(tempName);</span>
<a href="#l57.327"></a><span id="l57.327">     }</span>
<a href="#l57.328"></a><span id="l57.328">     SET_STRING(displayName, DisplayName, aNotify, abManager);</span>
<a href="#l57.329"></a><span id="l57.329">   }</span>
<a href="#l57.330"></a><span id="l57.330"> </span>
<a href="#l57.331"></a><span id="l57.331">   ABMultiValue *value = GetMultiValue(card, kABEmailProperty);</span>
<a href="#l57.332"></a><span id="l57.332">   if (value) {</span>
<a href="#l57.333"></a><span id="l57.333">     unsigned int count = [value count];</span>
<a href="#l57.334"></a><span id="l57.334">     if (count &gt; 0) {</span>
<a href="#l57.335"></a><span id="l57.335">       unsigned int j = [value indexForIdentifier:[value primaryIdentifier]];</span>
<a href="#l57.336"></a><span id="l57.336"> </span>
<a href="#l57.337"></a><span id="l57.337" class="difflineminus">-      if (j &lt; count)</span>
<a href="#l57.338"></a><span id="l57.338" class="difflineminus">-        SET_STRING([value valueAtIndex:j], PrimaryEmail, aNotify,</span>
<a href="#l57.339"></a><span id="l57.339" class="difflineminus">-                   abManager);</span>
<a href="#l57.340"></a><span id="l57.340" class="difflineplus">+      if (j &lt; count) SET_STRING([value valueAtIndex:j], PrimaryEmail, aNotify, abManager);</span>
<a href="#l57.341"></a><span id="l57.341"> </span>
<a href="#l57.342"></a><span id="l57.342">       // If j is 0 (first in the list) we want the second in the list</span>
<a href="#l57.343"></a><span id="l57.343">       // (index 1), if j is anything else we want the first in the list</span>
<a href="#l57.344"></a><span id="l57.344">       // (index 0).</span>
<a href="#l57.345"></a><span id="l57.345">       j = (j == 0);</span>
<a href="#l57.346"></a><span id="l57.346" class="difflineminus">-      if (j &lt; count)</span>
<a href="#l57.347"></a><span id="l57.347" class="difflineminus">-        SET_STRING([value valueAtIndex:j], SecondEmail, aNotify,</span>
<a href="#l57.348"></a><span id="l57.348" class="difflineminus">-                   abManager);</span>
<a href="#l57.349"></a><span id="l57.349" class="difflineplus">+      if (j &lt; count) SET_STRING([value valueAtIndex:j], SecondEmail, aNotify, abManager);</span>
<a href="#l57.350"></a><span id="l57.350">     }</span>
<a href="#l57.351"></a><span id="l57.351">   }</span>
<a href="#l57.352"></a><span id="l57.352"> </span>
<a href="#l57.353"></a><span id="l57.353">   // We map the first home address we can find and the first work address</span>
<a href="#l57.354"></a><span id="l57.354">   // we can find. If we find none, we map the primary address to the home</span>
<a href="#l57.355"></a><span id="l57.355">   // address.</span>
<a href="#l57.356"></a><span id="l57.356">   if (!foundHome &amp;&amp; !foundWork) {</span>
<a href="#l57.357"></a><span id="l57.357">     value = GetMultiValue(card, kABAddressProperty);</span>
<a href="#l57.358"></a><span id="l57.358">     if (value) {</span>
<a href="#l57.359"></a><span id="l57.359">       unsigned int count = [value count];</span>
<a href="#l57.360"></a><span id="l57.360">       unsigned int j = [value indexForIdentifier:[value primaryIdentifier]];</span>
<a href="#l57.361"></a><span id="l57.361"> </span>
<a href="#l57.362"></a><span id="l57.362">       if (j &lt; count) {</span>
<a href="#l57.363"></a><span id="l57.363">         NSDictionary *address = [value valueAtIndex:j];</span>
<a href="#l57.364"></a><span id="l57.364">         if (address) {</span>
<a href="#l57.365"></a><span id="l57.365" class="difflineminus">-          SET_STRING([address objectForKey:kABAddressStreetKey],</span>
<a href="#l57.366"></a><span id="l57.366" class="difflineminus">-                     HomeAddress, aNotify, abManager);</span>
<a href="#l57.367"></a><span id="l57.367" class="difflineminus">-          SET_STRING([address objectForKey:kABAddressCityKey],</span>
<a href="#l57.368"></a><span id="l57.368" class="difflineminus">-                     HomeCity, aNotify, abManager);</span>
<a href="#l57.369"></a><span id="l57.369" class="difflineminus">-          SET_STRING([address objectForKey:kABAddressStateKey],</span>
<a href="#l57.370"></a><span id="l57.370" class="difflineminus">-                     HomeState, aNotify, abManager);</span>
<a href="#l57.371"></a><span id="l57.371" class="difflineminus">-          SET_STRING([address objectForKey:kABAddressZIPKey],</span>
<a href="#l57.372"></a><span id="l57.372" class="difflineminus">-                     HomeZipCode, aNotify, abManager);</span>
<a href="#l57.373"></a><span id="l57.373" class="difflineminus">-          SET_STRING([address objectForKey:kABAddressCountryKey],</span>
<a href="#l57.374"></a><span id="l57.374" class="difflineminus">-                     HomeCountry, aNotify, abManager);</span>
<a href="#l57.375"></a><span id="l57.375" class="difflineplus">+          SET_STRING([address objectForKey:kABAddressStreetKey], HomeAddress, aNotify, abManager);</span>
<a href="#l57.376"></a><span id="l57.376" class="difflineplus">+          SET_STRING([address objectForKey:kABAddressCityKey], HomeCity, aNotify, abManager);</span>
<a href="#l57.377"></a><span id="l57.377" class="difflineplus">+          SET_STRING([address objectForKey:kABAddressStateKey], HomeState, aNotify, abManager);</span>
<a href="#l57.378"></a><span id="l57.378" class="difflineplus">+          SET_STRING([address objectForKey:kABAddressZIPKey], HomeZipCode, aNotify, abManager);</span>
<a href="#l57.379"></a><span id="l57.379" class="difflineplus">+          SET_STRING([address objectForKey:kABAddressCountryKey], HomeCountry, aNotify, abManager);</span>
<a href="#l57.380"></a><span id="l57.380">         }</span>
<a href="#l57.381"></a><span id="l57.381">       }</span>
<a href="#l57.382"></a><span id="l57.382">     }</span>
<a href="#l57.383"></a><span id="l57.383">   }</span>
<a href="#l57.384"></a><span id="l57.384">   // This was kABAIMInstantProperty previously, but it was deprecated in OS X 10.7.</span>
<a href="#l57.385"></a><span id="l57.385">   value = GetMultiValue(card, kABInstantMessageProperty);</span>
<a href="#l57.386"></a><span id="l57.386">   if (value) {</span>
<a href="#l57.387"></a><span id="l57.387">     unsigned int count = [value count];</span>
<a href="#l57.388"></a><span id="l57.388">     for (size_t i = 0; i &lt; count; i++) {</span>
<a href="#l57.389"></a><span id="l57.389">       id imValue = [value valueAtIndex:i];</span>
<a href="#l57.390"></a><span id="l57.390">       // Depending on the macOS version, imValue can be an NSString or an NSDictionary.</span>
<a href="#l57.391"></a><span id="l57.391">       if ([imValue isKindOfClass:[NSString class]]) {</span>
<a href="#l57.392"></a><span id="l57.392">         if (i == [value indexForIdentifier:[value primaryIdentifier]]) {</span>
<a href="#l57.393"></a><span id="l57.393">           SET_STRING(imValue, _AimScreenName, aNotify, abManager);</span>
<a href="#l57.394"></a><span id="l57.394">         }</span>
<a href="#l57.395"></a><span id="l57.395">       } else if ([imValue isKindOfClass:[NSDictionary class]]) {</span>
<a href="#l57.396"></a><span id="l57.396" class="difflineminus">-        NSString* instantMessageService = [imValue objectForKey:@&quot;InstantMessageService&quot;];</span>
<a href="#l57.397"></a><span id="l57.397" class="difflineminus">-        const char* fieldName = InstantMessengerFieldName(instantMessageService);</span>
<a href="#l57.398"></a><span id="l57.398" class="difflineminus">-        NSString* userName = [imValue objectForKey:@&quot;InstantMessageUsername&quot;];</span>
<a href="#l57.399"></a><span id="l57.399" class="difflineplus">+        NSString *instantMessageService = [imValue objectForKey:@&quot;InstantMessageService&quot;];</span>
<a href="#l57.400"></a><span id="l57.400" class="difflineplus">+        const char *fieldName = InstantMessengerFieldName(instantMessageService);</span>
<a href="#l57.401"></a><span id="l57.401" class="difflineplus">+        NSString *userName = [imValue objectForKey:@&quot;InstantMessageUsername&quot;];</span>
<a href="#l57.402"></a><span id="l57.402">         SetStringProperty(this, userName, fieldName, aNotify, abManager);</span>
<a href="#l57.403"></a><span id="l57.403">       }</span>
<a href="#l57.404"></a><span id="l57.404">     }</span>
<a href="#l57.405"></a><span id="l57.405">   }</span>
<a href="#l57.406"></a><span id="l57.406"> </span>
<a href="#l57.407"></a><span id="l57.407"> #define MAP_DATE(_date, _name, _notify, _session) \</span>
<a href="#l57.408"></a><span id="l57.408" class="difflineminus">-  MapDate(this, _date, #_name&quot;Year&quot;, #_name&quot;Month&quot;, #_name&quot;Day&quot;, _notify, \</span>
<a href="#l57.409"></a><span id="l57.409" class="difflineminus">-  _session)</span>
<a href="#l57.410"></a><span id="l57.410" class="difflineplus">+  MapDate(this, _date, #_name &quot;Year&quot;, #_name &quot;Month&quot;, #_name &quot;Day&quot;, _notify, _session)</span>
<a href="#l57.411"></a><span id="l57.411"> </span>
<a href="#l57.412"></a><span id="l57.412" class="difflineminus">-    NSDate *date = [card valueForProperty:kABBirthdayProperty];</span>
<a href="#l57.413"></a><span id="l57.413" class="difflineminus">-  if (date)</span>
<a href="#l57.414"></a><span id="l57.414" class="difflineminus">-    MAP_DATE(date, Birth, aNotify, abManager);</span>
<a href="#l57.415"></a><span id="l57.415" class="difflineplus">+  NSDate *date = [card valueForProperty:kABBirthdayProperty];</span>
<a href="#l57.416"></a><span id="l57.416" class="difflineplus">+  if (date) MAP_DATE(date, Birth, aNotify, abManager);</span>
<a href="#l57.417"></a><span id="l57.417"> </span>
<a href="#l57.418"></a><span id="l57.418">   if (kABOtherDatesProperty) {</span>
<a href="#l57.419"></a><span id="l57.419">     value = GetMultiValue(card, kABOtherDatesProperty);</span>
<a href="#l57.420"></a><span id="l57.420">     if (value) {</span>
<a href="#l57.421"></a><span id="l57.421">       unsigned int j, count = [value count];</span>
<a href="#l57.422"></a><span id="l57.422">       for (j = 0; j &lt; count; ++j) {</span>
<a href="#l57.423"></a><span id="l57.423">         if ([[value labelAtIndex:j] isEqualToString:kABAnniversaryLabel]) {</span>
<a href="#l57.424"></a><span id="l57.424">           date = [value valueAtIndex:j];</span>
<a href="#l57.425"></a><span id="l57.425" class="difflineat">@@ -385,17 +325,15 @@ nsAbOSXCard::Update(bool aNotify)</span>
<a href="#l57.426"></a><span id="l57.426">         }</span>
<a href="#l57.427"></a><span id="l57.427">       }</span>
<a href="#l57.428"></a><span id="l57.428">     }</span>
<a href="#l57.429"></a><span id="l57.429">   }</span>
<a href="#l57.430"></a><span id="l57.430"> #undef MAP_DATE</span>
<a href="#l57.431"></a><span id="l57.431"> #undef SET_STRING</span>
<a href="#l57.432"></a><span id="l57.432"> </span>
<a href="#l57.433"></a><span id="l57.433">   date = [card valueForProperty:kABModificationDateProperty];</span>
<a href="#l57.434"></a><span id="l57.434" class="difflineminus">-  if (date)</span>
<a href="#l57.435"></a><span id="l57.435" class="difflineminus">-    SetPropertyAsUint32(&quot;LastModifiedDate&quot;,</span>
<a href="#l57.436"></a><span id="l57.436" class="difflineminus">-                        uint32_t([date timeIntervalSince1970]));</span>
<a href="#l57.437"></a><span id="l57.437" class="difflineminus">-    // XXX No way to notify about this?</span>
<a href="#l57.438"></a><span id="l57.438" class="difflineplus">+  if (date) SetPropertyAsUint32(&quot;LastModifiedDate&quot;, uint32_t([date timeIntervalSince1970]));</span>
<a href="#l57.439"></a><span id="l57.439" class="difflineplus">+  // XXX No way to notify about this?</span>
<a href="#l57.440"></a><span id="l57.440"> </span>
<a href="#l57.441"></a><span id="l57.441">   return NS_OK;</span>
<a href="#l57.442"></a><span id="l57.442"> </span>
<a href="#l57.443"></a><span id="l57.443">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l57.444"></a><span id="l57.444"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirFactory.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirFactory.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -13,38 +13,35 @@</span>
<a href="#l58.4"></a><span id="l58.4"> #include &quot;nsAbOSXDirectory.h&quot;</span>
<a href="#l58.5"></a><span id="l58.5"> </span>
<a href="#l58.6"></a><span id="l58.6"> NS_IMPL_ISUPPORTS(nsAbOSXDirFactory, nsIAbDirFactory)</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8"> NS_IMETHODIMP</span>
<a href="#l58.9"></a><span id="l58.9"> nsAbOSXDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l58.10"></a><span id="l58.10">                                   const nsACString &amp;aURI,</span>
<a href="#l58.11"></a><span id="l58.11">                                   const nsACString &amp;aPrefName,</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-                                  nsISimpleEnumerator **aDirectories)</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-{</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+                                  nsISimpleEnumerator **aDirectories) {</span>
<a href="#l58.15"></a><span id="l58.15">   NS_ENSURE_ARG_POINTER(aDirectories);</span>
<a href="#l58.16"></a><span id="l58.16"> </span>
<a href="#l58.17"></a><span id="l58.17">   *aDirectories = nullptr;</span>
<a href="#l58.18"></a><span id="l58.18"> </span>
<a href="#l58.19"></a><span id="l58.19">   nsresult rv;</span>
<a href="#l58.20"></a><span id="l58.20">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l58.21"></a><span id="l58.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.22"></a><span id="l58.22"> </span>
<a href="#l58.23"></a><span id="l58.23">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineminus">-  rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineminus">-                               getter_AddRefs(directory));</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineplus">+  rv = abManager-&gt;GetDirectory(</span>
<a href="#l58.27"></a><span id="l58.27" class="difflineplus">+      NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l58.28"></a><span id="l58.28" class="difflineplus">+      getter_AddRefs(directory));</span>
<a href="#l58.29"></a><span id="l58.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.30"></a><span id="l58.30"> </span>
<a href="#l58.31"></a><span id="l58.31">   nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l58.32"></a><span id="l58.32">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.33"></a><span id="l58.33"> </span>
<a href="#l58.34"></a><span id="l58.34">   rv = osxDirectory-&gt;AssertChildNodes();</span>
<a href="#l58.35"></a><span id="l58.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.36"></a><span id="l58.36"> </span>
<a href="#l58.37"></a><span id="l58.37">   return NS_NewSingletonEnumerator(aDirectories, osxDirectory);</span>
<a href="#l58.38"></a><span id="l58.38"> }</span>
<a href="#l58.39"></a><span id="l58.39"> </span>
<a href="#l58.40"></a><span id="l58.40"> // No actual deletion, since you cannot create the address books from Mozilla.</span>
<a href="#l58.41"></a><span id="l58.41"> NS_IMETHODIMP</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineminus">-nsAbOSXDirFactory::DeleteDirectory(nsIAbDirectory *aDirectory)</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineminus">-{</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineminus">-  return NS_OK;</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineminus">-}</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineplus">+nsAbOSXDirFactory::DeleteDirectory(nsIAbDirectory *aDirectory) { return NS_OK; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirFactory.h</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirFactory.h</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -3,19 +3,18 @@</span>
<a href="#l59.4"></a><span id="l59.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l59.5"></a><span id="l59.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l59.6"></a><span id="l59.6"> </span>
<a href="#l59.7"></a><span id="l59.7"> #ifndef nsAbOSXDirFactory_h___</span>
<a href="#l59.8"></a><span id="l59.8"> #define nsAbOSXDirFactory_h___</span>
<a href="#l59.9"></a><span id="l59.9"> </span>
<a href="#l59.10"></a><span id="l59.10"> #include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-class nsAbOSXDirFactory final : public nsIAbDirFactory</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-{</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineminus">-public:</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineminus">-    NS_DECL_NSIABDIRFACTORY</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+class nsAbOSXDirFactory final : public nsIAbDirFactory {</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+ public:</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineplus">+  NS_DECL_NSIABDIRFACTORY</span>
<a href="#l59.21"></a><span id="l59.21"> </span>
<a href="#l59.22"></a><span id="l59.22" class="difflineminus">-private:</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineminus">-    ~nsAbOSXDirFactory() {}</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+ private:</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineplus">+  ~nsAbOSXDirFactory() {}</span>
<a href="#l59.26"></a><span id="l59.26"> };</span>
<a href="#l59.27"></a><span id="l59.27"> </span>
<a href="#l59.28"></a><span id="l59.28" class="difflineminus">-#endif // nsAbOSXDirFactory_h___</span>
<a href="#l59.29"></a><span id="l59.29" class="difflineplus">+#endif  // nsAbOSXDirFactory_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -16,97 +16,95 @@</span>
<a href="#l60.4"></a><span id="l60.4"> #include &quot;nsAbOSXCard.h&quot;</span>
<a href="#l60.5"></a><span id="l60.5"> </span>
<a href="#l60.6"></a><span id="l60.6"> #include &lt;CoreFoundation/CoreFoundation.h&gt;</span>
<a href="#l60.7"></a><span id="l60.7"> class nsIAbManager;</span>
<a href="#l60.8"></a><span id="l60.8"> class nsIAbBooleanExpression;</span>
<a href="#l60.9"></a><span id="l60.9"> </span>
<a href="#l60.10"></a><span id="l60.10"> #define NS_ABOSXDIRECTORY_URI_PREFIX NS_ABOSXDIRECTORY_PREFIX &quot;://&quot;</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-#define NS_IABOSXDIRECTORY_IID \</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-{ 0x87ee4bd9, 0x8552, 0x498f, \</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineminus">-  { 0x80, 0x85, 0x34, 0xf0, 0x2a, 0xbb, 0x56, 0x16 } }</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+#define NS_IABOSXDIRECTORY_IID                       \</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+  {                                                  \</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+    0x87ee4bd9, 0x8552, 0x498f, {                    \</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineplus">+      0x80, 0x85, 0x34, 0xf0, 0x2a, 0xbb, 0x56, 0x16 \</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineplus">+    }                                                \</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineplus">+  }</span>
<a href="#l60.21"></a><span id="l60.21"> </span>
<a href="#l60.22"></a><span id="l60.22" class="difflineminus">-class nsIAbOSXDirectory : public nsISupports</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineminus">-{</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineminus">-public:</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+class nsIAbOSXDirectory : public nsISupports {</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+ public:</span>
<a href="#l60.27"></a><span id="l60.27">   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IABOSXDIRECTORY_IID)</span>
<a href="#l60.28"></a><span id="l60.28"> </span>
<a href="#l60.29"></a><span id="l60.29">   virtual nsresult AssertChildNodes() = 0;</span>
<a href="#l60.30"></a><span id="l60.30">   virtual nsresult Update() = 0;</span>
<a href="#l60.31"></a><span id="l60.31">   virtual nsresult AssertDirectory(nsIAbManager *aManager,</span>
<a href="#l60.32"></a><span id="l60.32">                                    nsIAbDirectory *aDirectory) = 0;</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineminus">-  virtual nsresult AssertCard(nsIAbManager *aManager,</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineminus">-                              nsIAbCard *aCard) = 0;</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineminus">-  virtual nsresult UnassertCard(nsIAbManager *aManager,</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineminus">-                                nsIAbCard *aCard,</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+  virtual nsresult AssertCard(nsIAbManager *aManager, nsIAbCard *aCard) = 0;</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+  virtual nsresult UnassertCard(nsIAbManager *aManager, nsIAbCard *aCard,</span>
<a href="#l60.39"></a><span id="l60.39">                                 nsIMutableArray *aCardList) = 0;</span>
<a href="#l60.40"></a><span id="l60.40">   virtual nsresult UnassertDirectory(nsIAbManager *aManager,</span>
<a href="#l60.41"></a><span id="l60.41">                                      nsIAbDirectory *aDirectory) = 0;</span>
<a href="#l60.42"></a><span id="l60.42">   virtual nsresult DeleteUid(const nsACString &amp;aUid) = 0;</span>
<a href="#l60.43"></a><span id="l60.43">   virtual nsresult GetURI(nsACString &amp;aURI) = 0;</span>
<a href="#l60.44"></a><span id="l60.44">   virtual nsresult Init(const char *aUri) = 0;</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineminus">-  virtual nsresult GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult) = 0;</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+  virtual nsresult GetCardByUri(const nsACString &amp;aUri,</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+                                nsIAbOSXCard **aResult) = 0;</span>
<a href="#l60.48"></a><span id="l60.48"> };</span>
<a href="#l60.49"></a><span id="l60.49"> </span>
<a href="#l60.50"></a><span id="l60.50"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIAbOSXDirectory, NS_IABOSXDIRECTORY_IID)</span>
<a href="#l60.51"></a><span id="l60.51"> </span>
<a href="#l60.52"></a><span id="l60.52"> class nsAbOSXDirectory final : public nsAbDirProperty,</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineminus">-public nsIAbDirSearchListener,</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineminus">-public nsIAbOSXDirectory</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineminus">-{</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineminus">-public:</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineplus">+                               public nsIAbDirSearchListener,</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineplus">+                               public nsIAbOSXDirectory {</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+ public:</span>
<a href="#l60.60"></a><span id="l60.60">   nsAbOSXDirectory();</span>
<a href="#l60.61"></a><span id="l60.61"> </span>
<a href="#l60.62"></a><span id="l60.62">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l60.63"></a><span id="l60.63">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l60.64"></a><span id="l60.64"> </span>
<a href="#l60.65"></a><span id="l60.65">   // nsIAbOSXDirectory method</span>
<a href="#l60.66"></a><span id="l60.66">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l60.67"></a><span id="l60.67"> </span>
<a href="#l60.68"></a><span id="l60.68">   // nsAbDirProperty methods</span>
<a href="#l60.69"></a><span id="l60.69">   NS_IMETHOD GetReadOnly(bool *aReadOnly) override;</span>
<a href="#l60.70"></a><span id="l60.70">   NS_IMETHOD GetChildCards(nsISimpleEnumerator **aCards) override;</span>
<a href="#l60.71"></a><span id="l60.71">   NS_IMETHOD GetChildNodes(nsISimpleEnumerator **aNodes) override;</span>
<a href="#l60.72"></a><span id="l60.72">   NS_IMETHOD GetIsQuery(bool *aResult) override;</span>
<a href="#l60.73"></a><span id="l60.73">   NS_IMETHOD HasCard(nsIAbCard *aCard, bool *aHasCard) override;</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineminus">-  NS_IMETHOD HasDirectory(nsIAbDirectory *aDirectory, bool *aHasDirectory) override;</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineplus">+  NS_IMETHOD HasDirectory(nsIAbDirectory *aDirectory,</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+                          bool *aHasDirectory) override;</span>
<a href="#l60.77"></a><span id="l60.77">   NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l60.78"></a><span id="l60.78">   NS_IMETHOD GetCardFromProperty(const char *aProperty,</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineminus">-                                 const nsACString &amp;aValue,</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineminus">-                                 bool caseSensitive,</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineplus">+                                 const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l60.82"></a><span id="l60.82">                                  nsIAbCard **aResult) override;</span>
<a href="#l60.83"></a><span id="l60.83">   NS_IMETHOD GetCardsFromProperty(const char *aProperty,</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineminus">-                                  const nsACString &amp;aValue,</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineminus">-                                  bool aCaseSensitive,</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+                                  const nsACString &amp;aValue, bool aCaseSensitive,</span>
<a href="#l60.87"></a><span id="l60.87">                                   nsISimpleEnumerator **aResult) override;</span>
<a href="#l60.88"></a><span id="l60.88">   NS_IMETHOD CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l60.89"></a><span id="l60.89">                                  nsIAbCard **aResult) override;</span>
<a href="#l60.90"></a><span id="l60.90"> </span>
<a href="#l60.91"></a><span id="l60.91">   // nsIAbOSXDirectory</span>
<a href="#l60.92"></a><span id="l60.92">   nsresult AssertChildNodes() override;</span>
<a href="#l60.93"></a><span id="l60.93">   nsresult AssertDirectory(nsIAbManager *aManager,</span>
<a href="#l60.94"></a><span id="l60.94">                            nsIAbDirectory *aDirectory) override;</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineminus">-  nsresult AssertCard(nsIAbManager *aManager,</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineminus">-                      nsIAbCard *aCard) override;</span>
<a href="#l60.97"></a><span id="l60.97" class="difflineminus">-  nsresult UnassertCard(nsIAbManager *aManager,</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineminus">-                        nsIAbCard *aCard,</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineplus">+  nsresult AssertCard(nsIAbManager *aManager, nsIAbCard *aCard) override;</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineplus">+  nsresult UnassertCard(nsIAbManager *aManager, nsIAbCard *aCard,</span>
<a href="#l60.101"></a><span id="l60.101">                         nsIMutableArray *aCardList) override;</span>
<a href="#l60.102"></a><span id="l60.102">   nsresult UnassertDirectory(nsIAbManager *aManager,</span>
<a href="#l60.103"></a><span id="l60.103">                              nsIAbDirectory *aDirectory) override;</span>
<a href="#l60.104"></a><span id="l60.104"> </span>
<a href="#l60.105"></a><span id="l60.105">   nsresult Update() override;</span>
<a href="#l60.106"></a><span id="l60.106"> </span>
<a href="#l60.107"></a><span id="l60.107">   nsresult DeleteUid(const nsACString &amp;aUid) override;</span>
<a href="#l60.108"></a><span id="l60.108"> </span>
<a href="#l60.109"></a><span id="l60.109" class="difflineminus">-  nsresult GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult) override;</span>
<a href="#l60.110"></a><span id="l60.110" class="difflineplus">+  nsresult GetCardByUri(const nsACString &amp;aUri,</span>
<a href="#l60.111"></a><span id="l60.111" class="difflineplus">+                        nsIAbOSXCard **aResult) override;</span>
<a href="#l60.112"></a><span id="l60.112"> </span>
<a href="#l60.113"></a><span id="l60.113">   nsresult GetRootOSXDirectory(nsIAbOSXDirectory **aResult);</span>
<a href="#l60.114"></a><span id="l60.114"> </span>
<a href="#l60.115"></a><span id="l60.115" class="difflineminus">-private:</span>
<a href="#l60.116"></a><span id="l60.116" class="difflineplus">+ private:</span>
<a href="#l60.117"></a><span id="l60.117">   ~nsAbOSXDirectory();</span>
<a href="#l60.118"></a><span id="l60.118">   nsresult FallbackSearch(nsIAbBooleanExpression *aExpression,</span>
<a href="#l60.119"></a><span id="l60.119">                           nsISimpleEnumerator **aCards);</span>
<a href="#l60.120"></a><span id="l60.120"> </span>
<a href="#l60.121"></a><span id="l60.121">   // This is a list of nsIAbCards, kept separate from m_AddressList because:</span>
<a href="#l60.122"></a><span id="l60.122">   // - nsIAbDirectory items that are mailing lists, must keep a list of</span>
<a href="#l60.123"></a><span id="l60.123">   //   nsIAbCards in m_AddressList, however</span>
<a href="#l60.124"></a><span id="l60.124">   // - nsIAbDirectory items that are address books, must keep a list of</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineat">@@ -116,9 +114,9 @@ private:</span>
<a href="#l60.126"></a><span id="l60.126">   // but because we store our own copy of the list, we must store a separate</span>
<a href="#l60.127"></a><span id="l60.127">   // list of nsIAbCards here. nsIMutableArray is used, because then it is</span>
<a href="#l60.128"></a><span id="l60.128">   // interchangeable with m_AddressList.</span>
<a href="#l60.129"></a><span id="l60.129">   nsCOMPtr&lt;nsIMutableArray&gt; mCardList;</span>
<a href="#l60.130"></a><span id="l60.130">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIAbOSXCard&gt; mCardStore;</span>
<a href="#l60.131"></a><span id="l60.131">   nsCOMPtr&lt;nsIAbOSXDirectory&gt; mCacheTopLevelOSXAb;</span>
<a href="#l60.132"></a><span id="l60.132"> };</span>
<a href="#l60.133"></a><span id="l60.133"> </span>
<a href="#l60.134"></a><span id="l60.134" class="difflineminus">-#endif // nsAbOSXDirectory_h___</span>
<a href="#l60.135"></a><span id="l60.135" class="difflineplus">+#endif  // nsAbOSXDirectory_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l61.4"></a><span id="l61.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l61.5"></a><span id="l61.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l61.6"></a><span id="l61.6" class="difflineminus">-* License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l61.7"></a><span id="l61.7" class="difflineminus">-* file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.8"></a><span id="l61.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l61.9"></a><span id="l61.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11"> #include &quot;nsAbOSXDirectory.h&quot;</span>
<a href="#l61.12"></a><span id="l61.12"> #include &quot;nsAbOSXCard.h&quot;</span>
<a href="#l61.13"></a><span id="l61.13"> #include &quot;nsAbOSXUtils.h&quot;</span>
<a href="#l61.14"></a><span id="l61.14"> #include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l61.15"></a><span id="l61.15"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l61.16"></a><span id="l61.16"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l61.17"></a><span id="l61.17"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineat">@@ -18,23 +18,21 @@</span>
<a href="#l61.19"></a><span id="l61.19"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l61.20"></a><span id="l61.20"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l61.21"></a><span id="l61.21"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l61.22"></a><span id="l61.22"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l61.23"></a><span id="l61.23"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l61.24"></a><span id="l61.24"> </span>
<a href="#l61.25"></a><span id="l61.25"> #include &lt;AddressBook/AddressBook.h&gt;</span>
<a href="#l61.26"></a><span id="l61.26"> </span>
<a href="#l61.27"></a><span id="l61.27" class="difflineminus">-#define kABDeletedRecords (kABDeletedRecords? kABDeletedRecords : @&quot;ABDeletedRecords&quot;)</span>
<a href="#l61.28"></a><span id="l61.28" class="difflineplus">+#define kABDeletedRecords (kABDeletedRecords ? kABDeletedRecords : @&quot;ABDeletedRecords&quot;)</span>
<a href="#l61.29"></a><span id="l61.29"> #define kABUpdatedRecords (kABUpdatedRecords ? kABUpdatedRecords : @&quot;ABUpdatedRecords&quot;)</span>
<a href="#l61.30"></a><span id="l61.30"> #define kABInsertedRecords (kABInsertedRecords ? kABInsertedRecords : @&quot;ABInsertedRecords&quot;)</span>
<a href="#l61.31"></a><span id="l61.31"> </span>
<a href="#l61.32"></a><span id="l61.32" class="difflineminus">-static nsresult</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineminus">-GetOrCreateGroup(NSString *aUid, nsIAbDirectory **aResult)</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineminus">-{</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineplus">+static nsresult GetOrCreateGroup(NSString *aUid, nsIAbDirectory **aResult) {</span>
<a href="#l61.36"></a><span id="l61.36">   NS_ASSERTION(aUid, &quot;No UID for group!.&quot;);</span>
<a href="#l61.37"></a><span id="l61.37"> </span>
<a href="#l61.38"></a><span id="l61.38">   nsAutoCString uri(NS_ABOSXDIRECTORY_URI_PREFIX);</span>
<a href="#l61.39"></a><span id="l61.39">   AppendToCString(aUid, uri);</span>
<a href="#l61.40"></a><span id="l61.40"> </span>
<a href="#l61.41"></a><span id="l61.41">   nsresult rv;</span>
<a href="#l61.42"></a><span id="l61.42">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.43"></a><span id="l61.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineat">@@ -42,50 +40,44 @@ GetOrCreateGroup(NSString *aUid, nsIAbDi</span>
<a href="#l61.45"></a><span id="l61.45">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.46"></a><span id="l61.46">   rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(directory));</span>
<a href="#l61.47"></a><span id="l61.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.48"></a><span id="l61.48"> </span>
<a href="#l61.49"></a><span id="l61.49">   NS_IF_ADDREF(*aResult = directory);</span>
<a href="#l61.50"></a><span id="l61.50">   return NS_OK;</span>
<a href="#l61.51"></a><span id="l61.51"> }</span>
<a href="#l61.52"></a><span id="l61.52"> </span>
<a href="#l61.53"></a><span id="l61.53" class="difflineminus">-static nsresult</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineminus">-GetCard(ABRecord *aRecord, nsIAbCard **aResult, nsIAbOSXDirectory *osxDirectory)</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineminus">-{</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineplus">+static nsresult GetCard(ABRecord *aRecord, nsIAbCard **aResult, nsIAbOSXDirectory *osxDirectory) {</span>
<a href="#l61.57"></a><span id="l61.57">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.58"></a><span id="l61.58"> </span>
<a href="#l61.59"></a><span id="l61.59">   NSString *uid = [aRecord uniqueId];</span>
<a href="#l61.60"></a><span id="l61.60">   NS_ASSERTION(uid, &quot;No UID for card!.&quot;);</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineminus">-  if (!uid)</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l61.63"></a><span id="l61.63" class="difflineplus">+  if (!uid) return NS_ERROR_FAILURE;</span>
<a href="#l61.64"></a><span id="l61.64"> </span>
<a href="#l61.65"></a><span id="l61.65">   nsAutoCString uri(NS_ABOSXCARD_URI_PREFIX);</span>
<a href="#l61.66"></a><span id="l61.66">   AppendToCString(uid, uri);</span>
<a href="#l61.67"></a><span id="l61.67">   nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard;</span>
<a href="#l61.68"></a><span id="l61.68">   nsresult rv = osxDirectory-&gt;GetCardByUri(uri, getter_AddRefs(osxCard));</span>
<a href="#l61.69"></a><span id="l61.69">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.70"></a><span id="l61.70"> </span>
<a href="#l61.71"></a><span id="l61.71">   nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(osxCard, &amp;rv);</span>
<a href="#l61.72"></a><span id="l61.72">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.73"></a><span id="l61.73"> </span>
<a href="#l61.74"></a><span id="l61.74">   NS_IF_ADDREF(*aResult = card);</span>
<a href="#l61.75"></a><span id="l61.75">   return NS_OK;</span>
<a href="#l61.76"></a><span id="l61.76"> </span>
<a href="#l61.77"></a><span id="l61.77">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.78"></a><span id="l61.78"> }</span>
<a href="#l61.79"></a><span id="l61.79"> </span>
<a href="#l61.80"></a><span id="l61.80" class="difflineminus">-static nsresult</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineminus">-CreateCard(ABRecord *aRecord, nsIAbCard **aResult)</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineminus">-{</span>
<a href="#l61.83"></a><span id="l61.83" class="difflineplus">+static nsresult CreateCard(ABRecord *aRecord, nsIAbCard **aResult) {</span>
<a href="#l61.84"></a><span id="l61.84">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.85"></a><span id="l61.85"> </span>
<a href="#l61.86"></a><span id="l61.86">   NSString *uid = [aRecord uniqueId];</span>
<a href="#l61.87"></a><span id="l61.87">   NS_ASSERTION(uid, &quot;No UID for card!.&quot;);</span>
<a href="#l61.88"></a><span id="l61.88" class="difflineminus">-  if (!uid)</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineplus">+  if (!uid) return NS_ERROR_FAILURE;</span>
<a href="#l61.91"></a><span id="l61.91"> </span>
<a href="#l61.92"></a><span id="l61.92">   nsresult rv;</span>
<a href="#l61.93"></a><span id="l61.93">   nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_CreateInstance(NS_ABOSXCARD_CONTRACTID, &amp;rv);</span>
<a href="#l61.94"></a><span id="l61.94">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.95"></a><span id="l61.95"> </span>
<a href="#l61.96"></a><span id="l61.96">   nsAutoCString uri(NS_ABOSXCARD_URI_PREFIX);</span>
<a href="#l61.97"></a><span id="l61.97">   AppendToCString(uid, uri);</span>
<a href="#l61.98"></a><span id="l61.98"> </span>
<a href="#l61.99"></a><span id="l61.99" class="difflineat">@@ -96,101 +88,89 @@ CreateCard(ABRecord *aRecord, nsIAbCard </span>
<a href="#l61.100"></a><span id="l61.100">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.101"></a><span id="l61.101"> </span>
<a href="#l61.102"></a><span id="l61.102">   NS_IF_ADDREF(*aResult = card);</span>
<a href="#l61.103"></a><span id="l61.103">   return NS_OK;</span>
<a href="#l61.104"></a><span id="l61.104"> </span>
<a href="#l61.105"></a><span id="l61.105">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.106"></a><span id="l61.106"> }</span>
<a href="#l61.107"></a><span id="l61.107"> </span>
<a href="#l61.108"></a><span id="l61.108" class="difflineminus">-static nsresult</span>
<a href="#l61.109"></a><span id="l61.109" class="difflineminus">-Sync(NSString *aUid)</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineminus">-{</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineplus">+static nsresult Sync(NSString *aUid) {</span>
<a href="#l61.112"></a><span id="l61.112">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.113"></a><span id="l61.113"> </span>
<a href="#l61.114"></a><span id="l61.114">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l61.115"></a><span id="l61.115">   ABRecord *card = [addressBook recordForUniqueId:aUid];</span>
<a href="#l61.116"></a><span id="l61.116" class="difflineminus">-  if ([card isKindOfClass:[ABGroup class]])</span>
<a href="#l61.117"></a><span id="l61.117" class="difflineminus">-  {</span>
<a href="#l61.118"></a><span id="l61.118" class="difflineplus">+  if ([card isKindOfClass:[ABGroup class]]) {</span>
<a href="#l61.119"></a><span id="l61.119">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.120"></a><span id="l61.120">     GetOrCreateGroup(aUid, getter_AddRefs(directory));</span>
<a href="#l61.121"></a><span id="l61.121" class="difflineminus">-    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l61.122"></a><span id="l61.122" class="difflineminus">-      do_QueryInterface(directory);</span>
<a href="#l61.123"></a><span id="l61.123" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory = do_QueryInterface(directory);</span>
<a href="#l61.124"></a><span id="l61.124"> </span>
<a href="#l61.125"></a><span id="l61.125">     if (osxDirectory) {</span>
<a href="#l61.126"></a><span id="l61.126">       osxDirectory-&gt;Update();</span>
<a href="#l61.127"></a><span id="l61.127">     }</span>
<a href="#l61.128"></a><span id="l61.128" class="difflineminus">-  }</span>
<a href="#l61.129"></a><span id="l61.129" class="difflineminus">-  else {</span>
<a href="#l61.130"></a><span id="l61.130" class="difflineplus">+  } else {</span>
<a href="#l61.131"></a><span id="l61.131">     nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l61.132"></a><span id="l61.132">     nsresult rv;</span>
<a href="#l61.133"></a><span id="l61.133"> </span>
<a href="#l61.134"></a><span id="l61.134">     nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.135"></a><span id="l61.135">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.136"></a><span id="l61.136"> </span>
<a href="#l61.137"></a><span id="l61.137">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.138"></a><span id="l61.138" class="difflineminus">-    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l61.140"></a><span id="l61.140">                                  getter_AddRefs(directory));</span>
<a href="#l61.141"></a><span id="l61.141">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.142"></a><span id="l61.142"> </span>
<a href="#l61.143"></a><span id="l61.143" class="difflineminus">-    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l61.144"></a><span id="l61.144" class="difflineminus">-      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.145"></a><span id="l61.145" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory = do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.146"></a><span id="l61.146">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.147"></a><span id="l61.147"> </span>
<a href="#l61.148"></a><span id="l61.148">     rv = GetCard(card, getter_AddRefs(abCard), osxDirectory);</span>
<a href="#l61.149"></a><span id="l61.149">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.150"></a><span id="l61.150"> </span>
<a href="#l61.151"></a><span id="l61.151">     nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_QueryInterface(abCard);</span>
<a href="#l61.152"></a><span id="l61.152">     osxCard-&gt;Update(true);</span>
<a href="#l61.153"></a><span id="l61.153">   }</span>
<a href="#l61.154"></a><span id="l61.154">   return NS_OK;</span>
<a href="#l61.155"></a><span id="l61.155"> </span>
<a href="#l61.156"></a><span id="l61.156">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.157"></a><span id="l61.157"> }</span>
<a href="#l61.158"></a><span id="l61.158"> </span>
<a href="#l61.159"></a><span id="l61.159"> @interface ABChangedMonitor : NSObject</span>
<a href="#l61.160"></a><span id="l61.160" class="difflineminus">--(void)ABChanged:(NSNotification *)aNotification;</span>
<a href="#l61.161"></a><span id="l61.161" class="difflineplus">+- (void)ABChanged:(NSNotification *)aNotification;</span>
<a href="#l61.162"></a><span id="l61.162"> @end</span>
<a href="#l61.163"></a><span id="l61.163"> </span>
<a href="#l61.164"></a><span id="l61.164"> @implementation ABChangedMonitor</span>
<a href="#l61.165"></a><span id="l61.165" class="difflineminus">--(void)ABChanged:(NSNotification *)aNotification</span>
<a href="#l61.166"></a><span id="l61.166" class="difflineminus">-{</span>
<a href="#l61.167"></a><span id="l61.167" class="difflineplus">+- (void)ABChanged:(NSNotification *)aNotification {</span>
<a href="#l61.168"></a><span id="l61.168">   NSDictionary *changes = [aNotification userInfo];</span>
<a href="#l61.169"></a><span id="l61.169"> </span>
<a href="#l61.170"></a><span id="l61.170">   nsresult rv;</span>
<a href="#l61.171"></a><span id="l61.171">   NSArray *inserted = [changes objectForKey:kABInsertedRecords];</span>
<a href="#l61.172"></a><span id="l61.172"> </span>
<a href="#l61.173"></a><span id="l61.173">   if (inserted) {</span>
<a href="#l61.174"></a><span id="l61.174">     nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.175"></a><span id="l61.175">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.176"></a><span id="l61.176"> </span>
<a href="#l61.177"></a><span id="l61.177">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.178"></a><span id="l61.178" class="difflineminus">-    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l61.179"></a><span id="l61.179" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l61.180"></a><span id="l61.180">                                  getter_AddRefs(directory));</span>
<a href="#l61.181"></a><span id="l61.181">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.182"></a><span id="l61.182"> </span>
<a href="#l61.183"></a><span id="l61.183" class="difflineminus">-    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineminus">-      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.185"></a><span id="l61.185" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory = do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.186"></a><span id="l61.186">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.187"></a><span id="l61.187"> </span>
<a href="#l61.188"></a><span id="l61.188">     unsigned int i, count = [inserted count];</span>
<a href="#l61.189"></a><span id="l61.189">     for (i = 0; i &lt; count; ++i) {</span>
<a href="#l61.190"></a><span id="l61.190" class="difflineminus">-      ABAddressBook *addressBook =</span>
<a href="#l61.191"></a><span id="l61.191" class="difflineminus">-      [ABAddressBook sharedAddressBook];</span>
<a href="#l61.192"></a><span id="l61.192" class="difflineminus">-      ABRecord *card =</span>
<a href="#l61.193"></a><span id="l61.193" class="difflineminus">-        [addressBook recordForUniqueId:[inserted objectAtIndex:i]];</span>
<a href="#l61.194"></a><span id="l61.194" class="difflineplus">+      ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l61.195"></a><span id="l61.195" class="difflineplus">+      ABRecord *card = [addressBook recordForUniqueId:[inserted objectAtIndex:i]];</span>
<a href="#l61.196"></a><span id="l61.196">       if ([card isKindOfClass:[ABGroup class]]) {</span>
<a href="#l61.197"></a><span id="l61.197">         nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.198"></a><span id="l61.198" class="difflineminus">-        GetOrCreateGroup([inserted objectAtIndex:i],</span>
<a href="#l61.199"></a><span id="l61.199" class="difflineminus">-                         getter_AddRefs(directory));</span>
<a href="#l61.200"></a><span id="l61.200" class="difflineplus">+        GetOrCreateGroup([inserted objectAtIndex:i], getter_AddRefs(directory));</span>
<a href="#l61.201"></a><span id="l61.201"> </span>
<a href="#l61.202"></a><span id="l61.202">         rv = osxDirectory-&gt;AssertDirectory(abManager, directory);</span>
<a href="#l61.203"></a><span id="l61.203">         NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.204"></a><span id="l61.204" class="difflineminus">-      }</span>
<a href="#l61.205"></a><span id="l61.205" class="difflineminus">-      else {</span>
<a href="#l61.206"></a><span id="l61.206" class="difflineplus">+      } else {</span>
<a href="#l61.207"></a><span id="l61.207">         nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l61.208"></a><span id="l61.208">         // Construct a card</span>
<a href="#l61.209"></a><span id="l61.209">         nsresult rv = CreateCard(card, getter_AddRefs(abCard));</span>
<a href="#l61.210"></a><span id="l61.210">         NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.211"></a><span id="l61.211">         rv = osxDirectory-&gt;AssertCard(abManager, abCard);</span>
<a href="#l61.212"></a><span id="l61.212">         NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.213"></a><span id="l61.213">       }</span>
<a href="#l61.214"></a><span id="l61.214">     }</span>
<a href="#l61.215"></a><span id="l61.215" class="difflineat">@@ -202,27 +182,25 @@ Sync(NSString *aUid)</span>
<a href="#l61.216"></a><span id="l61.216">     for (i = 0; i &lt; count; ++i) {</span>
<a href="#l61.217"></a><span id="l61.217">       NSString *uid = [updated objectAtIndex:i];</span>
<a href="#l61.218"></a><span id="l61.218">       Sync(uid);</span>
<a href="#l61.219"></a><span id="l61.219">     }</span>
<a href="#l61.220"></a><span id="l61.220">   }</span>
<a href="#l61.221"></a><span id="l61.221"> </span>
<a href="#l61.222"></a><span id="l61.222">   NSArray *deleted = [changes objectForKey:kABDeletedRecords];</span>
<a href="#l61.223"></a><span id="l61.223">   if (deleted) {</span>
<a href="#l61.224"></a><span id="l61.224" class="difflineminus">-</span>
<a href="#l61.225"></a><span id="l61.225">     nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.226"></a><span id="l61.226">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.227"></a><span id="l61.227"> </span>
<a href="#l61.228"></a><span id="l61.228">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.229"></a><span id="l61.229" class="difflineminus">-    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l61.230"></a><span id="l61.230" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l61.231"></a><span id="l61.231">                                  getter_AddRefs(directory));</span>
<a href="#l61.232"></a><span id="l61.232">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.233"></a><span id="l61.233"> </span>
<a href="#l61.234"></a><span id="l61.234" class="difflineminus">-    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l61.235"></a><span id="l61.235" class="difflineminus">-      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.236"></a><span id="l61.236" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory = do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.237"></a><span id="l61.237">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l61.238"></a><span id="l61.238"> </span>
<a href="#l61.239"></a><span id="l61.239">     unsigned int i, count = [deleted count];</span>
<a href="#l61.240"></a><span id="l61.240">     for (i = 0; i &lt; count; ++i) {</span>
<a href="#l61.241"></a><span id="l61.241">       NSString *deletedUid = [deleted objectAtIndex:i];</span>
<a href="#l61.242"></a><span id="l61.242"> </span>
<a href="#l61.243"></a><span id="l61.243">       nsAutoCString uid;</span>
<a href="#l61.244"></a><span id="l61.244">       AppendToCString(deletedUid, uid);</span>
<a href="#l61.245"></a><span id="l61.245" class="difflineat">@@ -234,145 +212,141 @@ Sync(NSString *aUid)</span>
<a href="#l61.246"></a><span id="l61.246"> </span>
<a href="#l61.247"></a><span id="l61.247">   if (!inserted &amp;&amp; !updated &amp;&amp; !deleted) {</span>
<a href="#l61.248"></a><span id="l61.248">     // XXX This is supposed to mean &quot;everything was updated&quot;, but we get</span>
<a href="#l61.249"></a><span id="l61.249">     //     this whenever something has changed, so not sure what to do.</span>
<a href="#l61.250"></a><span id="l61.250">   }</span>
<a href="#l61.251"></a><span id="l61.251"> }</span>
<a href="#l61.252"></a><span id="l61.252"> @end</span>
<a href="#l61.253"></a><span id="l61.253"> </span>
<a href="#l61.254"></a><span id="l61.254" class="difflineminus">-static nsresult</span>
<a href="#l61.255"></a><span id="l61.255" class="difflineminus">-MapConditionString(nsIAbBooleanConditionString *aCondition, bool aNegate,</span>
<a href="#l61.256"></a><span id="l61.256" class="difflineminus">-                   bool &amp;aCanHandle, ABSearchElement **aResult)</span>
<a href="#l61.257"></a><span id="l61.257" class="difflineminus">-{</span>
<a href="#l61.258"></a><span id="l61.258" class="difflineplus">+static nsresult MapConditionString(nsIAbBooleanConditionString *aCondition, bool aNegate,</span>
<a href="#l61.259"></a><span id="l61.259" class="difflineplus">+                                   bool &amp;aCanHandle, ABSearchElement **aResult) {</span>
<a href="#l61.260"></a><span id="l61.260">   aCanHandle = false;</span>
<a href="#l61.261"></a><span id="l61.261"> </span>
<a href="#l61.262"></a><span id="l61.262">   nsAbBooleanConditionType conditionType = 0;</span>
<a href="#l61.263"></a><span id="l61.263">   nsresult rv = aCondition-&gt;GetCondition(&amp;conditionType);</span>
<a href="#l61.264"></a><span id="l61.264">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.265"></a><span id="l61.265"> </span>
<a href="#l61.266"></a><span id="l61.266">   ABSearchComparison comparison;</span>
<a href="#l61.267"></a><span id="l61.267">   switch (conditionType) {</span>
<a href="#l61.268"></a><span id="l61.268" class="difflineminus">-    case nsIAbBooleanConditionTypes::Contains:</span>
<a href="#l61.269"></a><span id="l61.269" class="difflineminus">-    {</span>
<a href="#l61.270"></a><span id="l61.270" class="difflineplus">+    case nsIAbBooleanConditionTypes::Contains: {</span>
<a href="#l61.271"></a><span id="l61.271">       if (!aNegate) {</span>
<a href="#l61.272"></a><span id="l61.272">         comparison = kABContainsSubString;</span>
<a href="#l61.273"></a><span id="l61.273">         aCanHandle = true;</span>
<a href="#l61.274"></a><span id="l61.274">       }</span>
<a href="#l61.275"></a><span id="l61.275">       break;</span>
<a href="#l61.276"></a><span id="l61.276">     }</span>
<a href="#l61.277"></a><span id="l61.277" class="difflineminus">-    case nsIAbBooleanConditionTypes::DoesNotContain:</span>
<a href="#l61.278"></a><span id="l61.278" class="difflineminus">-    {</span>
<a href="#l61.279"></a><span id="l61.279" class="difflineplus">+    case nsIAbBooleanConditionTypes::DoesNotContain: {</span>
<a href="#l61.280"></a><span id="l61.280">       if (aNegate) {</span>
<a href="#l61.281"></a><span id="l61.281">         comparison = kABContainsSubString;</span>
<a href="#l61.282"></a><span id="l61.282">         aCanHandle = true;</span>
<a href="#l61.283"></a><span id="l61.283">       }</span>
<a href="#l61.284"></a><span id="l61.284">       break;</span>
<a href="#l61.285"></a><span id="l61.285">     }</span>
<a href="#l61.286"></a><span id="l61.286" class="difflineminus">-    case nsIAbBooleanConditionTypes::Is:</span>
<a href="#l61.287"></a><span id="l61.287" class="difflineminus">-    {</span>
<a href="#l61.288"></a><span id="l61.288" class="difflineplus">+    case nsIAbBooleanConditionTypes::Is: {</span>
<a href="#l61.289"></a><span id="l61.289">       comparison = aNegate ? kABNotEqual : kABEqual;</span>
<a href="#l61.290"></a><span id="l61.290">       aCanHandle = true;</span>
<a href="#l61.291"></a><span id="l61.291">       break;</span>
<a href="#l61.292"></a><span id="l61.292">     }</span>
<a href="#l61.293"></a><span id="l61.293" class="difflineminus">-    case nsIAbBooleanConditionTypes::IsNot:</span>
<a href="#l61.294"></a><span id="l61.294" class="difflineminus">-    {</span>
<a href="#l61.295"></a><span id="l61.295" class="difflineplus">+    case nsIAbBooleanConditionTypes::IsNot: {</span>
<a href="#l61.296"></a><span id="l61.296">       comparison = aNegate ? kABEqual : kABNotEqual;</span>
<a href="#l61.297"></a><span id="l61.297">       aCanHandle = true;</span>
<a href="#l61.298"></a><span id="l61.298">       break;</span>
<a href="#l61.299"></a><span id="l61.299">     }</span>
<a href="#l61.300"></a><span id="l61.300" class="difflineminus">-    case nsIAbBooleanConditionTypes::BeginsWith:</span>
<a href="#l61.301"></a><span id="l61.301" class="difflineminus">-    {</span>
<a href="#l61.302"></a><span id="l61.302" class="difflineplus">+    case nsIAbBooleanConditionTypes::BeginsWith: {</span>
<a href="#l61.303"></a><span id="l61.303">       if (!aNegate) {</span>
<a href="#l61.304"></a><span id="l61.304">         comparison = kABPrefixMatch;</span>
<a href="#l61.305"></a><span id="l61.305">         aCanHandle = true;</span>
<a href="#l61.306"></a><span id="l61.306">       }</span>
<a href="#l61.307"></a><span id="l61.307">       break;</span>
<a href="#l61.308"></a><span id="l61.308">     }</span>
<a href="#l61.309"></a><span id="l61.309" class="difflineminus">-    case nsIAbBooleanConditionTypes::EndsWith:</span>
<a href="#l61.310"></a><span id="l61.310" class="difflineminus">-    {</span>
<a href="#l61.311"></a><span id="l61.311" class="difflineminus">-      //comparison = kABSuffixMatch;</span>
<a href="#l61.312"></a><span id="l61.312" class="difflineplus">+    case nsIAbBooleanConditionTypes::EndsWith: {</span>
<a href="#l61.313"></a><span id="l61.313" class="difflineplus">+      // comparison = kABSuffixMatch;</span>
<a href="#l61.314"></a><span id="l61.314">       break;</span>
<a href="#l61.315"></a><span id="l61.315">     }</span>
<a href="#l61.316"></a><span id="l61.316" class="difflineminus">-    case nsIAbBooleanConditionTypes::LessThan:</span>
<a href="#l61.317"></a><span id="l61.317" class="difflineminus">-    {</span>
<a href="#l61.318"></a><span id="l61.318" class="difflineplus">+    case nsIAbBooleanConditionTypes::LessThan: {</span>
<a href="#l61.319"></a><span id="l61.319">       comparison = aNegate ? kABGreaterThanOrEqual : kABLessThan;</span>
<a href="#l61.320"></a><span id="l61.320">       aCanHandle = true;</span>
<a href="#l61.321"></a><span id="l61.321">       break;</span>
<a href="#l61.322"></a><span id="l61.322">     }</span>
<a href="#l61.323"></a><span id="l61.323" class="difflineminus">-    case nsIAbBooleanConditionTypes::GreaterThan:</span>
<a href="#l61.324"></a><span id="l61.324" class="difflineminus">-    {</span>
<a href="#l61.325"></a><span id="l61.325" class="difflineplus">+    case nsIAbBooleanConditionTypes::GreaterThan: {</span>
<a href="#l61.326"></a><span id="l61.326">       comparison = aNegate ? kABLessThanOrEqual : kABGreaterThan;</span>
<a href="#l61.327"></a><span id="l61.327">       aCanHandle = true;</span>
<a href="#l61.328"></a><span id="l61.328">       break;</span>
<a href="#l61.329"></a><span id="l61.329">     }</span>
<a href="#l61.330"></a><span id="l61.330">   }</span>
<a href="#l61.331"></a><span id="l61.331"> </span>
<a href="#l61.332"></a><span id="l61.332" class="difflineminus">-  if (!aCanHandle)</span>
<a href="#l61.333"></a><span id="l61.333" class="difflineminus">-    return NS_OK;</span>
<a href="#l61.334"></a><span id="l61.334" class="difflineplus">+  if (!aCanHandle) return NS_OK;</span>
<a href="#l61.335"></a><span id="l61.335"> </span>
<a href="#l61.336"></a><span id="l61.336">   nsCString name;</span>
<a href="#l61.337"></a><span id="l61.337">   rv = aCondition-&gt;GetName(getter_Copies(name));</span>
<a href="#l61.338"></a><span id="l61.338">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.339"></a><span id="l61.339"> </span>
<a href="#l61.340"></a><span id="l61.340">   nsString value;</span>
<a href="#l61.341"></a><span id="l61.341">   rv = aCondition-&gt;GetValue(getter_Copies(value));</span>
<a href="#l61.342"></a><span id="l61.342">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.343"></a><span id="l61.343"> </span>
<a href="#l61.344"></a><span id="l61.344">   uint32_t length = value.Length();</span>
<a href="#l61.345"></a><span id="l61.345"> </span>
<a href="#l61.346"></a><span id="l61.346">   uint32_t i;</span>
<a href="#l61.347"></a><span id="l61.347">   for (i = 0; i &lt; nsAbOSXUtils::kPropertyMapSize; ++i) {</span>
<a href="#l61.348"></a><span id="l61.348">     if (name.Equals(nsAbOSXUtils::kPropertyMap[i].mPropertyName)) {</span>
<a href="#l61.349"></a><span id="l61.349" class="difflineminus">-      *aResult =</span>
<a href="#l61.350"></a><span id="l61.350" class="difflineminus">-      [ABPerson searchElementForProperty:nsAbOSXUtils::kPropertyMap[i].mOSXProperty</span>
<a href="#l61.351"></a><span id="l61.351" class="difflineminus">-                                   label:nsAbOSXUtils::kPropertyMap[i].mOSXLabel</span>
<a href="#l61.352"></a><span id="l61.352" class="difflineminus">-                                     key:nsAbOSXUtils::kPropertyMap[i].mOSXKey</span>
<a href="#l61.353"></a><span id="l61.353" class="difflineminus">-                                   value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar*&gt;(value.get()) length:length]</span>
<a href="#l61.354"></a><span id="l61.354" class="difflineminus">-                              comparison:comparison];</span>
<a href="#l61.355"></a><span id="l61.355" class="difflineplus">+      *aResult = [ABPerson</span>
<a href="#l61.356"></a><span id="l61.356" class="difflineplus">+          searchElementForProperty:nsAbOSXUtils::kPropertyMap[i].mOSXProperty</span>
<a href="#l61.357"></a><span id="l61.357" class="difflineplus">+                             label:nsAbOSXUtils::kPropertyMap[i].mOSXLabel</span>
<a href="#l61.358"></a><span id="l61.358" class="difflineplus">+                               key:nsAbOSXUtils::kPropertyMap[i].mOSXKey</span>
<a href="#l61.359"></a><span id="l61.359" class="difflineplus">+                             value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l61.360"></a><span id="l61.360" class="difflineplus">+                                                                      value.get())</span>
<a href="#l61.361"></a><span id="l61.361" class="difflineplus">+                                                           length:length]</span>
<a href="#l61.362"></a><span id="l61.362" class="difflineplus">+                        comparison:comparison];</span>
<a href="#l61.363"></a><span id="l61.363"> </span>
<a href="#l61.364"></a><span id="l61.364">       return NS_OK;</span>
<a href="#l61.365"></a><span id="l61.365">     }</span>
<a href="#l61.366"></a><span id="l61.366">   }</span>
<a href="#l61.367"></a><span id="l61.367"> </span>
<a href="#l61.368"></a><span id="l61.368">   if (name.EqualsLiteral(&quot;DisplayName&quot;) &amp;&amp; comparison == kABContainsSubString) {</span>
<a href="#l61.369"></a><span id="l61.369" class="difflineminus">-    ABSearchElement *first =</span>
<a href="#l61.370"></a><span id="l61.370" class="difflineminus">-    [ABPerson searchElementForProperty:kABFirstNameProperty</span>
<a href="#l61.371"></a><span id="l61.371" class="difflineminus">-                                 label:nil</span>
<a href="#l61.372"></a><span id="l61.372" class="difflineminus">-                                   key:nil</span>
<a href="#l61.373"></a><span id="l61.373" class="difflineminus">-                                 value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar*&gt;(value.get()) length:length]</span>
<a href="#l61.374"></a><span id="l61.374" class="difflineminus">-                            comparison:comparison];</span>
<a href="#l61.375"></a><span id="l61.375" class="difflineminus">-    ABSearchElement *second =</span>
<a href="#l61.376"></a><span id="l61.376" class="difflineminus">-      [ABPerson searchElementForProperty:kABLastNameProperty</span>
<a href="#l61.377"></a><span id="l61.377" class="difflineminus">-                                   label:nil</span>
<a href="#l61.378"></a><span id="l61.378" class="difflineminus">-                                     key:nil</span>
<a href="#l61.379"></a><span id="l61.379" class="difflineminus">-                                   value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar*&gt;(value.get()) length:length]</span>
<a href="#l61.380"></a><span id="l61.380" class="difflineminus">-                              comparison:comparison];</span>
<a href="#l61.381"></a><span id="l61.381" class="difflineminus">-    ABSearchElement *third =</span>
<a href="#l61.382"></a><span id="l61.382" class="difflineminus">-      [ABGroup searchElementForProperty:kABGroupNameProperty</span>
<a href="#l61.383"></a><span id="l61.383" class="difflineminus">-                                  label:nil</span>
<a href="#l61.384"></a><span id="l61.384" class="difflineminus">-                                    key:nil</span>
<a href="#l61.385"></a><span id="l61.385" class="difflineminus">-                                  value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar*&gt;(value.get()) length:length]</span>
<a href="#l61.386"></a><span id="l61.386" class="difflineminus">-                             comparison:comparison];</span>
<a href="#l61.387"></a><span id="l61.387" class="difflineplus">+    ABSearchElement *first = [ABPerson</span>
<a href="#l61.388"></a><span id="l61.388" class="difflineplus">+        searchElementForProperty:kABFirstNameProperty</span>
<a href="#l61.389"></a><span id="l61.389" class="difflineplus">+                           label:nil</span>
<a href="#l61.390"></a><span id="l61.390" class="difflineplus">+                             key:nil</span>
<a href="#l61.391"></a><span id="l61.391" class="difflineplus">+                           value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l61.392"></a><span id="l61.392" class="difflineplus">+                                                                    value.get())</span>
<a href="#l61.393"></a><span id="l61.393" class="difflineplus">+                                                         length:length]</span>
<a href="#l61.394"></a><span id="l61.394" class="difflineplus">+                      comparison:comparison];</span>
<a href="#l61.395"></a><span id="l61.395" class="difflineplus">+    ABSearchElement *second = [ABPerson</span>
<a href="#l61.396"></a><span id="l61.396" class="difflineplus">+        searchElementForProperty:kABLastNameProperty</span>
<a href="#l61.397"></a><span id="l61.397" class="difflineplus">+                           label:nil</span>
<a href="#l61.398"></a><span id="l61.398" class="difflineplus">+                             key:nil</span>
<a href="#l61.399"></a><span id="l61.399" class="difflineplus">+                           value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l61.400"></a><span id="l61.400" class="difflineplus">+                                                                    value.get())</span>
<a href="#l61.401"></a><span id="l61.401" class="difflineplus">+                                                         length:length]</span>
<a href="#l61.402"></a><span id="l61.402" class="difflineplus">+                      comparison:comparison];</span>
<a href="#l61.403"></a><span id="l61.403" class="difflineplus">+    ABSearchElement *third = [ABGroup</span>
<a href="#l61.404"></a><span id="l61.404" class="difflineplus">+        searchElementForProperty:kABGroupNameProperty</span>
<a href="#l61.405"></a><span id="l61.405" class="difflineplus">+                           label:nil</span>
<a href="#l61.406"></a><span id="l61.406" class="difflineplus">+                             key:nil</span>
<a href="#l61.407"></a><span id="l61.407" class="difflineplus">+                           value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l61.408"></a><span id="l61.408" class="difflineplus">+                                                                    value.get())</span>
<a href="#l61.409"></a><span id="l61.409" class="difflineplus">+                                                         length:length]</span>
<a href="#l61.410"></a><span id="l61.410" class="difflineplus">+                      comparison:comparison];</span>
<a href="#l61.411"></a><span id="l61.411"> </span>
<a href="#l61.412"></a><span id="l61.412" class="difflineminus">-    *aResult = [ABSearchElement searchElementForConjunction:kABSearchOr children:[NSArray arrayWithObjects:first, second, third, nil]];</span>
<a href="#l61.413"></a><span id="l61.413" class="difflineplus">+    *aResult = [ABSearchElement</span>
<a href="#l61.414"></a><span id="l61.414" class="difflineplus">+        searchElementForConjunction:kABSearchOr</span>
<a href="#l61.415"></a><span id="l61.415" class="difflineplus">+                           children:[NSArray arrayWithObjects:first, second, third, nil]];</span>
<a href="#l61.416"></a><span id="l61.416"> </span>
<a href="#l61.417"></a><span id="l61.417">     return NS_OK;</span>
<a href="#l61.418"></a><span id="l61.418">   }</span>
<a href="#l61.419"></a><span id="l61.419"> </span>
<a href="#l61.420"></a><span id="l61.420">   aCanHandle = false;</span>
<a href="#l61.421"></a><span id="l61.421"> </span>
<a href="#l61.422"></a><span id="l61.422">   return NS_OK;</span>
<a href="#l61.423"></a><span id="l61.423"> }</span>
<a href="#l61.424"></a><span id="l61.424"> </span>
<a href="#l61.425"></a><span id="l61.425" class="difflineminus">-static nsresult</span>
<a href="#l61.426"></a><span id="l61.426" class="difflineminus">-BuildSearchElements(nsIAbBooleanExpression *aExpression,</span>
<a href="#l61.427"></a><span id="l61.427" class="difflineminus">-                    bool &amp;aCanHandle,</span>
<a href="#l61.428"></a><span id="l61.428" class="difflineminus">-                    ABSearchElement **aResult)</span>
<a href="#l61.429"></a><span id="l61.429" class="difflineminus">-{</span>
<a href="#l61.430"></a><span id="l61.430" class="difflineplus">+static nsresult BuildSearchElements(nsIAbBooleanExpression *aExpression, bool &amp;aCanHandle,</span>
<a href="#l61.431"></a><span id="l61.431" class="difflineplus">+                                    ABSearchElement **aResult) {</span>
<a href="#l61.432"></a><span id="l61.432">   aCanHandle = true;</span>
<a href="#l61.433"></a><span id="l61.433"> </span>
<a href="#l61.434"></a><span id="l61.434">   nsCOMPtr&lt;nsIArray&gt; expressions;</span>
<a href="#l61.435"></a><span id="l61.435">   nsresult rv = aExpression-&gt;GetExpressions(getter_AddRefs(expressions));</span>
<a href="#l61.436"></a><span id="l61.436">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.437"></a><span id="l61.437"> </span>
<a href="#l61.438"></a><span id="l61.438">   nsAbBooleanOperationType operation;</span>
<a href="#l61.439"></a><span id="l61.439">   rv = aExpression-&gt;GetOperation(&amp;operation);</span>
<a href="#l61.440"></a><span id="l61.440" class="difflineat">@@ -381,37 +355,34 @@ BuildSearchElements(nsIAbBooleanExpressi</span>
<a href="#l61.441"></a><span id="l61.441">   uint32_t count;</span>
<a href="#l61.442"></a><span id="l61.442">   rv = expressions-&gt;GetLength(&amp;count);</span>
<a href="#l61.443"></a><span id="l61.443">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.444"></a><span id="l61.444"> </span>
<a href="#l61.445"></a><span id="l61.445">   NS_ASSERTION(count &gt; 1 &amp;&amp; operation != nsIAbBooleanOperationTypes::NOT,</span>
<a href="#l61.446"></a><span id="l61.446">                &quot;This doesn't make sense!&quot;);</span>
<a href="#l61.447"></a><span id="l61.447"> </span>
<a href="#l61.448"></a><span id="l61.448">   NSMutableArray *array = nullptr;</span>
<a href="#l61.449"></a><span id="l61.449" class="difflineminus">-  if (count &gt; 1)</span>
<a href="#l61.450"></a><span id="l61.450" class="difflineminus">-    array = [[NSMutableArray alloc] init];</span>
<a href="#l61.451"></a><span id="l61.451" class="difflineplus">+  if (count &gt; 1) array = [[NSMutableArray alloc] init];</span>
<a href="#l61.452"></a><span id="l61.452"> </span>
<a href="#l61.453"></a><span id="l61.453">   uint32_t i;</span>
<a href="#l61.454"></a><span id="l61.454">   nsCOMPtr&lt;nsIAbBooleanConditionString&gt; condition;</span>
<a href="#l61.455"></a><span id="l61.455">   nsCOMPtr&lt;nsIAbBooleanExpression&gt; subExpression;</span>
<a href="#l61.456"></a><span id="l61.456">   for (i = 0; i &lt; count; ++i) {</span>
<a href="#l61.457"></a><span id="l61.457">     ABSearchElement *element = nullptr;</span>
<a href="#l61.458"></a><span id="l61.458"> </span>
<a href="#l61.459"></a><span id="l61.459">     condition = do_QueryElementAt(expressions, i);</span>
<a href="#l61.460"></a><span id="l61.460">     if (condition) {</span>
<a href="#l61.461"></a><span id="l61.461" class="difflineminus">-      rv = MapConditionString(condition, operation == nsIAbBooleanOperationTypes::NOT, aCanHandle, &amp;element);</span>
<a href="#l61.462"></a><span id="l61.462" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l61.463"></a><span id="l61.463" class="difflineminus">-        break;</span>
<a href="#l61.464"></a><span id="l61.464" class="difflineminus">-    }</span>
<a href="#l61.465"></a><span id="l61.465" class="difflineminus">-    else {</span>
<a href="#l61.466"></a><span id="l61.466" class="difflineplus">+      rv = MapConditionString(condition, operation == nsIAbBooleanOperationTypes::NOT, aCanHandle,</span>
<a href="#l61.467"></a><span id="l61.467" class="difflineplus">+                              &amp;element);</span>
<a href="#l61.468"></a><span id="l61.468" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l61.469"></a><span id="l61.469" class="difflineplus">+    } else {</span>
<a href="#l61.470"></a><span id="l61.470">       subExpression = do_QueryElementAt(expressions, i);</span>
<a href="#l61.471"></a><span id="l61.471">       if (subExpression) {</span>
<a href="#l61.472"></a><span id="l61.472">         rv = BuildSearchElements(subExpression, aCanHandle, &amp;element);</span>
<a href="#l61.473"></a><span id="l61.473" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l61.474"></a><span id="l61.474" class="difflineminus">-          break;</span>
<a href="#l61.475"></a><span id="l61.475" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l61.476"></a><span id="l61.476">       }</span>
<a href="#l61.477"></a><span id="l61.477">     }</span>
<a href="#l61.478"></a><span id="l61.478"> </span>
<a href="#l61.479"></a><span id="l61.479">     if (!aCanHandle) {</span>
<a href="#l61.480"></a><span id="l61.480">       // remember to free the array when returning early</span>
<a href="#l61.481"></a><span id="l61.481">       [array release];</span>
<a href="#l61.482"></a><span id="l61.482">       return NS_OK;</span>
<a href="#l61.483"></a><span id="l61.483">     }</span>
<a href="#l61.484"></a><span id="l61.484" class="difflineat">@@ -421,187 +392,167 @@ BuildSearchElements(nsIAbBooleanExpressi</span>
<a href="#l61.485"></a><span id="l61.485">         [array addObject:element];</span>
<a href="#l61.486"></a><span id="l61.486">       else</span>
<a href="#l61.487"></a><span id="l61.487">         *aResult = element;</span>
<a href="#l61.488"></a><span id="l61.488">     }</span>
<a href="#l61.489"></a><span id="l61.489">   }</span>
<a href="#l61.490"></a><span id="l61.490"> </span>
<a href="#l61.491"></a><span id="l61.491">   if (array) {</span>
<a href="#l61.492"></a><span id="l61.492">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.493"></a><span id="l61.493" class="difflineminus">-      ABSearchConjunction conjunction = operation == nsIAbBooleanOperationTypes::AND ? kABSearchAnd : kABSearchOr;</span>
<a href="#l61.494"></a><span id="l61.494" class="difflineplus">+      ABSearchConjunction conjunction =</span>
<a href="#l61.495"></a><span id="l61.495" class="difflineplus">+          operation == nsIAbBooleanOperationTypes::AND ? kABSearchAnd : kABSearchOr;</span>
<a href="#l61.496"></a><span id="l61.496">       *aResult = [ABSearchElement searchElementForConjunction:conjunction children:array];</span>
<a href="#l61.497"></a><span id="l61.497">     }</span>
<a href="#l61.498"></a><span id="l61.498">     [array release];</span>
<a href="#l61.499"></a><span id="l61.499">   }</span>
<a href="#l61.500"></a><span id="l61.500"> </span>
<a href="#l61.501"></a><span id="l61.501">   return rv;</span>
<a href="#l61.502"></a><span id="l61.502"> }</span>
<a href="#l61.503"></a><span id="l61.503"> </span>
<a href="#l61.504"></a><span id="l61.504" class="difflineminus">-static bool</span>
<a href="#l61.505"></a><span id="l61.505" class="difflineminus">-Search(nsIAbBooleanExpression *aExpression, NSArray **aResult)</span>
<a href="#l61.506"></a><span id="l61.506" class="difflineminus">-{</span>
<a href="#l61.507"></a><span id="l61.507" class="difflineplus">+static bool Search(nsIAbBooleanExpression *aExpression, NSArray **aResult) {</span>
<a href="#l61.508"></a><span id="l61.508">   bool canHandle = false;</span>
<a href="#l61.509"></a><span id="l61.509">   ABSearchElement *searchElement;</span>
<a href="#l61.510"></a><span id="l61.510">   nsresult rv = BuildSearchElements(aExpression, canHandle, &amp;searchElement);</span>
<a href="#l61.511"></a><span id="l61.511">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l61.512"></a><span id="l61.512"> </span>
<a href="#l61.513"></a><span id="l61.513">   if (canHandle)</span>
<a href="#l61.514"></a><span id="l61.514">     *aResult = [[ABAddressBook sharedAddressBook] recordsMatchingSearchElement:searchElement];</span>
<a href="#l61.515"></a><span id="l61.515"> </span>
<a href="#l61.516"></a><span id="l61.516">   return canHandle;</span>
<a href="#l61.517"></a><span id="l61.517"> }</span>
<a href="#l61.518"></a><span id="l61.518"> </span>
<a href="#l61.519"></a><span id="l61.519"> static uint32_t sObserverCount = 0;</span>
<a href="#l61.520"></a><span id="l61.520"> static ABChangedMonitor *sObserver = nullptr;</span>
<a href="#l61.521"></a><span id="l61.521"> </span>
<a href="#l61.522"></a><span id="l61.522" class="difflineminus">-nsAbOSXDirectory::nsAbOSXDirectory()</span>
<a href="#l61.523"></a><span id="l61.523" class="difflineminus">-{</span>
<a href="#l61.524"></a><span id="l61.524" class="difflineminus">-}</span>
<a href="#l61.525"></a><span id="l61.525" class="difflineplus">+nsAbOSXDirectory::nsAbOSXDirectory() {}</span>
<a href="#l61.526"></a><span id="l61.526"> </span>
<a href="#l61.527"></a><span id="l61.527" class="difflineminus">-nsAbOSXDirectory::~nsAbOSXDirectory()</span>
<a href="#l61.528"></a><span id="l61.528" class="difflineminus">-{</span>
<a href="#l61.529"></a><span id="l61.529" class="difflineplus">+nsAbOSXDirectory::~nsAbOSXDirectory() {</span>
<a href="#l61.530"></a><span id="l61.530">   if (--sObserverCount == 0) {</span>
<a href="#l61.531"></a><span id="l61.531">     [[NSNotificationCenter defaultCenter] removeObserver:sObserver];</span>
<a href="#l61.532"></a><span id="l61.532">     [sObserver release];</span>
<a href="#l61.533"></a><span id="l61.533">   }</span>
<a href="#l61.534"></a><span id="l61.534"> }</span>
<a href="#l61.535"></a><span id="l61.535"> </span>
<a href="#l61.536"></a><span id="l61.536" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbOSXDirectory,</span>
<a href="#l61.537"></a><span id="l61.537" class="difflineminus">-                             nsAbDirProperty,</span>
<a href="#l61.538"></a><span id="l61.538" class="difflineminus">-                             nsIAbOSXDirectory,</span>
<a href="#l61.539"></a><span id="l61.539" class="difflineminus">-                             nsIAbDirSearchListener)</span>
<a href="#l61.540"></a><span id="l61.540" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsAbOSXDirectory, nsAbDirProperty, nsIAbOSXDirectory,</span>
<a href="#l61.541"></a><span id="l61.541" class="difflineplus">+                            nsIAbDirSearchListener)</span>
<a href="#l61.542"></a><span id="l61.542"> </span>
<a href="#l61.543"></a><span id="l61.543"> NS_IMETHODIMP</span>
<a href="#l61.544"></a><span id="l61.544" class="difflineminus">-nsAbOSXDirectory::Init(const char *aUri)</span>
<a href="#l61.545"></a><span id="l61.545" class="difflineminus">-{</span>
<a href="#l61.546"></a><span id="l61.546" class="difflineplus">+nsAbOSXDirectory::Init(const char *aUri) {</span>
<a href="#l61.547"></a><span id="l61.547">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.548"></a><span id="l61.548"> </span>
<a href="#l61.549"></a><span id="l61.549">   nsresult rv;</span>
<a href="#l61.550"></a><span id="l61.550">   rv = nsAbDirProperty::Init(aUri);</span>
<a href="#l61.551"></a><span id="l61.551">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.552"></a><span id="l61.552"> </span>
<a href="#l61.553"></a><span id="l61.553">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l61.554"></a><span id="l61.554">   if (sObserverCount == 0) {</span>
<a href="#l61.555"></a><span id="l61.555">     sObserver = [[ABChangedMonitor alloc] init];</span>
<a href="#l61.556"></a><span id="l61.556" class="difflineminus">-    [[NSNotificationCenter defaultCenter] addObserver:(ABChangedMonitor*)sObserver</span>
<a href="#l61.557"></a><span id="l61.557" class="difflineplus">+    [[NSNotificationCenter defaultCenter] addObserver:(ABChangedMonitor *)sObserver</span>
<a href="#l61.558"></a><span id="l61.558">                                              selector:@selector(ABChanged:)</span>
<a href="#l61.559"></a><span id="l61.559">                                                  name:kABDatabaseChangedExternallyNotification</span>
<a href="#l61.560"></a><span id="l61.560">                                                object:nil];</span>
<a href="#l61.561"></a><span id="l61.561">   }</span>
<a href="#l61.562"></a><span id="l61.562">   ++sObserverCount;</span>
<a href="#l61.563"></a><span id="l61.563"> </span>
<a href="#l61.564"></a><span id="l61.564">   NSArray *cards;</span>
<a href="#l61.565"></a><span id="l61.565">   nsCOMPtr&lt;nsIMutableArray&gt; cardList;</span>
<a href="#l61.566"></a><span id="l61.566">   bool isRootOSXDirectory = false;</span>
<a href="#l61.567"></a><span id="l61.567"> </span>
<a href="#l61.568"></a><span id="l61.568">   if (!mIsQueryURI &amp;&amp; mURINoQuery.Length() &lt;= sizeof(NS_ABOSXDIRECTORY_URI_PREFIX))</span>
<a href="#l61.569"></a><span id="l61.569">     isRootOSXDirectory = true;</span>
<a href="#l61.570"></a><span id="l61.570"> </span>
<a href="#l61.571"></a><span id="l61.571" class="difflineminus">-  if (mIsQueryURI || isRootOSXDirectory)</span>
<a href="#l61.572"></a><span id="l61.572" class="difflineminus">-  {</span>
<a href="#l61.573"></a><span id="l61.573" class="difflineplus">+  if (mIsQueryURI || isRootOSXDirectory) {</span>
<a href="#l61.574"></a><span id="l61.574">     m_DirPrefId.AssignLiteral(&quot;ldap_2.servers.osx&quot;);</span>
<a href="#l61.575"></a><span id="l61.575"> </span>
<a href="#l61.576"></a><span id="l61.576">     cards = [[addressBook people] arrayByAddingObjectsFromArray:[addressBook groups]];</span>
<a href="#l61.577"></a><span id="l61.577">     if (!mCardList)</span>
<a href="#l61.578"></a><span id="l61.578">       mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.579"></a><span id="l61.579">     else</span>
<a href="#l61.580"></a><span id="l61.580">       rv = mCardList-&gt;Clear();</span>
<a href="#l61.581"></a><span id="l61.581">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.582"></a><span id="l61.582"> </span>
<a href="#l61.583"></a><span id="l61.583">     cardList = mCardList;</span>
<a href="#l61.584"></a><span id="l61.584" class="difflineminus">-  }</span>
<a href="#l61.585"></a><span id="l61.585" class="difflineminus">-  else</span>
<a href="#l61.586"></a><span id="l61.586" class="difflineminus">-  {</span>
<a href="#l61.587"></a><span id="l61.587" class="difflineplus">+  } else {</span>
<a href="#l61.588"></a><span id="l61.588">     nsAutoCString uid(Substring(mURINoQuery, sizeof(NS_ABOSXDIRECTORY_URI_PREFIX) - 1));</span>
<a href="#l61.589"></a><span id="l61.589">     ABRecord *card = [addressBook recordForUniqueId:[NSString stringWithUTF8String:uid.get()]];</span>
<a href="#l61.590"></a><span id="l61.590">     NS_ASSERTION([card isKindOfClass:[ABGroup class]], &quot;Huh.&quot;);</span>
<a href="#l61.591"></a><span id="l61.591"> </span>
<a href="#l61.592"></a><span id="l61.592">     m_IsMailList = true;</span>
<a href="#l61.593"></a><span id="l61.593">     AppendToString([card valueForProperty:kABGroupNameProperty], m_ListDirName);</span>
<a href="#l61.594"></a><span id="l61.594"> </span>
<a href="#l61.595"></a><span id="l61.595" class="difflineminus">-    ABGroup *group = (ABGroup*)[addressBook recordForUniqueId:[NSString stringWithUTF8String:nsAutoCString(Substring(mURINoQuery, 21)).get()]];</span>
<a href="#l61.596"></a><span id="l61.596" class="difflineplus">+    ABGroup *group = (ABGroup *)[addressBook</span>
<a href="#l61.597"></a><span id="l61.597" class="difflineplus">+        recordForUniqueId:[NSString stringWithUTF8String:nsAutoCString(Substring(mURINoQuery, 21))</span>
<a href="#l61.598"></a><span id="l61.598" class="difflineplus">+                                                             .get()]];</span>
<a href="#l61.599"></a><span id="l61.599">     cards = [[group members] arrayByAddingObjectsFromArray:[group subgroups]];</span>
<a href="#l61.600"></a><span id="l61.600"> </span>
<a href="#l61.601"></a><span id="l61.601">     if (!m_AddressList)</span>
<a href="#l61.602"></a><span id="l61.602">       m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.603"></a><span id="l61.603">     else</span>
<a href="#l61.604"></a><span id="l61.604">       rv = m_AddressList-&gt;Clear();</span>
<a href="#l61.605"></a><span id="l61.605">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.606"></a><span id="l61.606"> </span>
<a href="#l61.607"></a><span id="l61.607">     cardList = m_AddressList;</span>
<a href="#l61.608"></a><span id="l61.608">   }</span>
<a href="#l61.609"></a><span id="l61.609"> </span>
<a href="#l61.610"></a><span id="l61.610" class="difflineminus">-</span>
<a href="#l61.611"></a><span id="l61.611">   nsAutoCString ourUuid;</span>
<a href="#l61.612"></a><span id="l61.612">   GetUuid(ourUuid);</span>
<a href="#l61.613"></a><span id="l61.613"> </span>
<a href="#l61.614"></a><span id="l61.614">   unsigned int nbCards = [cards count];</span>
<a href="#l61.615"></a><span id="l61.615">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l61.616"></a><span id="l61.616">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.617"></a><span id="l61.617">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.618"></a><span id="l61.618"> </span>
<a href="#l61.619"></a><span id="l61.619">   nsCOMPtr&lt;nsIAbOSXDirectory&gt; rootOSXDirectory;</span>
<a href="#l61.620"></a><span id="l61.620" class="difflineminus">-  if (!isRootOSXDirectory)</span>
<a href="#l61.621"></a><span id="l61.621" class="difflineminus">-  {</span>
<a href="#l61.622"></a><span id="l61.622" class="difflineplus">+  if (!isRootOSXDirectory) {</span>
<a href="#l61.623"></a><span id="l61.623">     rv = GetRootOSXDirectory(getter_AddRefs(rootOSXDirectory));</span>
<a href="#l61.624"></a><span id="l61.624">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.625"></a><span id="l61.625">   }</span>
<a href="#l61.626"></a><span id="l61.626"> </span>
<a href="#l61.627"></a><span id="l61.627" class="difflineminus">-  for (unsigned int i = 0; i &lt; nbCards; ++i)</span>
<a href="#l61.628"></a><span id="l61.628" class="difflineminus">-  {</span>
<a href="#l61.629"></a><span id="l61.629" class="difflineplus">+  for (unsigned int i = 0; i &lt; nbCards; ++i) {</span>
<a href="#l61.630"></a><span id="l61.630">     // If we're a Group, it's likely that the cards we're going</span>
<a href="#l61.631"></a><span id="l61.631">     // to create were already created in the root nsAbOSXDirectory,</span>
<a href="#l61.632"></a><span id="l61.632">     if (!isRootOSXDirectory)</span>
<a href="#l61.633"></a><span id="l61.633" class="difflineminus">-      rv = GetCard([cards objectAtIndex:i], getter_AddRefs(card),</span>
<a href="#l61.634"></a><span id="l61.634" class="difflineminus">-                   rootOSXDirectory);</span>
<a href="#l61.635"></a><span id="l61.635" class="difflineminus">-    else</span>
<a href="#l61.636"></a><span id="l61.636" class="difflineminus">-    {</span>
<a href="#l61.637"></a><span id="l61.637" class="difflineplus">+      rv = GetCard([cards objectAtIndex:i], getter_AddRefs(card), rootOSXDirectory);</span>
<a href="#l61.638"></a><span id="l61.638" class="difflineplus">+    else {</span>
<a href="#l61.639"></a><span id="l61.639">       // If we're not a Group, that means we're the root nsAbOSXDirectory,</span>
<a href="#l61.640"></a><span id="l61.640">       // which means we have to create the cards from scratch.</span>
<a href="#l61.641"></a><span id="l61.641">       rv = CreateCard([cards objectAtIndex:i], getter_AddRefs(card));</span>
<a href="#l61.642"></a><span id="l61.642">     }</span>
<a href="#l61.643"></a><span id="l61.643"> </span>
<a href="#l61.644"></a><span id="l61.644">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.645"></a><span id="l61.645"> </span>
<a href="#l61.646"></a><span id="l61.646">     // If we're not a query directory, we're going to want to</span>
<a href="#l61.647"></a><span id="l61.647">     // tell the AB Manager that we've added some cards so that they</span>
<a href="#l61.648"></a><span id="l61.648">     // show up in the address book views.</span>
<a href="#l61.649"></a><span id="l61.649" class="difflineminus">-    if (!mIsQueryURI)</span>
<a href="#l61.650"></a><span id="l61.650" class="difflineminus">-      AssertCard(abManager, card);</span>
<a href="#l61.651"></a><span id="l61.651" class="difflineminus">-</span>
<a href="#l61.652"></a><span id="l61.652" class="difflineplus">+    if (!mIsQueryURI) AssertCard(abManager, card);</span>
<a href="#l61.653"></a><span id="l61.653">   }</span>
<a href="#l61.654"></a><span id="l61.654"> </span>
<a href="#l61.655"></a><span id="l61.655">   return NS_OK;</span>
<a href="#l61.656"></a><span id="l61.656"> </span>
<a href="#l61.657"></a><span id="l61.657">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.658"></a><span id="l61.658"> }</span>
<a href="#l61.659"></a><span id="l61.659"> </span>
<a href="#l61.660"></a><span id="l61.660"> NS_IMETHODIMP</span>
<a href="#l61.661"></a><span id="l61.661" class="difflineminus">-nsAbOSXDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l61.662"></a><span id="l61.662" class="difflineminus">-{</span>
<a href="#l61.663"></a><span id="l61.663" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l61.664"></a><span id="l61.664" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l61.665"></a><span id="l61.665" class="difflineplus">+nsAbOSXDirectory::GetURI(nsACString &amp;aURI) {</span>
<a href="#l61.666"></a><span id="l61.666" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l61.667"></a><span id="l61.667"> </span>
<a href="#l61.668"></a><span id="l61.668">   aURI = mURI;</span>
<a href="#l61.669"></a><span id="l61.669">   return NS_OK;</span>
<a href="#l61.670"></a><span id="l61.670"> }</span>
<a href="#l61.671"></a><span id="l61.671"> </span>
<a href="#l61.672"></a><span id="l61.672"> NS_IMETHODIMP</span>
<a href="#l61.673"></a><span id="l61.673" class="difflineminus">-nsAbOSXDirectory::GetReadOnly(bool *aReadOnly)</span>
<a href="#l61.674"></a><span id="l61.674" class="difflineminus">-{</span>
<a href="#l61.675"></a><span id="l61.675" class="difflineplus">+nsAbOSXDirectory::GetReadOnly(bool *aReadOnly) {</span>
<a href="#l61.676"></a><span id="l61.676">   NS_ENSURE_ARG_POINTER(aReadOnly);</span>
<a href="#l61.677"></a><span id="l61.677"> </span>
<a href="#l61.678"></a><span id="l61.678">   *aReadOnly = true;</span>
<a href="#l61.679"></a><span id="l61.679">   return NS_OK;</span>
<a href="#l61.680"></a><span id="l61.680"> }</span>
<a href="#l61.681"></a><span id="l61.681"> </span>
<a href="#l61.682"></a><span id="l61.682" class="difflineminus">-static bool</span>
<a href="#l61.683"></a><span id="l61.683" class="difflineminus">-CheckRedundantCards(nsIAbManager *aManager, nsIAbDirectory *aDirectory,</span>
<a href="#l61.684"></a><span id="l61.684" class="difflineminus">-                    nsIAbCard *aCard, NSMutableArray *aCardList)</span>
<a href="#l61.685"></a><span id="l61.685" class="difflineminus">-{</span>
<a href="#l61.686"></a><span id="l61.686" class="difflineplus">+static bool CheckRedundantCards(nsIAbManager *aManager, nsIAbDirectory *aDirectory,</span>
<a href="#l61.687"></a><span id="l61.687" class="difflineplus">+                                nsIAbCard *aCard, NSMutableArray *aCardList) {</span>
<a href="#l61.688"></a><span id="l61.688">   nsresult rv;</span>
<a href="#l61.689"></a><span id="l61.689">   nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_QueryInterface(aCard, &amp;rv);</span>
<a href="#l61.690"></a><span id="l61.690">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l61.691"></a><span id="l61.691"> </span>
<a href="#l61.692"></a><span id="l61.692">   nsAutoCString uri;</span>
<a href="#l61.693"></a><span id="l61.693">   rv = osxCard-&gt;GetURI(uri);</span>
<a href="#l61.694"></a><span id="l61.694">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l61.695"></a><span id="l61.695">   NSString *uid = [NSString stringWithUTF8String:(uri.get() + 21)];</span>
<a href="#l61.696"></a><span id="l61.696" class="difflineat">@@ -617,145 +568,130 @@ CheckRedundantCards(nsIAbManager *aManag</span>
<a href="#l61.697"></a><span id="l61.697">   if (i == count) {</span>
<a href="#l61.698"></a><span id="l61.698">     aManager-&gt;NotifyDirectoryItemDeleted(aDirectory, aCard);</span>
<a href="#l61.699"></a><span id="l61.699">     return true;</span>
<a href="#l61.700"></a><span id="l61.700">   }</span>
<a href="#l61.701"></a><span id="l61.701"> </span>
<a href="#l61.702"></a><span id="l61.702">   return false;</span>
<a href="#l61.703"></a><span id="l61.703"> }</span>
<a href="#l61.704"></a><span id="l61.704"> </span>
<a href="#l61.705"></a><span id="l61.705" class="difflineminus">-nsresult</span>
<a href="#l61.706"></a><span id="l61.706" class="difflineminus">-nsAbOSXDirectory::GetRootOSXDirectory(nsIAbOSXDirectory **aResult)</span>
<a href="#l61.707"></a><span id="l61.707" class="difflineminus">-{</span>
<a href="#l61.708"></a><span id="l61.708" class="difflineminus">-  if (!mCacheTopLevelOSXAb)</span>
<a href="#l61.709"></a><span id="l61.709" class="difflineminus">-  {</span>
<a href="#l61.710"></a><span id="l61.710" class="difflineplus">+nsresult nsAbOSXDirectory::GetRootOSXDirectory(nsIAbOSXDirectory **aResult) {</span>
<a href="#l61.711"></a><span id="l61.711" class="difflineplus">+  if (!mCacheTopLevelOSXAb) {</span>
<a href="#l61.712"></a><span id="l61.712">     // Attempt to get card from the toplevel directories</span>
<a href="#l61.713"></a><span id="l61.713">     nsresult rv;</span>
<a href="#l61.714"></a><span id="l61.714">     nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.715"></a><span id="l61.715">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.716"></a><span id="l61.716"> </span>
<a href="#l61.717"></a><span id="l61.717">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.718"></a><span id="l61.718" class="difflineminus">-    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l61.719"></a><span id="l61.719" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l61.720"></a><span id="l61.720">                                  getter_AddRefs(directory));</span>
<a href="#l61.721"></a><span id="l61.721">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.722"></a><span id="l61.722"> </span>
<a href="#l61.723"></a><span id="l61.723" class="difflineminus">-    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l61.724"></a><span id="l61.724" class="difflineminus">-      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.725"></a><span id="l61.725" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory = do_QueryInterface(directory, &amp;rv);</span>
<a href="#l61.726"></a><span id="l61.726">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.727"></a><span id="l61.727">     mCacheTopLevelOSXAb = osxDirectory;</span>
<a href="#l61.728"></a><span id="l61.728">   }</span>
<a href="#l61.729"></a><span id="l61.729"> </span>
<a href="#l61.730"></a><span id="l61.730">   NS_IF_ADDREF(*aResult = mCacheTopLevelOSXAb);</span>
<a href="#l61.731"></a><span id="l61.731">   return NS_OK;</span>
<a href="#l61.732"></a><span id="l61.732"> }</span>
<a href="#l61.733"></a><span id="l61.733"> </span>
<a href="#l61.734"></a><span id="l61.734" class="difflineminus">-nsresult</span>
<a href="#l61.735"></a><span id="l61.735" class="difflineminus">-nsAbOSXDirectory::Update()</span>
<a href="#l61.736"></a><span id="l61.736" class="difflineminus">-{</span>
<a href="#l61.737"></a><span id="l61.737" class="difflineplus">+nsresult nsAbOSXDirectory::Update() {</span>
<a href="#l61.738"></a><span id="l61.738">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.739"></a><span id="l61.739"> </span>
<a href="#l61.740"></a><span id="l61.740">   nsresult rv;</span>
<a href="#l61.741"></a><span id="l61.741">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.742"></a><span id="l61.742">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.743"></a><span id="l61.743"> </span>
<a href="#l61.744"></a><span id="l61.744">   if (mIsQueryURI) {</span>
<a href="#l61.745"></a><span id="l61.745">     return NS_OK;</span>
<a href="#l61.746"></a><span id="l61.746">   }</span>
<a href="#l61.747"></a><span id="l61.747"> </span>
<a href="#l61.748"></a><span id="l61.748">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l61.749"></a><span id="l61.749">   // Due to the horrible way the address book code works wrt mailing lists</span>
<a href="#l61.750"></a><span id="l61.750">   // we have to use a different list depending on what we are. This pointer</span>
<a href="#l61.751"></a><span id="l61.751">   // holds a reference to that list.</span>
<a href="#l61.752"></a><span id="l61.752" class="difflineminus">-  nsIMutableArray* cardList;</span>
<a href="#l61.753"></a><span id="l61.753" class="difflineplus">+  nsIMutableArray *cardList;</span>
<a href="#l61.754"></a><span id="l61.754">   NSArray *groups, *cards;</span>
<a href="#l61.755"></a><span id="l61.755">   if (m_IsMailList) {</span>
<a href="#l61.756"></a><span id="l61.756" class="difflineminus">-    ABGroup *group = (ABGroup*)[addressBook recordForUniqueId:[NSString stringWithUTF8String:nsAutoCString(Substring(mURINoQuery, 21)).get()]];</span>
<a href="#l61.757"></a><span id="l61.757" class="difflineplus">+    ABGroup *group = (ABGroup *)[addressBook</span>
<a href="#l61.758"></a><span id="l61.758" class="difflineplus">+        recordForUniqueId:[NSString stringWithUTF8String:nsAutoCString(Substring(mURINoQuery, 21))</span>
<a href="#l61.759"></a><span id="l61.759" class="difflineplus">+                                                             .get()]];</span>
<a href="#l61.760"></a><span id="l61.760">     groups = nil;</span>
<a href="#l61.761"></a><span id="l61.761">     cards = [[group members] arrayByAddingObjectsFromArray:[group subgroups]];</span>
<a href="#l61.762"></a><span id="l61.762"> </span>
<a href="#l61.763"></a><span id="l61.763" class="difflineminus">-    if (!m_AddressList)</span>
<a href="#l61.764"></a><span id="l61.764" class="difflineminus">-    {</span>
<a href="#l61.765"></a><span id="l61.765" class="difflineplus">+    if (!m_AddressList) {</span>
<a href="#l61.766"></a><span id="l61.766">       m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.767"></a><span id="l61.767">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.768"></a><span id="l61.768">     }</span>
<a href="#l61.769"></a><span id="l61.769">     // For mailing lists, store the cards in m_AddressList</span>
<a href="#l61.770"></a><span id="l61.770">     cardList = m_AddressList;</span>
<a href="#l61.771"></a><span id="l61.771" class="difflineminus">-  }</span>
<a href="#l61.772"></a><span id="l61.772" class="difflineminus">-  else {</span>
<a href="#l61.773"></a><span id="l61.773" class="difflineplus">+  } else {</span>
<a href="#l61.774"></a><span id="l61.774">     groups = [addressBook groups];</span>
<a href="#l61.775"></a><span id="l61.775">     cards = [[addressBook people] arrayByAddingObjectsFromArray:groups];</span>
<a href="#l61.776"></a><span id="l61.776"> </span>
<a href="#l61.777"></a><span id="l61.777" class="difflineminus">-    if (!mCardList)</span>
<a href="#l61.778"></a><span id="l61.778" class="difflineminus">-    {</span>
<a href="#l61.779"></a><span id="l61.779" class="difflineplus">+    if (!mCardList) {</span>
<a href="#l61.780"></a><span id="l61.780">       mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.781"></a><span id="l61.781">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.782"></a><span id="l61.782">     }</span>
<a href="#l61.783"></a><span id="l61.783">     // For directories, store the cards in mCardList</span>
<a href="#l61.784"></a><span id="l61.784">     cardList = mCardList;</span>
<a href="#l61.785"></a><span id="l61.785">   }</span>
<a href="#l61.786"></a><span id="l61.786"> </span>
<a href="#l61.787"></a><span id="l61.787">   NSMutableArray *mutableArray = [NSMutableArray arrayWithArray:cards];</span>
<a href="#l61.788"></a><span id="l61.788">   uint32_t addressCount;</span>
<a href="#l61.789"></a><span id="l61.789">   rv = cardList-&gt;GetLength(&amp;addressCount);</span>
<a href="#l61.790"></a><span id="l61.790">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.791"></a><span id="l61.791"> </span>
<a href="#l61.792"></a><span id="l61.792" class="difflineminus">-  while (addressCount--)</span>
<a href="#l61.793"></a><span id="l61.793" class="difflineminus">-  {</span>
<a href="#l61.794"></a><span id="l61.794" class="difflineplus">+  while (addressCount--) {</span>
<a href="#l61.795"></a><span id="l61.795">     nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(cardList, addressCount, &amp;rv));</span>
<a href="#l61.796"></a><span id="l61.796" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l61.797"></a><span id="l61.797" class="difflineminus">-      break;</span>
<a href="#l61.798"></a><span id="l61.798" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l61.799"></a><span id="l61.799"> </span>
<a href="#l61.800"></a><span id="l61.800">     if (CheckRedundantCards(abManager, this, card, mutableArray))</span>
<a href="#l61.801"></a><span id="l61.801">       cardList-&gt;RemoveElementAt(addressCount);</span>
<a href="#l61.802"></a><span id="l61.802">   }</span>
<a href="#l61.803"></a><span id="l61.803"> </span>
<a href="#l61.804"></a><span id="l61.804">   NSEnumerator *enumerator = [mutableArray objectEnumerator];</span>
<a href="#l61.805"></a><span id="l61.805">   ABRecord *card;</span>
<a href="#l61.806"></a><span id="l61.806">   nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l61.807"></a><span id="l61.807">   nsCOMPtr&lt;nsIAbOSXDirectory&gt; rootOSXDirectory;</span>
<a href="#l61.808"></a><span id="l61.808">   rv = GetRootOSXDirectory(getter_AddRefs(rootOSXDirectory));</span>
<a href="#l61.809"></a><span id="l61.809">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.810"></a><span id="l61.810"> </span>
<a href="#l61.811"></a><span id="l61.811" class="difflineminus">-  while ((card = [enumerator nextObject]))</span>
<a href="#l61.812"></a><span id="l61.812" class="difflineminus">-  {</span>
<a href="#l61.813"></a><span id="l61.813" class="difflineplus">+  while ((card = [enumerator nextObject])) {</span>
<a href="#l61.814"></a><span id="l61.814">     rv = GetCard(card, getter_AddRefs(abCard), rootOSXDirectory);</span>
<a href="#l61.815"></a><span id="l61.815" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l61.816"></a><span id="l61.816" class="difflineminus">-      rv = CreateCard(card, getter_AddRefs(abCard));</span>
<a href="#l61.817"></a><span id="l61.817" class="difflineplus">+    if (NS_FAILED(rv)) rv = CreateCard(card, getter_AddRefs(abCard));</span>
<a href="#l61.818"></a><span id="l61.818">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.819"></a><span id="l61.819">     AssertCard(abManager, abCard);</span>
<a href="#l61.820"></a><span id="l61.820">   }</span>
<a href="#l61.821"></a><span id="l61.821"> </span>
<a href="#l61.822"></a><span id="l61.822" class="difflineminus">-  card = (ABRecord*)[addressBook recordForUniqueId:[NSString stringWithUTF8String:nsAutoCString(Substring(mURINoQuery, 21)).get()]];</span>
<a href="#l61.823"></a><span id="l61.823" class="difflineminus">-  NSString * stringValue = [card valueForProperty:kABGroupNameProperty];</span>
<a href="#l61.824"></a><span id="l61.824" class="difflineminus">-  if (![stringValue isEqualToString:WrapString(m_ListDirName)])</span>
<a href="#l61.825"></a><span id="l61.825" class="difflineminus">-  {</span>
<a href="#l61.826"></a><span id="l61.826" class="difflineplus">+  card = (ABRecord *)[addressBook</span>
<a href="#l61.827"></a><span id="l61.827" class="difflineplus">+      recordForUniqueId:[NSString</span>
<a href="#l61.828"></a><span id="l61.828" class="difflineplus">+                            stringWithUTF8String:nsAutoCString(Substring(mURINoQuery, 21)).get()]];</span>
<a href="#l61.829"></a><span id="l61.829" class="difflineplus">+  NSString *stringValue = [card valueForProperty:kABGroupNameProperty];</span>
<a href="#l61.830"></a><span id="l61.830" class="difflineplus">+  if (![stringValue isEqualToString:WrapString(m_ListDirName)]) {</span>
<a href="#l61.831"></a><span id="l61.831">     nsAutoString oldValue(m_ListDirName);</span>
<a href="#l61.832"></a><span id="l61.832">     AssignToString(stringValue, m_ListDirName);</span>
<a href="#l61.833"></a><span id="l61.833">     nsCOMPtr&lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIAbDirectory *&gt;(this), &amp;rv);</span>
<a href="#l61.834"></a><span id="l61.834">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.835"></a><span id="l61.835" class="difflineminus">-    abManager-&gt;NotifyItemPropertyChanged(supports, &quot;DirName&quot;,</span>
<a href="#l61.836"></a><span id="l61.836" class="difflineminus">-                                         oldValue.get(), m_ListDirName.get());</span>
<a href="#l61.837"></a><span id="l61.837" class="difflineplus">+    abManager-&gt;NotifyItemPropertyChanged(supports, &quot;DirName&quot;, oldValue.get(), m_ListDirName.get());</span>
<a href="#l61.838"></a><span id="l61.838">   }</span>
<a href="#l61.839"></a><span id="l61.839"> </span>
<a href="#l61.840"></a><span id="l61.840" class="difflineminus">-  if (groups)</span>
<a href="#l61.841"></a><span id="l61.841" class="difflineminus">-  {</span>
<a href="#l61.842"></a><span id="l61.842" class="difflineplus">+  if (groups) {</span>
<a href="#l61.843"></a><span id="l61.843">     mutableArray = [NSMutableArray arrayWithArray:groups];</span>
<a href="#l61.844"></a><span id="l61.844">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.845"></a><span id="l61.845">     // It is ok to use m_AddressList here as only top-level directories have</span>
<a href="#l61.846"></a><span id="l61.846">     // groups, and they will be in m_AddressList</span>
<a href="#l61.847"></a><span id="l61.847" class="difflineminus">-    if (m_AddressList)</span>
<a href="#l61.848"></a><span id="l61.848" class="difflineminus">-    {</span>
<a href="#l61.849"></a><span id="l61.849" class="difflineplus">+    if (m_AddressList) {</span>
<a href="#l61.850"></a><span id="l61.850">       rv = m_AddressList-&gt;GetLength(&amp;addressCount);</span>
<a href="#l61.851"></a><span id="l61.851">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.852"></a><span id="l61.852"> </span>
<a href="#l61.853"></a><span id="l61.853" class="difflineminus">-      while (addressCount--)</span>
<a href="#l61.854"></a><span id="l61.854" class="difflineminus">-      {</span>
<a href="#l61.855"></a><span id="l61.855" class="difflineplus">+      while (addressCount--) {</span>
<a href="#l61.856"></a><span id="l61.856">         directory = do_QueryElementAt(m_AddressList, addressCount, &amp;rv);</span>
<a href="#l61.857"></a><span id="l61.857" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l61.858"></a><span id="l61.858" class="difflineminus">-          continue;</span>
<a href="#l61.859"></a><span id="l61.859" class="difflineplus">+        if (NS_FAILED(rv)) continue;</span>
<a href="#l61.860"></a><span id="l61.860"> </span>
<a href="#l61.861"></a><span id="l61.861">         nsAutoCString uri;</span>
<a href="#l61.862"></a><span id="l61.862">         directory-&gt;GetURI(uri);</span>
<a href="#l61.863"></a><span id="l61.863">         uri.Cut(0, 21);</span>
<a href="#l61.864"></a><span id="l61.864">         NSString *uid = [NSString stringWithUTF8String:uri.get()];</span>
<a href="#l61.865"></a><span id="l61.865"> </span>
<a href="#l61.866"></a><span id="l61.866">         unsigned int j, arrayCount = [mutableArray count];</span>
<a href="#l61.867"></a><span id="l61.867">         for (j = 0; j &lt; arrayCount; ++j) {</span>
<a href="#l61.868"></a><span id="l61.868" class="difflineat">@@ -780,164 +716,138 @@ nsAbOSXDirectory::Update()</span>
<a href="#l61.869"></a><span id="l61.869">     }</span>
<a href="#l61.870"></a><span id="l61.870">   }</span>
<a href="#l61.871"></a><span id="l61.871"> </span>
<a href="#l61.872"></a><span id="l61.872">   return NS_OK;</span>
<a href="#l61.873"></a><span id="l61.873"> </span>
<a href="#l61.874"></a><span id="l61.874">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.875"></a><span id="l61.875"> }</span>
<a href="#l61.876"></a><span id="l61.876"> </span>
<a href="#l61.877"></a><span id="l61.877" class="difflineminus">-nsresult</span>
<a href="#l61.878"></a><span id="l61.878" class="difflineminus">-nsAbOSXDirectory::AssertChildNodes()</span>
<a href="#l61.879"></a><span id="l61.879" class="difflineminus">-{</span>
<a href="#l61.880"></a><span id="l61.880" class="difflineplus">+nsresult nsAbOSXDirectory::AssertChildNodes() {</span>
<a href="#l61.881"></a><span id="l61.881">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.882"></a><span id="l61.882"> </span>
<a href="#l61.883"></a><span id="l61.883">   // Queries and mailing lists can't have childnodes.</span>
<a href="#l61.884"></a><span id="l61.884">   if (mIsQueryURI || m_IsMailList) {</span>
<a href="#l61.885"></a><span id="l61.885">     return NS_OK;</span>
<a href="#l61.886"></a><span id="l61.886">   }</span>
<a href="#l61.887"></a><span id="l61.887"> </span>
<a href="#l61.888"></a><span id="l61.888">   nsresult rv;</span>
<a href="#l61.889"></a><span id="l61.889" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l61.890"></a><span id="l61.890" class="difflineminus">-    do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.891"></a><span id="l61.891" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.892"></a><span id="l61.892">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.893"></a><span id="l61.893"> </span>
<a href="#l61.894"></a><span id="l61.894">   NSArray *groups = [[ABAddressBook sharedAddressBook] groups];</span>
<a href="#l61.895"></a><span id="l61.895"> </span>
<a href="#l61.896"></a><span id="l61.896">   unsigned int i, count = [groups count];</span>
<a href="#l61.897"></a><span id="l61.897"> </span>
<a href="#l61.898"></a><span id="l61.898">   if (count &gt; 0 &amp;&amp; !m_AddressList) {</span>
<a href="#l61.899"></a><span id="l61.899">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.900"></a><span id="l61.900">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.901"></a><span id="l61.901">   }</span>
<a href="#l61.902"></a><span id="l61.902"> </span>
<a href="#l61.903"></a><span id="l61.903">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.904"></a><span id="l61.904">   for (i = 0; i &lt; count; ++i) {</span>
<a href="#l61.905"></a><span id="l61.905" class="difflineminus">-    rv = GetOrCreateGroup([[groups objectAtIndex:i] uniqueId],</span>
<a href="#l61.906"></a><span id="l61.906" class="difflineminus">-                          getter_AddRefs(directory));</span>
<a href="#l61.907"></a><span id="l61.907" class="difflineplus">+    rv = GetOrCreateGroup([[groups objectAtIndex:i] uniqueId], getter_AddRefs(directory));</span>
<a href="#l61.908"></a><span id="l61.908">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.909"></a><span id="l61.909"> </span>
<a href="#l61.910"></a><span id="l61.910">     rv = AssertDirectory(abManager, directory);</span>
<a href="#l61.911"></a><span id="l61.911">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.912"></a><span id="l61.912">   }</span>
<a href="#l61.913"></a><span id="l61.913"> </span>
<a href="#l61.914"></a><span id="l61.914">   return NS_OK;</span>
<a href="#l61.915"></a><span id="l61.915"> </span>
<a href="#l61.916"></a><span id="l61.916">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.917"></a><span id="l61.917"> }</span>
<a href="#l61.918"></a><span id="l61.918"> </span>
<a href="#l61.919"></a><span id="l61.919" class="difflineminus">-nsresult</span>
<a href="#l61.920"></a><span id="l61.920" class="difflineminus">-nsAbOSXDirectory::AssertDirectory(nsIAbManager *aManager,</span>
<a href="#l61.921"></a><span id="l61.921" class="difflineminus">-                                  nsIAbDirectory *aDirectory)</span>
<a href="#l61.922"></a><span id="l61.922" class="difflineminus">-{</span>
<a href="#l61.923"></a><span id="l61.923" class="difflineplus">+nsresult nsAbOSXDirectory::AssertDirectory(nsIAbManager *aManager, nsIAbDirectory *aDirectory) {</span>
<a href="#l61.924"></a><span id="l61.924">   uint32_t pos;</span>
<a href="#l61.925"></a><span id="l61.925" class="difflineminus">-  if (m_AddressList &amp;&amp;</span>
<a href="#l61.926"></a><span id="l61.926" class="difflineminus">-      NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l61.927"></a><span id="l61.927" class="difflineplus">+  if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l61.928"></a><span id="l61.928">     // We already have this directory, so no point in adding it again.</span>
<a href="#l61.929"></a><span id="l61.929">     return NS_OK;</span>
<a href="#l61.930"></a><span id="l61.930"> </span>
<a href="#l61.931"></a><span id="l61.931">   nsresult rv;</span>
<a href="#l61.932"></a><span id="l61.932">   if (!m_AddressList) {</span>
<a href="#l61.933"></a><span id="l61.933">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.934"></a><span id="l61.934">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.935"></a><span id="l61.935">   }</span>
<a href="#l61.936"></a><span id="l61.936"> </span>
<a href="#l61.937"></a><span id="l61.937">   rv = m_AddressList-&gt;AppendElement(aDirectory);</span>
<a href="#l61.938"></a><span id="l61.938">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.939"></a><span id="l61.939"> </span>
<a href="#l61.940"></a><span id="l61.940">   return aManager-&gt;NotifyDirectoryItemAdded(this, aDirectory);</span>
<a href="#l61.941"></a><span id="l61.941"> }</span>
<a href="#l61.942"></a><span id="l61.942"> </span>
<a href="#l61.943"></a><span id="l61.943" class="difflineminus">-nsresult</span>
<a href="#l61.944"></a><span id="l61.944" class="difflineminus">-nsAbOSXDirectory::AssertCard(nsIAbManager *aManager,</span>
<a href="#l61.945"></a><span id="l61.945" class="difflineminus">-                             nsIAbCard *aCard)</span>
<a href="#l61.946"></a><span id="l61.946" class="difflineminus">-{</span>
<a href="#l61.947"></a><span id="l61.947" class="difflineplus">+nsresult nsAbOSXDirectory::AssertCard(nsIAbManager *aManager, nsIAbCard *aCard) {</span>
<a href="#l61.948"></a><span id="l61.948">   nsAutoCString ourUuid;</span>
<a href="#l61.949"></a><span id="l61.949">   GetUuid(ourUuid);</span>
<a href="#l61.950"></a><span id="l61.950">   aCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l61.951"></a><span id="l61.951"> </span>
<a href="#l61.952"></a><span id="l61.952" class="difflineminus">-  nsresult rv = m_IsMailList ? m_AddressList-&gt;AppendElement(aCard) :</span>
<a href="#l61.953"></a><span id="l61.953" class="difflineminus">-                               mCardList-&gt;AppendElement(aCard);</span>
<a href="#l61.954"></a><span id="l61.954" class="difflineplus">+  nsresult rv =</span>
<a href="#l61.955"></a><span id="l61.955" class="difflineplus">+      m_IsMailList ? m_AddressList-&gt;AppendElement(aCard) : mCardList-&gt;AppendElement(aCard);</span>
<a href="#l61.956"></a><span id="l61.956">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.957"></a><span id="l61.957"> </span>
<a href="#l61.958"></a><span id="l61.958">   // Get the card's URI and add it to our card store</span>
<a href="#l61.959"></a><span id="l61.959">   nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_QueryInterface(aCard, &amp;rv);</span>
<a href="#l61.960"></a><span id="l61.960">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.961"></a><span id="l61.961"> </span>
<a href="#l61.962"></a><span id="l61.962">   nsCString uri;</span>
<a href="#l61.963"></a><span id="l61.963">   rv = osxCard-&gt;GetURI(uri);</span>
<a href="#l61.964"></a><span id="l61.964"> </span>
<a href="#l61.965"></a><span id="l61.965">   nsCOMPtr&lt;nsIAbOSXCard&gt; retrievedCard;</span>
<a href="#l61.966"></a><span id="l61.966" class="difflineminus">-  if (!mCardStore.Get(uri, getter_AddRefs(retrievedCard)))</span>
<a href="#l61.967"></a><span id="l61.967" class="difflineminus">-    mCardStore.Put(uri, osxCard);</span>
<a href="#l61.968"></a><span id="l61.968" class="difflineplus">+  if (!mCardStore.Get(uri, getter_AddRefs(retrievedCard))) mCardStore.Put(uri, osxCard);</span>
<a href="#l61.969"></a><span id="l61.969"> </span>
<a href="#l61.970"></a><span id="l61.970">   return aManager-&gt;NotifyDirectoryItemAdded(this, aCard);</span>
<a href="#l61.971"></a><span id="l61.971"> }</span>
<a href="#l61.972"></a><span id="l61.972"> </span>
<a href="#l61.973"></a><span id="l61.973" class="difflineminus">-nsresult</span>
<a href="#l61.974"></a><span id="l61.974" class="difflineminus">-nsAbOSXDirectory::UnassertCard(nsIAbManager *aManager,</span>
<a href="#l61.975"></a><span id="l61.975" class="difflineminus">-                               nsIAbCard *aCard,</span>
<a href="#l61.976"></a><span id="l61.976" class="difflineminus">-                               nsIMutableArray *aCardList)</span>
<a href="#l61.977"></a><span id="l61.977" class="difflineminus">-{</span>
<a href="#l61.978"></a><span id="l61.978" class="difflineplus">+nsresult nsAbOSXDirectory::UnassertCard(nsIAbManager *aManager, nsIAbCard *aCard,</span>
<a href="#l61.979"></a><span id="l61.979" class="difflineplus">+                                        nsIMutableArray *aCardList) {</span>
<a href="#l61.980"></a><span id="l61.980">   nsresult rv;</span>
<a href="#l61.981"></a><span id="l61.981">   uint32_t pos;</span>
<a href="#l61.982"></a><span id="l61.982"> </span>
<a href="#l61.983"></a><span id="l61.983" class="difflineminus">-  if (NS_SUCCEEDED(aCardList-&gt;IndexOf(0, aCard, &amp;pos)))</span>
<a href="#l61.984"></a><span id="l61.984" class="difflineminus">-    rv = aCardList-&gt;RemoveElementAt(pos);</span>
<a href="#l61.985"></a><span id="l61.985" class="difflineplus">+  if (NS_SUCCEEDED(aCardList-&gt;IndexOf(0, aCard, &amp;pos))) rv = aCardList-&gt;RemoveElementAt(pos);</span>
<a href="#l61.986"></a><span id="l61.986"> </span>
<a href="#l61.987"></a><span id="l61.987">   return aManager-&gt;NotifyDirectoryItemDeleted(this, aCard);</span>
<a href="#l61.988"></a><span id="l61.988"> }</span>
<a href="#l61.989"></a><span id="l61.989"> </span>
<a href="#l61.990"></a><span id="l61.990" class="difflineminus">-nsresult</span>
<a href="#l61.991"></a><span id="l61.991" class="difflineminus">-nsAbOSXDirectory::UnassertDirectory(nsIAbManager *aManager,</span>
<a href="#l61.992"></a><span id="l61.992" class="difflineminus">-                                    nsIAbDirectory *aDirectory)</span>
<a href="#l61.993"></a><span id="l61.993" class="difflineminus">-{</span>
<a href="#l61.994"></a><span id="l61.994" class="difflineplus">+nsresult nsAbOSXDirectory::UnassertDirectory(nsIAbManager *aManager, nsIAbDirectory *aDirectory) {</span>
<a href="#l61.995"></a><span id="l61.995">   NS_ENSURE_TRUE(m_AddressList, NS_ERROR_NULL_POINTER);</span>
<a href="#l61.996"></a><span id="l61.996"> </span>
<a href="#l61.997"></a><span id="l61.997">   uint32_t pos;</span>
<a href="#l61.998"></a><span id="l61.998" class="difflineminus">-  if (NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l61.999"></a><span id="l61.999" class="difflineminus">-  {</span>
<a href="#l61.1000"></a><span id="l61.1000" class="difflineplus">+  if (NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos))) {</span>
<a href="#l61.1001"></a><span id="l61.1001">     nsresult rv = m_AddressList-&gt;RemoveElementAt(pos);</span>
<a href="#l61.1002"></a><span id="l61.1002">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1003"></a><span id="l61.1003">   }</span>
<a href="#l61.1004"></a><span id="l61.1004"> </span>
<a href="#l61.1005"></a><span id="l61.1005">   return aManager-&gt;NotifyDirectoryItemDeleted(this, aDirectory);</span>
<a href="#l61.1006"></a><span id="l61.1006"> }</span>
<a href="#l61.1007"></a><span id="l61.1007"> </span>
<a href="#l61.1008"></a><span id="l61.1008"> NS_IMETHODIMP</span>
<a href="#l61.1009"></a><span id="l61.1009" class="difflineminus">-nsAbOSXDirectory::GetChildNodes(nsISimpleEnumerator **aNodes)</span>
<a href="#l61.1010"></a><span id="l61.1010" class="difflineminus">-{</span>
<a href="#l61.1011"></a><span id="l61.1011" class="difflineplus">+nsAbOSXDirectory::GetChildNodes(nsISimpleEnumerator **aNodes) {</span>
<a href="#l61.1012"></a><span id="l61.1012">   NS_ENSURE_ARG_POINTER(aNodes);</span>
<a href="#l61.1013"></a><span id="l61.1013"> </span>
<a href="#l61.1014"></a><span id="l61.1014">   // Queries don't have childnodes.</span>
<a href="#l61.1015"></a><span id="l61.1015" class="difflineminus">-  if (mIsQueryURI || m_IsMailList || !m_AddressList)</span>
<a href="#l61.1016"></a><span id="l61.1016" class="difflineminus">-    return NS_NewEmptyEnumerator(aNodes);</span>
<a href="#l61.1017"></a><span id="l61.1017" class="difflineplus">+  if (mIsQueryURI || m_IsMailList || !m_AddressList) return NS_NewEmptyEnumerator(aNodes);</span>
<a href="#l61.1018"></a><span id="l61.1018"> </span>
<a href="#l61.1019"></a><span id="l61.1019">   return NS_NewArrayEnumerator(aNodes, m_AddressList, NS_GET_IID(nsIAbDirectory));</span>
<a href="#l61.1020"></a><span id="l61.1020"> }</span>
<a href="#l61.1021"></a><span id="l61.1021"> </span>
<a href="#l61.1022"></a><span id="l61.1022"> NS_IMETHODIMP</span>
<a href="#l61.1023"></a><span id="l61.1023" class="difflineminus">-nsAbOSXDirectory::GetChildCards(nsISimpleEnumerator **aCards)</span>
<a href="#l61.1024"></a><span id="l61.1024" class="difflineminus">-{</span>
<a href="#l61.1025"></a><span id="l61.1025" class="difflineplus">+nsAbOSXDirectory::GetChildCards(nsISimpleEnumerator **aCards) {</span>
<a href="#l61.1026"></a><span id="l61.1026">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.1027"></a><span id="l61.1027"> </span>
<a href="#l61.1028"></a><span id="l61.1028">   NS_ENSURE_ARG_POINTER(aCards);</span>
<a href="#l61.1029"></a><span id="l61.1029"> </span>
<a href="#l61.1030"></a><span id="l61.1030">   nsresult rv;</span>
<a href="#l61.1031"></a><span id="l61.1031">   NSArray *cards;</span>
<a href="#l61.1032"></a><span id="l61.1032" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l61.1033"></a><span id="l61.1033" class="difflineminus">-  {</span>
<a href="#l61.1034"></a><span id="l61.1034" class="difflineplus">+  if (mIsQueryURI) {</span>
<a href="#l61.1035"></a><span id="l61.1035">     nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l61.1036"></a><span id="l61.1036" class="difflineminus">-    rv = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l61.1037"></a><span id="l61.1037" class="difflineminus">-                                              getter_AddRefs(expression));</span>
<a href="#l61.1038"></a><span id="l61.1038" class="difflineplus">+    rv = nsAbQueryStringToExpression::Convert(mQueryString, getter_AddRefs(expression));</span>
<a href="#l61.1039"></a><span id="l61.1039">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1040"></a><span id="l61.1040"> </span>
<a href="#l61.1041"></a><span id="l61.1041">     bool canHandle = !m_IsMailList &amp;&amp; Search(expression, &amp;cards);</span>
<a href="#l61.1042"></a><span id="l61.1042" class="difflineminus">-    if (!canHandle)</span>
<a href="#l61.1043"></a><span id="l61.1043" class="difflineminus">-      return FallbackSearch(expression, aCards);</span>
<a href="#l61.1044"></a><span id="l61.1044" class="difflineplus">+    if (!canHandle) return FallbackSearch(expression, aCards);</span>
<a href="#l61.1045"></a><span id="l61.1045"> </span>
<a href="#l61.1046"></a><span id="l61.1046">     if (!mCardList)</span>
<a href="#l61.1047"></a><span id="l61.1047">       mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.1048"></a><span id="l61.1048">     else</span>
<a href="#l61.1049"></a><span id="l61.1049">       mCardList-&gt;Clear();</span>
<a href="#l61.1050"></a><span id="l61.1050">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1051"></a><span id="l61.1051"> </span>
<a href="#l61.1052"></a><span id="l61.1052">     // The uuid for initializing cards</span>
<a href="#l61.1053"></a><span id="l61.1053" class="difflineat">@@ -948,262 +858,218 @@ nsAbOSXDirectory::GetChildCards(nsISimpl</span>
<a href="#l61.1054"></a><span id="l61.1054">     unsigned int nbCards = [cards count];</span>
<a href="#l61.1055"></a><span id="l61.1055"> </span>
<a href="#l61.1056"></a><span id="l61.1056">     unsigned int i;</span>
<a href="#l61.1057"></a><span id="l61.1057">     nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l61.1058"></a><span id="l61.1058">     nsCOMPtr&lt;nsIAbOSXDirectory&gt; rootOSXDirectory;</span>
<a href="#l61.1059"></a><span id="l61.1059">     rv = GetRootOSXDirectory(getter_AddRefs(rootOSXDirectory));</span>
<a href="#l61.1060"></a><span id="l61.1060">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1061"></a><span id="l61.1061"> </span>
<a href="#l61.1062"></a><span id="l61.1062" class="difflineminus">-    for (i = 0; i &lt; nbCards; ++i)</span>
<a href="#l61.1063"></a><span id="l61.1063" class="difflineminus">-    {</span>
<a href="#l61.1064"></a><span id="l61.1064" class="difflineminus">-      rv = GetCard([cards objectAtIndex:i], getter_AddRefs(card),</span>
<a href="#l61.1065"></a><span id="l61.1065" class="difflineminus">-                   rootOSXDirectory);</span>
<a href="#l61.1066"></a><span id="l61.1066" class="difflineplus">+    for (i = 0; i &lt; nbCards; ++i) {</span>
<a href="#l61.1067"></a><span id="l61.1067" class="difflineplus">+      rv = GetCard([cards objectAtIndex:i], getter_AddRefs(card), rootOSXDirectory);</span>
<a href="#l61.1068"></a><span id="l61.1068"> </span>
<a href="#l61.1069"></a><span id="l61.1069" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l61.1070"></a><span id="l61.1070" class="difflineminus">-        rv = CreateCard([cards objectAtIndex:i],</span>
<a href="#l61.1071"></a><span id="l61.1071" class="difflineminus">-                        getter_AddRefs(card));</span>
<a href="#l61.1072"></a><span id="l61.1072" class="difflineplus">+      if (NS_FAILED(rv)) rv = CreateCard([cards objectAtIndex:i], getter_AddRefs(card));</span>
<a href="#l61.1073"></a><span id="l61.1073"> </span>
<a href="#l61.1074"></a><span id="l61.1074">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1075"></a><span id="l61.1075">       card-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l61.1076"></a><span id="l61.1076"> </span>
<a href="#l61.1077"></a><span id="l61.1077">       mCardList-&gt;AppendElement(card);</span>
<a href="#l61.1078"></a><span id="l61.1078">     }</span>
<a href="#l61.1079"></a><span id="l61.1079"> </span>
<a href="#l61.1080"></a><span id="l61.1080">     return NS_NewArrayEnumerator(aCards, mCardList, NS_GET_IID(nsIAbCard));</span>
<a href="#l61.1081"></a><span id="l61.1081">   }</span>
<a href="#l61.1082"></a><span id="l61.1082"> </span>
<a href="#l61.1083"></a><span id="l61.1083">   // Not a search, so just return the appropriate list of items.</span>
<a href="#l61.1084"></a><span id="l61.1084" class="difflineminus">-  return m_IsMailList ?</span>
<a href="#l61.1085"></a><span id="l61.1085" class="difflineminus">-         NS_NewArrayEnumerator(aCards, m_AddressList, NS_GET_IID(nsIAbDirectory)) :</span>
<a href="#l61.1086"></a><span id="l61.1086" class="difflineminus">-         NS_NewArrayEnumerator(aCards, mCardList, NS_GET_IID(nsIAbCard));</span>
<a href="#l61.1087"></a><span id="l61.1087" class="difflineplus">+  return m_IsMailList ? NS_NewArrayEnumerator(aCards, m_AddressList, NS_GET_IID(nsIAbDirectory))</span>
<a href="#l61.1088"></a><span id="l61.1088" class="difflineplus">+                      : NS_NewArrayEnumerator(aCards, mCardList, NS_GET_IID(nsIAbCard));</span>
<a href="#l61.1089"></a><span id="l61.1089"> </span>
<a href="#l61.1090"></a><span id="l61.1090">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l61.1091"></a><span id="l61.1091"> }</span>
<a href="#l61.1092"></a><span id="l61.1092"> </span>
<a href="#l61.1093"></a><span id="l61.1093"> NS_IMETHODIMP</span>
<a href="#l61.1094"></a><span id="l61.1094" class="difflineminus">-nsAbOSXDirectory::GetIsQuery(bool *aResult)</span>
<a href="#l61.1095"></a><span id="l61.1095" class="difflineminus">-{</span>
<a href="#l61.1096"></a><span id="l61.1096" class="difflineplus">+nsAbOSXDirectory::GetIsQuery(bool *aResult) {</span>
<a href="#l61.1097"></a><span id="l61.1097">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l61.1098"></a><span id="l61.1098">   *aResult = mIsQueryURI;</span>
<a href="#l61.1099"></a><span id="l61.1099">   return NS_OK;</span>
<a href="#l61.1100"></a><span id="l61.1100"> }</span>
<a href="#l61.1101"></a><span id="l61.1101"> </span>
<a href="#l61.1102"></a><span id="l61.1102"> /* Recursive method that searches for a child card by URI.  If it cannot find</span>
<a href="#l61.1103"></a><span id="l61.1103">  * it within this directory, it checks all subfolders.</span>
<a href="#l61.1104"></a><span id="l61.1104">  */</span>
<a href="#l61.1105"></a><span id="l61.1105"> NS_IMETHODIMP</span>
<a href="#l61.1106"></a><span id="l61.1106" class="difflineminus">-nsAbOSXDirectory::GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult)</span>
<a href="#l61.1107"></a><span id="l61.1107" class="difflineminus">-{</span>
<a href="#l61.1108"></a><span id="l61.1108" class="difflineplus">+nsAbOSXDirectory::GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult) {</span>
<a href="#l61.1109"></a><span id="l61.1109">   nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard;</span>
<a href="#l61.1110"></a><span id="l61.1110"> </span>
<a href="#l61.1111"></a><span id="l61.1111">   // Base Case</span>
<a href="#l61.1112"></a><span id="l61.1112" class="difflineminus">-  if (mCardStore.Get(aUri, getter_AddRefs(osxCard)))</span>
<a href="#l61.1113"></a><span id="l61.1113" class="difflineminus">-  {</span>
<a href="#l61.1114"></a><span id="l61.1114" class="difflineplus">+  if (mCardStore.Get(aUri, getter_AddRefs(osxCard))) {</span>
<a href="#l61.1115"></a><span id="l61.1115">     NS_IF_ADDREF(*aResult = osxCard);</span>
<a href="#l61.1116"></a><span id="l61.1116">     return NS_OK;</span>
<a href="#l61.1117"></a><span id="l61.1117">   }</span>
<a href="#l61.1118"></a><span id="l61.1118">   // Search children</span>
<a href="#l61.1119"></a><span id="l61.1119">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l61.1120"></a><span id="l61.1120">   nsresult rv = this-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l61.1121"></a><span id="l61.1121">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1122"></a><span id="l61.1122"> </span>
<a href="#l61.1123"></a><span id="l61.1123">   nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l61.1124"></a><span id="l61.1124">   bool hasMore = false;</span>
<a href="#l61.1125"></a><span id="l61.1125" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l61.1126"></a><span id="l61.1126" class="difflineminus">-  {</span>
<a href="#l61.1127"></a><span id="l61.1127" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l61.1128"></a><span id="l61.1128">     rv = enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l61.1129"></a><span id="l61.1129">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1130"></a><span id="l61.1130"> </span>
<a href="#l61.1131"></a><span id="l61.1131">     nsCOMPtr&lt;nsIAbOSXDirectory&gt; childDirectory;</span>
<a href="#l61.1132"></a><span id="l61.1132">     childDirectory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l61.1133"></a><span id="l61.1133" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1134"></a><span id="l61.1134" class="difflineminus">-    {</span>
<a href="#l61.1135"></a><span id="l61.1135" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1136"></a><span id="l61.1136">       rv = childDirectory-&gt;GetCardByUri(aUri, getter_AddRefs(osxCard));</span>
<a href="#l61.1137"></a><span id="l61.1137" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1138"></a><span id="l61.1138" class="difflineminus">-      {</span>
<a href="#l61.1139"></a><span id="l61.1139" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1140"></a><span id="l61.1140">         NS_IF_ADDREF(*aResult = osxCard);</span>
<a href="#l61.1141"></a><span id="l61.1141">         return NS_OK;</span>
<a href="#l61.1142"></a><span id="l61.1142">       }</span>
<a href="#l61.1143"></a><span id="l61.1143">     }</span>
<a href="#l61.1144"></a><span id="l61.1144">   }</span>
<a href="#l61.1145"></a><span id="l61.1145">   return NS_ERROR_FAILURE;</span>
<a href="#l61.1146"></a><span id="l61.1146"> }</span>
<a href="#l61.1147"></a><span id="l61.1147"> </span>
<a href="#l61.1148"></a><span id="l61.1148"> NS_IMETHODIMP</span>
<a href="#l61.1149"></a><span id="l61.1149" class="difflineminus">-nsAbOSXDirectory::GetCardFromProperty(const char *aProperty,</span>
<a href="#l61.1150"></a><span id="l61.1150" class="difflineminus">-                                      const nsACString &amp;aValue,</span>
<a href="#l61.1151"></a><span id="l61.1151" class="difflineminus">-                                      bool aCaseSensitive,</span>
<a href="#l61.1152"></a><span id="l61.1152" class="difflineminus">-                                      nsIAbCard **aResult)</span>
<a href="#l61.1153"></a><span id="l61.1153" class="difflineminus">-{</span>
<a href="#l61.1154"></a><span id="l61.1154" class="difflineplus">+nsAbOSXDirectory::GetCardFromProperty(const char *aProperty, const nsACString &amp;aValue,</span>
<a href="#l61.1155"></a><span id="l61.1155" class="difflineplus">+                                      bool aCaseSensitive, nsIAbCard **aResult) {</span>
<a href="#l61.1156"></a><span id="l61.1156">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l61.1157"></a><span id="l61.1157"> </span>
<a href="#l61.1158"></a><span id="l61.1158">   *aResult = nullptr;</span>
<a href="#l61.1159"></a><span id="l61.1159"> </span>
<a href="#l61.1160"></a><span id="l61.1160" class="difflineminus">-  if (aValue.IsEmpty())</span>
<a href="#l61.1161"></a><span id="l61.1161" class="difflineminus">-    return NS_OK;</span>
<a href="#l61.1162"></a><span id="l61.1162" class="difflineplus">+  if (aValue.IsEmpty()) return NS_OK;</span>
<a href="#l61.1163"></a><span id="l61.1163"> </span>
<a href="#l61.1164"></a><span id="l61.1164">   nsIMutableArray *list = m_IsMailList ? m_AddressList : mCardList;</span>
<a href="#l61.1165"></a><span id="l61.1165"> </span>
<a href="#l61.1166"></a><span id="l61.1166" class="difflineminus">-  if (!list)</span>
<a href="#l61.1167"></a><span id="l61.1167" class="difflineminus">-    return NS_OK;</span>
<a href="#l61.1168"></a><span id="l61.1168" class="difflineplus">+  if (!list) return NS_OK;</span>
<a href="#l61.1169"></a><span id="l61.1169"> </span>
<a href="#l61.1170"></a><span id="l61.1170">   uint32_t length;</span>
<a href="#l61.1171"></a><span id="l61.1171">   nsresult rv = list-&gt;GetLength(&amp;length);</span>
<a href="#l61.1172"></a><span id="l61.1172">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1173"></a><span id="l61.1173"> </span>
<a href="#l61.1174"></a><span id="l61.1174">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l61.1175"></a><span id="l61.1175">   nsAutoCString cardValue;</span>
<a href="#l61.1176"></a><span id="l61.1176"> </span>
<a href="#l61.1177"></a><span id="l61.1177" class="difflineminus">-  for (uint32_t i = 0; i &lt; length &amp;&amp; !*aResult; ++i)</span>
<a href="#l61.1178"></a><span id="l61.1178" class="difflineminus">-  {</span>
<a href="#l61.1179"></a><span id="l61.1179" class="difflineplus">+  for (uint32_t i = 0; i &lt; length &amp;&amp; !*aResult; ++i) {</span>
<a href="#l61.1180"></a><span id="l61.1180">     card = do_QueryElementAt(list, i, &amp;rv);</span>
<a href="#l61.1181"></a><span id="l61.1181" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1182"></a><span id="l61.1182" class="difflineminus">-    {</span>
<a href="#l61.1183"></a><span id="l61.1183" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1184"></a><span id="l61.1184">       rv = card-&gt;GetPropertyAsAUTF8String(aProperty, cardValue);</span>
<a href="#l61.1185"></a><span id="l61.1185" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1186"></a><span id="l61.1186" class="difflineminus">-      {</span>
<a href="#l61.1187"></a><span id="l61.1187" class="difflineminus">-        bool equal = aCaseSensitive ? cardValue.Equals(aValue) :</span>
<a href="#l61.1188"></a><span id="l61.1188" class="difflineminus">-          cardValue.Equals(aValue, nsCaseInsensitiveCStringComparator());</span>
<a href="#l61.1189"></a><span id="l61.1189" class="difflineminus">-        if (equal)</span>
<a href="#l61.1190"></a><span id="l61.1190" class="difflineminus">-          NS_IF_ADDREF(*aResult = card);</span>
<a href="#l61.1191"></a><span id="l61.1191" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1192"></a><span id="l61.1192" class="difflineplus">+        bool equal = aCaseSensitive</span>
<a href="#l61.1193"></a><span id="l61.1193" class="difflineplus">+                         ? cardValue.Equals(aValue)</span>
<a href="#l61.1194"></a><span id="l61.1194" class="difflineplus">+                         : cardValue.Equals(aValue, nsCaseInsensitiveCStringComparator());</span>
<a href="#l61.1195"></a><span id="l61.1195" class="difflineplus">+        if (equal) NS_IF_ADDREF(*aResult = card);</span>
<a href="#l61.1196"></a><span id="l61.1196">       }</span>
<a href="#l61.1197"></a><span id="l61.1197">     }</span>
<a href="#l61.1198"></a><span id="l61.1198">   }</span>
<a href="#l61.1199"></a><span id="l61.1199">   return NS_OK;</span>
<a href="#l61.1200"></a><span id="l61.1200"> }</span>
<a href="#l61.1201"></a><span id="l61.1201"> </span>
<a href="#l61.1202"></a><span id="l61.1202"> NS_IMETHODIMP</span>
<a href="#l61.1203"></a><span id="l61.1203" class="difflineminus">-nsAbOSXDirectory::GetCardsFromProperty(const char *aProperty,</span>
<a href="#l61.1204"></a><span id="l61.1204" class="difflineminus">-                                       const nsACString &amp;aValue,</span>
<a href="#l61.1205"></a><span id="l61.1205" class="difflineminus">-                                       bool aCaseSensitive,</span>
<a href="#l61.1206"></a><span id="l61.1206" class="difflineminus">-                                       nsISimpleEnumerator **aResult)</span>
<a href="#l61.1207"></a><span id="l61.1207" class="difflineminus">-{</span>
<a href="#l61.1208"></a><span id="l61.1208" class="difflineplus">+nsAbOSXDirectory::GetCardsFromProperty(const char *aProperty, const nsACString &amp;aValue,</span>
<a href="#l61.1209"></a><span id="l61.1209" class="difflineplus">+                                       bool aCaseSensitive, nsISimpleEnumerator **aResult) {</span>
<a href="#l61.1210"></a><span id="l61.1210">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l61.1211"></a><span id="l61.1211"> </span>
<a href="#l61.1212"></a><span id="l61.1212">   *aResult = nullptr;</span>
<a href="#l61.1213"></a><span id="l61.1213"> </span>
<a href="#l61.1214"></a><span id="l61.1214" class="difflineminus">-  if (aValue.IsEmpty())</span>
<a href="#l61.1215"></a><span id="l61.1215" class="difflineminus">-    return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l61.1216"></a><span id="l61.1216" class="difflineplus">+  if (aValue.IsEmpty()) return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l61.1217"></a><span id="l61.1217"> </span>
<a href="#l61.1218"></a><span id="l61.1218">   nsIMutableArray *list = m_IsMailList ? m_AddressList : mCardList;</span>
<a href="#l61.1219"></a><span id="l61.1219"> </span>
<a href="#l61.1220"></a><span id="l61.1220" class="difflineminus">-  if (!list)</span>
<a href="#l61.1221"></a><span id="l61.1221" class="difflineminus">-    return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l61.1222"></a><span id="l61.1222" class="difflineplus">+  if (!list) return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l61.1223"></a><span id="l61.1223"> </span>
<a href="#l61.1224"></a><span id="l61.1224">   uint32_t length;</span>
<a href="#l61.1225"></a><span id="l61.1225">   nsresult rv = list-&gt;GetLength(&amp;length);</span>
<a href="#l61.1226"></a><span id="l61.1226">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1227"></a><span id="l61.1227"> </span>
<a href="#l61.1228"></a><span id="l61.1228">   nsCOMArray&lt;nsIAbCard&gt; resultArray;</span>
<a href="#l61.1229"></a><span id="l61.1229">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l61.1230"></a><span id="l61.1230">   nsAutoCString cardValue;</span>
<a href="#l61.1231"></a><span id="l61.1231"> </span>
<a href="#l61.1232"></a><span id="l61.1232" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; ++i)</span>
<a href="#l61.1233"></a><span id="l61.1233" class="difflineminus">-  {</span>
<a href="#l61.1234"></a><span id="l61.1234" class="difflineplus">+  for (uint32_t i = 0; i &lt; length; ++i) {</span>
<a href="#l61.1235"></a><span id="l61.1235">     card = do_QueryElementAt(list, i, &amp;rv);</span>
<a href="#l61.1236"></a><span id="l61.1236" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1237"></a><span id="l61.1237" class="difflineminus">-    {</span>
<a href="#l61.1238"></a><span id="l61.1238" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1239"></a><span id="l61.1239">       rv = card-&gt;GetPropertyAsAUTF8String(aProperty, cardValue);</span>
<a href="#l61.1240"></a><span id="l61.1240" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1241"></a><span id="l61.1241" class="difflineminus">-      {</span>
<a href="#l61.1242"></a><span id="l61.1242" class="difflineminus">-        bool equal = aCaseSensitive ? cardValue.Equals(aValue) :</span>
<a href="#l61.1243"></a><span id="l61.1243" class="difflineminus">-          cardValue.Equals(aValue, nsCaseInsensitiveCStringComparator());</span>
<a href="#l61.1244"></a><span id="l61.1244" class="difflineminus">-        if (equal)</span>
<a href="#l61.1245"></a><span id="l61.1245" class="difflineminus">-          resultArray.AppendObject(card);</span>
<a href="#l61.1246"></a><span id="l61.1246" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1247"></a><span id="l61.1247" class="difflineplus">+        bool equal = aCaseSensitive</span>
<a href="#l61.1248"></a><span id="l61.1248" class="difflineplus">+                         ? cardValue.Equals(aValue)</span>
<a href="#l61.1249"></a><span id="l61.1249" class="difflineplus">+                         : cardValue.Equals(aValue, nsCaseInsensitiveCStringComparator());</span>
<a href="#l61.1250"></a><span id="l61.1250" class="difflineplus">+        if (equal) resultArray.AppendObject(card);</span>
<a href="#l61.1251"></a><span id="l61.1251">       }</span>
<a href="#l61.1252"></a><span id="l61.1252">     }</span>
<a href="#l61.1253"></a><span id="l61.1253">   }</span>
<a href="#l61.1254"></a><span id="l61.1254"> </span>
<a href="#l61.1255"></a><span id="l61.1255">   return NS_NewArrayEnumerator(aResult, resultArray, NS_GET_IID(nsIAbCard));</span>
<a href="#l61.1256"></a><span id="l61.1256"> }</span>
<a href="#l61.1257"></a><span id="l61.1257"> </span>
<a href="#l61.1258"></a><span id="l61.1258"> NS_IMETHODIMP</span>
<a href="#l61.1259"></a><span id="l61.1259" class="difflineminus">-nsAbOSXDirectory::CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l61.1260"></a><span id="l61.1260" class="difflineminus">-                                      nsIAbCard **aResult)</span>
<a href="#l61.1261"></a><span id="l61.1261" class="difflineminus">-{</span>
<a href="#l61.1262"></a><span id="l61.1262" class="difflineplus">+nsAbOSXDirectory::CardForEmailAddress(const nsACString &amp;aEmailAddress, nsIAbCard **aResult) {</span>
<a href="#l61.1263"></a><span id="l61.1263">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l61.1264"></a><span id="l61.1264"> </span>
<a href="#l61.1265"></a><span id="l61.1265">   *aResult = nullptr;</span>
<a href="#l61.1266"></a><span id="l61.1266"> </span>
<a href="#l61.1267"></a><span id="l61.1267" class="difflineminus">-  if (aEmailAddress.IsEmpty())</span>
<a href="#l61.1268"></a><span id="l61.1268" class="difflineminus">-    return NS_OK;</span>
<a href="#l61.1269"></a><span id="l61.1269" class="difflineplus">+  if (aEmailAddress.IsEmpty()) return NS_OK;</span>
<a href="#l61.1270"></a><span id="l61.1270"> </span>
<a href="#l61.1271"></a><span id="l61.1271">   nsIMutableArray *list = m_IsMailList ? m_AddressList : mCardList;</span>
<a href="#l61.1272"></a><span id="l61.1272"> </span>
<a href="#l61.1273"></a><span id="l61.1273" class="difflineminus">-  if (!list)</span>
<a href="#l61.1274"></a><span id="l61.1274" class="difflineminus">-    return NS_OK;</span>
<a href="#l61.1275"></a><span id="l61.1275" class="difflineplus">+  if (!list) return NS_OK;</span>
<a href="#l61.1276"></a><span id="l61.1276"> </span>
<a href="#l61.1277"></a><span id="l61.1277">   uint32_t length;</span>
<a href="#l61.1278"></a><span id="l61.1278">   nsresult rv = list-&gt;GetLength(&amp;length);</span>
<a href="#l61.1279"></a><span id="l61.1279">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1280"></a><span id="l61.1280"> </span>
<a href="#l61.1281"></a><span id="l61.1281">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l61.1282"></a><span id="l61.1282"> </span>
<a href="#l61.1283"></a><span id="l61.1283" class="difflineminus">-  for (uint32_t i = 0; i &lt; length &amp;&amp; !*aResult; ++i)</span>
<a href="#l61.1284"></a><span id="l61.1284" class="difflineminus">-  {</span>
<a href="#l61.1285"></a><span id="l61.1285" class="difflineplus">+  for (uint32_t i = 0; i &lt; length &amp;&amp; !*aResult; ++i) {</span>
<a href="#l61.1286"></a><span id="l61.1286">     card = do_QueryElementAt(list, i, &amp;rv);</span>
<a href="#l61.1287"></a><span id="l61.1287" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1288"></a><span id="l61.1288" class="difflineminus">-    {</span>
<a href="#l61.1289"></a><span id="l61.1289" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1290"></a><span id="l61.1290">       bool hasEmailAddress = false;</span>
<a href="#l61.1291"></a><span id="l61.1291"> </span>
<a href="#l61.1292"></a><span id="l61.1292">       rv = card-&gt;HasEmailAddress(aEmailAddress, &amp;hasEmailAddress);</span>
<a href="#l61.1293"></a><span id="l61.1293" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; hasEmailAddress)</span>
<a href="#l61.1294"></a><span id="l61.1294" class="difflineminus">-        NS_IF_ADDREF(*aResult = card);</span>
<a href="#l61.1295"></a><span id="l61.1295" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; hasEmailAddress) NS_IF_ADDREF(*aResult = card);</span>
<a href="#l61.1296"></a><span id="l61.1296">     }</span>
<a href="#l61.1297"></a><span id="l61.1297">   }</span>
<a href="#l61.1298"></a><span id="l61.1298">   return NS_OK;</span>
<a href="#l61.1299"></a><span id="l61.1299"> }</span>
<a href="#l61.1300"></a><span id="l61.1300"> </span>
<a href="#l61.1301"></a><span id="l61.1301"> NS_IMETHODIMP</span>
<a href="#l61.1302"></a><span id="l61.1302" class="difflineminus">-nsAbOSXDirectory::HasCard(nsIAbCard *aCard, bool *aHasCard)</span>
<a href="#l61.1303"></a><span id="l61.1303" class="difflineminus">-{</span>
<a href="#l61.1304"></a><span id="l61.1304" class="difflineplus">+nsAbOSXDirectory::HasCard(nsIAbCard *aCard, bool *aHasCard) {</span>
<a href="#l61.1305"></a><span id="l61.1305">   NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l61.1306"></a><span id="l61.1306">   NS_ENSURE_ARG_POINTER(aHasCard);</span>
<a href="#l61.1307"></a><span id="l61.1307"> </span>
<a href="#l61.1308"></a><span id="l61.1308">   nsresult rv = NS_OK;</span>
<a href="#l61.1309"></a><span id="l61.1309">   uint32_t index;</span>
<a href="#l61.1310"></a><span id="l61.1310" class="difflineminus">-  if (m_IsMailList)</span>
<a href="#l61.1311"></a><span id="l61.1311" class="difflineminus">-  {</span>
<a href="#l61.1312"></a><span id="l61.1312" class="difflineminus">-    if (m_AddressList)</span>
<a href="#l61.1313"></a><span id="l61.1313" class="difflineminus">-      rv = m_AddressList-&gt;IndexOf(0, aCard, &amp;index);</span>
<a href="#l61.1314"></a><span id="l61.1314" class="difflineminus">-  }</span>
<a href="#l61.1315"></a><span id="l61.1315" class="difflineminus">-  else if (mCardList)</span>
<a href="#l61.1316"></a><span id="l61.1316" class="difflineplus">+  if (m_IsMailList) {</span>
<a href="#l61.1317"></a><span id="l61.1317" class="difflineplus">+    if (m_AddressList) rv = m_AddressList-&gt;IndexOf(0, aCard, &amp;index);</span>
<a href="#l61.1318"></a><span id="l61.1318" class="difflineplus">+  } else if (mCardList)</span>
<a href="#l61.1319"></a><span id="l61.1319">     rv = mCardList-&gt;IndexOf(0, aCard, &amp;index);</span>
<a href="#l61.1320"></a><span id="l61.1320"> </span>
<a href="#l61.1321"></a><span id="l61.1321">   *aHasCard = NS_SUCCEEDED(rv);</span>
<a href="#l61.1322"></a><span id="l61.1322"> </span>
<a href="#l61.1323"></a><span id="l61.1323">   return NS_OK;</span>
<a href="#l61.1324"></a><span id="l61.1324"> }</span>
<a href="#l61.1325"></a><span id="l61.1325"> </span>
<a href="#l61.1326"></a><span id="l61.1326"> NS_IMETHODIMP</span>
<a href="#l61.1327"></a><span id="l61.1327" class="difflineminus">-nsAbOSXDirectory::HasDirectory(nsIAbDirectory *aDirectory,</span>
<a href="#l61.1328"></a><span id="l61.1328" class="difflineminus">-                               bool *aHasDirectory)</span>
<a href="#l61.1329"></a><span id="l61.1329" class="difflineminus">-{</span>
<a href="#l61.1330"></a><span id="l61.1330" class="difflineplus">+nsAbOSXDirectory::HasDirectory(nsIAbDirectory *aDirectory, bool *aHasDirectory) {</span>
<a href="#l61.1331"></a><span id="l61.1331">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l61.1332"></a><span id="l61.1332">   NS_ENSURE_ARG_POINTER(aHasDirectory);</span>
<a href="#l61.1333"></a><span id="l61.1333"> </span>
<a href="#l61.1334"></a><span id="l61.1334">   *aHasDirectory = false;</span>
<a href="#l61.1335"></a><span id="l61.1335"> </span>
<a href="#l61.1336"></a><span id="l61.1336">   uint32_t pos;</span>
<a href="#l61.1337"></a><span id="l61.1337">   if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l61.1338"></a><span id="l61.1338">     *aHasDirectory = true;</span>
<a href="#l61.1339"></a><span id="l61.1339"> </span>
<a href="#l61.1340"></a><span id="l61.1340">   return NS_OK;</span>
<a href="#l61.1341"></a><span id="l61.1341"> }</span>
<a href="#l61.1342"></a><span id="l61.1342"> </span>
<a href="#l61.1343"></a><span id="l61.1343"> NS_IMETHODIMP</span>
<a href="#l61.1344"></a><span id="l61.1344" class="difflineminus">-nsAbOSXDirectory::OnSearchFinished(int32_t aResult, const nsAString &amp;aErrorMsg)</span>
<a href="#l61.1345"></a><span id="l61.1345" class="difflineminus">-{</span>
<a href="#l61.1346"></a><span id="l61.1346" class="difflineminus">-  return NS_OK;</span>
<a href="#l61.1347"></a><span id="l61.1347" class="difflineminus">-}</span>
<a href="#l61.1348"></a><span id="l61.1348" class="difflineplus">+nsAbOSXDirectory::OnSearchFinished(int32_t aResult, const nsAString &amp;aErrorMsg) { return NS_OK; }</span>
<a href="#l61.1349"></a><span id="l61.1349"> </span>
<a href="#l61.1350"></a><span id="l61.1350"> NS_IMETHODIMP</span>
<a href="#l61.1351"></a><span id="l61.1351" class="difflineminus">-nsAbOSXDirectory::OnSearchFoundCard(nsIAbCard *aCard)</span>
<a href="#l61.1352"></a><span id="l61.1352" class="difflineminus">-{</span>
<a href="#l61.1353"></a><span id="l61.1353" class="difflineplus">+nsAbOSXDirectory::OnSearchFoundCard(nsIAbCard *aCard) {</span>
<a href="#l61.1354"></a><span id="l61.1354">   nsresult rv;</span>
<a href="#l61.1355"></a><span id="l61.1355">   if (!m_AddressList) {</span>
<a href="#l61.1356"></a><span id="l61.1356">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.1357"></a><span id="l61.1357">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1358"></a><span id="l61.1358">   }</span>
<a href="#l61.1359"></a><span id="l61.1359"> </span>
<a href="#l61.1360"></a><span id="l61.1360">   if (!mCardList) {</span>
<a href="#l61.1361"></a><span id="l61.1361">     mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.1362"></a><span id="l61.1362" class="difflineat">@@ -1218,38 +1084,35 @@ nsAbOSXDirectory::OnSearchFoundCard(nsIA</span>
<a href="#l61.1363"></a><span id="l61.1363"> </span>
<a href="#l61.1364"></a><span id="l61.1364">   nsAutoCString ourUuid;</span>
<a href="#l61.1365"></a><span id="l61.1365">   GetUuid(ourUuid);</span>
<a href="#l61.1366"></a><span id="l61.1366">   aCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l61.1367"></a><span id="l61.1367"> </span>
<a href="#l61.1368"></a><span id="l61.1368">   return NS_OK;</span>
<a href="#l61.1369"></a><span id="l61.1369"> }</span>
<a href="#l61.1370"></a><span id="l61.1370"> </span>
<a href="#l61.1371"></a><span id="l61.1371" class="difflineminus">-nsresult</span>
<a href="#l61.1372"></a><span id="l61.1372" class="difflineminus">-nsAbOSXDirectory::FallbackSearch(nsIAbBooleanExpression *aExpression,</span>
<a href="#l61.1373"></a><span id="l61.1373" class="difflineminus">-                                 nsISimpleEnumerator **aCards)</span>
<a href="#l61.1374"></a><span id="l61.1374" class="difflineminus">-{</span>
<a href="#l61.1375"></a><span id="l61.1375" class="difflineplus">+nsresult nsAbOSXDirectory::FallbackSearch(nsIAbBooleanExpression *aExpression,</span>
<a href="#l61.1376"></a><span id="l61.1376" class="difflineplus">+                                          nsISimpleEnumerator **aCards) {</span>
<a href="#l61.1377"></a><span id="l61.1377">   nsresult rv;</span>
<a href="#l61.1378"></a><span id="l61.1378"> </span>
<a href="#l61.1379"></a><span id="l61.1379">   if (mCardList)</span>
<a href="#l61.1380"></a><span id="l61.1380">     rv = mCardList-&gt;Clear();</span>
<a href="#l61.1381"></a><span id="l61.1381">   else</span>
<a href="#l61.1382"></a><span id="l61.1382">     mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.1383"></a><span id="l61.1383">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1384"></a><span id="l61.1384"> </span>
<a href="#l61.1385"></a><span id="l61.1385">   if (m_AddressList) {</span>
<a href="#l61.1386"></a><span id="l61.1386">     m_AddressList-&gt;Clear();</span>
<a href="#l61.1387"></a><span id="l61.1387" class="difflineminus">-  }</span>
<a href="#l61.1388"></a><span id="l61.1388" class="difflineminus">-  else {</span>
<a href="#l61.1389"></a><span id="l61.1389" class="difflineplus">+  } else {</span>
<a href="#l61.1390"></a><span id="l61.1390">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.1391"></a><span id="l61.1391">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1392"></a><span id="l61.1392">   }</span>
<a href="#l61.1393"></a><span id="l61.1393"> </span>
<a href="#l61.1394"></a><span id="l61.1394">   nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments =</span>
<a href="#l61.1395"></a><span id="l61.1395" class="difflineminus">-    do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;rv);</span>
<a href="#l61.1396"></a><span id="l61.1396" class="difflineplus">+      do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;rv);</span>
<a href="#l61.1397"></a><span id="l61.1397">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1398"></a><span id="l61.1398"> </span>
<a href="#l61.1399"></a><span id="l61.1399">   rv = arguments-&gt;SetExpression(aExpression);</span>
<a href="#l61.1400"></a><span id="l61.1400">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1401"></a><span id="l61.1401"> </span>
<a href="#l61.1402"></a><span id="l61.1402">   // Don't search the subdirectories. If the current directory is a mailing</span>
<a href="#l61.1403"></a><span id="l61.1403">   // list, it won't have any subdirectories. If the current directory is an</span>
<a href="#l61.1404"></a><span id="l61.1404">   // addressbook, searching both it and the subdirectories (the mailing</span>
<a href="#l61.1405"></a><span id="l61.1405" class="difflineat">@@ -1263,37 +1126,34 @@ nsAbOSXDirectory::FallbackSearch(nsIAbBo</span>
<a href="#l61.1406"></a><span id="l61.1406">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1407"></a><span id="l61.1407"> </span>
<a href="#l61.1408"></a><span id="l61.1408">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l61.1409"></a><span id="l61.1409">   rv = abManager-&gt;GetDirectory(mURINoQuery, getter_AddRefs(directory));</span>
<a href="#l61.1410"></a><span id="l61.1410">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1411"></a><span id="l61.1411"> </span>
<a href="#l61.1412"></a><span id="l61.1412">   // Initiate the proxy query with the no query directory</span>
<a href="#l61.1413"></a><span id="l61.1413">   nsCOMPtr&lt;nsIAbDirectoryQueryProxy&gt; queryProxy =</span>
<a href="#l61.1414"></a><span id="l61.1414" class="difflineminus">-    do_CreateInstance(NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l61.1415"></a><span id="l61.1415" class="difflineplus">+      do_CreateInstance(NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l61.1416"></a><span id="l61.1416">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1417"></a><span id="l61.1417"> </span>
<a href="#l61.1418"></a><span id="l61.1418">   rv = queryProxy-&gt;Initiate();</span>
<a href="#l61.1419"></a><span id="l61.1419">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1420"></a><span id="l61.1420"> </span>
<a href="#l61.1421"></a><span id="l61.1421">   int32_t context = 0;</span>
<a href="#l61.1422"></a><span id="l61.1422">   rv = queryProxy-&gt;DoQuery(directory, arguments, this, -1, 0, &amp;context);</span>
<a href="#l61.1423"></a><span id="l61.1423">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1424"></a><span id="l61.1424"> </span>
<a href="#l61.1425"></a><span id="l61.1425">   return NS_NewArrayEnumerator(aCards, m_AddressList, NS_GET_IID(nsIAbDirectory));</span>
<a href="#l61.1426"></a><span id="l61.1426"> }</span>
<a href="#l61.1427"></a><span id="l61.1427"> </span>
<a href="#l61.1428"></a><span id="l61.1428" class="difflineminus">-nsresult nsAbOSXDirectory::DeleteUid(const nsACString &amp;aUid)</span>
<a href="#l61.1429"></a><span id="l61.1429" class="difflineminus">-{</span>
<a href="#l61.1430"></a><span id="l61.1430" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l61.1431"></a><span id="l61.1431" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l61.1432"></a><span id="l61.1432" class="difflineplus">+nsresult nsAbOSXDirectory::DeleteUid(const nsACString &amp;aUid) {</span>
<a href="#l61.1433"></a><span id="l61.1433" class="difflineplus">+  if (!m_AddressList) return NS_ERROR_NULL_POINTER;</span>
<a href="#l61.1434"></a><span id="l61.1434"> </span>
<a href="#l61.1435"></a><span id="l61.1435">   nsresult rv;</span>
<a href="#l61.1436"></a><span id="l61.1436" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l61.1437"></a><span id="l61.1437" class="difflineminus">-    do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.1438"></a><span id="l61.1438" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l61.1439"></a><span id="l61.1439">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1440"></a><span id="l61.1440"> </span>
<a href="#l61.1441"></a><span id="l61.1441">   // At this stage we don't know if aUid represents a card or group. The OS X</span>
<a href="#l61.1442"></a><span id="l61.1442">   // interfaces don't give us chance to find out, so we have to go through</span>
<a href="#l61.1443"></a><span id="l61.1443">   // our lists to find it.</span>
<a href="#l61.1444"></a><span id="l61.1444"> </span>
<a href="#l61.1445"></a><span id="l61.1445">   // First, we'll see if its in the group list as it is likely to be shorter.</span>
<a href="#l61.1446"></a><span id="l61.1446"> </span>
<a href="#l61.1447"></a><span id="l61.1447" class="difflineat">@@ -1301,65 +1161,53 @@ nsresult nsAbOSXDirectory::DeleteUid(con</span>
<a href="#l61.1448"></a><span id="l61.1448">   uint32_t addressCount;</span>
<a href="#l61.1449"></a><span id="l61.1449">   rv = m_AddressList-&gt;GetLength(&amp;addressCount);</span>
<a href="#l61.1450"></a><span id="l61.1450">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1451"></a><span id="l61.1451"> </span>
<a href="#l61.1452"></a><span id="l61.1452">   nsAutoCString uri(NS_ABOSXDIRECTORY_URI_PREFIX);</span>
<a href="#l61.1453"></a><span id="l61.1453">   uri.Append(aUid);</span>
<a href="#l61.1454"></a><span id="l61.1454"> </span>
<a href="#l61.1455"></a><span id="l61.1455">   // Iterate backwards in case we remove something</span>
<a href="#l61.1456"></a><span id="l61.1456" class="difflineminus">-  while (addressCount--)</span>
<a href="#l61.1457"></a><span id="l61.1457" class="difflineminus">-  {</span>
<a href="#l61.1458"></a><span id="l61.1458" class="difflineminus">-    nsCOMPtr&lt;nsIAbItem&gt; abItem(do_QueryElementAt(m_AddressList,</span>
<a href="#l61.1459"></a><span id="l61.1459" class="difflineminus">-                                                 addressCount, &amp;rv));</span>
<a href="#l61.1460"></a><span id="l61.1460" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l61.1461"></a><span id="l61.1461" class="difflineminus">-      continue;</span>
<a href="#l61.1462"></a><span id="l61.1462" class="difflineplus">+  while (addressCount--) {</span>
<a href="#l61.1463"></a><span id="l61.1463" class="difflineplus">+    nsCOMPtr&lt;nsIAbItem&gt; abItem(do_QueryElementAt(m_AddressList, addressCount, &amp;rv));</span>
<a href="#l61.1464"></a><span id="l61.1464" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l61.1465"></a><span id="l61.1465"> </span>
<a href="#l61.1466"></a><span id="l61.1466">     nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(abItem, &amp;rv));</span>
<a href="#l61.1467"></a><span id="l61.1467" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1468"></a><span id="l61.1468" class="difflineminus">-    {</span>
<a href="#l61.1469"></a><span id="l61.1469" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1470"></a><span id="l61.1470">       nsAutoCString dirUri;</span>
<a href="#l61.1471"></a><span id="l61.1471">       directory-&gt;GetURI(dirUri);</span>
<a href="#l61.1472"></a><span id="l61.1472" class="difflineminus">-      if (uri.Equals(dirUri))</span>
<a href="#l61.1473"></a><span id="l61.1473" class="difflineminus">-        return UnassertDirectory(abManager, directory);</span>
<a href="#l61.1474"></a><span id="l61.1474" class="difflineplus">+      if (uri.Equals(dirUri)) return UnassertDirectory(abManager, directory);</span>
<a href="#l61.1475"></a><span id="l61.1475">     } else {</span>
<a href="#l61.1476"></a><span id="l61.1476">       nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard(do_QueryInterface(abItem, &amp;rv));</span>
<a href="#l61.1477"></a><span id="l61.1477" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1478"></a><span id="l61.1478" class="difflineminus">-      {</span>
<a href="#l61.1479"></a><span id="l61.1479" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l61.1480"></a><span id="l61.1480">         nsAutoCString cardUri;</span>
<a href="#l61.1481"></a><span id="l61.1481">         osxCard-&gt;GetURI(cardUri);</span>
<a href="#l61.1482"></a><span id="l61.1482" class="difflineminus">-        if (uri.Equals(cardUri))</span>
<a href="#l61.1483"></a><span id="l61.1483" class="difflineminus">-        {</span>
<a href="#l61.1484"></a><span id="l61.1484" class="difflineplus">+        if (uri.Equals(cardUri)) {</span>
<a href="#l61.1485"></a><span id="l61.1485">           nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(osxCard, &amp;rv));</span>
<a href="#l61.1486"></a><span id="l61.1486" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1487"></a><span id="l61.1487" class="difflineminus">-            return UnassertCard(abManager, card, m_AddressList);</span>
<a href="#l61.1488"></a><span id="l61.1488" class="difflineplus">+          if (NS_SUCCEEDED(rv)) return UnassertCard(abManager, card, m_AddressList);</span>
<a href="#l61.1489"></a><span id="l61.1489">         }</span>
<a href="#l61.1490"></a><span id="l61.1490">       }</span>
<a href="#l61.1491"></a><span id="l61.1491">     }</span>
<a href="#l61.1492"></a><span id="l61.1492">   }</span>
<a href="#l61.1493"></a><span id="l61.1493"> </span>
<a href="#l61.1494"></a><span id="l61.1494">   // Second, see if it is one of the cards.</span>
<a href="#l61.1495"></a><span id="l61.1495" class="difflineminus">-  if (!mCardList)</span>
<a href="#l61.1496"></a><span id="l61.1496" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l61.1497"></a><span id="l61.1497" class="difflineplus">+  if (!mCardList) return NS_ERROR_FAILURE;</span>
<a href="#l61.1498"></a><span id="l61.1498"> </span>
<a href="#l61.1499"></a><span id="l61.1499">   uri = NS_ABOSXCARD_URI_PREFIX;</span>
<a href="#l61.1500"></a><span id="l61.1500">   uri.Append(aUid);</span>
<a href="#l61.1501"></a><span id="l61.1501"> </span>
<a href="#l61.1502"></a><span id="l61.1502">   rv = mCardList-&gt;GetLength(&amp;addressCount);</span>
<a href="#l61.1503"></a><span id="l61.1503">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.1504"></a><span id="l61.1504"> </span>
<a href="#l61.1505"></a><span id="l61.1505" class="difflineminus">-  while (addressCount--)</span>
<a href="#l61.1506"></a><span id="l61.1506" class="difflineminus">-  {</span>
<a href="#l61.1507"></a><span id="l61.1507" class="difflineplus">+  while (addressCount--) {</span>
<a href="#l61.1508"></a><span id="l61.1508">     nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard(do_QueryElementAt(mCardList, addressCount, &amp;rv));</span>
<a href="#l61.1509"></a><span id="l61.1509" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l61.1510"></a><span id="l61.1510" class="difflineminus">-      continue;</span>
<a href="#l61.1511"></a><span id="l61.1511" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l61.1512"></a><span id="l61.1512"> </span>
<a href="#l61.1513"></a><span id="l61.1513">     nsAutoCString cardUri;</span>
<a href="#l61.1514"></a><span id="l61.1514">     osxCard-&gt;GetURI(cardUri);</span>
<a href="#l61.1515"></a><span id="l61.1515"> </span>
<a href="#l61.1516"></a><span id="l61.1516">     if (uri.Equals(cardUri)) {</span>
<a href="#l61.1517"></a><span id="l61.1517">       nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(osxCard, &amp;rv));</span>
<a href="#l61.1518"></a><span id="l61.1518" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l61.1519"></a><span id="l61.1519" class="difflineminus">-        return UnassertCard(abManager, card, mCardList);</span>
<a href="#l61.1520"></a><span id="l61.1520" class="difflineplus">+      if (NS_SUCCEEDED(rv)) return UnassertCard(abManager, card, mCardList);</span>
<a href="#l61.1521"></a><span id="l61.1521">     }</span>
<a href="#l61.1522"></a><span id="l61.1522">   }</span>
<a href="#l61.1523"></a><span id="l61.1523">   return NS_OK;</span>
<a href="#l61.1524"></a><span id="l61.1524"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXUtils.h</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXUtils.h</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -9,24 +9,22 @@</span>
<a href="#l62.4"></a><span id="l62.4"> #include &lt;Foundation/NSString.h&gt;</span>
<a href="#l62.5"></a><span id="l62.5"> #include &quot;nsString.h&quot;</span>
<a href="#l62.6"></a><span id="l62.6"> </span>
<a href="#l62.7"></a><span id="l62.7"> NSString *WrapString(const nsString &amp;aString);</span>
<a href="#l62.8"></a><span id="l62.8"> void AppendToString(const NSString *aString, nsString &amp;aResult);</span>
<a href="#l62.9"></a><span id="l62.9"> void AssignToString(const NSString *aString, nsString &amp;aResult);</span>
<a href="#l62.10"></a><span id="l62.10"> void AppendToCString(const NSString *aString, nsCString &amp;aResult);</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-struct nsAbOSXPropertyMap</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineminus">-{</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineminus">-    NSString * const mOSXProperty;</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineminus">-    NSString * const mOSXLabel;</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineminus">-    NSString * const mOSXKey;</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineminus">-    const char *mPropertyName;</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineplus">+struct nsAbOSXPropertyMap {</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+  NSString *const mOSXProperty;</span>
<a href="#l62.20"></a><span id="l62.20" class="difflineplus">+  NSString *const mOSXLabel;</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineplus">+  NSString *const mOSXKey;</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineplus">+  const char *mPropertyName;</span>
<a href="#l62.23"></a><span id="l62.23"> };</span>
<a href="#l62.24"></a><span id="l62.24"> </span>
<a href="#l62.25"></a><span id="l62.25" class="difflineminus">-class nsAbOSXUtils</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineminus">-{</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineminus">-public:</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineminus">-    static const nsAbOSXPropertyMap kPropertyMap[];</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineminus">-    static const uint32_t kPropertyMapSize;</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+class nsAbOSXUtils {</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+ public:</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+  static const nsAbOSXPropertyMap kPropertyMap[];</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+  static const uint32_t kPropertyMapSize;</span>
<a href="#l62.34"></a><span id="l62.34"> };</span>
<a href="#l62.35"></a><span id="l62.35"> </span>
<a href="#l62.36"></a><span id="l62.36" class="difflineminus">-#endif // nsAbOSXUtils_h___</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+#endif  // nsAbOSXUtils_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXUtils.mm</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXUtils.mm</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -8,63 +8,54 @@</span>
<a href="#l63.4"></a><span id="l63.4"> #include &quot;nsAbOSXCard.h&quot;</span>
<a href="#l63.5"></a><span id="l63.5"> #include &quot;nsMemory.h&quot;</span>
<a href="#l63.6"></a><span id="l63.6"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l63.7"></a><span id="l63.7"> using namespace mozilla;</span>
<a href="#l63.8"></a><span id="l63.8"> </span>
<a href="#l63.9"></a><span id="l63.9"> #include &lt;AddressBook/AddressBook.h&gt;</span>
<a href="#l63.10"></a><span id="l63.10"> #define kABDepartmentProperty (kABDepartmentProperty ? kABDepartmentProperty : @&quot;ABDepartment&quot;)</span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-NSString*</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-WrapString(const nsString &amp;aString)</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineminus">-{</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineminus">-    unichar* chars = reinterpret_cast&lt;unichar*&gt;(const_cast&lt;char16_t*&gt;(aString.get()));</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineplus">+NSString *WrapString(const nsString &amp;aString) {</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineplus">+  unichar *chars = reinterpret_cast&lt;unichar *&gt;(const_cast&lt;char16_t *&gt;(aString.get()));</span>
<a href="#l63.18"></a><span id="l63.18"> </span>
<a href="#l63.19"></a><span id="l63.19" class="difflineminus">-    return [NSString stringWithCharacters:chars</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineminus">-                                   length:aString.Length()];</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineplus">+  return [NSString stringWithCharacters:chars length:aString.Length()];</span>
<a href="#l63.22"></a><span id="l63.22"> }</span>
<a href="#l63.23"></a><span id="l63.23"> </span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-void</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineminus">-AppendToString(const NSString *aString, nsString &amp;aResult)</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineminus">-{</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineminus">-    if (aString) {</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineminus">-        const char *chars = [aString UTF8String];</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineminus">-        if (chars) {</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineminus">-            aResult.Append(NS_ConvertUTF8toUTF16(chars));</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-        }</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+void AppendToString(const NSString *aString, nsString &amp;aResult) {</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+  if (aString) {</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineplus">+    const char *chars = [aString UTF8String];</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineplus">+    if (chars) {</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+      aResult.Append(NS_ConvertUTF8toUTF16(chars));</span>
<a href="#l63.37"></a><span id="l63.37">     }</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineplus">+  }</span>
<a href="#l63.39"></a><span id="l63.39"> }</span>
<a href="#l63.40"></a><span id="l63.40"> </span>
<a href="#l63.41"></a><span id="l63.41" class="difflineminus">-void</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-AssignToString(const NSString *aString, nsString &amp;aResult)</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineminus">-{</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineminus">-    if (aString) {</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineminus">-        const char *chars = [aString UTF8String];</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineminus">-        if (chars)</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineminus">-          CopyUTF8toUTF16(nsDependentCString(chars), aResult);</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineminus">-    }</span>
<a href="#l63.49"></a><span id="l63.49" class="difflineplus">+void AssignToString(const NSString *aString, nsString &amp;aResult) {</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineplus">+  if (aString) {</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineplus">+    const char *chars = [aString UTF8String];</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineplus">+    if (chars) CopyUTF8toUTF16(nsDependentCString(chars), aResult);</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineplus">+  }</span>
<a href="#l63.54"></a><span id="l63.54"> }</span>
<a href="#l63.55"></a><span id="l63.55"> </span>
<a href="#l63.56"></a><span id="l63.56" class="difflineminus">-void</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineminus">-AppendToCString(const NSString *aString, nsCString &amp;aResult)</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineminus">-{</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineminus">-    if (aString) {</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineminus">-        const char *chars = [aString UTF8String];</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineminus">-        if (chars) {</span>
<a href="#l63.62"></a><span id="l63.62" class="difflineminus">-            aResult.Append(chars);</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineminus">-        }</span>
<a href="#l63.64"></a><span id="l63.64" class="difflineplus">+void AppendToCString(const NSString *aString, nsCString &amp;aResult) {</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineplus">+  if (aString) {</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineplus">+    const char *chars = [aString UTF8String];</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineplus">+    if (chars) {</span>
<a href="#l63.68"></a><span id="l63.68" class="difflineplus">+      aResult.Append(chars);</span>
<a href="#l63.69"></a><span id="l63.69">     }</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineplus">+  }</span>
<a href="#l63.71"></a><span id="l63.71"> }</span>
<a href="#l63.72"></a><span id="l63.72"> </span>
<a href="#l63.73"></a><span id="l63.73"> // Some properties can't be easily mapped back and forth.</span>
<a href="#l63.74"></a><span id="l63.74"> #define DONT_MAP(moz_name, osx_property, osx_label, osx_key)</span>
<a href="#l63.75"></a><span id="l63.75"> </span>
<a href="#l63.76"></a><span id="l63.76"> #define DEFINE_PROPERTY(moz_name, osx_property, osx_label, osx_key) \</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineminus">-    { osx_property, osx_label, osx_key, #moz_name },</span>
<a href="#l63.78"></a><span id="l63.78" class="difflineplus">+  {osx_property, osx_label, osx_key, #moz_name},</span>
<a href="#l63.79"></a><span id="l63.79"> </span>
<a href="#l63.80"></a><span id="l63.80" class="difflineplus">+// clang-format off</span>
<a href="#l63.81"></a><span id="l63.81"> const nsAbOSXPropertyMap nsAbOSXUtils::kPropertyMap[] = {</span>
<a href="#l63.82"></a><span id="l63.82">     DEFINE_PROPERTY(FirstName, kABFirstNameProperty, nil, nil)</span>
<a href="#l63.83"></a><span id="l63.83">     DEFINE_PROPERTY(LastName, kABLastNameProperty, nil, nil)</span>
<a href="#l63.84"></a><span id="l63.84">     DONT_MAP(&quot;DisplayName&quot;, nil, nil, nil)</span>
<a href="#l63.85"></a><span id="l63.85">     DEFINE_PROPERTY(PhoneticFirstName, kABFirstNamePhoneticProperty, nil, nil)</span>
<a href="#l63.86"></a><span id="l63.86">     DEFINE_PROPERTY(PhoneticLastName, kABLastNamePhoneticProperty, nil, nil)</span>
<a href="#l63.87"></a><span id="l63.87">     DEFINE_PROPERTY(NickName, kABNicknameProperty, nil, nil)</span>
<a href="#l63.88"></a><span id="l63.88">     DONT_MAP(PrimaryEmail, kABEmailProperty, nil, nil)</span>
<a href="#l63.89"></a><span id="l63.89" class="difflineat">@@ -107,11 +98,11 @@ const nsAbOSXPropertyMap nsAbOSXUtils::k</span>
<a href="#l63.90"></a><span id="l63.90">     DONT_MAP(Custom1, &quot;custom1&quot;, nil, nil)</span>
<a href="#l63.91"></a><span id="l63.91">     DONT_MAP(Custom2, &quot;custom2&quot;, nil, nil)</span>
<a href="#l63.92"></a><span id="l63.92">     DONT_MAP(Custom3, &quot;custom3&quot;, nil, nil)</span>
<a href="#l63.93"></a><span id="l63.93">     DONT_MAP(Custom4, &quot;custom4&quot;, nil, nil)</span>
<a href="#l63.94"></a><span id="l63.94">     DEFINE_PROPERTY(Note, kABNoteProperty, nil, nil)</span>
<a href="#l63.95"></a><span id="l63.95">     DONT_MAP(&quot;PreferMailFormat&quot;, nil, nil, nil)</span>
<a href="#l63.96"></a><span id="l63.96">     DONT_MAP(&quot;LastModifiedDate&quot;, modifytimestamp, nil, nil)</span>
<a href="#l63.97"></a><span id="l63.97"> };</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineplus">+// clang-format on</span>
<a href="#l63.99"></a><span id="l63.99"> </span>
<a href="#l63.100"></a><span id="l63.100" class="difflineminus">-const uint32_t nsAbOSXUtils::kPropertyMapSize =</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineminus">-    ArrayLength(nsAbOSXUtils::kPropertyMap);</span>
<a href="#l63.102"></a><span id="l63.102" class="difflineplus">+const uint32_t nsAbOSXUtils::kPropertyMapSize = ArrayLength(nsAbOSXUtils::kPropertyMap);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -11,40 +11,35 @@</span>
<a href="#l64.4"></a><span id="l64.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l64.5"></a><span id="l64.5"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l64.6"></a><span id="l64.6"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l64.7"></a><span id="l64.7"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l64.8"></a><span id="l64.8"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l64.9"></a><span id="l64.9"> </span>
<a href="#l64.10"></a><span id="l64.10"> NS_IMPL_ISUPPORTS(nsAbOutlookDirFactory, nsIAbDirFactory)</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-nsAbOutlookDirFactory::nsAbOutlookDirFactory(void)</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-{</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineminus">-}</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+nsAbOutlookDirFactory::nsAbOutlookDirFactory(void) {}</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17" class="difflineminus">-nsAbOutlookDirFactory::~nsAbOutlookDirFactory(void)</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineminus">-{</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineminus">-}</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+nsAbOutlookDirFactory::~nsAbOutlookDirFactory(void) {}</span>
<a href="#l64.21"></a><span id="l64.21"> </span>
<a href="#l64.22"></a><span id="l64.22"> extern const char *kOutlookDirectoryScheme;</span>
<a href="#l64.23"></a><span id="l64.23"> </span>
<a href="#l64.24"></a><span id="l64.24"> NS_IMETHODIMP</span>
<a href="#l64.25"></a><span id="l64.25"> nsAbOutlookDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l64.26"></a><span id="l64.26">                                       const nsACString &amp;aURI,</span>
<a href="#l64.27"></a><span id="l64.27">                                       const nsACString &amp;aPrefName,</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineminus">-                                      nsISimpleEnumerator **aDirectories)</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineminus">-{</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+                                      nsISimpleEnumerator **aDirectories) {</span>
<a href="#l64.31"></a><span id="l64.31">   NS_ENSURE_ARG_POINTER(aDirectories);</span>
<a href="#l64.32"></a><span id="l64.32"> </span>
<a href="#l64.33"></a><span id="l64.33">   *aDirectories = nullptr;</span>
<a href="#l64.34"></a><span id="l64.34">   nsresult rv = NS_OK;</span>
<a href="#l64.35"></a><span id="l64.35">   nsCString stub;</span>
<a href="#l64.36"></a><span id="l64.36">   nsCString entry;</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineminus">-  nsAbWinType abType = getAbWinType(kOutlookDirectoryScheme,</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineminus">-                                    nsCString(aURI).get(), stub, entry);</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+  nsAbWinType abType =</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+      getAbWinType(kOutlookDirectoryScheme, nsCString(aURI).get(), stub, entry);</span>
<a href="#l64.41"></a><span id="l64.41"> </span>
<a href="#l64.42"></a><span id="l64.42">   if (abType == nsAbWinType_Unknown) {</span>
<a href="#l64.43"></a><span id="l64.43">     return NS_ERROR_FAILURE;</span>
<a href="#l64.44"></a><span id="l64.44">   }</span>
<a href="#l64.45"></a><span id="l64.45">   nsAbWinHelperGuard mapiAddBook(abType);</span>
<a href="#l64.46"></a><span id="l64.46">   nsMapiEntryArray folders;</span>
<a href="#l64.47"></a><span id="l64.47">   nsCOMPtr&lt;nsIMutableArray&gt; directories(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l64.48"></a><span id="l64.48">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineat">@@ -62,17 +57,17 @@ nsAbOutlookDirFactory::GetDirectories(co</span>
<a href="#l64.50"></a><span id="l64.50">     buildAbWinUri(kOutlookDirectoryScheme, abType, uri);</span>
<a href="#l64.51"></a><span id="l64.51">     uri.Append(entryId);</span>
<a href="#l64.52"></a><span id="l64.52"> </span>
<a href="#l64.53"></a><span id="l64.53">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l64.54"></a><span id="l64.54">     rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(directory));</span>
<a href="#l64.55"></a><span id="l64.55">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.56"></a><span id="l64.56">     directories-&gt;AppendElement(directory);</span>
<a href="#l64.57"></a><span id="l64.57">   }</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineminus">-  return NS_NewArrayEnumerator(aDirectories, directories, NS_GET_IID(nsIAbDirectory));</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+  return NS_NewArrayEnumerator(aDirectories, directories,</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineplus">+                               NS_GET_IID(nsIAbDirectory));</span>
<a href="#l64.61"></a><span id="l64.61"> }</span>
<a href="#l64.62"></a><span id="l64.62"> </span>
<a href="#l64.63"></a><span id="l64.63"> // No actual deletion, since you cannot create the address books from Mozilla.</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirFactory::DeleteDirectory(nsIAbDirectory *aDirectory)</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineminus">-{</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirFactory::DeleteDirectory(</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineplus">+    nsIAbDirectory *aDirectory) {</span>
<a href="#l64.68"></a><span id="l64.68">   return NS_OK;</span>
<a href="#l64.69"></a><span id="l64.69"> }</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirFactory.h</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirFactory.h</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -2,21 +2,20 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l65.5"></a><span id="l65.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l65.6"></a><span id="l65.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l65.7"></a><span id="l65.7"> #ifndef nsAbOutlookDirFactory_h___</span>
<a href="#l65.8"></a><span id="l65.8"> #define nsAbOutlookDirFactory_h___</span>
<a href="#l65.9"></a><span id="l65.9"> </span>
<a href="#l65.10"></a><span id="l65.10"> #include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-class nsAbOutlookDirFactory : public nsIAbDirFactory</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-{</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineminus">-public:</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineminus">-    nsAbOutlookDirFactory(void);</span>
<a href="#l65.16"></a><span id="l65.16" class="difflineplus">+class nsAbOutlookDirFactory : public nsIAbDirFactory {</span>
<a href="#l65.17"></a><span id="l65.17" class="difflineplus">+ public:</span>
<a href="#l65.18"></a><span id="l65.18" class="difflineplus">+  nsAbOutlookDirFactory(void);</span>
<a href="#l65.19"></a><span id="l65.19"> </span>
<a href="#l65.20"></a><span id="l65.20" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineminus">-    NS_DECL_NSIABDIRFACTORY</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+  NS_DECL_NSIABDIRFACTORY</span>
<a href="#l65.24"></a><span id="l65.24"> </span>
<a href="#l65.25"></a><span id="l65.25" class="difflineminus">-private:</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineminus">-    virtual ~nsAbOutlookDirFactory(void);</span>
<a href="#l65.27"></a><span id="l65.27" class="difflineplus">+ private:</span>
<a href="#l65.28"></a><span id="l65.28" class="difflineplus">+  virtual ~nsAbOutlookDirFactory(void);</span>
<a href="#l65.29"></a><span id="l65.29"> };</span>
<a href="#l65.30"></a><span id="l65.30"> </span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-#endif // nsAbOutlookDirFactory_h___</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+#endif  // nsAbOutlookDirFactory_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -22,475 +22,454 @@</span>
<a href="#l66.4"></a><span id="l66.4"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l66.5"></a><span id="l66.5"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l66.6"></a><span id="l66.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l66.7"></a><span id="l66.7"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l66.8"></a><span id="l66.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l66.9"></a><span id="l66.9"> </span>
<a href="#l66.10"></a><span id="l66.10"> static mozilla::LazyLogModule gAbOutlookDirectoryLog(&quot;AbOutlookDirectory&quot;);</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-#define PRINTF(args) MOZ_LOG(gAbOutlookDirectoryLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+#define PRINTF(args) \</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+  MOZ_LOG(gAbOutlookDirectoryLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l66.15"></a><span id="l66.15"> </span>
<a href="#l66.16"></a><span id="l66.16"> nsAbOutlookDirectory::nsAbOutlookDirectory(void)</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineminus">-  : nsAbDirProperty()</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineminus">-  , mMapiData(nullptr)</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineminus">-  , mCurrentQueryId(0)</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineminus">-  , mSearchContext(-1)</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineminus">-  , mAbWinType(nsAbWinType_Unknown)</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineminus">-{</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineminus">-    mMapiData = new nsMapiEntry ;</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineminus">-    mProtector = PR_NewLock() ;</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineplus">+    : nsAbDirProperty(),</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+      mMapiData(nullptr),</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+      mCurrentQueryId(0),</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+      mSearchContext(-1),</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineplus">+      mAbWinType(nsAbWinType_Unknown) {</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+  mMapiData = new nsMapiEntry;</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+  mProtector = PR_NewLock();</span>
<a href="#l66.32"></a><span id="l66.32"> }</span>
<a href="#l66.33"></a><span id="l66.33"> </span>
<a href="#l66.34"></a><span id="l66.34" class="difflineminus">-nsAbOutlookDirectory::~nsAbOutlookDirectory(void)</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineminus">-{</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineminus">-    if (mMapiData) { delete mMapiData ; }</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineminus">-    if (mProtector) { PR_DestroyLock(mProtector) ; }</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineplus">+nsAbOutlookDirectory::~nsAbOutlookDirectory(void) {</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineplus">+  if (mMapiData) {</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineplus">+    delete mMapiData;</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineplus">+  }</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineplus">+  if (mProtector) {</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+    PR_DestroyLock(mProtector);</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+  }</span>
<a href="#l66.45"></a><span id="l66.45"> }</span>
<a href="#l66.46"></a><span id="l66.46"> </span>
<a href="#l66.47"></a><span id="l66.47"> NS_IMPL_ISUPPORTS_INHERITED(nsAbOutlookDirectory, nsAbDirProperty,</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineminus">-                             nsIAbDirectoryQuery, nsIAbDirectorySearch,</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineminus">-                             nsIAbDirSearchListener)</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineplus">+                            nsIAbDirectoryQuery, nsIAbDirectorySearch,</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+                            nsIAbDirSearchListener)</span>
<a href="#l66.52"></a><span id="l66.52"> </span>
<a href="#l66.53"></a><span id="l66.53" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::Init(const char *aUri)</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineminus">-{</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::Init(const char *aUri) {</span>
<a href="#l66.56"></a><span id="l66.56">   nsresult rv = nsAbDirProperty::Init(aUri);</span>
<a href="#l66.57"></a><span id="l66.57">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.58"></a><span id="l66.58"> </span>
<a href="#l66.59"></a><span id="l66.59">   nsAutoCString entry;</span>
<a href="#l66.60"></a><span id="l66.60">   nsAutoCString stub;</span>
<a href="#l66.61"></a><span id="l66.61"> </span>
<a href="#l66.62"></a><span id="l66.62" class="difflineminus">-  mAbWinType = getAbWinType(kOutlookDirectoryScheme, mURINoQuery.get(), stub, entry);</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineplus">+  mAbWinType =</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineplus">+      getAbWinType(kOutlookDirectoryScheme, mURINoQuery.get(), stub, entry);</span>
<a href="#l66.65"></a><span id="l66.65">   if (mAbWinType == nsAbWinType_Unknown) {</span>
<a href="#l66.66"></a><span id="l66.66">     PRINTF((&quot;Huge problem URI=%s.\n&quot;, mURINoQuery.get()));</span>
<a href="#l66.67"></a><span id="l66.67">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l66.68"></a><span id="l66.68">   }</span>
<a href="#l66.69"></a><span id="l66.69" class="difflineminus">-  nsAbWinHelperGuard mapiAddBook (mAbWinType);</span>
<a href="#l66.70"></a><span id="l66.70" class="difflineplus">+  nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.71"></a><span id="l66.71">   nsString prefix;</span>
<a href="#l66.72"></a><span id="l66.72">   nsAutoString unichars;</span>
<a href="#l66.73"></a><span id="l66.73">   ULONG objectType = 0;</span>
<a href="#l66.74"></a><span id="l66.74"> </span>
<a href="#l66.75"></a><span id="l66.75" class="difflineminus">-  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l66.76"></a><span id="l66.76" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l66.77"></a><span id="l66.77" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) return NS_ERROR_FAILURE;</span>
<a href="#l66.78"></a><span id="l66.78"> </span>
<a href="#l66.79"></a><span id="l66.79">   mMapiData-&gt;Assign(entry);</span>
<a href="#l66.80"></a><span id="l66.80">   if (!mapiAddBook-&gt;GetPropertyLong(*mMapiData, PR_OBJECT_TYPE, objectType)) {</span>
<a href="#l66.81"></a><span id="l66.81">     PRINTF((&quot;Cannot get type.\n&quot;));</span>
<a href="#l66.82"></a><span id="l66.82">     return NS_ERROR_FAILURE;</span>
<a href="#l66.83"></a><span id="l66.83">   }</span>
<a href="#l66.84"></a><span id="l66.84" class="difflineminus">-  if (!mapiAddBook-&gt;GetPropertyUString(*mMapiData, PR_DISPLAY_NAME_W, unichars)) {</span>
<a href="#l66.85"></a><span id="l66.85" class="difflineplus">+  if (!mapiAddBook-&gt;GetPropertyUString(*mMapiData, PR_DISPLAY_NAME_W,</span>
<a href="#l66.86"></a><span id="l66.86" class="difflineplus">+                                       unichars)) {</span>
<a href="#l66.87"></a><span id="l66.87">     PRINTF((&quot;Cannot get name.\n&quot;));</span>
<a href="#l66.88"></a><span id="l66.88">     return NS_ERROR_FAILURE;</span>
<a href="#l66.89"></a><span id="l66.89">   }</span>
<a href="#l66.90"></a><span id="l66.90"> </span>
<a href="#l66.91"></a><span id="l66.91">   if (mAbWinType == nsAbWinType_Outlook)</span>
<a href="#l66.92"></a><span id="l66.92">     prefix.AssignLiteral(&quot;OP &quot;);</span>
<a href="#l66.93"></a><span id="l66.93">   else</span>
<a href="#l66.94"></a><span id="l66.94">     prefix.AssignLiteral(&quot;OE &quot;);</span>
<a href="#l66.95"></a><span id="l66.95">   prefix.Append(unichars);</span>
<a href="#l66.96"></a><span id="l66.96"> </span>
<a href="#l66.97"></a><span id="l66.97">   if (objectType == MAPI_DISTLIST) {</span>
<a href="#l66.98"></a><span id="l66.98">     m_IsMailList = true;</span>
<a href="#l66.99"></a><span id="l66.99">     SetDirName(unichars);</span>
<a href="#l66.100"></a><span id="l66.100" class="difflineminus">-  }</span>
<a href="#l66.101"></a><span id="l66.101" class="difflineminus">-  else {</span>
<a href="#l66.102"></a><span id="l66.102" class="difflineplus">+  } else {</span>
<a href="#l66.103"></a><span id="l66.103">     m_IsMailList = false;</span>
<a href="#l66.104"></a><span id="l66.104">     SetDirName(prefix);</span>
<a href="#l66.105"></a><span id="l66.105">   }</span>
<a href="#l66.106"></a><span id="l66.106"> </span>
<a href="#l66.107"></a><span id="l66.107">   return UpdateAddressList();</span>
<a href="#l66.108"></a><span id="l66.108"> }</span>
<a href="#l66.109"></a><span id="l66.109"> </span>
<a href="#l66.110"></a><span id="l66.110"> // nsIAbDirectory methods</span>
<a href="#l66.111"></a><span id="l66.111"> </span>
<a href="#l66.112"></a><span id="l66.112" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::GetDirType(int32_t *aDirType)</span>
<a href="#l66.113"></a><span id="l66.113" class="difflineminus">-{</span>
<a href="#l66.114"></a><span id="l66.114" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::GetDirType(int32_t *aDirType) {</span>
<a href="#l66.115"></a><span id="l66.115">   NS_ENSURE_ARG_POINTER(aDirType);</span>
<a href="#l66.116"></a><span id="l66.116">   *aDirType = MAPIDirectory;</span>
<a href="#l66.117"></a><span id="l66.117">   return NS_OK;</span>
<a href="#l66.118"></a><span id="l66.118"> }</span>
<a href="#l66.119"></a><span id="l66.119"> </span>
<a href="#l66.120"></a><span id="l66.120" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l66.121"></a><span id="l66.121" class="difflineminus">-{</span>
<a href="#l66.122"></a><span id="l66.122" class="difflineminus">-  if (mURI.IsEmpty())</span>
<a href="#l66.123"></a><span id="l66.123" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l66.124"></a><span id="l66.124" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::GetURI(nsACString &amp;aURI) {</span>
<a href="#l66.125"></a><span id="l66.125" class="difflineplus">+  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l66.126"></a><span id="l66.126"> </span>
<a href="#l66.127"></a><span id="l66.127">   aURI = mURI;</span>
<a href="#l66.128"></a><span id="l66.128">   return NS_OK;</span>
<a href="#l66.129"></a><span id="l66.129"> }</span>
<a href="#l66.130"></a><span id="l66.130"> </span>
<a href="#l66.131"></a><span id="l66.131" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::GetChildNodes(nsISimpleEnumerator **aNodes)</span>
<a href="#l66.132"></a><span id="l66.132" class="difflineminus">-{</span>
<a href="#l66.133"></a><span id="l66.133" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::GetChildNodes(</span>
<a href="#l66.134"></a><span id="l66.134" class="difflineplus">+    nsISimpleEnumerator **aNodes) {</span>
<a href="#l66.135"></a><span id="l66.135">   NS_ENSURE_ARG_POINTER(aNodes);</span>
<a href="#l66.136"></a><span id="l66.136"> </span>
<a href="#l66.137"></a><span id="l66.137">   *aNodes = nullptr;</span>
<a href="#l66.138"></a><span id="l66.138"> </span>
<a href="#l66.139"></a><span id="l66.139">   if (mIsQueryURI) {</span>
<a href="#l66.140"></a><span id="l66.140">     return NS_NewEmptyEnumerator(aNodes);</span>
<a href="#l66.141"></a><span id="l66.141">   }</span>
<a href="#l66.142"></a><span id="l66.142"> </span>
<a href="#l66.143"></a><span id="l66.143">   nsresult rv;</span>
<a href="#l66.144"></a><span id="l66.144" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; nodeList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l66.145"></a><span id="l66.145" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; nodeList(</span>
<a href="#l66.146"></a><span id="l66.146" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l66.147"></a><span id="l66.147">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.148"></a><span id="l66.148"> </span>
<a href="#l66.149"></a><span id="l66.149">   rv = GetChildNodes(nodeList);</span>
<a href="#l66.150"></a><span id="l66.150">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.151"></a><span id="l66.151"> </span>
<a href="#l66.152"></a><span id="l66.152">   return NS_NewArrayEnumerator(aNodes, nodeList, NS_GET_IID(nsIAbDirectory));</span>
<a href="#l66.153"></a><span id="l66.153"> }</span>
<a href="#l66.154"></a><span id="l66.154"> </span>
<a href="#l66.155"></a><span id="l66.155" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::GetChildCards(nsISimpleEnumerator **aCards)</span>
<a href="#l66.156"></a><span id="l66.156" class="difflineminus">-{</span>
<a href="#l66.157"></a><span id="l66.157" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::GetChildCards(</span>
<a href="#l66.158"></a><span id="l66.158" class="difflineplus">+    nsISimpleEnumerator **aCards) {</span>
<a href="#l66.159"></a><span id="l66.159">   NS_ENSURE_ARG_POINTER(aCards);</span>
<a href="#l66.160"></a><span id="l66.160">   *aCards = nullptr;</span>
<a href="#l66.161"></a><span id="l66.161"> </span>
<a href="#l66.162"></a><span id="l66.162">   nsresult rv;</span>
<a href="#l66.163"></a><span id="l66.163" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; cardList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l66.164"></a><span id="l66.164" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; cardList(</span>
<a href="#l66.165"></a><span id="l66.165" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l66.166"></a><span id="l66.166">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.167"></a><span id="l66.167"> </span>
<a href="#l66.168"></a><span id="l66.168">   mCardList.Clear();</span>
<a href="#l66.169"></a><span id="l66.169"> </span>
<a href="#l66.170"></a><span id="l66.170">   rv = mIsQueryURI ? StartSearch() : GetChildCards(cardList, nullptr);</span>
<a href="#l66.171"></a><span id="l66.171"> </span>
<a href="#l66.172"></a><span id="l66.172">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.173"></a><span id="l66.173" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l66.174"></a><span id="l66.174" class="difflineminus">-  {</span>
<a href="#l66.175"></a><span id="l66.175" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l66.176"></a><span id="l66.176">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l66.177"></a><span id="l66.177">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.178"></a><span id="l66.178">   }</span>
<a href="#l66.179"></a><span id="l66.179"> </span>
<a href="#l66.180"></a><span id="l66.180">   // Fill the results array and update the card list</span>
<a href="#l66.181"></a><span id="l66.181">   // Also update the address list and notify any changes.</span>
<a href="#l66.182"></a><span id="l66.182">   uint32_t nbCards = 0;</span>
<a href="#l66.183"></a><span id="l66.183"> </span>
<a href="#l66.184"></a><span id="l66.184">   NS_NewArrayEnumerator(aCards, cardList, NS_GET_IID(nsIAbCard));</span>
<a href="#l66.185"></a><span id="l66.185">   cardList-&gt;GetLength(&amp;nbCards);</span>
<a href="#l66.186"></a><span id="l66.186"> </span>
<a href="#l66.187"></a><span id="l66.187">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l66.188"></a><span id="l66.188" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l66.189"></a><span id="l66.189" class="difflineminus">-                                   &amp;rv));</span>
<a href="#l66.190"></a><span id="l66.190" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l66.191"></a><span id="l66.191">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.192"></a><span id="l66.192"> </span>
<a href="#l66.193"></a><span id="l66.193" class="difflineminus">-</span>
<a href="#l66.194"></a><span id="l66.194" class="difflineminus">-  for (uint32_t i = 0; i &lt; nbCards; ++i)</span>
<a href="#l66.195"></a><span id="l66.195" class="difflineminus">-  {</span>
<a href="#l66.196"></a><span id="l66.196" class="difflineplus">+  for (uint32_t i = 0; i &lt; nbCards; ++i) {</span>
<a href="#l66.197"></a><span id="l66.197">     card = do_QueryElementAt(cardList, i, &amp;rv);</span>
<a href="#l66.198"></a><span id="l66.198" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l66.199"></a><span id="l66.199" class="difflineminus">-      continue;</span>
<a href="#l66.200"></a><span id="l66.200" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l66.201"></a><span id="l66.201"> </span>
<a href="#l66.202"></a><span id="l66.202" class="difflineminus">-    if (!mCardList.Get(card, nullptr))</span>
<a href="#l66.203"></a><span id="l66.203" class="difflineminus">-    {</span>
<a href="#l66.204"></a><span id="l66.204" class="difflineplus">+    if (!mCardList.Get(card, nullptr)) {</span>
<a href="#l66.205"></a><span id="l66.205">       // We are dealing with a new element (probably directly</span>
<a href="#l66.206"></a><span id="l66.206">       // added from Outlook), we may need to sync m_AddressList</span>
<a href="#l66.207"></a><span id="l66.207">       mCardList.Put(card, card);</span>
<a href="#l66.208"></a><span id="l66.208"> </span>
<a href="#l66.209"></a><span id="l66.209">       bool isMailList = false;</span>
<a href="#l66.210"></a><span id="l66.210"> </span>
<a href="#l66.211"></a><span id="l66.211">       rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l66.212"></a><span id="l66.212">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.213"></a><span id="l66.213" class="difflineminus">-      if (isMailList)</span>
<a href="#l66.214"></a><span id="l66.214" class="difflineminus">-      {</span>
<a href="#l66.215"></a><span id="l66.215" class="difflineplus">+      if (isMailList) {</span>
<a href="#l66.216"></a><span id="l66.216">         // We can have mailing lists only in folder,</span>
<a href="#l66.217"></a><span id="l66.217">         // we must add the directory to m_AddressList</span>
<a href="#l66.218"></a><span id="l66.218">         nsCString mailListUri;</span>
<a href="#l66.219"></a><span id="l66.219">         rv = card-&gt;GetMailListURI(getter_Copies(mailListUri));</span>
<a href="#l66.220"></a><span id="l66.220">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.221"></a><span id="l66.221">         nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l66.222"></a><span id="l66.222">         rv = abManager-&gt;GetDirectory(mailListUri, getter_AddRefs(mailList));</span>
<a href="#l66.223"></a><span id="l66.223">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.224"></a><span id="l66.224"> </span>
<a href="#l66.225"></a><span id="l66.225">         m_AddressList-&gt;AppendElement(mailList);</span>
<a href="#l66.226"></a><span id="l66.226">         NotifyItemAddition(mailList);</span>
<a href="#l66.227"></a><span id="l66.227" class="difflineminus">-      }</span>
<a href="#l66.228"></a><span id="l66.228" class="difflineminus">-      else if (m_IsMailList)</span>
<a href="#l66.229"></a><span id="l66.229" class="difflineminus">-      {</span>
<a href="#l66.230"></a><span id="l66.230" class="difflineplus">+      } else if (m_IsMailList) {</span>
<a href="#l66.231"></a><span id="l66.231">         m_AddressList-&gt;AppendElement(card);</span>
<a href="#l66.232"></a><span id="l66.232">         NotifyItemAddition(card);</span>
<a href="#l66.233"></a><span id="l66.233">       }</span>
<a href="#l66.234"></a><span id="l66.234">     }</span>
<a href="#l66.235"></a><span id="l66.235">   }</span>
<a href="#l66.236"></a><span id="l66.236">   return rv;</span>
<a href="#l66.237"></a><span id="l66.237"> }</span>
<a href="#l66.238"></a><span id="l66.238"> </span>
<a href="#l66.239"></a><span id="l66.239" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::GetIsQuery(bool *aResult)</span>
<a href="#l66.240"></a><span id="l66.240" class="difflineminus">-{</span>
<a href="#l66.241"></a><span id="l66.241" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::GetIsQuery(bool *aResult) {</span>
<a href="#l66.242"></a><span id="l66.242">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l66.243"></a><span id="l66.243">   *aResult = mIsQueryURI;</span>
<a href="#l66.244"></a><span id="l66.244">   return NS_OK;</span>
<a href="#l66.245"></a><span id="l66.245"> }</span>
<a href="#l66.246"></a><span id="l66.246"> </span>
<a href="#l66.247"></a><span id="l66.247" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::HasCard(nsIAbCard *aCard, bool *aHasCard)</span>
<a href="#l66.248"></a><span id="l66.248" class="difflineminus">-{</span>
<a href="#l66.249"></a><span id="l66.249" class="difflineminus">-  if (!aCard || !aHasCard)</span>
<a href="#l66.250"></a><span id="l66.250" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.251"></a><span id="l66.251" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::HasCard(nsIAbCard *aCard, bool *aHasCard) {</span>
<a href="#l66.252"></a><span id="l66.252" class="difflineplus">+  if (!aCard || !aHasCard) return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.253"></a><span id="l66.253"> </span>
<a href="#l66.254"></a><span id="l66.254">   *aHasCard = mCardList.Get(aCard, nullptr);</span>
<a href="#l66.255"></a><span id="l66.255">   return NS_OK;</span>
<a href="#l66.256"></a><span id="l66.256"> }</span>
<a href="#l66.257"></a><span id="l66.257"> </span>
<a href="#l66.258"></a><span id="l66.258" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::HasDirectory(nsIAbDirectory *aDirectory, bool *aHasDirectory)</span>
<a href="#l66.259"></a><span id="l66.259" class="difflineminus">-{</span>
<a href="#l66.260"></a><span id="l66.260" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::HasDirectory(nsIAbDirectory *aDirectory,</span>
<a href="#l66.261"></a><span id="l66.261" class="difflineplus">+                                                 bool *aHasDirectory) {</span>
<a href="#l66.262"></a><span id="l66.262">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l66.263"></a><span id="l66.263">   NS_ENSURE_ARG_POINTER(aHasDirectory);</span>
<a href="#l66.264"></a><span id="l66.264"> </span>
<a href="#l66.265"></a><span id="l66.265">   *aHasDirectory = false;</span>
<a href="#l66.266"></a><span id="l66.266"> </span>
<a href="#l66.267"></a><span id="l66.267">   uint32_t pos;</span>
<a href="#l66.268"></a><span id="l66.268" class="difflineminus">-  if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l66.269"></a><span id="l66.269" class="difflineminus">-      *aHasDirectory = true;</span>
<a href="#l66.270"></a><span id="l66.270" class="difflineplus">+  if (m_AddressList &amp;&amp;</span>
<a href="#l66.271"></a><span id="l66.271" class="difflineplus">+      NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l66.272"></a><span id="l66.272" class="difflineplus">+    *aHasDirectory = true;</span>
<a href="#l66.273"></a><span id="l66.273"> </span>
<a href="#l66.274"></a><span id="l66.274">   return NS_OK;</span>
<a href="#l66.275"></a><span id="l66.275"> }</span>
<a href="#l66.276"></a><span id="l66.276"> </span>
<a href="#l66.277"></a><span id="l66.277" class="difflineminus">-</span>
<a href="#l66.278"></a><span id="l66.278" class="difflineminus">-static nsresult ExtractCardEntry(nsIAbCard *aCard, nsCString&amp; aEntry)</span>
<a href="#l66.279"></a><span id="l66.279" class="difflineminus">-{</span>
<a href="#l66.280"></a><span id="l66.280" class="difflineplus">+static nsresult ExtractCardEntry(nsIAbCard *aCard, nsCString &amp;aEntry) {</span>
<a href="#l66.281"></a><span id="l66.281">   aEntry.Truncate();</span>
<a href="#l66.282"></a><span id="l66.282"> </span>
<a href="#l66.283"></a><span id="l66.283">   nsCString uri;</span>
<a href="#l66.284"></a><span id="l66.284">   aCard-&gt;GetPropertyAsAUTF8String(&quot;OutlookEntryURI&quot;, uri);</span>
<a href="#l66.285"></a><span id="l66.285"> </span>
<a href="#l66.286"></a><span id="l66.286">   // If we don't have a URI, uri will be empty. getAbWinType doesn't set</span>
<a href="#l66.287"></a><span id="l66.287">   // aEntry to anything if uri is empty, so it will be truncated, allowing us</span>
<a href="#l66.288"></a><span id="l66.288">   // to accept cards not initialized by us.</span>
<a href="#l66.289"></a><span id="l66.289">   nsAutoCString stub;</span>
<a href="#l66.290"></a><span id="l66.290">   getAbWinType(kOutlookCardScheme, uri.get(), stub, aEntry);</span>
<a href="#l66.291"></a><span id="l66.291">   return NS_OK;</span>
<a href="#l66.292"></a><span id="l66.292"> }</span>
<a href="#l66.293"></a><span id="l66.293"> </span>
<a href="#l66.294"></a><span id="l66.294" class="difflineminus">-static nsresult ExtractDirectoryEntry(nsIAbDirectory *aDirectory, nsCString&amp; aEntry)</span>
<a href="#l66.295"></a><span id="l66.295" class="difflineminus">-{</span>
<a href="#l66.296"></a><span id="l66.296" class="difflineplus">+static nsresult ExtractDirectoryEntry(nsIAbDirectory *aDirectory,</span>
<a href="#l66.297"></a><span id="l66.297" class="difflineplus">+                                      nsCString &amp;aEntry) {</span>
<a href="#l66.298"></a><span id="l66.298">   aEntry.Truncate();</span>
<a href="#l66.299"></a><span id="l66.299">   nsCString uri;</span>
<a href="#l66.300"></a><span id="l66.300">   nsresult rv = aDirectory-&gt;GetURI(uri);</span>
<a href="#l66.301"></a><span id="l66.301">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.302"></a><span id="l66.302"> </span>
<a href="#l66.303"></a><span id="l66.303">   nsAutoCString stub;</span>
<a href="#l66.304"></a><span id="l66.304">   getAbWinType(kOutlookDirectoryScheme, uri.get(), stub, aEntry);</span>
<a href="#l66.305"></a><span id="l66.305"> </span>
<a href="#l66.306"></a><span id="l66.306">   return NS_OK;</span>
<a href="#l66.307"></a><span id="l66.307"> }</span>
<a href="#l66.308"></a><span id="l66.308"> </span>
<a href="#l66.309"></a><span id="l66.309" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::DeleteCards(nsIArray *aCardList)</span>
<a href="#l66.310"></a><span id="l66.310" class="difflineminus">-{</span>
<a href="#l66.311"></a><span id="l66.311" class="difflineminus">-    if (mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l66.312"></a><span id="l66.312" class="difflineminus">-    if (!aCardList) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l66.313"></a><span id="l66.313" class="difflineminus">-    uint32_t nbCards = 0 ;</span>
<a href="#l66.314"></a><span id="l66.314" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.315"></a><span id="l66.315" class="difflineminus">-    nsAbWinHelperGuard mapiAddBook (mAbWinType) ;</span>
<a href="#l66.316"></a><span id="l66.316" class="difflineminus">-</span>
<a href="#l66.317"></a><span id="l66.317" class="difflineminus">-    if (!mapiAddBook-&gt;IsOK()) { return NS_ERROR_FAILURE ; }</span>
<a href="#l66.318"></a><span id="l66.318" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::DeleteCards(nsIArray *aCardList) {</span>
<a href="#l66.319"></a><span id="l66.319" class="difflineplus">+  if (mIsQueryURI) {</span>
<a href="#l66.320"></a><span id="l66.320" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.321"></a><span id="l66.321" class="difflineplus">+  }</span>
<a href="#l66.322"></a><span id="l66.322" class="difflineplus">+  if (!aCardList) {</span>
<a href="#l66.323"></a><span id="l66.323" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.324"></a><span id="l66.324" class="difflineplus">+  }</span>
<a href="#l66.325"></a><span id="l66.325" class="difflineplus">+  uint32_t nbCards = 0;</span>
<a href="#l66.326"></a><span id="l66.326" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.327"></a><span id="l66.327" class="difflineplus">+  nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.328"></a><span id="l66.328"> </span>
<a href="#l66.329"></a><span id="l66.329" class="difflineminus">-    retCode = aCardList-&gt;GetLength(&amp;nbCards);</span>
<a href="#l66.330"></a><span id="l66.330" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.331"></a><span id="l66.331" class="difflineminus">-    uint32_t i = 0 ;</span>
<a href="#l66.332"></a><span id="l66.332" class="difflineminus">-    nsAutoCString entryString ;</span>
<a href="#l66.333"></a><span id="l66.333" class="difflineminus">-    nsMapiEntry cardEntry ;</span>
<a href="#l66.334"></a><span id="l66.334" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) {</span>
<a href="#l66.335"></a><span id="l66.335" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l66.336"></a><span id="l66.336" class="difflineplus">+  }</span>
<a href="#l66.337"></a><span id="l66.337"> </span>
<a href="#l66.338"></a><span id="l66.338" class="difflineminus">-    for (i = 0 ; i &lt; nbCards ; ++i) {</span>
<a href="#l66.339"></a><span id="l66.339" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(aCardList, i, &amp;retCode));</span>
<a href="#l66.340"></a><span id="l66.340" class="difflineminus">-        NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.341"></a><span id="l66.341" class="difflineplus">+  retCode = aCardList-&gt;GetLength(&amp;nbCards);</span>
<a href="#l66.342"></a><span id="l66.342" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.343"></a><span id="l66.343" class="difflineplus">+  uint32_t i = 0;</span>
<a href="#l66.344"></a><span id="l66.344" class="difflineplus">+  nsAutoCString entryString;</span>
<a href="#l66.345"></a><span id="l66.345" class="difflineplus">+  nsMapiEntry cardEntry;</span>
<a href="#l66.346"></a><span id="l66.346"> </span>
<a href="#l66.347"></a><span id="l66.347" class="difflineminus">-        retCode = ExtractCardEntry(card, entryString) ;</span>
<a href="#l66.348"></a><span id="l66.348" class="difflineminus">-        if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l66.349"></a><span id="l66.349" class="difflineminus">-            card-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l66.350"></a><span id="l66.350" class="difflineplus">+  for (i = 0; i &lt; nbCards; ++i) {</span>
<a href="#l66.351"></a><span id="l66.351" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(aCardList, i, &amp;retCode));</span>
<a href="#l66.352"></a><span id="l66.352" class="difflineplus">+    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.353"></a><span id="l66.353" class="difflineplus">+</span>
<a href="#l66.354"></a><span id="l66.354" class="difflineplus">+    retCode = ExtractCardEntry(card, entryString);</span>
<a href="#l66.355"></a><span id="l66.355" class="difflineplus">+    if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l66.356"></a><span id="l66.356" class="difflineplus">+      card-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l66.357"></a><span id="l66.357"> </span>
<a href="#l66.358"></a><span id="l66.358" class="difflineminus">-            cardEntry.Assign(entryString) ;</span>
<a href="#l66.359"></a><span id="l66.359" class="difflineminus">-            if (!mapiAddBook-&gt;DeleteEntry(*mMapiData, cardEntry)) {</span>
<a href="#l66.360"></a><span id="l66.360" class="difflineminus">-                PRINTF((&quot;Cannot delete card %s.\n&quot;, entryString.get())) ;</span>
<a href="#l66.361"></a><span id="l66.361" class="difflineminus">-            }</span>
<a href="#l66.362"></a><span id="l66.362" class="difflineminus">-            else {</span>
<a href="#l66.363"></a><span id="l66.363" class="difflineminus">-                mCardList.Remove(card);</span>
<a href="#l66.364"></a><span id="l66.364" class="difflineminus">-                if (m_IsMailList &amp;&amp; m_AddressList)</span>
<a href="#l66.365"></a><span id="l66.365" class="difflineminus">-                {</span>
<a href="#l66.366"></a><span id="l66.366" class="difflineminus">-                    uint32_t pos;</span>
<a href="#l66.367"></a><span id="l66.367" class="difflineminus">-                    if (NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, card, &amp;pos)))</span>
<a href="#l66.368"></a><span id="l66.368" class="difflineminus">-                        m_AddressList-&gt;RemoveElementAt(pos);</span>
<a href="#l66.369"></a><span id="l66.369" class="difflineminus">-                }</span>
<a href="#l66.370"></a><span id="l66.370" class="difflineminus">-                retCode = NotifyItemDeletion(card);</span>
<a href="#l66.371"></a><span id="l66.371" class="difflineminus">-                NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.372"></a><span id="l66.372" class="difflineminus">-            }</span>
<a href="#l66.373"></a><span id="l66.373" class="difflineplus">+      cardEntry.Assign(entryString);</span>
<a href="#l66.374"></a><span id="l66.374" class="difflineplus">+      if (!mapiAddBook-&gt;DeleteEntry(*mMapiData, cardEntry)) {</span>
<a href="#l66.375"></a><span id="l66.375" class="difflineplus">+        PRINTF((&quot;Cannot delete card %s.\n&quot;, entryString.get()));</span>
<a href="#l66.376"></a><span id="l66.376" class="difflineplus">+      } else {</span>
<a href="#l66.377"></a><span id="l66.377" class="difflineplus">+        mCardList.Remove(card);</span>
<a href="#l66.378"></a><span id="l66.378" class="difflineplus">+        if (m_IsMailList &amp;&amp; m_AddressList) {</span>
<a href="#l66.379"></a><span id="l66.379" class="difflineplus">+          uint32_t pos;</span>
<a href="#l66.380"></a><span id="l66.380" class="difflineplus">+          if (NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, card, &amp;pos)))</span>
<a href="#l66.381"></a><span id="l66.381" class="difflineplus">+            m_AddressList-&gt;RemoveElementAt(pos);</span>
<a href="#l66.382"></a><span id="l66.382">         }</span>
<a href="#l66.383"></a><span id="l66.383" class="difflineminus">-        else {</span>
<a href="#l66.384"></a><span id="l66.384" class="difflineminus">-            PRINTF((&quot;Card doesn't belong in this directory.\n&quot;)) ;</span>
<a href="#l66.385"></a><span id="l66.385" class="difflineminus">-        }</span>
<a href="#l66.386"></a><span id="l66.386" class="difflineplus">+        retCode = NotifyItemDeletion(card);</span>
<a href="#l66.387"></a><span id="l66.387" class="difflineplus">+        NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.388"></a><span id="l66.388" class="difflineplus">+      }</span>
<a href="#l66.389"></a><span id="l66.389" class="difflineplus">+    } else {</span>
<a href="#l66.390"></a><span id="l66.390" class="difflineplus">+      PRINTF((&quot;Card doesn't belong in this directory.\n&quot;));</span>
<a href="#l66.391"></a><span id="l66.391">     }</span>
<a href="#l66.392"></a><span id="l66.392" class="difflineminus">-    return NS_OK ;</span>
<a href="#l66.393"></a><span id="l66.393" class="difflineplus">+  }</span>
<a href="#l66.394"></a><span id="l66.394" class="difflineplus">+  return NS_OK;</span>
<a href="#l66.395"></a><span id="l66.395"> }</span>
<a href="#l66.396"></a><span id="l66.396"> </span>
<a href="#l66.397"></a><span id="l66.397" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::DeleteDirectory(nsIAbDirectory *aDirectory)</span>
<a href="#l66.398"></a><span id="l66.398" class="difflineminus">-{</span>
<a href="#l66.399"></a><span id="l66.399" class="difflineminus">-    if (mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l66.400"></a><span id="l66.400" class="difflineminus">-    if (!aDirectory) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l66.401"></a><span id="l66.401" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.402"></a><span id="l66.402" class="difflineminus">-    nsAbWinHelperGuard mapiAddBook (mAbWinType) ;</span>
<a href="#l66.403"></a><span id="l66.403" class="difflineminus">-    nsAutoCString entryString ;</span>
<a href="#l66.404"></a><span id="l66.404" class="difflineminus">-</span>
<a href="#l66.405"></a><span id="l66.405" class="difflineminus">-    if (!mapiAddBook-&gt;IsOK()) { return NS_ERROR_FAILURE ; }</span>
<a href="#l66.406"></a><span id="l66.406" class="difflineminus">-    retCode = ExtractDirectoryEntry(aDirectory, entryString) ;</span>
<a href="#l66.407"></a><span id="l66.407" class="difflineminus">-    if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l66.408"></a><span id="l66.408" class="difflineminus">-        nsMapiEntry directoryEntry ;</span>
<a href="#l66.409"></a><span id="l66.409" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::DeleteDirectory(</span>
<a href="#l66.410"></a><span id="l66.410" class="difflineplus">+    nsIAbDirectory *aDirectory) {</span>
<a href="#l66.411"></a><span id="l66.411" class="difflineplus">+  if (mIsQueryURI) {</span>
<a href="#l66.412"></a><span id="l66.412" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.413"></a><span id="l66.413" class="difflineplus">+  }</span>
<a href="#l66.414"></a><span id="l66.414" class="difflineplus">+  if (!aDirectory) {</span>
<a href="#l66.415"></a><span id="l66.415" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.416"></a><span id="l66.416" class="difflineplus">+  }</span>
<a href="#l66.417"></a><span id="l66.417" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.418"></a><span id="l66.418" class="difflineplus">+  nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.419"></a><span id="l66.419" class="difflineplus">+  nsAutoCString entryString;</span>
<a href="#l66.420"></a><span id="l66.420"> </span>
<a href="#l66.421"></a><span id="l66.421" class="difflineminus">-        directoryEntry.Assign(entryString) ;</span>
<a href="#l66.422"></a><span id="l66.422" class="difflineminus">-        if (!mapiAddBook-&gt;DeleteEntry(*mMapiData, directoryEntry)) {</span>
<a href="#l66.423"></a><span id="l66.423" class="difflineminus">-            PRINTF((&quot;Cannot delete directory %s.\n&quot;, entryString.get())) ;</span>
<a href="#l66.424"></a><span id="l66.424" class="difflineminus">-        }</span>
<a href="#l66.425"></a><span id="l66.425" class="difflineminus">-        else {</span>
<a href="#l66.426"></a><span id="l66.426" class="difflineminus">-            uint32_t pos;</span>
<a href="#l66.427"></a><span id="l66.427" class="difflineminus">-            if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l66.428"></a><span id="l66.428" class="difflineminus">-                m_AddressList-&gt;RemoveElementAt(pos);</span>
<a href="#l66.429"></a><span id="l66.429" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) {</span>
<a href="#l66.430"></a><span id="l66.430" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l66.431"></a><span id="l66.431" class="difflineplus">+  }</span>
<a href="#l66.432"></a><span id="l66.432" class="difflineplus">+  retCode = ExtractDirectoryEntry(aDirectory, entryString);</span>
<a href="#l66.433"></a><span id="l66.433" class="difflineplus">+  if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l66.434"></a><span id="l66.434" class="difflineplus">+    nsMapiEntry directoryEntry;</span>
<a href="#l66.435"></a><span id="l66.435"> </span>
<a href="#l66.436"></a><span id="l66.436" class="difflineminus">-            retCode = NotifyItemDeletion(aDirectory);</span>
<a href="#l66.437"></a><span id="l66.437" class="difflineminus">-            NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.438"></a><span id="l66.438" class="difflineminus">-        }</span>
<a href="#l66.439"></a><span id="l66.439" class="difflineplus">+    directoryEntry.Assign(entryString);</span>
<a href="#l66.440"></a><span id="l66.440" class="difflineplus">+    if (!mapiAddBook-&gt;DeleteEntry(*mMapiData, directoryEntry)) {</span>
<a href="#l66.441"></a><span id="l66.441" class="difflineplus">+      PRINTF((&quot;Cannot delete directory %s.\n&quot;, entryString.get()));</span>
<a href="#l66.442"></a><span id="l66.442" class="difflineplus">+    } else {</span>
<a href="#l66.443"></a><span id="l66.443" class="difflineplus">+      uint32_t pos;</span>
<a href="#l66.444"></a><span id="l66.444" class="difflineplus">+      if (m_AddressList &amp;&amp;</span>
<a href="#l66.445"></a><span id="l66.445" class="difflineplus">+          NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l66.446"></a><span id="l66.446" class="difflineplus">+        m_AddressList-&gt;RemoveElementAt(pos);</span>
<a href="#l66.447"></a><span id="l66.447" class="difflineplus">+</span>
<a href="#l66.448"></a><span id="l66.448" class="difflineplus">+      retCode = NotifyItemDeletion(aDirectory);</span>
<a href="#l66.449"></a><span id="l66.449" class="difflineplus">+      NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.450"></a><span id="l66.450">     }</span>
<a href="#l66.451"></a><span id="l66.451" class="difflineminus">-    else {</span>
<a href="#l66.452"></a><span id="l66.452" class="difflineminus">-        PRINTF((&quot;Directory doesn't belong to this folder.\n&quot;)) ;</span>
<a href="#l66.453"></a><span id="l66.453" class="difflineminus">-    }</span>
<a href="#l66.454"></a><span id="l66.454" class="difflineminus">-    return retCode ;</span>
<a href="#l66.455"></a><span id="l66.455" class="difflineplus">+  } else {</span>
<a href="#l66.456"></a><span id="l66.456" class="difflineplus">+    PRINTF((&quot;Directory doesn't belong to this folder.\n&quot;));</span>
<a href="#l66.457"></a><span id="l66.457" class="difflineplus">+  }</span>
<a href="#l66.458"></a><span id="l66.458" class="difflineplus">+  return retCode;</span>
<a href="#l66.459"></a><span id="l66.459"> }</span>
<a href="#l66.460"></a><span id="l66.460"> </span>
<a href="#l66.461"></a><span id="l66.461" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::AddCard(nsIAbCard *aData, nsIAbCard **addedCard)</span>
<a href="#l66.462"></a><span id="l66.462" class="difflineminus">-{</span>
<a href="#l66.463"></a><span id="l66.463" class="difflineminus">-    if (mIsQueryURI)</span>
<a href="#l66.464"></a><span id="l66.464" class="difflineminus">-      return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.465"></a><span id="l66.465" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::AddCard(nsIAbCard *aData,</span>
<a href="#l66.466"></a><span id="l66.466" class="difflineplus">+                                            nsIAbCard **addedCard) {</span>
<a href="#l66.467"></a><span id="l66.467" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.468"></a><span id="l66.468"> </span>
<a href="#l66.469"></a><span id="l66.469" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aData);</span>
<a href="#l66.470"></a><span id="l66.470" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aData);</span>
<a href="#l66.471"></a><span id="l66.471"> </span>
<a href="#l66.472"></a><span id="l66.472" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.473"></a><span id="l66.473" class="difflineminus">-    bool hasCard = false ;</span>
<a href="#l66.474"></a><span id="l66.474" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.475"></a><span id="l66.475" class="difflineplus">+  bool hasCard = false;</span>
<a href="#l66.476"></a><span id="l66.476"> </span>
<a href="#l66.477"></a><span id="l66.477" class="difflineminus">-    retCode = HasCard(aData, &amp;hasCard) ;</span>
<a href="#l66.478"></a><span id="l66.478" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.479"></a><span id="l66.479" class="difflineminus">-    if (hasCard) {</span>
<a href="#l66.480"></a><span id="l66.480" class="difflineminus">-        PRINTF((&quot;Has card.\n&quot;)) ;</span>
<a href="#l66.481"></a><span id="l66.481" class="difflineminus">-        NS_IF_ADDREF(*addedCard = aData);</span>
<a href="#l66.482"></a><span id="l66.482" class="difflineminus">-        return NS_OK ;</span>
<a href="#l66.483"></a><span id="l66.483" class="difflineminus">-    }</span>
<a href="#l66.484"></a><span id="l66.484" class="difflineminus">-    retCode = CreateCard(aData, addedCard) ;</span>
<a href="#l66.485"></a><span id="l66.485" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.486"></a><span id="l66.486" class="difflineplus">+  retCode = HasCard(aData, &amp;hasCard);</span>
<a href="#l66.487"></a><span id="l66.487" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.488"></a><span id="l66.488" class="difflineplus">+  if (hasCard) {</span>
<a href="#l66.489"></a><span id="l66.489" class="difflineplus">+    PRINTF((&quot;Has card.\n&quot;));</span>
<a href="#l66.490"></a><span id="l66.490" class="difflineplus">+    NS_IF_ADDREF(*addedCard = aData);</span>
<a href="#l66.491"></a><span id="l66.491" class="difflineplus">+    return NS_OK;</span>
<a href="#l66.492"></a><span id="l66.492" class="difflineplus">+  }</span>
<a href="#l66.493"></a><span id="l66.493" class="difflineplus">+  retCode = CreateCard(aData, addedCard);</span>
<a href="#l66.494"></a><span id="l66.494" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.495"></a><span id="l66.495"> </span>
<a href="#l66.496"></a><span id="l66.496" class="difflineminus">-    mCardList.Put(*addedCard, *addedCard);</span>
<a href="#l66.497"></a><span id="l66.497" class="difflineplus">+  mCardList.Put(*addedCard, *addedCard);</span>
<a href="#l66.498"></a><span id="l66.498"> </span>
<a href="#l66.499"></a><span id="l66.499" class="difflineminus">-    if (!m_AddressList)</span>
<a href="#l66.500"></a><span id="l66.500" class="difflineminus">-    {</span>
<a href="#l66.501"></a><span id="l66.501" class="difflineminus">-        m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;retCode);</span>
<a href="#l66.502"></a><span id="l66.502" class="difflineminus">-        NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.503"></a><span id="l66.503" class="difflineminus">-    }</span>
<a href="#l66.504"></a><span id="l66.504" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l66.505"></a><span id="l66.505" class="difflineplus">+    m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;retCode);</span>
<a href="#l66.506"></a><span id="l66.506" class="difflineplus">+    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.507"></a><span id="l66.507" class="difflineplus">+  }</span>
<a href="#l66.508"></a><span id="l66.508"> </span>
<a href="#l66.509"></a><span id="l66.509" class="difflineminus">-    if (m_IsMailList)</span>
<a href="#l66.510"></a><span id="l66.510" class="difflineminus">-        m_AddressList-&gt;AppendElement(*addedCard);</span>
<a href="#l66.511"></a><span id="l66.511" class="difflineminus">-    NotifyItemAddition(*addedCard) ;</span>
<a href="#l66.512"></a><span id="l66.512" class="difflineminus">-    return retCode ;</span>
<a href="#l66.513"></a><span id="l66.513" class="difflineplus">+  if (m_IsMailList) m_AddressList-&gt;AppendElement(*addedCard);</span>
<a href="#l66.514"></a><span id="l66.514" class="difflineplus">+  NotifyItemAddition(*addedCard);</span>
<a href="#l66.515"></a><span id="l66.515" class="difflineplus">+  return retCode;</span>
<a href="#l66.516"></a><span id="l66.516"> }</span>
<a href="#l66.517"></a><span id="l66.517"> </span>
<a href="#l66.518"></a><span id="l66.518" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::DropCard(nsIAbCard *aData, bool needToCopyCard)</span>
<a href="#l66.519"></a><span id="l66.519" class="difflineminus">-{</span>
<a href="#l66.520"></a><span id="l66.520" class="difflineminus">-    nsCOMPtr &lt;nsIAbCard&gt; addedCard;</span>
<a href="#l66.521"></a><span id="l66.521" class="difflineminus">-    return AddCard(aData, getter_AddRefs(addedCard));</span>
<a href="#l66.522"></a><span id="l66.522" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::DropCard(nsIAbCard *aData,</span>
<a href="#l66.523"></a><span id="l66.523" class="difflineplus">+                                             bool needToCopyCard) {</span>
<a href="#l66.524"></a><span id="l66.524" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; addedCard;</span>
<a href="#l66.525"></a><span id="l66.525" class="difflineplus">+  return AddCard(aData, getter_AddRefs(addedCard));</span>
<a href="#l66.526"></a><span id="l66.526"> }</span>
<a href="#l66.527"></a><span id="l66.527"> </span>
<a href="#l66.528"></a><span id="l66.528" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::AddMailList(nsIAbDirectory *aMailList, nsIAbDirectory **addedList)</span>
<a href="#l66.529"></a><span id="l66.529" class="difflineminus">-{</span>
<a href="#l66.530"></a><span id="l66.530" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l66.531"></a><span id="l66.531" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.532"></a><span id="l66.532" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::AddMailList(nsIAbDirectory *aMailList,</span>
<a href="#l66.533"></a><span id="l66.533" class="difflineplus">+                                                nsIAbDirectory **addedList) {</span>
<a href="#l66.534"></a><span id="l66.534" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.535"></a><span id="l66.535">   NS_ENSURE_ARG_POINTER(aMailList);</span>
<a href="#l66.536"></a><span id="l66.536">   NS_ENSURE_ARG_POINTER(addedList);</span>
<a href="#l66.537"></a><span id="l66.537" class="difflineminus">-  if (m_IsMailList)</span>
<a href="#l66.538"></a><span id="l66.538" class="difflineminus">-    return NS_OK;</span>
<a href="#l66.539"></a><span id="l66.539" class="difflineminus">-  nsAbWinHelperGuard mapiAddBook (mAbWinType);</span>
<a href="#l66.540"></a><span id="l66.540" class="difflineplus">+  if (m_IsMailList) return NS_OK;</span>
<a href="#l66.541"></a><span id="l66.541" class="difflineplus">+  nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.542"></a><span id="l66.542">   nsAutoCString entryString;</span>
<a href="#l66.543"></a><span id="l66.543">   nsMapiEntry newEntry;</span>
<a href="#l66.544"></a><span id="l66.544">   bool didCopy = false;</span>
<a href="#l66.545"></a><span id="l66.545"> </span>
<a href="#l66.546"></a><span id="l66.546" class="difflineminus">-  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l66.547"></a><span id="l66.547" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l66.548"></a><span id="l66.548" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) return NS_ERROR_FAILURE;</span>
<a href="#l66.549"></a><span id="l66.549">   nsresult rv = ExtractDirectoryEntry(aMailList, entryString);</span>
<a href="#l66.550"></a><span id="l66.550" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !entryString.IsEmpty())</span>
<a href="#l66.551"></a><span id="l66.551" class="difflineminus">-  {</span>
<a href="#l66.552"></a><span id="l66.552" class="difflineminus">-      nsMapiEntry sourceEntry;</span>
<a href="#l66.553"></a><span id="l66.553" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l66.554"></a><span id="l66.554" class="difflineplus">+    nsMapiEntry sourceEntry;</span>
<a href="#l66.555"></a><span id="l66.555"> </span>
<a href="#l66.556"></a><span id="l66.556" class="difflineminus">-      sourceEntry.Assign(entryString);</span>
<a href="#l66.557"></a><span id="l66.557" class="difflineminus">-      mapiAddBook-&gt;CopyEntry(*mMapiData, sourceEntry, newEntry);</span>
<a href="#l66.558"></a><span id="l66.558" class="difflineplus">+    sourceEntry.Assign(entryString);</span>
<a href="#l66.559"></a><span id="l66.559" class="difflineplus">+    mapiAddBook-&gt;CopyEntry(*mMapiData, sourceEntry, newEntry);</span>
<a href="#l66.560"></a><span id="l66.560">   }</span>
<a href="#l66.561"></a><span id="l66.561" class="difflineminus">-  if (newEntry.mByteCount == 0)</span>
<a href="#l66.562"></a><span id="l66.562" class="difflineminus">-  {</span>
<a href="#l66.563"></a><span id="l66.563" class="difflineplus">+  if (newEntry.mByteCount == 0) {</span>
<a href="#l66.564"></a><span id="l66.564">     if (!mapiAddBook-&gt;CreateDistList(*mMapiData, newEntry))</span>
<a href="#l66.565"></a><span id="l66.565" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l66.566"></a><span id="l66.566" class="difflineminus">-  }</span>
<a href="#l66.567"></a><span id="l66.567" class="difflineminus">-  else {</span>
<a href="#l66.568"></a><span id="l66.568" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l66.569"></a><span id="l66.569" class="difflineplus">+  } else {</span>
<a href="#l66.570"></a><span id="l66.570">     didCopy = true;</span>
<a href="#l66.571"></a><span id="l66.571">   }</span>
<a href="#l66.572"></a><span id="l66.572">   newEntry.ToString(entryString);</span>
<a href="#l66.573"></a><span id="l66.573">   nsAutoCString uri;</span>
<a href="#l66.574"></a><span id="l66.574"> </span>
<a href="#l66.575"></a><span id="l66.575">   buildAbWinUri(kOutlookDirectoryScheme, mAbWinType, uri);</span>
<a href="#l66.576"></a><span id="l66.576">   uri.Append(entryString);</span>
<a href="#l66.577"></a><span id="l66.577"> </span>
<a href="#l66.578"></a><span id="l66.578" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l66.579"></a><span id="l66.579" class="difflineminus">-                                   &amp;rv));</span>
<a href="#l66.580"></a><span id="l66.580" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l66.581"></a><span id="l66.581">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.582"></a><span id="l66.582"> </span>
<a href="#l66.583"></a><span id="l66.583">   nsCOMPtr&lt;nsIAbDirectory&gt; newList;</span>
<a href="#l66.584"></a><span id="l66.584">   rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(newList));</span>
<a href="#l66.585"></a><span id="l66.585">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.586"></a><span id="l66.586"> </span>
<a href="#l66.587"></a><span id="l66.587" class="difflineminus">-  if (!didCopy)</span>
<a href="#l66.588"></a><span id="l66.588" class="difflineminus">-  {</span>
<a href="#l66.589"></a><span id="l66.589" class="difflineplus">+  if (!didCopy) {</span>
<a href="#l66.590"></a><span id="l66.590">     rv = newList-&gt;CopyMailList(aMailList);</span>
<a href="#l66.591"></a><span id="l66.591">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.592"></a><span id="l66.592">     rv = newList-&gt;EditMailListToDatabase(nullptr);</span>
<a href="#l66.593"></a><span id="l66.593">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.594"></a><span id="l66.594">   }</span>
<a href="#l66.595"></a><span id="l66.595"> </span>
<a href="#l66.596"></a><span id="l66.596" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l66.597"></a><span id="l66.597" class="difflineminus">-  {</span>
<a href="#l66.598"></a><span id="l66.598" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l66.599"></a><span id="l66.599">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l66.600"></a><span id="l66.600">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.601"></a><span id="l66.601">   }</span>
<a href="#l66.602"></a><span id="l66.602">   m_AddressList-&gt;AppendElement(newList);</span>
<a href="#l66.603"></a><span id="l66.603">   NotifyItemAddition(newList);</span>
<a href="#l66.604"></a><span id="l66.604">   newList.forget(addedList);</span>
<a href="#l66.605"></a><span id="l66.605"> </span>
<a href="#l66.606"></a><span id="l66.606">   return rv;</span>
<a href="#l66.607"></a><span id="l66.607"> }</span>
<a href="#l66.608"></a><span id="l66.608"> </span>
<a href="#l66.609"></a><span id="l66.609" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::EditMailListToDatabase(nsIAbCard *listCard)</span>
<a href="#l66.610"></a><span id="l66.610" class="difflineminus">-{</span>
<a href="#l66.611"></a><span id="l66.611" class="difflineminus">-  if (mIsQueryURI)</span>
<a href="#l66.612"></a><span id="l66.612" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.613"></a><span id="l66.613" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::EditMailListToDatabase(</span>
<a href="#l66.614"></a><span id="l66.614" class="difflineplus">+    nsIAbCard *listCard) {</span>
<a href="#l66.615"></a><span id="l66.615" class="difflineplus">+  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.616"></a><span id="l66.616"> </span>
<a href="#l66.617"></a><span id="l66.617">   nsresult rv;</span>
<a href="#l66.618"></a><span id="l66.618">   nsString name;</span>
<a href="#l66.619"></a><span id="l66.619">   nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.620"></a><span id="l66.620"> </span>
<a href="#l66.621"></a><span id="l66.621" class="difflineminus">-  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l66.622"></a><span id="l66.622" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l66.623"></a><span id="l66.623" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) return NS_ERROR_FAILURE;</span>
<a href="#l66.624"></a><span id="l66.624"> </span>
<a href="#l66.625"></a><span id="l66.625">   rv = GetDirName(name);</span>
<a href="#l66.626"></a><span id="l66.626">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.627"></a><span id="l66.627"> </span>
<a href="#l66.628"></a><span id="l66.628">   if (!mapiAddBook-&gt;SetPropertyUString(*mMapiData, PR_DISPLAY_NAME_W,</span>
<a href="#l66.629"></a><span id="l66.629">                                        name.get()))</span>
<a href="#l66.630"></a><span id="l66.630">     return NS_ERROR_FAILURE;</span>
<a href="#l66.631"></a><span id="l66.631"> </span>
<a href="#l66.632"></a><span id="l66.632">   return CommitAddressList();</span>
<a href="#l66.633"></a><span id="l66.633"> }</span>
<a href="#l66.634"></a><span id="l66.634"> </span>
<a href="#l66.635"></a><span id="l66.635" class="difflineminus">-struct OutlookTableAttr</span>
<a href="#l66.636"></a><span id="l66.636" class="difflineminus">-{</span>
<a href="#l66.637"></a><span id="l66.637" class="difflineminus">-    const char *mOuterName ;</span>
<a href="#l66.638"></a><span id="l66.638" class="difflineminus">-    ULONG mMapiProp ;</span>
<a href="#l66.639"></a><span id="l66.639" class="difflineminus">-} ;</span>
<a href="#l66.640"></a><span id="l66.640" class="difflineplus">+struct OutlookTableAttr {</span>
<a href="#l66.641"></a><span id="l66.641" class="difflineplus">+  const char *mOuterName;</span>
<a href="#l66.642"></a><span id="l66.642" class="difflineplus">+  ULONG mMapiProp;</span>
<a href="#l66.643"></a><span id="l66.643" class="difflineplus">+};</span>
<a href="#l66.644"></a><span id="l66.644"> </span>
<a href="#l66.645"></a><span id="l66.645"> // Here, we are forced to use the Ascii versions of the properties</span>
<a href="#l66.646"></a><span id="l66.646"> // instead of the widechar ones, because the content restriction</span>
<a href="#l66.647"></a><span id="l66.647"> // operators do not work on unicode strings in mapi.</span>
<a href="#l66.648"></a><span id="l66.648" class="difflineminus">-static const OutlookTableAttr OutlookTableStringToProp[] =</span>
<a href="#l66.649"></a><span id="l66.649" class="difflineminus">-{</span>
<a href="#l66.650"></a><span id="l66.650" class="difflineplus">+static const OutlookTableAttr OutlookTableStringToProp[] = {</span>
<a href="#l66.651"></a><span id="l66.651">     {kFirstNameProperty, PR_GIVEN_NAME_A},</span>
<a href="#l66.652"></a><span id="l66.652">     {kLastNameProperty, PR_SURNAME_A},</span>
<a href="#l66.653"></a><span id="l66.653">     {kDisplayNameProperty, PR_DISPLAY_NAME_A},</span>
<a href="#l66.654"></a><span id="l66.654">     {kNicknameProperty, PR_NICKNAME_A},</span>
<a href="#l66.655"></a><span id="l66.655">     {kPriEmailProperty, PR_EMAIL_ADDRESS_A},</span>
<a href="#l66.656"></a><span id="l66.656">     {kWorkPhoneProperty, PR_BUSINESS_TELEPHONE_NUMBER_A},</span>
<a href="#l66.657"></a><span id="l66.657">     {kHomePhoneProperty, PR_HOME_TELEPHONE_NUMBER_A},</span>
<a href="#l66.658"></a><span id="l66.658">     {kFaxProperty, PR_BUSINESS_FAX_NUMBER_A},</span>
<a href="#l66.659"></a><span id="l66.659" class="difflineat">@@ -506,523 +485,516 @@ static const OutlookTableAttr OutlookTab</span>
<a href="#l66.660"></a><span id="l66.660">     {kWorkStateProperty, PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_A},</span>
<a href="#l66.661"></a><span id="l66.661">     {kWorkZipCodeProperty, PR_BUSINESS_ADDRESS_POSTAL_CODE_A},</span>
<a href="#l66.662"></a><span id="l66.662">     {kWorkCountryProperty, PR_BUSINESS_ADDRESS_COUNTRY_A},</span>
<a href="#l66.663"></a><span id="l66.663">     {kJobTitleProperty, PR_TITLE_A},</span>
<a href="#l66.664"></a><span id="l66.664">     {kDepartmentProperty, PR_DEPARTMENT_NAME_A},</span>
<a href="#l66.665"></a><span id="l66.665">     {kCompanyProperty, PR_COMPANY_NAME_A},</span>
<a href="#l66.666"></a><span id="l66.666">     {kWorkWebPageProperty, PR_BUSINESS_HOME_PAGE_A},</span>
<a href="#l66.667"></a><span id="l66.667">     {kHomeWebPageProperty, PR_PERSONAL_HOME_PAGE_A},</span>
<a href="#l66.668"></a><span id="l66.668" class="difflineminus">-    // For the moment, we don't support querying on the birthday</span>
<a href="#l66.669"></a><span id="l66.669" class="difflineminus">-    // sub-elements.</span>
<a href="#l66.670"></a><span id="l66.670" class="difflineplus">+// For the moment, we don't support querying on the birthday</span>
<a href="#l66.671"></a><span id="l66.671" class="difflineplus">+// sub-elements.</span>
<a href="#l66.672"></a><span id="l66.672"> #if 0</span>
<a href="#l66.673"></a><span id="l66.673">     {kBirthYearProperty, PR_BIRTHDAY},</span>
<a href="#l66.674"></a><span id="l66.674">     {kBirthMonthProperty, PR_BIRTHDAY},</span>
<a href="#l66.675"></a><span id="l66.675">     {kBirthDayProperty, PR_BIRTHDAY},</span>
<a href="#l66.676"></a><span id="l66.676" class="difflineminus">-#endif // 0</span>
<a href="#l66.677"></a><span id="l66.677" class="difflineminus">-    {kNotesProperty, PR_COMMENT_A}</span>
<a href="#l66.678"></a><span id="l66.678" class="difflineminus">-} ;</span>
<a href="#l66.679"></a><span id="l66.679" class="difflineplus">+#endif  // 0</span>
<a href="#l66.680"></a><span id="l66.680" class="difflineplus">+    {kNotesProperty, PR_COMMENT_A}};</span>
<a href="#l66.681"></a><span id="l66.681"> </span>
<a href="#l66.682"></a><span id="l66.682" class="difflineminus">-static const uint32_t OutlookTableNbProps = sizeof(OutlookTableStringToProp) /</span>
<a href="#l66.683"></a><span id="l66.683" class="difflineminus">-                                            sizeof(OutlookTableStringToProp[0]) ;</span>
<a href="#l66.684"></a><span id="l66.684" class="difflineplus">+static const uint32_t OutlookTableNbProps =</span>
<a href="#l66.685"></a><span id="l66.685" class="difflineplus">+    sizeof(OutlookTableStringToProp) / sizeof(OutlookTableStringToProp[0]);</span>
<a href="#l66.686"></a><span id="l66.686"> </span>
<a href="#l66.687"></a><span id="l66.687"> static ULONG findPropertyTag(const char *aName) {</span>
<a href="#l66.688"></a><span id="l66.688" class="difflineminus">-    uint32_t i = 0 ;</span>
<a href="#l66.689"></a><span id="l66.689" class="difflineplus">+  uint32_t i = 0;</span>
<a href="#l66.690"></a><span id="l66.690"> </span>
<a href="#l66.691"></a><span id="l66.691" class="difflineminus">-    for (i = 0 ; i &lt; OutlookTableNbProps ; ++i) {</span>
<a href="#l66.692"></a><span id="l66.692" class="difflineminus">-        if (strcmp(aName, OutlookTableStringToProp[i].mOuterName) == 0) {</span>
<a href="#l66.693"></a><span id="l66.693" class="difflineminus">-            return OutlookTableStringToProp[i].mMapiProp ;</span>
<a href="#l66.694"></a><span id="l66.694" class="difflineminus">-        }</span>
<a href="#l66.695"></a><span id="l66.695" class="difflineplus">+  for (i = 0; i &lt; OutlookTableNbProps; ++i) {</span>
<a href="#l66.696"></a><span id="l66.696" class="difflineplus">+    if (strcmp(aName, OutlookTableStringToProp[i].mOuterName) == 0) {</span>
<a href="#l66.697"></a><span id="l66.697" class="difflineplus">+      return OutlookTableStringToProp[i].mMapiProp;</span>
<a href="#l66.698"></a><span id="l66.698">     }</span>
<a href="#l66.699"></a><span id="l66.699" class="difflineminus">-    return 0 ;</span>
<a href="#l66.700"></a><span id="l66.700" class="difflineplus">+  }</span>
<a href="#l66.701"></a><span id="l66.701" class="difflineplus">+  return 0;</span>
<a href="#l66.702"></a><span id="l66.702"> }</span>
<a href="#l66.703"></a><span id="l66.703"> </span>
<a href="#l66.704"></a><span id="l66.704"> static nsresult BuildRestriction(nsIAbBooleanConditionString *aCondition,</span>
<a href="#l66.705"></a><span id="l66.705" class="difflineminus">-                                 SRestriction&amp; aRestriction,</span>
<a href="#l66.706"></a><span id="l66.706" class="difflineminus">-                                 bool&amp; aSkipItem)</span>
<a href="#l66.707"></a><span id="l66.707" class="difflineminus">-{</span>
<a href="#l66.708"></a><span id="l66.708" class="difflineminus">-    if (!aCondition) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l66.709"></a><span id="l66.709" class="difflineminus">-    aSkipItem = false ;</span>
<a href="#l66.710"></a><span id="l66.710" class="difflineminus">-    nsAbBooleanConditionType conditionType = 0 ;</span>
<a href="#l66.711"></a><span id="l66.711" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.712"></a><span id="l66.712" class="difflineminus">-    nsCString name;</span>
<a href="#l66.713"></a><span id="l66.713" class="difflineminus">-    nsString value;</span>
<a href="#l66.714"></a><span id="l66.714" class="difflineminus">-    ULONG propertyTag = 0 ;</span>
<a href="#l66.715"></a><span id="l66.715" class="difflineminus">-    nsAutoCString valueAscii ;</span>
<a href="#l66.716"></a><span id="l66.716" class="difflineplus">+                                 SRestriction &amp;aRestriction, bool &amp;aSkipItem) {</span>
<a href="#l66.717"></a><span id="l66.717" class="difflineplus">+  if (!aCondition) {</span>
<a href="#l66.718"></a><span id="l66.718" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.719"></a><span id="l66.719" class="difflineplus">+  }</span>
<a href="#l66.720"></a><span id="l66.720" class="difflineplus">+  aSkipItem = false;</span>
<a href="#l66.721"></a><span id="l66.721" class="difflineplus">+  nsAbBooleanConditionType conditionType = 0;</span>
<a href="#l66.722"></a><span id="l66.722" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.723"></a><span id="l66.723" class="difflineplus">+  nsCString name;</span>
<a href="#l66.724"></a><span id="l66.724" class="difflineplus">+  nsString value;</span>
<a href="#l66.725"></a><span id="l66.725" class="difflineplus">+  ULONG propertyTag = 0;</span>
<a href="#l66.726"></a><span id="l66.726" class="difflineplus">+  nsAutoCString valueAscii;</span>
<a href="#l66.727"></a><span id="l66.727"> </span>
<a href="#l66.728"></a><span id="l66.728" class="difflineminus">-    retCode = aCondition-&gt;GetCondition(&amp;conditionType) ;</span>
<a href="#l66.729"></a><span id="l66.729" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.730"></a><span id="l66.730" class="difflineminus">-    retCode = aCondition-&gt;GetName(getter_Copies(name)) ;</span>
<a href="#l66.731"></a><span id="l66.731" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.732"></a><span id="l66.732" class="difflineminus">-    retCode = aCondition-&gt;GetValue(getter_Copies(value)) ;</span>
<a href="#l66.733"></a><span id="l66.733" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.734"></a><span id="l66.734" class="difflineminus">-    LossyCopyUTF16toASCII(value, valueAscii);</span>
<a href="#l66.735"></a><span id="l66.735" class="difflineminus">-    propertyTag = findPropertyTag(name.get()) ;</span>
<a href="#l66.736"></a><span id="l66.736" class="difflineminus">-    if (propertyTag == 0) {</span>
<a href="#l66.737"></a><span id="l66.737" class="difflineminus">-        aSkipItem = true ;</span>
<a href="#l66.738"></a><span id="l66.738" class="difflineminus">-        return retCode ;</span>
<a href="#l66.739"></a><span id="l66.739" class="difflineminus">-    }</span>
<a href="#l66.740"></a><span id="l66.740" class="difflineminus">-    switch (conditionType) {</span>
<a href="#l66.741"></a><span id="l66.741" class="difflineminus">-    case nsIAbBooleanConditionTypes::Exists :</span>
<a href="#l66.742"></a><span id="l66.742" class="difflineminus">-        aRestriction.rt = RES_EXIST ;</span>
<a href="#l66.743"></a><span id="l66.743" class="difflineminus">-        aRestriction.res.resExist.ulPropTag = propertyTag ;</span>
<a href="#l66.744"></a><span id="l66.744" class="difflineminus">-        break ;</span>
<a href="#l66.745"></a><span id="l66.745" class="difflineminus">-    case nsIAbBooleanConditionTypes::DoesNotExist :</span>
<a href="#l66.746"></a><span id="l66.746" class="difflineminus">-        aRestriction.rt = RES_NOT ;</span>
<a href="#l66.747"></a><span id="l66.747" class="difflineminus">-        aRestriction.res.resNot.lpRes = new SRestriction ;</span>
<a href="#l66.748"></a><span id="l66.748" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;rt = RES_EXIST ;</span>
<a href="#l66.749"></a><span id="l66.749" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resExist.ulPropTag = propertyTag ;</span>
<a href="#l66.750"></a><span id="l66.750" class="difflineminus">-        break ;</span>
<a href="#l66.751"></a><span id="l66.751" class="difflineminus">-    case nsIAbBooleanConditionTypes::Contains :</span>
<a href="#l66.752"></a><span id="l66.752" class="difflineminus">-        aRestriction.rt = RES_CONTENT ;</span>
<a href="#l66.753"></a><span id="l66.753" class="difflineminus">-        aRestriction.res.resContent.ulFuzzyLevel = FL_SUBSTRING | FL_LOOSE ;</span>
<a href="#l66.754"></a><span id="l66.754" class="difflineminus">-        aRestriction.res.resContent.ulPropTag = propertyTag ;</span>
<a href="#l66.755"></a><span id="l66.755" class="difflineminus">-        aRestriction.res.resContent.lpProp = new SPropValue ;</span>
<a href="#l66.756"></a><span id="l66.756" class="difflineminus">-        aRestriction.res.resContent.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.757"></a><span id="l66.757" class="difflineminus">-        aRestriction.res.resContent.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.758"></a><span id="l66.758" class="difflineminus">-        break ;</span>
<a href="#l66.759"></a><span id="l66.759" class="difflineminus">-    case nsIAbBooleanConditionTypes::DoesNotContain :</span>
<a href="#l66.760"></a><span id="l66.760" class="difflineminus">-        aRestriction.rt = RES_NOT ;</span>
<a href="#l66.761"></a><span id="l66.761" class="difflineminus">-        aRestriction.res.resNot.lpRes = new SRestriction ;</span>
<a href="#l66.762"></a><span id="l66.762" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;rt = RES_CONTENT ;</span>
<a href="#l66.763"></a><span id="l66.763" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.ulFuzzyLevel = FL_SUBSTRING | FL_LOOSE ;</span>
<a href="#l66.764"></a><span id="l66.764" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.ulPropTag = propertyTag ;</span>
<a href="#l66.765"></a><span id="l66.765" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp = new SPropValue ;</span>
<a href="#l66.766"></a><span id="l66.766" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.767"></a><span id="l66.767" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.768"></a><span id="l66.768" class="difflineminus">-        break ;</span>
<a href="#l66.769"></a><span id="l66.769" class="difflineminus">-    case nsIAbBooleanConditionTypes::Is :</span>
<a href="#l66.770"></a><span id="l66.770" class="difflineminus">-        aRestriction.rt = RES_CONTENT ;</span>
<a href="#l66.771"></a><span id="l66.771" class="difflineminus">-        aRestriction.res.resContent.ulFuzzyLevel = FL_FULLSTRING | FL_LOOSE ;</span>
<a href="#l66.772"></a><span id="l66.772" class="difflineminus">-        aRestriction.res.resContent.ulPropTag = propertyTag ;</span>
<a href="#l66.773"></a><span id="l66.773" class="difflineminus">-        aRestriction.res.resContent.lpProp = new SPropValue ;</span>
<a href="#l66.774"></a><span id="l66.774" class="difflineminus">-        aRestriction.res.resContent.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.775"></a><span id="l66.775" class="difflineminus">-        aRestriction.res.resContent.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.776"></a><span id="l66.776" class="difflineminus">-        break ;</span>
<a href="#l66.777"></a><span id="l66.777" class="difflineminus">-    case nsIAbBooleanConditionTypes::IsNot :</span>
<a href="#l66.778"></a><span id="l66.778" class="difflineminus">-        aRestriction.rt = RES_NOT ;</span>
<a href="#l66.779"></a><span id="l66.779" class="difflineminus">-        aRestriction.res.resNot.lpRes = new SRestriction ;</span>
<a href="#l66.780"></a><span id="l66.780" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;rt = RES_CONTENT ;</span>
<a href="#l66.781"></a><span id="l66.781" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.ulFuzzyLevel = FL_FULLSTRING | FL_LOOSE ;</span>
<a href="#l66.782"></a><span id="l66.782" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.ulPropTag = propertyTag ;</span>
<a href="#l66.783"></a><span id="l66.783" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp = new SPropValue ;</span>
<a href="#l66.784"></a><span id="l66.784" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.785"></a><span id="l66.785" class="difflineminus">-        aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.786"></a><span id="l66.786" class="difflineminus">-        break ;</span>
<a href="#l66.787"></a><span id="l66.787" class="difflineminus">-    case nsIAbBooleanConditionTypes::BeginsWith :</span>
<a href="#l66.788"></a><span id="l66.788" class="difflineminus">-        aRestriction.rt = RES_CONTENT ;</span>
<a href="#l66.789"></a><span id="l66.789" class="difflineminus">-        aRestriction.res.resContent.ulFuzzyLevel = FL_PREFIX | FL_LOOSE ;</span>
<a href="#l66.790"></a><span id="l66.790" class="difflineminus">-        aRestriction.res.resContent.ulPropTag = propertyTag ;</span>
<a href="#l66.791"></a><span id="l66.791" class="difflineminus">-        aRestriction.res.resContent.lpProp = new SPropValue ;</span>
<a href="#l66.792"></a><span id="l66.792" class="difflineminus">-        aRestriction.res.resContent.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.793"></a><span id="l66.793" class="difflineminus">-        aRestriction.res.resContent.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.794"></a><span id="l66.794" class="difflineminus">-        break ;</span>
<a href="#l66.795"></a><span id="l66.795" class="difflineminus">-    case nsIAbBooleanConditionTypes::EndsWith :</span>
<a href="#l66.796"></a><span id="l66.796" class="difflineminus">-        // This condition should be implemented through regular expressions,</span>
<a href="#l66.797"></a><span id="l66.797" class="difflineminus">-        // but MAPI doesn't match them correctly.</span>
<a href="#l66.798"></a><span id="l66.798" class="difflineplus">+  retCode = aCondition-&gt;GetCondition(&amp;conditionType);</span>
<a href="#l66.799"></a><span id="l66.799" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.800"></a><span id="l66.800" class="difflineplus">+  retCode = aCondition-&gt;GetName(getter_Copies(name));</span>
<a href="#l66.801"></a><span id="l66.801" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.802"></a><span id="l66.802" class="difflineplus">+  retCode = aCondition-&gt;GetValue(getter_Copies(value));</span>
<a href="#l66.803"></a><span id="l66.803" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.804"></a><span id="l66.804" class="difflineplus">+  LossyCopyUTF16toASCII(value, valueAscii);</span>
<a href="#l66.805"></a><span id="l66.805" class="difflineplus">+  propertyTag = findPropertyTag(name.get());</span>
<a href="#l66.806"></a><span id="l66.806" class="difflineplus">+  if (propertyTag == 0) {</span>
<a href="#l66.807"></a><span id="l66.807" class="difflineplus">+    aSkipItem = true;</span>
<a href="#l66.808"></a><span id="l66.808" class="difflineplus">+    return retCode;</span>
<a href="#l66.809"></a><span id="l66.809" class="difflineplus">+  }</span>
<a href="#l66.810"></a><span id="l66.810" class="difflineplus">+  switch (conditionType) {</span>
<a href="#l66.811"></a><span id="l66.811" class="difflineplus">+    case nsIAbBooleanConditionTypes::Exists:</span>
<a href="#l66.812"></a><span id="l66.812" class="difflineplus">+      aRestriction.rt = RES_EXIST;</span>
<a href="#l66.813"></a><span id="l66.813" class="difflineplus">+      aRestriction.res.resExist.ulPropTag = propertyTag;</span>
<a href="#l66.814"></a><span id="l66.814" class="difflineplus">+      break;</span>
<a href="#l66.815"></a><span id="l66.815" class="difflineplus">+    case nsIAbBooleanConditionTypes::DoesNotExist:</span>
<a href="#l66.816"></a><span id="l66.816" class="difflineplus">+      aRestriction.rt = RES_NOT;</span>
<a href="#l66.817"></a><span id="l66.817" class="difflineplus">+      aRestriction.res.resNot.lpRes = new SRestriction;</span>
<a href="#l66.818"></a><span id="l66.818" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;rt = RES_EXIST;</span>
<a href="#l66.819"></a><span id="l66.819" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resExist.ulPropTag = propertyTag;</span>
<a href="#l66.820"></a><span id="l66.820" class="difflineplus">+      break;</span>
<a href="#l66.821"></a><span id="l66.821" class="difflineplus">+    case nsIAbBooleanConditionTypes::Contains:</span>
<a href="#l66.822"></a><span id="l66.822" class="difflineplus">+      aRestriction.rt = RES_CONTENT;</span>
<a href="#l66.823"></a><span id="l66.823" class="difflineplus">+      aRestriction.res.resContent.ulFuzzyLevel = FL_SUBSTRING | FL_LOOSE;</span>
<a href="#l66.824"></a><span id="l66.824" class="difflineplus">+      aRestriction.res.resContent.ulPropTag = propertyTag;</span>
<a href="#l66.825"></a><span id="l66.825" class="difflineplus">+      aRestriction.res.resContent.lpProp = new SPropValue;</span>
<a href="#l66.826"></a><span id="l66.826" class="difflineplus">+      aRestriction.res.resContent.lpProp-&gt;ulPropTag = propertyTag;</span>
<a href="#l66.827"></a><span id="l66.827" class="difflineplus">+      aRestriction.res.resContent.lpProp-&gt;Value.lpszA =</span>
<a href="#l66.828"></a><span id="l66.828" class="difflineplus">+          strdup(valueAscii.get());</span>
<a href="#l66.829"></a><span id="l66.829" class="difflineplus">+      break;</span>
<a href="#l66.830"></a><span id="l66.830" class="difflineplus">+    case nsIAbBooleanConditionTypes::DoesNotContain:</span>
<a href="#l66.831"></a><span id="l66.831" class="difflineplus">+      aRestriction.rt = RES_NOT;</span>
<a href="#l66.832"></a><span id="l66.832" class="difflineplus">+      aRestriction.res.resNot.lpRes = new SRestriction;</span>
<a href="#l66.833"></a><span id="l66.833" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;rt = RES_CONTENT;</span>
<a href="#l66.834"></a><span id="l66.834" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.ulFuzzyLevel =</span>
<a href="#l66.835"></a><span id="l66.835" class="difflineplus">+          FL_SUBSTRING | FL_LOOSE;</span>
<a href="#l66.836"></a><span id="l66.836" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.ulPropTag = propertyTag;</span>
<a href="#l66.837"></a><span id="l66.837" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp = new SPropValue;</span>
<a href="#l66.838"></a><span id="l66.838" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;ulPropTag =</span>
<a href="#l66.839"></a><span id="l66.839" class="difflineplus">+          propertyTag;</span>
<a href="#l66.840"></a><span id="l66.840" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;Value.lpszA =</span>
<a href="#l66.841"></a><span id="l66.841" class="difflineplus">+          strdup(valueAscii.get());</span>
<a href="#l66.842"></a><span id="l66.842" class="difflineplus">+      break;</span>
<a href="#l66.843"></a><span id="l66.843" class="difflineplus">+    case nsIAbBooleanConditionTypes::Is:</span>
<a href="#l66.844"></a><span id="l66.844" class="difflineplus">+      aRestriction.rt = RES_CONTENT;</span>
<a href="#l66.845"></a><span id="l66.845" class="difflineplus">+      aRestriction.res.resContent.ulFuzzyLevel = FL_FULLSTRING | FL_LOOSE;</span>
<a href="#l66.846"></a><span id="l66.846" class="difflineplus">+      aRestriction.res.resContent.ulPropTag = propertyTag;</span>
<a href="#l66.847"></a><span id="l66.847" class="difflineplus">+      aRestriction.res.resContent.lpProp = new SPropValue;</span>
<a href="#l66.848"></a><span id="l66.848" class="difflineplus">+      aRestriction.res.resContent.lpProp-&gt;ulPropTag = propertyTag;</span>
<a href="#l66.849"></a><span id="l66.849" class="difflineplus">+      aRestriction.res.resContent.lpProp-&gt;Value.lpszA =</span>
<a href="#l66.850"></a><span id="l66.850" class="difflineplus">+          strdup(valueAscii.get());</span>
<a href="#l66.851"></a><span id="l66.851" class="difflineplus">+      break;</span>
<a href="#l66.852"></a><span id="l66.852" class="difflineplus">+    case nsIAbBooleanConditionTypes::IsNot:</span>
<a href="#l66.853"></a><span id="l66.853" class="difflineplus">+      aRestriction.rt = RES_NOT;</span>
<a href="#l66.854"></a><span id="l66.854" class="difflineplus">+      aRestriction.res.resNot.lpRes = new SRestriction;</span>
<a href="#l66.855"></a><span id="l66.855" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;rt = RES_CONTENT;</span>
<a href="#l66.856"></a><span id="l66.856" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.ulFuzzyLevel =</span>
<a href="#l66.857"></a><span id="l66.857" class="difflineplus">+          FL_FULLSTRING | FL_LOOSE;</span>
<a href="#l66.858"></a><span id="l66.858" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.ulPropTag = propertyTag;</span>
<a href="#l66.859"></a><span id="l66.859" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp = new SPropValue;</span>
<a href="#l66.860"></a><span id="l66.860" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;ulPropTag =</span>
<a href="#l66.861"></a><span id="l66.861" class="difflineplus">+          propertyTag;</span>
<a href="#l66.862"></a><span id="l66.862" class="difflineplus">+      aRestriction.res.resNot.lpRes-&gt;res.resContent.lpProp-&gt;Value.lpszA =</span>
<a href="#l66.863"></a><span id="l66.863" class="difflineplus">+          strdup(valueAscii.get());</span>
<a href="#l66.864"></a><span id="l66.864" class="difflineplus">+      break;</span>
<a href="#l66.865"></a><span id="l66.865" class="difflineplus">+    case nsIAbBooleanConditionTypes::BeginsWith:</span>
<a href="#l66.866"></a><span id="l66.866" class="difflineplus">+      aRestriction.rt = RES_CONTENT;</span>
<a href="#l66.867"></a><span id="l66.867" class="difflineplus">+      aRestriction.res.resContent.ulFuzzyLevel = FL_PREFIX | FL_LOOSE;</span>
<a href="#l66.868"></a><span id="l66.868" class="difflineplus">+      aRestriction.res.resContent.ulPropTag = propertyTag;</span>
<a href="#l66.869"></a><span id="l66.869" class="difflineplus">+      aRestriction.res.resContent.lpProp = new SPropValue;</span>
<a href="#l66.870"></a><span id="l66.870" class="difflineplus">+      aRestriction.res.resContent.lpProp-&gt;ulPropTag = propertyTag;</span>
<a href="#l66.871"></a><span id="l66.871" class="difflineplus">+      aRestriction.res.resContent.lpProp-&gt;Value.lpszA =</span>
<a href="#l66.872"></a><span id="l66.872" class="difflineplus">+          strdup(valueAscii.get());</span>
<a href="#l66.873"></a><span id="l66.873" class="difflineplus">+      break;</span>
<a href="#l66.874"></a><span id="l66.874" class="difflineplus">+    case nsIAbBooleanConditionTypes::EndsWith:</span>
<a href="#l66.875"></a><span id="l66.875" class="difflineplus">+      // This condition should be implemented through regular expressions,</span>
<a href="#l66.876"></a><span id="l66.876" class="difflineplus">+      // but MAPI doesn't match them correctly.</span>
<a href="#l66.877"></a><span id="l66.877"> #if 0</span>
<a href="#l66.878"></a><span id="l66.878">         aRestriction.rt = RES_PROPERTY ;</span>
<a href="#l66.879"></a><span id="l66.879">         aRestriction.res.resProperty.relop = RELOP_RE ;</span>
<a href="#l66.880"></a><span id="l66.880">         aRestriction.res.resProperty.ulPropTag = propertyTag ;</span>
<a href="#l66.881"></a><span id="l66.881">         aRestriction.res.resProperty.lpProp = new SPropValue ;</span>
<a href="#l66.882"></a><span id="l66.882">         aRestriction.res.resProperty.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.883"></a><span id="l66.883">         aRestriction.res.resProperty.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.884"></a><span id="l66.884"> #else</span>
<a href="#l66.885"></a><span id="l66.885" class="difflineminus">-        aSkipItem = true ;</span>
<a href="#l66.886"></a><span id="l66.886" class="difflineminus">-#endif // 0</span>
<a href="#l66.887"></a><span id="l66.887" class="difflineminus">-        break ;</span>
<a href="#l66.888"></a><span id="l66.888" class="difflineminus">-    case nsIAbBooleanConditionTypes::SoundsLike :</span>
<a href="#l66.889"></a><span id="l66.889" class="difflineminus">-        // This condition cannot be implemented in MAPI.</span>
<a href="#l66.890"></a><span id="l66.890" class="difflineminus">-        aSkipItem = true ;</span>
<a href="#l66.891"></a><span id="l66.891" class="difflineminus">-        break ;</span>
<a href="#l66.892"></a><span id="l66.892" class="difflineminus">-    case nsIAbBooleanConditionTypes::RegExp :</span>
<a href="#l66.893"></a><span id="l66.893" class="difflineminus">-        // This condition should be implemented this way, but the following</span>
<a href="#l66.894"></a><span id="l66.894" class="difflineminus">-        // code will never match (through MAPI's fault).</span>
<a href="#l66.895"></a><span id="l66.895" class="difflineplus">+      aSkipItem = true;</span>
<a href="#l66.896"></a><span id="l66.896" class="difflineplus">+#endif  // 0</span>
<a href="#l66.897"></a><span id="l66.897" class="difflineplus">+      break;</span>
<a href="#l66.898"></a><span id="l66.898" class="difflineplus">+    case nsIAbBooleanConditionTypes::SoundsLike:</span>
<a href="#l66.899"></a><span id="l66.899" class="difflineplus">+      // This condition cannot be implemented in MAPI.</span>
<a href="#l66.900"></a><span id="l66.900" class="difflineplus">+      aSkipItem = true;</span>
<a href="#l66.901"></a><span id="l66.901" class="difflineplus">+      break;</span>
<a href="#l66.902"></a><span id="l66.902" class="difflineplus">+    case nsIAbBooleanConditionTypes::RegExp:</span>
<a href="#l66.903"></a><span id="l66.903" class="difflineplus">+      // This condition should be implemented this way, but the following</span>
<a href="#l66.904"></a><span id="l66.904" class="difflineplus">+      // code will never match (through MAPI's fault).</span>
<a href="#l66.905"></a><span id="l66.905"> #if 0</span>
<a href="#l66.906"></a><span id="l66.906">         aRestriction.rt = RES_PROPERTY ;</span>
<a href="#l66.907"></a><span id="l66.907">         aRestriction.res.resProperty.relop = RELOP_RE ;</span>
<a href="#l66.908"></a><span id="l66.908">         aRestriction.res.resProperty.ulPropTag = propertyTag ;</span>
<a href="#l66.909"></a><span id="l66.909">         aRestriction.res.resProperty.lpProp = new SPropValue ;</span>
<a href="#l66.910"></a><span id="l66.910">         aRestriction.res.resProperty.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.911"></a><span id="l66.911">         aRestriction.res.resProperty.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.912"></a><span id="l66.912"> #else</span>
<a href="#l66.913"></a><span id="l66.913" class="difflineminus">-        aSkipItem = true ;</span>
<a href="#l66.914"></a><span id="l66.914" class="difflineminus">-#endif // 0</span>
<a href="#l66.915"></a><span id="l66.915" class="difflineminus">-        break ;</span>
<a href="#l66.916"></a><span id="l66.916" class="difflineminus">-    case nsIAbBooleanConditionTypes::LessThan :</span>
<a href="#l66.917"></a><span id="l66.917" class="difflineminus">-        aRestriction.rt = RES_PROPERTY ;</span>
<a href="#l66.918"></a><span id="l66.918" class="difflineminus">-        aRestriction.res.resProperty.relop = RELOP_LT ;</span>
<a href="#l66.919"></a><span id="l66.919" class="difflineminus">-        aRestriction.res.resProperty.ulPropTag = propertyTag ;</span>
<a href="#l66.920"></a><span id="l66.920" class="difflineminus">-        aRestriction.res.resProperty.lpProp = new SPropValue ;</span>
<a href="#l66.921"></a><span id="l66.921" class="difflineminus">-        aRestriction.res.resProperty.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.922"></a><span id="l66.922" class="difflineminus">-        aRestriction.res.resProperty.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.923"></a><span id="l66.923" class="difflineminus">-        break ;</span>
<a href="#l66.924"></a><span id="l66.924" class="difflineminus">-    case nsIAbBooleanConditionTypes::GreaterThan :</span>
<a href="#l66.925"></a><span id="l66.925" class="difflineminus">-        aRestriction.rt = RES_PROPERTY ;</span>
<a href="#l66.926"></a><span id="l66.926" class="difflineminus">-        aRestriction.res.resProperty.relop = RELOP_GT ;</span>
<a href="#l66.927"></a><span id="l66.927" class="difflineminus">-        aRestriction.res.resProperty.ulPropTag = propertyTag ;</span>
<a href="#l66.928"></a><span id="l66.928" class="difflineminus">-        aRestriction.res.resProperty.lpProp = new SPropValue ;</span>
<a href="#l66.929"></a><span id="l66.929" class="difflineminus">-        aRestriction.res.resProperty.lpProp-&gt;ulPropTag = propertyTag ;</span>
<a href="#l66.930"></a><span id="l66.930" class="difflineminus">-        aRestriction.res.resProperty.lpProp-&gt;Value.lpszA = strdup(valueAscii.get()) ;</span>
<a href="#l66.931"></a><span id="l66.931" class="difflineminus">-        break ;</span>
<a href="#l66.932"></a><span id="l66.932" class="difflineminus">-    default :</span>
<a href="#l66.933"></a><span id="l66.933" class="difflineminus">-        aSkipItem = true ;</span>
<a href="#l66.934"></a><span id="l66.934" class="difflineminus">-        break ;</span>
<a href="#l66.935"></a><span id="l66.935" class="difflineminus">-    }</span>
<a href="#l66.936"></a><span id="l66.936" class="difflineminus">-    return retCode ;</span>
<a href="#l66.937"></a><span id="l66.937" class="difflineplus">+      aSkipItem = true;</span>
<a href="#l66.938"></a><span id="l66.938" class="difflineplus">+#endif  // 0</span>
<a href="#l66.939"></a><span id="l66.939" class="difflineplus">+      break;</span>
<a href="#l66.940"></a><span id="l66.940" class="difflineplus">+    case nsIAbBooleanConditionTypes::LessThan:</span>
<a href="#l66.941"></a><span id="l66.941" class="difflineplus">+      aRestriction.rt = RES_PROPERTY;</span>
<a href="#l66.942"></a><span id="l66.942" class="difflineplus">+      aRestriction.res.resProperty.relop = RELOP_LT;</span>
<a href="#l66.943"></a><span id="l66.943" class="difflineplus">+      aRestriction.res.resProperty.ulPropTag = propertyTag;</span>
<a href="#l66.944"></a><span id="l66.944" class="difflineplus">+      aRestriction.res.resProperty.lpProp = new SPropValue;</span>
<a href="#l66.945"></a><span id="l66.945" class="difflineplus">+      aRestriction.res.resProperty.lpProp-&gt;ulPropTag = propertyTag;</span>
<a href="#l66.946"></a><span id="l66.946" class="difflineplus">+      aRestriction.res.resProperty.lpProp-&gt;Value.lpszA =</span>
<a href="#l66.947"></a><span id="l66.947" class="difflineplus">+          strdup(valueAscii.get());</span>
<a href="#l66.948"></a><span id="l66.948" class="difflineplus">+      break;</span>
<a href="#l66.949"></a><span id="l66.949" class="difflineplus">+    case nsIAbBooleanConditionTypes::GreaterThan:</span>
<a href="#l66.950"></a><span id="l66.950" class="difflineplus">+      aRestriction.rt = RES_PROPERTY;</span>
<a href="#l66.951"></a><span id="l66.951" class="difflineplus">+      aRestriction.res.resProperty.relop = RELOP_GT;</span>
<a href="#l66.952"></a><span id="l66.952" class="difflineplus">+      aRestriction.res.resProperty.ulPropTag = propertyTag;</span>
<a href="#l66.953"></a><span id="l66.953" class="difflineplus">+      aRestriction.res.resProperty.lpProp = new SPropValue;</span>
<a href="#l66.954"></a><span id="l66.954" class="difflineplus">+      aRestriction.res.resProperty.lpProp-&gt;ulPropTag = propertyTag;</span>
<a href="#l66.955"></a><span id="l66.955" class="difflineplus">+      aRestriction.res.resProperty.lpProp-&gt;Value.lpszA =</span>
<a href="#l66.956"></a><span id="l66.956" class="difflineplus">+          strdup(valueAscii.get());</span>
<a href="#l66.957"></a><span id="l66.957" class="difflineplus">+      break;</span>
<a href="#l66.958"></a><span id="l66.958" class="difflineplus">+    default:</span>
<a href="#l66.959"></a><span id="l66.959" class="difflineplus">+      aSkipItem = true;</span>
<a href="#l66.960"></a><span id="l66.960" class="difflineplus">+      break;</span>
<a href="#l66.961"></a><span id="l66.961" class="difflineplus">+  }</span>
<a href="#l66.962"></a><span id="l66.962" class="difflineplus">+  return retCode;</span>
<a href="#l66.963"></a><span id="l66.963"> }</span>
<a href="#l66.964"></a><span id="l66.964"> </span>
<a href="#l66.965"></a><span id="l66.965"> static nsresult BuildRestriction(nsIAbBooleanExpression *aLevel,</span>
<a href="#l66.966"></a><span id="l66.966" class="difflineminus">-                                 SRestriction&amp; aRestriction)</span>
<a href="#l66.967"></a><span id="l66.967" class="difflineminus">-{</span>
<a href="#l66.968"></a><span id="l66.968" class="difflineminus">-    if (!aLevel) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l66.969"></a><span id="l66.969" class="difflineminus">-    aRestriction.rt = RES_COMMENT ;</span>
<a href="#l66.970"></a><span id="l66.970" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.971"></a><span id="l66.971" class="difflineminus">-    nsAbBooleanOperationType operationType = 0 ;</span>
<a href="#l66.972"></a><span id="l66.972" class="difflineminus">-    uint32_t nbExpressions = 0 ;</span>
<a href="#l66.973"></a><span id="l66.973" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; expressions;</span>
<a href="#l66.974"></a><span id="l66.974" class="difflineplus">+                                 SRestriction &amp;aRestriction) {</span>
<a href="#l66.975"></a><span id="l66.975" class="difflineplus">+  if (!aLevel) {</span>
<a href="#l66.976"></a><span id="l66.976" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.977"></a><span id="l66.977" class="difflineplus">+  }</span>
<a href="#l66.978"></a><span id="l66.978" class="difflineplus">+  aRestriction.rt = RES_COMMENT;</span>
<a href="#l66.979"></a><span id="l66.979" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.980"></a><span id="l66.980" class="difflineplus">+  nsAbBooleanOperationType operationType = 0;</span>
<a href="#l66.981"></a><span id="l66.981" class="difflineplus">+  uint32_t nbExpressions = 0;</span>
<a href="#l66.982"></a><span id="l66.982" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; expressions;</span>
<a href="#l66.983"></a><span id="l66.983"> </span>
<a href="#l66.984"></a><span id="l66.984" class="difflineminus">-    retCode = aLevel-&gt;GetOperation(&amp;operationType);</span>
<a href="#l66.985"></a><span id="l66.985" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.986"></a><span id="l66.986" class="difflineminus">-    retCode = aLevel-&gt;GetExpressions(getter_AddRefs(expressions));</span>
<a href="#l66.987"></a><span id="l66.987" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.988"></a><span id="l66.988" class="difflineminus">-    retCode = expressions-&gt;GetLength(&amp;nbExpressions);</span>
<a href="#l66.989"></a><span id="l66.989" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.990"></a><span id="l66.990" class="difflineminus">-    if (nbExpressions == 0) {</span>
<a href="#l66.991"></a><span id="l66.991" class="difflineminus">-        PRINTF((&quot;Error, no expressions.\n&quot;)) ;</span>
<a href="#l66.992"></a><span id="l66.992" class="difflineminus">-        return NS_OK ;</span>
<a href="#l66.993"></a><span id="l66.993" class="difflineminus">-    }</span>
<a href="#l66.994"></a><span id="l66.994" class="difflineminus">-    if (operationType == nsIAbBooleanOperationTypes::NOT &amp;&amp; nbExpressions != 1) {</span>
<a href="#l66.995"></a><span id="l66.995" class="difflineminus">-        PRINTF((&quot;Error, unary operation NOT with multiple operands.\n&quot;)) ;</span>
<a href="#l66.996"></a><span id="l66.996" class="difflineminus">-        return NS_OK ;</span>
<a href="#l66.997"></a><span id="l66.997" class="difflineminus">-    }</span>
<a href="#l66.998"></a><span id="l66.998" class="difflineminus">-    LPSRestriction restrictionArray = new SRestriction[nbExpressions] ;</span>
<a href="#l66.999"></a><span id="l66.999" class="difflineminus">-    uint32_t realNbExpressions = 0 ;</span>
<a href="#l66.1000"></a><span id="l66.1000" class="difflineminus">-    bool skipItem = false ;</span>
<a href="#l66.1001"></a><span id="l66.1001" class="difflineminus">-    uint32_t i = 0 ;</span>
<a href="#l66.1002"></a><span id="l66.1002" class="difflineplus">+  retCode = aLevel-&gt;GetOperation(&amp;operationType);</span>
<a href="#l66.1003"></a><span id="l66.1003" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1004"></a><span id="l66.1004" class="difflineplus">+  retCode = aLevel-&gt;GetExpressions(getter_AddRefs(expressions));</span>
<a href="#l66.1005"></a><span id="l66.1005" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1006"></a><span id="l66.1006" class="difflineplus">+  retCode = expressions-&gt;GetLength(&amp;nbExpressions);</span>
<a href="#l66.1007"></a><span id="l66.1007" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1008"></a><span id="l66.1008" class="difflineplus">+  if (nbExpressions == 0) {</span>
<a href="#l66.1009"></a><span id="l66.1009" class="difflineplus">+    PRINTF((&quot;Error, no expressions.\n&quot;));</span>
<a href="#l66.1010"></a><span id="l66.1010" class="difflineplus">+    return NS_OK;</span>
<a href="#l66.1011"></a><span id="l66.1011" class="difflineplus">+  }</span>
<a href="#l66.1012"></a><span id="l66.1012" class="difflineplus">+  if (operationType == nsIAbBooleanOperationTypes::NOT &amp;&amp; nbExpressions != 1) {</span>
<a href="#l66.1013"></a><span id="l66.1013" class="difflineplus">+    PRINTF((&quot;Error, unary operation NOT with multiple operands.\n&quot;));</span>
<a href="#l66.1014"></a><span id="l66.1014" class="difflineplus">+    return NS_OK;</span>
<a href="#l66.1015"></a><span id="l66.1015" class="difflineplus">+  }</span>
<a href="#l66.1016"></a><span id="l66.1016" class="difflineplus">+  LPSRestriction restrictionArray = new SRestriction[nbExpressions];</span>
<a href="#l66.1017"></a><span id="l66.1017" class="difflineplus">+  uint32_t realNbExpressions = 0;</span>
<a href="#l66.1018"></a><span id="l66.1018" class="difflineplus">+  bool skipItem = false;</span>
<a href="#l66.1019"></a><span id="l66.1019" class="difflineplus">+  uint32_t i = 0;</span>
<a href="#l66.1020"></a><span id="l66.1020"> </span>
<a href="#l66.1021"></a><span id="l66.1021" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanConditionString&gt; condition;</span>
<a href="#l66.1022"></a><span id="l66.1022" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; subExpression;</span>
<a href="#l66.1023"></a><span id="l66.1023" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanConditionString&gt; condition;</span>
<a href="#l66.1024"></a><span id="l66.1024" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; subExpression;</span>
<a href="#l66.1025"></a><span id="l66.1025" class="difflineplus">+</span>
<a href="#l66.1026"></a><span id="l66.1026" class="difflineplus">+  for (i = 0; i &lt; nbExpressions; ++i) {</span>
<a href="#l66.1027"></a><span id="l66.1027" class="difflineplus">+    condition = do_QueryElementAt(expressions, i, &amp;retCode);</span>
<a href="#l66.1028"></a><span id="l66.1028"> </span>
<a href="#l66.1029"></a><span id="l66.1029" class="difflineminus">-    for (i = 0; i &lt; nbExpressions; ++i) {</span>
<a href="#l66.1030"></a><span id="l66.1030" class="difflineminus">-      condition = do_QueryElementAt(expressions, i, &amp;retCode);</span>
<a href="#l66.1031"></a><span id="l66.1031" class="difflineplus">+    if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l66.1032"></a><span id="l66.1032" class="difflineplus">+      retCode = BuildRestriction(condition, *restrictionArray, skipItem);</span>
<a href="#l66.1033"></a><span id="l66.1033" class="difflineplus">+      if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l66.1034"></a><span id="l66.1034" class="difflineplus">+        if (!skipItem) {</span>
<a href="#l66.1035"></a><span id="l66.1035" class="difflineplus">+          ++restrictionArray;</span>
<a href="#l66.1036"></a><span id="l66.1036" class="difflineplus">+          ++realNbExpressions;</span>
<a href="#l66.1037"></a><span id="l66.1037" class="difflineplus">+        }</span>
<a href="#l66.1038"></a><span id="l66.1038" class="difflineplus">+      } else</span>
<a href="#l66.1039"></a><span id="l66.1039" class="difflineplus">+        PRINTF((&quot;Cannot build restriction for item %d %08x.\n&quot;, i, retCode));</span>
<a href="#l66.1040"></a><span id="l66.1040" class="difflineplus">+    } else {</span>
<a href="#l66.1041"></a><span id="l66.1041" class="difflineplus">+      subExpression = do_QueryElementAt(expressions, i, &amp;retCode);</span>
<a href="#l66.1042"></a><span id="l66.1042"> </span>
<a href="#l66.1043"></a><span id="l66.1043">       if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l66.1044"></a><span id="l66.1044" class="difflineminus">-        retCode = BuildRestriction(condition, *restrictionArray, skipItem);</span>
<a href="#l66.1045"></a><span id="l66.1045" class="difflineplus">+        retCode = BuildRestriction(subExpression, *restrictionArray);</span>
<a href="#l66.1046"></a><span id="l66.1046">         if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l66.1047"></a><span id="l66.1047" class="difflineminus">-          if (!skipItem) {</span>
<a href="#l66.1048"></a><span id="l66.1048" class="difflineplus">+          if (restrictionArray-&gt;rt != RES_COMMENT) {</span>
<a href="#l66.1049"></a><span id="l66.1049">             ++restrictionArray;</span>
<a href="#l66.1050"></a><span id="l66.1050">             ++realNbExpressions;</span>
<a href="#l66.1051"></a><span id="l66.1051">           }</span>
<a href="#l66.1052"></a><span id="l66.1052">         }</span>
<a href="#l66.1053"></a><span id="l66.1053" class="difflineminus">-        else</span>
<a href="#l66.1054"></a><span id="l66.1054" class="difflineminus">-          PRINTF((&quot;Cannot build restriction for item %d %08x.\n&quot;, i, retCode));</span>
<a href="#l66.1055"></a><span id="l66.1055" class="difflineminus">-      }</span>
<a href="#l66.1056"></a><span id="l66.1056" class="difflineminus">-      else {</span>
<a href="#l66.1057"></a><span id="l66.1057" class="difflineminus">-        subExpression = do_QueryElementAt(expressions, i, &amp;retCode);</span>
<a href="#l66.1058"></a><span id="l66.1058" class="difflineminus">-</span>
<a href="#l66.1059"></a><span id="l66.1059" class="difflineminus">-        if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l66.1060"></a><span id="l66.1060" class="difflineminus">-          retCode = BuildRestriction(subExpression, *restrictionArray);</span>
<a href="#l66.1061"></a><span id="l66.1061" class="difflineminus">-          if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l66.1062"></a><span id="l66.1062" class="difflineminus">-            if (restrictionArray-&gt;rt != RES_COMMENT) {</span>
<a href="#l66.1063"></a><span id="l66.1063" class="difflineminus">-              ++restrictionArray;</span>
<a href="#l66.1064"></a><span id="l66.1064" class="difflineminus">-              ++realNbExpressions;</span>
<a href="#l66.1065"></a><span id="l66.1065" class="difflineminus">-            }</span>
<a href="#l66.1066"></a><span id="l66.1066" class="difflineminus">-          }</span>
<a href="#l66.1067"></a><span id="l66.1067" class="difflineminus">-        }</span>
<a href="#l66.1068"></a><span id="l66.1068" class="difflineminus">-        else</span>
<a href="#l66.1069"></a><span id="l66.1069" class="difflineminus">-          PRINTF((&quot;Cannot get interface for item %d %08x.\n&quot;, i, retCode));</span>
<a href="#l66.1070"></a><span id="l66.1070" class="difflineminus">-      }</span>
<a href="#l66.1071"></a><span id="l66.1071" class="difflineplus">+      } else</span>
<a href="#l66.1072"></a><span id="l66.1072" class="difflineplus">+        PRINTF((&quot;Cannot get interface for item %d %08x.\n&quot;, i, retCode));</span>
<a href="#l66.1073"></a><span id="l66.1073">     }</span>
<a href="#l66.1074"></a><span id="l66.1074" class="difflineplus">+  }</span>
<a href="#l66.1075"></a><span id="l66.1075"> </span>
<a href="#l66.1076"></a><span id="l66.1076" class="difflineminus">-    restrictionArray -= realNbExpressions ;</span>
<a href="#l66.1077"></a><span id="l66.1077" class="difflineminus">-    if (realNbExpressions &gt; 1) {</span>
<a href="#l66.1078"></a><span id="l66.1078" class="difflineminus">-        if (operationType == nsIAbBooleanOperationTypes::OR) {</span>
<a href="#l66.1079"></a><span id="l66.1079" class="difflineminus">-            aRestriction.rt = RES_OR ;</span>
<a href="#l66.1080"></a><span id="l66.1080" class="difflineminus">-            aRestriction.res.resOr.lpRes = restrictionArray ;</span>
<a href="#l66.1081"></a><span id="l66.1081" class="difflineminus">-            aRestriction.res.resOr.cRes = realNbExpressions ;</span>
<a href="#l66.1082"></a><span id="l66.1082" class="difflineminus">-        }</span>
<a href="#l66.1083"></a><span id="l66.1083" class="difflineminus">-        else if (operationType == nsIAbBooleanOperationTypes::AND) {</span>
<a href="#l66.1084"></a><span id="l66.1084" class="difflineminus">-            aRestriction.rt = RES_AND ;</span>
<a href="#l66.1085"></a><span id="l66.1085" class="difflineminus">-            aRestriction.res.resAnd.lpRes = restrictionArray ;</span>
<a href="#l66.1086"></a><span id="l66.1086" class="difflineminus">-            aRestriction.res.resAnd.cRes = realNbExpressions ;</span>
<a href="#l66.1087"></a><span id="l66.1087" class="difflineminus">-        }</span>
<a href="#l66.1088"></a><span id="l66.1088" class="difflineminus">-        else {</span>
<a href="#l66.1089"></a><span id="l66.1089" class="difflineminus">-            PRINTF((&quot;Unsupported operation %d.\n&quot;, operationType)) ;</span>
<a href="#l66.1090"></a><span id="l66.1090" class="difflineminus">-        }</span>
<a href="#l66.1091"></a><span id="l66.1091" class="difflineplus">+  restrictionArray -= realNbExpressions;</span>
<a href="#l66.1092"></a><span id="l66.1092" class="difflineplus">+  if (realNbExpressions &gt; 1) {</span>
<a href="#l66.1093"></a><span id="l66.1093" class="difflineplus">+    if (operationType == nsIAbBooleanOperationTypes::OR) {</span>
<a href="#l66.1094"></a><span id="l66.1094" class="difflineplus">+      aRestriction.rt = RES_OR;</span>
<a href="#l66.1095"></a><span id="l66.1095" class="difflineplus">+      aRestriction.res.resOr.lpRes = restrictionArray;</span>
<a href="#l66.1096"></a><span id="l66.1096" class="difflineplus">+      aRestriction.res.resOr.cRes = realNbExpressions;</span>
<a href="#l66.1097"></a><span id="l66.1097" class="difflineplus">+    } else if (operationType == nsIAbBooleanOperationTypes::AND) {</span>
<a href="#l66.1098"></a><span id="l66.1098" class="difflineplus">+      aRestriction.rt = RES_AND;</span>
<a href="#l66.1099"></a><span id="l66.1099" class="difflineplus">+      aRestriction.res.resAnd.lpRes = restrictionArray;</span>
<a href="#l66.1100"></a><span id="l66.1100" class="difflineplus">+      aRestriction.res.resAnd.cRes = realNbExpressions;</span>
<a href="#l66.1101"></a><span id="l66.1101" class="difflineplus">+    } else {</span>
<a href="#l66.1102"></a><span id="l66.1102" class="difflineplus">+      PRINTF((&quot;Unsupported operation %d.\n&quot;, operationType));</span>
<a href="#l66.1103"></a><span id="l66.1103">     }</span>
<a href="#l66.1104"></a><span id="l66.1104" class="difflineminus">-    else if (realNbExpressions == 1) {</span>
<a href="#l66.1105"></a><span id="l66.1105" class="difflineminus">-        if (operationType == nsIAbBooleanOperationTypes::NOT) {</span>
<a href="#l66.1106"></a><span id="l66.1106" class="difflineminus">-            aRestriction.rt = RES_NOT ;</span>
<a href="#l66.1107"></a><span id="l66.1107" class="difflineminus">-            // This copy is to ensure that every NOT restriction is being</span>
<a href="#l66.1108"></a><span id="l66.1108" class="difflineminus">-            // allocated by new and not new[] (see destruction of restriction)</span>
<a href="#l66.1109"></a><span id="l66.1109" class="difflineminus">-            aRestriction.res.resNot.lpRes = new SRestriction ;</span>
<a href="#l66.1110"></a><span id="l66.1110" class="difflineminus">-            memcpy(aRestriction.res.resNot.lpRes, restrictionArray, sizeof(SRestriction)) ;</span>
<a href="#l66.1111"></a><span id="l66.1111" class="difflineminus">-        }</span>
<a href="#l66.1112"></a><span id="l66.1112" class="difflineminus">-        else {</span>
<a href="#l66.1113"></a><span id="l66.1113" class="difflineminus">-            // Case where the restriction array is redundant,</span>
<a href="#l66.1114"></a><span id="l66.1114" class="difflineminus">-            // we need to fill the restriction directly.</span>
<a href="#l66.1115"></a><span id="l66.1115" class="difflineminus">-            memcpy(&amp;aRestriction, restrictionArray, sizeof(SRestriction)) ;</span>
<a href="#l66.1116"></a><span id="l66.1116" class="difflineminus">-        }</span>
<a href="#l66.1117"></a><span id="l66.1117" class="difflineminus">-        delete [] restrictionArray ;</span>
<a href="#l66.1118"></a><span id="l66.1118" class="difflineplus">+  } else if (realNbExpressions == 1) {</span>
<a href="#l66.1119"></a><span id="l66.1119" class="difflineplus">+    if (operationType == nsIAbBooleanOperationTypes::NOT) {</span>
<a href="#l66.1120"></a><span id="l66.1120" class="difflineplus">+      aRestriction.rt = RES_NOT;</span>
<a href="#l66.1121"></a><span id="l66.1121" class="difflineplus">+      // This copy is to ensure that every NOT restriction is being</span>
<a href="#l66.1122"></a><span id="l66.1122" class="difflineplus">+      // allocated by new and not new[] (see destruction of restriction)</span>
<a href="#l66.1123"></a><span id="l66.1123" class="difflineplus">+      aRestriction.res.resNot.lpRes = new SRestriction;</span>
<a href="#l66.1124"></a><span id="l66.1124" class="difflineplus">+      memcpy(aRestriction.res.resNot.lpRes, restrictionArray,</span>
<a href="#l66.1125"></a><span id="l66.1125" class="difflineplus">+             sizeof(SRestriction));</span>
<a href="#l66.1126"></a><span id="l66.1126" class="difflineplus">+    } else {</span>
<a href="#l66.1127"></a><span id="l66.1127" class="difflineplus">+      // Case where the restriction array is redundant,</span>
<a href="#l66.1128"></a><span id="l66.1128" class="difflineplus">+      // we need to fill the restriction directly.</span>
<a href="#l66.1129"></a><span id="l66.1129" class="difflineplus">+      memcpy(&amp;aRestriction, restrictionArray, sizeof(SRestriction));</span>
<a href="#l66.1130"></a><span id="l66.1130">     }</span>
<a href="#l66.1131"></a><span id="l66.1131" class="difflineminus">-    if (aRestriction.rt == RES_COMMENT) {</span>
<a href="#l66.1132"></a><span id="l66.1132" class="difflineminus">-        // This means we haven't really built any useful expression</span>
<a href="#l66.1133"></a><span id="l66.1133" class="difflineminus">-        delete [] restrictionArray ;</span>
<a href="#l66.1134"></a><span id="l66.1134" class="difflineminus">-    }</span>
<a href="#l66.1135"></a><span id="l66.1135" class="difflineminus">-    return NS_OK ;</span>
<a href="#l66.1136"></a><span id="l66.1136" class="difflineplus">+    delete[] restrictionArray;</span>
<a href="#l66.1137"></a><span id="l66.1137" class="difflineplus">+  }</span>
<a href="#l66.1138"></a><span id="l66.1138" class="difflineplus">+  if (aRestriction.rt == RES_COMMENT) {</span>
<a href="#l66.1139"></a><span id="l66.1139" class="difflineplus">+    // This means we haven't really built any useful expression</span>
<a href="#l66.1140"></a><span id="l66.1140" class="difflineplus">+    delete[] restrictionArray;</span>
<a href="#l66.1141"></a><span id="l66.1141" class="difflineplus">+  }</span>
<a href="#l66.1142"></a><span id="l66.1142" class="difflineplus">+  return NS_OK;</span>
<a href="#l66.1143"></a><span id="l66.1143"> }</span>
<a href="#l66.1144"></a><span id="l66.1144"> </span>
<a href="#l66.1145"></a><span id="l66.1145"> static nsresult BuildRestriction(nsIAbDirectoryQueryArguments *aArguments,</span>
<a href="#l66.1146"></a><span id="l66.1146" class="difflineminus">-                                 SRestriction&amp; aRestriction)</span>
<a href="#l66.1147"></a><span id="l66.1147" class="difflineminus">-{</span>
<a href="#l66.1148"></a><span id="l66.1148" class="difflineminus">-    if (!aArguments) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l66.1149"></a><span id="l66.1149" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.1150"></a><span id="l66.1150" class="difflineplus">+                                 SRestriction &amp;aRestriction) {</span>
<a href="#l66.1151"></a><span id="l66.1151" class="difflineplus">+  if (!aArguments) {</span>
<a href="#l66.1152"></a><span id="l66.1152" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.1153"></a><span id="l66.1153" class="difflineplus">+  }</span>
<a href="#l66.1154"></a><span id="l66.1154" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.1155"></a><span id="l66.1155"> </span>
<a href="#l66.1156"></a><span id="l66.1156" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; supports ;</span>
<a href="#l66.1157"></a><span id="l66.1157" class="difflineminus">-    retCode = aArguments-&gt;GetExpression(getter_AddRefs(supports)) ;</span>
<a href="#l66.1158"></a><span id="l66.1158" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1159"></a><span id="l66.1159" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; booleanQuery =</span>
<a href="#l66.1160"></a><span id="l66.1160" class="difflineminus">-      do_QueryInterface(supports, &amp;retCode) ;</span>
<a href="#l66.1161"></a><span id="l66.1161" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1162"></a><span id="l66.1162" class="difflineminus">-    retCode = BuildRestriction(booleanQuery, aRestriction) ;</span>
<a href="#l66.1163"></a><span id="l66.1163" class="difflineminus">-    return retCode ;</span>
<a href="#l66.1164"></a><span id="l66.1164" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l66.1165"></a><span id="l66.1165" class="difflineplus">+  retCode = aArguments-&gt;GetExpression(getter_AddRefs(supports));</span>
<a href="#l66.1166"></a><span id="l66.1166" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1167"></a><span id="l66.1167" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; booleanQuery =</span>
<a href="#l66.1168"></a><span id="l66.1168" class="difflineplus">+      do_QueryInterface(supports, &amp;retCode);</span>
<a href="#l66.1169"></a><span id="l66.1169" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1170"></a><span id="l66.1170" class="difflineplus">+  retCode = BuildRestriction(booleanQuery, aRestriction);</span>
<a href="#l66.1171"></a><span id="l66.1171" class="difflineplus">+  return retCode;</span>
<a href="#l66.1172"></a><span id="l66.1172"> }</span>
<a href="#l66.1173"></a><span id="l66.1173"> </span>
<a href="#l66.1174"></a><span id="l66.1174" class="difflineminus">-static void DestroyRestriction(SRestriction&amp; aRestriction)</span>
<a href="#l66.1175"></a><span id="l66.1175" class="difflineminus">-{</span>
<a href="#l66.1176"></a><span id="l66.1176" class="difflineminus">-    switch(aRestriction.rt) {</span>
<a href="#l66.1177"></a><span id="l66.1177" class="difflineminus">-    case RES_AND :</span>
<a href="#l66.1178"></a><span id="l66.1178" class="difflineminus">-    case RES_OR :</span>
<a href="#l66.1179"></a><span id="l66.1179" class="difflineminus">-        {</span>
<a href="#l66.1180"></a><span id="l66.1180" class="difflineminus">-            for (ULONG i = 0 ; i &lt; aRestriction.res.resAnd.cRes ; ++i) {</span>
<a href="#l66.1181"></a><span id="l66.1181" class="difflineminus">-                DestroyRestriction(aRestriction.res.resAnd.lpRes[i]) ;</span>
<a href="#l66.1182"></a><span id="l66.1182" class="difflineminus">-            }</span>
<a href="#l66.1183"></a><span id="l66.1183" class="difflineminus">-            delete [] aRestriction.res.resAnd.lpRes ;</span>
<a href="#l66.1184"></a><span id="l66.1184" class="difflineminus">-        }</span>
<a href="#l66.1185"></a><span id="l66.1185" class="difflineminus">-        break ;</span>
<a href="#l66.1186"></a><span id="l66.1186" class="difflineminus">-    case RES_COMMENT :</span>
<a href="#l66.1187"></a><span id="l66.1187" class="difflineminus">-        break ;</span>
<a href="#l66.1188"></a><span id="l66.1188" class="difflineminus">-    case RES_CONTENT :</span>
<a href="#l66.1189"></a><span id="l66.1189" class="difflineminus">-        if (PROP_TYPE(aRestriction.res.resContent.ulPropTag) == PT_UNICODE) {</span>
<a href="#l66.1190"></a><span id="l66.1190" class="difflineminus">-            free(aRestriction.res.resContent.lpProp-&gt;Value.lpszW) ;</span>
<a href="#l66.1191"></a><span id="l66.1191" class="difflineminus">-        }</span>
<a href="#l66.1192"></a><span id="l66.1192" class="difflineminus">-        else if (PROP_TYPE(aRestriction.res.resContent.ulPropTag) == PT_STRING8) {</span>
<a href="#l66.1193"></a><span id="l66.1193" class="difflineminus">-            free(aRestriction.res.resContent.lpProp-&gt;Value.lpszA) ;</span>
<a href="#l66.1194"></a><span id="l66.1194" class="difflineminus">-        }</span>
<a href="#l66.1195"></a><span id="l66.1195" class="difflineminus">-        delete aRestriction.res.resContent.lpProp ;</span>
<a href="#l66.1196"></a><span id="l66.1196" class="difflineminus">-        break ;</span>
<a href="#l66.1197"></a><span id="l66.1197" class="difflineminus">-    case RES_EXIST :</span>
<a href="#l66.1198"></a><span id="l66.1198" class="difflineminus">-        break ;</span>
<a href="#l66.1199"></a><span id="l66.1199" class="difflineminus">-    case RES_NOT :</span>
<a href="#l66.1200"></a><span id="l66.1200" class="difflineminus">-        DestroyRestriction(*aRestriction.res.resNot.lpRes) ;</span>
<a href="#l66.1201"></a><span id="l66.1201" class="difflineminus">-        delete aRestriction.res.resNot.lpRes ;</span>
<a href="#l66.1202"></a><span id="l66.1202" class="difflineminus">-        break ;</span>
<a href="#l66.1203"></a><span id="l66.1203" class="difflineminus">-    case RES_BITMASK :</span>
<a href="#l66.1204"></a><span id="l66.1204" class="difflineminus">-    case RES_COMPAREPROPS :</span>
<a href="#l66.1205"></a><span id="l66.1205" class="difflineminus">-        break ;</span>
<a href="#l66.1206"></a><span id="l66.1206" class="difflineminus">-    case RES_PROPERTY :</span>
<a href="#l66.1207"></a><span id="l66.1207" class="difflineminus">-        if (PROP_TYPE(aRestriction.res.resProperty.ulPropTag) == PT_UNICODE) {</span>
<a href="#l66.1208"></a><span id="l66.1208" class="difflineminus">-            free(aRestriction.res.resProperty.lpProp-&gt;Value.lpszW) ;</span>
<a href="#l66.1209"></a><span id="l66.1209" class="difflineminus">-        }</span>
<a href="#l66.1210"></a><span id="l66.1210" class="difflineminus">-        else if (PROP_TYPE(aRestriction.res.resProperty.ulPropTag) == PT_STRING8) {</span>
<a href="#l66.1211"></a><span id="l66.1211" class="difflineminus">-            free(aRestriction.res.resProperty.lpProp-&gt;Value.lpszA) ;</span>
<a href="#l66.1212"></a><span id="l66.1212" class="difflineminus">-        }</span>
<a href="#l66.1213"></a><span id="l66.1213" class="difflineminus">-        delete aRestriction.res.resProperty.lpProp ;</span>
<a href="#l66.1214"></a><span id="l66.1214" class="difflineminus">-    case RES_SIZE :</span>
<a href="#l66.1215"></a><span id="l66.1215" class="difflineminus">-    case RES_SUBRESTRICTION :</span>
<a href="#l66.1216"></a><span id="l66.1216" class="difflineminus">-        break ;</span>
<a href="#l66.1217"></a><span id="l66.1217" class="difflineminus">-    }</span>
<a href="#l66.1218"></a><span id="l66.1218" class="difflineplus">+static void DestroyRestriction(SRestriction &amp;aRestriction) {</span>
<a href="#l66.1219"></a><span id="l66.1219" class="difflineplus">+  switch (aRestriction.rt) {</span>
<a href="#l66.1220"></a><span id="l66.1220" class="difflineplus">+    case RES_AND:</span>
<a href="#l66.1221"></a><span id="l66.1221" class="difflineplus">+    case RES_OR: {</span>
<a href="#l66.1222"></a><span id="l66.1222" class="difflineplus">+      for (ULONG i = 0; i &lt; aRestriction.res.resAnd.cRes; ++i) {</span>
<a href="#l66.1223"></a><span id="l66.1223" class="difflineplus">+        DestroyRestriction(aRestriction.res.resAnd.lpRes[i]);</span>
<a href="#l66.1224"></a><span id="l66.1224" class="difflineplus">+      }</span>
<a href="#l66.1225"></a><span id="l66.1225" class="difflineplus">+      delete[] aRestriction.res.resAnd.lpRes;</span>
<a href="#l66.1226"></a><span id="l66.1226" class="difflineplus">+    } break;</span>
<a href="#l66.1227"></a><span id="l66.1227" class="difflineplus">+    case RES_COMMENT:</span>
<a href="#l66.1228"></a><span id="l66.1228" class="difflineplus">+      break;</span>
<a href="#l66.1229"></a><span id="l66.1229" class="difflineplus">+    case RES_CONTENT:</span>
<a href="#l66.1230"></a><span id="l66.1230" class="difflineplus">+      if (PROP_TYPE(aRestriction.res.resContent.ulPropTag) == PT_UNICODE) {</span>
<a href="#l66.1231"></a><span id="l66.1231" class="difflineplus">+        free(aRestriction.res.resContent.lpProp-&gt;Value.lpszW);</span>
<a href="#l66.1232"></a><span id="l66.1232" class="difflineplus">+      } else if (PROP_TYPE(aRestriction.res.resContent.ulPropTag) ==</span>
<a href="#l66.1233"></a><span id="l66.1233" class="difflineplus">+                 PT_STRING8) {</span>
<a href="#l66.1234"></a><span id="l66.1234" class="difflineplus">+        free(aRestriction.res.resContent.lpProp-&gt;Value.lpszA);</span>
<a href="#l66.1235"></a><span id="l66.1235" class="difflineplus">+      }</span>
<a href="#l66.1236"></a><span id="l66.1236" class="difflineplus">+      delete aRestriction.res.resContent.lpProp;</span>
<a href="#l66.1237"></a><span id="l66.1237" class="difflineplus">+      break;</span>
<a href="#l66.1238"></a><span id="l66.1238" class="difflineplus">+    case RES_EXIST:</span>
<a href="#l66.1239"></a><span id="l66.1239" class="difflineplus">+      break;</span>
<a href="#l66.1240"></a><span id="l66.1240" class="difflineplus">+    case RES_NOT:</span>
<a href="#l66.1241"></a><span id="l66.1241" class="difflineplus">+      DestroyRestriction(*aRestriction.res.resNot.lpRes);</span>
<a href="#l66.1242"></a><span id="l66.1242" class="difflineplus">+      delete aRestriction.res.resNot.lpRes;</span>
<a href="#l66.1243"></a><span id="l66.1243" class="difflineplus">+      break;</span>
<a href="#l66.1244"></a><span id="l66.1244" class="difflineplus">+    case RES_BITMASK:</span>
<a href="#l66.1245"></a><span id="l66.1245" class="difflineplus">+    case RES_COMPAREPROPS:</span>
<a href="#l66.1246"></a><span id="l66.1246" class="difflineplus">+      break;</span>
<a href="#l66.1247"></a><span id="l66.1247" class="difflineplus">+    case RES_PROPERTY:</span>
<a href="#l66.1248"></a><span id="l66.1248" class="difflineplus">+      if (PROP_TYPE(aRestriction.res.resProperty.ulPropTag) == PT_UNICODE) {</span>
<a href="#l66.1249"></a><span id="l66.1249" class="difflineplus">+        free(aRestriction.res.resProperty.lpProp-&gt;Value.lpszW);</span>
<a href="#l66.1250"></a><span id="l66.1250" class="difflineplus">+      } else if (PROP_TYPE(aRestriction.res.resProperty.ulPropTag) ==</span>
<a href="#l66.1251"></a><span id="l66.1251" class="difflineplus">+                 PT_STRING8) {</span>
<a href="#l66.1252"></a><span id="l66.1252" class="difflineplus">+        free(aRestriction.res.resProperty.lpProp-&gt;Value.lpszA);</span>
<a href="#l66.1253"></a><span id="l66.1253" class="difflineplus">+      }</span>
<a href="#l66.1254"></a><span id="l66.1254" class="difflineplus">+      delete aRestriction.res.resProperty.lpProp;</span>
<a href="#l66.1255"></a><span id="l66.1255" class="difflineplus">+    case RES_SIZE:</span>
<a href="#l66.1256"></a><span id="l66.1256" class="difflineplus">+    case RES_SUBRESTRICTION:</span>
<a href="#l66.1257"></a><span id="l66.1257" class="difflineplus">+      break;</span>
<a href="#l66.1258"></a><span id="l66.1258" class="difflineplus">+  }</span>
<a href="#l66.1259"></a><span id="l66.1259"> }</span>
<a href="#l66.1260"></a><span id="l66.1260"> </span>
<a href="#l66.1261"></a><span id="l66.1261" class="difflineminus">-struct QueryThreadArgs</span>
<a href="#l66.1262"></a><span id="l66.1262" class="difflineminus">-{</span>
<a href="#l66.1263"></a><span id="l66.1263" class="difflineminus">-    nsAbOutlookDirectory *mThis ;</span>
<a href="#l66.1264"></a><span id="l66.1264" class="difflineminus">-    SRestriction mRestriction ;</span>
<a href="#l66.1265"></a><span id="l66.1265" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirSearchListener&gt; mListener ;</span>
<a href="#l66.1266"></a><span id="l66.1266" class="difflineminus">-    int32_t mResultLimit ;</span>
<a href="#l66.1267"></a><span id="l66.1267" class="difflineminus">-    int32_t mTimeout ;</span>
<a href="#l66.1268"></a><span id="l66.1268" class="difflineminus">-    int32_t mThreadId ;</span>
<a href="#l66.1269"></a><span id="l66.1269" class="difflineminus">-} ;</span>
<a href="#l66.1270"></a><span id="l66.1270" class="difflineplus">+struct QueryThreadArgs {</span>
<a href="#l66.1271"></a><span id="l66.1271" class="difflineplus">+  nsAbOutlookDirectory *mThis;</span>
<a href="#l66.1272"></a><span id="l66.1272" class="difflineplus">+  SRestriction mRestriction;</span>
<a href="#l66.1273"></a><span id="l66.1273" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirSearchListener&gt; mListener;</span>
<a href="#l66.1274"></a><span id="l66.1274" class="difflineplus">+  int32_t mResultLimit;</span>
<a href="#l66.1275"></a><span id="l66.1275" class="difflineplus">+  int32_t mTimeout;</span>
<a href="#l66.1276"></a><span id="l66.1276" class="difflineplus">+  int32_t mThreadId;</span>
<a href="#l66.1277"></a><span id="l66.1277" class="difflineplus">+};</span>
<a href="#l66.1278"></a><span id="l66.1278"> </span>
<a href="#l66.1279"></a><span id="l66.1279" class="difflineminus">-static void QueryThreadFunc(void *aArguments)</span>
<a href="#l66.1280"></a><span id="l66.1280" class="difflineminus">-{</span>
<a href="#l66.1281"></a><span id="l66.1281" class="difflineminus">-    QueryThreadArgs *arguments = reinterpret_cast&lt;QueryThreadArgs *&gt;(aArguments) ;</span>
<a href="#l66.1282"></a><span id="l66.1282" class="difflineplus">+static void QueryThreadFunc(void *aArguments) {</span>
<a href="#l66.1283"></a><span id="l66.1283" class="difflineplus">+  QueryThreadArgs *arguments = reinterpret_cast&lt;QueryThreadArgs *&gt;(aArguments);</span>
<a href="#l66.1284"></a><span id="l66.1284"> </span>
<a href="#l66.1285"></a><span id="l66.1285" class="difflineminus">-    if (!aArguments) { return ; }</span>
<a href="#l66.1286"></a><span id="l66.1286" class="difflineminus">-    arguments-&gt;mThis-&gt;ExecuteQuery(arguments-&gt;mRestriction, arguments-&gt;mListener,</span>
<a href="#l66.1287"></a><span id="l66.1287" class="difflineminus">-                                   arguments-&gt;mResultLimit, arguments-&gt;mTimeout,</span>
<a href="#l66.1288"></a><span id="l66.1288" class="difflineminus">-                                   arguments-&gt;mThreadId) ;</span>
<a href="#l66.1289"></a><span id="l66.1289" class="difflineminus">-    DestroyRestriction(arguments-&gt;mRestriction) ;</span>
<a href="#l66.1290"></a><span id="l66.1290" class="difflineminus">-    delete arguments ;</span>
<a href="#l66.1291"></a><span id="l66.1291" class="difflineplus">+  if (!aArguments) {</span>
<a href="#l66.1292"></a><span id="l66.1292" class="difflineplus">+    return;</span>
<a href="#l66.1293"></a><span id="l66.1293" class="difflineplus">+  }</span>
<a href="#l66.1294"></a><span id="l66.1294" class="difflineplus">+  arguments-&gt;mThis-&gt;ExecuteQuery(arguments-&gt;mRestriction, arguments-&gt;mListener,</span>
<a href="#l66.1295"></a><span id="l66.1295" class="difflineplus">+                                 arguments-&gt;mResultLimit, arguments-&gt;mTimeout,</span>
<a href="#l66.1296"></a><span id="l66.1296" class="difflineplus">+                                 arguments-&gt;mThreadId);</span>
<a href="#l66.1297"></a><span id="l66.1297" class="difflineplus">+  DestroyRestriction(arguments-&gt;mRestriction);</span>
<a href="#l66.1298"></a><span id="l66.1298" class="difflineplus">+  delete arguments;</span>
<a href="#l66.1299"></a><span id="l66.1299"> }</span>
<a href="#l66.1300"></a><span id="l66.1300"> </span>
<a href="#l66.1301"></a><span id="l66.1301" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::DoQuery(nsIAbDirectory *aDirectory,</span>
<a href="#l66.1302"></a><span id="l66.1302" class="difflineminus">-                                            nsIAbDirectoryQueryArguments *aArguments,</span>
<a href="#l66.1303"></a><span id="l66.1303" class="difflineminus">-                                            nsIAbDirSearchListener *aListener,</span>
<a href="#l66.1304"></a><span id="l66.1304" class="difflineminus">-                                            int32_t aResultLimit, int32_t aTimeout,</span>
<a href="#l66.1305"></a><span id="l66.1305" class="difflineminus">-                                            int32_t *aReturnValue)</span>
<a href="#l66.1306"></a><span id="l66.1306" class="difflineminus">-{</span>
<a href="#l66.1307"></a><span id="l66.1307" class="difflineminus">-  if (!aArguments || !aListener || !aReturnValue)  {</span>
<a href="#l66.1308"></a><span id="l66.1308" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::DoQuery(</span>
<a href="#l66.1309"></a><span id="l66.1309" class="difflineplus">+    nsIAbDirectory *aDirectory, nsIAbDirectoryQueryArguments *aArguments,</span>
<a href="#l66.1310"></a><span id="l66.1310" class="difflineplus">+    nsIAbDirSearchListener *aListener, int32_t aResultLimit, int32_t aTimeout,</span>
<a href="#l66.1311"></a><span id="l66.1311" class="difflineplus">+    int32_t *aReturnValue) {</span>
<a href="#l66.1312"></a><span id="l66.1312" class="difflineplus">+  if (!aArguments || !aListener || !aReturnValue) {</span>
<a href="#l66.1313"></a><span id="l66.1313">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.1314"></a><span id="l66.1314">   }</span>
<a href="#l66.1315"></a><span id="l66.1315">   *aReturnValue = -1;</span>
<a href="#l66.1316"></a><span id="l66.1316"> </span>
<a href="#l66.1317"></a><span id="l66.1317">   QueryThreadArgs *threadArgs = new QueryThreadArgs;</span>
<a href="#l66.1318"></a><span id="l66.1318">   PRThread *newThread = nullptr;</span>
<a href="#l66.1319"></a><span id="l66.1319"> </span>
<a href="#l66.1320"></a><span id="l66.1320" class="difflineminus">-  if (!threadArgs)</span>
<a href="#l66.1321"></a><span id="l66.1321" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l66.1322"></a><span id="l66.1322" class="difflineplus">+  if (!threadArgs) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l66.1323"></a><span id="l66.1323"> </span>
<a href="#l66.1324"></a><span id="l66.1324">   nsresult rv = BuildRestriction(aArguments, threadArgs-&gt;mRestriction);</span>
<a href="#l66.1325"></a><span id="l66.1325">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1326"></a><span id="l66.1326"> </span>
<a href="#l66.1327"></a><span id="l66.1327">   threadArgs-&gt;mThis = this;</span>
<a href="#l66.1328"></a><span id="l66.1328">   threadArgs-&gt;mListener = aListener;</span>
<a href="#l66.1329"></a><span id="l66.1329">   threadArgs-&gt;mResultLimit = aResultLimit;</span>
<a href="#l66.1330"></a><span id="l66.1330">   threadArgs-&gt;mTimeout = aTimeout;</span>
<a href="#l66.1331"></a><span id="l66.1331"> </span>
<a href="#l66.1332"></a><span id="l66.1332">   PR_Lock(mProtector);</span>
<a href="#l66.1333"></a><span id="l66.1333">   *aReturnValue = ++mCurrentQueryId;</span>
<a href="#l66.1334"></a><span id="l66.1334">   PR_Unlock(mProtector);</span>
<a href="#l66.1335"></a><span id="l66.1335"> </span>
<a href="#l66.1336"></a><span id="l66.1336">   threadArgs-&gt;mThreadId = *aReturnValue;</span>
<a href="#l66.1337"></a><span id="l66.1337" class="difflineminus">-  newThread = PR_CreateThread(PR_USER_THREAD,</span>
<a href="#l66.1338"></a><span id="l66.1338" class="difflineminus">-                              QueryThreadFunc,</span>
<a href="#l66.1339"></a><span id="l66.1339" class="difflineminus">-                              threadArgs,</span>
<a href="#l66.1340"></a><span id="l66.1340" class="difflineminus">-                              PR_PRIORITY_NORMAL,</span>
<a href="#l66.1341"></a><span id="l66.1341" class="difflineminus">-                              PR_GLOBAL_THREAD,</span>
<a href="#l66.1342"></a><span id="l66.1342" class="difflineminus">-                              PR_UNJOINABLE_THREAD,</span>
<a href="#l66.1343"></a><span id="l66.1343" class="difflineminus">-                              0);</span>
<a href="#l66.1344"></a><span id="l66.1344" class="difflineplus">+  newThread = PR_CreateThread(PR_USER_THREAD, QueryThreadFunc, threadArgs,</span>
<a href="#l66.1345"></a><span id="l66.1345" class="difflineplus">+                              PR_PRIORITY_NORMAL, PR_GLOBAL_THREAD,</span>
<a href="#l66.1346"></a><span id="l66.1346" class="difflineplus">+                              PR_UNJOINABLE_THREAD, 0);</span>
<a href="#l66.1347"></a><span id="l66.1347"> </span>
<a href="#l66.1348"></a><span id="l66.1348" class="difflineminus">-  if (!newThread ) {</span>
<a href="#l66.1349"></a><span id="l66.1349" class="difflineplus">+  if (!newThread) {</span>
<a href="#l66.1350"></a><span id="l66.1350">     DestroyRestriction(threadArgs-&gt;mRestriction);</span>
<a href="#l66.1351"></a><span id="l66.1351">     delete threadArgs;</span>
<a href="#l66.1352"></a><span id="l66.1352">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l66.1353"></a><span id="l66.1353">   }</span>
<a href="#l66.1354"></a><span id="l66.1354"> </span>
<a href="#l66.1355"></a><span id="l66.1355">   mQueryThreads.Put(*aReturnValue, newThread);</span>
<a href="#l66.1356"></a><span id="l66.1356">   return NS_OK;</span>
<a href="#l66.1357"></a><span id="l66.1357"> }</span>
<a href="#l66.1358"></a><span id="l66.1358"> </span>
<a href="#l66.1359"></a><span id="l66.1359" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::StopQuery(int32_t aContext)</span>
<a href="#l66.1360"></a><span id="l66.1360" class="difflineminus">-{</span>
<a href="#l66.1361"></a><span id="l66.1361" class="difflineminus">-    PRThread *queryThread;</span>
<a href="#l66.1362"></a><span id="l66.1362" class="difflineminus">-    if (mQueryThreads.Get(aContext, &amp;queryThread)) {</span>
<a href="#l66.1363"></a><span id="l66.1363" class="difflineminus">-        PR_Interrupt(queryThread);</span>
<a href="#l66.1364"></a><span id="l66.1364" class="difflineminus">-        mQueryThreads.Remove(aContext);</span>
<a href="#l66.1365"></a><span id="l66.1365" class="difflineminus">-    }</span>
<a href="#l66.1366"></a><span id="l66.1366" class="difflineminus">-    return NS_OK;</span>
<a href="#l66.1367"></a><span id="l66.1367" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::StopQuery(int32_t aContext) {</span>
<a href="#l66.1368"></a><span id="l66.1368" class="difflineplus">+  PRThread *queryThread;</span>
<a href="#l66.1369"></a><span id="l66.1369" class="difflineplus">+  if (mQueryThreads.Get(aContext, &amp;queryThread)) {</span>
<a href="#l66.1370"></a><span id="l66.1370" class="difflineplus">+    PR_Interrupt(queryThread);</span>
<a href="#l66.1371"></a><span id="l66.1371" class="difflineplus">+    mQueryThreads.Remove(aContext);</span>
<a href="#l66.1372"></a><span id="l66.1372" class="difflineplus">+  }</span>
<a href="#l66.1373"></a><span id="l66.1373" class="difflineplus">+  return NS_OK;</span>
<a href="#l66.1374"></a><span id="l66.1374"> }</span>
<a href="#l66.1375"></a><span id="l66.1375"> </span>
<a href="#l66.1376"></a><span id="l66.1376"> // nsIAbDirectorySearch methods</span>
<a href="#l66.1377"></a><span id="l66.1377" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::StartSearch(void)</span>
<a href="#l66.1378"></a><span id="l66.1378" class="difflineminus">-{</span>
<a href="#l66.1379"></a><span id="l66.1379" class="difflineminus">-    if (!mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l66.1380"></a><span id="l66.1380" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.1381"></a><span id="l66.1381" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::StartSearch(void) {</span>
<a href="#l66.1382"></a><span id="l66.1382" class="difflineplus">+  if (!mIsQueryURI) {</span>
<a href="#l66.1383"></a><span id="l66.1383" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.1384"></a><span id="l66.1384" class="difflineplus">+  }</span>
<a href="#l66.1385"></a><span id="l66.1385" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.1386"></a><span id="l66.1386"> </span>
<a href="#l66.1387"></a><span id="l66.1387" class="difflineminus">-    retCode = StopSearch() ;</span>
<a href="#l66.1388"></a><span id="l66.1388" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1389"></a><span id="l66.1389" class="difflineminus">-    mCardList.Clear();</span>
<a href="#l66.1390"></a><span id="l66.1390" class="difflineplus">+  retCode = StopSearch();</span>
<a href="#l66.1391"></a><span id="l66.1391" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1392"></a><span id="l66.1392" class="difflineplus">+  mCardList.Clear();</span>
<a href="#l66.1393"></a><span id="l66.1393"> </span>
<a href="#l66.1394"></a><span id="l66.1394" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression ;</span>
<a href="#l66.1395"></a><span id="l66.1395" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l66.1396"></a><span id="l66.1396"> </span>
<a href="#l66.1397"></a><span id="l66.1397" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments = do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID,&amp;retCode);</span>
<a href="#l66.1398"></a><span id="l66.1398" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1399"></a><span id="l66.1399" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments =</span>
<a href="#l66.1400"></a><span id="l66.1400" class="difflineplus">+      do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;retCode);</span>
<a href="#l66.1401"></a><span id="l66.1401" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1402"></a><span id="l66.1402"> </span>
<a href="#l66.1403"></a><span id="l66.1403" class="difflineminus">-    retCode = nsAbQueryStringToExpression::Convert(mQueryString, getter_AddRefs(expression)) ;</span>
<a href="#l66.1404"></a><span id="l66.1404" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1405"></a><span id="l66.1405" class="difflineminus">-    retCode = arguments-&gt;SetExpression(expression) ;</span>
<a href="#l66.1406"></a><span id="l66.1406" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1407"></a><span id="l66.1407" class="difflineplus">+  retCode = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l66.1408"></a><span id="l66.1408" class="difflineplus">+                                                 getter_AddRefs(expression));</span>
<a href="#l66.1409"></a><span id="l66.1409" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1410"></a><span id="l66.1410" class="difflineplus">+  retCode = arguments-&gt;SetExpression(expression);</span>
<a href="#l66.1411"></a><span id="l66.1411" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1412"></a><span id="l66.1412"> </span>
<a href="#l66.1413"></a><span id="l66.1413" class="difflineminus">-    retCode = arguments-&gt;SetQuerySubDirectories(true) ;</span>
<a href="#l66.1414"></a><span id="l66.1414" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1415"></a><span id="l66.1415" class="difflineplus">+  retCode = arguments-&gt;SetQuerySubDirectories(true);</span>
<a href="#l66.1416"></a><span id="l66.1416" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1417"></a><span id="l66.1417"> </span>
<a href="#l66.1418"></a><span id="l66.1418" class="difflineminus">-    return DoQuery(this, arguments, this, -1, 0, &amp;mSearchContext);</span>
<a href="#l66.1419"></a><span id="l66.1419" class="difflineplus">+  return DoQuery(this, arguments, this, -1, 0, &amp;mSearchContext);</span>
<a href="#l66.1420"></a><span id="l66.1420"> }</span>
<a href="#l66.1421"></a><span id="l66.1421"> </span>
<a href="#l66.1422"></a><span id="l66.1422" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::StopSearch(void)</span>
<a href="#l66.1423"></a><span id="l66.1423" class="difflineminus">-{</span>
<a href="#l66.1424"></a><span id="l66.1424" class="difflineminus">-    if (!mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l66.1425"></a><span id="l66.1425" class="difflineminus">-    return StopQuery(mSearchContext) ;</span>
<a href="#l66.1426"></a><span id="l66.1426" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::StopSearch(void) {</span>
<a href="#l66.1427"></a><span id="l66.1427" class="difflineplus">+  if (!mIsQueryURI) {</span>
<a href="#l66.1428"></a><span id="l66.1428" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.1429"></a><span id="l66.1429" class="difflineplus">+  }</span>
<a href="#l66.1430"></a><span id="l66.1430" class="difflineplus">+  return StopQuery(mSearchContext);</span>
<a href="#l66.1431"></a><span id="l66.1431"> }</span>
<a href="#l66.1432"></a><span id="l66.1432"> </span>
<a href="#l66.1433"></a><span id="l66.1433"> // nsIAbDirSearchListener</span>
<a href="#l66.1434"></a><span id="l66.1434" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::OnSearchFinished(int32_t aResult,</span>
<a href="#l66.1435"></a><span id="l66.1435" class="difflineminus">-                                                     const nsAString &amp;aErrorMsg)</span>
<a href="#l66.1436"></a><span id="l66.1436" class="difflineminus">-{</span>
<a href="#l66.1437"></a><span id="l66.1437" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::OnSearchFinished(</span>
<a href="#l66.1438"></a><span id="l66.1438" class="difflineplus">+    int32_t aResult, const nsAString &amp;aErrorMsg) {</span>
<a href="#l66.1439"></a><span id="l66.1439">   return NS_OK;</span>
<a href="#l66.1440"></a><span id="l66.1440"> }</span>
<a href="#l66.1441"></a><span id="l66.1441"> </span>
<a href="#l66.1442"></a><span id="l66.1442" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::OnSearchFoundCard(nsIAbCard *aCard)</span>
<a href="#l66.1443"></a><span id="l66.1443" class="difflineminus">-{</span>
<a href="#l66.1444"></a><span id="l66.1444" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::OnSearchFoundCard(nsIAbCard *aCard) {</span>
<a href="#l66.1445"></a><span id="l66.1445">   mCardList.Put(aCard, aCard);</span>
<a href="#l66.1446"></a><span id="l66.1446">   nsresult rv;</span>
<a href="#l66.1447"></a><span id="l66.1447">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l66.1448"></a><span id="l66.1448" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l66.1449"></a><span id="l66.1449" class="difflineminus">-    rv = abManager-&gt;NotifyDirectoryItemAdded(this, aCard);</span>
<a href="#l66.1450"></a><span id="l66.1450" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = abManager-&gt;NotifyDirectoryItemAdded(this, aCard);</span>
<a href="#l66.1451"></a><span id="l66.1451"> </span>
<a href="#l66.1452"></a><span id="l66.1452">   return rv;</span>
<a href="#l66.1453"></a><span id="l66.1453"> }</span>
<a href="#l66.1454"></a><span id="l66.1454"> </span>
<a href="#l66.1455"></a><span id="l66.1455"> nsresult nsAbOutlookDirectory::ExecuteQuery(SRestriction &amp;aRestriction,</span>
<a href="#l66.1456"></a><span id="l66.1456">                                             nsIAbDirSearchListener *aListener,</span>
<a href="#l66.1457"></a><span id="l66.1457" class="difflineminus">-                                            int32_t aResultLimit, int32_t aTimeout,</span>
<a href="#l66.1458"></a><span id="l66.1458" class="difflineminus">-                                            int32_t aThreadId)</span>
<a href="#l66.1459"></a><span id="l66.1459" class="difflineplus">+                                            int32_t aResultLimit,</span>
<a href="#l66.1460"></a><span id="l66.1460" class="difflineplus">+                                            int32_t aTimeout, int32_t aThreadId)</span>
<a href="#l66.1461"></a><span id="l66.1461"> </span>
<a href="#l66.1462"></a><span id="l66.1462"> {</span>
<a href="#l66.1463"></a><span id="l66.1463" class="difflineminus">-  if (!aListener)</span>
<a href="#l66.1464"></a><span id="l66.1464" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.1465"></a><span id="l66.1465" class="difflineplus">+  if (!aListener) return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.1466"></a><span id="l66.1466"> </span>
<a href="#l66.1467"></a><span id="l66.1467">   nsresult retCode = NS_OK;</span>
<a href="#l66.1468"></a><span id="l66.1468"> </span>
<a href="#l66.1469"></a><span id="l66.1469" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; resultsArray(do_CreateInstance(NS_ARRAY_CONTRACTID,</span>
<a href="#l66.1470"></a><span id="l66.1470" class="difflineminus">-                                                           &amp;retCode));</span>
<a href="#l66.1471"></a><span id="l66.1471" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; resultsArray(</span>
<a href="#l66.1472"></a><span id="l66.1472" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;retCode));</span>
<a href="#l66.1473"></a><span id="l66.1473">   NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1474"></a><span id="l66.1474"> </span>
<a href="#l66.1475"></a><span id="l66.1475" class="difflineminus">-  retCode = GetChildCards(resultsArray,</span>
<a href="#l66.1476"></a><span id="l66.1476" class="difflineminus">-                          aRestriction.rt == RES_COMMENT ? nullptr : &amp;aRestriction);</span>
<a href="#l66.1477"></a><span id="l66.1477" class="difflineplus">+  retCode = GetChildCards(</span>
<a href="#l66.1478"></a><span id="l66.1478" class="difflineplus">+      resultsArray, aRestriction.rt == RES_COMMENT ? nullptr : &amp;aRestriction);</span>
<a href="#l66.1479"></a><span id="l66.1479">   NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1480"></a><span id="l66.1480"> </span>
<a href="#l66.1481"></a><span id="l66.1481">   uint32_t nbResults = 0;</span>
<a href="#l66.1482"></a><span id="l66.1482">   retCode = resultsArray-&gt;GetLength(&amp;nbResults);</span>
<a href="#l66.1483"></a><span id="l66.1483">   NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1484"></a><span id="l66.1484"> </span>
<a href="#l66.1485"></a><span id="l66.1485">   if (aResultLimit &gt; 0 &amp;&amp; nbResults &gt; static_cast&lt;uint32_t&gt;(aResultLimit)) {</span>
<a href="#l66.1486"></a><span id="l66.1486" class="difflineminus">-    nbResults = static_cast&lt;uint32_t&gt;(aResultLimit) ;</span>
<a href="#l66.1487"></a><span id="l66.1487" class="difflineplus">+    nbResults = static_cast&lt;uint32_t&gt;(aResultLimit);</span>
<a href="#l66.1488"></a><span id="l66.1488">   }</span>
<a href="#l66.1489"></a><span id="l66.1489"> </span>
<a href="#l66.1490"></a><span id="l66.1490">   uint32_t i = 0;</span>
<a href="#l66.1491"></a><span id="l66.1491">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l66.1492"></a><span id="l66.1492"> </span>
<a href="#l66.1493"></a><span id="l66.1493" class="difflineminus">-  for (i = 0 ; i &lt; nbResults ; ++i) {</span>
<a href="#l66.1494"></a><span id="l66.1494" class="difflineplus">+  for (i = 0; i &lt; nbResults; ++i) {</span>
<a href="#l66.1495"></a><span id="l66.1495">     card = do_QueryElementAt(resultsArray, i, &amp;retCode);</span>
<a href="#l66.1496"></a><span id="l66.1496">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1497"></a><span id="l66.1497"> </span>
<a href="#l66.1498"></a><span id="l66.1498">     aListener-&gt;OnSearchFoundCard(card);</span>
<a href="#l66.1499"></a><span id="l66.1499">   }</span>
<a href="#l66.1500"></a><span id="l66.1500"> </span>
<a href="#l66.1501"></a><span id="l66.1501">   mQueryThreads.Remove(aThreadId);</span>
<a href="#l66.1502"></a><span id="l66.1502"> </span>
<a href="#l66.1503"></a><span id="l66.1503" class="difflineminus">-  aListener-&gt;OnSearchFinished(nsIAbDirectoryQueryResultListener::queryResultComplete,</span>
<a href="#l66.1504"></a><span id="l66.1504" class="difflineminus">-                              EmptyString());</span>
<a href="#l66.1505"></a><span id="l66.1505" class="difflineplus">+  aListener-&gt;OnSearchFinished(</span>
<a href="#l66.1506"></a><span id="l66.1506" class="difflineplus">+      nsIAbDirectoryQueryResultListener::queryResultComplete, EmptyString());</span>
<a href="#l66.1507"></a><span id="l66.1507">   return retCode;</span>
<a href="#l66.1508"></a><span id="l66.1508"> }</span>
<a href="#l66.1509"></a><span id="l66.1509"> </span>
<a href="#l66.1510"></a><span id="l66.1510"> // This function expects the aCards array to already be created.</span>
<a href="#l66.1511"></a><span id="l66.1511"> nsresult nsAbOutlookDirectory::GetChildCards(nsIMutableArray *aCards,</span>
<a href="#l66.1512"></a><span id="l66.1512" class="difflineminus">-                                             void *aRestriction)</span>
<a href="#l66.1513"></a><span id="l66.1513" class="difflineminus">-{</span>
<a href="#l66.1514"></a><span id="l66.1514" class="difflineplus">+                                             void *aRestriction) {</span>
<a href="#l66.1515"></a><span id="l66.1515">   nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.1516"></a><span id="l66.1516"> </span>
<a href="#l66.1517"></a><span id="l66.1517" class="difflineminus">-  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l66.1518"></a><span id="l66.1518" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l66.1519"></a><span id="l66.1519" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) return NS_ERROR_FAILURE;</span>
<a href="#l66.1520"></a><span id="l66.1520"> </span>
<a href="#l66.1521"></a><span id="l66.1521">   nsMapiEntryArray cardEntries;</span>
<a href="#l66.1522"></a><span id="l66.1522" class="difflineminus">-  LPSRestriction restriction = (LPSRestriction) aRestriction;</span>
<a href="#l66.1523"></a><span id="l66.1523" class="difflineplus">+  LPSRestriction restriction = (LPSRestriction)aRestriction;</span>
<a href="#l66.1524"></a><span id="l66.1524"> </span>
<a href="#l66.1525"></a><span id="l66.1525">   if (!mapiAddBook-&gt;GetCards(*mMapiData, restriction, cardEntries)) {</span>
<a href="#l66.1526"></a><span id="l66.1526">     PRINTF((&quot;Cannot get cards.\n&quot;));</span>
<a href="#l66.1527"></a><span id="l66.1527">     return NS_ERROR_FAILURE;</span>
<a href="#l66.1528"></a><span id="l66.1528">   }</span>
<a href="#l66.1529"></a><span id="l66.1529"> </span>
<a href="#l66.1530"></a><span id="l66.1530">   nsAutoCString ourUuid;</span>
<a href="#l66.1531"></a><span id="l66.1531">   GetUuid(ourUuid);</span>
<a href="#l66.1532"></a><span id="l66.1532" class="difflineat">@@ -1041,256 +1013,245 @@ nsresult nsAbOutlookDirectory::GetChildC</span>
<a href="#l66.1533"></a><span id="l66.1533">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1534"></a><span id="l66.1534">     childCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l66.1535"></a><span id="l66.1535"> </span>
<a href="#l66.1536"></a><span id="l66.1536">     aCards-&gt;AppendElement(childCard);</span>
<a href="#l66.1537"></a><span id="l66.1537">   }</span>
<a href="#l66.1538"></a><span id="l66.1538">   return rv;</span>
<a href="#l66.1539"></a><span id="l66.1539"> }</span>
<a href="#l66.1540"></a><span id="l66.1540"> </span>
<a href="#l66.1541"></a><span id="l66.1541" class="difflineminus">-nsresult nsAbOutlookDirectory::GetChildNodes(nsIMutableArray* aNodes)</span>
<a href="#l66.1542"></a><span id="l66.1542" class="difflineminus">-{</span>
<a href="#l66.1543"></a><span id="l66.1543" class="difflineplus">+nsresult nsAbOutlookDirectory::GetChildNodes(nsIMutableArray *aNodes) {</span>
<a href="#l66.1544"></a><span id="l66.1544">   NS_ENSURE_ARG_POINTER(aNodes);</span>
<a href="#l66.1545"></a><span id="l66.1545"> </span>
<a href="#l66.1546"></a><span id="l66.1546">   aNodes-&gt;Clear();</span>
<a href="#l66.1547"></a><span id="l66.1547"> </span>
<a href="#l66.1548"></a><span id="l66.1548">   nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.1549"></a><span id="l66.1549">   nsMapiEntryArray nodeEntries;</span>
<a href="#l66.1550"></a><span id="l66.1550"> </span>
<a href="#l66.1551"></a><span id="l66.1551" class="difflineminus">-  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l66.1552"></a><span id="l66.1552" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l66.1553"></a><span id="l66.1553" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) return NS_ERROR_FAILURE;</span>
<a href="#l66.1554"></a><span id="l66.1554"> </span>
<a href="#l66.1555"></a><span id="l66.1555" class="difflineminus">-  if (!mapiAddBook-&gt;GetNodes(*mMapiData, nodeEntries))</span>
<a href="#l66.1556"></a><span id="l66.1556" class="difflineminus">-  {</span>
<a href="#l66.1557"></a><span id="l66.1557" class="difflineplus">+  if (!mapiAddBook-&gt;GetNodes(*mMapiData, nodeEntries)) {</span>
<a href="#l66.1558"></a><span id="l66.1558">     PRINTF((&quot;Cannot get nodes.\n&quot;));</span>
<a href="#l66.1559"></a><span id="l66.1559">     return NS_ERROR_FAILURE;</span>
<a href="#l66.1560"></a><span id="l66.1560">   }</span>
<a href="#l66.1561"></a><span id="l66.1561"> </span>
<a href="#l66.1562"></a><span id="l66.1562">   nsAutoCString entryId;</span>
<a href="#l66.1563"></a><span id="l66.1563">   nsAutoCString uriName;</span>
<a href="#l66.1564"></a><span id="l66.1564">   nsresult rv = NS_OK;</span>
<a href="#l66.1565"></a><span id="l66.1565"> </span>
<a href="#l66.1566"></a><span id="l66.1566">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l66.1567"></a><span id="l66.1567">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1568"></a><span id="l66.1568"> </span>
<a href="#l66.1569"></a><span id="l66.1569" class="difflineminus">-  for (ULONG node = 0; node &lt; nodeEntries.mNbEntries; ++node)</span>
<a href="#l66.1570"></a><span id="l66.1570" class="difflineminus">-  {</span>
<a href="#l66.1571"></a><span id="l66.1571" class="difflineplus">+  for (ULONG node = 0; node &lt; nodeEntries.mNbEntries; ++node) {</span>
<a href="#l66.1572"></a><span id="l66.1572">     nodeEntries.mEntries[node].ToString(entryId);</span>
<a href="#l66.1573"></a><span id="l66.1573">     buildAbWinUri(kOutlookDirectoryScheme, mAbWinType, uriName);</span>
<a href="#l66.1574"></a><span id="l66.1574">     uriName.Append(entryId);</span>
<a href="#l66.1575"></a><span id="l66.1575"> </span>
<a href="#l66.1576"></a><span id="l66.1576" class="difflineminus">-    nsCOMPtr &lt;nsIAbDirectory&gt; directory;</span>
<a href="#l66.1577"></a><span id="l66.1577" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l66.1578"></a><span id="l66.1578">     rv = abManager-&gt;GetDirectory(uriName, getter_AddRefs(directory));</span>
<a href="#l66.1579"></a><span id="l66.1579">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1580"></a><span id="l66.1580"> </span>
<a href="#l66.1581"></a><span id="l66.1581">     aNodes-&gt;AppendElement(directory);</span>
<a href="#l66.1582"></a><span id="l66.1582">   }</span>
<a href="#l66.1583"></a><span id="l66.1583">   return rv;</span>
<a href="#l66.1584"></a><span id="l66.1584"> }</span>
<a href="#l66.1585"></a><span id="l66.1585"> </span>
<a href="#l66.1586"></a><span id="l66.1586" class="difflineminus">-nsresult nsAbOutlookDirectory::NotifyItemDeletion(nsISupports *aItem)</span>
<a href="#l66.1587"></a><span id="l66.1587" class="difflineminus">-{</span>
<a href="#l66.1588"></a><span id="l66.1588" class="difflineplus">+nsresult nsAbOutlookDirectory::NotifyItemDeletion(nsISupports *aItem) {</span>
<a href="#l66.1589"></a><span id="l66.1589">   nsresult rv;</span>
<a href="#l66.1590"></a><span id="l66.1590">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l66.1591"></a><span id="l66.1591"> </span>
<a href="#l66.1592"></a><span id="l66.1592" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l66.1593"></a><span id="l66.1593" class="difflineminus">-    rv = abManager-&gt;NotifyDirectoryItemDeleted(this, aItem);</span>
<a href="#l66.1594"></a><span id="l66.1594" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = abManager-&gt;NotifyDirectoryItemDeleted(this, aItem);</span>
<a href="#l66.1595"></a><span id="l66.1595"> </span>
<a href="#l66.1596"></a><span id="l66.1596">   return rv;</span>
<a href="#l66.1597"></a><span id="l66.1597"> }</span>
<a href="#l66.1598"></a><span id="l66.1598"> </span>
<a href="#l66.1599"></a><span id="l66.1599" class="difflineminus">-nsresult nsAbOutlookDirectory::NotifyItemAddition(nsISupports *aItem)</span>
<a href="#l66.1600"></a><span id="l66.1600" class="difflineminus">-{</span>
<a href="#l66.1601"></a><span id="l66.1601" class="difflineplus">+nsresult nsAbOutlookDirectory::NotifyItemAddition(nsISupports *aItem) {</span>
<a href="#l66.1602"></a><span id="l66.1602">   nsresult rv;</span>
<a href="#l66.1603"></a><span id="l66.1603" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l66.1604"></a><span id="l66.1604" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l66.1605"></a><span id="l66.1605" class="difflineminus">-    rv = abManager-&gt;NotifyDirectoryItemAdded(this, aItem);</span>
<a href="#l66.1606"></a><span id="l66.1606" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l66.1607"></a><span id="l66.1607" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l66.1608"></a><span id="l66.1608" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = abManager-&gt;NotifyDirectoryItemAdded(this, aItem);</span>
<a href="#l66.1609"></a><span id="l66.1609"> </span>
<a href="#l66.1610"></a><span id="l66.1610">   return rv;</span>
<a href="#l66.1611"></a><span id="l66.1611"> }</span>
<a href="#l66.1612"></a><span id="l66.1612"> </span>
<a href="#l66.1613"></a><span id="l66.1613"> // This is called from EditMailListToDatabase.</span>
<a href="#l66.1614"></a><span id="l66.1614"> // We got m_AddressList containing the list of cards the mailing</span>
<a href="#l66.1615"></a><span id="l66.1615"> // list is supposed to contain at the end.</span>
<a href="#l66.1616"></a><span id="l66.1616" class="difflineminus">-nsresult nsAbOutlookDirectory::CommitAddressList(void)</span>
<a href="#l66.1617"></a><span id="l66.1617" class="difflineminus">-{</span>
<a href="#l66.1618"></a><span id="l66.1618" class="difflineplus">+nsresult nsAbOutlookDirectory::CommitAddressList(void) {</span>
<a href="#l66.1619"></a><span id="l66.1619">   if (!m_IsMailList) {</span>
<a href="#l66.1620"></a><span id="l66.1620">     PRINTF((&quot;We are not in a mailing list, no commit can be done.\n&quot;));</span>
<a href="#l66.1621"></a><span id="l66.1621">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l66.1622"></a><span id="l66.1622">   }</span>
<a href="#l66.1623"></a><span id="l66.1623"> </span>
<a href="#l66.1624"></a><span id="l66.1624">   nsresult rv;</span>
<a href="#l66.1625"></a><span id="l66.1625">   uint32_t i = 0;</span>
<a href="#l66.1626"></a><span id="l66.1626" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; oldList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l66.1627"></a><span id="l66.1627" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; oldList(</span>
<a href="#l66.1628"></a><span id="l66.1628" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l66.1629"></a><span id="l66.1629">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1630"></a><span id="l66.1630"> </span>
<a href="#l66.1631"></a><span id="l66.1631">   rv = GetChildCards(oldList, nullptr);</span>
<a href="#l66.1632"></a><span id="l66.1632">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1633"></a><span id="l66.1633"> </span>
<a href="#l66.1634"></a><span id="l66.1634" class="difflineminus">-  if (!m_AddressList)</span>
<a href="#l66.1635"></a><span id="l66.1635" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.1636"></a><span id="l66.1636" class="difflineplus">+  if (!m_AddressList) return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.1637"></a><span id="l66.1637"> </span>
<a href="#l66.1638"></a><span id="l66.1638">   uint32_t nbCards = 0;</span>
<a href="#l66.1639"></a><span id="l66.1639">   rv = m_AddressList-&gt;GetLength(&amp;nbCards);</span>
<a href="#l66.1640"></a><span id="l66.1640">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1641"></a><span id="l66.1641"> </span>
<a href="#l66.1642"></a><span id="l66.1642">   nsCOMPtr&lt;nsISupports&gt; element;</span>
<a href="#l66.1643"></a><span id="l66.1643">   nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l66.1644"></a><span id="l66.1644">   uint32_t pos;</span>
<a href="#l66.1645"></a><span id="l66.1645"> </span>
<a href="#l66.1646"></a><span id="l66.1646">   for (i = 0; i &lt; nbCards; ++i) {</span>
<a href="#l66.1647"></a><span id="l66.1647">     element = do_QueryElementAt(m_AddressList, i, &amp;rv);</span>
<a href="#l66.1648"></a><span id="l66.1648">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1649"></a><span id="l66.1649"> </span>
<a href="#l66.1650"></a><span id="l66.1650">     if (NS_SUCCEEDED(oldList-&gt;IndexOf(0, element, &amp;pos))) {</span>
<a href="#l66.1651"></a><span id="l66.1651" class="difflineminus">-        rv = oldList-&gt;RemoveElementAt(pos);</span>
<a href="#l66.1652"></a><span id="l66.1652" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1653"></a><span id="l66.1653" class="difflineplus">+      rv = oldList-&gt;RemoveElementAt(pos);</span>
<a href="#l66.1654"></a><span id="l66.1654" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1655"></a><span id="l66.1655"> </span>
<a href="#l66.1656"></a><span id="l66.1656" class="difflineminus">-        // The entry was not already there</span>
<a href="#l66.1657"></a><span id="l66.1657" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(element, &amp;rv));</span>
<a href="#l66.1658"></a><span id="l66.1658" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1659"></a><span id="l66.1659" class="difflineplus">+      // The entry was not already there</span>
<a href="#l66.1660"></a><span id="l66.1660" class="difflineplus">+      nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(element, &amp;rv));</span>
<a href="#l66.1661"></a><span id="l66.1661" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1662"></a><span id="l66.1662"> </span>
<a href="#l66.1663"></a><span id="l66.1663" class="difflineminus">-        rv = CreateCard(card, getter_AddRefs(newCard));</span>
<a href="#l66.1664"></a><span id="l66.1664" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1665"></a><span id="l66.1665" class="difflineminus">-        m_AddressList-&gt;ReplaceElementAt(newCard, i);</span>
<a href="#l66.1666"></a><span id="l66.1666" class="difflineplus">+      rv = CreateCard(card, getter_AddRefs(newCard));</span>
<a href="#l66.1667"></a><span id="l66.1667" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1668"></a><span id="l66.1668" class="difflineplus">+      m_AddressList-&gt;ReplaceElementAt(newCard, i);</span>
<a href="#l66.1669"></a><span id="l66.1669">     }</span>
<a href="#l66.1670"></a><span id="l66.1670">   }</span>
<a href="#l66.1671"></a><span id="l66.1671">   return DeleteCards(oldList);</span>
<a href="#l66.1672"></a><span id="l66.1672"> }</span>
<a href="#l66.1673"></a><span id="l66.1673"> </span>
<a href="#l66.1674"></a><span id="l66.1674" class="difflineminus">-nsresult nsAbOutlookDirectory::UpdateAddressList(void)</span>
<a href="#l66.1675"></a><span id="l66.1675" class="difflineminus">-{</span>
<a href="#l66.1676"></a><span id="l66.1676" class="difflineminus">-    if (!m_AddressList)</span>
<a href="#l66.1677"></a><span id="l66.1677" class="difflineminus">-    {</span>
<a href="#l66.1678"></a><span id="l66.1678" class="difflineminus">-        nsresult rv;</span>
<a href="#l66.1679"></a><span id="l66.1679" class="difflineminus">-        m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l66.1680"></a><span id="l66.1680" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1681"></a><span id="l66.1681" class="difflineminus">-    }</span>
<a href="#l66.1682"></a><span id="l66.1682" class="difflineplus">+nsresult nsAbOutlookDirectory::UpdateAddressList(void) {</span>
<a href="#l66.1683"></a><span id="l66.1683" class="difflineplus">+  if (!m_AddressList) {</span>
<a href="#l66.1684"></a><span id="l66.1684" class="difflineplus">+    nsresult rv;</span>
<a href="#l66.1685"></a><span id="l66.1685" class="difflineplus">+    m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l66.1686"></a><span id="l66.1686" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1687"></a><span id="l66.1687" class="difflineplus">+  }</span>
<a href="#l66.1688"></a><span id="l66.1688"> </span>
<a href="#l66.1689"></a><span id="l66.1689" class="difflineminus">-    return m_IsMailList ? GetChildCards(m_AddressList, nullptr) :</span>
<a href="#l66.1690"></a><span id="l66.1690" class="difflineminus">-                          GetChildNodes(m_AddressList);</span>
<a href="#l66.1691"></a><span id="l66.1691" class="difflineplus">+  return m_IsMailList ? GetChildCards(m_AddressList, nullptr)</span>
<a href="#l66.1692"></a><span id="l66.1692" class="difflineplus">+                      : GetChildNodes(m_AddressList);</span>
<a href="#l66.1693"></a><span id="l66.1693"> }</span>
<a href="#l66.1694"></a><span id="l66.1694"> </span>
<a href="#l66.1695"></a><span id="l66.1695" class="difflineminus">-nsresult nsAbOutlookDirectory::CreateCard(nsIAbCard *aData, nsIAbCard **aNewCard)</span>
<a href="#l66.1696"></a><span id="l66.1696" class="difflineminus">-{</span>
<a href="#l66.1697"></a><span id="l66.1697" class="difflineminus">-    if (!aData || !aNewCard) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l66.1698"></a><span id="l66.1698" class="difflineminus">-    *aNewCard = nullptr ;</span>
<a href="#l66.1699"></a><span id="l66.1699" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l66.1700"></a><span id="l66.1700" class="difflineminus">-    nsAbWinHelperGuard mapiAddBook (mAbWinType) ;</span>
<a href="#l66.1701"></a><span id="l66.1701" class="difflineminus">-    nsMapiEntry newEntry ;</span>
<a href="#l66.1702"></a><span id="l66.1702" class="difflineminus">-    nsAutoCString entryString ;</span>
<a href="#l66.1703"></a><span id="l66.1703" class="difflineminus">-    bool didCopy = false ;</span>
<a href="#l66.1704"></a><span id="l66.1704" class="difflineminus">-</span>
<a href="#l66.1705"></a><span id="l66.1705" class="difflineminus">-    if (!mapiAddBook-&gt;IsOK()) { return NS_ERROR_FAILURE ; }</span>
<a href="#l66.1706"></a><span id="l66.1706" class="difflineminus">-    // If we get an nsIAbCard that maps onto an Outlook card uri</span>
<a href="#l66.1707"></a><span id="l66.1707" class="difflineminus">-    // we simply copy the contents of the Outlook card.</span>
<a href="#l66.1708"></a><span id="l66.1708" class="difflineminus">-    retCode = ExtractCardEntry(aData, entryString) ;</span>
<a href="#l66.1709"></a><span id="l66.1709" class="difflineminus">-    if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l66.1710"></a><span id="l66.1710" class="difflineminus">-        nsMapiEntry sourceEntry ;</span>
<a href="#l66.1711"></a><span id="l66.1711" class="difflineminus">-</span>
<a href="#l66.1712"></a><span id="l66.1712" class="difflineplus">+nsresult nsAbOutlookDirectory::CreateCard(nsIAbCard *aData,</span>
<a href="#l66.1713"></a><span id="l66.1713" class="difflineplus">+                                          nsIAbCard **aNewCard) {</span>
<a href="#l66.1714"></a><span id="l66.1714" class="difflineplus">+  if (!aData || !aNewCard) {</span>
<a href="#l66.1715"></a><span id="l66.1715" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l66.1716"></a><span id="l66.1716" class="difflineplus">+  }</span>
<a href="#l66.1717"></a><span id="l66.1717" class="difflineplus">+  *aNewCard = nullptr;</span>
<a href="#l66.1718"></a><span id="l66.1718" class="difflineplus">+  nsresult retCode = NS_OK;</span>
<a href="#l66.1719"></a><span id="l66.1719" class="difflineplus">+  nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.1720"></a><span id="l66.1720" class="difflineplus">+  nsMapiEntry newEntry;</span>
<a href="#l66.1721"></a><span id="l66.1721" class="difflineplus">+  nsAutoCString entryString;</span>
<a href="#l66.1722"></a><span id="l66.1722" class="difflineplus">+  bool didCopy = false;</span>
<a href="#l66.1723"></a><span id="l66.1723"> </span>
<a href="#l66.1724"></a><span id="l66.1724" class="difflineminus">-        sourceEntry.Assign(entryString) ;</span>
<a href="#l66.1725"></a><span id="l66.1725" class="difflineminus">-        if (m_IsMailList) {</span>
<a href="#l66.1726"></a><span id="l66.1726" class="difflineminus">-            // In the case of a mailing list, we can use the address</span>
<a href="#l66.1727"></a><span id="l66.1727" class="difflineminus">-            // as a direct template to build the new one (which is done</span>
<a href="#l66.1728"></a><span id="l66.1728" class="difflineminus">-            // by CopyEntry).</span>
<a href="#l66.1729"></a><span id="l66.1729" class="difflineminus">-            mapiAddBook-&gt;CopyEntry(*mMapiData, sourceEntry, newEntry) ;</span>
<a href="#l66.1730"></a><span id="l66.1730" class="difflineminus">-            didCopy = true ;</span>
<a href="#l66.1731"></a><span id="l66.1731" class="difflineminus">-        }</span>
<a href="#l66.1732"></a><span id="l66.1732" class="difflineminus">-        else {</span>
<a href="#l66.1733"></a><span id="l66.1733" class="difflineminus">-            // Else, we have to create a temporary address and copy the</span>
<a href="#l66.1734"></a><span id="l66.1734" class="difflineminus">-            // source into it. Yes it's silly.</span>
<a href="#l66.1735"></a><span id="l66.1735" class="difflineminus">-            mapiAddBook-&gt;CreateEntry(*mMapiData, newEntry) ;</span>
<a href="#l66.1736"></a><span id="l66.1736" class="difflineminus">-        }</span>
<a href="#l66.1737"></a><span id="l66.1737" class="difflineminus">-    }</span>
<a href="#l66.1738"></a><span id="l66.1738" class="difflineminus">-    // If this approach doesn't work, well we're back to creating and copying.</span>
<a href="#l66.1739"></a><span id="l66.1739" class="difflineminus">-    if (newEntry.mByteCount == 0) {</span>
<a href="#l66.1740"></a><span id="l66.1740" class="difflineminus">-        // In the case of a mailing list, we cannot directly create a new card,</span>
<a href="#l66.1741"></a><span id="l66.1741" class="difflineminus">-        // we have to create a temporary one in a real folder (to be able to use</span>
<a href="#l66.1742"></a><span id="l66.1742" class="difflineminus">-        // templates) and then copy it to the mailing list.</span>
<a href="#l66.1743"></a><span id="l66.1743" class="difflineminus">-        if (m_IsMailList) {</span>
<a href="#l66.1744"></a><span id="l66.1744" class="difflineminus">-            nsMapiEntry parentEntry ;</span>
<a href="#l66.1745"></a><span id="l66.1745" class="difflineminus">-            nsMapiEntry temporaryEntry ;</span>
<a href="#l66.1746"></a><span id="l66.1746" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) {</span>
<a href="#l66.1747"></a><span id="l66.1747" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l66.1748"></a><span id="l66.1748" class="difflineplus">+  }</span>
<a href="#l66.1749"></a><span id="l66.1749" class="difflineplus">+  // If we get an nsIAbCard that maps onto an Outlook card uri</span>
<a href="#l66.1750"></a><span id="l66.1750" class="difflineplus">+  // we simply copy the contents of the Outlook card.</span>
<a href="#l66.1751"></a><span id="l66.1751" class="difflineplus">+  retCode = ExtractCardEntry(aData, entryString);</span>
<a href="#l66.1752"></a><span id="l66.1752" class="difflineplus">+  if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l66.1753"></a><span id="l66.1753" class="difflineplus">+    nsMapiEntry sourceEntry;</span>
<a href="#l66.1754"></a><span id="l66.1754"> </span>
<a href="#l66.1755"></a><span id="l66.1755" class="difflineminus">-            if (!mapiAddBook-&gt;GetDefaultContainer(parentEntry)) {</span>
<a href="#l66.1756"></a><span id="l66.1756" class="difflineminus">-                return NS_ERROR_FAILURE ;</span>
<a href="#l66.1757"></a><span id="l66.1757" class="difflineminus">-            }</span>
<a href="#l66.1758"></a><span id="l66.1758" class="difflineminus">-            if (!mapiAddBook-&gt;CreateEntry(parentEntry, temporaryEntry)) {</span>
<a href="#l66.1759"></a><span id="l66.1759" class="difflineminus">-                return NS_ERROR_FAILURE ;</span>
<a href="#l66.1760"></a><span id="l66.1760" class="difflineminus">-            }</span>
<a href="#l66.1761"></a><span id="l66.1761" class="difflineminus">-            if (!mapiAddBook-&gt;CopyEntry(*mMapiData, temporaryEntry, newEntry)) {</span>
<a href="#l66.1762"></a><span id="l66.1762" class="difflineminus">-                return NS_ERROR_FAILURE ;</span>
<a href="#l66.1763"></a><span id="l66.1763" class="difflineminus">-            }</span>
<a href="#l66.1764"></a><span id="l66.1764" class="difflineminus">-            if (!mapiAddBook-&gt;DeleteEntry(parentEntry, temporaryEntry)) {</span>
<a href="#l66.1765"></a><span id="l66.1765" class="difflineminus">-                return NS_ERROR_FAILURE ;</span>
<a href="#l66.1766"></a><span id="l66.1766" class="difflineminus">-            }</span>
<a href="#l66.1767"></a><span id="l66.1767" class="difflineminus">-        }</span>
<a href="#l66.1768"></a><span id="l66.1768" class="difflineminus">-        // If we're on a real address book folder, we can directly create an</span>
<a href="#l66.1769"></a><span id="l66.1769" class="difflineminus">-        // empty card.</span>
<a href="#l66.1770"></a><span id="l66.1770" class="difflineminus">-        else if (!mapiAddBook-&gt;CreateEntry(*mMapiData, newEntry)) {</span>
<a href="#l66.1771"></a><span id="l66.1771" class="difflineminus">-            return NS_ERROR_FAILURE ;</span>
<a href="#l66.1772"></a><span id="l66.1772" class="difflineminus">-        }</span>
<a href="#l66.1773"></a><span id="l66.1773" class="difflineplus">+    sourceEntry.Assign(entryString);</span>
<a href="#l66.1774"></a><span id="l66.1774" class="difflineplus">+    if (m_IsMailList) {</span>
<a href="#l66.1775"></a><span id="l66.1775" class="difflineplus">+      // In the case of a mailing list, we can use the address</span>
<a href="#l66.1776"></a><span id="l66.1776" class="difflineplus">+      // as a direct template to build the new one (which is done</span>
<a href="#l66.1777"></a><span id="l66.1777" class="difflineplus">+      // by CopyEntry).</span>
<a href="#l66.1778"></a><span id="l66.1778" class="difflineplus">+      mapiAddBook-&gt;CopyEntry(*mMapiData, sourceEntry, newEntry);</span>
<a href="#l66.1779"></a><span id="l66.1779" class="difflineplus">+      didCopy = true;</span>
<a href="#l66.1780"></a><span id="l66.1780" class="difflineplus">+    } else {</span>
<a href="#l66.1781"></a><span id="l66.1781" class="difflineplus">+      // Else, we have to create a temporary address and copy the</span>
<a href="#l66.1782"></a><span id="l66.1782" class="difflineplus">+      // source into it. Yes it's silly.</span>
<a href="#l66.1783"></a><span id="l66.1783" class="difflineplus">+      mapiAddBook-&gt;CreateEntry(*mMapiData, newEntry);</span>
<a href="#l66.1784"></a><span id="l66.1784">     }</span>
<a href="#l66.1785"></a><span id="l66.1785" class="difflineminus">-    newEntry.ToString(entryString) ;</span>
<a href="#l66.1786"></a><span id="l66.1786" class="difflineminus">-    nsAutoCString uri ;</span>
<a href="#l66.1787"></a><span id="l66.1787" class="difflineminus">-</span>
<a href="#l66.1788"></a><span id="l66.1788" class="difflineminus">-    buildAbWinUri(kOutlookCardScheme, mAbWinType, uri) ;</span>
<a href="#l66.1789"></a><span id="l66.1789" class="difflineminus">-    uri.Append(entryString) ;</span>
<a href="#l66.1790"></a><span id="l66.1790" class="difflineminus">-</span>
<a href="#l66.1791"></a><span id="l66.1791" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l66.1792"></a><span id="l66.1792" class="difflineminus">-    retCode = OutlookCardForURI(uri, getter_AddRefs(newCard));</span>
<a href="#l66.1793"></a><span id="l66.1793" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1794"></a><span id="l66.1794" class="difflineplus">+  }</span>
<a href="#l66.1795"></a><span id="l66.1795" class="difflineplus">+  // If this approach doesn't work, well we're back to creating and copying.</span>
<a href="#l66.1796"></a><span id="l66.1796" class="difflineplus">+  if (newEntry.mByteCount == 0) {</span>
<a href="#l66.1797"></a><span id="l66.1797" class="difflineplus">+    // In the case of a mailing list, we cannot directly create a new card,</span>
<a href="#l66.1798"></a><span id="l66.1798" class="difflineplus">+    // we have to create a temporary one in a real folder (to be able to use</span>
<a href="#l66.1799"></a><span id="l66.1799" class="difflineplus">+    // templates) and then copy it to the mailing list.</span>
<a href="#l66.1800"></a><span id="l66.1800" class="difflineplus">+    if (m_IsMailList) {</span>
<a href="#l66.1801"></a><span id="l66.1801" class="difflineplus">+      nsMapiEntry parentEntry;</span>
<a href="#l66.1802"></a><span id="l66.1802" class="difflineplus">+      nsMapiEntry temporaryEntry;</span>
<a href="#l66.1803"></a><span id="l66.1803"> </span>
<a href="#l66.1804"></a><span id="l66.1804" class="difflineminus">-    nsAutoCString ourUuid;</span>
<a href="#l66.1805"></a><span id="l66.1805" class="difflineminus">-    GetUuid(ourUuid);</span>
<a href="#l66.1806"></a><span id="l66.1806" class="difflineminus">-    newCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l66.1807"></a><span id="l66.1807" class="difflineplus">+      if (!mapiAddBook-&gt;GetDefaultContainer(parentEntry)) {</span>
<a href="#l66.1808"></a><span id="l66.1808" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l66.1809"></a><span id="l66.1809" class="difflineplus">+      }</span>
<a href="#l66.1810"></a><span id="l66.1810" class="difflineplus">+      if (!mapiAddBook-&gt;CreateEntry(parentEntry, temporaryEntry)) {</span>
<a href="#l66.1811"></a><span id="l66.1811" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l66.1812"></a><span id="l66.1812" class="difflineplus">+      }</span>
<a href="#l66.1813"></a><span id="l66.1813" class="difflineplus">+      if (!mapiAddBook-&gt;CopyEntry(*mMapiData, temporaryEntry, newEntry)) {</span>
<a href="#l66.1814"></a><span id="l66.1814" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l66.1815"></a><span id="l66.1815" class="difflineplus">+      }</span>
<a href="#l66.1816"></a><span id="l66.1816" class="difflineplus">+      if (!mapiAddBook-&gt;DeleteEntry(parentEntry, temporaryEntry)) {</span>
<a href="#l66.1817"></a><span id="l66.1817" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l66.1818"></a><span id="l66.1818" class="difflineplus">+      }</span>
<a href="#l66.1819"></a><span id="l66.1819" class="difflineplus">+    }</span>
<a href="#l66.1820"></a><span id="l66.1820" class="difflineplus">+    // If we're on a real address book folder, we can directly create an</span>
<a href="#l66.1821"></a><span id="l66.1821" class="difflineplus">+    // empty card.</span>
<a href="#l66.1822"></a><span id="l66.1822" class="difflineplus">+    else if (!mapiAddBook-&gt;CreateEntry(*mMapiData, newEntry)) {</span>
<a href="#l66.1823"></a><span id="l66.1823" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l66.1824"></a><span id="l66.1824" class="difflineplus">+    }</span>
<a href="#l66.1825"></a><span id="l66.1825" class="difflineplus">+  }</span>
<a href="#l66.1826"></a><span id="l66.1826" class="difflineplus">+  newEntry.ToString(entryString);</span>
<a href="#l66.1827"></a><span id="l66.1827" class="difflineplus">+  nsAutoCString uri;</span>
<a href="#l66.1828"></a><span id="l66.1828"> </span>
<a href="#l66.1829"></a><span id="l66.1829" class="difflineminus">-    if (!didCopy) {</span>
<a href="#l66.1830"></a><span id="l66.1830" class="difflineminus">-        retCode = newCard-&gt;Copy(aData) ;</span>
<a href="#l66.1831"></a><span id="l66.1831" class="difflineminus">-        NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1832"></a><span id="l66.1832" class="difflineminus">-        retCode = ModifyCard(newCard) ;</span>
<a href="#l66.1833"></a><span id="l66.1833" class="difflineminus">-        NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l66.1834"></a><span id="l66.1834" class="difflineminus">-    }</span>
<a href="#l66.1835"></a><span id="l66.1835" class="difflineminus">-    newCard.forget(aNewCard);</span>
<a href="#l66.1836"></a><span id="l66.1836" class="difflineminus">-    return retCode ;</span>
<a href="#l66.1837"></a><span id="l66.1837" class="difflineplus">+  buildAbWinUri(kOutlookCardScheme, mAbWinType, uri);</span>
<a href="#l66.1838"></a><span id="l66.1838" class="difflineplus">+  uri.Append(entryString);</span>
<a href="#l66.1839"></a><span id="l66.1839" class="difflineplus">+</span>
<a href="#l66.1840"></a><span id="l66.1840" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l66.1841"></a><span id="l66.1841" class="difflineplus">+  retCode = OutlookCardForURI(uri, getter_AddRefs(newCard));</span>
<a href="#l66.1842"></a><span id="l66.1842" class="difflineplus">+  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1843"></a><span id="l66.1843" class="difflineplus">+</span>
<a href="#l66.1844"></a><span id="l66.1844" class="difflineplus">+  nsAutoCString ourUuid;</span>
<a href="#l66.1845"></a><span id="l66.1845" class="difflineplus">+  GetUuid(ourUuid);</span>
<a href="#l66.1846"></a><span id="l66.1846" class="difflineplus">+  newCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l66.1847"></a><span id="l66.1847" class="difflineplus">+</span>
<a href="#l66.1848"></a><span id="l66.1848" class="difflineplus">+  if (!didCopy) {</span>
<a href="#l66.1849"></a><span id="l66.1849" class="difflineplus">+    retCode = newCard-&gt;Copy(aData);</span>
<a href="#l66.1850"></a><span id="l66.1850" class="difflineplus">+    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1851"></a><span id="l66.1851" class="difflineplus">+    retCode = ModifyCard(newCard);</span>
<a href="#l66.1852"></a><span id="l66.1852" class="difflineplus">+    NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1853"></a><span id="l66.1853" class="difflineplus">+  }</span>
<a href="#l66.1854"></a><span id="l66.1854" class="difflineplus">+  newCard.forget(aNewCard);</span>
<a href="#l66.1855"></a><span id="l66.1855" class="difflineplus">+  return retCode;</span>
<a href="#l66.1856"></a><span id="l66.1856"> }</span>
<a href="#l66.1857"></a><span id="l66.1857"> </span>
<a href="#l66.1858"></a><span id="l66.1858" class="difflineminus">-static void UnicodeToWord(const char16_t *aUnicode, WORD&amp; aWord)</span>
<a href="#l66.1859"></a><span id="l66.1859" class="difflineminus">-{</span>
<a href="#l66.1860"></a><span id="l66.1860" class="difflineminus">-    aWord = 0 ;</span>
<a href="#l66.1861"></a><span id="l66.1861" class="difflineminus">-    if (aUnicode == nullptr || *aUnicode == 0) { return ; }</span>
<a href="#l66.1862"></a><span id="l66.1862" class="difflineminus">-    nsresult errorCode = NS_OK;</span>
<a href="#l66.1863"></a><span id="l66.1863" class="difflineminus">-    nsAutoString unichar (aUnicode) ;</span>
<a href="#l66.1864"></a><span id="l66.1864" class="difflineplus">+static void UnicodeToWord(const char16_t *aUnicode, WORD &amp;aWord) {</span>
<a href="#l66.1865"></a><span id="l66.1865" class="difflineplus">+  aWord = 0;</span>
<a href="#l66.1866"></a><span id="l66.1866" class="difflineplus">+  if (aUnicode == nullptr || *aUnicode == 0) {</span>
<a href="#l66.1867"></a><span id="l66.1867" class="difflineplus">+    return;</span>
<a href="#l66.1868"></a><span id="l66.1868" class="difflineplus">+  }</span>
<a href="#l66.1869"></a><span id="l66.1869" class="difflineplus">+  nsresult errorCode = NS_OK;</span>
<a href="#l66.1870"></a><span id="l66.1870" class="difflineplus">+  nsAutoString unichar(aUnicode);</span>
<a href="#l66.1871"></a><span id="l66.1871"> </span>
<a href="#l66.1872"></a><span id="l66.1872" class="difflineminus">-    aWord = static_cast&lt;WORD&gt;(unichar.ToInteger(&amp;errorCode));</span>
<a href="#l66.1873"></a><span id="l66.1873" class="difflineminus">-    if (NS_FAILED(errorCode)) {</span>
<a href="#l66.1874"></a><span id="l66.1874" class="difflineminus">-        PRINTF((&quot;Error conversion string %S: %08x.\n&quot;, unichar.get(), errorCode)) ;</span>
<a href="#l66.1875"></a><span id="l66.1875" class="difflineminus">-    }</span>
<a href="#l66.1876"></a><span id="l66.1876" class="difflineplus">+  aWord = static_cast&lt;WORD&gt;(unichar.ToInteger(&amp;errorCode));</span>
<a href="#l66.1877"></a><span id="l66.1877" class="difflineplus">+  if (NS_FAILED(errorCode)) {</span>
<a href="#l66.1878"></a><span id="l66.1878" class="difflineplus">+    PRINTF((&quot;Error conversion string %S: %08x.\n&quot;, unichar.get(), errorCode));</span>
<a href="#l66.1879"></a><span id="l66.1879" class="difflineplus">+  }</span>
<a href="#l66.1880"></a><span id="l66.1880"> }</span>
<a href="#l66.1881"></a><span id="l66.1881"> </span>
<a href="#l66.1882"></a><span id="l66.1882"> #define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l66.1883"></a><span id="l66.1883"> </span>
<a href="#l66.1884"></a><span id="l66.1884" class="difflineminus">-</span>
<a href="#l66.1885"></a><span id="l66.1885" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::ModifyCard(nsIAbCard *aModifiedCard)</span>
<a href="#l66.1886"></a><span id="l66.1886" class="difflineminus">-{</span>
<a href="#l66.1887"></a><span id="l66.1887" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::ModifyCard(nsIAbCard *aModifiedCard) {</span>
<a href="#l66.1888"></a><span id="l66.1888">   NS_ENSURE_ARG_POINTER(aModifiedCard);</span>
<a href="#l66.1889"></a><span id="l66.1889"> </span>
<a href="#l66.1890"></a><span id="l66.1890">   nsString *properties = nullptr;</span>
<a href="#l66.1891"></a><span id="l66.1891">   nsAutoString utility;</span>
<a href="#l66.1892"></a><span id="l66.1892">   nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l66.1893"></a><span id="l66.1893"> </span>
<a href="#l66.1894"></a><span id="l66.1894" class="difflineminus">-  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l66.1895"></a><span id="l66.1895" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l66.1896"></a><span id="l66.1896" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) return NS_ERROR_FAILURE;</span>
<a href="#l66.1897"></a><span id="l66.1897"> </span>
<a href="#l66.1898"></a><span id="l66.1898">   nsCString entry;</span>
<a href="#l66.1899"></a><span id="l66.1899">   nsresult retCode = ExtractCardEntry(aModifiedCard, entry);</span>
<a href="#l66.1900"></a><span id="l66.1900">   NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l66.1901"></a><span id="l66.1901">   // If we don't have the card entry, we can't work.</span>
<a href="#l66.1902"></a><span id="l66.1902" class="difflineminus">-  if (entry.IsEmpty())</span>
<a href="#l66.1903"></a><span id="l66.1903" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l66.1904"></a><span id="l66.1904" class="difflineplus">+  if (entry.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l66.1905"></a><span id="l66.1905"> </span>
<a href="#l66.1906"></a><span id="l66.1906">   nsMapiEntry mapiData;</span>
<a href="#l66.1907"></a><span id="l66.1907">   mapiData.Assign(entry);</span>
<a href="#l66.1908"></a><span id="l66.1908"> </span>
<a href="#l66.1909"></a><span id="l66.1909">   // First, all the standard properties in one go</span>
<a href="#l66.1910"></a><span id="l66.1910">   properties = new nsString[index_LastProp];</span>
<a href="#l66.1911"></a><span id="l66.1911">   if (!properties) {</span>
<a href="#l66.1912"></a><span id="l66.1912">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l66.1913"></a><span id="l66.1913" class="difflineat">@@ -1301,236 +1262,250 @@ NS_IMETHODIMP nsAbOutlookDirectory::Modi</span>
<a href="#l66.1914"></a><span id="l66.1914">   // is because in the case of a mailing list edition in</span>
<a href="#l66.1915"></a><span id="l66.1915">   // Mozilla, the display name will not be provided, and</span>
<a href="#l66.1916"></a><span id="l66.1916">   // MAPI doesn't allow that, so we fall back on an optional</span>
<a href="#l66.1917"></a><span id="l66.1917">   // name, and when all fails, on the email address.</span>
<a href="#l66.1918"></a><span id="l66.1918">   aModifiedCard-&gt;GetDisplayName(properties[index_DisplayName]);</span>
<a href="#l66.1919"></a><span id="l66.1919">   if (properties[index_DisplayName].IsEmpty()) {</span>
<a href="#l66.1920"></a><span id="l66.1920">     nsresult rv;</span>
<a href="#l66.1921"></a><span id="l66.1921">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l66.1922"></a><span id="l66.1922" class="difflineminus">-      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l66.1923"></a><span id="l66.1923" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l66.1924"></a><span id="l66.1924" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l66.1925"></a><span id="l66.1925" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1926"></a><span id="l66.1926"> </span>
<a href="#l66.1927"></a><span id="l66.1927">     int32_t format;</span>
<a href="#l66.1928"></a><span id="l66.1928">     rv = prefBranch-&gt;GetIntPref(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, &amp;format);</span>
<a href="#l66.1929"></a><span id="l66.1929" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l66.1930"></a><span id="l66.1930" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1931"></a><span id="l66.1931"> </span>
<a href="#l66.1932"></a><span id="l66.1932">     rv = aModifiedCard-&gt;GenerateName(format, nullptr,</span>
<a href="#l66.1933"></a><span id="l66.1933">                                      properties[index_DisplayName]);</span>
<a href="#l66.1934"></a><span id="l66.1934" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l66.1935"></a><span id="l66.1935" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.1936"></a><span id="l66.1936"> </span>
<a href="#l66.1937"></a><span id="l66.1937">     if (properties[index_DisplayName].IsEmpty()) {</span>
<a href="#l66.1938"></a><span id="l66.1938">       aModifiedCard-&gt;GetPrimaryEmail(properties[index_DisplayName]);</span>
<a href="#l66.1939"></a><span id="l66.1939">     }</span>
<a href="#l66.1940"></a><span id="l66.1940">   }</span>
<a href="#l66.1941"></a><span id="l66.1941">   aModifiedCard-&gt;SetDisplayName(properties[index_DisplayName]);</span>
<a href="#l66.1942"></a><span id="l66.1942">   aModifiedCard-&gt;GetPrimaryEmail(properties[index_EmailAddress]);</span>
<a href="#l66.1943"></a><span id="l66.1943" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kNicknameProperty, properties[index_NickName]);</span>
<a href="#l66.1944"></a><span id="l66.1944" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kWorkPhoneProperty, properties[index_WorkPhoneNumber]);</span>
<a href="#l66.1945"></a><span id="l66.1945" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kHomePhoneProperty, properties[index_HomePhoneNumber]);</span>
<a href="#l66.1946"></a><span id="l66.1946" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kFaxProperty, properties[index_WorkFaxNumber]);</span>
<a href="#l66.1947"></a><span id="l66.1947" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kPagerProperty, properties[index_PagerNumber]);</span>
<a href="#l66.1948"></a><span id="l66.1948" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kCellularProperty, properties[index_MobileNumber]);</span>
<a href="#l66.1949"></a><span id="l66.1949" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kHomeCityProperty, properties[index_HomeCity]);</span>
<a href="#l66.1950"></a><span id="l66.1950" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kHomeStateProperty, properties[index_HomeState]);</span>
<a href="#l66.1951"></a><span id="l66.1951" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kHomeZipCodeProperty, properties[index_HomeZip]);</span>
<a href="#l66.1952"></a><span id="l66.1952" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kHomeCountryProperty, properties[index_HomeCountry]);</span>
<a href="#l66.1953"></a><span id="l66.1953" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kWorkCityProperty, properties[index_WorkCity]);</span>
<a href="#l66.1954"></a><span id="l66.1954" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kWorkStateProperty, properties[index_WorkState]);</span>
<a href="#l66.1955"></a><span id="l66.1955" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kWorkZipCodeProperty, properties[index_WorkZip]);</span>
<a href="#l66.1956"></a><span id="l66.1956" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kWorkCountryProperty, properties[index_WorkCountry]);</span>
<a href="#l66.1957"></a><span id="l66.1957" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kJobTitleProperty, properties[index_JobTitle]);</span>
<a href="#l66.1958"></a><span id="l66.1958" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kDepartmentProperty, properties[index_Department]);</span>
<a href="#l66.1959"></a><span id="l66.1959" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kCompanyProperty, properties[index_Company]);</span>
<a href="#l66.1960"></a><span id="l66.1960" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kWorkWebPageProperty, properties[index_WorkWebPage]);</span>
<a href="#l66.1961"></a><span id="l66.1961" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kHomeWebPageProperty, properties[index_HomeWebPage]);</span>
<a href="#l66.1962"></a><span id="l66.1962" class="difflineminus">-  aModifiedCard-&gt;GetPropertyAsAString(kNotesProperty, properties[index_Comments]);</span>
<a href="#l66.1963"></a><span id="l66.1963" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kNicknameProperty,</span>
<a href="#l66.1964"></a><span id="l66.1964" class="difflineplus">+                                      properties[index_NickName]);</span>
<a href="#l66.1965"></a><span id="l66.1965" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkPhoneProperty,</span>
<a href="#l66.1966"></a><span id="l66.1966" class="difflineplus">+                                      properties[index_WorkPhoneNumber]);</span>
<a href="#l66.1967"></a><span id="l66.1967" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomePhoneProperty,</span>
<a href="#l66.1968"></a><span id="l66.1968" class="difflineplus">+                                      properties[index_HomePhoneNumber]);</span>
<a href="#l66.1969"></a><span id="l66.1969" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kFaxProperty,</span>
<a href="#l66.1970"></a><span id="l66.1970" class="difflineplus">+                                      properties[index_WorkFaxNumber]);</span>
<a href="#l66.1971"></a><span id="l66.1971" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kPagerProperty,</span>
<a href="#l66.1972"></a><span id="l66.1972" class="difflineplus">+                                      properties[index_PagerNumber]);</span>
<a href="#l66.1973"></a><span id="l66.1973" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kCellularProperty,</span>
<a href="#l66.1974"></a><span id="l66.1974" class="difflineplus">+                                      properties[index_MobileNumber]);</span>
<a href="#l66.1975"></a><span id="l66.1975" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeCityProperty,</span>
<a href="#l66.1976"></a><span id="l66.1976" class="difflineplus">+                                      properties[index_HomeCity]);</span>
<a href="#l66.1977"></a><span id="l66.1977" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeStateProperty,</span>
<a href="#l66.1978"></a><span id="l66.1978" class="difflineplus">+                                      properties[index_HomeState]);</span>
<a href="#l66.1979"></a><span id="l66.1979" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeZipCodeProperty,</span>
<a href="#l66.1980"></a><span id="l66.1980" class="difflineplus">+                                      properties[index_HomeZip]);</span>
<a href="#l66.1981"></a><span id="l66.1981" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeCountryProperty,</span>
<a href="#l66.1982"></a><span id="l66.1982" class="difflineplus">+                                      properties[index_HomeCountry]);</span>
<a href="#l66.1983"></a><span id="l66.1983" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkCityProperty,</span>
<a href="#l66.1984"></a><span id="l66.1984" class="difflineplus">+                                      properties[index_WorkCity]);</span>
<a href="#l66.1985"></a><span id="l66.1985" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkStateProperty,</span>
<a href="#l66.1986"></a><span id="l66.1986" class="difflineplus">+                                      properties[index_WorkState]);</span>
<a href="#l66.1987"></a><span id="l66.1987" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkZipCodeProperty,</span>
<a href="#l66.1988"></a><span id="l66.1988" class="difflineplus">+                                      properties[index_WorkZip]);</span>
<a href="#l66.1989"></a><span id="l66.1989" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkCountryProperty,</span>
<a href="#l66.1990"></a><span id="l66.1990" class="difflineplus">+                                      properties[index_WorkCountry]);</span>
<a href="#l66.1991"></a><span id="l66.1991" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kJobTitleProperty,</span>
<a href="#l66.1992"></a><span id="l66.1992" class="difflineplus">+                                      properties[index_JobTitle]);</span>
<a href="#l66.1993"></a><span id="l66.1993" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kDepartmentProperty,</span>
<a href="#l66.1994"></a><span id="l66.1994" class="difflineplus">+                                      properties[index_Department]);</span>
<a href="#l66.1995"></a><span id="l66.1995" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kCompanyProperty,</span>
<a href="#l66.1996"></a><span id="l66.1996" class="difflineplus">+                                      properties[index_Company]);</span>
<a href="#l66.1997"></a><span id="l66.1997" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kWorkWebPageProperty,</span>
<a href="#l66.1998"></a><span id="l66.1998" class="difflineplus">+                                      properties[index_WorkWebPage]);</span>
<a href="#l66.1999"></a><span id="l66.1999" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kHomeWebPageProperty,</span>
<a href="#l66.2000"></a><span id="l66.2000" class="difflineplus">+                                      properties[index_HomeWebPage]);</span>
<a href="#l66.2001"></a><span id="l66.2001" class="difflineplus">+  aModifiedCard-&gt;GetPropertyAsAString(kNotesProperty,</span>
<a href="#l66.2002"></a><span id="l66.2002" class="difflineplus">+                                      properties[index_Comments]);</span>
<a href="#l66.2003"></a><span id="l66.2003">   if (!mapiAddBook-&gt;SetPropertiesUString(mapiData, OutlookCardMAPIProps,</span>
<a href="#l66.2004"></a><span id="l66.2004">                                          index_LastProp, properties)) {</span>
<a href="#l66.2005"></a><span id="l66.2005" class="difflineminus">-    PRINTF((&quot;Cannot set general properties.\n&quot;)) ;</span>
<a href="#l66.2006"></a><span id="l66.2006" class="difflineplus">+    PRINTF((&quot;Cannot set general properties.\n&quot;));</span>
<a href="#l66.2007"></a><span id="l66.2007">   }</span>
<a href="#l66.2008"></a><span id="l66.2008"> </span>
<a href="#l66.2009"></a><span id="l66.2009" class="difflineminus">-  delete [] properties;</span>
<a href="#l66.2010"></a><span id="l66.2010" class="difflineplus">+  delete[] properties;</span>
<a href="#l66.2011"></a><span id="l66.2011">   nsString unichar;</span>
<a href="#l66.2012"></a><span id="l66.2012">   nsString unichar2;</span>
<a href="#l66.2013"></a><span id="l66.2013">   WORD year = 0;</span>
<a href="#l66.2014"></a><span id="l66.2014">   WORD month = 0;</span>
<a href="#l66.2015"></a><span id="l66.2015">   WORD day = 0;</span>
<a href="#l66.2016"></a><span id="l66.2016"> </span>
<a href="#l66.2017"></a><span id="l66.2017">   aModifiedCard-&gt;GetPropertyAsAString(kHomeAddressProperty, unichar);</span>
<a href="#l66.2018"></a><span id="l66.2018">   aModifiedCard-&gt;GetPropertyAsAString(kHomeAddress2Property, unichar2);</span>
<a href="#l66.2019"></a><span id="l66.2019"> </span>
<a href="#l66.2020"></a><span id="l66.2020">   utility.Assign(unichar.get());</span>
<a href="#l66.2021"></a><span id="l66.2021" class="difflineminus">-  if (!utility.IsEmpty())</span>
<a href="#l66.2022"></a><span id="l66.2022" class="difflineminus">-    utility.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l66.2023"></a><span id="l66.2023" class="difflineplus">+  if (!utility.IsEmpty()) utility.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l66.2024"></a><span id="l66.2024"> </span>
<a href="#l66.2025"></a><span id="l66.2025">   utility.Append(unichar2.get());</span>
<a href="#l66.2026"></a><span id="l66.2026" class="difflineminus">-  if (!mapiAddBook-&gt;SetPropertyUString(mapiData, PR_HOME_ADDRESS_STREET_W, utility.get())) {</span>
<a href="#l66.2027"></a><span id="l66.2027" class="difflineminus">-    PRINTF((&quot;Cannot set home address.\n&quot;)) ;</span>
<a href="#l66.2028"></a><span id="l66.2028" class="difflineplus">+  if (!mapiAddBook-&gt;SetPropertyUString(mapiData, PR_HOME_ADDRESS_STREET_W,</span>
<a href="#l66.2029"></a><span id="l66.2029" class="difflineplus">+                                       utility.get())) {</span>
<a href="#l66.2030"></a><span id="l66.2030" class="difflineplus">+    PRINTF((&quot;Cannot set home address.\n&quot;));</span>
<a href="#l66.2031"></a><span id="l66.2031">   }</span>
<a href="#l66.2032"></a><span id="l66.2032"> </span>
<a href="#l66.2033"></a><span id="l66.2033">   unichar.Truncate();</span>
<a href="#l66.2034"></a><span id="l66.2034">   aModifiedCard-&gt;GetPropertyAsAString(kWorkAddressProperty, unichar);</span>
<a href="#l66.2035"></a><span id="l66.2035">   unichar2.Truncate();</span>
<a href="#l66.2036"></a><span id="l66.2036">   aModifiedCard-&gt;GetPropertyAsAString(kWorkAddress2Property, unichar2);</span>
<a href="#l66.2037"></a><span id="l66.2037"> </span>
<a href="#l66.2038"></a><span id="l66.2038">   utility.Assign(unichar.get());</span>
<a href="#l66.2039"></a><span id="l66.2039" class="difflineminus">-  if (!utility.IsEmpty())</span>
<a href="#l66.2040"></a><span id="l66.2040" class="difflineminus">-    utility.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l66.2041"></a><span id="l66.2041" class="difflineplus">+  if (!utility.IsEmpty()) utility.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l66.2042"></a><span id="l66.2042"> </span>
<a href="#l66.2043"></a><span id="l66.2043">   utility.Append(unichar2.get());</span>
<a href="#l66.2044"></a><span id="l66.2044" class="difflineminus">-  if (!mapiAddBook-&gt;SetPropertyUString(mapiData, PR_BUSINESS_ADDRESS_STREET_W, utility.get())) {</span>
<a href="#l66.2045"></a><span id="l66.2045" class="difflineminus">-    PRINTF((&quot;Cannot set work address.\n&quot;)) ;</span>
<a href="#l66.2046"></a><span id="l66.2046" class="difflineplus">+  if (!mapiAddBook-&gt;SetPropertyUString(mapiData, PR_BUSINESS_ADDRESS_STREET_W,</span>
<a href="#l66.2047"></a><span id="l66.2047" class="difflineplus">+                                       utility.get())) {</span>
<a href="#l66.2048"></a><span id="l66.2048" class="difflineplus">+    PRINTF((&quot;Cannot set work address.\n&quot;));</span>
<a href="#l66.2049"></a><span id="l66.2049">   }</span>
<a href="#l66.2050"></a><span id="l66.2050"> </span>
<a href="#l66.2051"></a><span id="l66.2051">   unichar.Truncate();</span>
<a href="#l66.2052"></a><span id="l66.2052">   aModifiedCard-&gt;GetPropertyAsAString(kBirthYearProperty, unichar);</span>
<a href="#l66.2053"></a><span id="l66.2053">   UnicodeToWord(unichar.get(), year);</span>
<a href="#l66.2054"></a><span id="l66.2054">   unichar.Truncate();</span>
<a href="#l66.2055"></a><span id="l66.2055">   aModifiedCard-&gt;GetPropertyAsAString(kBirthMonthProperty, unichar);</span>
<a href="#l66.2056"></a><span id="l66.2056">   UnicodeToWord(unichar.get(), month);</span>
<a href="#l66.2057"></a><span id="l66.2057">   unichar.Truncate();</span>
<a href="#l66.2058"></a><span id="l66.2058">   aModifiedCard-&gt;GetPropertyAsAString(kBirthDayProperty, unichar);</span>
<a href="#l66.2059"></a><span id="l66.2059">   UnicodeToWord(unichar.get(), day);</span>
<a href="#l66.2060"></a><span id="l66.2060">   if (!mapiAddBook-&gt;SetPropertyDate(mapiData, PR_BIRTHDAY, year, month, day)) {</span>
<a href="#l66.2061"></a><span id="l66.2061" class="difflineminus">-    PRINTF((&quot;Cannot set date.\n&quot;)) ;</span>
<a href="#l66.2062"></a><span id="l66.2062" class="difflineplus">+    PRINTF((&quot;Cannot set date.\n&quot;));</span>
<a href="#l66.2063"></a><span id="l66.2063">   }</span>
<a href="#l66.2064"></a><span id="l66.2064"> </span>
<a href="#l66.2065"></a><span id="l66.2065">   return retCode;</span>
<a href="#l66.2066"></a><span id="l66.2066"> }</span>
<a href="#l66.2067"></a><span id="l66.2067"> </span>
<a href="#l66.2068"></a><span id="l66.2068" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::OnQueryFoundCard(nsIAbCard *aCard)</span>
<a href="#l66.2069"></a><span id="l66.2069" class="difflineminus">-{</span>
<a href="#l66.2070"></a><span id="l66.2070" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::OnQueryFoundCard(nsIAbCard *aCard) {</span>
<a href="#l66.2071"></a><span id="l66.2071">   return OnSearchFoundCard(aCard);</span>
<a href="#l66.2072"></a><span id="l66.2072"> }</span>
<a href="#l66.2073"></a><span id="l66.2073"> </span>
<a href="#l66.2074"></a><span id="l66.2074"> NS_IMETHODIMP nsAbOutlookDirectory::OnQueryResult(int32_t aResult,</span>
<a href="#l66.2075"></a><span id="l66.2075" class="difflineminus">-                                                  int32_t aErrorCode)</span>
<a href="#l66.2076"></a><span id="l66.2076" class="difflineminus">-{</span>
<a href="#l66.2077"></a><span id="l66.2077" class="difflineplus">+                                                  int32_t aErrorCode) {</span>
<a href="#l66.2078"></a><span id="l66.2078">   return OnSearchFinished(aResult, EmptyString());</span>
<a href="#l66.2079"></a><span id="l66.2079"> }</span>
<a href="#l66.2080"></a><span id="l66.2080"> </span>
<a href="#l66.2081"></a><span id="l66.2081" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::UseForAutocomplete(const nsACString &amp;aIdentityKey, bool *aResult)</span>
<a href="#l66.2082"></a><span id="l66.2082" class="difflineminus">-{</span>
<a href="#l66.2083"></a><span id="l66.2083" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::UseForAutocomplete(</span>
<a href="#l66.2084"></a><span id="l66.2084" class="difflineplus">+    const nsACString &amp;aIdentityKey, bool *aResult) {</span>
<a href="#l66.2085"></a><span id="l66.2085">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l66.2086"></a><span id="l66.2086">   *aResult = false;</span>
<a href="#l66.2087"></a><span id="l66.2087">   return NS_OK;</span>
<a href="#l66.2088"></a><span id="l66.2088"> }</span>
<a href="#l66.2089"></a><span id="l66.2089"> </span>
<a href="#l66.2090"></a><span id="l66.2090" class="difflineminus">-static void splitString(nsString&amp; aSource, nsString&amp; aTarget)</span>
<a href="#l66.2091"></a><span id="l66.2091" class="difflineminus">-{</span>
<a href="#l66.2092"></a><span id="l66.2092" class="difflineplus">+static void splitString(nsString &amp;aSource, nsString &amp;aTarget) {</span>
<a href="#l66.2093"></a><span id="l66.2093">   aTarget.Truncate();</span>
<a href="#l66.2094"></a><span id="l66.2094">   int32_t offset = aSource.FindChar('\n');</span>
<a href="#l66.2095"></a><span id="l66.2095"> </span>
<a href="#l66.2096"></a><span id="l66.2096" class="difflineminus">-  if (offset &gt;= 0)</span>
<a href="#l66.2097"></a><span id="l66.2097" class="difflineminus">-  {</span>
<a href="#l66.2098"></a><span id="l66.2098" class="difflineplus">+  if (offset &gt;= 0) {</span>
<a href="#l66.2099"></a><span id="l66.2099">     const char16_t *source = aSource.get() + offset + 1;</span>
<a href="#l66.2100"></a><span id="l66.2100" class="difflineminus">-    while (*source)</span>
<a href="#l66.2101"></a><span id="l66.2101" class="difflineminus">-    {</span>
<a href="#l66.2102"></a><span id="l66.2102" class="difflineplus">+    while (*source) {</span>
<a href="#l66.2103"></a><span id="l66.2103">       if (*source == '\n' || *source == '\r')</span>
<a href="#l66.2104"></a><span id="l66.2104">         aTarget.Append(char16_t(' '));</span>
<a href="#l66.2105"></a><span id="l66.2105">       else</span>
<a href="#l66.2106"></a><span id="l66.2106">         aTarget.Append(*source);</span>
<a href="#l66.2107"></a><span id="l66.2107">       ++source;</span>
<a href="#l66.2108"></a><span id="l66.2108">     }</span>
<a href="#l66.2109"></a><span id="l66.2109">     aSource.SetLength(offset);</span>
<a href="#l66.2110"></a><span id="l66.2110">   }</span>
<a href="#l66.2111"></a><span id="l66.2111"> }</span>
<a href="#l66.2112"></a><span id="l66.2112"> </span>
<a href="#l66.2113"></a><span id="l66.2113" class="difflineminus">-nsresult OutlookCardForURI(const nsACString &amp;aUri, nsIAbCard **newCard)</span>
<a href="#l66.2114"></a><span id="l66.2114" class="difflineminus">-{</span>
<a href="#l66.2115"></a><span id="l66.2115" class="difflineplus">+nsresult OutlookCardForURI(const nsACString &amp;aUri, nsIAbCard **newCard) {</span>
<a href="#l66.2116"></a><span id="l66.2116">   NS_ENSURE_ARG_POINTER(newCard);</span>
<a href="#l66.2117"></a><span id="l66.2117"> </span>
<a href="#l66.2118"></a><span id="l66.2118">   nsAutoCString entry;</span>
<a href="#l66.2119"></a><span id="l66.2119">   nsAutoCString stub;</span>
<a href="#l66.2120"></a><span id="l66.2120" class="difflineminus">-  uint32_t abWinType = getAbWinType(kOutlookCardScheme,</span>
<a href="#l66.2121"></a><span id="l66.2121" class="difflineminus">-    PromiseFlatCString(aUri).get(), stub, entry);</span>
<a href="#l66.2122"></a><span id="l66.2122" class="difflineminus">-  if (abWinType == nsAbWinType_Unknown)</span>
<a href="#l66.2123"></a><span id="l66.2123" class="difflineminus">-  {</span>
<a href="#l66.2124"></a><span id="l66.2124" class="difflineplus">+  uint32_t abWinType = getAbWinType(</span>
<a href="#l66.2125"></a><span id="l66.2125" class="difflineplus">+      kOutlookCardScheme, PromiseFlatCString(aUri).get(), stub, entry);</span>
<a href="#l66.2126"></a><span id="l66.2126" class="difflineplus">+  if (abWinType == nsAbWinType_Unknown) {</span>
<a href="#l66.2127"></a><span id="l66.2127">     PRINTF((&quot;Huge problem URI=%s.\n&quot;, PromiseFlatCString(aUri).get()));</span>
<a href="#l66.2128"></a><span id="l66.2128">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l66.2129"></a><span id="l66.2129">   }</span>
<a href="#l66.2130"></a><span id="l66.2130"> </span>
<a href="#l66.2131"></a><span id="l66.2131">   nsAbWinHelperGuard mapiAddBook(abWinType);</span>
<a href="#l66.2132"></a><span id="l66.2132" class="difflineminus">-  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l66.2133"></a><span id="l66.2133" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l66.2134"></a><span id="l66.2134" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK()) return NS_ERROR_FAILURE;</span>
<a href="#l66.2135"></a><span id="l66.2135"> </span>
<a href="#l66.2136"></a><span id="l66.2136">   nsresult rv;</span>
<a href="#l66.2137"></a><span id="l66.2137" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l66.2138"></a><span id="l66.2138" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card =</span>
<a href="#l66.2139"></a><span id="l66.2139" class="difflineplus">+      do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l66.2140"></a><span id="l66.2140">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l66.2141"></a><span id="l66.2141"> </span>
<a href="#l66.2142"></a><span id="l66.2142">   card-&gt;SetPropertyAsAUTF8String(&quot;OutlookEntryURI&quot;, aUri);</span>
<a href="#l66.2143"></a><span id="l66.2143">   card-&gt;SetLocalId(aUri);</span>
<a href="#l66.2144"></a><span id="l66.2144"> </span>
<a href="#l66.2145"></a><span id="l66.2145">   nsMapiEntry mapiData;</span>
<a href="#l66.2146"></a><span id="l66.2146">   mapiData.Assign(entry);</span>
<a href="#l66.2147"></a><span id="l66.2147"> </span>
<a href="#l66.2148"></a><span id="l66.2148">   nsString unichars[index_LastProp];</span>
<a href="#l66.2149"></a><span id="l66.2149"> </span>
<a href="#l66.2150"></a><span id="l66.2150">   if (mapiAddBook-&gt;GetPropertiesUString(mapiData, OutlookCardMAPIProps,</span>
<a href="#l66.2151"></a><span id="l66.2151" class="difflineminus">-                                        index_LastProp, unichars))</span>
<a href="#l66.2152"></a><span id="l66.2152" class="difflineminus">-  {</span>
<a href="#l66.2153"></a><span id="l66.2153" class="difflineplus">+                                        index_LastProp, unichars)) {</span>
<a href="#l66.2154"></a><span id="l66.2154">     card-&gt;SetFirstName(unichars[index_FirstName]);</span>
<a href="#l66.2155"></a><span id="l66.2155">     card-&gt;SetLastName(unichars[index_LastName]);</span>
<a href="#l66.2156"></a><span id="l66.2156">     card-&gt;SetDisplayName(unichars[index_DisplayName]);</span>
<a href="#l66.2157"></a><span id="l66.2157">     card-&gt;SetPrimaryEmail(unichars[index_EmailAddress]);</span>
<a href="#l66.2158"></a><span id="l66.2158">     card-&gt;SetPropertyAsAString(kNicknameProperty, unichars[index_NickName]);</span>
<a href="#l66.2159"></a><span id="l66.2159" class="difflineminus">-    card-&gt;SetPropertyAsAString(kWorkPhoneProperty, unichars[index_WorkPhoneNumber]);</span>
<a href="#l66.2160"></a><span id="l66.2160" class="difflineminus">-    card-&gt;SetPropertyAsAString(kHomePhoneProperty, unichars[index_HomePhoneNumber]);</span>
<a href="#l66.2161"></a><span id="l66.2161" class="difflineplus">+    card-&gt;SetPropertyAsAString(kWorkPhoneProperty,</span>
<a href="#l66.2162"></a><span id="l66.2162" class="difflineplus">+                               unichars[index_WorkPhoneNumber]);</span>
<a href="#l66.2163"></a><span id="l66.2163" class="difflineplus">+    card-&gt;SetPropertyAsAString(kHomePhoneProperty,</span>
<a href="#l66.2164"></a><span id="l66.2164" class="difflineplus">+                               unichars[index_HomePhoneNumber]);</span>
<a href="#l66.2165"></a><span id="l66.2165">     card-&gt;SetPropertyAsAString(kFaxProperty, unichars[index_WorkFaxNumber]);</span>
<a href="#l66.2166"></a><span id="l66.2166">     card-&gt;SetPropertyAsAString(kPagerProperty, unichars[index_PagerNumber]);</span>
<a href="#l66.2167"></a><span id="l66.2167">     card-&gt;SetPropertyAsAString(kCellularProperty, unichars[index_MobileNumber]);</span>
<a href="#l66.2168"></a><span id="l66.2168">     card-&gt;SetPropertyAsAString(kHomeCityProperty, unichars[index_HomeCity]);</span>
<a href="#l66.2169"></a><span id="l66.2169">     card-&gt;SetPropertyAsAString(kHomeStateProperty, unichars[index_HomeState]);</span>
<a href="#l66.2170"></a><span id="l66.2170">     card-&gt;SetPropertyAsAString(kHomeZipCodeProperty, unichars[index_HomeZip]);</span>
<a href="#l66.2171"></a><span id="l66.2171" class="difflineminus">-    card-&gt;SetPropertyAsAString(kHomeCountryProperty, unichars[index_HomeCountry]);</span>
<a href="#l66.2172"></a><span id="l66.2172" class="difflineplus">+    card-&gt;SetPropertyAsAString(kHomeCountryProperty,</span>
<a href="#l66.2173"></a><span id="l66.2173" class="difflineplus">+                               unichars[index_HomeCountry]);</span>
<a href="#l66.2174"></a><span id="l66.2174">     card-&gt;SetPropertyAsAString(kWorkCityProperty, unichars[index_WorkCity]);</span>
<a href="#l66.2175"></a><span id="l66.2175">     card-&gt;SetPropertyAsAString(kWorkStateProperty, unichars[index_WorkState]);</span>
<a href="#l66.2176"></a><span id="l66.2176">     card-&gt;SetPropertyAsAString(kWorkZipCodeProperty, unichars[index_WorkZip]);</span>
<a href="#l66.2177"></a><span id="l66.2177" class="difflineminus">-    card-&gt;SetPropertyAsAString(kWorkCountryProperty, unichars[index_WorkCountry]);</span>
<a href="#l66.2178"></a><span id="l66.2178" class="difflineplus">+    card-&gt;SetPropertyAsAString(kWorkCountryProperty,</span>
<a href="#l66.2179"></a><span id="l66.2179" class="difflineplus">+                               unichars[index_WorkCountry]);</span>
<a href="#l66.2180"></a><span id="l66.2180">     card-&gt;SetPropertyAsAString(kJobTitleProperty, unichars[index_JobTitle]);</span>
<a href="#l66.2181"></a><span id="l66.2181">     card-&gt;SetPropertyAsAString(kDepartmentProperty, unichars[index_Department]);</span>
<a href="#l66.2182"></a><span id="l66.2182">     card-&gt;SetPropertyAsAString(kCompanyProperty, unichars[index_Company]);</span>
<a href="#l66.2183"></a><span id="l66.2183" class="difflineminus">-    card-&gt;SetPropertyAsAString(kWorkWebPageProperty, unichars[index_WorkWebPage]);</span>
<a href="#l66.2184"></a><span id="l66.2184" class="difflineminus">-    card-&gt;SetPropertyAsAString(kHomeWebPageProperty, unichars[index_HomeWebPage]);</span>
<a href="#l66.2185"></a><span id="l66.2185" class="difflineplus">+    card-&gt;SetPropertyAsAString(kWorkWebPageProperty,</span>
<a href="#l66.2186"></a><span id="l66.2186" class="difflineplus">+                               unichars[index_WorkWebPage]);</span>
<a href="#l66.2187"></a><span id="l66.2187" class="difflineplus">+    card-&gt;SetPropertyAsAString(kHomeWebPageProperty,</span>
<a href="#l66.2188"></a><span id="l66.2188" class="difflineplus">+                               unichars[index_HomeWebPage]);</span>
<a href="#l66.2189"></a><span id="l66.2189">     card-&gt;SetPropertyAsAString(kNotesProperty, unichars[index_Comments]);</span>
<a href="#l66.2190"></a><span id="l66.2190">   }</span>
<a href="#l66.2191"></a><span id="l66.2191"> </span>
<a href="#l66.2192"></a><span id="l66.2192">   ULONG cardType = 0;</span>
<a href="#l66.2193"></a><span id="l66.2193" class="difflineminus">-  if (mapiAddBook-&gt;GetPropertyLong(mapiData, PR_OBJECT_TYPE, cardType))</span>
<a href="#l66.2194"></a><span id="l66.2194" class="difflineminus">-  {</span>
<a href="#l66.2195"></a><span id="l66.2195" class="difflineplus">+  if (mapiAddBook-&gt;GetPropertyLong(mapiData, PR_OBJECT_TYPE, cardType)) {</span>
<a href="#l66.2196"></a><span id="l66.2196">     card-&gt;SetIsMailList(cardType == MAPI_DISTLIST);</span>
<a href="#l66.2197"></a><span id="l66.2197" class="difflineminus">-    if (cardType == MAPI_DISTLIST)</span>
<a href="#l66.2198"></a><span id="l66.2198" class="difflineminus">-    {</span>
<a href="#l66.2199"></a><span id="l66.2199" class="difflineplus">+    if (cardType == MAPI_DISTLIST) {</span>
<a href="#l66.2200"></a><span id="l66.2200">       nsAutoCString normalChars;</span>
<a href="#l66.2201"></a><span id="l66.2201">       buildAbWinUri(kOutlookDirectoryScheme, abWinType, normalChars);</span>
<a href="#l66.2202"></a><span id="l66.2202">       normalChars.Append(entry);</span>
<a href="#l66.2203"></a><span id="l66.2203">       card-&gt;SetMailListURI(normalChars.get());</span>
<a href="#l66.2204"></a><span id="l66.2204">     }</span>
<a href="#l66.2205"></a><span id="l66.2205">   }</span>
<a href="#l66.2206"></a><span id="l66.2206"> </span>
<a href="#l66.2207"></a><span id="l66.2207">   nsAutoString unichar;</span>
<a href="#l66.2208"></a><span id="l66.2208">   nsAutoString unicharBis;</span>
<a href="#l66.2209"></a><span id="l66.2209" class="difflineminus">-  if (mapiAddBook-&gt;GetPropertyUString(mapiData, PR_HOME_ADDRESS_STREET_W, unichar))</span>
<a href="#l66.2210"></a><span id="l66.2210" class="difflineminus">-  {</span>
<a href="#l66.2211"></a><span id="l66.2211" class="difflineplus">+  if (mapiAddBook-&gt;GetPropertyUString(mapiData, PR_HOME_ADDRESS_STREET_W,</span>
<a href="#l66.2212"></a><span id="l66.2212" class="difflineplus">+                                      unichar)) {</span>
<a href="#l66.2213"></a><span id="l66.2213">     splitString(unichar, unicharBis);</span>
<a href="#l66.2214"></a><span id="l66.2214">     card-&gt;SetPropertyAsAString(kHomeAddressProperty, unichar);</span>
<a href="#l66.2215"></a><span id="l66.2215">     card-&gt;SetPropertyAsAString(kHomeAddress2Property, unicharBis);</span>
<a href="#l66.2216"></a><span id="l66.2216">   }</span>
<a href="#l66.2217"></a><span id="l66.2217">   if (mapiAddBook-&gt;GetPropertyUString(mapiData, PR_BUSINESS_ADDRESS_STREET_W,</span>
<a href="#l66.2218"></a><span id="l66.2218" class="difflineminus">-                                      unichar))</span>
<a href="#l66.2219"></a><span id="l66.2219" class="difflineminus">-  {</span>
<a href="#l66.2220"></a><span id="l66.2220" class="difflineplus">+                                      unichar)) {</span>
<a href="#l66.2221"></a><span id="l66.2221">     splitString(unichar, unicharBis);</span>
<a href="#l66.2222"></a><span id="l66.2222">     card-&gt;SetPropertyAsAString(kWorkAddressProperty, unichar);</span>
<a href="#l66.2223"></a><span id="l66.2223">     card-&gt;SetPropertyAsAString(kWorkAddress2Property, unicharBis);</span>
<a href="#l66.2224"></a><span id="l66.2224">   }</span>
<a href="#l66.2225"></a><span id="l66.2225"> </span>
<a href="#l66.2226"></a><span id="l66.2226">   WORD year = 0, month = 0, day = 0;</span>
<a href="#l66.2227"></a><span id="l66.2227" class="difflineminus">-  if (mapiAddBook-&gt;GetPropertyDate(mapiData, PR_BIRTHDAY, year, month, day))</span>
<a href="#l66.2228"></a><span id="l66.2228" class="difflineminus">-  {</span>
<a href="#l66.2229"></a><span id="l66.2229" class="difflineplus">+  if (mapiAddBook-&gt;GetPropertyDate(mapiData, PR_BIRTHDAY, year, month, day)) {</span>
<a href="#l66.2230"></a><span id="l66.2230">     card-&gt;SetPropertyAsUint32(kBirthYearProperty, year);</span>
<a href="#l66.2231"></a><span id="l66.2231">     card-&gt;SetPropertyAsUint32(kBirthMonthProperty, month);</span>
<a href="#l66.2232"></a><span id="l66.2232">     card-&gt;SetPropertyAsUint32(kBirthDayProperty, day);</span>
<a href="#l66.2233"></a><span id="l66.2233">   }</span>
<a href="#l66.2234"></a><span id="l66.2234"> </span>
<a href="#l66.2235"></a><span id="l66.2235">   card.forget(newCard);</span>
<a href="#l66.2236"></a><span id="l66.2236">   return NS_OK;</span>
<a href="#l66.2237"></a><span id="l66.2237"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.h</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.h</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -11,122 +11,120 @@</span>
<a href="#l67.4"></a><span id="l67.4"> #include &quot;nsIAbDirectorySearch.h&quot;</span>
<a href="#l67.5"></a><span id="l67.5"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l67.6"></a><span id="l67.6"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l67.7"></a><span id="l67.7"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l67.8"></a><span id="l67.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l67.9"></a><span id="l67.9"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l67.10"></a><span id="l67.10"> #include &quot;prlock.h&quot;</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-struct nsMapiEntry ;</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+struct nsMapiEntry;</span>
<a href="#l67.14"></a><span id="l67.14"> </span>
<a href="#l67.15"></a><span id="l67.15" class="difflineminus">-class nsAbOutlookDirectory : public nsAbDirProperty, // nsIAbDirectory</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineplus">+class nsAbOutlookDirectory : public nsAbDirProperty,  // nsIAbDirectory</span>
<a href="#l67.17"></a><span id="l67.17">                              public nsIAbDirectoryQuery,</span>
<a href="#l67.18"></a><span id="l67.18">                              public nsIAbDirectorySearch,</span>
<a href="#l67.19"></a><span id="l67.19">                              public nsIAbDirSearchListener,</span>
<a href="#l67.20"></a><span id="l67.20" class="difflineminus">-                             public nsIAbDirectoryQueryResultListener</span>
<a href="#l67.21"></a><span id="l67.21" class="difflineminus">-{</span>
<a href="#l67.22"></a><span id="l67.22" class="difflineminus">-public:</span>
<a href="#l67.23"></a><span id="l67.23" class="difflineplus">+                             public nsIAbDirectoryQueryResultListener {</span>
<a href="#l67.24"></a><span id="l67.24" class="difflineplus">+ public:</span>
<a href="#l67.25"></a><span id="l67.25">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l67.26"></a><span id="l67.26">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l67.27"></a><span id="l67.27">   NS_DECL_NSIABDIRECTORYQUERYRESULTLISTENER</span>
<a href="#l67.28"></a><span id="l67.28"> </span>
<a href="#l67.29"></a><span id="l67.29">   nsAbOutlookDirectory(void);</span>
<a href="#l67.30"></a><span id="l67.30"> </span>
<a href="#l67.31"></a><span id="l67.31">   // nsAbDirProperty methods</span>
<a href="#l67.32"></a><span id="l67.32">   NS_IMETHOD GetDirType(int32_t *aDirType) override;</span>
<a href="#l67.33"></a><span id="l67.33">   NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l67.34"></a><span id="l67.34">   NS_IMETHOD GetChildCards(nsISimpleEnumerator **aCards) override;</span>
<a href="#l67.35"></a><span id="l67.35">   NS_IMETHOD GetChildNodes(nsISimpleEnumerator **aNodes) override;</span>
<a href="#l67.36"></a><span id="l67.36">   NS_IMETHOD GetIsQuery(bool *aResult) override;</span>
<a href="#l67.37"></a><span id="l67.37">   NS_IMETHOD HasCard(nsIAbCard *aCard, bool *aHasCard) override;</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineminus">-  NS_IMETHOD HasDirectory(nsIAbDirectory *aDirectory, bool *aHasDirectory) override;</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineplus">+  NS_IMETHOD HasDirectory(nsIAbDirectory *aDirectory,</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineplus">+                          bool *aHasDirectory) override;</span>
<a href="#l67.41"></a><span id="l67.41">   NS_IMETHOD DeleteCards(nsIArray *aCardList) override;</span>
<a href="#l67.42"></a><span id="l67.42">   NS_IMETHOD DeleteDirectory(nsIAbDirectory *aDirectory) override;</span>
<a href="#l67.43"></a><span id="l67.43" class="difflineminus">-  NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey, bool *aResult) override;</span>
<a href="#l67.44"></a><span id="l67.44" class="difflineplus">+  NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineplus">+                                bool *aResult) override;</span>
<a href="#l67.46"></a><span id="l67.46">   NS_IMETHOD AddCard(nsIAbCard *aData, nsIAbCard **addedCard) override;</span>
<a href="#l67.47"></a><span id="l67.47">   NS_IMETHOD ModifyCard(nsIAbCard *aModifiedCard) override;</span>
<a href="#l67.48"></a><span id="l67.48">   NS_IMETHOD DropCard(nsIAbCard *aData, bool needToCopyCard) override;</span>
<a href="#l67.49"></a><span id="l67.49" class="difflineminus">-  NS_IMETHOD AddMailList(nsIAbDirectory *aMailList, nsIAbDirectory **addedList) override;</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineplus">+  NS_IMETHOD AddMailList(nsIAbDirectory *aMailList,</span>
<a href="#l67.51"></a><span id="l67.51" class="difflineplus">+                         nsIAbDirectory **addedList) override;</span>
<a href="#l67.52"></a><span id="l67.52">   NS_IMETHOD EditMailListToDatabase(nsIAbCard *listCard) override;</span>
<a href="#l67.53"></a><span id="l67.53"> </span>
<a href="#l67.54"></a><span id="l67.54">   // nsAbDirProperty method</span>
<a href="#l67.55"></a><span id="l67.55">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l67.56"></a><span id="l67.56">   // nsIAbDirectoryQuery methods</span>
<a href="#l67.57"></a><span id="l67.57">   NS_DECL_NSIABDIRECTORYQUERY</span>
<a href="#l67.58"></a><span id="l67.58">   // nsIAbDirectorySearch methods</span>
<a href="#l67.59"></a><span id="l67.59">   NS_DECL_NSIABDIRECTORYSEARCH</span>
<a href="#l67.60"></a><span id="l67.60">   // Perform a MAPI query (function executed in a separate thread)</span>
<a href="#l67.61"></a><span id="l67.61">   nsresult ExecuteQuery(SRestriction &amp;aRestriction,</span>
<a href="#l67.62"></a><span id="l67.62" class="difflineminus">-                        nsIAbDirSearchListener *aListener,</span>
<a href="#l67.63"></a><span id="l67.63" class="difflineminus">-                        int32_t aResultLimit, int32_t aTimeout,</span>
<a href="#l67.64"></a><span id="l67.64" class="difflineminus">-                        int32_t aThreadId);</span>
<a href="#l67.65"></a><span id="l67.65" class="difflineplus">+                        nsIAbDirSearchListener *aListener, int32_t aResultLimit,</span>
<a href="#l67.66"></a><span id="l67.66" class="difflineplus">+                        int32_t aTimeout, int32_t aThreadId);</span>
<a href="#l67.67"></a><span id="l67.67"> </span>
<a href="#l67.68"></a><span id="l67.68" class="difflineminus">-protected:</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineplus">+ protected:</span>
<a href="#l67.70"></a><span id="l67.70">   // Retrieve hierarchy as cards, with an optional restriction</span>
<a href="#l67.71"></a><span id="l67.71">   nsresult GetChildCards(nsIMutableArray *aCards, void *aRestriction);</span>
<a href="#l67.72"></a><span id="l67.72">   // Retrieve hierarchy as directories</span>
<a href="#l67.73"></a><span id="l67.73">   nsresult GetChildNodes(nsIMutableArray *aNodes);</span>
<a href="#l67.74"></a><span id="l67.74">   // Create a new card</span>
<a href="#l67.75"></a><span id="l67.75">   nsresult CreateCard(nsIAbCard *aData, nsIAbCard **aNewCard);</span>
<a href="#l67.76"></a><span id="l67.76">   // Notification for the UI</span>
<a href="#l67.77"></a><span id="l67.77">   nsresult NotifyItemDeletion(nsISupports *aItem);</span>
<a href="#l67.78"></a><span id="l67.78">   nsresult NotifyItemAddition(nsISupports *aItem);</span>
<a href="#l67.79"></a><span id="l67.79">   // Force update of MAPI repository for mailing list</span>
<a href="#l67.80"></a><span id="l67.80">   nsresult CommitAddressList(void);</span>
<a href="#l67.81"></a><span id="l67.81">   // Read MAPI repository</span>
<a href="#l67.82"></a><span id="l67.82">   nsresult UpdateAddressList(void);</span>
<a href="#l67.83"></a><span id="l67.83"> </span>
<a href="#l67.84"></a><span id="l67.84">   nsMapiEntry *mMapiData;</span>
<a href="#l67.85"></a><span id="l67.85">   // Container for the query threads</span>
<a href="#l67.86"></a><span id="l67.86" class="difflineminus">-  nsDataHashtable&lt;nsUint32HashKey, PRThread*&gt; mQueryThreads;</span>
<a href="#l67.87"></a><span id="l67.87" class="difflineplus">+  nsDataHashtable&lt;nsUint32HashKey, PRThread *&gt; mQueryThreads;</span>
<a href="#l67.88"></a><span id="l67.88">   int32_t mCurrentQueryId;</span>
<a href="#l67.89"></a><span id="l67.89">   PRLock *mProtector;</span>
<a href="#l67.90"></a><span id="l67.90">   // Data for the search interfaces</span>
<a href="#l67.91"></a><span id="l67.91">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIAbCard&gt; mCardList;</span>
<a href="#l67.92"></a><span id="l67.92">   int32_t mSearchContext;</span>
<a href="#l67.93"></a><span id="l67.93">   // Windows AB type</span>
<a href="#l67.94"></a><span id="l67.94">   uint32_t mAbWinType;</span>
<a href="#l67.95"></a><span id="l67.95"> </span>
<a href="#l67.96"></a><span id="l67.96" class="difflineminus">-private:</span>
<a href="#l67.97"></a><span id="l67.97" class="difflineplus">+ private:</span>
<a href="#l67.98"></a><span id="l67.98">   virtual ~nsAbOutlookDirectory(void);</span>
<a href="#l67.99"></a><span id="l67.99" class="difflineminus">-</span>
<a href="#l67.100"></a><span id="l67.100"> };</span>
<a href="#l67.101"></a><span id="l67.101"> </span>
<a href="#l67.102"></a><span id="l67.102" class="difflineminus">-enum</span>
<a href="#l67.103"></a><span id="l67.103" class="difflineminus">-{</span>
<a href="#l67.104"></a><span id="l67.104" class="difflineminus">-    index_DisplayName = 0,</span>
<a href="#l67.105"></a><span id="l67.105" class="difflineminus">-    index_EmailAddress,</span>
<a href="#l67.106"></a><span id="l67.106" class="difflineminus">-    index_FirstName,</span>
<a href="#l67.107"></a><span id="l67.107" class="difflineminus">-    index_LastName,</span>
<a href="#l67.108"></a><span id="l67.108" class="difflineminus">-    index_NickName,</span>
<a href="#l67.109"></a><span id="l67.109" class="difflineminus">-    index_WorkPhoneNumber,</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineminus">-    index_HomePhoneNumber,</span>
<a href="#l67.111"></a><span id="l67.111" class="difflineminus">-    index_WorkFaxNumber,</span>
<a href="#l67.112"></a><span id="l67.112" class="difflineminus">-    index_PagerNumber,</span>
<a href="#l67.113"></a><span id="l67.113" class="difflineminus">-    index_MobileNumber,</span>
<a href="#l67.114"></a><span id="l67.114" class="difflineminus">-    index_HomeCity,</span>
<a href="#l67.115"></a><span id="l67.115" class="difflineminus">-    index_HomeState,</span>
<a href="#l67.116"></a><span id="l67.116" class="difflineminus">-    index_HomeZip,</span>
<a href="#l67.117"></a><span id="l67.117" class="difflineminus">-    index_HomeCountry,</span>
<a href="#l67.118"></a><span id="l67.118" class="difflineminus">-    index_WorkCity,</span>
<a href="#l67.119"></a><span id="l67.119" class="difflineminus">-    index_WorkState,</span>
<a href="#l67.120"></a><span id="l67.120" class="difflineminus">-    index_WorkZip,</span>
<a href="#l67.121"></a><span id="l67.121" class="difflineminus">-    index_WorkCountry,</span>
<a href="#l67.122"></a><span id="l67.122" class="difflineminus">-    index_JobTitle,</span>
<a href="#l67.123"></a><span id="l67.123" class="difflineminus">-    index_Department,</span>
<a href="#l67.124"></a><span id="l67.124" class="difflineminus">-    index_Company,</span>
<a href="#l67.125"></a><span id="l67.125" class="difflineminus">-    index_WorkWebPage,</span>
<a href="#l67.126"></a><span id="l67.126" class="difflineminus">-    index_HomeWebPage,</span>
<a href="#l67.127"></a><span id="l67.127" class="difflineminus">-    index_Comments,</span>
<a href="#l67.128"></a><span id="l67.128" class="difflineminus">-    index_LastProp</span>
<a href="#l67.129"></a><span id="l67.129" class="difflineplus">+enum {</span>
<a href="#l67.130"></a><span id="l67.130" class="difflineplus">+  index_DisplayName = 0,</span>
<a href="#l67.131"></a><span id="l67.131" class="difflineplus">+  index_EmailAddress,</span>
<a href="#l67.132"></a><span id="l67.132" class="difflineplus">+  index_FirstName,</span>
<a href="#l67.133"></a><span id="l67.133" class="difflineplus">+  index_LastName,</span>
<a href="#l67.134"></a><span id="l67.134" class="difflineplus">+  index_NickName,</span>
<a href="#l67.135"></a><span id="l67.135" class="difflineplus">+  index_WorkPhoneNumber,</span>
<a href="#l67.136"></a><span id="l67.136" class="difflineplus">+  index_HomePhoneNumber,</span>
<a href="#l67.137"></a><span id="l67.137" class="difflineplus">+  index_WorkFaxNumber,</span>
<a href="#l67.138"></a><span id="l67.138" class="difflineplus">+  index_PagerNumber,</span>
<a href="#l67.139"></a><span id="l67.139" class="difflineplus">+  index_MobileNumber,</span>
<a href="#l67.140"></a><span id="l67.140" class="difflineplus">+  index_HomeCity,</span>
<a href="#l67.141"></a><span id="l67.141" class="difflineplus">+  index_HomeState,</span>
<a href="#l67.142"></a><span id="l67.142" class="difflineplus">+  index_HomeZip,</span>
<a href="#l67.143"></a><span id="l67.143" class="difflineplus">+  index_HomeCountry,</span>
<a href="#l67.144"></a><span id="l67.144" class="difflineplus">+  index_WorkCity,</span>
<a href="#l67.145"></a><span id="l67.145" class="difflineplus">+  index_WorkState,</span>
<a href="#l67.146"></a><span id="l67.146" class="difflineplus">+  index_WorkZip,</span>
<a href="#l67.147"></a><span id="l67.147" class="difflineplus">+  index_WorkCountry,</span>
<a href="#l67.148"></a><span id="l67.148" class="difflineplus">+  index_JobTitle,</span>
<a href="#l67.149"></a><span id="l67.149" class="difflineplus">+  index_Department,</span>
<a href="#l67.150"></a><span id="l67.150" class="difflineplus">+  index_Company,</span>
<a href="#l67.151"></a><span id="l67.151" class="difflineplus">+  index_WorkWebPage,</span>
<a href="#l67.152"></a><span id="l67.152" class="difflineplus">+  index_HomeWebPage,</span>
<a href="#l67.153"></a><span id="l67.153" class="difflineplus">+  index_Comments,</span>
<a href="#l67.154"></a><span id="l67.154" class="difflineplus">+  index_LastProp</span>
<a href="#l67.155"></a><span id="l67.155"> };</span>
<a href="#l67.156"></a><span id="l67.156"> </span>
<a href="#l67.157"></a><span id="l67.157" class="difflineminus">-static const ULONG OutlookCardMAPIProps[] =</span>
<a href="#l67.158"></a><span id="l67.158" class="difflineminus">-{</span>
<a href="#l67.159"></a><span id="l67.159" class="difflineplus">+static const ULONG OutlookCardMAPIProps[] = {</span>
<a href="#l67.160"></a><span id="l67.160">     PR_DISPLAY_NAME_W,</span>
<a href="#l67.161"></a><span id="l67.161">     PR_EMAIL_ADDRESS_W,</span>
<a href="#l67.162"></a><span id="l67.162">     PR_GIVEN_NAME_W,</span>
<a href="#l67.163"></a><span id="l67.163">     PR_SURNAME_W,</span>
<a href="#l67.164"></a><span id="l67.164">     PR_NICKNAME_W,</span>
<a href="#l67.165"></a><span id="l67.165">     PR_BUSINESS_TELEPHONE_NUMBER_W,</span>
<a href="#l67.166"></a><span id="l67.166">     PR_HOME_TELEPHONE_NUMBER_W,</span>
<a href="#l67.167"></a><span id="l67.167">     PR_BUSINESS_FAX_NUMBER_W,</span>
<a href="#l67.168"></a><span id="l67.168" class="difflineat">@@ -140,14 +138,13 @@ static const ULONG OutlookCardMAPIProps[</span>
<a href="#l67.169"></a><span id="l67.169">     PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_W,</span>
<a href="#l67.170"></a><span id="l67.170">     PR_BUSINESS_ADDRESS_POSTAL_CODE_W,</span>
<a href="#l67.171"></a><span id="l67.171">     PR_BUSINESS_ADDRESS_COUNTRY_W,</span>
<a href="#l67.172"></a><span id="l67.172">     PR_TITLE_W,</span>
<a href="#l67.173"></a><span id="l67.173">     PR_DEPARTMENT_NAME_W,</span>
<a href="#l67.174"></a><span id="l67.174">     PR_COMPANY_NAME_W,</span>
<a href="#l67.175"></a><span id="l67.175">     PR_BUSINESS_HOME_PAGE_W,</span>
<a href="#l67.176"></a><span id="l67.176">     PR_PERSONAL_HOME_PAGE_W,</span>
<a href="#l67.177"></a><span id="l67.177" class="difflineminus">-    PR_COMMENT_W</span>
<a href="#l67.178"></a><span id="l67.178" class="difflineminus">-};</span>
<a href="#l67.179"></a><span id="l67.179" class="difflineplus">+    PR_COMMENT_W};</span>
<a href="#l67.180"></a><span id="l67.180"> </span>
<a href="#l67.181"></a><span id="l67.181"> nsresult OutlookCardForURI(const nsACString &amp;aUri, nsIAbCard **card);</span>
<a href="#l67.182"></a><span id="l67.182"> </span>
<a href="#l67.183"></a><span id="l67.183" class="difflineminus">-#endif // nsAbOutlookDirectory_h___</span>
<a href="#l67.184"></a><span id="l67.184" class="difflineplus">+#endif  // nsAbOutlookDirectory_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -21,317 +21,274 @@</span>
<a href="#l68.4"></a><span id="l68.4">  * (BOOL1(FIELD1,OP1,VALUE1)..(FIELDn,OPn,VALUEn)(BOOL2(FIELD1,OP1,VALUE1)...)...)</span>
<a href="#l68.5"></a><span id="l68.5">  *</span>
<a href="#l68.6"></a><span id="l68.6">  * BOOLn   A boolean operator joining subsequent terms delimited by ().</span>
<a href="#l68.7"></a><span id="l68.7">  *         For possible values see CreateBooleanExpression().</span>
<a href="#l68.8"></a><span id="l68.8">  * FIELDn  An addressbook card data field.</span>
<a href="#l68.9"></a><span id="l68.9">  * OPn     An operator for the search term.</span>
<a href="#l68.10"></a><span id="l68.10">  *         For possible values see CreateBooleanConditionString().</span>
<a href="#l68.11"></a><span id="l68.11">  * VALUEn  The value to be matched in the FIELDn via the OPn operator.</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">- *         The value must be URL encoded by the caller, if it contains any special</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineminus">- *         characters including '(' and ')'.</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineplus">+ *         The value must be URL encoded by the caller, if it contains any</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+ * special characters including '(' and ')'.</span>
<a href="#l68.16"></a><span id="l68.16">  */</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineminus">-nsresult nsAbQueryStringToExpression::Convert (</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineminus">-    const nsACString &amp;aQueryString,</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineminus">-    nsIAbBooleanExpression** expression)</span>
<a href="#l68.20"></a><span id="l68.20" class="difflineminus">-{</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineminus">-    nsresult rv;</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineplus">+nsresult nsAbQueryStringToExpression::Convert(</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineplus">+    const nsACString&amp; aQueryString, nsIAbBooleanExpression** expression) {</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineplus">+  nsresult rv;</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineplus">+</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineplus">+  nsAutoCString q(aQueryString);</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineplus">+  q.StripWhitespace();</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineplus">+  const char* queryChars = q.get();</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineplus">+</span>
<a href="#l68.30"></a><span id="l68.30" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; s;</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineplus">+  rv = ParseExpression(&amp;queryChars, getter_AddRefs(s));</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineplus">+</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+  // Case: Not end of string</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+  if (*queryChars != 0) return NS_ERROR_FAILURE;</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; e(do_QueryInterface(s, &amp;rv));</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineplus">+</span>
<a href="#l68.40"></a><span id="l68.40" class="difflineplus">+  e.forget(expression);</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineplus">+  return rv;</span>
<a href="#l68.42"></a><span id="l68.42" class="difflineplus">+}</span>
<a href="#l68.43"></a><span id="l68.43"> </span>
<a href="#l68.44"></a><span id="l68.44" class="difflineminus">-    nsAutoCString q(aQueryString);</span>
<a href="#l68.45"></a><span id="l68.45" class="difflineminus">-    q.StripWhitespace();</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineminus">-    const char *queryChars = q.get();</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineplus">+nsresult nsAbQueryStringToExpression::ParseExpression(</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineplus">+    const char** index, nsISupports** expression) {</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+  nsresult rv;</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineplus">+</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineplus">+  if (**index != '(') return NS_ERROR_FAILURE;</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineplus">+</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+  const char* indexBracket = *index + 1;</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+  while (*indexBracket &amp;&amp; *indexBracket != '(' &amp;&amp; *indexBracket != ')')</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineplus">+    indexBracket++;</span>
<a href="#l68.56"></a><span id="l68.56"> </span>
<a href="#l68.57"></a><span id="l68.57" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; s;</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineminus">-    rv = ParseExpression(&amp;queryChars, getter_AddRefs(s));</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineplus">+  // Case: End of string</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineplus">+  if (*indexBracket == 0) return NS_ERROR_FAILURE;</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineplus">+</span>
<a href="#l68.62"></a><span id="l68.62" class="difflineplus">+  // Case: &quot;((&quot; or &quot;()&quot;</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineplus">+  if (indexBracket == *index + 1) {</span>
<a href="#l68.64"></a><span id="l68.64" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l68.65"></a><span id="l68.65" class="difflineplus">+  }</span>
<a href="#l68.66"></a><span id="l68.66" class="difflineplus">+  // Case: &quot;(*(&quot;</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineplus">+  else if (*indexBracket == '(') {</span>
<a href="#l68.68"></a><span id="l68.68" class="difflineplus">+    // printf (&quot;Case: (*(: %s\n&quot;, *index);</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineplus">+</span>
<a href="#l68.70"></a><span id="l68.70" class="difflineplus">+    nsCString operation;</span>
<a href="#l68.71"></a><span id="l68.71" class="difflineplus">+    rv = ParseOperationEntry(*index, indexBracket, getter_Copies(operation));</span>
<a href="#l68.72"></a><span id="l68.72">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.73"></a><span id="l68.73"> </span>
<a href="#l68.74"></a><span id="l68.74" class="difflineminus">-    // Case: Not end of string</span>
<a href="#l68.75"></a><span id="l68.75" class="difflineminus">-    if (*queryChars != 0)</span>
<a href="#l68.76"></a><span id="l68.76" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.77"></a><span id="l68.77" class="difflineplus">+    nsCOMPtr&lt;nsIAbBooleanExpression&gt; e;</span>
<a href="#l68.78"></a><span id="l68.78" class="difflineplus">+    rv = CreateBooleanExpression(operation.get(), getter_AddRefs(e));</span>
<a href="#l68.79"></a><span id="l68.79" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.80"></a><span id="l68.80"> </span>
<a href="#l68.81"></a><span id="l68.81" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; e(do_QueryInterface(s, &amp;rv));</span>
<a href="#l68.82"></a><span id="l68.82" class="difflineplus">+    // Case: &quot;(*)(*)....(*))&quot;</span>
<a href="#l68.83"></a><span id="l68.83" class="difflineplus">+    *index = indexBracket;</span>
<a href="#l68.84"></a><span id="l68.84" class="difflineplus">+    rv = ParseExpressions(index, e);</span>
<a href="#l68.85"></a><span id="l68.85">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.86"></a><span id="l68.86"> </span>
<a href="#l68.87"></a><span id="l68.87">     e.forget(expression);</span>
<a href="#l68.88"></a><span id="l68.88" class="difflineminus">-    return rv;</span>
<a href="#l68.89"></a><span id="l68.89" class="difflineplus">+  }</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineplus">+  // Case&quot; &quot;(*)&quot;</span>
<a href="#l68.91"></a><span id="l68.91" class="difflineplus">+  else if (*indexBracket == ')') {</span>
<a href="#l68.92"></a><span id="l68.92" class="difflineplus">+    // printf (&quot;Case: (*): %s\n&quot;, *index);</span>
<a href="#l68.93"></a><span id="l68.93" class="difflineplus">+</span>
<a href="#l68.94"></a><span id="l68.94" class="difflineplus">+    nsCOMPtr&lt;nsIAbBooleanConditionString&gt; conditionString;</span>
<a href="#l68.95"></a><span id="l68.95" class="difflineplus">+    rv = ParseCondition(index, indexBracket, getter_AddRefs(conditionString));</span>
<a href="#l68.96"></a><span id="l68.96" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.97"></a><span id="l68.97" class="difflineplus">+</span>
<a href="#l68.98"></a><span id="l68.98" class="difflineplus">+    conditionString.forget(expression);</span>
<a href="#l68.99"></a><span id="l68.99" class="difflineplus">+  }</span>
<a href="#l68.100"></a><span id="l68.100" class="difflineplus">+</span>
<a href="#l68.101"></a><span id="l68.101" class="difflineplus">+  if (**index != ')') return NS_ERROR_FAILURE;</span>
<a href="#l68.102"></a><span id="l68.102" class="difflineplus">+</span>
<a href="#l68.103"></a><span id="l68.103" class="difflineplus">+  (*index)++;</span>
<a href="#l68.104"></a><span id="l68.104" class="difflineplus">+</span>
<a href="#l68.105"></a><span id="l68.105" class="difflineplus">+  return NS_OK;</span>
<a href="#l68.106"></a><span id="l68.106"> }</span>
<a href="#l68.107"></a><span id="l68.107"> </span>
<a href="#l68.108"></a><span id="l68.108" class="difflineminus">-nsresult nsAbQueryStringToExpression::ParseExpression (</span>
<a href="#l68.109"></a><span id="l68.109" class="difflineminus">-    const char** index,</span>
<a href="#l68.110"></a><span id="l68.110" class="difflineminus">-    nsISupports** expression)</span>
<a href="#l68.111"></a><span id="l68.111" class="difflineminus">-{</span>
<a href="#l68.112"></a><span id="l68.112" class="difflineminus">-    nsresult rv;</span>
<a href="#l68.113"></a><span id="l68.113" class="difflineminus">-</span>
<a href="#l68.114"></a><span id="l68.114" class="difflineminus">-    if (**index != '(')</span>
<a href="#l68.115"></a><span id="l68.115" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.116"></a><span id="l68.116" class="difflineminus">-</span>
<a href="#l68.117"></a><span id="l68.117" class="difflineminus">-    const char* indexBracket = *index + 1;</span>
<a href="#l68.118"></a><span id="l68.118" class="difflineminus">-    while (*indexBracket &amp;&amp;</span>
<a href="#l68.119"></a><span id="l68.119" class="difflineminus">-        *indexBracket != '(' &amp;&amp; *indexBracket != ')')</span>
<a href="#l68.120"></a><span id="l68.120" class="difflineminus">-        indexBracket++;</span>
<a href="#l68.121"></a><span id="l68.121" class="difflineplus">+nsresult nsAbQueryStringToExpression::ParseExpressions(</span>
<a href="#l68.122"></a><span id="l68.122" class="difflineplus">+    const char** index, nsIAbBooleanExpression* expression) {</span>
<a href="#l68.123"></a><span id="l68.123" class="difflineplus">+  nsresult rv;</span>
<a href="#l68.124"></a><span id="l68.124" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; expressions(</span>
<a href="#l68.125"></a><span id="l68.125" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l68.126"></a><span id="l68.126" class="difflineplus">+  if (NS_FAILED(rv)) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l68.127"></a><span id="l68.127"> </span>
<a href="#l68.128"></a><span id="l68.128" class="difflineminus">-    // Case: End of string</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineminus">-    if (*indexBracket == 0)</span>
<a href="#l68.130"></a><span id="l68.130" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.131"></a><span id="l68.131" class="difflineminus">-</span>
<a href="#l68.132"></a><span id="l68.132" class="difflineminus">-    // Case: &quot;((&quot; or &quot;()&quot;</span>
<a href="#l68.133"></a><span id="l68.133" class="difflineminus">-    if (indexBracket == *index + 1)</span>
<a href="#l68.134"></a><span id="l68.134" class="difflineminus">-    {</span>
<a href="#l68.135"></a><span id="l68.135" class="difflineminus">-         return NS_ERROR_FAILURE;</span>
<a href="#l68.136"></a><span id="l68.136" class="difflineminus">-    }</span>
<a href="#l68.137"></a><span id="l68.137" class="difflineminus">-    // Case: &quot;(*(&quot;</span>
<a href="#l68.138"></a><span id="l68.138" class="difflineminus">-    else if (*indexBracket == '(')</span>
<a href="#l68.139"></a><span id="l68.139" class="difflineminus">-    {</span>
<a href="#l68.140"></a><span id="l68.140" class="difflineminus">-        // printf (&quot;Case: (*(: %s\n&quot;, *index);</span>
<a href="#l68.141"></a><span id="l68.141" class="difflineplus">+  // Case: &quot;)(*)(*)....(*))&quot;</span>
<a href="#l68.142"></a><span id="l68.142" class="difflineplus">+  // printf (&quot;Case: )(*)(*)....(*)): %s\n&quot;, *index);</span>
<a href="#l68.143"></a><span id="l68.143" class="difflineplus">+  while (**index == '(') {</span>
<a href="#l68.144"></a><span id="l68.144" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; childExpression;</span>
<a href="#l68.145"></a><span id="l68.145" class="difflineplus">+    rv = ParseExpression(index, getter_AddRefs(childExpression));</span>
<a href="#l68.146"></a><span id="l68.146" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.147"></a><span id="l68.147"> </span>
<a href="#l68.148"></a><span id="l68.148" class="difflineminus">-        nsCString operation;</span>
<a href="#l68.149"></a><span id="l68.149" class="difflineminus">-        rv = ParseOperationEntry (</span>
<a href="#l68.150"></a><span id="l68.150" class="difflineminus">-            *index, indexBracket,</span>
<a href="#l68.151"></a><span id="l68.151" class="difflineminus">-            getter_Copies (operation));</span>
<a href="#l68.152"></a><span id="l68.152" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.153"></a><span id="l68.153" class="difflineplus">+    expressions-&gt;AppendElement(childExpression);</span>
<a href="#l68.154"></a><span id="l68.154" class="difflineplus">+  }</span>
<a href="#l68.155"></a><span id="l68.155"> </span>
<a href="#l68.156"></a><span id="l68.156" class="difflineminus">-        nsCOMPtr&lt;nsIAbBooleanExpression&gt; e;</span>
<a href="#l68.157"></a><span id="l68.157" class="difflineminus">-        rv = CreateBooleanExpression(operation.get(),</span>
<a href="#l68.158"></a><span id="l68.158" class="difflineminus">-            getter_AddRefs(e));</span>
<a href="#l68.159"></a><span id="l68.159" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.160"></a><span id="l68.160" class="difflineminus">-</span>
<a href="#l68.161"></a><span id="l68.161" class="difflineminus">-        // Case: &quot;(*)(*)....(*))&quot;</span>
<a href="#l68.162"></a><span id="l68.162" class="difflineminus">-        *index = indexBracket;</span>
<a href="#l68.163"></a><span id="l68.163" class="difflineminus">-        rv = ParseExpressions (index, e);</span>
<a href="#l68.164"></a><span id="l68.164" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.165"></a><span id="l68.165" class="difflineplus">+  if (**index == 0) return NS_ERROR_FAILURE;</span>
<a href="#l68.166"></a><span id="l68.166"> </span>
<a href="#l68.167"></a><span id="l68.167" class="difflineminus">-        e.forget(expression);</span>
<a href="#l68.168"></a><span id="l68.168" class="difflineminus">-    }</span>
<a href="#l68.169"></a><span id="l68.169" class="difflineminus">-    // Case&quot; &quot;(*)&quot;</span>
<a href="#l68.170"></a><span id="l68.170" class="difflineminus">-    else if (*indexBracket == ')')</span>
<a href="#l68.171"></a><span id="l68.171" class="difflineminus">-    {</span>
<a href="#l68.172"></a><span id="l68.172" class="difflineminus">-        // printf (&quot;Case: (*): %s\n&quot;, *index);</span>
<a href="#l68.173"></a><span id="l68.173" class="difflineplus">+  // Case: &quot;))&quot;</span>
<a href="#l68.174"></a><span id="l68.174" class="difflineplus">+  // printf (&quot;Case: )): %s\n&quot;, *index);</span>
<a href="#l68.175"></a><span id="l68.175"> </span>
<a href="#l68.176"></a><span id="l68.176" class="difflineminus">-        nsCOMPtr&lt;nsIAbBooleanConditionString&gt; conditionString;</span>
<a href="#l68.177"></a><span id="l68.177" class="difflineminus">-        rv = ParseCondition (index, indexBracket,</span>
<a href="#l68.178"></a><span id="l68.178" class="difflineminus">-            getter_AddRefs(conditionString));</span>
<a href="#l68.179"></a><span id="l68.179" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.180"></a><span id="l68.180" class="difflineplus">+  if (**index != ')') return NS_ERROR_FAILURE;</span>
<a href="#l68.181"></a><span id="l68.181"> </span>
<a href="#l68.182"></a><span id="l68.182" class="difflineminus">-        conditionString.forget(expression);</span>
<a href="#l68.183"></a><span id="l68.183" class="difflineminus">-    }</span>
<a href="#l68.184"></a><span id="l68.184" class="difflineplus">+  expression-&gt;SetExpressions(expressions);</span>
<a href="#l68.185"></a><span id="l68.185"> </span>
<a href="#l68.186"></a><span id="l68.186" class="difflineminus">-    if (**index != ')')</span>
<a href="#l68.187"></a><span id="l68.187" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.188"></a><span id="l68.188" class="difflineminus">-</span>
<a href="#l68.189"></a><span id="l68.189" class="difflineminus">-    (*index)++;</span>
<a href="#l68.190"></a><span id="l68.190" class="difflineminus">-</span>
<a href="#l68.191"></a><span id="l68.191" class="difflineminus">-    return NS_OK;</span>
<a href="#l68.192"></a><span id="l68.192" class="difflineplus">+  return NS_OK;</span>
<a href="#l68.193"></a><span id="l68.193"> }</span>
<a href="#l68.194"></a><span id="l68.194"> </span>
<a href="#l68.195"></a><span id="l68.195" class="difflineplus">+nsresult nsAbQueryStringToExpression::ParseCondition(</span>
<a href="#l68.196"></a><span id="l68.196" class="difflineplus">+    const char** index, const char* indexBracketClose,</span>
<a href="#l68.197"></a><span id="l68.197" class="difflineplus">+    nsIAbBooleanConditionString** conditionString) {</span>
<a href="#l68.198"></a><span id="l68.198" class="difflineplus">+  nsresult rv;</span>
<a href="#l68.199"></a><span id="l68.199"> </span>
<a href="#l68.200"></a><span id="l68.200" class="difflineminus">-nsresult nsAbQueryStringToExpression::ParseExpressions (</span>
<a href="#l68.201"></a><span id="l68.201" class="difflineminus">-    const char** index,</span>
<a href="#l68.202"></a><span id="l68.202" class="difflineminus">-    nsIAbBooleanExpression* expression)</span>
<a href="#l68.203"></a><span id="l68.203" class="difflineminus">-{</span>
<a href="#l68.204"></a><span id="l68.204" class="difflineminus">-    nsresult rv;</span>
<a href="#l68.205"></a><span id="l68.205" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; expressions(do_CreateInstance(NS_ARRAY_CONTRACTID,</span>
<a href="#l68.206"></a><span id="l68.206" class="difflineminus">-                                                            &amp;rv));</span>
<a href="#l68.207"></a><span id="l68.207" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l68.208"></a><span id="l68.208" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l68.209"></a><span id="l68.209" class="difflineplus">+  (*index)++;</span>
<a href="#l68.210"></a><span id="l68.210" class="difflineplus">+</span>
<a href="#l68.211"></a><span id="l68.211" class="difflineplus">+  nsCString entries[3];</span>
<a href="#l68.212"></a><span id="l68.212" class="difflineplus">+  for (int i = 0; i &lt; 3; i++) {</span>
<a href="#l68.213"></a><span id="l68.213" class="difflineplus">+    rv = ParseConditionEntry(index, indexBracketClose,</span>
<a href="#l68.214"></a><span id="l68.214" class="difflineplus">+                             getter_Copies(entries[i]));</span>
<a href="#l68.215"></a><span id="l68.215" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.216"></a><span id="l68.216"> </span>
<a href="#l68.217"></a><span id="l68.217" class="difflineminus">-    // Case: &quot;)(*)(*)....(*))&quot;</span>
<a href="#l68.218"></a><span id="l68.218" class="difflineminus">-    // printf (&quot;Case: )(*)(*)....(*)): %s\n&quot;, *index);</span>
<a href="#l68.219"></a><span id="l68.219" class="difflineminus">-    while (**index == '(')</span>
<a href="#l68.220"></a><span id="l68.220" class="difflineminus">-    {</span>
<a href="#l68.221"></a><span id="l68.221" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; childExpression;</span>
<a href="#l68.222"></a><span id="l68.222" class="difflineminus">-        rv = ParseExpression(index, getter_AddRefs (childExpression));</span>
<a href="#l68.223"></a><span id="l68.223" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.224"></a><span id="l68.224" class="difflineplus">+    if (*index == indexBracketClose) break;</span>
<a href="#l68.225"></a><span id="l68.225" class="difflineplus">+  }</span>
<a href="#l68.226"></a><span id="l68.226"> </span>
<a href="#l68.227"></a><span id="l68.227" class="difflineminus">-        expressions-&gt;AppendElement(childExpression);</span>
<a href="#l68.228"></a><span id="l68.228" class="difflineminus">-    }</span>
<a href="#l68.229"></a><span id="l68.229" class="difflineplus">+  if (*index != indexBracketClose) return NS_ERROR_FAILURE;</span>
<a href="#l68.230"></a><span id="l68.230"> </span>
<a href="#l68.231"></a><span id="l68.231" class="difflineminus">-    if (**index == 0)</span>
<a href="#l68.232"></a><span id="l68.232" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.233"></a><span id="l68.233" class="difflineminus">-</span>
<a href="#l68.234"></a><span id="l68.234" class="difflineminus">-    // Case: &quot;))&quot;</span>
<a href="#l68.235"></a><span id="l68.235" class="difflineminus">-    // printf (&quot;Case: )): %s\n&quot;, *index);</span>
<a href="#l68.236"></a><span id="l68.236" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanConditionString&gt; c;</span>
<a href="#l68.237"></a><span id="l68.237" class="difflineplus">+  rv = CreateBooleanConditionString(entries[0].get(), entries[1].get(),</span>
<a href="#l68.238"></a><span id="l68.238" class="difflineplus">+                                    entries[2].get(), getter_AddRefs(c));</span>
<a href="#l68.239"></a><span id="l68.239" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.240"></a><span id="l68.240"> </span>
<a href="#l68.241"></a><span id="l68.241" class="difflineminus">-    if (**index != ')')</span>
<a href="#l68.242"></a><span id="l68.242" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.243"></a><span id="l68.243" class="difflineminus">-</span>
<a href="#l68.244"></a><span id="l68.244" class="difflineminus">-    expression-&gt;SetExpressions (expressions);</span>
<a href="#l68.245"></a><span id="l68.245" class="difflineminus">-</span>
<a href="#l68.246"></a><span id="l68.246" class="difflineminus">-    return NS_OK;</span>
<a href="#l68.247"></a><span id="l68.247" class="difflineplus">+  c.forget(conditionString);</span>
<a href="#l68.248"></a><span id="l68.248" class="difflineplus">+  return NS_OK;</span>
<a href="#l68.249"></a><span id="l68.249"> }</span>
<a href="#l68.250"></a><span id="l68.250"> </span>
<a href="#l68.251"></a><span id="l68.251" class="difflineminus">-nsresult nsAbQueryStringToExpression::ParseCondition (</span>
<a href="#l68.252"></a><span id="l68.252" class="difflineminus">-    const char** index,</span>
<a href="#l68.253"></a><span id="l68.253" class="difflineminus">-    const char* indexBracketClose,</span>
<a href="#l68.254"></a><span id="l68.254" class="difflineminus">-    nsIAbBooleanConditionString** conditionString)</span>
<a href="#l68.255"></a><span id="l68.255" class="difflineminus">-{</span>
<a href="#l68.256"></a><span id="l68.256" class="difflineminus">-    nsresult rv;</span>
<a href="#l68.257"></a><span id="l68.257" class="difflineminus">-</span>
<a href="#l68.258"></a><span id="l68.258" class="difflineminus">-    (*index)++;</span>
<a href="#l68.259"></a><span id="l68.259" class="difflineminus">-</span>
<a href="#l68.260"></a><span id="l68.260" class="difflineminus">-    nsCString entries[3];</span>
<a href="#l68.261"></a><span id="l68.261" class="difflineminus">-    for (int i = 0; i &lt; 3; i++)</span>
<a href="#l68.262"></a><span id="l68.262" class="difflineminus">-    {</span>
<a href="#l68.263"></a><span id="l68.263" class="difflineminus">-        rv = ParseConditionEntry (index, indexBracketClose,</span>
<a href="#l68.264"></a><span id="l68.264" class="difflineminus">-                getter_Copies (entries[i]));</span>
<a href="#l68.265"></a><span id="l68.265" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.266"></a><span id="l68.266" class="difflineplus">+nsresult nsAbQueryStringToExpression::ParseConditionEntry(</span>
<a href="#l68.267"></a><span id="l68.267" class="difflineplus">+    const char** index, const char* indexBracketClose, char** entry) {</span>
<a href="#l68.268"></a><span id="l68.268" class="difflineplus">+  const char* indexDeliminator = *index;</span>
<a href="#l68.269"></a><span id="l68.269" class="difflineplus">+  while (indexDeliminator != indexBracketClose &amp;&amp; *indexDeliminator != ',')</span>
<a href="#l68.270"></a><span id="l68.270" class="difflineplus">+    indexDeliminator++;</span>
<a href="#l68.271"></a><span id="l68.271"> </span>
<a href="#l68.272"></a><span id="l68.272" class="difflineminus">-        if (*index == indexBracketClose)</span>
<a href="#l68.273"></a><span id="l68.273" class="difflineminus">-            break;</span>
<a href="#l68.274"></a><span id="l68.274" class="difflineminus">-    }</span>
<a href="#l68.275"></a><span id="l68.275" class="difflineminus">-</span>
<a href="#l68.276"></a><span id="l68.276" class="difflineminus">-    if (*index != indexBracketClose)</span>
<a href="#l68.277"></a><span id="l68.277" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.278"></a><span id="l68.278" class="difflineplus">+  int entryLength = indexDeliminator - *index;</span>
<a href="#l68.279"></a><span id="l68.279" class="difflineplus">+  if (entryLength)</span>
<a href="#l68.280"></a><span id="l68.280" class="difflineplus">+    *entry = PL_strndup(*index, entryLength);</span>
<a href="#l68.281"></a><span id="l68.281" class="difflineplus">+  else</span>
<a href="#l68.282"></a><span id="l68.282" class="difflineplus">+    *entry = 0;</span>
<a href="#l68.283"></a><span id="l68.283"> </span>
<a href="#l68.284"></a><span id="l68.284" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanConditionString&gt; c;</span>
<a href="#l68.285"></a><span id="l68.285" class="difflineminus">-    rv = CreateBooleanConditionString (</span>
<a href="#l68.286"></a><span id="l68.286" class="difflineminus">-        entries[0].get(),</span>
<a href="#l68.287"></a><span id="l68.287" class="difflineminus">-        entries[1].get(),</span>
<a href="#l68.288"></a><span id="l68.288" class="difflineminus">-        entries[2].get(),</span>
<a href="#l68.289"></a><span id="l68.289" class="difflineminus">-        getter_AddRefs (c));</span>
<a href="#l68.290"></a><span id="l68.290" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.291"></a><span id="l68.291" class="difflineplus">+  if (indexDeliminator != indexBracketClose)</span>
<a href="#l68.292"></a><span id="l68.292" class="difflineplus">+    *index = indexDeliminator + 1;</span>
<a href="#l68.293"></a><span id="l68.293" class="difflineplus">+  else</span>
<a href="#l68.294"></a><span id="l68.294" class="difflineplus">+    *index = indexDeliminator;</span>
<a href="#l68.295"></a><span id="l68.295"> </span>
<a href="#l68.296"></a><span id="l68.296" class="difflineminus">-    c.forget(conditionString);</span>
<a href="#l68.297"></a><span id="l68.297" class="difflineminus">-    return NS_OK;</span>
<a href="#l68.298"></a><span id="l68.298" class="difflineplus">+  return NS_OK;</span>
<a href="#l68.299"></a><span id="l68.299"> }</span>
<a href="#l68.300"></a><span id="l68.300"> </span>
<a href="#l68.301"></a><span id="l68.301" class="difflineminus">-nsresult nsAbQueryStringToExpression::ParseConditionEntry (</span>
<a href="#l68.302"></a><span id="l68.302" class="difflineminus">-    const char** index,</span>
<a href="#l68.303"></a><span id="l68.303" class="difflineminus">-    const char* indexBracketClose,</span>
<a href="#l68.304"></a><span id="l68.304" class="difflineminus">-    char** entry)</span>
<a href="#l68.305"></a><span id="l68.305" class="difflineminus">-{</span>
<a href="#l68.306"></a><span id="l68.306" class="difflineminus">-    const char* indexDeliminator = *index;</span>
<a href="#l68.307"></a><span id="l68.307" class="difflineminus">-    while (indexDeliminator != indexBracketClose &amp;&amp;</span>
<a href="#l68.308"></a><span id="l68.308" class="difflineminus">-        *indexDeliminator != ',')</span>
<a href="#l68.309"></a><span id="l68.309" class="difflineminus">-        indexDeliminator++;</span>
<a href="#l68.310"></a><span id="l68.310" class="difflineminus">-</span>
<a href="#l68.311"></a><span id="l68.311" class="difflineminus">-    int entryLength = indexDeliminator - *index;</span>
<a href="#l68.312"></a><span id="l68.312" class="difflineminus">-    if (entryLength)</span>
<a href="#l68.313"></a><span id="l68.313" class="difflineminus">-      *entry = PL_strndup (*index, entryLength);</span>
<a href="#l68.314"></a><span id="l68.314" class="difflineminus">-    else</span>
<a href="#l68.315"></a><span id="l68.315" class="difflineminus">-        *entry = 0;</span>
<a href="#l68.316"></a><span id="l68.316" class="difflineplus">+nsresult nsAbQueryStringToExpression::ParseOperationEntry(</span>
<a href="#l68.317"></a><span id="l68.317" class="difflineplus">+    const char* indexBracketOpen1, const char* indexBracketOpen2,</span>
<a href="#l68.318"></a><span id="l68.318" class="difflineplus">+    char** operation) {</span>
<a href="#l68.319"></a><span id="l68.319" class="difflineplus">+  int operationLength = indexBracketOpen2 - indexBracketOpen1 - 1;</span>
<a href="#l68.320"></a><span id="l68.320" class="difflineplus">+  if (operationLength)</span>
<a href="#l68.321"></a><span id="l68.321" class="difflineplus">+    *operation = PL_strndup(indexBracketOpen1 + 1, operationLength);</span>
<a href="#l68.322"></a><span id="l68.322" class="difflineplus">+  else</span>
<a href="#l68.323"></a><span id="l68.323" class="difflineplus">+    *operation = 0;</span>
<a href="#l68.324"></a><span id="l68.324"> </span>
<a href="#l68.325"></a><span id="l68.325" class="difflineminus">-    if (indexDeliminator != indexBracketClose)</span>
<a href="#l68.326"></a><span id="l68.326" class="difflineminus">-        *index = indexDeliminator + 1;</span>
<a href="#l68.327"></a><span id="l68.327" class="difflineminus">-    else</span>
<a href="#l68.328"></a><span id="l68.328" class="difflineminus">-        *index = indexDeliminator;</span>
<a href="#l68.329"></a><span id="l68.329" class="difflineminus">-</span>
<a href="#l68.330"></a><span id="l68.330" class="difflineminus">-    return NS_OK;</span>
<a href="#l68.331"></a><span id="l68.331" class="difflineminus">-}</span>
<a href="#l68.332"></a><span id="l68.332" class="difflineminus">-</span>
<a href="#l68.333"></a><span id="l68.333" class="difflineminus">-nsresult nsAbQueryStringToExpression::ParseOperationEntry (</span>
<a href="#l68.334"></a><span id="l68.334" class="difflineminus">-    const char* indexBracketOpen1,</span>
<a href="#l68.335"></a><span id="l68.335" class="difflineminus">-    const char* indexBracketOpen2,</span>
<a href="#l68.336"></a><span id="l68.336" class="difflineminus">-    char** operation)</span>
<a href="#l68.337"></a><span id="l68.337" class="difflineminus">-{</span>
<a href="#l68.338"></a><span id="l68.338" class="difflineminus">-    int operationLength = indexBracketOpen2 - indexBracketOpen1 - 1;</span>
<a href="#l68.339"></a><span id="l68.339" class="difflineminus">-    if (operationLength)</span>
<a href="#l68.340"></a><span id="l68.340" class="difflineminus">-        *operation = PL_strndup (indexBracketOpen1 + 1,</span>
<a href="#l68.341"></a><span id="l68.341" class="difflineminus">-            operationLength);</span>
<a href="#l68.342"></a><span id="l68.342" class="difflineminus">-    else</span>
<a href="#l68.343"></a><span id="l68.343" class="difflineminus">-        *operation = 0;</span>
<a href="#l68.344"></a><span id="l68.344" class="difflineminus">-</span>
<a href="#l68.345"></a><span id="l68.345" class="difflineminus">-    return NS_OK;</span>
<a href="#l68.346"></a><span id="l68.346" class="difflineplus">+  return NS_OK;</span>
<a href="#l68.347"></a><span id="l68.347"> }</span>
<a href="#l68.348"></a><span id="l68.348"> </span>
<a href="#l68.349"></a><span id="l68.349"> nsresult nsAbQueryStringToExpression::CreateBooleanExpression(</span>
<a href="#l68.350"></a><span id="l68.350" class="difflineminus">-        const char* operation,</span>
<a href="#l68.351"></a><span id="l68.351" class="difflineminus">-        nsIAbBooleanExpression** expression)</span>
<a href="#l68.352"></a><span id="l68.352" class="difflineminus">-{</span>
<a href="#l68.353"></a><span id="l68.353" class="difflineminus">-    nsAbBooleanOperationType op;</span>
<a href="#l68.354"></a><span id="l68.354" class="difflineminus">-    if (PL_strcasecmp (operation, &quot;and&quot;) == 0)</span>
<a href="#l68.355"></a><span id="l68.355" class="difflineminus">-        op = nsIAbBooleanOperationTypes::AND;</span>
<a href="#l68.356"></a><span id="l68.356" class="difflineminus">-    else if (PL_strcasecmp (operation, &quot;or&quot;) == 0)</span>
<a href="#l68.357"></a><span id="l68.357" class="difflineminus">-        op = nsIAbBooleanOperationTypes::OR;</span>
<a href="#l68.358"></a><span id="l68.358" class="difflineminus">-    else if (PL_strcasecmp (operation, &quot;not&quot;) == 0)</span>
<a href="#l68.359"></a><span id="l68.359" class="difflineminus">-        op = nsIAbBooleanOperationTypes::NOT;</span>
<a href="#l68.360"></a><span id="l68.360" class="difflineminus">-    else</span>
<a href="#l68.361"></a><span id="l68.361" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.362"></a><span id="l68.362" class="difflineplus">+    const char* operation, nsIAbBooleanExpression** expression) {</span>
<a href="#l68.363"></a><span id="l68.363" class="difflineplus">+  nsAbBooleanOperationType op;</span>
<a href="#l68.364"></a><span id="l68.364" class="difflineplus">+  if (PL_strcasecmp(operation, &quot;and&quot;) == 0)</span>
<a href="#l68.365"></a><span id="l68.365" class="difflineplus">+    op = nsIAbBooleanOperationTypes::AND;</span>
<a href="#l68.366"></a><span id="l68.366" class="difflineplus">+  else if (PL_strcasecmp(operation, &quot;or&quot;) == 0)</span>
<a href="#l68.367"></a><span id="l68.367" class="difflineplus">+    op = nsIAbBooleanOperationTypes::OR;</span>
<a href="#l68.368"></a><span id="l68.368" class="difflineplus">+  else if (PL_strcasecmp(operation, &quot;not&quot;) == 0)</span>
<a href="#l68.369"></a><span id="l68.369" class="difflineplus">+    op = nsIAbBooleanOperationTypes::NOT;</span>
<a href="#l68.370"></a><span id="l68.370" class="difflineplus">+  else</span>
<a href="#l68.371"></a><span id="l68.371" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l68.372"></a><span id="l68.372"> </span>
<a href="#l68.373"></a><span id="l68.373" class="difflineminus">-    nsresult rv;</span>
<a href="#l68.374"></a><span id="l68.374" class="difflineplus">+  nsresult rv;</span>
<a href="#l68.375"></a><span id="l68.375"> </span>
<a href="#l68.376"></a><span id="l68.376" class="difflineminus">-    nsCOMPtr &lt;nsIAbBooleanExpression&gt; expr = do_CreateInstance(NS_BOOLEANEXPRESSION_CONTRACTID, &amp;rv);</span>
<a href="#l68.377"></a><span id="l68.377" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.378"></a><span id="l68.378" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; expr =</span>
<a href="#l68.379"></a><span id="l68.379" class="difflineplus">+      do_CreateInstance(NS_BOOLEANEXPRESSION_CONTRACTID, &amp;rv);</span>
<a href="#l68.380"></a><span id="l68.380" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.381"></a><span id="l68.381"> </span>
<a href="#l68.382"></a><span id="l68.382" class="difflineminus">-    rv = expr-&gt;SetOperation (op);</span>
<a href="#l68.383"></a><span id="l68.383" class="difflineminus">-    expr.forget(expression);</span>
<a href="#l68.384"></a><span id="l68.384" class="difflineminus">-    return rv;</span>
<a href="#l68.385"></a><span id="l68.385" class="difflineplus">+  rv = expr-&gt;SetOperation(op);</span>
<a href="#l68.386"></a><span id="l68.386" class="difflineplus">+  expr.forget(expression);</span>
<a href="#l68.387"></a><span id="l68.387" class="difflineplus">+  return rv;</span>
<a href="#l68.388"></a><span id="l68.388"> }</span>
<a href="#l68.389"></a><span id="l68.389"> </span>
<a href="#l68.390"></a><span id="l68.390" class="difflineminus">-nsresult nsAbQueryStringToExpression::CreateBooleanConditionString (</span>
<a href="#l68.391"></a><span id="l68.391" class="difflineminus">-    const char* attribute,</span>
<a href="#l68.392"></a><span id="l68.392" class="difflineminus">-    const char* condition,</span>
<a href="#l68.393"></a><span id="l68.393" class="difflineminus">-    const char* value,</span>
<a href="#l68.394"></a><span id="l68.394" class="difflineminus">-    nsIAbBooleanConditionString** conditionString)</span>
<a href="#l68.395"></a><span id="l68.395" class="difflineminus">-{</span>
<a href="#l68.396"></a><span id="l68.396" class="difflineminus">-    if (attribute == 0 || condition == 0 || value == 0)</span>
<a href="#l68.397"></a><span id="l68.397" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.398"></a><span id="l68.398" class="difflineplus">+nsresult nsAbQueryStringToExpression::CreateBooleanConditionString(</span>
<a href="#l68.399"></a><span id="l68.399" class="difflineplus">+    const char* attribute, const char* condition, const char* value,</span>
<a href="#l68.400"></a><span id="l68.400" class="difflineplus">+    nsIAbBooleanConditionString** conditionString) {</span>
<a href="#l68.401"></a><span id="l68.401" class="difflineplus">+  if (attribute == 0 || condition == 0 || value == 0) return NS_ERROR_FAILURE;</span>
<a href="#l68.402"></a><span id="l68.402"> </span>
<a href="#l68.403"></a><span id="l68.403" class="difflineminus">-    nsAbBooleanConditionType c;</span>
<a href="#l68.404"></a><span id="l68.404" class="difflineplus">+  nsAbBooleanConditionType c;</span>
<a href="#l68.405"></a><span id="l68.405"> </span>
<a href="#l68.406"></a><span id="l68.406" class="difflineminus">-    if (PL_strcasecmp (condition, &quot;=&quot;) == 0)</span>
<a href="#l68.407"></a><span id="l68.407" class="difflineminus">-        c = nsIAbBooleanConditionTypes::Is;</span>
<a href="#l68.408"></a><span id="l68.408" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;!=&quot;) == 0)</span>
<a href="#l68.409"></a><span id="l68.409" class="difflineminus">-        c = nsIAbBooleanConditionTypes::IsNot;</span>
<a href="#l68.410"></a><span id="l68.410" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;lt&quot;) == 0)</span>
<a href="#l68.411"></a><span id="l68.411" class="difflineminus">-        c = nsIAbBooleanConditionTypes::LessThan;</span>
<a href="#l68.412"></a><span id="l68.412" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;gt&quot;) == 0)</span>
<a href="#l68.413"></a><span id="l68.413" class="difflineminus">-        c = nsIAbBooleanConditionTypes::GreaterThan;</span>
<a href="#l68.414"></a><span id="l68.414" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;bw&quot;) == 0)</span>
<a href="#l68.415"></a><span id="l68.415" class="difflineminus">-        c = nsIAbBooleanConditionTypes::BeginsWith;</span>
<a href="#l68.416"></a><span id="l68.416" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;ew&quot;) == 0)</span>
<a href="#l68.417"></a><span id="l68.417" class="difflineminus">-        c = nsIAbBooleanConditionTypes::EndsWith;</span>
<a href="#l68.418"></a><span id="l68.418" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;c&quot;)== 0)</span>
<a href="#l68.419"></a><span id="l68.419" class="difflineminus">-        c = nsIAbBooleanConditionTypes::Contains;</span>
<a href="#l68.420"></a><span id="l68.420" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;!c&quot;) == 0)</span>
<a href="#l68.421"></a><span id="l68.421" class="difflineminus">-        c = nsIAbBooleanConditionTypes::DoesNotContain;</span>
<a href="#l68.422"></a><span id="l68.422" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;~=&quot;) == 0)</span>
<a href="#l68.423"></a><span id="l68.423" class="difflineminus">-        c = nsIAbBooleanConditionTypes::SoundsLike;</span>
<a href="#l68.424"></a><span id="l68.424" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;regex&quot;) == 0)</span>
<a href="#l68.425"></a><span id="l68.425" class="difflineminus">-        c = nsIAbBooleanConditionTypes::RegExp;</span>
<a href="#l68.426"></a><span id="l68.426" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;ex&quot;) == 0)</span>
<a href="#l68.427"></a><span id="l68.427" class="difflineminus">-        c = nsIAbBooleanConditionTypes::Exists;</span>
<a href="#l68.428"></a><span id="l68.428" class="difflineminus">-    else if (PL_strcasecmp (condition, &quot;!ex&quot;) == 0)</span>
<a href="#l68.429"></a><span id="l68.429" class="difflineminus">-        c = nsIAbBooleanConditionTypes::DoesNotExist;</span>
<a href="#l68.430"></a><span id="l68.430" class="difflineminus">-    else</span>
<a href="#l68.431"></a><span id="l68.431" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l68.432"></a><span id="l68.432" class="difflineplus">+  if (PL_strcasecmp(condition, &quot;=&quot;) == 0)</span>
<a href="#l68.433"></a><span id="l68.433" class="difflineplus">+    c = nsIAbBooleanConditionTypes::Is;</span>
<a href="#l68.434"></a><span id="l68.434" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;!=&quot;) == 0)</span>
<a href="#l68.435"></a><span id="l68.435" class="difflineplus">+    c = nsIAbBooleanConditionTypes::IsNot;</span>
<a href="#l68.436"></a><span id="l68.436" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;lt&quot;) == 0)</span>
<a href="#l68.437"></a><span id="l68.437" class="difflineplus">+    c = nsIAbBooleanConditionTypes::LessThan;</span>
<a href="#l68.438"></a><span id="l68.438" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;gt&quot;) == 0)</span>
<a href="#l68.439"></a><span id="l68.439" class="difflineplus">+    c = nsIAbBooleanConditionTypes::GreaterThan;</span>
<a href="#l68.440"></a><span id="l68.440" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;bw&quot;) == 0)</span>
<a href="#l68.441"></a><span id="l68.441" class="difflineplus">+    c = nsIAbBooleanConditionTypes::BeginsWith;</span>
<a href="#l68.442"></a><span id="l68.442" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;ew&quot;) == 0)</span>
<a href="#l68.443"></a><span id="l68.443" class="difflineplus">+    c = nsIAbBooleanConditionTypes::EndsWith;</span>
<a href="#l68.444"></a><span id="l68.444" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;c&quot;) == 0)</span>
<a href="#l68.445"></a><span id="l68.445" class="difflineplus">+    c = nsIAbBooleanConditionTypes::Contains;</span>
<a href="#l68.446"></a><span id="l68.446" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;!c&quot;) == 0)</span>
<a href="#l68.447"></a><span id="l68.447" class="difflineplus">+    c = nsIAbBooleanConditionTypes::DoesNotContain;</span>
<a href="#l68.448"></a><span id="l68.448" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;~=&quot;) == 0)</span>
<a href="#l68.449"></a><span id="l68.449" class="difflineplus">+    c = nsIAbBooleanConditionTypes::SoundsLike;</span>
<a href="#l68.450"></a><span id="l68.450" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;regex&quot;) == 0)</span>
<a href="#l68.451"></a><span id="l68.451" class="difflineplus">+    c = nsIAbBooleanConditionTypes::RegExp;</span>
<a href="#l68.452"></a><span id="l68.452" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;ex&quot;) == 0)</span>
<a href="#l68.453"></a><span id="l68.453" class="difflineplus">+    c = nsIAbBooleanConditionTypes::Exists;</span>
<a href="#l68.454"></a><span id="l68.454" class="difflineplus">+  else if (PL_strcasecmp(condition, &quot;!ex&quot;) == 0)</span>
<a href="#l68.455"></a><span id="l68.455" class="difflineplus">+    c = nsIAbBooleanConditionTypes::DoesNotExist;</span>
<a href="#l68.456"></a><span id="l68.456" class="difflineplus">+  else</span>
<a href="#l68.457"></a><span id="l68.457" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l68.458"></a><span id="l68.458"> </span>
<a href="#l68.459"></a><span id="l68.459" class="difflineminus">-    nsresult rv;</span>
<a href="#l68.460"></a><span id="l68.460" class="difflineplus">+  nsresult rv;</span>
<a href="#l68.461"></a><span id="l68.461" class="difflineplus">+</span>
<a href="#l68.462"></a><span id="l68.462" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanConditionString&gt; cs =</span>
<a href="#l68.463"></a><span id="l68.463" class="difflineplus">+      do_CreateInstance(NS_BOOLEANCONDITIONSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l68.464"></a><span id="l68.464" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.465"></a><span id="l68.465" class="difflineplus">+</span>
<a href="#l68.466"></a><span id="l68.466" class="difflineplus">+  rv = cs-&gt;SetCondition(c);</span>
<a href="#l68.467"></a><span id="l68.467" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.468"></a><span id="l68.468"> </span>
<a href="#l68.469"></a><span id="l68.469" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanConditionString&gt; cs = do_CreateInstance(NS_BOOLEANCONDITIONSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l68.470"></a><span id="l68.470" class="difflineplus">+  nsCOMPtr&lt;nsITextToSubURI&gt; textToSubURI =</span>
<a href="#l68.471"></a><span id="l68.471" class="difflineplus">+      do_GetService(NS_ITEXTTOSUBURI_CONTRACTID, &amp;rv);</span>
<a href="#l68.472"></a><span id="l68.472" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l68.473"></a><span id="l68.473" class="difflineplus">+    nsString attributeUCS2;</span>
<a href="#l68.474"></a><span id="l68.474" class="difflineplus">+    nsString valueUCS2;</span>
<a href="#l68.475"></a><span id="l68.475" class="difflineplus">+</span>
<a href="#l68.476"></a><span id="l68.476" class="difflineplus">+    rv = textToSubURI-&gt;UnEscapeAndConvert(nsDependentCString(&quot;UTF-8&quot;),</span>
<a href="#l68.477"></a><span id="l68.477" class="difflineplus">+                                          nsDependentCString(attribute),</span>
<a href="#l68.478"></a><span id="l68.478" class="difflineplus">+                                          attributeUCS2);</span>
<a href="#l68.479"></a><span id="l68.479">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.480"></a><span id="l68.480"> </span>
<a href="#l68.481"></a><span id="l68.481" class="difflineminus">-    rv = cs-&gt;SetCondition (c);</span>
<a href="#l68.482"></a><span id="l68.482" class="difflineplus">+    rv = textToSubURI-&gt;UnEscapeAndConvert(nsDependentCString(&quot;UTF-8&quot;),</span>
<a href="#l68.483"></a><span id="l68.483" class="difflineplus">+                                          nsDependentCString(value), valueUCS2);</span>
<a href="#l68.484"></a><span id="l68.484">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.485"></a><span id="l68.485"> </span>
<a href="#l68.486"></a><span id="l68.486" class="difflineminus">-    nsCOMPtr&lt;nsITextToSubURI&gt; textToSubURI = do_GetService(NS_ITEXTTOSUBURI_CONTRACTID,&amp;rv);</span>
<a href="#l68.487"></a><span id="l68.487" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l68.488"></a><span id="l68.488" class="difflineminus">-    {</span>
<a href="#l68.489"></a><span id="l68.489" class="difflineminus">-        nsString attributeUCS2;</span>
<a href="#l68.490"></a><span id="l68.490" class="difflineminus">-        nsString valueUCS2;</span>
<a href="#l68.491"></a><span id="l68.491" class="difflineplus">+    NS_ConvertUTF16toUTF8 attributeUTF8(attributeUCS2);</span>
<a href="#l68.492"></a><span id="l68.492"> </span>
<a href="#l68.493"></a><span id="l68.493" class="difflineminus">-        rv = textToSubURI-&gt;UnEscapeAndConvert(nsDependentCString(&quot;UTF-8&quot;),</span>
<a href="#l68.494"></a><span id="l68.494" class="difflineminus">-            nsDependentCString(attribute), attributeUCS2);</span>
<a href="#l68.495"></a><span id="l68.495" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.496"></a><span id="l68.496" class="difflineminus">-</span>
<a href="#l68.497"></a><span id="l68.497" class="difflineminus">-        rv = textToSubURI-&gt;UnEscapeAndConvert(nsDependentCString(&quot;UTF-8&quot;),</span>
<a href="#l68.498"></a><span id="l68.498" class="difflineminus">-            nsDependentCString(value), valueUCS2);</span>
<a href="#l68.499"></a><span id="l68.499" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.500"></a><span id="l68.500" class="difflineminus">-</span>
<a href="#l68.501"></a><span id="l68.501" class="difflineminus">-        NS_ConvertUTF16toUTF8 attributeUTF8(attributeUCS2);</span>
<a href="#l68.502"></a><span id="l68.502" class="difflineplus">+    rv = cs-&gt;SetName(attributeUTF8.get());</span>
<a href="#l68.503"></a><span id="l68.503" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.504"></a><span id="l68.504" class="difflineplus">+    rv = cs-&gt;SetValue(valueUCS2.get());</span>
<a href="#l68.505"></a><span id="l68.505" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.506"></a><span id="l68.506" class="difflineplus">+  } else {</span>
<a href="#l68.507"></a><span id="l68.507" class="difflineplus">+    NS_ConvertUTF8toUTF16 valueUCS2(value);</span>
<a href="#l68.508"></a><span id="l68.508"> </span>
<a href="#l68.509"></a><span id="l68.509" class="difflineminus">-        rv = cs-&gt;SetName (attributeUTF8.get ());</span>
<a href="#l68.510"></a><span id="l68.510" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.511"></a><span id="l68.511" class="difflineminus">-        rv = cs-&gt;SetValue(valueUCS2.get());</span>
<a href="#l68.512"></a><span id="l68.512" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.513"></a><span id="l68.513" class="difflineminus">-    }</span>
<a href="#l68.514"></a><span id="l68.514" class="difflineminus">-    else</span>
<a href="#l68.515"></a><span id="l68.515" class="difflineminus">-    {</span>
<a href="#l68.516"></a><span id="l68.516" class="difflineminus">-        NS_ConvertUTF8toUTF16 valueUCS2(value);</span>
<a href="#l68.517"></a><span id="l68.517" class="difflineplus">+    rv = cs-&gt;SetName(attribute);</span>
<a href="#l68.518"></a><span id="l68.518" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.519"></a><span id="l68.519" class="difflineplus">+    rv = cs-&gt;SetValue(valueUCS2.get());</span>
<a href="#l68.520"></a><span id="l68.520" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.521"></a><span id="l68.521" class="difflineplus">+  }</span>
<a href="#l68.522"></a><span id="l68.522"> </span>
<a href="#l68.523"></a><span id="l68.523" class="difflineminus">-        rv = cs-&gt;SetName (attribute);</span>
<a href="#l68.524"></a><span id="l68.524" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.525"></a><span id="l68.525" class="difflineminus">-        rv = cs-&gt;SetValue (valueUCS2.get ());</span>
<a href="#l68.526"></a><span id="l68.526" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.527"></a><span id="l68.527" class="difflineminus">-    }</span>
<a href="#l68.528"></a><span id="l68.528" class="difflineminus">-</span>
<a href="#l68.529"></a><span id="l68.529" class="difflineminus">-    cs.forget(conditionString);</span>
<a href="#l68.530"></a><span id="l68.530" class="difflineminus">-    return NS_OK;</span>
<a href="#l68.531"></a><span id="l68.531" class="difflineplus">+  cs.forget(conditionString);</span>
<a href="#l68.532"></a><span id="l68.532" class="difflineplus">+  return NS_OK;</span>
<a href="#l68.533"></a><span id="l68.533"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbQueryStringToExpression.h</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbQueryStringToExpression.h</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -3,47 +3,36 @@</span>
<a href="#l69.4"></a><span id="l69.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l69.5"></a><span id="l69.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l69.6"></a><span id="l69.6"> </span>
<a href="#l69.7"></a><span id="l69.7"> #ifndef nsAbQueryStringToExpression_h__</span>
<a href="#l69.8"></a><span id="l69.8"> #define nsAbQueryStringToExpression_h__</span>
<a href="#l69.9"></a><span id="l69.9"> </span>
<a href="#l69.10"></a><span id="l69.10"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-class nsAbQueryStringToExpression</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-{</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-public:</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineminus">-    static nsresult Convert (</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineminus">-        const nsACString &amp;aQueryString,</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineminus">-        nsIAbBooleanExpression** expression);</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineplus">+class nsAbQueryStringToExpression {</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineplus">+ public:</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineplus">+  static nsresult Convert(const nsACString&amp; aQueryString,</span>
<a href="#l69.21"></a><span id="l69.21" class="difflineplus">+                          nsIAbBooleanExpression** expression);</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineplus">+</span>
<a href="#l69.23"></a><span id="l69.23" class="difflineplus">+ protected:</span>
<a href="#l69.24"></a><span id="l69.24" class="difflineplus">+  static nsresult ParseExpression(const char** index, nsISupports** expression);</span>
<a href="#l69.25"></a><span id="l69.25" class="difflineplus">+  static nsresult ParseExpressions(const char** index,</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineplus">+                                   nsIAbBooleanExpression* expression);</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineplus">+  static nsresult ParseCondition(const char** index,</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineplus">+                                 const char* indexBracketClose,</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineplus">+                                 nsIAbBooleanConditionString** conditionString);</span>
<a href="#l69.30"></a><span id="l69.30"> </span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-protected:</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineminus">-    static nsresult ParseExpression (</span>
<a href="#l69.33"></a><span id="l69.33" class="difflineminus">-        const char** index,</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineminus">-        nsISupports** expression);</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineminus">-    static nsresult ParseExpressions (</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineminus">-        const char** index,</span>
<a href="#l69.37"></a><span id="l69.37" class="difflineminus">-        nsIAbBooleanExpression* expression);</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineminus">-    static nsresult ParseCondition (</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineminus">-        const char** index,</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineminus">-        const char* indexBracketClose,</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineminus">-        nsIAbBooleanConditionString** conditionString);</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineplus">+  static nsresult ParseConditionEntry(const char** index,</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineplus">+                                      const char* indexBracketClose,</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineplus">+                                      char** entry);</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineplus">+  static nsresult ParseOperationEntry(const char* indexBracketOpen1,</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineplus">+                                      const char* indexBracketOpen2,</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineplus">+                                      char** operation);</span>
<a href="#l69.48"></a><span id="l69.48"> </span>
<a href="#l69.49"></a><span id="l69.49" class="difflineminus">-    static nsresult ParseConditionEntry (</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineminus">-        const char** index,</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineminus">-        const char* indexBracketClose,</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineminus">-        char** entry);</span>
<a href="#l69.53"></a><span id="l69.53" class="difflineminus">-    static nsresult ParseOperationEntry (</span>
<a href="#l69.54"></a><span id="l69.54" class="difflineminus">-        const char* indexBracketOpen1,</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineminus">-        const char* indexBracketOpen2,</span>
<a href="#l69.56"></a><span id="l69.56" class="difflineminus">-        char** operation);</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineminus">-</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineminus">-    static nsresult CreateBooleanExpression(</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineminus">-        const char* operation,</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineminus">-        nsIAbBooleanExpression** expression);</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineminus">-    static nsresult CreateBooleanConditionString (</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineminus">-        const char* attribute,</span>
<a href="#l69.63"></a><span id="l69.63" class="difflineminus">-        const char* condition,</span>
<a href="#l69.64"></a><span id="l69.64" class="difflineminus">-        const char* value,</span>
<a href="#l69.65"></a><span id="l69.65" class="difflineminus">-        nsIAbBooleanConditionString** conditionString);</span>
<a href="#l69.66"></a><span id="l69.66" class="difflineplus">+  static nsresult CreateBooleanExpression(const char* operation,</span>
<a href="#l69.67"></a><span id="l69.67" class="difflineplus">+                                          nsIAbBooleanExpression** expression);</span>
<a href="#l69.68"></a><span id="l69.68" class="difflineplus">+  static nsresult CreateBooleanConditionString(</span>
<a href="#l69.69"></a><span id="l69.69" class="difflineplus">+      const char* attribute, const char* condition, const char* value,</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineplus">+      nsIAbBooleanConditionString** conditionString);</span>
<a href="#l69.71"></a><span id="l69.71"> };</span>
<a href="#l69.72"></a><span id="l69.72"> </span>
<a href="#l69.73"></a><span id="l69.73"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbUtils.h</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbUtils.h</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -7,134 +7,80 @@</span>
<a href="#l70.4"></a><span id="l70.4"> #define nsAbUtils_h__</span>
<a href="#l70.5"></a><span id="l70.5"> </span>
<a href="#l70.6"></a><span id="l70.6"> #include &quot;nsMemory.h&quot;</span>
<a href="#l70.7"></a><span id="l70.7"> </span>
<a href="#l70.8"></a><span id="l70.8"> /*</span>
<a href="#l70.9"></a><span id="l70.9">  * Wrapper class to automatically free an array of</span>
<a href="#l70.10"></a><span id="l70.10">  * char* when class goes out of scope</span>
<a href="#l70.11"></a><span id="l70.11">  */</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-class CharPtrArrayGuard</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineminus">-{</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineminus">-public:</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineminus">-    explicit CharPtrArrayGuard (bool freeElements = true) :</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineminus">-        mFreeElements (freeElements),</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineminus">-        mArray (0),</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineminus">-        mSize (0)</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineminus">-    {</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineminus">-    }</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineplus">+class CharPtrArrayGuard {</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineplus">+ public:</span>
<a href="#l70.23"></a><span id="l70.23" class="difflineplus">+  explicit CharPtrArrayGuard(bool freeElements = true)</span>
<a href="#l70.24"></a><span id="l70.24" class="difflineplus">+      : mFreeElements(freeElements), mArray(0), mSize(0) {}</span>
<a href="#l70.25"></a><span id="l70.25"> </span>
<a href="#l70.26"></a><span id="l70.26" class="difflineminus">-    ~CharPtrArrayGuard ()</span>
<a href="#l70.27"></a><span id="l70.27" class="difflineminus">-    {</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineminus">-        Free ();</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineminus">-    }</span>
<a href="#l70.30"></a><span id="l70.30" class="difflineplus">+  ~CharPtrArrayGuard() { Free(); }</span>
<a href="#l70.31"></a><span id="l70.31"> </span>
<a href="#l70.32"></a><span id="l70.32" class="difflineminus">-    char* operator[](int i)</span>
<a href="#l70.33"></a><span id="l70.33" class="difflineminus">-    {</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineminus">-        return mArray[i];</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineminus">-    }</span>
<a href="#l70.36"></a><span id="l70.36" class="difflineplus">+  char* operator[](int i) { return mArray[i]; }</span>
<a href="#l70.37"></a><span id="l70.37" class="difflineplus">+</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineplus">+  uint32_t* GetSizeAddr(void) { return &amp;mSize; }</span>
<a href="#l70.39"></a><span id="l70.39"> </span>
<a href="#l70.40"></a><span id="l70.40" class="difflineminus">-    uint32_t* GetSizeAddr(void)</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineminus">-    {</span>
<a href="#l70.42"></a><span id="l70.42" class="difflineminus">-        return &amp;mSize;</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineminus">-    }</span>
<a href="#l70.44"></a><span id="l70.44" class="difflineplus">+  uint32_t GetSize(void) { return mSize; }</span>
<a href="#l70.45"></a><span id="l70.45"> </span>
<a href="#l70.46"></a><span id="l70.46" class="difflineminus">-    uint32_t GetSize(void)</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineminus">-    {</span>
<a href="#l70.48"></a><span id="l70.48" class="difflineminus">-        return mSize;</span>
<a href="#l70.49"></a><span id="l70.49" class="difflineminus">-    }</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineplus">+  char*** GetArrayAddr(void) { return &amp;mArray; }</span>
<a href="#l70.51"></a><span id="l70.51"> </span>
<a href="#l70.52"></a><span id="l70.52" class="difflineminus">-    char*** GetArrayAddr(void)</span>
<a href="#l70.53"></a><span id="l70.53" class="difflineminus">-    {</span>
<a href="#l70.54"></a><span id="l70.54" class="difflineminus">-        return &amp;mArray;</span>
<a href="#l70.55"></a><span id="l70.55" class="difflineminus">-    }</span>
<a href="#l70.56"></a><span id="l70.56" class="difflineplus">+  const char** GetArray(void) { return (const char**)mArray; }</span>
<a href="#l70.57"></a><span id="l70.57"> </span>
<a href="#l70.58"></a><span id="l70.58" class="difflineminus">-    const char** GetArray(void)</span>
<a href="#l70.59"></a><span id="l70.59" class="difflineminus">-    {</span>
<a href="#l70.60"></a><span id="l70.60" class="difflineminus">-        return (const char** ) mArray;</span>
<a href="#l70.61"></a><span id="l70.61" class="difflineminus">-    }</span>
<a href="#l70.62"></a><span id="l70.62" class="difflineminus">-</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineminus">-public:</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineplus">+ public:</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineplus">+ private:</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineplus">+  bool mFreeElements;</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineplus">+  char** mArray;</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineplus">+  uint32_t mSize;</span>
<a href="#l70.69"></a><span id="l70.69"> </span>
<a href="#l70.70"></a><span id="l70.70" class="difflineminus">-private:</span>
<a href="#l70.71"></a><span id="l70.71" class="difflineminus">-    bool mFreeElements;</span>
<a href="#l70.72"></a><span id="l70.72" class="difflineminus">-    char **mArray;</span>
<a href="#l70.73"></a><span id="l70.73" class="difflineminus">-    uint32_t mSize;</span>
<a href="#l70.74"></a><span id="l70.74" class="difflineplus">+  void Free() {</span>
<a href="#l70.75"></a><span id="l70.75" class="difflineplus">+    if (!mArray) return;</span>
<a href="#l70.76"></a><span id="l70.76"> </span>
<a href="#l70.77"></a><span id="l70.77" class="difflineminus">-    void Free ()</span>
<a href="#l70.78"></a><span id="l70.78" class="difflineminus">-    {</span>
<a href="#l70.79"></a><span id="l70.79" class="difflineminus">-        if (!mArray)</span>
<a href="#l70.80"></a><span id="l70.80" class="difflineminus">-            return;</span>
<a href="#l70.81"></a><span id="l70.81" class="difflineminus">-</span>
<a href="#l70.82"></a><span id="l70.82" class="difflineminus">-        if (mFreeElements)</span>
<a href="#l70.83"></a><span id="l70.83" class="difflineminus">-            NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mSize, mArray);</span>
<a href="#l70.84"></a><span id="l70.84" class="difflineminus">-        else</span>
<a href="#l70.85"></a><span id="l70.85" class="difflineminus">-        {</span>
<a href="#l70.86"></a><span id="l70.86" class="difflineminus">-          free(mArray);</span>
<a href="#l70.87"></a><span id="l70.87" class="difflineminus">-        }</span>
<a href="#l70.88"></a><span id="l70.88" class="difflineplus">+    if (mFreeElements)</span>
<a href="#l70.89"></a><span id="l70.89" class="difflineplus">+      NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mSize, mArray);</span>
<a href="#l70.90"></a><span id="l70.90" class="difflineplus">+    else {</span>
<a href="#l70.91"></a><span id="l70.91" class="difflineplus">+      free(mArray);</span>
<a href="#l70.92"></a><span id="l70.92">     }</span>
<a href="#l70.93"></a><span id="l70.93" class="difflineplus">+  }</span>
<a href="#l70.94"></a><span id="l70.94"> };</span>
<a href="#l70.95"></a><span id="l70.95"> </span>
<a href="#l70.96"></a><span id="l70.96"> /*</span>
<a href="#l70.97"></a><span id="l70.97">  * Wrapper class to automatically free an array of</span>
<a href="#l70.98"></a><span id="l70.98">  * char16_t* when class goes out of scope</span>
<a href="#l70.99"></a><span id="l70.99">  */</span>
<a href="#l70.100"></a><span id="l70.100" class="difflineminus">-class PRUnicharPtrArrayGuard</span>
<a href="#l70.101"></a><span id="l70.101" class="difflineminus">-{</span>
<a href="#l70.102"></a><span id="l70.102" class="difflineminus">-public:</span>
<a href="#l70.103"></a><span id="l70.103" class="difflineminus">-    explicit PRUnicharPtrArrayGuard (bool freeElements = true) :</span>
<a href="#l70.104"></a><span id="l70.104" class="difflineminus">-        mFreeElements (freeElements),</span>
<a href="#l70.105"></a><span id="l70.105" class="difflineminus">-        mArray (0),</span>
<a href="#l70.106"></a><span id="l70.106" class="difflineminus">-        mSize (0)</span>
<a href="#l70.107"></a><span id="l70.107" class="difflineminus">-    {</span>
<a href="#l70.108"></a><span id="l70.108" class="difflineminus">-    }</span>
<a href="#l70.109"></a><span id="l70.109" class="difflineplus">+class PRUnicharPtrArrayGuard {</span>
<a href="#l70.110"></a><span id="l70.110" class="difflineplus">+ public:</span>
<a href="#l70.111"></a><span id="l70.111" class="difflineplus">+  explicit PRUnicharPtrArrayGuard(bool freeElements = true)</span>
<a href="#l70.112"></a><span id="l70.112" class="difflineplus">+      : mFreeElements(freeElements), mArray(0), mSize(0) {}</span>
<a href="#l70.113"></a><span id="l70.113" class="difflineplus">+</span>
<a href="#l70.114"></a><span id="l70.114" class="difflineplus">+  ~PRUnicharPtrArrayGuard() { Free(); }</span>
<a href="#l70.115"></a><span id="l70.115" class="difflineplus">+</span>
<a href="#l70.116"></a><span id="l70.116" class="difflineplus">+  char16_t* operator[](int i) { return mArray[i]; }</span>
<a href="#l70.117"></a><span id="l70.117" class="difflineplus">+</span>
<a href="#l70.118"></a><span id="l70.118" class="difflineplus">+  uint32_t* GetSizeAddr(void) { return &amp;mSize; }</span>
<a href="#l70.119"></a><span id="l70.119" class="difflineplus">+</span>
<a href="#l70.120"></a><span id="l70.120" class="difflineplus">+  uint32_t GetSize(void) { return mSize; }</span>
<a href="#l70.121"></a><span id="l70.121" class="difflineplus">+</span>
<a href="#l70.122"></a><span id="l70.122" class="difflineplus">+  char16_t*** GetArrayAddr(void) { return &amp;mArray; }</span>
<a href="#l70.123"></a><span id="l70.123"> </span>
<a href="#l70.124"></a><span id="l70.124" class="difflineminus">-    ~PRUnicharPtrArrayGuard ()</span>
<a href="#l70.125"></a><span id="l70.125" class="difflineminus">-    {</span>
<a href="#l70.126"></a><span id="l70.126" class="difflineminus">-        Free ();</span>
<a href="#l70.127"></a><span id="l70.127" class="difflineminus">-    }</span>
<a href="#l70.128"></a><span id="l70.128" class="difflineplus">+  const char16_t** GetArray(void) { return (const char16_t**)mArray; }</span>
<a href="#l70.129"></a><span id="l70.129"> </span>
<a href="#l70.130"></a><span id="l70.130" class="difflineminus">-    char16_t* operator[](int i)</span>
<a href="#l70.131"></a><span id="l70.131" class="difflineminus">-    {</span>
<a href="#l70.132"></a><span id="l70.132" class="difflineminus">-        return mArray[i];</span>
<a href="#l70.133"></a><span id="l70.133" class="difflineminus">-    }</span>
<a href="#l70.134"></a><span id="l70.134" class="difflineplus">+ public:</span>
<a href="#l70.135"></a><span id="l70.135" class="difflineplus">+ private:</span>
<a href="#l70.136"></a><span id="l70.136" class="difflineplus">+  bool mFreeElements;</span>
<a href="#l70.137"></a><span id="l70.137" class="difflineplus">+  char16_t** mArray;</span>
<a href="#l70.138"></a><span id="l70.138" class="difflineplus">+  uint32_t mSize;</span>
<a href="#l70.139"></a><span id="l70.139" class="difflineplus">+  void Free() {</span>
<a href="#l70.140"></a><span id="l70.140" class="difflineplus">+    if (!mArray) return;</span>
<a href="#l70.141"></a><span id="l70.141"> </span>
<a href="#l70.142"></a><span id="l70.142" class="difflineminus">-    uint32_t* GetSizeAddr(void)</span>
<a href="#l70.143"></a><span id="l70.143" class="difflineminus">-    {</span>
<a href="#l70.144"></a><span id="l70.144" class="difflineminus">-        return &amp;mSize;</span>
<a href="#l70.145"></a><span id="l70.145" class="difflineminus">-    }</span>
<a href="#l70.146"></a><span id="l70.146" class="difflineminus">-</span>
<a href="#l70.147"></a><span id="l70.147" class="difflineminus">-    uint32_t GetSize(void)</span>
<a href="#l70.148"></a><span id="l70.148" class="difflineminus">-    {</span>
<a href="#l70.149"></a><span id="l70.149" class="difflineminus">-        return mSize;</span>
<a href="#l70.150"></a><span id="l70.150" class="difflineplus">+    if (mFreeElements)</span>
<a href="#l70.151"></a><span id="l70.151" class="difflineplus">+      NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mSize, mArray);</span>
<a href="#l70.152"></a><span id="l70.152" class="difflineplus">+    else {</span>
<a href="#l70.153"></a><span id="l70.153" class="difflineplus">+      free(mArray);</span>
<a href="#l70.154"></a><span id="l70.154">     }</span>
<a href="#l70.155"></a><span id="l70.155" class="difflineminus">-</span>
<a href="#l70.156"></a><span id="l70.156" class="difflineminus">-    char16_t*** GetArrayAddr(void)</span>
<a href="#l70.157"></a><span id="l70.157" class="difflineminus">-    {</span>
<a href="#l70.158"></a><span id="l70.158" class="difflineminus">-        return &amp;mArray;</span>
<a href="#l70.159"></a><span id="l70.159" class="difflineminus">-    }</span>
<a href="#l70.160"></a><span id="l70.160" class="difflineminus">-</span>
<a href="#l70.161"></a><span id="l70.161" class="difflineminus">-    const char16_t** GetArray(void)</span>
<a href="#l70.162"></a><span id="l70.162" class="difflineminus">-    {</span>
<a href="#l70.163"></a><span id="l70.163" class="difflineminus">-        return (const char16_t** ) mArray;</span>
<a href="#l70.164"></a><span id="l70.164" class="difflineminus">-    }</span>
<a href="#l70.165"></a><span id="l70.165" class="difflineminus">-</span>
<a href="#l70.166"></a><span id="l70.166" class="difflineminus">-public:</span>
<a href="#l70.167"></a><span id="l70.167" class="difflineminus">-</span>
<a href="#l70.168"></a><span id="l70.168" class="difflineminus">-private:</span>
<a href="#l70.169"></a><span id="l70.169" class="difflineminus">-    bool mFreeElements;</span>
<a href="#l70.170"></a><span id="l70.170" class="difflineminus">-    char16_t **mArray;</span>
<a href="#l70.171"></a><span id="l70.171" class="difflineminus">-    uint32_t mSize;</span>
<a href="#l70.172"></a><span id="l70.172" class="difflineminus">-    void Free ()</span>
<a href="#l70.173"></a><span id="l70.173" class="difflineminus">-    {</span>
<a href="#l70.174"></a><span id="l70.174" class="difflineminus">-        if (!mArray)</span>
<a href="#l70.175"></a><span id="l70.175" class="difflineminus">-            return;</span>
<a href="#l70.176"></a><span id="l70.176" class="difflineminus">-</span>
<a href="#l70.177"></a><span id="l70.177" class="difflineminus">-        if (mFreeElements)</span>
<a href="#l70.178"></a><span id="l70.178" class="difflineminus">-          NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mSize, mArray);</span>
<a href="#l70.179"></a><span id="l70.179" class="difflineminus">-        else</span>
<a href="#l70.180"></a><span id="l70.180" class="difflineminus">-        {</span>
<a href="#l70.181"></a><span id="l70.181" class="difflineminus">-          free(mArray);</span>
<a href="#l70.182"></a><span id="l70.182" class="difflineminus">-        }</span>
<a href="#l70.183"></a><span id="l70.183" class="difflineminus">-    }</span>
<a href="#l70.184"></a><span id="l70.184" class="difflineplus">+  }</span>
<a href="#l70.185"></a><span id="l70.185"> };</span>
<a href="#l70.186"></a><span id="l70.186"> </span>
<a href="#l70.187"></a><span id="l70.187" class="difflineminus">-#endif  /* nsAbUtils_h__ */</span>
<a href="#l70.188"></a><span id="l70.188" class="difflineplus">+#endif /* nsAbUtils_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -17,175 +17,168 @@</span>
<a href="#l71.4"></a><span id="l71.4"> #include &quot;nsTreeColumns.h&quot;</span>
<a href="#l71.5"></a><span id="l71.5"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l71.6"></a><span id="l71.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l71.7"></a><span id="l71.7"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l71.8"></a><span id="l71.8"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l71.9"></a><span id="l71.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l71.10"></a><span id="l71.10"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l71.11"></a><span id="l71.11"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot; // for kPhoneticNameColumn</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+#include &quot;nsIAddrDatabase.h&quot;  // for kPhoneticNameColumn</span>
<a href="#l71.14"></a><span id="l71.14"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l71.15"></a><span id="l71.15"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l71.16"></a><span id="l71.16"> #include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l71.17"></a><span id="l71.17"> </span>
<a href="#l71.18"></a><span id="l71.18"> using namespace mozilla;</span>
<a href="#l71.19"></a><span id="l71.19"> </span>
<a href="#l71.20"></a><span id="l71.20"> #define CARD_NOT_FOUND -1</span>
<a href="#l71.21"></a><span id="l71.21"> #define ALL_ROWS -1</span>
<a href="#l71.22"></a><span id="l71.22"> </span>
<a href="#l71.23"></a><span id="l71.23"> #define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineminus">-#define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION &quot;mail.addr_book.displayName.autoGeneration&quot;</span>
<a href="#l71.25"></a><span id="l71.25" class="difflineminus">-#define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST &quot;mail.addr_book.displayName.lastnamefirst&quot;</span>
<a href="#l71.26"></a><span id="l71.26" class="difflineplus">+#define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION \</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineplus">+  &quot;mail.addr_book.displayName.autoGeneration&quot;</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+#define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST \</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineplus">+  &quot;mail.addr_book.displayName.lastnamefirst&quot;</span>
<a href="#l71.30"></a><span id="l71.30"> </span>
<a href="#l71.31"></a><span id="l71.31"> // Also, our default primary sort</span>
<a href="#l71.32"></a><span id="l71.32"> #define GENERATED_NAME_COLUMN_ID &quot;GeneratedName&quot;</span>
<a href="#l71.33"></a><span id="l71.33"> </span>
<a href="#l71.34"></a><span id="l71.34"> NS_IMPL_ISUPPORTS(nsAbView, nsIAbView, nsITreeView, nsIAbListener, nsIObserver)</span>
<a href="#l71.35"></a><span id="l71.35"> </span>
<a href="#l71.36"></a><span id="l71.36" class="difflineminus">-nsAbView::nsAbView() : mInitialized(false),</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineminus">-                       mIsAllDirectoryRootView(false),</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineminus">-                       mSuppressSelectionChange(false),</span>
<a href="#l71.39"></a><span id="l71.39" class="difflineminus">-                       mSuppressCountChange(false),</span>
<a href="#l71.40"></a><span id="l71.40" class="difflineminus">-                       mGeneratedNameFormat(0)</span>
<a href="#l71.41"></a><span id="l71.41" class="difflineminus">-{</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineminus">-}</span>
<a href="#l71.43"></a><span id="l71.43" class="difflineplus">+nsAbView::nsAbView()</span>
<a href="#l71.44"></a><span id="l71.44" class="difflineplus">+    : mInitialized(false),</span>
<a href="#l71.45"></a><span id="l71.45" class="difflineplus">+      mIsAllDirectoryRootView(false),</span>
<a href="#l71.46"></a><span id="l71.46" class="difflineplus">+      mSuppressSelectionChange(false),</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineplus">+      mSuppressCountChange(false),</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+      mGeneratedNameFormat(0) {}</span>
<a href="#l71.49"></a><span id="l71.49"> </span>
<a href="#l71.50"></a><span id="l71.50" class="difflineminus">-nsAbView::~nsAbView()</span>
<a href="#l71.51"></a><span id="l71.51" class="difflineminus">-{</span>
<a href="#l71.52"></a><span id="l71.52" class="difflineplus">+nsAbView::~nsAbView() {</span>
<a href="#l71.53"></a><span id="l71.53">   if (mInitialized) {</span>
<a href="#l71.54"></a><span id="l71.54">     NS_ASSERTION(NS_SUCCEEDED(ClearView()), &quot;failed to close view&quot;);</span>
<a href="#l71.55"></a><span id="l71.55">   }</span>
<a href="#l71.56"></a><span id="l71.56"> }</span>
<a href="#l71.57"></a><span id="l71.57"> </span>
<a href="#l71.58"></a><span id="l71.58" class="difflineminus">-NS_IMETHODIMP nsAbView::ClearView()</span>
<a href="#l71.59"></a><span id="l71.59" class="difflineminus">-{</span>
<a href="#l71.60"></a><span id="l71.60" class="difflineplus">+NS_IMETHODIMP nsAbView::ClearView() {</span>
<a href="#l71.61"></a><span id="l71.61">   mDirectory = nullptr;</span>
<a href="#l71.62"></a><span id="l71.62">   mAbViewListener = nullptr;</span>
<a href="#l71.63"></a><span id="l71.63">   if (mTree) {</span>
<a href="#l71.64"></a><span id="l71.64">     IgnoredErrorResult rv2;</span>
<a href="#l71.65"></a><span id="l71.65">     mTree-&gt;SetView(nullptr, mozilla::dom::CallerType::System, rv2);</span>
<a href="#l71.66"></a><span id="l71.66">   }</span>
<a href="#l71.67"></a><span id="l71.67">   mTree = nullptr;</span>
<a href="#l71.68"></a><span id="l71.68">   mTreeSelection = nullptr;</span>
<a href="#l71.69"></a><span id="l71.69"> </span>
<a href="#l71.70"></a><span id="l71.70" class="difflineminus">-  if (mInitialized)</span>
<a href="#l71.71"></a><span id="l71.71" class="difflineminus">-  {</span>
<a href="#l71.72"></a><span id="l71.72" class="difflineplus">+  if (mInitialized) {</span>
<a href="#l71.73"></a><span id="l71.73">     nsresult rv;</span>
<a href="#l71.74"></a><span id="l71.74">     mInitialized = false;</span>
<a href="#l71.75"></a><span id="l71.75" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pbi(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l71.76"></a><span id="l71.76" class="difflineminus">-                                              &amp;rv));</span>
<a href="#l71.77"></a><span id="l71.77" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.78"></a><span id="l71.78" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pbi(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l71.79"></a><span id="l71.79" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.80"></a><span id="l71.80"> </span>
<a href="#l71.81"></a><span id="l71.81">     rv = pbi-&gt;RemoveObserver(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, this);</span>
<a href="#l71.82"></a><span id="l71.82">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.83"></a><span id="l71.83"> </span>
<a href="#l71.84"></a><span id="l71.84" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l71.85"></a><span id="l71.85" class="difflineminus">-                                                   &amp;rv));</span>
<a href="#l71.86"></a><span id="l71.86" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l71.87"></a><span id="l71.87" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l71.88"></a><span id="l71.88">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.89"></a><span id="l71.89"> </span>
<a href="#l71.90"></a><span id="l71.90">     rv = abManager-&gt;RemoveAddressBookListener(this);</span>
<a href="#l71.91"></a><span id="l71.91">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.92"></a><span id="l71.92">   }</span>
<a href="#l71.93"></a><span id="l71.93"> </span>
<a href="#l71.94"></a><span id="l71.94">   int32_t i = mCards.Length();</span>
<a href="#l71.95"></a><span id="l71.95" class="difflineminus">-  while(i-- &gt; 0)</span>
<a href="#l71.96"></a><span id="l71.96" class="difflineplus">+  while (i-- &gt; 0)</span>
<a href="#l71.97"></a><span id="l71.97">     NS_ASSERTION(NS_SUCCEEDED(RemoveCardAt(i)), &quot;remove card failed&quot;);</span>
<a href="#l71.98"></a><span id="l71.98"> </span>
<a href="#l71.99"></a><span id="l71.99">   return NS_OK;</span>
<a href="#l71.100"></a><span id="l71.100"> }</span>
<a href="#l71.101"></a><span id="l71.101"> </span>
<a href="#l71.102"></a><span id="l71.102" class="difflineminus">-nsresult nsAbView::RemoveCardAt(int32_t row)</span>
<a href="#l71.103"></a><span id="l71.103" class="difflineminus">-{</span>
<a href="#l71.104"></a><span id="l71.104" class="difflineplus">+nsresult nsAbView::RemoveCardAt(int32_t row) {</span>
<a href="#l71.105"></a><span id="l71.105">   nsresult rv;</span>
<a href="#l71.106"></a><span id="l71.106"> </span>
<a href="#l71.107"></a><span id="l71.107">   AbCard *abcard = mCards.ElementAt(row);</span>
<a href="#l71.108"></a><span id="l71.108">   NS_IF_RELEASE(abcard-&gt;card);</span>
<a href="#l71.109"></a><span id="l71.109">   mCards.RemoveElementAt(row);</span>
<a href="#l71.110"></a><span id="l71.110">   PR_FREEIF(abcard-&gt;primaryCollationKey);</span>
<a href="#l71.111"></a><span id="l71.111">   PR_FREEIF(abcard-&gt;secondaryCollationKey);</span>
<a href="#l71.112"></a><span id="l71.112">   PR_FREEIF(abcard);</span>
<a href="#l71.113"></a><span id="l71.113"> </span>
<a href="#l71.114"></a><span id="l71.114" class="difflineminus">-</span>
<a href="#l71.115"></a><span id="l71.115" class="difflineminus">-  // This needs to happen after we remove the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l71.116"></a><span id="l71.116" class="difflineplus">+  // This needs to happen after we remove the card, as RowCountChanged() will</span>
<a href="#l71.117"></a><span id="l71.117" class="difflineplus">+  // call GetRowCount()</span>
<a href="#l71.118"></a><span id="l71.118">   if (mTree) {</span>
<a href="#l71.119"></a><span id="l71.119">     mTree-&gt;RowCountChanged(row, -1);</span>
<a href="#l71.120"></a><span id="l71.120">   }</span>
<a href="#l71.121"></a><span id="l71.121"> </span>
<a href="#l71.122"></a><span id="l71.122">   if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l71.123"></a><span id="l71.123">     rv = mAbViewListener-&gt;OnCountChanged(mCards.Length());</span>
<a href="#l71.124"></a><span id="l71.124" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.125"></a><span id="l71.125" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.126"></a><span id="l71.126">   }</span>
<a href="#l71.127"></a><span id="l71.127">   return NS_OK;</span>
<a href="#l71.128"></a><span id="l71.128"> }</span>
<a href="#l71.129"></a><span id="l71.129"> </span>
<a href="#l71.130"></a><span id="l71.130" class="difflineminus">-nsresult nsAbView::SetGeneratedNameFormatFromPrefs()</span>
<a href="#l71.131"></a><span id="l71.131" class="difflineminus">-{</span>
<a href="#l71.132"></a><span id="l71.132" class="difflineplus">+nsresult nsAbView::SetGeneratedNameFormatFromPrefs() {</span>
<a href="#l71.133"></a><span id="l71.133">   nsresult rv;</span>
<a href="#l71.134"></a><span id="l71.134" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchInt(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l71.135"></a><span id="l71.135" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.136"></a><span id="l71.136" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchInt(</span>
<a href="#l71.137"></a><span id="l71.137" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l71.138"></a><span id="l71.138" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.139"></a><span id="l71.139"> </span>
<a href="#l71.140"></a><span id="l71.140" class="difflineminus">-  return prefBranchInt-&gt;GetIntPref(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, &amp;mGeneratedNameFormat);</span>
<a href="#l71.141"></a><span id="l71.141" class="difflineplus">+  return prefBranchInt-&gt;GetIntPref(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST,</span>
<a href="#l71.142"></a><span id="l71.142" class="difflineplus">+                                   &amp;mGeneratedNameFormat);</span>
<a href="#l71.143"></a><span id="l71.143"> }</span>
<a href="#l71.144"></a><span id="l71.144"> </span>
<a href="#l71.145"></a><span id="l71.145" class="difflineminus">-nsresult nsAbView::Initialize()</span>
<a href="#l71.146"></a><span id="l71.146" class="difflineminus">-{</span>
<a href="#l71.147"></a><span id="l71.147" class="difflineminus">-  if (mInitialized)</span>
<a href="#l71.148"></a><span id="l71.148" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.149"></a><span id="l71.149" class="difflineplus">+nsresult nsAbView::Initialize() {</span>
<a href="#l71.150"></a><span id="l71.150" class="difflineplus">+  if (mInitialized) return NS_OK;</span>
<a href="#l71.151"></a><span id="l71.151"> </span>
<a href="#l71.152"></a><span id="l71.152">   mInitialized = true;</span>
<a href="#l71.153"></a><span id="l71.153"> </span>
<a href="#l71.154"></a><span id="l71.154">   nsresult rv;</span>
<a href="#l71.155"></a><span id="l71.155">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l71.156"></a><span id="l71.156">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.157"></a><span id="l71.157"> </span>
<a href="#l71.158"></a><span id="l71.158">   rv = abManager-&gt;AddAddressBookListener(this, nsIAbListener::all);</span>
<a href="#l71.159"></a><span id="l71.159">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.160"></a><span id="l71.160"> </span>
<a href="#l71.161"></a><span id="l71.161">   nsCOMPtr&lt;nsIPrefBranch&gt; pbi(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l71.162"></a><span id="l71.162">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.163"></a><span id="l71.163"> </span>
<a href="#l71.164"></a><span id="l71.164">   rv = pbi-&gt;AddObserver(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, this, false);</span>
<a href="#l71.165"></a><span id="l71.165">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.166"></a><span id="l71.166"> </span>
<a href="#l71.167"></a><span id="l71.167" class="difflineminus">-  if (!mABBundle)</span>
<a href="#l71.168"></a><span id="l71.168" class="difflineminus">-  {</span>
<a href="#l71.169"></a><span id="l71.169" class="difflineplus">+  if (!mABBundle) {</span>
<a href="#l71.170"></a><span id="l71.170">     nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l71.171"></a><span id="l71.171" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l71.172"></a><span id="l71.172" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l71.173"></a><span id="l71.173">     NS_ENSURE_TRUE(stringBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l71.174"></a><span id="l71.174"> </span>
<a href="#l71.175"></a><span id="l71.175" class="difflineminus">-    rv = stringBundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;, getter_AddRefs(mABBundle));</span>
<a href="#l71.176"></a><span id="l71.176" class="difflineplus">+    rv = stringBundleService-&gt;CreateBundle(</span>
<a href="#l71.177"></a><span id="l71.177" class="difflineplus">+        &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l71.178"></a><span id="l71.178" class="difflineplus">+        getter_AddRefs(mABBundle));</span>
<a href="#l71.179"></a><span id="l71.179">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.180"></a><span id="l71.180">   }</span>
<a href="#l71.181"></a><span id="l71.181"> </span>
<a href="#l71.182"></a><span id="l71.182">   return SetGeneratedNameFormatFromPrefs();</span>
<a href="#l71.183"></a><span id="l71.183"> }</span>
<a href="#l71.184"></a><span id="l71.184"> </span>
<a href="#l71.185"></a><span id="l71.185"> NS_IMETHODIMP nsAbView::SetView(nsIAbDirectory *aAddressBook,</span>
<a href="#l71.186"></a><span id="l71.186">                                 nsIAbViewListener *aAbViewListener,</span>
<a href="#l71.187"></a><span id="l71.187">                                 const nsAString &amp;aSortColumn,</span>
<a href="#l71.188"></a><span id="l71.188">                                 const nsAString &amp;aSortDirection,</span>
<a href="#l71.189"></a><span id="l71.189" class="difflineminus">-                                nsAString &amp;aResult)</span>
<a href="#l71.190"></a><span id="l71.190" class="difflineminus">-{</span>
<a href="#l71.191"></a><span id="l71.191" class="difflineplus">+                                nsAString &amp;aResult) {</span>
<a href="#l71.192"></a><span id="l71.192">   // Ensure we are initialized</span>
<a href="#l71.193"></a><span id="l71.193">   nsresult rv = Initialize();</span>
<a href="#l71.194"></a><span id="l71.194"> </span>
<a href="#l71.195"></a><span id="l71.195">   mAbViewListener = nullptr;</span>
<a href="#l71.196"></a><span id="l71.196" class="difflineminus">-  if (mTree)</span>
<a href="#l71.197"></a><span id="l71.197" class="difflineminus">-  {</span>
<a href="#l71.198"></a><span id="l71.198" class="difflineplus">+  if (mTree) {</span>
<a href="#l71.199"></a><span id="l71.199">     // Try and speed deletion of old cards by disconnecting the tree from us.</span>
<a href="#l71.200"></a><span id="l71.200">     mTreeSelection-&gt;ClearSelection();</span>
<a href="#l71.201"></a><span id="l71.201">     IgnoredErrorResult rv2;</span>
<a href="#l71.202"></a><span id="l71.202">     mTree-&gt;SetView(nullptr, mozilla::dom::CallerType::System, rv2);</span>
<a href="#l71.203"></a><span id="l71.203">   }</span>
<a href="#l71.204"></a><span id="l71.204"> </span>
<a href="#l71.205"></a><span id="l71.205">   // Clear out old cards</span>
<a href="#l71.206"></a><span id="l71.206">   int32_t i = mCards.Length();</span>
<a href="#l71.207"></a><span id="l71.207" class="difflineminus">-  while(i-- &gt; 0)</span>
<a href="#l71.208"></a><span id="l71.208" class="difflineminus">-  {</span>
<a href="#l71.209"></a><span id="l71.209" class="difflineplus">+  while (i-- &gt; 0) {</span>
<a href="#l71.210"></a><span id="l71.210">     rv = RemoveCardAt(i);</span>
<a href="#l71.211"></a><span id="l71.211">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;remove card failed&quot;);</span>
<a href="#l71.212"></a><span id="l71.212">   }</span>
<a href="#l71.213"></a><span id="l71.213"> </span>
<a href="#l71.214"></a><span id="l71.214">   // We replace all cards so any sorting is no longer valid.</span>
<a href="#l71.215"></a><span id="l71.215">   mSortColumn.AssignLiteral(&quot;&quot;);</span>
<a href="#l71.216"></a><span id="l71.216">   mSortDirection.AssignLiteral(&quot;&quot;);</span>
<a href="#l71.217"></a><span id="l71.217"> </span>
<a href="#l71.218"></a><span id="l71.218" class="difflineat">@@ -199,42 +192,41 @@ NS_IMETHODIMP nsAbView::SetView(nsIAbDir</span>
<a href="#l71.219"></a><span id="l71.219">   }</span>
<a href="#l71.220"></a><span id="l71.220"> </span>
<a href="#l71.221"></a><span id="l71.221">   if (Substring(uri, 0, searchBegin).EqualsLiteral(kAllDirectoryRoot)) {</span>
<a href="#l71.222"></a><span id="l71.222">     mIsAllDirectoryRootView = true;</span>
<a href="#l71.223"></a><span id="l71.223">     // We have special request case to search all addressbooks, so we need</span>
<a href="#l71.224"></a><span id="l71.224">     // to iterate over all addressbooks.</span>
<a href="#l71.225"></a><span id="l71.225">     // Since the request is for all addressbooks, the URI must have been</span>
<a href="#l71.226"></a><span id="l71.226">     // passed with an extra '?'. We still check it for sanity and trim it here.</span>
<a href="#l71.227"></a><span id="l71.227" class="difflineminus">-    if (searchQuery.Find(&quot;??&quot;) == 0)</span>
<a href="#l71.228"></a><span id="l71.228" class="difflineminus">-      searchQuery = Substring(searchQuery, 1);</span>
<a href="#l71.229"></a><span id="l71.229" class="difflineplus">+    if (searchQuery.Find(&quot;??&quot;) == 0) searchQuery = Substring(searchQuery, 1);</span>
<a href="#l71.230"></a><span id="l71.230"> </span>
<a href="#l71.231"></a><span id="l71.231" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l71.232"></a><span id="l71.232" class="difflineminus">-                                                   &amp;rv));</span>
<a href="#l71.233"></a><span id="l71.233" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l71.234"></a><span id="l71.234" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l71.235"></a><span id="l71.235">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.236"></a><span id="l71.236">     nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l71.237"></a><span id="l71.237">     rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l71.238"></a><span id="l71.238">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.239"></a><span id="l71.239"> </span>
<a href="#l71.240"></a><span id="l71.240">     bool hasMore = false;</span>
<a href="#l71.241"></a><span id="l71.241">     nsCOMPtr&lt;nsISupports&gt; support;</span>
<a href="#l71.242"></a><span id="l71.242">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l71.243"></a><span id="l71.243">     while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l71.244"></a><span id="l71.244">       rv = enumerator-&gt;GetNext(getter_AddRefs(support));</span>
<a href="#l71.245"></a><span id="l71.245">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.246"></a><span id="l71.246">       directory = do_QueryInterface(support, &amp;rv);</span>
<a href="#l71.247"></a><span id="l71.247"> </span>
<a href="#l71.248"></a><span id="l71.248">       // If, for some reason, we are unable to get a directory, we continue.</span>
<a href="#l71.249"></a><span id="l71.249" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l71.250"></a><span id="l71.250" class="difflineminus">-        continue;</span>
<a href="#l71.251"></a><span id="l71.251" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l71.252"></a><span id="l71.252"> </span>
<a href="#l71.253"></a><span id="l71.253">       // Get appropriate directory with search query.</span>
<a href="#l71.254"></a><span id="l71.254">       nsCString uri;</span>
<a href="#l71.255"></a><span id="l71.255">       directory-&gt;GetURI(uri);</span>
<a href="#l71.256"></a><span id="l71.256" class="difflineminus">-      rv = abManager-&gt;GetDirectory(uri + searchQuery, getter_AddRefs(directory));</span>
<a href="#l71.257"></a><span id="l71.257" class="difflineplus">+      rv =</span>
<a href="#l71.258"></a><span id="l71.258" class="difflineplus">+          abManager-&gt;GetDirectory(uri + searchQuery, getter_AddRefs(directory));</span>
<a href="#l71.259"></a><span id="l71.259">       mDirectory = directory;</span>
<a href="#l71.260"></a><span id="l71.260">       rv = EnumerateCards();</span>
<a href="#l71.261"></a><span id="l71.261">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.262"></a><span id="l71.262">     }</span>
<a href="#l71.263"></a><span id="l71.263">   } else {</span>
<a href="#l71.264"></a><span id="l71.264">     mIsAllDirectoryRootView = false;</span>
<a href="#l71.265"></a><span id="l71.265">     mDirectory = aAddressBook;</span>
<a href="#l71.266"></a><span id="l71.266">     rv = EnumerateCards();</span>
<a href="#l71.267"></a><span id="l71.267" class="difflineat">@@ -246,72 +238,66 @@ NS_IMETHODIMP nsAbView::SetView(nsIAbDir</span>
<a href="#l71.268"></a><span id="l71.268">   // See if the persisted sortColumn is valid.</span>
<a href="#l71.269"></a><span id="l71.269">   // It may not be, if you migrated from older versions, or switched between</span>
<a href="#l71.270"></a><span id="l71.270">   // a mozilla build and a commercial build, which have different columns.</span>
<a href="#l71.271"></a><span id="l71.271">   nsAutoString actualSortColumn;</span>
<a href="#l71.272"></a><span id="l71.272">   if (!generatedNameColumnId.Equals(aSortColumn) &amp;&amp; mCards.Length()) {</span>
<a href="#l71.273"></a><span id="l71.273">     nsIAbCard *card = mCards.ElementAt(0)-&gt;card;</span>
<a href="#l71.274"></a><span id="l71.274">     nsString value;</span>
<a href="#l71.275"></a><span id="l71.275">     // XXX todo</span>
<a href="#l71.276"></a><span id="l71.276" class="difflineminus">-    // Need to check if _Generic is valid.  GetCardValue() will always return NS_OK for _Generic</span>
<a href="#l71.277"></a><span id="l71.277" class="difflineminus">-    // We're going to have to ask mDirectory if it is.</span>
<a href="#l71.278"></a><span id="l71.278" class="difflineminus">-    // It might not be.  example:  _ScreenName is valid in Netscape, but not Mozilla.</span>
<a href="#l71.279"></a><span id="l71.279" class="difflineplus">+    // Need to check if _Generic is valid.  GetCardValue() will always return</span>
<a href="#l71.280"></a><span id="l71.280" class="difflineplus">+    // NS_OK for _Generic We're going to have to ask mDirectory if it is. It</span>
<a href="#l71.281"></a><span id="l71.281" class="difflineplus">+    // might not be.  example:  _ScreenName is valid in Netscape, but not</span>
<a href="#l71.282"></a><span id="l71.282" class="difflineplus">+    // Mozilla.</span>
<a href="#l71.283"></a><span id="l71.283">     rv = GetCardValue(card, aSortColumn, value);</span>
<a href="#l71.284"></a><span id="l71.284">     if (NS_FAILED(rv))</span>
<a href="#l71.285"></a><span id="l71.285">       actualSortColumn = generatedNameColumnId;</span>
<a href="#l71.286"></a><span id="l71.286">     else</span>
<a href="#l71.287"></a><span id="l71.287">       actualSortColumn = aSortColumn;</span>
<a href="#l71.288"></a><span id="l71.288" class="difflineminus">-  }</span>
<a href="#l71.289"></a><span id="l71.289" class="difflineminus">-  else</span>
<a href="#l71.290"></a><span id="l71.290" class="difflineplus">+  } else</span>
<a href="#l71.291"></a><span id="l71.291">     actualSortColumn = aSortColumn;</span>
<a href="#l71.292"></a><span id="l71.292"> </span>
<a href="#l71.293"></a><span id="l71.293" class="difflineminus">-  rv = SortBy(actualSortColumn.get(), PromiseFlatString(aSortDirection).get(), false);</span>
<a href="#l71.294"></a><span id="l71.294" class="difflineplus">+  rv = SortBy(actualSortColumn.get(), PromiseFlatString(aSortDirection).get(),</span>
<a href="#l71.295"></a><span id="l71.295" class="difflineplus">+              false);</span>
<a href="#l71.296"></a><span id="l71.296">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.297"></a><span id="l71.297"> </span>
<a href="#l71.298"></a><span id="l71.298">   mAbViewListener = aAbViewListener;</span>
<a href="#l71.299"></a><span id="l71.299">   if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l71.300"></a><span id="l71.300">     rv = mAbViewListener-&gt;OnCountChanged(mCards.Length());</span>
<a href="#l71.301"></a><span id="l71.301">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.302"></a><span id="l71.302">   }</span>
<a href="#l71.303"></a><span id="l71.303"> </span>
<a href="#l71.304"></a><span id="l71.304">   aResult = actualSortColumn;</span>
<a href="#l71.305"></a><span id="l71.305">   return NS_OK;</span>
<a href="#l71.306"></a><span id="l71.306"> }</span>
<a href="#l71.307"></a><span id="l71.307"> </span>
<a href="#l71.308"></a><span id="l71.308" class="difflineminus">-NS_IMETHODIMP nsAbView::GetDirectory(nsIAbDirectory **aDirectory)</span>
<a href="#l71.309"></a><span id="l71.309" class="difflineminus">-{</span>
<a href="#l71.310"></a><span id="l71.310" class="difflineplus">+NS_IMETHODIMP nsAbView::GetDirectory(nsIAbDirectory **aDirectory) {</span>
<a href="#l71.311"></a><span id="l71.311">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l71.312"></a><span id="l71.312">   NS_IF_ADDREF(*aDirectory = mDirectory);</span>
<a href="#l71.313"></a><span id="l71.313">   return NS_OK;</span>
<a href="#l71.314"></a><span id="l71.314"> }</span>
<a href="#l71.315"></a><span id="l71.315"> </span>
<a href="#l71.316"></a><span id="l71.316" class="difflineminus">-nsresult nsAbView::EnumerateCards()</span>
<a href="#l71.317"></a><span id="l71.317" class="difflineminus">-{</span>
<a href="#l71.318"></a><span id="l71.318" class="difflineplus">+nsresult nsAbView::EnumerateCards() {</span>
<a href="#l71.319"></a><span id="l71.319">   nsresult rv;</span>
<a href="#l71.320"></a><span id="l71.320">   nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l71.321"></a><span id="l71.321">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l71.322"></a><span id="l71.322"> </span>
<a href="#l71.323"></a><span id="l71.323" class="difflineminus">-  if (!mDirectory)</span>
<a href="#l71.324"></a><span id="l71.324" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l71.325"></a><span id="l71.325" class="difflineplus">+  if (!mDirectory) return NS_ERROR_UNEXPECTED;</span>
<a href="#l71.326"></a><span id="l71.326"> </span>
<a href="#l71.327"></a><span id="l71.327">   rv = mDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l71.328"></a><span id="l71.328" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator)</span>
<a href="#l71.329"></a><span id="l71.329" class="difflineminus">-  {</span>
<a href="#l71.330"></a><span id="l71.330" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l71.331"></a><span id="l71.331">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l71.332"></a><span id="l71.332">     bool more;</span>
<a href="#l71.333"></a><span id="l71.333" class="difflineminus">-    while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more)</span>
<a href="#l71.334"></a><span id="l71.334" class="difflineminus">-    {</span>
<a href="#l71.335"></a><span id="l71.335" class="difflineplus">+    while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l71.336"></a><span id="l71.336">       rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l71.337"></a><span id="l71.337" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l71.338"></a><span id="l71.338" class="difflineminus">-      {</span>
<a href="#l71.339"></a><span id="l71.339" class="difflineminus">-        nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l71.340"></a><span id="l71.340" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l71.341"></a><span id="l71.341" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l71.342"></a><span id="l71.342">         // Malloc these from an arena</span>
<a href="#l71.343"></a><span id="l71.343" class="difflineminus">-        AbCard *abcard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l71.344"></a><span id="l71.344" class="difflineminus">-        if (!abcard)</span>
<a href="#l71.345"></a><span id="l71.345" class="difflineminus">-          return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l71.346"></a><span id="l71.346" class="difflineplus">+        AbCard *abcard = (AbCard *)PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l71.347"></a><span id="l71.347" class="difflineplus">+        if (!abcard) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l71.348"></a><span id="l71.348"> </span>
<a href="#l71.349"></a><span id="l71.349">         abcard-&gt;card = card;</span>
<a href="#l71.350"></a><span id="l71.350">         NS_IF_ADDREF(abcard-&gt;card);</span>
<a href="#l71.351"></a><span id="l71.351"> </span>
<a href="#l71.352"></a><span id="l71.352">         // XXX todo</span>
<a href="#l71.353"></a><span id="l71.353">         // Would it be better to do an insertion sort, than append and sort?</span>
<a href="#l71.354"></a><span id="l71.354">         // XXX todo</span>
<a href="#l71.355"></a><span id="l71.355">         // If we knew how many cards there was going to be</span>
<a href="#l71.356"></a><span id="l71.356" class="difflineat">@@ -321,140 +307,121 @@ nsresult nsAbView::EnumerateCards()</span>
<a href="#l71.357"></a><span id="l71.357">         NS_ASSERTION(didAppend, &quot;failed to append card&quot;);</span>
<a href="#l71.358"></a><span id="l71.358">       }</span>
<a href="#l71.359"></a><span id="l71.359">     }</span>
<a href="#l71.360"></a><span id="l71.360">   }</span>
<a href="#l71.361"></a><span id="l71.361"> </span>
<a href="#l71.362"></a><span id="l71.362">   return NS_OK;</span>
<a href="#l71.363"></a><span id="l71.363"> }</span>
<a href="#l71.364"></a><span id="l71.364"> </span>
<a href="#l71.365"></a><span id="l71.365" class="difflineminus">-NS_IMETHODIMP nsAbView::GetRowCount(int32_t *aRowCount)</span>
<a href="#l71.366"></a><span id="l71.366" class="difflineminus">-{</span>
<a href="#l71.367"></a><span id="l71.367" class="difflineplus">+NS_IMETHODIMP nsAbView::GetRowCount(int32_t *aRowCount) {</span>
<a href="#l71.368"></a><span id="l71.368">   *aRowCount = mCards.Length();</span>
<a href="#l71.369"></a><span id="l71.369">   return NS_OK;</span>
<a href="#l71.370"></a><span id="l71.370"> }</span>
<a href="#l71.371"></a><span id="l71.371"> </span>
<a href="#l71.372"></a><span id="l71.372" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSelection(nsITreeSelection * *aSelection)</span>
<a href="#l71.373"></a><span id="l71.373" class="difflineminus">-{</span>
<a href="#l71.374"></a><span id="l71.374" class="difflineplus">+NS_IMETHODIMP nsAbView::GetSelection(nsITreeSelection **aSelection) {</span>
<a href="#l71.375"></a><span id="l71.375">   NS_IF_ADDREF(*aSelection = mTreeSelection);</span>
<a href="#l71.376"></a><span id="l71.376">   return NS_OK;</span>
<a href="#l71.377"></a><span id="l71.377"> }</span>
<a href="#l71.378"></a><span id="l71.378"> </span>
<a href="#l71.379"></a><span id="l71.379" class="difflineminus">-NS_IMETHODIMP nsAbView::SetSelection(nsITreeSelection * aSelection)</span>
<a href="#l71.380"></a><span id="l71.380" class="difflineminus">-{</span>
<a href="#l71.381"></a><span id="l71.381" class="difflineplus">+NS_IMETHODIMP nsAbView::SetSelection(nsITreeSelection *aSelection) {</span>
<a href="#l71.382"></a><span id="l71.382">   mTreeSelection = aSelection;</span>
<a href="#l71.383"></a><span id="l71.383">   return NS_OK;</span>
<a href="#l71.384"></a><span id="l71.384"> }</span>
<a href="#l71.385"></a><span id="l71.385"> </span>
<a href="#l71.386"></a><span id="l71.386" class="difflineminus">-NS_IMETHODIMP nsAbView::GetRowProperties(int32_t index, nsAString&amp; properties)</span>
<a href="#l71.387"></a><span id="l71.387" class="difflineminus">-{</span>
<a href="#l71.388"></a><span id="l71.388" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.389"></a><span id="l71.389" class="difflineplus">+NS_IMETHODIMP nsAbView::GetRowProperties(int32_t index, nsAString &amp;properties) {</span>
<a href="#l71.390"></a><span id="l71.390" class="difflineplus">+  return NS_OK;</span>
<a href="#l71.391"></a><span id="l71.391"> }</span>
<a href="#l71.392"></a><span id="l71.392"> </span>
<a href="#l71.393"></a><span id="l71.393" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellProperties(int32_t row, nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l71.394"></a><span id="l71.394" class="difflineminus">-{</span>
<a href="#l71.395"></a><span id="l71.395" class="difflineplus">+NS_IMETHODIMP nsAbView::GetCellProperties(int32_t row, nsTreeColumn *col,</span>
<a href="#l71.396"></a><span id="l71.396" class="difflineplus">+                                          nsAString &amp;properties) {</span>
<a href="#l71.397"></a><span id="l71.397">   NS_ENSURE_TRUE(row &gt;= 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l71.398"></a><span id="l71.398"> </span>
<a href="#l71.399"></a><span id="l71.399" class="difflineminus">-  if (mCards.Length() &lt;= (size_t)row)</span>
<a href="#l71.400"></a><span id="l71.400" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.401"></a><span id="l71.401" class="difflineplus">+  if (mCards.Length() &lt;= (size_t)row) return NS_OK;</span>
<a href="#l71.402"></a><span id="l71.402"> </span>
<a href="#l71.403"></a><span id="l71.403" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l71.404"></a><span id="l71.404" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l71.405"></a><span id="l71.405">   // &quot;G&quot; == &quot;GeneratedName&quot;</span>
<a href="#l71.406"></a><span id="l71.406" class="difflineminus">-  if (colID.IsEmpty() || colID.First() != 'G')</span>
<a href="#l71.407"></a><span id="l71.407" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.408"></a><span id="l71.408" class="difflineplus">+  if (colID.IsEmpty() || colID.First() != 'G') return NS_OK;</span>
<a href="#l71.409"></a><span id="l71.409"> </span>
<a href="#l71.410"></a><span id="l71.410">   nsIAbCard *card = mCards.ElementAt(row)-&gt;card;</span>
<a href="#l71.411"></a><span id="l71.411"> </span>
<a href="#l71.412"></a><span id="l71.412">   bool isMailList;</span>
<a href="#l71.413"></a><span id="l71.413">   nsresult rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l71.414"></a><span id="l71.414" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.415"></a><span id="l71.415" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.416"></a><span id="l71.416"> </span>
<a href="#l71.417"></a><span id="l71.417" class="difflineminus">-  if (isMailList)</span>
<a href="#l71.418"></a><span id="l71.418" class="difflineminus">-    properties.AssignLiteral(&quot;MailList&quot;);</span>
<a href="#l71.419"></a><span id="l71.419" class="difflineplus">+  if (isMailList) properties.AssignLiteral(&quot;MailList&quot;);</span>
<a href="#l71.420"></a><span id="l71.420"> </span>
<a href="#l71.421"></a><span id="l71.421">   return NS_OK;</span>
<a href="#l71.422"></a><span id="l71.422"> }</span>
<a href="#l71.423"></a><span id="l71.423"> </span>
<a href="#l71.424"></a><span id="l71.424" class="difflineminus">-NS_IMETHODIMP nsAbView::GetColumnProperties(nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l71.425"></a><span id="l71.425" class="difflineminus">-{</span>
<a href="#l71.426"></a><span id="l71.426" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.427"></a><span id="l71.427" class="difflineplus">+NS_IMETHODIMP nsAbView::GetColumnProperties(nsTreeColumn *col,</span>
<a href="#l71.428"></a><span id="l71.428" class="difflineplus">+                                            nsAString &amp;properties) {</span>
<a href="#l71.429"></a><span id="l71.429" class="difflineplus">+  return NS_OK;</span>
<a href="#l71.430"></a><span id="l71.430"> }</span>
<a href="#l71.431"></a><span id="l71.431"> </span>
<a href="#l71.432"></a><span id="l71.432" class="difflineminus">-NS_IMETHODIMP nsAbView::IsContainer(int32_t index, bool *_retval)</span>
<a href="#l71.433"></a><span id="l71.433" class="difflineminus">-{</span>
<a href="#l71.434"></a><span id="l71.434" class="difflineminus">-    *_retval = false;</span>
<a href="#l71.435"></a><span id="l71.435" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.436"></a><span id="l71.436" class="difflineplus">+NS_IMETHODIMP nsAbView::IsContainer(int32_t index, bool *_retval) {</span>
<a href="#l71.437"></a><span id="l71.437" class="difflineplus">+  *_retval = false;</span>
<a href="#l71.438"></a><span id="l71.438" class="difflineplus">+  return NS_OK;</span>
<a href="#l71.439"></a><span id="l71.439"> }</span>
<a href="#l71.440"></a><span id="l71.440"> </span>
<a href="#l71.441"></a><span id="l71.441" class="difflineminus">-NS_IMETHODIMP nsAbView::IsContainerOpen(int32_t index, bool *_retval)</span>
<a href="#l71.442"></a><span id="l71.442" class="difflineminus">-{</span>
<a href="#l71.443"></a><span id="l71.443" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.444"></a><span id="l71.444" class="difflineplus">+NS_IMETHODIMP nsAbView::IsContainerOpen(int32_t index, bool *_retval) {</span>
<a href="#l71.445"></a><span id="l71.445" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.446"></a><span id="l71.446"> }</span>
<a href="#l71.447"></a><span id="l71.447"> </span>
<a href="#l71.448"></a><span id="l71.448" class="difflineminus">-NS_IMETHODIMP nsAbView::IsContainerEmpty(int32_t index, bool *_retval)</span>
<a href="#l71.449"></a><span id="l71.449" class="difflineminus">-{</span>
<a href="#l71.450"></a><span id="l71.450" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.451"></a><span id="l71.451" class="difflineplus">+NS_IMETHODIMP nsAbView::IsContainerEmpty(int32_t index, bool *_retval) {</span>
<a href="#l71.452"></a><span id="l71.452" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.453"></a><span id="l71.453"> }</span>
<a href="#l71.454"></a><span id="l71.454"> </span>
<a href="#l71.455"></a><span id="l71.455" class="difflineminus">-NS_IMETHODIMP nsAbView::IsSeparator(int32_t index, bool *_retval)</span>
<a href="#l71.456"></a><span id="l71.456" class="difflineminus">-{</span>
<a href="#l71.457"></a><span id="l71.457" class="difflineplus">+NS_IMETHODIMP nsAbView::IsSeparator(int32_t index, bool *_retval) {</span>
<a href="#l71.458"></a><span id="l71.458">   *_retval = false;</span>
<a href="#l71.459"></a><span id="l71.459">   return NS_OK;</span>
<a href="#l71.460"></a><span id="l71.460"> }</span>
<a href="#l71.461"></a><span id="l71.461"> </span>
<a href="#l71.462"></a><span id="l71.462" class="difflineminus">-NS_IMETHODIMP nsAbView::IsSorted(bool *_retval)</span>
<a href="#l71.463"></a><span id="l71.463" class="difflineminus">-{</span>
<a href="#l71.464"></a><span id="l71.464" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.465"></a><span id="l71.465" class="difflineplus">+NS_IMETHODIMP nsAbView::IsSorted(bool *_retval) {</span>
<a href="#l71.466"></a><span id="l71.466" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.467"></a><span id="l71.467"> }</span>
<a href="#l71.468"></a><span id="l71.468"> </span>
<a href="#l71.469"></a><span id="l71.469" class="difflineminus">-NS_IMETHODIMP nsAbView::CanDrop(int32_t index,</span>
<a href="#l71.470"></a><span id="l71.470" class="difflineminus">-                                int32_t orientation,</span>
<a href="#l71.471"></a><span id="l71.471" class="difflineplus">+NS_IMETHODIMP nsAbView::CanDrop(int32_t index, int32_t orientation,</span>
<a href="#l71.472"></a><span id="l71.472">                                 mozilla::dom::DataTransfer *dataTransfer,</span>
<a href="#l71.473"></a><span id="l71.473" class="difflineminus">-                                bool *_retval)</span>
<a href="#l71.474"></a><span id="l71.474" class="difflineminus">-{</span>
<a href="#l71.475"></a><span id="l71.475" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.476"></a><span id="l71.476" class="difflineplus">+                                bool *_retval) {</span>
<a href="#l71.477"></a><span id="l71.477" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.478"></a><span id="l71.478"> }</span>
<a href="#l71.479"></a><span id="l71.479"> </span>
<a href="#l71.480"></a><span id="l71.480" class="difflineminus">-NS_IMETHODIMP nsAbView::Drop(int32_t row,</span>
<a href="#l71.481"></a><span id="l71.481" class="difflineminus">-                             int32_t orientation,</span>
<a href="#l71.482"></a><span id="l71.482" class="difflineminus">-                             mozilla::dom::DataTransfer *dataTransfer)</span>
<a href="#l71.483"></a><span id="l71.483" class="difflineminus">-{</span>
<a href="#l71.484"></a><span id="l71.484" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.485"></a><span id="l71.485" class="difflineplus">+NS_IMETHODIMP nsAbView::Drop(int32_t row, int32_t orientation,</span>
<a href="#l71.486"></a><span id="l71.486" class="difflineplus">+                             mozilla::dom::DataTransfer *dataTransfer) {</span>
<a href="#l71.487"></a><span id="l71.487" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.488"></a><span id="l71.488"> }</span>
<a href="#l71.489"></a><span id="l71.489"> </span>
<a href="#l71.490"></a><span id="l71.490" class="difflineminus">-NS_IMETHODIMP nsAbView::GetParentIndex(int32_t rowIndex, int32_t *_retval)</span>
<a href="#l71.491"></a><span id="l71.491" class="difflineminus">-{</span>
<a href="#l71.492"></a><span id="l71.492" class="difflineplus">+NS_IMETHODIMP nsAbView::GetParentIndex(int32_t rowIndex, int32_t *_retval) {</span>
<a href="#l71.493"></a><span id="l71.493">   *_retval = -1;</span>
<a href="#l71.494"></a><span id="l71.494">   return NS_OK;</span>
<a href="#l71.495"></a><span id="l71.495"> }</span>
<a href="#l71.496"></a><span id="l71.496"> </span>
<a href="#l71.497"></a><span id="l71.497" class="difflineminus">-NS_IMETHODIMP nsAbView::HasNextSibling(int32_t rowIndex, int32_t afterIndex, bool *_retval)</span>
<a href="#l71.498"></a><span id="l71.498" class="difflineminus">-{</span>
<a href="#l71.499"></a><span id="l71.499" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.500"></a><span id="l71.500" class="difflineplus">+NS_IMETHODIMP nsAbView::HasNextSibling(int32_t rowIndex, int32_t afterIndex,</span>
<a href="#l71.501"></a><span id="l71.501" class="difflineplus">+                                       bool *_retval) {</span>
<a href="#l71.502"></a><span id="l71.502" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.503"></a><span id="l71.503"> }</span>
<a href="#l71.504"></a><span id="l71.504"> </span>
<a href="#l71.505"></a><span id="l71.505" class="difflineminus">-NS_IMETHODIMP nsAbView::GetLevel(int32_t index, int32_t *_retval)</span>
<a href="#l71.506"></a><span id="l71.506" class="difflineminus">-{</span>
<a href="#l71.507"></a><span id="l71.507" class="difflineplus">+NS_IMETHODIMP nsAbView::GetLevel(int32_t index, int32_t *_retval) {</span>
<a href="#l71.508"></a><span id="l71.508">   *_retval = 0;</span>
<a href="#l71.509"></a><span id="l71.509">   return NS_OK;</span>
<a href="#l71.510"></a><span id="l71.510"> }</span>
<a href="#l71.511"></a><span id="l71.511"> </span>
<a href="#l71.512"></a><span id="l71.512" class="difflineminus">-NS_IMETHODIMP nsAbView::GetImageSrc(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l71.513"></a><span id="l71.513" class="difflineminus">-{</span>
<a href="#l71.514"></a><span id="l71.514" class="difflineplus">+NS_IMETHODIMP nsAbView::GetImageSrc(int32_t row, nsTreeColumn *col,</span>
<a href="#l71.515"></a><span id="l71.515" class="difflineplus">+                                    nsAString &amp;_retval) {</span>
<a href="#l71.516"></a><span id="l71.516">   return NS_OK;</span>
<a href="#l71.517"></a><span id="l71.517"> }</span>
<a href="#l71.518"></a><span id="l71.518"> </span>
<a href="#l71.519"></a><span id="l71.519" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellValue(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l71.520"></a><span id="l71.520" class="difflineminus">-{</span>
<a href="#l71.521"></a><span id="l71.521" class="difflineplus">+NS_IMETHODIMP nsAbView::GetCellValue(int32_t row, nsTreeColumn *col,</span>
<a href="#l71.522"></a><span id="l71.522" class="difflineplus">+                                     nsAString &amp;_retval) {</span>
<a href="#l71.523"></a><span id="l71.523">   return NS_OK;</span>
<a href="#l71.524"></a><span id="l71.524"> }</span>
<a href="#l71.525"></a><span id="l71.525"> </span>
<a href="#l71.526"></a><span id="l71.526" class="difflineminus">-nsresult nsAbView::GetCardValue(nsIAbCard *card, const nsAString&amp; colID,</span>
<a href="#l71.527"></a><span id="l71.527" class="difflineminus">-                                nsAString &amp;_retval)</span>
<a href="#l71.528"></a><span id="l71.528" class="difflineminus">-{</span>
<a href="#l71.529"></a><span id="l71.529" class="difflineplus">+nsresult nsAbView::GetCardValue(nsIAbCard *card, const nsAString &amp;colID,</span>
<a href="#l71.530"></a><span id="l71.530" class="difflineplus">+                                nsAString &amp;_retval) {</span>
<a href="#l71.531"></a><span id="l71.531">   if (colID.EqualsLiteral(&quot;addrbook&quot;)) {</span>
<a href="#l71.532"></a><span id="l71.532">     nsCString dirID;</span>
<a href="#l71.533"></a><span id="l71.533">     nsresult rv = card-&gt;GetDirectoryId(dirID);</span>
<a href="#l71.534"></a><span id="l71.534">     if (NS_SUCCEEDED(rv))</span>
<a href="#l71.535"></a><span id="l71.535">       CopyUTF8toUTF16(Substring(dirID, dirID.FindChar('&amp;') + 1), _retval);</span>
<a href="#l71.536"></a><span id="l71.536"> </span>
<a href="#l71.537"></a><span id="l71.537">     return rv;</span>
<a href="#l71.538"></a><span id="l71.538">   }</span>
<a href="#l71.539"></a><span id="l71.539" class="difflineat">@@ -463,390 +430,386 @@ nsresult nsAbView::GetCardValue(nsIAbCar</span>
<a href="#l71.540"></a><span id="l71.540">   // else, standard column (like PrimaryEmail and _AimScreenName)</span>
<a href="#l71.541"></a><span id="l71.541">   if (colID[0] == char16_t('G'))</span>
<a href="#l71.542"></a><span id="l71.542">     return card-&gt;GenerateName(mGeneratedNameFormat, mABBundle, _retval);</span>
<a href="#l71.543"></a><span id="l71.543"> </span>
<a href="#l71.544"></a><span id="l71.544">   if (colID[0] == char16_t('_') &amp;&amp; colID[1] == char16_t('P'))</span>
<a href="#l71.545"></a><span id="l71.545">     // Use LN/FN order for the phonetic name</span>
<a href="#l71.546"></a><span id="l71.546">     return card-&gt;GeneratePhoneticName(true, _retval);</span>
<a href="#l71.547"></a><span id="l71.547"> </span>
<a href="#l71.548"></a><span id="l71.548" class="difflineminus">-  if (colID.EqualsLiteral(&quot;ChatName&quot;))</span>
<a href="#l71.549"></a><span id="l71.549" class="difflineminus">-    return card-&gt;GenerateChatName(_retval);</span>
<a href="#l71.550"></a><span id="l71.550" class="difflineplus">+  if (colID.EqualsLiteral(&quot;ChatName&quot;)) return card-&gt;GenerateChatName(_retval);</span>
<a href="#l71.551"></a><span id="l71.551"> </span>
<a href="#l71.552"></a><span id="l71.552" class="difflineminus">-  nsresult rv = card-&gt;GetPropertyAsAString(NS_ConvertUTF16toUTF8(colID).get(), _retval);</span>
<a href="#l71.553"></a><span id="l71.553" class="difflineplus">+  nsresult rv =</span>
<a href="#l71.554"></a><span id="l71.554" class="difflineplus">+      card-&gt;GetPropertyAsAString(NS_ConvertUTF16toUTF8(colID).get(), _retval);</span>
<a href="#l71.555"></a><span id="l71.555">   if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l71.556"></a><span id="l71.556">     rv = NS_OK;</span>
<a href="#l71.557"></a><span id="l71.557">     _retval.Truncate();</span>
<a href="#l71.558"></a><span id="l71.558">   }</span>
<a href="#l71.559"></a><span id="l71.559">   return rv;</span>
<a href="#l71.560"></a><span id="l71.560"> }</span>
<a href="#l71.561"></a><span id="l71.561"> </span>
<a href="#l71.562"></a><span id="l71.562" class="difflineminus">-nsresult nsAbView::RefreshTree()</span>
<a href="#l71.563"></a><span id="l71.563" class="difflineminus">-{</span>
<a href="#l71.564"></a><span id="l71.564" class="difflineplus">+nsresult nsAbView::RefreshTree() {</span>
<a href="#l71.565"></a><span id="l71.565">   nsresult rv;</span>
<a href="#l71.566"></a><span id="l71.566"> </span>
<a href="#l71.567"></a><span id="l71.567" class="difflineminus">-  // The PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST pref affects how the GeneratedName column looks.</span>
<a href="#l71.568"></a><span id="l71.568" class="difflineminus">-  // so if the GeneratedName is our primary or secondary sort,</span>
<a href="#l71.569"></a><span id="l71.569" class="difflineminus">-  // we need to resort.</span>
<a href="#l71.570"></a><span id="l71.570" class="difflineminus">-  // the same applies for kPhoneticNameColumn</span>
<a href="#l71.571"></a><span id="l71.571" class="difflineplus">+  // The PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST pref affects how the GeneratedName</span>
<a href="#l71.572"></a><span id="l71.572" class="difflineplus">+  // column looks. so if the GeneratedName is our primary or secondary sort, we</span>
<a href="#l71.573"></a><span id="l71.573" class="difflineplus">+  // need to resort. the same applies for kPhoneticNameColumn</span>
<a href="#l71.574"></a><span id="l71.574">   //</span>
<a href="#l71.575"></a><span id="l71.575">   // XXX optimize me</span>
<a href="#l71.576"></a><span id="l71.576">   // PrimaryEmail is always the secondary sort, unless it is currently the</span>
<a href="#l71.577"></a><span id="l71.577">   // primary sort.  So, if PrimaryEmail is the primary sort,</span>
<a href="#l71.578"></a><span id="l71.578">   // GeneratedName might be the secondary sort.</span>
<a href="#l71.579"></a><span id="l71.579">   //</span>
<a href="#l71.580"></a><span id="l71.580">   // One day, we can get fancy and remember what the secondary sort is.</span>
<a href="#l71.581"></a><span id="l71.581" class="difflineminus">-  // We do that, we can fix this code. At best, it will turn a sort into a invalidate.</span>
<a href="#l71.582"></a><span id="l71.582" class="difflineplus">+  // We do that, we can fix this code. At best, it will turn a sort into a</span>
<a href="#l71.583"></a><span id="l71.583" class="difflineplus">+  // invalidate.</span>
<a href="#l71.584"></a><span id="l71.584">   //</span>
<a href="#l71.585"></a><span id="l71.585" class="difflineminus">-  // If neither the primary nor the secondary sorts are GeneratedName (or kPhoneticNameColumn),</span>
<a href="#l71.586"></a><span id="l71.586" class="difflineminus">-  // all we have to do is invalidate (to show the new GeneratedNames),</span>
<a href="#l71.587"></a><span id="l71.587" class="difflineminus">-  // but the sort will not change.</span>
<a href="#l71.588"></a><span id="l71.588" class="difflineplus">+  // If neither the primary nor the secondary sorts are GeneratedName (or</span>
<a href="#l71.589"></a><span id="l71.589" class="difflineplus">+  // kPhoneticNameColumn), all we have to do is invalidate (to show the new</span>
<a href="#l71.590"></a><span id="l71.590" class="difflineplus">+  // GeneratedNames), but the sort will not change.</span>
<a href="#l71.591"></a><span id="l71.591">   if (mSortColumn.EqualsLiteral(GENERATED_NAME_COLUMN_ID) ||</span>
<a href="#l71.592"></a><span id="l71.592">       mSortColumn.EqualsLiteral(kPriEmailProperty) ||</span>
<a href="#l71.593"></a><span id="l71.593">       mSortColumn.EqualsLiteral(kPhoneticNameColumn)) {</span>
<a href="#l71.594"></a><span id="l71.594">     rv = SortBy(mSortColumn.get(), mSortDirection.get(), true);</span>
<a href="#l71.595"></a><span id="l71.595" class="difflineminus">-  }</span>
<a href="#l71.596"></a><span id="l71.596" class="difflineminus">-  else {</span>
<a href="#l71.597"></a><span id="l71.597" class="difflineplus">+  } else {</span>
<a href="#l71.598"></a><span id="l71.598">     rv = InvalidateTree(ALL_ROWS);</span>
<a href="#l71.599"></a><span id="l71.599"> </span>
<a href="#l71.600"></a><span id="l71.600">     // Although the selection hasn't changed, the card that is selected may need</span>
<a href="#l71.601"></a><span id="l71.601">     // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l71.602"></a><span id="l71.602">     // changed to force that update.</span>
<a href="#l71.603"></a><span id="l71.603">     SelectionChangedXPCOM();</span>
<a href="#l71.604"></a><span id="l71.604">   }</span>
<a href="#l71.605"></a><span id="l71.605"> </span>
<a href="#l71.606"></a><span id="l71.606">   return rv;</span>
<a href="#l71.607"></a><span id="l71.607"> }</span>
<a href="#l71.608"></a><span id="l71.608"> </span>
<a href="#l71.609"></a><span id="l71.609" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellText(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l71.610"></a><span id="l71.610" class="difflineminus">-{</span>
<a href="#l71.611"></a><span id="l71.611" class="difflineminus">-  NS_ENSURE_TRUE(row &gt;= 0 &amp;&amp; (size_t)row &lt; mCards.Length(), NS_ERROR_UNEXPECTED);</span>
<a href="#l71.612"></a><span id="l71.612" class="difflineplus">+NS_IMETHODIMP nsAbView::GetCellText(int32_t row, nsTreeColumn *col,</span>
<a href="#l71.613"></a><span id="l71.613" class="difflineplus">+                                    nsAString &amp;_retval) {</span>
<a href="#l71.614"></a><span id="l71.614" class="difflineplus">+  NS_ENSURE_TRUE(row &gt;= 0 &amp;&amp; (size_t)row &lt; mCards.Length(),</span>
<a href="#l71.615"></a><span id="l71.615" class="difflineplus">+                 NS_ERROR_UNEXPECTED);</span>
<a href="#l71.616"></a><span id="l71.616"> </span>
<a href="#l71.617"></a><span id="l71.617">   nsIAbCard *card = mCards.ElementAt(row)-&gt;card;</span>
<a href="#l71.618"></a><span id="l71.618" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l71.619"></a><span id="l71.619" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l71.620"></a><span id="l71.620">   return GetCardValue(card, colID, _retval);</span>
<a href="#l71.621"></a><span id="l71.621"> }</span>
<a href="#l71.622"></a><span id="l71.622"> </span>
<a href="#l71.623"></a><span id="l71.623" class="difflineminus">-NS_IMETHODIMP nsAbView::SetTree(mozilla::dom::XULTreeElement *tree)</span>
<a href="#l71.624"></a><span id="l71.624" class="difflineminus">-{</span>
<a href="#l71.625"></a><span id="l71.625" class="difflineplus">+NS_IMETHODIMP nsAbView::SetTree(mozilla::dom::XULTreeElement *tree) {</span>
<a href="#l71.626"></a><span id="l71.626">   mTree = tree;</span>
<a href="#l71.627"></a><span id="l71.627">   return NS_OK;</span>
<a href="#l71.628"></a><span id="l71.628"> }</span>
<a href="#l71.629"></a><span id="l71.629"> </span>
<a href="#l71.630"></a><span id="l71.630" class="difflineminus">-NS_IMETHODIMP nsAbView::ToggleOpenState(int32_t index)</span>
<a href="#l71.631"></a><span id="l71.631" class="difflineminus">-{</span>
<a href="#l71.632"></a><span id="l71.632" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.633"></a><span id="l71.633" class="difflineplus">+NS_IMETHODIMP nsAbView::ToggleOpenState(int32_t index) {</span>
<a href="#l71.634"></a><span id="l71.634" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.635"></a><span id="l71.635"> }</span>
<a href="#l71.636"></a><span id="l71.636"> </span>
<a href="#l71.637"></a><span id="l71.637" class="difflineminus">-NS_IMETHODIMP nsAbView::CycleHeader(nsTreeColumn* col)</span>
<a href="#l71.638"></a><span id="l71.638" class="difflineminus">-{</span>
<a href="#l71.639"></a><span id="l71.639" class="difflineminus">-  return NS_OK;</span>
<a href="#l71.640"></a><span id="l71.640" class="difflineminus">-}</span>
<a href="#l71.641"></a><span id="l71.641" class="difflineplus">+NS_IMETHODIMP nsAbView::CycleHeader(nsTreeColumn *col) { return NS_OK; }</span>
<a href="#l71.642"></a><span id="l71.642"> </span>
<a href="#l71.643"></a><span id="l71.643" class="difflineminus">-nsresult nsAbView::InvalidateTree(int32_t row)</span>
<a href="#l71.644"></a><span id="l71.644" class="difflineminus">-{</span>
<a href="#l71.645"></a><span id="l71.645" class="difflineminus">-  if (!mTree)</span>
<a href="#l71.646"></a><span id="l71.646" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.647"></a><span id="l71.647" class="difflineplus">+nsresult nsAbView::InvalidateTree(int32_t row) {</span>
<a href="#l71.648"></a><span id="l71.648" class="difflineplus">+  if (!mTree) return NS_OK;</span>
<a href="#l71.649"></a><span id="l71.649"> </span>
<a href="#l71.650"></a><span id="l71.650">   if (row == ALL_ROWS)</span>
<a href="#l71.651"></a><span id="l71.651">     mTree-&gt;Invalidate();</span>
<a href="#l71.652"></a><span id="l71.652">   else</span>
<a href="#l71.653"></a><span id="l71.653">     mTree-&gt;InvalidateRow(row);</span>
<a href="#l71.654"></a><span id="l71.654">   return NS_OK;</span>
<a href="#l71.655"></a><span id="l71.655"> }</span>
<a href="#l71.656"></a><span id="l71.656"> </span>
<a href="#l71.657"></a><span id="l71.657" class="difflineminus">-NS_IMETHODIMP nsAbView::SelectionChangedXPCOM()</span>
<a href="#l71.658"></a><span id="l71.658" class="difflineminus">-{</span>
<a href="#l71.659"></a><span id="l71.659" class="difflineplus">+NS_IMETHODIMP nsAbView::SelectionChangedXPCOM() {</span>
<a href="#l71.660"></a><span id="l71.660">   if (mAbViewListener &amp;&amp; !mSuppressSelectionChange) {</span>
<a href="#l71.661"></a><span id="l71.661">     nsresult rv = mAbViewListener-&gt;OnSelectionChanged();</span>
<a href="#l71.662"></a><span id="l71.662" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.663"></a><span id="l71.663" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.664"></a><span id="l71.664">   }</span>
<a href="#l71.665"></a><span id="l71.665">   return NS_OK;</span>
<a href="#l71.666"></a><span id="l71.666"> }</span>
<a href="#l71.667"></a><span id="l71.667"> </span>
<a href="#l71.668"></a><span id="l71.668" class="difflineminus">-NS_IMETHODIMP nsAbView::CycleCell(int32_t row, nsTreeColumn* col)</span>
<a href="#l71.669"></a><span id="l71.669" class="difflineminus">-{</span>
<a href="#l71.670"></a><span id="l71.670" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.671"></a><span id="l71.671" class="difflineplus">+NS_IMETHODIMP nsAbView::CycleCell(int32_t row, nsTreeColumn *col) {</span>
<a href="#l71.672"></a><span id="l71.672" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.673"></a><span id="l71.673"> }</span>
<a href="#l71.674"></a><span id="l71.674"> </span>
<a href="#l71.675"></a><span id="l71.675" class="difflineminus">-NS_IMETHODIMP nsAbView::IsEditable(int32_t row, nsTreeColumn* col, bool* _retval)</span>
<a href="#l71.676"></a><span id="l71.676" class="difflineminus">-{</span>
<a href="#l71.677"></a><span id="l71.677" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.678"></a><span id="l71.678" class="difflineplus">+NS_IMETHODIMP nsAbView::IsEditable(int32_t row, nsTreeColumn *col,</span>
<a href="#l71.679"></a><span id="l71.679" class="difflineplus">+                                   bool *_retval) {</span>
<a href="#l71.680"></a><span id="l71.680" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.681"></a><span id="l71.681"> }</span>
<a href="#l71.682"></a><span id="l71.682"> </span>
<a href="#l71.683"></a><span id="l71.683" class="difflineminus">-NS_IMETHODIMP nsAbView::SetCellValue(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l71.684"></a><span id="l71.684" class="difflineminus">-{</span>
<a href="#l71.685"></a><span id="l71.685" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.686"></a><span id="l71.686" class="difflineplus">+NS_IMETHODIMP nsAbView::SetCellValue(int32_t row, nsTreeColumn *col,</span>
<a href="#l71.687"></a><span id="l71.687" class="difflineplus">+                                     const nsAString &amp;value) {</span>
<a href="#l71.688"></a><span id="l71.688" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.689"></a><span id="l71.689"> }</span>
<a href="#l71.690"></a><span id="l71.690"> </span>
<a href="#l71.691"></a><span id="l71.691" class="difflineminus">-NS_IMETHODIMP nsAbView::SetCellText(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l71.692"></a><span id="l71.692" class="difflineminus">-{</span>
<a href="#l71.693"></a><span id="l71.693" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.694"></a><span id="l71.694" class="difflineplus">+NS_IMETHODIMP nsAbView::SetCellText(int32_t row, nsTreeColumn *col,</span>
<a href="#l71.695"></a><span id="l71.695" class="difflineplus">+                                    const nsAString &amp;value) {</span>
<a href="#l71.696"></a><span id="l71.696" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.697"></a><span id="l71.697"> }</span>
<a href="#l71.698"></a><span id="l71.698"> </span>
<a href="#l71.699"></a><span id="l71.699" class="difflineminus">-NS_IMETHODIMP nsAbView::PerformAction(const char16_t *action)</span>
<a href="#l71.700"></a><span id="l71.700" class="difflineminus">-{</span>
<a href="#l71.701"></a><span id="l71.701" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.702"></a><span id="l71.702" class="difflineplus">+NS_IMETHODIMP nsAbView::PerformAction(const char16_t *action) {</span>
<a href="#l71.703"></a><span id="l71.703" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.704"></a><span id="l71.704"> }</span>
<a href="#l71.705"></a><span id="l71.705"> </span>
<a href="#l71.706"></a><span id="l71.706" class="difflineminus">-NS_IMETHODIMP nsAbView::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l71.707"></a><span id="l71.707" class="difflineminus">-{</span>
<a href="#l71.708"></a><span id="l71.708" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.709"></a><span id="l71.709" class="difflineplus">+NS_IMETHODIMP nsAbView::PerformActionOnRow(const char16_t *action,</span>
<a href="#l71.710"></a><span id="l71.710" class="difflineplus">+                                           int32_t row) {</span>
<a href="#l71.711"></a><span id="l71.711" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.712"></a><span id="l71.712"> }</span>
<a href="#l71.713"></a><span id="l71.713"> </span>
<a href="#l71.714"></a><span id="l71.714" class="difflineminus">-NS_IMETHODIMP nsAbView::PerformActionOnCell(const char16_t *action, int32_t row, nsTreeColumn* col)</span>
<a href="#l71.715"></a><span id="l71.715" class="difflineminus">-{</span>
<a href="#l71.716"></a><span id="l71.716" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.717"></a><span id="l71.717" class="difflineplus">+NS_IMETHODIMP nsAbView::PerformActionOnCell(const char16_t *action, int32_t row,</span>
<a href="#l71.718"></a><span id="l71.718" class="difflineplus">+                                            nsTreeColumn *col) {</span>
<a href="#l71.719"></a><span id="l71.719" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l71.720"></a><span id="l71.720"> }</span>
<a href="#l71.721"></a><span id="l71.721"> </span>
<a href="#l71.722"></a><span id="l71.722" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCardFromRow(int32_t row, nsIAbCard **aCard)</span>
<a href="#l71.723"></a><span id="l71.723" class="difflineminus">-{</span>
<a href="#l71.724"></a><span id="l71.724" class="difflineplus">+NS_IMETHODIMP nsAbView::GetCardFromRow(int32_t row, nsIAbCard **aCard) {</span>
<a href="#l71.725"></a><span id="l71.725">   *aCard = nullptr;</span>
<a href="#l71.726"></a><span id="l71.726">   NS_ENSURE_TRUE(row &gt;= 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l71.727"></a><span id="l71.727">   if (mCards.Length() &lt;= (size_t)row) {</span>
<a href="#l71.728"></a><span id="l71.728">     return NS_OK;</span>
<a href="#l71.729"></a><span id="l71.729">   }</span>
<a href="#l71.730"></a><span id="l71.730"> </span>
<a href="#l71.731"></a><span id="l71.731">   AbCard *a = mCards.ElementAt(row);</span>
<a href="#l71.732"></a><span id="l71.732" class="difflineminus">-  if (!a)</span>
<a href="#l71.733"></a><span id="l71.733" class="difflineminus">-      return NS_OK;</span>
<a href="#l71.734"></a><span id="l71.734" class="difflineplus">+  if (!a) return NS_OK;</span>
<a href="#l71.735"></a><span id="l71.735"> </span>
<a href="#l71.736"></a><span id="l71.736">   NS_IF_ADDREF(*aCard = a-&gt;card);</span>
<a href="#l71.737"></a><span id="l71.737">   return NS_OK;</span>
<a href="#l71.738"></a><span id="l71.738"> }</span>
<a href="#l71.739"></a><span id="l71.739"> </span>
<a href="#l71.740"></a><span id="l71.740"> #define DESCENDING_SORT_FACTOR -1</span>
<a href="#l71.741"></a><span id="l71.741"> #define ASCENDING_SORT_FACTOR 1</span>
<a href="#l71.742"></a><span id="l71.742"> </span>
<a href="#l71.743"></a><span id="l71.743" class="difflineminus">-typedef struct SortClosure</span>
<a href="#l71.744"></a><span id="l71.744" class="difflineminus">-{</span>
<a href="#l71.745"></a><span id="l71.745" class="difflineplus">+typedef struct SortClosure {</span>
<a href="#l71.746"></a><span id="l71.746">   const char16_t *colID;</span>
<a href="#l71.747"></a><span id="l71.747">   int32_t factor;</span>
<a href="#l71.748"></a><span id="l71.748">   nsAbView *abView;</span>
<a href="#l71.749"></a><span id="l71.749"> } SortClosure;</span>
<a href="#l71.750"></a><span id="l71.750"> </span>
<a href="#l71.751"></a><span id="l71.751" class="difflineminus">-static int</span>
<a href="#l71.752"></a><span id="l71.752" class="difflineminus">-inplaceSortCallback(const AbCard *card1, const AbCard *card2, SortClosure *closure)</span>
<a href="#l71.753"></a><span id="l71.753" class="difflineminus">-{</span>
<a href="#l71.754"></a><span id="l71.754" class="difflineplus">+static int inplaceSortCallback(const AbCard *card1, const AbCard *card2,</span>
<a href="#l71.755"></a><span id="l71.755" class="difflineplus">+                               SortClosure *closure) {</span>
<a href="#l71.756"></a><span id="l71.756">   int32_t sortValue;</span>
<a href="#l71.757"></a><span id="l71.757"> </span>
<a href="#l71.758"></a><span id="l71.758" class="difflineminus">-  // If we are sorting the &quot;PrimaryEmail&quot;, swap the collation keys, as the secondary is always the</span>
<a href="#l71.759"></a><span id="l71.759" class="difflineminus">-  // PrimaryEmail. Use the last primary key as the secondary key.</span>
<a href="#l71.760"></a><span id="l71.760" class="difflineplus">+  // If we are sorting the &quot;PrimaryEmail&quot;, swap the collation keys, as the</span>
<a href="#l71.761"></a><span id="l71.761" class="difflineplus">+  // secondary is always the PrimaryEmail. Use the last primary key as the</span>
<a href="#l71.762"></a><span id="l71.762" class="difflineplus">+  // secondary key.</span>
<a href="#l71.763"></a><span id="l71.763">   //</span>
<a href="#l71.764"></a><span id="l71.764">   // &quot;Pr&quot; to distinguish &quot;PrimaryEmail&quot; from &quot;PagerNumber&quot;</span>
<a href="#l71.765"></a><span id="l71.765" class="difflineminus">-  if (closure-&gt;colID[0] == char16_t('P') &amp;&amp; closure-&gt;colID[1] == char16_t('r')) {</span>
<a href="#l71.766"></a><span id="l71.766" class="difflineminus">-    sortValue = closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;secondaryCollationKey,card1-&gt;secondaryCollationKeyLen,card2-&gt;secondaryCollationKey,card2-&gt;secondaryCollationKeyLen);</span>
<a href="#l71.767"></a><span id="l71.767" class="difflineplus">+  if (closure-&gt;colID[0] == char16_t('P') &amp;&amp;</span>
<a href="#l71.768"></a><span id="l71.768" class="difflineplus">+      closure-&gt;colID[1] == char16_t('r')) {</span>
<a href="#l71.769"></a><span id="l71.769" class="difflineplus">+    sortValue = closure-&gt;abView-&gt;CompareCollationKeys(</span>
<a href="#l71.770"></a><span id="l71.770" class="difflineplus">+        card1-&gt;secondaryCollationKey, card1-&gt;secondaryCollationKeyLen,</span>
<a href="#l71.771"></a><span id="l71.771" class="difflineplus">+        card2-&gt;secondaryCollationKey, card2-&gt;secondaryCollationKeyLen);</span>
<a href="#l71.772"></a><span id="l71.772">     if (sortValue)</span>
<a href="#l71.773"></a><span id="l71.773">       return sortValue * closure-&gt;factor;</span>
<a href="#l71.774"></a><span id="l71.774">     else</span>
<a href="#l71.775"></a><span id="l71.775" class="difflineminus">-      return closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;primaryCollationKey,card1-&gt;primaryCollationKeyLen,card2-&gt;primaryCollationKey,card2-&gt;primaryCollationKeyLen) * (closure-&gt;factor);</span>
<a href="#l71.776"></a><span id="l71.776" class="difflineminus">-  }</span>
<a href="#l71.777"></a><span id="l71.777" class="difflineminus">-  else {</span>
<a href="#l71.778"></a><span id="l71.778" class="difflineminus">-    sortValue = closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;primaryCollationKey,card1-&gt;primaryCollationKeyLen,card2-&gt;primaryCollationKey,card2-&gt;primaryCollationKeyLen);</span>
<a href="#l71.779"></a><span id="l71.779" class="difflineplus">+      return closure-&gt;abView-&gt;CompareCollationKeys(</span>
<a href="#l71.780"></a><span id="l71.780" class="difflineplus">+                 card1-&gt;primaryCollationKey, card1-&gt;primaryCollationKeyLen,</span>
<a href="#l71.781"></a><span id="l71.781" class="difflineplus">+                 card2-&gt;primaryCollationKey, card2-&gt;primaryCollationKeyLen) *</span>
<a href="#l71.782"></a><span id="l71.782" class="difflineplus">+             (closure-&gt;factor);</span>
<a href="#l71.783"></a><span id="l71.783" class="difflineplus">+  } else {</span>
<a href="#l71.784"></a><span id="l71.784" class="difflineplus">+    sortValue = closure-&gt;abView-&gt;CompareCollationKeys(</span>
<a href="#l71.785"></a><span id="l71.785" class="difflineplus">+        card1-&gt;primaryCollationKey, card1-&gt;primaryCollationKeyLen,</span>
<a href="#l71.786"></a><span id="l71.786" class="difflineplus">+        card2-&gt;primaryCollationKey, card2-&gt;primaryCollationKeyLen);</span>
<a href="#l71.787"></a><span id="l71.787">     if (sortValue)</span>
<a href="#l71.788"></a><span id="l71.788">       return sortValue * (closure-&gt;factor);</span>
<a href="#l71.789"></a><span id="l71.789">     else</span>
<a href="#l71.790"></a><span id="l71.790" class="difflineminus">-      return closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;secondaryCollationKey,card1-&gt;secondaryCollationKeyLen,card2-&gt;secondaryCollationKey,card2-&gt;secondaryCollationKeyLen) * (closure-&gt;factor);</span>
<a href="#l71.791"></a><span id="l71.791" class="difflineplus">+      return closure-&gt;abView-&gt;CompareCollationKeys(</span>
<a href="#l71.792"></a><span id="l71.792" class="difflineplus">+                 card1-&gt;secondaryCollationKey, card1-&gt;secondaryCollationKeyLen,</span>
<a href="#l71.793"></a><span id="l71.793" class="difflineplus">+                 card2-&gt;secondaryCollationKey,</span>
<a href="#l71.794"></a><span id="l71.794" class="difflineplus">+                 card2-&gt;secondaryCollationKeyLen) *</span>
<a href="#l71.795"></a><span id="l71.795" class="difflineplus">+             (closure-&gt;factor);</span>
<a href="#l71.796"></a><span id="l71.796">   }</span>
<a href="#l71.797"></a><span id="l71.797"> }</span>
<a href="#l71.798"></a><span id="l71.798"> </span>
<a href="#l71.799"></a><span id="l71.799" class="difflineminus">-static void SetSortClosure(const char16_t *sortColumn, const char16_t *sortDirection, nsAbView *abView, SortClosure *closure)</span>
<a href="#l71.800"></a><span id="l71.800" class="difflineminus">-{</span>
<a href="#l71.801"></a><span id="l71.801" class="difflineplus">+static void SetSortClosure(const char16_t *sortColumn,</span>
<a href="#l71.802"></a><span id="l71.802" class="difflineplus">+                           const char16_t *sortDirection, nsAbView *abView,</span>
<a href="#l71.803"></a><span id="l71.803" class="difflineplus">+                           SortClosure *closure) {</span>
<a href="#l71.804"></a><span id="l71.804">   closure-&gt;colID = sortColumn;</span>
<a href="#l71.805"></a><span id="l71.805"> </span>
<a href="#l71.806"></a><span id="l71.806">   if (sortDirection &amp;&amp; !NS_strcmp(sortDirection, u&quot;descending&quot;))</span>
<a href="#l71.807"></a><span id="l71.807">     closure-&gt;factor = DESCENDING_SORT_FACTOR;</span>
<a href="#l71.808"></a><span id="l71.808">   else</span>
<a href="#l71.809"></a><span id="l71.809">     closure-&gt;factor = ASCENDING_SORT_FACTOR;</span>
<a href="#l71.810"></a><span id="l71.810"> </span>
<a href="#l71.811"></a><span id="l71.811">   closure-&gt;abView = abView;</span>
<a href="#l71.812"></a><span id="l71.812">   return;</span>
<a href="#l71.813"></a><span id="l71.813"> }</span>
<a href="#l71.814"></a><span id="l71.814"> </span>
<a href="#l71.815"></a><span id="l71.815" class="difflineminus">-class CardComparator</span>
<a href="#l71.816"></a><span id="l71.816" class="difflineminus">-{</span>
<a href="#l71.817"></a><span id="l71.817" class="difflineminus">-public:</span>
<a href="#l71.818"></a><span id="l71.818" class="difflineplus">+class CardComparator {</span>
<a href="#l71.819"></a><span id="l71.819" class="difflineplus">+ public:</span>
<a href="#l71.820"></a><span id="l71.820">   void SetClosure(SortClosure *closure) { m_closure = closure; };</span>
<a href="#l71.821"></a><span id="l71.821"> </span>
<a href="#l71.822"></a><span id="l71.822">   bool Equals(const AbCard *a, const AbCard *b) const {</span>
<a href="#l71.823"></a><span id="l71.823">     return inplaceSortCallback(a, b, m_closure) == 0;</span>
<a href="#l71.824"></a><span id="l71.824">   }</span>
<a href="#l71.825"></a><span id="l71.825" class="difflineminus">-  bool LessThan(const AbCard *a, const AbCard *b) const{</span>
<a href="#l71.826"></a><span id="l71.826" class="difflineplus">+  bool LessThan(const AbCard *a, const AbCard *b) const {</span>
<a href="#l71.827"></a><span id="l71.827">     return inplaceSortCallback(a, b, m_closure) &lt; 0;</span>
<a href="#l71.828"></a><span id="l71.828">   }</span>
<a href="#l71.829"></a><span id="l71.829"> </span>
<a href="#l71.830"></a><span id="l71.830" class="difflineminus">-private:</span>
<a href="#l71.831"></a><span id="l71.831" class="difflineplus">+ private:</span>
<a href="#l71.832"></a><span id="l71.832">   SortClosure *m_closure;</span>
<a href="#l71.833"></a><span id="l71.833"> };</span>
<a href="#l71.834"></a><span id="l71.834"> </span>
<a href="#l71.835"></a><span id="l71.835" class="difflineminus">-NS_IMETHODIMP nsAbView::SortBy(const char16_t *colID, const char16_t *sortDir, bool aResort = false)</span>
<a href="#l71.836"></a><span id="l71.836" class="difflineminus">-{</span>
<a href="#l71.837"></a><span id="l71.837" class="difflineplus">+NS_IMETHODIMP nsAbView::SortBy(const char16_t *colID, const char16_t *sortDir,</span>
<a href="#l71.838"></a><span id="l71.838" class="difflineplus">+                               bool aResort = false) {</span>
<a href="#l71.839"></a><span id="l71.839">   nsresult rv;</span>
<a href="#l71.840"></a><span id="l71.840"> </span>
<a href="#l71.841"></a><span id="l71.841">   int32_t count = mCards.Length();</span>
<a href="#l71.842"></a><span id="l71.842"> </span>
<a href="#l71.843"></a><span id="l71.843">   nsAutoString sortColumn;</span>
<a href="#l71.844"></a><span id="l71.844">   if (!colID)</span>
<a href="#l71.845"></a><span id="l71.845" class="difflineminus">-    sortColumn = NS_LITERAL_STRING(GENERATED_NAME_COLUMN_ID);  // default sort column</span>
<a href="#l71.846"></a><span id="l71.846" class="difflineplus">+    sortColumn =</span>
<a href="#l71.847"></a><span id="l71.847" class="difflineplus">+        NS_LITERAL_STRING(GENERATED_NAME_COLUMN_ID);  // default sort column</span>
<a href="#l71.848"></a><span id="l71.848">   else</span>
<a href="#l71.849"></a><span id="l71.849">     sortColumn = colID;</span>
<a href="#l71.850"></a><span id="l71.850"> </span>
<a href="#l71.851"></a><span id="l71.851">   nsAutoString sortDirection;</span>
<a href="#l71.852"></a><span id="l71.852">   if (!sortDir)</span>
<a href="#l71.853"></a><span id="l71.853">     sortDirection = NS_LITERAL_STRING(&quot;ascending&quot;);  // default direction</span>
<a href="#l71.854"></a><span id="l71.854">   else</span>
<a href="#l71.855"></a><span id="l71.855">     sortDirection = sortDir;</span>
<a href="#l71.856"></a><span id="l71.856"> </span>
<a href="#l71.857"></a><span id="l71.857">   if (mSortColumn.Equals(sortColumn) &amp;&amp; !aResort) {</span>
<a href="#l71.858"></a><span id="l71.858">     if (mSortDirection.Equals(sortDir)) {</span>
<a href="#l71.859"></a><span id="l71.859" class="difflineminus">-      // If sortColumn and sortDirection are identical since the last call, do nothing.</span>
<a href="#l71.860"></a><span id="l71.860" class="difflineplus">+      // If sortColumn and sortDirection are identical since the last call, do</span>
<a href="#l71.861"></a><span id="l71.861" class="difflineplus">+      // nothing.</span>
<a href="#l71.862"></a><span id="l71.862">       return NS_OK;</span>
<a href="#l71.863"></a><span id="l71.863">     } else {</span>
<a href="#l71.864"></a><span id="l71.864">       // If we are sorting by how we are already sorted,</span>
<a href="#l71.865"></a><span id="l71.865">       // and just the sort direction changes, just reverse.</span>
<a href="#l71.866"></a><span id="l71.866">       int32_t halfPoint = count / 2;</span>
<a href="#l71.867"></a><span id="l71.867">       for (int32_t i = 0; i &lt; halfPoint; i++) {</span>
<a href="#l71.868"></a><span id="l71.868">         // Swap the elements.</span>
<a href="#l71.869"></a><span id="l71.869">         AbCard *ptr1 = mCards.ElementAt(i);</span>
<a href="#l71.870"></a><span id="l71.870">         AbCard *ptr2 = mCards.ElementAt(count - i - 1);</span>
<a href="#l71.871"></a><span id="l71.871">         mCards.ReplaceElementAt(i, ptr2);</span>
<a href="#l71.872"></a><span id="l71.872">         mCards.ReplaceElementAt(count - i - 1, ptr1);</span>
<a href="#l71.873"></a><span id="l71.873">       }</span>
<a href="#l71.874"></a><span id="l71.874">       mSortDirection = sortDir;</span>
<a href="#l71.875"></a><span id="l71.875">     }</span>
<a href="#l71.876"></a><span id="l71.876" class="difflineminus">-  }</span>
<a href="#l71.877"></a><span id="l71.877" class="difflineminus">-  else {</span>
<a href="#l71.878"></a><span id="l71.878" class="difflineplus">+  } else {</span>
<a href="#l71.879"></a><span id="l71.879">     // Generate collation keys</span>
<a href="#l71.880"></a><span id="l71.880">     for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l71.881"></a><span id="l71.881">       AbCard *abcard = mCards.ElementAt(i);</span>
<a href="#l71.882"></a><span id="l71.882"> </span>
<a href="#l71.883"></a><span id="l71.883">       rv = GenerateCollationKeysForCard(sortColumn, abcard);</span>
<a href="#l71.884"></a><span id="l71.884" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.885"></a><span id="l71.885" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.886"></a><span id="l71.886">     }</span>
<a href="#l71.887"></a><span id="l71.887"> </span>
<a href="#l71.888"></a><span id="l71.888">     // We need to do full sort.</span>
<a href="#l71.889"></a><span id="l71.889">     SortClosure closure;</span>
<a href="#l71.890"></a><span id="l71.890">     SetSortClosure(sortColumn.get(), sortDirection.get(), this, &amp;closure);</span>
<a href="#l71.891"></a><span id="l71.891"> </span>
<a href="#l71.892"></a><span id="l71.892" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; selectedCards = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.893"></a><span id="l71.893" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; selectedCards =</span>
<a href="#l71.894"></a><span id="l71.894" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.895"></a><span id="l71.895">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.896"></a><span id="l71.896"> </span>
<a href="#l71.897"></a><span id="l71.897">     rv = GetSelectedCards(selectedCards);</span>
<a href="#l71.898"></a><span id="l71.898">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.899"></a><span id="l71.899"> </span>
<a href="#l71.900"></a><span id="l71.900">     nsCOMPtr&lt;nsIAbCard&gt; indexCard;</span>
<a href="#l71.901"></a><span id="l71.901"> </span>
<a href="#l71.902"></a><span id="l71.902">     if (mTreeSelection) {</span>
<a href="#l71.903"></a><span id="l71.903">       int32_t currentIndex = -1;</span>
<a href="#l71.904"></a><span id="l71.904"> </span>
<a href="#l71.905"></a><span id="l71.905">       rv = mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex);</span>
<a href="#l71.906"></a><span id="l71.906" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.907"></a><span id="l71.907" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.908"></a><span id="l71.908"> </span>
<a href="#l71.909"></a><span id="l71.909">       if (currentIndex != -1) {</span>
<a href="#l71.910"></a><span id="l71.910">         rv = GetCardFromRow(currentIndex, getter_AddRefs(indexCard));</span>
<a href="#l71.911"></a><span id="l71.911" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.912"></a><span id="l71.912" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.913"></a><span id="l71.913">       }</span>
<a href="#l71.914"></a><span id="l71.914">     }</span>
<a href="#l71.915"></a><span id="l71.915"> </span>
<a href="#l71.916"></a><span id="l71.916">     CardComparator cardComparator;</span>
<a href="#l71.917"></a><span id="l71.917">     cardComparator.SetClosure(&amp;closure);</span>
<a href="#l71.918"></a><span id="l71.918">     mCards.Sort(cardComparator);</span>
<a href="#l71.919"></a><span id="l71.919"> </span>
<a href="#l71.920"></a><span id="l71.920">     rv = ReselectCards(selectedCards, indexCard);</span>
<a href="#l71.921"></a><span id="l71.921">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.922"></a><span id="l71.922"> </span>
<a href="#l71.923"></a><span id="l71.923">     mSortColumn = sortColumn;</span>
<a href="#l71.924"></a><span id="l71.924">     mSortDirection = sortDirection;</span>
<a href="#l71.925"></a><span id="l71.925">   }</span>
<a href="#l71.926"></a><span id="l71.926"> </span>
<a href="#l71.927"></a><span id="l71.927">   rv = InvalidateTree(ALL_ROWS);</span>
<a href="#l71.928"></a><span id="l71.928" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.929"></a><span id="l71.929" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.930"></a><span id="l71.930">   return rv;</span>
<a href="#l71.931"></a><span id="l71.931"> }</span>
<a href="#l71.932"></a><span id="l71.932"> </span>
<a href="#l71.933"></a><span id="l71.933" class="difflineminus">-int32_t nsAbView::CompareCollationKeys(uint8_t *key1, uint32_t len1, uint8_t *key2, uint32_t len2)</span>
<a href="#l71.934"></a><span id="l71.934" class="difflineminus">-{</span>
<a href="#l71.935"></a><span id="l71.935" class="difflineplus">+int32_t nsAbView::CompareCollationKeys(uint8_t *key1, uint32_t len1,</span>
<a href="#l71.936"></a><span id="l71.936" class="difflineplus">+                                       uint8_t *key2, uint32_t len2) {</span>
<a href="#l71.937"></a><span id="l71.937">   NS_ASSERTION(mCollationKeyGenerator, &quot;no key generator&quot;);</span>
<a href="#l71.938"></a><span id="l71.938" class="difflineminus">-  if (!mCollationKeyGenerator)</span>
<a href="#l71.939"></a><span id="l71.939" class="difflineminus">-    return 0;</span>
<a href="#l71.940"></a><span id="l71.940" class="difflineplus">+  if (!mCollationKeyGenerator) return 0;</span>
<a href="#l71.941"></a><span id="l71.941"> </span>
<a href="#l71.942"></a><span id="l71.942">   int32_t result;</span>
<a href="#l71.943"></a><span id="l71.943"> </span>
<a href="#l71.944"></a><span id="l71.944" class="difflineminus">-  nsresult rv = mCollationKeyGenerator-&gt;CompareRawSortKey(key1,len1,key2,len2,&amp;result);</span>
<a href="#l71.945"></a><span id="l71.945" class="difflineplus">+  nsresult rv = mCollationKeyGenerator-&gt;CompareRawSortKey(key1, len1, key2,</span>
<a href="#l71.946"></a><span id="l71.946" class="difflineplus">+                                                          len2, &amp;result);</span>
<a href="#l71.947"></a><span id="l71.947">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;key compare failed&quot;);</span>
<a href="#l71.948"></a><span id="l71.948" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l71.949"></a><span id="l71.949" class="difflineminus">-    result = 0;</span>
<a href="#l71.950"></a><span id="l71.950" class="difflineplus">+  if (NS_FAILED(rv)) result = 0;</span>
<a href="#l71.951"></a><span id="l71.951">   return result;</span>
<a href="#l71.952"></a><span id="l71.952"> }</span>
<a href="#l71.953"></a><span id="l71.953"> </span>
<a href="#l71.954"></a><span id="l71.954" class="difflineminus">-nsresult nsAbView::GenerateCollationKeysForCard(const nsAString&amp; colID, AbCard *abcard)</span>
<a href="#l71.955"></a><span id="l71.955" class="difflineminus">-{</span>
<a href="#l71.956"></a><span id="l71.956" class="difflineplus">+nsresult nsAbView::GenerateCollationKeysForCard(const nsAString &amp;colID,</span>
<a href="#l71.957"></a><span id="l71.957" class="difflineplus">+                                                AbCard *abcard) {</span>
<a href="#l71.958"></a><span id="l71.958">   nsresult rv;</span>
<a href="#l71.959"></a><span id="l71.959">   nsString value;</span>
<a href="#l71.960"></a><span id="l71.960"> </span>
<a href="#l71.961"></a><span id="l71.961" class="difflineminus">-  if (!mCollationKeyGenerator)</span>
<a href="#l71.962"></a><span id="l71.962" class="difflineminus">-  {</span>
<a href="#l71.963"></a><span id="l71.963" class="difflineminus">-    nsCOMPtr &lt;nsICollationFactory&gt; factory = do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;rv);</span>
<a href="#l71.964"></a><span id="l71.964" class="difflineplus">+  if (!mCollationKeyGenerator) {</span>
<a href="#l71.965"></a><span id="l71.965" class="difflineplus">+    nsCOMPtr&lt;nsICollationFactory&gt; factory =</span>
<a href="#l71.966"></a><span id="l71.966" class="difflineplus">+        do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;rv);</span>
<a href="#l71.967"></a><span id="l71.967">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.968"></a><span id="l71.968"> </span>
<a href="#l71.969"></a><span id="l71.969">     rv = factory-&gt;CreateCollation(getter_AddRefs(mCollationKeyGenerator));</span>
<a href="#l71.970"></a><span id="l71.970">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.971"></a><span id="l71.971">   }</span>
<a href="#l71.972"></a><span id="l71.972"> </span>
<a href="#l71.973"></a><span id="l71.973">   rv = GetCardValue(abcard-&gt;card, colID, value);</span>
<a href="#l71.974"></a><span id="l71.974" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.975"></a><span id="l71.975" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.976"></a><span id="l71.976"> </span>
<a href="#l71.977"></a><span id="l71.977">   PR_FREEIF(abcard-&gt;primaryCollationKey);</span>
<a href="#l71.978"></a><span id="l71.978" class="difflineminus">-  rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l71.979"></a><span id="l71.979" class="difflineminus">-    value, &amp;(abcard-&gt;primaryCollationKey), &amp;(abcard-&gt;primaryCollationKeyLen));</span>
<a href="#l71.980"></a><span id="l71.980" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.981"></a><span id="l71.981" class="difflineplus">+  rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(</span>
<a href="#l71.982"></a><span id="l71.982" class="difflineplus">+      nsICollation::kCollationCaseInSensitive, value,</span>
<a href="#l71.983"></a><span id="l71.983" class="difflineplus">+      &amp;(abcard-&gt;primaryCollationKey), &amp;(abcard-&gt;primaryCollationKeyLen));</span>
<a href="#l71.984"></a><span id="l71.984" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.985"></a><span id="l71.985"> </span>
<a href="#l71.986"></a><span id="l71.986">   // Hardcode email to be our secondary key. As we are doing this, just call</span>
<a href="#l71.987"></a><span id="l71.987">   // the card's GetCardValue direct, rather than our own function which will</span>
<a href="#l71.988"></a><span id="l71.988">   // end up doing the same as then we can save a bit of time.</span>
<a href="#l71.989"></a><span id="l71.989">   rv = abcard-&gt;card-&gt;GetPrimaryEmail(value);</span>
<a href="#l71.990"></a><span id="l71.990" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.991"></a><span id="l71.991" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.992"></a><span id="l71.992"> </span>
<a href="#l71.993"></a><span id="l71.993">   PR_FREEIF(abcard-&gt;secondaryCollationKey);</span>
<a href="#l71.994"></a><span id="l71.994" class="difflineminus">-  rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l71.995"></a><span id="l71.995" class="difflineminus">-    value, &amp;(abcard-&gt;secondaryCollationKey), &amp;(abcard-&gt;secondaryCollationKeyLen));</span>
<a href="#l71.996"></a><span id="l71.996" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.997"></a><span id="l71.997" class="difflineplus">+  rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(</span>
<a href="#l71.998"></a><span id="l71.998" class="difflineplus">+      nsICollation::kCollationCaseInSensitive, value,</span>
<a href="#l71.999"></a><span id="l71.999" class="difflineplus">+      &amp;(abcard-&gt;secondaryCollationKey), &amp;(abcard-&gt;secondaryCollationKeyLen));</span>
<a href="#l71.1000"></a><span id="l71.1000" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1001"></a><span id="l71.1001">   return rv;</span>
<a href="#l71.1002"></a><span id="l71.1002"> }</span>
<a href="#l71.1003"></a><span id="l71.1003"> </span>
<a href="#l71.1004"></a><span id="l71.1004"> // A helper method currently returns true if the directory is an LDAP.</span>
<a href="#l71.1005"></a><span id="l71.1005"> // We can tweak this to return true for all Remote Address Books where the</span>
<a href="#l71.1006"></a><span id="l71.1006"> // search is asynchronous.</span>
<a href="#l71.1007"></a><span id="l71.1007" class="difflineminus">-bool isDirectoryRemote(nsCOMPtr&lt;nsIAbDirectory&gt; aDir)</span>
<a href="#l71.1008"></a><span id="l71.1008" class="difflineminus">-{</span>
<a href="#l71.1009"></a><span id="l71.1009" class="difflineplus">+bool isDirectoryRemote(nsCOMPtr&lt;nsIAbDirectory&gt; aDir) {</span>
<a href="#l71.1010"></a><span id="l71.1010">   nsCString uri;</span>
<a href="#l71.1011"></a><span id="l71.1011">   aDir-&gt;GetURI(uri);</span>
<a href="#l71.1012"></a><span id="l71.1012">   return (uri.Find(&quot;moz-abldapdirectory&quot;) != kNotFound);</span>
<a href="#l71.1013"></a><span id="l71.1013"> }</span>
<a href="#l71.1014"></a><span id="l71.1014"> </span>
<a href="#l71.1015"></a><span id="l71.1015"> // A helper method to get the query string for nsIAbDirectory.</span>
<a href="#l71.1016"></a><span id="l71.1016" class="difflineminus">-nsCString getQuery(nsCOMPtr&lt;nsIAbDirectory&gt; aDir)</span>
<a href="#l71.1017"></a><span id="l71.1017" class="difflineminus">-{</span>
<a href="#l71.1018"></a><span id="l71.1018" class="difflineplus">+nsCString getQuery(nsCOMPtr&lt;nsIAbDirectory&gt; aDir) {</span>
<a href="#l71.1019"></a><span id="l71.1019">   nsCString uri;</span>
<a href="#l71.1020"></a><span id="l71.1020">   aDir-&gt;GetURI(uri);</span>
<a href="#l71.1021"></a><span id="l71.1021">   int32_t searchBegin = uri.FindChar('?');</span>
<a href="#l71.1022"></a><span id="l71.1022" class="difflineminus">-  if (searchBegin == kNotFound)</span>
<a href="#l71.1023"></a><span id="l71.1023" class="difflineminus">-    return EmptyCString();</span>
<a href="#l71.1024"></a><span id="l71.1024" class="difflineplus">+  if (searchBegin == kNotFound) return EmptyCString();</span>
<a href="#l71.1025"></a><span id="l71.1025"> </span>
<a href="#l71.1026"></a><span id="l71.1026">   return nsCString(Substring(uri, searchBegin));</span>
<a href="#l71.1027"></a><span id="l71.1027"> }</span>
<a href="#l71.1028"></a><span id="l71.1028"> </span>
<a href="#l71.1029"></a><span id="l71.1029" class="difflineminus">-NS_IMETHODIMP nsAbView::OnItemAdded(nsISupports *parentDir, nsISupports *item)</span>
<a href="#l71.1030"></a><span id="l71.1030" class="difflineminus">-{</span>
<a href="#l71.1031"></a><span id="l71.1031" class="difflineplus">+NS_IMETHODIMP nsAbView::OnItemAdded(nsISupports *parentDir, nsISupports *item) {</span>
<a href="#l71.1032"></a><span id="l71.1032">   if (!mDirectory)  // No address book selected.</span>
<a href="#l71.1033"></a><span id="l71.1033">     return NS_OK;</span>
<a href="#l71.1034"></a><span id="l71.1034"> </span>
<a href="#l71.1035"></a><span id="l71.1035">   nsresult rv;</span>
<a href="#l71.1036"></a><span id="l71.1036" class="difflineminus">-  nsCOMPtr &lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir, &amp;rv);</span>
<a href="#l71.1037"></a><span id="l71.1037" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1038"></a><span id="l71.1038" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir, &amp;rv);</span>
<a href="#l71.1039"></a><span id="l71.1039" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1040"></a><span id="l71.1040"> </span>
<a href="#l71.1041"></a><span id="l71.1041">   bool isRemote = isDirectoryRemote(directory);</span>
<a href="#l71.1042"></a><span id="l71.1042">   // If the search is performed on All Address books, its possible that the LDAP</span>
<a href="#l71.1043"></a><span id="l71.1043">   // results start coming when mDirectory has changed (LDAP search works in an</span>
<a href="#l71.1044"></a><span id="l71.1044">   // asynchronous manner).</span>
<a href="#l71.1045"></a><span id="l71.1045">   // Since the listeners are being added to all nsAbView instances, we need to</span>
<a href="#l71.1046"></a><span id="l71.1046">   // make sure that all the views aren't updated by the listeners.</span>
<a href="#l71.1047"></a><span id="l71.1047">   bool isDirectoryQuery = false;</span>
<a href="#l71.1048"></a><span id="l71.1048" class="difflineat">@@ -856,302 +819,288 @@ NS_IMETHODIMP nsAbView::OnItemAdded(nsIS</span>
<a href="#l71.1049"></a><span id="l71.1049">   directory-&gt;GetIsQuery(&amp;isDirectoryQuery);</span>
<a href="#l71.1050"></a><span id="l71.1050">   // Get the query string for the directory in Advanced AB Search window.</span>
<a href="#l71.1051"></a><span id="l71.1051">   nsCString directoryQuery(getQuery(directory));</span>
<a href="#l71.1052"></a><span id="l71.1052">   // See if the selected directory in Address book main window is a query</span>
<a href="#l71.1053"></a><span id="l71.1053">   // directory.</span>
<a href="#l71.1054"></a><span id="l71.1054">   mDirectory-&gt;GetIsQuery(&amp;isMDirectoryQuery);</span>
<a href="#l71.1055"></a><span id="l71.1055">   // Get the query string for the selected directory in the main AB window.</span>
<a href="#l71.1056"></a><span id="l71.1056">   nsCString mDirectoryQuery(getQuery(mDirectory));</span>
<a href="#l71.1057"></a><span id="l71.1057" class="difflineminus">-  if ((mIsAllDirectoryRootView &amp;&amp; isRemote &amp;&amp;</span>
<a href="#l71.1058"></a><span id="l71.1058" class="difflineminus">-       isDirectoryQuery &amp;&amp; isMDirectoryQuery &amp;&amp;</span>
<a href="#l71.1059"></a><span id="l71.1059" class="difflineminus">-       directoryQuery.Equals(mDirectoryQuery)) ||</span>
<a href="#l71.1060"></a><span id="l71.1060" class="difflineplus">+  if ((mIsAllDirectoryRootView &amp;&amp; isRemote &amp;&amp; isDirectoryQuery &amp;&amp;</span>
<a href="#l71.1061"></a><span id="l71.1061" class="difflineplus">+       isMDirectoryQuery &amp;&amp; directoryQuery.Equals(mDirectoryQuery)) ||</span>
<a href="#l71.1062"></a><span id="l71.1062">       directory.get() == mDirectory.get()) {</span>
<a href="#l71.1063"></a><span id="l71.1063" class="difflineminus">-    nsCOMPtr &lt;nsIAbCard&gt; addedCard = do_QueryInterface(item);</span>
<a href="#l71.1064"></a><span id="l71.1064" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; addedCard = do_QueryInterface(item);</span>
<a href="#l71.1065"></a><span id="l71.1065">     if (addedCard) {</span>
<a href="#l71.1066"></a><span id="l71.1066">       // Malloc these from an arena</span>
<a href="#l71.1067"></a><span id="l71.1067" class="difflineminus">-      AbCard *abcard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l71.1068"></a><span id="l71.1068" class="difflineminus">-      if (!abcard)</span>
<a href="#l71.1069"></a><span id="l71.1069" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l71.1070"></a><span id="l71.1070" class="difflineplus">+      AbCard *abcard = (AbCard *)PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l71.1071"></a><span id="l71.1071" class="difflineplus">+      if (!abcard) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l71.1072"></a><span id="l71.1072"> </span>
<a href="#l71.1073"></a><span id="l71.1073">       abcard-&gt;card = addedCard;</span>
<a href="#l71.1074"></a><span id="l71.1074">       NS_IF_ADDREF(abcard-&gt;card);</span>
<a href="#l71.1075"></a><span id="l71.1075"> </span>
<a href="#l71.1076"></a><span id="l71.1076">       rv = GenerateCollationKeysForCard(mSortColumn, abcard);</span>
<a href="#l71.1077"></a><span id="l71.1077" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1078"></a><span id="l71.1078" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1079"></a><span id="l71.1079"> </span>
<a href="#l71.1080"></a><span id="l71.1080">       int32_t index;</span>
<a href="#l71.1081"></a><span id="l71.1081">       rv = AddCard(abcard, false /* select card */, &amp;index);</span>
<a href="#l71.1082"></a><span id="l71.1082" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1083"></a><span id="l71.1083" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1084"></a><span id="l71.1084">     }</span>
<a href="#l71.1085"></a><span id="l71.1085">   }</span>
<a href="#l71.1086"></a><span id="l71.1086">   return rv;</span>
<a href="#l71.1087"></a><span id="l71.1087"> }</span>
<a href="#l71.1088"></a><span id="l71.1088"> </span>
<a href="#l71.1089"></a><span id="l71.1089" class="difflineminus">-NS_IMETHODIMP nsAbView::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l71.1090"></a><span id="l71.1090" class="difflineminus">-{</span>
<a href="#l71.1091"></a><span id="l71.1091" class="difflineplus">+NS_IMETHODIMP nsAbView::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l71.1092"></a><span id="l71.1092" class="difflineplus">+                                const char16_t *someData) {</span>
<a href="#l71.1093"></a><span id="l71.1093">   if (!strcmp(aTopic, NS_PREFBRANCH_PREFCHANGE_TOPIC_ID)) {</span>
<a href="#l71.1094"></a><span id="l71.1094" class="difflineminus">-    if (nsDependentString(someData).EqualsLiteral(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST)) {</span>
<a href="#l71.1095"></a><span id="l71.1095" class="difflineplus">+    if (nsDependentString(someData).EqualsLiteral(</span>
<a href="#l71.1096"></a><span id="l71.1096" class="difflineplus">+            PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST)) {</span>
<a href="#l71.1097"></a><span id="l71.1097">       nsresult rv = SetGeneratedNameFormatFromPrefs();</span>
<a href="#l71.1098"></a><span id="l71.1098">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1099"></a><span id="l71.1099"> </span>
<a href="#l71.1100"></a><span id="l71.1100">       rv = RefreshTree();</span>
<a href="#l71.1101"></a><span id="l71.1101">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1102"></a><span id="l71.1102">     }</span>
<a href="#l71.1103"></a><span id="l71.1103">   }</span>
<a href="#l71.1104"></a><span id="l71.1104">   return NS_OK;</span>
<a href="#l71.1105"></a><span id="l71.1105"> }</span>
<a href="#l71.1106"></a><span id="l71.1106"> </span>
<a href="#l71.1107"></a><span id="l71.1107" class="difflineminus">-nsresult nsAbView::AddCard(AbCard *abcard, bool selectCardAfterAdding, int32_t *index)</span>
<a href="#l71.1108"></a><span id="l71.1108" class="difflineminus">-{</span>
<a href="#l71.1109"></a><span id="l71.1109" class="difflineplus">+nsresult nsAbView::AddCard(AbCard *abcard, bool selectCardAfterAdding,</span>
<a href="#l71.1110"></a><span id="l71.1110" class="difflineplus">+                           int32_t *index) {</span>
<a href="#l71.1111"></a><span id="l71.1111">   nsresult rv = NS_OK;</span>
<a href="#l71.1112"></a><span id="l71.1112">   NS_ENSURE_ARG_POINTER(abcard);</span>
<a href="#l71.1113"></a><span id="l71.1113"> </span>
<a href="#l71.1114"></a><span id="l71.1114">   *index = FindIndexForInsert(abcard);</span>
<a href="#l71.1115"></a><span id="l71.1115">   mCards.InsertElementAt(*index, abcard);</span>
<a href="#l71.1116"></a><span id="l71.1116"> </span>
<a href="#l71.1117"></a><span id="l71.1117" class="difflineminus">-  // This needs to happen after we insert the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l71.1118"></a><span id="l71.1118" class="difflineminus">-  if (mTree)</span>
<a href="#l71.1119"></a><span id="l71.1119" class="difflineminus">-    mTree-&gt;RowCountChanged(*index, 1);</span>
<a href="#l71.1120"></a><span id="l71.1120" class="difflineplus">+  // This needs to happen after we insert the card, as RowCountChanged() will</span>
<a href="#l71.1121"></a><span id="l71.1121" class="difflineplus">+  // call GetRowCount()</span>
<a href="#l71.1122"></a><span id="l71.1122" class="difflineplus">+  if (mTree) mTree-&gt;RowCountChanged(*index, 1);</span>
<a href="#l71.1123"></a><span id="l71.1123"> </span>
<a href="#l71.1124"></a><span id="l71.1124">   // Checking for mTree here works around core bug 399227</span>
<a href="#l71.1125"></a><span id="l71.1125">   if (selectCardAfterAdding &amp;&amp; mTreeSelection &amp;&amp; mTree) {</span>
<a href="#l71.1126"></a><span id="l71.1126">     mTreeSelection-&gt;SetCurrentIndex(*index);</span>
<a href="#l71.1127"></a><span id="l71.1127">     mTreeSelection-&gt;RangedSelect(*index, *index, false /* augment */);</span>
<a href="#l71.1128"></a><span id="l71.1128">   }</span>
<a href="#l71.1129"></a><span id="l71.1129"> </span>
<a href="#l71.1130"></a><span id="l71.1130">   if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l71.1131"></a><span id="l71.1131">     rv = mAbViewListener-&gt;OnCountChanged(mCards.Length());</span>
<a href="#l71.1132"></a><span id="l71.1132" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1133"></a><span id="l71.1133" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1134"></a><span id="l71.1134">   }</span>
<a href="#l71.1135"></a><span id="l71.1135"> </span>
<a href="#l71.1136"></a><span id="l71.1136">   return rv;</span>
<a href="#l71.1137"></a><span id="l71.1137"> }</span>
<a href="#l71.1138"></a><span id="l71.1138"> </span>
<a href="#l71.1139"></a><span id="l71.1139" class="difflineminus">-int32_t nsAbView::FindIndexForInsert(AbCard *abcard)</span>
<a href="#l71.1140"></a><span id="l71.1140" class="difflineminus">-{</span>
<a href="#l71.1141"></a><span id="l71.1141" class="difflineplus">+int32_t nsAbView::FindIndexForInsert(AbCard *abcard) {</span>
<a href="#l71.1142"></a><span id="l71.1142">   int32_t count = mCards.Length();</span>
<a href="#l71.1143"></a><span id="l71.1143">   int32_t i;</span>
<a href="#l71.1144"></a><span id="l71.1144"> </span>
<a href="#l71.1145"></a><span id="l71.1145">   SortClosure closure;</span>
<a href="#l71.1146"></a><span id="l71.1146">   SetSortClosure(mSortColumn.get(), mSortDirection.get(), this, &amp;closure);</span>
<a href="#l71.1147"></a><span id="l71.1147"> </span>
<a href="#l71.1148"></a><span id="l71.1148">   // XXX todo</span>
<a href="#l71.1149"></a><span id="l71.1149">   // Make this a binary search</span>
<a href="#l71.1150"></a><span id="l71.1150" class="difflineminus">-  for (i=0; i &lt; count; i++) {</span>
<a href="#l71.1151"></a><span id="l71.1151" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l71.1152"></a><span id="l71.1152">     int32_t value = inplaceSortCallback(abcard, mCards.ElementAt(i), &amp;closure);</span>
<a href="#l71.1153"></a><span id="l71.1153">     // XXX Fix me, this is not right for both ascending and descending</span>
<a href="#l71.1154"></a><span id="l71.1154" class="difflineminus">-    if (value &lt;= 0)</span>
<a href="#l71.1155"></a><span id="l71.1155" class="difflineminus">-      break;</span>
<a href="#l71.1156"></a><span id="l71.1156" class="difflineplus">+    if (value &lt;= 0) break;</span>
<a href="#l71.1157"></a><span id="l71.1157">   }</span>
<a href="#l71.1158"></a><span id="l71.1158">   return i;</span>
<a href="#l71.1159"></a><span id="l71.1159"> }</span>
<a href="#l71.1160"></a><span id="l71.1160"> </span>
<a href="#l71.1161"></a><span id="l71.1161" class="difflineminus">-NS_IMETHODIMP nsAbView::OnItemRemoved(nsISupports *parentDir, nsISupports *item)</span>
<a href="#l71.1162"></a><span id="l71.1162" class="difflineminus">-{</span>
<a href="#l71.1163"></a><span id="l71.1163" class="difflineplus">+NS_IMETHODIMP nsAbView::OnItemRemoved(nsISupports *parentDir,</span>
<a href="#l71.1164"></a><span id="l71.1164" class="difflineplus">+                                      nsISupports *item) {</span>
<a href="#l71.1165"></a><span id="l71.1165">   nsresult rv;</span>
<a href="#l71.1166"></a><span id="l71.1166"> </span>
<a href="#l71.1167"></a><span id="l71.1167" class="difflineminus">-  nsCOMPtr &lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir,&amp;rv);</span>
<a href="#l71.1168"></a><span id="l71.1168" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1169"></a><span id="l71.1169" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir, &amp;rv);</span>
<a href="#l71.1170"></a><span id="l71.1170" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1171"></a><span id="l71.1171"> </span>
<a href="#l71.1172"></a><span id="l71.1172">   if (directory.get() == mDirectory.get())</span>
<a href="#l71.1173"></a><span id="l71.1173">     return RemoveCardAndSelectNextCard(item);</span>
<a href="#l71.1174"></a><span id="l71.1174"> </span>
<a href="#l71.1175"></a><span id="l71.1175">   // The pointers aren't the same, are the URI strings similar? This is most</span>
<a href="#l71.1176"></a><span id="l71.1176">   // likely the case if the current directory is a search on a directory.</span>
<a href="#l71.1177"></a><span id="l71.1177">   nsCString currentURI;</span>
<a href="#l71.1178"></a><span id="l71.1178">   rv = mDirectory-&gt;GetURI(currentURI);</span>
<a href="#l71.1179"></a><span id="l71.1179">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1180"></a><span id="l71.1180"> </span>
<a href="#l71.1181"></a><span id="l71.1181">   // If it is a search, it will have something like ?(or(PrimaryEmail...</span>
<a href="#l71.1182"></a><span id="l71.1182">   // on the end of the string, so remove that before comparing</span>
<a href="#l71.1183"></a><span id="l71.1183">   int32_t pos = currentURI.FindChar('?');</span>
<a href="#l71.1184"></a><span id="l71.1184" class="difflineminus">-  if (pos != -1)</span>
<a href="#l71.1185"></a><span id="l71.1185" class="difflineminus">-    currentURI.SetLength(pos);</span>
<a href="#l71.1186"></a><span id="l71.1186" class="difflineplus">+  if (pos != -1) currentURI.SetLength(pos);</span>
<a href="#l71.1187"></a><span id="l71.1187"> </span>
<a href="#l71.1188"></a><span id="l71.1188">   nsCString notifiedURI;</span>
<a href="#l71.1189"></a><span id="l71.1189">   rv = directory-&gt;GetURI(notifiedURI);</span>
<a href="#l71.1190"></a><span id="l71.1190">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1191"></a><span id="l71.1191"> </span>
<a href="#l71.1192"></a><span id="l71.1192" class="difflineminus">-  if (currentURI.Equals(notifiedURI))</span>
<a href="#l71.1193"></a><span id="l71.1193" class="difflineminus">-    return RemoveCardAndSelectNextCard(item);</span>
<a href="#l71.1194"></a><span id="l71.1194" class="difflineplus">+  if (currentURI.Equals(notifiedURI)) return RemoveCardAndSelectNextCard(item);</span>
<a href="#l71.1195"></a><span id="l71.1195"> </span>
<a href="#l71.1196"></a><span id="l71.1196">   return NS_OK;</span>
<a href="#l71.1197"></a><span id="l71.1197"> }</span>
<a href="#l71.1198"></a><span id="l71.1198"> </span>
<a href="#l71.1199"></a><span id="l71.1199" class="difflineminus">-nsresult nsAbView::RemoveCardAndSelectNextCard(nsISupports *item)</span>
<a href="#l71.1200"></a><span id="l71.1200" class="difflineminus">-{</span>
<a href="#l71.1201"></a><span id="l71.1201" class="difflineplus">+nsresult nsAbView::RemoveCardAndSelectNextCard(nsISupports *item) {</span>
<a href="#l71.1202"></a><span id="l71.1202">   nsresult rv = NS_OK;</span>
<a href="#l71.1203"></a><span id="l71.1203" class="difflineminus">-  nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l71.1204"></a><span id="l71.1204" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l71.1205"></a><span id="l71.1205">   if (card) {</span>
<a href="#l71.1206"></a><span id="l71.1206">     int32_t index = FindIndexForCard(card);</span>
<a href="#l71.1207"></a><span id="l71.1207">     if (index != CARD_NOT_FOUND) {</span>
<a href="#l71.1208"></a><span id="l71.1208">       bool selectNextCard = false;</span>
<a href="#l71.1209"></a><span id="l71.1209">       if (mTreeSelection) {</span>
<a href="#l71.1210"></a><span id="l71.1210">         int32_t selectedIndex;</span>
<a href="#l71.1211"></a><span id="l71.1211">         // XXX todo</span>
<a href="#l71.1212"></a><span id="l71.1212">         // Make sure it works if nothing selected</span>
<a href="#l71.1213"></a><span id="l71.1213">         mTreeSelection-&gt;GetCurrentIndex(&amp;selectedIndex);</span>
<a href="#l71.1214"></a><span id="l71.1214" class="difflineminus">-        if (index == selectedIndex)</span>
<a href="#l71.1215"></a><span id="l71.1215" class="difflineminus">-          selectNextCard = true;</span>
<a href="#l71.1216"></a><span id="l71.1216" class="difflineplus">+        if (index == selectedIndex) selectNextCard = true;</span>
<a href="#l71.1217"></a><span id="l71.1217">       }</span>
<a href="#l71.1218"></a><span id="l71.1218"> </span>
<a href="#l71.1219"></a><span id="l71.1219">       rv = RemoveCardAt(index);</span>
<a href="#l71.1220"></a><span id="l71.1220" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1221"></a><span id="l71.1221" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1222"></a><span id="l71.1222"> </span>
<a href="#l71.1223"></a><span id="l71.1223">       if (selectNextCard) {</span>
<a href="#l71.1224"></a><span id="l71.1224" class="difflineminus">-      int32_t count = mCards.Length();</span>
<a href="#l71.1225"></a><span id="l71.1225" class="difflineminus">-      if (count &amp;&amp; mTreeSelection) {</span>
<a href="#l71.1226"></a><span id="l71.1226" class="difflineminus">-        // If we deleted the last card, adjust so we select the new &quot;last&quot; card</span>
<a href="#l71.1227"></a><span id="l71.1227" class="difflineminus">-        if (index &gt;= (count - 1)) {</span>
<a href="#l71.1228"></a><span id="l71.1228" class="difflineminus">-          index = count -1;</span>
<a href="#l71.1229"></a><span id="l71.1229" class="difflineplus">+        int32_t count = mCards.Length();</span>
<a href="#l71.1230"></a><span id="l71.1230" class="difflineplus">+        if (count &amp;&amp; mTreeSelection) {</span>
<a href="#l71.1231"></a><span id="l71.1231" class="difflineplus">+          // If we deleted the last card, adjust so we select the new &quot;last&quot;</span>
<a href="#l71.1232"></a><span id="l71.1232" class="difflineplus">+          // card</span>
<a href="#l71.1233"></a><span id="l71.1233" class="difflineplus">+          if (index &gt;= (count - 1)) {</span>
<a href="#l71.1234"></a><span id="l71.1234" class="difflineplus">+            index = count - 1;</span>
<a href="#l71.1235"></a><span id="l71.1235" class="difflineplus">+          }</span>
<a href="#l71.1236"></a><span id="l71.1236" class="difflineplus">+          mTreeSelection-&gt;SetCurrentIndex(index);</span>
<a href="#l71.1237"></a><span id="l71.1237" class="difflineplus">+          mTreeSelection-&gt;RangedSelect(index, index, false /* augment */);</span>
<a href="#l71.1238"></a><span id="l71.1238">         }</span>
<a href="#l71.1239"></a><span id="l71.1239" class="difflineminus">-        mTreeSelection-&gt;SetCurrentIndex(index);</span>
<a href="#l71.1240"></a><span id="l71.1240" class="difflineminus">-        mTreeSelection-&gt;RangedSelect(index, index, false /* augment */);</span>
<a href="#l71.1241"></a><span id="l71.1241">       }</span>
<a href="#l71.1242"></a><span id="l71.1242">     }</span>
<a href="#l71.1243"></a><span id="l71.1243">   }</span>
<a href="#l71.1244"></a><span id="l71.1244" class="difflineminus">-  }</span>
<a href="#l71.1245"></a><span id="l71.1245">   return rv;</span>
<a href="#l71.1246"></a><span id="l71.1246"> }</span>
<a href="#l71.1247"></a><span id="l71.1247"> </span>
<a href="#l71.1248"></a><span id="l71.1248" class="difflineminus">-int32_t nsAbView::FindIndexForCard(nsIAbCard *card)</span>
<a href="#l71.1249"></a><span id="l71.1249" class="difflineminus">-{</span>
<a href="#l71.1250"></a><span id="l71.1250" class="difflineplus">+int32_t nsAbView::FindIndexForCard(nsIAbCard *card) {</span>
<a href="#l71.1251"></a><span id="l71.1251">   int32_t count = mCards.Length();</span>
<a href="#l71.1252"></a><span id="l71.1252">   int32_t i;</span>
<a href="#l71.1253"></a><span id="l71.1253"> </span>
<a href="#l71.1254"></a><span id="l71.1254" class="difflineminus">-  // You can't implement the binary search here, as all you have is the nsIAbCard</span>
<a href="#l71.1255"></a><span id="l71.1255" class="difflineminus">-  // you might be here because one of the card properties has changed, and that property</span>
<a href="#l71.1256"></a><span id="l71.1256" class="difflineminus">-  // could be the collation key.</span>
<a href="#l71.1257"></a><span id="l71.1257" class="difflineminus">-  for (i=0; i &lt; count; i++) {</span>
<a href="#l71.1258"></a><span id="l71.1258" class="difflineplus">+  // You can't implement the binary search here, as all you have is the</span>
<a href="#l71.1259"></a><span id="l71.1259" class="difflineplus">+  // nsIAbCard you might be here because one of the card properties has changed,</span>
<a href="#l71.1260"></a><span id="l71.1260" class="difflineplus">+  // and that property could be the collation key.</span>
<a href="#l71.1261"></a><span id="l71.1261" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l71.1262"></a><span id="l71.1262">     AbCard *abcard = mCards.ElementAt(i);</span>
<a href="#l71.1263"></a><span id="l71.1263">     bool equals;</span>
<a href="#l71.1264"></a><span id="l71.1264">     nsresult rv = card-&gt;Equals(abcard-&gt;card, &amp;equals);</span>
<a href="#l71.1265"></a><span id="l71.1265">     if (NS_SUCCEEDED(rv) &amp;&amp; equals) {</span>
<a href="#l71.1266"></a><span id="l71.1266">       return i;</span>
<a href="#l71.1267"></a><span id="l71.1267">     }</span>
<a href="#l71.1268"></a><span id="l71.1268">   }</span>
<a href="#l71.1269"></a><span id="l71.1269">   return CARD_NOT_FOUND;</span>
<a href="#l71.1270"></a><span id="l71.1270"> }</span>
<a href="#l71.1271"></a><span id="l71.1271"> </span>
<a href="#l71.1272"></a><span id="l71.1272" class="difflineminus">-NS_IMETHODIMP nsAbView::OnItemPropertyChanged(nsISupports *item, const char *property, const char16_t *oldValue, const char16_t *newValue)</span>
<a href="#l71.1273"></a><span id="l71.1273" class="difflineminus">-{</span>
<a href="#l71.1274"></a><span id="l71.1274" class="difflineplus">+NS_IMETHODIMP nsAbView::OnItemPropertyChanged(nsISupports *item,</span>
<a href="#l71.1275"></a><span id="l71.1275" class="difflineplus">+                                              const char *property,</span>
<a href="#l71.1276"></a><span id="l71.1276" class="difflineplus">+                                              const char16_t *oldValue,</span>
<a href="#l71.1277"></a><span id="l71.1277" class="difflineplus">+                                              const char16_t *newValue) {</span>
<a href="#l71.1278"></a><span id="l71.1278">   nsresult rv;</span>
<a href="#l71.1279"></a><span id="l71.1279"> </span>
<a href="#l71.1280"></a><span id="l71.1280" class="difflineminus">-  nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l71.1281"></a><span id="l71.1281" class="difflineminus">-  if (!card)</span>
<a href="#l71.1282"></a><span id="l71.1282" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1283"></a><span id="l71.1283" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l71.1284"></a><span id="l71.1284" class="difflineplus">+  if (!card) return NS_OK;</span>
<a href="#l71.1285"></a><span id="l71.1285"> </span>
<a href="#l71.1286"></a><span id="l71.1286">   int32_t index = FindIndexForCard(card);</span>
<a href="#l71.1287"></a><span id="l71.1287" class="difflineminus">-  if (index == -1)</span>
<a href="#l71.1288"></a><span id="l71.1288" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1289"></a><span id="l71.1289" class="difflineplus">+  if (index == -1) return NS_OK;</span>
<a href="#l71.1290"></a><span id="l71.1290"> </span>
<a href="#l71.1291"></a><span id="l71.1291">   AbCard *oldCard = mCards.ElementAt(index);</span>
<a href="#l71.1292"></a><span id="l71.1292"> </span>
<a href="#l71.1293"></a><span id="l71.1293">   // Malloc these from an arena</span>
<a href="#l71.1294"></a><span id="l71.1294" class="difflineminus">-  AbCard *newCard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l71.1295"></a><span id="l71.1295" class="difflineminus">-  if (!newCard)</span>
<a href="#l71.1296"></a><span id="l71.1296" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l71.1297"></a><span id="l71.1297" class="difflineplus">+  AbCard *newCard = (AbCard *)PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l71.1298"></a><span id="l71.1298" class="difflineplus">+  if (!newCard) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l71.1299"></a><span id="l71.1299"> </span>
<a href="#l71.1300"></a><span id="l71.1300">   newCard-&gt;card = card;</span>
<a href="#l71.1301"></a><span id="l71.1301">   NS_IF_ADDREF(newCard-&gt;card);</span>
<a href="#l71.1302"></a><span id="l71.1302"> </span>
<a href="#l71.1303"></a><span id="l71.1303">   rv = GenerateCollationKeysForCard(mSortColumn, newCard);</span>
<a href="#l71.1304"></a><span id="l71.1304" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1305"></a><span id="l71.1305" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1306"></a><span id="l71.1306"> </span>
<a href="#l71.1307"></a><span id="l71.1307">   bool cardWasSelected = false;</span>
<a href="#l71.1308"></a><span id="l71.1308"> </span>
<a href="#l71.1309"></a><span id="l71.1309">   if (mTreeSelection) {</span>
<a href="#l71.1310"></a><span id="l71.1310">     rv = mTreeSelection-&gt;IsSelected(index, &amp;cardWasSelected);</span>
<a href="#l71.1311"></a><span id="l71.1311" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1312"></a><span id="l71.1312" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1313"></a><span id="l71.1313">   }</span>
<a href="#l71.1314"></a><span id="l71.1314"> </span>
<a href="#l71.1315"></a><span id="l71.1315" class="difflineminus">-  if (!CompareCollationKeys(newCard-&gt;primaryCollationKey,newCard-&gt;primaryCollationKeyLen,oldCard-&gt;primaryCollationKey,oldCard-&gt;primaryCollationKeyLen)</span>
<a href="#l71.1316"></a><span id="l71.1316" class="difflineminus">-    &amp;&amp; CompareCollationKeys(newCard-&gt;secondaryCollationKey,newCard-&gt;secondaryCollationKeyLen,oldCard-&gt;secondaryCollationKey,oldCard-&gt;secondaryCollationKeyLen)) {</span>
<a href="#l71.1317"></a><span id="l71.1317" class="difflineplus">+  if (!CompareCollationKeys(</span>
<a href="#l71.1318"></a><span id="l71.1318" class="difflineplus">+          newCard-&gt;primaryCollationKey, newCard-&gt;primaryCollationKeyLen,</span>
<a href="#l71.1319"></a><span id="l71.1319" class="difflineplus">+          oldCard-&gt;primaryCollationKey, oldCard-&gt;primaryCollationKeyLen) &amp;&amp;</span>
<a href="#l71.1320"></a><span id="l71.1320" class="difflineplus">+      CompareCollationKeys(</span>
<a href="#l71.1321"></a><span id="l71.1321" class="difflineplus">+          newCard-&gt;secondaryCollationKey, newCard-&gt;secondaryCollationKeyLen,</span>
<a href="#l71.1322"></a><span id="l71.1322" class="difflineplus">+          oldCard-&gt;secondaryCollationKey, oldCard-&gt;secondaryCollationKeyLen)) {</span>
<a href="#l71.1323"></a><span id="l71.1323">     // No need to remove and add, since the collation keys haven't changed.</span>
<a href="#l71.1324"></a><span id="l71.1324">     // Since they haven't changed, the card will sort to the same place.</span>
<a href="#l71.1325"></a><span id="l71.1325">     // We just need to clean up what we allocated.</span>
<a href="#l71.1326"></a><span id="l71.1326">     NS_IF_RELEASE(newCard-&gt;card);</span>
<a href="#l71.1327"></a><span id="l71.1327" class="difflineminus">-    if (newCard-&gt;primaryCollationKey)</span>
<a href="#l71.1328"></a><span id="l71.1328" class="difflineminus">-      free(newCard-&gt;primaryCollationKey);</span>
<a href="#l71.1329"></a><span id="l71.1329" class="difflineminus">-    if (newCard-&gt;secondaryCollationKey)</span>
<a href="#l71.1330"></a><span id="l71.1330" class="difflineminus">-      free(newCard-&gt;secondaryCollationKey);</span>
<a href="#l71.1331"></a><span id="l71.1331" class="difflineplus">+    if (newCard-&gt;primaryCollationKey) free(newCard-&gt;primaryCollationKey);</span>
<a href="#l71.1332"></a><span id="l71.1332" class="difflineplus">+    if (newCard-&gt;secondaryCollationKey) free(newCard-&gt;secondaryCollationKey);</span>
<a href="#l71.1333"></a><span id="l71.1333">     PR_FREEIF(newCard);</span>
<a href="#l71.1334"></a><span id="l71.1334"> </span>
<a href="#l71.1335"></a><span id="l71.1335">     // Still need to invalidate, as the other columns may have changed.</span>
<a href="#l71.1336"></a><span id="l71.1336">     rv = InvalidateTree(index);</span>
<a href="#l71.1337"></a><span id="l71.1337" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1338"></a><span id="l71.1338" class="difflineminus">-  }</span>
<a href="#l71.1339"></a><span id="l71.1339" class="difflineminus">-  else {</span>
<a href="#l71.1340"></a><span id="l71.1340" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1341"></a><span id="l71.1341" class="difflineplus">+  } else {</span>
<a href="#l71.1342"></a><span id="l71.1342">     mSuppressSelectionChange = true;</span>
<a href="#l71.1343"></a><span id="l71.1343">     mSuppressCountChange = true;</span>
<a href="#l71.1344"></a><span id="l71.1344"> </span>
<a href="#l71.1345"></a><span id="l71.1345">     // Remove the old card.</span>
<a href="#l71.1346"></a><span id="l71.1346">     rv = RemoveCardAt(index);</span>
<a href="#l71.1347"></a><span id="l71.1347">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;remove card failed&quot;);</span>
<a href="#l71.1348"></a><span id="l71.1348"> </span>
<a href="#l71.1349"></a><span id="l71.1349" class="difflineminus">-    // Add the card we created, and select it (to restore selection) if it was selected.</span>
<a href="#l71.1350"></a><span id="l71.1350" class="difflineplus">+    // Add the card we created, and select it (to restore selection) if it was</span>
<a href="#l71.1351"></a><span id="l71.1351" class="difflineplus">+    // selected.</span>
<a href="#l71.1352"></a><span id="l71.1352">     rv = AddCard(newCard, cardWasSelected /* select card */, &amp;index);</span>
<a href="#l71.1353"></a><span id="l71.1353">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;add card failed&quot;);</span>
<a href="#l71.1354"></a><span id="l71.1354"> </span>
<a href="#l71.1355"></a><span id="l71.1355">     mSuppressSelectionChange = false;</span>
<a href="#l71.1356"></a><span id="l71.1356">     mSuppressCountChange = false;</span>
<a href="#l71.1357"></a><span id="l71.1357"> </span>
<a href="#l71.1358"></a><span id="l71.1358">     // Ensure restored selection is visible</span>
<a href="#l71.1359"></a><span id="l71.1359" class="difflineminus">-    if (cardWasSelected &amp;&amp; mTree)</span>
<a href="#l71.1360"></a><span id="l71.1360" class="difflineminus">-      mTree-&gt;EnsureRowIsVisible(index);</span>
<a href="#l71.1361"></a><span id="l71.1361" class="difflineplus">+    if (cardWasSelected &amp;&amp; mTree) mTree-&gt;EnsureRowIsVisible(index);</span>
<a href="#l71.1362"></a><span id="l71.1362">   }</span>
<a href="#l71.1363"></a><span id="l71.1363"> </span>
<a href="#l71.1364"></a><span id="l71.1364">   // Although the selection hasn't changed, the card that is selected may need</span>
<a href="#l71.1365"></a><span id="l71.1365">   // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l71.1366"></a><span id="l71.1366">   // changed to force that update.</span>
<a href="#l71.1367"></a><span id="l71.1367" class="difflineminus">-  if (cardWasSelected)</span>
<a href="#l71.1368"></a><span id="l71.1368" class="difflineminus">-    SelectionChangedXPCOM();</span>
<a href="#l71.1369"></a><span id="l71.1369" class="difflineplus">+  if (cardWasSelected) SelectionChangedXPCOM();</span>
<a href="#l71.1370"></a><span id="l71.1370"> </span>
<a href="#l71.1371"></a><span id="l71.1371">   return NS_OK;</span>
<a href="#l71.1372"></a><span id="l71.1372"> }</span>
<a href="#l71.1373"></a><span id="l71.1373"> </span>
<a href="#l71.1374"></a><span id="l71.1374" class="difflineminus">-NS_IMETHODIMP nsAbView::SelectAll()</span>
<a href="#l71.1375"></a><span id="l71.1375" class="difflineminus">-{</span>
<a href="#l71.1376"></a><span id="l71.1376" class="difflineplus">+NS_IMETHODIMP nsAbView::SelectAll() {</span>
<a href="#l71.1377"></a><span id="l71.1377">   if (mTreeSelection &amp;&amp; mTree) {</span>
<a href="#l71.1378"></a><span id="l71.1378">     mTreeSelection-&gt;SelectAll();</span>
<a href="#l71.1379"></a><span id="l71.1379">     mTree-&gt;Invalidate();</span>
<a href="#l71.1380"></a><span id="l71.1380">   }</span>
<a href="#l71.1381"></a><span id="l71.1381">   return NS_OK;</span>
<a href="#l71.1382"></a><span id="l71.1382"> }</span>
<a href="#l71.1383"></a><span id="l71.1383"> </span>
<a href="#l71.1384"></a><span id="l71.1384" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSortDirection(nsAString &amp; aDirection)</span>
<a href="#l71.1385"></a><span id="l71.1385" class="difflineminus">-{</span>
<a href="#l71.1386"></a><span id="l71.1386" class="difflineplus">+NS_IMETHODIMP nsAbView::GetSortDirection(nsAString &amp;aDirection) {</span>
<a href="#l71.1387"></a><span id="l71.1387">   aDirection = mSortDirection;</span>
<a href="#l71.1388"></a><span id="l71.1388">   return NS_OK;</span>
<a href="#l71.1389"></a><span id="l71.1389"> }</span>
<a href="#l71.1390"></a><span id="l71.1390"> </span>
<a href="#l71.1391"></a><span id="l71.1391" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSortColumn(nsAString &amp; aColumn)</span>
<a href="#l71.1392"></a><span id="l71.1392" class="difflineminus">-{</span>
<a href="#l71.1393"></a><span id="l71.1393" class="difflineplus">+NS_IMETHODIMP nsAbView::GetSortColumn(nsAString &amp;aColumn) {</span>
<a href="#l71.1394"></a><span id="l71.1394">   aColumn = mSortColumn;</span>
<a href="#l71.1395"></a><span id="l71.1395">   return NS_OK;</span>
<a href="#l71.1396"></a><span id="l71.1396"> }</span>
<a href="#l71.1397"></a><span id="l71.1397"> </span>
<a href="#l71.1398"></a><span id="l71.1398" class="difflineminus">-nsresult nsAbView::ReselectCards(nsIArray *aCards, nsIAbCard *aIndexCard)</span>
<a href="#l71.1399"></a><span id="l71.1399" class="difflineminus">-{</span>
<a href="#l71.1400"></a><span id="l71.1400" class="difflineplus">+nsresult nsAbView::ReselectCards(nsIArray *aCards, nsIAbCard *aIndexCard) {</span>
<a href="#l71.1401"></a><span id="l71.1401">   uint32_t count;</span>
<a href="#l71.1402"></a><span id="l71.1402">   uint32_t i;</span>
<a href="#l71.1403"></a><span id="l71.1403"> </span>
<a href="#l71.1404"></a><span id="l71.1404" class="difflineminus">-  if (!mTreeSelection || !aCards)</span>
<a href="#l71.1405"></a><span id="l71.1405" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1406"></a><span id="l71.1406" class="difflineplus">+  if (!mTreeSelection || !aCards) return NS_OK;</span>
<a href="#l71.1407"></a><span id="l71.1407"> </span>
<a href="#l71.1408"></a><span id="l71.1408">   nsresult rv = mTreeSelection-&gt;ClearSelection();</span>
<a href="#l71.1409"></a><span id="l71.1409" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1410"></a><span id="l71.1410" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1411"></a><span id="l71.1411"> </span>
<a href="#l71.1412"></a><span id="l71.1412">   rv = aCards-&gt;GetLength(&amp;count);</span>
<a href="#l71.1413"></a><span id="l71.1413">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1414"></a><span id="l71.1414"> </span>
<a href="#l71.1415"></a><span id="l71.1415">   // If we don't have any cards selected, nothing else to do.</span>
<a href="#l71.1416"></a><span id="l71.1416" class="difflineminus">-  if (!count)</span>
<a href="#l71.1417"></a><span id="l71.1417" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1418"></a><span id="l71.1418" class="difflineplus">+  if (!count) return NS_OK;</span>
<a href="#l71.1419"></a><span id="l71.1419"> </span>
<a href="#l71.1420"></a><span id="l71.1420">   for (i = 0; i &lt; count; i++) {</span>
<a href="#l71.1421"></a><span id="l71.1421">     nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryElementAt(aCards, i);</span>
<a href="#l71.1422"></a><span id="l71.1422">     if (card) {</span>
<a href="#l71.1423"></a><span id="l71.1423">       int32_t index = FindIndexForCard(card);</span>
<a href="#l71.1424"></a><span id="l71.1424">       if (index != CARD_NOT_FOUND) {</span>
<a href="#l71.1425"></a><span id="l71.1425">         mTreeSelection-&gt;RangedSelect(index, index, true /* augment */);</span>
<a href="#l71.1426"></a><span id="l71.1426">       }</span>
<a href="#l71.1427"></a><span id="l71.1427" class="difflineat">@@ -1167,266 +1116,256 @@ nsresult nsAbView::ReselectCards(nsIArra</span>
<a href="#l71.1428"></a><span id="l71.1428">     if (mTree) {</span>
<a href="#l71.1429"></a><span id="l71.1429">       mTree-&gt;EnsureRowIsVisible(currentIndex);</span>
<a href="#l71.1430"></a><span id="l71.1430">     }</span>
<a href="#l71.1431"></a><span id="l71.1431">   }</span>
<a href="#l71.1432"></a><span id="l71.1432"> </span>
<a href="#l71.1433"></a><span id="l71.1433">   return NS_OK;</span>
<a href="#l71.1434"></a><span id="l71.1434"> }</span>
<a href="#l71.1435"></a><span id="l71.1435"> </span>
<a href="#l71.1436"></a><span id="l71.1436" class="difflineminus">-NS_IMETHODIMP nsAbView::DeleteSelectedCards()</span>
<a href="#l71.1437"></a><span id="l71.1437" class="difflineminus">-{</span>
<a href="#l71.1438"></a><span id="l71.1438" class="difflineplus">+NS_IMETHODIMP nsAbView::DeleteSelectedCards() {</span>
<a href="#l71.1439"></a><span id="l71.1439">   nsresult rv;</span>
<a href="#l71.1440"></a><span id="l71.1440" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; cardsToDelete = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.1441"></a><span id="l71.1441" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; cardsToDelete =</span>
<a href="#l71.1442"></a><span id="l71.1442" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.1443"></a><span id="l71.1443">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1444"></a><span id="l71.1444"> </span>
<a href="#l71.1445"></a><span id="l71.1445">   rv = GetSelectedCards(cardsToDelete);</span>
<a href="#l71.1446"></a><span id="l71.1446">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1447"></a><span id="l71.1447"> </span>
<a href="#l71.1448"></a><span id="l71.1448">   // mDirectory should not be null</span>
<a href="#l71.1449"></a><span id="l71.1449">   // Bullet proof (and assert) to help figure out bug #127748</span>
<a href="#l71.1450"></a><span id="l71.1450">   NS_ENSURE_TRUE(mDirectory, NS_ERROR_UNEXPECTED);</span>
<a href="#l71.1451"></a><span id="l71.1451"> </span>
<a href="#l71.1452"></a><span id="l71.1452">   rv = mDirectory-&gt;DeleteCards(cardsToDelete);</span>
<a href="#l71.1453"></a><span id="l71.1453">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1454"></a><span id="l71.1454">   return rv;</span>
<a href="#l71.1455"></a><span id="l71.1455"> }</span>
<a href="#l71.1456"></a><span id="l71.1456"> </span>
<a href="#l71.1457"></a><span id="l71.1457" class="difflineminus">-nsresult nsAbView::GetSelectedCards(nsCOMPtr&lt;nsIMutableArray&gt; &amp;aSelectedCards)</span>
<a href="#l71.1458"></a><span id="l71.1458" class="difflineminus">-{</span>
<a href="#l71.1459"></a><span id="l71.1459" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l71.1460"></a><span id="l71.1460" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1461"></a><span id="l71.1461" class="difflineplus">+nsresult nsAbView::GetSelectedCards(nsCOMPtr&lt;nsIMutableArray&gt; &amp;aSelectedCards) {</span>
<a href="#l71.1462"></a><span id="l71.1462" class="difflineplus">+  if (!mTreeSelection) return NS_OK;</span>
<a href="#l71.1463"></a><span id="l71.1463"> </span>
<a href="#l71.1464"></a><span id="l71.1464">   int32_t selectionCount;</span>
<a href="#l71.1465"></a><span id="l71.1465">   nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l71.1466"></a><span id="l71.1466">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1467"></a><span id="l71.1467"> </span>
<a href="#l71.1468"></a><span id="l71.1468" class="difflineminus">-  if (!selectionCount)</span>
<a href="#l71.1469"></a><span id="l71.1469" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1470"></a><span id="l71.1470" class="difflineplus">+  if (!selectionCount) return NS_OK;</span>
<a href="#l71.1471"></a><span id="l71.1471"> </span>
<a href="#l71.1472"></a><span id="l71.1472" class="difflineminus">-  for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l71.1473"></a><span id="l71.1473" class="difflineminus">-  {</span>
<a href="#l71.1474"></a><span id="l71.1474" class="difflineplus">+  for (int32_t i = 0; i &lt; selectionCount; i++) {</span>
<a href="#l71.1475"></a><span id="l71.1475">     int32_t startRange;</span>
<a href="#l71.1476"></a><span id="l71.1476">     int32_t endRange;</span>
<a href="#l71.1477"></a><span id="l71.1477">     rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l71.1478"></a><span id="l71.1478">     NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l71.1479"></a><span id="l71.1479">     int32_t totalCards = mCards.Length();</span>
<a href="#l71.1480"></a><span id="l71.1480" class="difflineminus">-    if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards)</span>
<a href="#l71.1481"></a><span id="l71.1481" class="difflineminus">-    {</span>
<a href="#l71.1482"></a><span id="l71.1482" class="difflineminus">-      for (int32_t rangeIndex = startRange; rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l71.1483"></a><span id="l71.1483" class="difflineplus">+    if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards) {</span>
<a href="#l71.1484"></a><span id="l71.1484" class="difflineplus">+      for (int32_t rangeIndex = startRange;</span>
<a href="#l71.1485"></a><span id="l71.1485" class="difflineplus">+           rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l71.1486"></a><span id="l71.1486">         nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l71.1487"></a><span id="l71.1487">         rv = GetCardFromRow(rangeIndex, getter_AddRefs(abCard));</span>
<a href="#l71.1488"></a><span id="l71.1488" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1489"></a><span id="l71.1489" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1490"></a><span id="l71.1490"> </span>
<a href="#l71.1491"></a><span id="l71.1491">         rv = aSelectedCards-&gt;AppendElement(abCard);</span>
<a href="#l71.1492"></a><span id="l71.1492">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1493"></a><span id="l71.1493">       }</span>
<a href="#l71.1494"></a><span id="l71.1494">     }</span>
<a href="#l71.1495"></a><span id="l71.1495">   }</span>
<a href="#l71.1496"></a><span id="l71.1496"> </span>
<a href="#l71.1497"></a><span id="l71.1497">   return NS_OK;</span>
<a href="#l71.1498"></a><span id="l71.1498"> }</span>
<a href="#l71.1499"></a><span id="l71.1499"> </span>
<a href="#l71.1500"></a><span id="l71.1500" class="difflineminus">-NS_IMETHODIMP nsAbView::SwapFirstNameLastName()</span>
<a href="#l71.1501"></a><span id="l71.1501" class="difflineminus">-{</span>
<a href="#l71.1502"></a><span id="l71.1502" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l71.1503"></a><span id="l71.1503" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1504"></a><span id="l71.1504" class="difflineplus">+NS_IMETHODIMP nsAbView::SwapFirstNameLastName() {</span>
<a href="#l71.1505"></a><span id="l71.1505" class="difflineplus">+  if (!mTreeSelection) return NS_OK;</span>
<a href="#l71.1506"></a><span id="l71.1506"> </span>
<a href="#l71.1507"></a><span id="l71.1507">   int32_t selectionCount;</span>
<a href="#l71.1508"></a><span id="l71.1508">   nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l71.1509"></a><span id="l71.1509">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1510"></a><span id="l71.1510"> </span>
<a href="#l71.1511"></a><span id="l71.1511" class="difflineminus">-  if (!selectionCount)</span>
<a href="#l71.1512"></a><span id="l71.1512" class="difflineminus">-    return NS_OK;</span>
<a href="#l71.1513"></a><span id="l71.1513" class="difflineplus">+  if (!selectionCount) return NS_OK;</span>
<a href="#l71.1514"></a><span id="l71.1514"> </span>
<a href="#l71.1515"></a><span id="l71.1515">   // Prepare for displayname generation</span>
<a href="#l71.1516"></a><span id="l71.1516" class="difflineminus">-  // No cache for pref and bundle since the swap operation is not executed frequently</span>
<a href="#l71.1517"></a><span id="l71.1517" class="difflineplus">+  // No cache for pref and bundle since the swap operation is not executed</span>
<a href="#l71.1518"></a><span id="l71.1518" class="difflineplus">+  // frequently</span>
<a href="#l71.1519"></a><span id="l71.1519">   bool displayNameAutoGeneration;</span>
<a href="#l71.1520"></a><span id="l71.1520">   bool displayNameLastnamefirst = false;</span>
<a href="#l71.1521"></a><span id="l71.1521"> </span>
<a href="#l71.1522"></a><span id="l71.1522" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranchInt(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l71.1523"></a><span id="l71.1523" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranchInt(</span>
<a href="#l71.1524"></a><span id="l71.1524" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l71.1525"></a><span id="l71.1525">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1526"></a><span id="l71.1526"> </span>
<a href="#l71.1527"></a><span id="l71.1527" class="difflineminus">-  rv = pPrefBranchInt-&gt;GetBoolPref(PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION, &amp;displayNameAutoGeneration);</span>
<a href="#l71.1528"></a><span id="l71.1528" class="difflineplus">+  rv = pPrefBranchInt-&gt;GetBoolPref(</span>
<a href="#l71.1529"></a><span id="l71.1529" class="difflineplus">+      PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION,</span>
<a href="#l71.1530"></a><span id="l71.1530" class="difflineplus">+      &amp;displayNameAutoGeneration);</span>
<a href="#l71.1531"></a><span id="l71.1531">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1532"></a><span id="l71.1532"> </span>
<a href="#l71.1533"></a><span id="l71.1533">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l71.1534"></a><span id="l71.1534" class="difflineminus">-  if (displayNameAutoGeneration)</span>
<a href="#l71.1535"></a><span id="l71.1535" class="difflineminus">-  {</span>
<a href="#l71.1536"></a><span id="l71.1536" class="difflineplus">+  if (displayNameAutoGeneration) {</span>
<a href="#l71.1537"></a><span id="l71.1537">     nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l71.1538"></a><span id="l71.1538" class="difflineminus">-    rv = pPrefBranchInt-&gt;GetComplexValue(PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST,</span>
<a href="#l71.1539"></a><span id="l71.1539" class="difflineminus">-                                         NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l71.1540"></a><span id="l71.1540" class="difflineplus">+    rv = pPrefBranchInt-&gt;GetComplexValue(</span>
<a href="#l71.1541"></a><span id="l71.1541" class="difflineplus">+        PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST,</span>
<a href="#l71.1542"></a><span id="l71.1542" class="difflineplus">+        NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l71.1543"></a><span id="l71.1543">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1544"></a><span id="l71.1544"> </span>
<a href="#l71.1545"></a><span id="l71.1545">     nsString str;</span>
<a href="#l71.1546"></a><span id="l71.1546">     pls-&gt;ToString(getter_Copies(str));</span>
<a href="#l71.1547"></a><span id="l71.1547">     displayNameLastnamefirst = str.EqualsLiteral(&quot;true&quot;);</span>
<a href="#l71.1548"></a><span id="l71.1548">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l71.1549"></a><span id="l71.1549" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l71.1550"></a><span id="l71.1550" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l71.1551"></a><span id="l71.1551">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l71.1552"></a><span id="l71.1552"> </span>
<a href="#l71.1553"></a><span id="l71.1553" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l71.1554"></a><span id="l71.1554" class="difflineminus">-                                     getter_AddRefs(bundle));</span>
<a href="#l71.1555"></a><span id="l71.1555" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l71.1556"></a><span id="l71.1556" class="difflineplus">+        &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l71.1557"></a><span id="l71.1557" class="difflineplus">+        getter_AddRefs(bundle));</span>
<a href="#l71.1558"></a><span id="l71.1558">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1559"></a><span id="l71.1559">   }</span>
<a href="#l71.1560"></a><span id="l71.1560"> </span>
<a href="#l71.1561"></a><span id="l71.1561" class="difflineminus">-  for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l71.1562"></a><span id="l71.1562" class="difflineminus">-  {</span>
<a href="#l71.1563"></a><span id="l71.1563" class="difflineplus">+  for (int32_t i = 0; i &lt; selectionCount; i++) {</span>
<a href="#l71.1564"></a><span id="l71.1564">     int32_t startRange;</span>
<a href="#l71.1565"></a><span id="l71.1565">     int32_t endRange;</span>
<a href="#l71.1566"></a><span id="l71.1566">     rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l71.1567"></a><span id="l71.1567">     NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l71.1568"></a><span id="l71.1568">     int32_t totalCards = mCards.Length();</span>
<a href="#l71.1569"></a><span id="l71.1569" class="difflineminus">-    if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards)</span>
<a href="#l71.1570"></a><span id="l71.1570" class="difflineminus">-    {</span>
<a href="#l71.1571"></a><span id="l71.1571" class="difflineminus">-      for (int32_t rangeIndex = startRange; rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l71.1572"></a><span id="l71.1572" class="difflineplus">+    if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards) {</span>
<a href="#l71.1573"></a><span id="l71.1573" class="difflineplus">+      for (int32_t rangeIndex = startRange;</span>
<a href="#l71.1574"></a><span id="l71.1574" class="difflineplus">+           rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l71.1575"></a><span id="l71.1575">         nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l71.1576"></a><span id="l71.1576">         rv = GetCardFromRow(rangeIndex, getter_AddRefs(abCard));</span>
<a href="#l71.1577"></a><span id="l71.1577">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1578"></a><span id="l71.1578"> </span>
<a href="#l71.1579"></a><span id="l71.1579">         // Swap FN/LN</span>
<a href="#l71.1580"></a><span id="l71.1580">         nsAutoString fn, ln;</span>
<a href="#l71.1581"></a><span id="l71.1581">         abCard-&gt;GetFirstName(fn);</span>
<a href="#l71.1582"></a><span id="l71.1582">         abCard-&gt;GetLastName(ln);</span>
<a href="#l71.1583"></a><span id="l71.1583" class="difflineminus">-        if (!fn.IsEmpty() || !ln.IsEmpty())</span>
<a href="#l71.1584"></a><span id="l71.1584" class="difflineminus">-        {</span>
<a href="#l71.1585"></a><span id="l71.1585" class="difflineplus">+        if (!fn.IsEmpty() || !ln.IsEmpty()) {</span>
<a href="#l71.1586"></a><span id="l71.1586">           abCard-&gt;SetFirstName(ln);</span>
<a href="#l71.1587"></a><span id="l71.1587">           abCard-&gt;SetLastName(fn);</span>
<a href="#l71.1588"></a><span id="l71.1588"> </span>
<a href="#l71.1589"></a><span id="l71.1589">           // Generate display name using the new order</span>
<a href="#l71.1590"></a><span id="l71.1590" class="difflineminus">-          if (displayNameAutoGeneration &amp;&amp;</span>
<a href="#l71.1591"></a><span id="l71.1591" class="difflineminus">-              !fn.IsEmpty() &amp;&amp; !ln.IsEmpty())</span>
<a href="#l71.1592"></a><span id="l71.1592" class="difflineminus">-          {</span>
<a href="#l71.1593"></a><span id="l71.1593" class="difflineplus">+          if (displayNameAutoGeneration &amp;&amp; !fn.IsEmpty() &amp;&amp; !ln.IsEmpty()) {</span>
<a href="#l71.1594"></a><span id="l71.1594">             nsString dnLnFn;</span>
<a href="#l71.1595"></a><span id="l71.1595">             nsString dnFnLn;</span>
<a href="#l71.1596"></a><span id="l71.1596">             const char16_t *nameString[2];</span>
<a href="#l71.1597"></a><span id="l71.1597">             const char *formatString;</span>
<a href="#l71.1598"></a><span id="l71.1598"> </span>
<a href="#l71.1599"></a><span id="l71.1599">             // The format should stays the same before/after we swap the names</span>
<a href="#l71.1600"></a><span id="l71.1600" class="difflineminus">-            formatString = displayNameLastnamefirst ?</span>
<a href="#l71.1601"></a><span id="l71.1601" class="difflineminus">-                              &quot;lastFirstFormat&quot; :</span>
<a href="#l71.1602"></a><span id="l71.1602" class="difflineminus">-                              &quot;firstLastFormat&quot;;</span>
<a href="#l71.1603"></a><span id="l71.1603" class="difflineplus">+            formatString = displayNameLastnamefirst ? &quot;lastFirstFormat&quot;</span>
<a href="#l71.1604"></a><span id="l71.1604" class="difflineplus">+                                                    : &quot;firstLastFormat&quot;;</span>
<a href="#l71.1605"></a><span id="l71.1605"> </span>
<a href="#l71.1606"></a><span id="l71.1606" class="difflineminus">-            // Generate both ln/fn and fn/ln combination since we need both later</span>
<a href="#l71.1607"></a><span id="l71.1607" class="difflineminus">-            // to check to see if the current display name was edited</span>
<a href="#l71.1608"></a><span id="l71.1608" class="difflineminus">-            // note that fn/ln still hold the values before the swap</span>
<a href="#l71.1609"></a><span id="l71.1609" class="difflineplus">+            // Generate both ln/fn and fn/ln combination since we need both</span>
<a href="#l71.1610"></a><span id="l71.1610" class="difflineplus">+            // later to check to see if the current display name was edited note</span>
<a href="#l71.1611"></a><span id="l71.1611" class="difflineplus">+            // that fn/ln still hold the values before the swap</span>
<a href="#l71.1612"></a><span id="l71.1612">             nameString[0] = ln.get();</span>
<a href="#l71.1613"></a><span id="l71.1613">             nameString[1] = fn.get();</span>
<a href="#l71.1614"></a><span id="l71.1614" class="difflineminus">-            rv = bundle-&gt;FormatStringFromName(formatString,</span>
<a href="#l71.1615"></a><span id="l71.1615" class="difflineminus">-                                              nameString, 2, dnLnFn);</span>
<a href="#l71.1616"></a><span id="l71.1616" class="difflineplus">+            rv = bundle-&gt;FormatStringFromName(formatString, nameString, 2,</span>
<a href="#l71.1617"></a><span id="l71.1617" class="difflineplus">+                                              dnLnFn);</span>
<a href="#l71.1618"></a><span id="l71.1618">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1619"></a><span id="l71.1619">             nameString[0] = fn.get();</span>
<a href="#l71.1620"></a><span id="l71.1620">             nameString[1] = ln.get();</span>
<a href="#l71.1621"></a><span id="l71.1621" class="difflineminus">-            rv = bundle-&gt;FormatStringFromName(formatString,</span>
<a href="#l71.1622"></a><span id="l71.1622" class="difflineminus">-                                              nameString, 2, dnFnLn);</span>
<a href="#l71.1623"></a><span id="l71.1623" class="difflineplus">+            rv = bundle-&gt;FormatStringFromName(formatString, nameString, 2,</span>
<a href="#l71.1624"></a><span id="l71.1624" class="difflineplus">+                                              dnFnLn);</span>
<a href="#l71.1625"></a><span id="l71.1625">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1626"></a><span id="l71.1626"> </span>
<a href="#l71.1627"></a><span id="l71.1627">             // Get the current display name</span>
<a href="#l71.1628"></a><span id="l71.1628">             nsAutoString dn;</span>
<a href="#l71.1629"></a><span id="l71.1629">             rv = abCard-&gt;GetDisplayName(dn);</span>
<a href="#l71.1630"></a><span id="l71.1630">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1631"></a><span id="l71.1631"> </span>
<a href="#l71.1632"></a><span id="l71.1632">             // Swap the display name if not edited</span>
<a href="#l71.1633"></a><span id="l71.1633" class="difflineminus">-            if (displayNameLastnamefirst)</span>
<a href="#l71.1634"></a><span id="l71.1634" class="difflineminus">-            {</span>
<a href="#l71.1635"></a><span id="l71.1635" class="difflineminus">-              if (dn.Equals(dnLnFn))</span>
<a href="#l71.1636"></a><span id="l71.1636" class="difflineminus">-                abCard-&gt;SetDisplayName(dnFnLn);</span>
<a href="#l71.1637"></a><span id="l71.1637" class="difflineminus">-            }</span>
<a href="#l71.1638"></a><span id="l71.1638" class="difflineminus">-            else</span>
<a href="#l71.1639"></a><span id="l71.1639" class="difflineminus">-            {</span>
<a href="#l71.1640"></a><span id="l71.1640" class="difflineminus">-              if (dn.Equals(dnFnLn))</span>
<a href="#l71.1641"></a><span id="l71.1641" class="difflineminus">-                abCard-&gt;SetDisplayName(dnLnFn);</span>
<a href="#l71.1642"></a><span id="l71.1642" class="difflineplus">+            if (displayNameLastnamefirst) {</span>
<a href="#l71.1643"></a><span id="l71.1643" class="difflineplus">+              if (dn.Equals(dnLnFn)) abCard-&gt;SetDisplayName(dnFnLn);</span>
<a href="#l71.1644"></a><span id="l71.1644" class="difflineplus">+            } else {</span>
<a href="#l71.1645"></a><span id="l71.1645" class="difflineplus">+              if (dn.Equals(dnFnLn)) abCard-&gt;SetDisplayName(dnLnFn);</span>
<a href="#l71.1646"></a><span id="l71.1646">             }</span>
<a href="#l71.1647"></a><span id="l71.1647">           }</span>
<a href="#l71.1648"></a><span id="l71.1648"> </span>
<a href="#l71.1649"></a><span id="l71.1649">           // Swap phonetic names</span>
<a href="#l71.1650"></a><span id="l71.1650">           rv = abCard-&gt;GetPropertyAsAString(kPhoneticFirstNameProperty, fn);</span>
<a href="#l71.1651"></a><span id="l71.1651">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1652"></a><span id="l71.1652">           rv = abCard-&gt;GetPropertyAsAString(kPhoneticLastNameProperty, ln);</span>
<a href="#l71.1653"></a><span id="l71.1653">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1654"></a><span id="l71.1654" class="difflineminus">-          if (!fn.IsEmpty() || !ln.IsEmpty())</span>
<a href="#l71.1655"></a><span id="l71.1655" class="difflineminus">-          {</span>
<a href="#l71.1656"></a><span id="l71.1656" class="difflineplus">+          if (!fn.IsEmpty() || !ln.IsEmpty()) {</span>
<a href="#l71.1657"></a><span id="l71.1657">             abCard-&gt;SetPropertyAsAString(kPhoneticFirstNameProperty, ln);</span>
<a href="#l71.1658"></a><span id="l71.1658">             abCard-&gt;SetPropertyAsAString(kPhoneticLastNameProperty, fn);</span>
<a href="#l71.1659"></a><span id="l71.1659">           }</span>
<a href="#l71.1660"></a><span id="l71.1660">         }</span>
<a href="#l71.1661"></a><span id="l71.1661">       }</span>
<a href="#l71.1662"></a><span id="l71.1662">     }</span>
<a href="#l71.1663"></a><span id="l71.1663">   }</span>
<a href="#l71.1664"></a><span id="l71.1664">   // Update the tree</span>
<a href="#l71.1665"></a><span id="l71.1665">   // Re-sort if either generated or phonetic name is primary or secondary sort,</span>
<a href="#l71.1666"></a><span id="l71.1666">   // otherwise invalidate to reflect the change</span>
<a href="#l71.1667"></a><span id="l71.1667">   rv = RefreshTree();</span>
<a href="#l71.1668"></a><span id="l71.1668"> </span>
<a href="#l71.1669"></a><span id="l71.1669">   return rv;</span>
<a href="#l71.1670"></a><span id="l71.1670"> }</span>
<a href="#l71.1671"></a><span id="l71.1671"> </span>
<a href="#l71.1672"></a><span id="l71.1672" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSelectedAddresses(nsIArray **_retval)</span>
<a href="#l71.1673"></a><span id="l71.1673" class="difflineminus">-{</span>
<a href="#l71.1674"></a><span id="l71.1674" class="difflineplus">+NS_IMETHODIMP nsAbView::GetSelectedAddresses(nsIArray **_retval) {</span>
<a href="#l71.1675"></a><span id="l71.1675">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l71.1676"></a><span id="l71.1676"> </span>
<a href="#l71.1677"></a><span id="l71.1677">   nsresult rv;</span>
<a href="#l71.1678"></a><span id="l71.1678" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; selectedCards = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.1679"></a><span id="l71.1679" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; selectedCards =</span>
<a href="#l71.1680"></a><span id="l71.1680" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.1681"></a><span id="l71.1681">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1682"></a><span id="l71.1682"> </span>
<a href="#l71.1683"></a><span id="l71.1683">   rv = GetSelectedCards(selectedCards);</span>
<a href="#l71.1684"></a><span id="l71.1684">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1685"></a><span id="l71.1685"> </span>
<a href="#l71.1686"></a><span id="l71.1686" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; addresses = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.1687"></a><span id="l71.1687" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; addresses =</span>
<a href="#l71.1688"></a><span id="l71.1688" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l71.1689"></a><span id="l71.1689">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1690"></a><span id="l71.1690">   uint32_t count;</span>
<a href="#l71.1691"></a><span id="l71.1691">   selectedCards-&gt;GetLength(&amp;count);</span>
<a href="#l71.1692"></a><span id="l71.1692"> </span>
<a href="#l71.1693"></a><span id="l71.1693">   for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l71.1694"></a><span id="l71.1694">     nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(selectedCards, i, &amp;rv));</span>
<a href="#l71.1695"></a><span id="l71.1695">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1696"></a><span id="l71.1696"> </span>
<a href="#l71.1697"></a><span id="l71.1697">     bool isMailList;</span>
<a href="#l71.1698"></a><span id="l71.1698">     card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l71.1699"></a><span id="l71.1699">     nsAutoString primaryEmail;</span>
<a href="#l71.1700"></a><span id="l71.1700">     if (isMailList) {</span>
<a href="#l71.1701"></a><span id="l71.1701" class="difflineminus">-      nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l71.1702"></a><span id="l71.1702" class="difflineminus">-                                                     &amp;rv));</span>
<a href="#l71.1703"></a><span id="l71.1703" class="difflineplus">+      nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l71.1704"></a><span id="l71.1704" class="difflineplus">+          do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l71.1705"></a><span id="l71.1705">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1706"></a><span id="l71.1706"> </span>
<a href="#l71.1707"></a><span id="l71.1707">       nsCString mailListURI;</span>
<a href="#l71.1708"></a><span id="l71.1708">       rv = card-&gt;GetMailListURI(getter_Copies(mailListURI));</span>
<a href="#l71.1709"></a><span id="l71.1709">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1710"></a><span id="l71.1710"> </span>
<a href="#l71.1711"></a><span id="l71.1711">       nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l71.1712"></a><span id="l71.1712">       rv = abManager-&gt;GetDirectory(mailListURI, getter_AddRefs(mailList));</span>
<a href="#l71.1713"></a><span id="l71.1713">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1714"></a><span id="l71.1714"> </span>
<a href="#l71.1715"></a><span id="l71.1715">       nsCOMPtr&lt;nsIMutableArray&gt; mailListAddresses;</span>
<a href="#l71.1716"></a><span id="l71.1716">       rv = mailList-&gt;GetAddressLists(getter_AddRefs(mailListAddresses));</span>
<a href="#l71.1717"></a><span id="l71.1717" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1718"></a><span id="l71.1718" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1719"></a><span id="l71.1719"> </span>
<a href="#l71.1720"></a><span id="l71.1720">       uint32_t mailListCount = 0;</span>
<a href="#l71.1721"></a><span id="l71.1721">       mailListAddresses-&gt;GetLength(&amp;mailListCount);</span>
<a href="#l71.1722"></a><span id="l71.1722"> </span>
<a href="#l71.1723"></a><span id="l71.1723">       for (uint32_t j = 0; j &lt; mailListCount; j++) {</span>
<a href="#l71.1724"></a><span id="l71.1724" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; mailListCard = do_QueryElementAt(mailListAddresses, j, &amp;rv);</span>
<a href="#l71.1725"></a><span id="l71.1725" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1726"></a><span id="l71.1726" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; mailListCard =</span>
<a href="#l71.1727"></a><span id="l71.1727" class="difflineplus">+            do_QueryElementAt(mailListAddresses, j, &amp;rv);</span>
<a href="#l71.1728"></a><span id="l71.1728" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1729"></a><span id="l71.1729"> </span>
<a href="#l71.1730"></a><span id="l71.1730">         rv = mailListCard-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l71.1731"></a><span id="l71.1731" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1732"></a><span id="l71.1732" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1733"></a><span id="l71.1733"> </span>
<a href="#l71.1734"></a><span id="l71.1734">         if (!primaryEmail.IsEmpty()) {</span>
<a href="#l71.1735"></a><span id="l71.1735" class="difflineminus">-          nsCOMPtr&lt;nsISupportsString&gt; supportsEmail(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l71.1736"></a><span id="l71.1736" class="difflineplus">+          nsCOMPtr&lt;nsISupportsString&gt; supportsEmail(</span>
<a href="#l71.1737"></a><span id="l71.1737" class="difflineplus">+              do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l71.1738"></a><span id="l71.1738">           supportsEmail-&gt;SetData(primaryEmail);</span>
<a href="#l71.1739"></a><span id="l71.1739">           addresses-&gt;AppendElement(supportsEmail);</span>
<a href="#l71.1740"></a><span id="l71.1740">         }</span>
<a href="#l71.1741"></a><span id="l71.1741">       }</span>
<a href="#l71.1742"></a><span id="l71.1742" class="difflineminus">-    }</span>
<a href="#l71.1743"></a><span id="l71.1743" class="difflineminus">-    else {</span>
<a href="#l71.1744"></a><span id="l71.1744" class="difflineplus">+    } else {</span>
<a href="#l71.1745"></a><span id="l71.1745">       rv = card-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l71.1746"></a><span id="l71.1746" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l71.1747"></a><span id="l71.1747" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.1748"></a><span id="l71.1748"> </span>
<a href="#l71.1749"></a><span id="l71.1749">       if (!primaryEmail.IsEmpty()) {</span>
<a href="#l71.1750"></a><span id="l71.1750" class="difflineminus">-        nsCOMPtr&lt;nsISupportsString&gt; supportsEmail(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l71.1751"></a><span id="l71.1751" class="difflineplus">+        nsCOMPtr&lt;nsISupportsString&gt; supportsEmail(</span>
<a href="#l71.1752"></a><span id="l71.1752" class="difflineplus">+            do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l71.1753"></a><span id="l71.1753">         supportsEmail-&gt;SetData(primaryEmail);</span>
<a href="#l71.1754"></a><span id="l71.1754">         addresses-&gt;AppendElement(supportsEmail);</span>
<a href="#l71.1755"></a><span id="l71.1755">       }</span>
<a href="#l71.1756"></a><span id="l71.1756">     }</span>
<a href="#l71.1757"></a><span id="l71.1757">   }</span>
<a href="#l71.1758"></a><span id="l71.1758"> </span>
<a href="#l71.1759"></a><span id="l71.1759">   addresses.forget(_retval);</span>
<a href="#l71.1760"></a><span id="l71.1760"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.h</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.h</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -17,60 +17,62 @@</span>
<a href="#l72.4"></a><span id="l72.4"> #include &quot;nsICollation.h&quot;</span>
<a href="#l72.5"></a><span id="l72.5"> #include &quot;nsIAbListener.h&quot;</span>
<a href="#l72.6"></a><span id="l72.6"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l72.7"></a><span id="l72.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l72.8"></a><span id="l72.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l72.9"></a><span id="l72.9"> #include &quot;nsMemory.h&quot;</span>
<a href="#l72.10"></a><span id="l72.10"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-typedef struct AbCard</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineminus">-{</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+typedef struct AbCard {</span>
<a href="#l72.15"></a><span id="l72.15">   nsIAbCard *card;</span>
<a href="#l72.16"></a><span id="l72.16">   uint32_t primaryCollationKeyLen;</span>
<a href="#l72.17"></a><span id="l72.17">   uint32_t secondaryCollationKeyLen;</span>
<a href="#l72.18"></a><span id="l72.18">   uint8_t *primaryCollationKey;</span>
<a href="#l72.19"></a><span id="l72.19">   uint8_t *secondaryCollationKey;</span>
<a href="#l72.20"></a><span id="l72.20"> } AbCard;</span>
<a href="#l72.21"></a><span id="l72.21"> </span>
<a href="#l72.22"></a><span id="l72.22" class="difflineminus">-</span>
<a href="#l72.23"></a><span id="l72.23" class="difflineminus">-class nsAbView : public nsIAbView, public nsITreeView, public nsIAbListener, public nsIObserver</span>
<a href="#l72.24"></a><span id="l72.24" class="difflineminus">-{</span>
<a href="#l72.25"></a><span id="l72.25" class="difflineminus">-public:</span>
<a href="#l72.26"></a><span id="l72.26" class="difflineplus">+class nsAbView : public nsIAbView,</span>
<a href="#l72.27"></a><span id="l72.27" class="difflineplus">+                 public nsITreeView,</span>
<a href="#l72.28"></a><span id="l72.28" class="difflineplus">+                 public nsIAbListener,</span>
<a href="#l72.29"></a><span id="l72.29" class="difflineplus">+                 public nsIObserver {</span>
<a href="#l72.30"></a><span id="l72.30" class="difflineplus">+ public:</span>
<a href="#l72.31"></a><span id="l72.31">   nsAbView();</span>
<a href="#l72.32"></a><span id="l72.32"> </span>
<a href="#l72.33"></a><span id="l72.33">   NS_DECL_ISUPPORTS</span>
<a href="#l72.34"></a><span id="l72.34">   NS_DECL_NSIABVIEW</span>
<a href="#l72.35"></a><span id="l72.35">   NS_DECL_NSITREEVIEW</span>
<a href="#l72.36"></a><span id="l72.36">   NS_DECL_NSIABLISTENER</span>
<a href="#l72.37"></a><span id="l72.37">   NS_DECL_NSIOBSERVER</span>
<a href="#l72.38"></a><span id="l72.38"> </span>
<a href="#l72.39"></a><span id="l72.39" class="difflineminus">-  int32_t CompareCollationKeys(uint8_t *key1, uint32_t len1, uint8_t *key2, uint32_t len2);</span>
<a href="#l72.40"></a><span id="l72.40" class="difflineplus">+  int32_t CompareCollationKeys(uint8_t *key1, uint32_t len1, uint8_t *key2,</span>
<a href="#l72.41"></a><span id="l72.41" class="difflineplus">+                               uint32_t len2);</span>
<a href="#l72.42"></a><span id="l72.42"> </span>
<a href="#l72.43"></a><span id="l72.43" class="difflineminus">-private:</span>
<a href="#l72.44"></a><span id="l72.44" class="difflineplus">+ private:</span>
<a href="#l72.45"></a><span id="l72.45">   virtual ~nsAbView();</span>
<a href="#l72.46"></a><span id="l72.46">   nsresult Initialize();</span>
<a href="#l72.47"></a><span id="l72.47">   int32_t FindIndexForInsert(AbCard *abcard);</span>
<a href="#l72.48"></a><span id="l72.48">   int32_t FindIndexForCard(nsIAbCard *card);</span>
<a href="#l72.49"></a><span id="l72.49" class="difflineminus">-  nsresult GenerateCollationKeysForCard(const nsAString&amp; colID, AbCard *abcard);</span>
<a href="#l72.50"></a><span id="l72.50" class="difflineplus">+  nsresult GenerateCollationKeysForCard(const nsAString &amp;colID, AbCard *abcard);</span>
<a href="#l72.51"></a><span id="l72.51">   nsresult InvalidateTree(int32_t row);</span>
<a href="#l72.52"></a><span id="l72.52">   nsresult RemoveCardAt(int32_t row);</span>
<a href="#l72.53"></a><span id="l72.53">   nsresult AddCard(AbCard *abcard, bool selectCardAfterAdding, int32_t *index);</span>
<a href="#l72.54"></a><span id="l72.54">   nsresult RemoveCardAndSelectNextCard(nsISupports *item);</span>
<a href="#l72.55"></a><span id="l72.55">   nsresult EnumerateCards();</span>
<a href="#l72.56"></a><span id="l72.56">   nsresult SetGeneratedNameFormatFromPrefs();</span>
<a href="#l72.57"></a><span id="l72.57">   nsresult GetSelectedCards(nsCOMPtr&lt;nsIMutableArray&gt; &amp;aSelectedCards);</span>
<a href="#l72.58"></a><span id="l72.58">   nsresult ReselectCards(nsIArray *aCards, nsIAbCard *aIndexCard);</span>
<a href="#l72.59"></a><span id="l72.59" class="difflineminus">-  nsresult GetCardValue(nsIAbCard *card, const nsAString&amp; colID, nsAString &amp;_retval);</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineplus">+  nsresult GetCardValue(nsIAbCard *card, const nsAString &amp;colID,</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+                        nsAString &amp;_retval);</span>
<a href="#l72.62"></a><span id="l72.62">   nsresult RefreshTree();</span>
<a href="#l72.63"></a><span id="l72.63"> </span>
<a href="#l72.64"></a><span id="l72.64">   RefPtr&lt;mozilla::dom::XULTreeElement&gt; mTree;</span>
<a href="#l72.65"></a><span id="l72.65">   nsCOMPtr&lt;nsITreeSelection&gt; mTreeSelection;</span>
<a href="#l72.66"></a><span id="l72.66" class="difflineminus">-  nsCOMPtr &lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l72.67"></a><span id="l72.67" class="difflineminus">-  nsTArray&lt;AbCard*&gt; mCards;</span>
<a href="#l72.68"></a><span id="l72.68" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l72.69"></a><span id="l72.69" class="difflineplus">+  nsTArray&lt;AbCard *&gt; mCards;</span>
<a href="#l72.70"></a><span id="l72.70">   nsString mSortColumn;</span>
<a href="#l72.71"></a><span id="l72.71">   nsString mSortDirection;</span>
<a href="#l72.72"></a><span id="l72.72">   nsCOMPtr&lt;nsICollation&gt; mCollationKeyGenerator;</span>
<a href="#l72.73"></a><span id="l72.73">   nsCOMPtr&lt;nsIAbViewListener&gt; mAbViewListener;</span>
<a href="#l72.74"></a><span id="l72.74">   nsCOMPtr&lt;nsIStringBundle&gt; mABBundle;</span>
<a href="#l72.75"></a><span id="l72.75"> </span>
<a href="#l72.76"></a><span id="l72.76">   bool mInitialized;</span>
<a href="#l72.77"></a><span id="l72.77">   bool mIsAllDirectoryRootView;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -17,972 +17,956 @@</span>
<a href="#l73.4"></a><span id="l73.4"> </span>
<a href="#l73.5"></a><span id="l73.5"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l73.6"></a><span id="l73.6"> </span>
<a href="#l73.7"></a><span id="l73.7"> static mozilla::LazyLogModule gAbWinHelperLog(&quot;AbWinHelper&quot;);</span>
<a href="#l73.8"></a><span id="l73.8"> </span>
<a href="#l73.9"></a><span id="l73.9"> #define PRINTF(args) MOZ_LOG(gAbWinHelperLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l73.10"></a><span id="l73.10"> </span>
<a href="#l73.11"></a><span id="l73.11"> // Small utility to ensure release of all MAPI interfaces</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-template &lt;class tInterface&gt; struct nsMapiInterfaceWrapper</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineminus">-{</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineminus">-    tInterface mInterface ;</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+template &lt;class tInterface&gt;</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineplus">+struct nsMapiInterfaceWrapper {</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineplus">+  tInterface mInterface;</span>
<a href="#l73.18"></a><span id="l73.18"> </span>
<a href="#l73.19"></a><span id="l73.19" class="difflineminus">-    nsMapiInterfaceWrapper(void) : mInterface(NULL) {}</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineminus">-    ~nsMapiInterfaceWrapper(void) {</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineminus">-        if (mInterface != NULL) { mInterface-&gt;Release() ; }</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineplus">+  nsMapiInterfaceWrapper(void) : mInterface(NULL) {}</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineplus">+  ~nsMapiInterfaceWrapper(void) {</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineplus">+    if (mInterface != NULL) {</span>
<a href="#l73.25"></a><span id="l73.25" class="difflineplus">+      mInterface-&gt;Release();</span>
<a href="#l73.26"></a><span id="l73.26">     }</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineminus">-    operator LPUNKNOWN *(void) { return reinterpret_cast&lt;LPUNKNOWN *&gt;(&amp;mInterface) ; }</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineminus">-    tInterface operator -&gt; (void) const { return mInterface ; }</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineminus">-    operator tInterface *(void) { return &amp;mInterface ; }</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineminus">-} ;</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+  }</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+  operator LPUNKNOWN*(void) {</span>
<a href="#l73.33"></a><span id="l73.33" class="difflineplus">+    return reinterpret_cast&lt;LPUNKNOWN*&gt;(&amp;mInterface);</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineplus">+  }</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+  tInterface operator-&gt;(void)const { return mInterface; }</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+  operator tInterface*(void) { return &amp;mInterface; }</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+};</span>
<a href="#l73.38"></a><span id="l73.38"> </span>
<a href="#l73.39"></a><span id="l73.39" class="difflineminus">-static void assignEntryID(LPENTRYID&amp; aTarget, LPENTRYID aSource, ULONG aByteCount)</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineminus">-{</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineminus">-    if (aTarget != NULL) {</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineminus">-        delete [] (reinterpret_cast&lt;LPBYTE&gt;(aTarget)) ;</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineminus">-        aTarget = NULL ;</span>
<a href="#l73.44"></a><span id="l73.44" class="difflineminus">-    }</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineminus">-    if (aSource != NULL) {</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineminus">-        aTarget = reinterpret_cast&lt;LPENTRYID&gt;(new BYTE[aByteCount]) ;</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineminus">-        memcpy(aTarget, aSource, aByteCount) ;</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineminus">-    }</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineplus">+static void assignEntryID(LPENTRYID&amp; aTarget, LPENTRYID aSource,</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+                          ULONG aByteCount) {</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+  if (aTarget != NULL) {</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+    delete[](reinterpret_cast&lt;LPBYTE&gt;(aTarget));</span>
<a href="#l73.53"></a><span id="l73.53" class="difflineplus">+    aTarget = NULL;</span>
<a href="#l73.54"></a><span id="l73.54" class="difflineplus">+  }</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineplus">+  if (aSource != NULL) {</span>
<a href="#l73.56"></a><span id="l73.56" class="difflineplus">+    aTarget = reinterpret_cast&lt;LPENTRYID&gt;(new BYTE[aByteCount]);</span>
<a href="#l73.57"></a><span id="l73.57" class="difflineplus">+    memcpy(aTarget, aSource, aByteCount);</span>
<a href="#l73.58"></a><span id="l73.58" class="difflineplus">+  }</span>
<a href="#l73.59"></a><span id="l73.59"> }</span>
<a href="#l73.60"></a><span id="l73.60"> </span>
<a href="#l73.61"></a><span id="l73.61" class="difflineminus">-nsMapiEntry::nsMapiEntry(void)</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineminus">-: mByteCount(0), mEntryId(NULL)</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineminus">-{</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineminus">-    MOZ_COUNT_CTOR(nsMapiEntry) ;</span>
<a href="#l73.65"></a><span id="l73.65" class="difflineplus">+nsMapiEntry::nsMapiEntry(void) : mByteCount(0), mEntryId(NULL) {</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineplus">+  MOZ_COUNT_CTOR(nsMapiEntry);</span>
<a href="#l73.67"></a><span id="l73.67"> }</span>
<a href="#l73.68"></a><span id="l73.68"> </span>
<a href="#l73.69"></a><span id="l73.69"> nsMapiEntry::nsMapiEntry(ULONG aByteCount, LPENTRYID aEntryId)</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineminus">-: mByteCount(0), mEntryId(NULL)</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineminus">-{</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineminus">-    Assign(aByteCount, aEntryId) ;</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineminus">-    MOZ_COUNT_CTOR(nsMapiEntry) ;</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+    : mByteCount(0), mEntryId(NULL) {</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+  Assign(aByteCount, aEntryId);</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineplus">+  MOZ_COUNT_CTOR(nsMapiEntry);</span>
<a href="#l73.77"></a><span id="l73.77"> }</span>
<a href="#l73.78"></a><span id="l73.78"> </span>
<a href="#l73.79"></a><span id="l73.79" class="difflineminus">-nsMapiEntry::~nsMapiEntry(void)</span>
<a href="#l73.80"></a><span id="l73.80" class="difflineminus">-{</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineminus">-    Assign(0, NULL) ;</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineminus">-    MOZ_COUNT_DTOR(nsMapiEntry) ;</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineplus">+nsMapiEntry::~nsMapiEntry(void) {</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineplus">+  Assign(0, NULL);</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineplus">+  MOZ_COUNT_DTOR(nsMapiEntry);</span>
<a href="#l73.86"></a><span id="l73.86"> }</span>
<a href="#l73.87"></a><span id="l73.87"> </span>
<a href="#l73.88"></a><span id="l73.88" class="difflineminus">-void nsMapiEntry::Assign(ULONG aByteCount, LPENTRYID aEntryId)</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineminus">-{</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineminus">-    assignEntryID(mEntryId, aEntryId, aByteCount) ;</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineminus">-    mByteCount = aByteCount ;</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineplus">+void nsMapiEntry::Assign(ULONG aByteCount, LPENTRYID aEntryId) {</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineplus">+  assignEntryID(mEntryId, aEntryId, aByteCount);</span>
<a href="#l73.94"></a><span id="l73.94" class="difflineplus">+  mByteCount = aByteCount;</span>
<a href="#l73.95"></a><span id="l73.95"> }</span>
<a href="#l73.96"></a><span id="l73.96"> </span>
<a href="#l73.97"></a><span id="l73.97" class="difflineminus">-static char kBase64Encoding[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-.&quot; ;</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineminus">-static const int kARank = 0 ;</span>
<a href="#l73.99"></a><span id="l73.99" class="difflineminus">-static const int kaRank = 26 ;</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineminus">-static const int k0Rank = 52 ;</span>
<a href="#l73.101"></a><span id="l73.101" class="difflineminus">-static const unsigned char kMinusRank = 62 ;</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineminus">-static const unsigned char kDotRank = 63 ;</span>
<a href="#l73.103"></a><span id="l73.103" class="difflineplus">+static char kBase64Encoding[] =</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineplus">+    &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-.&quot;;</span>
<a href="#l73.105"></a><span id="l73.105" class="difflineplus">+static const int kARank = 0;</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineplus">+static const int kaRank = 26;</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineplus">+static const int k0Rank = 52;</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineplus">+static const unsigned char kMinusRank = 62;</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineplus">+static const unsigned char kDotRank = 63;</span>
<a href="#l73.110"></a><span id="l73.110"> </span>
<a href="#l73.111"></a><span id="l73.111" class="difflineminus">-static void UnsignedToBase64(unsigned char *&amp; aUnsigned,</span>
<a href="#l73.112"></a><span id="l73.112" class="difflineminus">-                             ULONG aNbUnsigned, nsCString&amp; aString)</span>
<a href="#l73.113"></a><span id="l73.113" class="difflineminus">-{</span>
<a href="#l73.114"></a><span id="l73.114" class="difflineminus">-    if (aNbUnsigned &gt; 0) {</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineminus">-        unsigned char remain0 = (*aUnsigned &amp; 0x03) &lt;&lt; 4 ;</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineplus">+static void UnsignedToBase64(unsigned char*&amp; aUnsigned, ULONG aNbUnsigned,</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+                             nsCString&amp; aString) {</span>
<a href="#l73.118"></a><span id="l73.118" class="difflineplus">+  if (aNbUnsigned &gt; 0) {</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineplus">+    unsigned char remain0 = (*aUnsigned &amp; 0x03) &lt;&lt; 4;</span>
<a href="#l73.120"></a><span id="l73.120"> </span>
<a href="#l73.121"></a><span id="l73.121" class="difflineminus">-        aString.Append(kBase64Encoding[(*aUnsigned &gt;&gt; 2) &amp; 0x3F]) ;</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineminus">-        ++aUnsigned ;</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineminus">-        if (aNbUnsigned &gt; 1) {</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineminus">-            unsigned char remain1 = (*aUnsigned &amp; 0x0F) &lt;&lt; 2 ;</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineplus">+    aString.Append(kBase64Encoding[(*aUnsigned &gt;&gt; 2) &amp; 0x3F]);</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineplus">+    ++aUnsigned;</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+    if (aNbUnsigned &gt; 1) {</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+      unsigned char remain1 = (*aUnsigned &amp; 0x0F) &lt;&lt; 2;</span>
<a href="#l73.129"></a><span id="l73.129"> </span>
<a href="#l73.130"></a><span id="l73.130" class="difflineminus">-            aString.Append(kBase64Encoding[remain0 | ((*aUnsigned &gt;&gt; 4) &amp; 0x0F)]) ;</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineminus">-            ++aUnsigned ;</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineminus">-            if (aNbUnsigned &gt; 2) {</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineminus">-                aString.Append(kBase64Encoding[remain1 | ((*aUnsigned &gt;&gt; 6) &amp; 0x03)]) ;</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineminus">-                aString.Append(kBase64Encoding[*aUnsigned &amp; 0x3F]) ;</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineminus">-                ++aUnsigned ;</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineminus">-            }</span>
<a href="#l73.137"></a><span id="l73.137" class="difflineminus">-            else {</span>
<a href="#l73.138"></a><span id="l73.138" class="difflineminus">-                aString.Append(kBase64Encoding[remain1]) ;</span>
<a href="#l73.139"></a><span id="l73.139" class="difflineminus">-            }</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineminus">-        }</span>
<a href="#l73.141"></a><span id="l73.141" class="difflineminus">-        else {</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineminus">-            aString.Append(kBase64Encoding[remain0]) ;</span>
<a href="#l73.143"></a><span id="l73.143" class="difflineminus">-        }</span>
<a href="#l73.144"></a><span id="l73.144" class="difflineplus">+      aString.Append(kBase64Encoding[remain0 | ((*aUnsigned &gt;&gt; 4) &amp; 0x0F)]);</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineplus">+      ++aUnsigned;</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineplus">+      if (aNbUnsigned &gt; 2) {</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+        aString.Append(kBase64Encoding[remain1 | ((*aUnsigned &gt;&gt; 6) &amp; 0x03)]);</span>
<a href="#l73.148"></a><span id="l73.148" class="difflineplus">+        aString.Append(kBase64Encoding[*aUnsigned &amp; 0x3F]);</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineplus">+        ++aUnsigned;</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+      } else {</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineplus">+        aString.Append(kBase64Encoding[remain1]);</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineplus">+      }</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineplus">+    } else {</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineplus">+      aString.Append(kBase64Encoding[remain0]);</span>
<a href="#l73.155"></a><span id="l73.155">     }</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineplus">+  }</span>
<a href="#l73.157"></a><span id="l73.157"> }</span>
<a href="#l73.158"></a><span id="l73.158"> </span>
<a href="#l73.159"></a><span id="l73.159"> // This function must return the rank in kBase64Encoding of the</span>
<a href="#l73.160"></a><span id="l73.160"> // character provided.</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineminus">-static unsigned char Base64To6Bits(char aBase64)</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineminus">-{</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineminus">-    if (aBase64 &gt;= 'A' &amp;&amp; aBase64 &lt;= 'Z') {</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineminus">-        return static_cast&lt;unsigned char&gt;(aBase64 - 'A' + kARank) ;</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineminus">-    }</span>
<a href="#l73.166"></a><span id="l73.166" class="difflineminus">-    if (aBase64 &gt;= 'a' &amp;&amp; aBase64 &lt;= 'z') {</span>
<a href="#l73.167"></a><span id="l73.167" class="difflineminus">-        return static_cast&lt;unsigned char&gt;(aBase64 - 'a' + kaRank) ;</span>
<a href="#l73.168"></a><span id="l73.168" class="difflineminus">-    }</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineminus">-    if (aBase64 &gt;= '0' &amp;&amp; aBase64 &lt;= '9') {</span>
<a href="#l73.170"></a><span id="l73.170" class="difflineminus">-        return static_cast&lt;unsigned char&gt;(aBase64 - '0' + k0Rank) ;</span>
<a href="#l73.171"></a><span id="l73.171" class="difflineminus">-    }</span>
<a href="#l73.172"></a><span id="l73.172" class="difflineminus">-    if (aBase64 == '-') { return kMinusRank ; }</span>
<a href="#l73.173"></a><span id="l73.173" class="difflineminus">-    if (aBase64 == '.') { return kDotRank ; }</span>
<a href="#l73.174"></a><span id="l73.174" class="difflineminus">-    return 0 ;</span>
<a href="#l73.175"></a><span id="l73.175" class="difflineplus">+static unsigned char Base64To6Bits(char aBase64) {</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineplus">+  if (aBase64 &gt;= 'A' &amp;&amp; aBase64 &lt;= 'Z') {</span>
<a href="#l73.177"></a><span id="l73.177" class="difflineplus">+    return static_cast&lt;unsigned char&gt;(aBase64 - 'A' + kARank);</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineplus">+  }</span>
<a href="#l73.179"></a><span id="l73.179" class="difflineplus">+  if (aBase64 &gt;= 'a' &amp;&amp; aBase64 &lt;= 'z') {</span>
<a href="#l73.180"></a><span id="l73.180" class="difflineplus">+    return static_cast&lt;unsigned char&gt;(aBase64 - 'a' + kaRank);</span>
<a href="#l73.181"></a><span id="l73.181" class="difflineplus">+  }</span>
<a href="#l73.182"></a><span id="l73.182" class="difflineplus">+  if (aBase64 &gt;= '0' &amp;&amp; aBase64 &lt;= '9') {</span>
<a href="#l73.183"></a><span id="l73.183" class="difflineplus">+    return static_cast&lt;unsigned char&gt;(aBase64 - '0' + k0Rank);</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineplus">+  }</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineplus">+  if (aBase64 == '-') {</span>
<a href="#l73.186"></a><span id="l73.186" class="difflineplus">+    return kMinusRank;</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineplus">+  }</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineplus">+  if (aBase64 == '.') {</span>
<a href="#l73.189"></a><span id="l73.189" class="difflineplus">+    return kDotRank;</span>
<a href="#l73.190"></a><span id="l73.190" class="difflineplus">+  }</span>
<a href="#l73.191"></a><span id="l73.191" class="difflineplus">+  return 0;</span>
<a href="#l73.192"></a><span id="l73.192"> }</span>
<a href="#l73.193"></a><span id="l73.193"> </span>
<a href="#l73.194"></a><span id="l73.194" class="difflineminus">-static void Base64ToUnsigned(const char *&amp; aBase64, uint32_t aNbBase64,</span>
<a href="#l73.195"></a><span id="l73.195" class="difflineminus">-                             unsigned char *&amp;aUnsigned)</span>
<a href="#l73.196"></a><span id="l73.196" class="difflineminus">-{</span>
<a href="#l73.197"></a><span id="l73.197" class="difflineminus">-    // By design of the encoding, we must have at least two characters to use</span>
<a href="#l73.198"></a><span id="l73.198" class="difflineminus">-    if (aNbBase64 &gt; 1) {</span>
<a href="#l73.199"></a><span id="l73.199" class="difflineminus">-        unsigned char first6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l73.200"></a><span id="l73.200" class="difflineminus">-        unsigned char second6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l73.201"></a><span id="l73.201" class="difflineplus">+static void Base64ToUnsigned(const char*&amp; aBase64, uint32_t aNbBase64,</span>
<a href="#l73.202"></a><span id="l73.202" class="difflineplus">+                             unsigned char*&amp; aUnsigned) {</span>
<a href="#l73.203"></a><span id="l73.203" class="difflineplus">+  // By design of the encoding, we must have at least two characters to use</span>
<a href="#l73.204"></a><span id="l73.204" class="difflineplus">+  if (aNbBase64 &gt; 1) {</span>
<a href="#l73.205"></a><span id="l73.205" class="difflineplus">+    unsigned char first6Bits = Base64To6Bits(*aBase64++);</span>
<a href="#l73.206"></a><span id="l73.206" class="difflineplus">+    unsigned char second6Bits = Base64To6Bits(*aBase64++);</span>
<a href="#l73.207"></a><span id="l73.207" class="difflineplus">+</span>
<a href="#l73.208"></a><span id="l73.208" class="difflineplus">+    *aUnsigned = first6Bits &lt;&lt; 2;</span>
<a href="#l73.209"></a><span id="l73.209" class="difflineplus">+    *aUnsigned |= second6Bits &gt;&gt; 4;</span>
<a href="#l73.210"></a><span id="l73.210" class="difflineplus">+    ++aUnsigned;</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineplus">+    if (aNbBase64 &gt; 2) {</span>
<a href="#l73.212"></a><span id="l73.212" class="difflineplus">+      unsigned char third6Bits = Base64To6Bits(*aBase64++);</span>
<a href="#l73.213"></a><span id="l73.213"> </span>
<a href="#l73.214"></a><span id="l73.214" class="difflineminus">-        *aUnsigned = first6Bits &lt;&lt; 2 ;</span>
<a href="#l73.215"></a><span id="l73.215" class="difflineminus">-        *aUnsigned |= second6Bits &gt;&gt; 4 ;</span>
<a href="#l73.216"></a><span id="l73.216" class="difflineminus">-        ++aUnsigned ;</span>
<a href="#l73.217"></a><span id="l73.217" class="difflineminus">-        if (aNbBase64 &gt; 2) {</span>
<a href="#l73.218"></a><span id="l73.218" class="difflineminus">-            unsigned char third6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l73.219"></a><span id="l73.219" class="difflineplus">+      *aUnsigned = second6Bits &lt;&lt; 4;</span>
<a href="#l73.220"></a><span id="l73.220" class="difflineplus">+      *aUnsigned |= third6Bits &gt;&gt; 2;</span>
<a href="#l73.221"></a><span id="l73.221" class="difflineplus">+      ++aUnsigned;</span>
<a href="#l73.222"></a><span id="l73.222" class="difflineplus">+      if (aNbBase64 &gt; 3) {</span>
<a href="#l73.223"></a><span id="l73.223" class="difflineplus">+        unsigned char fourth6Bits = Base64To6Bits(*aBase64++);</span>
<a href="#l73.224"></a><span id="l73.224"> </span>
<a href="#l73.225"></a><span id="l73.225" class="difflineminus">-            *aUnsigned = second6Bits &lt;&lt; 4 ;</span>
<a href="#l73.226"></a><span id="l73.226" class="difflineminus">-            *aUnsigned |= third6Bits &gt;&gt; 2 ;</span>
<a href="#l73.227"></a><span id="l73.227" class="difflineminus">-            ++aUnsigned ;</span>
<a href="#l73.228"></a><span id="l73.228" class="difflineminus">-            if (aNbBase64 &gt; 3) {</span>
<a href="#l73.229"></a><span id="l73.229" class="difflineminus">-                unsigned char fourth6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l73.230"></a><span id="l73.230" class="difflineminus">-</span>
<a href="#l73.231"></a><span id="l73.231" class="difflineminus">-                *aUnsigned = third6Bits &lt;&lt; 6 ;</span>
<a href="#l73.232"></a><span id="l73.232" class="difflineminus">-                *aUnsigned |= fourth6Bits ;</span>
<a href="#l73.233"></a><span id="l73.233" class="difflineminus">-                ++aUnsigned ;</span>
<a href="#l73.234"></a><span id="l73.234" class="difflineminus">-            }</span>
<a href="#l73.235"></a><span id="l73.235" class="difflineminus">-        }</span>
<a href="#l73.236"></a><span id="l73.236" class="difflineplus">+        *aUnsigned = third6Bits &lt;&lt; 6;</span>
<a href="#l73.237"></a><span id="l73.237" class="difflineplus">+        *aUnsigned |= fourth6Bits;</span>
<a href="#l73.238"></a><span id="l73.238" class="difflineplus">+        ++aUnsigned;</span>
<a href="#l73.239"></a><span id="l73.239" class="difflineplus">+      }</span>
<a href="#l73.240"></a><span id="l73.240">     }</span>
<a href="#l73.241"></a><span id="l73.241" class="difflineplus">+  }</span>
<a href="#l73.242"></a><span id="l73.242"> }</span>
<a href="#l73.243"></a><span id="l73.243"> </span>
<a href="#l73.244"></a><span id="l73.244" class="difflineminus">-void nsMapiEntry::Assign(const nsCString&amp; aString)</span>
<a href="#l73.245"></a><span id="l73.245" class="difflineminus">-{</span>
<a href="#l73.246"></a><span id="l73.246" class="difflineminus">-    Assign(0, NULL) ;</span>
<a href="#l73.247"></a><span id="l73.247" class="difflineminus">-    ULONG byteCount = aString.Length() / 4 * 3 ;</span>
<a href="#l73.248"></a><span id="l73.248" class="difflineplus">+void nsMapiEntry::Assign(const nsCString&amp; aString) {</span>
<a href="#l73.249"></a><span id="l73.249" class="difflineplus">+  Assign(0, NULL);</span>
<a href="#l73.250"></a><span id="l73.250" class="difflineplus">+  ULONG byteCount = aString.Length() / 4 * 3;</span>
<a href="#l73.251"></a><span id="l73.251"> </span>
<a href="#l73.252"></a><span id="l73.252" class="difflineminus">-    if ((aString.Length() &amp; 0x03) != 0) {</span>
<a href="#l73.253"></a><span id="l73.253" class="difflineminus">-        byteCount += (aString.Length() &amp; 0x03) - 1 ;</span>
<a href="#l73.254"></a><span id="l73.254" class="difflineminus">-    }</span>
<a href="#l73.255"></a><span id="l73.255" class="difflineminus">-    const char *currentSource = aString.get() ;</span>
<a href="#l73.256"></a><span id="l73.256" class="difflineminus">-    unsigned char *currentTarget = new unsigned char[byteCount] ;</span>
<a href="#l73.257"></a><span id="l73.257" class="difflineminus">-    uint32_t i = 0 ;</span>
<a href="#l73.258"></a><span id="l73.258" class="difflineplus">+  if ((aString.Length() &amp; 0x03) != 0) {</span>
<a href="#l73.259"></a><span id="l73.259" class="difflineplus">+    byteCount += (aString.Length() &amp; 0x03) - 1;</span>
<a href="#l73.260"></a><span id="l73.260" class="difflineplus">+  }</span>
<a href="#l73.261"></a><span id="l73.261" class="difflineplus">+  const char* currentSource = aString.get();</span>
<a href="#l73.262"></a><span id="l73.262" class="difflineplus">+  unsigned char* currentTarget = new unsigned char[byteCount];</span>
<a href="#l73.263"></a><span id="l73.263" class="difflineplus">+  uint32_t i = 0;</span>
<a href="#l73.264"></a><span id="l73.264"> </span>
<a href="#l73.265"></a><span id="l73.265" class="difflineminus">-    mByteCount = byteCount ;</span>
<a href="#l73.266"></a><span id="l73.266" class="difflineminus">-    mEntryId = reinterpret_cast&lt;LPENTRYID&gt;(currentTarget) ;</span>
<a href="#l73.267"></a><span id="l73.267" class="difflineminus">-    for (i = aString.Length() ; i &gt;= 4 ; i -= 4) {</span>
<a href="#l73.268"></a><span id="l73.268" class="difflineminus">-        Base64ToUnsigned(currentSource, 4, currentTarget) ;</span>
<a href="#l73.269"></a><span id="l73.269" class="difflineminus">-    }</span>
<a href="#l73.270"></a><span id="l73.270" class="difflineminus">-    Base64ToUnsigned(currentSource, i, currentTarget) ;</span>
<a href="#l73.271"></a><span id="l73.271" class="difflineplus">+  mByteCount = byteCount;</span>
<a href="#l73.272"></a><span id="l73.272" class="difflineplus">+  mEntryId = reinterpret_cast&lt;LPENTRYID&gt;(currentTarget);</span>
<a href="#l73.273"></a><span id="l73.273" class="difflineplus">+  for (i = aString.Length(); i &gt;= 4; i -= 4) {</span>
<a href="#l73.274"></a><span id="l73.274" class="difflineplus">+    Base64ToUnsigned(currentSource, 4, currentTarget);</span>
<a href="#l73.275"></a><span id="l73.275" class="difflineplus">+  }</span>
<a href="#l73.276"></a><span id="l73.276" class="difflineplus">+  Base64ToUnsigned(currentSource, i, currentTarget);</span>
<a href="#l73.277"></a><span id="l73.277"> }</span>
<a href="#l73.278"></a><span id="l73.278"> </span>
<a href="#l73.279"></a><span id="l73.279" class="difflineminus">-void nsMapiEntry::ToString(nsCString&amp; aString) const</span>
<a href="#l73.280"></a><span id="l73.280" class="difflineminus">-{</span>
<a href="#l73.281"></a><span id="l73.281" class="difflineminus">-    aString.Truncate() ;</span>
<a href="#l73.282"></a><span id="l73.282" class="difflineminus">-    ULONG i = 0 ;</span>
<a href="#l73.283"></a><span id="l73.283" class="difflineminus">-    unsigned char *currentSource = reinterpret_cast&lt;unsigned char *&gt;(mEntryId) ;</span>
<a href="#l73.284"></a><span id="l73.284" class="difflineplus">+void nsMapiEntry::ToString(nsCString&amp; aString) const {</span>
<a href="#l73.285"></a><span id="l73.285" class="difflineplus">+  aString.Truncate();</span>
<a href="#l73.286"></a><span id="l73.286" class="difflineplus">+  ULONG i = 0;</span>
<a href="#l73.287"></a><span id="l73.287" class="difflineplus">+  unsigned char* currentSource = reinterpret_cast&lt;unsigned char*&gt;(mEntryId);</span>
<a href="#l73.288"></a><span id="l73.288"> </span>
<a href="#l73.289"></a><span id="l73.289" class="difflineminus">-    for (i = mByteCount ; i &gt;= 3 ; i -= 3) {</span>
<a href="#l73.290"></a><span id="l73.290" class="difflineminus">-        UnsignedToBase64(currentSource, 3, aString) ;</span>
<a href="#l73.291"></a><span id="l73.291" class="difflineminus">-    }</span>
<a href="#l73.292"></a><span id="l73.292" class="difflineminus">-    UnsignedToBase64(currentSource, i, aString) ;</span>
<a href="#l73.293"></a><span id="l73.293" class="difflineplus">+  for (i = mByteCount; i &gt;= 3; i -= 3) {</span>
<a href="#l73.294"></a><span id="l73.294" class="difflineplus">+    UnsignedToBase64(currentSource, 3, aString);</span>
<a href="#l73.295"></a><span id="l73.295" class="difflineplus">+  }</span>
<a href="#l73.296"></a><span id="l73.296" class="difflineplus">+  UnsignedToBase64(currentSource, i, aString);</span>
<a href="#l73.297"></a><span id="l73.297"> }</span>
<a href="#l73.298"></a><span id="l73.298"> </span>
<a href="#l73.299"></a><span id="l73.299" class="difflineminus">-void nsMapiEntry::Dump(void) const</span>
<a href="#l73.300"></a><span id="l73.300" class="difflineminus">-{</span>
<a href="#l73.301"></a><span id="l73.301" class="difflineminus">-    PRINTF((&quot;%d\n&quot;, mByteCount)) ;</span>
<a href="#l73.302"></a><span id="l73.302" class="difflineminus">-    for (ULONG i = 0 ; i &lt; mByteCount ; ++i) {</span>
<a href="#l73.303"></a><span id="l73.303" class="difflineminus">-        PRINTF((&quot;%02X&quot;, (reinterpret_cast&lt;unsigned char *&gt;(mEntryId))[i])) ;</span>
<a href="#l73.304"></a><span id="l73.304" class="difflineminus">-    }</span>
<a href="#l73.305"></a><span id="l73.305" class="difflineminus">-    PRINTF((&quot;\n&quot;)) ;</span>
<a href="#l73.306"></a><span id="l73.306" class="difflineplus">+void nsMapiEntry::Dump(void) const {</span>
<a href="#l73.307"></a><span id="l73.307" class="difflineplus">+  PRINTF((&quot;%d\n&quot;, mByteCount));</span>
<a href="#l73.308"></a><span id="l73.308" class="difflineplus">+  for (ULONG i = 0; i &lt; mByteCount; ++i) {</span>
<a href="#l73.309"></a><span id="l73.309" class="difflineplus">+    PRINTF((&quot;%02X&quot;, (reinterpret_cast&lt;unsigned char*&gt;(mEntryId))[i]));</span>
<a href="#l73.310"></a><span id="l73.310" class="difflineplus">+  }</span>
<a href="#l73.311"></a><span id="l73.311" class="difflineplus">+  PRINTF((&quot;\n&quot;));</span>
<a href="#l73.312"></a><span id="l73.312" class="difflineplus">+}</span>
<a href="#l73.313"></a><span id="l73.313" class="difflineplus">+</span>
<a href="#l73.314"></a><span id="l73.314" class="difflineplus">+nsMapiEntryArray::nsMapiEntryArray(void) : mEntries(NULL), mNbEntries(0) {</span>
<a href="#l73.315"></a><span id="l73.315" class="difflineplus">+  MOZ_COUNT_CTOR(nsMapiEntryArray);</span>
<a href="#l73.316"></a><span id="l73.316"> }</span>
<a href="#l73.317"></a><span id="l73.317"> </span>
<a href="#l73.318"></a><span id="l73.318" class="difflineminus">-nsMapiEntryArray::nsMapiEntryArray(void)</span>
<a href="#l73.319"></a><span id="l73.319" class="difflineminus">-: mEntries(NULL), mNbEntries(0)</span>
<a href="#l73.320"></a><span id="l73.320" class="difflineminus">-{</span>
<a href="#l73.321"></a><span id="l73.321" class="difflineminus">-    MOZ_COUNT_CTOR(nsMapiEntryArray) ;</span>
<a href="#l73.322"></a><span id="l73.322" class="difflineplus">+nsMapiEntryArray::~nsMapiEntryArray(void) {</span>
<a href="#l73.323"></a><span id="l73.323" class="difflineplus">+  if (mEntries) {</span>
<a href="#l73.324"></a><span id="l73.324" class="difflineplus">+    delete[] mEntries;</span>
<a href="#l73.325"></a><span id="l73.325" class="difflineplus">+  }</span>
<a href="#l73.326"></a><span id="l73.326" class="difflineplus">+  MOZ_COUNT_DTOR(nsMapiEntryArray);</span>
<a href="#l73.327"></a><span id="l73.327"> }</span>
<a href="#l73.328"></a><span id="l73.328"> </span>
<a href="#l73.329"></a><span id="l73.329" class="difflineminus">-nsMapiEntryArray::~nsMapiEntryArray(void)</span>
<a href="#l73.330"></a><span id="l73.330" class="difflineminus">-{</span>
<a href="#l73.331"></a><span id="l73.331" class="difflineminus">-    if (mEntries) { delete [] mEntries ; }</span>
<a href="#l73.332"></a><span id="l73.332" class="difflineminus">-    MOZ_COUNT_DTOR(nsMapiEntryArray) ;</span>
<a href="#l73.333"></a><span id="l73.333" class="difflineminus">-}</span>
<a href="#l73.334"></a><span id="l73.334" class="difflineminus">-</span>
<a href="#l73.335"></a><span id="l73.335" class="difflineminus">-void nsMapiEntryArray::CleanUp(void)</span>
<a href="#l73.336"></a><span id="l73.336" class="difflineminus">-{</span>
<a href="#l73.337"></a><span id="l73.337" class="difflineminus">-    if (mEntries != NULL) {</span>
<a href="#l73.338"></a><span id="l73.338" class="difflineminus">-        delete [] mEntries ;</span>
<a href="#l73.339"></a><span id="l73.339" class="difflineminus">-        mEntries = NULL ;</span>
<a href="#l73.340"></a><span id="l73.340" class="difflineminus">-        mNbEntries = 0 ;</span>
<a href="#l73.341"></a><span id="l73.341" class="difflineminus">-    }</span>
<a href="#l73.342"></a><span id="l73.342" class="difflineplus">+void nsMapiEntryArray::CleanUp(void) {</span>
<a href="#l73.343"></a><span id="l73.343" class="difflineplus">+  if (mEntries != NULL) {</span>
<a href="#l73.344"></a><span id="l73.344" class="difflineplus">+    delete[] mEntries;</span>
<a href="#l73.345"></a><span id="l73.345" class="difflineplus">+    mEntries = NULL;</span>
<a href="#l73.346"></a><span id="l73.346" class="difflineplus">+    mNbEntries = 0;</span>
<a href="#l73.347"></a><span id="l73.347" class="difflineplus">+  }</span>
<a href="#l73.348"></a><span id="l73.348"> }</span>
<a href="#l73.349"></a><span id="l73.349"> </span>
<a href="#l73.350"></a><span id="l73.350"> using namespace mozilla;</span>
<a href="#l73.351"></a><span id="l73.351"> </span>
<a href="#l73.352"></a><span id="l73.352"> uint32_t nsAbWinHelper::mEntryCounter = 0;</span>
<a href="#l73.353"></a><span id="l73.353"> nsAutoPtr&lt;mozilla::Mutex&gt; nsAbWinHelper::mMutex;</span>
<a href="#l73.354"></a><span id="l73.354"> uint32_t nsAbWinHelper::mUseCount = 0;</span>
<a href="#l73.355"></a><span id="l73.355"> // There seems to be a deadlock/auto-destruction issue</span>
<a href="#l73.356"></a><span id="l73.356"> // in MAPI when multiple threads perform init/release</span>
<a href="#l73.357"></a><span id="l73.357"> // operations at the same time. So I've put a mutex</span>
<a href="#l73.358"></a><span id="l73.358"> // around both the initialize process and the destruction</span>
<a href="#l73.359"></a><span id="l73.359"> // one. I just hope the rest of the calls don't need the</span>
<a href="#l73.360"></a><span id="l73.360"> // same protection (MAPI is supposed to be thread-safe).</span>
<a href="#l73.361"></a><span id="l73.361"> </span>
<a href="#l73.362"></a><span id="l73.362" class="difflineminus">-nsAbWinHelper::nsAbWinHelper(void)</span>
<a href="#l73.363"></a><span id="l73.363" class="difflineminus">-  : mLastError(S_OK)</span>
<a href="#l73.364"></a><span id="l73.364" class="difflineminus">-  , mAddressBook(NULL)</span>
<a href="#l73.365"></a><span id="l73.365" class="difflineminus">-{</span>
<a href="#l73.366"></a><span id="l73.366" class="difflineminus">-  if (!mUseCount++)</span>
<a href="#l73.367"></a><span id="l73.367" class="difflineminus">-    mMutex = new mozilla::Mutex(&quot;nsAbWinHelper.mMutex&quot;);</span>
<a href="#l73.368"></a><span id="l73.368" class="difflineplus">+nsAbWinHelper::nsAbWinHelper(void) : mLastError(S_OK), mAddressBook(NULL) {</span>
<a href="#l73.369"></a><span id="l73.369" class="difflineplus">+  if (!mUseCount++) mMutex = new mozilla::Mutex(&quot;nsAbWinHelper.mMutex&quot;);</span>
<a href="#l73.370"></a><span id="l73.370"> </span>
<a href="#l73.371"></a><span id="l73.371">   MOZ_COUNT_CTOR(nsAbWinHelper);</span>
<a href="#l73.372"></a><span id="l73.372"> }</span>
<a href="#l73.373"></a><span id="l73.373"> </span>
<a href="#l73.374"></a><span id="l73.374" class="difflineminus">-nsAbWinHelper::~nsAbWinHelper(void)</span>
<a href="#l73.375"></a><span id="l73.375" class="difflineminus">-{</span>
<a href="#l73.376"></a><span id="l73.376" class="difflineminus">-  if (!--mUseCount)</span>
<a href="#l73.377"></a><span id="l73.377" class="difflineminus">-    mMutex = nullptr;</span>
<a href="#l73.378"></a><span id="l73.378" class="difflineminus">-  MOZ_COUNT_DTOR(nsAbWinHelper) ;</span>
<a href="#l73.379"></a><span id="l73.379" class="difflineplus">+nsAbWinHelper::~nsAbWinHelper(void) {</span>
<a href="#l73.380"></a><span id="l73.380" class="difflineplus">+  if (!--mUseCount) mMutex = nullptr;</span>
<a href="#l73.381"></a><span id="l73.381" class="difflineplus">+  MOZ_COUNT_DTOR(nsAbWinHelper);</span>
<a href="#l73.382"></a><span id="l73.382"> }</span>
<a href="#l73.383"></a><span id="l73.383"> </span>
<a href="#l73.384"></a><span id="l73.384" class="difflineminus">-BOOL nsAbWinHelper::GetFolders(nsMapiEntryArray&amp; aFolders)</span>
<a href="#l73.385"></a><span id="l73.385" class="difflineminus">-{</span>
<a href="#l73.386"></a><span id="l73.386" class="difflineminus">-    aFolders.CleanUp() ;</span>
<a href="#l73.387"></a><span id="l73.387" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPABCONT&gt; rootFolder ;</span>
<a href="#l73.388"></a><span id="l73.388" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPITABLE&gt; folders ;</span>
<a href="#l73.389"></a><span id="l73.389" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.390"></a><span id="l73.390" class="difflineminus">-    ULONG rowCount = 0 ;</span>
<a href="#l73.391"></a><span id="l73.391" class="difflineminus">-    SRestriction restriction ;</span>
<a href="#l73.392"></a><span id="l73.392" class="difflineminus">-    SPropTagArray folderColumns ;</span>
<a href="#l73.393"></a><span id="l73.393" class="difflineplus">+BOOL nsAbWinHelper::GetFolders(nsMapiEntryArray&amp; aFolders) {</span>
<a href="#l73.394"></a><span id="l73.394" class="difflineplus">+  aFolders.CleanUp();</span>
<a href="#l73.395"></a><span id="l73.395" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPABCONT&gt; rootFolder;</span>
<a href="#l73.396"></a><span id="l73.396" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPITABLE&gt; folders;</span>
<a href="#l73.397"></a><span id="l73.397" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.398"></a><span id="l73.398" class="difflineplus">+  ULONG rowCount = 0;</span>
<a href="#l73.399"></a><span id="l73.399" class="difflineplus">+  SRestriction restriction;</span>
<a href="#l73.400"></a><span id="l73.400" class="difflineplus">+  SPropTagArray folderColumns;</span>
<a href="#l73.401"></a><span id="l73.401"> </span>
<a href="#l73.402"></a><span id="l73.402" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(0, NULL, NULL, 0, &amp;objType,</span>
<a href="#l73.403"></a><span id="l73.403" class="difflineminus">-                                         rootFolder) ;</span>
<a href="#l73.404"></a><span id="l73.404" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.405"></a><span id="l73.405" class="difflineminus">-        PRINTF((&quot;Cannot open root %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.406"></a><span id="l73.406" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.407"></a><span id="l73.407" class="difflineminus">-    }</span>
<a href="#l73.408"></a><span id="l73.408" class="difflineminus">-    mLastError = rootFolder-&gt;GetHierarchyTable(0, folders) ;</span>
<a href="#l73.409"></a><span id="l73.409" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.410"></a><span id="l73.410" class="difflineminus">-        PRINTF((&quot;Cannot get hierarchy %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.411"></a><span id="l73.411" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.412"></a><span id="l73.412" class="difflineminus">-    }</span>
<a href="#l73.413"></a><span id="l73.413" class="difflineminus">-    // We only take into account modifiable containers,</span>
<a href="#l73.414"></a><span id="l73.414" class="difflineminus">-    // otherwise, we end up with all the directory services...</span>
<a href="#l73.415"></a><span id="l73.415" class="difflineminus">-    restriction.rt = RES_BITMASK ;</span>
<a href="#l73.416"></a><span id="l73.416" class="difflineminus">-    restriction.res.resBitMask.ulPropTag = PR_CONTAINER_FLAGS ;</span>
<a href="#l73.417"></a><span id="l73.417" class="difflineminus">-    restriction.res.resBitMask.relBMR = BMR_NEZ ;</span>
<a href="#l73.418"></a><span id="l73.418" class="difflineminus">-    restriction.res.resBitMask.ulMask = AB_MODIFIABLE ;</span>
<a href="#l73.419"></a><span id="l73.419" class="difflineminus">-    mLastError = folders-&gt;Restrict(&amp;restriction, 0) ;</span>
<a href="#l73.420"></a><span id="l73.420" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.421"></a><span id="l73.421" class="difflineminus">-        PRINTF((&quot;Cannot restrict table %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.422"></a><span id="l73.422" class="difflineminus">-    }</span>
<a href="#l73.423"></a><span id="l73.423" class="difflineminus">-    folderColumns.cValues = 1 ;</span>
<a href="#l73.424"></a><span id="l73.424" class="difflineminus">-    folderColumns.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l73.425"></a><span id="l73.425" class="difflineminus">-    mLastError = folders-&gt;SetColumns(&amp;folderColumns, 0) ;</span>
<a href="#l73.426"></a><span id="l73.426" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.427"></a><span id="l73.427" class="difflineminus">-        PRINTF((&quot;Cannot set columns %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.428"></a><span id="l73.428" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.429"></a><span id="l73.429" class="difflineminus">-    }</span>
<a href="#l73.430"></a><span id="l73.430" class="difflineminus">-    mLastError = folders-&gt;GetRowCount(0, &amp;rowCount) ;</span>
<a href="#l73.431"></a><span id="l73.431" class="difflineminus">-    if (HR_SUCCEEDED(mLastError)) {</span>
<a href="#l73.432"></a><span id="l73.432" class="difflineminus">-        aFolders.mEntries = new nsMapiEntry[rowCount] ;</span>
<a href="#l73.433"></a><span id="l73.433" class="difflineminus">-        aFolders.mNbEntries = 0 ;</span>
<a href="#l73.434"></a><span id="l73.434" class="difflineminus">-        do {</span>
<a href="#l73.435"></a><span id="l73.435" class="difflineminus">-            LPSRowSet rowSet = NULL ;</span>
<a href="#l73.436"></a><span id="l73.436" class="difflineplus">+  mLastError = mAddressBook-&gt;OpenEntry(0, NULL, NULL, 0, &amp;objType, rootFolder);</span>
<a href="#l73.437"></a><span id="l73.437" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.438"></a><span id="l73.438" class="difflineplus">+    PRINTF((&quot;Cannot open root %08x.\n&quot;, mLastError));</span>
<a href="#l73.439"></a><span id="l73.439" class="difflineplus">+    return FALSE;</span>
<a href="#l73.440"></a><span id="l73.440" class="difflineplus">+  }</span>
<a href="#l73.441"></a><span id="l73.441" class="difflineplus">+  mLastError = rootFolder-&gt;GetHierarchyTable(0, folders);</span>
<a href="#l73.442"></a><span id="l73.442" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.443"></a><span id="l73.443" class="difflineplus">+    PRINTF((&quot;Cannot get hierarchy %08x.\n&quot;, mLastError));</span>
<a href="#l73.444"></a><span id="l73.444" class="difflineplus">+    return FALSE;</span>
<a href="#l73.445"></a><span id="l73.445" class="difflineplus">+  }</span>
<a href="#l73.446"></a><span id="l73.446" class="difflineplus">+  // We only take into account modifiable containers,</span>
<a href="#l73.447"></a><span id="l73.447" class="difflineplus">+  // otherwise, we end up with all the directory services...</span>
<a href="#l73.448"></a><span id="l73.448" class="difflineplus">+  restriction.rt = RES_BITMASK;</span>
<a href="#l73.449"></a><span id="l73.449" class="difflineplus">+  restriction.res.resBitMask.ulPropTag = PR_CONTAINER_FLAGS;</span>
<a href="#l73.450"></a><span id="l73.450" class="difflineplus">+  restriction.res.resBitMask.relBMR = BMR_NEZ;</span>
<a href="#l73.451"></a><span id="l73.451" class="difflineplus">+  restriction.res.resBitMask.ulMask = AB_MODIFIABLE;</span>
<a href="#l73.452"></a><span id="l73.452" class="difflineplus">+  mLastError = folders-&gt;Restrict(&amp;restriction, 0);</span>
<a href="#l73.453"></a><span id="l73.453" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.454"></a><span id="l73.454" class="difflineplus">+    PRINTF((&quot;Cannot restrict table %08x.\n&quot;, mLastError));</span>
<a href="#l73.455"></a><span id="l73.455" class="difflineplus">+  }</span>
<a href="#l73.456"></a><span id="l73.456" class="difflineplus">+  folderColumns.cValues = 1;</span>
<a href="#l73.457"></a><span id="l73.457" class="difflineplus">+  folderColumns.aulPropTag[0] = PR_ENTRYID;</span>
<a href="#l73.458"></a><span id="l73.458" class="difflineplus">+  mLastError = folders-&gt;SetColumns(&amp;folderColumns, 0);</span>
<a href="#l73.459"></a><span id="l73.459" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.460"></a><span id="l73.460" class="difflineplus">+    PRINTF((&quot;Cannot set columns %08x.\n&quot;, mLastError));</span>
<a href="#l73.461"></a><span id="l73.461" class="difflineplus">+    return FALSE;</span>
<a href="#l73.462"></a><span id="l73.462" class="difflineplus">+  }</span>
<a href="#l73.463"></a><span id="l73.463" class="difflineplus">+  mLastError = folders-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l73.464"></a><span id="l73.464" class="difflineplus">+  if (HR_SUCCEEDED(mLastError)) {</span>
<a href="#l73.465"></a><span id="l73.465" class="difflineplus">+    aFolders.mEntries = new nsMapiEntry[rowCount];</span>
<a href="#l73.466"></a><span id="l73.466" class="difflineplus">+    aFolders.mNbEntries = 0;</span>
<a href="#l73.467"></a><span id="l73.467" class="difflineplus">+    do {</span>
<a href="#l73.468"></a><span id="l73.468" class="difflineplus">+      LPSRowSet rowSet = NULL;</span>
<a href="#l73.469"></a><span id="l73.469"> </span>
<a href="#l73.470"></a><span id="l73.470" class="difflineminus">-            rowCount = 0 ;</span>
<a href="#l73.471"></a><span id="l73.471" class="difflineminus">-            mLastError = folders-&gt;QueryRows(1, 0, &amp;rowSet) ;</span>
<a href="#l73.472"></a><span id="l73.472" class="difflineminus">-            if (HR_SUCCEEDED(mLastError)) {</span>
<a href="#l73.473"></a><span id="l73.473" class="difflineminus">-                rowCount = rowSet-&gt;cRows ;</span>
<a href="#l73.474"></a><span id="l73.474" class="difflineminus">-                if (rowCount &gt; 0) {</span>
<a href="#l73.475"></a><span id="l73.475" class="difflineminus">-                    nsMapiEntry&amp; current = aFolders.mEntries[aFolders.mNbEntries++] ;</span>
<a href="#l73.476"></a><span id="l73.476" class="difflineminus">-                    SPropValue&amp; currentValue = rowSet-&gt;aRow-&gt;lpProps[0] ;</span>
<a href="#l73.477"></a><span id="l73.477" class="difflineplus">+      rowCount = 0;</span>
<a href="#l73.478"></a><span id="l73.478" class="difflineplus">+      mLastError = folders-&gt;QueryRows(1, 0, &amp;rowSet);</span>
<a href="#l73.479"></a><span id="l73.479" class="difflineplus">+      if (HR_SUCCEEDED(mLastError)) {</span>
<a href="#l73.480"></a><span id="l73.480" class="difflineplus">+        rowCount = rowSet-&gt;cRows;</span>
<a href="#l73.481"></a><span id="l73.481" class="difflineplus">+        if (rowCount &gt; 0) {</span>
<a href="#l73.482"></a><span id="l73.482" class="difflineplus">+          nsMapiEntry&amp; current = aFolders.mEntries[aFolders.mNbEntries++];</span>
<a href="#l73.483"></a><span id="l73.483" class="difflineplus">+          SPropValue&amp; currentValue = rowSet-&gt;aRow-&gt;lpProps[0];</span>
<a href="#l73.484"></a><span id="l73.484"> </span>
<a href="#l73.485"></a><span id="l73.485" class="difflineminus">-                    current.Assign(currentValue.Value.bin.cb,</span>
<a href="#l73.486"></a><span id="l73.486" class="difflineminus">-                                   reinterpret_cast&lt;LPENTRYID&gt;(currentValue.Value.bin.lpb)) ;</span>
<a href="#l73.487"></a><span id="l73.487" class="difflineminus">-                }</span>
<a href="#l73.488"></a><span id="l73.488" class="difflineminus">-                MyFreeProws(rowSet) ;</span>
<a href="#l73.489"></a><span id="l73.489" class="difflineminus">-            }</span>
<a href="#l73.490"></a><span id="l73.490" class="difflineminus">-            else {</span>
<a href="#l73.491"></a><span id="l73.491" class="difflineminus">-                PRINTF((&quot;Cannot query rows %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.492"></a><span id="l73.492" class="difflineminus">-            }</span>
<a href="#l73.493"></a><span id="l73.493" class="difflineminus">-        } while (rowCount &gt; 0) ;</span>
<a href="#l73.494"></a><span id="l73.494" class="difflineminus">-    }</span>
<a href="#l73.495"></a><span id="l73.495" class="difflineminus">-    return HR_SUCCEEDED(mLastError) ;</span>
<a href="#l73.496"></a><span id="l73.496" class="difflineplus">+          current.Assign(</span>
<a href="#l73.497"></a><span id="l73.497" class="difflineplus">+              currentValue.Value.bin.cb,</span>
<a href="#l73.498"></a><span id="l73.498" class="difflineplus">+              reinterpret_cast&lt;LPENTRYID&gt;(currentValue.Value.bin.lpb));</span>
<a href="#l73.499"></a><span id="l73.499" class="difflineplus">+        }</span>
<a href="#l73.500"></a><span id="l73.500" class="difflineplus">+        MyFreeProws(rowSet);</span>
<a href="#l73.501"></a><span id="l73.501" class="difflineplus">+      } else {</span>
<a href="#l73.502"></a><span id="l73.502" class="difflineplus">+        PRINTF((&quot;Cannot query rows %08x.\n&quot;, mLastError));</span>
<a href="#l73.503"></a><span id="l73.503" class="difflineplus">+      }</span>
<a href="#l73.504"></a><span id="l73.504" class="difflineplus">+    } while (rowCount &gt; 0);</span>
<a href="#l73.505"></a><span id="l73.505" class="difflineplus">+  }</span>
<a href="#l73.506"></a><span id="l73.506" class="difflineplus">+  return HR_SUCCEEDED(mLastError);</span>
<a href="#l73.507"></a><span id="l73.507"> }</span>
<a href="#l73.508"></a><span id="l73.508"> </span>
<a href="#l73.509"></a><span id="l73.509" class="difflineminus">-BOOL nsAbWinHelper::GetCards(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l73.510"></a><span id="l73.510" class="difflineminus">-                             nsMapiEntryArray&amp; aCards)</span>
<a href="#l73.511"></a><span id="l73.511" class="difflineminus">-{</span>
<a href="#l73.512"></a><span id="l73.512" class="difflineminus">-    aCards.CleanUp() ;</span>
<a href="#l73.513"></a><span id="l73.513" class="difflineminus">-    return GetContents(aParent, aRestriction, &amp;aCards.mEntries, aCards.mNbEntries, 0) ;</span>
<a href="#l73.514"></a><span id="l73.514" class="difflineplus">+BOOL nsAbWinHelper::GetCards(const nsMapiEntry&amp; aParent,</span>
<a href="#l73.515"></a><span id="l73.515" class="difflineplus">+                             LPSRestriction aRestriction,</span>
<a href="#l73.516"></a><span id="l73.516" class="difflineplus">+                             nsMapiEntryArray&amp; aCards) {</span>
<a href="#l73.517"></a><span id="l73.517" class="difflineplus">+  aCards.CleanUp();</span>
<a href="#l73.518"></a><span id="l73.518" class="difflineplus">+  return GetContents(aParent, aRestriction, &amp;aCards.mEntries, aCards.mNbEntries,</span>
<a href="#l73.519"></a><span id="l73.519" class="difflineplus">+                     0);</span>
<a href="#l73.520"></a><span id="l73.520"> }</span>
<a href="#l73.521"></a><span id="l73.521"> </span>
<a href="#l73.522"></a><span id="l73.522" class="difflineminus">-BOOL nsAbWinHelper::GetNodes(const nsMapiEntry&amp; aParent, nsMapiEntryArray&amp; aNodes)</span>
<a href="#l73.523"></a><span id="l73.523" class="difflineminus">-{</span>
<a href="#l73.524"></a><span id="l73.524" class="difflineminus">-    aNodes.CleanUp() ;</span>
<a href="#l73.525"></a><span id="l73.525" class="difflineminus">-    return GetContents(aParent, NULL, &amp;aNodes.mEntries, aNodes.mNbEntries, MAPI_DISTLIST) ;</span>
<a href="#l73.526"></a><span id="l73.526" class="difflineplus">+BOOL nsAbWinHelper::GetNodes(const nsMapiEntry&amp; aParent,</span>
<a href="#l73.527"></a><span id="l73.527" class="difflineplus">+                             nsMapiEntryArray&amp; aNodes) {</span>
<a href="#l73.528"></a><span id="l73.528" class="difflineplus">+  aNodes.CleanUp();</span>
<a href="#l73.529"></a><span id="l73.529" class="difflineplus">+  return GetContents(aParent, NULL, &amp;aNodes.mEntries, aNodes.mNbEntries,</span>
<a href="#l73.530"></a><span id="l73.530" class="difflineplus">+                     MAPI_DISTLIST);</span>
<a href="#l73.531"></a><span id="l73.531"> }</span>
<a href="#l73.532"></a><span id="l73.532"> </span>
<a href="#l73.533"></a><span id="l73.533" class="difflineminus">-BOOL nsAbWinHelper::GetCardsCount(const nsMapiEntry&amp; aParent, ULONG&amp; aNbCards)</span>
<a href="#l73.534"></a><span id="l73.534" class="difflineminus">-{</span>
<a href="#l73.535"></a><span id="l73.535" class="difflineminus">-    aNbCards = 0 ;</span>
<a href="#l73.536"></a><span id="l73.536" class="difflineminus">-    return GetContents(aParent, NULL, NULL, aNbCards, 0) ;</span>
<a href="#l73.537"></a><span id="l73.537" class="difflineplus">+BOOL nsAbWinHelper::GetCardsCount(const nsMapiEntry&amp; aParent, ULONG&amp; aNbCards) {</span>
<a href="#l73.538"></a><span id="l73.538" class="difflineplus">+  aNbCards = 0;</span>
<a href="#l73.539"></a><span id="l73.539" class="difflineplus">+  return GetContents(aParent, NULL, NULL, aNbCards, 0);</span>
<a href="#l73.540"></a><span id="l73.540"> }</span>
<a href="#l73.541"></a><span id="l73.541"> </span>
<a href="#l73.542"></a><span id="l73.542"> BOOL nsAbWinHelper::GetPropertyString(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.543"></a><span id="l73.543" class="difflineminus">-                                      ULONG aPropertyTag,</span>
<a href="#l73.544"></a><span id="l73.544" class="difflineminus">-                                      nsCString&amp; aName)</span>
<a href="#l73.545"></a><span id="l73.545" class="difflineminus">-{</span>
<a href="#l73.546"></a><span id="l73.546" class="difflineminus">-    aName.Truncate() ;</span>
<a href="#l73.547"></a><span id="l73.547" class="difflineminus">-    LPSPropValue values = NULL ;</span>
<a href="#l73.548"></a><span id="l73.548" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.549"></a><span id="l73.549" class="difflineplus">+                                      ULONG aPropertyTag, nsCString&amp; aName) {</span>
<a href="#l73.550"></a><span id="l73.550" class="difflineplus">+  aName.Truncate();</span>
<a href="#l73.551"></a><span id="l73.551" class="difflineplus">+  LPSPropValue values = NULL;</span>
<a href="#l73.552"></a><span id="l73.552" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.553"></a><span id="l73.553"> </span>
<a href="#l73.554"></a><span id="l73.554" class="difflineminus">-    if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l73.555"></a><span id="l73.555" class="difflineminus">-    if (valueCount == 1 &amp;&amp; values != NULL) {</span>
<a href="#l73.556"></a><span id="l73.556" class="difflineminus">-        if (PROP_TYPE(values-&gt;ulPropTag) == PT_STRING8)</span>
<a href="#l73.557"></a><span id="l73.557" class="difflineminus">-            aName = values-&gt;Value.lpszA ;</span>
<a href="#l73.558"></a><span id="l73.558" class="difflineminus">-        else if (PROP_TYPE(values-&gt;ulPropTag) == PT_UNICODE)</span>
<a href="#l73.559"></a><span id="l73.559" class="difflineminus">-            aName = NS_LossyConvertUTF16toASCII(values-&gt;Value.lpszW);</span>
<a href="#l73.560"></a><span id="l73.560" class="difflineminus">-    }</span>
<a href="#l73.561"></a><span id="l73.561" class="difflineminus">-    FreeBuffer(values) ;</span>
<a href="#l73.562"></a><span id="l73.562" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.563"></a><span id="l73.563" class="difflineplus">+  if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) {</span>
<a href="#l73.564"></a><span id="l73.564" class="difflineplus">+    return FALSE;</span>
<a href="#l73.565"></a><span id="l73.565" class="difflineplus">+  }</span>
<a href="#l73.566"></a><span id="l73.566" class="difflineplus">+  if (valueCount == 1 &amp;&amp; values != NULL) {</span>
<a href="#l73.567"></a><span id="l73.567" class="difflineplus">+    if (PROP_TYPE(values-&gt;ulPropTag) == PT_STRING8)</span>
<a href="#l73.568"></a><span id="l73.568" class="difflineplus">+      aName = values-&gt;Value.lpszA;</span>
<a href="#l73.569"></a><span id="l73.569" class="difflineplus">+    else if (PROP_TYPE(values-&gt;ulPropTag) == PT_UNICODE)</span>
<a href="#l73.570"></a><span id="l73.570" class="difflineplus">+      aName = NS_LossyConvertUTF16toASCII(values-&gt;Value.lpszW);</span>
<a href="#l73.571"></a><span id="l73.571" class="difflineplus">+  }</span>
<a href="#l73.572"></a><span id="l73.572" class="difflineplus">+  FreeBuffer(values);</span>
<a href="#l73.573"></a><span id="l73.573" class="difflineplus">+  return TRUE;</span>
<a href="#l73.574"></a><span id="l73.574"> }</span>
<a href="#l73.575"></a><span id="l73.575"> </span>
<a href="#l73.576"></a><span id="l73.576" class="difflineminus">-BOOL nsAbWinHelper::GetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l73.577"></a><span id="l73.577" class="difflineminus">-                                       nsString&amp; aName)</span>
<a href="#l73.578"></a><span id="l73.578" class="difflineminus">-{</span>
<a href="#l73.579"></a><span id="l73.579" class="difflineminus">-    aName.Truncate() ;</span>
<a href="#l73.580"></a><span id="l73.580" class="difflineminus">-    LPSPropValue values = NULL ;</span>
<a href="#l73.581"></a><span id="l73.581" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.582"></a><span id="l73.582" class="difflineplus">+BOOL nsAbWinHelper::GetPropertyUString(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.583"></a><span id="l73.583" class="difflineplus">+                                       ULONG aPropertyTag, nsString&amp; aName) {</span>
<a href="#l73.584"></a><span id="l73.584" class="difflineplus">+  aName.Truncate();</span>
<a href="#l73.585"></a><span id="l73.585" class="difflineplus">+  LPSPropValue values = NULL;</span>
<a href="#l73.586"></a><span id="l73.586" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.587"></a><span id="l73.587"> </span>
<a href="#l73.588"></a><span id="l73.588" class="difflineminus">-    if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l73.589"></a><span id="l73.589" class="difflineminus">-    if (valueCount == 1 &amp;&amp; values != NULL) {</span>
<a href="#l73.590"></a><span id="l73.590" class="difflineminus">-        if (PROP_TYPE(values-&gt;ulPropTag) == PT_UNICODE)</span>
<a href="#l73.591"></a><span id="l73.591" class="difflineminus">-            aName = values-&gt;Value.lpszW ;</span>
<a href="#l73.592"></a><span id="l73.592" class="difflineminus">-        else if (PROP_TYPE(values-&gt;ulPropTag) == PT_STRING8)</span>
<a href="#l73.593"></a><span id="l73.593" class="difflineminus">-            aName.AssignASCII(values-&gt;Value.lpszA);</span>
<a href="#l73.594"></a><span id="l73.594" class="difflineminus">-    }</span>
<a href="#l73.595"></a><span id="l73.595" class="difflineminus">-    FreeBuffer(values) ;</span>
<a href="#l73.596"></a><span id="l73.596" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.597"></a><span id="l73.597" class="difflineplus">+  if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) {</span>
<a href="#l73.598"></a><span id="l73.598" class="difflineplus">+    return FALSE;</span>
<a href="#l73.599"></a><span id="l73.599" class="difflineplus">+  }</span>
<a href="#l73.600"></a><span id="l73.600" class="difflineplus">+  if (valueCount == 1 &amp;&amp; values != NULL) {</span>
<a href="#l73.601"></a><span id="l73.601" class="difflineplus">+    if (PROP_TYPE(values-&gt;ulPropTag) == PT_UNICODE)</span>
<a href="#l73.602"></a><span id="l73.602" class="difflineplus">+      aName = values-&gt;Value.lpszW;</span>
<a href="#l73.603"></a><span id="l73.603" class="difflineplus">+    else if (PROP_TYPE(values-&gt;ulPropTag) == PT_STRING8)</span>
<a href="#l73.604"></a><span id="l73.604" class="difflineplus">+      aName.AssignASCII(values-&gt;Value.lpszA);</span>
<a href="#l73.605"></a><span id="l73.605" class="difflineplus">+  }</span>
<a href="#l73.606"></a><span id="l73.606" class="difflineplus">+  FreeBuffer(values);</span>
<a href="#l73.607"></a><span id="l73.607" class="difflineplus">+  return TRUE;</span>
<a href="#l73.608"></a><span id="l73.608"> }</span>
<a href="#l73.609"></a><span id="l73.609"> </span>
<a href="#l73.610"></a><span id="l73.610" class="difflineminus">-BOOL nsAbWinHelper::GetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertyTags,</span>
<a href="#l73.611"></a><span id="l73.611" class="difflineminus">-                                         ULONG aNbProperties, nsString *aNames)</span>
<a href="#l73.612"></a><span id="l73.612" class="difflineminus">-{</span>
<a href="#l73.613"></a><span id="l73.613" class="difflineplus">+BOOL nsAbWinHelper::GetPropertiesUString(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.614"></a><span id="l73.614" class="difflineplus">+                                         const ULONG* aPropertyTags,</span>
<a href="#l73.615"></a><span id="l73.615" class="difflineplus">+                                         ULONG aNbProperties,</span>
<a href="#l73.616"></a><span id="l73.616" class="difflineplus">+                                         nsString* aNames) {</span>
<a href="#l73.617"></a><span id="l73.617">   LPSPropValue values = NULL;</span>
<a href="#l73.618"></a><span id="l73.618">   ULONG valueCount = 0;</span>
<a href="#l73.619"></a><span id="l73.619"> </span>
<a href="#l73.620"></a><span id="l73.620">   if (!GetMAPIProperties(aObject, aPropertyTags, aNbProperties, values,</span>
<a href="#l73.621"></a><span id="l73.621">                          valueCount))</span>
<a href="#l73.622"></a><span id="l73.622">     return FALSE;</span>
<a href="#l73.623"></a><span id="l73.623"> </span>
<a href="#l73.624"></a><span id="l73.624" class="difflineminus">-  if (valueCount == aNbProperties &amp;&amp; values != NULL)</span>
<a href="#l73.625"></a><span id="l73.625" class="difflineminus">-  {</span>
<a href="#l73.626"></a><span id="l73.626" class="difflineminus">-    for (ULONG i = 0 ; i &lt; valueCount ; ++i)</span>
<a href="#l73.627"></a><span id="l73.627" class="difflineminus">-    {</span>
<a href="#l73.628"></a><span id="l73.628" class="difflineminus">-      if (PROP_ID(values[i].ulPropTag) == PROP_ID(aPropertyTags[i]))</span>
<a href="#l73.629"></a><span id="l73.629" class="difflineminus">-      {</span>
<a href="#l73.630"></a><span id="l73.630" class="difflineplus">+  if (valueCount == aNbProperties &amp;&amp; values != NULL) {</span>
<a href="#l73.631"></a><span id="l73.631" class="difflineplus">+    for (ULONG i = 0; i &lt; valueCount; ++i) {</span>
<a href="#l73.632"></a><span id="l73.632" class="difflineplus">+      if (PROP_ID(values[i].ulPropTag) == PROP_ID(aPropertyTags[i])) {</span>
<a href="#l73.633"></a><span id="l73.633">         if (PROP_TYPE(values[i].ulPropTag) == PT_STRING8)</span>
<a href="#l73.634"></a><span id="l73.634">           aNames[i].AssignASCII(values[i].Value.lpszA);</span>
<a href="#l73.635"></a><span id="l73.635">         else if (PROP_TYPE(values[i].ulPropTag) == PT_UNICODE)</span>
<a href="#l73.636"></a><span id="l73.636">           aNames[i] = values[i].Value.lpszW;</span>
<a href="#l73.637"></a><span id="l73.637">       }</span>
<a href="#l73.638"></a><span id="l73.638">     }</span>
<a href="#l73.639"></a><span id="l73.639">     FreeBuffer(values);</span>
<a href="#l73.640"></a><span id="l73.640">   }</span>
<a href="#l73.641"></a><span id="l73.641">   return TRUE;</span>
<a href="#l73.642"></a><span id="l73.642"> }</span>
<a href="#l73.643"></a><span id="l73.643"> </span>
<a href="#l73.644"></a><span id="l73.644" class="difflineminus">-BOOL nsAbWinHelper::GetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l73.645"></a><span id="l73.645" class="difflineminus">-                                    WORD&amp; aYear, WORD&amp; aMonth, WORD&amp; aDay)</span>
<a href="#l73.646"></a><span id="l73.646" class="difflineminus">-{</span>
<a href="#l73.647"></a><span id="l73.647" class="difflineminus">-    aYear = 0 ;</span>
<a href="#l73.648"></a><span id="l73.648" class="difflineminus">-    aMonth = 0 ;</span>
<a href="#l73.649"></a><span id="l73.649" class="difflineminus">-    aDay = 0 ;</span>
<a href="#l73.650"></a><span id="l73.650" class="difflineminus">-    LPSPropValue values = NULL ;</span>
<a href="#l73.651"></a><span id="l73.651" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.652"></a><span id="l73.652" class="difflineplus">+BOOL nsAbWinHelper::GetPropertyDate(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.653"></a><span id="l73.653" class="difflineplus">+                                    ULONG aPropertyTag, WORD&amp; aYear,</span>
<a href="#l73.654"></a><span id="l73.654" class="difflineplus">+                                    WORD&amp; aMonth, WORD&amp; aDay) {</span>
<a href="#l73.655"></a><span id="l73.655" class="difflineplus">+  aYear = 0;</span>
<a href="#l73.656"></a><span id="l73.656" class="difflineplus">+  aMonth = 0;</span>
<a href="#l73.657"></a><span id="l73.657" class="difflineplus">+  aDay = 0;</span>
<a href="#l73.658"></a><span id="l73.658" class="difflineplus">+  LPSPropValue values = NULL;</span>
<a href="#l73.659"></a><span id="l73.659" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.660"></a><span id="l73.660"> </span>
<a href="#l73.661"></a><span id="l73.661" class="difflineminus">-    if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l73.662"></a><span id="l73.662" class="difflineminus">-    if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp; PROP_TYPE(values-&gt;ulPropTag) == PT_SYSTIME) {</span>
<a href="#l73.663"></a><span id="l73.663" class="difflineminus">-        SYSTEMTIME readableTime ;</span>
<a href="#l73.664"></a><span id="l73.664" class="difflineplus">+  if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) {</span>
<a href="#l73.665"></a><span id="l73.665" class="difflineplus">+    return FALSE;</span>
<a href="#l73.666"></a><span id="l73.666" class="difflineplus">+  }</span>
<a href="#l73.667"></a><span id="l73.667" class="difflineplus">+  if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp;</span>
<a href="#l73.668"></a><span id="l73.668" class="difflineplus">+      PROP_TYPE(values-&gt;ulPropTag) == PT_SYSTIME) {</span>
<a href="#l73.669"></a><span id="l73.669" class="difflineplus">+    SYSTEMTIME readableTime;</span>
<a href="#l73.670"></a><span id="l73.670"> </span>
<a href="#l73.671"></a><span id="l73.671" class="difflineminus">-        if (FileTimeToSystemTime(&amp;values-&gt;Value.ft, &amp;readableTime)) {</span>
<a href="#l73.672"></a><span id="l73.672" class="difflineminus">-            aYear = readableTime.wYear ;</span>
<a href="#l73.673"></a><span id="l73.673" class="difflineminus">-            aMonth = readableTime.wMonth ;</span>
<a href="#l73.674"></a><span id="l73.674" class="difflineminus">-            aDay = readableTime.wDay ;</span>
<a href="#l73.675"></a><span id="l73.675" class="difflineminus">-        }</span>
<a href="#l73.676"></a><span id="l73.676" class="difflineplus">+    if (FileTimeToSystemTime(&amp;values-&gt;Value.ft, &amp;readableTime)) {</span>
<a href="#l73.677"></a><span id="l73.677" class="difflineplus">+      aYear = readableTime.wYear;</span>
<a href="#l73.678"></a><span id="l73.678" class="difflineplus">+      aMonth = readableTime.wMonth;</span>
<a href="#l73.679"></a><span id="l73.679" class="difflineplus">+      aDay = readableTime.wDay;</span>
<a href="#l73.680"></a><span id="l73.680">     }</span>
<a href="#l73.681"></a><span id="l73.681" class="difflineminus">-    FreeBuffer(values) ;</span>
<a href="#l73.682"></a><span id="l73.682" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.683"></a><span id="l73.683" class="difflineplus">+  }</span>
<a href="#l73.684"></a><span id="l73.684" class="difflineplus">+  FreeBuffer(values);</span>
<a href="#l73.685"></a><span id="l73.685" class="difflineplus">+  return TRUE;</span>
<a href="#l73.686"></a><span id="l73.686"> }</span>
<a href="#l73.687"></a><span id="l73.687"> </span>
<a href="#l73.688"></a><span id="l73.688"> BOOL nsAbWinHelper::GetPropertyLong(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.689"></a><span id="l73.689" class="difflineminus">-                                    ULONG aPropertyTag,</span>
<a href="#l73.690"></a><span id="l73.690" class="difflineminus">-                                    ULONG&amp; aValue)</span>
<a href="#l73.691"></a><span id="l73.691" class="difflineminus">-{</span>
<a href="#l73.692"></a><span id="l73.692" class="difflineminus">-    aValue = 0 ;</span>
<a href="#l73.693"></a><span id="l73.693" class="difflineminus">-    LPSPropValue values = NULL ;</span>
<a href="#l73.694"></a><span id="l73.694" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.695"></a><span id="l73.695" class="difflineplus">+                                    ULONG aPropertyTag, ULONG&amp; aValue) {</span>
<a href="#l73.696"></a><span id="l73.696" class="difflineplus">+  aValue = 0;</span>
<a href="#l73.697"></a><span id="l73.697" class="difflineplus">+  LPSPropValue values = NULL;</span>
<a href="#l73.698"></a><span id="l73.698" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.699"></a><span id="l73.699"> </span>
<a href="#l73.700"></a><span id="l73.700" class="difflineminus">-    if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l73.701"></a><span id="l73.701" class="difflineminus">-    if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp; PROP_TYPE(values-&gt;ulPropTag) == PT_LONG) {</span>
<a href="#l73.702"></a><span id="l73.702" class="difflineminus">-        aValue = values-&gt;Value.ul ;</span>
<a href="#l73.703"></a><span id="l73.703" class="difflineminus">-    }</span>
<a href="#l73.704"></a><span id="l73.704" class="difflineminus">-    FreeBuffer(values) ;</span>
<a href="#l73.705"></a><span id="l73.705" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.706"></a><span id="l73.706" class="difflineplus">+  if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) {</span>
<a href="#l73.707"></a><span id="l73.707" class="difflineplus">+    return FALSE;</span>
<a href="#l73.708"></a><span id="l73.708" class="difflineplus">+  }</span>
<a href="#l73.709"></a><span id="l73.709" class="difflineplus">+  if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp;</span>
<a href="#l73.710"></a><span id="l73.710" class="difflineplus">+      PROP_TYPE(values-&gt;ulPropTag) == PT_LONG) {</span>
<a href="#l73.711"></a><span id="l73.711" class="difflineplus">+    aValue = values-&gt;Value.ul;</span>
<a href="#l73.712"></a><span id="l73.712" class="difflineplus">+  }</span>
<a href="#l73.713"></a><span id="l73.713" class="difflineplus">+  FreeBuffer(values);</span>
<a href="#l73.714"></a><span id="l73.714" class="difflineplus">+  return TRUE;</span>
<a href="#l73.715"></a><span id="l73.715"> }</span>
<a href="#l73.716"></a><span id="l73.716"> </span>
<a href="#l73.717"></a><span id="l73.717" class="difflineminus">-BOOL nsAbWinHelper::GetPropertyBin(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l73.718"></a><span id="l73.718" class="difflineminus">-                                   nsMapiEntry&amp; aValue)</span>
<a href="#l73.719"></a><span id="l73.719" class="difflineminus">-{</span>
<a href="#l73.720"></a><span id="l73.720" class="difflineminus">-    aValue.Assign(0, NULL) ;</span>
<a href="#l73.721"></a><span id="l73.721" class="difflineminus">-    LPSPropValue values = NULL ;</span>
<a href="#l73.722"></a><span id="l73.722" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.723"></a><span id="l73.723" class="difflineplus">+BOOL nsAbWinHelper::GetPropertyBin(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.724"></a><span id="l73.724" class="difflineplus">+                                   ULONG aPropertyTag, nsMapiEntry&amp; aValue) {</span>
<a href="#l73.725"></a><span id="l73.725" class="difflineplus">+  aValue.Assign(0, NULL);</span>
<a href="#l73.726"></a><span id="l73.726" class="difflineplus">+  LPSPropValue values = NULL;</span>
<a href="#l73.727"></a><span id="l73.727" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.728"></a><span id="l73.728"> </span>
<a href="#l73.729"></a><span id="l73.729" class="difflineminus">-    if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l73.730"></a><span id="l73.730" class="difflineminus">-    if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp; PROP_TYPE(values-&gt;ulPropTag) == PT_BINARY) {</span>
<a href="#l73.731"></a><span id="l73.731" class="difflineminus">-        aValue.Assign(values-&gt;Value.bin.cb,</span>
<a href="#l73.732"></a><span id="l73.732" class="difflineminus">-                      reinterpret_cast&lt;LPENTRYID&gt;(values-&gt;Value.bin.lpb)) ;</span>
<a href="#l73.733"></a><span id="l73.733" class="difflineminus">-    }</span>
<a href="#l73.734"></a><span id="l73.734" class="difflineminus">-    FreeBuffer(values) ;</span>
<a href="#l73.735"></a><span id="l73.735" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.736"></a><span id="l73.736" class="difflineplus">+  if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) {</span>
<a href="#l73.737"></a><span id="l73.737" class="difflineplus">+    return FALSE;</span>
<a href="#l73.738"></a><span id="l73.738" class="difflineplus">+  }</span>
<a href="#l73.739"></a><span id="l73.739" class="difflineplus">+  if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp;</span>
<a href="#l73.740"></a><span id="l73.740" class="difflineplus">+      PROP_TYPE(values-&gt;ulPropTag) == PT_BINARY) {</span>
<a href="#l73.741"></a><span id="l73.741" class="difflineplus">+    aValue.Assign(values-&gt;Value.bin.cb,</span>
<a href="#l73.742"></a><span id="l73.742" class="difflineplus">+                  reinterpret_cast&lt;LPENTRYID&gt;(values-&gt;Value.bin.lpb));</span>
<a href="#l73.743"></a><span id="l73.743" class="difflineplus">+  }</span>
<a href="#l73.744"></a><span id="l73.744" class="difflineplus">+  FreeBuffer(values);</span>
<a href="#l73.745"></a><span id="l73.745" class="difflineplus">+  return TRUE;</span>
<a href="#l73.746"></a><span id="l73.746"> }</span>
<a href="#l73.747"></a><span id="l73.747"> </span>
<a href="#l73.748"></a><span id="l73.748"> // This function, supposedly indicating whether a particular entry was</span>
<a href="#l73.749"></a><span id="l73.749"> // in a particular container, doesn't seem to work very well (has</span>
<a href="#l73.750"></a><span id="l73.750"> // a tendency to return TRUE even if we're talking to different containers...).</span>
<a href="#l73.751"></a><span id="l73.751" class="difflineminus">-BOOL nsAbWinHelper::TestOpenEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry)</span>
<a href="#l73.752"></a><span id="l73.752" class="difflineminus">-{</span>
<a href="#l73.753"></a><span id="l73.753" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPICONTAINER&gt; container ;</span>
<a href="#l73.754"></a><span id="l73.754" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; subObject ;</span>
<a href="#l73.755"></a><span id="l73.755" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.756"></a><span id="l73.756" class="difflineplus">+BOOL nsAbWinHelper::TestOpenEntry(const nsMapiEntry&amp; aContainer,</span>
<a href="#l73.757"></a><span id="l73.757" class="difflineplus">+                                  const nsMapiEntry&amp; aEntry) {</span>
<a href="#l73.758"></a><span id="l73.758" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPICONTAINER&gt; container;</span>
<a href="#l73.759"></a><span id="l73.759" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; subObject;</span>
<a href="#l73.760"></a><span id="l73.760" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.761"></a><span id="l73.761"> </span>
<a href="#l73.762"></a><span id="l73.762" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l73.763"></a><span id="l73.763" class="difflineminus">-                                         &amp;IID_IMAPIContainer, 0, &amp;objType,</span>
<a href="#l73.764"></a><span id="l73.764" class="difflineminus">-                                         container) ;</span>
<a href="#l73.765"></a><span id="l73.765" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.766"></a><span id="l73.766" class="difflineminus">-        PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.767"></a><span id="l73.767" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.768"></a><span id="l73.768" class="difflineminus">-    }</span>
<a href="#l73.769"></a><span id="l73.769" class="difflineminus">-    mLastError = container-&gt;OpenEntry(aEntry.mByteCount, aEntry.mEntryId,</span>
<a href="#l73.770"></a><span id="l73.770" class="difflineminus">-                                      NULL, 0, &amp;objType, subObject) ;</span>
<a href="#l73.771"></a><span id="l73.771" class="difflineminus">-    return HR_SUCCEEDED(mLastError) ;</span>
<a href="#l73.772"></a><span id="l73.772" class="difflineplus">+  mLastError =</span>
<a href="#l73.773"></a><span id="l73.773" class="difflineplus">+      mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l73.774"></a><span id="l73.774" class="difflineplus">+                              &amp;IID_IMAPIContainer, 0, &amp;objType, container);</span>
<a href="#l73.775"></a><span id="l73.775" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.776"></a><span id="l73.776" class="difflineplus">+    PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError));</span>
<a href="#l73.777"></a><span id="l73.777" class="difflineplus">+    return FALSE;</span>
<a href="#l73.778"></a><span id="l73.778" class="difflineplus">+  }</span>
<a href="#l73.779"></a><span id="l73.779" class="difflineplus">+  mLastError = container-&gt;OpenEntry(aEntry.mByteCount, aEntry.mEntryId, NULL, 0,</span>
<a href="#l73.780"></a><span id="l73.780" class="difflineplus">+                                    &amp;objType, subObject);</span>
<a href="#l73.781"></a><span id="l73.781" class="difflineplus">+  return HR_SUCCEEDED(mLastError);</span>
<a href="#l73.782"></a><span id="l73.782"> }</span>
<a href="#l73.783"></a><span id="l73.783"> </span>
<a href="#l73.784"></a><span id="l73.784" class="difflineminus">-BOOL nsAbWinHelper::DeleteEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry)</span>
<a href="#l73.785"></a><span id="l73.785" class="difflineminus">-{</span>
<a href="#l73.786"></a><span id="l73.786" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPABCONT&gt; container ;</span>
<a href="#l73.787"></a><span id="l73.787" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.788"></a><span id="l73.788" class="difflineminus">-    SBinary entry ;</span>
<a href="#l73.789"></a><span id="l73.789" class="difflineminus">-    SBinaryArray entryArray ;</span>
<a href="#l73.790"></a><span id="l73.790" class="difflineplus">+BOOL nsAbWinHelper::DeleteEntry(const nsMapiEntry&amp; aContainer,</span>
<a href="#l73.791"></a><span id="l73.791" class="difflineplus">+                                const nsMapiEntry&amp; aEntry) {</span>
<a href="#l73.792"></a><span id="l73.792" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPABCONT&gt; container;</span>
<a href="#l73.793"></a><span id="l73.793" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.794"></a><span id="l73.794" class="difflineplus">+  SBinary entry;</span>
<a href="#l73.795"></a><span id="l73.795" class="difflineplus">+  SBinaryArray entryArray;</span>
<a href="#l73.796"></a><span id="l73.796"> </span>
<a href="#l73.797"></a><span id="l73.797" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l73.798"></a><span id="l73.798" class="difflineminus">-                                         &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l73.799"></a><span id="l73.799" class="difflineminus">-                                         container) ;</span>
<a href="#l73.800"></a><span id="l73.800" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.801"></a><span id="l73.801" class="difflineminus">-        PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.802"></a><span id="l73.802" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.803"></a><span id="l73.803" class="difflineminus">-    }</span>
<a href="#l73.804"></a><span id="l73.804" class="difflineminus">-    entry.cb = aEntry.mByteCount ;</span>
<a href="#l73.805"></a><span id="l73.805" class="difflineminus">-    entry.lpb = reinterpret_cast&lt;LPBYTE&gt;(aEntry.mEntryId) ;</span>
<a href="#l73.806"></a><span id="l73.806" class="difflineminus">-    entryArray.cValues = 1 ;</span>
<a href="#l73.807"></a><span id="l73.807" class="difflineminus">-    entryArray.lpbin = &amp;entry ;</span>
<a href="#l73.808"></a><span id="l73.808" class="difflineminus">-    mLastError = container-&gt;DeleteEntries(&amp;entryArray, 0) ;</span>
<a href="#l73.809"></a><span id="l73.809" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.810"></a><span id="l73.810" class="difflineminus">-        PRINTF((&quot;Cannot delete entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.811"></a><span id="l73.811" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.812"></a><span id="l73.812" class="difflineminus">-    }</span>
<a href="#l73.813"></a><span id="l73.813" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.814"></a><span id="l73.814" class="difflineplus">+  mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount,</span>
<a href="#l73.815"></a><span id="l73.815" class="difflineplus">+                                       aContainer.mEntryId, &amp;IID_IABContainer,</span>
<a href="#l73.816"></a><span id="l73.816" class="difflineplus">+                                       MAPI_MODIFY, &amp;objType, container);</span>
<a href="#l73.817"></a><span id="l73.817" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.818"></a><span id="l73.818" class="difflineplus">+    PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError));</span>
<a href="#l73.819"></a><span id="l73.819" class="difflineplus">+    return FALSE;</span>
<a href="#l73.820"></a><span id="l73.820" class="difflineplus">+  }</span>
<a href="#l73.821"></a><span id="l73.821" class="difflineplus">+  entry.cb = aEntry.mByteCount;</span>
<a href="#l73.822"></a><span id="l73.822" class="difflineplus">+  entry.lpb = reinterpret_cast&lt;LPBYTE&gt;(aEntry.mEntryId);</span>
<a href="#l73.823"></a><span id="l73.823" class="difflineplus">+  entryArray.cValues = 1;</span>
<a href="#l73.824"></a><span id="l73.824" class="difflineplus">+  entryArray.lpbin = &amp;entry;</span>
<a href="#l73.825"></a><span id="l73.825" class="difflineplus">+  mLastError = container-&gt;DeleteEntries(&amp;entryArray, 0);</span>
<a href="#l73.826"></a><span id="l73.826" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.827"></a><span id="l73.827" class="difflineplus">+    PRINTF((&quot;Cannot delete entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.828"></a><span id="l73.828" class="difflineplus">+    return FALSE;</span>
<a href="#l73.829"></a><span id="l73.829" class="difflineplus">+  }</span>
<a href="#l73.830"></a><span id="l73.830" class="difflineplus">+  return TRUE;</span>
<a href="#l73.831"></a><span id="l73.831"> }</span>
<a href="#l73.832"></a><span id="l73.832"> </span>
<a href="#l73.833"></a><span id="l73.833" class="difflineminus">-BOOL nsAbWinHelper::SetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l73.834"></a><span id="l73.834" class="difflineminus">-                                       const char16_t *aValue)</span>
<a href="#l73.835"></a><span id="l73.835" class="difflineminus">-{</span>
<a href="#l73.836"></a><span id="l73.836" class="difflineminus">-    SPropValue value ;</span>
<a href="#l73.837"></a><span id="l73.837" class="difflineminus">-    nsAutoCString alternativeValue ;</span>
<a href="#l73.838"></a><span id="l73.838" class="difflineplus">+BOOL nsAbWinHelper::SetPropertyUString(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.839"></a><span id="l73.839" class="difflineplus">+                                       ULONG aPropertyTag,</span>
<a href="#l73.840"></a><span id="l73.840" class="difflineplus">+                                       const char16_t* aValue) {</span>
<a href="#l73.841"></a><span id="l73.841" class="difflineplus">+  SPropValue value;</span>
<a href="#l73.842"></a><span id="l73.842" class="difflineplus">+  nsAutoCString alternativeValue;</span>
<a href="#l73.843"></a><span id="l73.843"> </span>
<a href="#l73.844"></a><span id="l73.844" class="difflineminus">-    value.ulPropTag = aPropertyTag ;</span>
<a href="#l73.845"></a><span id="l73.845" class="difflineminus">-    if (PROP_TYPE(aPropertyTag) == PT_UNICODE) {</span>
<a href="#l73.846"></a><span id="l73.846" class="difflineminus">-        value.Value.lpszW = reinterpret_cast&lt;wchar_t*&gt;(const_cast&lt;char16_t *&gt;(aValue));</span>
<a href="#l73.847"></a><span id="l73.847" class="difflineminus">-    }</span>
<a href="#l73.848"></a><span id="l73.848" class="difflineminus">-    else if (PROP_TYPE(aPropertyTag) == PT_STRING8) {</span>
<a href="#l73.849"></a><span id="l73.849" class="difflineminus">-        alternativeValue = NS_LossyConvertUTF16toASCII(aValue);</span>
<a href="#l73.850"></a><span id="l73.850" class="difflineminus">-        value.Value.lpszA = const_cast&lt;char *&gt;(alternativeValue.get()) ;</span>
<a href="#l73.851"></a><span id="l73.851" class="difflineminus">-    }</span>
<a href="#l73.852"></a><span id="l73.852" class="difflineminus">-    else {</span>
<a href="#l73.853"></a><span id="l73.853" class="difflineminus">-        PRINTF((&quot;Property %08x is not a string.\n&quot;, aPropertyTag)) ;</span>
<a href="#l73.854"></a><span id="l73.854" class="difflineminus">-        return TRUE ;</span>
<a href="#l73.855"></a><span id="l73.855" class="difflineminus">-    }</span>
<a href="#l73.856"></a><span id="l73.856" class="difflineminus">-    return SetMAPIProperties(aObject, 1, &amp;value) ;</span>
<a href="#l73.857"></a><span id="l73.857" class="difflineplus">+  value.ulPropTag = aPropertyTag;</span>
<a href="#l73.858"></a><span id="l73.858" class="difflineplus">+  if (PROP_TYPE(aPropertyTag) == PT_UNICODE) {</span>
<a href="#l73.859"></a><span id="l73.859" class="difflineplus">+    value.Value.lpszW =</span>
<a href="#l73.860"></a><span id="l73.860" class="difflineplus">+        reinterpret_cast&lt;wchar_t*&gt;(const_cast&lt;char16_t*&gt;(aValue));</span>
<a href="#l73.861"></a><span id="l73.861" class="difflineplus">+  } else if (PROP_TYPE(aPropertyTag) == PT_STRING8) {</span>
<a href="#l73.862"></a><span id="l73.862" class="difflineplus">+    alternativeValue = NS_LossyConvertUTF16toASCII(aValue);</span>
<a href="#l73.863"></a><span id="l73.863" class="difflineplus">+    value.Value.lpszA = const_cast&lt;char*&gt;(alternativeValue.get());</span>
<a href="#l73.864"></a><span id="l73.864" class="difflineplus">+  } else {</span>
<a href="#l73.865"></a><span id="l73.865" class="difflineplus">+    PRINTF((&quot;Property %08x is not a string.\n&quot;, aPropertyTag));</span>
<a href="#l73.866"></a><span id="l73.866" class="difflineplus">+    return TRUE;</span>
<a href="#l73.867"></a><span id="l73.867" class="difflineplus">+  }</span>
<a href="#l73.868"></a><span id="l73.868" class="difflineplus">+  return SetMAPIProperties(aObject, 1, &amp;value);</span>
<a href="#l73.869"></a><span id="l73.869"> }</span>
<a href="#l73.870"></a><span id="l73.870"> </span>
<a href="#l73.871"></a><span id="l73.871" class="difflineminus">-BOOL nsAbWinHelper::SetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertiesTag,</span>
<a href="#l73.872"></a><span id="l73.872" class="difflineminus">-                                         ULONG aNbProperties, nsString *aValues)</span>
<a href="#l73.873"></a><span id="l73.873" class="difflineminus">-{</span>
<a href="#l73.874"></a><span id="l73.874" class="difflineminus">-    LPSPropValue values = new SPropValue[aNbProperties] ;</span>
<a href="#l73.875"></a><span id="l73.875" class="difflineminus">-    if (!values)</span>
<a href="#l73.876"></a><span id="l73.876" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.877"></a><span id="l73.877" class="difflineplus">+BOOL nsAbWinHelper::SetPropertiesUString(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.878"></a><span id="l73.878" class="difflineplus">+                                         const ULONG* aPropertiesTag,</span>
<a href="#l73.879"></a><span id="l73.879" class="difflineplus">+                                         ULONG aNbProperties,</span>
<a href="#l73.880"></a><span id="l73.880" class="difflineplus">+                                         nsString* aValues) {</span>
<a href="#l73.881"></a><span id="l73.881" class="difflineplus">+  LPSPropValue values = new SPropValue[aNbProperties];</span>
<a href="#l73.882"></a><span id="l73.882" class="difflineplus">+  if (!values) return FALSE;</span>
<a href="#l73.883"></a><span id="l73.883"> </span>
<a href="#l73.884"></a><span id="l73.884" class="difflineminus">-    ULONG i = 0 ;</span>
<a href="#l73.885"></a><span id="l73.885" class="difflineminus">-    ULONG currentValue = 0 ;</span>
<a href="#l73.886"></a><span id="l73.886" class="difflineminus">-    nsAutoCString alternativeValue ;</span>
<a href="#l73.887"></a><span id="l73.887" class="difflineminus">-    BOOL retCode = TRUE ;</span>
<a href="#l73.888"></a><span id="l73.888" class="difflineplus">+  ULONG i = 0;</span>
<a href="#l73.889"></a><span id="l73.889" class="difflineplus">+  ULONG currentValue = 0;</span>
<a href="#l73.890"></a><span id="l73.890" class="difflineplus">+  nsAutoCString alternativeValue;</span>
<a href="#l73.891"></a><span id="l73.891" class="difflineplus">+  BOOL retCode = TRUE;</span>
<a href="#l73.892"></a><span id="l73.892"> </span>
<a href="#l73.893"></a><span id="l73.893" class="difflineminus">-    for (i = 0 ; i &lt; aNbProperties ; ++i) {</span>
<a href="#l73.894"></a><span id="l73.894" class="difflineminus">-        values[currentValue].ulPropTag = aPropertiesTag[i] ;</span>
<a href="#l73.895"></a><span id="l73.895" class="difflineminus">-        if (PROP_TYPE(aPropertiesTag[i]) == PT_UNICODE) {</span>
<a href="#l73.896"></a><span id="l73.896" class="difflineminus">-            const wchar_t *value = aValues[i].get() ;</span>
<a href="#l73.897"></a><span id="l73.897" class="difflineminus">-            values[currentValue++].Value.lpszW = const_cast&lt;wchar_t *&gt;(value) ;</span>
<a href="#l73.898"></a><span id="l73.898" class="difflineminus">-        }</span>
<a href="#l73.899"></a><span id="l73.899" class="difflineminus">-        else if (PROP_TYPE(aPropertiesTag[i]) == PT_STRING8) {</span>
<a href="#l73.900"></a><span id="l73.900" class="difflineminus">-            LossyCopyUTF16toASCII(aValues[i], alternativeValue);</span>
<a href="#l73.901"></a><span id="l73.901" class="difflineminus">-            char *av = strdup(alternativeValue.get()) ;</span>
<a href="#l73.902"></a><span id="l73.902" class="difflineminus">-            if (!av) {</span>
<a href="#l73.903"></a><span id="l73.903" class="difflineminus">-                retCode = FALSE ;</span>
<a href="#l73.904"></a><span id="l73.904" class="difflineminus">-                break ;</span>
<a href="#l73.905"></a><span id="l73.905" class="difflineminus">-            }</span>
<a href="#l73.906"></a><span id="l73.906" class="difflineminus">-            values[currentValue++].Value.lpszA = av ;</span>
<a href="#l73.907"></a><span id="l73.907" class="difflineminus">-        }</span>
<a href="#l73.908"></a><span id="l73.908" class="difflineplus">+  for (i = 0; i &lt; aNbProperties; ++i) {</span>
<a href="#l73.909"></a><span id="l73.909" class="difflineplus">+    values[currentValue].ulPropTag = aPropertiesTag[i];</span>
<a href="#l73.910"></a><span id="l73.910" class="difflineplus">+    if (PROP_TYPE(aPropertiesTag[i]) == PT_UNICODE) {</span>
<a href="#l73.911"></a><span id="l73.911" class="difflineplus">+      const wchar_t* value = aValues[i].get();</span>
<a href="#l73.912"></a><span id="l73.912" class="difflineplus">+      values[currentValue++].Value.lpszW = const_cast&lt;wchar_t*&gt;(value);</span>
<a href="#l73.913"></a><span id="l73.913" class="difflineplus">+    } else if (PROP_TYPE(aPropertiesTag[i]) == PT_STRING8) {</span>
<a href="#l73.914"></a><span id="l73.914" class="difflineplus">+      LossyCopyUTF16toASCII(aValues[i], alternativeValue);</span>
<a href="#l73.915"></a><span id="l73.915" class="difflineplus">+      char* av = strdup(alternativeValue.get());</span>
<a href="#l73.916"></a><span id="l73.916" class="difflineplus">+      if (!av) {</span>
<a href="#l73.917"></a><span id="l73.917" class="difflineplus">+        retCode = FALSE;</span>
<a href="#l73.918"></a><span id="l73.918" class="difflineplus">+        break;</span>
<a href="#l73.919"></a><span id="l73.919" class="difflineplus">+      }</span>
<a href="#l73.920"></a><span id="l73.920" class="difflineplus">+      values[currentValue++].Value.lpszA = av;</span>
<a href="#l73.921"></a><span id="l73.921" class="difflineplus">+    }</span>
<a href="#l73.922"></a><span id="l73.922" class="difflineplus">+  }</span>
<a href="#l73.923"></a><span id="l73.923" class="difflineplus">+  if (retCode) retCode = SetMAPIProperties(aObject, currentValue, values);</span>
<a href="#l73.924"></a><span id="l73.924" class="difflineplus">+  for (i = 0; i &lt; currentValue; ++i) {</span>
<a href="#l73.925"></a><span id="l73.925" class="difflineplus">+    if (PROP_TYPE(aPropertiesTag[i]) == PT_STRING8) {</span>
<a href="#l73.926"></a><span id="l73.926" class="difflineplus">+      free(values[i].Value.lpszA);</span>
<a href="#l73.927"></a><span id="l73.927">     }</span>
<a href="#l73.928"></a><span id="l73.928" class="difflineminus">-    if (retCode)</span>
<a href="#l73.929"></a><span id="l73.929" class="difflineminus">-        retCode = SetMAPIProperties(aObject, currentValue, values) ;</span>
<a href="#l73.930"></a><span id="l73.930" class="difflineminus">-    for (i = 0 ; i &lt; currentValue ; ++i) {</span>
<a href="#l73.931"></a><span id="l73.931" class="difflineminus">-        if (PROP_TYPE(aPropertiesTag[i]) == PT_STRING8) {</span>
<a href="#l73.932"></a><span id="l73.932" class="difflineminus">-            free(values[i].Value.lpszA) ;</span>
<a href="#l73.933"></a><span id="l73.933" class="difflineminus">-        }</span>
<a href="#l73.934"></a><span id="l73.934" class="difflineplus">+  }</span>
<a href="#l73.935"></a><span id="l73.935" class="difflineplus">+  delete[] values;</span>
<a href="#l73.936"></a><span id="l73.936" class="difflineplus">+  return retCode;</span>
<a href="#l73.937"></a><span id="l73.937" class="difflineplus">+}</span>
<a href="#l73.938"></a><span id="l73.938" class="difflineplus">+</span>
<a href="#l73.939"></a><span id="l73.939" class="difflineplus">+BOOL nsAbWinHelper::SetPropertyDate(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.940"></a><span id="l73.940" class="difflineplus">+                                    ULONG aPropertyTag, WORD aYear, WORD aMonth,</span>
<a href="#l73.941"></a><span id="l73.941" class="difflineplus">+                                    WORD aDay) {</span>
<a href="#l73.942"></a><span id="l73.942" class="difflineplus">+  SPropValue value;</span>
<a href="#l73.943"></a><span id="l73.943" class="difflineplus">+</span>
<a href="#l73.944"></a><span id="l73.944" class="difflineplus">+  value.ulPropTag = aPropertyTag;</span>
<a href="#l73.945"></a><span id="l73.945" class="difflineplus">+  if (PROP_TYPE(aPropertyTag) == PT_SYSTIME) {</span>
<a href="#l73.946"></a><span id="l73.946" class="difflineplus">+    SYSTEMTIME readableTime;</span>
<a href="#l73.947"></a><span id="l73.947" class="difflineplus">+</span>
<a href="#l73.948"></a><span id="l73.948" class="difflineplus">+    readableTime.wYear = aYear;</span>
<a href="#l73.949"></a><span id="l73.949" class="difflineplus">+    readableTime.wMonth = aMonth;</span>
<a href="#l73.950"></a><span id="l73.950" class="difflineplus">+    readableTime.wDay = aDay;</span>
<a href="#l73.951"></a><span id="l73.951" class="difflineplus">+    readableTime.wDayOfWeek = 0;</span>
<a href="#l73.952"></a><span id="l73.952" class="difflineplus">+    readableTime.wHour = 0;</span>
<a href="#l73.953"></a><span id="l73.953" class="difflineplus">+    readableTime.wMinute = 0;</span>
<a href="#l73.954"></a><span id="l73.954" class="difflineplus">+    readableTime.wSecond = 0;</span>
<a href="#l73.955"></a><span id="l73.955" class="difflineplus">+    readableTime.wMilliseconds = 0;</span>
<a href="#l73.956"></a><span id="l73.956" class="difflineplus">+    if (SystemTimeToFileTime(&amp;readableTime, &amp;value.Value.ft)) {</span>
<a href="#l73.957"></a><span id="l73.957" class="difflineplus">+      return SetMAPIProperties(aObject, 1, &amp;value);</span>
<a href="#l73.958"></a><span id="l73.958">     }</span>
<a href="#l73.959"></a><span id="l73.959" class="difflineminus">-    delete [] values ;</span>
<a href="#l73.960"></a><span id="l73.960" class="difflineminus">-    return retCode ;</span>
<a href="#l73.961"></a><span id="l73.961" class="difflineplus">+    return TRUE;</span>
<a href="#l73.962"></a><span id="l73.962" class="difflineplus">+  }</span>
<a href="#l73.963"></a><span id="l73.963" class="difflineplus">+  return FALSE;</span>
<a href="#l73.964"></a><span id="l73.964"> }</span>
<a href="#l73.965"></a><span id="l73.965"> </span>
<a href="#l73.966"></a><span id="l73.966" class="difflineminus">-BOOL nsAbWinHelper::SetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l73.967"></a><span id="l73.967" class="difflineminus">-                                    WORD aYear, WORD aMonth, WORD aDay)</span>
<a href="#l73.968"></a><span id="l73.968" class="difflineminus">-{</span>
<a href="#l73.969"></a><span id="l73.969" class="difflineminus">-    SPropValue value ;</span>
<a href="#l73.970"></a><span id="l73.970" class="difflineplus">+BOOL nsAbWinHelper::CreateEntry(const nsMapiEntry&amp; aParent,</span>
<a href="#l73.971"></a><span id="l73.971" class="difflineplus">+                                nsMapiEntry&amp; aNewEntry) {</span>
<a href="#l73.972"></a><span id="l73.972" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPABCONT&gt; container;</span>
<a href="#l73.973"></a><span id="l73.973" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.974"></a><span id="l73.974"> </span>
<a href="#l73.975"></a><span id="l73.975" class="difflineminus">-    value.ulPropTag = aPropertyTag ;</span>
<a href="#l73.976"></a><span id="l73.976" class="difflineminus">-    if (PROP_TYPE(aPropertyTag) == PT_SYSTIME) {</span>
<a href="#l73.977"></a><span id="l73.977" class="difflineminus">-        SYSTEMTIME readableTime ;</span>
<a href="#l73.978"></a><span id="l73.978" class="difflineplus">+  mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l73.979"></a><span id="l73.979" class="difflineplus">+                                       &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l73.980"></a><span id="l73.980" class="difflineplus">+                                       container);</span>
<a href="#l73.981"></a><span id="l73.981" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.982"></a><span id="l73.982" class="difflineplus">+    PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError));</span>
<a href="#l73.983"></a><span id="l73.983" class="difflineplus">+    return FALSE;</span>
<a href="#l73.984"></a><span id="l73.984" class="difflineplus">+  }</span>
<a href="#l73.985"></a><span id="l73.985" class="difflineplus">+  SPropTagArray property;</span>
<a href="#l73.986"></a><span id="l73.986" class="difflineplus">+  LPSPropValue value = NULL;</span>
<a href="#l73.987"></a><span id="l73.987" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.988"></a><span id="l73.988" class="difflineplus">+</span>
<a href="#l73.989"></a><span id="l73.989" class="difflineplus">+  property.cValues = 1;</span>
<a href="#l73.990"></a><span id="l73.990" class="difflineplus">+  property.aulPropTag[0] = PR_DEF_CREATE_MAILUSER;</span>
<a href="#l73.991"></a><span id="l73.991" class="difflineplus">+  mLastError = container-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value);</span>
<a href="#l73.992"></a><span id="l73.992" class="difflineplus">+  if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.993"></a><span id="l73.993" class="difflineplus">+    PRINTF((&quot;Cannot obtain template %08x.\n&quot;, mLastError));</span>
<a href="#l73.994"></a><span id="l73.994" class="difflineplus">+    return FALSE;</span>
<a href="#l73.995"></a><span id="l73.995" class="difflineplus">+  }</span>
<a href="#l73.996"></a><span id="l73.996" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry;</span>
<a href="#l73.997"></a><span id="l73.997"> </span>
<a href="#l73.998"></a><span id="l73.998" class="difflineminus">-        readableTime.wYear = aYear ;</span>
<a href="#l73.999"></a><span id="l73.999" class="difflineminus">-        readableTime.wMonth = aMonth ;</span>
<a href="#l73.1000"></a><span id="l73.1000" class="difflineminus">-        readableTime.wDay = aDay ;</span>
<a href="#l73.1001"></a><span id="l73.1001" class="difflineminus">-        readableTime.wDayOfWeek = 0 ;</span>
<a href="#l73.1002"></a><span id="l73.1002" class="difflineminus">-        readableTime.wHour = 0 ;</span>
<a href="#l73.1003"></a><span id="l73.1003" class="difflineminus">-        readableTime.wMinute = 0 ;</span>
<a href="#l73.1004"></a><span id="l73.1004" class="difflineminus">-        readableTime.wSecond = 0 ;</span>
<a href="#l73.1005"></a><span id="l73.1005" class="difflineminus">-        readableTime.wMilliseconds = 0 ;</span>
<a href="#l73.1006"></a><span id="l73.1006" class="difflineminus">-        if (SystemTimeToFileTime(&amp;readableTime, &amp;value.Value.ft)) {</span>
<a href="#l73.1007"></a><span id="l73.1007" class="difflineminus">-            return SetMAPIProperties(aObject, 1, &amp;value) ;</span>
<a href="#l73.1008"></a><span id="l73.1008" class="difflineminus">-        }</span>
<a href="#l73.1009"></a><span id="l73.1009" class="difflineminus">-        return TRUE ;</span>
<a href="#l73.1010"></a><span id="l73.1010" class="difflineminus">-    }</span>
<a href="#l73.1011"></a><span id="l73.1011" class="difflineminus">-    return FALSE ;</span>
<a href="#l73.1012"></a><span id="l73.1012" class="difflineplus">+  mLastError = container-&gt;CreateEntry(</span>
<a href="#l73.1013"></a><span id="l73.1013" class="difflineplus">+      value-&gt;Value.bin.cb, reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb),</span>
<a href="#l73.1014"></a><span id="l73.1014" class="difflineplus">+      CREATE_CHECK_DUP_LOOSE, newEntry);</span>
<a href="#l73.1015"></a><span id="l73.1015" class="difflineplus">+  FreeBuffer(value);</span>
<a href="#l73.1016"></a><span id="l73.1016" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1017"></a><span id="l73.1017" class="difflineplus">+    PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1018"></a><span id="l73.1018" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1019"></a><span id="l73.1019" class="difflineplus">+  }</span>
<a href="#l73.1020"></a><span id="l73.1020" class="difflineplus">+  SPropValue displayName;</span>
<a href="#l73.1021"></a><span id="l73.1021" class="difflineplus">+  LPSPropProblemArray problems = NULL;</span>
<a href="#l73.1022"></a><span id="l73.1022" class="difflineplus">+  nsAutoString tempName;</span>
<a href="#l73.1023"></a><span id="l73.1023" class="difflineplus">+</span>
<a href="#l73.1024"></a><span id="l73.1024" class="difflineplus">+  displayName.ulPropTag = PR_DISPLAY_NAME_W;</span>
<a href="#l73.1025"></a><span id="l73.1025" class="difflineplus">+  tempName.AssignLiteral(&quot;__MailUser__&quot;);</span>
<a href="#l73.1026"></a><span id="l73.1026" class="difflineplus">+  tempName.AppendInt(mEntryCounter++);</span>
<a href="#l73.1027"></a><span id="l73.1027" class="difflineplus">+  const wchar_t* tempNameValue = tempName.get();</span>
<a href="#l73.1028"></a><span id="l73.1028" class="difflineplus">+  displayName.Value.lpszW = const_cast&lt;wchar_t*&gt;(tempNameValue);</span>
<a href="#l73.1029"></a><span id="l73.1029" class="difflineplus">+  mLastError = newEntry-&gt;SetProps(1, &amp;displayName, &amp;problems);</span>
<a href="#l73.1030"></a><span id="l73.1030" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1031"></a><span id="l73.1031" class="difflineplus">+    PRINTF((&quot;Cannot set temporary name %08x.\n&quot;, mLastError));</span>
<a href="#l73.1032"></a><span id="l73.1032" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1033"></a><span id="l73.1033" class="difflineplus">+  }</span>
<a href="#l73.1034"></a><span id="l73.1034" class="difflineplus">+  mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY);</span>
<a href="#l73.1035"></a><span id="l73.1035" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1036"></a><span id="l73.1036" class="difflineplus">+    PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1037"></a><span id="l73.1037" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1038"></a><span id="l73.1038" class="difflineplus">+  }</span>
<a href="#l73.1039"></a><span id="l73.1039" class="difflineplus">+  property.aulPropTag[0] = PR_ENTRYID;</span>
<a href="#l73.1040"></a><span id="l73.1040" class="difflineplus">+  mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value);</span>
<a href="#l73.1041"></a><span id="l73.1041" class="difflineplus">+  if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1042"></a><span id="l73.1042" class="difflineplus">+    PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError));</span>
<a href="#l73.1043"></a><span id="l73.1043" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1044"></a><span id="l73.1044" class="difflineplus">+  }</span>
<a href="#l73.1045"></a><span id="l73.1045" class="difflineplus">+  aNewEntry.Assign(value-&gt;Value.bin.cb,</span>
<a href="#l73.1046"></a><span id="l73.1046" class="difflineplus">+                   reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb));</span>
<a href="#l73.1047"></a><span id="l73.1047" class="difflineplus">+  FreeBuffer(value);</span>
<a href="#l73.1048"></a><span id="l73.1048" class="difflineplus">+  return TRUE;</span>
<a href="#l73.1049"></a><span id="l73.1049"> }</span>
<a href="#l73.1050"></a><span id="l73.1050"> </span>
<a href="#l73.1051"></a><span id="l73.1051" class="difflineminus">-BOOL nsAbWinHelper::CreateEntry(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry)</span>
<a href="#l73.1052"></a><span id="l73.1052" class="difflineminus">-{</span>
<a href="#l73.1053"></a><span id="l73.1053" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPABCONT&gt; container ;</span>
<a href="#l73.1054"></a><span id="l73.1054" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.1055"></a><span id="l73.1055" class="difflineminus">-</span>
<a href="#l73.1056"></a><span id="l73.1056" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l73.1057"></a><span id="l73.1057" class="difflineminus">-                                         &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l73.1058"></a><span id="l73.1058" class="difflineminus">-                                         container) ;</span>
<a href="#l73.1059"></a><span id="l73.1059" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1060"></a><span id="l73.1060" class="difflineminus">-        PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1061"></a><span id="l73.1061" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1062"></a><span id="l73.1062" class="difflineminus">-    }</span>
<a href="#l73.1063"></a><span id="l73.1063" class="difflineminus">-    SPropTagArray property ;</span>
<a href="#l73.1064"></a><span id="l73.1064" class="difflineminus">-    LPSPropValue value = NULL ;</span>
<a href="#l73.1065"></a><span id="l73.1065" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.1066"></a><span id="l73.1066" class="difflineminus">-</span>
<a href="#l73.1067"></a><span id="l73.1067" class="difflineminus">-    property.cValues = 1 ;</span>
<a href="#l73.1068"></a><span id="l73.1068" class="difflineminus">-    property.aulPropTag[0] = PR_DEF_CREATE_MAILUSER ;</span>
<a href="#l73.1069"></a><span id="l73.1069" class="difflineminus">-    mLastError = container-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l73.1070"></a><span id="l73.1070" class="difflineminus">-    if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1071"></a><span id="l73.1071" class="difflineminus">-        PRINTF((&quot;Cannot obtain template %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1072"></a><span id="l73.1072" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1073"></a><span id="l73.1073" class="difflineminus">-    }</span>
<a href="#l73.1074"></a><span id="l73.1074" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry ;</span>
<a href="#l73.1075"></a><span id="l73.1075" class="difflineplus">+BOOL nsAbWinHelper::CreateDistList(const nsMapiEntry&amp; aParent,</span>
<a href="#l73.1076"></a><span id="l73.1076" class="difflineplus">+                                   nsMapiEntry&amp; aNewEntry) {</span>
<a href="#l73.1077"></a><span id="l73.1077" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPABCONT&gt; container;</span>
<a href="#l73.1078"></a><span id="l73.1078" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.1079"></a><span id="l73.1079"> </span>
<a href="#l73.1080"></a><span id="l73.1080" class="difflineminus">-    mLastError = container-&gt;CreateEntry(value-&gt;Value.bin.cb,</span>
<a href="#l73.1081"></a><span id="l73.1081" class="difflineminus">-                                        reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb),</span>
<a href="#l73.1082"></a><span id="l73.1082" class="difflineminus">-                                        CREATE_CHECK_DUP_LOOSE,</span>
<a href="#l73.1083"></a><span id="l73.1083" class="difflineminus">-                                        newEntry) ;</span>
<a href="#l73.1084"></a><span id="l73.1084" class="difflineminus">-    FreeBuffer(value) ;</span>
<a href="#l73.1085"></a><span id="l73.1085" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1086"></a><span id="l73.1086" class="difflineminus">-        PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1087"></a><span id="l73.1087" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1088"></a><span id="l73.1088" class="difflineminus">-    }</span>
<a href="#l73.1089"></a><span id="l73.1089" class="difflineminus">-    SPropValue displayName ;</span>
<a href="#l73.1090"></a><span id="l73.1090" class="difflineminus">-    LPSPropProblemArray problems = NULL ;</span>
<a href="#l73.1091"></a><span id="l73.1091" class="difflineminus">-    nsAutoString tempName ;</span>
<a href="#l73.1092"></a><span id="l73.1092" class="difflineplus">+  mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l73.1093"></a><span id="l73.1093" class="difflineplus">+                                       &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l73.1094"></a><span id="l73.1094" class="difflineplus">+                                       container);</span>
<a href="#l73.1095"></a><span id="l73.1095" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1096"></a><span id="l73.1096" class="difflineplus">+    PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError));</span>
<a href="#l73.1097"></a><span id="l73.1097" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1098"></a><span id="l73.1098" class="difflineplus">+  }</span>
<a href="#l73.1099"></a><span id="l73.1099" class="difflineplus">+  SPropTagArray property;</span>
<a href="#l73.1100"></a><span id="l73.1100" class="difflineplus">+  LPSPropValue value = NULL;</span>
<a href="#l73.1101"></a><span id="l73.1101" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.1102"></a><span id="l73.1102"> </span>
<a href="#l73.1103"></a><span id="l73.1103" class="difflineminus">-    displayName.ulPropTag = PR_DISPLAY_NAME_W ;</span>
<a href="#l73.1104"></a><span id="l73.1104" class="difflineminus">-    tempName.AssignLiteral(&quot;__MailUser__&quot;) ;</span>
<a href="#l73.1105"></a><span id="l73.1105" class="difflineminus">-    tempName.AppendInt(mEntryCounter++) ;</span>
<a href="#l73.1106"></a><span id="l73.1106" class="difflineminus">-    const wchar_t *tempNameValue = tempName.get();</span>
<a href="#l73.1107"></a><span id="l73.1107" class="difflineminus">-    displayName.Value.lpszW = const_cast&lt;wchar_t *&gt;(tempNameValue) ;</span>
<a href="#l73.1108"></a><span id="l73.1108" class="difflineminus">-    mLastError = newEntry-&gt;SetProps(1, &amp;displayName, &amp;problems) ;</span>
<a href="#l73.1109"></a><span id="l73.1109" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1110"></a><span id="l73.1110" class="difflineminus">-        PRINTF((&quot;Cannot set temporary name %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1111"></a><span id="l73.1111" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1112"></a><span id="l73.1112" class="difflineminus">-    }</span>
<a href="#l73.1113"></a><span id="l73.1113" class="difflineminus">-    mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY) ;</span>
<a href="#l73.1114"></a><span id="l73.1114" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1115"></a><span id="l73.1115" class="difflineminus">-        PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1116"></a><span id="l73.1116" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1117"></a><span id="l73.1117" class="difflineminus">-    }</span>
<a href="#l73.1118"></a><span id="l73.1118" class="difflineminus">-    property.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l73.1119"></a><span id="l73.1119" class="difflineminus">-    mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l73.1120"></a><span id="l73.1120" class="difflineminus">-    if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1121"></a><span id="l73.1121" class="difflineminus">-        PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1122"></a><span id="l73.1122" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1123"></a><span id="l73.1123" class="difflineminus">-    }</span>
<a href="#l73.1124"></a><span id="l73.1124" class="difflineminus">-    aNewEntry.Assign(value-&gt;Value.bin.cb, reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb)) ;</span>
<a href="#l73.1125"></a><span id="l73.1125" class="difflineminus">-    FreeBuffer(value) ;</span>
<a href="#l73.1126"></a><span id="l73.1126" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.1127"></a><span id="l73.1127" class="difflineminus">-}</span>
<a href="#l73.1128"></a><span id="l73.1128" class="difflineplus">+  property.cValues = 1;</span>
<a href="#l73.1129"></a><span id="l73.1129" class="difflineplus">+  property.aulPropTag[0] = PR_DEF_CREATE_DL;</span>
<a href="#l73.1130"></a><span id="l73.1130" class="difflineplus">+  mLastError = container-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value);</span>
<a href="#l73.1131"></a><span id="l73.1131" class="difflineplus">+  if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1132"></a><span id="l73.1132" class="difflineplus">+    PRINTF((&quot;Cannot obtain template %08x.\n&quot;, mLastError));</span>
<a href="#l73.1133"></a><span id="l73.1133" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1134"></a><span id="l73.1134" class="difflineplus">+  }</span>
<a href="#l73.1135"></a><span id="l73.1135" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry;</span>
<a href="#l73.1136"></a><span id="l73.1136"> </span>
<a href="#l73.1137"></a><span id="l73.1137" class="difflineminus">-BOOL nsAbWinHelper::CreateDistList(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry)</span>
<a href="#l73.1138"></a><span id="l73.1138" class="difflineminus">-{</span>
<a href="#l73.1139"></a><span id="l73.1139" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPABCONT&gt; container ;</span>
<a href="#l73.1140"></a><span id="l73.1140" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.1141"></a><span id="l73.1141" class="difflineminus">-</span>
<a href="#l73.1142"></a><span id="l73.1142" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l73.1143"></a><span id="l73.1143" class="difflineminus">-                                         &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l73.1144"></a><span id="l73.1144" class="difflineminus">-                                         container) ;</span>
<a href="#l73.1145"></a><span id="l73.1145" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1146"></a><span id="l73.1146" class="difflineminus">-        PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1147"></a><span id="l73.1147" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1148"></a><span id="l73.1148" class="difflineminus">-    }</span>
<a href="#l73.1149"></a><span id="l73.1149" class="difflineminus">-    SPropTagArray property ;</span>
<a href="#l73.1150"></a><span id="l73.1150" class="difflineminus">-    LPSPropValue value = NULL ;</span>
<a href="#l73.1151"></a><span id="l73.1151" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.1152"></a><span id="l73.1152" class="difflineminus">-</span>
<a href="#l73.1153"></a><span id="l73.1153" class="difflineminus">-    property.cValues = 1 ;</span>
<a href="#l73.1154"></a><span id="l73.1154" class="difflineminus">-    property.aulPropTag[0] = PR_DEF_CREATE_DL ;</span>
<a href="#l73.1155"></a><span id="l73.1155" class="difflineminus">-    mLastError = container-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l73.1156"></a><span id="l73.1156" class="difflineminus">-    if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1157"></a><span id="l73.1157" class="difflineminus">-        PRINTF((&quot;Cannot obtain template %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1158"></a><span id="l73.1158" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1159"></a><span id="l73.1159" class="difflineminus">-    }</span>
<a href="#l73.1160"></a><span id="l73.1160" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry ;</span>
<a href="#l73.1161"></a><span id="l73.1161" class="difflineplus">+  mLastError = container-&gt;CreateEntry(</span>
<a href="#l73.1162"></a><span id="l73.1162" class="difflineplus">+      value-&gt;Value.bin.cb, reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb),</span>
<a href="#l73.1163"></a><span id="l73.1163" class="difflineplus">+      CREATE_CHECK_DUP_LOOSE, newEntry);</span>
<a href="#l73.1164"></a><span id="l73.1164" class="difflineplus">+  FreeBuffer(value);</span>
<a href="#l73.1165"></a><span id="l73.1165" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1166"></a><span id="l73.1166" class="difflineplus">+    PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1167"></a><span id="l73.1167" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1168"></a><span id="l73.1168" class="difflineplus">+  }</span>
<a href="#l73.1169"></a><span id="l73.1169" class="difflineplus">+  SPropValue displayName;</span>
<a href="#l73.1170"></a><span id="l73.1170" class="difflineplus">+  LPSPropProblemArray problems = NULL;</span>
<a href="#l73.1171"></a><span id="l73.1171" class="difflineplus">+  nsAutoString tempName;</span>
<a href="#l73.1172"></a><span id="l73.1172"> </span>
<a href="#l73.1173"></a><span id="l73.1173" class="difflineminus">-    mLastError = container-&gt;CreateEntry(value-&gt;Value.bin.cb,</span>
<a href="#l73.1174"></a><span id="l73.1174" class="difflineminus">-                                        reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb),</span>
<a href="#l73.1175"></a><span id="l73.1175" class="difflineminus">-                                        CREATE_CHECK_DUP_LOOSE,</span>
<a href="#l73.1176"></a><span id="l73.1176" class="difflineminus">-                                        newEntry) ;</span>
<a href="#l73.1177"></a><span id="l73.1177" class="difflineminus">-    FreeBuffer(value) ;</span>
<a href="#l73.1178"></a><span id="l73.1178" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1179"></a><span id="l73.1179" class="difflineminus">-        PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1180"></a><span id="l73.1180" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1181"></a><span id="l73.1181" class="difflineminus">-    }</span>
<a href="#l73.1182"></a><span id="l73.1182" class="difflineminus">-    SPropValue displayName ;</span>
<a href="#l73.1183"></a><span id="l73.1183" class="difflineminus">-    LPSPropProblemArray problems = NULL ;</span>
<a href="#l73.1184"></a><span id="l73.1184" class="difflineminus">-    nsAutoString tempName ;</span>
<a href="#l73.1185"></a><span id="l73.1185" class="difflineminus">-</span>
<a href="#l73.1186"></a><span id="l73.1186" class="difflineminus">-    displayName.ulPropTag = PR_DISPLAY_NAME_W ;</span>
<a href="#l73.1187"></a><span id="l73.1187" class="difflineminus">-    tempName.AssignLiteral(&quot;__MailList__&quot;) ;</span>
<a href="#l73.1188"></a><span id="l73.1188" class="difflineminus">-    tempName.AppendInt(mEntryCounter++) ;</span>
<a href="#l73.1189"></a><span id="l73.1189" class="difflineminus">-    const wchar_t *tempNameValue = tempName.get() ;</span>
<a href="#l73.1190"></a><span id="l73.1190" class="difflineminus">-    displayName.Value.lpszW = const_cast&lt;wchar_t *&gt;(tempNameValue) ;</span>
<a href="#l73.1191"></a><span id="l73.1191" class="difflineminus">-    mLastError = newEntry-&gt;SetProps(1, &amp;displayName, &amp;problems) ;</span>
<a href="#l73.1192"></a><span id="l73.1192" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1193"></a><span id="l73.1193" class="difflineminus">-        PRINTF((&quot;Cannot set temporary name %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1194"></a><span id="l73.1194" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1195"></a><span id="l73.1195" class="difflineminus">-    }</span>
<a href="#l73.1196"></a><span id="l73.1196" class="difflineminus">-    mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY) ;</span>
<a href="#l73.1197"></a><span id="l73.1197" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1198"></a><span id="l73.1198" class="difflineminus">-        PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1199"></a><span id="l73.1199" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1200"></a><span id="l73.1200" class="difflineminus">-    }</span>
<a href="#l73.1201"></a><span id="l73.1201" class="difflineminus">-    property.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l73.1202"></a><span id="l73.1202" class="difflineminus">-    mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l73.1203"></a><span id="l73.1203" class="difflineminus">-    if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1204"></a><span id="l73.1204" class="difflineminus">-        PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1205"></a><span id="l73.1205" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1206"></a><span id="l73.1206" class="difflineminus">-    }</span>
<a href="#l73.1207"></a><span id="l73.1207" class="difflineminus">-    aNewEntry.Assign(value-&gt;Value.bin.cb,</span>
<a href="#l73.1208"></a><span id="l73.1208" class="difflineminus">-                     reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb)) ;</span>
<a href="#l73.1209"></a><span id="l73.1209" class="difflineminus">-    FreeBuffer(value) ;</span>
<a href="#l73.1210"></a><span id="l73.1210" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.1211"></a><span id="l73.1211" class="difflineplus">+  displayName.ulPropTag = PR_DISPLAY_NAME_W;</span>
<a href="#l73.1212"></a><span id="l73.1212" class="difflineplus">+  tempName.AssignLiteral(&quot;__MailList__&quot;);</span>
<a href="#l73.1213"></a><span id="l73.1213" class="difflineplus">+  tempName.AppendInt(mEntryCounter++);</span>
<a href="#l73.1214"></a><span id="l73.1214" class="difflineplus">+  const wchar_t* tempNameValue = tempName.get();</span>
<a href="#l73.1215"></a><span id="l73.1215" class="difflineplus">+  displayName.Value.lpszW = const_cast&lt;wchar_t*&gt;(tempNameValue);</span>
<a href="#l73.1216"></a><span id="l73.1216" class="difflineplus">+  mLastError = newEntry-&gt;SetProps(1, &amp;displayName, &amp;problems);</span>
<a href="#l73.1217"></a><span id="l73.1217" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1218"></a><span id="l73.1218" class="difflineplus">+    PRINTF((&quot;Cannot set temporary name %08x.\n&quot;, mLastError));</span>
<a href="#l73.1219"></a><span id="l73.1219" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1220"></a><span id="l73.1220" class="difflineplus">+  }</span>
<a href="#l73.1221"></a><span id="l73.1221" class="difflineplus">+  mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY);</span>
<a href="#l73.1222"></a><span id="l73.1222" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1223"></a><span id="l73.1223" class="difflineplus">+    PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1224"></a><span id="l73.1224" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1225"></a><span id="l73.1225" class="difflineplus">+  }</span>
<a href="#l73.1226"></a><span id="l73.1226" class="difflineplus">+  property.aulPropTag[0] = PR_ENTRYID;</span>
<a href="#l73.1227"></a><span id="l73.1227" class="difflineplus">+  mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value);</span>
<a href="#l73.1228"></a><span id="l73.1228" class="difflineplus">+  if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1229"></a><span id="l73.1229" class="difflineplus">+    PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError));</span>
<a href="#l73.1230"></a><span id="l73.1230" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1231"></a><span id="l73.1231" class="difflineplus">+  }</span>
<a href="#l73.1232"></a><span id="l73.1232" class="difflineplus">+  aNewEntry.Assign(value-&gt;Value.bin.cb,</span>
<a href="#l73.1233"></a><span id="l73.1233" class="difflineplus">+                   reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb));</span>
<a href="#l73.1234"></a><span id="l73.1234" class="difflineplus">+  FreeBuffer(value);</span>
<a href="#l73.1235"></a><span id="l73.1235" class="difflineplus">+  return TRUE;</span>
<a href="#l73.1236"></a><span id="l73.1236"> }</span>
<a href="#l73.1237"></a><span id="l73.1237"> </span>
<a href="#l73.1238"></a><span id="l73.1238" class="difflineminus">-BOOL nsAbWinHelper::CopyEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aSource,</span>
<a href="#l73.1239"></a><span id="l73.1239" class="difflineminus">-                              nsMapiEntry&amp; aTarget)</span>
<a href="#l73.1240"></a><span id="l73.1240" class="difflineminus">-{</span>
<a href="#l73.1241"></a><span id="l73.1241" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPABCONT&gt; container ;</span>
<a href="#l73.1242"></a><span id="l73.1242" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.1243"></a><span id="l73.1243" class="difflineplus">+BOOL nsAbWinHelper::CopyEntry(const nsMapiEntry&amp; aContainer,</span>
<a href="#l73.1244"></a><span id="l73.1244" class="difflineplus">+                              const nsMapiEntry&amp; aSource,</span>
<a href="#l73.1245"></a><span id="l73.1245" class="difflineplus">+                              nsMapiEntry&amp; aTarget) {</span>
<a href="#l73.1246"></a><span id="l73.1246" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPABCONT&gt; container;</span>
<a href="#l73.1247"></a><span id="l73.1247" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.1248"></a><span id="l73.1248"> </span>
<a href="#l73.1249"></a><span id="l73.1249" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l73.1250"></a><span id="l73.1250" class="difflineminus">-                                         &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l73.1251"></a><span id="l73.1251" class="difflineminus">-                                         container) ;</span>
<a href="#l73.1252"></a><span id="l73.1252" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1253"></a><span id="l73.1253" class="difflineminus">-        PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1254"></a><span id="l73.1254" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1255"></a><span id="l73.1255" class="difflineminus">-    }</span>
<a href="#l73.1256"></a><span id="l73.1256" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry ;</span>
<a href="#l73.1257"></a><span id="l73.1257" class="difflineplus">+  mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount,</span>
<a href="#l73.1258"></a><span id="l73.1258" class="difflineplus">+                                       aContainer.mEntryId, &amp;IID_IABContainer,</span>
<a href="#l73.1259"></a><span id="l73.1259" class="difflineplus">+                                       MAPI_MODIFY, &amp;objType, container);</span>
<a href="#l73.1260"></a><span id="l73.1260" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1261"></a><span id="l73.1261" class="difflineplus">+    PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError));</span>
<a href="#l73.1262"></a><span id="l73.1262" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1263"></a><span id="l73.1263" class="difflineplus">+  }</span>
<a href="#l73.1264"></a><span id="l73.1264" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry;</span>
<a href="#l73.1265"></a><span id="l73.1265"> </span>
<a href="#l73.1266"></a><span id="l73.1266" class="difflineminus">-    mLastError = container-&gt;CreateEntry(aSource.mByteCount, aSource.mEntryId,</span>
<a href="#l73.1267"></a><span id="l73.1267" class="difflineminus">-                                        CREATE_CHECK_DUP_LOOSE, newEntry) ;</span>
<a href="#l73.1268"></a><span id="l73.1268" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1269"></a><span id="l73.1269" class="difflineminus">-        PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1270"></a><span id="l73.1270" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1271"></a><span id="l73.1271" class="difflineminus">-    }</span>
<a href="#l73.1272"></a><span id="l73.1272" class="difflineminus">-    mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY) ;</span>
<a href="#l73.1273"></a><span id="l73.1273" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1274"></a><span id="l73.1274" class="difflineminus">-        PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1275"></a><span id="l73.1275" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1276"></a><span id="l73.1276" class="difflineminus">-    }</span>
<a href="#l73.1277"></a><span id="l73.1277" class="difflineminus">-    SPropTagArray property ;</span>
<a href="#l73.1278"></a><span id="l73.1278" class="difflineminus">-    LPSPropValue value = NULL ;</span>
<a href="#l73.1279"></a><span id="l73.1279" class="difflineminus">-    ULONG valueCount = 0 ;</span>
<a href="#l73.1280"></a><span id="l73.1280" class="difflineplus">+  mLastError = container-&gt;CreateEntry(aSource.mByteCount, aSource.mEntryId,</span>
<a href="#l73.1281"></a><span id="l73.1281" class="difflineplus">+                                      CREATE_CHECK_DUP_LOOSE, newEntry);</span>
<a href="#l73.1282"></a><span id="l73.1282" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1283"></a><span id="l73.1283" class="difflineplus">+    PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1284"></a><span id="l73.1284" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1285"></a><span id="l73.1285" class="difflineplus">+  }</span>
<a href="#l73.1286"></a><span id="l73.1286" class="difflineplus">+  mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY);</span>
<a href="#l73.1287"></a><span id="l73.1287" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1288"></a><span id="l73.1288" class="difflineplus">+    PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1289"></a><span id="l73.1289" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1290"></a><span id="l73.1290" class="difflineplus">+  }</span>
<a href="#l73.1291"></a><span id="l73.1291" class="difflineplus">+  SPropTagArray property;</span>
<a href="#l73.1292"></a><span id="l73.1292" class="difflineplus">+  LPSPropValue value = NULL;</span>
<a href="#l73.1293"></a><span id="l73.1293" class="difflineplus">+  ULONG valueCount = 0;</span>
<a href="#l73.1294"></a><span id="l73.1294"> </span>
<a href="#l73.1295"></a><span id="l73.1295" class="difflineminus">-    property.cValues = 1 ;</span>
<a href="#l73.1296"></a><span id="l73.1296" class="difflineminus">-    property.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l73.1297"></a><span id="l73.1297" class="difflineminus">-    mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l73.1298"></a><span id="l73.1298" class="difflineminus">-    if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1299"></a><span id="l73.1299" class="difflineminus">-        PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1300"></a><span id="l73.1300" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1301"></a><span id="l73.1301" class="difflineminus">-    }</span>
<a href="#l73.1302"></a><span id="l73.1302" class="difflineminus">-    aTarget.Assign(value-&gt;Value.bin.cb,</span>
<a href="#l73.1303"></a><span id="l73.1303" class="difflineminus">-                   reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb)) ;</span>
<a href="#l73.1304"></a><span id="l73.1304" class="difflineminus">-    FreeBuffer(value) ;</span>
<a href="#l73.1305"></a><span id="l73.1305" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.1306"></a><span id="l73.1306" class="difflineplus">+  property.cValues = 1;</span>
<a href="#l73.1307"></a><span id="l73.1307" class="difflineplus">+  property.aulPropTag[0] = PR_ENTRYID;</span>
<a href="#l73.1308"></a><span id="l73.1308" class="difflineplus">+  mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value);</span>
<a href="#l73.1309"></a><span id="l73.1309" class="difflineplus">+  if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l73.1310"></a><span id="l73.1310" class="difflineplus">+    PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError));</span>
<a href="#l73.1311"></a><span id="l73.1311" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1312"></a><span id="l73.1312" class="difflineplus">+  }</span>
<a href="#l73.1313"></a><span id="l73.1313" class="difflineplus">+  aTarget.Assign(value-&gt;Value.bin.cb,</span>
<a href="#l73.1314"></a><span id="l73.1314" class="difflineplus">+                 reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb));</span>
<a href="#l73.1315"></a><span id="l73.1315" class="difflineplus">+  FreeBuffer(value);</span>
<a href="#l73.1316"></a><span id="l73.1316" class="difflineplus">+  return TRUE;</span>
<a href="#l73.1317"></a><span id="l73.1317"> }</span>
<a href="#l73.1318"></a><span id="l73.1318"> </span>
<a href="#l73.1319"></a><span id="l73.1319" class="difflineminus">-BOOL nsAbWinHelper::GetDefaultContainer(nsMapiEntry&amp; aContainer)</span>
<a href="#l73.1320"></a><span id="l73.1320" class="difflineminus">-{</span>
<a href="#l73.1321"></a><span id="l73.1321" class="difflineminus">-    LPENTRYID entryId = NULL ;</span>
<a href="#l73.1322"></a><span id="l73.1322" class="difflineminus">-    ULONG byteCount = 0 ;</span>
<a href="#l73.1323"></a><span id="l73.1323" class="difflineplus">+BOOL nsAbWinHelper::GetDefaultContainer(nsMapiEntry&amp; aContainer) {</span>
<a href="#l73.1324"></a><span id="l73.1324" class="difflineplus">+  LPENTRYID entryId = NULL;</span>
<a href="#l73.1325"></a><span id="l73.1325" class="difflineplus">+  ULONG byteCount = 0;</span>
<a href="#l73.1326"></a><span id="l73.1326"> </span>
<a href="#l73.1327"></a><span id="l73.1327" class="difflineminus">-    mLastError = mAddressBook-&gt;GetPAB(&amp;byteCount, &amp;entryId) ;</span>
<a href="#l73.1328"></a><span id="l73.1328" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1329"></a><span id="l73.1329" class="difflineminus">-        PRINTF((&quot;Cannot get PAB %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1330"></a><span id="l73.1330" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1331"></a><span id="l73.1331" class="difflineminus">-    }</span>
<a href="#l73.1332"></a><span id="l73.1332" class="difflineminus">-    aContainer.Assign(byteCount, entryId) ;</span>
<a href="#l73.1333"></a><span id="l73.1333" class="difflineminus">-    FreeBuffer(entryId) ;</span>
<a href="#l73.1334"></a><span id="l73.1334" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.1335"></a><span id="l73.1335" class="difflineplus">+  mLastError = mAddressBook-&gt;GetPAB(&amp;byteCount, &amp;entryId);</span>
<a href="#l73.1336"></a><span id="l73.1336" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1337"></a><span id="l73.1337" class="difflineplus">+    PRINTF((&quot;Cannot get PAB %08x.\n&quot;, mLastError));</span>
<a href="#l73.1338"></a><span id="l73.1338" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1339"></a><span id="l73.1339" class="difflineplus">+  }</span>
<a href="#l73.1340"></a><span id="l73.1340" class="difflineplus">+  aContainer.Assign(byteCount, entryId);</span>
<a href="#l73.1341"></a><span id="l73.1341" class="difflineplus">+  FreeBuffer(entryId);</span>
<a href="#l73.1342"></a><span id="l73.1342" class="difflineplus">+  return TRUE;</span>
<a href="#l73.1343"></a><span id="l73.1343"> }</span>
<a href="#l73.1344"></a><span id="l73.1344"> </span>
<a href="#l73.1345"></a><span id="l73.1345" class="difflineminus">-enum</span>
<a href="#l73.1346"></a><span id="l73.1346" class="difflineminus">-{</span>
<a href="#l73.1347"></a><span id="l73.1347" class="difflineminus">-    ContentsColumnEntryId = 0,</span>
<a href="#l73.1348"></a><span id="l73.1348" class="difflineminus">-    ContentsColumnObjectType,</span>
<a href="#l73.1349"></a><span id="l73.1349" class="difflineminus">-    ContentsColumnsSize</span>
<a href="#l73.1350"></a><span id="l73.1350" class="difflineminus">-} ;</span>
<a href="#l73.1351"></a><span id="l73.1351" class="difflineplus">+enum {</span>
<a href="#l73.1352"></a><span id="l73.1352" class="difflineplus">+  ContentsColumnEntryId = 0,</span>
<a href="#l73.1353"></a><span id="l73.1353" class="difflineplus">+  ContentsColumnObjectType,</span>
<a href="#l73.1354"></a><span id="l73.1354" class="difflineplus">+  ContentsColumnsSize</span>
<a href="#l73.1355"></a><span id="l73.1355" class="difflineplus">+};</span>
<a href="#l73.1356"></a><span id="l73.1356"> </span>
<a href="#l73.1357"></a><span id="l73.1357" class="difflineminus">-static const SizedSPropTagArray(ContentsColumnsSize, ContentsColumns) =</span>
<a href="#l73.1358"></a><span id="l73.1358" class="difflineminus">-{</span>
<a href="#l73.1359"></a><span id="l73.1359" class="difflineminus">-    ContentsColumnsSize,</span>
<a href="#l73.1360"></a><span id="l73.1360" class="difflineminus">-    {</span>
<a href="#l73.1361"></a><span id="l73.1361" class="difflineminus">-        PR_ENTRYID,</span>
<a href="#l73.1362"></a><span id="l73.1362" class="difflineminus">-        PR_OBJECT_TYPE</span>
<a href="#l73.1363"></a><span id="l73.1363" class="difflineminus">-    }</span>
<a href="#l73.1364"></a><span id="l73.1364" class="difflineminus">-} ;</span>
<a href="#l73.1365"></a><span id="l73.1365" class="difflineplus">+static const SizedSPropTagArray(ContentsColumnsSize, ContentsColumns) = {</span>
<a href="#l73.1366"></a><span id="l73.1366" class="difflineplus">+    ContentsColumnsSize, {PR_ENTRYID, PR_OBJECT_TYPE}};</span>
<a href="#l73.1367"></a><span id="l73.1367"> </span>
<a href="#l73.1368"></a><span id="l73.1368" class="difflineminus">-BOOL nsAbWinHelper::GetContents(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l73.1369"></a><span id="l73.1369" class="difflineminus">-                                nsMapiEntry **aList, ULONG&amp; aNbElements, ULONG aMapiType)</span>
<a href="#l73.1370"></a><span id="l73.1370" class="difflineminus">-{</span>
<a href="#l73.1371"></a><span id="l73.1371" class="difflineminus">-    if (aList != NULL) { *aList = NULL ; }</span>
<a href="#l73.1372"></a><span id="l73.1372" class="difflineminus">-    aNbElements = 0 ;</span>
<a href="#l73.1373"></a><span id="l73.1373" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPICONTAINER&gt; parent ;</span>
<a href="#l73.1374"></a><span id="l73.1374" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPITABLE&gt; contents ;</span>
<a href="#l73.1375"></a><span id="l73.1375" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.1376"></a><span id="l73.1376" class="difflineminus">-    ULONG rowCount = 0 ;</span>
<a href="#l73.1377"></a><span id="l73.1377" class="difflineplus">+BOOL nsAbWinHelper::GetContents(const nsMapiEntry&amp; aParent,</span>
<a href="#l73.1378"></a><span id="l73.1378" class="difflineplus">+                                LPSRestriction aRestriction,</span>
<a href="#l73.1379"></a><span id="l73.1379" class="difflineplus">+                                nsMapiEntry** aList, ULONG&amp; aNbElements,</span>
<a href="#l73.1380"></a><span id="l73.1380" class="difflineplus">+                                ULONG aMapiType) {</span>
<a href="#l73.1381"></a><span id="l73.1381" class="difflineplus">+  if (aList != NULL) {</span>
<a href="#l73.1382"></a><span id="l73.1382" class="difflineplus">+    *aList = NULL;</span>
<a href="#l73.1383"></a><span id="l73.1383" class="difflineplus">+  }</span>
<a href="#l73.1384"></a><span id="l73.1384" class="difflineplus">+  aNbElements = 0;</span>
<a href="#l73.1385"></a><span id="l73.1385" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPICONTAINER&gt; parent;</span>
<a href="#l73.1386"></a><span id="l73.1386" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPITABLE&gt; contents;</span>
<a href="#l73.1387"></a><span id="l73.1387" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.1388"></a><span id="l73.1388" class="difflineplus">+  ULONG rowCount = 0;</span>
<a href="#l73.1389"></a><span id="l73.1389"> </span>
<a href="#l73.1390"></a><span id="l73.1390" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l73.1391"></a><span id="l73.1391" class="difflineminus">-                                         &amp;IID_IMAPIContainer, 0, &amp;objType,</span>
<a href="#l73.1392"></a><span id="l73.1392" class="difflineminus">-                                         parent) ;</span>
<a href="#l73.1393"></a><span id="l73.1393" class="difflineplus">+  mLastError =</span>
<a href="#l73.1394"></a><span id="l73.1394" class="difflineplus">+      mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l73.1395"></a><span id="l73.1395" class="difflineplus">+                              &amp;IID_IMAPIContainer, 0, &amp;objType, parent);</span>
<a href="#l73.1396"></a><span id="l73.1396" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1397"></a><span id="l73.1397" class="difflineplus">+    PRINTF((&quot;Cannot open parent %08x.\n&quot;, mLastError));</span>
<a href="#l73.1398"></a><span id="l73.1398" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1399"></a><span id="l73.1399" class="difflineplus">+  }</span>
<a href="#l73.1400"></a><span id="l73.1400" class="difflineplus">+  // Here, flags for WAB and MAPI could be different, so this works</span>
<a href="#l73.1401"></a><span id="l73.1401" class="difflineplus">+  // only as long as we don't want to use any flag in GetContentsTable</span>
<a href="#l73.1402"></a><span id="l73.1402" class="difflineplus">+  mLastError = parent-&gt;GetContentsTable(0, contents);</span>
<a href="#l73.1403"></a><span id="l73.1403" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1404"></a><span id="l73.1404" class="difflineplus">+    PRINTF((&quot;Cannot get contents %08x.\n&quot;, mLastError));</span>
<a href="#l73.1405"></a><span id="l73.1405" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1406"></a><span id="l73.1406" class="difflineplus">+  }</span>
<a href="#l73.1407"></a><span id="l73.1407" class="difflineplus">+  if (aRestriction != NULL) {</span>
<a href="#l73.1408"></a><span id="l73.1408" class="difflineplus">+    mLastError = contents-&gt;Restrict(aRestriction, 0);</span>
<a href="#l73.1409"></a><span id="l73.1409">     if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1410"></a><span id="l73.1410" class="difflineminus">-        PRINTF((&quot;Cannot open parent %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1411"></a><span id="l73.1411" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1412"></a><span id="l73.1412" class="difflineminus">-    }</span>
<a href="#l73.1413"></a><span id="l73.1413" class="difflineminus">-    // Here, flags for WAB and MAPI could be different, so this works</span>
<a href="#l73.1414"></a><span id="l73.1414" class="difflineminus">-    // only as long as we don't want to use any flag in GetContentsTable</span>
<a href="#l73.1415"></a><span id="l73.1415" class="difflineminus">-    mLastError = parent-&gt;GetContentsTable(0, contents) ;</span>
<a href="#l73.1416"></a><span id="l73.1416" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1417"></a><span id="l73.1417" class="difflineminus">-        PRINTF((&quot;Cannot get contents %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1418"></a><span id="l73.1418" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1419"></a><span id="l73.1419" class="difflineplus">+      PRINTF((&quot;Cannot set restriction %08x.\n&quot;, mLastError));</span>
<a href="#l73.1420"></a><span id="l73.1420" class="difflineplus">+      return FALSE;</span>
<a href="#l73.1421"></a><span id="l73.1421">     }</span>
<a href="#l73.1422"></a><span id="l73.1422" class="difflineminus">-    if (aRestriction != NULL) {</span>
<a href="#l73.1423"></a><span id="l73.1423" class="difflineminus">-        mLastError = contents-&gt;Restrict(aRestriction, 0) ;</span>
<a href="#l73.1424"></a><span id="l73.1424" class="difflineminus">-        if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1425"></a><span id="l73.1425" class="difflineminus">-            PRINTF((&quot;Cannot set restriction %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1426"></a><span id="l73.1426" class="difflineminus">-            return FALSE ;</span>
<a href="#l73.1427"></a><span id="l73.1427" class="difflineminus">-        }</span>
<a href="#l73.1428"></a><span id="l73.1428" class="difflineminus">-    }</span>
<a href="#l73.1429"></a><span id="l73.1429" class="difflineminus">-    mLastError = contents-&gt;SetColumns((LPSPropTagArray) &amp;ContentsColumns, 0) ;</span>
<a href="#l73.1430"></a><span id="l73.1430" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1431"></a><span id="l73.1431" class="difflineminus">-        PRINTF((&quot;Cannot set columns %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1432"></a><span id="l73.1432" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1433"></a><span id="l73.1433" class="difflineminus">-    }</span>
<a href="#l73.1434"></a><span id="l73.1434" class="difflineminus">-    mLastError = contents-&gt;GetRowCount(0, &amp;rowCount) ;</span>
<a href="#l73.1435"></a><span id="l73.1435" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1436"></a><span id="l73.1436" class="difflineminus">-        PRINTF((&quot;Cannot get result count %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1437"></a><span id="l73.1437" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1438"></a><span id="l73.1438" class="difflineminus">-    }</span>
<a href="#l73.1439"></a><span id="l73.1439" class="difflineminus">-    if (aList != NULL) { *aList = new nsMapiEntry[rowCount] ; }</span>
<a href="#l73.1440"></a><span id="l73.1440" class="difflineminus">-    aNbElements = 0 ;</span>
<a href="#l73.1441"></a><span id="l73.1441" class="difflineminus">-    do {</span>
<a href="#l73.1442"></a><span id="l73.1442" class="difflineminus">-        LPSRowSet rowSet = NULL ;</span>
<a href="#l73.1443"></a><span id="l73.1443" class="difflineplus">+  }</span>
<a href="#l73.1444"></a><span id="l73.1444" class="difflineplus">+  mLastError = contents-&gt;SetColumns((LPSPropTagArray)&amp;ContentsColumns, 0);</span>
<a href="#l73.1445"></a><span id="l73.1445" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1446"></a><span id="l73.1446" class="difflineplus">+    PRINTF((&quot;Cannot set columns %08x.\n&quot;, mLastError));</span>
<a href="#l73.1447"></a><span id="l73.1447" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1448"></a><span id="l73.1448" class="difflineplus">+  }</span>
<a href="#l73.1449"></a><span id="l73.1449" class="difflineplus">+  mLastError = contents-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l73.1450"></a><span id="l73.1450" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1451"></a><span id="l73.1451" class="difflineplus">+    PRINTF((&quot;Cannot get result count %08x.\n&quot;, mLastError));</span>
<a href="#l73.1452"></a><span id="l73.1452" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1453"></a><span id="l73.1453" class="difflineplus">+  }</span>
<a href="#l73.1454"></a><span id="l73.1454" class="difflineplus">+  if (aList != NULL) {</span>
<a href="#l73.1455"></a><span id="l73.1455" class="difflineplus">+    *aList = new nsMapiEntry[rowCount];</span>
<a href="#l73.1456"></a><span id="l73.1456" class="difflineplus">+  }</span>
<a href="#l73.1457"></a><span id="l73.1457" class="difflineplus">+  aNbElements = 0;</span>
<a href="#l73.1458"></a><span id="l73.1458" class="difflineplus">+  do {</span>
<a href="#l73.1459"></a><span id="l73.1459" class="difflineplus">+    LPSRowSet rowSet = NULL;</span>
<a href="#l73.1460"></a><span id="l73.1460"> </span>
<a href="#l73.1461"></a><span id="l73.1461" class="difflineminus">-        rowCount = 0 ;</span>
<a href="#l73.1462"></a><span id="l73.1462" class="difflineminus">-        mLastError = contents-&gt;QueryRows(1, 0, &amp;rowSet) ;</span>
<a href="#l73.1463"></a><span id="l73.1463" class="difflineminus">-        if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1464"></a><span id="l73.1464" class="difflineminus">-            PRINTF((&quot;Cannot query rows %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1465"></a><span id="l73.1465" class="difflineminus">-            return FALSE ;</span>
<a href="#l73.1466"></a><span id="l73.1466" class="difflineminus">-        }</span>
<a href="#l73.1467"></a><span id="l73.1467" class="difflineminus">-        rowCount = rowSet-&gt;cRows ;</span>
<a href="#l73.1468"></a><span id="l73.1468" class="difflineminus">-        if (rowCount &gt; 0 &amp;&amp;</span>
<a href="#l73.1469"></a><span id="l73.1469" class="difflineminus">-            (aMapiType == 0 ||</span>
<a href="#l73.1470"></a><span id="l73.1470" class="difflineminus">-            rowSet-&gt;aRow-&gt;lpProps[ContentsColumnObjectType].Value.ul == aMapiType)) {</span>
<a href="#l73.1471"></a><span id="l73.1471" class="difflineminus">-            if (aList != NULL) {</span>
<a href="#l73.1472"></a><span id="l73.1472" class="difflineminus">-                nsMapiEntry&amp; current = (*aList)[aNbElements] ;</span>
<a href="#l73.1473"></a><span id="l73.1473" class="difflineminus">-                SPropValue&amp; currentValue = rowSet-&gt;aRow-&gt;lpProps[ContentsColumnEntryId] ;</span>
<a href="#l73.1474"></a><span id="l73.1474" class="difflineplus">+    rowCount = 0;</span>
<a href="#l73.1475"></a><span id="l73.1475" class="difflineplus">+    mLastError = contents-&gt;QueryRows(1, 0, &amp;rowSet);</span>
<a href="#l73.1476"></a><span id="l73.1476" class="difflineplus">+    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1477"></a><span id="l73.1477" class="difflineplus">+      PRINTF((&quot;Cannot query rows %08x.\n&quot;, mLastError));</span>
<a href="#l73.1478"></a><span id="l73.1478" class="difflineplus">+      return FALSE;</span>
<a href="#l73.1479"></a><span id="l73.1479" class="difflineplus">+    }</span>
<a href="#l73.1480"></a><span id="l73.1480" class="difflineplus">+    rowCount = rowSet-&gt;cRows;</span>
<a href="#l73.1481"></a><span id="l73.1481" class="difflineplus">+    if (rowCount &gt; 0 &amp;&amp;</span>
<a href="#l73.1482"></a><span id="l73.1482" class="difflineplus">+        (aMapiType == 0 ||</span>
<a href="#l73.1483"></a><span id="l73.1483" class="difflineplus">+         rowSet-&gt;aRow-&gt;lpProps[ContentsColumnObjectType].Value.ul ==</span>
<a href="#l73.1484"></a><span id="l73.1484" class="difflineplus">+             aMapiType)) {</span>
<a href="#l73.1485"></a><span id="l73.1485" class="difflineplus">+      if (aList != NULL) {</span>
<a href="#l73.1486"></a><span id="l73.1486" class="difflineplus">+        nsMapiEntry&amp; current = (*aList)[aNbElements];</span>
<a href="#l73.1487"></a><span id="l73.1487" class="difflineplus">+        SPropValue&amp; currentValue = rowSet-&gt;aRow-&gt;lpProps[ContentsColumnEntryId];</span>
<a href="#l73.1488"></a><span id="l73.1488"> </span>
<a href="#l73.1489"></a><span id="l73.1489" class="difflineminus">-                current.Assign(currentValue.Value.bin.cb,</span>
<a href="#l73.1490"></a><span id="l73.1490" class="difflineminus">-                    reinterpret_cast&lt;LPENTRYID&gt;(currentValue.Value.bin.lpb)) ;</span>
<a href="#l73.1491"></a><span id="l73.1491" class="difflineminus">-            }</span>
<a href="#l73.1492"></a><span id="l73.1492" class="difflineminus">-            ++aNbElements ;</span>
<a href="#l73.1493"></a><span id="l73.1493" class="difflineminus">-        }</span>
<a href="#l73.1494"></a><span id="l73.1494" class="difflineminus">-        MyFreeProws(rowSet) ;</span>
<a href="#l73.1495"></a><span id="l73.1495" class="difflineminus">-    } while (rowCount &gt; 0) ;</span>
<a href="#l73.1496"></a><span id="l73.1496" class="difflineminus">-    return TRUE ;</span>
<a href="#l73.1497"></a><span id="l73.1497" class="difflineplus">+        current.Assign(currentValue.Value.bin.cb,</span>
<a href="#l73.1498"></a><span id="l73.1498" class="difflineplus">+                       reinterpret_cast&lt;LPENTRYID&gt;(currentValue.Value.bin.lpb));</span>
<a href="#l73.1499"></a><span id="l73.1499" class="difflineplus">+      }</span>
<a href="#l73.1500"></a><span id="l73.1500" class="difflineplus">+      ++aNbElements;</span>
<a href="#l73.1501"></a><span id="l73.1501" class="difflineplus">+    }</span>
<a href="#l73.1502"></a><span id="l73.1502" class="difflineplus">+    MyFreeProws(rowSet);</span>
<a href="#l73.1503"></a><span id="l73.1503" class="difflineplus">+  } while (rowCount &gt; 0);</span>
<a href="#l73.1504"></a><span id="l73.1504" class="difflineplus">+  return TRUE;</span>
<a href="#l73.1505"></a><span id="l73.1505"> }</span>
<a href="#l73.1506"></a><span id="l73.1506"> </span>
<a href="#l73.1507"></a><span id="l73.1507" class="difflineminus">-BOOL nsAbWinHelper::GetMAPIProperties(const nsMapiEntry&amp; aObject, const ULONG *aPropertyTags,</span>
<a href="#l73.1508"></a><span id="l73.1508" class="difflineplus">+BOOL nsAbWinHelper::GetMAPIProperties(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.1509"></a><span id="l73.1509" class="difflineplus">+                                      const ULONG* aPropertyTags,</span>
<a href="#l73.1510"></a><span id="l73.1510">                                       ULONG aNbProperties, LPSPropValue&amp; aValue,</span>
<a href="#l73.1511"></a><span id="l73.1511" class="difflineminus">-                                      ULONG&amp; aValueCount)</span>
<a href="#l73.1512"></a><span id="l73.1512" class="difflineminus">-{</span>
<a href="#l73.1513"></a><span id="l73.1513" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; object ;</span>
<a href="#l73.1514"></a><span id="l73.1514" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.1515"></a><span id="l73.1515" class="difflineminus">-    LPSPropTagArray properties = NULL ;</span>
<a href="#l73.1516"></a><span id="l73.1516" class="difflineminus">-    ULONG i = 0 ;</span>
<a href="#l73.1517"></a><span id="l73.1517" class="difflineplus">+                                      ULONG&amp; aValueCount) {</span>
<a href="#l73.1518"></a><span id="l73.1518" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; object;</span>
<a href="#l73.1519"></a><span id="l73.1519" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.1520"></a><span id="l73.1520" class="difflineplus">+  LPSPropTagArray properties = NULL;</span>
<a href="#l73.1521"></a><span id="l73.1521" class="difflineplus">+  ULONG i = 0;</span>
<a href="#l73.1522"></a><span id="l73.1522"> </span>
<a href="#l73.1523"></a><span id="l73.1523" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aObject.mByteCount, aObject.mEntryId,</span>
<a href="#l73.1524"></a><span id="l73.1524" class="difflineminus">-                                         &amp;IID_IMAPIProp, 0, &amp;objType,</span>
<a href="#l73.1525"></a><span id="l73.1525" class="difflineminus">-                                         object) ;</span>
<a href="#l73.1526"></a><span id="l73.1526" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1527"></a><span id="l73.1527" class="difflineminus">-        PRINTF((&quot;Cannot open entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1528"></a><span id="l73.1528" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1529"></a><span id="l73.1529" class="difflineminus">-    }</span>
<a href="#l73.1530"></a><span id="l73.1530" class="difflineminus">-    AllocateBuffer(CbNewSPropTagArray(aNbProperties),</span>
<a href="#l73.1531"></a><span id="l73.1531" class="difflineminus">-                   reinterpret_cast&lt;void **&gt;(&amp;properties)) ;</span>
<a href="#l73.1532"></a><span id="l73.1532" class="difflineminus">-    properties-&gt;cValues = aNbProperties ;</span>
<a href="#l73.1533"></a><span id="l73.1533" class="difflineminus">-    for (i = 0 ; i &lt; aNbProperties ; ++i) {</span>
<a href="#l73.1534"></a><span id="l73.1534" class="difflineminus">-        properties-&gt;aulPropTag[i] = aPropertyTags[i] ;</span>
<a href="#l73.1535"></a><span id="l73.1535" class="difflineminus">-    }</span>
<a href="#l73.1536"></a><span id="l73.1536" class="difflineminus">-    mLastError = object-&gt;GetProps(properties, 0, &amp;aValueCount, &amp;aValue) ;</span>
<a href="#l73.1537"></a><span id="l73.1537" class="difflineminus">-    FreeBuffer(properties) ;</span>
<a href="#l73.1538"></a><span id="l73.1538" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1539"></a><span id="l73.1539" class="difflineminus">-        PRINTF((&quot;Cannot get props %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1540"></a><span id="l73.1540" class="difflineminus">-    }</span>
<a href="#l73.1541"></a><span id="l73.1541" class="difflineminus">-    return HR_SUCCEEDED(mLastError) ;</span>
<a href="#l73.1542"></a><span id="l73.1542" class="difflineplus">+  mLastError = mAddressBook-&gt;OpenEntry(aObject.mByteCount, aObject.mEntryId,</span>
<a href="#l73.1543"></a><span id="l73.1543" class="difflineplus">+                                       &amp;IID_IMAPIProp, 0, &amp;objType, object);</span>
<a href="#l73.1544"></a><span id="l73.1544" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1545"></a><span id="l73.1545" class="difflineplus">+    PRINTF((&quot;Cannot open entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1546"></a><span id="l73.1546" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1547"></a><span id="l73.1547" class="difflineplus">+  }</span>
<a href="#l73.1548"></a><span id="l73.1548" class="difflineplus">+  AllocateBuffer(CbNewSPropTagArray(aNbProperties),</span>
<a href="#l73.1549"></a><span id="l73.1549" class="difflineplus">+                 reinterpret_cast&lt;void**&gt;(&amp;properties));</span>
<a href="#l73.1550"></a><span id="l73.1550" class="difflineplus">+  properties-&gt;cValues = aNbProperties;</span>
<a href="#l73.1551"></a><span id="l73.1551" class="difflineplus">+  for (i = 0; i &lt; aNbProperties; ++i) {</span>
<a href="#l73.1552"></a><span id="l73.1552" class="difflineplus">+    properties-&gt;aulPropTag[i] = aPropertyTags[i];</span>
<a href="#l73.1553"></a><span id="l73.1553" class="difflineplus">+  }</span>
<a href="#l73.1554"></a><span id="l73.1554" class="difflineplus">+  mLastError = object-&gt;GetProps(properties, 0, &amp;aValueCount, &amp;aValue);</span>
<a href="#l73.1555"></a><span id="l73.1555" class="difflineplus">+  FreeBuffer(properties);</span>
<a href="#l73.1556"></a><span id="l73.1556" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1557"></a><span id="l73.1557" class="difflineplus">+    PRINTF((&quot;Cannot get props %08x.\n&quot;, mLastError));</span>
<a href="#l73.1558"></a><span id="l73.1558" class="difflineplus">+  }</span>
<a href="#l73.1559"></a><span id="l73.1559" class="difflineplus">+  return HR_SUCCEEDED(mLastError);</span>
<a href="#l73.1560"></a><span id="l73.1560"> }</span>
<a href="#l73.1561"></a><span id="l73.1561"> </span>
<a href="#l73.1562"></a><span id="l73.1562" class="difflineminus">-BOOL nsAbWinHelper::SetMAPIProperties(const nsMapiEntry&amp; aObject, ULONG aNbProperties,</span>
<a href="#l73.1563"></a><span id="l73.1563" class="difflineminus">-                                      const LPSPropValue&amp; aValues)</span>
<a href="#l73.1564"></a><span id="l73.1564" class="difflineminus">-{</span>
<a href="#l73.1565"></a><span id="l73.1565" class="difflineminus">-    nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; object ;</span>
<a href="#l73.1566"></a><span id="l73.1566" class="difflineminus">-    ULONG objType = 0 ;</span>
<a href="#l73.1567"></a><span id="l73.1567" class="difflineminus">-    LPSPropProblemArray problems = NULL ;</span>
<a href="#l73.1568"></a><span id="l73.1568" class="difflineplus">+BOOL nsAbWinHelper::SetMAPIProperties(const nsMapiEntry&amp; aObject,</span>
<a href="#l73.1569"></a><span id="l73.1569" class="difflineplus">+                                      ULONG aNbProperties,</span>
<a href="#l73.1570"></a><span id="l73.1570" class="difflineplus">+                                      const LPSPropValue&amp; aValues) {</span>
<a href="#l73.1571"></a><span id="l73.1571" class="difflineplus">+  nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; object;</span>
<a href="#l73.1572"></a><span id="l73.1572" class="difflineplus">+  ULONG objType = 0;</span>
<a href="#l73.1573"></a><span id="l73.1573" class="difflineplus">+  LPSPropProblemArray problems = NULL;</span>
<a href="#l73.1574"></a><span id="l73.1574"> </span>
<a href="#l73.1575"></a><span id="l73.1575" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aObject.mByteCount, aObject.mEntryId,</span>
<a href="#l73.1576"></a><span id="l73.1576" class="difflineminus">-                                         &amp;IID_IMAPIProp, MAPI_MODIFY, &amp;objType,</span>
<a href="#l73.1577"></a><span id="l73.1577" class="difflineminus">-                                         object) ;</span>
<a href="#l73.1578"></a><span id="l73.1578" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1579"></a><span id="l73.1579" class="difflineminus">-        PRINTF((&quot;Cannot open entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1580"></a><span id="l73.1580" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1581"></a><span id="l73.1581" class="difflineplus">+  mLastError =</span>
<a href="#l73.1582"></a><span id="l73.1582" class="difflineplus">+      mAddressBook-&gt;OpenEntry(aObject.mByteCount, aObject.mEntryId,</span>
<a href="#l73.1583"></a><span id="l73.1583" class="difflineplus">+                              &amp;IID_IMAPIProp, MAPI_MODIFY, &amp;objType, object);</span>
<a href="#l73.1584"></a><span id="l73.1584" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1585"></a><span id="l73.1585" class="difflineplus">+    PRINTF((&quot;Cannot open entry %08x.\n&quot;, mLastError));</span>
<a href="#l73.1586"></a><span id="l73.1586" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1587"></a><span id="l73.1587" class="difflineplus">+  }</span>
<a href="#l73.1588"></a><span id="l73.1588" class="difflineplus">+  mLastError = object-&gt;SetProps(aNbProperties, aValues, &amp;problems);</span>
<a href="#l73.1589"></a><span id="l73.1589" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1590"></a><span id="l73.1590" class="difflineplus">+    PRINTF((&quot;Cannot update the object %08x.\n&quot;, mLastError));</span>
<a href="#l73.1591"></a><span id="l73.1591" class="difflineplus">+    return FALSE;</span>
<a href="#l73.1592"></a><span id="l73.1592" class="difflineplus">+  }</span>
<a href="#l73.1593"></a><span id="l73.1593" class="difflineplus">+  if (problems != NULL) {</span>
<a href="#l73.1594"></a><span id="l73.1594" class="difflineplus">+    for (ULONG i = 0; i &lt; problems-&gt;cProblem; ++i) {</span>
<a href="#l73.1595"></a><span id="l73.1595" class="difflineplus">+      PRINTF((&quot;Problem %d: index %d code %08x.\n&quot;, i,</span>
<a href="#l73.1596"></a><span id="l73.1596" class="difflineplus">+              problems-&gt;aProblem[i].ulIndex, problems-&gt;aProblem[i].scode));</span>
<a href="#l73.1597"></a><span id="l73.1597">     }</span>
<a href="#l73.1598"></a><span id="l73.1598" class="difflineminus">-    mLastError = object-&gt;SetProps(aNbProperties, aValues, &amp;problems) ;</span>
<a href="#l73.1599"></a><span id="l73.1599" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1600"></a><span id="l73.1600" class="difflineminus">-        PRINTF((&quot;Cannot update the object %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1601"></a><span id="l73.1601" class="difflineminus">-        return FALSE ;</span>
<a href="#l73.1602"></a><span id="l73.1602" class="difflineminus">-    }</span>
<a href="#l73.1603"></a><span id="l73.1603" class="difflineminus">-    if (problems != NULL) {</span>
<a href="#l73.1604"></a><span id="l73.1604" class="difflineminus">-        for (ULONG i = 0 ; i &lt; problems-&gt;cProblem ; ++i) {</span>
<a href="#l73.1605"></a><span id="l73.1605" class="difflineminus">-            PRINTF((&quot;Problem %d: index %d code %08x.\n&quot;, i,</span>
<a href="#l73.1606"></a><span id="l73.1606" class="difflineminus">-                problems-&gt;aProblem[i].ulIndex,</span>
<a href="#l73.1607"></a><span id="l73.1607" class="difflineminus">-                problems-&gt;aProblem[i].scode)) ;</span>
<a href="#l73.1608"></a><span id="l73.1608" class="difflineminus">-        }</span>
<a href="#l73.1609"></a><span id="l73.1609" class="difflineminus">-    }</span>
<a href="#l73.1610"></a><span id="l73.1610" class="difflineminus">-    mLastError = object-&gt;SaveChanges(0) ;</span>
<a href="#l73.1611"></a><span id="l73.1611" class="difflineminus">-    if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1612"></a><span id="l73.1612" class="difflineminus">-        PRINTF((&quot;Cannot commit changes %08x.\n&quot;, mLastError)) ;</span>
<a href="#l73.1613"></a><span id="l73.1613" class="difflineminus">-    }</span>
<a href="#l73.1614"></a><span id="l73.1614" class="difflineminus">-    return HR_SUCCEEDED(mLastError) ;</span>
<a href="#l73.1615"></a><span id="l73.1615" class="difflineplus">+  }</span>
<a href="#l73.1616"></a><span id="l73.1616" class="difflineplus">+  mLastError = object-&gt;SaveChanges(0);</span>
<a href="#l73.1617"></a><span id="l73.1617" class="difflineplus">+  if (HR_FAILED(mLastError)) {</span>
<a href="#l73.1618"></a><span id="l73.1618" class="difflineplus">+    PRINTF((&quot;Cannot commit changes %08x.\n&quot;, mLastError));</span>
<a href="#l73.1619"></a><span id="l73.1619" class="difflineplus">+  }</span>
<a href="#l73.1620"></a><span id="l73.1620" class="difflineplus">+  return HR_SUCCEEDED(mLastError);</span>
<a href="#l73.1621"></a><span id="l73.1621"> }</span>
<a href="#l73.1622"></a><span id="l73.1622"> </span>
<a href="#l73.1623"></a><span id="l73.1623" class="difflineminus">-void nsAbWinHelper::MyFreeProws(LPSRowSet aRowset)</span>
<a href="#l73.1624"></a><span id="l73.1624" class="difflineminus">-{</span>
<a href="#l73.1625"></a><span id="l73.1625" class="difflineminus">-    if (aRowset == NULL) { return ; }</span>
<a href="#l73.1626"></a><span id="l73.1626" class="difflineminus">-    ULONG i = 0 ;</span>
<a href="#l73.1627"></a><span id="l73.1627" class="difflineplus">+void nsAbWinHelper::MyFreeProws(LPSRowSet aRowset) {</span>
<a href="#l73.1628"></a><span id="l73.1628" class="difflineplus">+  if (aRowset == NULL) {</span>
<a href="#l73.1629"></a><span id="l73.1629" class="difflineplus">+    return;</span>
<a href="#l73.1630"></a><span id="l73.1630" class="difflineplus">+  }</span>
<a href="#l73.1631"></a><span id="l73.1631" class="difflineplus">+  ULONG i = 0;</span>
<a href="#l73.1632"></a><span id="l73.1632"> </span>
<a href="#l73.1633"></a><span id="l73.1633" class="difflineminus">-    for (i = 0 ; i &lt; aRowset-&gt;cRows ; ++i) {</span>
<a href="#l73.1634"></a><span id="l73.1634" class="difflineminus">-        FreeBuffer(aRowset-&gt;aRow[i].lpProps) ;</span>
<a href="#l73.1635"></a><span id="l73.1635" class="difflineminus">-    }</span>
<a href="#l73.1636"></a><span id="l73.1636" class="difflineminus">-    FreeBuffer(aRowset) ;</span>
<a href="#l73.1637"></a><span id="l73.1637" class="difflineplus">+  for (i = 0; i &lt; aRowset-&gt;cRows; ++i) {</span>
<a href="#l73.1638"></a><span id="l73.1638" class="difflineplus">+    FreeBuffer(aRowset-&gt;aRow[i].lpProps);</span>
<a href="#l73.1639"></a><span id="l73.1639" class="difflineplus">+  }</span>
<a href="#l73.1640"></a><span id="l73.1640" class="difflineplus">+  FreeBuffer(aRowset);</span>
<a href="#l73.1641"></a><span id="l73.1641"> }</span>
<a href="#l73.1642"></a><span id="l73.1642"> </span>
<a href="#l73.1643"></a><span id="l73.1643" class="difflineminus">-nsAbWinHelperGuard::nsAbWinHelperGuard(uint32_t aType)</span>
<a href="#l73.1644"></a><span id="l73.1644" class="difflineminus">-: mHelper(NULL)</span>
<a href="#l73.1645"></a><span id="l73.1645" class="difflineminus">-{</span>
<a href="#l73.1646"></a><span id="l73.1646" class="difflineminus">-    switch(aType) {</span>
<a href="#l73.1647"></a><span id="l73.1647" class="difflineminus">-    case nsAbWinType_Outlook: mHelper = new nsMapiAddressBook ; break ;</span>
<a href="#l73.1648"></a><span id="l73.1648" class="difflineminus">-    case nsAbWinType_OutlookExp: mHelper = new nsWabAddressBook ; break ;</span>
<a href="#l73.1649"></a><span id="l73.1649" class="difflineminus">-    default: break ;</span>
<a href="#l73.1650"></a><span id="l73.1650" class="difflineminus">-    }</span>
<a href="#l73.1651"></a><span id="l73.1651" class="difflineminus">-}</span>
<a href="#l73.1652"></a><span id="l73.1652" class="difflineminus">-</span>
<a href="#l73.1653"></a><span id="l73.1653" class="difflineminus">-nsAbWinHelperGuard::~nsAbWinHelperGuard(void)</span>
<a href="#l73.1654"></a><span id="l73.1654" class="difflineminus">-{</span>
<a href="#l73.1655"></a><span id="l73.1655" class="difflineminus">-    delete mHelper ;</span>
<a href="#l73.1656"></a><span id="l73.1656" class="difflineplus">+nsAbWinHelperGuard::nsAbWinHelperGuard(uint32_t aType) : mHelper(NULL) {</span>
<a href="#l73.1657"></a><span id="l73.1657" class="difflineplus">+  switch (aType) {</span>
<a href="#l73.1658"></a><span id="l73.1658" class="difflineplus">+    case nsAbWinType_Outlook:</span>
<a href="#l73.1659"></a><span id="l73.1659" class="difflineplus">+      mHelper = new nsMapiAddressBook;</span>
<a href="#l73.1660"></a><span id="l73.1660" class="difflineplus">+      break;</span>
<a href="#l73.1661"></a><span id="l73.1661" class="difflineplus">+    case nsAbWinType_OutlookExp:</span>
<a href="#l73.1662"></a><span id="l73.1662" class="difflineplus">+      mHelper = new nsWabAddressBook;</span>
<a href="#l73.1663"></a><span id="l73.1663" class="difflineplus">+      break;</span>
<a href="#l73.1664"></a><span id="l73.1664" class="difflineplus">+    default:</span>
<a href="#l73.1665"></a><span id="l73.1665" class="difflineplus">+      break;</span>
<a href="#l73.1666"></a><span id="l73.1666" class="difflineplus">+  }</span>
<a href="#l73.1667"></a><span id="l73.1667"> }</span>
<a href="#l73.1668"></a><span id="l73.1668"> </span>
<a href="#l73.1669"></a><span id="l73.1669" class="difflineminus">-const char *kOutlookDirectoryScheme = &quot;moz-aboutlookdirectory://&quot; ;</span>
<a href="#l73.1670"></a><span id="l73.1670" class="difflineminus">-const int kOutlookDirSchemeLength = 21 ;</span>
<a href="#l73.1671"></a><span id="l73.1671" class="difflineminus">-const char *kOutlookStub = &quot;op/&quot; ;</span>
<a href="#l73.1672"></a><span id="l73.1672" class="difflineminus">-const int kOutlookStubLength = 3 ;</span>
<a href="#l73.1673"></a><span id="l73.1673" class="difflineminus">-const char *kOutlookExpStub = &quot;oe/&quot; ;</span>
<a href="#l73.1674"></a><span id="l73.1674" class="difflineminus">-const int kOutlookExpStubLength = 3 ;</span>
<a href="#l73.1675"></a><span id="l73.1675" class="difflineminus">-const char *kOutlookCardScheme = &quot;moz-aboutlookcard://&quot; ;</span>
<a href="#l73.1676"></a><span id="l73.1676" class="difflineplus">+nsAbWinHelperGuard::~nsAbWinHelperGuard(void) { delete mHelper; }</span>
<a href="#l73.1677"></a><span id="l73.1677"> </span>
<a href="#l73.1678"></a><span id="l73.1678" class="difflineminus">-nsAbWinType getAbWinType(const char *aScheme, const char *aUri, nsCString&amp; aStub, nsCString&amp; aEntry)</span>
<a href="#l73.1679"></a><span id="l73.1679" class="difflineminus">-{</span>
<a href="#l73.1680"></a><span id="l73.1680" class="difflineminus">-    aStub.Truncate() ;</span>
<a href="#l73.1681"></a><span id="l73.1681" class="difflineminus">-    aEntry.Truncate() ;</span>
<a href="#l73.1682"></a><span id="l73.1682" class="difflineminus">-    uint32_t schemeLength = strlen(aScheme) ;</span>
<a href="#l73.1683"></a><span id="l73.1683" class="difflineplus">+const char* kOutlookDirectoryScheme = &quot;moz-aboutlookdirectory://&quot;;</span>
<a href="#l73.1684"></a><span id="l73.1684" class="difflineplus">+const int kOutlookDirSchemeLength = 21;</span>
<a href="#l73.1685"></a><span id="l73.1685" class="difflineplus">+const char* kOutlookStub = &quot;op/&quot;;</span>
<a href="#l73.1686"></a><span id="l73.1686" class="difflineplus">+const int kOutlookStubLength = 3;</span>
<a href="#l73.1687"></a><span id="l73.1687" class="difflineplus">+const char* kOutlookExpStub = &quot;oe/&quot;;</span>
<a href="#l73.1688"></a><span id="l73.1688" class="difflineplus">+const int kOutlookExpStubLength = 3;</span>
<a href="#l73.1689"></a><span id="l73.1689" class="difflineplus">+const char* kOutlookCardScheme = &quot;moz-aboutlookcard://&quot;;</span>
<a href="#l73.1690"></a><span id="l73.1690"> </span>
<a href="#l73.1691"></a><span id="l73.1691" class="difflineminus">-    if (strncmp(aUri, aScheme, schemeLength) == 0) {</span>
<a href="#l73.1692"></a><span id="l73.1692" class="difflineminus">-        if (strncmp(aUri + schemeLength, kOutlookStub, kOutlookStubLength) == 0) {</span>
<a href="#l73.1693"></a><span id="l73.1693" class="difflineminus">-            aEntry = aUri + schemeLength + kOutlookStubLength ;</span>
<a href="#l73.1694"></a><span id="l73.1694" class="difflineminus">-            aStub = kOutlookStub ;</span>
<a href="#l73.1695"></a><span id="l73.1695" class="difflineminus">-            return nsAbWinType_Outlook ;</span>
<a href="#l73.1696"></a><span id="l73.1696" class="difflineminus">-        }</span>
<a href="#l73.1697"></a><span id="l73.1697" class="difflineminus">-        if (strncmp(aUri + schemeLength, kOutlookExpStub, kOutlookExpStubLength) == 0) {</span>
<a href="#l73.1698"></a><span id="l73.1698" class="difflineminus">-            aEntry = aUri + schemeLength + kOutlookExpStubLength ;</span>
<a href="#l73.1699"></a><span id="l73.1699" class="difflineminus">-            aStub = kOutlookExpStub ;</span>
<a href="#l73.1700"></a><span id="l73.1700" class="difflineminus">-            return nsAbWinType_OutlookExp ;</span>
<a href="#l73.1701"></a><span id="l73.1701" class="difflineminus">-        }</span>
<a href="#l73.1702"></a><span id="l73.1702" class="difflineplus">+nsAbWinType getAbWinType(const char* aScheme, const char* aUri,</span>
<a href="#l73.1703"></a><span id="l73.1703" class="difflineplus">+                         nsCString&amp; aStub, nsCString&amp; aEntry) {</span>
<a href="#l73.1704"></a><span id="l73.1704" class="difflineplus">+  aStub.Truncate();</span>
<a href="#l73.1705"></a><span id="l73.1705" class="difflineplus">+  aEntry.Truncate();</span>
<a href="#l73.1706"></a><span id="l73.1706" class="difflineplus">+  uint32_t schemeLength = strlen(aScheme);</span>
<a href="#l73.1707"></a><span id="l73.1707" class="difflineplus">+</span>
<a href="#l73.1708"></a><span id="l73.1708" class="difflineplus">+  if (strncmp(aUri, aScheme, schemeLength) == 0) {</span>
<a href="#l73.1709"></a><span id="l73.1709" class="difflineplus">+    if (strncmp(aUri + schemeLength, kOutlookStub, kOutlookStubLength) == 0) {</span>
<a href="#l73.1710"></a><span id="l73.1710" class="difflineplus">+      aEntry = aUri + schemeLength + kOutlookStubLength;</span>
<a href="#l73.1711"></a><span id="l73.1711" class="difflineplus">+      aStub = kOutlookStub;</span>
<a href="#l73.1712"></a><span id="l73.1712" class="difflineplus">+      return nsAbWinType_Outlook;</span>
<a href="#l73.1713"></a><span id="l73.1713">     }</span>
<a href="#l73.1714"></a><span id="l73.1714" class="difflineminus">-    return nsAbWinType_Unknown ;</span>
<a href="#l73.1715"></a><span id="l73.1715" class="difflineplus">+    if (strncmp(aUri + schemeLength, kOutlookExpStub, kOutlookExpStubLength) ==</span>
<a href="#l73.1716"></a><span id="l73.1716" class="difflineplus">+        0) {</span>
<a href="#l73.1717"></a><span id="l73.1717" class="difflineplus">+      aEntry = aUri + schemeLength + kOutlookExpStubLength;</span>
<a href="#l73.1718"></a><span id="l73.1718" class="difflineplus">+      aStub = kOutlookExpStub;</span>
<a href="#l73.1719"></a><span id="l73.1719" class="difflineplus">+      return nsAbWinType_OutlookExp;</span>
<a href="#l73.1720"></a><span id="l73.1720" class="difflineplus">+    }</span>
<a href="#l73.1721"></a><span id="l73.1721" class="difflineplus">+  }</span>
<a href="#l73.1722"></a><span id="l73.1722" class="difflineplus">+  return nsAbWinType_Unknown;</span>
<a href="#l73.1723"></a><span id="l73.1723"> }</span>
<a href="#l73.1724"></a><span id="l73.1724"> </span>
<a href="#l73.1725"></a><span id="l73.1725" class="difflineminus">-void buildAbWinUri(const char *aScheme, uint32_t aType, nsCString&amp; aUri)</span>
<a href="#l73.1726"></a><span id="l73.1726" class="difflineminus">-{</span>
<a href="#l73.1727"></a><span id="l73.1727" class="difflineminus">-    aUri.Assign(aScheme) ;</span>
<a href="#l73.1728"></a><span id="l73.1728" class="difflineminus">-    switch(aType) {</span>
<a href="#l73.1729"></a><span id="l73.1729" class="difflineminus">-    case nsAbWinType_Outlook: aUri.Append(kOutlookStub) ; break ;</span>
<a href="#l73.1730"></a><span id="l73.1730" class="difflineminus">-    case nsAbWinType_OutlookExp: aUri.Append(kOutlookExpStub) ; break ;</span>
<a href="#l73.1731"></a><span id="l73.1731" class="difflineminus">-    default: aUri.AssignLiteral(&quot;&quot;) ;</span>
<a href="#l73.1732"></a><span id="l73.1732" class="difflineminus">-    }</span>
<a href="#l73.1733"></a><span id="l73.1733" class="difflineplus">+void buildAbWinUri(const char* aScheme, uint32_t aType, nsCString&amp; aUri) {</span>
<a href="#l73.1734"></a><span id="l73.1734" class="difflineplus">+  aUri.Assign(aScheme);</span>
<a href="#l73.1735"></a><span id="l73.1735" class="difflineplus">+  switch (aType) {</span>
<a href="#l73.1736"></a><span id="l73.1736" class="difflineplus">+    case nsAbWinType_Outlook:</span>
<a href="#l73.1737"></a><span id="l73.1737" class="difflineplus">+      aUri.Append(kOutlookStub);</span>
<a href="#l73.1738"></a><span id="l73.1738" class="difflineplus">+      break;</span>
<a href="#l73.1739"></a><span id="l73.1739" class="difflineplus">+    case nsAbWinType_OutlookExp:</span>
<a href="#l73.1740"></a><span id="l73.1740" class="difflineplus">+      aUri.Append(kOutlookExpStub);</span>
<a href="#l73.1741"></a><span id="l73.1741" class="difflineplus">+      break;</span>
<a href="#l73.1742"></a><span id="l73.1742" class="difflineplus">+    default:</span>
<a href="#l73.1743"></a><span id="l73.1743" class="difflineplus">+      aUri.AssignLiteral(&quot;&quot;);</span>
<a href="#l73.1744"></a><span id="l73.1744" class="difflineplus">+  }</span>
<a href="#l73.1745"></a><span id="l73.1745"> }</span>
<a href="#l73.1746"></a><span id="l73.1746" class="difflineminus">-</span>
<a href="#l73.1747"></a><span id="l73.1747" class="difflineminus">-</span>
<a href="#l73.1748"></a><span id="l73.1748" class="difflineminus">-</span>
<a href="#l73.1749"></a><span id="l73.1749" class="difflineminus">-</span>
<a href="#l73.1750"></a><span id="l73.1750" class="difflineminus">-</span>
<a href="#l73.1751"></a><span id="l73.1751" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbWinHelper.h</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbWinHelper.h</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -7,150 +7,149 @@</span>
<a href="#l74.4"></a><span id="l74.4"> </span>
<a href="#l74.5"></a><span id="l74.5"> #include &lt;windows.h&gt;</span>
<a href="#l74.6"></a><span id="l74.6"> #include &lt;mapix.h&gt;</span>
<a href="#l74.7"></a><span id="l74.7"> </span>
<a href="#l74.8"></a><span id="l74.8"> #include &quot;nsString.h&quot;</span>
<a href="#l74.9"></a><span id="l74.9"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l74.10"></a><span id="l74.10"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-struct nsMapiEntry</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineminus">-{</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineminus">-    ULONG     mByteCount ;</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineminus">-    LPENTRYID mEntryId ;</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineplus">+struct nsMapiEntry {</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineplus">+  ULONG mByteCount;</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+  LPENTRYID mEntryId;</span>
<a href="#l74.19"></a><span id="l74.19"> </span>
<a href="#l74.20"></a><span id="l74.20" class="difflineminus">-    nsMapiEntry(void) ;</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineminus">-    ~nsMapiEntry(void) ;</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineminus">-    nsMapiEntry(ULONG aByteCount, LPENTRYID aEntryId) ;</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineplus">+  nsMapiEntry(void);</span>
<a href="#l74.24"></a><span id="l74.24" class="difflineplus">+  ~nsMapiEntry(void);</span>
<a href="#l74.25"></a><span id="l74.25" class="difflineplus">+  nsMapiEntry(ULONG aByteCount, LPENTRYID aEntryId);</span>
<a href="#l74.26"></a><span id="l74.26"> </span>
<a href="#l74.27"></a><span id="l74.27" class="difflineminus">-    void Assign(ULONG aByteCount, LPENTRYID aEntryId) ;</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineminus">-    void Assign(const nsCString&amp; aString) ;</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineminus">-    void ToString(nsCString&amp; aString) const ;</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineminus">-    void Dump(void) const ;</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineminus">-} ;</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineplus">+  void Assign(ULONG aByteCount, LPENTRYID aEntryId);</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineplus">+  void Assign(const nsCString&amp; aString);</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineplus">+  void ToString(nsCString&amp; aString) const;</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineplus">+  void Dump(void) const;</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineplus">+};</span>
<a href="#l74.37"></a><span id="l74.37"> </span>
<a href="#l74.38"></a><span id="l74.38" class="difflineminus">-struct nsMapiEntryArray</span>
<a href="#l74.39"></a><span id="l74.39" class="difflineminus">-{</span>
<a href="#l74.40"></a><span id="l74.40" class="difflineminus">-    nsMapiEntry *mEntries ;</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineminus">-    ULONG      mNbEntries ;</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineplus">+struct nsMapiEntryArray {</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineplus">+  nsMapiEntry* mEntries;</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineplus">+  ULONG mNbEntries;</span>
<a href="#l74.45"></a><span id="l74.45"> </span>
<a href="#l74.46"></a><span id="l74.46" class="difflineminus">-    nsMapiEntryArray(void) ;</span>
<a href="#l74.47"></a><span id="l74.47" class="difflineminus">-    ~nsMapiEntryArray(void) ;</span>
<a href="#l74.48"></a><span id="l74.48" class="difflineplus">+  nsMapiEntryArray(void);</span>
<a href="#l74.49"></a><span id="l74.49" class="difflineplus">+  ~nsMapiEntryArray(void);</span>
<a href="#l74.50"></a><span id="l74.50"> </span>
<a href="#l74.51"></a><span id="l74.51" class="difflineminus">-    const nsMapiEntry&amp; operator [] (int aIndex) const { return mEntries [aIndex] ; }</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineminus">-    void CleanUp(void) ;</span>
<a href="#l74.53"></a><span id="l74.53" class="difflineminus">-} ;</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineplus">+  const nsMapiEntry&amp; operator[](int aIndex) const { return mEntries[aIndex]; }</span>
<a href="#l74.55"></a><span id="l74.55" class="difflineplus">+  void CleanUp(void);</span>
<a href="#l74.56"></a><span id="l74.56" class="difflineplus">+};</span>
<a href="#l74.57"></a><span id="l74.57"> </span>
<a href="#l74.58"></a><span id="l74.58" class="difflineminus">-class nsAbWinHelper</span>
<a href="#l74.59"></a><span id="l74.59" class="difflineminus">-{</span>
<a href="#l74.60"></a><span id="l74.60" class="difflineminus">-public:</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineminus">-    nsAbWinHelper(void) ;</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineminus">-    virtual ~nsAbWinHelper(void) ;</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+class nsAbWinHelper {</span>
<a href="#l74.64"></a><span id="l74.64" class="difflineplus">+ public:</span>
<a href="#l74.65"></a><span id="l74.65" class="difflineplus">+  nsAbWinHelper(void);</span>
<a href="#l74.66"></a><span id="l74.66" class="difflineplus">+  virtual ~nsAbWinHelper(void);</span>
<a href="#l74.67"></a><span id="l74.67"> </span>
<a href="#l74.68"></a><span id="l74.68" class="difflineminus">-    // Get the top address books</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineminus">-    BOOL GetFolders(nsMapiEntryArray&amp; aFolders) ;</span>
<a href="#l74.70"></a><span id="l74.70" class="difflineminus">-    // Get a list of entries for cards/mailing lists in a folder/mailing list</span>
<a href="#l74.71"></a><span id="l74.71" class="difflineminus">-    BOOL GetCards(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineminus">-                  nsMapiEntryArray&amp; aCards) ;</span>
<a href="#l74.73"></a><span id="l74.73" class="difflineminus">-    // Get a list of mailing lists in a folder</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineminus">-    BOOL GetNodes(const nsMapiEntry&amp; aParent, nsMapiEntryArray&amp; aNodes) ;</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineminus">-    // Get the number of cards/mailing lists in a folder/mailing list</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineminus">-    BOOL GetCardsCount(const nsMapiEntry&amp; aParent, ULONG&amp; aNbCards) ;</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineminus">-    // Access last MAPI error</span>
<a href="#l74.78"></a><span id="l74.78" class="difflineminus">-    HRESULT LastError(void) const { return mLastError ; }</span>
<a href="#l74.79"></a><span id="l74.79" class="difflineminus">-    // Get the value of a MAPI property of type string</span>
<a href="#l74.80"></a><span id="l74.80" class="difflineminus">-    BOOL GetPropertyString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, nsCString&amp; aValue) ;</span>
<a href="#l74.81"></a><span id="l74.81" class="difflineminus">-    // Same as previous, but string is returned as unicode</span>
<a href="#l74.82"></a><span id="l74.82" class="difflineminus">-    BOOL GetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, nsString&amp; aValue) ;</span>
<a href="#l74.83"></a><span id="l74.83" class="difflineminus">-    // Get multiple string MAPI properties in one call.</span>
<a href="#l74.84"></a><span id="l74.84" class="difflineminus">-    BOOL GetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertiesTag,</span>
<a href="#l74.85"></a><span id="l74.85" class="difflineminus">-                              ULONG aNbProperties, nsString *aValues);</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineminus">-    // Get the value of a MAPI property of type SYSTIME</span>
<a href="#l74.87"></a><span id="l74.87" class="difflineminus">-    BOOL GetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.88"></a><span id="l74.88" class="difflineminus">-                         WORD&amp; aYear, WORD&amp; aMonth, WORD&amp; aDay) ;</span>
<a href="#l74.89"></a><span id="l74.89" class="difflineminus">-    // Get the value of a MAPI property of type LONG</span>
<a href="#l74.90"></a><span id="l74.90" class="difflineminus">-    BOOL GetPropertyLong(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, ULONG&amp; aValue) ;</span>
<a href="#l74.91"></a><span id="l74.91" class="difflineminus">-    // Get the value of a MAPI property of type BIN</span>
<a href="#l74.92"></a><span id="l74.92" class="difflineminus">-    BOOL GetPropertyBin(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, nsMapiEntry&amp; aValue) ;</span>
<a href="#l74.93"></a><span id="l74.93" class="difflineminus">-    // Tests if a container contains an entry</span>
<a href="#l74.94"></a><span id="l74.94" class="difflineminus">-    BOOL TestOpenEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry) ;</span>
<a href="#l74.95"></a><span id="l74.95" class="difflineminus">-    // Delete an entry in the address book</span>
<a href="#l74.96"></a><span id="l74.96" class="difflineminus">-    BOOL DeleteEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry) ;</span>
<a href="#l74.97"></a><span id="l74.97" class="difflineminus">-    // Set the value of a MAPI property of type string in unicode</span>
<a href="#l74.98"></a><span id="l74.98" class="difflineminus">-    BOOL SetPropertyUString (const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.99"></a><span id="l74.99" class="difflineminus">-                             const char16_t *aValue) ;</span>
<a href="#l74.100"></a><span id="l74.100" class="difflineminus">-    // Same as previous, but with a bunch of properties in one call</span>
<a href="#l74.101"></a><span id="l74.101" class="difflineminus">-    BOOL SetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertiesTag,</span>
<a href="#l74.102"></a><span id="l74.102" class="difflineminus">-                              ULONG aNbProperties, nsString *aValues) ;</span>
<a href="#l74.103"></a><span id="l74.103" class="difflineminus">-    // Set the value of a MAPI property of type SYSTIME</span>
<a href="#l74.104"></a><span id="l74.104" class="difflineminus">-    BOOL SetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.105"></a><span id="l74.105" class="difflineminus">-                         WORD aYear, WORD aMonth, WORD aDay) ;</span>
<a href="#l74.106"></a><span id="l74.106" class="difflineminus">-    // Create entry in the address book</span>
<a href="#l74.107"></a><span id="l74.107" class="difflineminus">-    BOOL CreateEntry(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry) ;</span>
<a href="#l74.108"></a><span id="l74.108" class="difflineminus">-    // Create a distribution list in the address book</span>
<a href="#l74.109"></a><span id="l74.109" class="difflineminus">-    BOOL CreateDistList(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry) ;</span>
<a href="#l74.110"></a><span id="l74.110" class="difflineminus">-    // Copy an existing entry in the address book</span>
<a href="#l74.111"></a><span id="l74.111" class="difflineminus">-    BOOL CopyEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aSource, nsMapiEntry&amp; aTarget) ;</span>
<a href="#l74.112"></a><span id="l74.112" class="difflineminus">-    // Get a default address book container</span>
<a href="#l74.113"></a><span id="l74.113" class="difflineminus">-    BOOL GetDefaultContainer(nsMapiEntry&amp; aContainer) ;</span>
<a href="#l74.114"></a><span id="l74.114" class="difflineminus">-    // Is the helper correctly initialised?</span>
<a href="#l74.115"></a><span id="l74.115" class="difflineminus">-    BOOL IsOK(void) const { return mAddressBook != NULL ; }</span>
<a href="#l74.116"></a><span id="l74.116" class="difflineplus">+  // Get the top address books</span>
<a href="#l74.117"></a><span id="l74.117" class="difflineplus">+  BOOL GetFolders(nsMapiEntryArray&amp; aFolders);</span>
<a href="#l74.118"></a><span id="l74.118" class="difflineplus">+  // Get a list of entries for cards/mailing lists in a folder/mailing list</span>
<a href="#l74.119"></a><span id="l74.119" class="difflineplus">+  BOOL GetCards(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l74.120"></a><span id="l74.120" class="difflineplus">+                nsMapiEntryArray&amp; aCards);</span>
<a href="#l74.121"></a><span id="l74.121" class="difflineplus">+  // Get a list of mailing lists in a folder</span>
<a href="#l74.122"></a><span id="l74.122" class="difflineplus">+  BOOL GetNodes(const nsMapiEntry&amp; aParent, nsMapiEntryArray&amp; aNodes);</span>
<a href="#l74.123"></a><span id="l74.123" class="difflineplus">+  // Get the number of cards/mailing lists in a folder/mailing list</span>
<a href="#l74.124"></a><span id="l74.124" class="difflineplus">+  BOOL GetCardsCount(const nsMapiEntry&amp; aParent, ULONG&amp; aNbCards);</span>
<a href="#l74.125"></a><span id="l74.125" class="difflineplus">+  // Access last MAPI error</span>
<a href="#l74.126"></a><span id="l74.126" class="difflineplus">+  HRESULT LastError(void) const { return mLastError; }</span>
<a href="#l74.127"></a><span id="l74.127" class="difflineplus">+  // Get the value of a MAPI property of type string</span>
<a href="#l74.128"></a><span id="l74.128" class="difflineplus">+  BOOL GetPropertyString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.129"></a><span id="l74.129" class="difflineplus">+                         nsCString&amp; aValue);</span>
<a href="#l74.130"></a><span id="l74.130" class="difflineplus">+  // Same as previous, but string is returned as unicode</span>
<a href="#l74.131"></a><span id="l74.131" class="difflineplus">+  BOOL GetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.132"></a><span id="l74.132" class="difflineplus">+                          nsString&amp; aValue);</span>
<a href="#l74.133"></a><span id="l74.133" class="difflineplus">+  // Get multiple string MAPI properties in one call.</span>
<a href="#l74.134"></a><span id="l74.134" class="difflineplus">+  BOOL GetPropertiesUString(const nsMapiEntry&amp; aObject,</span>
<a href="#l74.135"></a><span id="l74.135" class="difflineplus">+                            const ULONG* aPropertiesTag, ULONG aNbProperties,</span>
<a href="#l74.136"></a><span id="l74.136" class="difflineplus">+                            nsString* aValues);</span>
<a href="#l74.137"></a><span id="l74.137" class="difflineplus">+  // Get the value of a MAPI property of type SYSTIME</span>
<a href="#l74.138"></a><span id="l74.138" class="difflineplus">+  BOOL GetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.139"></a><span id="l74.139" class="difflineplus">+                       WORD&amp; aYear, WORD&amp; aMonth, WORD&amp; aDay);</span>
<a href="#l74.140"></a><span id="l74.140" class="difflineplus">+  // Get the value of a MAPI property of type LONG</span>
<a href="#l74.141"></a><span id="l74.141" class="difflineplus">+  BOOL GetPropertyLong(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.142"></a><span id="l74.142" class="difflineplus">+                       ULONG&amp; aValue);</span>
<a href="#l74.143"></a><span id="l74.143" class="difflineplus">+  // Get the value of a MAPI property of type BIN</span>
<a href="#l74.144"></a><span id="l74.144" class="difflineplus">+  BOOL GetPropertyBin(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.145"></a><span id="l74.145" class="difflineplus">+                      nsMapiEntry&amp; aValue);</span>
<a href="#l74.146"></a><span id="l74.146" class="difflineplus">+  // Tests if a container contains an entry</span>
<a href="#l74.147"></a><span id="l74.147" class="difflineplus">+  BOOL TestOpenEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry);</span>
<a href="#l74.148"></a><span id="l74.148" class="difflineplus">+  // Delete an entry in the address book</span>
<a href="#l74.149"></a><span id="l74.149" class="difflineplus">+  BOOL DeleteEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry);</span>
<a href="#l74.150"></a><span id="l74.150" class="difflineplus">+  // Set the value of a MAPI property of type string in unicode</span>
<a href="#l74.151"></a><span id="l74.151" class="difflineplus">+  BOOL SetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.152"></a><span id="l74.152" class="difflineplus">+                          const char16_t* aValue);</span>
<a href="#l74.153"></a><span id="l74.153" class="difflineplus">+  // Same as previous, but with a bunch of properties in one call</span>
<a href="#l74.154"></a><span id="l74.154" class="difflineplus">+  BOOL SetPropertiesUString(const nsMapiEntry&amp; aObject,</span>
<a href="#l74.155"></a><span id="l74.155" class="difflineplus">+                            const ULONG* aPropertiesTag, ULONG aNbProperties,</span>
<a href="#l74.156"></a><span id="l74.156" class="difflineplus">+                            nsString* aValues);</span>
<a href="#l74.157"></a><span id="l74.157" class="difflineplus">+  // Set the value of a MAPI property of type SYSTIME</span>
<a href="#l74.158"></a><span id="l74.158" class="difflineplus">+  BOOL SetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l74.159"></a><span id="l74.159" class="difflineplus">+                       WORD aYear, WORD aMonth, WORD aDay);</span>
<a href="#l74.160"></a><span id="l74.160" class="difflineplus">+  // Create entry in the address book</span>
<a href="#l74.161"></a><span id="l74.161" class="difflineplus">+  BOOL CreateEntry(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry);</span>
<a href="#l74.162"></a><span id="l74.162" class="difflineplus">+  // Create a distribution list in the address book</span>
<a href="#l74.163"></a><span id="l74.163" class="difflineplus">+  BOOL CreateDistList(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry);</span>
<a href="#l74.164"></a><span id="l74.164" class="difflineplus">+  // Copy an existing entry in the address book</span>
<a href="#l74.165"></a><span id="l74.165" class="difflineplus">+  BOOL CopyEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aSource,</span>
<a href="#l74.166"></a><span id="l74.166" class="difflineplus">+                 nsMapiEntry&amp; aTarget);</span>
<a href="#l74.167"></a><span id="l74.167" class="difflineplus">+  // Get a default address book container</span>
<a href="#l74.168"></a><span id="l74.168" class="difflineplus">+  BOOL GetDefaultContainer(nsMapiEntry&amp; aContainer);</span>
<a href="#l74.169"></a><span id="l74.169" class="difflineplus">+  // Is the helper correctly initialised?</span>
<a href="#l74.170"></a><span id="l74.170" class="difflineplus">+  BOOL IsOK(void) const { return mAddressBook != NULL; }</span>
<a href="#l74.171"></a><span id="l74.171"> </span>
<a href="#l74.172"></a><span id="l74.172" class="difflineminus">-protected:</span>
<a href="#l74.173"></a><span id="l74.173" class="difflineminus">-    HRESULT mLastError ;</span>
<a href="#l74.174"></a><span id="l74.174" class="difflineminus">-    LPADRBOOK mAddressBook ;</span>
<a href="#l74.175"></a><span id="l74.175" class="difflineminus">-    static uint32_t mEntryCounter ;</span>
<a href="#l74.176"></a><span id="l74.176" class="difflineminus">-    static uint32_t mUseCount ;</span>
<a href="#l74.177"></a><span id="l74.177" class="difflineminus">-    static nsAutoPtr&lt;mozilla::Mutex&gt; mMutex ;</span>
<a href="#l74.178"></a><span id="l74.178" class="difflineplus">+ protected:</span>
<a href="#l74.179"></a><span id="l74.179" class="difflineplus">+  HRESULT mLastError;</span>
<a href="#l74.180"></a><span id="l74.180" class="difflineplus">+  LPADRBOOK mAddressBook;</span>
<a href="#l74.181"></a><span id="l74.181" class="difflineplus">+  static uint32_t mEntryCounter;</span>
<a href="#l74.182"></a><span id="l74.182" class="difflineplus">+  static uint32_t mUseCount;</span>
<a href="#l74.183"></a><span id="l74.183" class="difflineplus">+  static nsAutoPtr&lt;mozilla::Mutex&gt; mMutex;</span>
<a href="#l74.184"></a><span id="l74.184"> </span>
<a href="#l74.185"></a><span id="l74.185" class="difflineminus">-    // Retrieve the contents of a container, with an optional restriction</span>
<a href="#l74.186"></a><span id="l74.186" class="difflineminus">-    BOOL GetContents(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l74.187"></a><span id="l74.187" class="difflineminus">-                     nsMapiEntry **aList, ULONG &amp;aNbElements, ULONG aMapiType) ;</span>
<a href="#l74.188"></a><span id="l74.188" class="difflineminus">-    // Retrieve the values of a set of properties on a MAPI object</span>
<a href="#l74.189"></a><span id="l74.189" class="difflineminus">-    BOOL GetMAPIProperties(const nsMapiEntry&amp; aObject, const ULONG *aPropertyTags,</span>
<a href="#l74.190"></a><span id="l74.190" class="difflineminus">-                           ULONG aNbProperties,</span>
<a href="#l74.191"></a><span id="l74.191" class="difflineminus">-                           LPSPropValue&amp; aValues, ULONG&amp; aValueCount) ;</span>
<a href="#l74.192"></a><span id="l74.192" class="difflineminus">-    // Set the values of a set of properties on a MAPI object</span>
<a href="#l74.193"></a><span id="l74.193" class="difflineminus">-    BOOL SetMAPIProperties(const nsMapiEntry&amp; aObject, ULONG aNbProperties,</span>
<a href="#l74.194"></a><span id="l74.194" class="difflineminus">-                           const LPSPropValue&amp; aValues) ;</span>
<a href="#l74.195"></a><span id="l74.195" class="difflineminus">-    // Clean-up a rowset returned by QueryRows</span>
<a href="#l74.196"></a><span id="l74.196" class="difflineminus">-    void MyFreeProws(LPSRowSet aSet) ;</span>
<a href="#l74.197"></a><span id="l74.197" class="difflineminus">-    // Allocation of a buffer for transmission to interfaces</span>
<a href="#l74.198"></a><span id="l74.198" class="difflineminus">-    virtual void AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) = 0 ;</span>
<a href="#l74.199"></a><span id="l74.199" class="difflineminus">-    // Destruction of a buffer provided by the interfaces</span>
<a href="#l74.200"></a><span id="l74.200" class="difflineminus">-    virtual void FreeBuffer(LPVOID aBuffer) = 0 ;</span>
<a href="#l74.201"></a><span id="l74.201" class="difflineplus">+  // Retrieve the contents of a container, with an optional restriction</span>
<a href="#l74.202"></a><span id="l74.202" class="difflineplus">+  BOOL GetContents(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l74.203"></a><span id="l74.203" class="difflineplus">+                   nsMapiEntry** aList, ULONG&amp; aNbElements, ULONG aMapiType);</span>
<a href="#l74.204"></a><span id="l74.204" class="difflineplus">+  // Retrieve the values of a set of properties on a MAPI object</span>
<a href="#l74.205"></a><span id="l74.205" class="difflineplus">+  BOOL GetMAPIProperties(const nsMapiEntry&amp; aObject, const ULONG* aPropertyTags,</span>
<a href="#l74.206"></a><span id="l74.206" class="difflineplus">+                         ULONG aNbProperties, LPSPropValue&amp; aValues,</span>
<a href="#l74.207"></a><span id="l74.207" class="difflineplus">+                         ULONG&amp; aValueCount);</span>
<a href="#l74.208"></a><span id="l74.208" class="difflineplus">+  // Set the values of a set of properties on a MAPI object</span>
<a href="#l74.209"></a><span id="l74.209" class="difflineplus">+  BOOL SetMAPIProperties(const nsMapiEntry&amp; aObject, ULONG aNbProperties,</span>
<a href="#l74.210"></a><span id="l74.210" class="difflineplus">+                         const LPSPropValue&amp; aValues);</span>
<a href="#l74.211"></a><span id="l74.211" class="difflineplus">+  // Clean-up a rowset returned by QueryRows</span>
<a href="#l74.212"></a><span id="l74.212" class="difflineplus">+  void MyFreeProws(LPSRowSet aSet);</span>
<a href="#l74.213"></a><span id="l74.213" class="difflineplus">+  // Allocation of a buffer for transmission to interfaces</span>
<a href="#l74.214"></a><span id="l74.214" class="difflineplus">+  virtual void AllocateBuffer(ULONG aByteCount, LPVOID* aBuffer) = 0;</span>
<a href="#l74.215"></a><span id="l74.215" class="difflineplus">+  // Destruction of a buffer provided by the interfaces</span>
<a href="#l74.216"></a><span id="l74.216" class="difflineplus">+  virtual void FreeBuffer(LPVOID aBuffer) = 0;</span>
<a href="#l74.217"></a><span id="l74.217"> </span>
<a href="#l74.218"></a><span id="l74.218" class="difflineminus">-private:</span>
<a href="#l74.219"></a><span id="l74.219" class="difflineminus">-} ;</span>
<a href="#l74.220"></a><span id="l74.220" class="difflineplus">+ private:</span>
<a href="#l74.221"></a><span id="l74.221" class="difflineplus">+};</span>
<a href="#l74.222"></a><span id="l74.222"> </span>
<a href="#l74.223"></a><span id="l74.223" class="difflineminus">-enum nsAbWinType</span>
<a href="#l74.224"></a><span id="l74.224" class="difflineminus">-{</span>
<a href="#l74.225"></a><span id="l74.225" class="difflineminus">-    nsAbWinType_Unknown,</span>
<a href="#l74.226"></a><span id="l74.226" class="difflineminus">-    nsAbWinType_Outlook,</span>
<a href="#l74.227"></a><span id="l74.227" class="difflineminus">-    nsAbWinType_OutlookExp</span>
<a href="#l74.228"></a><span id="l74.228" class="difflineminus">-} ;</span>
<a href="#l74.229"></a><span id="l74.229" class="difflineplus">+enum nsAbWinType {</span>
<a href="#l74.230"></a><span id="l74.230" class="difflineplus">+  nsAbWinType_Unknown,</span>
<a href="#l74.231"></a><span id="l74.231" class="difflineplus">+  nsAbWinType_Outlook,</span>
<a href="#l74.232"></a><span id="l74.232" class="difflineplus">+  nsAbWinType_OutlookExp</span>
<a href="#l74.233"></a><span id="l74.233" class="difflineplus">+};</span>
<a href="#l74.234"></a><span id="l74.234"> </span>
<a href="#l74.235"></a><span id="l74.235" class="difflineminus">-class nsAbWinHelperGuard</span>
<a href="#l74.236"></a><span id="l74.236" class="difflineminus">-{</span>
<a href="#l74.237"></a><span id="l74.237" class="difflineminus">-public :</span>
<a href="#l74.238"></a><span id="l74.238" class="difflineminus">-    explicit nsAbWinHelperGuard(uint32_t aType) ;</span>
<a href="#l74.239"></a><span id="l74.239" class="difflineminus">-    ~nsAbWinHelperGuard(void) ;</span>
<a href="#l74.240"></a><span id="l74.240" class="difflineplus">+class nsAbWinHelperGuard {</span>
<a href="#l74.241"></a><span id="l74.241" class="difflineplus">+ public:</span>
<a href="#l74.242"></a><span id="l74.242" class="difflineplus">+  explicit nsAbWinHelperGuard(uint32_t aType);</span>
<a href="#l74.243"></a><span id="l74.243" class="difflineplus">+  ~nsAbWinHelperGuard(void);</span>
<a href="#l74.244"></a><span id="l74.244"> </span>
<a href="#l74.245"></a><span id="l74.245" class="difflineminus">-    nsAbWinHelper *operator -&gt;(void) { return mHelper ; }</span>
<a href="#l74.246"></a><span id="l74.246" class="difflineplus">+  nsAbWinHelper* operator-&gt;(void) { return mHelper; }</span>
<a href="#l74.247"></a><span id="l74.247"> </span>
<a href="#l74.248"></a><span id="l74.248" class="difflineminus">-private:</span>
<a href="#l74.249"></a><span id="l74.249" class="difflineminus">-    nsAbWinHelper *mHelper ;</span>
<a href="#l74.250"></a><span id="l74.250" class="difflineminus">-} ;</span>
<a href="#l74.251"></a><span id="l74.251" class="difflineplus">+ private:</span>
<a href="#l74.252"></a><span id="l74.252" class="difflineplus">+  nsAbWinHelper* mHelper;</span>
<a href="#l74.253"></a><span id="l74.253" class="difflineplus">+};</span>
<a href="#l74.254"></a><span id="l74.254"> </span>
<a href="#l74.255"></a><span id="l74.255" class="difflineminus">-extern const char *kOutlookDirectoryScheme ;</span>
<a href="#l74.256"></a><span id="l74.256" class="difflineminus">-extern const int  kOutlookDirSchemeLength ;</span>
<a href="#l74.257"></a><span id="l74.257" class="difflineminus">-extern const char *kOutlookStub ;</span>
<a href="#l74.258"></a><span id="l74.258" class="difflineminus">-extern const char *kOutlookExpStub ;</span>
<a href="#l74.259"></a><span id="l74.259" class="difflineminus">-extern const char *kOutlookCardScheme ;</span>
<a href="#l74.260"></a><span id="l74.260" class="difflineplus">+extern const char* kOutlookDirectoryScheme;</span>
<a href="#l74.261"></a><span id="l74.261" class="difflineplus">+extern const int kOutlookDirSchemeLength;</span>
<a href="#l74.262"></a><span id="l74.262" class="difflineplus">+extern const char* kOutlookStub;</span>
<a href="#l74.263"></a><span id="l74.263" class="difflineplus">+extern const char* kOutlookExpStub;</span>
<a href="#l74.264"></a><span id="l74.264" class="difflineplus">+extern const char* kOutlookCardScheme;</span>
<a href="#l74.265"></a><span id="l74.265"> </span>
<a href="#l74.266"></a><span id="l74.266" class="difflineminus">-nsAbWinType getAbWinType(const char *aScheme, const char *aUri,</span>
<a href="#l74.267"></a><span id="l74.267" class="difflineminus">-                         nsCString&amp; aStub, nsCString&amp; aEntry) ;</span>
<a href="#l74.268"></a><span id="l74.268" class="difflineminus">-void buildAbWinUri(const char *aScheme, uint32_t aType, nsCString&amp; aUri) ;</span>
<a href="#l74.269"></a><span id="l74.269" class="difflineplus">+nsAbWinType getAbWinType(const char* aScheme, const char* aUri,</span>
<a href="#l74.270"></a><span id="l74.270" class="difflineplus">+                         nsCString&amp; aStub, nsCString&amp; aEntry);</span>
<a href="#l74.271"></a><span id="l74.271" class="difflineplus">+void buildAbWinUri(const char* aScheme, uint32_t aType, nsCString&amp; aUri);</span>
<a href="#l74.272"></a><span id="l74.272"> </span>
<a href="#l74.273"></a><span id="l74.273" class="difflineminus">-#endif // nsAbWinHelper_h___</span>
<a href="#l74.274"></a><span id="l74.274" class="difflineminus">-</span>
<a href="#l74.275"></a><span id="l74.275" class="difflineminus">-</span>
<a href="#l74.276"></a><span id="l74.276" class="difflineminus">-</span>
<a href="#l74.277"></a><span id="l74.277" class="difflineplus">+#endif  // nsAbWinHelper_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l75.4"></a><span id="l75.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l75.5"></a><span id="l75.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l75.6"></a><span id="l75.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l75.7"></a><span id="l75.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l75.8"></a><span id="l75.8" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l75.9"></a><span id="l75.9" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l75.10"></a><span id="l75.10"> #include &quot;nsString.h&quot;</span>
<a href="#l75.11"></a><span id="l75.11"> </span>
<a href="#l75.12"></a><span id="l75.12"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l75.13"></a><span id="l75.13"> </span>
<a href="#l75.14"></a><span id="l75.14"> #include &quot;nsAddbookUrl.h&quot;</span>
<a href="#l75.15"></a><span id="l75.15"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l75.16"></a><span id="l75.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l75.17"></a><span id="l75.17"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineat">@@ -21,227 +21,197 @@</span>
<a href="#l75.19"></a><span id="l75.19"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l75.20"></a><span id="l75.20"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l75.21"></a><span id="l75.21"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l75.22"></a><span id="l75.22"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l75.23"></a><span id="l75.23"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l75.24"></a><span id="l75.24"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l75.25"></a><span id="l75.25"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l75.26"></a><span id="l75.26"> </span>
<a href="#l75.27"></a><span id="l75.27" class="difflineminus">-nsAddbookProtocolHandler::nsAddbookProtocolHandler()</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineminus">-{</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineplus">+nsAddbookProtocolHandler::nsAddbookProtocolHandler() {</span>
<a href="#l75.30"></a><span id="l75.30">   mAddbookOperation = nsIAddbookUrlOperation::InvalidUrl;</span>
<a href="#l75.31"></a><span id="l75.31"> }</span>
<a href="#l75.32"></a><span id="l75.32"> </span>
<a href="#l75.33"></a><span id="l75.33" class="difflineminus">-nsAddbookProtocolHandler::~nsAddbookProtocolHandler()</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineminus">-{</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineminus">-}</span>
<a href="#l75.36"></a><span id="l75.36" class="difflineplus">+nsAddbookProtocolHandler::~nsAddbookProtocolHandler() {}</span>
<a href="#l75.37"></a><span id="l75.37"> </span>
<a href="#l75.38"></a><span id="l75.38"> NS_IMPL_ISUPPORTS(nsAddbookProtocolHandler, nsIProtocolHandler)</span>
<a href="#l75.39"></a><span id="l75.39"> </span>
<a href="#l75.40"></a><span id="l75.40" class="difflineminus">-NS_IMETHODIMP nsAddbookProtocolHandler::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineminus">-{</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineplus">+NS_IMETHODIMP nsAddbookProtocolHandler::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l75.43"></a><span id="l75.43">   aScheme = &quot;addbook&quot;;</span>
<a href="#l75.44"></a><span id="l75.44">   return NS_OK;</span>
<a href="#l75.45"></a><span id="l75.45"> }</span>
<a href="#l75.46"></a><span id="l75.46"> </span>
<a href="#l75.47"></a><span id="l75.47" class="difflineminus">-NS_IMETHODIMP nsAddbookProtocolHandler::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l75.48"></a><span id="l75.48" class="difflineminus">-{</span>
<a href="#l75.49"></a><span id="l75.49" class="difflineplus">+NS_IMETHODIMP nsAddbookProtocolHandler::GetDefaultPort(int32_t *aDefaultPort) {</span>
<a href="#l75.50"></a><span id="l75.50">   return NS_OK;</span>
<a href="#l75.51"></a><span id="l75.51"> }</span>
<a href="#l75.52"></a><span id="l75.52"> </span>
<a href="#l75.53"></a><span id="l75.53" class="difflineminus">-NS_IMETHODIMP nsAddbookProtocolHandler::GetProtocolFlags(uint32_t *aUritype)</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineminus">-{</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineplus">+NS_IMETHODIMP nsAddbookProtocolHandler::GetProtocolFlags(uint32_t *aUritype) {</span>
<a href="#l75.56"></a><span id="l75.56">   *aUritype = URI_STD | URI_LOADABLE_BY_ANYONE;</span>
<a href="#l75.57"></a><span id="l75.57">   return NS_OK;</span>
<a href="#l75.58"></a><span id="l75.58"> }</span>
<a href="#l75.59"></a><span id="l75.59"> </span>
<a href="#l75.60"></a><span id="l75.60" class="difflineminus">-NS_IMETHODIMP nsAddbookProtocolHandler::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l75.61"></a><span id="l75.61" class="difflineminus">-                                               const char *aOriginCharset, // ignored</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineminus">-                                               nsIURI *aBaseURI,</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineminus">-                                               nsIURI **_retval)</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineminus">-{</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+NS_IMETHODIMP nsAddbookProtocolHandler::NewURI(</span>
<a href="#l75.66"></a><span id="l75.66" class="difflineplus">+    const nsACString &amp;aSpec,</span>
<a href="#l75.67"></a><span id="l75.67" class="difflineplus">+    const char *aOriginCharset,  // ignored</span>
<a href="#l75.68"></a><span id="l75.68" class="difflineplus">+    nsIURI *aBaseURI, nsIURI **_retval) {</span>
<a href="#l75.69"></a><span id="l75.69">   nsresult rv;</span>
<a href="#l75.70"></a><span id="l75.70">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineminus">-  rv = NS_MutateURI(new nsAddbookUrl::Mutator())</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineminus">-         .SetSpec(aSpec)</span>
<a href="#l75.73"></a><span id="l75.73" class="difflineminus">-         .Finalize(uri);</span>
<a href="#l75.74"></a><span id="l75.74" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.75"></a><span id="l75.75" class="difflineplus">+  rv = NS_MutateURI(new nsAddbookUrl::Mutator()).SetSpec(aSpec).Finalize(uri);</span>
<a href="#l75.76"></a><span id="l75.76" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.77"></a><span id="l75.77"> </span>
<a href="#l75.78"></a><span id="l75.78">   uri.forget(_retval);</span>
<a href="#l75.79"></a><span id="l75.79">   return NS_OK;</span>
<a href="#l75.80"></a><span id="l75.80"> }</span>
<a href="#l75.81"></a><span id="l75.81"> </span>
<a href="#l75.82"></a><span id="l75.82"> NS_IMETHODIMP</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineminus">-nsAddbookProtocolHandler::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineminus">-{</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineminus">-    // don't override anything.</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineminus">-    *_retval = false;</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineminus">-    return NS_OK;</span>
<a href="#l75.88"></a><span id="l75.88" class="difflineplus">+nsAddbookProtocolHandler::AllowPort(int32_t port, const char *scheme,</span>
<a href="#l75.89"></a><span id="l75.89" class="difflineplus">+                                    bool *_retval) {</span>
<a href="#l75.90"></a><span id="l75.90" class="difflineplus">+  // don't override anything.</span>
<a href="#l75.91"></a><span id="l75.91" class="difflineplus">+  *_retval = false;</span>
<a href="#l75.92"></a><span id="l75.92" class="difflineplus">+  return NS_OK;</span>
<a href="#l75.93"></a><span id="l75.93"> }</span>
<a href="#l75.94"></a><span id="l75.94"> </span>
<a href="#l75.95"></a><span id="l75.95" class="difflineminus">-nsresult</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineminus">-nsAddbookProtocolHandler::GenerateXMLOutputChannel( nsString &amp;aOutput,</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineminus">-                                                     nsIAddbookUrl *addbookUrl,</span>
<a href="#l75.98"></a><span id="l75.98" class="difflineminus">-                                                     nsIURI *aURI,</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineminus">-                                                     nsILoadInfo *aLoadInfo,</span>
<a href="#l75.100"></a><span id="l75.100" class="difflineminus">-                                                     nsIChannel **_retval)</span>
<a href="#l75.101"></a><span id="l75.101" class="difflineminus">-{</span>
<a href="#l75.102"></a><span id="l75.102" class="difflineplus">+nsresult nsAddbookProtocolHandler::GenerateXMLOutputChannel(</span>
<a href="#l75.103"></a><span id="l75.103" class="difflineplus">+    nsString &amp;aOutput, nsIAddbookUrl *addbookUrl, nsIURI *aURI,</span>
<a href="#l75.104"></a><span id="l75.104" class="difflineplus">+    nsILoadInfo *aLoadInfo, nsIChannel **_retval) {</span>
<a href="#l75.105"></a><span id="l75.105">   nsresult rv;</span>
<a href="#l75.106"></a><span id="l75.106" class="difflineminus">-  nsCOMPtr&lt;nsIStringInputStream&gt; inStr(do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv));</span>
<a href="#l75.107"></a><span id="l75.107" class="difflineplus">+  nsCOMPtr&lt;nsIStringInputStream&gt; inStr(</span>
<a href="#l75.108"></a><span id="l75.108" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv));</span>
<a href="#l75.109"></a><span id="l75.109">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.110"></a><span id="l75.110"> </span>
<a href="#l75.111"></a><span id="l75.111">   NS_ConvertUTF16toUTF8 utf8String(aOutput.get());</span>
<a href="#l75.112"></a><span id="l75.112"> </span>
<a href="#l75.113"></a><span id="l75.113">   rv = inStr-&gt;SetData(utf8String.get(), utf8String.Length());</span>
<a href="#l75.114"></a><span id="l75.114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.115"></a><span id="l75.115"> </span>
<a href="#l75.116"></a><span id="l75.116">   if (aLoadInfo) {</span>
<a href="#l75.117"></a><span id="l75.117" class="difflineminus">-    return NS_NewInputStreamChannelInternal(_retval,</span>
<a href="#l75.118"></a><span id="l75.118" class="difflineminus">-                                            aURI,</span>
<a href="#l75.119"></a><span id="l75.119" class="difflineminus">-                                            inStr.forget(),</span>
<a href="#l75.120"></a><span id="l75.120" class="difflineplus">+    return NS_NewInputStreamChannelInternal(_retval, aURI, inStr.forget(),</span>
<a href="#l75.121"></a><span id="l75.121">                                             NS_LITERAL_CSTRING(&quot;text/xml&quot;),</span>
<a href="#l75.122"></a><span id="l75.122" class="difflineminus">-                                            EmptyCString(),</span>
<a href="#l75.123"></a><span id="l75.123" class="difflineminus">-                                            aLoadInfo);</span>
<a href="#l75.124"></a><span id="l75.124" class="difflineplus">+                                            EmptyCString(), aLoadInfo);</span>
<a href="#l75.125"></a><span id="l75.125">   }</span>
<a href="#l75.126"></a><span id="l75.126"> </span>
<a href="#l75.127"></a><span id="l75.127">   nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l75.128"></a><span id="l75.128" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l75.129"></a><span id="l75.129" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l75.130"></a><span id="l75.130">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipalfailed.&quot;);</span>
<a href="#l75.131"></a><span id="l75.131" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l75.132"></a><span id="l75.132" class="difflineminus">-      return rv;</span>
<a href="#l75.133"></a><span id="l75.133" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l75.134"></a><span id="l75.134"> </span>
<a href="#l75.135"></a><span id="l75.135" class="difflineminus">-  return NS_NewInputStreamChannel(_retval,</span>
<a href="#l75.136"></a><span id="l75.136" class="difflineminus">-                                  aURI,</span>
<a href="#l75.137"></a><span id="l75.137" class="difflineminus">-                                  inStr.forget(),</span>
<a href="#l75.138"></a><span id="l75.138" class="difflineminus">-                                  nullPrincipal,</span>
<a href="#l75.139"></a><span id="l75.139" class="difflineminus">-                                  nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l75.140"></a><span id="l75.140" class="difflineminus">-                                  nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l75.141"></a><span id="l75.141" class="difflineminus">-                                  NS_LITERAL_CSTRING(&quot;text/xml&quot;));</span>
<a href="#l75.142"></a><span id="l75.142" class="difflineplus">+  return NS_NewInputStreamChannel(</span>
<a href="#l75.143"></a><span id="l75.143" class="difflineplus">+      _retval, aURI, inStr.forget(), nullPrincipal,</span>
<a href="#l75.144"></a><span id="l75.144" class="difflineplus">+      nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l75.145"></a><span id="l75.145" class="difflineplus">+      nsIContentPolicy::TYPE_OTHER, NS_LITERAL_CSTRING(&quot;text/xml&quot;));</span>
<a href="#l75.146"></a><span id="l75.146"> }</span>
<a href="#l75.147"></a><span id="l75.147"> </span>
<a href="#l75.148"></a><span id="l75.148"> NS_IMETHODIMP</span>
<a href="#l75.149"></a><span id="l75.149" class="difflineminus">-nsAddbookProtocolHandler::NewChannel(nsIURI *aURI,</span>
<a href="#l75.150"></a><span id="l75.150" class="difflineminus">-                                     nsILoadInfo* aLoadInfo,</span>
<a href="#l75.151"></a><span id="l75.151" class="difflineminus">-                                     nsIChannel **_retval)</span>
<a href="#l75.152"></a><span id="l75.152" class="difflineminus">-{</span>
<a href="#l75.153"></a><span id="l75.153" class="difflineplus">+nsAddbookProtocolHandler::NewChannel(nsIURI *aURI, nsILoadInfo *aLoadInfo,</span>
<a href="#l75.154"></a><span id="l75.154" class="difflineplus">+                                     nsIChannel **_retval) {</span>
<a href="#l75.155"></a><span id="l75.155">   nsresult rv;</span>
<a href="#l75.156"></a><span id="l75.156" class="difflineminus">-  nsCOMPtr &lt;nsIAddbookUrl&gt; addbookUrl = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l75.157"></a><span id="l75.157" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.158"></a><span id="l75.158" class="difflineplus">+  nsCOMPtr&lt;nsIAddbookUrl&gt; addbookUrl = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l75.159"></a><span id="l75.159" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.160"></a><span id="l75.160"> </span>
<a href="#l75.161"></a><span id="l75.161">   rv = addbookUrl-&gt;GetAddbookOperation(&amp;mAddbookOperation);</span>
<a href="#l75.162"></a><span id="l75.162" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.163"></a><span id="l75.163" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.164"></a><span id="l75.164"> </span>
<a href="#l75.165"></a><span id="l75.165">   if (mAddbookOperation == nsIAddbookUrlOperation::InvalidUrl) {</span>
<a href="#l75.166"></a><span id="l75.166">     nsAutoString errorString;</span>
<a href="#l75.167"></a><span id="l75.167">     errorString.AssignLiteral(&quot;Unsupported format/operation requested for &quot;);</span>
<a href="#l75.168"></a><span id="l75.168">     nsAutoCString spec;</span>
<a href="#l75.169"></a><span id="l75.169">     rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l75.170"></a><span id="l75.170" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.171"></a><span id="l75.171" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.172"></a><span id="l75.172"> </span>
<a href="#l75.173"></a><span id="l75.173" class="difflineminus">-     errorString.Append(NS_ConvertUTF8toUTF16(spec));</span>
<a href="#l75.174"></a><span id="l75.174" class="difflineminus">-    rv = GenerateXMLOutputChannel(errorString, addbookUrl, aURI, aLoadInfo, _retval);</span>
<a href="#l75.175"></a><span id="l75.175" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.176"></a><span id="l75.176" class="difflineplus">+    errorString.Append(NS_ConvertUTF8toUTF16(spec));</span>
<a href="#l75.177"></a><span id="l75.177" class="difflineplus">+    rv = GenerateXMLOutputChannel(errorString, addbookUrl, aURI, aLoadInfo,</span>
<a href="#l75.178"></a><span id="l75.178" class="difflineplus">+                                  _retval);</span>
<a href="#l75.179"></a><span id="l75.179" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.180"></a><span id="l75.180">     return NS_OK;</span>
<a href="#l75.181"></a><span id="l75.181">   }</span>
<a href="#l75.182"></a><span id="l75.182"> </span>
<a href="#l75.183"></a><span id="l75.183">   if (mAddbookOperation == nsIAddbookUrlOperation::AddVCard) {</span>
<a href="#l75.184"></a><span id="l75.184" class="difflineminus">-      // create an empty pipe for use with the input stream channel.</span>
<a href="#l75.185"></a><span id="l75.185" class="difflineminus">-      nsCOMPtr&lt;nsIAsyncInputStream&gt; pipeIn;</span>
<a href="#l75.186"></a><span id="l75.186" class="difflineminus">-      nsCOMPtr&lt;nsIAsyncOutputStream&gt; pipeOut;</span>
<a href="#l75.187"></a><span id="l75.187" class="difflineminus">-      nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l75.188"></a><span id="l75.188" class="difflineplus">+    // create an empty pipe for use with the input stream channel.</span>
<a href="#l75.189"></a><span id="l75.189" class="difflineplus">+    nsCOMPtr&lt;nsIAsyncInputStream&gt; pipeIn;</span>
<a href="#l75.190"></a><span id="l75.190" class="difflineplus">+    nsCOMPtr&lt;nsIAsyncOutputStream&gt; pipeOut;</span>
<a href="#l75.191"></a><span id="l75.191" class="difflineplus">+    nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l75.192"></a><span id="l75.192"> </span>
<a href="#l75.193"></a><span id="l75.193" class="difflineminus">-      rv = pipe-&gt;Init(false, false, 0, 0);</span>
<a href="#l75.194"></a><span id="l75.194" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.195"></a><span id="l75.195" class="difflineplus">+    rv = pipe-&gt;Init(false, false, 0, 0);</span>
<a href="#l75.196"></a><span id="l75.196" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.197"></a><span id="l75.197"> </span>
<a href="#l75.198"></a><span id="l75.198" class="difflineminus">-      // These always succeed because the pipe is initialized above.</span>
<a href="#l75.199"></a><span id="l75.199" class="difflineminus">-      MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(pipeIn)));</span>
<a href="#l75.200"></a><span id="l75.200" class="difflineminus">-      MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(pipeOut)));</span>
<a href="#l75.201"></a><span id="l75.201" class="difflineplus">+    // These always succeed because the pipe is initialized above.</span>
<a href="#l75.202"></a><span id="l75.202" class="difflineplus">+    MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(pipeIn)));</span>
<a href="#l75.203"></a><span id="l75.203" class="difflineplus">+    MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(pipeOut)));</span>
<a href="#l75.204"></a><span id="l75.204"> </span>
<a href="#l75.205"></a><span id="l75.205" class="difflineminus">-      pipeOut-&gt;Close();</span>
<a href="#l75.206"></a><span id="l75.206" class="difflineminus">-      if (aLoadInfo) {</span>
<a href="#l75.207"></a><span id="l75.207" class="difflineminus">-        return NS_NewInputStreamChannelInternal(_retval,</span>
<a href="#l75.208"></a><span id="l75.208" class="difflineminus">-                                                aURI,</span>
<a href="#l75.209"></a><span id="l75.209" class="difflineminus">-                                                pipeIn.forget(),</span>
<a href="#l75.210"></a><span id="l75.210" class="difflineminus">-                                                NS_LITERAL_CSTRING(&quot;application/x-addvcard&quot;),</span>
<a href="#l75.211"></a><span id="l75.211" class="difflineminus">-                                                EmptyCString(),</span>
<a href="#l75.212"></a><span id="l75.212" class="difflineminus">-                                                aLoadInfo);</span>
<a href="#l75.213"></a><span id="l75.213" class="difflineminus">-      }</span>
<a href="#l75.214"></a><span id="l75.214" class="difflineplus">+    pipeOut-&gt;Close();</span>
<a href="#l75.215"></a><span id="l75.215" class="difflineplus">+    if (aLoadInfo) {</span>
<a href="#l75.216"></a><span id="l75.216" class="difflineplus">+      return NS_NewInputStreamChannelInternal(</span>
<a href="#l75.217"></a><span id="l75.217" class="difflineplus">+          _retval, aURI, pipeIn.forget(),</span>
<a href="#l75.218"></a><span id="l75.218" class="difflineplus">+          NS_LITERAL_CSTRING(&quot;application/x-addvcard&quot;), EmptyCString(),</span>
<a href="#l75.219"></a><span id="l75.219" class="difflineplus">+          aLoadInfo);</span>
<a href="#l75.220"></a><span id="l75.220" class="difflineplus">+    }</span>
<a href="#l75.221"></a><span id="l75.221"> </span>
<a href="#l75.222"></a><span id="l75.222" class="difflineminus">-      nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l75.223"></a><span id="l75.223" class="difflineplus">+    nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l75.224"></a><span id="l75.224">         do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l75.225"></a><span id="l75.225" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed.&quot;);</span>
<a href="#l75.226"></a><span id="l75.226" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l75.227"></a><span id="l75.227" class="difflineminus">-          return rv;</span>
<a href="#l75.228"></a><span id="l75.228" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed.&quot;);</span>
<a href="#l75.229"></a><span id="l75.229" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l75.230"></a><span id="l75.230"> </span>
<a href="#l75.231"></a><span id="l75.231" class="difflineminus">-      return NS_NewInputStreamChannel(_retval,</span>
<a href="#l75.232"></a><span id="l75.232" class="difflineminus">-                                      aURI,</span>
<a href="#l75.233"></a><span id="l75.233" class="difflineminus">-                                      pipeIn.forget(),</span>
<a href="#l75.234"></a><span id="l75.234" class="difflineminus">-                                      nullPrincipal,</span>
<a href="#l75.235"></a><span id="l75.235" class="difflineminus">-                                      nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l75.236"></a><span id="l75.236" class="difflineminus">-                                      nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l75.237"></a><span id="l75.237" class="difflineminus">-                                      NS_LITERAL_CSTRING(&quot;application/x-addvcard&quot;));</span>
<a href="#l75.238"></a><span id="l75.238" class="difflineplus">+    return NS_NewInputStreamChannel(</span>
<a href="#l75.239"></a><span id="l75.239" class="difflineplus">+        _retval, aURI, pipeIn.forget(), nullPrincipal,</span>
<a href="#l75.240"></a><span id="l75.240" class="difflineplus">+        nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l75.241"></a><span id="l75.241" class="difflineplus">+        nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l75.242"></a><span id="l75.242" class="difflineplus">+        NS_LITERAL_CSTRING(&quot;application/x-addvcard&quot;));</span>
<a href="#l75.243"></a><span id="l75.243">   }</span>
<a href="#l75.244"></a><span id="l75.244"> </span>
<a href="#l75.245"></a><span id="l75.245">   nsString output;</span>
<a href="#l75.246"></a><span id="l75.246">   rv = GeneratePrintOutput(addbookUrl, output);</span>
<a href="#l75.247"></a><span id="l75.247">   if (NS_FAILED(rv)) {</span>
<a href="#l75.248"></a><span id="l75.248">     output.AssignLiteral(&quot;failed to print. url=&quot;);</span>
<a href="#l75.249"></a><span id="l75.249">     nsAutoCString spec;</span>
<a href="#l75.250"></a><span id="l75.250">     rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l75.251"></a><span id="l75.251" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.252"></a><span id="l75.252" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.253"></a><span id="l75.253">     output.Append(NS_ConvertUTF8toUTF16(spec));</span>
<a href="#l75.254"></a><span id="l75.254">   }</span>
<a href="#l75.255"></a><span id="l75.255"> </span>
<a href="#l75.256"></a><span id="l75.256">   rv = GenerateXMLOutputChannel(output, addbookUrl, aURI, aLoadInfo, _retval);</span>
<a href="#l75.257"></a><span id="l75.257" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.258"></a><span id="l75.258" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.259"></a><span id="l75.259">   return NS_OK;</span>
<a href="#l75.260"></a><span id="l75.260"> }</span>
<a href="#l75.261"></a><span id="l75.261"> </span>
<a href="#l75.262"></a><span id="l75.262" class="difflineminus">-nsresult</span>
<a href="#l75.263"></a><span id="l75.263" class="difflineminus">-nsAddbookProtocolHandler::GeneratePrintOutput(nsIAddbookUrl *addbookUrl,</span>
<a href="#l75.264"></a><span id="l75.264" class="difflineminus">-                                              nsString &amp;aOutput)</span>
<a href="#l75.265"></a><span id="l75.265" class="difflineminus">-{</span>
<a href="#l75.266"></a><span id="l75.266" class="difflineplus">+nsresult nsAddbookProtocolHandler::GeneratePrintOutput(</span>
<a href="#l75.267"></a><span id="l75.267" class="difflineplus">+    nsIAddbookUrl *addbookUrl, nsString &amp;aOutput) {</span>
<a href="#l75.268"></a><span id="l75.268">   NS_ENSURE_ARG_POINTER(addbookUrl);</span>
<a href="#l75.269"></a><span id="l75.269"> </span>
<a href="#l75.270"></a><span id="l75.270">   nsAutoCString uri;</span>
<a href="#l75.271"></a><span id="l75.271">   nsresult rv = addbookUrl-&gt;GetPathQueryRef(uri);</span>
<a href="#l75.272"></a><span id="l75.272" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.273"></a><span id="l75.273" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.274"></a><span id="l75.274"> </span>
<a href="#l75.275"></a><span id="l75.275">   /* turn</span>
<a href="#l75.276"></a><span id="l75.276">    &quot;//moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l75.277"></a><span id="l75.277">    into &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l75.278"></a><span id="l75.278">   */</span>
<a href="#l75.279"></a><span id="l75.279"> </span>
<a href="#l75.280"></a><span id="l75.280">   /* step 1:</span>
<a href="#l75.281"></a><span id="l75.281">    turn &quot;//moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l75.282"></a><span id="l75.282">    into &quot;moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l75.283"></a><span id="l75.283">    */</span>
<a href="#l75.284"></a><span id="l75.284" class="difflineminus">-  if (uri[0] != '/' &amp;&amp; uri[1] != '/')</span>
<a href="#l75.285"></a><span id="l75.285" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l75.286"></a><span id="l75.286" class="difflineplus">+  if (uri[0] != '/' &amp;&amp; uri[1] != '/') return NS_ERROR_UNEXPECTED;</span>
<a href="#l75.287"></a><span id="l75.287"> </span>
<a href="#l75.288"></a><span id="l75.288" class="difflineminus">-  uri.Cut(0,2);</span>
<a href="#l75.289"></a><span id="l75.289" class="difflineplus">+  uri.Cut(0, 2);</span>
<a href="#l75.290"></a><span id="l75.290"> </span>
<a href="#l75.291"></a><span id="l75.291">   /* step 2:</span>
<a href="#l75.292"></a><span id="l75.292">    turn &quot;moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l75.293"></a><span id="l75.293">    into &quot;moz-abmdbdirectory/abook.mab&quot;</span>
<a href="#l75.294"></a><span id="l75.294">    */</span>
<a href="#l75.295"></a><span id="l75.295">   int32_t pos = uri.Find(&quot;?action=print&quot;);</span>
<a href="#l75.296"></a><span id="l75.296" class="difflineminus">-  if (pos == -1)</span>
<a href="#l75.297"></a><span id="l75.297" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l75.298"></a><span id="l75.298" class="difflineplus">+  if (pos == -1) return NS_ERROR_UNEXPECTED;</span>
<a href="#l75.299"></a><span id="l75.299"> </span>
<a href="#l75.300"></a><span id="l75.300">   uri.SetLength(pos);</span>
<a href="#l75.301"></a><span id="l75.301"> </span>
<a href="#l75.302"></a><span id="l75.302">   /* step 2:</span>
<a href="#l75.303"></a><span id="l75.303">    turn &quot;moz-abmdbdirectory/abook.mab&quot;</span>
<a href="#l75.304"></a><span id="l75.304">    into &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l75.305"></a><span id="l75.305">    */</span>
<a href="#l75.306"></a><span id="l75.306">   pos = uri.FindChar('/');</span>
<a href="#l75.307"></a><span id="l75.307" class="difflineminus">-  if (pos == -1)</span>
<a href="#l75.308"></a><span id="l75.308" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l75.309"></a><span id="l75.309" class="difflineplus">+  if (pos == -1) return NS_ERROR_UNEXPECTED;</span>
<a href="#l75.310"></a><span id="l75.310"> </span>
<a href="#l75.311"></a><span id="l75.311">   uri.Insert('/', pos);</span>
<a href="#l75.312"></a><span id="l75.312">   uri.Insert(':', pos);</span>
<a href="#l75.313"></a><span id="l75.313"> </span>
<a href="#l75.314"></a><span id="l75.314">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l75.315"></a><span id="l75.315">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.316"></a><span id="l75.316"> </span>
<a href="#l75.317"></a><span id="l75.317">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l75.318"></a><span id="l75.318" class="difflineat">@@ -249,69 +219,70 @@ nsAddbookProtocolHandler::GeneratePrintO</span>
<a href="#l75.319"></a><span id="l75.319">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.320"></a><span id="l75.320"> </span>
<a href="#l75.321"></a><span id="l75.321">   rv = BuildDirectoryXML(directory, aOutput);</span>
<a href="#l75.322"></a><span id="l75.322">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.323"></a><span id="l75.323"> </span>
<a href="#l75.324"></a><span id="l75.324">   return NS_OK;</span>
<a href="#l75.325"></a><span id="l75.325"> }</span>
<a href="#l75.326"></a><span id="l75.326"> </span>
<a href="#l75.327"></a><span id="l75.327" class="difflineminus">-nsresult</span>
<a href="#l75.328"></a><span id="l75.328" class="difflineminus">-nsAddbookProtocolHandler::BuildDirectoryXML(nsIAbDirectory *aDirectory,</span>
<a href="#l75.329"></a><span id="l75.329" class="difflineminus">-                                       nsString &amp;aOutput)</span>
<a href="#l75.330"></a><span id="l75.330" class="difflineminus">-{</span>
<a href="#l75.331"></a><span id="l75.331" class="difflineplus">+nsresult nsAddbookProtocolHandler::BuildDirectoryXML(nsIAbDirectory *aDirectory,</span>
<a href="#l75.332"></a><span id="l75.332" class="difflineplus">+                                                     nsString &amp;aOutput) {</span>
<a href="#l75.333"></a><span id="l75.333">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l75.334"></a><span id="l75.334"> </span>
<a href="#l75.335"></a><span id="l75.335">   nsresult rv;</span>
<a href="#l75.336"></a><span id="l75.336">   nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l75.337"></a><span id="l75.337">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l75.338"></a><span id="l75.338"> </span>
<a href="#l75.339"></a><span id="l75.339" class="difflineminus">-  aOutput.AppendLiteral(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a href="#l75.340"></a><span id="l75.340" class="difflineminus">-                        &quot;&lt;?xml-stylesheet type=\&quot;text/css\&quot; href=\&quot;chrome://messagebody/content/addressbook/print.css\&quot;?&gt;\n&quot;</span>
<a href="#l75.341"></a><span id="l75.341" class="difflineminus">-                        &quot;&lt;directory&gt;\n&quot;);</span>
<a href="#l75.342"></a><span id="l75.342" class="difflineplus">+  aOutput.AppendLiteral(</span>
<a href="#l75.343"></a><span id="l75.343" class="difflineplus">+      &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a href="#l75.344"></a><span id="l75.344" class="difflineplus">+      &quot;&lt;?xml-stylesheet type=\&quot;text/css\&quot; &quot;</span>
<a href="#l75.345"></a><span id="l75.345" class="difflineplus">+      &quot;href=\&quot;chrome://messagebody/content/addressbook/print.css\&quot;?&gt;\n&quot;</span>
<a href="#l75.346"></a><span id="l75.346" class="difflineplus">+      &quot;&lt;directory&gt;\n&quot;);</span>
<a href="#l75.347"></a><span id="l75.347"> </span>
<a href="#l75.348"></a><span id="l75.348">   // Get Address Book string and set it as title of XML document</span>
<a href="#l75.349"></a><span id="l75.349">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l75.350"></a><span id="l75.350">   nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l75.351"></a><span id="l75.351" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l75.352"></a><span id="l75.352" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l75.353"></a><span id="l75.353">   if (stringBundleService) {</span>
<a href="#l75.354"></a><span id="l75.354" class="difflineminus">-    rv = stringBundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l75.355"></a><span id="l75.355" class="difflineplus">+    rv = stringBundleService-&gt;CreateBundle(</span>
<a href="#l75.356"></a><span id="l75.356" class="difflineplus">+        &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l75.357"></a><span id="l75.357" class="difflineplus">+        getter_AddRefs(bundle));</span>
<a href="#l75.358"></a><span id="l75.358">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l75.359"></a><span id="l75.359">       nsString addrBook;</span>
<a href="#l75.360"></a><span id="l75.360">       rv = bundle-&gt;GetStringFromName(&quot;addressBook&quot;, addrBook);</span>
<a href="#l75.361"></a><span id="l75.361">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l75.362"></a><span id="l75.362">         aOutput.AppendLiteral(&quot;&lt;title xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;&quot;);</span>
<a href="#l75.363"></a><span id="l75.363">         aOutput.Append(addrBook);</span>
<a href="#l75.364"></a><span id="l75.364">         aOutput.AppendLiteral(&quot;&lt;/title&gt;\n&quot;);</span>
<a href="#l75.365"></a><span id="l75.365">       }</span>
<a href="#l75.366"></a><span id="l75.366">     }</span>
<a href="#l75.367"></a><span id="l75.367">   }</span>
<a href="#l75.368"></a><span id="l75.368"> </span>
<a href="#l75.369"></a><span id="l75.369" class="difflineminus">- // create a view and init it with the generated name sort order. Then, iterate</span>
<a href="#l75.370"></a><span id="l75.370" class="difflineplus">+  // create a view and init it with the generated name sort order. Then, iterate</span>
<a href="#l75.371"></a><span id="l75.371">   // over the view, getting the card for each row, and printing them.</span>
<a href="#l75.372"></a><span id="l75.372">   nsString sortColumn;</span>
<a href="#l75.373"></a><span id="l75.373" class="difflineminus">-  nsCOMPtr &lt;nsIAbView&gt; view = do_CreateInstance(&quot;@mozilla.org/addressbook/abview;1&quot;, &amp;rv);</span>
<a href="#l75.374"></a><span id="l75.374" class="difflineplus">+  nsCOMPtr&lt;nsIAbView&gt; view =</span>
<a href="#l75.375"></a><span id="l75.375" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/addressbook/abview;1&quot;, &amp;rv);</span>
<a href="#l75.376"></a><span id="l75.376"> </span>
<a href="#l75.377"></a><span id="l75.377">   view-&gt;SetView(aDirectory, nullptr, NS_LITERAL_STRING(&quot;GeneratedName&quot;),</span>
<a href="#l75.378"></a><span id="l75.378">                 NS_LITERAL_STRING(&quot;ascending&quot;), sortColumn);</span>
<a href="#l75.379"></a><span id="l75.379"> </span>
<a href="#l75.380"></a><span id="l75.380">   int32_t numRows;</span>
<a href="#l75.381"></a><span id="l75.381" class="difflineminus">-  nsCOMPtr &lt;nsITreeView&gt; treeView = do_QueryInterface(view, &amp;rv);</span>
<a href="#l75.382"></a><span id="l75.382" class="difflineplus">+  nsCOMPtr&lt;nsITreeView&gt; treeView = do_QueryInterface(view, &amp;rv);</span>
<a href="#l75.383"></a><span id="l75.383">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.384"></a><span id="l75.384">   treeView-&gt;GetRowCount(&amp;numRows);</span>
<a href="#l75.385"></a><span id="l75.385"> </span>
<a href="#l75.386"></a><span id="l75.386" class="difflineminus">-  for (int32_t row = 0; row &lt; numRows; row++)</span>
<a href="#l75.387"></a><span id="l75.387" class="difflineminus">-  {</span>
<a href="#l75.388"></a><span id="l75.388" class="difflineminus">-</span>
<a href="#l75.389"></a><span id="l75.389" class="difflineminus">-    nsCOMPtr &lt;nsIAbCard&gt; card;</span>
<a href="#l75.390"></a><span id="l75.390" class="difflineplus">+  for (int32_t row = 0; row &lt; numRows; row++) {</span>
<a href="#l75.391"></a><span id="l75.391" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l75.392"></a><span id="l75.392">     view-&gt;GetCardFromRow(row, getter_AddRefs(card));</span>
<a href="#l75.393"></a><span id="l75.393">     nsCString xmlSubstr;</span>
<a href="#l75.394"></a><span id="l75.394"> </span>
<a href="#l75.395"></a><span id="l75.395">     rv = card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;xml&quot;), xmlSubstr);</span>
<a href="#l75.396"></a><span id="l75.396" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l75.397"></a><span id="l75.397" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.398"></a><span id="l75.398"> </span>
<a href="#l75.399"></a><span id="l75.399">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l75.400"></a><span id="l75.400">     aOutput.Append(NS_ConvertUTF8toUTF16(xmlSubstr));</span>
<a href="#l75.401"></a><span id="l75.401">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l75.402"></a><span id="l75.402">   }</span>
<a href="#l75.403"></a><span id="l75.403"> </span>
<a href="#l75.404"></a><span id="l75.404">   aOutput.AppendLiteral(&quot;&lt;/directory&gt;\n&quot;);</span>
<a href="#l75.405"></a><span id="l75.405"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.h</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.h</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -8,38 +8,34 @@</span>
<a href="#l76.4"></a><span id="l76.4"> </span>
<a href="#l76.5"></a><span id="l76.5"> #include &quot;nscore.h&quot;</span>
<a href="#l76.6"></a><span id="l76.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l76.7"></a><span id="l76.7"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l76.8"></a><span id="l76.8"> #include &quot;nsIProtocolHandler.h&quot;</span>
<a href="#l76.9"></a><span id="l76.9"> #include &quot;nsIAddbookUrl.h&quot;</span>
<a href="#l76.10"></a><span id="l76.10"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l76.11"></a><span id="l76.11"> </span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-class nsAddbookProtocolHandler : public nsIProtocolHandler</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineminus">-{</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineminus">-public:</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+class nsAddbookProtocolHandler : public nsIProtocolHandler {</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineplus">+ public:</span>
<a href="#l76.17"></a><span id="l76.17">   nsAddbookProtocolHandler();</span>
<a href="#l76.18"></a><span id="l76.18"> </span>
<a href="#l76.19"></a><span id="l76.19">   NS_DECL_ISUPPORTS</span>
<a href="#l76.20"></a><span id="l76.20"> </span>
<a href="#l76.21"></a><span id="l76.21">   //////////////////////////////////////////////////////////////////////////</span>
<a href="#l76.22"></a><span id="l76.22">   // We support the nsIProtocolHandler interface.</span>
<a href="#l76.23"></a><span id="l76.23">   //////////////////////////////////////////////////////////////////////////</span>
<a href="#l76.24"></a><span id="l76.24">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l76.25"></a><span id="l76.25"> </span>
<a href="#l76.26"></a><span id="l76.26" class="difflineminus">-private:</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+ private:</span>
<a href="#l76.28"></a><span id="l76.28">   virtual ~nsAddbookProtocolHandler();</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineminus">-  nsresult    GenerateXMLOutputChannel(nsString &amp;aOutput,</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineminus">-                                         nsIAddbookUrl *addbookUrl,</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineminus">-                                         nsIURI *aURI,</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineminus">-                                         nsILoadInfo *aLoadInfo,</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineminus">-                                         nsIChannel **_retval);</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineplus">+  nsresult GenerateXMLOutputChannel(nsString &amp;aOutput,</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+                                    nsIAddbookUrl *addbookUrl, nsIURI *aURI,</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineplus">+                                    nsILoadInfo *aLoadInfo,</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineplus">+                                    nsIChannel **_retval);</span>
<a href="#l76.38"></a><span id="l76.38"> </span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-  nsresult    GeneratePrintOutput(nsIAddbookUrl *addbookUrl,</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineminus">-                                   nsString &amp;aOutput);</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+  nsresult GeneratePrintOutput(nsIAddbookUrl *addbookUrl, nsString &amp;aOutput);</span>
<a href="#l76.42"></a><span id="l76.42"> </span>
<a href="#l76.43"></a><span id="l76.43" class="difflineminus">-  nsresult    BuildDirectoryXML(nsIAbDirectory *aDirectory,</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineminus">-                                   nsString &amp;aOutput);</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineplus">+  nsresult BuildDirectoryXML(nsIAbDirectory *aDirectory, nsString &amp;aOutput);</span>
<a href="#l76.46"></a><span id="l76.46"> </span>
<a href="#l76.47"></a><span id="l76.47" class="difflineminus">-  int32_t     mAddbookOperation;</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineplus">+  int32_t mAddbookOperation;</span>
<a href="#l76.49"></a><span id="l76.49"> };</span>
<a href="#l76.50"></a><span id="l76.50"> </span>
<a href="#l76.51"></a><span id="l76.51"> #endif /* nsAddbookProtocolHandler_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookUrl.cpp</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookUrl.cpp</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -10,309 +10,259 @@</span>
<a href="#l77.4"></a><span id="l77.4"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l77.5"></a><span id="l77.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l77.6"></a><span id="l77.6"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l77.7"></a><span id="l77.7"> #include &quot;mozilla/Encoding.h&quot;</span>
<a href="#l77.8"></a><span id="l77.8"> </span>
<a href="#l77.9"></a><span id="l77.9"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l77.10"></a><span id="l77.10"> // addbook url definition</span>
<a href="#l77.11"></a><span id="l77.11"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-nsAddbookUrl::nsAddbookUrl()</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-{</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+nsAddbookUrl::nsAddbookUrl() {</span>
<a href="#l77.15"></a><span id="l77.15">   mOperationType = nsIAddbookUrlOperation::InvalidUrl;</span>
<a href="#l77.16"></a><span id="l77.16"> }</span>
<a href="#l77.17"></a><span id="l77.17"> </span>
<a href="#l77.18"></a><span id="l77.18" class="difflineminus">-nsAddbookUrl::~nsAddbookUrl()</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineminus">-{</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineminus">-}</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineplus">+nsAddbookUrl::~nsAddbookUrl() {}</span>
<a href="#l77.22"></a><span id="l77.22"> </span>
<a href="#l77.23"></a><span id="l77.23"> NS_IMPL_ISUPPORTS(nsAddbookUrl, nsIAddbookUrl, nsIURI)</span>
<a href="#l77.24"></a><span id="l77.24"> </span>
<a href="#l77.25"></a><span id="l77.25" class="difflineminus">-nsresult</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineminus">-nsAddbookUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineminus">-{</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineminus">-  nsresult rv = NS_MutateURI(NS_SIMPLEURIMUTATOR_CONTRACTID).SetSpec(aSpec).Finalize(m_baseURL);</span>
<a href="#l77.29"></a><span id="l77.29" class="difflineplus">+nsresult nsAddbookUrl::SetSpecInternal(const nsACString &amp;aSpec) {</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineplus">+  nsresult rv = NS_MutateURI(NS_SIMPLEURIMUTATOR_CONTRACTID)</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineplus">+                    .SetSpec(aSpec)</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+                    .Finalize(m_baseURL);</span>
<a href="#l77.33"></a><span id="l77.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.34"></a><span id="l77.34">   return ParseUrl();</span>
<a href="#l77.35"></a><span id="l77.35"> }</span>
<a href="#l77.36"></a><span id="l77.36"> </span>
<a href="#l77.37"></a><span id="l77.37" class="difflineminus">-nsresult nsAddbookUrl::ParseUrl()</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineminus">-{</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineplus">+nsresult nsAddbookUrl::ParseUrl() {</span>
<a href="#l77.40"></a><span id="l77.40">   nsAutoCString pathStr;</span>
<a href="#l77.41"></a><span id="l77.41"> </span>
<a href="#l77.42"></a><span id="l77.42">   nsresult rv = m_baseURL-&gt;GetPathQueryRef(pathStr);</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l77.44"></a><span id="l77.44" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.45"></a><span id="l77.45"> </span>
<a href="#l77.46"></a><span id="l77.46">   if (strstr(pathStr.get(), &quot;?action=print&quot;))</span>
<a href="#l77.47"></a><span id="l77.47">     mOperationType = nsIAddbookUrlOperation::PrintAddressBook;</span>
<a href="#l77.48"></a><span id="l77.48">   else if (strstr(pathStr.get(), &quot;?action=add&quot;))</span>
<a href="#l77.49"></a><span id="l77.49">     mOperationType = nsIAddbookUrlOperation::AddVCard;</span>
<a href="#l77.50"></a><span id="l77.50">   else</span>
<a href="#l77.51"></a><span id="l77.51">     mOperationType = nsIAddbookUrlOperation::InvalidUrl;</span>
<a href="#l77.52"></a><span id="l77.52">   return NS_OK;</span>
<a href="#l77.53"></a><span id="l77.53"> }</span>
<a href="#l77.54"></a><span id="l77.54"> </span>
<a href="#l77.55"></a><span id="l77.55"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l77.56"></a><span id="l77.56"> // Begin nsIURI support</span>
<a href="#l77.57"></a><span id="l77.57"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l77.58"></a><span id="l77.58"> </span>
<a href="#l77.59"></a><span id="l77.59" class="difflineminus">-</span>
<a href="#l77.60"></a><span id="l77.60" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetSpec(nsACString &amp;aSpec)</span>
<a href="#l77.61"></a><span id="l77.61" class="difflineminus">-{</span>
<a href="#l77.62"></a><span id="l77.62" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetSpec(nsACString &amp;aSpec) {</span>
<a href="#l77.63"></a><span id="l77.63">   return m_baseURL-&gt;GetSpec(aSpec);</span>
<a href="#l77.64"></a><span id="l77.64"> }</span>
<a href="#l77.65"></a><span id="l77.65"> </span>
<a href="#l77.66"></a><span id="l77.66" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetPrePath(nsACString &amp;aPrePath)</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineminus">-{</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetPrePath(nsACString &amp;aPrePath) {</span>
<a href="#l77.69"></a><span id="l77.69">   return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l77.70"></a><span id="l77.70"> }</span>
<a href="#l77.71"></a><span id="l77.71"> </span>
<a href="#l77.72"></a><span id="l77.72" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineminus">-{</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l77.75"></a><span id="l77.75">   return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l77.76"></a><span id="l77.76"> }</span>
<a href="#l77.77"></a><span id="l77.77"> </span>
<a href="#l77.78"></a><span id="l77.78" class="difflineminus">-nsresult nsAddbookUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineminus">-{</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineplus">+nsresult nsAddbookUrl::SetScheme(const nsACString &amp;aScheme) {</span>
<a href="#l77.81"></a><span id="l77.81">   return NS_MutateURI(m_baseURL).SetScheme(aScheme).Finalize(m_baseURL);</span>
<a href="#l77.82"></a><span id="l77.82"> }</span>
<a href="#l77.83"></a><span id="l77.83"> </span>
<a href="#l77.84"></a><span id="l77.84" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetUserPass(nsACString &amp;aUserPass)</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineminus">-{</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetUserPass(nsACString &amp;aUserPass) {</span>
<a href="#l77.87"></a><span id="l77.87">   return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l77.88"></a><span id="l77.88"> }</span>
<a href="#l77.89"></a><span id="l77.89"> </span>
<a href="#l77.90"></a><span id="l77.90" class="difflineminus">-nsresult nsAddbookUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l77.91"></a><span id="l77.91" class="difflineminus">-{</span>
<a href="#l77.92"></a><span id="l77.92" class="difflineplus">+nsresult nsAddbookUrl::SetUserPass(const nsACString &amp;aUserPass) {</span>
<a href="#l77.93"></a><span id="l77.93">   return NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l77.94"></a><span id="l77.94"> }</span>
<a href="#l77.95"></a><span id="l77.95"> </span>
<a href="#l77.96"></a><span id="l77.96" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l77.97"></a><span id="l77.97" class="difflineminus">-{</span>
<a href="#l77.98"></a><span id="l77.98" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetUsername(nsACString &amp;aUsername) {</span>
<a href="#l77.99"></a><span id="l77.99">   return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l77.100"></a><span id="l77.100"> }</span>
<a href="#l77.101"></a><span id="l77.101"> </span>
<a href="#l77.102"></a><span id="l77.102" class="difflineminus">-nsresult nsAddbookUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l77.103"></a><span id="l77.103" class="difflineminus">-{</span>
<a href="#l77.104"></a><span id="l77.104" class="difflineplus">+nsresult nsAddbookUrl::SetUsername(const nsACString &amp;aUsername) {</span>
<a href="#l77.105"></a><span id="l77.105">   return NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l77.106"></a><span id="l77.106"> }</span>
<a href="#l77.107"></a><span id="l77.107"> </span>
<a href="#l77.108"></a><span id="l77.108" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetPassword(nsACString &amp;aPassword)</span>
<a href="#l77.109"></a><span id="l77.109" class="difflineminus">-{</span>
<a href="#l77.110"></a><span id="l77.110" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetPassword(nsACString &amp;aPassword) {</span>
<a href="#l77.111"></a><span id="l77.111">   return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l77.112"></a><span id="l77.112"> }</span>
<a href="#l77.113"></a><span id="l77.113"> </span>
<a href="#l77.114"></a><span id="l77.114" class="difflineminus">-nsresult nsAddbookUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineminus">-{</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineplus">+nsresult nsAddbookUrl::SetPassword(const nsACString &amp;aPassword) {</span>
<a href="#l77.117"></a><span id="l77.117">   return NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l77.118"></a><span id="l77.118"> }</span>
<a href="#l77.119"></a><span id="l77.119"> </span>
<a href="#l77.120"></a><span id="l77.120" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetHostPort(nsACString &amp;aHostPort)</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineminus">-{</span>
<a href="#l77.122"></a><span id="l77.122" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetHostPort(nsACString &amp;aHostPort) {</span>
<a href="#l77.123"></a><span id="l77.123">   return m_baseURL-&gt;GetHostPort(aHostPort);</span>
<a href="#l77.124"></a><span id="l77.124"> }</span>
<a href="#l77.125"></a><span id="l77.125"> </span>
<a href="#l77.126"></a><span id="l77.126" class="difflineminus">-nsresult nsAddbookUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineminus">-{</span>
<a href="#l77.128"></a><span id="l77.128" class="difflineplus">+nsresult nsAddbookUrl::SetHostPort(const nsACString &amp;aHostPort) {</span>
<a href="#l77.129"></a><span id="l77.129">   return NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l77.130"></a><span id="l77.130"> }</span>
<a href="#l77.131"></a><span id="l77.131"> </span>
<a href="#l77.132"></a><span id="l77.132" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetHost(nsACString &amp;aHost)</span>
<a href="#l77.133"></a><span id="l77.133" class="difflineminus">-{</span>
<a href="#l77.134"></a><span id="l77.134" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetHost(nsACString &amp;aHost) {</span>
<a href="#l77.135"></a><span id="l77.135">   return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l77.136"></a><span id="l77.136"> }</span>
<a href="#l77.137"></a><span id="l77.137"> </span>
<a href="#l77.138"></a><span id="l77.138" class="difflineminus">-nsresult nsAddbookUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l77.139"></a><span id="l77.139" class="difflineminus">-{</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineplus">+nsresult nsAddbookUrl::SetHost(const nsACString &amp;aHost) {</span>
<a href="#l77.141"></a><span id="l77.141">   return NS_MutateURI(m_baseURL).SetHost(aHost).Finalize(m_baseURL);</span>
<a href="#l77.142"></a><span id="l77.142"> }</span>
<a href="#l77.143"></a><span id="l77.143"> </span>
<a href="#l77.144"></a><span id="l77.144" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetPort(int32_t *aPort)</span>
<a href="#l77.145"></a><span id="l77.145" class="difflineminus">-{</span>
<a href="#l77.146"></a><span id="l77.146" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetPort(int32_t *aPort) {</span>
<a href="#l77.147"></a><span id="l77.147">   return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l77.148"></a><span id="l77.148"> }</span>
<a href="#l77.149"></a><span id="l77.149"> </span>
<a href="#l77.150"></a><span id="l77.150" class="difflineminus">-nsresult nsAddbookUrl::SetPort(int32_t aPort)</span>
<a href="#l77.151"></a><span id="l77.151" class="difflineminus">-{</span>
<a href="#l77.152"></a><span id="l77.152" class="difflineplus">+nsresult nsAddbookUrl::SetPort(int32_t aPort) {</span>
<a href="#l77.153"></a><span id="l77.153">   return NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l77.154"></a><span id="l77.154"> }</span>
<a href="#l77.155"></a><span id="l77.155"> </span>
<a href="#l77.156"></a><span id="l77.156" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetPathQueryRef(nsACString &amp;aPath)</span>
<a href="#l77.157"></a><span id="l77.157" class="difflineminus">-{</span>
<a href="#l77.158"></a><span id="l77.158" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetPathQueryRef(nsACString &amp;aPath) {</span>
<a href="#l77.159"></a><span id="l77.159">   return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l77.160"></a><span id="l77.160"> }</span>
<a href="#l77.161"></a><span id="l77.161"> </span>
<a href="#l77.162"></a><span id="l77.162" class="difflineminus">-nsresult nsAddbookUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l77.163"></a><span id="l77.163" class="difflineminus">-{</span>
<a href="#l77.164"></a><span id="l77.164" class="difflineminus">-  nsresult rv = NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l77.165"></a><span id="l77.165" class="difflineplus">+nsresult nsAddbookUrl::SetPathQueryRef(const nsACString &amp;aPath) {</span>
<a href="#l77.166"></a><span id="l77.166" class="difflineplus">+  nsresult rv =</span>
<a href="#l77.167"></a><span id="l77.167" class="difflineplus">+      NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l77.168"></a><span id="l77.168">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.169"></a><span id="l77.169">   return ParseUrl();</span>
<a href="#l77.170"></a><span id="l77.170"> }</span>
<a href="#l77.171"></a><span id="l77.171"> </span>
<a href="#l77.172"></a><span id="l77.172" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetAsciiHost(nsACString &amp;aHostA)</span>
<a href="#l77.173"></a><span id="l77.173" class="difflineminus">-{</span>
<a href="#l77.174"></a><span id="l77.174" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetAsciiHost(nsACString &amp;aHostA) {</span>
<a href="#l77.175"></a><span id="l77.175">   return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l77.176"></a><span id="l77.176"> }</span>
<a href="#l77.177"></a><span id="l77.177"> </span>
<a href="#l77.178"></a><span id="l77.178" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetAsciiHostPort(nsACString &amp;aHostPortA)</span>
<a href="#l77.179"></a><span id="l77.179" class="difflineminus">-{</span>
<a href="#l77.180"></a><span id="l77.180" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetAsciiHostPort(nsACString &amp;aHostPortA) {</span>
<a href="#l77.181"></a><span id="l77.181">   return m_baseURL-&gt;GetAsciiHostPort(aHostPortA);</span>
<a href="#l77.182"></a><span id="l77.182"> }</span>
<a href="#l77.183"></a><span id="l77.183"> </span>
<a href="#l77.184"></a><span id="l77.184" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::GetAsciiSpec(nsACString &amp;aSpecA)</span>
<a href="#l77.185"></a><span id="l77.185" class="difflineminus">-{</span>
<a href="#l77.186"></a><span id="l77.186" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::GetAsciiSpec(nsACString &amp;aSpecA) {</span>
<a href="#l77.187"></a><span id="l77.187">   return m_baseURL-&gt;GetAsciiSpec(aSpecA);</span>
<a href="#l77.188"></a><span id="l77.188"> }</span>
<a href="#l77.189"></a><span id="l77.189"> </span>
<a href="#l77.190"></a><span id="l77.190" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::SchemeIs(const char *aScheme, bool *_retval)</span>
<a href="#l77.191"></a><span id="l77.191" class="difflineminus">-{</span>
<a href="#l77.192"></a><span id="l77.192" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::SchemeIs(const char *aScheme, bool *_retval) {</span>
<a href="#l77.193"></a><span id="l77.193">   return m_baseURL-&gt;SchemeIs(aScheme, _retval);</span>
<a href="#l77.194"></a><span id="l77.194"> }</span>
<a href="#l77.195"></a><span id="l77.195"> </span>
<a href="#l77.196"></a><span id="l77.196" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::Equals(nsIURI *other, bool *_retval)</span>
<a href="#l77.197"></a><span id="l77.197" class="difflineminus">-{</span>
<a href="#l77.198"></a><span id="l77.198" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::Equals(nsIURI *other, bool *_retval) {</span>
<a href="#l77.199"></a><span id="l77.199">   // The passed-in URI might be an nsMailtoUrl. Pass our inner URL to its</span>
<a href="#l77.200"></a><span id="l77.200">   // Equals method. The other nsMailtoUrl will then pass its inner URL to</span>
<a href="#l77.201"></a><span id="l77.201">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l77.202"></a><span id="l77.202" class="difflineminus">-  if (other)</span>
<a href="#l77.203"></a><span id="l77.203" class="difflineminus">-    return other-&gt;Equals(m_baseURL, _retval);</span>
<a href="#l77.204"></a><span id="l77.204" class="difflineplus">+  if (other) return other-&gt;Equals(m_baseURL, _retval);</span>
<a href="#l77.205"></a><span id="l77.205"> </span>
<a href="#l77.206"></a><span id="l77.206">   return m_baseURL-&gt;Equals(other, _retval);</span>
<a href="#l77.207"></a><span id="l77.207"> }</span>
<a href="#l77.208"></a><span id="l77.208"> </span>
<a href="#l77.209"></a><span id="l77.209" class="difflineminus">-nsresult</span>
<a href="#l77.210"></a><span id="l77.210" class="difflineminus">-nsAddbookUrl::Clone(nsIURI** _retval)</span>
<a href="#l77.211"></a><span id="l77.211" class="difflineminus">-{</span>
<a href="#l77.212"></a><span id="l77.212" class="difflineplus">+nsresult nsAddbookUrl::Clone(nsIURI **_retval) {</span>
<a href="#l77.213"></a><span id="l77.213">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l77.214"></a><span id="l77.214"> </span>
<a href="#l77.215"></a><span id="l77.215">   RefPtr&lt;nsAddbookUrl&gt; clone = new nsAddbookUrl();</span>
<a href="#l77.216"></a><span id="l77.216"> </span>
<a href="#l77.217"></a><span id="l77.217" class="difflineminus">-  if (!clone)</span>
<a href="#l77.218"></a><span id="l77.218" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l77.219"></a><span id="l77.219" class="difflineplus">+  if (!clone) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l77.220"></a><span id="l77.220"> </span>
<a href="#l77.221"></a><span id="l77.221">   nsresult rv = NS_MutateURI(m_baseURL).Finalize(clone-&gt;m_baseURL);</span>
<a href="#l77.222"></a><span id="l77.222">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.223"></a><span id="l77.223">   clone-&gt;ParseUrl();</span>
<a href="#l77.224"></a><span id="l77.224">   clone.forget(_retval);</span>
<a href="#l77.225"></a><span id="l77.225">   return NS_OK;</span>
<a href="#l77.226"></a><span id="l77.226"> }</span>
<a href="#l77.227"></a><span id="l77.227"> </span>
<a href="#l77.228"></a><span id="l77.228" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::Resolve(const nsACString &amp;relativePath, nsACString &amp;result)</span>
<a href="#l77.229"></a><span id="l77.229" class="difflineminus">-{</span>
<a href="#l77.230"></a><span id="l77.230" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::Resolve(const nsACString &amp;relativePath,</span>
<a href="#l77.231"></a><span id="l77.231" class="difflineplus">+                                    nsACString &amp;result) {</span>
<a href="#l77.232"></a><span id="l77.232">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l77.233"></a><span id="l77.233"> }</span>
<a href="#l77.234"></a><span id="l77.234"> </span>
<a href="#l77.235"></a><span id="l77.235"> NS_IMETHODIMP</span>
<a href="#l77.236"></a><span id="l77.236" class="difflineminus">-nsAddbookUrl::GetRef(nsACString &amp;result)</span>
<a href="#l77.237"></a><span id="l77.237" class="difflineminus">-{</span>
<a href="#l77.238"></a><span id="l77.238" class="difflineminus">-  return m_baseURL-&gt;GetRef(result);</span>
<a href="#l77.239"></a><span id="l77.239" class="difflineminus">-}</span>
<a href="#l77.240"></a><span id="l77.240" class="difflineplus">+nsAddbookUrl::GetRef(nsACString &amp;result) { return m_baseURL-&gt;GetRef(result); }</span>
<a href="#l77.241"></a><span id="l77.241"> </span>
<a href="#l77.242"></a><span id="l77.242" class="difflineminus">-nsresult nsAddbookUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l77.243"></a><span id="l77.243" class="difflineminus">-{</span>
<a href="#l77.244"></a><span id="l77.244" class="difflineplus">+nsresult nsAddbookUrl::SetRef(const nsACString &amp;aRef) {</span>
<a href="#l77.245"></a><span id="l77.245">   nsresult rv = NS_MutateURI(m_baseURL).SetRef(aRef).Finalize(m_baseURL);</span>
<a href="#l77.246"></a><span id="l77.246">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.247"></a><span id="l77.247">   return ParseUrl();</span>
<a href="#l77.248"></a><span id="l77.248"> }</span>
<a href="#l77.249"></a><span id="l77.249"> </span>
<a href="#l77.250"></a><span id="l77.250"> NS_IMETHODIMP</span>
<a href="#l77.251"></a><span id="l77.251" class="difflineminus">-nsAddbookUrl::GetFilePath(nsACString &amp;aFilePath)</span>
<a href="#l77.252"></a><span id="l77.252" class="difflineminus">-{</span>
<a href="#l77.253"></a><span id="l77.253" class="difflineplus">+nsAddbookUrl::GetFilePath(nsACString &amp;aFilePath) {</span>
<a href="#l77.254"></a><span id="l77.254">   return m_baseURL-&gt;GetFilePath(aFilePath);</span>
<a href="#l77.255"></a><span id="l77.255"> }</span>
<a href="#l77.256"></a><span id="l77.256"> </span>
<a href="#l77.257"></a><span id="l77.257" class="difflineminus">-nsresult nsAddbookUrl::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l77.258"></a><span id="l77.258" class="difflineminus">-{</span>
<a href="#l77.259"></a><span id="l77.259" class="difflineplus">+nsresult nsAddbookUrl::SetFilePath(const nsACString &amp;aFilePath) {</span>
<a href="#l77.260"></a><span id="l77.260">   return NS_MutateURI(m_baseURL).SetFilePath(aFilePath).Finalize(m_baseURL);</span>
<a href="#l77.261"></a><span id="l77.261"> }</span>
<a href="#l77.262"></a><span id="l77.262"> </span>
<a href="#l77.263"></a><span id="l77.263"> NS_IMETHODIMP</span>
<a href="#l77.264"></a><span id="l77.264" class="difflineminus">-nsAddbookUrl::GetQuery(nsACString &amp;aQuery)</span>
<a href="#l77.265"></a><span id="l77.265" class="difflineminus">-{</span>
<a href="#l77.266"></a><span id="l77.266" class="difflineplus">+nsAddbookUrl::GetQuery(nsACString &amp;aQuery) {</span>
<a href="#l77.267"></a><span id="l77.267">   return m_baseURL-&gt;GetQuery(aQuery);</span>
<a href="#l77.268"></a><span id="l77.268"> }</span>
<a href="#l77.269"></a><span id="l77.269"> </span>
<a href="#l77.270"></a><span id="l77.270" class="difflineminus">-nsresult nsAddbookUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l77.271"></a><span id="l77.271" class="difflineminus">-{</span>
<a href="#l77.272"></a><span id="l77.272" class="difflineplus">+nsresult nsAddbookUrl::SetQuery(const nsACString &amp;aQuery) {</span>
<a href="#l77.273"></a><span id="l77.273">   return NS_MutateURI(m_baseURL).SetQuery(aQuery).Finalize(m_baseURL);</span>
<a href="#l77.274"></a><span id="l77.274"> }</span>
<a href="#l77.275"></a><span id="l77.275"> </span>
<a href="#l77.276"></a><span id="l77.276" class="difflineminus">-nsresult nsAddbookUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l77.277"></a><span id="l77.277" class="difflineminus">-{</span>
<a href="#l77.278"></a><span id="l77.278" class="difflineminus">-  return NS_MutateURI(m_baseURL).SetQueryWithEncoding(aQuery, aEncoding).Finalize(m_baseURL);</span>
<a href="#l77.279"></a><span id="l77.279" class="difflineplus">+nsresult nsAddbookUrl::SetQueryWithEncoding(</span>
<a href="#l77.280"></a><span id="l77.280" class="difflineplus">+    const nsACString &amp;aQuery, const mozilla::Encoding *aEncoding) {</span>
<a href="#l77.281"></a><span id="l77.281" class="difflineplus">+  return NS_MutateURI(m_baseURL)</span>
<a href="#l77.282"></a><span id="l77.282" class="difflineplus">+      .SetQueryWithEncoding(aQuery, aEncoding)</span>
<a href="#l77.283"></a><span id="l77.283" class="difflineplus">+      .Finalize(m_baseURL);</span>
<a href="#l77.284"></a><span id="l77.284"> }</span>
<a href="#l77.285"></a><span id="l77.285"> </span>
<a href="#l77.286"></a><span id="l77.286"> NS_IMETHODIMP_(void)</span>
<a href="#l77.287"></a><span id="l77.287" class="difflineminus">-nsAddbookUrl::Serialize(mozilla::ipc::URIParams &amp;aParams)</span>
<a href="#l77.288"></a><span id="l77.288" class="difflineminus">-{</span>
<a href="#l77.289"></a><span id="l77.289" class="difflineplus">+nsAddbookUrl::Serialize(mozilla::ipc::URIParams &amp;aParams) {</span>
<a href="#l77.290"></a><span id="l77.290">   m_baseURL-&gt;Serialize(aParams);</span>
<a href="#l77.291"></a><span id="l77.291"> }</span>
<a href="#l77.292"></a><span id="l77.292"> </span>
<a href="#l77.293"></a><span id="l77.293" class="difflineminus">-NS_IMETHODIMP nsAddbookUrl::EqualsExceptRef(nsIURI *other, bool *_retval)</span>
<a href="#l77.294"></a><span id="l77.294" class="difflineminus">-{</span>
<a href="#l77.295"></a><span id="l77.295" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::EqualsExceptRef(nsIURI *other, bool *_retval) {</span>
<a href="#l77.296"></a><span id="l77.296">   // The passed-in URI might be an nsMailtoUrl. Pass our inner URL to its</span>
<a href="#l77.297"></a><span id="l77.297">   // Equals method. The other nsMailtoUrl will then pass its inner URL to</span>
<a href="#l77.298"></a><span id="l77.298">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l77.299"></a><span id="l77.299" class="difflineminus">-  if (other)</span>
<a href="#l77.300"></a><span id="l77.300" class="difflineminus">-    return other-&gt;EqualsExceptRef(m_baseURL, _retval);</span>
<a href="#l77.301"></a><span id="l77.301" class="difflineplus">+  if (other) return other-&gt;EqualsExceptRef(m_baseURL, _retval);</span>
<a href="#l77.302"></a><span id="l77.302"> </span>
<a href="#l77.303"></a><span id="l77.303">   return m_baseURL-&gt;EqualsExceptRef(other, _retval);</span>
<a href="#l77.304"></a><span id="l77.304"> }</span>
<a href="#l77.305"></a><span id="l77.305"> </span>
<a href="#l77.306"></a><span id="l77.306"> NS_IMETHODIMP</span>
<a href="#l77.307"></a><span id="l77.307" class="difflineminus">-nsAddbookUrl::GetSpecIgnoringRef(nsACString &amp;result)</span>
<a href="#l77.308"></a><span id="l77.308" class="difflineminus">-{</span>
<a href="#l77.309"></a><span id="l77.309" class="difflineplus">+nsAddbookUrl::GetSpecIgnoringRef(nsACString &amp;result) {</span>
<a href="#l77.310"></a><span id="l77.310">   return m_baseURL-&gt;GetSpecIgnoringRef(result);</span>
<a href="#l77.311"></a><span id="l77.311"> }</span>
<a href="#l77.312"></a><span id="l77.312"> </span>
<a href="#l77.313"></a><span id="l77.313"> NS_IMETHODIMP</span>
<a href="#l77.314"></a><span id="l77.314" class="difflineminus">-nsAddbookUrl::GetDisplaySpec(nsACString&amp; aUnicodeSpec)</span>
<a href="#l77.315"></a><span id="l77.315" class="difflineminus">-{</span>
<a href="#l77.316"></a><span id="l77.316" class="difflineplus">+nsAddbookUrl::GetDisplaySpec(nsACString &amp;aUnicodeSpec) {</span>
<a href="#l77.317"></a><span id="l77.317">   return GetSpec(aUnicodeSpec);</span>
<a href="#l77.318"></a><span id="l77.318"> }</span>
<a href="#l77.319"></a><span id="l77.319"> </span>
<a href="#l77.320"></a><span id="l77.320"> NS_IMETHODIMP</span>
<a href="#l77.321"></a><span id="l77.321" class="difflineminus">-nsAddbookUrl::GetDisplayHostPort(nsACString&amp; aUnicodeHostPort)</span>
<a href="#l77.322"></a><span id="l77.322" class="difflineminus">-{</span>
<a href="#l77.323"></a><span id="l77.323" class="difflineplus">+nsAddbookUrl::GetDisplayHostPort(nsACString &amp;aUnicodeHostPort) {</span>
<a href="#l77.324"></a><span id="l77.324">   return GetHostPort(aUnicodeHostPort);</span>
<a href="#l77.325"></a><span id="l77.325"> }</span>
<a href="#l77.326"></a><span id="l77.326"> </span>
<a href="#l77.327"></a><span id="l77.327"> NS_IMETHODIMP</span>
<a href="#l77.328"></a><span id="l77.328" class="difflineminus">-nsAddbookUrl::GetDisplayHost(nsACString&amp; aUnicodeHost)</span>
<a href="#l77.329"></a><span id="l77.329" class="difflineminus">-{</span>
<a href="#l77.330"></a><span id="l77.330" class="difflineplus">+nsAddbookUrl::GetDisplayHost(nsACString &amp;aUnicodeHost) {</span>
<a href="#l77.331"></a><span id="l77.331">   return GetHost(aUnicodeHost);</span>
<a href="#l77.332"></a><span id="l77.332"> }</span>
<a href="#l77.333"></a><span id="l77.333"> </span>
<a href="#l77.334"></a><span id="l77.334"> NS_IMETHODIMP</span>
<a href="#l77.335"></a><span id="l77.335" class="difflineminus">-nsAddbookUrl::GetDisplayPrePath(nsACString&amp; aPrePath)</span>
<a href="#l77.336"></a><span id="l77.336" class="difflineminus">-{</span>
<a href="#l77.337"></a><span id="l77.337" class="difflineplus">+nsAddbookUrl::GetDisplayPrePath(nsACString &amp;aPrePath) {</span>
<a href="#l77.338"></a><span id="l77.338">   return GetPrePath(aPrePath);</span>
<a href="#l77.339"></a><span id="l77.339"> }</span>
<a href="#l77.340"></a><span id="l77.340"> </span>
<a href="#l77.341"></a><span id="l77.341"> NS_IMETHODIMP</span>
<a href="#l77.342"></a><span id="l77.342" class="difflineminus">-nsAddbookUrl::GetHasRef(bool *result)</span>
<a href="#l77.343"></a><span id="l77.343" class="difflineminus">-{</span>
<a href="#l77.344"></a><span id="l77.344" class="difflineminus">-  return m_baseURL-&gt;GetHasRef(result);</span>
<a href="#l77.345"></a><span id="l77.345" class="difflineminus">-}</span>
<a href="#l77.346"></a><span id="l77.346" class="difflineplus">+nsAddbookUrl::GetHasRef(bool *result) { return m_baseURL-&gt;GetHasRef(result); }</span>
<a href="#l77.347"></a><span id="l77.347"> </span>
<a href="#l77.348"></a><span id="l77.348"> //</span>
<a href="#l77.349"></a><span id="l77.349"> // Specific nsAddbookUrl operations</span>
<a href="#l77.350"></a><span id="l77.350"> //</span>
<a href="#l77.351"></a><span id="l77.351"> NS_IMETHODIMP</span>
<a href="#l77.352"></a><span id="l77.352" class="difflineminus">-nsAddbookUrl::GetAddbookOperation(int32_t *_retval)</span>
<a href="#l77.353"></a><span id="l77.353" class="difflineminus">-{</span>
<a href="#l77.354"></a><span id="l77.354" class="difflineplus">+nsAddbookUrl::GetAddbookOperation(int32_t *_retval) {</span>
<a href="#l77.355"></a><span id="l77.355">   *_retval = mOperationType;</span>
<a href="#l77.356"></a><span id="l77.356">   return NS_OK;</span>
<a href="#l77.357"></a><span id="l77.357"> }</span>
<a href="#l77.358"></a><span id="l77.358"> </span>
<a href="#l77.359"></a><span id="l77.359"> NS_IMPL_ISUPPORTS(nsAddbookUrl::Mutator, nsIURISetters, nsIURIMutator)</span>
<a href="#l77.360"></a><span id="l77.360"> </span>
<a href="#l77.361"></a><span id="l77.361"> NS_IMETHODIMP</span>
<a href="#l77.362"></a><span id="l77.362" class="difflineminus">-nsAddbookUrl::Mutate(nsIURIMutator** aMutator)</span>
<a href="#l77.363"></a><span id="l77.363" class="difflineminus">-{</span>
<a href="#l77.364"></a><span id="l77.364" class="difflineplus">+nsAddbookUrl::Mutate(nsIURIMutator **aMutator) {</span>
<a href="#l77.365"></a><span id="l77.365">   RefPtr&lt;nsAddbookUrl::Mutator&gt; mutator = new nsAddbookUrl::Mutator();</span>
<a href="#l77.366"></a><span id="l77.366">   nsresult rv = mutator-&gt;InitFromURI(this);</span>
<a href="#l77.367"></a><span id="l77.367">   if (NS_FAILED(rv)) {</span>
<a href="#l77.368"></a><span id="l77.368">     return rv;</span>
<a href="#l77.369"></a><span id="l77.369">   }</span>
<a href="#l77.370"></a><span id="l77.370">   mutator.forget(aMutator);</span>
<a href="#l77.371"></a><span id="l77.371">   return NS_OK;</span>
<a href="#l77.372"></a><span id="l77.372"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookUrl.h</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookUrl.h</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -6,77 +6,72 @@</span>
<a href="#l78.4"></a><span id="l78.4"> #ifndef nsAddbookUrl_h__</span>
<a href="#l78.5"></a><span id="l78.5"> #define nsAddbookUrl_h__</span>
<a href="#l78.6"></a><span id="l78.6"> </span>
<a href="#l78.7"></a><span id="l78.7"> #include &quot;nsIURI.h&quot;</span>
<a href="#l78.8"></a><span id="l78.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l78.9"></a><span id="l78.9"> #include &quot;nsIAddbookUrl.h&quot;</span>
<a href="#l78.10"></a><span id="l78.10"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-class nsAddbookUrl : public nsIAddbookUrl</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-{</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineminus">-public:</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineminus">-    NS_DECL_NSIURI</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-    NS_DECL_NSIADDBOOKURL</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+class nsAddbookUrl : public nsIAddbookUrl {</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+ public:</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineplus">+  NS_DECL_NSIURI</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineplus">+  NS_DECL_NSIADDBOOKURL</span>
<a href="#l78.23"></a><span id="l78.23"> </span>
<a href="#l78.24"></a><span id="l78.24" class="difflineminus">-    nsAddbookUrl();</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineplus">+  nsAddbookUrl();</span>
<a href="#l78.26"></a><span id="l78.26"> </span>
<a href="#l78.27"></a><span id="l78.27" class="difflineminus">-protected:</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+ protected:</span>
<a href="#l78.29"></a><span id="l78.29">   virtual nsresult Clone(nsIURI **_retval);</span>
<a href="#l78.30"></a><span id="l78.30">   virtual nsresult SetSpecInternal(const nsACString &amp;aSpec);</span>
<a href="#l78.31"></a><span id="l78.31">   virtual nsresult SetScheme(const nsACString &amp;aScheme);</span>
<a href="#l78.32"></a><span id="l78.32">   virtual nsresult SetUserPass(const nsACString &amp;aUserPass);</span>
<a href="#l78.33"></a><span id="l78.33">   virtual nsresult SetUsername(const nsACString &amp;aUsername);</span>
<a href="#l78.34"></a><span id="l78.34">   virtual nsresult SetPassword(const nsACString &amp;aPassword);</span>
<a href="#l78.35"></a><span id="l78.35">   virtual nsresult SetHostPort(const nsACString &amp;aHostPort);</span>
<a href="#l78.36"></a><span id="l78.36">   virtual nsresult SetHost(const nsACString &amp;aHost);</span>
<a href="#l78.37"></a><span id="l78.37">   virtual nsresult SetPort(int32_t aPort);</span>
<a href="#l78.38"></a><span id="l78.38">   virtual nsresult SetPathQueryRef(const nsACString &amp;aPath);</span>
<a href="#l78.39"></a><span id="l78.39">   virtual nsresult SetRef(const nsACString &amp;aRef);</span>
<a href="#l78.40"></a><span id="l78.40">   virtual nsresult SetFilePath(const nsACString &amp;aFilePath);</span>
<a href="#l78.41"></a><span id="l78.41">   virtual nsresult SetQuery(const nsACString &amp;aQuery);</span>
<a href="#l78.42"></a><span id="l78.42" class="difflineminus">-  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding);</span>
<a href="#l78.43"></a><span id="l78.43" class="difflineplus">+  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery,</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+                                        const mozilla::Encoding *aEncoding);</span>
<a href="#l78.45"></a><span id="l78.45"> </span>
<a href="#l78.46"></a><span id="l78.46" class="difflineminus">-public:</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineminus">-  class Mutator</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineminus">-      : public nsIURIMutator</span>
<a href="#l78.49"></a><span id="l78.49" class="difflineminus">-      , public BaseURIMutator&lt;nsAddbookUrl&gt;</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineminus">-  {</span>
<a href="#l78.51"></a><span id="l78.51" class="difflineplus">+ public:</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineplus">+  class Mutator : public nsIURIMutator, public BaseURIMutator&lt;nsAddbookUrl&gt; {</span>
<a href="#l78.53"></a><span id="l78.53">     NS_DECL_ISUPPORTS</span>
<a href="#l78.54"></a><span id="l78.54">     NS_FORWARD_SAFE_NSIURISETTERS_RET(mURI)</span>
<a href="#l78.55"></a><span id="l78.55"> </span>
<a href="#l78.56"></a><span id="l78.56" class="difflineminus">-    NS_IMETHOD Deserialize(const mozilla::ipc::URIParams&amp; aParams) override</span>
<a href="#l78.57"></a><span id="l78.57" class="difflineminus">-    {</span>
<a href="#l78.58"></a><span id="l78.58" class="difflineplus">+    NS_IMETHOD Deserialize(const mozilla::ipc::URIParams &amp;aParams) override {</span>
<a href="#l78.59"></a><span id="l78.59">       return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l78.60"></a><span id="l78.60">     }</span>
<a href="#l78.61"></a><span id="l78.61"> </span>
<a href="#l78.62"></a><span id="l78.62" class="difflineminus">-    NS_IMETHOD Finalize(nsIURI** aURI) override</span>
<a href="#l78.63"></a><span id="l78.63" class="difflineminus">-    {</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineplus">+    NS_IMETHOD Finalize(nsIURI **aURI) override {</span>
<a href="#l78.65"></a><span id="l78.65">       mURI.forget(aURI);</span>
<a href="#l78.66"></a><span id="l78.66">       return NS_OK;</span>
<a href="#l78.67"></a><span id="l78.67">     }</span>
<a href="#l78.68"></a><span id="l78.68"> </span>
<a href="#l78.69"></a><span id="l78.69" class="difflineminus">-    NS_IMETHOD SetSpec(const nsACString &amp; aSpec, nsIURIMutator** aMutator) override</span>
<a href="#l78.70"></a><span id="l78.70" class="difflineminus">-    {</span>
<a href="#l78.71"></a><span id="l78.71" class="difflineminus">-      if (aMutator)</span>
<a href="#l78.72"></a><span id="l78.72" class="difflineminus">-        NS_ADDREF(*aMutator = this);</span>
<a href="#l78.73"></a><span id="l78.73" class="difflineplus">+    NS_IMETHOD SetSpec(const nsACString &amp;aSpec,</span>
<a href="#l78.74"></a><span id="l78.74" class="difflineplus">+                       nsIURIMutator **aMutator) override {</span>
<a href="#l78.75"></a><span id="l78.75" class="difflineplus">+      if (aMutator) NS_ADDREF(*aMutator = this);</span>
<a href="#l78.76"></a><span id="l78.76">       return InitFromSpec(aSpec);</span>
<a href="#l78.77"></a><span id="l78.77">     }</span>
<a href="#l78.78"></a><span id="l78.78"> </span>
<a href="#l78.79"></a><span id="l78.79" class="difflineminus">-    explicit Mutator() { }</span>
<a href="#l78.80"></a><span id="l78.80" class="difflineminus">-  private:</span>
<a href="#l78.81"></a><span id="l78.81" class="difflineminus">-    virtual ~Mutator() { }</span>
<a href="#l78.82"></a><span id="l78.82" class="difflineplus">+    explicit Mutator() {}</span>
<a href="#l78.83"></a><span id="l78.83" class="difflineplus">+</span>
<a href="#l78.84"></a><span id="l78.84" class="difflineplus">+   private:</span>
<a href="#l78.85"></a><span id="l78.85" class="difflineplus">+    virtual ~Mutator() {}</span>
<a href="#l78.86"></a><span id="l78.86"> </span>
<a href="#l78.87"></a><span id="l78.87">     friend class nsAddbookUrl;</span>
<a href="#l78.88"></a><span id="l78.88">   };</span>
<a href="#l78.89"></a><span id="l78.89">   friend BaseURIMutator&lt;nsAddbookUrl&gt;;</span>
<a href="#l78.90"></a><span id="l78.90"> </span>
<a href="#l78.91"></a><span id="l78.91" class="difflineminus">-protected:</span>
<a href="#l78.92"></a><span id="l78.92" class="difflineplus">+ protected:</span>
<a href="#l78.93"></a><span id="l78.93">   virtual ~nsAddbookUrl();</span>
<a href="#l78.94"></a><span id="l78.94"> </span>
<a href="#l78.95"></a><span id="l78.95" class="difflineminus">-  nsresult                      ParseUrl();</span>
<a href="#l78.96"></a><span id="l78.96" class="difflineminus">-  int32_t                       mOperationType;     // the internal ID for the operation</span>
<a href="#l78.97"></a><span id="l78.97" class="difflineplus">+  nsresult ParseUrl();</span>
<a href="#l78.98"></a><span id="l78.98" class="difflineplus">+  int32_t mOperationType;  // the internal ID for the operation</span>
<a href="#l78.99"></a><span id="l78.99"> </span>
<a href="#l78.100"></a><span id="l78.100" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt;              m_baseURL;          // the base URL for the object</span>
<a href="#l78.101"></a><span id="l78.101" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; m_baseURL;  // the base URL for the object</span>
<a href="#l78.102"></a><span id="l78.102"> };</span>
<a href="#l78.103"></a><span id="l78.103"> </span>
<a href="#l78.104"></a><span id="l78.104" class="difflineminus">-#endif // nsAddbookUrl_h__</span>
<a href="#l78.105"></a><span id="l78.105" class="difflineplus">+#endif  // nsAddbookUrl_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -29,26 +29,28 @@</span>
<a href="#l79.4"></a><span id="l79.4"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l79.5"></a><span id="l79.5"> #include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l79.6"></a><span id="l79.6"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l79.7"></a><span id="l79.7"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l79.8"></a><span id="l79.8"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l79.9"></a><span id="l79.9"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l79.10"></a><span id="l79.10"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l79.11"></a><span id="l79.11"> </span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-#define ID_PAB_TABLE            1</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineminus">-#define ID_DELETEDCARDS_TABLE           2</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+#define ID_PAB_TABLE 1</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+#define ID_DELETEDCARDS_TABLE 2</span>
<a href="#l79.16"></a><span id="l79.16"> </span>
<a href="#l79.17"></a><span id="l79.17"> // There's two books by default, although Mac may have one more, so set this</span>
<a href="#l79.18"></a><span id="l79.18"> // to three. Its not going to affect much, but will save us a few reallocations</span>
<a href="#l79.19"></a><span id="l79.19"> // when the cache is allocated.</span>
<a href="#l79.20"></a><span id="l79.20"> const uint32_t kInitialAddrDBCacheSize = 3;</span>
<a href="#l79.21"></a><span id="l79.21"> </span>
<a href="#l79.22"></a><span id="l79.22"> static const char kPabTableKind[] = &quot;ns:addrbk:db:table:kind:pab&quot;;</span>
<a href="#l79.23"></a><span id="l79.23" class="difflineminus">-static const char kDeletedCardsTableKind[] = &quot;ns:addrbk:db:table:kind:deleted&quot;; // this table is used to keep the deleted cards</span>
<a href="#l79.24"></a><span id="l79.24" class="difflineplus">+static const char kDeletedCardsTableKind[] =</span>
<a href="#l79.25"></a><span id="l79.25" class="difflineplus">+    &quot;ns:addrbk:db:table:kind:deleted&quot;;  // this table is used to keep the</span>
<a href="#l79.26"></a><span id="l79.26" class="difflineplus">+                                        // deleted cards</span>
<a href="#l79.27"></a><span id="l79.27"> </span>
<a href="#l79.28"></a><span id="l79.28"> static const char kCardRowScope[] = &quot;ns:addrbk:db:row:scope:card:all&quot;;</span>
<a href="#l79.29"></a><span id="l79.29"> static const char kListRowScope[] = &quot;ns:addrbk:db:row:scope:list:all&quot;;</span>
<a href="#l79.30"></a><span id="l79.30"> static const char kDataRowScope[] = &quot;ns:addrbk:db:row:scope:data:all&quot;;</span>
<a href="#l79.31"></a><span id="l79.31"> </span>
<a href="#l79.32"></a><span id="l79.32"> #define DATAROW_ROWID 1</span>
<a href="#l79.33"></a><span id="l79.33"> </span>
<a href="#l79.34"></a><span id="l79.34"> #define COLUMN_STR_MAX 16</span>
<a href="#l79.35"></a><span id="l79.35" class="difflineat">@@ -61,17 +63,18 @@ static const char kRowIDProperty[] = &quot;Db</span>
<a href="#l79.36"></a><span id="l79.36"> </span>
<a href="#l79.37"></a><span id="l79.37"> static const char kLowerListNameColumn[] = &quot;LowercaseListName&quot;;</span>
<a href="#l79.38"></a><span id="l79.38"> </span>
<a href="#l79.39"></a><span id="l79.39"> struct mdbOid gAddressBookTableOID;</span>
<a href="#l79.40"></a><span id="l79.40"> </span>
<a href="#l79.41"></a><span id="l79.41"> static const char kMailListAddressFormat[] = &quot;Address%d&quot;;</span>
<a href="#l79.42"></a><span id="l79.42"> </span>
<a href="#l79.43"></a><span id="l79.43"> nsAddrDatabase::nsAddrDatabase()</span>
<a href="#l79.44"></a><span id="l79.44" class="difflineminus">-    : m_mdbEnv(nullptr), m_mdbStore(nullptr),</span>
<a href="#l79.45"></a><span id="l79.45" class="difflineplus">+    : m_mdbEnv(nullptr),</span>
<a href="#l79.46"></a><span id="l79.46" class="difflineplus">+      m_mdbStore(nullptr),</span>
<a href="#l79.47"></a><span id="l79.47">       m_mdbPabTable(nullptr),</span>
<a href="#l79.48"></a><span id="l79.48">       m_mdbTokensInitialized(false),</span>
<a href="#l79.49"></a><span id="l79.49">       m_mdbDeletedCardsTableRemoved(false),</span>
<a href="#l79.50"></a><span id="l79.50">       m_PabTableKind(0),</span>
<a href="#l79.51"></a><span id="l79.51">       m_MailListTableKind(0),</span>
<a href="#l79.52"></a><span id="l79.52">       m_DeletedCardsTableKind(0),</span>
<a href="#l79.53"></a><span id="l79.53">       m_CardRowScopeToken(0),</span>
<a href="#l79.54"></a><span id="l79.54">       m_UIDColumnToken(0),</span>
<a href="#l79.55"></a><span id="l79.55" class="difflineat">@@ -124,226 +127,197 @@ nsAddrDatabase::nsAddrDatabase()</span>
<a href="#l79.56"></a><span id="l79.56">       m_Custom3ColumnToken(0),</span>
<a href="#l79.57"></a><span id="l79.57">       m_Custom4ColumnToken(0),</span>
<a href="#l79.58"></a><span id="l79.58">       m_NotesColumnToken(0),</span>
<a href="#l79.59"></a><span id="l79.59">       m_LastModDateColumnToken(0),</span>
<a href="#l79.60"></a><span id="l79.60">       m_MailFormatColumnToken(0),</span>
<a href="#l79.61"></a><span id="l79.61">       m_PopularityIndexColumnToken(0),</span>
<a href="#l79.62"></a><span id="l79.62">       m_AddressCharSetColumnToken(0),</span>
<a href="#l79.63"></a><span id="l79.63">       m_LastRecordKey(0),</span>
<a href="#l79.64"></a><span id="l79.64" class="difflineminus">-      m_dbDirectory(nullptr)</span>
<a href="#l79.65"></a><span id="l79.65" class="difflineminus">-{</span>
<a href="#l79.66"></a><span id="l79.66" class="difflineminus">-}</span>
<a href="#l79.67"></a><span id="l79.67" class="difflineminus">-</span>
<a href="#l79.68"></a><span id="l79.68" class="difflineminus">-nsAddrDatabase::~nsAddrDatabase()</span>
<a href="#l79.69"></a><span id="l79.69" class="difflineminus">-{</span>
<a href="#l79.70"></a><span id="l79.70" class="difflineminus">-  Close(false);    // better have already been closed.</span>
<a href="#l79.71"></a><span id="l79.71" class="difflineplus">+      m_dbDirectory(nullptr) {}</span>
<a href="#l79.72"></a><span id="l79.72" class="difflineplus">+</span>
<a href="#l79.73"></a><span id="l79.73" class="difflineplus">+nsAddrDatabase::~nsAddrDatabase() {</span>
<a href="#l79.74"></a><span id="l79.74" class="difflineplus">+  Close(false);  // better have already been closed.</span>
<a href="#l79.75"></a><span id="l79.75"> </span>
<a href="#l79.76"></a><span id="l79.76">   // better not be any listeners, because we're going away.</span>
<a href="#l79.77"></a><span id="l79.77">   NS_ASSERTION(m_ChangeListeners.Length() == 0, &quot;shouldn't have any listeners&quot;);</span>
<a href="#l79.78"></a><span id="l79.78"> </span>
<a href="#l79.79"></a><span id="l79.79">   RemoveFromCache(this);</span>
<a href="#l79.80"></a><span id="l79.80">   // clean up after ourself!</span>
<a href="#l79.81"></a><span id="l79.81" class="difflineminus">-  if (m_mdbPabTable)</span>
<a href="#l79.82"></a><span id="l79.82" class="difflineminus">-    m_mdbPabTable-&gt;Release();</span>
<a href="#l79.83"></a><span id="l79.83" class="difflineplus">+  if (m_mdbPabTable) m_mdbPabTable-&gt;Release();</span>
<a href="#l79.84"></a><span id="l79.84">   NS_IF_RELEASE(m_mdbStore);</span>
<a href="#l79.85"></a><span id="l79.85">   NS_IF_RELEASE(m_mdbEnv);</span>
<a href="#l79.86"></a><span id="l79.86"> }</span>
<a href="#l79.87"></a><span id="l79.87"> </span>
<a href="#l79.88"></a><span id="l79.88"> NS_IMPL_ISUPPORTS(nsAddrDatabase, nsIAddrDatabase, nsIAddrDBAnnouncer)</span>
<a href="#l79.89"></a><span id="l79.89"> </span>
<a href="#l79.90"></a><span id="l79.90" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::AddListener(nsIAddrDBListener *listener)</span>
<a href="#l79.91"></a><span id="l79.91" class="difflineminus">-{</span>
<a href="#l79.92"></a><span id="l79.92" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::AddListener(nsIAddrDBListener *listener) {</span>
<a href="#l79.93"></a><span id="l79.93">   NS_ENSURE_ARG_POINTER(listener);</span>
<a href="#l79.94"></a><span id="l79.94">   m_ChangeListeners.AppendElement(listener);</span>
<a href="#l79.95"></a><span id="l79.95">   return NS_OK;</span>
<a href="#l79.96"></a><span id="l79.96"> }</span>
<a href="#l79.97"></a><span id="l79.97"> </span>
<a href="#l79.98"></a><span id="l79.98" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::RemoveListener(nsIAddrDBListener *listener)</span>
<a href="#l79.99"></a><span id="l79.99" class="difflineminus">-{</span>
<a href="#l79.100"></a><span id="l79.100" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::RemoveListener(nsIAddrDBListener *listener) {</span>
<a href="#l79.101"></a><span id="l79.101">   NS_ENSURE_ARG_POINTER(listener);</span>
<a href="#l79.102"></a><span id="l79.102">   return m_ChangeListeners.RemoveElement(listener) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.103"></a><span id="l79.103"> }</span>
<a href="#l79.104"></a><span id="l79.104"> </span>
<a href="#l79.105"></a><span id="l79.105" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::NotifyCardAttribChange(uint32_t abCode)</span>
<a href="#l79.106"></a><span id="l79.106" class="difflineminus">-{</span>
<a href="#l79.107"></a><span id="l79.107" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::NotifyCardAttribChange(uint32_t abCode) {</span>
<a href="#l79.108"></a><span id="l79.108">   NS_OBSERVER_ARRAY_NOTIFY_OBSERVERS(m_ChangeListeners, nsIAddrDBListener,</span>
<a href="#l79.109"></a><span id="l79.109">                                      OnCardAttribChange, (abCode));</span>
<a href="#l79.110"></a><span id="l79.110">   return NS_OK;</span>
<a href="#l79.111"></a><span id="l79.111"> }</span>
<a href="#l79.112"></a><span id="l79.112"> </span>
<a href="#l79.113"></a><span id="l79.113" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::NotifyCardEntryChange(uint32_t aAbCode, nsIAbCard *aCard, nsIAbDirectory *aParent)</span>
<a href="#l79.114"></a><span id="l79.114" class="difflineminus">-{</span>
<a href="#l79.115"></a><span id="l79.115" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::NotifyCardEntryChange(uint32_t aAbCode,</span>
<a href="#l79.116"></a><span id="l79.116" class="difflineplus">+                                                    nsIAbCard *aCard,</span>
<a href="#l79.117"></a><span id="l79.117" class="difflineplus">+                                                    nsIAbDirectory *aParent) {</span>
<a href="#l79.118"></a><span id="l79.118">   int32_t currentDisplayNameVersion = 0;</span>
<a href="#l79.119"></a><span id="l79.119"> </span>
<a href="#l79.120"></a><span id="l79.120" class="difflineminus">-  //Update &quot;mail.displayname.version&quot; prefernce</span>
<a href="#l79.121"></a><span id="l79.121" class="difflineplus">+  // Update &quot;mail.displayname.version&quot; prefernce</span>
<a href="#l79.122"></a><span id="l79.122">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l79.123"></a><span id="l79.123"> </span>
<a href="#l79.124"></a><span id="l79.124" class="difflineminus">-  prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;,&amp;currentDisplayNameVersion);</span>
<a href="#l79.125"></a><span id="l79.125" class="difflineminus">-</span>
<a href="#l79.126"></a><span id="l79.126" class="difflineminus">-  prefs-&gt;SetIntPref(&quot;mail.displayname.version&quot;,++currentDisplayNameVersion);</span>
<a href="#l79.127"></a><span id="l79.127" class="difflineplus">+  prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;, &amp;currentDisplayNameVersion);</span>
<a href="#l79.128"></a><span id="l79.128" class="difflineplus">+</span>
<a href="#l79.129"></a><span id="l79.129" class="difflineplus">+  prefs-&gt;SetIntPref(&quot;mail.displayname.version&quot;, ++currentDisplayNameVersion);</span>
<a href="#l79.130"></a><span id="l79.130"> </span>
<a href="#l79.131"></a><span id="l79.131">   NS_OBSERVER_ARRAY_NOTIFY_OBSERVERS(m_ChangeListeners, nsIAddrDBListener,</span>
<a href="#l79.132"></a><span id="l79.132" class="difflineminus">-                                     OnCardEntryChange, (aAbCode, aCard, aParent));</span>
<a href="#l79.133"></a><span id="l79.133" class="difflineplus">+                                     OnCardEntryChange,</span>
<a href="#l79.134"></a><span id="l79.134" class="difflineplus">+                                     (aAbCode, aCard, aParent));</span>
<a href="#l79.135"></a><span id="l79.135">   return NS_OK;</span>
<a href="#l79.136"></a><span id="l79.136"> }</span>
<a href="#l79.137"></a><span id="l79.137"> </span>
<a href="#l79.138"></a><span id="l79.138" class="difflineminus">-nsresult nsAddrDatabase::NotifyListEntryChange(uint32_t abCode, nsIAbDirectory *dir)</span>
<a href="#l79.139"></a><span id="l79.139" class="difflineminus">-{</span>
<a href="#l79.140"></a><span id="l79.140" class="difflineplus">+nsresult nsAddrDatabase::NotifyListEntryChange(uint32_t abCode,</span>
<a href="#l79.141"></a><span id="l79.141" class="difflineplus">+                                               nsIAbDirectory *dir) {</span>
<a href="#l79.142"></a><span id="l79.142">   NS_OBSERVER_ARRAY_NOTIFY_OBSERVERS(m_ChangeListeners, nsIAddrDBListener,</span>
<a href="#l79.143"></a><span id="l79.143">                                      OnListEntryChange, (abCode, dir));</span>
<a href="#l79.144"></a><span id="l79.144">   return NS_OK;</span>
<a href="#l79.145"></a><span id="l79.145"> }</span>
<a href="#l79.146"></a><span id="l79.146"> </span>
<a href="#l79.147"></a><span id="l79.147" class="difflineminus">-</span>
<a href="#l79.148"></a><span id="l79.148" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::NotifyAnnouncerGoingAway(void)</span>
<a href="#l79.149"></a><span id="l79.149" class="difflineminus">-{</span>
<a href="#l79.150"></a><span id="l79.150" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::NotifyAnnouncerGoingAway(void) {</span>
<a href="#l79.151"></a><span id="l79.151">   NS_OBSERVER_ARRAY_NOTIFY_OBSERVERS(m_ChangeListeners, nsIAddrDBListener,</span>
<a href="#l79.152"></a><span id="l79.152">                                      OnAnnouncerGoingAway, ());</span>
<a href="#l79.153"></a><span id="l79.153">   return NS_OK;</span>
<a href="#l79.154"></a><span id="l79.154"> }</span>
<a href="#l79.155"></a><span id="l79.155"> </span>
<a href="#l79.156"></a><span id="l79.156" class="difflineminus">-</span>
<a href="#l79.157"></a><span id="l79.157"> // Apparently its not good for nsTArray to be allocated as static. Don't know</span>
<a href="#l79.158"></a><span id="l79.158"> // why it isn't but its not, so don't think about making it a static variable.</span>
<a href="#l79.159"></a><span id="l79.159"> // Maybe bz knows.</span>
<a href="#l79.160"></a><span id="l79.160" class="difflineminus">-nsTArray&lt;nsAddrDatabase*&gt;* nsAddrDatabase::m_dbCache = nullptr;</span>
<a href="#l79.161"></a><span id="l79.161" class="difflineminus">-</span>
<a href="#l79.162"></a><span id="l79.162" class="difflineminus">-nsTArray&lt;nsAddrDatabase*&gt;*</span>
<a href="#l79.163"></a><span id="l79.163" class="difflineminus">-nsAddrDatabase::GetDBCache()</span>
<a href="#l79.164"></a><span id="l79.164" class="difflineminus">-{</span>
<a href="#l79.165"></a><span id="l79.165" class="difflineplus">+nsTArray&lt;nsAddrDatabase *&gt; *nsAddrDatabase::m_dbCache = nullptr;</span>
<a href="#l79.166"></a><span id="l79.166" class="difflineplus">+</span>
<a href="#l79.167"></a><span id="l79.167" class="difflineplus">+nsTArray&lt;nsAddrDatabase *&gt; *nsAddrDatabase::GetDBCache() {</span>
<a href="#l79.168"></a><span id="l79.168">   if (!m_dbCache)</span>
<a href="#l79.169"></a><span id="l79.169" class="difflineminus">-    m_dbCache = new AutoTArray&lt;nsAddrDatabase*, kInitialAddrDBCacheSize&gt;;</span>
<a href="#l79.170"></a><span id="l79.170" class="difflineplus">+    m_dbCache = new AutoTArray&lt;nsAddrDatabase *, kInitialAddrDBCacheSize&gt;;</span>
<a href="#l79.171"></a><span id="l79.171"> </span>
<a href="#l79.172"></a><span id="l79.172">   return m_dbCache;</span>
<a href="#l79.173"></a><span id="l79.173"> }</span>
<a href="#l79.174"></a><span id="l79.174"> </span>
<a href="#l79.175"></a><span id="l79.175" class="difflineminus">-void</span>
<a href="#l79.176"></a><span id="l79.176" class="difflineminus">-nsAddrDatabase::CleanupCache()</span>
<a href="#l79.177"></a><span id="l79.177" class="difflineminus">-{</span>
<a href="#l79.178"></a><span id="l79.178" class="difflineminus">-  if (m_dbCache)</span>
<a href="#l79.179"></a><span id="l79.179" class="difflineminus">-  {</span>
<a href="#l79.180"></a><span id="l79.180" class="difflineminus">-    for (int32_t i = m_dbCache-&gt;Length() - 1; i &gt;= 0; --i)</span>
<a href="#l79.181"></a><span id="l79.181" class="difflineminus">-    {</span>
<a href="#l79.182"></a><span id="l79.182" class="difflineminus">-      nsAddrDatabase* pAddrDB = m_dbCache-&gt;ElementAt(i);</span>
<a href="#l79.183"></a><span id="l79.183" class="difflineminus">-      if (pAddrDB)</span>
<a href="#l79.184"></a><span id="l79.184" class="difflineminus">-        pAddrDB-&gt;ForceClosed();</span>
<a href="#l79.185"></a><span id="l79.185" class="difflineplus">+void nsAddrDatabase::CleanupCache() {</span>
<a href="#l79.186"></a><span id="l79.186" class="difflineplus">+  if (m_dbCache) {</span>
<a href="#l79.187"></a><span id="l79.187" class="difflineplus">+    for (int32_t i = m_dbCache-&gt;Length() - 1; i &gt;= 0; --i) {</span>
<a href="#l79.188"></a><span id="l79.188" class="difflineplus">+      nsAddrDatabase *pAddrDB = m_dbCache-&gt;ElementAt(i);</span>
<a href="#l79.189"></a><span id="l79.189" class="difflineplus">+      if (pAddrDB) pAddrDB-&gt;ForceClosed();</span>
<a href="#l79.190"></a><span id="l79.190">     }</span>
<a href="#l79.191"></a><span id="l79.191" class="difflineminus">-    // NS_ASSERTION(m_dbCache.Length() == 0, &quot;some msg dbs left open&quot;);    // better not be any open db's.</span>
<a href="#l79.192"></a><span id="l79.192" class="difflineplus">+    // NS_ASSERTION(m_dbCache.Length() == 0, &quot;some msg dbs left open&quot;);    //</span>
<a href="#l79.193"></a><span id="l79.193" class="difflineplus">+    // better not be any open db's.</span>
<a href="#l79.194"></a><span id="l79.194">     delete m_dbCache;</span>
<a href="#l79.195"></a><span id="l79.195">     m_dbCache = nullptr;</span>
<a href="#l79.196"></a><span id="l79.196">   }</span>
<a href="#l79.197"></a><span id="l79.197"> }</span>
<a href="#l79.198"></a><span id="l79.198"> </span>
<a href="#l79.199"></a><span id="l79.199"> //----------------------------------------------------------------------</span>
<a href="#l79.200"></a><span id="l79.200"> // FindInCache - this addrefs the db it finds.</span>
<a href="#l79.201"></a><span id="l79.201"> //----------------------------------------------------------------------</span>
<a href="#l79.202"></a><span id="l79.202" class="difflineminus">-already_AddRefed&lt;nsAddrDatabase&gt; nsAddrDatabase::FindInCache(nsIFile *dbName)</span>
<a href="#l79.203"></a><span id="l79.203" class="difflineminus">-{</span>
<a href="#l79.204"></a><span id="l79.204" class="difflineminus">-  nsTArray&lt;nsAddrDatabase*&gt;* dbCache = GetDBCache();</span>
<a href="#l79.205"></a><span id="l79.205" class="difflineplus">+already_AddRefed&lt;nsAddrDatabase&gt; nsAddrDatabase::FindInCache(nsIFile *dbName) {</span>
<a href="#l79.206"></a><span id="l79.206" class="difflineplus">+  nsTArray&lt;nsAddrDatabase *&gt; *dbCache = GetDBCache();</span>
<a href="#l79.207"></a><span id="l79.207">   uint32_t length = dbCache-&gt;Length();</span>
<a href="#l79.208"></a><span id="l79.208" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; ++i)</span>
<a href="#l79.209"></a><span id="l79.209" class="difflineminus">-  {</span>
<a href="#l79.210"></a><span id="l79.210" class="difflineplus">+  for (uint32_t i = 0; i &lt; length; ++i) {</span>
<a href="#l79.211"></a><span id="l79.211">     RefPtr&lt;nsAddrDatabase&gt; pAddrDB = dbCache-&gt;ElementAt(i);</span>
<a href="#l79.212"></a><span id="l79.212" class="difflineminus">-    if (pAddrDB-&gt;MatchDbName(dbName))</span>
<a href="#l79.213"></a><span id="l79.213" class="difflineminus">-    {</span>
<a href="#l79.214"></a><span id="l79.214" class="difflineplus">+    if (pAddrDB-&gt;MatchDbName(dbName)) {</span>
<a href="#l79.215"></a><span id="l79.215">       return pAddrDB.forget();</span>
<a href="#l79.216"></a><span id="l79.216">     }</span>
<a href="#l79.217"></a><span id="l79.217">   }</span>
<a href="#l79.218"></a><span id="l79.218">   return nullptr;</span>
<a href="#l79.219"></a><span id="l79.219"> }</span>
<a href="#l79.220"></a><span id="l79.220"> </span>
<a href="#l79.221"></a><span id="l79.221" class="difflineminus">-bool nsAddrDatabase::MatchDbName(nsIFile* dbName)    // returns true if they match</span>
<a href="#l79.222"></a><span id="l79.222" class="difflineplus">+bool nsAddrDatabase::MatchDbName(nsIFile *dbName)  // returns true if they match</span>
<a href="#l79.223"></a><span id="l79.223"> {</span>
<a href="#l79.224"></a><span id="l79.224">   bool dbMatches = false;</span>
<a href="#l79.225"></a><span id="l79.225"> </span>
<a href="#l79.226"></a><span id="l79.226">   nsresult rv = m_dbName-&gt;Equals(dbName, &amp;dbMatches);</span>
<a href="#l79.227"></a><span id="l79.227" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l79.228"></a><span id="l79.228" class="difflineminus">-    return false;</span>
<a href="#l79.229"></a><span id="l79.229" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l79.230"></a><span id="l79.230"> </span>
<a href="#l79.231"></a><span id="l79.231">   return dbMatches;</span>
<a href="#l79.232"></a><span id="l79.232"> }</span>
<a href="#l79.233"></a><span id="l79.233"> </span>
<a href="#l79.234"></a><span id="l79.234"> //----------------------------------------------------------------------</span>
<a href="#l79.235"></a><span id="l79.235"> // RemoveFromCache</span>
<a href="#l79.236"></a><span id="l79.236"> //----------------------------------------------------------------------</span>
<a href="#l79.237"></a><span id="l79.237" class="difflineminus">-void nsAddrDatabase::RemoveFromCache(nsAddrDatabase* pAddrDB)</span>
<a href="#l79.238"></a><span id="l79.238" class="difflineminus">-{</span>
<a href="#l79.239"></a><span id="l79.239" class="difflineminus">-  if (m_dbCache)</span>
<a href="#l79.240"></a><span id="l79.240" class="difflineminus">-    m_dbCache-&gt;RemoveElement(pAddrDB);</span>
<a href="#l79.241"></a><span id="l79.241" class="difflineplus">+void nsAddrDatabase::RemoveFromCache(nsAddrDatabase *pAddrDB) {</span>
<a href="#l79.242"></a><span id="l79.242" class="difflineplus">+  if (m_dbCache) m_dbCache-&gt;RemoveElement(pAddrDB);</span>
<a href="#l79.243"></a><span id="l79.243"> }</span>
<a href="#l79.244"></a><span id="l79.244"> </span>
<a href="#l79.245"></a><span id="l79.245" class="difflineminus">-nsresult nsAddrDatabase::GetMDBFactory(nsIMdbFactory ** aMdbFactory)</span>
<a href="#l79.246"></a><span id="l79.246" class="difflineminus">-{</span>
<a href="#l79.247"></a><span id="l79.247" class="difflineminus">-  if (!mMdbFactory)</span>
<a href="#l79.248"></a><span id="l79.248" class="difflineminus">-  {</span>
<a href="#l79.249"></a><span id="l79.249" class="difflineplus">+nsresult nsAddrDatabase::GetMDBFactory(nsIMdbFactory **aMdbFactory) {</span>
<a href="#l79.250"></a><span id="l79.250" class="difflineplus">+  if (!mMdbFactory) {</span>
<a href="#l79.251"></a><span id="l79.251">     nsresult rv;</span>
<a href="#l79.252"></a><span id="l79.252" class="difflineminus">-    nsCOMPtr &lt;nsIMdbFactoryService&gt; mdbFactoryService = do_GetService(NS_MORK_CONTRACTID, &amp;rv);</span>
<a href="#l79.253"></a><span id="l79.253" class="difflineplus">+    nsCOMPtr&lt;nsIMdbFactoryService&gt; mdbFactoryService =</span>
<a href="#l79.254"></a><span id="l79.254" class="difflineplus">+        do_GetService(NS_MORK_CONTRACTID, &amp;rv);</span>
<a href="#l79.255"></a><span id="l79.255">     if (NS_SUCCEEDED(rv) &amp;&amp; mdbFactoryService) {</span>
<a href="#l79.256"></a><span id="l79.256">       rv = mdbFactoryService-&gt;GetMdbFactory(getter_AddRefs(mMdbFactory));</span>
<a href="#l79.257"></a><span id="l79.257">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.258"></a><span id="l79.258" class="difflineminus">-      if (!mMdbFactory)</span>
<a href="#l79.259"></a><span id="l79.259" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l79.260"></a><span id="l79.260" class="difflineplus">+      if (!mMdbFactory) return NS_ERROR_FAILURE;</span>
<a href="#l79.261"></a><span id="l79.261">     }</span>
<a href="#l79.262"></a><span id="l79.262">   }</span>
<a href="#l79.263"></a><span id="l79.263">   NS_ADDREF(*aMdbFactory = mMdbFactory);</span>
<a href="#l79.264"></a><span id="l79.264">   return NS_OK;</span>
<a href="#l79.265"></a><span id="l79.265"> }</span>
<a href="#l79.266"></a><span id="l79.266"> </span>
<a href="#l79.267"></a><span id="l79.267"> /* caller need to delete *aDbPath */</span>
<a href="#l79.268"></a><span id="l79.268" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::GetDbPath(nsIFile* *aDbPath)</span>
<a href="#l79.269"></a><span id="l79.269" class="difflineminus">-{</span>
<a href="#l79.270"></a><span id="l79.270" class="difflineminus">-  if (!aDbPath)</span>
<a href="#l79.271"></a><span id="l79.271" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.272"></a><span id="l79.272" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::GetDbPath(nsIFile **aDbPath) {</span>
<a href="#l79.273"></a><span id="l79.273" class="difflineplus">+  if (!aDbPath) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.274"></a><span id="l79.274"> </span>
<a href="#l79.275"></a><span id="l79.275">   return m_dbName-&gt;Clone(aDbPath);</span>
<a href="#l79.276"></a><span id="l79.276"> }</span>
<a href="#l79.277"></a><span id="l79.277"> </span>
<a href="#l79.278"></a><span id="l79.278" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::SetDbPath(nsIFile* aDbPath)</span>
<a href="#l79.279"></a><span id="l79.279" class="difflineminus">-{</span>
<a href="#l79.280"></a><span id="l79.280" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::SetDbPath(nsIFile *aDbPath) {</span>
<a href="#l79.281"></a><span id="l79.281">   return aDbPath-&gt;Clone(getter_AddRefs(m_dbName));</span>
<a href="#l79.282"></a><span id="l79.282"> }</span>
<a href="#l79.283"></a><span id="l79.283"> </span>
<a href="#l79.284"></a><span id="l79.284" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::Open</span>
<a href="#l79.285"></a><span id="l79.285" class="difflineminus">-(nsIFile *aMabFile, bool aCreate, bool upgrading /* unused */, nsIAddrDatabase** pAddrDB)</span>
<a href="#l79.286"></a><span id="l79.286" class="difflineminus">-{</span>
<a href="#l79.287"></a><span id="l79.287" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::Open(nsIFile *aMabFile, bool aCreate,</span>
<a href="#l79.288"></a><span id="l79.288" class="difflineplus">+                                   bool upgrading /* unused */,</span>
<a href="#l79.289"></a><span id="l79.289" class="difflineplus">+                                   nsIAddrDatabase **pAddrDB) {</span>
<a href="#l79.290"></a><span id="l79.290">   *pAddrDB = nullptr;</span>
<a href="#l79.291"></a><span id="l79.291"> </span>
<a href="#l79.292"></a><span id="l79.292">   RefPtr&lt;nsAddrDatabase&gt; pAddressBookDB = FindInCache(aMabFile);</span>
<a href="#l79.293"></a><span id="l79.293"> </span>
<a href="#l79.294"></a><span id="l79.294">   if (pAddressBookDB) {</span>
<a href="#l79.295"></a><span id="l79.295">     pAddressBookDB.forget(pAddrDB);</span>
<a href="#l79.296"></a><span id="l79.296">     return NS_OK;</span>
<a href="#l79.297"></a><span id="l79.297">   }</span>
<a href="#l79.298"></a><span id="l79.298"> </span>
<a href="#l79.299"></a><span id="l79.299">   nsresult rv = OpenInternal(aMabFile, aCreate, pAddrDB);</span>
<a href="#l79.300"></a><span id="l79.300" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l79.301"></a><span id="l79.301" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.302"></a><span id="l79.302" class="difflineminus">-</span>
<a href="#l79.303"></a><span id="l79.303" class="difflineminus">-  if (rv == NS_ERROR_FILE_ACCESS_DENIED)</span>
<a href="#l79.304"></a><span id="l79.304" class="difflineminus">-  {</span>
<a href="#l79.305"></a><span id="l79.305" class="difflineplus">+  if (NS_SUCCEEDED(rv)) return NS_OK;</span>
<a href="#l79.306"></a><span id="l79.306" class="difflineplus">+</span>
<a href="#l79.307"></a><span id="l79.307" class="difflineplus">+  if (rv == NS_ERROR_FILE_ACCESS_DENIED) {</span>
<a href="#l79.308"></a><span id="l79.308">     static bool gAlreadyAlerted;</span>
<a href="#l79.309"></a><span id="l79.309" class="difflineminus">-     // only do this once per session to avoid annoying the user</span>
<a href="#l79.310"></a><span id="l79.310" class="difflineminus">-    if (!gAlreadyAlerted)</span>
<a href="#l79.311"></a><span id="l79.311" class="difflineminus">-    {</span>
<a href="#l79.312"></a><span id="l79.312" class="difflineplus">+    // only do this once per session to avoid annoying the user</span>
<a href="#l79.313"></a><span id="l79.313" class="difflineplus">+    if (!gAlreadyAlerted) {</span>
<a href="#l79.314"></a><span id="l79.314">       gAlreadyAlerted = true;</span>
<a href="#l79.315"></a><span id="l79.315">       nsAutoString mabFileName;</span>
<a href="#l79.316"></a><span id="l79.316">       rv = aMabFile-&gt;GetLeafName(mabFileName);</span>
<a href="#l79.317"></a><span id="l79.317">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.318"></a><span id="l79.318">       AlertAboutLockedMabFile(mabFileName.get());</span>
<a href="#l79.319"></a><span id="l79.319"> </span>
<a href="#l79.320"></a><span id="l79.320">       // We just overwrote rv, so return the proper value here.</span>
<a href="#l79.321"></a><span id="l79.321">       return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l79.322"></a><span id="l79.322">     }</span>
<a href="#l79.323"></a><span id="l79.323">   }</span>
<a href="#l79.324"></a><span id="l79.324">   // try one more time</span>
<a href="#l79.325"></a><span id="l79.325">   // but first rename corrupt mab file</span>
<a href="#l79.326"></a><span id="l79.326">   // and prompt the user</span>
<a href="#l79.327"></a><span id="l79.327" class="difflineminus">-  else if (aCreate)</span>
<a href="#l79.328"></a><span id="l79.328" class="difflineminus">-  {</span>
<a href="#l79.329"></a><span id="l79.329" class="difflineplus">+  else if (aCreate) {</span>
<a href="#l79.330"></a><span id="l79.330">     nsCOMPtr&lt;nsIFile&gt; dummyBackupMabFile;</span>
<a href="#l79.331"></a><span id="l79.331">     nsCOMPtr&lt;nsIFile&gt; actualBackupMabFile;</span>
<a href="#l79.332"></a><span id="l79.332"> </span>
<a href="#l79.333"></a><span id="l79.333">     // First create a clone of the corrupt mab file that we'll</span>
<a href="#l79.334"></a><span id="l79.334">     // use to generate the name for the backup file that we are</span>
<a href="#l79.335"></a><span id="l79.335">     // going to move it to.</span>
<a href="#l79.336"></a><span id="l79.336">     rv = aMabFile-&gt;Clone(getter_AddRefs(dummyBackupMabFile));</span>
<a href="#l79.337"></a><span id="l79.337">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.338"></a><span id="l79.338" class="difflineat">@@ -383,723 +357,727 @@ NS_IMETHODIMP nsAddrDatabase::Open</span>
<a href="#l79.339"></a><span id="l79.339"> </span>
<a href="#l79.340"></a><span id="l79.340">     // Now move the corrupt file to its backup location</span>
<a href="#l79.341"></a><span id="l79.341">     rv = actualBackupMabFile-&gt;MoveToNative(parentDir, backupMabFileName);</span>
<a href="#l79.342"></a><span id="l79.342">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to rename corrupt mab file&quot;);</span>
<a href="#l79.343"></a><span id="l79.343"> </span>
<a href="#l79.344"></a><span id="l79.344">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.345"></a><span id="l79.345">       // now we can try to recreate the original mab file</span>
<a href="#l79.346"></a><span id="l79.346">       rv = OpenInternal(aMabFile, aCreate, pAddrDB);</span>
<a href="#l79.347"></a><span id="l79.347" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create .mab file, after rename&quot;);</span>
<a href="#l79.348"></a><span id="l79.348" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l79.349"></a><span id="l79.349" class="difflineplus">+                   &quot;failed to create .mab file, after rename&quot;);</span>
<a href="#l79.350"></a><span id="l79.350"> </span>
<a href="#l79.351"></a><span id="l79.351">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.352"></a><span id="l79.352">         nsAutoString originalMabFileName;</span>
<a href="#l79.353"></a><span id="l79.353">         rv = aMabFile-&gt;GetLeafName(originalMabFileName);</span>
<a href="#l79.354"></a><span id="l79.354">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.355"></a><span id="l79.355"> </span>
<a href="#l79.356"></a><span id="l79.356">         // if this fails, we don't care</span>
<a href="#l79.357"></a><span id="l79.357" class="difflineminus">-        (void)AlertAboutCorruptMabFile(originalMabFileName.get(),</span>
<a href="#l79.358"></a><span id="l79.358" class="difflineminus">-          NS_ConvertASCIItoUTF16(backupMabFileName).get());</span>
<a href="#l79.359"></a><span id="l79.359" class="difflineplus">+        (void)AlertAboutCorruptMabFile(</span>
<a href="#l79.360"></a><span id="l79.360" class="difflineplus">+            originalMabFileName.get(),</span>
<a href="#l79.361"></a><span id="l79.361" class="difflineplus">+            NS_ConvertASCIItoUTF16(backupMabFileName).get());</span>
<a href="#l79.362"></a><span id="l79.362">       }</span>
<a href="#l79.363"></a><span id="l79.363">     }</span>
<a href="#l79.364"></a><span id="l79.364">   }</span>
<a href="#l79.365"></a><span id="l79.365">   return rv;</span>
<a href="#l79.366"></a><span id="l79.366"> }</span>
<a href="#l79.367"></a><span id="l79.367"> </span>
<a href="#l79.368"></a><span id="l79.368" class="difflineminus">-nsresult nsAddrDatabase::DisplayAlert(const char16_t *titleName, const char16_t *alertStringName, const char16_t **formatStrings, int32_t numFormatStrings)</span>
<a href="#l79.369"></a><span id="l79.369" class="difflineminus">-{</span>
<a href="#l79.370"></a><span id="l79.370" class="difflineplus">+nsresult nsAddrDatabase::DisplayAlert(const char16_t *titleName,</span>
<a href="#l79.371"></a><span id="l79.371" class="difflineplus">+                                      const char16_t *alertStringName,</span>
<a href="#l79.372"></a><span id="l79.372" class="difflineplus">+                                      const char16_t **formatStrings,</span>
<a href="#l79.373"></a><span id="l79.373" class="difflineplus">+                                      int32_t numFormatStrings) {</span>
<a href="#l79.374"></a><span id="l79.374">   nsresult rv;</span>
<a href="#l79.375"></a><span id="l79.375">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l79.376"></a><span id="l79.376" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l79.377"></a><span id="l79.377" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l79.378"></a><span id="l79.378">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l79.379"></a><span id="l79.379"> </span>
<a href="#l79.380"></a><span id="l79.380">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l79.381"></a><span id="l79.381" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l79.382"></a><span id="l79.382" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l79.383"></a><span id="l79.383" class="difflineplus">+      &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l79.384"></a><span id="l79.384" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l79.385"></a><span id="l79.385">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.386"></a><span id="l79.386"> </span>
<a href="#l79.387"></a><span id="l79.387">   nsString alertMessage;</span>
<a href="#l79.388"></a><span id="l79.388" class="difflineminus">-  rv = bundle-&gt;FormatStringFromName(NS_ConvertUTF16toUTF8(alertStringName).get(), formatStrings, numFormatStrings,</span>
<a href="#l79.389"></a><span id="l79.389" class="difflineminus">-    alertMessage);</span>
<a href="#l79.390"></a><span id="l79.390" class="difflineplus">+  rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l79.391"></a><span id="l79.391" class="difflineplus">+      NS_ConvertUTF16toUTF8(alertStringName).get(), formatStrings,</span>
<a href="#l79.392"></a><span id="l79.392" class="difflineplus">+      numFormatStrings, alertMessage);</span>
<a href="#l79.393"></a><span id="l79.393">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.394"></a><span id="l79.394"> </span>
<a href="#l79.395"></a><span id="l79.395">   nsString alertTitle;</span>
<a href="#l79.396"></a><span id="l79.396" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(titleName).get(), alertTitle);</span>
<a href="#l79.397"></a><span id="l79.397" class="difflineplus">+  rv = bundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(titleName).get(),</span>
<a href="#l79.398"></a><span id="l79.398" class="difflineplus">+                                 alertTitle);</span>
<a href="#l79.399"></a><span id="l79.399">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.400"></a><span id="l79.400"> </span>
<a href="#l79.401"></a><span id="l79.401">   nsCOMPtr&lt;nsIPromptService&gt; prompter =</span>
<a href="#l79.402"></a><span id="l79.402">       do_GetService(NS_PROMPTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l79.403"></a><span id="l79.403">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.404"></a><span id="l79.404"> </span>
<a href="#l79.405"></a><span id="l79.405" class="difflineminus">-  return prompter-&gt;Alert(nullptr /* we don't know the parent window */, alertTitle.get(), alertMessage.get());</span>
<a href="#l79.406"></a><span id="l79.406" class="difflineplus">+  return prompter-&gt;Alert(nullptr /* we don't know the parent window */,</span>
<a href="#l79.407"></a><span id="l79.407" class="difflineplus">+                         alertTitle.get(), alertMessage.get());</span>
<a href="#l79.408"></a><span id="l79.408"> }</span>
<a href="#l79.409"></a><span id="l79.409"> </span>
<a href="#l79.410"></a><span id="l79.410" class="difflineminus">-nsresult nsAddrDatabase::AlertAboutCorruptMabFile(const char16_t *aOldFileName, const char16_t *aNewFileName)</span>
<a href="#l79.411"></a><span id="l79.411" class="difflineminus">-{</span>
<a href="#l79.412"></a><span id="l79.412" class="difflineminus">-  const char16_t *formatStrings[] = { aOldFileName, aOldFileName, aNewFileName };</span>
<a href="#l79.413"></a><span id="l79.413" class="difflineminus">-  return DisplayAlert(u&quot;corruptMabFileTitle&quot;,</span>
<a href="#l79.414"></a><span id="l79.414" class="difflineminus">-    u&quot;corruptMabFileAlert&quot;, formatStrings, 3);</span>
<a href="#l79.415"></a><span id="l79.415" class="difflineplus">+nsresult nsAddrDatabase::AlertAboutCorruptMabFile(</span>
<a href="#l79.416"></a><span id="l79.416" class="difflineplus">+    const char16_t *aOldFileName, const char16_t *aNewFileName) {</span>
<a href="#l79.417"></a><span id="l79.417" class="difflineplus">+  const char16_t *formatStrings[] = {aOldFileName, aOldFileName, aNewFileName};</span>
<a href="#l79.418"></a><span id="l79.418" class="difflineplus">+  return DisplayAlert(u&quot;corruptMabFileTitle&quot;, u&quot;corruptMabFileAlert&quot;,</span>
<a href="#l79.419"></a><span id="l79.419" class="difflineplus">+                      formatStrings, 3);</span>
<a href="#l79.420"></a><span id="l79.420"> }</span>
<a href="#l79.421"></a><span id="l79.421"> </span>
<a href="#l79.422"></a><span id="l79.422" class="difflineminus">-nsresult nsAddrDatabase::AlertAboutLockedMabFile(const char16_t *aFileName)</span>
<a href="#l79.423"></a><span id="l79.423" class="difflineminus">-{</span>
<a href="#l79.424"></a><span id="l79.424" class="difflineminus">-  const char16_t *formatStrings[] = { aFileName };</span>
<a href="#l79.425"></a><span id="l79.425" class="difflineminus">-  return DisplayAlert(u&quot;lockedMabFileTitle&quot;,</span>
<a href="#l79.426"></a><span id="l79.426" class="difflineminus">-    u&quot;lockedMabFileAlert&quot;, formatStrings, 1);</span>
<a href="#l79.427"></a><span id="l79.427" class="difflineplus">+nsresult nsAddrDatabase::AlertAboutLockedMabFile(const char16_t *aFileName) {</span>
<a href="#l79.428"></a><span id="l79.428" class="difflineplus">+  const char16_t *formatStrings[] = {aFileName};</span>
<a href="#l79.429"></a><span id="l79.429" class="difflineplus">+  return DisplayAlert(u&quot;lockedMabFileTitle&quot;, u&quot;lockedMabFileAlert&quot;,</span>
<a href="#l79.430"></a><span id="l79.430" class="difflineplus">+                      formatStrings, 1);</span>
<a href="#l79.431"></a><span id="l79.431"> }</span>
<a href="#l79.432"></a><span id="l79.432"> </span>
<a href="#l79.433"></a><span id="l79.433" class="difflineminus">-nsresult</span>
<a href="#l79.434"></a><span id="l79.434" class="difflineminus">-nsAddrDatabase::OpenInternal(nsIFile *aMabFile, bool aCreate, nsIAddrDatabase** pAddrDB)</span>
<a href="#l79.435"></a><span id="l79.435" class="difflineminus">-{</span>
<a href="#l79.436"></a><span id="l79.436" class="difflineplus">+nsresult nsAddrDatabase::OpenInternal(nsIFile *aMabFile, bool aCreate,</span>
<a href="#l79.437"></a><span id="l79.437" class="difflineplus">+                                      nsIAddrDatabase **pAddrDB) {</span>
<a href="#l79.438"></a><span id="l79.438">   RefPtr&lt;nsAddrDatabase&gt; pAddressBookDB = new nsAddrDatabase();</span>
<a href="#l79.439"></a><span id="l79.439"> </span>
<a href="#l79.440"></a><span id="l79.440">   nsresult rv = pAddressBookDB-&gt;OpenMDB(aMabFile, aCreate);</span>
<a href="#l79.441"></a><span id="l79.441" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l79.442"></a><span id="l79.442" class="difflineminus">-  {</span>
<a href="#l79.443"></a><span id="l79.443" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.444"></a><span id="l79.444">     pAddressBookDB-&gt;SetDbPath(aMabFile);</span>
<a href="#l79.445"></a><span id="l79.445">     GetDBCache()-&gt;AppendElement(pAddressBookDB);</span>
<a href="#l79.446"></a><span id="l79.446">     pAddressBookDB.forget(pAddrDB);</span>
<a href="#l79.447"></a><span id="l79.447" class="difflineminus">-  }</span>
<a href="#l79.448"></a><span id="l79.448" class="difflineminus">-  else</span>
<a href="#l79.449"></a><span id="l79.449" class="difflineminus">-  {</span>
<a href="#l79.450"></a><span id="l79.450" class="difflineplus">+  } else {</span>
<a href="#l79.451"></a><span id="l79.451">     *pAddrDB = nullptr;</span>
<a href="#l79.452"></a><span id="l79.452">     pAddressBookDB-&gt;ForceClosed();</span>
<a href="#l79.453"></a><span id="l79.453">     pAddressBookDB = nullptr;</span>
<a href="#l79.454"></a><span id="l79.454">   }</span>
<a href="#l79.455"></a><span id="l79.455">   return rv;</span>
<a href="#l79.456"></a><span id="l79.456"> }</span>
<a href="#l79.457"></a><span id="l79.457"> </span>
<a href="#l79.458"></a><span id="l79.458"> // Open the MDB database synchronously. If successful, this routine</span>
<a href="#l79.459"></a><span id="l79.459"> // will set up the m_mdbStore and m_mdbEnv of the database object</span>
<a href="#l79.460"></a><span id="l79.460"> // so other database calls can work.</span>
<a href="#l79.461"></a><span id="l79.461" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::OpenMDB(nsIFile *dbName, bool create)</span>
<a href="#l79.462"></a><span id="l79.462" class="difflineminus">-{</span>
<a href="#l79.463"></a><span id="l79.463" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::OpenMDB(nsIFile *dbName, bool create) {</span>
<a href="#l79.464"></a><span id="l79.464">   nsCOMPtr&lt;nsIMdbFactory&gt; mdbFactory;</span>
<a href="#l79.465"></a><span id="l79.465">   nsresult ret = GetMDBFactory(getter_AddRefs(mdbFactory));</span>
<a href="#l79.466"></a><span id="l79.466">   NS_ENSURE_SUCCESS(ret, ret);</span>
<a href="#l79.467"></a><span id="l79.467"> </span>
<a href="#l79.468"></a><span id="l79.468">   ret = mdbFactory-&gt;MakeEnv(NULL, &amp;m_mdbEnv);</span>
<a href="#l79.469"></a><span id="l79.469" class="difflineminus">-  if (NS_SUCCEEDED(ret))</span>
<a href="#l79.470"></a><span id="l79.470" class="difflineminus">-  {</span>
<a href="#l79.471"></a><span id="l79.471" class="difflineplus">+  if (NS_SUCCEEDED(ret)) {</span>
<a href="#l79.472"></a><span id="l79.472">     nsIMdbThumb *thumb = nullptr;</span>
<a href="#l79.473"></a><span id="l79.473"> </span>
<a href="#l79.474"></a><span id="l79.474">     PathString filePath = dbName-&gt;NativePath();</span>
<a href="#l79.475"></a><span id="l79.475"> </span>
<a href="#l79.476"></a><span id="l79.476" class="difflineminus">-    nsIMdbHeap* dbHeap = nullptr;</span>
<a href="#l79.477"></a><span id="l79.477" class="difflineminus">-</span>
<a href="#l79.478"></a><span id="l79.478" class="difflineminus">-    if (m_mdbEnv)</span>
<a href="#l79.479"></a><span id="l79.479" class="difflineminus">-      m_mdbEnv-&gt;SetAutoClear(true);</span>
<a href="#l79.480"></a><span id="l79.480" class="difflineplus">+    nsIMdbHeap *dbHeap = nullptr;</span>
<a href="#l79.481"></a><span id="l79.481" class="difflineplus">+</span>
<a href="#l79.482"></a><span id="l79.482" class="difflineplus">+    if (m_mdbEnv) m_mdbEnv-&gt;SetAutoClear(true);</span>
<a href="#l79.483"></a><span id="l79.483"> </span>
<a href="#l79.484"></a><span id="l79.484">     bool dbNameExists = false;</span>
<a href="#l79.485"></a><span id="l79.485">     ret = dbName-&gt;Exists(&amp;dbNameExists);</span>
<a href="#l79.486"></a><span id="l79.486">     NS_ENSURE_SUCCESS(ret, ret);</span>
<a href="#l79.487"></a><span id="l79.487"> </span>
<a href="#l79.488"></a><span id="l79.488">     if (!dbNameExists)</span>
<a href="#l79.489"></a><span id="l79.489">       ret = NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l79.490"></a><span id="l79.490" class="difflineminus">-    else</span>
<a href="#l79.491"></a><span id="l79.491" class="difflineminus">-    {</span>
<a href="#l79.492"></a><span id="l79.492" class="difflineplus">+    else {</span>
<a href="#l79.493"></a><span id="l79.493">       mdbOpenPolicy inOpenPolicy;</span>
<a href="#l79.494"></a><span id="l79.494" class="difflineminus">-      mdb_bool    canOpen;</span>
<a href="#l79.495"></a><span id="l79.495" class="difflineminus">-      mdbYarn        outFormatVersion;</span>
<a href="#l79.496"></a><span id="l79.496" class="difflineminus">-      nsIMdbFile* oldFile = nullptr;</span>
<a href="#l79.497"></a><span id="l79.497" class="difflineplus">+      mdb_bool canOpen;</span>
<a href="#l79.498"></a><span id="l79.498" class="difflineplus">+      mdbYarn outFormatVersion;</span>
<a href="#l79.499"></a><span id="l79.499" class="difflineplus">+      nsIMdbFile *oldFile = nullptr;</span>
<a href="#l79.500"></a><span id="l79.500">       int64_t fileSize;</span>
<a href="#l79.501"></a><span id="l79.501">       ret = dbName-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l79.502"></a><span id="l79.502">       NS_ENSURE_SUCCESS(ret, ret);</span>
<a href="#l79.503"></a><span id="l79.503"> </span>
<a href="#l79.504"></a><span id="l79.504" class="difflineminus">-      ret = mdbFactory-&gt;OpenOldFile(m_mdbEnv, dbHeap, filePath.get(),</span>
<a href="#l79.505"></a><span id="l79.505" class="difflineminus">-                                    mdbBool_kFalse, // not readonly, we want modifiable</span>
<a href="#l79.506"></a><span id="l79.506" class="difflineminus">-                                    &amp;oldFile);</span>
<a href="#l79.507"></a><span id="l79.507" class="difflineminus">-      if ( oldFile )</span>
<a href="#l79.508"></a><span id="l79.508" class="difflineminus">-      {</span>
<a href="#l79.509"></a><span id="l79.509" class="difflineminus">-        if (NS_SUCCEEDED(ret))</span>
<a href="#l79.510"></a><span id="l79.510" class="difflineminus">-        {</span>
<a href="#l79.511"></a><span id="l79.511" class="difflineminus">-          ret = mdbFactory-&gt;CanOpenFilePort(m_mdbEnv, oldFile, // the file to investigate</span>
<a href="#l79.512"></a><span id="l79.512" class="difflineplus">+      ret = mdbFactory-&gt;OpenOldFile(</span>
<a href="#l79.513"></a><span id="l79.513" class="difflineplus">+          m_mdbEnv, dbHeap, filePath.get(),</span>
<a href="#l79.514"></a><span id="l79.514" class="difflineplus">+          mdbBool_kFalse,  // not readonly, we want modifiable</span>
<a href="#l79.515"></a><span id="l79.515" class="difflineplus">+          &amp;oldFile);</span>
<a href="#l79.516"></a><span id="l79.516" class="difflineplus">+      if (oldFile) {</span>
<a href="#l79.517"></a><span id="l79.517" class="difflineplus">+        if (NS_SUCCEEDED(ret)) {</span>
<a href="#l79.518"></a><span id="l79.518" class="difflineplus">+          ret = mdbFactory-&gt;CanOpenFilePort(m_mdbEnv,</span>
<a href="#l79.519"></a><span id="l79.519" class="difflineplus">+                                            oldFile,  // the file to investigate</span>
<a href="#l79.520"></a><span id="l79.520">                                             &amp;canOpen, &amp;outFormatVersion);</span>
<a href="#l79.521"></a><span id="l79.521" class="difflineminus">-          if (NS_SUCCEEDED(ret) &amp;&amp; canOpen)</span>
<a href="#l79.522"></a><span id="l79.522" class="difflineminus">-          {</span>
<a href="#l79.523"></a><span id="l79.523" class="difflineplus">+          if (NS_SUCCEEDED(ret) &amp;&amp; canOpen) {</span>
<a href="#l79.524"></a><span id="l79.524">             inOpenPolicy.mOpenPolicy_ScopePlan.mScopeStringSet_Count = 0;</span>
<a href="#l79.525"></a><span id="l79.525">             inOpenPolicy.mOpenPolicy_MinMemory = 0;</span>
<a href="#l79.526"></a><span id="l79.526">             inOpenPolicy.mOpenPolicy_MaxLazy = 0;</span>
<a href="#l79.527"></a><span id="l79.527"> </span>
<a href="#l79.528"></a><span id="l79.528" class="difflineminus">-            ret = mdbFactory-&gt;OpenFileStore(m_mdbEnv, dbHeap,</span>
<a href="#l79.529"></a><span id="l79.529" class="difflineminus">-              oldFile, &amp;inOpenPolicy, &amp;thumb);</span>
<a href="#l79.530"></a><span id="l79.530" class="difflineminus">-          }</span>
<a href="#l79.531"></a><span id="l79.531" class="difflineminus">-          else if (fileSize != 0)</span>
<a href="#l79.532"></a><span id="l79.532" class="difflineplus">+            ret = mdbFactory-&gt;OpenFileStore(m_mdbEnv, dbHeap, oldFile,</span>
<a href="#l79.533"></a><span id="l79.533" class="difflineplus">+                                            &amp;inOpenPolicy, &amp;thumb);</span>
<a href="#l79.534"></a><span id="l79.534" class="difflineplus">+          } else if (fileSize != 0)</span>
<a href="#l79.535"></a><span id="l79.535">             ret = NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l79.536"></a><span id="l79.536">         }</span>
<a href="#l79.537"></a><span id="l79.537" class="difflineminus">-        NS_RELEASE(oldFile); // always release our file ref, store has own</span>
<a href="#l79.538"></a><span id="l79.538" class="difflineplus">+        NS_RELEASE(oldFile);  // always release our file ref, store has own</span>
<a href="#l79.539"></a><span id="l79.539">       }</span>
<a href="#l79.540"></a><span id="l79.540" class="difflineminus">-      if (NS_FAILED(ret))</span>
<a href="#l79.541"></a><span id="l79.541" class="difflineminus">-        ret = NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l79.542"></a><span id="l79.542" class="difflineplus">+      if (NS_FAILED(ret)) ret = NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l79.543"></a><span id="l79.543">     }</span>
<a href="#l79.544"></a><span id="l79.544"> </span>
<a href="#l79.545"></a><span id="l79.545" class="difflineminus">-    if (NS_SUCCEEDED(ret) &amp;&amp; thumb)</span>
<a href="#l79.546"></a><span id="l79.546" class="difflineminus">-    {</span>
<a href="#l79.547"></a><span id="l79.547" class="difflineminus">-      mdb_count outTotal;    // total somethings to do in operation</span>
<a href="#l79.548"></a><span id="l79.548" class="difflineminus">-      mdb_count outCurrent;  // subportion of total completed so far</span>
<a href="#l79.549"></a><span id="l79.549" class="difflineminus">-      mdb_bool outDone = false;      // is operation finished?</span>
<a href="#l79.550"></a><span id="l79.550" class="difflineminus">-      mdb_bool outBroken;     // is operation irreparably dead and broken?</span>
<a href="#l79.551"></a><span id="l79.551" class="difflineminus">-      do</span>
<a href="#l79.552"></a><span id="l79.552" class="difflineminus">-      {</span>
<a href="#l79.553"></a><span id="l79.553" class="difflineminus">-        ret = thumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone, &amp;outBroken);</span>
<a href="#l79.554"></a><span id="l79.554" class="difflineminus">-        if (NS_FAILED(ret))</span>
<a href="#l79.555"></a><span id="l79.555" class="difflineminus">-        {</span>
<a href="#l79.556"></a><span id="l79.556" class="difflineplus">+    if (NS_SUCCEEDED(ret) &amp;&amp; thumb) {</span>
<a href="#l79.557"></a><span id="l79.557" class="difflineplus">+      mdb_count outTotal;        // total somethings to do in operation</span>
<a href="#l79.558"></a><span id="l79.558" class="difflineplus">+      mdb_count outCurrent;      // subportion of total completed so far</span>
<a href="#l79.559"></a><span id="l79.559" class="difflineplus">+      mdb_bool outDone = false;  // is operation finished?</span>
<a href="#l79.560"></a><span id="l79.560" class="difflineplus">+      mdb_bool outBroken;        // is operation irreparably dead and broken?</span>
<a href="#l79.561"></a><span id="l79.561" class="difflineplus">+      do {</span>
<a href="#l79.562"></a><span id="l79.562" class="difflineplus">+        ret = thumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone,</span>
<a href="#l79.563"></a><span id="l79.563" class="difflineplus">+                            &amp;outBroken);</span>
<a href="#l79.564"></a><span id="l79.564" class="difflineplus">+        if (NS_FAILED(ret)) {</span>
<a href="#l79.565"></a><span id="l79.565">           outDone = true;</span>
<a href="#l79.566"></a><span id="l79.566">           break;</span>
<a href="#l79.567"></a><span id="l79.567">         }</span>
<a href="#l79.568"></a><span id="l79.568" class="difflineminus">-      }</span>
<a href="#l79.569"></a><span id="l79.569" class="difflineminus">-      while (NS_SUCCEEDED(ret) &amp;&amp; !outBroken &amp;&amp; !outDone);</span>
<a href="#l79.570"></a><span id="l79.570" class="difflineminus">-      if (NS_SUCCEEDED(ret) &amp;&amp; outDone)</span>
<a href="#l79.571"></a><span id="l79.571" class="difflineminus">-      {</span>
<a href="#l79.572"></a><span id="l79.572" class="difflineplus">+      } while (NS_SUCCEEDED(ret) &amp;&amp; !outBroken &amp;&amp; !outDone);</span>
<a href="#l79.573"></a><span id="l79.573" class="difflineplus">+      if (NS_SUCCEEDED(ret) &amp;&amp; outDone) {</span>
<a href="#l79.574"></a><span id="l79.574">         ret = mdbFactory-&gt;ThumbToOpenStore(m_mdbEnv, thumb, &amp;m_mdbStore);</span>
<a href="#l79.575"></a><span id="l79.575" class="difflineminus">-        if (NS_SUCCEEDED(ret) &amp;&amp; m_mdbStore)</span>
<a href="#l79.576"></a><span id="l79.576" class="difflineminus">-        {</span>
<a href="#l79.577"></a><span id="l79.577" class="difflineplus">+        if (NS_SUCCEEDED(ret) &amp;&amp; m_mdbStore) {</span>
<a href="#l79.578"></a><span id="l79.578">           ret = InitExistingDB();</span>
<a href="#l79.579"></a><span id="l79.579">           create = false;</span>
<a href="#l79.580"></a><span id="l79.580">         }</span>
<a href="#l79.581"></a><span id="l79.581">       }</span>
<a href="#l79.582"></a><span id="l79.582" class="difflineminus">-    }</span>
<a href="#l79.583"></a><span id="l79.583" class="difflineminus">-    else if (create &amp;&amp; ret != NS_ERROR_FILE_ACCESS_DENIED)</span>
<a href="#l79.584"></a><span id="l79.584" class="difflineminus">-    {</span>
<a href="#l79.585"></a><span id="l79.585" class="difflineminus">-      nsIMdbFile* newFile = 0;</span>
<a href="#l79.586"></a><span id="l79.586" class="difflineminus">-      ret = mdbFactory-&gt;CreateNewFile(m_mdbEnv, dbHeap, filePath.get(), &amp;newFile);</span>
<a href="#l79.587"></a><span id="l79.587" class="difflineminus">-      if ( newFile )</span>
<a href="#l79.588"></a><span id="l79.588" class="difflineminus">-      {</span>
<a href="#l79.589"></a><span id="l79.589" class="difflineminus">-        if (NS_SUCCEEDED(ret))</span>
<a href="#l79.590"></a><span id="l79.590" class="difflineminus">-        {</span>
<a href="#l79.591"></a><span id="l79.591" class="difflineplus">+    } else if (create &amp;&amp; ret != NS_ERROR_FILE_ACCESS_DENIED) {</span>
<a href="#l79.592"></a><span id="l79.592" class="difflineplus">+      nsIMdbFile *newFile = 0;</span>
<a href="#l79.593"></a><span id="l79.593" class="difflineplus">+      ret =</span>
<a href="#l79.594"></a><span id="l79.594" class="difflineplus">+          mdbFactory-&gt;CreateNewFile(m_mdbEnv, dbHeap, filePath.get(), &amp;newFile);</span>
<a href="#l79.595"></a><span id="l79.595" class="difflineplus">+      if (newFile) {</span>
<a href="#l79.596"></a><span id="l79.596" class="difflineplus">+        if (NS_SUCCEEDED(ret)) {</span>
<a href="#l79.597"></a><span id="l79.597">           mdbOpenPolicy inOpenPolicy;</span>
<a href="#l79.598"></a><span id="l79.598"> </span>
<a href="#l79.599"></a><span id="l79.599">           inOpenPolicy.mOpenPolicy_ScopePlan.mScopeStringSet_Count = 0;</span>
<a href="#l79.600"></a><span id="l79.600">           inOpenPolicy.mOpenPolicy_MinMemory = 0;</span>
<a href="#l79.601"></a><span id="l79.601">           inOpenPolicy.mOpenPolicy_MaxLazy = 0;</span>
<a href="#l79.602"></a><span id="l79.602"> </span>
<a href="#l79.603"></a><span id="l79.603" class="difflineminus">-          ret = mdbFactory-&gt;CreateNewFileStore(m_mdbEnv, dbHeap,</span>
<a href="#l79.604"></a><span id="l79.604" class="difflineminus">-                                               newFile, &amp;inOpenPolicy,</span>
<a href="#l79.605"></a><span id="l79.605" class="difflineminus">-                                               &amp;m_mdbStore);</span>
<a href="#l79.606"></a><span id="l79.606" class="difflineminus">-          if (NS_SUCCEEDED(ret))</span>
<a href="#l79.607"></a><span id="l79.607" class="difflineminus">-            ret = InitNewDB();</span>
<a href="#l79.608"></a><span id="l79.608" class="difflineplus">+          ret = mdbFactory-&gt;CreateNewFileStore(m_mdbEnv, dbHeap, newFile,</span>
<a href="#l79.609"></a><span id="l79.609" class="difflineplus">+                                               &amp;inOpenPolicy, &amp;m_mdbStore);</span>
<a href="#l79.610"></a><span id="l79.610" class="difflineplus">+          if (NS_SUCCEEDED(ret)) ret = InitNewDB();</span>
<a href="#l79.611"></a><span id="l79.611">         }</span>
<a href="#l79.612"></a><span id="l79.612" class="difflineminus">-        NS_RELEASE(newFile); // always release our file ref, store has own</span>
<a href="#l79.613"></a><span id="l79.613" class="difflineplus">+        NS_RELEASE(newFile);  // always release our file ref, store has own</span>
<a href="#l79.614"></a><span id="l79.614">       }</span>
<a href="#l79.615"></a><span id="l79.615">     }</span>
<a href="#l79.616"></a><span id="l79.616">     NS_IF_RELEASE(thumb);</span>
<a href="#l79.617"></a><span id="l79.617">   }</span>
<a href="#l79.618"></a><span id="l79.618">   return ret;</span>
<a href="#l79.619"></a><span id="l79.619"> }</span>
<a href="#l79.620"></a><span id="l79.620"> </span>
<a href="#l79.621"></a><span id="l79.621" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::CloseMDB(bool commit)</span>
<a href="#l79.622"></a><span id="l79.622" class="difflineminus">-{</span>
<a href="#l79.623"></a><span id="l79.623" class="difflineminus">-  if (commit)</span>
<a href="#l79.624"></a><span id="l79.624" class="difflineminus">-    Commit(nsAddrDBCommitType::kSessionCommit);</span>
<a href="#l79.625"></a><span id="l79.625" class="difflineminus">-//???    RemoveFromCache(this);  // if we've closed it, better not leave it in the cache.</span>
<a href="#l79.626"></a><span id="l79.626" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::CloseMDB(bool commit) {</span>
<a href="#l79.627"></a><span id="l79.627" class="difflineplus">+  if (commit) Commit(nsAddrDBCommitType::kSessionCommit);</span>
<a href="#l79.628"></a><span id="l79.628" class="difflineplus">+  //???    RemoveFromCache(this);  // if we've closed it, better not leave it in</span>
<a href="#l79.629"></a><span id="l79.629" class="difflineplus">+  // the cache.</span>
<a href="#l79.630"></a><span id="l79.630">   return NS_OK;</span>
<a href="#l79.631"></a><span id="l79.631"> }</span>
<a href="#l79.632"></a><span id="l79.632"> </span>
<a href="#l79.633"></a><span id="l79.633"> // force the database to close - this'll flush out anybody holding onto</span>
<a href="#l79.634"></a><span id="l79.634"> // a database without having a listener!</span>
<a href="#l79.635"></a><span id="l79.635" class="difflineminus">-// This is evil in the com world, but there are times we need to delete the file.</span>
<a href="#l79.636"></a><span id="l79.636" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::ForceClosed()</span>
<a href="#l79.637"></a><span id="l79.637" class="difflineminus">-{</span>
<a href="#l79.638"></a><span id="l79.638" class="difflineplus">+// This is evil in the com world, but there are times we need to delete the</span>
<a href="#l79.639"></a><span id="l79.639" class="difflineplus">+// file.</span>
<a href="#l79.640"></a><span id="l79.640" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::ForceClosed() {</span>
<a href="#l79.641"></a><span id="l79.641">   nsresult err = NS_OK;</span>
<a href="#l79.642"></a><span id="l79.642"> </span>
<a href="#l79.643"></a><span id="l79.643" class="difflineminus">-  // make sure someone has a reference so object won't get deleted out from under us.</span>
<a href="#l79.644"></a><span id="l79.644" class="difflineplus">+  // make sure someone has a reference so object won't get deleted out from</span>
<a href="#l79.645"></a><span id="l79.645" class="difflineplus">+  // under us.</span>
<a href="#l79.646"></a><span id="l79.646">   NS_ADDREF_THIS();</span>
<a href="#l79.647"></a><span id="l79.647">   NotifyAnnouncerGoingAway();</span>
<a href="#l79.648"></a><span id="l79.648">   // OK, remove from cache first and close the store.</span>
<a href="#l79.649"></a><span id="l79.649">   RemoveFromCache(this);</span>
<a href="#l79.650"></a><span id="l79.650"> </span>
<a href="#l79.651"></a><span id="l79.651" class="difflineminus">-  err = CloseMDB(false);    // since we're about to delete it, no need to commit.</span>
<a href="#l79.652"></a><span id="l79.652" class="difflineplus">+  err = CloseMDB(false);  // since we're about to delete it, no need to commit.</span>
<a href="#l79.653"></a><span id="l79.653">   NS_IF_RELEASE(m_mdbStore);</span>
<a href="#l79.654"></a><span id="l79.654">   NS_RELEASE_THIS();</span>
<a href="#l79.655"></a><span id="l79.655">   return err;</span>
<a href="#l79.656"></a><span id="l79.656"> }</span>
<a href="#l79.657"></a><span id="l79.657"> </span>
<a href="#l79.658"></a><span id="l79.658" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::Commit(uint32_t commitType)</span>
<a href="#l79.659"></a><span id="l79.659" class="difflineminus">-{</span>
<a href="#l79.660"></a><span id="l79.660" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::Commit(uint32_t commitType) {</span>
<a href="#l79.661"></a><span id="l79.661">   nsresult err = NS_OK;</span>
<a href="#l79.662"></a><span id="l79.662">   nsIMdbThumb *commitThumb = nullptr;</span>
<a href="#l79.663"></a><span id="l79.663"> </span>
<a href="#l79.664"></a><span id="l79.664">   if (commitType == nsAddrDBCommitType::kLargeCommit ||</span>
<a href="#l79.665"></a><span id="l79.665" class="difflineminus">-      commitType == nsAddrDBCommitType::kSessionCommit)</span>
<a href="#l79.666"></a><span id="l79.666" class="difflineminus">-  {</span>
<a href="#l79.667"></a><span id="l79.667" class="difflineplus">+      commitType == nsAddrDBCommitType::kSessionCommit) {</span>
<a href="#l79.668"></a><span id="l79.668">     mdb_percent outActualWaste = 0;</span>
<a href="#l79.669"></a><span id="l79.669">     mdb_bool outShould;</span>
<a href="#l79.670"></a><span id="l79.670" class="difflineminus">-    if (m_mdbStore &amp;&amp; m_mdbEnv)</span>
<a href="#l79.671"></a><span id="l79.671" class="difflineminus">-    {</span>
<a href="#l79.672"></a><span id="l79.672" class="difflineplus">+    if (m_mdbStore &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.673"></a><span id="l79.673">       // check how much space would be saved by doing a compress commit.</span>
<a href="#l79.674"></a><span id="l79.674">       // If it's more than 30%, go for it.</span>
<a href="#l79.675"></a><span id="l79.675">       // N.B. - I'm not sure this calls works in Mork for all cases.</span>
<a href="#l79.676"></a><span id="l79.676" class="difflineminus">-      err = m_mdbStore-&gt;ShouldCompress(m_mdbEnv, 30, &amp;outActualWaste, &amp;outShould);</span>
<a href="#l79.677"></a><span id="l79.677" class="difflineminus">-      if (NS_SUCCEEDED(err) &amp;&amp; outShould)</span>
<a href="#l79.678"></a><span id="l79.678" class="difflineminus">-      {</span>
<a href="#l79.679"></a><span id="l79.679" class="difflineplus">+      err =</span>
<a href="#l79.680"></a><span id="l79.680" class="difflineplus">+          m_mdbStore-&gt;ShouldCompress(m_mdbEnv, 30, &amp;outActualWaste, &amp;outShould);</span>
<a href="#l79.681"></a><span id="l79.681" class="difflineplus">+      if (NS_SUCCEEDED(err) &amp;&amp; outShould) {</span>
<a href="#l79.682"></a><span id="l79.682">         commitType = nsAddrDBCommitType::kCompressCommit;</span>
<a href="#l79.683"></a><span id="l79.683">       }</span>
<a href="#l79.684"></a><span id="l79.684">     }</span>
<a href="#l79.685"></a><span id="l79.685">   }</span>
<a href="#l79.686"></a><span id="l79.686"> </span>
<a href="#l79.687"></a><span id="l79.687" class="difflineminus">-  if (m_mdbStore &amp;&amp; m_mdbEnv)</span>
<a href="#l79.688"></a><span id="l79.688" class="difflineminus">-  {</span>
<a href="#l79.689"></a><span id="l79.689" class="difflineminus">-    switch (commitType)</span>
<a href="#l79.690"></a><span id="l79.690" class="difflineminus">-    {</span>
<a href="#l79.691"></a><span id="l79.691" class="difflineplus">+  if (m_mdbStore &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.692"></a><span id="l79.692" class="difflineplus">+    switch (commitType) {</span>
<a href="#l79.693"></a><span id="l79.693">       case nsAddrDBCommitType::kLargeCommit:</span>
<a href="#l79.694"></a><span id="l79.694">         err = m_mdbStore-&gt;LargeCommit(m_mdbEnv, &amp;commitThumb);</span>
<a href="#l79.695"></a><span id="l79.695">         break;</span>
<a href="#l79.696"></a><span id="l79.696">       case nsAddrDBCommitType::kSessionCommit:</span>
<a href="#l79.697"></a><span id="l79.697">         // comment out until persistence works.</span>
<a href="#l79.698"></a><span id="l79.698">         err = m_mdbStore-&gt;SessionCommit(m_mdbEnv, &amp;commitThumb);</span>
<a href="#l79.699"></a><span id="l79.699">         break;</span>
<a href="#l79.700"></a><span id="l79.700">       case nsAddrDBCommitType::kCompressCommit:</span>
<a href="#l79.701"></a><span id="l79.701">         err = m_mdbStore-&gt;CompressCommit(m_mdbEnv, &amp;commitThumb);</span>
<a href="#l79.702"></a><span id="l79.702">         break;</span>
<a href="#l79.703"></a><span id="l79.703" class="difflineminus">-      }</span>
<a href="#l79.704"></a><span id="l79.704" class="difflineplus">+    }</span>
<a href="#l79.705"></a><span id="l79.705">   }</span>
<a href="#l79.706"></a><span id="l79.706" class="difflineminus">-  if (commitThumb &amp;&amp; m_mdbEnv)</span>
<a href="#l79.707"></a><span id="l79.707" class="difflineminus">-  {</span>
<a href="#l79.708"></a><span id="l79.708" class="difflineminus">-    mdb_count outTotal = 0;    // total somethings to do in operation</span>
<a href="#l79.709"></a><span id="l79.709" class="difflineminus">-    mdb_count outCurrent = 0;  // subportion of total completed so far</span>
<a href="#l79.710"></a><span id="l79.710" class="difflineminus">-    mdb_bool outDone = false;      // is operation finished?</span>
<a href="#l79.711"></a><span id="l79.711" class="difflineminus">-    mdb_bool outBroken = false;     // is operation irreparably dead and broken?</span>
<a href="#l79.712"></a><span id="l79.712" class="difflineminus">-    while (!outDone &amp;&amp; !outBroken &amp;&amp; NS_SUCCEEDED(err))</span>
<a href="#l79.713"></a><span id="l79.713" class="difflineminus">-    {</span>
<a href="#l79.714"></a><span id="l79.714" class="difflineminus">-      err = commitThumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone, &amp;outBroken);</span>
<a href="#l79.715"></a><span id="l79.715" class="difflineplus">+  if (commitThumb &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.716"></a><span id="l79.716" class="difflineplus">+    mdb_count outTotal = 0;      // total somethings to do in operation</span>
<a href="#l79.717"></a><span id="l79.717" class="difflineplus">+    mdb_count outCurrent = 0;    // subportion of total completed so far</span>
<a href="#l79.718"></a><span id="l79.718" class="difflineplus">+    mdb_bool outDone = false;    // is operation finished?</span>
<a href="#l79.719"></a><span id="l79.719" class="difflineplus">+    mdb_bool outBroken = false;  // is operation irreparably dead and broken?</span>
<a href="#l79.720"></a><span id="l79.720" class="difflineplus">+    while (!outDone &amp;&amp; !outBroken &amp;&amp; NS_SUCCEEDED(err)) {</span>
<a href="#l79.721"></a><span id="l79.721" class="difflineplus">+      err = commitThumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone,</span>
<a href="#l79.722"></a><span id="l79.722" class="difflineplus">+                                &amp;outBroken);</span>
<a href="#l79.723"></a><span id="l79.723">     }</span>
<a href="#l79.724"></a><span id="l79.724">     NS_RELEASE(commitThumb);</span>
<a href="#l79.725"></a><span id="l79.725">   }</span>
<a href="#l79.726"></a><span id="l79.726" class="difflineminus">-  // ### do something with error, but clear it now because mork errors out on commits.</span>
<a href="#l79.727"></a><span id="l79.727" class="difflineminus">-  if (m_mdbEnv)</span>
<a href="#l79.728"></a><span id="l79.728" class="difflineminus">-    m_mdbEnv-&gt;ClearErrors();</span>
<a href="#l79.729"></a><span id="l79.729" class="difflineplus">+  // ### do something with error, but clear it now because mork errors out on</span>
<a href="#l79.730"></a><span id="l79.730" class="difflineplus">+  // commits.</span>
<a href="#l79.731"></a><span id="l79.731" class="difflineplus">+  if (m_mdbEnv) m_mdbEnv-&gt;ClearErrors();</span>
<a href="#l79.732"></a><span id="l79.732">   return err;</span>
<a href="#l79.733"></a><span id="l79.733"> }</span>
<a href="#l79.734"></a><span id="l79.734"> </span>
<a href="#l79.735"></a><span id="l79.735" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::Close(bool forceCommit /* = TRUE */)</span>
<a href="#l79.736"></a><span id="l79.736" class="difflineminus">-{</span>
<a href="#l79.737"></a><span id="l79.737" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::Close(bool forceCommit /* = TRUE */) {</span>
<a href="#l79.738"></a><span id="l79.738">   return CloseMDB(forceCommit);</span>
<a href="#l79.739"></a><span id="l79.739"> }</span>
<a href="#l79.740"></a><span id="l79.740"> </span>
<a href="#l79.741"></a><span id="l79.741"> // set up empty tablesetc.</span>
<a href="#l79.742"></a><span id="l79.742" class="difflineminus">-nsresult nsAddrDatabase::InitNewDB()</span>
<a href="#l79.743"></a><span id="l79.743" class="difflineminus">-{</span>
<a href="#l79.744"></a><span id="l79.744" class="difflineplus">+nsresult nsAddrDatabase::InitNewDB() {</span>
<a href="#l79.745"></a><span id="l79.745">   nsresult err = InitMDBInfo();</span>
<a href="#l79.746"></a><span id="l79.746" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l79.747"></a><span id="l79.747" class="difflineminus">-  {</span>
<a href="#l79.748"></a><span id="l79.748" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l79.749"></a><span id="l79.749">     err = InitPabTable();</span>
<a href="#l79.750"></a><span id="l79.750">     err = InitLastRecorKey();</span>
<a href="#l79.751"></a><span id="l79.751">     Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l79.752"></a><span id="l79.752">   }</span>
<a href="#l79.753"></a><span id="l79.753">   return err;</span>
<a href="#l79.754"></a><span id="l79.754"> }</span>
<a href="#l79.755"></a><span id="l79.755"> </span>
<a href="#l79.756"></a><span id="l79.756" class="difflineminus">-nsresult nsAddrDatabase::InitPabTable()</span>
<a href="#l79.757"></a><span id="l79.757" class="difflineminus">-{</span>
<a href="#l79.758"></a><span id="l79.758" class="difflineminus">-  return m_mdbStore &amp;&amp; m_mdbEnv ? m_mdbStore-&gt;NewTableWithOid(m_mdbEnv,</span>
<a href="#l79.759"></a><span id="l79.759" class="difflineminus">-                                                  &amp;gAddressBookTableOID,</span>
<a href="#l79.760"></a><span id="l79.760" class="difflineminus">-                                                  m_PabTableKind,</span>
<a href="#l79.761"></a><span id="l79.761" class="difflineminus">-                                                  false,</span>
<a href="#l79.762"></a><span id="l79.762" class="difflineminus">-                                                  (const mdbOid*)nullptr,</span>
<a href="#l79.763"></a><span id="l79.763" class="difflineminus">-                                                  &amp;m_mdbPabTable)</span>
<a href="#l79.764"></a><span id="l79.764" class="difflineminus">-                                : NS_ERROR_NULL_POINTER;</span>
<a href="#l79.765"></a><span id="l79.765" class="difflineplus">+nsresult nsAddrDatabase::InitPabTable() {</span>
<a href="#l79.766"></a><span id="l79.766" class="difflineplus">+  return m_mdbStore &amp;&amp; m_mdbEnv</span>
<a href="#l79.767"></a><span id="l79.767" class="difflineplus">+             ? m_mdbStore-&gt;NewTableWithOid(</span>
<a href="#l79.768"></a><span id="l79.768" class="difflineplus">+                   m_mdbEnv, &amp;gAddressBookTableOID, m_PabTableKind, false,</span>
<a href="#l79.769"></a><span id="l79.769" class="difflineplus">+                   (const mdbOid *)nullptr, &amp;m_mdbPabTable)</span>
<a href="#l79.770"></a><span id="l79.770" class="difflineplus">+             : NS_ERROR_NULL_POINTER;</span>
<a href="#l79.771"></a><span id="l79.771"> }</span>
<a href="#l79.772"></a><span id="l79.772"> </span>
<a href="#l79.773"></a><span id="l79.773" class="difflineminus">-//save the last record number, store in m_DataRowScopeToken, row 1</span>
<a href="#l79.774"></a><span id="l79.774" class="difflineminus">-nsresult nsAddrDatabase::InitLastRecorKey()</span>
<a href="#l79.775"></a><span id="l79.775" class="difflineminus">-{</span>
<a href="#l79.776"></a><span id="l79.776" class="difflineminus">-  if (!m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.777"></a><span id="l79.777" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.778"></a><span id="l79.778" class="difflineplus">+// save the last record number, store in m_DataRowScopeToken, row 1</span>
<a href="#l79.779"></a><span id="l79.779" class="difflineplus">+nsresult nsAddrDatabase::InitLastRecorKey() {</span>
<a href="#l79.780"></a><span id="l79.780" class="difflineplus">+  if (!m_mdbPabTable || !m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.781"></a><span id="l79.781"> </span>
<a href="#l79.782"></a><span id="l79.782">   nsIMdbRow *pDataRow = nullptr;</span>
<a href="#l79.783"></a><span id="l79.783">   mdbOid dataRowOid;</span>
<a href="#l79.784"></a><span id="l79.784">   dataRowOid.mOid_Scope = m_DataRowScopeToken;</span>
<a href="#l79.785"></a><span id="l79.785">   dataRowOid.mOid_Id = DATAROW_ROWID;</span>
<a href="#l79.786"></a><span id="l79.786">   nsresult err = m_mdbStore-&gt;NewRowWithOid(m_mdbEnv, &amp;dataRowOid, &amp;pDataRow);</span>
<a href="#l79.787"></a><span id="l79.787"> </span>
<a href="#l79.788"></a><span id="l79.788" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; pDataRow)</span>
<a href="#l79.789"></a><span id="l79.789" class="difflineminus">-  {</span>
<a href="#l79.790"></a><span id="l79.790" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; pDataRow) {</span>
<a href="#l79.791"></a><span id="l79.791">     m_LastRecordKey = 0;</span>
<a href="#l79.792"></a><span id="l79.792">     err = AddIntColumn(pDataRow, m_LastRecordKeyColumnToken, 0);</span>
<a href="#l79.793"></a><span id="l79.793">     err = m_mdbPabTable-&gt;AddRow(m_mdbEnv, pDataRow);</span>
<a href="#l79.794"></a><span id="l79.794">     NS_RELEASE(pDataRow);</span>
<a href="#l79.795"></a><span id="l79.795">   }</span>
<a href="#l79.796"></a><span id="l79.796">   return err;</span>
<a href="#l79.797"></a><span id="l79.797"> }</span>
<a href="#l79.798"></a><span id="l79.798"> </span>
<a href="#l79.799"></a><span id="l79.799" class="difflineminus">-nsresult nsAddrDatabase::GetDataRow(nsIMdbRow **pDataRow)</span>
<a href="#l79.800"></a><span id="l79.800" class="difflineminus">-{</span>
<a href="#l79.801"></a><span id="l79.801" class="difflineminus">-  if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.802"></a><span id="l79.802" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.803"></a><span id="l79.803" class="difflineplus">+nsresult nsAddrDatabase::GetDataRow(nsIMdbRow **pDataRow) {</span>
<a href="#l79.804"></a><span id="l79.804" class="difflineplus">+  if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.805"></a><span id="l79.805"> </span>
<a href="#l79.806"></a><span id="l79.806">   nsIMdbRow *pRow = nullptr;</span>
<a href="#l79.807"></a><span id="l79.807">   mdbOid dataRowOid;</span>
<a href="#l79.808"></a><span id="l79.808">   dataRowOid.mOid_Scope = m_DataRowScopeToken;</span>
<a href="#l79.809"></a><span id="l79.809">   dataRowOid.mOid_Id = DATAROW_ROWID;</span>
<a href="#l79.810"></a><span id="l79.810">   m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;dataRowOid, &amp;pRow);</span>
<a href="#l79.811"></a><span id="l79.811">   *pDataRow = pRow;</span>
<a href="#l79.812"></a><span id="l79.812"> </span>
<a href="#l79.813"></a><span id="l79.813">   return pRow ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.814"></a><span id="l79.814"> }</span>
<a href="#l79.815"></a><span id="l79.815"> </span>
<a href="#l79.816"></a><span id="l79.816" class="difflineminus">-nsresult nsAddrDatabase::GetLastRecordKey()</span>
<a href="#l79.817"></a><span id="l79.817" class="difflineminus">-{</span>
<a href="#l79.818"></a><span id="l79.818" class="difflineminus">-  if (!m_mdbPabTable)</span>
<a href="#l79.819"></a><span id="l79.819" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.820"></a><span id="l79.820" class="difflineminus">-</span>
<a href="#l79.821"></a><span id="l79.821" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; pDataRow;</span>
<a href="#l79.822"></a><span id="l79.822" class="difflineplus">+nsresult nsAddrDatabase::GetLastRecordKey() {</span>
<a href="#l79.823"></a><span id="l79.823" class="difflineplus">+  if (!m_mdbPabTable) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.824"></a><span id="l79.824" class="difflineplus">+</span>
<a href="#l79.825"></a><span id="l79.825" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; pDataRow;</span>
<a href="#l79.826"></a><span id="l79.826">   nsresult err = GetDataRow(getter_AddRefs(pDataRow));</span>
<a href="#l79.827"></a><span id="l79.827"> </span>
<a href="#l79.828"></a><span id="l79.828" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; pDataRow)</span>
<a href="#l79.829"></a><span id="l79.829" class="difflineminus">-  {</span>
<a href="#l79.830"></a><span id="l79.830" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; pDataRow) {</span>
<a href="#l79.831"></a><span id="l79.831">     m_LastRecordKey = 0;</span>
<a href="#l79.832"></a><span id="l79.832" class="difflineminus">-    err = GetIntColumn(pDataRow, m_LastRecordKeyColumnToken, &amp;m_LastRecordKey, 0);</span>
<a href="#l79.833"></a><span id="l79.833" class="difflineminus">-    if (NS_FAILED(err))</span>
<a href="#l79.834"></a><span id="l79.834" class="difflineminus">-      err = NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l79.835"></a><span id="l79.835" class="difflineplus">+    err =</span>
<a href="#l79.836"></a><span id="l79.836" class="difflineplus">+        GetIntColumn(pDataRow, m_LastRecordKeyColumnToken, &amp;m_LastRecordKey, 0);</span>
<a href="#l79.837"></a><span id="l79.837" class="difflineplus">+    if (NS_FAILED(err)) err = NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l79.838"></a><span id="l79.838">     return NS_OK;</span>
<a href="#l79.839"></a><span id="l79.839">   }</span>
<a href="#l79.840"></a><span id="l79.840"> </span>
<a href="#l79.841"></a><span id="l79.841">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l79.842"></a><span id="l79.842"> }</span>
<a href="#l79.843"></a><span id="l79.843"> </span>
<a href="#l79.844"></a><span id="l79.844" class="difflineminus">-nsresult nsAddrDatabase::UpdateLastRecordKey()</span>
<a href="#l79.845"></a><span id="l79.845" class="difflineminus">-{</span>
<a href="#l79.846"></a><span id="l79.846" class="difflineminus">-  if (!m_mdbPabTable || !m_mdbEnv)</span>
<a href="#l79.847"></a><span id="l79.847" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.848"></a><span id="l79.848" class="difflineminus">-</span>
<a href="#l79.849"></a><span id="l79.849" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; pDataRow;</span>
<a href="#l79.850"></a><span id="l79.850" class="difflineplus">+nsresult nsAddrDatabase::UpdateLastRecordKey() {</span>
<a href="#l79.851"></a><span id="l79.851" class="difflineplus">+  if (!m_mdbPabTable || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.852"></a><span id="l79.852" class="difflineplus">+</span>
<a href="#l79.853"></a><span id="l79.853" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; pDataRow;</span>
<a href="#l79.854"></a><span id="l79.854">   nsresult err = GetDataRow(getter_AddRefs(pDataRow));</span>
<a href="#l79.855"></a><span id="l79.855"> </span>
<a href="#l79.856"></a><span id="l79.856" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; pDataRow)</span>
<a href="#l79.857"></a><span id="l79.857" class="difflineminus">-  {</span>
<a href="#l79.858"></a><span id="l79.858" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; pDataRow) {</span>
<a href="#l79.859"></a><span id="l79.859">     err = AddIntColumn(pDataRow, m_LastRecordKeyColumnToken, m_LastRecordKey);</span>
<a href="#l79.860"></a><span id="l79.860">     err = m_mdbPabTable-&gt;AddRow(m_mdbEnv, pDataRow);</span>
<a href="#l79.861"></a><span id="l79.861">     return NS_OK;</span>
<a href="#l79.862"></a><span id="l79.862" class="difflineminus">-  }</span>
<a href="#l79.863"></a><span id="l79.863" class="difflineminus">-  else if (!pDataRow)</span>
<a href="#l79.864"></a><span id="l79.864" class="difflineplus">+  } else if (!pDataRow)</span>
<a href="#l79.865"></a><span id="l79.865">     err = InitLastRecorKey();</span>
<a href="#l79.866"></a><span id="l79.866">   else</span>
<a href="#l79.867"></a><span id="l79.867">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l79.868"></a><span id="l79.868">   return err;</span>
<a href="#l79.869"></a><span id="l79.869"> }</span>
<a href="#l79.870"></a><span id="l79.870"> </span>
<a href="#l79.871"></a><span id="l79.871" class="difflineminus">-nsresult nsAddrDatabase::InitExistingDB()</span>
<a href="#l79.872"></a><span id="l79.872" class="difflineminus">-{</span>
<a href="#l79.873"></a><span id="l79.873" class="difflineplus">+nsresult nsAddrDatabase::InitExistingDB() {</span>
<a href="#l79.874"></a><span id="l79.874">   nsresult err = InitMDBInfo();</span>
<a href="#l79.875"></a><span id="l79.875" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l79.876"></a><span id="l79.876" class="difflineminus">-  {</span>
<a href="#l79.877"></a><span id="l79.877" class="difflineminus">-    if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.878"></a><span id="l79.878" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.879"></a><span id="l79.879" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l79.880"></a><span id="l79.880" class="difflineplus">+    if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.881"></a><span id="l79.881"> </span>
<a href="#l79.882"></a><span id="l79.882">     err = m_mdbStore-&gt;GetTable(m_mdbEnv, &amp;gAddressBookTableOID, &amp;m_mdbPabTable);</span>
<a href="#l79.883"></a><span id="l79.883" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; m_mdbPabTable)</span>
<a href="#l79.884"></a><span id="l79.884" class="difflineminus">-    {</span>
<a href="#l79.885"></a><span id="l79.885" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; m_mdbPabTable) {</span>
<a href="#l79.886"></a><span id="l79.886">       err = GetLastRecordKey();</span>
<a href="#l79.887"></a><span id="l79.887" class="difflineminus">-      if (err == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l79.888"></a><span id="l79.888" class="difflineminus">-        CheckAndUpdateRecordKey();</span>
<a href="#l79.889"></a><span id="l79.889" class="difflineplus">+      if (err == NS_ERROR_NOT_AVAILABLE) CheckAndUpdateRecordKey();</span>
<a href="#l79.890"></a><span id="l79.890">       UpdateLowercaseEmailListName();</span>
<a href="#l79.891"></a><span id="l79.891">     }</span>
<a href="#l79.892"></a><span id="l79.892">   }</span>
<a href="#l79.893"></a><span id="l79.893">   return err;</span>
<a href="#l79.894"></a><span id="l79.894"> }</span>
<a href="#l79.895"></a><span id="l79.895"> </span>
<a href="#l79.896"></a><span id="l79.896" class="difflineminus">-nsresult nsAddrDatabase::CheckAndUpdateRecordKey()</span>
<a href="#l79.897"></a><span id="l79.897" class="difflineminus">-{</span>
<a href="#l79.898"></a><span id="l79.898" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.899"></a><span id="l79.899" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.900"></a><span id="l79.900" class="difflineplus">+nsresult nsAddrDatabase::CheckAndUpdateRecordKey() {</span>
<a href="#l79.901"></a><span id="l79.901" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.902"></a><span id="l79.902"> </span>
<a href="#l79.903"></a><span id="l79.903">   nsresult err = NS_OK;</span>
<a href="#l79.904"></a><span id="l79.904" class="difflineminus">-  nsIMdbTableRowCursor* rowCursor = nullptr;</span>
<a href="#l79.905"></a><span id="l79.905" class="difflineminus">-  nsIMdbRow* findRow = nullptr;</span>
<a href="#l79.906"></a><span id="l79.906" class="difflineminus">-  mdb_pos    rowPos = 0;</span>
<a href="#l79.907"></a><span id="l79.907" class="difflineplus">+  nsIMdbTableRowCursor *rowCursor = nullptr;</span>
<a href="#l79.908"></a><span id="l79.908" class="difflineplus">+  nsIMdbRow *findRow = nullptr;</span>
<a href="#l79.909"></a><span id="l79.909" class="difflineplus">+  mdb_pos rowPos = 0;</span>
<a href="#l79.910"></a><span id="l79.910"> </span>
<a href="#l79.911"></a><span id="l79.911">   nsresult merror = m_mdbPabTable-&gt;GetTableRowCursor(m_mdbEnv, -1, &amp;rowCursor);</span>
<a href="#l79.912"></a><span id="l79.912"> </span>
<a href="#l79.913"></a><span id="l79.913">   NS_ENSURE_TRUE(NS_SUCCEEDED(merror) &amp;&amp; rowCursor, NS_ERROR_FAILURE);</span>
<a href="#l79.914"></a><span id="l79.914"> </span>
<a href="#l79.915"></a><span id="l79.915" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; pDataRow;</span>
<a href="#l79.916"></a><span id="l79.916" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; pDataRow;</span>
<a href="#l79.917"></a><span id="l79.917">   err = GetDataRow(getter_AddRefs(pDataRow));</span>
<a href="#l79.918"></a><span id="l79.918" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l79.919"></a><span id="l79.919" class="difflineminus">-    InitLastRecorKey();</span>
<a href="#l79.920"></a><span id="l79.920" class="difflineminus">-</span>
<a href="#l79.921"></a><span id="l79.921" class="difflineminus">-  do</span>
<a href="#l79.922"></a><span id="l79.922" class="difflineminus">-  {  //add key to each card and mailing list row</span>
<a href="#l79.923"></a><span id="l79.923" class="difflineplus">+  if (NS_FAILED(err)) InitLastRecorKey();</span>
<a href="#l79.924"></a><span id="l79.924" class="difflineplus">+</span>
<a href="#l79.925"></a><span id="l79.925" class="difflineplus">+  do {  // add key to each card and mailing list row</span>
<a href="#l79.926"></a><span id="l79.926">     merror = rowCursor-&gt;NextRow(m_mdbEnv, &amp;findRow, &amp;rowPos);</span>
<a href="#l79.927"></a><span id="l79.927" class="difflineminus">-    if (NS_SUCCEEDED(merror) &amp;&amp; findRow)</span>
<a href="#l79.928"></a><span id="l79.928" class="difflineminus">-    {</span>
<a href="#l79.929"></a><span id="l79.929" class="difflineplus">+    if (NS_SUCCEEDED(merror) &amp;&amp; findRow) {</span>
<a href="#l79.930"></a><span id="l79.930">       mdbOid rowOid;</span>
<a href="#l79.931"></a><span id="l79.931"> </span>
<a href="#l79.932"></a><span id="l79.932" class="difflineminus">-      if (NS_SUCCEEDED(findRow-&gt;GetOid(m_mdbEnv, &amp;rowOid)))</span>
<a href="#l79.933"></a><span id="l79.933" class="difflineminus">-      {</span>
<a href="#l79.934"></a><span id="l79.934" class="difflineminus">-        if (!IsDataRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.935"></a><span id="l79.935" class="difflineminus">-        {</span>
<a href="#l79.936"></a><span id="l79.936" class="difflineplus">+      if (NS_SUCCEEDED(findRow-&gt;GetOid(m_mdbEnv, &amp;rowOid))) {</span>
<a href="#l79.937"></a><span id="l79.937" class="difflineplus">+        if (!IsDataRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.938"></a><span id="l79.938">           m_LastRecordKey++;</span>
<a href="#l79.939"></a><span id="l79.939">           err = AddIntColumn(findRow, m_RecordKeyColumnToken, m_LastRecordKey);</span>
<a href="#l79.940"></a><span id="l79.940">         }</span>
<a href="#l79.941"></a><span id="l79.941">       }</span>
<a href="#l79.942"></a><span id="l79.942">     }</span>
<a href="#l79.943"></a><span id="l79.943">   } while (findRow);</span>
<a href="#l79.944"></a><span id="l79.944"> </span>
<a href="#l79.945"></a><span id="l79.945">   UpdateLastRecordKey();</span>
<a href="#l79.946"></a><span id="l79.946">   Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l79.947"></a><span id="l79.947">   return NS_OK;</span>
<a href="#l79.948"></a><span id="l79.948"> }</span>
<a href="#l79.949"></a><span id="l79.949"> </span>
<a href="#l79.950"></a><span id="l79.950" class="difflineminus">-nsresult nsAddrDatabase::UpdateLowercaseEmailListName()</span>
<a href="#l79.951"></a><span id="l79.951" class="difflineminus">-{</span>
<a href="#l79.952"></a><span id="l79.952" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.953"></a><span id="l79.953" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.954"></a><span id="l79.954" class="difflineplus">+nsresult nsAddrDatabase::UpdateLowercaseEmailListName() {</span>
<a href="#l79.955"></a><span id="l79.955" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.956"></a><span id="l79.956"> </span>
<a href="#l79.957"></a><span id="l79.957">   nsresult err = NS_OK;</span>
<a href="#l79.958"></a><span id="l79.958" class="difflineminus">-  nsIMdbTableRowCursor* rowCursor = nullptr;</span>
<a href="#l79.959"></a><span id="l79.959" class="difflineminus">-  nsIMdbRow* findRow = nullptr;</span>
<a href="#l79.960"></a><span id="l79.960" class="difflineminus">-  mdb_pos    rowPos = 0;</span>
<a href="#l79.961"></a><span id="l79.961" class="difflineplus">+  nsIMdbTableRowCursor *rowCursor = nullptr;</span>
<a href="#l79.962"></a><span id="l79.962" class="difflineplus">+  nsIMdbRow *findRow = nullptr;</span>
<a href="#l79.963"></a><span id="l79.963" class="difflineplus">+  mdb_pos rowPos = 0;</span>
<a href="#l79.964"></a><span id="l79.964">   bool commitRequired = false;</span>
<a href="#l79.965"></a><span id="l79.965"> </span>
<a href="#l79.966"></a><span id="l79.966">   nsresult merror = m_mdbPabTable-&gt;GetTableRowCursor(m_mdbEnv, -1, &amp;rowCursor);</span>
<a href="#l79.967"></a><span id="l79.967"> </span>
<a href="#l79.968"></a><span id="l79.968">   NS_ENSURE_TRUE(NS_SUCCEEDED(merror) &amp;&amp; rowCursor, NS_ERROR_FAILURE);</span>
<a href="#l79.969"></a><span id="l79.969"> </span>
<a href="#l79.970"></a><span id="l79.970" class="difflineminus">-  do</span>
<a href="#l79.971"></a><span id="l79.971" class="difflineminus">-  { // Add lowercase primary+secondary email to each card and mailing list row.</span>
<a href="#l79.972"></a><span id="l79.972" class="difflineplus">+  do {  // Add lowercase primary+secondary email to each card and mailing list</span>
<a href="#l79.973"></a><span id="l79.973" class="difflineplus">+        // row.</span>
<a href="#l79.974"></a><span id="l79.974">     merror = rowCursor-&gt;NextRow(m_mdbEnv, &amp;findRow, &amp;rowPos);</span>
<a href="#l79.975"></a><span id="l79.975" class="difflineminus">-    if (NS_SUCCEEDED(merror) &amp;&amp; findRow)</span>
<a href="#l79.976"></a><span id="l79.976" class="difflineminus">-    {</span>
<a href="#l79.977"></a><span id="l79.977" class="difflineplus">+    if (NS_SUCCEEDED(merror) &amp;&amp; findRow) {</span>
<a href="#l79.978"></a><span id="l79.978">       mdbOid rowOid;</span>
<a href="#l79.979"></a><span id="l79.979"> </span>
<a href="#l79.980"></a><span id="l79.980" class="difflineminus">-      if (NS_SUCCEEDED(findRow-&gt;GetOid(m_mdbEnv, &amp;rowOid)))</span>
<a href="#l79.981"></a><span id="l79.981" class="difflineminus">-      {</span>
<a href="#l79.982"></a><span id="l79.982" class="difflineplus">+      if (NS_SUCCEEDED(findRow-&gt;GetOid(m_mdbEnv, &amp;rowOid))) {</span>
<a href="#l79.983"></a><span id="l79.983">         nsAutoString tempString;</span>
<a href="#l79.984"></a><span id="l79.984" class="difflineminus">-        if (IsCardRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.985"></a><span id="l79.985" class="difflineminus">-        {</span>
<a href="#l79.986"></a><span id="l79.986" class="difflineminus">-          err = GetStringColumn(findRow, m_LowerPriEmailColumnToken, tempString);</span>
<a href="#l79.987"></a><span id="l79.987" class="difflineminus">-          if (NS_FAILED(err)) // not set yet</span>
<a href="#l79.988"></a><span id="l79.988" class="difflineplus">+        if (IsCardRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.989"></a><span id="l79.989" class="difflineplus">+          err =</span>
<a href="#l79.990"></a><span id="l79.990" class="difflineplus">+              GetStringColumn(findRow, m_LowerPriEmailColumnToken, tempString);</span>
<a href="#l79.991"></a><span id="l79.991" class="difflineplus">+          if (NS_FAILED(err))  // not set yet</span>
<a href="#l79.992"></a><span id="l79.992">           {</span>
<a href="#l79.993"></a><span id="l79.993">             err = ConvertAndAddLowercaseColumn(findRow, m_PriEmailColumnToken,</span>
<a href="#l79.994"></a><span id="l79.994" class="difflineminus">-              m_LowerPriEmailColumnToken);</span>
<a href="#l79.995"></a><span id="l79.995" class="difflineplus">+                                               m_LowerPriEmailColumnToken);</span>
<a href="#l79.996"></a><span id="l79.996">             commitRequired = commitRequired || NS_SUCCEEDED(err);</span>
<a href="#l79.997"></a><span id="l79.997">           }</span>
<a href="#l79.998"></a><span id="l79.998"> </span>
<a href="#l79.999"></a><span id="l79.999" class="difflineminus">-          err = GetStringColumn(findRow, m_Lower2ndEmailColumnToken, tempString);</span>
<a href="#l79.1000"></a><span id="l79.1000" class="difflineminus">-          if (NS_FAILED(err)) // not set yet</span>
<a href="#l79.1001"></a><span id="l79.1001" class="difflineplus">+          err =</span>
<a href="#l79.1002"></a><span id="l79.1002" class="difflineplus">+              GetStringColumn(findRow, m_Lower2ndEmailColumnToken, tempString);</span>
<a href="#l79.1003"></a><span id="l79.1003" class="difflineplus">+          if (NS_FAILED(err))  // not set yet</span>
<a href="#l79.1004"></a><span id="l79.1004">           {</span>
<a href="#l79.1005"></a><span id="l79.1005">             err = ConvertAndAddLowercaseColumn(findRow, m_2ndEmailColumnToken,</span>
<a href="#l79.1006"></a><span id="l79.1006" class="difflineminus">-              m_Lower2ndEmailColumnToken);</span>
<a href="#l79.1007"></a><span id="l79.1007" class="difflineplus">+                                               m_Lower2ndEmailColumnToken);</span>
<a href="#l79.1008"></a><span id="l79.1008">             commitRequired = commitRequired || NS_SUCCEEDED(err);</span>
<a href="#l79.1009"></a><span id="l79.1009">           }</span>
<a href="#l79.1010"></a><span id="l79.1010" class="difflineminus">-        }</span>
<a href="#l79.1011"></a><span id="l79.1011" class="difflineminus">-        else if (IsListRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.1012"></a><span id="l79.1012" class="difflineminus">-        {</span>
<a href="#l79.1013"></a><span id="l79.1013" class="difflineminus">-          err = GetStringColumn(findRow, m_LowerListNameColumnToken, tempString);</span>
<a href="#l79.1014"></a><span id="l79.1014" class="difflineminus">-          if (NS_SUCCEEDED(err)) // already set up</span>
<a href="#l79.1015"></a><span id="l79.1015" class="difflineplus">+        } else if (IsListRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.1016"></a><span id="l79.1016" class="difflineplus">+          err =</span>
<a href="#l79.1017"></a><span id="l79.1017" class="difflineplus">+              GetStringColumn(findRow, m_LowerListNameColumnToken, tempString);</span>
<a href="#l79.1018"></a><span id="l79.1018" class="difflineplus">+          if (NS_SUCCEEDED(err))  // already set up</span>
<a href="#l79.1019"></a><span id="l79.1019">             continue;</span>
<a href="#l79.1020"></a><span id="l79.1020"> </span>
<a href="#l79.1021"></a><span id="l79.1021">           err = ConvertAndAddLowercaseColumn(findRow, m_ListNameColumnToken,</span>
<a href="#l79.1022"></a><span id="l79.1022" class="difflineminus">-            m_LowerListNameColumnToken);</span>
<a href="#l79.1023"></a><span id="l79.1023" class="difflineplus">+                                             m_LowerListNameColumnToken);</span>
<a href="#l79.1024"></a><span id="l79.1024">           commitRequired = commitRequired || NS_SUCCEEDED(err);</span>
<a href="#l79.1025"></a><span id="l79.1025">         }</span>
<a href="#l79.1026"></a><span id="l79.1026">       }</span>
<a href="#l79.1027"></a><span id="l79.1027">       findRow-&gt;Release();</span>
<a href="#l79.1028"></a><span id="l79.1028">     }</span>
<a href="#l79.1029"></a><span id="l79.1029">   } while (findRow);</span>
<a href="#l79.1030"></a><span id="l79.1030"> </span>
<a href="#l79.1031"></a><span id="l79.1031" class="difflineminus">-  if (findRow)</span>
<a href="#l79.1032"></a><span id="l79.1032" class="difflineminus">-    findRow-&gt;Release();</span>
<a href="#l79.1033"></a><span id="l79.1033" class="difflineplus">+  if (findRow) findRow-&gt;Release();</span>
<a href="#l79.1034"></a><span id="l79.1034">   rowCursor-&gt;Release();</span>
<a href="#l79.1035"></a><span id="l79.1035" class="difflineminus">-  if (commitRequired)</span>
<a href="#l79.1036"></a><span id="l79.1036" class="difflineminus">-    Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l79.1037"></a><span id="l79.1037" class="difflineplus">+  if (commitRequired) Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l79.1038"></a><span id="l79.1038">   return NS_OK;</span>
<a href="#l79.1039"></a><span id="l79.1039"> }</span>
<a href="#l79.1040"></a><span id="l79.1040"> </span>
<a href="#l79.1041"></a><span id="l79.1041"> /*</span>
<a href="#l79.1042"></a><span id="l79.1042"> We store UTF8 strings in the database.  We need to convert the UTF8</span>
<a href="#l79.1043"></a><span id="l79.1043"> string into unicode string, then convert to lower case.  Before storing</span>
<a href="#l79.1044"></a><span id="l79.1044"> back into the database,  we need to convert the lowercase unicode string</span>
<a href="#l79.1045"></a><span id="l79.1045"> into UTF8 string.</span>
<a href="#l79.1046"></a><span id="l79.1046"> */</span>
<a href="#l79.1047"></a><span id="l79.1047" class="difflineminus">-nsresult nsAddrDatabase::ConvertAndAddLowercaseColumn</span>
<a href="#l79.1048"></a><span id="l79.1048" class="difflineminus">-(nsIMdbRow * row, mdb_token fromCol, mdb_token toCol)</span>
<a href="#l79.1049"></a><span id="l79.1049" class="difflineminus">-{</span>
<a href="#l79.1050"></a><span id="l79.1050" class="difflineplus">+nsresult nsAddrDatabase::ConvertAndAddLowercaseColumn(nsIMdbRow *row,</span>
<a href="#l79.1051"></a><span id="l79.1051" class="difflineplus">+                                                      mdb_token fromCol,</span>
<a href="#l79.1052"></a><span id="l79.1052" class="difflineplus">+                                                      mdb_token toCol) {</span>
<a href="#l79.1053"></a><span id="l79.1053">   nsAutoString colString;</span>
<a href="#l79.1054"></a><span id="l79.1054"> </span>
<a href="#l79.1055"></a><span id="l79.1055">   nsresult rv = GetStringColumn(row, fromCol, colString);</span>
<a href="#l79.1056"></a><span id="l79.1056" class="difflineminus">-  if (!colString.IsEmpty())</span>
<a href="#l79.1057"></a><span id="l79.1057" class="difflineminus">-  {</span>
<a href="#l79.1058"></a><span id="l79.1058" class="difflineplus">+  if (!colString.IsEmpty()) {</span>
<a href="#l79.1059"></a><span id="l79.1059">     rv = AddLowercaseColumn(row, toCol, NS_ConvertUTF16toUTF8(colString).get());</span>
<a href="#l79.1060"></a><span id="l79.1060">   }</span>
<a href="#l79.1061"></a><span id="l79.1061">   return rv;</span>
<a href="#l79.1062"></a><span id="l79.1062"> }</span>
<a href="#l79.1063"></a><span id="l79.1063"> </span>
<a href="#l79.1064"></a><span id="l79.1064" class="difflineminus">-// Change the unicode string to lowercase, then convert to UTF8 string to store in db</span>
<a href="#l79.1065"></a><span id="l79.1065" class="difflineminus">-nsresult nsAddrDatabase::AddUnicodeToColumn(nsIMdbRow * row, mdb_token aColToken, mdb_token aLowerCaseColToken, const char16_t* aUnicodeStr)</span>
<a href="#l79.1066"></a><span id="l79.1066" class="difflineminus">-{</span>
<a href="#l79.1067"></a><span id="l79.1067" class="difflineminus">-  nsresult rv = AddCharStringColumn(row, aColToken, NS_ConvertUTF16toUTF8(aUnicodeStr).get());</span>
<a href="#l79.1068"></a><span id="l79.1068" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1069"></a><span id="l79.1069" class="difflineminus">-</span>
<a href="#l79.1070"></a><span id="l79.1070" class="difflineminus">-  rv = AddLowercaseColumn(row, aLowerCaseColToken, NS_ConvertUTF16toUTF8(aUnicodeStr).get());</span>
<a href="#l79.1071"></a><span id="l79.1071" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1072"></a><span id="l79.1072" class="difflineplus">+// Change the unicode string to lowercase, then convert to UTF8 string to store</span>
<a href="#l79.1073"></a><span id="l79.1073" class="difflineplus">+// in db</span>
<a href="#l79.1074"></a><span id="l79.1074" class="difflineplus">+nsresult nsAddrDatabase::AddUnicodeToColumn(nsIMdbRow *row, mdb_token aColToken,</span>
<a href="#l79.1075"></a><span id="l79.1075" class="difflineplus">+                                            mdb_token aLowerCaseColToken,</span>
<a href="#l79.1076"></a><span id="l79.1076" class="difflineplus">+                                            const char16_t *aUnicodeStr) {</span>
<a href="#l79.1077"></a><span id="l79.1077" class="difflineplus">+  nsresult rv = AddCharStringColumn(row, aColToken,</span>
<a href="#l79.1078"></a><span id="l79.1078" class="difflineplus">+                                    NS_ConvertUTF16toUTF8(aUnicodeStr).get());</span>
<a href="#l79.1079"></a><span id="l79.1079" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1080"></a><span id="l79.1080" class="difflineplus">+</span>
<a href="#l79.1081"></a><span id="l79.1081" class="difflineplus">+  rv = AddLowercaseColumn(row, aLowerCaseColToken,</span>
<a href="#l79.1082"></a><span id="l79.1082" class="difflineplus">+                          NS_ConvertUTF16toUTF8(aUnicodeStr).get());</span>
<a href="#l79.1083"></a><span id="l79.1083" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1084"></a><span id="l79.1084">   return rv;</span>
<a href="#l79.1085"></a><span id="l79.1085"> }</span>
<a href="#l79.1086"></a><span id="l79.1086"> </span>
<a href="#l79.1087"></a><span id="l79.1087"> // initialize the various tokens and tables in our db's env</span>
<a href="#l79.1088"></a><span id="l79.1088" class="difflineminus">-nsresult nsAddrDatabase::InitMDBInfo()</span>
<a href="#l79.1089"></a><span id="l79.1089" class="difflineminus">-{</span>
<a href="#l79.1090"></a><span id="l79.1090" class="difflineplus">+nsresult nsAddrDatabase::InitMDBInfo() {</span>
<a href="#l79.1091"></a><span id="l79.1091">   nsresult err = NS_OK;</span>
<a href="#l79.1092"></a><span id="l79.1092"> </span>
<a href="#l79.1093"></a><span id="l79.1093" class="difflineminus">-  if (!m_mdbTokensInitialized &amp;&amp; m_mdbStore &amp;&amp; m_mdbEnv)</span>
<a href="#l79.1094"></a><span id="l79.1094" class="difflineminus">-  {</span>
<a href="#l79.1095"></a><span id="l79.1095" class="difflineplus">+  if (!m_mdbTokensInitialized &amp;&amp; m_mdbStore &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.1096"></a><span id="l79.1096">     m_mdbTokensInitialized = true;</span>
<a href="#l79.1097"></a><span id="l79.1097" class="difflineminus">-    err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kCardRowScope, &amp;m_CardRowScopeToken);</span>
<a href="#l79.1098"></a><span id="l79.1098" class="difflineminus">-    err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kListRowScope, &amp;m_ListRowScopeToken);</span>
<a href="#l79.1099"></a><span id="l79.1099" class="difflineminus">-    err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kDataRowScope, &amp;m_DataRowScopeToken);</span>
<a href="#l79.1100"></a><span id="l79.1100" class="difflineplus">+    err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kCardRowScope,</span>
<a href="#l79.1101"></a><span id="l79.1101" class="difflineplus">+                                    &amp;m_CardRowScopeToken);</span>
<a href="#l79.1102"></a><span id="l79.1102" class="difflineplus">+    err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kListRowScope,</span>
<a href="#l79.1103"></a><span id="l79.1103" class="difflineplus">+                                    &amp;m_ListRowScopeToken);</span>
<a href="#l79.1104"></a><span id="l79.1104" class="difflineplus">+    err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kDataRowScope,</span>
<a href="#l79.1105"></a><span id="l79.1105" class="difflineplus">+                                    &amp;m_DataRowScopeToken);</span>
<a href="#l79.1106"></a><span id="l79.1106">     gAddressBookTableOID.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l79.1107"></a><span id="l79.1107">     gAddressBookTableOID.mOid_Id = ID_PAB_TABLE;</span>
<a href="#l79.1108"></a><span id="l79.1108" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l79.1109"></a><span id="l79.1109" class="difflineminus">-    {</span>
<a href="#l79.1110"></a><span id="l79.1110" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kUIDProperty, &amp;m_UIDColumnToken);</span>
<a href="#l79.1111"></a><span id="l79.1111" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFirstNameProperty, &amp;m_FirstNameColumnToken);</span>
<a href="#l79.1112"></a><span id="l79.1112" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastNameProperty, &amp;m_LastNameColumnToken);</span>
<a href="#l79.1113"></a><span id="l79.1113" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPhoneticFirstNameProperty, &amp;m_PhoneticFirstNameColumnToken);</span>
<a href="#l79.1114"></a><span id="l79.1114" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPhoneticLastNameProperty, &amp;m_PhoneticLastNameColumnToken);</span>
<a href="#l79.1115"></a><span id="l79.1115" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDisplayNameProperty, &amp;m_DisplayNameColumnToken);</span>
<a href="#l79.1116"></a><span id="l79.1116" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kNicknameProperty, &amp;m_NickNameColumnToken);</span>
<a href="#l79.1117"></a><span id="l79.1117" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPriEmailProperty, &amp;m_PriEmailColumnToken);</span>
<a href="#l79.1118"></a><span id="l79.1118" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLowerPriEmailColumn, &amp;m_LowerPriEmailColumnToken);</span>
<a href="#l79.1119"></a><span id="l79.1119" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  k2ndEmailProperty, &amp;m_2ndEmailColumnToken);</span>
<a href="#l79.1120"></a><span id="l79.1120" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLower2ndEmailColumn, &amp;m_Lower2ndEmailColumnToken);</span>
<a href="#l79.1121"></a><span id="l79.1121" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPreferMailFormatProperty, &amp;m_MailFormatColumnToken);</span>
<a href="#l79.1122"></a><span id="l79.1122" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPopularityIndexProperty, &amp;m_PopularityIndexColumnToken);</span>
<a href="#l79.1123"></a><span id="l79.1123" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkPhoneProperty, &amp;m_WorkPhoneColumnToken);</span>
<a href="#l79.1124"></a><span id="l79.1124" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomePhoneProperty, &amp;m_HomePhoneColumnToken);</span>
<a href="#l79.1125"></a><span id="l79.1125" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFaxProperty, &amp;m_FaxColumnToken);</span>
<a href="#l79.1126"></a><span id="l79.1126" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPagerProperty, &amp;m_PagerColumnToken);</span>
<a href="#l79.1127"></a><span id="l79.1127" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCellularProperty, &amp;m_CellularColumnToken);</span>
<a href="#l79.1128"></a><span id="l79.1128" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkPhoneTypeProperty, &amp;m_WorkPhoneTypeColumnToken);</span>
<a href="#l79.1129"></a><span id="l79.1129" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomePhoneTypeProperty, &amp;m_HomePhoneTypeColumnToken);</span>
<a href="#l79.1130"></a><span id="l79.1130" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFaxTypeProperty, &amp;m_FaxTypeColumnToken);</span>
<a href="#l79.1131"></a><span id="l79.1131" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kPagerTypeProperty, &amp;m_PagerTypeColumnToken);</span>
<a href="#l79.1132"></a><span id="l79.1132" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCellularTypeProperty, &amp;m_CellularTypeColumnToken);</span>
<a href="#l79.1133"></a><span id="l79.1133" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeAddressProperty, &amp;m_HomeAddressColumnToken);</span>
<a href="#l79.1134"></a><span id="l79.1134" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeAddress2Property, &amp;m_HomeAddress2ColumnToken);</span>
<a href="#l79.1135"></a><span id="l79.1135" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeCityProperty, &amp;m_HomeCityColumnToken);</span>
<a href="#l79.1136"></a><span id="l79.1136" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeStateProperty, &amp;m_HomeStateColumnToken);</span>
<a href="#l79.1137"></a><span id="l79.1137" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeZipCodeProperty, &amp;m_HomeZipCodeColumnToken);</span>
<a href="#l79.1138"></a><span id="l79.1138" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeCountryProperty, &amp;m_HomeCountryColumnToken);</span>
<a href="#l79.1139"></a><span id="l79.1139" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkAddressProperty, &amp;m_WorkAddressColumnToken);</span>
<a href="#l79.1140"></a><span id="l79.1140" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkAddress2Property, &amp;m_WorkAddress2ColumnToken);</span>
<a href="#l79.1141"></a><span id="l79.1141" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkCityProperty, &amp;m_WorkCityColumnToken);</span>
<a href="#l79.1142"></a><span id="l79.1142" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkStateProperty, &amp;m_WorkStateColumnToken);</span>
<a href="#l79.1143"></a><span id="l79.1143" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkZipCodeProperty, &amp;m_WorkZipCodeColumnToken);</span>
<a href="#l79.1144"></a><span id="l79.1144" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkCountryProperty, &amp;m_WorkCountryColumnToken);</span>
<a href="#l79.1145"></a><span id="l79.1145" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kJobTitleProperty, &amp;m_JobTitleColumnToken);</span>
<a href="#l79.1146"></a><span id="l79.1146" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDepartmentProperty, &amp;m_DepartmentColumnToken);</span>
<a href="#l79.1147"></a><span id="l79.1147" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCompanyProperty, &amp;m_CompanyColumnToken);</span>
<a href="#l79.1148"></a><span id="l79.1148" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kScreenNameProperty, &amp;m_AimScreenNameColumnToken);</span>
<a href="#l79.1149"></a><span id="l79.1149" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryYearProperty, &amp;m_AnniversaryYearColumnToken);</span>
<a href="#l79.1150"></a><span id="l79.1150" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryMonthProperty, &amp;m_AnniversaryMonthColumnToken);</span>
<a href="#l79.1151"></a><span id="l79.1151" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAnniversaryDayProperty, &amp;m_AnniversaryDayColumnToken);</span>
<a href="#l79.1152"></a><span id="l79.1152" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kSpouseNameProperty, &amp;m_SpouseNameColumnToken);</span>
<a href="#l79.1153"></a><span id="l79.1153" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kFamilyNameProperty, &amp;m_FamilyNameColumnToken);</span>
<a href="#l79.1154"></a><span id="l79.1154" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kWorkWebPageProperty, &amp;m_WebPage1ColumnToken);</span>
<a href="#l79.1155"></a><span id="l79.1155" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kHomeWebPageProperty, &amp;m_WebPage2ColumnToken);</span>
<a href="#l79.1156"></a><span id="l79.1156" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthYearProperty, &amp;m_BirthYearColumnToken);</span>
<a href="#l79.1157"></a><span id="l79.1157" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthMonthProperty, &amp;m_BirthMonthColumnToken);</span>
<a href="#l79.1158"></a><span id="l79.1158" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kBirthDayProperty, &amp;m_BirthDayColumnToken);</span>
<a href="#l79.1159"></a><span id="l79.1159" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom1Property, &amp;m_Custom1ColumnToken);</span>
<a href="#l79.1160"></a><span id="l79.1160" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom2Property, &amp;m_Custom2ColumnToken);</span>
<a href="#l79.1161"></a><span id="l79.1161" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom3Property, &amp;m_Custom3ColumnToken);</span>
<a href="#l79.1162"></a><span id="l79.1162" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kCustom4Property, &amp;m_Custom4ColumnToken);</span>
<a href="#l79.1163"></a><span id="l79.1163" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kNotesProperty, &amp;m_NotesColumnToken);</span>
<a href="#l79.1164"></a><span id="l79.1164" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastModifiedDateProperty, &amp;m_LastModDateColumnToken);</span>
<a href="#l79.1165"></a><span id="l79.1165" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kRecordKeyColumn, &amp;m_RecordKeyColumnToken);</span>
<a href="#l79.1166"></a><span id="l79.1166" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kAddressCharSetColumn, &amp;m_AddressCharSetColumnToken);</span>
<a href="#l79.1167"></a><span id="l79.1167" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLastRecordKeyColumn, &amp;m_LastRecordKeyColumnToken);</span>
<a href="#l79.1168"></a><span id="l79.1168" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l79.1169"></a><span id="l79.1169" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kUIDProperty, &amp;m_UIDColumnToken);</span>
<a href="#l79.1170"></a><span id="l79.1170" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kFirstNameProperty,</span>
<a href="#l79.1171"></a><span id="l79.1171" class="difflineplus">+                                &amp;m_FirstNameColumnToken);</span>
<a href="#l79.1172"></a><span id="l79.1172" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kLastNameProperty,</span>
<a href="#l79.1173"></a><span id="l79.1173" class="difflineplus">+                                &amp;m_LastNameColumnToken);</span>
<a href="#l79.1174"></a><span id="l79.1174" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kPhoneticFirstNameProperty,</span>
<a href="#l79.1175"></a><span id="l79.1175" class="difflineplus">+                                &amp;m_PhoneticFirstNameColumnToken);</span>
<a href="#l79.1176"></a><span id="l79.1176" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kPhoneticLastNameProperty,</span>
<a href="#l79.1177"></a><span id="l79.1177" class="difflineplus">+                                &amp;m_PhoneticLastNameColumnToken);</span>
<a href="#l79.1178"></a><span id="l79.1178" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kDisplayNameProperty,</span>
<a href="#l79.1179"></a><span id="l79.1179" class="difflineplus">+                                &amp;m_DisplayNameColumnToken);</span>
<a href="#l79.1180"></a><span id="l79.1180" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kNicknameProperty,</span>
<a href="#l79.1181"></a><span id="l79.1181" class="difflineplus">+                                &amp;m_NickNameColumnToken);</span>
<a href="#l79.1182"></a><span id="l79.1182" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kPriEmailProperty,</span>
<a href="#l79.1183"></a><span id="l79.1183" class="difflineplus">+                                &amp;m_PriEmailColumnToken);</span>
<a href="#l79.1184"></a><span id="l79.1184" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kLowerPriEmailColumn,</span>
<a href="#l79.1185"></a><span id="l79.1185" class="difflineplus">+                                &amp;m_LowerPriEmailColumnToken);</span>
<a href="#l79.1186"></a><span id="l79.1186" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, k2ndEmailProperty,</span>
<a href="#l79.1187"></a><span id="l79.1187" class="difflineplus">+                                &amp;m_2ndEmailColumnToken);</span>
<a href="#l79.1188"></a><span id="l79.1188" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kLower2ndEmailColumn,</span>
<a href="#l79.1189"></a><span id="l79.1189" class="difflineplus">+                                &amp;m_Lower2ndEmailColumnToken);</span>
<a href="#l79.1190"></a><span id="l79.1190" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kPreferMailFormatProperty,</span>
<a href="#l79.1191"></a><span id="l79.1191" class="difflineplus">+                                &amp;m_MailFormatColumnToken);</span>
<a href="#l79.1192"></a><span id="l79.1192" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kPopularityIndexProperty,</span>
<a href="#l79.1193"></a><span id="l79.1193" class="difflineplus">+                                &amp;m_PopularityIndexColumnToken);</span>
<a href="#l79.1194"></a><span id="l79.1194" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkPhoneProperty,</span>
<a href="#l79.1195"></a><span id="l79.1195" class="difflineplus">+                                &amp;m_WorkPhoneColumnToken);</span>
<a href="#l79.1196"></a><span id="l79.1196" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomePhoneProperty,</span>
<a href="#l79.1197"></a><span id="l79.1197" class="difflineplus">+                                &amp;m_HomePhoneColumnToken);</span>
<a href="#l79.1198"></a><span id="l79.1198" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kFaxProperty, &amp;m_FaxColumnToken);</span>
<a href="#l79.1199"></a><span id="l79.1199" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kPagerProperty, &amp;m_PagerColumnToken);</span>
<a href="#l79.1200"></a><span id="l79.1200" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kCellularProperty,</span>
<a href="#l79.1201"></a><span id="l79.1201" class="difflineplus">+                                &amp;m_CellularColumnToken);</span>
<a href="#l79.1202"></a><span id="l79.1202" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkPhoneTypeProperty,</span>
<a href="#l79.1203"></a><span id="l79.1203" class="difflineplus">+                                &amp;m_WorkPhoneTypeColumnToken);</span>
<a href="#l79.1204"></a><span id="l79.1204" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomePhoneTypeProperty,</span>
<a href="#l79.1205"></a><span id="l79.1205" class="difflineplus">+                                &amp;m_HomePhoneTypeColumnToken);</span>
<a href="#l79.1206"></a><span id="l79.1206" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kFaxTypeProperty,</span>
<a href="#l79.1207"></a><span id="l79.1207" class="difflineplus">+                                &amp;m_FaxTypeColumnToken);</span>
<a href="#l79.1208"></a><span id="l79.1208" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kPagerTypeProperty,</span>
<a href="#l79.1209"></a><span id="l79.1209" class="difflineplus">+                                &amp;m_PagerTypeColumnToken);</span>
<a href="#l79.1210"></a><span id="l79.1210" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kCellularTypeProperty,</span>
<a href="#l79.1211"></a><span id="l79.1211" class="difflineplus">+                                &amp;m_CellularTypeColumnToken);</span>
<a href="#l79.1212"></a><span id="l79.1212" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomeAddressProperty,</span>
<a href="#l79.1213"></a><span id="l79.1213" class="difflineplus">+                                &amp;m_HomeAddressColumnToken);</span>
<a href="#l79.1214"></a><span id="l79.1214" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomeAddress2Property,</span>
<a href="#l79.1215"></a><span id="l79.1215" class="difflineplus">+                                &amp;m_HomeAddress2ColumnToken);</span>
<a href="#l79.1216"></a><span id="l79.1216" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomeCityProperty,</span>
<a href="#l79.1217"></a><span id="l79.1217" class="difflineplus">+                                &amp;m_HomeCityColumnToken);</span>
<a href="#l79.1218"></a><span id="l79.1218" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomeStateProperty,</span>
<a href="#l79.1219"></a><span id="l79.1219" class="difflineplus">+                                &amp;m_HomeStateColumnToken);</span>
<a href="#l79.1220"></a><span id="l79.1220" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomeZipCodeProperty,</span>
<a href="#l79.1221"></a><span id="l79.1221" class="difflineplus">+                                &amp;m_HomeZipCodeColumnToken);</span>
<a href="#l79.1222"></a><span id="l79.1222" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomeCountryProperty,</span>
<a href="#l79.1223"></a><span id="l79.1223" class="difflineplus">+                                &amp;m_HomeCountryColumnToken);</span>
<a href="#l79.1224"></a><span id="l79.1224" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkAddressProperty,</span>
<a href="#l79.1225"></a><span id="l79.1225" class="difflineplus">+                                &amp;m_WorkAddressColumnToken);</span>
<a href="#l79.1226"></a><span id="l79.1226" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkAddress2Property,</span>
<a href="#l79.1227"></a><span id="l79.1227" class="difflineplus">+                                &amp;m_WorkAddress2ColumnToken);</span>
<a href="#l79.1228"></a><span id="l79.1228" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkCityProperty,</span>
<a href="#l79.1229"></a><span id="l79.1229" class="difflineplus">+                                &amp;m_WorkCityColumnToken);</span>
<a href="#l79.1230"></a><span id="l79.1230" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkStateProperty,</span>
<a href="#l79.1231"></a><span id="l79.1231" class="difflineplus">+                                &amp;m_WorkStateColumnToken);</span>
<a href="#l79.1232"></a><span id="l79.1232" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkZipCodeProperty,</span>
<a href="#l79.1233"></a><span id="l79.1233" class="difflineplus">+                                &amp;m_WorkZipCodeColumnToken);</span>
<a href="#l79.1234"></a><span id="l79.1234" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkCountryProperty,</span>
<a href="#l79.1235"></a><span id="l79.1235" class="difflineplus">+                                &amp;m_WorkCountryColumnToken);</span>
<a href="#l79.1236"></a><span id="l79.1236" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kJobTitleProperty,</span>
<a href="#l79.1237"></a><span id="l79.1237" class="difflineplus">+                                &amp;m_JobTitleColumnToken);</span>
<a href="#l79.1238"></a><span id="l79.1238" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kDepartmentProperty,</span>
<a href="#l79.1239"></a><span id="l79.1239" class="difflineplus">+                                &amp;m_DepartmentColumnToken);</span>
<a href="#l79.1240"></a><span id="l79.1240" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kCompanyProperty,</span>
<a href="#l79.1241"></a><span id="l79.1241" class="difflineplus">+                                &amp;m_CompanyColumnToken);</span>
<a href="#l79.1242"></a><span id="l79.1242" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kScreenNameProperty,</span>
<a href="#l79.1243"></a><span id="l79.1243" class="difflineplus">+                                &amp;m_AimScreenNameColumnToken);</span>
<a href="#l79.1244"></a><span id="l79.1244" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kAnniversaryYearProperty,</span>
<a href="#l79.1245"></a><span id="l79.1245" class="difflineplus">+                                &amp;m_AnniversaryYearColumnToken);</span>
<a href="#l79.1246"></a><span id="l79.1246" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kAnniversaryMonthProperty,</span>
<a href="#l79.1247"></a><span id="l79.1247" class="difflineplus">+                                &amp;m_AnniversaryMonthColumnToken);</span>
<a href="#l79.1248"></a><span id="l79.1248" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kAnniversaryDayProperty,</span>
<a href="#l79.1249"></a><span id="l79.1249" class="difflineplus">+                                &amp;m_AnniversaryDayColumnToken);</span>
<a href="#l79.1250"></a><span id="l79.1250" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kSpouseNameProperty,</span>
<a href="#l79.1251"></a><span id="l79.1251" class="difflineplus">+                                &amp;m_SpouseNameColumnToken);</span>
<a href="#l79.1252"></a><span id="l79.1252" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kFamilyNameProperty,</span>
<a href="#l79.1253"></a><span id="l79.1253" class="difflineplus">+                                &amp;m_FamilyNameColumnToken);</span>
<a href="#l79.1254"></a><span id="l79.1254" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kWorkWebPageProperty,</span>
<a href="#l79.1255"></a><span id="l79.1255" class="difflineplus">+                                &amp;m_WebPage1ColumnToken);</span>
<a href="#l79.1256"></a><span id="l79.1256" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kHomeWebPageProperty,</span>
<a href="#l79.1257"></a><span id="l79.1257" class="difflineplus">+                                &amp;m_WebPage2ColumnToken);</span>
<a href="#l79.1258"></a><span id="l79.1258" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kBirthYearProperty,</span>
<a href="#l79.1259"></a><span id="l79.1259" class="difflineplus">+                                &amp;m_BirthYearColumnToken);</span>
<a href="#l79.1260"></a><span id="l79.1260" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kBirthMonthProperty,</span>
<a href="#l79.1261"></a><span id="l79.1261" class="difflineplus">+                                &amp;m_BirthMonthColumnToken);</span>
<a href="#l79.1262"></a><span id="l79.1262" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kBirthDayProperty,</span>
<a href="#l79.1263"></a><span id="l79.1263" class="difflineplus">+                                &amp;m_BirthDayColumnToken);</span>
<a href="#l79.1264"></a><span id="l79.1264" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kCustom1Property,</span>
<a href="#l79.1265"></a><span id="l79.1265" class="difflineplus">+                                &amp;m_Custom1ColumnToken);</span>
<a href="#l79.1266"></a><span id="l79.1266" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kCustom2Property,</span>
<a href="#l79.1267"></a><span id="l79.1267" class="difflineplus">+                                &amp;m_Custom2ColumnToken);</span>
<a href="#l79.1268"></a><span id="l79.1268" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kCustom3Property,</span>
<a href="#l79.1269"></a><span id="l79.1269" class="difflineplus">+                                &amp;m_Custom3ColumnToken);</span>
<a href="#l79.1270"></a><span id="l79.1270" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kCustom4Property,</span>
<a href="#l79.1271"></a><span id="l79.1271" class="difflineplus">+                                &amp;m_Custom4ColumnToken);</span>
<a href="#l79.1272"></a><span id="l79.1272" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kNotesProperty, &amp;m_NotesColumnToken);</span>
<a href="#l79.1273"></a><span id="l79.1273" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kLastModifiedDateProperty,</span>
<a href="#l79.1274"></a><span id="l79.1274" class="difflineplus">+                                &amp;m_LastModDateColumnToken);</span>
<a href="#l79.1275"></a><span id="l79.1275" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kRecordKeyColumn,</span>
<a href="#l79.1276"></a><span id="l79.1276" class="difflineplus">+                                &amp;m_RecordKeyColumnToken);</span>
<a href="#l79.1277"></a><span id="l79.1277" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kAddressCharSetColumn,</span>
<a href="#l79.1278"></a><span id="l79.1278" class="difflineplus">+                                &amp;m_AddressCharSetColumnToken);</span>
<a href="#l79.1279"></a><span id="l79.1279" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kLastRecordKeyColumn,</span>
<a href="#l79.1280"></a><span id="l79.1280" class="difflineplus">+                                &amp;m_LastRecordKeyColumnToken);</span>
<a href="#l79.1281"></a><span id="l79.1281"> </span>
<a href="#l79.1282"></a><span id="l79.1282">       err = m_mdbStore-&gt;StringToToken(m_mdbEnv, kPabTableKind, &amp;m_PabTableKind);</span>
<a href="#l79.1283"></a><span id="l79.1283"> </span>
<a href="#l79.1284"></a><span id="l79.1284" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kMailListName, &amp;m_ListNameColumnToken);</span>
<a href="#l79.1285"></a><span id="l79.1285" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kMailListNickName, &amp;m_ListNickNameColumnToken);</span>
<a href="#l79.1286"></a><span id="l79.1286" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kMailListDescription, &amp;m_ListDescriptionColumnToken);</span>
<a href="#l79.1287"></a><span id="l79.1287" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kMailListTotalAddresses, &amp;m_ListTotalColumnToken);</span>
<a href="#l79.1288"></a><span id="l79.1288" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kLowerListNameColumn, &amp;m_LowerListNameColumnToken);</span>
<a href="#l79.1289"></a><span id="l79.1289" class="difflineminus">-      m_mdbStore-&gt;StringToToken(m_mdbEnv,  kDeletedCardsTableKind, &amp;m_DeletedCardsTableKind);</span>
<a href="#l79.1290"></a><span id="l79.1290" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kMailListName,</span>
<a href="#l79.1291"></a><span id="l79.1291" class="difflineplus">+                                &amp;m_ListNameColumnToken);</span>
<a href="#l79.1292"></a><span id="l79.1292" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kMailListNickName,</span>
<a href="#l79.1293"></a><span id="l79.1293" class="difflineplus">+                                &amp;m_ListNickNameColumnToken);</span>
<a href="#l79.1294"></a><span id="l79.1294" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kMailListDescription,</span>
<a href="#l79.1295"></a><span id="l79.1295" class="difflineplus">+                                &amp;m_ListDescriptionColumnToken);</span>
<a href="#l79.1296"></a><span id="l79.1296" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kMailListTotalAddresses,</span>
<a href="#l79.1297"></a><span id="l79.1297" class="difflineplus">+                                &amp;m_ListTotalColumnToken);</span>
<a href="#l79.1298"></a><span id="l79.1298" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kLowerListNameColumn,</span>
<a href="#l79.1299"></a><span id="l79.1299" class="difflineplus">+                                &amp;m_LowerListNameColumnToken);</span>
<a href="#l79.1300"></a><span id="l79.1300" class="difflineplus">+      m_mdbStore-&gt;StringToToken(m_mdbEnv, kDeletedCardsTableKind,</span>
<a href="#l79.1301"></a><span id="l79.1301" class="difflineplus">+                                &amp;m_DeletedCardsTableKind);</span>
<a href="#l79.1302"></a><span id="l79.1302">     }</span>
<a href="#l79.1303"></a><span id="l79.1303">   }</span>
<a href="#l79.1304"></a><span id="l79.1304">   return err;</span>
<a href="#l79.1305"></a><span id="l79.1305"> }</span>
<a href="#l79.1306"></a><span id="l79.1306"> </span>
<a href="#l79.1307"></a><span id="l79.1307"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l79.1308"></a><span id="l79.1308"> </span>
<a href="#l79.1309"></a><span id="l79.1309" class="difflineminus">-nsresult nsAddrDatabase::AddRecordKeyColumnToRow(nsIMdbRow *pRow)</span>
<a href="#l79.1310"></a><span id="l79.1310" class="difflineminus">-{</span>
<a href="#l79.1311"></a><span id="l79.1311" class="difflineminus">-  if (pRow &amp;&amp; m_mdbEnv)</span>
<a href="#l79.1312"></a><span id="l79.1312" class="difflineminus">-  {</span>
<a href="#l79.1313"></a><span id="l79.1313" class="difflineplus">+nsresult nsAddrDatabase::AddRecordKeyColumnToRow(nsIMdbRow *pRow) {</span>
<a href="#l79.1314"></a><span id="l79.1314" class="difflineplus">+  if (pRow &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.1315"></a><span id="l79.1315">     m_LastRecordKey++;</span>
<a href="#l79.1316"></a><span id="l79.1316">     nsresult err = AddIntColumn(pRow, m_RecordKeyColumnToken, m_LastRecordKey);</span>
<a href="#l79.1317"></a><span id="l79.1317">     NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.1318"></a><span id="l79.1318"> </span>
<a href="#l79.1319"></a><span id="l79.1319">     err = m_mdbPabTable-&gt;AddRow(m_mdbEnv, pRow);</span>
<a href="#l79.1320"></a><span id="l79.1320">     UpdateLastRecordKey();</span>
<a href="#l79.1321"></a><span id="l79.1321">     return err;</span>
<a href="#l79.1322"></a><span id="l79.1322">   }</span>
<a href="#l79.1323"></a><span id="l79.1323">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1324"></a><span id="l79.1324"> }</span>
<a href="#l79.1325"></a><span id="l79.1325"> </span>
<a href="#l79.1326"></a><span id="l79.1326" class="difflineminus">-nsresult nsAddrDatabase::AddAttributeColumnsToRow(nsIAbCard *card, nsIMdbRow *cardRow)</span>
<a href="#l79.1327"></a><span id="l79.1327" class="difflineminus">-{</span>
<a href="#l79.1328"></a><span id="l79.1328" class="difflineplus">+nsresult nsAddrDatabase::AddAttributeColumnsToRow(nsIAbCard *card,</span>
<a href="#l79.1329"></a><span id="l79.1329" class="difflineplus">+                                                  nsIMdbRow *cardRow) {</span>
<a href="#l79.1330"></a><span id="l79.1330">   nsresult rv = NS_OK;</span>
<a href="#l79.1331"></a><span id="l79.1331"> </span>
<a href="#l79.1332"></a><span id="l79.1332" class="difflineminus">-  if ((!card &amp;&amp; !cardRow) || !m_mdbEnv)</span>
<a href="#l79.1333"></a><span id="l79.1333" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1334"></a><span id="l79.1334" class="difflineplus">+  if ((!card &amp;&amp; !cardRow) || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1335"></a><span id="l79.1335"> </span>
<a href="#l79.1336"></a><span id="l79.1336">   mdbOid rowOid;</span>
<a href="#l79.1337"></a><span id="l79.1337">   cardRow-&gt;GetOid(m_mdbEnv, &amp;rowOid);</span>
<a href="#l79.1338"></a><span id="l79.1338"> </span>
<a href="#l79.1339"></a><span id="l79.1339">   card-&gt;SetPropertyAsUint32(kRowIDProperty, rowOid.mOid_Id);</span>
<a href="#l79.1340"></a><span id="l79.1340"> </span>
<a href="#l79.1341"></a><span id="l79.1341">   // add the row to the singleton table.</span>
<a href="#l79.1342"></a><span id="l79.1342" class="difflineminus">-  if (card &amp;&amp; cardRow)</span>
<a href="#l79.1343"></a><span id="l79.1343" class="difflineminus">-  {</span>
<a href="#l79.1344"></a><span id="l79.1344" class="difflineplus">+  if (card &amp;&amp; cardRow) {</span>
<a href="#l79.1345"></a><span id="l79.1345">     nsCOMPtr&lt;nsISimpleEnumerator&gt; properties;</span>
<a href="#l79.1346"></a><span id="l79.1346">     rv = card-&gt;GetProperties(getter_AddRefs(properties));</span>
<a href="#l79.1347"></a><span id="l79.1347">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1348"></a><span id="l79.1348"> </span>
<a href="#l79.1349"></a><span id="l79.1349">     bool hasMore;</span>
<a href="#l79.1350"></a><span id="l79.1350" class="difflineminus">-    while (NS_SUCCEEDED(properties-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l79.1351"></a><span id="l79.1351" class="difflineminus">-    {</span>
<a href="#l79.1352"></a><span id="l79.1352" class="difflineplus">+    while (NS_SUCCEEDED(properties-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l79.1353"></a><span id="l79.1353">       nsCOMPtr&lt;nsISupports&gt; next;</span>
<a href="#l79.1354"></a><span id="l79.1354">       rv = properties-&gt;GetNext(getter_AddRefs(next));</span>
<a href="#l79.1355"></a><span id="l79.1355">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1356"></a><span id="l79.1356"> </span>
<a href="#l79.1357"></a><span id="l79.1357">       nsCOMPtr&lt;nsIProperty&gt; prop = do_QueryInterface(next);</span>
<a href="#l79.1358"></a><span id="l79.1358">       nsAutoString name;</span>
<a href="#l79.1359"></a><span id="l79.1359">       prop-&gt;GetName(name);</span>
<a href="#l79.1360"></a><span id="l79.1360"> </span>
<a href="#l79.1361"></a><span id="l79.1361">       nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l79.1362"></a><span id="l79.1362">       prop-&gt;GetValue(getter_AddRefs(variant));</span>
<a href="#l79.1363"></a><span id="l79.1363"> </span>
<a href="#l79.1364"></a><span id="l79.1364">       // We can't get as a char * because that messes up UTF8 stuff</span>
<a href="#l79.1365"></a><span id="l79.1365">       nsAutoCString value;</span>
<a href="#l79.1366"></a><span id="l79.1366">       variant-&gt;GetAsAUTF8String(value);</span>
<a href="#l79.1367"></a><span id="l79.1367"> </span>
<a href="#l79.1368"></a><span id="l79.1368">       mdb_token token;</span>
<a href="#l79.1369"></a><span id="l79.1369" class="difflineminus">-      rv = m_mdbStore-&gt;StringToToken(m_mdbEnv, NS_ConvertUTF16toUTF8(name).get(), &amp;token);</span>
<a href="#l79.1370"></a><span id="l79.1370" class="difflineplus">+      rv = m_mdbStore-&gt;StringToToken(m_mdbEnv,</span>
<a href="#l79.1371"></a><span id="l79.1371" class="difflineplus">+                                     NS_ConvertUTF16toUTF8(name).get(), &amp;token);</span>
<a href="#l79.1372"></a><span id="l79.1372">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1373"></a><span id="l79.1373"> </span>
<a href="#l79.1374"></a><span id="l79.1374">       rv = AddCharStringColumn(cardRow, token, value.get());</span>
<a href="#l79.1375"></a><span id="l79.1375">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1376"></a><span id="l79.1376">     }</span>
<a href="#l79.1377"></a><span id="l79.1377"> </span>
<a href="#l79.1378"></a><span id="l79.1378">     // Primary email is special: it is stored lowercase as well as in its</span>
<a href="#l79.1379"></a><span id="l79.1379">     // original format.</span>
<a href="#l79.1380"></a><span id="l79.1380">     nsAutoString primaryEmail;</span>
<a href="#l79.1381"></a><span id="l79.1381">     card-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l79.1382"></a><span id="l79.1382">     AddPrimaryEmail(cardRow, NS_ConvertUTF16toUTF8(primaryEmail).get());</span>
<a href="#l79.1383"></a><span id="l79.1383">   }</span>
<a href="#l79.1384"></a><span id="l79.1384"> </span>
<a href="#l79.1385"></a><span id="l79.1385">   return NS_OK;</span>
<a href="#l79.1386"></a><span id="l79.1386"> }</span>
<a href="#l79.1387"></a><span id="l79.1387"> </span>
<a href="#l79.1388"></a><span id="l79.1388" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::CreateNewCardAndAddToDB(nsIAbCard *aNewCard, bool aNotify /* = FALSE */, nsIAbDirectory *aParent)</span>
<a href="#l79.1389"></a><span id="l79.1389" class="difflineminus">-{</span>
<a href="#l79.1390"></a><span id="l79.1390" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.1391"></a><span id="l79.1391" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::CreateNewCardAndAddToDB(</span>
<a href="#l79.1392"></a><span id="l79.1392" class="difflineplus">+    nsIAbCard *aNewCard, bool aNotify /* = FALSE */, nsIAbDirectory *aParent) {</span>
<a href="#l79.1393"></a><span id="l79.1393" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.1394"></a><span id="l79.1394"> </span>
<a href="#l79.1395"></a><span id="l79.1395">   if (!aNewCard || !m_mdbPabTable || !m_mdbEnv || !m_mdbStore)</span>
<a href="#l79.1396"></a><span id="l79.1396">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1397"></a><span id="l79.1397"> </span>
<a href="#l79.1398"></a><span id="l79.1398">   // Ensure the new card has a UID.</span>
<a href="#l79.1399"></a><span id="l79.1399">   nsAutoCString uid;</span>
<a href="#l79.1400"></a><span id="l79.1400">   aNewCard-&gt;GetUID(uid);</span>
<a href="#l79.1401"></a><span id="l79.1401"> </span>
<a href="#l79.1402"></a><span id="l79.1402" class="difflineat">@@ -1111,174 +1089,166 @@ NS_IMETHODIMP nsAddrDatabase::CreateNewC</span>
<a href="#l79.1403"></a><span id="l79.1403">   nsresult rv;</span>
<a href="#l79.1404"></a><span id="l79.1404"> </span>
<a href="#l79.1405"></a><span id="l79.1405">   nsAutoCString id;</span>
<a href="#l79.1406"></a><span id="l79.1406">   aNewCard-&gt;GetLocalId(id);</span>
<a href="#l79.1407"></a><span id="l79.1407"> </span>
<a href="#l79.1408"></a><span id="l79.1408">   mdbOid rowId;</span>
<a href="#l79.1409"></a><span id="l79.1409">   rowId.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l79.1410"></a><span id="l79.1410">   rowId.mOid_Id = id.ToInteger(&amp;rv);</span>
<a href="#l79.1411"></a><span id="l79.1411" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l79.1412"></a><span id="l79.1412" class="difflineminus">-  {</span>
<a href="#l79.1413"></a><span id="l79.1413" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.1414"></a><span id="l79.1414">     // Mork is being very naughty here. If the table does not have the oid, we</span>
<a href="#l79.1415"></a><span id="l79.1415">     // should be able to reuse it. To be on the safe side, however, we're going</span>
<a href="#l79.1416"></a><span id="l79.1416">     // to reference the store's reference count.</span>
<a href="#l79.1417"></a><span id="l79.1417">     mdb_count rowCount = 1;</span>
<a href="#l79.1418"></a><span id="l79.1418">     m_mdbStore-&gt;GetRowRefCount(m_mdbEnv, &amp;rowId, &amp;rowCount);</span>
<a href="#l79.1419"></a><span id="l79.1419" class="difflineminus">-    if (rowCount == 0)</span>
<a href="#l79.1420"></a><span id="l79.1420" class="difflineminus">-    {</span>
<a href="#l79.1421"></a><span id="l79.1421" class="difflineplus">+    if (rowCount == 0) {</span>
<a href="#l79.1422"></a><span id="l79.1422">       // So apparently, the row can have a count of 0 yet still exist (probably</span>
<a href="#l79.1423"></a><span id="l79.1423">       // meaning we haven't flushed it out of memory). In this case, we need to</span>
<a href="#l79.1424"></a><span id="l79.1424">       // get the row and cut its cells.</span>
<a href="#l79.1425"></a><span id="l79.1425">       rv = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowId, getter_AddRefs(cardRow));</span>
<a href="#l79.1426"></a><span id="l79.1426">       if (NS_SUCCEEDED(rv) &amp;&amp; cardRow)</span>
<a href="#l79.1427"></a><span id="l79.1427">         cardRow-&gt;CutAllColumns(m_mdbEnv);</span>
<a href="#l79.1428"></a><span id="l79.1428">       else</span>
<a href="#l79.1429"></a><span id="l79.1429" class="difflineminus">-        rv = m_mdbStore-&gt;NewRowWithOid(m_mdbEnv, &amp;rowId, getter_AddRefs(cardRow));</span>
<a href="#l79.1430"></a><span id="l79.1430" class="difflineplus">+        rv = m_mdbStore-&gt;NewRowWithOid(m_mdbEnv, &amp;rowId,</span>
<a href="#l79.1431"></a><span id="l79.1431" class="difflineplus">+                                       getter_AddRefs(cardRow));</span>
<a href="#l79.1432"></a><span id="l79.1432">     }</span>
<a href="#l79.1433"></a><span id="l79.1433">   }</span>
<a href="#l79.1434"></a><span id="l79.1434"> </span>
<a href="#l79.1435"></a><span id="l79.1435">   // If we don't have a cardRow yet, just get one with any ol' id.</span>
<a href="#l79.1436"></a><span id="l79.1436" class="difflineminus">-  if (!cardRow)</span>
<a href="#l79.1437"></a><span id="l79.1437" class="difflineminus">-    rv = GetNewRow(getter_AddRefs(cardRow));</span>
<a href="#l79.1438"></a><span id="l79.1438" class="difflineminus">-</span>
<a href="#l79.1439"></a><span id="l79.1439" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; cardRow)</span>
<a href="#l79.1440"></a><span id="l79.1440" class="difflineminus">-  {</span>
<a href="#l79.1441"></a><span id="l79.1441" class="difflineplus">+  if (!cardRow) rv = GetNewRow(getter_AddRefs(cardRow));</span>
<a href="#l79.1442"></a><span id="l79.1442" class="difflineplus">+</span>
<a href="#l79.1443"></a><span id="l79.1443" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; cardRow) {</span>
<a href="#l79.1444"></a><span id="l79.1444">     AddAttributeColumnsToRow(aNewCard, cardRow);</span>
<a href="#l79.1445"></a><span id="l79.1445">     AddRecordKeyColumnToRow(cardRow);</span>
<a href="#l79.1446"></a><span id="l79.1446"> </span>
<a href="#l79.1447"></a><span id="l79.1447">     // we need to do this for dnd</span>
<a href="#l79.1448"></a><span id="l79.1448">     uint32_t key = 0;</span>
<a href="#l79.1449"></a><span id="l79.1449">     rv = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l79.1450"></a><span id="l79.1450" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l79.1451"></a><span id="l79.1451" class="difflineminus">-      aNewCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l79.1452"></a><span id="l79.1452" class="difflineplus">+    if (NS_SUCCEEDED(rv)) aNewCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l79.1453"></a><span id="l79.1453"> </span>
<a href="#l79.1454"></a><span id="l79.1454">     aNewCard-&gt;GetPropertyAsAUTF8String(kRowIDProperty, id);</span>
<a href="#l79.1455"></a><span id="l79.1455">     aNewCard-&gt;SetLocalId(id);</span>
<a href="#l79.1456"></a><span id="l79.1456"> </span>
<a href="#l79.1457"></a><span id="l79.1457">     nsCOMPtr&lt;nsIAbDirectory&gt; abDir = do_QueryReferent(m_dbDirectory);</span>
<a href="#l79.1458"></a><span id="l79.1458" class="difflineminus">-    if (abDir)</span>
<a href="#l79.1459"></a><span id="l79.1459" class="difflineminus">-      abDir-&gt;GetUuid(id);</span>
<a href="#l79.1460"></a><span id="l79.1460" class="difflineplus">+    if (abDir) abDir-&gt;GetUuid(id);</span>
<a href="#l79.1461"></a><span id="l79.1461"> </span>
<a href="#l79.1462"></a><span id="l79.1462">     aNewCard-&gt;SetDirectoryId(id);</span>
<a href="#l79.1463"></a><span id="l79.1463"> </span>
<a href="#l79.1464"></a><span id="l79.1464">     nsresult merror = m_mdbPabTable-&gt;AddRow(m_mdbEnv, cardRow);</span>
<a href="#l79.1465"></a><span id="l79.1465">     NS_ENSURE_SUCCESS(merror, NS_ERROR_FAILURE);</span>
<a href="#l79.1466"></a><span id="l79.1466" class="difflineminus">-  }</span>
<a href="#l79.1467"></a><span id="l79.1467" class="difflineminus">-  else</span>
<a href="#l79.1468"></a><span id="l79.1468" class="difflineplus">+  } else</span>
<a href="#l79.1469"></a><span id="l79.1469">     return rv;</span>
<a href="#l79.1470"></a><span id="l79.1470"> </span>
<a href="#l79.1471"></a><span id="l79.1471">   //  do notification</span>
<a href="#l79.1472"></a><span id="l79.1472" class="difflineminus">-  if (aNotify)</span>
<a href="#l79.1473"></a><span id="l79.1473" class="difflineminus">-  {</span>
<a href="#l79.1474"></a><span id="l79.1474" class="difflineplus">+  if (aNotify) {</span>
<a href="#l79.1475"></a><span id="l79.1475">     NotifyCardEntryChange(AB_NotifyInserted, aNewCard, aParent);</span>
<a href="#l79.1476"></a><span id="l79.1476">   }</span>
<a href="#l79.1477"></a><span id="l79.1477">   return rv;</span>
<a href="#l79.1478"></a><span id="l79.1478"> }</span>
<a href="#l79.1479"></a><span id="l79.1479"> </span>
<a href="#l79.1480"></a><span id="l79.1480" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::CreateNewListCardAndAddToDB(nsIAbDirectory *aList, uint32_t listRowID, nsIAbCard *newCard, bool notify /* = FALSE */)</span>
<a href="#l79.1481"></a><span id="l79.1481" class="difflineminus">-{</span>
<a href="#l79.1482"></a><span id="l79.1482" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::CreateNewListCardAndAddToDB(</span>
<a href="#l79.1483"></a><span id="l79.1483" class="difflineplus">+    nsIAbDirectory *aList, uint32_t listRowID, nsIAbCard *newCard,</span>
<a href="#l79.1484"></a><span id="l79.1484" class="difflineplus">+    bool notify /* = FALSE */) {</span>
<a href="#l79.1485"></a><span id="l79.1485">   if (!newCard || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.1486"></a><span id="l79.1486" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1487"></a><span id="l79.1487" class="difflineminus">-</span>
<a href="#l79.1488"></a><span id="l79.1488" class="difflineminus">-  nsIMdbRow* pListRow = nullptr;</span>
<a href="#l79.1489"></a><span id="l79.1489" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1490"></a><span id="l79.1490" class="difflineplus">+</span>
<a href="#l79.1491"></a><span id="l79.1491" class="difflineplus">+  nsIMdbRow *pListRow = nullptr;</span>
<a href="#l79.1492"></a><span id="l79.1492">   mdbOid listRowOid;</span>
<a href="#l79.1493"></a><span id="l79.1493">   listRowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l79.1494"></a><span id="l79.1494">   listRowOid.mOid_Id = listRowID;</span>
<a href="#l79.1495"></a><span id="l79.1495">   nsresult rv = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;listRowOid, &amp;pListRow);</span>
<a href="#l79.1496"></a><span id="l79.1496" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1497"></a><span id="l79.1497" class="difflineminus">-</span>
<a href="#l79.1498"></a><span id="l79.1498" class="difflineminus">-  if (!pListRow)</span>
<a href="#l79.1499"></a><span id="l79.1499" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.1500"></a><span id="l79.1500" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1501"></a><span id="l79.1501" class="difflineplus">+</span>
<a href="#l79.1502"></a><span id="l79.1502" class="difflineplus">+  if (!pListRow) return NS_OK;</span>
<a href="#l79.1503"></a><span id="l79.1503"> </span>
<a href="#l79.1504"></a><span id="l79.1504">   nsCOMPtr&lt;nsIMutableArray&gt; addressList;</span>
<a href="#l79.1505"></a><span id="l79.1505">   rv = aList-&gt;GetAddressLists(getter_AddRefs(addressList));</span>
<a href="#l79.1506"></a><span id="l79.1506" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1507"></a><span id="l79.1507" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1508"></a><span id="l79.1508"> </span>
<a href="#l79.1509"></a><span id="l79.1509">   uint32_t count;</span>
<a href="#l79.1510"></a><span id="l79.1510">   addressList-&gt;GetLength(&amp;count);</span>
<a href="#l79.1511"></a><span id="l79.1511"> </span>
<a href="#l79.1512"></a><span id="l79.1512">   nsAutoString newEmail;</span>
<a href="#l79.1513"></a><span id="l79.1513">   rv = newCard-&gt;GetPrimaryEmail(newEmail);</span>
<a href="#l79.1514"></a><span id="l79.1514" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1515"></a><span id="l79.1515" class="difflineminus">-</span>
<a href="#l79.1516"></a><span id="l79.1516" class="difflineminus">-  if (newEmail.IsEmpty())</span>
<a href="#l79.1517"></a><span id="l79.1517" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.1518"></a><span id="l79.1518" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1519"></a><span id="l79.1519" class="difflineplus">+</span>
<a href="#l79.1520"></a><span id="l79.1520" class="difflineplus">+  if (newEmail.IsEmpty()) return NS_OK;</span>
<a href="#l79.1521"></a><span id="l79.1521"> </span>
<a href="#l79.1522"></a><span id="l79.1522">   uint32_t i;</span>
<a href="#l79.1523"></a><span id="l79.1523">   for (i = 0; i &lt; count; i++) {</span>
<a href="#l79.1524"></a><span id="l79.1524">     nsCOMPtr&lt;nsIAbCard&gt; currentCard = do_QueryElementAt(addressList, i, &amp;rv);</span>
<a href="#l79.1525"></a><span id="l79.1525" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1526"></a><span id="l79.1526" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1527"></a><span id="l79.1527"> </span>
<a href="#l79.1528"></a><span id="l79.1528">     bool equals;</span>
<a href="#l79.1529"></a><span id="l79.1529">     rv = newCard-&gt;Equals(currentCard, &amp;equals);</span>
<a href="#l79.1530"></a><span id="l79.1530" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1531"></a><span id="l79.1531" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1532"></a><span id="l79.1532"> </span>
<a href="#l79.1533"></a><span id="l79.1533">     if (equals) {</span>
<a href="#l79.1534"></a><span id="l79.1534">       // card is already in list, bail out.</span>
<a href="#l79.1535"></a><span id="l79.1535" class="difflineminus">-      // this can happen when dropping a card on a mailing list from the directory that contains the mailing list</span>
<a href="#l79.1536"></a><span id="l79.1536" class="difflineplus">+      // this can happen when dropping a card on a mailing list from the</span>
<a href="#l79.1537"></a><span id="l79.1537" class="difflineplus">+      // directory that contains the mailing list</span>
<a href="#l79.1538"></a><span id="l79.1538">       return NS_OK;</span>
<a href="#l79.1539"></a><span id="l79.1539">     }</span>
<a href="#l79.1540"></a><span id="l79.1540"> </span>
<a href="#l79.1541"></a><span id="l79.1541">     nsAutoString currentEmail;</span>
<a href="#l79.1542"></a><span id="l79.1542">     rv = currentCard-&gt;GetPrimaryEmail(currentEmail);</span>
<a href="#l79.1543"></a><span id="l79.1543" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1544"></a><span id="l79.1544" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1545"></a><span id="l79.1545"> </span>
<a href="#l79.1546"></a><span id="l79.1546">     if (newEmail.Equals(currentEmail)) {</span>
<a href="#l79.1547"></a><span id="l79.1547">       // card is already in list, bail out</span>
<a href="#l79.1548"></a><span id="l79.1548" class="difflineminus">-      // this can happen when dropping a card on a mailing list from another directory (not the one that contains the mailing list</span>
<a href="#l79.1549"></a><span id="l79.1549" class="difflineminus">-      // or if you have multiple cards on a directory, with the same primary email address.</span>
<a href="#l79.1550"></a><span id="l79.1550" class="difflineplus">+      // this can happen when dropping a card on a mailing list from another</span>
<a href="#l79.1551"></a><span id="l79.1551" class="difflineplus">+      // directory (not the one that contains the mailing list or if you have</span>
<a href="#l79.1552"></a><span id="l79.1552" class="difflineplus">+      // multiple cards on a directory, with the same primary email address.</span>
<a href="#l79.1553"></a><span id="l79.1553">       return NS_OK;</span>
<a href="#l79.1554"></a><span id="l79.1554">     }</span>
<a href="#l79.1555"></a><span id="l79.1555">   }</span>
<a href="#l79.1556"></a><span id="l79.1556"> </span>
<a href="#l79.1557"></a><span id="l79.1557">   // start from 1</span>
<a href="#l79.1558"></a><span id="l79.1558">   uint32_t totalAddress = GetListAddressTotal(pListRow) + 1;</span>
<a href="#l79.1559"></a><span id="l79.1559">   SetListAddressTotal(pListRow, totalAddress);</span>
<a href="#l79.1560"></a><span id="l79.1560">   nsCOMPtr&lt;nsIAbCard&gt; pNewCard;</span>
<a href="#l79.1561"></a><span id="l79.1561" class="difflineminus">-  rv = AddListCardColumnsToRow(newCard, pListRow, totalAddress, getter_AddRefs(pNewCard), true /* aInMailingList */, aList, nullptr);</span>
<a href="#l79.1562"></a><span id="l79.1562" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.1563"></a><span id="l79.1563" class="difflineplus">+  rv = AddListCardColumnsToRow(newCard, pListRow, totalAddress,</span>
<a href="#l79.1564"></a><span id="l79.1564" class="difflineplus">+                               getter_AddRefs(pNewCard),</span>
<a href="#l79.1565"></a><span id="l79.1565" class="difflineplus">+                               true /* aInMailingList */, aList, nullptr);</span>
<a href="#l79.1566"></a><span id="l79.1566" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.1567"></a><span id="l79.1567"> </span>
<a href="#l79.1568"></a><span id="l79.1568">   addressList-&gt;AppendElement(newCard);</span>
<a href="#l79.1569"></a><span id="l79.1569"> </span>
<a href="#l79.1570"></a><span id="l79.1570" class="difflineminus">-  if (notify)</span>
<a href="#l79.1571"></a><span id="l79.1571" class="difflineminus">-    NotifyCardEntryChange(AB_NotifyInserted, newCard, aList);</span>
<a href="#l79.1572"></a><span id="l79.1572" class="difflineplus">+  if (notify) NotifyCardEntryChange(AB_NotifyInserted, newCard, aList);</span>
<a href="#l79.1573"></a><span id="l79.1573"> </span>
<a href="#l79.1574"></a><span id="l79.1574">   return rv;</span>
<a href="#l79.1575"></a><span id="l79.1575"> }</span>
<a href="#l79.1576"></a><span id="l79.1576"> </span>
<a href="#l79.1577"></a><span id="l79.1577" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::AddListCardColumnsToRow</span>
<a href="#l79.1578"></a><span id="l79.1578" class="difflineminus">-(nsIAbCard *aPCard, nsIMdbRow *aPListRow, uint32_t aPos, nsIAbCard** aPNewCard, bool aInMailingList, nsIAbDirectory *aParent, nsIAbDirectory *aRoot)</span>
<a href="#l79.1579"></a><span id="l79.1579" class="difflineminus">-{</span>
<a href="#l79.1580"></a><span id="l79.1580" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::AddListCardColumnsToRow(</span>
<a href="#l79.1581"></a><span id="l79.1581" class="difflineplus">+    nsIAbCard *aPCard, nsIMdbRow *aPListRow, uint32_t aPos,</span>
<a href="#l79.1582"></a><span id="l79.1582" class="difflineplus">+    nsIAbCard **aPNewCard, bool aInMailingList, nsIAbDirectory *aParent,</span>
<a href="#l79.1583"></a><span id="l79.1583" class="difflineplus">+    nsIAbDirectory *aRoot) {</span>
<a href="#l79.1584"></a><span id="l79.1584">   if (!aPCard || !aPListRow || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.1585"></a><span id="l79.1585">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1586"></a><span id="l79.1586"> </span>
<a href="#l79.1587"></a><span id="l79.1587" class="difflineminus">-  nsresult    err = NS_OK;</span>
<a href="#l79.1588"></a><span id="l79.1588" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l79.1589"></a><span id="l79.1589">   nsString email;</span>
<a href="#l79.1590"></a><span id="l79.1590">   aPCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l79.1591"></a><span id="l79.1591" class="difflineminus">-  if (!email.IsEmpty())</span>
<a href="#l79.1592"></a><span id="l79.1592" class="difflineminus">-  {</span>
<a href="#l79.1593"></a><span id="l79.1593" class="difflineminus">-    nsIMdbRow    *pCardRow = nullptr;</span>
<a href="#l79.1594"></a><span id="l79.1594" class="difflineplus">+  if (!email.IsEmpty()) {</span>
<a href="#l79.1595"></a><span id="l79.1595" class="difflineplus">+    nsIMdbRow *pCardRow = nullptr;</span>
<a href="#l79.1596"></a><span id="l79.1596">     // Please DO NOT change the 3rd param of GetRowFromAttribute() call to</span>
<a href="#l79.1597"></a><span id="l79.1597">     // true (ie, case insensitive) without reading bugs #128535 and #121478.</span>
<a href="#l79.1598"></a><span id="l79.1598">     err = GetRowFromAttribute(kPriEmailProperty, NS_ConvertUTF16toUTF8(email),</span>
<a href="#l79.1599"></a><span id="l79.1599">                               false /* retain case */, &amp;pCardRow, nullptr);</span>
<a href="#l79.1600"></a><span id="l79.1600">     bool cardWasAdded = false;</span>
<a href="#l79.1601"></a><span id="l79.1601" class="difflineminus">-    if (NS_FAILED(err) || !pCardRow)</span>
<a href="#l79.1602"></a><span id="l79.1602" class="difflineminus">-    {</span>
<a href="#l79.1603"></a><span id="l79.1603" class="difflineminus">-      //New Email, then add a new row with this email</span>
<a href="#l79.1604"></a><span id="l79.1604" class="difflineminus">-      err  = GetNewRow(&amp;pCardRow);</span>
<a href="#l79.1605"></a><span id="l79.1605" class="difflineminus">-</span>
<a href="#l79.1606"></a><span id="l79.1606" class="difflineminus">-      if (NS_SUCCEEDED(err) &amp;&amp; pCardRow)</span>
<a href="#l79.1607"></a><span id="l79.1607" class="difflineminus">-      {</span>
<a href="#l79.1608"></a><span id="l79.1608" class="difflineplus">+    if (NS_FAILED(err) || !pCardRow) {</span>
<a href="#l79.1609"></a><span id="l79.1609" class="difflineplus">+      // New Email, then add a new row with this email</span>
<a href="#l79.1610"></a><span id="l79.1610" class="difflineplus">+      err = GetNewRow(&amp;pCardRow);</span>
<a href="#l79.1611"></a><span id="l79.1611" class="difflineplus">+</span>
<a href="#l79.1612"></a><span id="l79.1612" class="difflineplus">+      if (NS_SUCCEEDED(err) &amp;&amp; pCardRow) {</span>
<a href="#l79.1613"></a><span id="l79.1613">         AddPrimaryEmail(pCardRow, NS_ConvertUTF16toUTF8(email).get());</span>
<a href="#l79.1614"></a><span id="l79.1614">         err = m_mdbPabTable-&gt;AddRow(m_mdbEnv, pCardRow);</span>
<a href="#l79.1615"></a><span id="l79.1615">         // Create a key for this row as well.</span>
<a href="#l79.1616"></a><span id="l79.1616" class="difflineminus">-        if (NS_SUCCEEDED(err))</span>
<a href="#l79.1617"></a><span id="l79.1617" class="difflineminus">-          AddRecordKeyColumnToRow(pCardRow);</span>
<a href="#l79.1618"></a><span id="l79.1618" class="difflineplus">+        if (NS_SUCCEEDED(err)) AddRecordKeyColumnToRow(pCardRow);</span>
<a href="#l79.1619"></a><span id="l79.1619">       }</span>
<a href="#l79.1620"></a><span id="l79.1620"> </span>
<a href="#l79.1621"></a><span id="l79.1621">       cardWasAdded = true;</span>
<a href="#l79.1622"></a><span id="l79.1622">     }</span>
<a href="#l79.1623"></a><span id="l79.1623"> </span>
<a href="#l79.1624"></a><span id="l79.1624">     NS_ENSURE_TRUE(pCardRow, NS_ERROR_NULL_POINTER);</span>
<a href="#l79.1625"></a><span id="l79.1625"> </span>
<a href="#l79.1626"></a><span id="l79.1626">     nsString name;</span>
<a href="#l79.1627"></a><span id="l79.1627" class="difflineat">@@ -1287,79 +1257,75 @@ NS_IMETHODIMP nsAddrDatabase::AddListCar</span>
<a href="#l79.1628"></a><span id="l79.1628">       AddDisplayName(pCardRow, NS_ConvertUTF16toUTF8(name).get());</span>
<a href="#l79.1629"></a><span id="l79.1629">       err = m_mdbPabTable-&gt;AddRow(m_mdbEnv, pCardRow);</span>
<a href="#l79.1630"></a><span id="l79.1630">     }</span>
<a href="#l79.1631"></a><span id="l79.1631"> </span>
<a href="#l79.1632"></a><span id="l79.1632">     CreateABCard(pCardRow, 0, aPNewCard);</span>
<a href="#l79.1633"></a><span id="l79.1633"> </span>
<a href="#l79.1634"></a><span id="l79.1634">     if (cardWasAdded) {</span>
<a href="#l79.1635"></a><span id="l79.1635">       NotifyCardEntryChange(AB_NotifyInserted, *aPNewCard, aParent);</span>
<a href="#l79.1636"></a><span id="l79.1636" class="difflineminus">-      if (aRoot)</span>
<a href="#l79.1637"></a><span id="l79.1637" class="difflineminus">-        NotifyCardEntryChange(AB_NotifyInserted, *aPNewCard, aRoot);</span>
<a href="#l79.1638"></a><span id="l79.1638" class="difflineminus">-    }</span>
<a href="#l79.1639"></a><span id="l79.1639" class="difflineminus">-    else if (!aInMailingList) {</span>
<a href="#l79.1640"></a><span id="l79.1640" class="difflineplus">+      if (aRoot) NotifyCardEntryChange(AB_NotifyInserted, *aPNewCard, aRoot);</span>
<a href="#l79.1641"></a><span id="l79.1641" class="difflineplus">+    } else if (!aInMailingList) {</span>
<a href="#l79.1642"></a><span id="l79.1642">       nsresult rv;</span>
<a href="#l79.1643"></a><span id="l79.1643" class="difflineminus">-      nsCOMPtr&lt;nsIAddrDBListener&gt; parentListener(do_QueryInterface(aParent, &amp;rv));</span>
<a href="#l79.1644"></a><span id="l79.1644" class="difflineminus">-</span>
<a href="#l79.1645"></a><span id="l79.1645" class="difflineminus">-      // Ensure the parent is in the listener list (and hence wants to be notified)</span>
<a href="#l79.1646"></a><span id="l79.1646" class="difflineplus">+      nsCOMPtr&lt;nsIAddrDBListener&gt; parentListener(</span>
<a href="#l79.1647"></a><span id="l79.1647" class="difflineplus">+          do_QueryInterface(aParent, &amp;rv));</span>
<a href="#l79.1648"></a><span id="l79.1648" class="difflineplus">+</span>
<a href="#l79.1649"></a><span id="l79.1649" class="difflineplus">+      // Ensure the parent is in the listener list (and hence wants to be</span>
<a href="#l79.1650"></a><span id="l79.1650" class="difflineplus">+      // notified)</span>
<a href="#l79.1651"></a><span id="l79.1651">       if (NS_SUCCEEDED(rv) &amp;&amp; m_ChangeListeners.Contains(parentListener))</span>
<a href="#l79.1652"></a><span id="l79.1652">         parentListener-&gt;OnCardEntryChange(AB_NotifyInserted, aPCard, aParent);</span>
<a href="#l79.1653"></a><span id="l79.1653" class="difflineminus">-    }</span>
<a href="#l79.1654"></a><span id="l79.1654" class="difflineminus">-    else {</span>
<a href="#l79.1655"></a><span id="l79.1655" class="difflineplus">+    } else {</span>
<a href="#l79.1656"></a><span id="l79.1656">       NotifyCardEntryChange(AB_NotifyPropertyChanged, aPCard, aParent);</span>
<a href="#l79.1657"></a><span id="l79.1657">     }</span>
<a href="#l79.1658"></a><span id="l79.1658"> </span>
<a href="#l79.1659"></a><span id="l79.1659" class="difflineminus">-    //add a column with address row id to the list row</span>
<a href="#l79.1660"></a><span id="l79.1660" class="difflineplus">+    // add a column with address row id to the list row</span>
<a href="#l79.1661"></a><span id="l79.1661">     mdb_token listAddressColumnToken;</span>
<a href="#l79.1662"></a><span id="l79.1662"> </span>
<a href="#l79.1663"></a><span id="l79.1663">     char columnStr[COLUMN_STR_MAX];</span>
<a href="#l79.1664"></a><span id="l79.1664">     PR_snprintf(columnStr, COLUMN_STR_MAX, kMailListAddressFormat, aPos);</span>
<a href="#l79.1665"></a><span id="l79.1665" class="difflineminus">-    m_mdbStore-&gt;StringToToken(m_mdbEnv,  columnStr, &amp;listAddressColumnToken);</span>
<a href="#l79.1666"></a><span id="l79.1666" class="difflineplus">+    m_mdbStore-&gt;StringToToken(m_mdbEnv, columnStr, &amp;listAddressColumnToken);</span>
<a href="#l79.1667"></a><span id="l79.1667"> </span>
<a href="#l79.1668"></a><span id="l79.1668">     mdbOid outOid;</span>
<a href="#l79.1669"></a><span id="l79.1669"> </span>
<a href="#l79.1670"></a><span id="l79.1670" class="difflineminus">-    if (NS_SUCCEEDED(pCardRow-&gt;GetOid(m_mdbEnv, &amp;outOid)))</span>
<a href="#l79.1671"></a><span id="l79.1671" class="difflineminus">-    {</span>
<a href="#l79.1672"></a><span id="l79.1672" class="difflineminus">-      //save address row ID to the list row</span>
<a href="#l79.1673"></a><span id="l79.1673" class="difflineplus">+    if (NS_SUCCEEDED(pCardRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) {</span>
<a href="#l79.1674"></a><span id="l79.1674" class="difflineplus">+      // save address row ID to the list row</span>
<a href="#l79.1675"></a><span id="l79.1675">       err = AddIntColumn(aPListRow, listAddressColumnToken, outOid.mOid_Id);</span>
<a href="#l79.1676"></a><span id="l79.1676">     }</span>
<a href="#l79.1677"></a><span id="l79.1677">     NS_RELEASE(pCardRow);</span>
<a href="#l79.1678"></a><span id="l79.1678" class="difflineminus">-</span>
<a href="#l79.1679"></a><span id="l79.1679">   }</span>
<a href="#l79.1680"></a><span id="l79.1680"> </span>
<a href="#l79.1681"></a><span id="l79.1681">   return NS_OK;</span>
<a href="#l79.1682"></a><span id="l79.1682"> }</span>
<a href="#l79.1683"></a><span id="l79.1683"> </span>
<a href="#l79.1684"></a><span id="l79.1684" class="difflineminus">-nsresult nsAddrDatabase::AddListAttributeColumnsToRow(nsIAbDirectory *list, nsIMdbRow *listRow, nsIAbDirectory *aParent)</span>
<a href="#l79.1685"></a><span id="l79.1685" class="difflineminus">-{</span>
<a href="#l79.1686"></a><span id="l79.1686" class="difflineplus">+nsresult nsAddrDatabase::AddListAttributeColumnsToRow(nsIAbDirectory *list,</span>
<a href="#l79.1687"></a><span id="l79.1687" class="difflineplus">+                                                      nsIMdbRow *listRow,</span>
<a href="#l79.1688"></a><span id="l79.1688" class="difflineplus">+                                                      nsIAbDirectory *aParent) {</span>
<a href="#l79.1689"></a><span id="l79.1689">   nsresult err = NS_OK;</span>
<a href="#l79.1690"></a><span id="l79.1690"> </span>
<a href="#l79.1691"></a><span id="l79.1691" class="difflineminus">-  if ((!list &amp;&amp; !listRow) || !m_mdbEnv)</span>
<a href="#l79.1692"></a><span id="l79.1692" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1693"></a><span id="l79.1693" class="difflineplus">+  if ((!list &amp;&amp; !listRow) || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1694"></a><span id="l79.1694"> </span>
<a href="#l79.1695"></a><span id="l79.1695">   mdbOid rowOid, tableOid;</span>
<a href="#l79.1696"></a><span id="l79.1696">   m_mdbPabTable-&gt;GetOid(m_mdbEnv, &amp;tableOid);</span>
<a href="#l79.1697"></a><span id="l79.1697">   listRow-&gt;GetOid(m_mdbEnv, &amp;rowOid);</span>
<a href="#l79.1698"></a><span id="l79.1698"> </span>
<a href="#l79.1699"></a><span id="l79.1699" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list,&amp;err));</span>
<a href="#l79.1700"></a><span id="l79.1700" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l79.1701"></a><span id="l79.1701" class="difflineminus">-    dblist-&gt;SetDbRowID(rowOid.mOid_Id);</span>
<a href="#l79.1702"></a><span id="l79.1702" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list, &amp;err));</span>
<a href="#l79.1703"></a><span id="l79.1703" class="difflineplus">+  if (NS_SUCCEEDED(err)) dblist-&gt;SetDbRowID(rowOid.mOid_Id);</span>
<a href="#l79.1704"></a><span id="l79.1704"> </span>
<a href="#l79.1705"></a><span id="l79.1705">   // add the row to the singleton table.</span>
<a href="#l79.1706"></a><span id="l79.1706" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; listRow)</span>
<a href="#l79.1707"></a><span id="l79.1707" class="difflineminus">-  {</span>
<a href="#l79.1708"></a><span id="l79.1708" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; listRow) {</span>
<a href="#l79.1709"></a><span id="l79.1709">     nsAutoCString acStr;</span>
<a href="#l79.1710"></a><span id="l79.1710">     list-&gt;GetUID(acStr);</span>
<a href="#l79.1711"></a><span id="l79.1711">     AddUID(listRow, acStr.get());</span>
<a href="#l79.1712"></a><span id="l79.1712"> </span>
<a href="#l79.1713"></a><span id="l79.1713">     nsString unicodeStr;</span>
<a href="#l79.1714"></a><span id="l79.1714"> </span>
<a href="#l79.1715"></a><span id="l79.1715">     list-&gt;GetDirName(unicodeStr);</span>
<a href="#l79.1716"></a><span id="l79.1716">     if (!unicodeStr.IsEmpty())</span>
<a href="#l79.1717"></a><span id="l79.1717" class="difflineminus">-        AddUnicodeToColumn(listRow, m_ListNameColumnToken, m_LowerListNameColumnToken, unicodeStr.get());</span>
<a href="#l79.1718"></a><span id="l79.1718" class="difflineplus">+      AddUnicodeToColumn(listRow, m_ListNameColumnToken,</span>
<a href="#l79.1719"></a><span id="l79.1719" class="difflineplus">+                         m_LowerListNameColumnToken, unicodeStr.get());</span>
<a href="#l79.1720"></a><span id="l79.1720"> </span>
<a href="#l79.1721"></a><span id="l79.1721">     list-&gt;GetListNickName(unicodeStr);</span>
<a href="#l79.1722"></a><span id="l79.1722">     AddListNickName(listRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l79.1723"></a><span id="l79.1723"> </span>
<a href="#l79.1724"></a><span id="l79.1724">     list-&gt;GetDescription(unicodeStr);</span>
<a href="#l79.1725"></a><span id="l79.1725">     AddListDescription(listRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l79.1726"></a><span id="l79.1726"> </span>
<a href="#l79.1727"></a><span id="l79.1727">     // XXX todo, this code has problems if you manually enter duplicate emails.</span>
<a href="#l79.1728"></a><span id="l79.1728" class="difflineat">@@ -1367,172 +1333,160 @@ nsresult nsAddrDatabase::AddListAttribut</span>
<a href="#l79.1729"></a><span id="l79.1729">     list-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l79.1730"></a><span id="l79.1730"> </span>
<a href="#l79.1731"></a><span id="l79.1731">     uint32_t count;</span>
<a href="#l79.1732"></a><span id="l79.1732">     pAddressLists-&gt;GetLength(&amp;count);</span>
<a href="#l79.1733"></a><span id="l79.1733"> </span>
<a href="#l79.1734"></a><span id="l79.1734">     nsAutoString email;</span>
<a href="#l79.1735"></a><span id="l79.1735">     uint32_t i, total;</span>
<a href="#l79.1736"></a><span id="l79.1736">     total = 0;</span>
<a href="#l79.1737"></a><span id="l79.1737" class="difflineminus">-    for (i = 0; i &lt; count; i++)</span>
<a href="#l79.1738"></a><span id="l79.1738" class="difflineminus">-    {</span>
<a href="#l79.1739"></a><span id="l79.1739" class="difflineplus">+    for (i = 0; i &lt; count; i++) {</span>
<a href="#l79.1740"></a><span id="l79.1740">       nsCOMPtr&lt;nsIAbCard&gt; pCard(do_QueryElementAt(pAddressLists, i, &amp;err));</span>
<a href="#l79.1741"></a><span id="l79.1741"> </span>
<a href="#l79.1742"></a><span id="l79.1742" class="difflineminus">-      if (NS_FAILED(err))</span>
<a href="#l79.1743"></a><span id="l79.1743" class="difflineminus">-        continue;</span>
<a href="#l79.1744"></a><span id="l79.1744" class="difflineplus">+      if (NS_FAILED(err)) continue;</span>
<a href="#l79.1745"></a><span id="l79.1745"> </span>
<a href="#l79.1746"></a><span id="l79.1746">       pCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l79.1747"></a><span id="l79.1747" class="difflineminus">-      if (!email.IsEmpty())</span>
<a href="#l79.1748"></a><span id="l79.1748" class="difflineminus">-        total++;</span>
<a href="#l79.1749"></a><span id="l79.1749" class="difflineplus">+      if (!email.IsEmpty()) total++;</span>
<a href="#l79.1750"></a><span id="l79.1750">     }</span>
<a href="#l79.1751"></a><span id="l79.1751">     SetListAddressTotal(listRow, total);</span>
<a href="#l79.1752"></a><span id="l79.1752"> </span>
<a href="#l79.1753"></a><span id="l79.1753">     uint32_t pos;</span>
<a href="#l79.1754"></a><span id="l79.1754" class="difflineminus">-    for (i = 0; i &lt; count; i++)</span>
<a href="#l79.1755"></a><span id="l79.1755" class="difflineminus">-    {</span>
<a href="#l79.1756"></a><span id="l79.1756" class="difflineplus">+    for (i = 0; i &lt; count; i++) {</span>
<a href="#l79.1757"></a><span id="l79.1757">       nsCOMPtr&lt;nsIAbCard&gt; pCard(do_QueryElementAt(pAddressLists, i, &amp;err));</span>
<a href="#l79.1758"></a><span id="l79.1758"> </span>
<a href="#l79.1759"></a><span id="l79.1759" class="difflineminus">-      if (NS_FAILED(err))</span>
<a href="#l79.1760"></a><span id="l79.1760" class="difflineminus">-        continue;</span>
<a href="#l79.1761"></a><span id="l79.1761" class="difflineplus">+      if (NS_FAILED(err)) continue;</span>
<a href="#l79.1762"></a><span id="l79.1762"> </span>
<a href="#l79.1763"></a><span id="l79.1763">       bool listHasCard = false;</span>
<a href="#l79.1764"></a><span id="l79.1764">       err = list-&gt;HasCard(pCard, &amp;listHasCard);</span>
<a href="#l79.1765"></a><span id="l79.1765"> </span>
<a href="#l79.1766"></a><span id="l79.1766">       // start from 1</span>
<a href="#l79.1767"></a><span id="l79.1767">       pos = i + 1;</span>
<a href="#l79.1768"></a><span id="l79.1768">       pCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l79.1769"></a><span id="l79.1769" class="difflineminus">-      if (!email.IsEmpty())</span>
<a href="#l79.1770"></a><span id="l79.1770" class="difflineminus">-      {</span>
<a href="#l79.1771"></a><span id="l79.1771" class="difflineplus">+      if (!email.IsEmpty()) {</span>
<a href="#l79.1772"></a><span id="l79.1772">         nsCOMPtr&lt;nsIAbCard&gt; pNewCard;</span>
<a href="#l79.1773"></a><span id="l79.1773" class="difflineminus">-        err = AddListCardColumnsToRow(pCard, listRow, pos, getter_AddRefs(pNewCard), listHasCard, list, aParent);</span>
<a href="#l79.1774"></a><span id="l79.1774" class="difflineminus">-        if (pNewCard)</span>
<a href="#l79.1775"></a><span id="l79.1775" class="difflineminus">-          pAddressLists-&gt;ReplaceElementAt(pNewCard, i);</span>
<a href="#l79.1776"></a><span id="l79.1776" class="difflineplus">+        err = AddListCardColumnsToRow(pCard, listRow, pos,</span>
<a href="#l79.1777"></a><span id="l79.1777" class="difflineplus">+                                      getter_AddRefs(pNewCard), listHasCard,</span>
<a href="#l79.1778"></a><span id="l79.1778" class="difflineplus">+                                      list, aParent);</span>
<a href="#l79.1779"></a><span id="l79.1779" class="difflineplus">+        if (pNewCard) pAddressLists-&gt;ReplaceElementAt(pNewCard, i);</span>
<a href="#l79.1780"></a><span id="l79.1780">       }</span>
<a href="#l79.1781"></a><span id="l79.1781">     }</span>
<a href="#l79.1782"></a><span id="l79.1782">   }</span>
<a href="#l79.1783"></a><span id="l79.1783">   return NS_OK;</span>
<a href="#l79.1784"></a><span id="l79.1784"> }</span>
<a href="#l79.1785"></a><span id="l79.1785"> </span>
<a href="#l79.1786"></a><span id="l79.1786" class="difflineminus">-uint32_t nsAddrDatabase::GetListAddressTotal(nsIMdbRow* listRow)</span>
<a href="#l79.1787"></a><span id="l79.1787" class="difflineminus">-{</span>
<a href="#l79.1788"></a><span id="l79.1788" class="difflineplus">+uint32_t nsAddrDatabase::GetListAddressTotal(nsIMdbRow *listRow) {</span>
<a href="#l79.1789"></a><span id="l79.1789">   uint32_t count = 0;</span>
<a href="#l79.1790"></a><span id="l79.1790">   GetIntColumn(listRow, m_ListTotalColumnToken, &amp;count, 0);</span>
<a href="#l79.1791"></a><span id="l79.1791">   return count;</span>
<a href="#l79.1792"></a><span id="l79.1792"> }</span>
<a href="#l79.1793"></a><span id="l79.1793"> </span>
<a href="#l79.1794"></a><span id="l79.1794" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::SetListAddressTotal(nsIMdbRow* aListRow, uint32_t aTotal)</span>
<a href="#l79.1795"></a><span id="l79.1795" class="difflineminus">-{</span>
<a href="#l79.1796"></a><span id="l79.1796" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::SetListAddressTotal(nsIMdbRow *aListRow,</span>
<a href="#l79.1797"></a><span id="l79.1797" class="difflineplus">+                                                  uint32_t aTotal) {</span>
<a href="#l79.1798"></a><span id="l79.1798">   return AddIntColumn(aListRow, m_ListTotalColumnToken, aTotal);</span>
<a href="#l79.1799"></a><span id="l79.1799"> }</span>
<a href="#l79.1800"></a><span id="l79.1800"> </span>
<a href="#l79.1801"></a><span id="l79.1801" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::FindRowByCard(nsIAbCard * aCard,nsIMdbRow **aRow)</span>
<a href="#l79.1802"></a><span id="l79.1802" class="difflineminus">-{</span>
<a href="#l79.1803"></a><span id="l79.1803" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::FindRowByCard(nsIAbCard *aCard,</span>
<a href="#l79.1804"></a><span id="l79.1804" class="difflineplus">+                                            nsIMdbRow **aRow) {</span>
<a href="#l79.1805"></a><span id="l79.1805">   nsString primaryEmail;</span>
<a href="#l79.1806"></a><span id="l79.1806">   aCard-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l79.1807"></a><span id="l79.1807" class="difflineminus">-  return GetRowForCharColumn(primaryEmail.get(), m_PriEmailColumnToken,</span>
<a href="#l79.1808"></a><span id="l79.1808" class="difflineminus">-                             true, true, aRow, nullptr);</span>
<a href="#l79.1809"></a><span id="l79.1809" class="difflineplus">+  return GetRowForCharColumn(primaryEmail.get(), m_PriEmailColumnToken, true,</span>
<a href="#l79.1810"></a><span id="l79.1810" class="difflineplus">+                             true, aRow, nullptr);</span>
<a href="#l79.1811"></a><span id="l79.1811"> }</span>
<a href="#l79.1812"></a><span id="l79.1812"> </span>
<a href="#l79.1813"></a><span id="l79.1813" class="difflineminus">-nsresult nsAddrDatabase::GetAddressRowByPos(nsIMdbRow* listRow, uint16_t pos, nsIMdbRow** cardRow)</span>
<a href="#l79.1814"></a><span id="l79.1814" class="difflineminus">-{</span>
<a href="#l79.1815"></a><span id="l79.1815" class="difflineplus">+nsresult nsAddrDatabase::GetAddressRowByPos(nsIMdbRow *listRow, uint16_t pos,</span>
<a href="#l79.1816"></a><span id="l79.1816" class="difflineplus">+                                            nsIMdbRow **cardRow) {</span>
<a href="#l79.1817"></a><span id="l79.1817">   if (!m_mdbStore || !listRow || !cardRow || !m_mdbEnv)</span>
<a href="#l79.1818"></a><span id="l79.1818">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1819"></a><span id="l79.1819"> </span>
<a href="#l79.1820"></a><span id="l79.1820">   mdb_token listAddressColumnToken;</span>
<a href="#l79.1821"></a><span id="l79.1821"> </span>
<a href="#l79.1822"></a><span id="l79.1822">   char columnStr[COLUMN_STR_MAX];</span>
<a href="#l79.1823"></a><span id="l79.1823">   PR_snprintf(columnStr, COLUMN_STR_MAX, kMailListAddressFormat, pos);</span>
<a href="#l79.1824"></a><span id="l79.1824">   m_mdbStore-&gt;StringToToken(m_mdbEnv, columnStr, &amp;listAddressColumnToken);</span>
<a href="#l79.1825"></a><span id="l79.1825"> </span>
<a href="#l79.1826"></a><span id="l79.1826">   nsAutoString tempString;</span>
<a href="#l79.1827"></a><span id="l79.1827">   mdb_id rowID;</span>
<a href="#l79.1828"></a><span id="l79.1828" class="difflineminus">-  nsresult err = GetIntColumn(listRow, listAddressColumnToken, (uint32_t*)&amp;rowID, 0);</span>
<a href="#l79.1829"></a><span id="l79.1829" class="difflineplus">+  nsresult err =</span>
<a href="#l79.1830"></a><span id="l79.1830" class="difflineplus">+      GetIntColumn(listRow, listAddressColumnToken, (uint32_t *)&amp;rowID, 0);</span>
<a href="#l79.1831"></a><span id="l79.1831">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.1832"></a><span id="l79.1832"> </span>
<a href="#l79.1833"></a><span id="l79.1833">   return GetCardRowByRowID(rowID, cardRow);</span>
<a href="#l79.1834"></a><span id="l79.1834"> }</span>
<a href="#l79.1835"></a><span id="l79.1835"> </span>
<a href="#l79.1836"></a><span id="l79.1836" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::CreateMailListAndAddToDB(nsIAbDirectory *aNewList, bool aNotify /* = FALSE */, nsIAbDirectory *aParent)</span>
<a href="#l79.1837"></a><span id="l79.1837" class="difflineminus">-{</span>
<a href="#l79.1838"></a><span id="l79.1838" class="difflineminus">-  if (!aNewList || !m_mdbPabTable || !m_mdbEnv)</span>
<a href="#l79.1839"></a><span id="l79.1839" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1840"></a><span id="l79.1840" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::CreateMailListAndAddToDB(</span>
<a href="#l79.1841"></a><span id="l79.1841" class="difflineplus">+    nsIAbDirectory *aNewList, bool aNotify /* = FALSE */,</span>
<a href="#l79.1842"></a><span id="l79.1842" class="difflineplus">+    nsIAbDirectory *aParent) {</span>
<a href="#l79.1843"></a><span id="l79.1843" class="difflineplus">+  if (!aNewList || !m_mdbPabTable || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1844"></a><span id="l79.1844"> </span>
<a href="#l79.1845"></a><span id="l79.1845">   nsIMdbRow *listRow;</span>
<a href="#l79.1846"></a><span id="l79.1846">   nsresult err = GetNewListRow(&amp;listRow);</span>
<a href="#l79.1847"></a><span id="l79.1847"> </span>
<a href="#l79.1848"></a><span id="l79.1848" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; listRow)</span>
<a href="#l79.1849"></a><span id="l79.1849" class="difflineminus">-  {</span>
<a href="#l79.1850"></a><span id="l79.1850" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; listRow) {</span>
<a href="#l79.1851"></a><span id="l79.1851">     AddListAttributeColumnsToRow(aNewList, listRow, aParent);</span>
<a href="#l79.1852"></a><span id="l79.1852">     AddRecordKeyColumnToRow(listRow);</span>
<a href="#l79.1853"></a><span id="l79.1853">     nsresult merror = m_mdbPabTable-&gt;AddRow(m_mdbEnv, listRow);</span>
<a href="#l79.1854"></a><span id="l79.1854">     NS_ENSURE_SUCCESS(merror, NS_ERROR_FAILURE);</span>
<a href="#l79.1855"></a><span id="l79.1855"> </span>
<a href="#l79.1856"></a><span id="l79.1856">     nsCOMPtr&lt;nsIAbCard&gt; listCard;</span>
<a href="#l79.1857"></a><span id="l79.1857">     CreateABListCard(listRow, getter_AddRefs(listCard));</span>
<a href="#l79.1858"></a><span id="l79.1858">     NotifyCardEntryChange(AB_NotifyInserted, listCard, aParent);</span>
<a href="#l79.1859"></a><span id="l79.1859"> </span>
<a href="#l79.1860"></a><span id="l79.1860">     NS_RELEASE(listRow);</span>
<a href="#l79.1861"></a><span id="l79.1861">     return NS_OK;</span>
<a href="#l79.1862"></a><span id="l79.1862">   }</span>
<a href="#l79.1863"></a><span id="l79.1863"> </span>
<a href="#l79.1864"></a><span id="l79.1864">   return NS_ERROR_FAILURE;</span>
<a href="#l79.1865"></a><span id="l79.1865"> }</span>
<a href="#l79.1866"></a><span id="l79.1866"> </span>
<a href="#l79.1867"></a><span id="l79.1867" class="difflineminus">-void nsAddrDatabase::DeleteCardFromAllMailLists(mdb_id cardRowID)</span>
<a href="#l79.1868"></a><span id="l79.1868" class="difflineminus">-{</span>
<a href="#l79.1869"></a><span id="l79.1869" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.1870"></a><span id="l79.1870" class="difflineminus">-    return;</span>
<a href="#l79.1871"></a><span id="l79.1871" class="difflineminus">-</span>
<a href="#l79.1872"></a><span id="l79.1872" class="difflineminus">-  nsCOMPtr &lt;nsIMdbTableRowCursor&gt; rowCursor;</span>
<a href="#l79.1873"></a><span id="l79.1873" class="difflineplus">+void nsAddrDatabase::DeleteCardFromAllMailLists(mdb_id cardRowID) {</span>
<a href="#l79.1874"></a><span id="l79.1874" class="difflineplus">+  if (!m_mdbEnv) return;</span>
<a href="#l79.1875"></a><span id="l79.1875" class="difflineplus">+</span>
<a href="#l79.1876"></a><span id="l79.1876" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTableRowCursor&gt; rowCursor;</span>
<a href="#l79.1877"></a><span id="l79.1877">   m_mdbPabTable-&gt;GetTableRowCursor(m_mdbEnv, -1, getter_AddRefs(rowCursor));</span>
<a href="#l79.1878"></a><span id="l79.1878"> </span>
<a href="#l79.1879"></a><span id="l79.1879" class="difflineminus">-  if (rowCursor)</span>
<a href="#l79.1880"></a><span id="l79.1880" class="difflineminus">-  {</span>
<a href="#l79.1881"></a><span id="l79.1881" class="difflineminus">-    nsCOMPtr &lt;nsIMdbRow&gt; pListRow;</span>
<a href="#l79.1882"></a><span id="l79.1882" class="difflineplus">+  if (rowCursor) {</span>
<a href="#l79.1883"></a><span id="l79.1883" class="difflineplus">+    nsCOMPtr&lt;nsIMdbRow&gt; pListRow;</span>
<a href="#l79.1884"></a><span id="l79.1884">     mdb_pos rowPos;</span>
<a href="#l79.1885"></a><span id="l79.1885" class="difflineminus">-    do</span>
<a href="#l79.1886"></a><span id="l79.1886" class="difflineminus">-    {</span>
<a href="#l79.1887"></a><span id="l79.1887" class="difflineminus">-      nsresult err = rowCursor-&gt;NextRow(m_mdbEnv, getter_AddRefs(pListRow), &amp;rowPos);</span>
<a href="#l79.1888"></a><span id="l79.1888" class="difflineminus">-</span>
<a href="#l79.1889"></a><span id="l79.1889" class="difflineminus">-      if (NS_SUCCEEDED(err) &amp;&amp; pListRow)</span>
<a href="#l79.1890"></a><span id="l79.1890" class="difflineminus">-      {</span>
<a href="#l79.1891"></a><span id="l79.1891" class="difflineplus">+    do {</span>
<a href="#l79.1892"></a><span id="l79.1892" class="difflineplus">+      nsresult err =</span>
<a href="#l79.1893"></a><span id="l79.1893" class="difflineplus">+          rowCursor-&gt;NextRow(m_mdbEnv, getter_AddRefs(pListRow), &amp;rowPos);</span>
<a href="#l79.1894"></a><span id="l79.1894" class="difflineplus">+</span>
<a href="#l79.1895"></a><span id="l79.1895" class="difflineplus">+      if (NS_SUCCEEDED(err) &amp;&amp; pListRow) {</span>
<a href="#l79.1896"></a><span id="l79.1896">         mdbOid rowOid;</span>
<a href="#l79.1897"></a><span id="l79.1897"> </span>
<a href="#l79.1898"></a><span id="l79.1898" class="difflineminus">-        if (NS_SUCCEEDED(pListRow-&gt;GetOid(m_mdbEnv, &amp;rowOid)))</span>
<a href="#l79.1899"></a><span id="l79.1899" class="difflineminus">-        {</span>
<a href="#l79.1900"></a><span id="l79.1900" class="difflineplus">+        if (NS_SUCCEEDED(pListRow-&gt;GetOid(m_mdbEnv, &amp;rowOid))) {</span>
<a href="#l79.1901"></a><span id="l79.1901">           if (IsListRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.1902"></a><span id="l79.1902">             DeleteCardFromListRow(pListRow, cardRowID);</span>
<a href="#l79.1903"></a><span id="l79.1903">         }</span>
<a href="#l79.1904"></a><span id="l79.1904">       }</span>
<a href="#l79.1905"></a><span id="l79.1905">     } while (pListRow);</span>
<a href="#l79.1906"></a><span id="l79.1906">   }</span>
<a href="#l79.1907"></a><span id="l79.1907"> }</span>
<a href="#l79.1908"></a><span id="l79.1908"> </span>
<a href="#l79.1909"></a><span id="l79.1909" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::DeleteCard(nsIAbCard *aCard, bool aNotify, nsIAbDirectory *aParent)</span>
<a href="#l79.1910"></a><span id="l79.1910" class="difflineminus">-{</span>
<a href="#l79.1911"></a><span id="l79.1911" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::DeleteCard(nsIAbCard *aCard, bool aNotify,</span>
<a href="#l79.1912"></a><span id="l79.1912" class="difflineplus">+                                         nsIAbDirectory *aParent) {</span>
<a href="#l79.1913"></a><span id="l79.1913">   if (!aCard || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.1914"></a><span id="l79.1914">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1915"></a><span id="l79.1915"> </span>
<a href="#l79.1916"></a><span id="l79.1916">   nsresult err = NS_OK;</span>
<a href="#l79.1917"></a><span id="l79.1917">   bool bIsMailList = false;</span>
<a href="#l79.1918"></a><span id="l79.1918">   aCard-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l79.1919"></a><span id="l79.1919"> </span>
<a href="#l79.1920"></a><span id="l79.1920">   // get the right row</span>
<a href="#l79.1921"></a><span id="l79.1921" class="difflineminus">-  nsIMdbRow* pCardRow = nullptr;</span>
<a href="#l79.1922"></a><span id="l79.1922" class="difflineplus">+  nsIMdbRow *pCardRow = nullptr;</span>
<a href="#l79.1923"></a><span id="l79.1923">   mdbOid rowOid;</span>
<a href="#l79.1924"></a><span id="l79.1924"> </span>
<a href="#l79.1925"></a><span id="l79.1925">   rowOid.mOid_Scope = bIsMailList ? m_ListRowScopeToken : m_CardRowScopeToken;</span>
<a href="#l79.1926"></a><span id="l79.1926"> </span>
<a href="#l79.1927"></a><span id="l79.1927">   err = aCard-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l79.1928"></a><span id="l79.1928">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.1929"></a><span id="l79.1929"> </span>
<a href="#l79.1930"></a><span id="l79.1930">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, &amp;pCardRow);</span>
<a href="#l79.1931"></a><span id="l79.1931" class="difflineminus">-  NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l79.1932"></a><span id="l79.1932" class="difflineminus">-  if (!pCardRow)</span>
<a href="#l79.1933"></a><span id="l79.1933" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.1934"></a><span id="l79.1934" class="difflineplus">+  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.1935"></a><span id="l79.1935" class="difflineplus">+  if (!pCardRow) return NS_OK;</span>
<a href="#l79.1936"></a><span id="l79.1936"> </span>
<a href="#l79.1937"></a><span id="l79.1937">   // Reset the directory id</span>
<a href="#l79.1938"></a><span id="l79.1938">   aCard-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l79.1939"></a><span id="l79.1939"> </span>
<a href="#l79.1940"></a><span id="l79.1940">   // And here a greeting from the quirky old past:</span>
<a href="#l79.1941"></a><span id="l79.1941">   // Before there was a &quot;deleted cards&quot; table where deleted cards</span>
<a href="#l79.1942"></a><span id="l79.1942">   // were stored for six month. If we find this table, we empty it out.</span>
<a href="#l79.1943"></a><span id="l79.1943">   if (!m_mdbDeletedCardsTableRemoved) {</span>
<a href="#l79.1944"></a><span id="l79.1944" class="difflineat">@@ -1546,157 +1500,151 @@ NS_IMETHODIMP nsAddrDatabase::DeleteCard</span>
<a href="#l79.1945"></a><span id="l79.1945">       deletedCardsTable-&gt;CutAllRows(m_mdbEnv);</span>
<a href="#l79.1946"></a><span id="l79.1946">       deletedCardsTable-&gt;Release();</span>
<a href="#l79.1947"></a><span id="l79.1947">       Commit(nsAddrDBCommitType::kCompressCommit);</span>
<a href="#l79.1948"></a><span id="l79.1948">     }</span>
<a href="#l79.1949"></a><span id="l79.1949">   }</span>
<a href="#l79.1950"></a><span id="l79.1950"> </span>
<a href="#l79.1951"></a><span id="l79.1951">   err = DeleteRow(m_mdbPabTable, pCardRow);</span>
<a href="#l79.1952"></a><span id="l79.1952"> </span>
<a href="#l79.1953"></a><span id="l79.1953" class="difflineminus">-  //delete the person card from all mailing list</span>
<a href="#l79.1954"></a><span id="l79.1954" class="difflineminus">-  if (!bIsMailList)</span>
<a href="#l79.1955"></a><span id="l79.1955" class="difflineminus">-    DeleteCardFromAllMailLists(rowOid.mOid_Id);</span>
<a href="#l79.1956"></a><span id="l79.1956" class="difflineplus">+  // delete the person card from all mailing list</span>
<a href="#l79.1957"></a><span id="l79.1957" class="difflineplus">+  if (!bIsMailList) DeleteCardFromAllMailLists(rowOid.mOid_Id);</span>
<a href="#l79.1958"></a><span id="l79.1958"> </span>
<a href="#l79.1959"></a><span id="l79.1959">   if (NS_SUCCEEDED(err)) {</span>
<a href="#l79.1960"></a><span id="l79.1960" class="difflineminus">-    if (aNotify)</span>
<a href="#l79.1961"></a><span id="l79.1961" class="difflineminus">-      NotifyCardEntryChange(AB_NotifyDeleted, aCard, aParent);</span>
<a href="#l79.1962"></a><span id="l79.1962" class="difflineplus">+    if (aNotify) NotifyCardEntryChange(AB_NotifyDeleted, aCard, aParent);</span>
<a href="#l79.1963"></a><span id="l79.1963">   }</span>
<a href="#l79.1964"></a><span id="l79.1964"> </span>
<a href="#l79.1965"></a><span id="l79.1965">   NS_RELEASE(pCardRow);</span>
<a href="#l79.1966"></a><span id="l79.1966">   return NS_OK;</span>
<a href="#l79.1967"></a><span id="l79.1967"> }</span>
<a href="#l79.1968"></a><span id="l79.1968"> </span>
<a href="#l79.1969"></a><span id="l79.1969" class="difflineminus">-nsresult nsAddrDatabase::DeleteCardFromListRow(nsIMdbRow* pListRow, mdb_id cardRowID)</span>
<a href="#l79.1970"></a><span id="l79.1970" class="difflineminus">-{</span>
<a href="#l79.1971"></a><span id="l79.1971" class="difflineplus">+nsresult nsAddrDatabase::DeleteCardFromListRow(nsIMdbRow *pListRow,</span>
<a href="#l79.1972"></a><span id="l79.1972" class="difflineplus">+                                               mdb_id cardRowID) {</span>
<a href="#l79.1973"></a><span id="l79.1973">   NS_ENSURE_ARG_POINTER(pListRow);</span>
<a href="#l79.1974"></a><span id="l79.1974" class="difflineminus">-  if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.1975"></a><span id="l79.1975" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1976"></a><span id="l79.1976" class="difflineplus">+  if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.1977"></a><span id="l79.1977"> </span>
<a href="#l79.1978"></a><span id="l79.1978">   nsresult err = NS_OK;</span>
<a href="#l79.1979"></a><span id="l79.1979"> </span>
<a href="#l79.1980"></a><span id="l79.1980">   uint32_t totalAddress = GetListAddressTotal(pListRow);</span>
<a href="#l79.1981"></a><span id="l79.1981"> </span>
<a href="#l79.1982"></a><span id="l79.1982">   uint32_t pos;</span>
<a href="#l79.1983"></a><span id="l79.1983" class="difflineminus">-  for (pos = 1; pos &lt;= totalAddress; pos++)</span>
<a href="#l79.1984"></a><span id="l79.1984" class="difflineminus">-  {</span>
<a href="#l79.1985"></a><span id="l79.1985" class="difflineplus">+  for (pos = 1; pos &lt;= totalAddress; pos++) {</span>
<a href="#l79.1986"></a><span id="l79.1986">     mdb_token listAddressColumnToken;</span>
<a href="#l79.1987"></a><span id="l79.1987">     mdb_id rowID;</span>
<a href="#l79.1988"></a><span id="l79.1988"> </span>
<a href="#l79.1989"></a><span id="l79.1989">     char columnStr[COLUMN_STR_MAX];</span>
<a href="#l79.1990"></a><span id="l79.1990">     PR_snprintf(columnStr, COLUMN_STR_MAX, kMailListAddressFormat, pos);</span>
<a href="#l79.1991"></a><span id="l79.1991">     m_mdbStore-&gt;StringToToken(m_mdbEnv, columnStr, &amp;listAddressColumnToken);</span>
<a href="#l79.1992"></a><span id="l79.1992"> </span>
<a href="#l79.1993"></a><span id="l79.1993" class="difflineminus">-    err = GetIntColumn(pListRow, listAddressColumnToken, (uint32_t*)&amp;rowID, 0);</span>
<a href="#l79.1994"></a><span id="l79.1994" class="difflineminus">-</span>
<a href="#l79.1995"></a><span id="l79.1995" class="difflineminus">-    if (cardRowID == rowID)</span>
<a href="#l79.1996"></a><span id="l79.1996" class="difflineminus">-    {</span>
<a href="#l79.1997"></a><span id="l79.1997" class="difflineplus">+    err = GetIntColumn(pListRow, listAddressColumnToken, (uint32_t *)&amp;rowID, 0);</span>
<a href="#l79.1998"></a><span id="l79.1998" class="difflineplus">+</span>
<a href="#l79.1999"></a><span id="l79.1999" class="difflineplus">+    if (cardRowID == rowID) {</span>
<a href="#l79.2000"></a><span id="l79.2000">       if (pos == totalAddress)</span>
<a href="#l79.2001"></a><span id="l79.2001">         err = pListRow-&gt;CutColumn(m_mdbEnv, listAddressColumnToken);</span>
<a href="#l79.2002"></a><span id="l79.2002" class="difflineminus">-      else</span>
<a href="#l79.2003"></a><span id="l79.2003" class="difflineminus">-      {</span>
<a href="#l79.2004"></a><span id="l79.2004" class="difflineminus">-        //replace the deleted one with the last one and delete the last one</span>
<a href="#l79.2005"></a><span id="l79.2005" class="difflineplus">+      else {</span>
<a href="#l79.2006"></a><span id="l79.2006" class="difflineplus">+        // replace the deleted one with the last one and delete the last one</span>
<a href="#l79.2007"></a><span id="l79.2007">         mdb_id lastRowID;</span>
<a href="#l79.2008"></a><span id="l79.2008">         mdb_token lastAddressColumnToken;</span>
<a href="#l79.2009"></a><span id="l79.2009" class="difflineminus">-        PR_snprintf(columnStr, COLUMN_STR_MAX, kMailListAddressFormat, totalAddress);</span>
<a href="#l79.2010"></a><span id="l79.2010" class="difflineplus">+        PR_snprintf(columnStr, COLUMN_STR_MAX, kMailListAddressFormat,</span>
<a href="#l79.2011"></a><span id="l79.2011" class="difflineplus">+                    totalAddress);</span>
<a href="#l79.2012"></a><span id="l79.2012">         m_mdbStore-&gt;StringToToken(m_mdbEnv, columnStr, &amp;lastAddressColumnToken);</span>
<a href="#l79.2013"></a><span id="l79.2013"> </span>
<a href="#l79.2014"></a><span id="l79.2014" class="difflineminus">-        err = GetIntColumn(pListRow, lastAddressColumnToken, (uint32_t*)&amp;lastRowID, 0);</span>
<a href="#l79.2015"></a><span id="l79.2015" class="difflineplus">+        err = GetIntColumn(pListRow, lastAddressColumnToken,</span>
<a href="#l79.2016"></a><span id="l79.2016" class="difflineplus">+                           (uint32_t *)&amp;lastRowID, 0);</span>
<a href="#l79.2017"></a><span id="l79.2017">         NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2018"></a><span id="l79.2018"> </span>
<a href="#l79.2019"></a><span id="l79.2019">         err = AddIntColumn(pListRow, listAddressColumnToken, lastRowID);</span>
<a href="#l79.2020"></a><span id="l79.2020">         NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2021"></a><span id="l79.2021"> </span>
<a href="#l79.2022"></a><span id="l79.2022">         err = pListRow-&gt;CutColumn(m_mdbEnv, lastAddressColumnToken);</span>
<a href="#l79.2023"></a><span id="l79.2023">         NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2024"></a><span id="l79.2024">       }</span>
<a href="#l79.2025"></a><span id="l79.2025"> </span>
<a href="#l79.2026"></a><span id="l79.2026">       // Reset total count after the card has been deleted.</span>
<a href="#l79.2027"></a><span id="l79.2027" class="difflineminus">-      SetListAddressTotal(pListRow, totalAddress-1);</span>
<a href="#l79.2028"></a><span id="l79.2028" class="difflineplus">+      SetListAddressTotal(pListRow, totalAddress - 1);</span>
<a href="#l79.2029"></a><span id="l79.2029">       break;</span>
<a href="#l79.2030"></a><span id="l79.2030">     }</span>
<a href="#l79.2031"></a><span id="l79.2031">   }</span>
<a href="#l79.2032"></a><span id="l79.2032"> </span>
<a href="#l79.2033"></a><span id="l79.2033">   return NS_OK;</span>
<a href="#l79.2034"></a><span id="l79.2034"> }</span>
<a href="#l79.2035"></a><span id="l79.2035"> </span>
<a href="#l79.2036"></a><span id="l79.2036" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::DeleteCardFromMailList(nsIAbDirectory *mailList, nsIAbCard *card, bool aNotify)</span>
<a href="#l79.2037"></a><span id="l79.2037" class="difflineminus">-{</span>
<a href="#l79.2038"></a><span id="l79.2038" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::DeleteCardFromMailList(nsIAbDirectory *mailList,</span>
<a href="#l79.2039"></a><span id="l79.2039" class="difflineplus">+                                                     nsIAbCard *card,</span>
<a href="#l79.2040"></a><span id="l79.2040" class="difflineplus">+                                                     bool aNotify) {</span>
<a href="#l79.2041"></a><span id="l79.2041">   if (!card || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.2042"></a><span id="l79.2042">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2043"></a><span id="l79.2043"> </span>
<a href="#l79.2044"></a><span id="l79.2044">   nsresult err = NS_OK;</span>
<a href="#l79.2045"></a><span id="l79.2045"> </span>
<a href="#l79.2046"></a><span id="l79.2046">   // get the right row</span>
<a href="#l79.2047"></a><span id="l79.2047" class="difflineminus">-  nsIMdbRow* pListRow = nullptr;</span>
<a href="#l79.2048"></a><span id="l79.2048" class="difflineplus">+  nsIMdbRow *pListRow = nullptr;</span>
<a href="#l79.2049"></a><span id="l79.2049">   mdbOid listRowOid;</span>
<a href="#l79.2050"></a><span id="l79.2050">   listRowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l79.2051"></a><span id="l79.2051"> </span>
<a href="#l79.2052"></a><span id="l79.2052" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList,&amp;err));</span>
<a href="#l79.2053"></a><span id="l79.2053" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;err));</span>
<a href="#l79.2054"></a><span id="l79.2054">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2055"></a><span id="l79.2055"> </span>
<a href="#l79.2056"></a><span id="l79.2056" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t*)&amp;listRowOid.mOid_Id);</span>
<a href="#l79.2057"></a><span id="l79.2057" class="difflineplus">+  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;listRowOid.mOid_Id);</span>
<a href="#l79.2058"></a><span id="l79.2058"> </span>
<a href="#l79.2059"></a><span id="l79.2059">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;listRowOid, &amp;pListRow);</span>
<a href="#l79.2060"></a><span id="l79.2060" class="difflineminus">-  NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l79.2061"></a><span id="l79.2061" class="difflineminus">-  if (!pListRow)</span>
<a href="#l79.2062"></a><span id="l79.2062" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.2063"></a><span id="l79.2063" class="difflineplus">+  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2064"></a><span id="l79.2064" class="difflineplus">+  if (!pListRow) return NS_OK;</span>
<a href="#l79.2065"></a><span id="l79.2065"> </span>
<a href="#l79.2066"></a><span id="l79.2066">   uint32_t cardRowID;</span>
<a href="#l79.2067"></a><span id="l79.2067"> </span>
<a href="#l79.2068"></a><span id="l79.2068">   err = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;cardRowID);</span>
<a href="#l79.2069"></a><span id="l79.2069" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l79.2070"></a><span id="l79.2070" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2071"></a><span id="l79.2071" class="difflineplus">+  if (NS_FAILED(err)) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2072"></a><span id="l79.2072"> </span>
<a href="#l79.2073"></a><span id="l79.2073">   err = DeleteCardFromListRow(pListRow, cardRowID);</span>
<a href="#l79.2074"></a><span id="l79.2074">   if (NS_SUCCEEDED(err) &amp;&amp; aNotify) {</span>
<a href="#l79.2075"></a><span id="l79.2075">     NotifyCardEntryChange(AB_NotifyDeleted, card, mailList);</span>
<a href="#l79.2076"></a><span id="l79.2076">   }</span>
<a href="#l79.2077"></a><span id="l79.2077">   NS_RELEASE(pListRow);</span>
<a href="#l79.2078"></a><span id="l79.2078">   return NS_OK;</span>
<a href="#l79.2079"></a><span id="l79.2079"> }</span>
<a href="#l79.2080"></a><span id="l79.2080"> </span>
<a href="#l79.2081"></a><span id="l79.2081" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::SetCardValue(nsIAbCard *card, const char *name, const char16_t *value, bool notify)</span>
<a href="#l79.2082"></a><span id="l79.2082" class="difflineminus">-{</span>
<a href="#l79.2083"></a><span id="l79.2083" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::SetCardValue(nsIAbCard *card, const char *name,</span>
<a href="#l79.2084"></a><span id="l79.2084" class="difflineplus">+                                           const char16_t *value, bool notify) {</span>
<a href="#l79.2085"></a><span id="l79.2085">   NS_ENSURE_ARG_POINTER(card);</span>
<a href="#l79.2086"></a><span id="l79.2086">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l79.2087"></a><span id="l79.2087">   NS_ENSURE_ARG_POINTER(value);</span>
<a href="#l79.2088"></a><span id="l79.2088" class="difflineminus">-  if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.2089"></a><span id="l79.2089" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2090"></a><span id="l79.2090" class="difflineplus">+  if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2091"></a><span id="l79.2091"> </span>
<a href="#l79.2092"></a><span id="l79.2092">   nsresult rv = NS_OK;</span>
<a href="#l79.2093"></a><span id="l79.2093"> </span>
<a href="#l79.2094"></a><span id="l79.2094" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2095"></a><span id="l79.2095" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2096"></a><span id="l79.2096">   mdbOid rowOid;</span>
<a href="#l79.2097"></a><span id="l79.2097">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l79.2098"></a><span id="l79.2098"> </span>
<a href="#l79.2099"></a><span id="l79.2099">   // it might be that the caller always has a nsAbMDBCard</span>
<a href="#l79.2100"></a><span id="l79.2100">   rv = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l79.2101"></a><span id="l79.2101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2102"></a><span id="l79.2102"> </span>
<a href="#l79.2103"></a><span id="l79.2103">   rv = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(cardRow));</span>
<a href="#l79.2104"></a><span id="l79.2104">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2105"></a><span id="l79.2105"> </span>
<a href="#l79.2106"></a><span id="l79.2106" class="difflineminus">-  if (!cardRow)</span>
<a href="#l79.2107"></a><span id="l79.2107" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.2108"></a><span id="l79.2108" class="difflineplus">+  if (!cardRow) return NS_OK;</span>
<a href="#l79.2109"></a><span id="l79.2109"> </span>
<a href="#l79.2110"></a><span id="l79.2110">   mdb_token token;</span>
<a href="#l79.2111"></a><span id="l79.2111">   rv = m_mdbStore-&gt;StringToToken(m_mdbEnv, name, &amp;token);</span>
<a href="#l79.2112"></a><span id="l79.2112">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2113"></a><span id="l79.2113"> </span>
<a href="#l79.2114"></a><span id="l79.2114" class="difflineminus">-  return AddCharStringColumn(cardRow, token, NS_ConvertUTF16toUTF8(value).get());</span>
<a href="#l79.2115"></a><span id="l79.2115" class="difflineplus">+  return AddCharStringColumn(cardRow, token,</span>
<a href="#l79.2116"></a><span id="l79.2116" class="difflineplus">+                             NS_ConvertUTF16toUTF8(value).get());</span>
<a href="#l79.2117"></a><span id="l79.2117"> }</span>
<a href="#l79.2118"></a><span id="l79.2118"> </span>
<a href="#l79.2119"></a><span id="l79.2119" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::GetCardValue(nsIAbCard *card, const char *name, char16_t **value)</span>
<a href="#l79.2120"></a><span id="l79.2120" class="difflineminus">-{</span>
<a href="#l79.2121"></a><span id="l79.2121" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::GetCardValue(nsIAbCard *card, const char *name,</span>
<a href="#l79.2122"></a><span id="l79.2122" class="difflineplus">+                                           char16_t **value) {</span>
<a href="#l79.2123"></a><span id="l79.2123">   if (!m_mdbStore || !card || !name || !value || !m_mdbEnv)</span>
<a href="#l79.2124"></a><span id="l79.2124">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2125"></a><span id="l79.2125"> </span>
<a href="#l79.2126"></a><span id="l79.2126">   nsresult rv = NS_OK;</span>
<a href="#l79.2127"></a><span id="l79.2127"> </span>
<a href="#l79.2128"></a><span id="l79.2128" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2129"></a><span id="l79.2129" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2130"></a><span id="l79.2130">   mdbOid rowOid;</span>
<a href="#l79.2131"></a><span id="l79.2131">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l79.2132"></a><span id="l79.2132"> </span>
<a href="#l79.2133"></a><span id="l79.2133">   // it might be that the caller always has a nsAbMDBCard</span>
<a href="#l79.2134"></a><span id="l79.2134">   rv = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l79.2135"></a><span id="l79.2135">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2136"></a><span id="l79.2136"> </span>
<a href="#l79.2137"></a><span id="l79.2137">   rv = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(cardRow));</span>
<a href="#l79.2138"></a><span id="l79.2138" class="difflineat">@@ -1717,59 +1665,55 @@ NS_IMETHODIMP nsAddrDatabase::GetCardVal</span>
<a href="#l79.2139"></a><span id="l79.2139">   rv = GetStringColumn(cardRow, token, tempString);</span>
<a href="#l79.2140"></a><span id="l79.2140">   if (NS_FAILED(rv)) {</span>
<a href="#l79.2141"></a><span id="l79.2141">     // not all cards are going this column</span>
<a href="#l79.2142"></a><span id="l79.2142">     *value = nullptr;</span>
<a href="#l79.2143"></a><span id="l79.2143">     return NS_OK;</span>
<a href="#l79.2144"></a><span id="l79.2144">   }</span>
<a href="#l79.2145"></a><span id="l79.2145"> </span>
<a href="#l79.2146"></a><span id="l79.2146">   *value = NS_xstrdup(tempString.get());</span>
<a href="#l79.2147"></a><span id="l79.2147" class="difflineminus">-  if (!*value)</span>
<a href="#l79.2148"></a><span id="l79.2148" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l79.2149"></a><span id="l79.2149" class="difflineplus">+  if (!*value) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l79.2150"></a><span id="l79.2150">   return NS_OK;</span>
<a href="#l79.2151"></a><span id="l79.2151"> }</span>
<a href="#l79.2152"></a><span id="l79.2152"> </span>
<a href="#l79.2153"></a><span id="l79.2153" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::EditCard(nsIAbCard *aCard, bool aNotify, nsIAbDirectory *aParent)</span>
<a href="#l79.2154"></a><span id="l79.2154" class="difflineminus">-{</span>
<a href="#l79.2155"></a><span id="l79.2155" class="difflineminus">-  // XXX make sure this isn't getting called when we're just editing one or two well known fields</span>
<a href="#l79.2156"></a><span id="l79.2156" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::EditCard(nsIAbCard *aCard, bool aNotify,</span>
<a href="#l79.2157"></a><span id="l79.2157" class="difflineplus">+                                       nsIAbDirectory *aParent) {</span>
<a href="#l79.2158"></a><span id="l79.2158" class="difflineplus">+  // XXX make sure this isn't getting called when we're just editing one or two</span>
<a href="#l79.2159"></a><span id="l79.2159" class="difflineplus">+  // well known fields</span>
<a href="#l79.2160"></a><span id="l79.2160">   if (!aCard || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.2161"></a><span id="l79.2161">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2162"></a><span id="l79.2162"> </span>
<a href="#l79.2163"></a><span id="l79.2163">   nsresult err = NS_OK;</span>
<a href="#l79.2164"></a><span id="l79.2164"> </span>
<a href="#l79.2165"></a><span id="l79.2165" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2166"></a><span id="l79.2166" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2167"></a><span id="l79.2167">   mdbOid rowOid;</span>
<a href="#l79.2168"></a><span id="l79.2168">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l79.2169"></a><span id="l79.2169"> </span>
<a href="#l79.2170"></a><span id="l79.2170">   uint32_t nowInSeconds;</span>
<a href="#l79.2171"></a><span id="l79.2171">   PRTime now = PR_Now();</span>
<a href="#l79.2172"></a><span id="l79.2172">   PRTime2Seconds(now, &amp;nowInSeconds);</span>
<a href="#l79.2173"></a><span id="l79.2173">   aCard-&gt;SetPropertyAsUint32(kLastModifiedDateProperty, nowInSeconds);</span>
<a href="#l79.2174"></a><span id="l79.2174">   err = aCard-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l79.2175"></a><span id="l79.2175">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2176"></a><span id="l79.2176"> </span>
<a href="#l79.2177"></a><span id="l79.2177">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(cardRow));</span>
<a href="#l79.2178"></a><span id="l79.2178">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2179"></a><span id="l79.2179"> </span>
<a href="#l79.2180"></a><span id="l79.2180" class="difflineminus">-  if (!cardRow)</span>
<a href="#l79.2181"></a><span id="l79.2181" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.2182"></a><span id="l79.2182" class="difflineplus">+  if (!cardRow) return NS_OK;</span>
<a href="#l79.2183"></a><span id="l79.2183"> </span>
<a href="#l79.2184"></a><span id="l79.2184">   err = AddAttributeColumnsToRow(aCard, cardRow);</span>
<a href="#l79.2185"></a><span id="l79.2185">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2186"></a><span id="l79.2186"> </span>
<a href="#l79.2187"></a><span id="l79.2187" class="difflineminus">-  if (aNotify)</span>
<a href="#l79.2188"></a><span id="l79.2188" class="difflineminus">-    NotifyCardEntryChange(AB_NotifyPropertyChanged, aCard, aParent);</span>
<a href="#l79.2189"></a><span id="l79.2189" class="difflineplus">+  if (aNotify) NotifyCardEntryChange(AB_NotifyPropertyChanged, aCard, aParent);</span>
<a href="#l79.2190"></a><span id="l79.2190"> </span>
<a href="#l79.2191"></a><span id="l79.2191">   return NS_OK;</span>
<a href="#l79.2192"></a><span id="l79.2192"> }</span>
<a href="#l79.2193"></a><span id="l79.2193"> </span>
<a href="#l79.2194"></a><span id="l79.2194" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::ContainsCard(nsIAbCard *card, bool *hasCard)</span>
<a href="#l79.2195"></a><span id="l79.2195" class="difflineminus">-{</span>
<a href="#l79.2196"></a><span id="l79.2196" class="difflineminus">-  if (!card || !m_mdbPabTable || !m_mdbEnv)</span>
<a href="#l79.2197"></a><span id="l79.2197" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2198"></a><span id="l79.2198" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::ContainsCard(nsIAbCard *card, bool *hasCard) {</span>
<a href="#l79.2199"></a><span id="l79.2199" class="difflineplus">+  if (!card || !m_mdbPabTable || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2200"></a><span id="l79.2200"> </span>
<a href="#l79.2201"></a><span id="l79.2201">   nsresult err = NS_OK;</span>
<a href="#l79.2202"></a><span id="l79.2202">   mdb_bool hasOid;</span>
<a href="#l79.2203"></a><span id="l79.2203">   mdbOid rowOid;</span>
<a href="#l79.2204"></a><span id="l79.2204">   bool bIsMailList;</span>
<a href="#l79.2205"></a><span id="l79.2205"> </span>
<a href="#l79.2206"></a><span id="l79.2206">   card-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l79.2207"></a><span id="l79.2207"> </span>
<a href="#l79.2208"></a><span id="l79.2208" class="difflineat">@@ -1777,173 +1721,160 @@ NS_IMETHODIMP nsAddrDatabase::ContainsCa</span>
<a href="#l79.2209"></a><span id="l79.2209">     rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l79.2210"></a><span id="l79.2210">   else</span>
<a href="#l79.2211"></a><span id="l79.2211">     rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l79.2212"></a><span id="l79.2212"> </span>
<a href="#l79.2213"></a><span id="l79.2213">   err = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l79.2214"></a><span id="l79.2214">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2215"></a><span id="l79.2215"> </span>
<a href="#l79.2216"></a><span id="l79.2216">   err = m_mdbPabTable-&gt;HasOid(m_mdbEnv, &amp;rowOid, &amp;hasOid);</span>
<a href="#l79.2217"></a><span id="l79.2217" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l79.2218"></a><span id="l79.2218" class="difflineminus">-  {</span>
<a href="#l79.2219"></a><span id="l79.2219" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l79.2220"></a><span id="l79.2220">     *hasCard = hasOid;</span>
<a href="#l79.2221"></a><span id="l79.2221">   }</span>
<a href="#l79.2222"></a><span id="l79.2222"> </span>
<a href="#l79.2223"></a><span id="l79.2223">   return err;</span>
<a href="#l79.2224"></a><span id="l79.2224"> }</span>
<a href="#l79.2225"></a><span id="l79.2225"> </span>
<a href="#l79.2226"></a><span id="l79.2226"> NS_IMETHODIMP nsAddrDatabase::DeleteMailList(nsIAbDirectory *aMailList,</span>
<a href="#l79.2227"></a><span id="l79.2227" class="difflineminus">-                                             nsIAbDirectory *aParent)</span>
<a href="#l79.2228"></a><span id="l79.2228" class="difflineminus">-{</span>
<a href="#l79.2229"></a><span id="l79.2229" class="difflineplus">+                                             nsIAbDirectory *aParent) {</span>
<a href="#l79.2230"></a><span id="l79.2230">   if (!aMailList || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.2231"></a><span id="l79.2231">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2232"></a><span id="l79.2232"> </span>
<a href="#l79.2233"></a><span id="l79.2233">   nsresult err = NS_OK;</span>
<a href="#l79.2234"></a><span id="l79.2234"> </span>
<a href="#l79.2235"></a><span id="l79.2235">   // get the row</span>
<a href="#l79.2236"></a><span id="l79.2236">   nsCOMPtr&lt;nsIMdbRow&gt; pListRow;</span>
<a href="#l79.2237"></a><span id="l79.2237">   mdbOid rowOid;</span>
<a href="#l79.2238"></a><span id="l79.2238">   rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l79.2239"></a><span id="l79.2239"> </span>
<a href="#l79.2240"></a><span id="l79.2240">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(aMailList, &amp;err));</span>
<a href="#l79.2241"></a><span id="l79.2241">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2242"></a><span id="l79.2242" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t*)&amp;rowOid.mOid_Id);</span>
<a href="#l79.2243"></a><span id="l79.2243" class="difflineplus">+  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;rowOid.mOid_Id);</span>
<a href="#l79.2244"></a><span id="l79.2244"> </span>
<a href="#l79.2245"></a><span id="l79.2245">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(pListRow));</span>
<a href="#l79.2246"></a><span id="l79.2246" class="difflineminus">-  NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l79.2247"></a><span id="l79.2247" class="difflineminus">-</span>
<a href="#l79.2248"></a><span id="l79.2248" class="difflineminus">-  if (!pListRow)</span>
<a href="#l79.2249"></a><span id="l79.2249" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.2250"></a><span id="l79.2250" class="difflineplus">+  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2251"></a><span id="l79.2251" class="difflineplus">+</span>
<a href="#l79.2252"></a><span id="l79.2252" class="difflineplus">+  if (!pListRow) return NS_OK;</span>
<a href="#l79.2253"></a><span id="l79.2253"> </span>
<a href="#l79.2254"></a><span id="l79.2254">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l79.2255"></a><span id="l79.2255">   err = CreateABListCard(pListRow, getter_AddRefs(card));</span>
<a href="#l79.2256"></a><span id="l79.2256">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2257"></a><span id="l79.2257"> </span>
<a href="#l79.2258"></a><span id="l79.2258">   err = DeleteRow(m_mdbPabTable, pListRow);</span>
<a href="#l79.2259"></a><span id="l79.2259"> </span>
<a href="#l79.2260"></a><span id="l79.2260">   if (NS_SUCCEEDED(err) &amp;&amp; aParent)</span>
<a href="#l79.2261"></a><span id="l79.2261">     NotifyCardEntryChange(AB_NotifyDeleted, card, aParent);</span>
<a href="#l79.2262"></a><span id="l79.2262"> </span>
<a href="#l79.2263"></a><span id="l79.2263">   return err;</span>
<a href="#l79.2264"></a><span id="l79.2264"> }</span>
<a href="#l79.2265"></a><span id="l79.2265"> </span>
<a href="#l79.2266"></a><span id="l79.2266" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::EditMailList(nsIAbDirectory *mailList, nsIAbCard *listCard, bool notify)</span>
<a href="#l79.2267"></a><span id="l79.2267" class="difflineminus">-{</span>
<a href="#l79.2268"></a><span id="l79.2268" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::EditMailList(nsIAbDirectory *mailList,</span>
<a href="#l79.2269"></a><span id="l79.2269" class="difflineplus">+                                           nsIAbCard *listCard, bool notify) {</span>
<a href="#l79.2270"></a><span id="l79.2270">   if (!mailList || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.2271"></a><span id="l79.2271">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2272"></a><span id="l79.2272"> </span>
<a href="#l79.2273"></a><span id="l79.2273">   nsresult err = NS_OK;</span>
<a href="#l79.2274"></a><span id="l79.2274"> </span>
<a href="#l79.2275"></a><span id="l79.2275" class="difflineminus">-  nsIMdbRow* pListRow = nullptr;</span>
<a href="#l79.2276"></a><span id="l79.2276" class="difflineplus">+  nsIMdbRow *pListRow = nullptr;</span>
<a href="#l79.2277"></a><span id="l79.2277">   mdbOid rowOid;</span>
<a href="#l79.2278"></a><span id="l79.2278">   rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l79.2279"></a><span id="l79.2279"> </span>
<a href="#l79.2280"></a><span id="l79.2280">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;err));</span>
<a href="#l79.2281"></a><span id="l79.2281">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2282"></a><span id="l79.2282" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t*)&amp;rowOid.mOid_Id);</span>
<a href="#l79.2283"></a><span id="l79.2283" class="difflineplus">+  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;rowOid.mOid_Id);</span>
<a href="#l79.2284"></a><span id="l79.2284"> </span>
<a href="#l79.2285"></a><span id="l79.2285">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, &amp;pListRow);</span>
<a href="#l79.2286"></a><span id="l79.2286">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2287"></a><span id="l79.2287"> </span>
<a href="#l79.2288"></a><span id="l79.2288" class="difflineminus">-  if (!pListRow)</span>
<a href="#l79.2289"></a><span id="l79.2289" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.2290"></a><span id="l79.2290" class="difflineplus">+  if (!pListRow) return NS_OK;</span>
<a href="#l79.2291"></a><span id="l79.2291"> </span>
<a href="#l79.2292"></a><span id="l79.2292">   err = AddListAttributeColumnsToRow(mailList, pListRow, mailList);</span>
<a href="#l79.2293"></a><span id="l79.2293">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2294"></a><span id="l79.2294"> </span>
<a href="#l79.2295"></a><span id="l79.2295" class="difflineminus">-  if (notify)</span>
<a href="#l79.2296"></a><span id="l79.2296" class="difflineminus">-  {</span>
<a href="#l79.2297"></a><span id="l79.2297" class="difflineplus">+  if (notify) {</span>
<a href="#l79.2298"></a><span id="l79.2298">     NotifyListEntryChange(AB_NotifyPropertyChanged, mailList);</span>
<a href="#l79.2299"></a><span id="l79.2299"> </span>
<a href="#l79.2300"></a><span id="l79.2300" class="difflineminus">-    if (listCard)</span>
<a href="#l79.2301"></a><span id="l79.2301" class="difflineminus">-    {</span>
<a href="#l79.2302"></a><span id="l79.2302" class="difflineplus">+    if (listCard) {</span>
<a href="#l79.2303"></a><span id="l79.2303">       NotifyCardEntryChange(AB_NotifyPropertyChanged, listCard, mailList);</span>
<a href="#l79.2304"></a><span id="l79.2304">     }</span>
<a href="#l79.2305"></a><span id="l79.2305"> </span>
<a href="#l79.2306"></a><span id="l79.2306" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService = mozilla::services::GetObserverService();</span>
<a href="#l79.2307"></a><span id="l79.2307" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l79.2308"></a><span id="l79.2308" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l79.2309"></a><span id="l79.2309">     if (observerService) {</span>
<a href="#l79.2310"></a><span id="l79.2310" class="difflineminus">-      observerService-&gt;NotifyObservers(mailList, &quot;addrbook-list-updated&quot;, nullptr);</span>
<a href="#l79.2311"></a><span id="l79.2311" class="difflineplus">+      observerService-&gt;NotifyObservers(mailList, &quot;addrbook-list-updated&quot;,</span>
<a href="#l79.2312"></a><span id="l79.2312" class="difflineplus">+                                       nullptr);</span>
<a href="#l79.2313"></a><span id="l79.2313">     }</span>
<a href="#l79.2314"></a><span id="l79.2314">   }</span>
<a href="#l79.2315"></a><span id="l79.2315"> </span>
<a href="#l79.2316"></a><span id="l79.2316">   NS_RELEASE(pListRow);</span>
<a href="#l79.2317"></a><span id="l79.2317">   return NS_OK;</span>
<a href="#l79.2318"></a><span id="l79.2318"> }</span>
<a href="#l79.2319"></a><span id="l79.2319"> </span>
<a href="#l79.2320"></a><span id="l79.2320" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::ContainsMailList(nsIAbDirectory *mailList, bool *hasList)</span>
<a href="#l79.2321"></a><span id="l79.2321" class="difflineminus">-{</span>
<a href="#l79.2322"></a><span id="l79.2322" class="difflineminus">-  if (!mailList || !m_mdbPabTable || !m_mdbEnv)</span>
<a href="#l79.2323"></a><span id="l79.2323" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2324"></a><span id="l79.2324" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::ContainsMailList(nsIAbDirectory *mailList,</span>
<a href="#l79.2325"></a><span id="l79.2325" class="difflineplus">+                                               bool *hasList) {</span>
<a href="#l79.2326"></a><span id="l79.2326" class="difflineplus">+  if (!mailList || !m_mdbPabTable || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2327"></a><span id="l79.2327"> </span>
<a href="#l79.2328"></a><span id="l79.2328">   nsresult err = NS_OK;</span>
<a href="#l79.2329"></a><span id="l79.2329">   mdb_bool hasOid;</span>
<a href="#l79.2330"></a><span id="l79.2330">   mdbOid rowOid;</span>
<a href="#l79.2331"></a><span id="l79.2331"> </span>
<a href="#l79.2332"></a><span id="l79.2332">   rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l79.2333"></a><span id="l79.2333"> </span>
<a href="#l79.2334"></a><span id="l79.2334" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList,&amp;err));</span>
<a href="#l79.2335"></a><span id="l79.2335" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;err));</span>
<a href="#l79.2336"></a><span id="l79.2336">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2337"></a><span id="l79.2337" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t*)&amp;rowOid.mOid_Id);</span>
<a href="#l79.2338"></a><span id="l79.2338" class="difflineplus">+  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;rowOid.mOid_Id);</span>
<a href="#l79.2339"></a><span id="l79.2339"> </span>
<a href="#l79.2340"></a><span id="l79.2340">   err = m_mdbPabTable-&gt;HasOid(m_mdbEnv, &amp;rowOid, &amp;hasOid);</span>
<a href="#l79.2341"></a><span id="l79.2341" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l79.2342"></a><span id="l79.2342" class="difflineminus">-    *hasList = hasOid;</span>
<a href="#l79.2343"></a><span id="l79.2343" class="difflineplus">+  if (NS_SUCCEEDED(err)) *hasList = hasOid;</span>
<a href="#l79.2344"></a><span id="l79.2344"> </span>
<a href="#l79.2345"></a><span id="l79.2345">   return (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.2346"></a><span id="l79.2346"> }</span>
<a href="#l79.2347"></a><span id="l79.2347"> </span>
<a href="#l79.2348"></a><span id="l79.2348" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::GetNewRow(nsIMdbRow * *newRow)</span>
<a href="#l79.2349"></a><span id="l79.2349" class="difflineminus">-{</span>
<a href="#l79.2350"></a><span id="l79.2350" class="difflineminus">-  if (!m_mdbStore || !newRow || !m_mdbEnv)</span>
<a href="#l79.2351"></a><span id="l79.2351" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2352"></a><span id="l79.2352" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::GetNewRow(nsIMdbRow **newRow) {</span>
<a href="#l79.2353"></a><span id="l79.2353" class="difflineplus">+  if (!m_mdbStore || !newRow || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2354"></a><span id="l79.2354"> </span>
<a href="#l79.2355"></a><span id="l79.2355">   return m_mdbStore-&gt;NewRow(m_mdbEnv, m_CardRowScopeToken, newRow);</span>
<a href="#l79.2356"></a><span id="l79.2356"> }</span>
<a href="#l79.2357"></a><span id="l79.2357"> </span>
<a href="#l79.2358"></a><span id="l79.2358" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::GetNewListRow(nsIMdbRow * *newRow)</span>
<a href="#l79.2359"></a><span id="l79.2359" class="difflineminus">-{</span>
<a href="#l79.2360"></a><span id="l79.2360" class="difflineminus">-  if (!m_mdbStore || !newRow || !m_mdbEnv)</span>
<a href="#l79.2361"></a><span id="l79.2361" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2362"></a><span id="l79.2362" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::GetNewListRow(nsIMdbRow **newRow) {</span>
<a href="#l79.2363"></a><span id="l79.2363" class="difflineplus">+  if (!m_mdbStore || !newRow || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2364"></a><span id="l79.2364"> </span>
<a href="#l79.2365"></a><span id="l79.2365">   return m_mdbStore-&gt;NewRow(m_mdbEnv, m_ListRowScopeToken, newRow);</span>
<a href="#l79.2366"></a><span id="l79.2366"> }</span>
<a href="#l79.2367"></a><span id="l79.2367"> </span>
<a href="#l79.2368"></a><span id="l79.2368" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::AddCardRowToDB(nsIMdbRow *newRow)</span>
<a href="#l79.2369"></a><span id="l79.2369" class="difflineminus">-{</span>
<a href="#l79.2370"></a><span id="l79.2370" class="difflineminus">-  if (m_mdbPabTable &amp;&amp; m_mdbEnv)</span>
<a href="#l79.2371"></a><span id="l79.2371" class="difflineminus">-  {</span>
<a href="#l79.2372"></a><span id="l79.2372" class="difflineminus">-    if (NS_SUCCEEDED(m_mdbPabTable-&gt;AddRow(m_mdbEnv, newRow)))</span>
<a href="#l79.2373"></a><span id="l79.2373" class="difflineminus">-    {</span>
<a href="#l79.2374"></a><span id="l79.2374" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::AddCardRowToDB(nsIMdbRow *newRow) {</span>
<a href="#l79.2375"></a><span id="l79.2375" class="difflineplus">+  if (m_mdbPabTable &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.2376"></a><span id="l79.2376" class="difflineplus">+    if (NS_SUCCEEDED(m_mdbPabTable-&gt;AddRow(m_mdbEnv, newRow))) {</span>
<a href="#l79.2377"></a><span id="l79.2377">       AddRecordKeyColumnToRow(newRow);</span>
<a href="#l79.2378"></a><span id="l79.2378">       return NS_OK;</span>
<a href="#l79.2379"></a><span id="l79.2379">     }</span>
<a href="#l79.2380"></a><span id="l79.2380">   }</span>
<a href="#l79.2381"></a><span id="l79.2381"> </span>
<a href="#l79.2382"></a><span id="l79.2382">   return NS_ERROR_FAILURE;</span>
<a href="#l79.2383"></a><span id="l79.2383"> }</span>
<a href="#l79.2384"></a><span id="l79.2384"> </span>
<a href="#l79.2385"></a><span id="l79.2385" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::AddLdifListMember(nsIMdbRow* listRow, const char* value)</span>
<a href="#l79.2386"></a><span id="l79.2386" class="difflineminus">-{</span>
<a href="#l79.2387"></a><span id="l79.2387" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::AddLdifListMember(nsIMdbRow *listRow,</span>
<a href="#l79.2388"></a><span id="l79.2388" class="difflineplus">+                                                const char *value) {</span>
<a href="#l79.2389"></a><span id="l79.2389">   if (!m_mdbStore || !listRow || !value || !m_mdbEnv)</span>
<a href="#l79.2390"></a><span id="l79.2390">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2391"></a><span id="l79.2391"> </span>
<a href="#l79.2392"></a><span id="l79.2392">   uint32_t total = GetListAddressTotal(listRow);</span>
<a href="#l79.2393"></a><span id="l79.2393" class="difflineminus">-  //add member</span>
<a href="#l79.2394"></a><span id="l79.2394" class="difflineplus">+  // add member</span>
<a href="#l79.2395"></a><span id="l79.2395">   nsAutoCString valueString(value);</span>
<a href="#l79.2396"></a><span id="l79.2396">   nsAutoCString email;</span>
<a href="#l79.2397"></a><span id="l79.2397">   int32_t emailPos = valueString.Find(&quot;mail=&quot;);</span>
<a href="#l79.2398"></a><span id="l79.2398">   emailPos += strlen(&quot;mail=&quot;);</span>
<a href="#l79.2399"></a><span id="l79.2399">   email = Substring(valueString, emailPos);</span>
<a href="#l79.2400"></a><span id="l79.2400" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2401"></a><span id="l79.2401" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2402"></a><span id="l79.2402">   // Please DO NOT change the 3rd param of GetRowFromAttribute() call to</span>
<a href="#l79.2403"></a><span id="l79.2403">   // true (ie, case insensitive) without reading bugs #128535 and #121478.</span>
<a href="#l79.2404"></a><span id="l79.2404" class="difflineminus">-  nsresult rv = GetRowFromAttribute(kPriEmailProperty, email, false /* retain case */,</span>
<a href="#l79.2405"></a><span id="l79.2405" class="difflineminus">-                                    getter_AddRefs(cardRow), nullptr);</span>
<a href="#l79.2406"></a><span id="l79.2406" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; cardRow)</span>
<a href="#l79.2407"></a><span id="l79.2407" class="difflineminus">-  {</span>
<a href="#l79.2408"></a><span id="l79.2408" class="difflineplus">+  nsresult rv =</span>
<a href="#l79.2409"></a><span id="l79.2409" class="difflineplus">+      GetRowFromAttribute(kPriEmailProperty, email, false /* retain case */,</span>
<a href="#l79.2410"></a><span id="l79.2410" class="difflineplus">+                          getter_AddRefs(cardRow), nullptr);</span>
<a href="#l79.2411"></a><span id="l79.2411" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; cardRow) {</span>
<a href="#l79.2412"></a><span id="l79.2412">     mdbOid outOid;</span>
<a href="#l79.2413"></a><span id="l79.2413">     mdb_id rowID = 0;</span>
<a href="#l79.2414"></a><span id="l79.2414">     if (NS_SUCCEEDED(cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid)))</span>
<a href="#l79.2415"></a><span id="l79.2415">       rowID = outOid.mOid_Id;</span>
<a href="#l79.2416"></a><span id="l79.2416"> </span>
<a href="#l79.2417"></a><span id="l79.2417">     // start from 1</span>
<a href="#l79.2418"></a><span id="l79.2418">     total += 1;</span>
<a href="#l79.2419"></a><span id="l79.2419">     mdb_token listAddressColumnToken;</span>
<a href="#l79.2420"></a><span id="l79.2420" class="difflineat">@@ -1954,891 +1885,791 @@ NS_IMETHODIMP nsAddrDatabase::AddLdifLis</span>
<a href="#l79.2421"></a><span id="l79.2421">     rv = AddIntColumn(listRow, listAddressColumnToken, rowID);</span>
<a href="#l79.2422"></a><span id="l79.2422">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2423"></a><span id="l79.2423"> </span>
<a href="#l79.2424"></a><span id="l79.2424">     SetListAddressTotal(listRow, total);</span>
<a href="#l79.2425"></a><span id="l79.2425">   }</span>
<a href="#l79.2426"></a><span id="l79.2426">   return NS_OK;</span>
<a href="#l79.2427"></a><span id="l79.2427"> }</span>
<a href="#l79.2428"></a><span id="l79.2428"> </span>
<a href="#l79.2429"></a><span id="l79.2429" class="difflineminus">-</span>
<a href="#l79.2430"></a><span id="l79.2430" class="difflineminus">-void nsAddrDatabase::GetCharStringYarn(char* str, struct mdbYarn* strYarn)</span>
<a href="#l79.2431"></a><span id="l79.2431" class="difflineminus">-{</span>
<a href="#l79.2432"></a><span id="l79.2432" class="difflineplus">+void nsAddrDatabase::GetCharStringYarn(char *str, struct mdbYarn *strYarn) {</span>
<a href="#l79.2433"></a><span id="l79.2433">   strYarn-&gt;mYarn_Grow = nullptr;</span>
<a href="#l79.2434"></a><span id="l79.2434">   strYarn-&gt;mYarn_Buf = str;</span>
<a href="#l79.2435"></a><span id="l79.2435" class="difflineminus">-  strYarn-&gt;mYarn_Size = PL_strlen((const char *) strYarn-&gt;mYarn_Buf) + 1;</span>
<a href="#l79.2436"></a><span id="l79.2436" class="difflineplus">+  strYarn-&gt;mYarn_Size = PL_strlen((const char *)strYarn-&gt;mYarn_Buf) + 1;</span>
<a href="#l79.2437"></a><span id="l79.2437">   strYarn-&gt;mYarn_Fill = strYarn-&gt;mYarn_Size - 1;</span>
<a href="#l79.2438"></a><span id="l79.2438">   strYarn-&gt;mYarn_Form = 0;</span>
<a href="#l79.2439"></a><span id="l79.2439"> }</span>
<a href="#l79.2440"></a><span id="l79.2440"> </span>
<a href="#l79.2441"></a><span id="l79.2441" class="difflineminus">-void nsAddrDatabase::GetStringYarn(const nsAString &amp; aStr, struct mdbYarn* strYarn)</span>
<a href="#l79.2442"></a><span id="l79.2442" class="difflineminus">-{</span>
<a href="#l79.2443"></a><span id="l79.2443" class="difflineplus">+void nsAddrDatabase::GetStringYarn(const nsAString &amp;aStr,</span>
<a href="#l79.2444"></a><span id="l79.2444" class="difflineplus">+                                   struct mdbYarn *strYarn) {</span>
<a href="#l79.2445"></a><span id="l79.2445">   strYarn-&gt;mYarn_Buf = ToNewUTF8String(aStr);</span>
<a href="#l79.2446"></a><span id="l79.2446" class="difflineminus">-  strYarn-&gt;mYarn_Size = PL_strlen((const char *) strYarn-&gt;mYarn_Buf) + 1;</span>
<a href="#l79.2447"></a><span id="l79.2447" class="difflineplus">+  strYarn-&gt;mYarn_Size = PL_strlen((const char *)strYarn-&gt;mYarn_Buf) + 1;</span>
<a href="#l79.2448"></a><span id="l79.2448">   strYarn-&gt;mYarn_Fill = strYarn-&gt;mYarn_Size - 1;</span>
<a href="#l79.2449"></a><span id="l79.2449">   strYarn-&gt;mYarn_Form = 0;</span>
<a href="#l79.2450"></a><span id="l79.2450"> }</span>
<a href="#l79.2451"></a><span id="l79.2451"> </span>
<a href="#l79.2452"></a><span id="l79.2452" class="difflineminus">-void nsAddrDatabase::GetIntYarn(uint32_t nValue, struct mdbYarn* intYarn)</span>
<a href="#l79.2453"></a><span id="l79.2453" class="difflineminus">-{</span>
<a href="#l79.2454"></a><span id="l79.2454" class="difflineplus">+void nsAddrDatabase::GetIntYarn(uint32_t nValue, struct mdbYarn *intYarn) {</span>
<a href="#l79.2455"></a><span id="l79.2455">   intYarn-&gt;mYarn_Fill = intYarn-&gt;mYarn_Size;</span>
<a href="#l79.2456"></a><span id="l79.2456">   intYarn-&gt;mYarn_Form = 0;</span>
<a href="#l79.2457"></a><span id="l79.2457">   intYarn-&gt;mYarn_Grow = nullptr;</span>
<a href="#l79.2458"></a><span id="l79.2458"> </span>
<a href="#l79.2459"></a><span id="l79.2459" class="difflineminus">-  PR_snprintf((char*)intYarn-&gt;mYarn_Buf, intYarn-&gt;mYarn_Size, &quot;%lx&quot;, nValue);</span>
<a href="#l79.2460"></a><span id="l79.2460" class="difflineminus">-  intYarn-&gt;mYarn_Fill = PL_strlen((const char *) intYarn-&gt;mYarn_Buf);</span>
<a href="#l79.2461"></a><span id="l79.2461" class="difflineplus">+  PR_snprintf((char *)intYarn-&gt;mYarn_Buf, intYarn-&gt;mYarn_Size, &quot;%lx&quot;, nValue);</span>
<a href="#l79.2462"></a><span id="l79.2462" class="difflineplus">+  intYarn-&gt;mYarn_Fill = PL_strlen((const char *)intYarn-&gt;mYarn_Buf);</span>
<a href="#l79.2463"></a><span id="l79.2463"> }</span>
<a href="#l79.2464"></a><span id="l79.2464"> </span>
<a href="#l79.2465"></a><span id="l79.2465" class="difflineminus">-nsresult nsAddrDatabase::AddCharStringColumn(nsIMdbRow* cardRow, mdb_column inColumn, const char* str)</span>
<a href="#l79.2466"></a><span id="l79.2466" class="difflineminus">-{</span>
<a href="#l79.2467"></a><span id="l79.2467" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.2468"></a><span id="l79.2468" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2469"></a><span id="l79.2469" class="difflineplus">+nsresult nsAddrDatabase::AddCharStringColumn(nsIMdbRow *cardRow,</span>
<a href="#l79.2470"></a><span id="l79.2470" class="difflineplus">+                                             mdb_column inColumn,</span>
<a href="#l79.2471"></a><span id="l79.2471" class="difflineplus">+                                             const char *str) {</span>
<a href="#l79.2472"></a><span id="l79.2472" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2473"></a><span id="l79.2473"> </span>
<a href="#l79.2474"></a><span id="l79.2474">   struct mdbYarn yarn;</span>
<a href="#l79.2475"></a><span id="l79.2475"> </span>
<a href="#l79.2476"></a><span id="l79.2476" class="difflineminus">-  GetCharStringYarn((char *) str, &amp;yarn);</span>
<a href="#l79.2477"></a><span id="l79.2477" class="difflineplus">+  GetCharStringYarn((char *)str, &amp;yarn);</span>
<a href="#l79.2478"></a><span id="l79.2478">   nsresult err = cardRow-&gt;AddColumn(m_mdbEnv, inColumn, &amp;yarn);</span>
<a href="#l79.2479"></a><span id="l79.2479"> </span>
<a href="#l79.2480"></a><span id="l79.2480">   return (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.2481"></a><span id="l79.2481"> }</span>
<a href="#l79.2482"></a><span id="l79.2482"> </span>
<a href="#l79.2483"></a><span id="l79.2483" class="difflineminus">-nsresult nsAddrDatabase::AddStringColumn(nsIMdbRow* aCardRow, mdb_column aInColumn, const nsAString &amp; aStr)</span>
<a href="#l79.2484"></a><span id="l79.2484" class="difflineminus">-{</span>
<a href="#l79.2485"></a><span id="l79.2485" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.2486"></a><span id="l79.2486" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2487"></a><span id="l79.2487" class="difflineplus">+nsresult nsAddrDatabase::AddStringColumn(nsIMdbRow *aCardRow,</span>
<a href="#l79.2488"></a><span id="l79.2488" class="difflineplus">+                                         mdb_column aInColumn,</span>
<a href="#l79.2489"></a><span id="l79.2489" class="difflineplus">+                                         const nsAString &amp;aStr) {</span>
<a href="#l79.2490"></a><span id="l79.2490" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2491"></a><span id="l79.2491"> </span>
<a href="#l79.2492"></a><span id="l79.2492">   struct mdbYarn yarn;</span>
<a href="#l79.2493"></a><span id="l79.2493"> </span>
<a href="#l79.2494"></a><span id="l79.2494">   GetStringYarn(aStr, &amp;yarn);</span>
<a href="#l79.2495"></a><span id="l79.2495">   nsresult err = aCardRow-&gt;AddColumn(m_mdbEnv, aInColumn, &amp;yarn);</span>
<a href="#l79.2496"></a><span id="l79.2496"> </span>
<a href="#l79.2497"></a><span id="l79.2497">   return (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.2498"></a><span id="l79.2498"> }</span>
<a href="#l79.2499"></a><span id="l79.2499"> </span>
<a href="#l79.2500"></a><span id="l79.2500" class="difflineminus">-nsresult nsAddrDatabase::AddIntColumn(nsIMdbRow* cardRow, mdb_column inColumn, uint32_t nValue)</span>
<a href="#l79.2501"></a><span id="l79.2501" class="difflineminus">-{</span>
<a href="#l79.2502"></a><span id="l79.2502" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.2503"></a><span id="l79.2503" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2504"></a><span id="l79.2504" class="difflineplus">+nsresult nsAddrDatabase::AddIntColumn(nsIMdbRow *cardRow, mdb_column inColumn,</span>
<a href="#l79.2505"></a><span id="l79.2505" class="difflineplus">+                                      uint32_t nValue) {</span>
<a href="#l79.2506"></a><span id="l79.2506" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2507"></a><span id="l79.2507"> </span>
<a href="#l79.2508"></a><span id="l79.2508">   struct mdbYarn yarn;</span>
<a href="#l79.2509"></a><span id="l79.2509">   char yarnBuf[100];</span>
<a href="#l79.2510"></a><span id="l79.2510"> </span>
<a href="#l79.2511"></a><span id="l79.2511" class="difflineminus">-  yarn.mYarn_Buf = (void *) yarnBuf;</span>
<a href="#l79.2512"></a><span id="l79.2512" class="difflineplus">+  yarn.mYarn_Buf = (void *)yarnBuf;</span>
<a href="#l79.2513"></a><span id="l79.2513">   yarn.mYarn_Size = sizeof(yarnBuf);</span>
<a href="#l79.2514"></a><span id="l79.2514">   GetIntYarn(nValue, &amp;yarn);</span>
<a href="#l79.2515"></a><span id="l79.2515">   nsresult err = cardRow-&gt;AddColumn(m_mdbEnv, inColumn, &amp;yarn);</span>
<a href="#l79.2516"></a><span id="l79.2516"> </span>
<a href="#l79.2517"></a><span id="l79.2517">   return (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.2518"></a><span id="l79.2518"> }</span>
<a href="#l79.2519"></a><span id="l79.2519"> </span>
<a href="#l79.2520"></a><span id="l79.2520" class="difflineminus">-nsresult nsAddrDatabase::AddBoolColumn(nsIMdbRow* cardRow, mdb_column inColumn, bool bValue)</span>
<a href="#l79.2521"></a><span id="l79.2521" class="difflineminus">-{</span>
<a href="#l79.2522"></a><span id="l79.2522" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.2523"></a><span id="l79.2523" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2524"></a><span id="l79.2524" class="difflineplus">+nsresult nsAddrDatabase::AddBoolColumn(nsIMdbRow *cardRow, mdb_column inColumn,</span>
<a href="#l79.2525"></a><span id="l79.2525" class="difflineplus">+                                       bool bValue) {</span>
<a href="#l79.2526"></a><span id="l79.2526" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2527"></a><span id="l79.2527"> </span>
<a href="#l79.2528"></a><span id="l79.2528">   struct mdbYarn yarn;</span>
<a href="#l79.2529"></a><span id="l79.2529">   char yarnBuf[100];</span>
<a href="#l79.2530"></a><span id="l79.2530"> </span>
<a href="#l79.2531"></a><span id="l79.2531" class="difflineminus">-  yarn.mYarn_Buf = (void *) yarnBuf;</span>
<a href="#l79.2532"></a><span id="l79.2532" class="difflineplus">+  yarn.mYarn_Buf = (void *)yarnBuf;</span>
<a href="#l79.2533"></a><span id="l79.2533">   yarn.mYarn_Size = sizeof(yarnBuf);</span>
<a href="#l79.2534"></a><span id="l79.2534"> </span>
<a href="#l79.2535"></a><span id="l79.2535">   GetIntYarn(bValue ? 1 : 0, &amp;yarn);</span>
<a href="#l79.2536"></a><span id="l79.2536"> </span>
<a href="#l79.2537"></a><span id="l79.2537">   nsresult err = cardRow-&gt;AddColumn(m_mdbEnv, inColumn, &amp;yarn);</span>
<a href="#l79.2538"></a><span id="l79.2538"> </span>
<a href="#l79.2539"></a><span id="l79.2539">   return (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.2540"></a><span id="l79.2540"> }</span>
<a href="#l79.2541"></a><span id="l79.2541"> </span>
<a href="#l79.2542"></a><span id="l79.2542" class="difflineminus">-nsresult nsAddrDatabase::GetStringColumn(nsIMdbRow *cardRow, mdb_token outToken, nsString&amp; str)</span>
<a href="#l79.2543"></a><span id="l79.2543" class="difflineminus">-{</span>
<a href="#l79.2544"></a><span id="l79.2544" class="difflineplus">+nsresult nsAddrDatabase::GetStringColumn(nsIMdbRow *cardRow, mdb_token outToken,</span>
<a href="#l79.2545"></a><span id="l79.2545" class="difflineplus">+                                         nsString &amp;str) {</span>
<a href="#l79.2546"></a><span id="l79.2546">   nsresult err = NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2547"></a><span id="l79.2547">   nsIMdbCell *cardCell;</span>
<a href="#l79.2548"></a><span id="l79.2548"> </span>
<a href="#l79.2549"></a><span id="l79.2549" class="difflineminus">-  if (cardRow &amp;&amp; m_mdbEnv)</span>
<a href="#l79.2550"></a><span id="l79.2550" class="difflineminus">-  {</span>
<a href="#l79.2551"></a><span id="l79.2551" class="difflineplus">+  if (cardRow &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.2552"></a><span id="l79.2552">     err = cardRow-&gt;GetCell(m_mdbEnv, outToken, &amp;cardCell);</span>
<a href="#l79.2553"></a><span id="l79.2553" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; cardCell)</span>
<a href="#l79.2554"></a><span id="l79.2554" class="difflineminus">-    {</span>
<a href="#l79.2555"></a><span id="l79.2555" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; cardCell) {</span>
<a href="#l79.2556"></a><span id="l79.2556">       struct mdbYarn yarn;</span>
<a href="#l79.2557"></a><span id="l79.2557">       cardCell-&gt;AliasYarn(m_mdbEnv, &amp;yarn);</span>
<a href="#l79.2558"></a><span id="l79.2558" class="difflineminus">-      NS_ConvertUTF8toUTF16 uniStr((const char*) yarn.mYarn_Buf, yarn.mYarn_Fill);</span>
<a href="#l79.2559"></a><span id="l79.2559" class="difflineplus">+      NS_ConvertUTF8toUTF16 uniStr((const char *)yarn.mYarn_Buf,</span>
<a href="#l79.2560"></a><span id="l79.2560" class="difflineplus">+                                   yarn.mYarn_Fill);</span>
<a href="#l79.2561"></a><span id="l79.2561">       if (!uniStr.IsEmpty())</span>
<a href="#l79.2562"></a><span id="l79.2562">         str.Assign(uniStr);</span>
<a href="#l79.2563"></a><span id="l79.2563">       else</span>
<a href="#l79.2564"></a><span id="l79.2564">         err = NS_ERROR_FAILURE;</span>
<a href="#l79.2565"></a><span id="l79.2565" class="difflineminus">-      cardCell-&gt;Release(); // always release ref</span>
<a href="#l79.2566"></a><span id="l79.2566" class="difflineminus">-    }</span>
<a href="#l79.2567"></a><span id="l79.2567" class="difflineminus">-    else</span>
<a href="#l79.2568"></a><span id="l79.2568" class="difflineplus">+      cardCell-&gt;Release();  // always release ref</span>
<a href="#l79.2569"></a><span id="l79.2569" class="difflineplus">+    } else</span>
<a href="#l79.2570"></a><span id="l79.2570">       err = NS_ERROR_FAILURE;</span>
<a href="#l79.2571"></a><span id="l79.2571">   }</span>
<a href="#l79.2572"></a><span id="l79.2572">   return err;</span>
<a href="#l79.2573"></a><span id="l79.2573"> }</span>
<a href="#l79.2574"></a><span id="l79.2574"> </span>
<a href="#l79.2575"></a><span id="l79.2575" class="difflineminus">-void nsAddrDatabase::YarnToUInt32(struct mdbYarn *yarn, uint32_t *pResult)</span>
<a href="#l79.2576"></a><span id="l79.2576" class="difflineminus">-{</span>
<a href="#l79.2577"></a><span id="l79.2577" class="difflineplus">+void nsAddrDatabase::YarnToUInt32(struct mdbYarn *yarn, uint32_t *pResult) {</span>
<a href="#l79.2578"></a><span id="l79.2578">   uint8_t numChars = std::min&lt;mdb_fill&gt;(8, yarn-&gt;mYarn_Fill);</span>
<a href="#l79.2579"></a><span id="l79.2579" class="difflineminus">-  *pResult = MsgUnhex((char *) yarn-&gt;mYarn_Buf, numChars);</span>
<a href="#l79.2580"></a><span id="l79.2580" class="difflineplus">+  *pResult = MsgUnhex((char *)yarn-&gt;mYarn_Buf, numChars);</span>
<a href="#l79.2581"></a><span id="l79.2581"> }</span>
<a href="#l79.2582"></a><span id="l79.2582"> </span>
<a href="#l79.2583"></a><span id="l79.2583" class="difflineminus">-nsresult nsAddrDatabase::GetIntColumn</span>
<a href="#l79.2584"></a><span id="l79.2584" class="difflineminus">-(nsIMdbRow *cardRow, mdb_token outToken, uint32_t* pValue, uint32_t defaultValue)</span>
<a href="#l79.2585"></a><span id="l79.2585" class="difflineminus">-{</span>
<a href="#l79.2586"></a><span id="l79.2586" class="difflineminus">-  nsresult    err = NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2587"></a><span id="l79.2587" class="difflineminus">-  nsIMdbCell    *cardCell;</span>
<a href="#l79.2588"></a><span id="l79.2588" class="difflineminus">-</span>
<a href="#l79.2589"></a><span id="l79.2589" class="difflineminus">-  if (pValue)</span>
<a href="#l79.2590"></a><span id="l79.2590" class="difflineminus">-      *pValue = defaultValue;</span>
<a href="#l79.2591"></a><span id="l79.2591" class="difflineminus">-  if (cardRow &amp;&amp; m_mdbEnv)</span>
<a href="#l79.2592"></a><span id="l79.2592" class="difflineminus">-  {</span>
<a href="#l79.2593"></a><span id="l79.2593" class="difflineplus">+nsresult nsAddrDatabase::GetIntColumn(nsIMdbRow *cardRow, mdb_token outToken,</span>
<a href="#l79.2594"></a><span id="l79.2594" class="difflineplus">+                                      uint32_t *pValue, uint32_t defaultValue) {</span>
<a href="#l79.2595"></a><span id="l79.2595" class="difflineplus">+  nsresult err = NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2596"></a><span id="l79.2596" class="difflineplus">+  nsIMdbCell *cardCell;</span>
<a href="#l79.2597"></a><span id="l79.2597" class="difflineplus">+</span>
<a href="#l79.2598"></a><span id="l79.2598" class="difflineplus">+  if (pValue) *pValue = defaultValue;</span>
<a href="#l79.2599"></a><span id="l79.2599" class="difflineplus">+  if (cardRow &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.2600"></a><span id="l79.2600">     err = cardRow-&gt;GetCell(m_mdbEnv, outToken, &amp;cardCell);</span>
<a href="#l79.2601"></a><span id="l79.2601" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; cardCell)</span>
<a href="#l79.2602"></a><span id="l79.2602" class="difflineminus">-    {</span>
<a href="#l79.2603"></a><span id="l79.2603" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; cardCell) {</span>
<a href="#l79.2604"></a><span id="l79.2604">       struct mdbYarn yarn;</span>
<a href="#l79.2605"></a><span id="l79.2605">       cardCell-&gt;AliasYarn(m_mdbEnv, &amp;yarn);</span>
<a href="#l79.2606"></a><span id="l79.2606">       YarnToUInt32(&amp;yarn, pValue);</span>
<a href="#l79.2607"></a><span id="l79.2607">       cardCell-&gt;Release();</span>
<a href="#l79.2608"></a><span id="l79.2608" class="difflineminus">-    }</span>
<a href="#l79.2609"></a><span id="l79.2609" class="difflineminus">-    else</span>
<a href="#l79.2610"></a><span id="l79.2610" class="difflineplus">+    } else</span>
<a href="#l79.2611"></a><span id="l79.2611">       err = NS_ERROR_FAILURE;</span>
<a href="#l79.2612"></a><span id="l79.2612">   }</span>
<a href="#l79.2613"></a><span id="l79.2613">   return err;</span>
<a href="#l79.2614"></a><span id="l79.2614"> }</span>
<a href="#l79.2615"></a><span id="l79.2615"> </span>
<a href="#l79.2616"></a><span id="l79.2616" class="difflineminus">-nsresult nsAddrDatabase::GetBoolColumn(nsIMdbRow *cardRow, mdb_token outToken, bool* pValue)</span>
<a href="#l79.2617"></a><span id="l79.2617" class="difflineminus">-{</span>
<a href="#l79.2618"></a><span id="l79.2618" class="difflineplus">+nsresult nsAddrDatabase::GetBoolColumn(nsIMdbRow *cardRow, mdb_token outToken,</span>
<a href="#l79.2619"></a><span id="l79.2619" class="difflineplus">+                                       bool *pValue) {</span>
<a href="#l79.2620"></a><span id="l79.2620">   NS_ENSURE_ARG_POINTER(pValue);</span>
<a href="#l79.2621"></a><span id="l79.2621"> </span>
<a href="#l79.2622"></a><span id="l79.2622" class="difflineminus">-  nsresult    err = NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2623"></a><span id="l79.2623" class="difflineminus">-  nsIMdbCell    *cardCell;</span>
<a href="#l79.2624"></a><span id="l79.2624" class="difflineplus">+  nsresult err = NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2625"></a><span id="l79.2625" class="difflineplus">+  nsIMdbCell *cardCell;</span>
<a href="#l79.2626"></a><span id="l79.2626">   uint32_t nValue = 0;</span>
<a href="#l79.2627"></a><span id="l79.2627"> </span>
<a href="#l79.2628"></a><span id="l79.2628" class="difflineminus">-  if (cardRow &amp;&amp; m_mdbEnv)</span>
<a href="#l79.2629"></a><span id="l79.2629" class="difflineminus">-  {</span>
<a href="#l79.2630"></a><span id="l79.2630" class="difflineplus">+  if (cardRow &amp;&amp; m_mdbEnv) {</span>
<a href="#l79.2631"></a><span id="l79.2631">     err = cardRow-&gt;GetCell(m_mdbEnv, outToken, &amp;cardCell);</span>
<a href="#l79.2632"></a><span id="l79.2632" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; cardCell)</span>
<a href="#l79.2633"></a><span id="l79.2633" class="difflineminus">-    {</span>
<a href="#l79.2634"></a><span id="l79.2634" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; cardCell) {</span>
<a href="#l79.2635"></a><span id="l79.2635">       struct mdbYarn yarn;</span>
<a href="#l79.2636"></a><span id="l79.2636">       cardCell-&gt;AliasYarn(m_mdbEnv, &amp;yarn);</span>
<a href="#l79.2637"></a><span id="l79.2637">       YarnToUInt32(&amp;yarn, &amp;nValue);</span>
<a href="#l79.2638"></a><span id="l79.2638">       cardCell-&gt;Release();</span>
<a href="#l79.2639"></a><span id="l79.2639" class="difflineminus">-    }</span>
<a href="#l79.2640"></a><span id="l79.2640" class="difflineminus">-    else</span>
<a href="#l79.2641"></a><span id="l79.2641" class="difflineplus">+    } else</span>
<a href="#l79.2642"></a><span id="l79.2642">       err = NS_ERROR_FAILURE;</span>
<a href="#l79.2643"></a><span id="l79.2643">   }</span>
<a href="#l79.2644"></a><span id="l79.2644"> </span>
<a href="#l79.2645"></a><span id="l79.2645">   *pValue = nValue ? true : false;</span>
<a href="#l79.2646"></a><span id="l79.2646">   return err;</span>
<a href="#l79.2647"></a><span id="l79.2647"> }</span>
<a href="#l79.2648"></a><span id="l79.2648"> </span>
<a href="#l79.2649"></a><span id="l79.2649"> /*  value is UTF8 string */</span>
<a href="#l79.2650"></a><span id="l79.2650" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::AddPrimaryEmail(nsIMdbRow *aRow, const char *aValue)</span>
<a href="#l79.2651"></a><span id="l79.2651" class="difflineminus">-{</span>
<a href="#l79.2652"></a><span id="l79.2652" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::AddPrimaryEmail(nsIMdbRow *aRow,</span>
<a href="#l79.2653"></a><span id="l79.2653" class="difflineplus">+                                              const char *aValue) {</span>
<a href="#l79.2654"></a><span id="l79.2654">   NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l79.2655"></a><span id="l79.2655"> </span>
<a href="#l79.2656"></a><span id="l79.2656">   nsresult rv = AddCharStringColumn(aRow, m_PriEmailColumnToken, aValue);</span>
<a href="#l79.2657"></a><span id="l79.2657" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.2658"></a><span id="l79.2658" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2659"></a><span id="l79.2659"> </span>
<a href="#l79.2660"></a><span id="l79.2660">   rv = AddLowercaseColumn(aRow, m_LowerPriEmailColumnToken, aValue);</span>
<a href="#l79.2661"></a><span id="l79.2661" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.2662"></a><span id="l79.2662" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2663"></a><span id="l79.2663">   return rv;</span>
<a href="#l79.2664"></a><span id="l79.2664"> }</span>
<a href="#l79.2665"></a><span id="l79.2665"> </span>
<a href="#l79.2666"></a><span id="l79.2666"> /*  value is UTF8 string */</span>
<a href="#l79.2667"></a><span id="l79.2667" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::Add2ndEmail(nsIMdbRow *aRow, const char *aValue)</span>
<a href="#l79.2668"></a><span id="l79.2668" class="difflineminus">-{</span>
<a href="#l79.2669"></a><span id="l79.2669" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::Add2ndEmail(nsIMdbRow *aRow, const char *aValue) {</span>
<a href="#l79.2670"></a><span id="l79.2670">   NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l79.2671"></a><span id="l79.2671"> </span>
<a href="#l79.2672"></a><span id="l79.2672">   nsresult rv = AddCharStringColumn(aRow, m_2ndEmailColumnToken, aValue);</span>
<a href="#l79.2673"></a><span id="l79.2673" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.2674"></a><span id="l79.2674" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2675"></a><span id="l79.2675"> </span>
<a href="#l79.2676"></a><span id="l79.2676">   rv = AddLowercaseColumn(aRow, m_Lower2ndEmailColumnToken, aValue);</span>
<a href="#l79.2677"></a><span id="l79.2677" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.2678"></a><span id="l79.2678" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2679"></a><span id="l79.2679">   return rv;</span>
<a href="#l79.2680"></a><span id="l79.2680"> }</span>
<a href="#l79.2681"></a><span id="l79.2681"> </span>
<a href="#l79.2682"></a><span id="l79.2682"> /*  value is UTF8 string */</span>
<a href="#l79.2683"></a><span id="l79.2683" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::AddListName(nsIMdbRow *aRow, const char *aValue)</span>
<a href="#l79.2684"></a><span id="l79.2684" class="difflineminus">-{</span>
<a href="#l79.2685"></a><span id="l79.2685" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::AddListName(nsIMdbRow *aRow, const char *aValue) {</span>
<a href="#l79.2686"></a><span id="l79.2686">   NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l79.2687"></a><span id="l79.2687"> </span>
<a href="#l79.2688"></a><span id="l79.2688">   nsresult rv = AddCharStringColumn(aRow, m_ListNameColumnToken, aValue);</span>
<a href="#l79.2689"></a><span id="l79.2689" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.2690"></a><span id="l79.2690" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2691"></a><span id="l79.2691"> </span>
<a href="#l79.2692"></a><span id="l79.2692">   rv = AddLowercaseColumn(aRow, m_LowerListNameColumnToken, aValue);</span>
<a href="#l79.2693"></a><span id="l79.2693" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.2694"></a><span id="l79.2694" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2695"></a><span id="l79.2695">   return rv;</span>
<a href="#l79.2696"></a><span id="l79.2696"> }</span>
<a href="#l79.2697"></a><span id="l79.2697"> </span>
<a href="#l79.2698"></a><span id="l79.2698"> /*</span>
<a href="#l79.2699"></a><span id="l79.2699"> columnValue is UTF8 string, need to convert back to lowercase unicode then</span>
<a href="#l79.2700"></a><span id="l79.2700"> back to UTF8 string</span>
<a href="#l79.2701"></a><span id="l79.2701"> */</span>
<a href="#l79.2702"></a><span id="l79.2702" class="difflineminus">-nsresult nsAddrDatabase::AddLowercaseColumn</span>
<a href="#l79.2703"></a><span id="l79.2703" class="difflineminus">-(nsIMdbRow * row, mdb_token columnToken, const char* columnValue)</span>
<a href="#l79.2704"></a><span id="l79.2704" class="difflineminus">-{</span>
<a href="#l79.2705"></a><span id="l79.2705" class="difflineplus">+nsresult nsAddrDatabase::AddLowercaseColumn(nsIMdbRow *row,</span>
<a href="#l79.2706"></a><span id="l79.2706" class="difflineplus">+                                            mdb_token columnToken,</span>
<a href="#l79.2707"></a><span id="l79.2707" class="difflineplus">+                                            const char *columnValue) {</span>
<a href="#l79.2708"></a><span id="l79.2708">   nsresult rv = NS_OK;</span>
<a href="#l79.2709"></a><span id="l79.2709" class="difflineminus">-  if (columnValue)</span>
<a href="#l79.2710"></a><span id="l79.2710" class="difflineminus">-  {</span>
<a href="#l79.2711"></a><span id="l79.2711" class="difflineplus">+  if (columnValue) {</span>
<a href="#l79.2712"></a><span id="l79.2712">     NS_ConvertUTF8toUTF16 newUnicodeString(columnValue);</span>
<a href="#l79.2713"></a><span id="l79.2713">     ToLowerCase(newUnicodeString);</span>
<a href="#l79.2714"></a><span id="l79.2714" class="difflineminus">-    rv = AddCharStringColumn(row, columnToken, NS_ConvertUTF16toUTF8(newUnicodeString).get());</span>
<a href="#l79.2715"></a><span id="l79.2715" class="difflineplus">+    rv = AddCharStringColumn(row, columnToken,</span>
<a href="#l79.2716"></a><span id="l79.2716" class="difflineplus">+                             NS_ConvertUTF16toUTF8(newUnicodeString).get());</span>
<a href="#l79.2717"></a><span id="l79.2717">   }</span>
<a href="#l79.2718"></a><span id="l79.2718">   return rv;</span>
<a href="#l79.2719"></a><span id="l79.2719"> }</span>
<a href="#l79.2720"></a><span id="l79.2720"> </span>
<a href="#l79.2721"></a><span id="l79.2721" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::InitCardFromRow(nsIAbCard *newCard, nsIMdbRow* cardRow)</span>
<a href="#l79.2722"></a><span id="l79.2722" class="difflineminus">-{</span>
<a href="#l79.2723"></a><span id="l79.2723" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::InitCardFromRow(nsIAbCard *newCard,</span>
<a href="#l79.2724"></a><span id="l79.2724" class="difflineplus">+                                              nsIMdbRow *cardRow) {</span>
<a href="#l79.2725"></a><span id="l79.2725">   nsresult rv = NS_OK;</span>
<a href="#l79.2726"></a><span id="l79.2726" class="difflineminus">-  if (!newCard || !cardRow || !m_mdbEnv)</span>
<a href="#l79.2727"></a><span id="l79.2727" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2728"></a><span id="l79.2728" class="difflineplus">+  if (!newCard || !cardRow || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2729"></a><span id="l79.2729"> </span>
<a href="#l79.2730"></a><span id="l79.2730">   nsCOMPtr&lt;nsIMdbRowCellCursor&gt; cursor;</span>
<a href="#l79.2731"></a><span id="l79.2731">   nsCOMPtr&lt;nsIMdbCell&gt; cell;</span>
<a href="#l79.2732"></a><span id="l79.2732"> </span>
<a href="#l79.2733"></a><span id="l79.2733">   rv = cardRow-&gt;GetRowCellCursor(m_mdbEnv, -1, getter_AddRefs(cursor));</span>
<a href="#l79.2734"></a><span id="l79.2734">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2735"></a><span id="l79.2735"> </span>
<a href="#l79.2736"></a><span id="l79.2736">   mdb_column columnNumber;</span>
<a href="#l79.2737"></a><span id="l79.2737">   char columnName[100];</span>
<a href="#l79.2738"></a><span id="l79.2738">   struct mdbYarn colYarn = {columnName, 0, sizeof(columnName), 0, 0, nullptr};</span>
<a href="#l79.2739"></a><span id="l79.2739">   struct mdbYarn cellYarn;</span>
<a href="#l79.2740"></a><span id="l79.2740"> </span>
<a href="#l79.2741"></a><span id="l79.2741" class="difflineminus">-  do</span>
<a href="#l79.2742"></a><span id="l79.2742" class="difflineminus">-  {</span>
<a href="#l79.2743"></a><span id="l79.2743" class="difflineminus">-    rv = cursor-&gt;NextCell(m_mdbEnv, getter_AddRefs(cell), &amp;columnNumber, nullptr);</span>
<a href="#l79.2744"></a><span id="l79.2744" class="difflineplus">+  do {</span>
<a href="#l79.2745"></a><span id="l79.2745" class="difflineplus">+    rv = cursor-&gt;NextCell(m_mdbEnv, getter_AddRefs(cell), &amp;columnNumber,</span>
<a href="#l79.2746"></a><span id="l79.2746" class="difflineplus">+                          nullptr);</span>
<a href="#l79.2747"></a><span id="l79.2747">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2748"></a><span id="l79.2748"> </span>
<a href="#l79.2749"></a><span id="l79.2749" class="difflineminus">-    if (!cell)</span>
<a href="#l79.2750"></a><span id="l79.2750" class="difflineminus">-      break;</span>
<a href="#l79.2751"></a><span id="l79.2751" class="difflineplus">+    if (!cell) break;</span>
<a href="#l79.2752"></a><span id="l79.2752"> </span>
<a href="#l79.2753"></a><span id="l79.2753">     // Get the value of the cell</span>
<a href="#l79.2754"></a><span id="l79.2754">     cell-&gt;AliasYarn(m_mdbEnv, &amp;cellYarn);</span>
<a href="#l79.2755"></a><span id="l79.2755" class="difflineminus">-    NS_ConvertUTF8toUTF16 value(static_cast&lt;const char*&gt;(cellYarn.mYarn_Buf),</span>
<a href="#l79.2756"></a><span id="l79.2756" class="difflineminus">-        cellYarn.mYarn_Fill);</span>
<a href="#l79.2757"></a><span id="l79.2757" class="difflineminus">-</span>
<a href="#l79.2758"></a><span id="l79.2758" class="difflineminus">-    if (!value.IsEmpty())</span>
<a href="#l79.2759"></a><span id="l79.2759" class="difflineminus">-    {</span>
<a href="#l79.2760"></a><span id="l79.2760" class="difflineplus">+    NS_ConvertUTF8toUTF16 value(static_cast&lt;const char *&gt;(cellYarn.mYarn_Buf),</span>
<a href="#l79.2761"></a><span id="l79.2761" class="difflineplus">+                                cellYarn.mYarn_Fill);</span>
<a href="#l79.2762"></a><span id="l79.2762" class="difflineplus">+</span>
<a href="#l79.2763"></a><span id="l79.2763" class="difflineplus">+    if (!value.IsEmpty()) {</span>
<a href="#l79.2764"></a><span id="l79.2764">       // Get the column of the cell</span>
<a href="#l79.2765"></a><span id="l79.2765">       // Mork makes this so hard...</span>
<a href="#l79.2766"></a><span id="l79.2766">       rv = m_mdbStore-&gt;TokenToString(m_mdbEnv, columnNumber, &amp;colYarn);</span>
<a href="#l79.2767"></a><span id="l79.2767">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.2768"></a><span id="l79.2768"> </span>
<a href="#l79.2769"></a><span id="l79.2769">       char *name = PL_strndup(static_cast&lt;char *&gt;(colYarn.mYarn_Buf),</span>
<a href="#l79.2770"></a><span id="l79.2770" class="difflineminus">-          colYarn.mYarn_Fill);</span>
<a href="#l79.2771"></a><span id="l79.2771" class="difflineplus">+                              colYarn.mYarn_Fill);</span>
<a href="#l79.2772"></a><span id="l79.2772">       newCard-&gt;SetPropertyAsAString(name, value);</span>
<a href="#l79.2773"></a><span id="l79.2773">       PL_strfree(name);</span>
<a href="#l79.2774"></a><span id="l79.2774">     }</span>
<a href="#l79.2775"></a><span id="l79.2775">   } while (true);</span>
<a href="#l79.2776"></a><span id="l79.2776"> </span>
<a href="#l79.2777"></a><span id="l79.2777">   uint32_t key = 0;</span>
<a href="#l79.2778"></a><span id="l79.2778">   rv = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l79.2779"></a><span id="l79.2779" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l79.2780"></a><span id="l79.2780" class="difflineminus">-    newCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l79.2781"></a><span id="l79.2781" class="difflineplus">+  if (NS_SUCCEEDED(rv)) newCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l79.2782"></a><span id="l79.2782"> </span>
<a href="#l79.2783"></a><span id="l79.2783">   return NS_OK;</span>
<a href="#l79.2784"></a><span id="l79.2784"> }</span>
<a href="#l79.2785"></a><span id="l79.2785"> </span>
<a href="#l79.2786"></a><span id="l79.2786" class="difflineminus">-nsresult nsAddrDatabase::GetListCardFromDB(nsIAbCard *listCard, nsIMdbRow* listRow)</span>
<a href="#l79.2787"></a><span id="l79.2787" class="difflineminus">-{</span>
<a href="#l79.2788"></a><span id="l79.2788" class="difflineminus">-  nsresult    err = NS_OK;</span>
<a href="#l79.2789"></a><span id="l79.2789" class="difflineminus">-  if (!listCard || !listRow)</span>
<a href="#l79.2790"></a><span id="l79.2790" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2791"></a><span id="l79.2791" class="difflineplus">+nsresult nsAddrDatabase::GetListCardFromDB(nsIAbCard *listCard,</span>
<a href="#l79.2792"></a><span id="l79.2792" class="difflineplus">+                                           nsIMdbRow *listRow) {</span>
<a href="#l79.2793"></a><span id="l79.2793" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l79.2794"></a><span id="l79.2794" class="difflineplus">+  if (!listCard || !listRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2795"></a><span id="l79.2795"> </span>
<a href="#l79.2796"></a><span id="l79.2796">   nsAutoString tempString;</span>
<a href="#l79.2797"></a><span id="l79.2797"> </span>
<a href="#l79.2798"></a><span id="l79.2798">   err = GetStringColumn(listRow, m_UIDColumnToken, tempString);</span>
<a href="#l79.2799"></a><span id="l79.2799" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2800"></a><span id="l79.2800" class="difflineminus">-  {</span>
<a href="#l79.2801"></a><span id="l79.2801" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2802"></a><span id="l79.2802">     listCard-&gt;SetPropertyAsAString(kUIDProperty, tempString);</span>
<a href="#l79.2803"></a><span id="l79.2803">   }</span>
<a href="#l79.2804"></a><span id="l79.2804">   err = GetStringColumn(listRow, m_ListNameColumnToken, tempString);</span>
<a href="#l79.2805"></a><span id="l79.2805" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2806"></a><span id="l79.2806" class="difflineminus">-  {</span>
<a href="#l79.2807"></a><span id="l79.2807" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2808"></a><span id="l79.2808">     listCard-&gt;SetDisplayName(tempString);</span>
<a href="#l79.2809"></a><span id="l79.2809">     listCard-&gt;SetLastName(tempString);</span>
<a href="#l79.2810"></a><span id="l79.2810">   }</span>
<a href="#l79.2811"></a><span id="l79.2811">   err = GetStringColumn(listRow, m_ListNickNameColumnToken, tempString);</span>
<a href="#l79.2812"></a><span id="l79.2812" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2813"></a><span id="l79.2813" class="difflineminus">-  {</span>
<a href="#l79.2814"></a><span id="l79.2814" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2815"></a><span id="l79.2815">     listCard-&gt;SetPropertyAsAString(kNicknameProperty, tempString);</span>
<a href="#l79.2816"></a><span id="l79.2816">   }</span>
<a href="#l79.2817"></a><span id="l79.2817">   err = GetStringColumn(listRow, m_ListDescriptionColumnToken, tempString);</span>
<a href="#l79.2818"></a><span id="l79.2818" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2819"></a><span id="l79.2819" class="difflineminus">-  {</span>
<a href="#l79.2820"></a><span id="l79.2820" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2821"></a><span id="l79.2821">     listCard-&gt;SetPropertyAsAString(kNotesProperty, tempString);</span>
<a href="#l79.2822"></a><span id="l79.2822">   }</span>
<a href="#l79.2823"></a><span id="l79.2823">   uint32_t key = 0;</span>
<a href="#l79.2824"></a><span id="l79.2824">   err = GetIntColumn(listRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l79.2825"></a><span id="l79.2825" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l79.2826"></a><span id="l79.2826" class="difflineminus">-    listCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l79.2827"></a><span id="l79.2827" class="difflineplus">+  if (NS_SUCCEEDED(err)) listCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l79.2828"></a><span id="l79.2828">   return err;</span>
<a href="#l79.2829"></a><span id="l79.2829"> }</span>
<a href="#l79.2830"></a><span id="l79.2830"> </span>
<a href="#l79.2831"></a><span id="l79.2831" class="difflineminus">-nsresult nsAddrDatabase::GetListFromDB(nsIAbDirectory *newList, nsIMdbRow* listRow)</span>
<a href="#l79.2832"></a><span id="l79.2832" class="difflineminus">-{</span>
<a href="#l79.2833"></a><span id="l79.2833" class="difflineminus">-  nsresult    err = NS_OK;</span>
<a href="#l79.2834"></a><span id="l79.2834" class="difflineplus">+nsresult nsAddrDatabase::GetListFromDB(nsIAbDirectory *newList,</span>
<a href="#l79.2835"></a><span id="l79.2835" class="difflineplus">+                                       nsIMdbRow *listRow) {</span>
<a href="#l79.2836"></a><span id="l79.2836" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l79.2837"></a><span id="l79.2837">   if (!newList || !listRow || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.2838"></a><span id="l79.2838">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2839"></a><span id="l79.2839"> </span>
<a href="#l79.2840"></a><span id="l79.2840">   nsAutoString tempString;</span>
<a href="#l79.2841"></a><span id="l79.2841"> </span>
<a href="#l79.2842"></a><span id="l79.2842">   err = GetStringColumn(listRow, m_UIDColumnToken, tempString);</span>
<a href="#l79.2843"></a><span id="l79.2843" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2844"></a><span id="l79.2844" class="difflineminus">-  {</span>
<a href="#l79.2845"></a><span id="l79.2845" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2846"></a><span id="l79.2846">     newList-&gt;SetUID(NS_ConvertUTF16toUTF8(tempString));</span>
<a href="#l79.2847"></a><span id="l79.2847">   }</span>
<a href="#l79.2848"></a><span id="l79.2848">   err = GetStringColumn(listRow, m_ListNameColumnToken, tempString);</span>
<a href="#l79.2849"></a><span id="l79.2849" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2850"></a><span id="l79.2850" class="difflineminus">-  {</span>
<a href="#l79.2851"></a><span id="l79.2851" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2852"></a><span id="l79.2852">     newList-&gt;SetDirName(tempString);</span>
<a href="#l79.2853"></a><span id="l79.2853">   }</span>
<a href="#l79.2854"></a><span id="l79.2854">   err = GetStringColumn(listRow, m_ListNickNameColumnToken, tempString);</span>
<a href="#l79.2855"></a><span id="l79.2855" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2856"></a><span id="l79.2856" class="difflineminus">-  {</span>
<a href="#l79.2857"></a><span id="l79.2857" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2858"></a><span id="l79.2858">     newList-&gt;SetListNickName(tempString);</span>
<a href="#l79.2859"></a><span id="l79.2859">   }</span>
<a href="#l79.2860"></a><span id="l79.2860">   err = GetStringColumn(listRow, m_ListDescriptionColumnToken, tempString);</span>
<a href="#l79.2861"></a><span id="l79.2861" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty())</span>
<a href="#l79.2862"></a><span id="l79.2862" class="difflineminus">-  {</span>
<a href="#l79.2863"></a><span id="l79.2863" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l79.2864"></a><span id="l79.2864">     newList-&gt;SetDescription(tempString);</span>
<a href="#l79.2865"></a><span id="l79.2865">   }</span>
<a href="#l79.2866"></a><span id="l79.2866"> </span>
<a href="#l79.2867"></a><span id="l79.2867">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbnewList(do_QueryInterface(newList, &amp;err));</span>
<a href="#l79.2868"></a><span id="l79.2868">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2869"></a><span id="l79.2869"> </span>
<a href="#l79.2870"></a><span id="l79.2870">   uint32_t totalAddress = GetListAddressTotal(listRow);</span>
<a href="#l79.2871"></a><span id="l79.2871">   uint32_t pos;</span>
<a href="#l79.2872"></a><span id="l79.2872" class="difflineminus">-  for (pos = 1; pos &lt;= totalAddress; ++pos)</span>
<a href="#l79.2873"></a><span id="l79.2873" class="difflineminus">-  {</span>
<a href="#l79.2874"></a><span id="l79.2874" class="difflineplus">+  for (pos = 1; pos &lt;= totalAddress; ++pos) {</span>
<a href="#l79.2875"></a><span id="l79.2875">     mdb_token listAddressColumnToken;</span>
<a href="#l79.2876"></a><span id="l79.2876">     mdb_id rowID;</span>
<a href="#l79.2877"></a><span id="l79.2877"> </span>
<a href="#l79.2878"></a><span id="l79.2878">     char columnStr[COLUMN_STR_MAX];</span>
<a href="#l79.2879"></a><span id="l79.2879">     PR_snprintf(columnStr, COLUMN_STR_MAX, kMailListAddressFormat, pos);</span>
<a href="#l79.2880"></a><span id="l79.2880">     m_mdbStore-&gt;StringToToken(m_mdbEnv, columnStr, &amp;listAddressColumnToken);</span>
<a href="#l79.2881"></a><span id="l79.2881"> </span>
<a href="#l79.2882"></a><span id="l79.2882" class="difflineminus">-    nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2883"></a><span id="l79.2883" class="difflineminus">-    err = GetIntColumn(listRow, listAddressColumnToken, (uint32_t*)&amp;rowID, 0);</span>
<a href="#l79.2884"></a><span id="l79.2884" class="difflineplus">+    nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.2885"></a><span id="l79.2885" class="difflineplus">+    err = GetIntColumn(listRow, listAddressColumnToken, (uint32_t *)&amp;rowID, 0);</span>
<a href="#l79.2886"></a><span id="l79.2886">     NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2887"></a><span id="l79.2887">     err = GetCardRowByRowID(rowID, getter_AddRefs(cardRow));</span>
<a href="#l79.2888"></a><span id="l79.2888">     NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l79.2889"></a><span id="l79.2889"> </span>
<a href="#l79.2890"></a><span id="l79.2890" class="difflineminus">-    if (cardRow)</span>
<a href="#l79.2891"></a><span id="l79.2891" class="difflineminus">-    {</span>
<a href="#l79.2892"></a><span id="l79.2892" class="difflineplus">+    if (cardRow) {</span>
<a href="#l79.2893"></a><span id="l79.2893">       nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l79.2894"></a><span id="l79.2894">       err = CreateABCard(cardRow, 0, getter_AddRefs(card));</span>
<a href="#l79.2895"></a><span id="l79.2895"> </span>
<a href="#l79.2896"></a><span id="l79.2896" class="difflineminus">-      if(NS_SUCCEEDED(err))</span>
<a href="#l79.2897"></a><span id="l79.2897" class="difflineminus">-        dbnewList-&gt;AddAddressToList(card);</span>
<a href="#l79.2898"></a><span id="l79.2898" class="difflineplus">+      if (NS_SUCCEEDED(err)) dbnewList-&gt;AddAddressToList(card);</span>
<a href="#l79.2899"></a><span id="l79.2899">     }</span>
<a href="#l79.2900"></a><span id="l79.2900">   }</span>
<a href="#l79.2901"></a><span id="l79.2901"> </span>
<a href="#l79.2902"></a><span id="l79.2902">   return err;</span>
<a href="#l79.2903"></a><span id="l79.2903"> }</span>
<a href="#l79.2904"></a><span id="l79.2904"> </span>
<a href="#l79.2905"></a><span id="l79.2905" class="difflineminus">-class nsAddrDBEnumerator : public nsSimpleEnumerator, public nsIAddrDBListener</span>
<a href="#l79.2906"></a><span id="l79.2906" class="difflineminus">-{</span>
<a href="#l79.2907"></a><span id="l79.2907" class="difflineminus">-  public:</span>
<a href="#l79.2908"></a><span id="l79.2908" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l79.2909"></a><span id="l79.2909" class="difflineminus">-</span>
<a href="#l79.2910"></a><span id="l79.2910" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l79.2911"></a><span id="l79.2911" class="difflineminus">-    {</span>
<a href="#l79.2912"></a><span id="l79.2912" class="difflineminus">-      return NS_GET_IID(nsIAbCard);</span>
<a href="#l79.2913"></a><span id="l79.2913" class="difflineminus">-    }</span>
<a href="#l79.2914"></a><span id="l79.2914" class="difflineminus">-</span>
<a href="#l79.2915"></a><span id="l79.2915" class="difflineminus">-    // nsISimpleEnumerator methods:</span>
<a href="#l79.2916"></a><span id="l79.2916" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l79.2917"></a><span id="l79.2917" class="difflineminus">-    NS_DECL_NSIADDRDBLISTENER</span>
<a href="#l79.2918"></a><span id="l79.2918" class="difflineminus">-</span>
<a href="#l79.2919"></a><span id="l79.2919" class="difflineminus">-    // nsAddrDBEnumerator methods:</span>
<a href="#l79.2920"></a><span id="l79.2920" class="difflineminus">-    explicit nsAddrDBEnumerator(nsAddrDatabase* aDb);</span>
<a href="#l79.2921"></a><span id="l79.2921" class="difflineminus">-    void Clear();</span>
<a href="#l79.2922"></a><span id="l79.2922" class="difflineminus">-  protected:</span>
<a href="#l79.2923"></a><span id="l79.2923" class="difflineminus">-    ~nsAddrDBEnumerator() override;</span>
<a href="#l79.2924"></a><span id="l79.2924" class="difflineminus">-    RefPtr&lt;nsAddrDatabase&gt; mDb;</span>
<a href="#l79.2925"></a><span id="l79.2925" class="difflineminus">-    nsIMdbTable *mDbTable;</span>
<a href="#l79.2926"></a><span id="l79.2926" class="difflineminus">-    nsCOMPtr&lt;nsIMdbTableRowCursor&gt; mRowCursor;</span>
<a href="#l79.2927"></a><span id="l79.2927" class="difflineminus">-    nsCOMPtr&lt;nsIMdbRow&gt; mCurrentRow;</span>
<a href="#l79.2928"></a><span id="l79.2928" class="difflineminus">-    mdb_pos mRowPos;</span>
<a href="#l79.2929"></a><span id="l79.2929" class="difflineplus">+class nsAddrDBEnumerator : public nsSimpleEnumerator, public nsIAddrDBListener {</span>
<a href="#l79.2930"></a><span id="l79.2930" class="difflineplus">+ public:</span>
<a href="#l79.2931"></a><span id="l79.2931" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l79.2932"></a><span id="l79.2932" class="difflineplus">+</span>
<a href="#l79.2933"></a><span id="l79.2933" class="difflineplus">+  const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIAbCard); }</span>
<a href="#l79.2934"></a><span id="l79.2934" class="difflineplus">+</span>
<a href="#l79.2935"></a><span id="l79.2935" class="difflineplus">+  // nsISimpleEnumerator methods:</span>
<a href="#l79.2936"></a><span id="l79.2936" class="difflineplus">+  NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l79.2937"></a><span id="l79.2937" class="difflineplus">+  NS_DECL_NSIADDRDBLISTENER</span>
<a href="#l79.2938"></a><span id="l79.2938" class="difflineplus">+</span>
<a href="#l79.2939"></a><span id="l79.2939" class="difflineplus">+  // nsAddrDBEnumerator methods:</span>
<a href="#l79.2940"></a><span id="l79.2940" class="difflineplus">+  explicit nsAddrDBEnumerator(nsAddrDatabase *aDb);</span>
<a href="#l79.2941"></a><span id="l79.2941" class="difflineplus">+  void Clear();</span>
<a href="#l79.2942"></a><span id="l79.2942" class="difflineplus">+</span>
<a href="#l79.2943"></a><span id="l79.2943" class="difflineplus">+ protected:</span>
<a href="#l79.2944"></a><span id="l79.2944" class="difflineplus">+  ~nsAddrDBEnumerator() override;</span>
<a href="#l79.2945"></a><span id="l79.2945" class="difflineplus">+  RefPtr&lt;nsAddrDatabase&gt; mDb;</span>
<a href="#l79.2946"></a><span id="l79.2946" class="difflineplus">+  nsIMdbTable *mDbTable;</span>
<a href="#l79.2947"></a><span id="l79.2947" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTableRowCursor&gt; mRowCursor;</span>
<a href="#l79.2948"></a><span id="l79.2948" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; mCurrentRow;</span>
<a href="#l79.2949"></a><span id="l79.2949" class="difflineplus">+  mdb_pos mRowPos;</span>
<a href="#l79.2950"></a><span id="l79.2950"> };</span>
<a href="#l79.2951"></a><span id="l79.2951"> </span>
<a href="#l79.2952"></a><span id="l79.2952" class="difflineminus">-nsAddrDBEnumerator::nsAddrDBEnumerator(nsAddrDatabase* aDb)</span>
<a href="#l79.2953"></a><span id="l79.2953" class="difflineminus">-    : mDb(aDb),</span>
<a href="#l79.2954"></a><span id="l79.2954" class="difflineminus">-      mDbTable(aDb-&gt;GetPabTable()),</span>
<a href="#l79.2955"></a><span id="l79.2955" class="difflineminus">-      mRowPos(-1)</span>
<a href="#l79.2956"></a><span id="l79.2956" class="difflineminus">-{</span>
<a href="#l79.2957"></a><span id="l79.2957" class="difflineminus">-  if (aDb)</span>
<a href="#l79.2958"></a><span id="l79.2958" class="difflineminus">-    aDb-&gt;AddListener(this);</span>
<a href="#l79.2959"></a><span id="l79.2959" class="difflineplus">+nsAddrDBEnumerator::nsAddrDBEnumerator(nsAddrDatabase *aDb)</span>
<a href="#l79.2960"></a><span id="l79.2960" class="difflineplus">+    : mDb(aDb), mDbTable(aDb-&gt;GetPabTable()), mRowPos(-1) {</span>
<a href="#l79.2961"></a><span id="l79.2961" class="difflineplus">+  if (aDb) aDb-&gt;AddListener(this);</span>
<a href="#l79.2962"></a><span id="l79.2962"> }</span>
<a href="#l79.2963"></a><span id="l79.2963"> </span>
<a href="#l79.2964"></a><span id="l79.2964" class="difflineminus">-nsAddrDBEnumerator::~nsAddrDBEnumerator()</span>
<a href="#l79.2965"></a><span id="l79.2965" class="difflineminus">-{</span>
<a href="#l79.2966"></a><span id="l79.2966" class="difflineminus">-  Clear();</span>
<a href="#l79.2967"></a><span id="l79.2967" class="difflineminus">-}</span>
<a href="#l79.2968"></a><span id="l79.2968" class="difflineminus">-</span>
<a href="#l79.2969"></a><span id="l79.2969" class="difflineminus">-void nsAddrDBEnumerator::Clear()</span>
<a href="#l79.2970"></a><span id="l79.2970" class="difflineminus">-{</span>
<a href="#l79.2971"></a><span id="l79.2971" class="difflineplus">+nsAddrDBEnumerator::~nsAddrDBEnumerator() { Clear(); }</span>
<a href="#l79.2972"></a><span id="l79.2972" class="difflineplus">+</span>
<a href="#l79.2973"></a><span id="l79.2973" class="difflineplus">+void nsAddrDBEnumerator::Clear() {</span>
<a href="#l79.2974"></a><span id="l79.2974">   mRowCursor = nullptr;</span>
<a href="#l79.2975"></a><span id="l79.2975">   mCurrentRow = nullptr;</span>
<a href="#l79.2976"></a><span id="l79.2976">   mDbTable = nullptr;</span>
<a href="#l79.2977"></a><span id="l79.2977" class="difflineminus">-  if (mDb)</span>
<a href="#l79.2978"></a><span id="l79.2978" class="difflineminus">-    mDb-&gt;RemoveListener(this);</span>
<a href="#l79.2979"></a><span id="l79.2979" class="difflineplus">+  if (mDb) mDb-&gt;RemoveListener(this);</span>
<a href="#l79.2980"></a><span id="l79.2980"> }</span>
<a href="#l79.2981"></a><span id="l79.2981"> </span>
<a href="#l79.2982"></a><span id="l79.2982" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAddrDBEnumerator, nsSimpleEnumerator, nsIAddrDBListener)</span>
<a href="#l79.2983"></a><span id="l79.2983" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsAddrDBEnumerator, nsSimpleEnumerator,</span>
<a href="#l79.2984"></a><span id="l79.2984" class="difflineplus">+                            nsIAddrDBListener)</span>
<a href="#l79.2985"></a><span id="l79.2985"> </span>
<a href="#l79.2986"></a><span id="l79.2986"> NS_IMETHODIMP</span>
<a href="#l79.2987"></a><span id="l79.2987" class="difflineminus">-nsAddrDBEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l79.2988"></a><span id="l79.2988" class="difflineminus">-{</span>
<a href="#l79.2989"></a><span id="l79.2989" class="difflineplus">+nsAddrDBEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l79.2990"></a><span id="l79.2990">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l79.2991"></a><span id="l79.2991">   *aResult = false;</span>
<a href="#l79.2992"></a><span id="l79.2992"> </span>
<a href="#l79.2993"></a><span id="l79.2993" class="difflineminus">-  if (!mDbTable || !mDb-&gt;GetEnv())</span>
<a href="#l79.2994"></a><span id="l79.2994" class="difflineminus">-  {</span>
<a href="#l79.2995"></a><span id="l79.2995" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2996"></a><span id="l79.2996" class="difflineplus">+  if (!mDbTable || !mDb-&gt;GetEnv()) {</span>
<a href="#l79.2997"></a><span id="l79.2997" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.2998"></a><span id="l79.2998">   }</span>
<a href="#l79.2999"></a><span id="l79.2999"> </span>
<a href="#l79.3000"></a><span id="l79.3000">   nsCOMPtr&lt;nsIMdbTableRowCursor&gt; rowCursor;</span>
<a href="#l79.3001"></a><span id="l79.3001">   mDbTable-&gt;GetTableRowCursor(mDb-&gt;GetEnv(), mRowPos,</span>
<a href="#l79.3002"></a><span id="l79.3002">                               getter_AddRefs(rowCursor));</span>
<a href="#l79.3003"></a><span id="l79.3003">   NS_ENSURE_TRUE(rowCursor, NS_ERROR_FAILURE);</span>
<a href="#l79.3004"></a><span id="l79.3004"> </span>
<a href="#l79.3005"></a><span id="l79.3005">   mdbOid rowOid;</span>
<a href="#l79.3006"></a><span id="l79.3006">   rowCursor-&gt;NextRowOid(mDb-&gt;GetEnv(), &amp;rowOid, nullptr);</span>
<a href="#l79.3007"></a><span id="l79.3007" class="difflineminus">-  while (rowOid.mOid_Id != (mdb_id)-1)</span>
<a href="#l79.3008"></a><span id="l79.3008" class="difflineminus">-  {</span>
<a href="#l79.3009"></a><span id="l79.3009" class="difflineplus">+  while (rowOid.mOid_Id != (mdb_id)-1) {</span>
<a href="#l79.3010"></a><span id="l79.3010">     if (mDb-&gt;IsListRowScopeToken(rowOid.mOid_Scope) ||</span>
<a href="#l79.3011"></a><span id="l79.3011" class="difflineminus">-        mDb-&gt;IsCardRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.3012"></a><span id="l79.3012" class="difflineminus">-    {</span>
<a href="#l79.3013"></a><span id="l79.3013" class="difflineplus">+        mDb-&gt;IsCardRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.3014"></a><span id="l79.3014">       *aResult = true;</span>
<a href="#l79.3015"></a><span id="l79.3015"> </span>
<a href="#l79.3016"></a><span id="l79.3016">       return NS_OK;</span>
<a href="#l79.3017"></a><span id="l79.3017">     }</span>
<a href="#l79.3018"></a><span id="l79.3018"> </span>
<a href="#l79.3019"></a><span id="l79.3019" class="difflineminus">-    if (!mDb-&gt;IsDataRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.3020"></a><span id="l79.3020" class="difflineminus">-    {</span>
<a href="#l79.3021"></a><span id="l79.3021" class="difflineplus">+    if (!mDb-&gt;IsDataRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.3022"></a><span id="l79.3022">       return NS_ERROR_FAILURE;</span>
<a href="#l79.3023"></a><span id="l79.3023">     }</span>
<a href="#l79.3024"></a><span id="l79.3024"> </span>
<a href="#l79.3025"></a><span id="l79.3025">     rowCursor-&gt;NextRowOid(mDb-&gt;GetEnv(), &amp;rowOid, nullptr);</span>
<a href="#l79.3026"></a><span id="l79.3026">   }</span>
<a href="#l79.3027"></a><span id="l79.3027"> </span>
<a href="#l79.3028"></a><span id="l79.3028">   return NS_OK;</span>
<a href="#l79.3029"></a><span id="l79.3029"> }</span>
<a href="#l79.3030"></a><span id="l79.3030"> </span>
<a href="#l79.3031"></a><span id="l79.3031"> NS_IMETHODIMP</span>
<a href="#l79.3032"></a><span id="l79.3032" class="difflineminus">-nsAddrDBEnumerator::GetNext(nsISupports **aResult)</span>
<a href="#l79.3033"></a><span id="l79.3033" class="difflineminus">-{</span>
<a href="#l79.3034"></a><span id="l79.3034" class="difflineplus">+nsAddrDBEnumerator::GetNext(nsISupports **aResult) {</span>
<a href="#l79.3035"></a><span id="l79.3035">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l79.3036"></a><span id="l79.3036"> </span>
<a href="#l79.3037"></a><span id="l79.3037">   *aResult = nullptr;</span>
<a href="#l79.3038"></a><span id="l79.3038"> </span>
<a href="#l79.3039"></a><span id="l79.3039" class="difflineminus">-  if (!mDbTable || !mDb-&gt;GetEnv())</span>
<a href="#l79.3040"></a><span id="l79.3040" class="difflineminus">-  {</span>
<a href="#l79.3041"></a><span id="l79.3041" class="difflineplus">+  if (!mDbTable || !mDb-&gt;GetEnv()) {</span>
<a href="#l79.3042"></a><span id="l79.3042">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3043"></a><span id="l79.3043">   }</span>
<a href="#l79.3044"></a><span id="l79.3044"> </span>
<a href="#l79.3045"></a><span id="l79.3045" class="difflineminus">-  if (!mRowCursor)</span>
<a href="#l79.3046"></a><span id="l79.3046" class="difflineminus">-  {</span>
<a href="#l79.3047"></a><span id="l79.3047" class="difflineminus">-    mDbTable-&gt;GetTableRowCursor(mDb-&gt;GetEnv(), -1,</span>
<a href="#l79.3048"></a><span id="l79.3048" class="difflineminus">-                                getter_AddRefs(mRowCursor));</span>
<a href="#l79.3049"></a><span id="l79.3049" class="difflineplus">+  if (!mRowCursor) {</span>
<a href="#l79.3050"></a><span id="l79.3050" class="difflineplus">+    mDbTable-&gt;GetTableRowCursor(mDb-&gt;GetEnv(), -1, getter_AddRefs(mRowCursor));</span>
<a href="#l79.3051"></a><span id="l79.3051">     NS_ENSURE_TRUE(mRowCursor, NS_ERROR_FAILURE);</span>
<a href="#l79.3052"></a><span id="l79.3052">   }</span>
<a href="#l79.3053"></a><span id="l79.3053"> </span>
<a href="#l79.3054"></a><span id="l79.3054">   nsCOMPtr&lt;nsIAbCard&gt; resultCard;</span>
<a href="#l79.3055"></a><span id="l79.3055">   mRowCursor-&gt;NextRow(mDb-&gt;GetEnv(), getter_AddRefs(mCurrentRow), &amp;mRowPos);</span>
<a href="#l79.3056"></a><span id="l79.3056" class="difflineminus">-  while (mCurrentRow)</span>
<a href="#l79.3057"></a><span id="l79.3057" class="difflineminus">-  {</span>
<a href="#l79.3058"></a><span id="l79.3058" class="difflineplus">+  while (mCurrentRow) {</span>
<a href="#l79.3059"></a><span id="l79.3059">     mdbOid rowOid;</span>
<a href="#l79.3060"></a><span id="l79.3060" class="difflineminus">-    if (NS_SUCCEEDED(mCurrentRow-&gt;GetOid(mDb-&gt;GetEnv(), &amp;rowOid)))</span>
<a href="#l79.3061"></a><span id="l79.3061" class="difflineminus">-    {</span>
<a href="#l79.3062"></a><span id="l79.3062" class="difflineplus">+    if (NS_SUCCEEDED(mCurrentRow-&gt;GetOid(mDb-&gt;GetEnv(), &amp;rowOid))) {</span>
<a href="#l79.3063"></a><span id="l79.3063">       nsresult rv;</span>
<a href="#l79.3064"></a><span id="l79.3064" class="difflineminus">-      if (mDb-&gt;IsListRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.3065"></a><span id="l79.3065" class="difflineminus">-      {</span>
<a href="#l79.3066"></a><span id="l79.3066" class="difflineminus">-        rv = mDb-&gt;CreateABListCard(mCurrentRow,</span>
<a href="#l79.3067"></a><span id="l79.3067" class="difflineminus">-                                   getter_AddRefs(resultCard));</span>
<a href="#l79.3068"></a><span id="l79.3068" class="difflineplus">+      if (mDb-&gt;IsListRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.3069"></a><span id="l79.3069" class="difflineplus">+        rv = mDb-&gt;CreateABListCard(mCurrentRow, getter_AddRefs(resultCard));</span>
<a href="#l79.3070"></a><span id="l79.3070">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3071"></a><span id="l79.3071" class="difflineminus">-      }</span>
<a href="#l79.3072"></a><span id="l79.3072" class="difflineminus">-      else if (mDb-&gt;IsCardRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.3073"></a><span id="l79.3073" class="difflineminus">-      {</span>
<a href="#l79.3074"></a><span id="l79.3074" class="difflineminus">-        rv = mDb-&gt;CreateABCard(mCurrentRow, 0,</span>
<a href="#l79.3075"></a><span id="l79.3075" class="difflineminus">-                               getter_AddRefs(resultCard));</span>
<a href="#l79.3076"></a><span id="l79.3076" class="difflineplus">+      } else if (mDb-&gt;IsCardRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.3077"></a><span id="l79.3077" class="difflineplus">+        rv = mDb-&gt;CreateABCard(mCurrentRow, 0, getter_AddRefs(resultCard));</span>
<a href="#l79.3078"></a><span id="l79.3078">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3079"></a><span id="l79.3079" class="difflineminus">-      }</span>
<a href="#l79.3080"></a><span id="l79.3080" class="difflineminus">-      else if (!mDb-&gt;IsDataRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.3081"></a><span id="l79.3081" class="difflineminus">-      {</span>
<a href="#l79.3082"></a><span id="l79.3082" class="difflineplus">+      } else if (!mDb-&gt;IsDataRowScopeToken(rowOid.mOid_Scope)) {</span>
<a href="#l79.3083"></a><span id="l79.3083">         return NS_ERROR_FAILURE;</span>
<a href="#l79.3084"></a><span id="l79.3084">       }</span>
<a href="#l79.3085"></a><span id="l79.3085"> </span>
<a href="#l79.3086"></a><span id="l79.3086" class="difflineminus">-      if (resultCard)</span>
<a href="#l79.3087"></a><span id="l79.3087" class="difflineminus">-      {</span>
<a href="#l79.3088"></a><span id="l79.3088" class="difflineplus">+      if (resultCard) {</span>
<a href="#l79.3089"></a><span id="l79.3089">         return CallQueryInterface(resultCard, aResult);</span>
<a href="#l79.3090"></a><span id="l79.3090">       }</span>
<a href="#l79.3091"></a><span id="l79.3091">     }</span>
<a href="#l79.3092"></a><span id="l79.3092"> </span>
<a href="#l79.3093"></a><span id="l79.3093" class="difflineminus">-    mRowCursor-&gt;NextRow(mDb-&gt;GetEnv(), getter_AddRefs(mCurrentRow),</span>
<a href="#l79.3094"></a><span id="l79.3094" class="difflineminus">-                        &amp;mRowPos);</span>
<a href="#l79.3095"></a><span id="l79.3095" class="difflineplus">+    mRowCursor-&gt;NextRow(mDb-&gt;GetEnv(), getter_AddRefs(mCurrentRow), &amp;mRowPos);</span>
<a href="#l79.3096"></a><span id="l79.3096">   }</span>
<a href="#l79.3097"></a><span id="l79.3097"> </span>
<a href="#l79.3098"></a><span id="l79.3098">   return NS_ERROR_FAILURE;</span>
<a href="#l79.3099"></a><span id="l79.3099"> }</span>
<a href="#l79.3100"></a><span id="l79.3100"> </span>
<a href="#l79.3101"></a><span id="l79.3101" class="difflineminus">-NS_IMETHODIMP nsAddrDBEnumerator::OnCardAttribChange(uint32_t abCode)</span>
<a href="#l79.3102"></a><span id="l79.3102" class="difflineminus">-{</span>
<a href="#l79.3103"></a><span id="l79.3103" class="difflineplus">+NS_IMETHODIMP nsAddrDBEnumerator::OnCardAttribChange(uint32_t abCode) {</span>
<a href="#l79.3104"></a><span id="l79.3104">   return NS_OK;</span>
<a href="#l79.3105"></a><span id="l79.3105"> }</span>
<a href="#l79.3106"></a><span id="l79.3106"> </span>
<a href="#l79.3107"></a><span id="l79.3107" class="difflineminus">-/* void onCardEntryChange (in unsigned long aAbCode, in nsIAbCard aCard, in nsIAbDirectory aParent); */</span>
<a href="#l79.3108"></a><span id="l79.3108" class="difflineminus">-NS_IMETHODIMP nsAddrDBEnumerator::OnCardEntryChange(uint32_t aAbCode, nsIAbCard *aCard, nsIAbDirectory *aParent)</span>
<a href="#l79.3109"></a><span id="l79.3109" class="difflineminus">-{</span>
<a href="#l79.3110"></a><span id="l79.3110" class="difflineplus">+/* void onCardEntryChange (in unsigned long aAbCode, in nsIAbCard aCard, in</span>
<a href="#l79.3111"></a><span id="l79.3111" class="difflineplus">+ * nsIAbDirectory aParent); */</span>
<a href="#l79.3112"></a><span id="l79.3112" class="difflineplus">+NS_IMETHODIMP nsAddrDBEnumerator::OnCardEntryChange(uint32_t aAbCode,</span>
<a href="#l79.3113"></a><span id="l79.3113" class="difflineplus">+                                                    nsIAbCard *aCard,</span>
<a href="#l79.3114"></a><span id="l79.3114" class="difflineplus">+                                                    nsIAbDirectory *aParent) {</span>
<a href="#l79.3115"></a><span id="l79.3115">   return NS_OK;</span>
<a href="#l79.3116"></a><span id="l79.3116"> }</span>
<a href="#l79.3117"></a><span id="l79.3117"> </span>
<a href="#l79.3118"></a><span id="l79.3118"> /* void onListEntryChange (in unsigned long abCode, in nsIAbDirectory list); */</span>
<a href="#l79.3119"></a><span id="l79.3119" class="difflineminus">-NS_IMETHODIMP nsAddrDBEnumerator::OnListEntryChange(uint32_t abCode, nsIAbDirectory *list)</span>
<a href="#l79.3120"></a><span id="l79.3120" class="difflineminus">-{</span>
<a href="#l79.3121"></a><span id="l79.3121" class="difflineplus">+NS_IMETHODIMP nsAddrDBEnumerator::OnListEntryChange(uint32_t abCode,</span>
<a href="#l79.3122"></a><span id="l79.3122" class="difflineplus">+                                                    nsIAbDirectory *list) {</span>
<a href="#l79.3123"></a><span id="l79.3123">   return NS_OK;</span>
<a href="#l79.3124"></a><span id="l79.3124"> }</span>
<a href="#l79.3125"></a><span id="l79.3125"> </span>
<a href="#l79.3126"></a><span id="l79.3126"> /* void onAnnouncerGoingAway (); */</span>
<a href="#l79.3127"></a><span id="l79.3127" class="difflineminus">-NS_IMETHODIMP nsAddrDBEnumerator::OnAnnouncerGoingAway()</span>
<a href="#l79.3128"></a><span id="l79.3128" class="difflineminus">-{</span>
<a href="#l79.3129"></a><span id="l79.3129" class="difflineplus">+NS_IMETHODIMP nsAddrDBEnumerator::OnAnnouncerGoingAway() {</span>
<a href="#l79.3130"></a><span id="l79.3130">   Clear();</span>
<a href="#l79.3131"></a><span id="l79.3131">   return NS_OK;</span>
<a href="#l79.3132"></a><span id="l79.3132"> }</span>
<a href="#l79.3133"></a><span id="l79.3133"> </span>
<a href="#l79.3134"></a><span id="l79.3134" class="difflineminus">-class nsListAddressEnumerator final : public nsSimpleEnumerator</span>
<a href="#l79.3135"></a><span id="l79.3135" class="difflineminus">-{</span>
<a href="#l79.3136"></a><span id="l79.3136" class="difflineminus">-  public:</span>
<a href="#l79.3137"></a><span id="l79.3137" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l79.3138"></a><span id="l79.3138" class="difflineminus">-    {</span>
<a href="#l79.3139"></a><span id="l79.3139" class="difflineminus">-      return NS_GET_IID(nsIAbCard);</span>
<a href="#l79.3140"></a><span id="l79.3140" class="difflineminus">-    }</span>
<a href="#l79.3141"></a><span id="l79.3141" class="difflineminus">-</span>
<a href="#l79.3142"></a><span id="l79.3142" class="difflineminus">-    // nsISimpleEnumerator methods:</span>
<a href="#l79.3143"></a><span id="l79.3143" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l79.3144"></a><span id="l79.3144" class="difflineminus">-</span>
<a href="#l79.3145"></a><span id="l79.3145" class="difflineminus">-    // nsListAddressEnumerator methods:</span>
<a href="#l79.3146"></a><span id="l79.3146" class="difflineminus">-    nsListAddressEnumerator(nsAddrDatabase* aDb, mdb_id aRowID);</span>
<a href="#l79.3147"></a><span id="l79.3147" class="difflineminus">-</span>
<a href="#l79.3148"></a><span id="l79.3148" class="difflineminus">-  protected:</span>
<a href="#l79.3149"></a><span id="l79.3149" class="difflineminus">-    ~nsListAddressEnumerator() override = default;</span>
<a href="#l79.3150"></a><span id="l79.3150" class="difflineminus">-    RefPtr&lt;nsAddrDatabase&gt; mDb;</span>
<a href="#l79.3151"></a><span id="l79.3151" class="difflineminus">-    nsIMdbTable *mDbTable;</span>
<a href="#l79.3152"></a><span id="l79.3152" class="difflineminus">-    nsCOMPtr&lt;nsIMdbRow&gt; mListRow;</span>
<a href="#l79.3153"></a><span id="l79.3153" class="difflineminus">-    mdb_id mListRowID;</span>
<a href="#l79.3154"></a><span id="l79.3154" class="difflineminus">-    uint32_t mAddressTotal;</span>
<a href="#l79.3155"></a><span id="l79.3155" class="difflineminus">-    uint16_t mAddressPos;</span>
<a href="#l79.3156"></a><span id="l79.3156" class="difflineplus">+class nsListAddressEnumerator final : public nsSimpleEnumerator {</span>
<a href="#l79.3157"></a><span id="l79.3157" class="difflineplus">+ public:</span>
<a href="#l79.3158"></a><span id="l79.3158" class="difflineplus">+  const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIAbCard); }</span>
<a href="#l79.3159"></a><span id="l79.3159" class="difflineplus">+</span>
<a href="#l79.3160"></a><span id="l79.3160" class="difflineplus">+  // nsISimpleEnumerator methods:</span>
<a href="#l79.3161"></a><span id="l79.3161" class="difflineplus">+  NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l79.3162"></a><span id="l79.3162" class="difflineplus">+</span>
<a href="#l79.3163"></a><span id="l79.3163" class="difflineplus">+  // nsListAddressEnumerator methods:</span>
<a href="#l79.3164"></a><span id="l79.3164" class="difflineplus">+  nsListAddressEnumerator(nsAddrDatabase *aDb, mdb_id aRowID);</span>
<a href="#l79.3165"></a><span id="l79.3165" class="difflineplus">+</span>
<a href="#l79.3166"></a><span id="l79.3166" class="difflineplus">+ protected:</span>
<a href="#l79.3167"></a><span id="l79.3167" class="difflineplus">+  ~nsListAddressEnumerator() override = default;</span>
<a href="#l79.3168"></a><span id="l79.3168" class="difflineplus">+  RefPtr&lt;nsAddrDatabase&gt; mDb;</span>
<a href="#l79.3169"></a><span id="l79.3169" class="difflineplus">+  nsIMdbTable *mDbTable;</span>
<a href="#l79.3170"></a><span id="l79.3170" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; mListRow;</span>
<a href="#l79.3171"></a><span id="l79.3171" class="difflineplus">+  mdb_id mListRowID;</span>
<a href="#l79.3172"></a><span id="l79.3172" class="difflineplus">+  uint32_t mAddressTotal;</span>
<a href="#l79.3173"></a><span id="l79.3173" class="difflineplus">+  uint16_t mAddressPos;</span>
<a href="#l79.3174"></a><span id="l79.3174"> };</span>
<a href="#l79.3175"></a><span id="l79.3175"> </span>
<a href="#l79.3176"></a><span id="l79.3176" class="difflineminus">-nsListAddressEnumerator::nsListAddressEnumerator(nsAddrDatabase* aDb,</span>
<a href="#l79.3177"></a><span id="l79.3177" class="difflineplus">+nsListAddressEnumerator::nsListAddressEnumerator(nsAddrDatabase *aDb,</span>
<a href="#l79.3178"></a><span id="l79.3178">                                                  mdb_id aRowID)</span>
<a href="#l79.3179"></a><span id="l79.3179">     : mDb(aDb),</span>
<a href="#l79.3180"></a><span id="l79.3180">       mDbTable(aDb-&gt;GetPabTable()),</span>
<a href="#l79.3181"></a><span id="l79.3181">       mListRowID(aRowID),</span>
<a href="#l79.3182"></a><span id="l79.3182" class="difflineminus">-      mAddressPos(0)</span>
<a href="#l79.3183"></a><span id="l79.3183" class="difflineminus">-{</span>
<a href="#l79.3184"></a><span id="l79.3184" class="difflineplus">+      mAddressPos(0) {</span>
<a href="#l79.3185"></a><span id="l79.3185">   mDb-&gt;GetListRowByRowID(mListRowID, getter_AddRefs(mListRow));</span>
<a href="#l79.3186"></a><span id="l79.3186">   mAddressTotal = aDb-&gt;GetListAddressTotal(mListRow);</span>
<a href="#l79.3187"></a><span id="l79.3187"> }</span>
<a href="#l79.3188"></a><span id="l79.3188"> </span>
<a href="#l79.3189"></a><span id="l79.3189"> NS_IMETHODIMP</span>
<a href="#l79.3190"></a><span id="l79.3190" class="difflineminus">-nsListAddressEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l79.3191"></a><span id="l79.3191" class="difflineminus">-{</span>
<a href="#l79.3192"></a><span id="l79.3192" class="difflineplus">+nsListAddressEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l79.3193"></a><span id="l79.3193">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l79.3194"></a><span id="l79.3194"> </span>
<a href="#l79.3195"></a><span id="l79.3195">   *aResult = false;</span>
<a href="#l79.3196"></a><span id="l79.3196"> </span>
<a href="#l79.3197"></a><span id="l79.3197" class="difflineminus">-  if (!mDbTable || !mDb-&gt;GetEnv())</span>
<a href="#l79.3198"></a><span id="l79.3198" class="difflineminus">-  {</span>
<a href="#l79.3199"></a><span id="l79.3199" class="difflineplus">+  if (!mDbTable || !mDb-&gt;GetEnv()) {</span>
<a href="#l79.3200"></a><span id="l79.3200">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3201"></a><span id="l79.3201">   }</span>
<a href="#l79.3202"></a><span id="l79.3202"> </span>
<a href="#l79.3203"></a><span id="l79.3203">   // In some cases it is possible that GetAddressRowByPos returns success,</span>
<a href="#l79.3204"></a><span id="l79.3204">   // but currentRow is null. This is typically due to the fact that a card</span>
<a href="#l79.3205"></a><span id="l79.3205">   // has been deleted from the parent and not the list. Whilst we have fixed</span>
<a href="#l79.3206"></a><span id="l79.3206">   // that there are still a few dbs around there that we need to support</span>
<a href="#l79.3207"></a><span id="l79.3207">   // correctly. Therefore, whilst processing lists ensure that we don't return</span>
<a href="#l79.3208"></a><span id="l79.3208">   // false if the only thing stopping us is a blank row, just skip it and try</span>
<a href="#l79.3209"></a><span id="l79.3209">   // the next one.</span>
<a href="#l79.3210"></a><span id="l79.3210" class="difflineminus">-  while (mAddressPos &lt; mAddressTotal)</span>
<a href="#l79.3211"></a><span id="l79.3211" class="difflineminus">-  {</span>
<a href="#l79.3212"></a><span id="l79.3212" class="difflineplus">+  while (mAddressPos &lt; mAddressTotal) {</span>
<a href="#l79.3213"></a><span id="l79.3213">     nsCOMPtr&lt;nsIMdbRow&gt; currentRow;</span>
<a href="#l79.3214"></a><span id="l79.3214">     nsresult rv = mDb-&gt;GetAddressRowByPos(mListRow, mAddressPos + 1,</span>
<a href="#l79.3215"></a><span id="l79.3215">                                           getter_AddRefs(currentRow));</span>
<a href="#l79.3216"></a><span id="l79.3216"> </span>
<a href="#l79.3217"></a><span id="l79.3217" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; currentRow)</span>
<a href="#l79.3218"></a><span id="l79.3218" class="difflineminus">-    {</span>
<a href="#l79.3219"></a><span id="l79.3219" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; currentRow) {</span>
<a href="#l79.3220"></a><span id="l79.3220">       *aResult = true;</span>
<a href="#l79.3221"></a><span id="l79.3221">       break;</span>
<a href="#l79.3222"></a><span id="l79.3222">     }</span>
<a href="#l79.3223"></a><span id="l79.3223"> </span>
<a href="#l79.3224"></a><span id="l79.3224">     ++mAddressPos;</span>
<a href="#l79.3225"></a><span id="l79.3225">   }</span>
<a href="#l79.3226"></a><span id="l79.3226"> </span>
<a href="#l79.3227"></a><span id="l79.3227">   return NS_OK;</span>
<a href="#l79.3228"></a><span id="l79.3228"> }</span>
<a href="#l79.3229"></a><span id="l79.3229"> </span>
<a href="#l79.3230"></a><span id="l79.3230"> NS_IMETHODIMP</span>
<a href="#l79.3231"></a><span id="l79.3231" class="difflineminus">-nsListAddressEnumerator::GetNext(nsISupports **aResult)</span>
<a href="#l79.3232"></a><span id="l79.3232" class="difflineminus">-{</span>
<a href="#l79.3233"></a><span id="l79.3233" class="difflineplus">+nsListAddressEnumerator::GetNext(nsISupports **aResult) {</span>
<a href="#l79.3234"></a><span id="l79.3234">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l79.3235"></a><span id="l79.3235"> </span>
<a href="#l79.3236"></a><span id="l79.3236">   *aResult = nullptr;</span>
<a href="#l79.3237"></a><span id="l79.3237"> </span>
<a href="#l79.3238"></a><span id="l79.3238" class="difflineminus">-  if (!mDbTable || !mDb-&gt;GetEnv())</span>
<a href="#l79.3239"></a><span id="l79.3239" class="difflineminus">-  {</span>
<a href="#l79.3240"></a><span id="l79.3240" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3241"></a><span id="l79.3241" class="difflineplus">+  if (!mDbTable || !mDb-&gt;GetEnv()) {</span>
<a href="#l79.3242"></a><span id="l79.3242" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3243"></a><span id="l79.3243">   }</span>
<a href="#l79.3244"></a><span id="l79.3244"> </span>
<a href="#l79.3245"></a><span id="l79.3245" class="difflineminus">-  while (++mAddressPos &lt;= mAddressTotal)</span>
<a href="#l79.3246"></a><span id="l79.3246" class="difflineminus">-  {</span>
<a href="#l79.3247"></a><span id="l79.3247" class="difflineplus">+  while (++mAddressPos &lt;= mAddressTotal) {</span>
<a href="#l79.3248"></a><span id="l79.3248">     nsCOMPtr&lt;nsIMdbRow&gt; currentRow;</span>
<a href="#l79.3249"></a><span id="l79.3249">     nsresult rv = mDb-&gt;GetAddressRowByPos(mListRow, mAddressPos,</span>
<a href="#l79.3250"></a><span id="l79.3250">                                           getter_AddRefs(currentRow));</span>
<a href="#l79.3251"></a><span id="l79.3251">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.3252"></a><span id="l79.3252">       nsCOMPtr&lt;nsIAbCard&gt; resultCard;</span>
<a href="#l79.3253"></a><span id="l79.3253" class="difflineminus">-      rv = mDb-&gt;CreateABCard(currentRow, mListRowID,</span>
<a href="#l79.3254"></a><span id="l79.3254" class="difflineminus">-                             getter_AddRefs(resultCard));</span>
<a href="#l79.3255"></a><span id="l79.3255" class="difflineplus">+      rv =</span>
<a href="#l79.3256"></a><span id="l79.3256" class="difflineplus">+          mDb-&gt;CreateABCard(currentRow, mListRowID, getter_AddRefs(resultCard));</span>
<a href="#l79.3257"></a><span id="l79.3257">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3258"></a><span id="l79.3258"> </span>
<a href="#l79.3259"></a><span id="l79.3259">       return CallQueryInterface(resultCard, aResult);</span>
<a href="#l79.3260"></a><span id="l79.3260">     }</span>
<a href="#l79.3261"></a><span id="l79.3261">   }</span>
<a href="#l79.3262"></a><span id="l79.3262"> </span>
<a href="#l79.3263"></a><span id="l79.3263">   return NS_ERROR_FAILURE;</span>
<a href="#l79.3264"></a><span id="l79.3264"> }</span>
<a href="#l79.3265"></a><span id="l79.3265"> </span>
<a href="#l79.3266"></a><span id="l79.3266"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l79.3267"></a><span id="l79.3267"> </span>
<a href="#l79.3268"></a><span id="l79.3268" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::EnumerateCards(nsIAbDirectory *directory, nsISimpleEnumerator **result)</span>
<a href="#l79.3269"></a><span id="l79.3269" class="difflineminus">-{</span>
<a href="#l79.3270"></a><span id="l79.3270" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::EnumerateCards(nsIAbDirectory *directory,</span>
<a href="#l79.3271"></a><span id="l79.3271" class="difflineplus">+                                             nsISimpleEnumerator **result) {</span>
<a href="#l79.3272"></a><span id="l79.3272">   NS_ADDREF(*result = new nsAddrDBEnumerator(this));</span>
<a href="#l79.3273"></a><span id="l79.3273">   m_dbDirectory = do_GetWeakReference(directory);</span>
<a href="#l79.3274"></a><span id="l79.3274">   return NS_OK;</span>
<a href="#l79.3275"></a><span id="l79.3275"> }</span>
<a href="#l79.3276"></a><span id="l79.3276"> </span>
<a href="#l79.3277"></a><span id="l79.3277" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::GetMailingListsFromDB(nsIAbDirectory *parentDir)</span>
<a href="#l79.3278"></a><span id="l79.3278" class="difflineminus">-{</span>
<a href="#l79.3279"></a><span id="l79.3279" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::GetMailingListsFromDB(nsIAbDirectory *parentDir) {</span>
<a href="#l79.3280"></a><span id="l79.3280">   nsCOMPtr&lt;nsIAbDirectory&gt; resultList;</span>
<a href="#l79.3281"></a><span id="l79.3281" class="difflineminus">-  nsIMdbTableRowCursor*    rowCursor = nullptr;</span>
<a href="#l79.3282"></a><span id="l79.3282" class="difflineminus">-  nsCOMPtr&lt;nsIMdbRow&gt;      currentRow;</span>
<a href="#l79.3283"></a><span id="l79.3283" class="difflineminus">-  mdb_pos                  rowPos;</span>
<a href="#l79.3284"></a><span id="l79.3284" class="difflineminus">-  bool                     done = false;</span>
<a href="#l79.3285"></a><span id="l79.3285" class="difflineminus">-</span>
<a href="#l79.3286"></a><span id="l79.3286" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.3287"></a><span id="l79.3287" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3288"></a><span id="l79.3288" class="difflineplus">+  nsIMdbTableRowCursor *rowCursor = nullptr;</span>
<a href="#l79.3289"></a><span id="l79.3289" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; currentRow;</span>
<a href="#l79.3290"></a><span id="l79.3290" class="difflineplus">+  mdb_pos rowPos;</span>
<a href="#l79.3291"></a><span id="l79.3291" class="difflineplus">+  bool done = false;</span>
<a href="#l79.3292"></a><span id="l79.3292" class="difflineplus">+</span>
<a href="#l79.3293"></a><span id="l79.3293" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3294"></a><span id="l79.3294"> </span>
<a href="#l79.3295"></a><span id="l79.3295">   m_dbDirectory = do_GetWeakReference(parentDir);</span>
<a href="#l79.3296"></a><span id="l79.3296"> </span>
<a href="#l79.3297"></a><span id="l79.3297" class="difflineminus">-  nsIMdbTable* dbTable = GetPabTable();</span>
<a href="#l79.3298"></a><span id="l79.3298" class="difflineminus">-</span>
<a href="#l79.3299"></a><span id="l79.3299" class="difflineminus">-  if (!dbTable)</span>
<a href="#l79.3300"></a><span id="l79.3300" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l79.3301"></a><span id="l79.3301" class="difflineplus">+  nsIMdbTable *dbTable = GetPabTable();</span>
<a href="#l79.3302"></a><span id="l79.3302" class="difflineplus">+</span>
<a href="#l79.3303"></a><span id="l79.3303" class="difflineplus">+  if (!dbTable) return NS_ERROR_FAILURE;</span>
<a href="#l79.3304"></a><span id="l79.3304"> </span>
<a href="#l79.3305"></a><span id="l79.3305">   dbTable-&gt;GetTableRowCursor(m_mdbEnv, -1, &amp;rowCursor);</span>
<a href="#l79.3306"></a><span id="l79.3306" class="difflineminus">-  if (!rowCursor)</span>
<a href="#l79.3307"></a><span id="l79.3307" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l79.3308"></a><span id="l79.3308" class="difflineminus">-</span>
<a href="#l79.3309"></a><span id="l79.3309" class="difflineminus">-  while (!done)</span>
<a href="#l79.3310"></a><span id="l79.3310" class="difflineminus">-  {</span>
<a href="#l79.3311"></a><span id="l79.3311" class="difflineminus">-    nsresult rv = rowCursor-&gt;NextRow(m_mdbEnv, getter_AddRefs(currentRow), &amp;rowPos);</span>
<a href="#l79.3312"></a><span id="l79.3312" class="difflineminus">-    if (currentRow &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l79.3313"></a><span id="l79.3313" class="difflineminus">-    {</span>
<a href="#l79.3314"></a><span id="l79.3314" class="difflineplus">+  if (!rowCursor) return NS_ERROR_FAILURE;</span>
<a href="#l79.3315"></a><span id="l79.3315" class="difflineplus">+</span>
<a href="#l79.3316"></a><span id="l79.3316" class="difflineplus">+  while (!done) {</span>
<a href="#l79.3317"></a><span id="l79.3317" class="difflineplus">+    nsresult rv =</span>
<a href="#l79.3318"></a><span id="l79.3318" class="difflineplus">+        rowCursor-&gt;NextRow(m_mdbEnv, getter_AddRefs(currentRow), &amp;rowPos);</span>
<a href="#l79.3319"></a><span id="l79.3319" class="difflineplus">+    if (currentRow &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l79.3320"></a><span id="l79.3320">       mdbOid rowOid;</span>
<a href="#l79.3321"></a><span id="l79.3321"> </span>
<a href="#l79.3322"></a><span id="l79.3322" class="difflineminus">-      if (NS_SUCCEEDED(currentRow-&gt;GetOid(m_mdbEnv, &amp;rowOid)))</span>
<a href="#l79.3323"></a><span id="l79.3323" class="difflineminus">-      {</span>
<a href="#l79.3324"></a><span id="l79.3324" class="difflineplus">+      if (NS_SUCCEEDED(currentRow-&gt;GetOid(m_mdbEnv, &amp;rowOid))) {</span>
<a href="#l79.3325"></a><span id="l79.3325">         if (IsListRowScopeToken(rowOid.mOid_Scope))</span>
<a href="#l79.3326"></a><span id="l79.3326">           rv = CreateABList(currentRow, getter_AddRefs(resultList));</span>
<a href="#l79.3327"></a><span id="l79.3327">       }</span>
<a href="#l79.3328"></a><span id="l79.3328" class="difflineminus">-    }</span>
<a href="#l79.3329"></a><span id="l79.3329" class="difflineminus">-    else</span>
<a href="#l79.3330"></a><span id="l79.3330" class="difflineplus">+    } else</span>
<a href="#l79.3331"></a><span id="l79.3331">       done = true;</span>
<a href="#l79.3332"></a><span id="l79.3332">   }</span>
<a href="#l79.3333"></a><span id="l79.3333">   NS_IF_RELEASE(rowCursor);</span>
<a href="#l79.3334"></a><span id="l79.3334">   return NS_OK;</span>
<a href="#l79.3335"></a><span id="l79.3335"> }</span>
<a href="#l79.3336"></a><span id="l79.3336"> </span>
<a href="#l79.3337"></a><span id="l79.3337" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::EnumerateListAddresses(nsIAbDirectory *directory, nsISimpleEnumerator **result)</span>
<a href="#l79.3338"></a><span id="l79.3338" class="difflineminus">-{</span>
<a href="#l79.3339"></a><span id="l79.3339" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::EnumerateListAddresses(</span>
<a href="#l79.3340"></a><span id="l79.3340" class="difflineplus">+    nsIAbDirectory *directory, nsISimpleEnumerator **result) {</span>
<a href="#l79.3341"></a><span id="l79.3341">   nsresult rv = NS_OK;</span>
<a href="#l79.3342"></a><span id="l79.3342">   mdb_id rowID;</span>
<a href="#l79.3343"></a><span id="l79.3343"> </span>
<a href="#l79.3344"></a><span id="l79.3344" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdirectory(do_QueryInterface(directory,&amp;rv));</span>
<a href="#l79.3345"></a><span id="l79.3345" class="difflineminus">-</span>
<a href="#l79.3346"></a><span id="l79.3346" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l79.3347"></a><span id="l79.3347" class="difflineminus">-  {</span>
<a href="#l79.3348"></a><span id="l79.3348" class="difflineminus">-    dbdirectory-&gt;GetDbRowID((uint32_t*)&amp;rowID);</span>
<a href="#l79.3349"></a><span id="l79.3349" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l79.3350"></a><span id="l79.3350" class="difflineplus">+</span>
<a href="#l79.3351"></a><span id="l79.3351" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.3352"></a><span id="l79.3352" class="difflineplus">+    dbdirectory-&gt;GetDbRowID((uint32_t *)&amp;rowID);</span>
<a href="#l79.3353"></a><span id="l79.3353"> </span>
<a href="#l79.3354"></a><span id="l79.3354">     NS_ADDREF(*result = new nsListAddressEnumerator(this, rowID));</span>
<a href="#l79.3355"></a><span id="l79.3355">     m_dbDirectory = do_GetWeakReference(directory);</span>
<a href="#l79.3356"></a><span id="l79.3356">   }</span>
<a href="#l79.3357"></a><span id="l79.3357">   return rv;</span>
<a href="#l79.3358"></a><span id="l79.3358"> }</span>
<a href="#l79.3359"></a><span id="l79.3359"> </span>
<a href="#l79.3360"></a><span id="l79.3360" class="difflineminus">-nsresult nsAddrDatabase::CreateCardFromDeletedCardsTable(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result)</span>
<a href="#l79.3361"></a><span id="l79.3361" class="difflineminus">-{</span>
<a href="#l79.3362"></a><span id="l79.3362" class="difflineminus">-  if (!cardRow || !m_mdbEnv || !result)</span>
<a href="#l79.3363"></a><span id="l79.3363" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3364"></a><span id="l79.3364" class="difflineplus">+nsresult nsAddrDatabase::CreateCardFromDeletedCardsTable(nsIMdbRow *cardRow,</span>
<a href="#l79.3365"></a><span id="l79.3365" class="difflineplus">+                                                         mdb_id listRowID,</span>
<a href="#l79.3366"></a><span id="l79.3366" class="difflineplus">+                                                         nsIAbCard **result) {</span>
<a href="#l79.3367"></a><span id="l79.3367" class="difflineplus">+  if (!cardRow || !m_mdbEnv || !result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3368"></a><span id="l79.3368"> </span>
<a href="#l79.3369"></a><span id="l79.3369">   nsresult rv = NS_OK;</span>
<a href="#l79.3370"></a><span id="l79.3370"> </span>
<a href="#l79.3371"></a><span id="l79.3371">   mdbOid outOid;</span>
<a href="#l79.3372"></a><span id="l79.3372">   mdb_id rowID = 0;</span>
<a href="#l79.3373"></a><span id="l79.3373"> </span>
<a href="#l79.3374"></a><span id="l79.3374" class="difflineminus">-  if (NS_SUCCEEDED(cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid)))</span>
<a href="#l79.3375"></a><span id="l79.3375" class="difflineminus">-    rowID = outOid.mOid_Id;</span>
<a href="#l79.3376"></a><span id="l79.3376" class="difflineminus">-</span>
<a href="#l79.3377"></a><span id="l79.3377" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l79.3378"></a><span id="l79.3378" class="difflineminus">-  {</span>
<a href="#l79.3379"></a><span id="l79.3379" class="difflineplus">+  if (NS_SUCCEEDED(cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l79.3380"></a><span id="l79.3380" class="difflineplus">+</span>
<a href="#l79.3381"></a><span id="l79.3381" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.3382"></a><span id="l79.3382">     nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l79.3383"></a><span id="l79.3383">     personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l79.3384"></a><span id="l79.3384" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.3385"></a><span id="l79.3385" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3386"></a><span id="l79.3386"> </span>
<a href="#l79.3387"></a><span id="l79.3387">     InitCardFromRow(personCard, cardRow);</span>
<a href="#l79.3388"></a><span id="l79.3388">     personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l79.3389"></a><span id="l79.3389"> </span>
<a href="#l79.3390"></a><span id="l79.3390">     personCard.forget(result);</span>
<a href="#l79.3391"></a><span id="l79.3391">   }</span>
<a href="#l79.3392"></a><span id="l79.3392"> </span>
<a href="#l79.3393"></a><span id="l79.3393">   return rv;</span>
<a href="#l79.3394"></a><span id="l79.3394"> }</span>
<a href="#l79.3395"></a><span id="l79.3395"> </span>
<a href="#l79.3396"></a><span id="l79.3396" class="difflineminus">-nsresult nsAddrDatabase::CreateCard(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result)</span>
<a href="#l79.3397"></a><span id="l79.3397" class="difflineminus">-{</span>
<a href="#l79.3398"></a><span id="l79.3398" class="difflineminus">-  if (!cardRow || !m_mdbEnv || !result)</span>
<a href="#l79.3399"></a><span id="l79.3399" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3400"></a><span id="l79.3400" class="difflineplus">+nsresult nsAddrDatabase::CreateCard(nsIMdbRow *cardRow, mdb_id listRowID,</span>
<a href="#l79.3401"></a><span id="l79.3401" class="difflineplus">+                                    nsIAbCard **result) {</span>
<a href="#l79.3402"></a><span id="l79.3402" class="difflineplus">+  if (!cardRow || !m_mdbEnv || !result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3403"></a><span id="l79.3403"> </span>
<a href="#l79.3404"></a><span id="l79.3404">   nsresult rv = NS_OK;</span>
<a href="#l79.3405"></a><span id="l79.3405"> </span>
<a href="#l79.3406"></a><span id="l79.3406">   mdbOid outOid;</span>
<a href="#l79.3407"></a><span id="l79.3407">   mdb_id rowID = 0;</span>
<a href="#l79.3408"></a><span id="l79.3408"> </span>
<a href="#l79.3409"></a><span id="l79.3409" class="difflineminus">-  if (NS_SUCCEEDED(cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid)))</span>
<a href="#l79.3410"></a><span id="l79.3410" class="difflineminus">-    rowID = outOid.mOid_Id;</span>
<a href="#l79.3411"></a><span id="l79.3411" class="difflineminus">-</span>
<a href="#l79.3412"></a><span id="l79.3412" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l79.3413"></a><span id="l79.3413" class="difflineminus">-  {</span>
<a href="#l79.3414"></a><span id="l79.3414" class="difflineplus">+  if (NS_SUCCEEDED(cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l79.3415"></a><span id="l79.3415" class="difflineplus">+</span>
<a href="#l79.3416"></a><span id="l79.3416" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.3417"></a><span id="l79.3417">     nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l79.3418"></a><span id="l79.3418">     personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l79.3419"></a><span id="l79.3419" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.3420"></a><span id="l79.3420" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3421"></a><span id="l79.3421"> </span>
<a href="#l79.3422"></a><span id="l79.3422">     InitCardFromRow(personCard, cardRow);</span>
<a href="#l79.3423"></a><span id="l79.3423">     personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l79.3424"></a><span id="l79.3424"> </span>
<a href="#l79.3425"></a><span id="l79.3425">     nsAutoCString id;</span>
<a href="#l79.3426"></a><span id="l79.3426">     id.AppendInt(rowID);</span>
<a href="#l79.3427"></a><span id="l79.3427">     personCard-&gt;SetLocalId(id);</span>
<a href="#l79.3428"></a><span id="l79.3428"> </span>
<a href="#l79.3429"></a><span id="l79.3429">     nsCOMPtr&lt;nsIAbDirectory&gt; abDir(do_QueryReferent(m_dbDirectory));</span>
<a href="#l79.3430"></a><span id="l79.3430" class="difflineminus">-    if (abDir)</span>
<a href="#l79.3431"></a><span id="l79.3431" class="difflineminus">-      abDir-&gt;GetUuid(id);</span>
<a href="#l79.3432"></a><span id="l79.3432" class="difflineplus">+    if (abDir) abDir-&gt;GetUuid(id);</span>
<a href="#l79.3433"></a><span id="l79.3433"> </span>
<a href="#l79.3434"></a><span id="l79.3434">     personCard-&gt;SetDirectoryId(id);</span>
<a href="#l79.3435"></a><span id="l79.3435"> </span>
<a href="#l79.3436"></a><span id="l79.3436">     personCard.forget(result);</span>
<a href="#l79.3437"></a><span id="l79.3437">   }</span>
<a href="#l79.3438"></a><span id="l79.3438"> </span>
<a href="#l79.3439"></a><span id="l79.3439">   return rv;</span>
<a href="#l79.3440"></a><span id="l79.3440"> }</span>
<a href="#l79.3441"></a><span id="l79.3441"> </span>
<a href="#l79.3442"></a><span id="l79.3442" class="difflineminus">-nsresult nsAddrDatabase::CreateABCard(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result)</span>
<a href="#l79.3443"></a><span id="l79.3443" class="difflineminus">-{</span>
<a href="#l79.3444"></a><span id="l79.3444" class="difflineplus">+nsresult nsAddrDatabase::CreateABCard(nsIMdbRow *cardRow, mdb_id listRowID,</span>
<a href="#l79.3445"></a><span id="l79.3445" class="difflineplus">+                                      nsIAbCard **result) {</span>
<a href="#l79.3446"></a><span id="l79.3446">   return CreateCard(cardRow, listRowID, result);</span>
<a href="#l79.3447"></a><span id="l79.3447"> }</span>
<a href="#l79.3448"></a><span id="l79.3448"> </span>
<a href="#l79.3449"></a><span id="l79.3449"> /* create a card for mailing list in the address book */</span>
<a href="#l79.3450"></a><span id="l79.3450" class="difflineminus">-nsresult nsAddrDatabase::CreateABListCard(nsIMdbRow* listRow, nsIAbCard **result)</span>
<a href="#l79.3451"></a><span id="l79.3451" class="difflineminus">-{</span>
<a href="#l79.3452"></a><span id="l79.3452" class="difflineminus">-  if (!listRow || !m_mdbEnv || !result)</span>
<a href="#l79.3453"></a><span id="l79.3453" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3454"></a><span id="l79.3454" class="difflineplus">+nsresult nsAddrDatabase::CreateABListCard(nsIMdbRow *listRow,</span>
<a href="#l79.3455"></a><span id="l79.3455" class="difflineplus">+                                          nsIAbCard **result) {</span>
<a href="#l79.3456"></a><span id="l79.3456" class="difflineplus">+  if (!listRow || !m_mdbEnv || !result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3457"></a><span id="l79.3457"> </span>
<a href="#l79.3458"></a><span id="l79.3458">   nsresult rv = NS_OK;</span>
<a href="#l79.3459"></a><span id="l79.3459"> </span>
<a href="#l79.3460"></a><span id="l79.3460">   mdbOid outOid;</span>
<a href="#l79.3461"></a><span id="l79.3461">   mdb_id rowID = 0;</span>
<a href="#l79.3462"></a><span id="l79.3462"> </span>
<a href="#l79.3463"></a><span id="l79.3463" class="difflineminus">-  if (NS_SUCCEEDED(listRow-&gt;GetOid(m_mdbEnv, &amp;outOid)))</span>
<a href="#l79.3464"></a><span id="l79.3464" class="difflineminus">-    rowID = outOid.mOid_Id;</span>
<a href="#l79.3465"></a><span id="l79.3465" class="difflineminus">-</span>
<a href="#l79.3466"></a><span id="l79.3466" class="difflineminus">-  char* listURI = nullptr;</span>
<a href="#l79.3467"></a><span id="l79.3467" class="difflineplus">+  if (NS_SUCCEEDED(listRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l79.3468"></a><span id="l79.3468" class="difflineplus">+</span>
<a href="#l79.3469"></a><span id="l79.3469" class="difflineplus">+  char *listURI = nullptr;</span>
<a href="#l79.3470"></a><span id="l79.3470"> </span>
<a href="#l79.3471"></a><span id="l79.3471">   nsAutoString fileName;</span>
<a href="#l79.3472"></a><span id="l79.3472">   rv = m_dbName-&gt;GetLeafName(fileName);</span>
<a href="#l79.3473"></a><span id="l79.3473">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3474"></a><span id="l79.3474" class="difflineminus">-  listURI = PR_smprintf(&quot;%s%s/MailList%ld&quot;, kMDBDirectoryRoot, NS_ConvertUTF16toUTF8(fileName).get(), rowID);</span>
<a href="#l79.3475"></a><span id="l79.3475" class="difflineplus">+  listURI = PR_smprintf(&quot;%s%s/MailList%ld&quot;, kMDBDirectoryRoot,</span>
<a href="#l79.3476"></a><span id="l79.3476" class="difflineplus">+                        NS_ConvertUTF16toUTF8(fileName).get(), rowID);</span>
<a href="#l79.3477"></a><span id="l79.3477"> </span>
<a href="#l79.3478"></a><span id="l79.3478">   nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l79.3479"></a><span id="l79.3479" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbm_dbDirectory(do_QueryReferent(m_dbDirectory,</span>
<a href="#l79.3480"></a><span id="l79.3480" class="difflineminus">-                                                               &amp;rv));</span>
<a href="#l79.3481"></a><span id="l79.3481" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; dbm_dbDirectory)</span>
<a href="#l79.3482"></a><span id="l79.3482" class="difflineminus">-  {</span>
<a href="#l79.3483"></a><span id="l79.3483" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbm_dbDirectory(</span>
<a href="#l79.3484"></a><span id="l79.3484" class="difflineplus">+      do_QueryReferent(m_dbDirectory, &amp;rv));</span>
<a href="#l79.3485"></a><span id="l79.3485" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; dbm_dbDirectory) {</span>
<a href="#l79.3486"></a><span id="l79.3486">     personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l79.3487"></a><span id="l79.3487" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l79.3488"></a><span id="l79.3488" class="difflineminus">-</span>
<a href="#l79.3489"></a><span id="l79.3489" class="difflineminus">-    if (personCard)</span>
<a href="#l79.3490"></a><span id="l79.3490" class="difflineminus">-    {</span>
<a href="#l79.3491"></a><span id="l79.3491" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3492"></a><span id="l79.3492" class="difflineplus">+</span>
<a href="#l79.3493"></a><span id="l79.3493" class="difflineplus">+    if (personCard) {</span>
<a href="#l79.3494"></a><span id="l79.3494">       GetListCardFromDB(personCard, listRow);</span>
<a href="#l79.3495"></a><span id="l79.3495"> </span>
<a href="#l79.3496"></a><span id="l79.3496">       personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l79.3497"></a><span id="l79.3497">       personCard-&gt;SetIsMailList(true);</span>
<a href="#l79.3498"></a><span id="l79.3498">       personCard-&gt;SetMailListURI(listURI);</span>
<a href="#l79.3499"></a><span id="l79.3499"> </span>
<a href="#l79.3500"></a><span id="l79.3500">       nsAutoCString id;</span>
<a href="#l79.3501"></a><span id="l79.3501">       id.AppendInt(rowID);</span>
<a href="#l79.3502"></a><span id="l79.3502">       personCard-&gt;SetLocalId(id);</span>
<a href="#l79.3503"></a><span id="l79.3503"> </span>
<a href="#l79.3504"></a><span id="l79.3504">       nsCOMPtr&lt;nsIAbDirectory&gt; abDir(do_QueryReferent(m_dbDirectory));</span>
<a href="#l79.3505"></a><span id="l79.3505" class="difflineminus">-      if (abDir)</span>
<a href="#l79.3506"></a><span id="l79.3506" class="difflineminus">-        abDir-&gt;GetUuid(id);</span>
<a href="#l79.3507"></a><span id="l79.3507" class="difflineplus">+      if (abDir) abDir-&gt;GetUuid(id);</span>
<a href="#l79.3508"></a><span id="l79.3508">       personCard-&gt;SetDirectoryId(id);</span>
<a href="#l79.3509"></a><span id="l79.3509">     }</span>
<a href="#l79.3510"></a><span id="l79.3510"> </span>
<a href="#l79.3511"></a><span id="l79.3511">     personCard.forget(result);</span>
<a href="#l79.3512"></a><span id="l79.3512">   }</span>
<a href="#l79.3513"></a><span id="l79.3513" class="difflineminus">-  if (listURI)</span>
<a href="#l79.3514"></a><span id="l79.3514" class="difflineminus">-    PR_smprintf_free(listURI);</span>
<a href="#l79.3515"></a><span id="l79.3515" class="difflineplus">+  if (listURI) PR_smprintf_free(listURI);</span>
<a href="#l79.3516"></a><span id="l79.3516"> </span>
<a href="#l79.3517"></a><span id="l79.3517">   return rv;</span>
<a href="#l79.3518"></a><span id="l79.3518"> }</span>
<a href="#l79.3519"></a><span id="l79.3519"> </span>
<a href="#l79.3520"></a><span id="l79.3520"> /* create a sub directory for mailing list in the address book left pane */</span>
<a href="#l79.3521"></a><span id="l79.3521" class="difflineminus">-nsresult nsAddrDatabase::CreateABList(nsIMdbRow* listRow, nsIAbDirectory **result)</span>
<a href="#l79.3522"></a><span id="l79.3522" class="difflineminus">-{</span>
<a href="#l79.3523"></a><span id="l79.3523" class="difflineplus">+nsresult nsAddrDatabase::CreateABList(nsIMdbRow *listRow,</span>
<a href="#l79.3524"></a><span id="l79.3524" class="difflineplus">+                                      nsIAbDirectory **result) {</span>
<a href="#l79.3525"></a><span id="l79.3525">   nsresult rv = NS_OK;</span>
<a href="#l79.3526"></a><span id="l79.3526"> </span>
<a href="#l79.3527"></a><span id="l79.3527" class="difflineminus">-  if (!listRow || !m_mdbEnv || !result)</span>
<a href="#l79.3528"></a><span id="l79.3528" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3529"></a><span id="l79.3529" class="difflineplus">+  if (!listRow || !m_mdbEnv || !result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3530"></a><span id="l79.3530"> </span>
<a href="#l79.3531"></a><span id="l79.3531">   mdbOid outOid;</span>
<a href="#l79.3532"></a><span id="l79.3532">   mdb_id rowID = 0;</span>
<a href="#l79.3533"></a><span id="l79.3533"> </span>
<a href="#l79.3534"></a><span id="l79.3534" class="difflineminus">-  if (NS_SUCCEEDED(listRow-&gt;GetOid(m_mdbEnv, &amp;outOid)))</span>
<a href="#l79.3535"></a><span id="l79.3535" class="difflineminus">-    rowID = outOid.mOid_Id;</span>
<a href="#l79.3536"></a><span id="l79.3536" class="difflineminus">-</span>
<a href="#l79.3537"></a><span id="l79.3537" class="difflineminus">-  char* listURI = nullptr;</span>
<a href="#l79.3538"></a><span id="l79.3538" class="difflineplus">+  if (NS_SUCCEEDED(listRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l79.3539"></a><span id="l79.3539" class="difflineplus">+</span>
<a href="#l79.3540"></a><span id="l79.3540" class="difflineplus">+  char *listURI = nullptr;</span>
<a href="#l79.3541"></a><span id="l79.3541"> </span>
<a href="#l79.3542"></a><span id="l79.3542">   nsAutoString fileName;</span>
<a href="#l79.3543"></a><span id="l79.3543">   m_dbName-&gt;GetLeafName(fileName);</span>
<a href="#l79.3544"></a><span id="l79.3544">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3545"></a><span id="l79.3545"> </span>
<a href="#l79.3546"></a><span id="l79.3546" class="difflineminus">-  listURI = PR_smprintf(&quot;%s%s/MailList%ld&quot;, kMDBDirectoryRoot, NS_ConvertUTF16toUTF8(fileName).get(), rowID);</span>
<a href="#l79.3547"></a><span id="l79.3547" class="difflineplus">+  listURI = PR_smprintf(&quot;%s%s/MailList%ld&quot;, kMDBDirectoryRoot,</span>
<a href="#l79.3548"></a><span id="l79.3548" class="difflineplus">+                        NS_ConvertUTF16toUTF8(fileName).get(), rowID);</span>
<a href="#l79.3549"></a><span id="l79.3549"> </span>
<a href="#l79.3550"></a><span id="l79.3550">   nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l79.3551"></a><span id="l79.3551" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbm_dbDirectory(do_QueryReferent(m_dbDirectory,</span>
<a href="#l79.3552"></a><span id="l79.3552" class="difflineminus">-                                                               &amp;rv));</span>
<a href="#l79.3553"></a><span id="l79.3553" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; dbm_dbDirectory)</span>
<a href="#l79.3554"></a><span id="l79.3554" class="difflineminus">-  {</span>
<a href="#l79.3555"></a><span id="l79.3555" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbm_dbDirectory(</span>
<a href="#l79.3556"></a><span id="l79.3556" class="difflineplus">+      do_QueryReferent(m_dbDirectory, &amp;rv));</span>
<a href="#l79.3557"></a><span id="l79.3557" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; dbm_dbDirectory) {</span>
<a href="#l79.3558"></a><span id="l79.3558">     rv = dbm_dbDirectory-&gt;AddDirectory(listURI, getter_AddRefs(mailList));</span>
<a href="#l79.3559"></a><span id="l79.3559"> </span>
<a href="#l79.3560"></a><span id="l79.3560" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList (do_QueryInterface(mailList, &amp;rv));</span>
<a href="#l79.3561"></a><span id="l79.3561" class="difflineminus">-</span>
<a href="#l79.3562"></a><span id="l79.3562" class="difflineminus">-    if (mailList)</span>
<a href="#l79.3563"></a><span id="l79.3563" class="difflineminus">-    {</span>
<a href="#l79.3564"></a><span id="l79.3564" class="difflineplus">+    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;rv));</span>
<a href="#l79.3565"></a><span id="l79.3565" class="difflineplus">+</span>
<a href="#l79.3566"></a><span id="l79.3566" class="difflineplus">+    if (mailList) {</span>
<a href="#l79.3567"></a><span id="l79.3567">       // if we are using turbo, and we &quot;exit&quot; and restart with the same profile</span>
<a href="#l79.3568"></a><span id="l79.3568">       // the current mailing list will still be in memory, so when we do</span>
<a href="#l79.3569"></a><span id="l79.3569">       // GetResource() and QI, we'll get it again.</span>
<a href="#l79.3570"></a><span id="l79.3570">       // in that scenario, the mailList that we pass in will already be</span>
<a href="#l79.3571"></a><span id="l79.3571">       // be a mailing list, with a valid row and all the entries</span>
<a href="#l79.3572"></a><span id="l79.3572">       // in that scenario, we can skip GetListFromDB(), which would have</span>
<a href="#l79.3573"></a><span id="l79.3573">       // have added all the cards to the list again.</span>
<a href="#l79.3574"></a><span id="l79.3574">       // see bug #134743</span>
<a href="#l79.3575"></a><span id="l79.3575" class="difflineat">@@ -2851,282 +2682,248 @@ nsresult nsAddrDatabase::CreateABList(ns</span>
<a href="#l79.3576"></a><span id="l79.3576">         dbmailList-&gt;SetDbRowID(rowID);</span>
<a href="#l79.3577"></a><span id="l79.3577">       }</span>
<a href="#l79.3578"></a><span id="l79.3578"> </span>
<a href="#l79.3579"></a><span id="l79.3579">       dbm_dbDirectory-&gt;AddMailListToDirectory(mailList);</span>
<a href="#l79.3580"></a><span id="l79.3580">       mailList.forget(result);</span>
<a href="#l79.3581"></a><span id="l79.3581">     }</span>
<a href="#l79.3582"></a><span id="l79.3582">   }</span>
<a href="#l79.3583"></a><span id="l79.3583"> </span>
<a href="#l79.3584"></a><span id="l79.3584" class="difflineminus">-  if (listURI)</span>
<a href="#l79.3585"></a><span id="l79.3585" class="difflineminus">-    PR_smprintf_free(listURI);</span>
<a href="#l79.3586"></a><span id="l79.3586" class="difflineplus">+  if (listURI) PR_smprintf_free(listURI);</span>
<a href="#l79.3587"></a><span id="l79.3587"> </span>
<a href="#l79.3588"></a><span id="l79.3588">   return rv;</span>
<a href="#l79.3589"></a><span id="l79.3589"> }</span>
<a href="#l79.3590"></a><span id="l79.3590"> </span>
<a href="#l79.3591"></a><span id="l79.3591" class="difflineminus">-nsresult nsAddrDatabase::GetCardRowByRowID(mdb_id rowID, nsIMdbRow **dbRow)</span>
<a href="#l79.3592"></a><span id="l79.3592" class="difflineminus">-{</span>
<a href="#l79.3593"></a><span id="l79.3593" class="difflineminus">-  if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.3594"></a><span id="l79.3594" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3595"></a><span id="l79.3595" class="difflineplus">+nsresult nsAddrDatabase::GetCardRowByRowID(mdb_id rowID, nsIMdbRow **dbRow) {</span>
<a href="#l79.3596"></a><span id="l79.3596" class="difflineplus">+  if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3597"></a><span id="l79.3597"> </span>
<a href="#l79.3598"></a><span id="l79.3598">   mdbOid rowOid;</span>
<a href="#l79.3599"></a><span id="l79.3599">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l79.3600"></a><span id="l79.3600">   rowOid.mOid_Id = rowID;</span>
<a href="#l79.3601"></a><span id="l79.3601"> </span>
<a href="#l79.3602"></a><span id="l79.3602">   return m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, dbRow);</span>
<a href="#l79.3603"></a><span id="l79.3603"> }</span>
<a href="#l79.3604"></a><span id="l79.3604"> </span>
<a href="#l79.3605"></a><span id="l79.3605" class="difflineminus">-nsresult nsAddrDatabase::GetListRowByRowID(mdb_id rowID, nsIMdbRow **dbRow)</span>
<a href="#l79.3606"></a><span id="l79.3606" class="difflineminus">-{</span>
<a href="#l79.3607"></a><span id="l79.3607" class="difflineminus">-  if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.3608"></a><span id="l79.3608" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3609"></a><span id="l79.3609" class="difflineplus">+nsresult nsAddrDatabase::GetListRowByRowID(mdb_id rowID, nsIMdbRow **dbRow) {</span>
<a href="#l79.3610"></a><span id="l79.3610" class="difflineplus">+  if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3611"></a><span id="l79.3611"> </span>
<a href="#l79.3612"></a><span id="l79.3612">   mdbOid rowOid;</span>
<a href="#l79.3613"></a><span id="l79.3613">   rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l79.3614"></a><span id="l79.3614">   rowOid.mOid_Id = rowID;</span>
<a href="#l79.3615"></a><span id="l79.3615"> </span>
<a href="#l79.3616"></a><span id="l79.3616">   return m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, dbRow);</span>
<a href="#l79.3617"></a><span id="l79.3617"> }</span>
<a href="#l79.3618"></a><span id="l79.3618"> </span>
<a href="#l79.3619"></a><span id="l79.3619"> nsresult nsAddrDatabase::GetRowFromAttribute(const char *aName,</span>
<a href="#l79.3620"></a><span id="l79.3620">                                              const nsACString &amp;aUTF8Value,</span>
<a href="#l79.3621"></a><span id="l79.3621">                                              bool aCaseInsensitive,</span>
<a href="#l79.3622"></a><span id="l79.3622">                                              nsIMdbRow **aCardRow,</span>
<a href="#l79.3623"></a><span id="l79.3623" class="difflineminus">-                                             mdb_pos *aRowPos)</span>
<a href="#l79.3624"></a><span id="l79.3624" class="difflineminus">-{</span>
<a href="#l79.3625"></a><span id="l79.3625" class="difflineplus">+                                             mdb_pos *aRowPos) {</span>
<a href="#l79.3626"></a><span id="l79.3626">   NS_ENSURE_ARG_POINTER(aName);</span>
<a href="#l79.3627"></a><span id="l79.3627">   NS_ENSURE_ARG_POINTER(aCardRow);</span>
<a href="#l79.3628"></a><span id="l79.3628" class="difflineminus">-  if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l79.3629"></a><span id="l79.3629" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3630"></a><span id="l79.3630" class="difflineplus">+  if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3631"></a><span id="l79.3631"> </span>
<a href="#l79.3632"></a><span id="l79.3632">   mdb_token token;</span>
<a href="#l79.3633"></a><span id="l79.3633">   m_mdbStore-&gt;StringToToken(m_mdbEnv, aName, &amp;token);</span>
<a href="#l79.3634"></a><span id="l79.3634">   NS_ConvertUTF8toUTF16 newUnicodeString(aUTF8Value);</span>
<a href="#l79.3635"></a><span id="l79.3635"> </span>
<a href="#l79.3636"></a><span id="l79.3636">   return GetRowForCharColumn(newUnicodeString.get(), token, true,</span>
<a href="#l79.3637"></a><span id="l79.3637">                              aCaseInsensitive, aCardRow, aRowPos);</span>
<a href="#l79.3638"></a><span id="l79.3638"> }</span>
<a href="#l79.3639"></a><span id="l79.3639"> </span>
<a href="#l79.3640"></a><span id="l79.3640"> NS_IMETHODIMP nsAddrDatabase::GetCardFromAttribute(nsIAbDirectory *aDirectory,</span>
<a href="#l79.3641"></a><span id="l79.3641">                                                    const char *aName,</span>
<a href="#l79.3642"></a><span id="l79.3642">                                                    const nsACString &amp;aUTF8Value,</span>
<a href="#l79.3643"></a><span id="l79.3643">                                                    bool aCaseInsensitive,</span>
<a href="#l79.3644"></a><span id="l79.3644" class="difflineminus">-                                                   nsIAbCard **aCardResult)</span>
<a href="#l79.3645"></a><span id="l79.3645" class="difflineminus">-{</span>
<a href="#l79.3646"></a><span id="l79.3646" class="difflineplus">+                                                   nsIAbCard **aCardResult) {</span>
<a href="#l79.3647"></a><span id="l79.3647">   NS_ENSURE_ARG_POINTER(aCardResult);</span>
<a href="#l79.3648"></a><span id="l79.3648"> </span>
<a href="#l79.3649"></a><span id="l79.3649">   m_dbDirectory = do_GetWeakReference(aDirectory);</span>
<a href="#l79.3650"></a><span id="l79.3650">   nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l79.3651"></a><span id="l79.3651">   if (NS_SUCCEEDED(GetRowFromAttribute(aName, aUTF8Value, aCaseInsensitive,</span>
<a href="#l79.3652"></a><span id="l79.3652" class="difflineminus">-                                       getter_AddRefs(cardRow), nullptr)) &amp;&amp; cardRow)</span>
<a href="#l79.3653"></a><span id="l79.3653" class="difflineplus">+                                       getter_AddRefs(cardRow), nullptr)) &amp;&amp;</span>
<a href="#l79.3654"></a><span id="l79.3654" class="difflineplus">+      cardRow)</span>
<a href="#l79.3655"></a><span id="l79.3655">     return CreateABCard(cardRow, 0, aCardResult);</span>
<a href="#l79.3656"></a><span id="l79.3656"> </span>
<a href="#l79.3657"></a><span id="l79.3657">   *aCardResult = nullptr;</span>
<a href="#l79.3658"></a><span id="l79.3658">   return NS_OK;</span>
<a href="#l79.3659"></a><span id="l79.3659"> }</span>
<a href="#l79.3660"></a><span id="l79.3660"> </span>
<a href="#l79.3661"></a><span id="l79.3661" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::GetCardsFromAttribute(nsIAbDirectory *aDirectory,</span>
<a href="#l79.3662"></a><span id="l79.3662" class="difflineminus">-                                                    const char *aName,</span>
<a href="#l79.3663"></a><span id="l79.3663" class="difflineminus">-                                                    const nsACString &amp; aUTF8Value,</span>
<a href="#l79.3664"></a><span id="l79.3664" class="difflineminus">-                                                    bool aCaseInsensitive,</span>
<a href="#l79.3665"></a><span id="l79.3665" class="difflineminus">-                                                    nsISimpleEnumerator **cards)</span>
<a href="#l79.3666"></a><span id="l79.3666" class="difflineminus">-{</span>
<a href="#l79.3667"></a><span id="l79.3667" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::GetCardsFromAttribute(</span>
<a href="#l79.3668"></a><span id="l79.3668" class="difflineplus">+    nsIAbDirectory *aDirectory, const char *aName, const nsACString &amp;aUTF8Value,</span>
<a href="#l79.3669"></a><span id="l79.3669" class="difflineplus">+    bool aCaseInsensitive, nsISimpleEnumerator **cards) {</span>
<a href="#l79.3670"></a><span id="l79.3670">   NS_ENSURE_ARG_POINTER(cards);</span>
<a href="#l79.3671"></a><span id="l79.3671"> </span>
<a href="#l79.3672"></a><span id="l79.3672">   m_dbDirectory = do_GetWeakReference(aDirectory);</span>
<a href="#l79.3673"></a><span id="l79.3673">   nsCOMPtr&lt;nsIMdbRow&gt; row;</span>
<a href="#l79.3674"></a><span id="l79.3674">   bool done = false;</span>
<a href="#l79.3675"></a><span id="l79.3675">   nsCOMArray&lt;nsIAbCard&gt; list;</span>
<a href="#l79.3676"></a><span id="l79.3676">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l79.3677"></a><span id="l79.3677">   mdb_pos rowPos = -1;</span>
<a href="#l79.3678"></a><span id="l79.3678"> </span>
<a href="#l79.3679"></a><span id="l79.3679" class="difflineminus">-  do</span>
<a href="#l79.3680"></a><span id="l79.3680" class="difflineminus">-  {</span>
<a href="#l79.3681"></a><span id="l79.3681" class="difflineplus">+  do {</span>
<a href="#l79.3682"></a><span id="l79.3682">     if (NS_SUCCEEDED(GetRowFromAttribute(aName, aUTF8Value, aCaseInsensitive,</span>
<a href="#l79.3683"></a><span id="l79.3683" class="difflineminus">-                                         getter_AddRefs(row), &amp;rowPos)) &amp;&amp; row)</span>
<a href="#l79.3684"></a><span id="l79.3684" class="difflineminus">-    {</span>
<a href="#l79.3685"></a><span id="l79.3685" class="difflineminus">-      if (NS_FAILED(CreateABCard(row, 0, getter_AddRefs(card))))</span>
<a href="#l79.3686"></a><span id="l79.3686" class="difflineminus">-        continue;</span>
<a href="#l79.3687"></a><span id="l79.3687" class="difflineplus">+                                         getter_AddRefs(row), &amp;rowPos)) &amp;&amp;</span>
<a href="#l79.3688"></a><span id="l79.3688" class="difflineplus">+        row) {</span>
<a href="#l79.3689"></a><span id="l79.3689" class="difflineplus">+      if (NS_FAILED(CreateABCard(row, 0, getter_AddRefs(card)))) continue;</span>
<a href="#l79.3690"></a><span id="l79.3690">       list.AppendObject(card);</span>
<a href="#l79.3691"></a><span id="l79.3691" class="difflineminus">-    }</span>
<a href="#l79.3692"></a><span id="l79.3692" class="difflineminus">-    else</span>
<a href="#l79.3693"></a><span id="l79.3693" class="difflineplus">+    } else</span>
<a href="#l79.3694"></a><span id="l79.3694">       done = true;</span>
<a href="#l79.3695"></a><span id="l79.3695">   } while (!done);</span>
<a href="#l79.3696"></a><span id="l79.3696"> </span>
<a href="#l79.3697"></a><span id="l79.3697">   return NS_NewArrayEnumerator(cards, list, NS_GET_IID(nsIAbCard));</span>
<a href="#l79.3698"></a><span id="l79.3698"> }</span>
<a href="#l79.3699"></a><span id="l79.3699"> </span>
<a href="#l79.3700"></a><span id="l79.3700" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::AddListDirNode(nsIMdbRow * listRow)</span>
<a href="#l79.3701"></a><span id="l79.3701" class="difflineminus">-{</span>
<a href="#l79.3702"></a><span id="l79.3702" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::AddListDirNode(nsIMdbRow *listRow) {</span>
<a href="#l79.3703"></a><span id="l79.3703">   nsresult rv = NS_OK;</span>
<a href="#l79.3704"></a><span id="l79.3704"> </span>
<a href="#l79.3705"></a><span id="l79.3705">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l79.3706"></a><span id="l79.3706"> </span>
<a href="#l79.3707"></a><span id="l79.3707" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l79.3708"></a><span id="l79.3708" class="difflineminus">-  {</span>
<a href="#l79.3709"></a><span id="l79.3709" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l79.3710"></a><span id="l79.3710">     nsAutoString parentURI;</span>
<a href="#l79.3711"></a><span id="l79.3711">     rv = m_dbName-&gt;GetLeafName(parentURI);</span>
<a href="#l79.3712"></a><span id="l79.3712">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3713"></a><span id="l79.3713"> </span>
<a href="#l79.3714"></a><span id="l79.3714">     parentURI.Replace(0, 0, NS_LITERAL_STRING(kMDBDirectoryRoot));</span>
<a href="#l79.3715"></a><span id="l79.3715"> </span>
<a href="#l79.3716"></a><span id="l79.3716">     nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l79.3717"></a><span id="l79.3717">     rv = abManager-&gt;GetDirectory(NS_ConvertUTF16toUTF8(parentURI),</span>
<a href="#l79.3718"></a><span id="l79.3718">                                  getter_AddRefs(parentDir));</span>
<a href="#l79.3719"></a><span id="l79.3719">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.3720"></a><span id="l79.3720"> </span>
<a href="#l79.3721"></a><span id="l79.3721" class="difflineminus">-    if (parentDir)</span>
<a href="#l79.3722"></a><span id="l79.3722" class="difflineminus">-    {</span>
<a href="#l79.3723"></a><span id="l79.3723" class="difflineplus">+    if (parentDir) {</span>
<a href="#l79.3724"></a><span id="l79.3724">       m_dbDirectory = do_GetWeakReference(parentDir);</span>
<a href="#l79.3725"></a><span id="l79.3725">       nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l79.3726"></a><span id="l79.3726">       rv = CreateABList(listRow, getter_AddRefs(mailList));</span>
<a href="#l79.3727"></a><span id="l79.3727" class="difflineminus">-      if (mailList)</span>
<a href="#l79.3728"></a><span id="l79.3728" class="difflineminus">-      {</span>
<a href="#l79.3729"></a><span id="l79.3729" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbparentDir(do_QueryInterface(parentDir, &amp;rv));</span>
<a href="#l79.3730"></a><span id="l79.3730" class="difflineminus">-        if(NS_SUCCEEDED(rv))</span>
<a href="#l79.3731"></a><span id="l79.3731" class="difflineminus">-          dbparentDir-&gt;NotifyDirItemAdded(mailList);</span>
<a href="#l79.3732"></a><span id="l79.3732" class="difflineplus">+      if (mailList) {</span>
<a href="#l79.3733"></a><span id="l79.3733" class="difflineplus">+        nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbparentDir(</span>
<a href="#l79.3734"></a><span id="l79.3734" class="difflineplus">+            do_QueryInterface(parentDir, &amp;rv));</span>
<a href="#l79.3735"></a><span id="l79.3735" class="difflineplus">+        if (NS_SUCCEEDED(rv)) dbparentDir-&gt;NotifyDirItemAdded(mailList);</span>
<a href="#l79.3736"></a><span id="l79.3736">       }</span>
<a href="#l79.3737"></a><span id="l79.3737">     }</span>
<a href="#l79.3738"></a><span id="l79.3738">   }</span>
<a href="#l79.3739"></a><span id="l79.3739">   return rv;</span>
<a href="#l79.3740"></a><span id="l79.3740"> }</span>
<a href="#l79.3741"></a><span id="l79.3741"> </span>
<a href="#l79.3742"></a><span id="l79.3742" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::FindMailListbyUnicodeName(const char16_t *listName, bool *exist)</span>
<a href="#l79.3743"></a><span id="l79.3743" class="difflineminus">-{</span>
<a href="#l79.3744"></a><span id="l79.3744" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::FindMailListbyUnicodeName(</span>
<a href="#l79.3745"></a><span id="l79.3745" class="difflineplus">+    const char16_t *listName, bool *exist) {</span>
<a href="#l79.3746"></a><span id="l79.3746">   nsAutoString unicodeString(listName);</span>
<a href="#l79.3747"></a><span id="l79.3747">   ToLowerCase(unicodeString);</span>
<a href="#l79.3748"></a><span id="l79.3748"> </span>
<a href="#l79.3749"></a><span id="l79.3749" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; listRow;</span>
<a href="#l79.3750"></a><span id="l79.3750" class="difflineminus">-  nsresult rv = GetRowForCharColumn(unicodeString.get(),</span>
<a href="#l79.3751"></a><span id="l79.3751" class="difflineminus">-                                    m_LowerListNameColumnToken, false,</span>
<a href="#l79.3752"></a><span id="l79.3752" class="difflineminus">-                                    false, getter_AddRefs(listRow), nullptr);</span>
<a href="#l79.3753"></a><span id="l79.3753" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; listRow;</span>
<a href="#l79.3754"></a><span id="l79.3754" class="difflineplus">+  nsresult rv =</span>
<a href="#l79.3755"></a><span id="l79.3755" class="difflineplus">+      GetRowForCharColumn(unicodeString.get(), m_LowerListNameColumnToken,</span>
<a href="#l79.3756"></a><span id="l79.3756" class="difflineplus">+                          false, false, getter_AddRefs(listRow), nullptr);</span>
<a href="#l79.3757"></a><span id="l79.3757">   *exist = (NS_SUCCEEDED(rv) &amp;&amp; listRow);</span>
<a href="#l79.3758"></a><span id="l79.3758">   return rv;</span>
<a href="#l79.3759"></a><span id="l79.3759"> }</span>
<a href="#l79.3760"></a><span id="l79.3760"> </span>
<a href="#l79.3761"></a><span id="l79.3761" class="difflineminus">-NS_IMETHODIMP nsAddrDatabase::GetCardCount(uint32_t *count)</span>
<a href="#l79.3762"></a><span id="l79.3762" class="difflineminus">-{</span>
<a href="#l79.3763"></a><span id="l79.3763" class="difflineminus">-    nsresult rv;</span>
<a href="#l79.3764"></a><span id="l79.3764" class="difflineminus">-    mdb_count c;</span>
<a href="#l79.3765"></a><span id="l79.3765" class="difflineminus">-    rv = m_mdbPabTable-&gt;GetCount(m_mdbEnv, &amp;c);</span>
<a href="#l79.3766"></a><span id="l79.3766" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l79.3767"></a><span id="l79.3767" class="difflineminus">-        *count = c - 1;  // Don't count LastRecordKey</span>
<a href="#l79.3768"></a><span id="l79.3768" class="difflineminus">-</span>
<a href="#l79.3769"></a><span id="l79.3769" class="difflineminus">-    return rv;</span>
<a href="#l79.3770"></a><span id="l79.3770" class="difflineplus">+NS_IMETHODIMP nsAddrDatabase::GetCardCount(uint32_t *count) {</span>
<a href="#l79.3771"></a><span id="l79.3771" class="difflineplus">+  nsresult rv;</span>
<a href="#l79.3772"></a><span id="l79.3772" class="difflineplus">+  mdb_count c;</span>
<a href="#l79.3773"></a><span id="l79.3773" class="difflineplus">+  rv = m_mdbPabTable-&gt;GetCount(m_mdbEnv, &amp;c);</span>
<a href="#l79.3774"></a><span id="l79.3774" class="difflineplus">+  if (NS_SUCCEEDED(rv)) *count = c - 1;  // Don't count LastRecordKey</span>
<a href="#l79.3775"></a><span id="l79.3775" class="difflineplus">+</span>
<a href="#l79.3776"></a><span id="l79.3776" class="difflineplus">+  return rv;</span>
<a href="#l79.3777"></a><span id="l79.3777"> }</span>
<a href="#l79.3778"></a><span id="l79.3778"> </span>
<a href="#l79.3779"></a><span id="l79.3779" class="difflineminus">-bool</span>
<a href="#l79.3780"></a><span id="l79.3780" class="difflineminus">-nsAddrDatabase::HasRowForCharColumn(const char16_t *unicodeStr, mdb_column findColumn, bool aIsCard, nsIMdbRow **aFindRow)</span>
<a href="#l79.3781"></a><span id="l79.3781" class="difflineminus">-{</span>
<a href="#l79.3782"></a><span id="l79.3782" class="difflineminus">-  if (!m_mdbStore || !aFindRow || !m_mdbEnv)</span>
<a href="#l79.3783"></a><span id="l79.3783" class="difflineminus">-    return false;</span>
<a href="#l79.3784"></a><span id="l79.3784" class="difflineminus">-</span>
<a href="#l79.3785"></a><span id="l79.3785" class="difflineminus">-  mdbYarn    sourceYarn;</span>
<a href="#l79.3786"></a><span id="l79.3786" class="difflineplus">+bool nsAddrDatabase::HasRowForCharColumn(const char16_t *unicodeStr,</span>
<a href="#l79.3787"></a><span id="l79.3787" class="difflineplus">+                                         mdb_column findColumn, bool aIsCard,</span>
<a href="#l79.3788"></a><span id="l79.3788" class="difflineplus">+                                         nsIMdbRow **aFindRow) {</span>
<a href="#l79.3789"></a><span id="l79.3789" class="difflineplus">+  if (!m_mdbStore || !aFindRow || !m_mdbEnv) return false;</span>
<a href="#l79.3790"></a><span id="l79.3790" class="difflineplus">+</span>
<a href="#l79.3791"></a><span id="l79.3791" class="difflineplus">+  mdbYarn sourceYarn;</span>
<a href="#l79.3792"></a><span id="l79.3792"> </span>
<a href="#l79.3793"></a><span id="l79.3793">   NS_ConvertUTF16toUTF8 UTF8String(unicodeStr);</span>
<a href="#l79.3794"></a><span id="l79.3794" class="difflineminus">-  sourceYarn.mYarn_Buf = (void *) UTF8String.get();</span>
<a href="#l79.3795"></a><span id="l79.3795" class="difflineplus">+  sourceYarn.mYarn_Buf = (void *)UTF8String.get();</span>
<a href="#l79.3796"></a><span id="l79.3796">   sourceYarn.mYarn_Fill = UTF8String.Length();</span>
<a href="#l79.3797"></a><span id="l79.3797">   sourceYarn.mYarn_Form = 0;</span>
<a href="#l79.3798"></a><span id="l79.3798">   sourceYarn.mYarn_Size = sourceYarn.mYarn_Fill;</span>
<a href="#l79.3799"></a><span id="l79.3799"> </span>
<a href="#l79.3800"></a><span id="l79.3800" class="difflineminus">-  mdbOid        outRowId;</span>
<a href="#l79.3801"></a><span id="l79.3801" class="difflineplus">+  mdbOid outRowId;</span>
<a href="#l79.3802"></a><span id="l79.3802">   nsresult rv;</span>
<a href="#l79.3803"></a><span id="l79.3803"> </span>
<a href="#l79.3804"></a><span id="l79.3804" class="difflineminus">-  if (aIsCard)</span>
<a href="#l79.3805"></a><span id="l79.3805" class="difflineminus">-  {</span>
<a href="#l79.3806"></a><span id="l79.3806" class="difflineminus">-    rv = m_mdbStore-&gt;FindRow(m_mdbEnv, m_CardRowScopeToken,</span>
<a href="#l79.3807"></a><span id="l79.3807" class="difflineminus">-      findColumn, &amp;sourceYarn,  &amp;outRowId, aFindRow);</span>
<a href="#l79.3808"></a><span id="l79.3808" class="difflineplus">+  if (aIsCard) {</span>
<a href="#l79.3809"></a><span id="l79.3809" class="difflineplus">+    rv = m_mdbStore-&gt;FindRow(m_mdbEnv, m_CardRowScopeToken, findColumn,</span>
<a href="#l79.3810"></a><span id="l79.3810" class="difflineplus">+                             &amp;sourceYarn, &amp;outRowId, aFindRow);</span>
<a href="#l79.3811"></a><span id="l79.3811">     return (NS_SUCCEEDED(rv) &amp;&amp; *aFindRow);</span>
<a href="#l79.3812"></a><span id="l79.3812">   }</span>
<a href="#l79.3813"></a><span id="l79.3813"> </span>
<a href="#l79.3814"></a><span id="l79.3814" class="difflineminus">-  rv = m_mdbStore-&gt;FindRow(m_mdbEnv, m_ListRowScopeToken,</span>
<a href="#l79.3815"></a><span id="l79.3815" class="difflineminus">-    findColumn, &amp;sourceYarn,  &amp;outRowId, aFindRow);</span>
<a href="#l79.3816"></a><span id="l79.3816" class="difflineplus">+  rv = m_mdbStore-&gt;FindRow(m_mdbEnv, m_ListRowScopeToken, findColumn,</span>
<a href="#l79.3817"></a><span id="l79.3817" class="difflineplus">+                           &amp;sourceYarn, &amp;outRowId, aFindRow);</span>
<a href="#l79.3818"></a><span id="l79.3818">   return (NS_SUCCEEDED(rv) &amp;&amp; *aFindRow);</span>
<a href="#l79.3819"></a><span id="l79.3819"> }</span>
<a href="#l79.3820"></a><span id="l79.3820"> </span>
<a href="#l79.3821"></a><span id="l79.3821"> /* @param aRowPos Contains the row position for multiple calls. Should be</span>
<a href="#l79.3822"></a><span id="l79.3822">  *                instantiated to -1 on the first call. Or can be null</span>
<a href="#l79.3823"></a><span id="l79.3823">  *                if you are not making multiple calls.</span>
<a href="#l79.3824"></a><span id="l79.3824">  */</span>
<a href="#l79.3825"></a><span id="l79.3825" class="difflineminus">-nsresult</span>
<a href="#l79.3826"></a><span id="l79.3826" class="difflineminus">-nsAddrDatabase::GetRowForCharColumn(const char16_t *unicodeStr,</span>
<a href="#l79.3827"></a><span id="l79.3827" class="difflineminus">-                                    mdb_column findColumn, bool aIsCard,</span>
<a href="#l79.3828"></a><span id="l79.3828" class="difflineminus">-                                    bool aCaseInsensitive,</span>
<a href="#l79.3829"></a><span id="l79.3829" class="difflineminus">-                                    nsIMdbRow **aFindRow,</span>
<a href="#l79.3830"></a><span id="l79.3830" class="difflineminus">-                                    mdb_pos *aRowPos)</span>
<a href="#l79.3831"></a><span id="l79.3831" class="difflineminus">-{</span>
<a href="#l79.3832"></a><span id="l79.3832" class="difflineplus">+nsresult nsAddrDatabase::GetRowForCharColumn(</span>
<a href="#l79.3833"></a><span id="l79.3833" class="difflineplus">+    const char16_t *unicodeStr, mdb_column findColumn, bool aIsCard,</span>
<a href="#l79.3834"></a><span id="l79.3834" class="difflineplus">+    bool aCaseInsensitive, nsIMdbRow **aFindRow, mdb_pos *aRowPos) {</span>
<a href="#l79.3835"></a><span id="l79.3835">   NS_ENSURE_ARG_POINTER(unicodeStr);</span>
<a href="#l79.3836"></a><span id="l79.3836">   NS_ENSURE_ARG_POINTER(aFindRow);</span>
<a href="#l79.3837"></a><span id="l79.3837">   NS_ENSURE_TRUE(m_mdbEnv &amp;&amp; m_mdbPabTable, NS_ERROR_NULL_POINTER);</span>
<a href="#l79.3838"></a><span id="l79.3838"> </span>
<a href="#l79.3839"></a><span id="l79.3839">   *aFindRow = nullptr;</span>
<a href="#l79.3840"></a><span id="l79.3840"> </span>
<a href="#l79.3841"></a><span id="l79.3841" class="difflineminus">-  if (!aRowPos &amp;&amp; !HasRowForCharColumn(unicodeStr, findColumn, aIsCard, aFindRow))</span>
<a href="#l79.3842"></a><span id="l79.3842" class="difflineminus">-  {</span>
<a href="#l79.3843"></a><span id="l79.3843" class="difflineplus">+  if (!aRowPos &amp;&amp;</span>
<a href="#l79.3844"></a><span id="l79.3844" class="difflineplus">+      !HasRowForCharColumn(unicodeStr, findColumn, aIsCard, aFindRow)) {</span>
<a href="#l79.3845"></a><span id="l79.3845">     // If we have a row, return NS_OK.</span>
<a href="#l79.3846"></a><span id="l79.3846">     // If we don't have a row, there are two possible conditions: either the</span>
<a href="#l79.3847"></a><span id="l79.3847">     // card does not exist, or we are doing case-insensitive searching and the</span>
<a href="#l79.3848"></a><span id="l79.3848">     // value isn't lowercase.</span>
<a href="#l79.3849"></a><span id="l79.3849"> </span>
<a href="#l79.3850"></a><span id="l79.3850">     // Valid result, return.</span>
<a href="#l79.3851"></a><span id="l79.3851" class="difflineminus">-    if (*aFindRow)</span>
<a href="#l79.3852"></a><span id="l79.3852" class="difflineminus">-      return NS_OK;</span>
<a href="#l79.3853"></a><span id="l79.3853" class="difflineplus">+    if (*aFindRow) return NS_OK;</span>
<a href="#l79.3854"></a><span id="l79.3854"> </span>
<a href="#l79.3855"></a><span id="l79.3855">     // We definitely don't have anything at this point if case-sensitive.</span>
<a href="#l79.3856"></a><span id="l79.3856" class="difflineminus">-    if (!aCaseInsensitive)</span>
<a href="#l79.3857"></a><span id="l79.3857" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l79.3858"></a><span id="l79.3858" class="difflineplus">+    if (!aCaseInsensitive) return NS_ERROR_FAILURE;</span>
<a href="#l79.3859"></a><span id="l79.3859">   }</span>
<a href="#l79.3860"></a><span id="l79.3860"> </span>
<a href="#l79.3861"></a><span id="l79.3861">   // Check if there is matching card.</span>
<a href="#l79.3862"></a><span id="l79.3862">   nsCOMPtr&lt;nsIMdbTableRowCursor&gt; rowCursor;</span>
<a href="#l79.3863"></a><span id="l79.3863">   mdb_pos rowPos = -1;</span>
<a href="#l79.3864"></a><span id="l79.3864">   bool done = false;</span>
<a href="#l79.3865"></a><span id="l79.3865">   nsCOMPtr&lt;nsIMdbRow&gt; currentRow;</span>
<a href="#l79.3866"></a><span id="l79.3866">   nsAutoString columnValue;</span>
<a href="#l79.3867"></a><span id="l79.3867"> </span>
<a href="#l79.3868"></a><span id="l79.3868" class="difflineminus">-  if (aRowPos)</span>
<a href="#l79.3869"></a><span id="l79.3869" class="difflineminus">-    rowPos = *aRowPos;</span>
<a href="#l79.3870"></a><span id="l79.3870" class="difflineplus">+  if (aRowPos) rowPos = *aRowPos;</span>
<a href="#l79.3871"></a><span id="l79.3871"> </span>
<a href="#l79.3872"></a><span id="l79.3872">   mdb_scope targetScope = aIsCard ? m_CardRowScopeToken : m_ListRowScopeToken;</span>
<a href="#l79.3873"></a><span id="l79.3873"> </span>
<a href="#l79.3874"></a><span id="l79.3874">   m_mdbPabTable-&gt;GetTableRowCursor(m_mdbEnv, rowPos, getter_AddRefs(rowCursor));</span>
<a href="#l79.3875"></a><span id="l79.3875" class="difflineminus">-  if (!rowCursor)</span>
<a href="#l79.3876"></a><span id="l79.3876" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l79.3877"></a><span id="l79.3877" class="difflineminus">-</span>
<a href="#l79.3878"></a><span id="l79.3878" class="difflineminus">-  while (!done)</span>
<a href="#l79.3879"></a><span id="l79.3879" class="difflineminus">-  {</span>
<a href="#l79.3880"></a><span id="l79.3880" class="difflineminus">-    nsresult rv = rowCursor-&gt;NextRow(m_mdbEnv, getter_AddRefs(currentRow), &amp;rowPos);</span>
<a href="#l79.3881"></a><span id="l79.3881" class="difflineminus">-    if (currentRow &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l79.3882"></a><span id="l79.3882" class="difflineminus">-    {</span>
<a href="#l79.3883"></a><span id="l79.3883" class="difflineplus">+  if (!rowCursor) return NS_ERROR_FAILURE;</span>
<a href="#l79.3884"></a><span id="l79.3884" class="difflineplus">+</span>
<a href="#l79.3885"></a><span id="l79.3885" class="difflineplus">+  while (!done) {</span>
<a href="#l79.3886"></a><span id="l79.3886" class="difflineplus">+    nsresult rv =</span>
<a href="#l79.3887"></a><span id="l79.3887" class="difflineplus">+        rowCursor-&gt;NextRow(m_mdbEnv, getter_AddRefs(currentRow), &amp;rowPos);</span>
<a href="#l79.3888"></a><span id="l79.3888" class="difflineplus">+    if (currentRow &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l79.3889"></a><span id="l79.3889">       mdbOid rowOid;</span>
<a href="#l79.3890"></a><span id="l79.3890" class="difflineminus">-      if (NS_SUCCEEDED(currentRow-&gt;GetOid(m_mdbEnv, &amp;rowOid)) &amp;&amp; (rowOid.mOid_Scope == targetScope))</span>
<a href="#l79.3891"></a><span id="l79.3891" class="difflineminus">-      {</span>
<a href="#l79.3892"></a><span id="l79.3892" class="difflineplus">+      if (NS_SUCCEEDED(currentRow-&gt;GetOid(m_mdbEnv, &amp;rowOid)) &amp;&amp;</span>
<a href="#l79.3893"></a><span id="l79.3893" class="difflineplus">+          (rowOid.mOid_Scope == targetScope)) {</span>
<a href="#l79.3894"></a><span id="l79.3894">         rv = GetStringColumn(currentRow, findColumn, columnValue);</span>
<a href="#l79.3895"></a><span id="l79.3895"> </span>
<a href="#l79.3896"></a><span id="l79.3896" class="difflineminus">-        bool equals = aCaseInsensitive ?</span>
<a href="#l79.3897"></a><span id="l79.3897" class="difflineminus">-          columnValue.Equals(unicodeStr, nsCaseInsensitiveStringComparator()) :</span>
<a href="#l79.3898"></a><span id="l79.3898" class="difflineminus">-          columnValue.Equals(unicodeStr);</span>
<a href="#l79.3899"></a><span id="l79.3899" class="difflineminus">-</span>
<a href="#l79.3900"></a><span id="l79.3900" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; equals)</span>
<a href="#l79.3901"></a><span id="l79.3901" class="difflineminus">-        {</span>
<a href="#l79.3902"></a><span id="l79.3902" class="difflineplus">+        bool equals = aCaseInsensitive</span>
<a href="#l79.3903"></a><span id="l79.3903" class="difflineplus">+                          ? columnValue.Equals(</span>
<a href="#l79.3904"></a><span id="l79.3904" class="difflineplus">+                                unicodeStr, nsCaseInsensitiveStringComparator())</span>
<a href="#l79.3905"></a><span id="l79.3905" class="difflineplus">+                          : columnValue.Equals(unicodeStr);</span>
<a href="#l79.3906"></a><span id="l79.3906" class="difflineplus">+</span>
<a href="#l79.3907"></a><span id="l79.3907" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; equals) {</span>
<a href="#l79.3908"></a><span id="l79.3908">           currentRow.forget(aFindRow);</span>
<a href="#l79.3909"></a><span id="l79.3909" class="difflineminus">-          if (aRowPos)</span>
<a href="#l79.3910"></a><span id="l79.3910" class="difflineminus">-            *aRowPos = rowPos;</span>
<a href="#l79.3911"></a><span id="l79.3911" class="difflineplus">+          if (aRowPos) *aRowPos = rowPos;</span>
<a href="#l79.3912"></a><span id="l79.3912">           return NS_OK;</span>
<a href="#l79.3913"></a><span id="l79.3913">         }</span>
<a href="#l79.3914"></a><span id="l79.3914">       }</span>
<a href="#l79.3915"></a><span id="l79.3915" class="difflineminus">-    }</span>
<a href="#l79.3916"></a><span id="l79.3916" class="difflineminus">-    else</span>
<a href="#l79.3917"></a><span id="l79.3917" class="difflineplus">+    } else</span>
<a href="#l79.3918"></a><span id="l79.3918">       done = true;</span>
<a href="#l79.3919"></a><span id="l79.3919">   }</span>
<a href="#l79.3920"></a><span id="l79.3920">   return NS_ERROR_FAILURE;</span>
<a href="#l79.3921"></a><span id="l79.3921"> }</span>
<a href="#l79.3922"></a><span id="l79.3922"> </span>
<a href="#l79.3923"></a><span id="l79.3923" class="difflineminus">-nsresult nsAddrDatabase::DeleteRow(nsIMdbTable* dbTable, nsIMdbRow* dbRow)</span>
<a href="#l79.3924"></a><span id="l79.3924" class="difflineminus">-{</span>
<a href="#l79.3925"></a><span id="l79.3925" class="difflineminus">-  if (!m_mdbEnv)</span>
<a href="#l79.3926"></a><span id="l79.3926" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3927"></a><span id="l79.3927" class="difflineplus">+nsresult nsAddrDatabase::DeleteRow(nsIMdbTable *dbTable, nsIMdbRow *dbRow) {</span>
<a href="#l79.3928"></a><span id="l79.3928" class="difflineplus">+  if (!m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.3929"></a><span id="l79.3929"> </span>
<a href="#l79.3930"></a><span id="l79.3930">   nsresult err = dbRow-&gt;CutAllColumns(m_mdbEnv);</span>
<a href="#l79.3931"></a><span id="l79.3931">   err = dbTable-&gt;CutRow(m_mdbEnv, dbRow);</span>
<a href="#l79.3932"></a><span id="l79.3932"> </span>
<a href="#l79.3933"></a><span id="l79.3933">   return (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l79.3934"></a><span id="l79.3934"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.h</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.h</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -11,427 +11,523 @@</span>
<a href="#l80.4"></a><span id="l80.4"> #include &quot;nsIFile.h&quot;</span>
<a href="#l80.5"></a><span id="l80.5"> #include &quot;mdb.h&quot;</span>
<a href="#l80.6"></a><span id="l80.6"> #include &quot;nsString.h&quot;</span>
<a href="#l80.7"></a><span id="l80.7"> #include &quot;nsIAddrDBListener.h&quot;</span>
<a href="#l80.8"></a><span id="l80.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l80.9"></a><span id="l80.9"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l80.10"></a><span id="l80.10"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-typedef enum</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineminus">-{</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineplus">+typedef enum {</span>
<a href="#l80.15"></a><span id="l80.15">   AB_NotifyInserted,</span>
<a href="#l80.16"></a><span id="l80.16">   AB_NotifyDeleted,</span>
<a href="#l80.17"></a><span id="l80.17">   AB_NotifyPropertyChanged</span>
<a href="#l80.18"></a><span id="l80.18"> } AB_NOTIFY_CODE;</span>
<a href="#l80.19"></a><span id="l80.19"> </span>
<a href="#l80.20"></a><span id="l80.20" class="difflineminus">-class nsAddrDatabase : public nsIAddrDatabase</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineminus">-{</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineplus">+class nsAddrDatabase : public nsIAddrDatabase {</span>
<a href="#l80.23"></a><span id="l80.23">   using PathString = mozilla::PathString;</span>
<a href="#l80.24"></a><span id="l80.24" class="difflineminus">-public:</span>
<a href="#l80.25"></a><span id="l80.25" class="difflineplus">+</span>
<a href="#l80.26"></a><span id="l80.26" class="difflineplus">+ public:</span>
<a href="#l80.27"></a><span id="l80.27">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l80.28"></a><span id="l80.28">   NS_DECL_NSIADDRDBANNOUNCER</span>
<a href="#l80.29"></a><span id="l80.29">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l80.30"></a><span id="l80.30">   // nsIAddrDatabase methods:</span>
<a href="#l80.31"></a><span id="l80.31"> </span>
<a href="#l80.32"></a><span id="l80.32" class="difflineminus">-  NS_IMETHOD GetDbPath(nsIFile * *aDbPath) override;</span>
<a href="#l80.33"></a><span id="l80.33" class="difflineminus">-  NS_IMETHOD SetDbPath(nsIFile * aDbPath) override;</span>
<a href="#l80.34"></a><span id="l80.34" class="difflineminus">-  NS_IMETHOD Open(nsIFile *aMabFile, bool aCreate, bool upgrading, nsIAddrDatabase **pCardDB) override;</span>
<a href="#l80.35"></a><span id="l80.35" class="difflineplus">+  NS_IMETHOD GetDbPath(nsIFile **aDbPath) override;</span>
<a href="#l80.36"></a><span id="l80.36" class="difflineplus">+  NS_IMETHOD SetDbPath(nsIFile *aDbPath) override;</span>
<a href="#l80.37"></a><span id="l80.37" class="difflineplus">+  NS_IMETHOD Open(nsIFile *aMabFile, bool aCreate, bool upgrading,</span>
<a href="#l80.38"></a><span id="l80.38" class="difflineplus">+                  nsIAddrDatabase **pCardDB) override;</span>
<a href="#l80.39"></a><span id="l80.39">   NS_IMETHOD Close(bool forceCommit) override;</span>
<a href="#l80.40"></a><span id="l80.40">   NS_IMETHOD OpenMDB(nsIFile *dbName, bool create) override;</span>
<a href="#l80.41"></a><span id="l80.41">   NS_IMETHOD CloseMDB(bool commit) override;</span>
<a href="#l80.42"></a><span id="l80.42">   NS_IMETHOD Commit(uint32_t commitType) override;</span>
<a href="#l80.43"></a><span id="l80.43">   NS_IMETHOD ForceClosed() override;</span>
<a href="#l80.44"></a><span id="l80.44"> </span>
<a href="#l80.45"></a><span id="l80.45" class="difflineminus">-  NS_IMETHOD CreateNewCardAndAddToDB(nsIAbCard *newCard, bool notify, nsIAbDirectory *parent) override;</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineminus">-  NS_IMETHOD CreateNewListCardAndAddToDB(nsIAbDirectory *list, uint32_t listRowID, nsIAbCard *newCard, bool notify) override;</span>
<a href="#l80.47"></a><span id="l80.47" class="difflineminus">-  NS_IMETHOD CreateMailListAndAddToDB(nsIAbDirectory *newList, bool notify, nsIAbDirectory *parent) override;</span>
<a href="#l80.48"></a><span id="l80.48" class="difflineminus">-  NS_IMETHOD EnumerateCards(nsIAbDirectory *directory, nsISimpleEnumerator **result) override;</span>
<a href="#l80.49"></a><span id="l80.49" class="difflineplus">+  NS_IMETHOD CreateNewCardAndAddToDB(nsIAbCard *newCard, bool notify,</span>
<a href="#l80.50"></a><span id="l80.50" class="difflineplus">+                                     nsIAbDirectory *parent) override;</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineplus">+  NS_IMETHOD CreateNewListCardAndAddToDB(nsIAbDirectory *list,</span>
<a href="#l80.52"></a><span id="l80.52" class="difflineplus">+                                         uint32_t listRowID, nsIAbCard *newCard,</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineplus">+                                         bool notify) override;</span>
<a href="#l80.54"></a><span id="l80.54" class="difflineplus">+  NS_IMETHOD CreateMailListAndAddToDB(nsIAbDirectory *newList, bool notify,</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineplus">+                                      nsIAbDirectory *parent) override;</span>
<a href="#l80.56"></a><span id="l80.56" class="difflineplus">+  NS_IMETHOD EnumerateCards(nsIAbDirectory *directory,</span>
<a href="#l80.57"></a><span id="l80.57" class="difflineplus">+                            nsISimpleEnumerator **result) override;</span>
<a href="#l80.58"></a><span id="l80.58">   NS_IMETHOD GetMailingListsFromDB(nsIAbDirectory *parentDir) override;</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineminus">-  NS_IMETHOD EnumerateListAddresses(nsIAbDirectory *directory, nsISimpleEnumerator **result) override;</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineminus">-  NS_IMETHOD DeleteCard(nsIAbCard *newCard, bool notify, nsIAbDirectory *parent) override;</span>
<a href="#l80.61"></a><span id="l80.61" class="difflineminus">-  NS_IMETHOD EditCard(nsIAbCard *card, bool notify, nsIAbDirectory *parent) override;</span>
<a href="#l80.62"></a><span id="l80.62" class="difflineplus">+  NS_IMETHOD EnumerateListAddresses(nsIAbDirectory *directory,</span>
<a href="#l80.63"></a><span id="l80.63" class="difflineplus">+                                    nsISimpleEnumerator **result) override;</span>
<a href="#l80.64"></a><span id="l80.64" class="difflineplus">+  NS_IMETHOD DeleteCard(nsIAbCard *newCard, bool notify,</span>
<a href="#l80.65"></a><span id="l80.65" class="difflineplus">+                        nsIAbDirectory *parent) override;</span>
<a href="#l80.66"></a><span id="l80.66" class="difflineplus">+  NS_IMETHOD EditCard(nsIAbCard *card, bool notify,</span>
<a href="#l80.67"></a><span id="l80.67" class="difflineplus">+                      nsIAbDirectory *parent) override;</span>
<a href="#l80.68"></a><span id="l80.68">   NS_IMETHOD ContainsCard(nsIAbCard *card, bool *hasCard) override;</span>
<a href="#l80.69"></a><span id="l80.69" class="difflineminus">-  NS_IMETHOD DeleteMailList(nsIAbDirectory *aMailList, nsIAbDirectory *aParent) override;</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineminus">-  NS_IMETHOD EditMailList(nsIAbDirectory *mailList, nsIAbCard *listCard, bool notify) override;</span>
<a href="#l80.71"></a><span id="l80.71" class="difflineplus">+  NS_IMETHOD DeleteMailList(nsIAbDirectory *aMailList,</span>
<a href="#l80.72"></a><span id="l80.72" class="difflineplus">+                            nsIAbDirectory *aParent) override;</span>
<a href="#l80.73"></a><span id="l80.73" class="difflineplus">+  NS_IMETHOD EditMailList(nsIAbDirectory *mailList, nsIAbCard *listCard,</span>
<a href="#l80.74"></a><span id="l80.74" class="difflineplus">+                          bool notify) override;</span>
<a href="#l80.75"></a><span id="l80.75">   NS_IMETHOD ContainsMailList(nsIAbDirectory *mailList, bool *hasCard) override;</span>
<a href="#l80.76"></a><span id="l80.76" class="difflineminus">-  NS_IMETHOD DeleteCardFromMailList(nsIAbDirectory *mailList, nsIAbCard *card, bool aNotify) override;</span>
<a href="#l80.77"></a><span id="l80.77" class="difflineplus">+  NS_IMETHOD DeleteCardFromMailList(nsIAbDirectory *mailList, nsIAbCard *card,</span>
<a href="#l80.78"></a><span id="l80.78" class="difflineplus">+                                    bool aNotify) override;</span>
<a href="#l80.79"></a><span id="l80.79">   NS_IMETHOD GetCardFromAttribute(nsIAbDirectory *aDirectory, const char *aName,</span>
<a href="#l80.80"></a><span id="l80.80">                                   const nsACString &amp;aValue,</span>
<a href="#l80.81"></a><span id="l80.81" class="difflineminus">-                                  bool aCaseInsensitive, nsIAbCard **card) override;</span>
<a href="#l80.82"></a><span id="l80.82" class="difflineplus">+                                  bool aCaseInsensitive,</span>
<a href="#l80.83"></a><span id="l80.83" class="difflineplus">+                                  nsIAbCard **card) override;</span>
<a href="#l80.84"></a><span id="l80.84">   NS_IMETHOD GetCardsFromAttribute(nsIAbDirectory *aDirectory,</span>
<a href="#l80.85"></a><span id="l80.85">                                    const char *aName,</span>
<a href="#l80.86"></a><span id="l80.86" class="difflineminus">-                                   const nsACString &amp; uUTF8Value,</span>
<a href="#l80.87"></a><span id="l80.87" class="difflineplus">+                                   const nsACString &amp;uUTF8Value,</span>
<a href="#l80.88"></a><span id="l80.88">                                    bool aCaseInsensitive,</span>
<a href="#l80.89"></a><span id="l80.89">                                    nsISimpleEnumerator **cards) override;</span>
<a href="#l80.90"></a><span id="l80.90" class="difflineminus">-  NS_IMETHOD GetNewRow(nsIMdbRow * *newRow) override;</span>
<a href="#l80.91"></a><span id="l80.91" class="difflineminus">-  NS_IMETHOD GetNewListRow(nsIMdbRow * *newRow) override;</span>
<a href="#l80.92"></a><span id="l80.92" class="difflineplus">+  NS_IMETHOD GetNewRow(nsIMdbRow **newRow) override;</span>
<a href="#l80.93"></a><span id="l80.93" class="difflineplus">+  NS_IMETHOD GetNewListRow(nsIMdbRow **newRow) override;</span>
<a href="#l80.94"></a><span id="l80.94">   NS_IMETHOD AddCardRowToDB(nsIMdbRow *newRow) override;</span>
<a href="#l80.95"></a><span id="l80.95" class="difflineminus">-  NS_IMETHOD AddLdifListMember(nsIMdbRow* row, const char * value) override;</span>
<a href="#l80.96"></a><span id="l80.96" class="difflineplus">+  NS_IMETHOD AddLdifListMember(nsIMdbRow *row, const char *value) override;</span>
<a href="#l80.97"></a><span id="l80.97"> </span>
<a href="#l80.98"></a><span id="l80.98" class="difflineminus">-  NS_IMETHOD AddUID(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.99"></a><span id="l80.99" class="difflineminus">-  { return AddCharStringColumn(row, m_UIDColumnToken, value); }</span>
<a href="#l80.100"></a><span id="l80.100" class="difflineplus">+  NS_IMETHOD AddUID(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.101"></a><span id="l80.101" class="difflineplus">+    return AddCharStringColumn(row, m_UIDColumnToken, value);</span>
<a href="#l80.102"></a><span id="l80.102" class="difflineplus">+  }</span>
<a href="#l80.103"></a><span id="l80.103"> </span>
<a href="#l80.104"></a><span id="l80.104" class="difflineminus">-  NS_IMETHOD AddFirstName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.105"></a><span id="l80.105" class="difflineminus">-  { return AddCharStringColumn(row, m_FirstNameColumnToken, value); }</span>
<a href="#l80.106"></a><span id="l80.106" class="difflineplus">+  NS_IMETHOD AddFirstName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.107"></a><span id="l80.107" class="difflineplus">+    return AddCharStringColumn(row, m_FirstNameColumnToken, value);</span>
<a href="#l80.108"></a><span id="l80.108" class="difflineplus">+  }</span>
<a href="#l80.109"></a><span id="l80.109"> </span>
<a href="#l80.110"></a><span id="l80.110" class="difflineminus">-  NS_IMETHOD AddLastName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.111"></a><span id="l80.111" class="difflineminus">-  { return AddCharStringColumn(row, m_LastNameColumnToken, value); }</span>
<a href="#l80.112"></a><span id="l80.112" class="difflineplus">+  NS_IMETHOD AddLastName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.113"></a><span id="l80.113" class="difflineplus">+    return AddCharStringColumn(row, m_LastNameColumnToken, value);</span>
<a href="#l80.114"></a><span id="l80.114" class="difflineplus">+  }</span>
<a href="#l80.115"></a><span id="l80.115"> </span>
<a href="#l80.116"></a><span id="l80.116" class="difflineminus">-  NS_IMETHOD AddPhoneticFirstName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.117"></a><span id="l80.117" class="difflineminus">-  { return AddCharStringColumn(row, m_PhoneticFirstNameColumnToken, value); }</span>
<a href="#l80.118"></a><span id="l80.118" class="difflineplus">+  NS_IMETHOD AddPhoneticFirstName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.119"></a><span id="l80.119" class="difflineplus">+    return AddCharStringColumn(row, m_PhoneticFirstNameColumnToken, value);</span>
<a href="#l80.120"></a><span id="l80.120" class="difflineplus">+  }</span>
<a href="#l80.121"></a><span id="l80.121"> </span>
<a href="#l80.122"></a><span id="l80.122" class="difflineminus">-  NS_IMETHOD AddPhoneticLastName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.123"></a><span id="l80.123" class="difflineminus">-  { return AddCharStringColumn(row, m_PhoneticLastNameColumnToken, value); }</span>
<a href="#l80.124"></a><span id="l80.124" class="difflineplus">+  NS_IMETHOD AddPhoneticLastName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.125"></a><span id="l80.125" class="difflineplus">+    return AddCharStringColumn(row, m_PhoneticLastNameColumnToken, value);</span>
<a href="#l80.126"></a><span id="l80.126" class="difflineplus">+  }</span>
<a href="#l80.127"></a><span id="l80.127"> </span>
<a href="#l80.128"></a><span id="l80.128" class="difflineminus">-  NS_IMETHOD AddDisplayName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.129"></a><span id="l80.129" class="difflineminus">-  { return AddCharStringColumn(row, m_DisplayNameColumnToken, value); }</span>
<a href="#l80.130"></a><span id="l80.130" class="difflineplus">+  NS_IMETHOD AddDisplayName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.131"></a><span id="l80.131" class="difflineplus">+    return AddCharStringColumn(row, m_DisplayNameColumnToken, value);</span>
<a href="#l80.132"></a><span id="l80.132" class="difflineplus">+  }</span>
<a href="#l80.133"></a><span id="l80.133"> </span>
<a href="#l80.134"></a><span id="l80.134" class="difflineminus">-  NS_IMETHOD AddNickName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.135"></a><span id="l80.135" class="difflineminus">-  { return AddCharStringColumn(row, m_NickNameColumnToken, value); }</span>
<a href="#l80.136"></a><span id="l80.136" class="difflineplus">+  NS_IMETHOD AddNickName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.137"></a><span id="l80.137" class="difflineplus">+    return AddCharStringColumn(row, m_NickNameColumnToken, value);</span>
<a href="#l80.138"></a><span id="l80.138" class="difflineplus">+  }</span>
<a href="#l80.139"></a><span id="l80.139"> </span>
<a href="#l80.140"></a><span id="l80.140" class="difflineminus">-  NS_IMETHOD AddPrimaryEmail(nsIMdbRow * row, const char * value) override;</span>
<a href="#l80.141"></a><span id="l80.141" class="difflineplus">+  NS_IMETHOD AddPrimaryEmail(nsIMdbRow *row, const char *value) override;</span>
<a href="#l80.142"></a><span id="l80.142"> </span>
<a href="#l80.143"></a><span id="l80.143" class="difflineminus">-  NS_IMETHOD Add2ndEmail(nsIMdbRow * row, const char * value) override;</span>
<a href="#l80.144"></a><span id="l80.144" class="difflineplus">+  NS_IMETHOD Add2ndEmail(nsIMdbRow *row, const char *value) override;</span>
<a href="#l80.145"></a><span id="l80.145"> </span>
<a href="#l80.146"></a><span id="l80.146" class="difflineminus">-  NS_IMETHOD AddPreferMailFormat(nsIMdbRow * row, uint32_t value) override</span>
<a href="#l80.147"></a><span id="l80.147" class="difflineminus">-  { return AddIntColumn(row, m_MailFormatColumnToken, value); }</span>
<a href="#l80.148"></a><span id="l80.148" class="difflineplus">+  NS_IMETHOD AddPreferMailFormat(nsIMdbRow *row, uint32_t value) override {</span>
<a href="#l80.149"></a><span id="l80.149" class="difflineplus">+    return AddIntColumn(row, m_MailFormatColumnToken, value);</span>
<a href="#l80.150"></a><span id="l80.150" class="difflineplus">+  }</span>
<a href="#l80.151"></a><span id="l80.151"> </span>
<a href="#l80.152"></a><span id="l80.152" class="difflineminus">-  NS_IMETHOD AddPopularityIndex(nsIMdbRow * row, uint32_t value) override</span>
<a href="#l80.153"></a><span id="l80.153" class="difflineminus">-  { return AddIntColumn(row, m_PopularityIndexColumnToken, value); }</span>
<a href="#l80.154"></a><span id="l80.154" class="difflineplus">+  NS_IMETHOD AddPopularityIndex(nsIMdbRow *row, uint32_t value) override {</span>
<a href="#l80.155"></a><span id="l80.155" class="difflineplus">+    return AddIntColumn(row, m_PopularityIndexColumnToken, value);</span>
<a href="#l80.156"></a><span id="l80.156" class="difflineplus">+  }</span>
<a href="#l80.157"></a><span id="l80.157"> </span>
<a href="#l80.158"></a><span id="l80.158" class="difflineminus">-  NS_IMETHOD AddWorkPhone(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.159"></a><span id="l80.159" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkPhoneColumnToken, value); }</span>
<a href="#l80.160"></a><span id="l80.160" class="difflineplus">+  NS_IMETHOD AddWorkPhone(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.161"></a><span id="l80.161" class="difflineplus">+    return AddCharStringColumn(row, m_WorkPhoneColumnToken, value);</span>
<a href="#l80.162"></a><span id="l80.162" class="difflineplus">+  }</span>
<a href="#l80.163"></a><span id="l80.163"> </span>
<a href="#l80.164"></a><span id="l80.164" class="difflineminus">-  NS_IMETHOD AddHomePhone(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.165"></a><span id="l80.165" class="difflineminus">-  { return AddCharStringColumn(row, m_HomePhoneColumnToken, value); }</span>
<a href="#l80.166"></a><span id="l80.166" class="difflineplus">+  NS_IMETHOD AddHomePhone(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.167"></a><span id="l80.167" class="difflineplus">+    return AddCharStringColumn(row, m_HomePhoneColumnToken, value);</span>
<a href="#l80.168"></a><span id="l80.168" class="difflineplus">+  }</span>
<a href="#l80.169"></a><span id="l80.169"> </span>
<a href="#l80.170"></a><span id="l80.170" class="difflineminus">-  NS_IMETHOD AddFaxNumber(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.171"></a><span id="l80.171" class="difflineminus">-  { return AddCharStringColumn(row, m_FaxColumnToken, value); }</span>
<a href="#l80.172"></a><span id="l80.172" class="difflineplus">+  NS_IMETHOD AddFaxNumber(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.173"></a><span id="l80.173" class="difflineplus">+    return AddCharStringColumn(row, m_FaxColumnToken, value);</span>
<a href="#l80.174"></a><span id="l80.174" class="difflineplus">+  }</span>
<a href="#l80.175"></a><span id="l80.175"> </span>
<a href="#l80.176"></a><span id="l80.176" class="difflineminus">-  NS_IMETHOD AddPagerNumber(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.177"></a><span id="l80.177" class="difflineminus">-  { return AddCharStringColumn(row, m_PagerColumnToken, value); }</span>
<a href="#l80.178"></a><span id="l80.178" class="difflineplus">+  NS_IMETHOD AddPagerNumber(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.179"></a><span id="l80.179" class="difflineplus">+    return AddCharStringColumn(row, m_PagerColumnToken, value);</span>
<a href="#l80.180"></a><span id="l80.180" class="difflineplus">+  }</span>
<a href="#l80.181"></a><span id="l80.181"> </span>
<a href="#l80.182"></a><span id="l80.182" class="difflineminus">-  NS_IMETHOD AddCellularNumber(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.183"></a><span id="l80.183" class="difflineminus">-  { return AddCharStringColumn(row, m_CellularColumnToken, value); }</span>
<a href="#l80.184"></a><span id="l80.184" class="difflineplus">+  NS_IMETHOD AddCellularNumber(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.185"></a><span id="l80.185" class="difflineplus">+    return AddCharStringColumn(row, m_CellularColumnToken, value);</span>
<a href="#l80.186"></a><span id="l80.186" class="difflineplus">+  }</span>
<a href="#l80.187"></a><span id="l80.187"> </span>
<a href="#l80.188"></a><span id="l80.188" class="difflineminus">-  NS_IMETHOD AddWorkPhoneType(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.189"></a><span id="l80.189" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkPhoneTypeColumnToken, value); }</span>
<a href="#l80.190"></a><span id="l80.190" class="difflineplus">+  NS_IMETHOD AddWorkPhoneType(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.191"></a><span id="l80.191" class="difflineplus">+    return AddCharStringColumn(row, m_WorkPhoneTypeColumnToken, value);</span>
<a href="#l80.192"></a><span id="l80.192" class="difflineplus">+  }</span>
<a href="#l80.193"></a><span id="l80.193"> </span>
<a href="#l80.194"></a><span id="l80.194" class="difflineminus">-  NS_IMETHOD AddHomePhoneType(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.195"></a><span id="l80.195" class="difflineminus">-  { return AddCharStringColumn(row, m_HomePhoneTypeColumnToken, value); }</span>
<a href="#l80.196"></a><span id="l80.196" class="difflineplus">+  NS_IMETHOD AddHomePhoneType(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.197"></a><span id="l80.197" class="difflineplus">+    return AddCharStringColumn(row, m_HomePhoneTypeColumnToken, value);</span>
<a href="#l80.198"></a><span id="l80.198" class="difflineplus">+  }</span>
<a href="#l80.199"></a><span id="l80.199"> </span>
<a href="#l80.200"></a><span id="l80.200" class="difflineminus">-  NS_IMETHOD AddFaxNumberType(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.201"></a><span id="l80.201" class="difflineminus">-  { return AddCharStringColumn(row, m_FaxTypeColumnToken, value); }</span>
<a href="#l80.202"></a><span id="l80.202" class="difflineplus">+  NS_IMETHOD AddFaxNumberType(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.203"></a><span id="l80.203" class="difflineplus">+    return AddCharStringColumn(row, m_FaxTypeColumnToken, value);</span>
<a href="#l80.204"></a><span id="l80.204" class="difflineplus">+  }</span>
<a href="#l80.205"></a><span id="l80.205"> </span>
<a href="#l80.206"></a><span id="l80.206" class="difflineminus">-  NS_IMETHOD AddPagerNumberType(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.207"></a><span id="l80.207" class="difflineminus">-  { return AddCharStringColumn(row, m_PagerTypeColumnToken, value); }</span>
<a href="#l80.208"></a><span id="l80.208" class="difflineplus">+  NS_IMETHOD AddPagerNumberType(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.209"></a><span id="l80.209" class="difflineplus">+    return AddCharStringColumn(row, m_PagerTypeColumnToken, value);</span>
<a href="#l80.210"></a><span id="l80.210" class="difflineplus">+  }</span>
<a href="#l80.211"></a><span id="l80.211"> </span>
<a href="#l80.212"></a><span id="l80.212" class="difflineminus">-  NS_IMETHOD AddCellularNumberType(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.213"></a><span id="l80.213" class="difflineminus">-  { return AddCharStringColumn(row, m_CellularTypeColumnToken, value); }</span>
<a href="#l80.214"></a><span id="l80.214" class="difflineplus">+  NS_IMETHOD AddCellularNumberType(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.215"></a><span id="l80.215" class="difflineplus">+    return AddCharStringColumn(row, m_CellularTypeColumnToken, value);</span>
<a href="#l80.216"></a><span id="l80.216" class="difflineplus">+  }</span>
<a href="#l80.217"></a><span id="l80.217"> </span>
<a href="#l80.218"></a><span id="l80.218" class="difflineminus">-  NS_IMETHOD AddHomeAddress(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.219"></a><span id="l80.219" class="difflineminus">-  { return AddCharStringColumn(row, m_HomeAddressColumnToken, value); }</span>
<a href="#l80.220"></a><span id="l80.220" class="difflineplus">+  NS_IMETHOD AddHomeAddress(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.221"></a><span id="l80.221" class="difflineplus">+    return AddCharStringColumn(row, m_HomeAddressColumnToken, value);</span>
<a href="#l80.222"></a><span id="l80.222" class="difflineplus">+  }</span>
<a href="#l80.223"></a><span id="l80.223"> </span>
<a href="#l80.224"></a><span id="l80.224" class="difflineminus">-  NS_IMETHOD AddHomeAddress2(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.225"></a><span id="l80.225" class="difflineminus">-  { return AddCharStringColumn(row, m_HomeAddress2ColumnToken, value); }</span>
<a href="#l80.226"></a><span id="l80.226" class="difflineplus">+  NS_IMETHOD AddHomeAddress2(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.227"></a><span id="l80.227" class="difflineplus">+    return AddCharStringColumn(row, m_HomeAddress2ColumnToken, value);</span>
<a href="#l80.228"></a><span id="l80.228" class="difflineplus">+  }</span>
<a href="#l80.229"></a><span id="l80.229"> </span>
<a href="#l80.230"></a><span id="l80.230" class="difflineminus">-  NS_IMETHOD AddHomeCity(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.231"></a><span id="l80.231" class="difflineminus">-  { return AddCharStringColumn(row, m_HomeCityColumnToken, value); }</span>
<a href="#l80.232"></a><span id="l80.232" class="difflineplus">+  NS_IMETHOD AddHomeCity(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.233"></a><span id="l80.233" class="difflineplus">+    return AddCharStringColumn(row, m_HomeCityColumnToken, value);</span>
<a href="#l80.234"></a><span id="l80.234" class="difflineplus">+  }</span>
<a href="#l80.235"></a><span id="l80.235"> </span>
<a href="#l80.236"></a><span id="l80.236" class="difflineminus">-  NS_IMETHOD AddHomeState(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.237"></a><span id="l80.237" class="difflineminus">-  { return AddCharStringColumn(row, m_HomeStateColumnToken, value); }</span>
<a href="#l80.238"></a><span id="l80.238" class="difflineplus">+  NS_IMETHOD AddHomeState(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.239"></a><span id="l80.239" class="difflineplus">+    return AddCharStringColumn(row, m_HomeStateColumnToken, value);</span>
<a href="#l80.240"></a><span id="l80.240" class="difflineplus">+  }</span>
<a href="#l80.241"></a><span id="l80.241"> </span>
<a href="#l80.242"></a><span id="l80.242" class="difflineminus">-  NS_IMETHOD AddHomeZipCode(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.243"></a><span id="l80.243" class="difflineminus">-  { return AddCharStringColumn(row, m_HomeZipCodeColumnToken, value); }</span>
<a href="#l80.244"></a><span id="l80.244" class="difflineplus">+  NS_IMETHOD AddHomeZipCode(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.245"></a><span id="l80.245" class="difflineplus">+    return AddCharStringColumn(row, m_HomeZipCodeColumnToken, value);</span>
<a href="#l80.246"></a><span id="l80.246" class="difflineplus">+  }</span>
<a href="#l80.247"></a><span id="l80.247"> </span>
<a href="#l80.248"></a><span id="l80.248" class="difflineminus">-  NS_IMETHOD AddHomeCountry(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.249"></a><span id="l80.249" class="difflineminus">-  { return AddCharStringColumn(row, m_HomeCountryColumnToken, value); }</span>
<a href="#l80.250"></a><span id="l80.250" class="difflineplus">+  NS_IMETHOD AddHomeCountry(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.251"></a><span id="l80.251" class="difflineplus">+    return AddCharStringColumn(row, m_HomeCountryColumnToken, value);</span>
<a href="#l80.252"></a><span id="l80.252" class="difflineplus">+  }</span>
<a href="#l80.253"></a><span id="l80.253"> </span>
<a href="#l80.254"></a><span id="l80.254" class="difflineminus">-  NS_IMETHOD AddWorkAddress(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.255"></a><span id="l80.255" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkAddressColumnToken, value); }</span>
<a href="#l80.256"></a><span id="l80.256" class="difflineplus">+  NS_IMETHOD AddWorkAddress(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.257"></a><span id="l80.257" class="difflineplus">+    return AddCharStringColumn(row, m_WorkAddressColumnToken, value);</span>
<a href="#l80.258"></a><span id="l80.258" class="difflineplus">+  }</span>
<a href="#l80.259"></a><span id="l80.259"> </span>
<a href="#l80.260"></a><span id="l80.260" class="difflineminus">-  NS_IMETHOD AddWorkAddress2(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.261"></a><span id="l80.261" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkAddress2ColumnToken, value); }</span>
<a href="#l80.262"></a><span id="l80.262" class="difflineplus">+  NS_IMETHOD AddWorkAddress2(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.263"></a><span id="l80.263" class="difflineplus">+    return AddCharStringColumn(row, m_WorkAddress2ColumnToken, value);</span>
<a href="#l80.264"></a><span id="l80.264" class="difflineplus">+  }</span>
<a href="#l80.265"></a><span id="l80.265"> </span>
<a href="#l80.266"></a><span id="l80.266" class="difflineminus">-  NS_IMETHOD AddWorkCity(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.267"></a><span id="l80.267" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkCityColumnToken, value); }</span>
<a href="#l80.268"></a><span id="l80.268" class="difflineplus">+  NS_IMETHOD AddWorkCity(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.269"></a><span id="l80.269" class="difflineplus">+    return AddCharStringColumn(row, m_WorkCityColumnToken, value);</span>
<a href="#l80.270"></a><span id="l80.270" class="difflineplus">+  }</span>
<a href="#l80.271"></a><span id="l80.271"> </span>
<a href="#l80.272"></a><span id="l80.272" class="difflineminus">-  NS_IMETHOD AddWorkState(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.273"></a><span id="l80.273" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkStateColumnToken, value); }</span>
<a href="#l80.274"></a><span id="l80.274" class="difflineplus">+  NS_IMETHOD AddWorkState(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.275"></a><span id="l80.275" class="difflineplus">+    return AddCharStringColumn(row, m_WorkStateColumnToken, value);</span>
<a href="#l80.276"></a><span id="l80.276" class="difflineplus">+  }</span>
<a href="#l80.277"></a><span id="l80.277"> </span>
<a href="#l80.278"></a><span id="l80.278" class="difflineminus">-  NS_IMETHOD AddWorkZipCode(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.279"></a><span id="l80.279" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkZipCodeColumnToken, value); }</span>
<a href="#l80.280"></a><span id="l80.280" class="difflineplus">+  NS_IMETHOD AddWorkZipCode(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.281"></a><span id="l80.281" class="difflineplus">+    return AddCharStringColumn(row, m_WorkZipCodeColumnToken, value);</span>
<a href="#l80.282"></a><span id="l80.282" class="difflineplus">+  }</span>
<a href="#l80.283"></a><span id="l80.283"> </span>
<a href="#l80.284"></a><span id="l80.284" class="difflineminus">-  NS_IMETHOD AddWorkCountry(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.285"></a><span id="l80.285" class="difflineminus">-  { return AddCharStringColumn(row, m_WorkCountryColumnToken, value); }</span>
<a href="#l80.286"></a><span id="l80.286" class="difflineplus">+  NS_IMETHOD AddWorkCountry(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.287"></a><span id="l80.287" class="difflineplus">+    return AddCharStringColumn(row, m_WorkCountryColumnToken, value);</span>
<a href="#l80.288"></a><span id="l80.288" class="difflineplus">+  }</span>
<a href="#l80.289"></a><span id="l80.289"> </span>
<a href="#l80.290"></a><span id="l80.290" class="difflineminus">-  NS_IMETHOD AddJobTitle(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.291"></a><span id="l80.291" class="difflineminus">-  { return AddCharStringColumn(row, m_JobTitleColumnToken, value); }</span>
<a href="#l80.292"></a><span id="l80.292" class="difflineplus">+  NS_IMETHOD AddJobTitle(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.293"></a><span id="l80.293" class="difflineplus">+    return AddCharStringColumn(row, m_JobTitleColumnToken, value);</span>
<a href="#l80.294"></a><span id="l80.294" class="difflineplus">+  }</span>
<a href="#l80.295"></a><span id="l80.295"> </span>
<a href="#l80.296"></a><span id="l80.296" class="difflineminus">-  NS_IMETHOD AddDepartment(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.297"></a><span id="l80.297" class="difflineminus">-  { return AddCharStringColumn(row, m_DepartmentColumnToken, value); }</span>
<a href="#l80.298"></a><span id="l80.298" class="difflineplus">+  NS_IMETHOD AddDepartment(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.299"></a><span id="l80.299" class="difflineplus">+    return AddCharStringColumn(row, m_DepartmentColumnToken, value);</span>
<a href="#l80.300"></a><span id="l80.300" class="difflineplus">+  }</span>
<a href="#l80.301"></a><span id="l80.301"> </span>
<a href="#l80.302"></a><span id="l80.302" class="difflineminus">-  NS_IMETHOD AddCompany(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.303"></a><span id="l80.303" class="difflineminus">-  { return AddCharStringColumn(row, m_CompanyColumnToken, value); }</span>
<a href="#l80.304"></a><span id="l80.304" class="difflineminus">-</span>
<a href="#l80.305"></a><span id="l80.305" class="difflineminus">-  NS_IMETHOD AddAimScreenName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.306"></a><span id="l80.306" class="difflineminus">-  { return AddCharStringColumn(row, m_AimScreenNameColumnToken, value); }</span>
<a href="#l80.307"></a><span id="l80.307" class="difflineplus">+  NS_IMETHOD AddCompany(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.308"></a><span id="l80.308" class="difflineplus">+    return AddCharStringColumn(row, m_CompanyColumnToken, value);</span>
<a href="#l80.309"></a><span id="l80.309" class="difflineplus">+  }</span>
<a href="#l80.310"></a><span id="l80.310"> </span>
<a href="#l80.311"></a><span id="l80.311" class="difflineminus">-  NS_IMETHOD AddAnniversaryYear(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.312"></a><span id="l80.312" class="difflineminus">-  { return AddCharStringColumn(row, m_AnniversaryYearColumnToken, value); }</span>
<a href="#l80.313"></a><span id="l80.313" class="difflineplus">+  NS_IMETHOD AddAimScreenName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.314"></a><span id="l80.314" class="difflineplus">+    return AddCharStringColumn(row, m_AimScreenNameColumnToken, value);</span>
<a href="#l80.315"></a><span id="l80.315" class="difflineplus">+  }</span>
<a href="#l80.316"></a><span id="l80.316"> </span>
<a href="#l80.317"></a><span id="l80.317" class="difflineminus">-  NS_IMETHOD AddAnniversaryMonth(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.318"></a><span id="l80.318" class="difflineminus">-  { return AddCharStringColumn(row, m_AnniversaryMonthColumnToken, value); }</span>
<a href="#l80.319"></a><span id="l80.319" class="difflineplus">+  NS_IMETHOD AddAnniversaryYear(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.320"></a><span id="l80.320" class="difflineplus">+    return AddCharStringColumn(row, m_AnniversaryYearColumnToken, value);</span>
<a href="#l80.321"></a><span id="l80.321" class="difflineplus">+  }</span>
<a href="#l80.322"></a><span id="l80.322"> </span>
<a href="#l80.323"></a><span id="l80.323" class="difflineminus">-  NS_IMETHOD AddAnniversaryDay(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.324"></a><span id="l80.324" class="difflineminus">-  { return AddCharStringColumn(row, m_AnniversaryDayColumnToken, value); }</span>
<a href="#l80.325"></a><span id="l80.325" class="difflineplus">+  NS_IMETHOD AddAnniversaryMonth(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.326"></a><span id="l80.326" class="difflineplus">+    return AddCharStringColumn(row, m_AnniversaryMonthColumnToken, value);</span>
<a href="#l80.327"></a><span id="l80.327" class="difflineplus">+  }</span>
<a href="#l80.328"></a><span id="l80.328"> </span>
<a href="#l80.329"></a><span id="l80.329" class="difflineminus">-  NS_IMETHOD AddSpouseName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.330"></a><span id="l80.330" class="difflineminus">-  { return AddCharStringColumn(row, m_SpouseNameColumnToken, value); }</span>
<a href="#l80.331"></a><span id="l80.331" class="difflineplus">+  NS_IMETHOD AddAnniversaryDay(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.332"></a><span id="l80.332" class="difflineplus">+    return AddCharStringColumn(row, m_AnniversaryDayColumnToken, value);</span>
<a href="#l80.333"></a><span id="l80.333" class="difflineplus">+  }</span>
<a href="#l80.334"></a><span id="l80.334"> </span>
<a href="#l80.335"></a><span id="l80.335" class="difflineminus">-  NS_IMETHOD AddFamilyName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.336"></a><span id="l80.336" class="difflineminus">-  { return AddCharStringColumn(row, m_FamilyNameColumnToken, value); }</span>
<a href="#l80.337"></a><span id="l80.337" class="difflineplus">+  NS_IMETHOD AddSpouseName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.338"></a><span id="l80.338" class="difflineplus">+    return AddCharStringColumn(row, m_SpouseNameColumnToken, value);</span>
<a href="#l80.339"></a><span id="l80.339" class="difflineplus">+  }</span>
<a href="#l80.340"></a><span id="l80.340"> </span>
<a href="#l80.341"></a><span id="l80.341" class="difflineminus">-  NS_IMETHOD AddDefaultAddress(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.342"></a><span id="l80.342" class="difflineminus">-  { return AddCharStringColumn(row, m_DefaultAddressColumnToken, value); }</span>
<a href="#l80.343"></a><span id="l80.343" class="difflineplus">+  NS_IMETHOD AddFamilyName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.344"></a><span id="l80.344" class="difflineplus">+    return AddCharStringColumn(row, m_FamilyNameColumnToken, value);</span>
<a href="#l80.345"></a><span id="l80.345" class="difflineplus">+  }</span>
<a href="#l80.346"></a><span id="l80.346"> </span>
<a href="#l80.347"></a><span id="l80.347" class="difflineminus">-  NS_IMETHOD AddCategory(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.348"></a><span id="l80.348" class="difflineminus">-  { return AddCharStringColumn(row, m_CategoryColumnToken, value); }</span>
<a href="#l80.349"></a><span id="l80.349" class="difflineplus">+  NS_IMETHOD AddDefaultAddress(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.350"></a><span id="l80.350" class="difflineplus">+    return AddCharStringColumn(row, m_DefaultAddressColumnToken, value);</span>
<a href="#l80.351"></a><span id="l80.351" class="difflineplus">+  }</span>
<a href="#l80.352"></a><span id="l80.352"> </span>
<a href="#l80.353"></a><span id="l80.353" class="difflineminus">-  NS_IMETHOD AddWebPage1(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.354"></a><span id="l80.354" class="difflineminus">-  { return AddCharStringColumn(row, m_WebPage1ColumnToken, value); }</span>
<a href="#l80.355"></a><span id="l80.355" class="difflineplus">+  NS_IMETHOD AddCategory(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.356"></a><span id="l80.356" class="difflineplus">+    return AddCharStringColumn(row, m_CategoryColumnToken, value);</span>
<a href="#l80.357"></a><span id="l80.357" class="difflineplus">+  }</span>
<a href="#l80.358"></a><span id="l80.358"> </span>
<a href="#l80.359"></a><span id="l80.359" class="difflineminus">-  NS_IMETHOD AddWebPage2(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.360"></a><span id="l80.360" class="difflineminus">-  { return AddCharStringColumn(row, m_WebPage2ColumnToken, value); }</span>
<a href="#l80.361"></a><span id="l80.361" class="difflineplus">+  NS_IMETHOD AddWebPage1(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.362"></a><span id="l80.362" class="difflineplus">+    return AddCharStringColumn(row, m_WebPage1ColumnToken, value);</span>
<a href="#l80.363"></a><span id="l80.363" class="difflineplus">+  }</span>
<a href="#l80.364"></a><span id="l80.364"> </span>
<a href="#l80.365"></a><span id="l80.365" class="difflineminus">-  NS_IMETHOD AddBirthYear(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.366"></a><span id="l80.366" class="difflineminus">-  { return AddCharStringColumn(row, m_BirthYearColumnToken, value); }</span>
<a href="#l80.367"></a><span id="l80.367" class="difflineplus">+  NS_IMETHOD AddWebPage2(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.368"></a><span id="l80.368" class="difflineplus">+    return AddCharStringColumn(row, m_WebPage2ColumnToken, value);</span>
<a href="#l80.369"></a><span id="l80.369" class="difflineplus">+  }</span>
<a href="#l80.370"></a><span id="l80.370"> </span>
<a href="#l80.371"></a><span id="l80.371" class="difflineminus">-  NS_IMETHOD AddBirthMonth(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.372"></a><span id="l80.372" class="difflineminus">-  { return AddCharStringColumn(row, m_BirthMonthColumnToken, value); }</span>
<a href="#l80.373"></a><span id="l80.373" class="difflineplus">+  NS_IMETHOD AddBirthYear(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.374"></a><span id="l80.374" class="difflineplus">+    return AddCharStringColumn(row, m_BirthYearColumnToken, value);</span>
<a href="#l80.375"></a><span id="l80.375" class="difflineplus">+  }</span>
<a href="#l80.376"></a><span id="l80.376"> </span>
<a href="#l80.377"></a><span id="l80.377" class="difflineminus">-  NS_IMETHOD AddBirthDay(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.378"></a><span id="l80.378" class="difflineminus">-  { return AddCharStringColumn(row, m_BirthDayColumnToken, value); }</span>
<a href="#l80.379"></a><span id="l80.379" class="difflineplus">+  NS_IMETHOD AddBirthMonth(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.380"></a><span id="l80.380" class="difflineplus">+    return AddCharStringColumn(row, m_BirthMonthColumnToken, value);</span>
<a href="#l80.381"></a><span id="l80.381" class="difflineplus">+  }</span>
<a href="#l80.382"></a><span id="l80.382"> </span>
<a href="#l80.383"></a><span id="l80.383" class="difflineminus">-  NS_IMETHOD AddCustom1(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.384"></a><span id="l80.384" class="difflineminus">-  { return AddCharStringColumn(row, m_Custom1ColumnToken, value); }</span>
<a href="#l80.385"></a><span id="l80.385" class="difflineplus">+  NS_IMETHOD AddBirthDay(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.386"></a><span id="l80.386" class="difflineplus">+    return AddCharStringColumn(row, m_BirthDayColumnToken, value);</span>
<a href="#l80.387"></a><span id="l80.387" class="difflineplus">+  }</span>
<a href="#l80.388"></a><span id="l80.388"> </span>
<a href="#l80.389"></a><span id="l80.389" class="difflineminus">-  NS_IMETHOD AddCustom2(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.390"></a><span id="l80.390" class="difflineminus">-  { return AddCharStringColumn(row, m_Custom2ColumnToken, value); }</span>
<a href="#l80.391"></a><span id="l80.391" class="difflineplus">+  NS_IMETHOD AddCustom1(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.392"></a><span id="l80.392" class="difflineplus">+    return AddCharStringColumn(row, m_Custom1ColumnToken, value);</span>
<a href="#l80.393"></a><span id="l80.393" class="difflineplus">+  }</span>
<a href="#l80.394"></a><span id="l80.394"> </span>
<a href="#l80.395"></a><span id="l80.395" class="difflineminus">-  NS_IMETHOD AddCustom3(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.396"></a><span id="l80.396" class="difflineminus">-  { return AddCharStringColumn(row, m_Custom3ColumnToken, value); }</span>
<a href="#l80.397"></a><span id="l80.397" class="difflineplus">+  NS_IMETHOD AddCustom2(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.398"></a><span id="l80.398" class="difflineplus">+    return AddCharStringColumn(row, m_Custom2ColumnToken, value);</span>
<a href="#l80.399"></a><span id="l80.399" class="difflineplus">+  }</span>
<a href="#l80.400"></a><span id="l80.400"> </span>
<a href="#l80.401"></a><span id="l80.401" class="difflineminus">-  NS_IMETHOD AddCustom4(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.402"></a><span id="l80.402" class="difflineminus">-  { return AddCharStringColumn(row, m_Custom4ColumnToken, value); }</span>
<a href="#l80.403"></a><span id="l80.403" class="difflineplus">+  NS_IMETHOD AddCustom3(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.404"></a><span id="l80.404" class="difflineplus">+    return AddCharStringColumn(row, m_Custom3ColumnToken, value);</span>
<a href="#l80.405"></a><span id="l80.405" class="difflineplus">+  }</span>
<a href="#l80.406"></a><span id="l80.406"> </span>
<a href="#l80.407"></a><span id="l80.407" class="difflineminus">-  NS_IMETHOD AddNotes(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.408"></a><span id="l80.408" class="difflineminus">-  { return AddCharStringColumn(row, m_NotesColumnToken, value); }</span>
<a href="#l80.409"></a><span id="l80.409" class="difflineplus">+  NS_IMETHOD AddCustom4(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.410"></a><span id="l80.410" class="difflineplus">+    return AddCharStringColumn(row, m_Custom4ColumnToken, value);</span>
<a href="#l80.411"></a><span id="l80.411" class="difflineplus">+  }</span>
<a href="#l80.412"></a><span id="l80.412"> </span>
<a href="#l80.413"></a><span id="l80.413" class="difflineminus">-  NS_IMETHOD AddListName(nsIMdbRow * row, const char * value) override;</span>
<a href="#l80.414"></a><span id="l80.414" class="difflineplus">+  NS_IMETHOD AddNotes(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.415"></a><span id="l80.415" class="difflineplus">+    return AddCharStringColumn(row, m_NotesColumnToken, value);</span>
<a href="#l80.416"></a><span id="l80.416" class="difflineplus">+  }</span>
<a href="#l80.417"></a><span id="l80.417"> </span>
<a href="#l80.418"></a><span id="l80.418" class="difflineminus">-  NS_IMETHOD AddListNickName(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.419"></a><span id="l80.419" class="difflineminus">-  { return AddCharStringColumn(row, m_ListNickNameColumnToken, value); }</span>
<a href="#l80.420"></a><span id="l80.420" class="difflineplus">+  NS_IMETHOD AddListName(nsIMdbRow *row, const char *value) override;</span>
<a href="#l80.421"></a><span id="l80.421"> </span>
<a href="#l80.422"></a><span id="l80.422" class="difflineminus">-  NS_IMETHOD AddListDescription(nsIMdbRow * row, const char * value) override</span>
<a href="#l80.423"></a><span id="l80.423" class="difflineminus">-  { return AddCharStringColumn(row, m_ListDescriptionColumnToken, value); }</span>
<a href="#l80.424"></a><span id="l80.424" class="difflineminus">-</span>
<a href="#l80.425"></a><span id="l80.425" class="difflineplus">+  NS_IMETHOD AddListNickName(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.426"></a><span id="l80.426" class="difflineplus">+    return AddCharStringColumn(row, m_ListNickNameColumnToken, value);</span>
<a href="#l80.427"></a><span id="l80.427" class="difflineplus">+  }</span>
<a href="#l80.428"></a><span id="l80.428"> </span>
<a href="#l80.429"></a><span id="l80.429" class="difflineminus">-  NS_IMETHOD AddListDirNode(nsIMdbRow * listRow) override;</span>
<a href="#l80.430"></a><span id="l80.430" class="difflineplus">+  NS_IMETHOD AddListDescription(nsIMdbRow *row, const char *value) override {</span>
<a href="#l80.431"></a><span id="l80.431" class="difflineplus">+    return AddCharStringColumn(row, m_ListDescriptionColumnToken, value);</span>
<a href="#l80.432"></a><span id="l80.432" class="difflineplus">+  }</span>
<a href="#l80.433"></a><span id="l80.433"> </span>
<a href="#l80.434"></a><span id="l80.434" class="difflineminus">-  NS_IMETHOD FindMailListbyUnicodeName(const char16_t *listName, bool *exist) override;</span>
<a href="#l80.435"></a><span id="l80.435" class="difflineplus">+  NS_IMETHOD AddListDirNode(nsIMdbRow *listRow) override;</span>
<a href="#l80.436"></a><span id="l80.436" class="difflineplus">+</span>
<a href="#l80.437"></a><span id="l80.437" class="difflineplus">+  NS_IMETHOD FindMailListbyUnicodeName(const char16_t *listName,</span>
<a href="#l80.438"></a><span id="l80.438" class="difflineplus">+                                       bool *exist) override;</span>
<a href="#l80.439"></a><span id="l80.439"> </span>
<a href="#l80.440"></a><span id="l80.440">   NS_IMETHOD GetCardCount(uint32_t *count) override;</span>
<a href="#l80.441"></a><span id="l80.441"> </span>
<a href="#l80.442"></a><span id="l80.442" class="difflineminus">-  NS_IMETHOD SetCardValue(nsIAbCard *card, const char *name, const char16_t *value, bool notify) override;</span>
<a href="#l80.443"></a><span id="l80.443" class="difflineminus">-  NS_IMETHOD GetCardValue(nsIAbCard *card, const char *name, char16_t **value) override;</span>
<a href="#l80.444"></a><span id="l80.444" class="difflineplus">+  NS_IMETHOD SetCardValue(nsIAbCard *card, const char *name,</span>
<a href="#l80.445"></a><span id="l80.445" class="difflineplus">+                          const char16_t *value, bool notify) override;</span>
<a href="#l80.446"></a><span id="l80.446" class="difflineplus">+  NS_IMETHOD GetCardValue(nsIAbCard *card, const char *name,</span>
<a href="#l80.447"></a><span id="l80.447" class="difflineplus">+                          char16_t **value) override;</span>
<a href="#l80.448"></a><span id="l80.448">   // nsAddrDatabase methods:</span>
<a href="#l80.449"></a><span id="l80.449"> </span>
<a href="#l80.450"></a><span id="l80.450">   nsAddrDatabase();</span>
<a href="#l80.451"></a><span id="l80.451"> </span>
<a href="#l80.452"></a><span id="l80.452" class="difflineminus">-  nsresult GetMDBFactory(nsIMdbFactory ** aMdbFactory);</span>
<a href="#l80.453"></a><span id="l80.453" class="difflineminus">-  nsIMdbEnv    *GetEnv() {return m_mdbEnv;}</span>
<a href="#l80.454"></a><span id="l80.454" class="difflineminus">-  uint32_t    GetCurVersion();</span>
<a href="#l80.455"></a><span id="l80.455" class="difflineplus">+  nsresult GetMDBFactory(nsIMdbFactory **aMdbFactory);</span>
<a href="#l80.456"></a><span id="l80.456" class="difflineplus">+  nsIMdbEnv *GetEnv() { return m_mdbEnv; }</span>
<a href="#l80.457"></a><span id="l80.457" class="difflineplus">+  uint32_t GetCurVersion();</span>
<a href="#l80.458"></a><span id="l80.458">   nsIMdbTableRowCursor *GetTableRowCursor();</span>
<a href="#l80.459"></a><span id="l80.459" class="difflineminus">-  nsIMdbTable    *GetPabTable() {return m_mdbPabTable;}</span>
<a href="#l80.460"></a><span id="l80.460" class="difflineplus">+  nsIMdbTable *GetPabTable() { return m_mdbPabTable; }</span>
<a href="#l80.461"></a><span id="l80.461"> </span>
<a href="#l80.462"></a><span id="l80.462">   static already_AddRefed&lt;nsAddrDatabase&gt; FindInCache(nsIFile *dbName);</span>
<a href="#l80.463"></a><span id="l80.463"> </span>
<a href="#l80.464"></a><span id="l80.464" class="difflineminus">-  static void    CleanupCache();</span>
<a href="#l80.465"></a><span id="l80.465" class="difflineplus">+  static void CleanupCache();</span>
<a href="#l80.466"></a><span id="l80.466" class="difflineplus">+</span>
<a href="#l80.467"></a><span id="l80.467" class="difflineplus">+  nsresult CreateABCard(nsIMdbRow *cardRow, mdb_id listRowID,</span>
<a href="#l80.468"></a><span id="l80.468" class="difflineplus">+                        nsIAbCard **result);</span>
<a href="#l80.469"></a><span id="l80.469" class="difflineplus">+  nsresult CreateABListCard(nsIMdbRow *listRow, nsIAbCard **result);</span>
<a href="#l80.470"></a><span id="l80.470" class="difflineplus">+  nsresult CreateABList(nsIMdbRow *listRow, nsIAbDirectory **result);</span>
<a href="#l80.471"></a><span id="l80.471"> </span>
<a href="#l80.472"></a><span id="l80.472" class="difflineminus">-  nsresult CreateABCard(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result);</span>
<a href="#l80.473"></a><span id="l80.473" class="difflineminus">-  nsresult CreateABListCard(nsIMdbRow* listRow, nsIAbCard **result);</span>
<a href="#l80.474"></a><span id="l80.474" class="difflineminus">-  nsresult CreateABList(nsIMdbRow* listRow, nsIAbDirectory **result);</span>
<a href="#l80.475"></a><span id="l80.475" class="difflineminus">-</span>
<a href="#l80.476"></a><span id="l80.476" class="difflineminus">-  bool IsListRowScopeToken(mdb_scope scope) { return (scope == m_ListRowScopeToken) ? true: false; }</span>
<a href="#l80.477"></a><span id="l80.477" class="difflineminus">-  bool IsCardRowScopeToken(mdb_scope scope) { return (scope == m_CardRowScopeToken) ? true: false;  }</span>
<a href="#l80.478"></a><span id="l80.478" class="difflineminus">-  bool IsDataRowScopeToken(mdb_scope scope) { return (scope == m_DataRowScopeToken) ? true: false; }</span>
<a href="#l80.479"></a><span id="l80.479" class="difflineplus">+  bool IsListRowScopeToken(mdb_scope scope) {</span>
<a href="#l80.480"></a><span id="l80.480" class="difflineplus">+    return (scope == m_ListRowScopeToken) ? true : false;</span>
<a href="#l80.481"></a><span id="l80.481" class="difflineplus">+  }</span>
<a href="#l80.482"></a><span id="l80.482" class="difflineplus">+  bool IsCardRowScopeToken(mdb_scope scope) {</span>
<a href="#l80.483"></a><span id="l80.483" class="difflineplus">+    return (scope == m_CardRowScopeToken) ? true : false;</span>
<a href="#l80.484"></a><span id="l80.484" class="difflineplus">+  }</span>
<a href="#l80.485"></a><span id="l80.485" class="difflineplus">+  bool IsDataRowScopeToken(mdb_scope scope) {</span>
<a href="#l80.486"></a><span id="l80.486" class="difflineplus">+    return (scope == m_DataRowScopeToken) ? true : false;</span>
<a href="#l80.487"></a><span id="l80.487" class="difflineplus">+  }</span>
<a href="#l80.488"></a><span id="l80.488">   nsresult GetCardRowByRowID(mdb_id rowID, nsIMdbRow **dbRow);</span>
<a href="#l80.489"></a><span id="l80.489">   nsresult GetListRowByRowID(mdb_id rowID, nsIMdbRow **dbRow);</span>
<a href="#l80.490"></a><span id="l80.490"> </span>
<a href="#l80.491"></a><span id="l80.491" class="difflineminus">-  uint32_t GetListAddressTotal(nsIMdbRow* listRow);</span>
<a href="#l80.492"></a><span id="l80.492" class="difflineminus">-  nsresult GetAddressRowByPos(nsIMdbRow* listRow, uint16_t pos, nsIMdbRow** cardRow);</span>
<a href="#l80.493"></a><span id="l80.493" class="difflineplus">+  uint32_t GetListAddressTotal(nsIMdbRow *listRow);</span>
<a href="#l80.494"></a><span id="l80.494" class="difflineplus">+  nsresult GetAddressRowByPos(nsIMdbRow *listRow, uint16_t pos,</span>
<a href="#l80.495"></a><span id="l80.495" class="difflineplus">+                              nsIMdbRow **cardRow);</span>
<a href="#l80.496"></a><span id="l80.496"> </span>
<a href="#l80.497"></a><span id="l80.497" class="difflineminus">-    NS_IMETHOD AddListCardColumnsToRow(nsIAbCard *aPCard, nsIMdbRow *aPListRow, uint32_t aPos, nsIAbCard** aPNewCard, bool aInMailingList, nsIAbDirectory *aParent, nsIAbDirectory *aRoot) override;</span>
<a href="#l80.498"></a><span id="l80.498" class="difflineminus">-    NS_IMETHOD InitCardFromRow(nsIAbCard *aNewCard, nsIMdbRow* aCardRow) override;</span>
<a href="#l80.499"></a><span id="l80.499" class="difflineminus">-    NS_IMETHOD SetListAddressTotal(nsIMdbRow* aListRow, uint32_t aTotal) override;</span>
<a href="#l80.500"></a><span id="l80.500" class="difflineminus">-    NS_IMETHOD FindRowByCard(nsIAbCard * card,nsIMdbRow **aRow) override;</span>
<a href="#l80.501"></a><span id="l80.501" class="difflineplus">+  NS_IMETHOD AddListCardColumnsToRow(nsIAbCard *aPCard, nsIMdbRow *aPListRow,</span>
<a href="#l80.502"></a><span id="l80.502" class="difflineplus">+                                     uint32_t aPos, nsIAbCard **aPNewCard,</span>
<a href="#l80.503"></a><span id="l80.503" class="difflineplus">+                                     bool aInMailingList,</span>
<a href="#l80.504"></a><span id="l80.504" class="difflineplus">+                                     nsIAbDirectory *aParent,</span>
<a href="#l80.505"></a><span id="l80.505" class="difflineplus">+                                     nsIAbDirectory *aRoot) override;</span>
<a href="#l80.506"></a><span id="l80.506" class="difflineplus">+  NS_IMETHOD InitCardFromRow(nsIAbCard *aNewCard, nsIMdbRow *aCardRow) override;</span>
<a href="#l80.507"></a><span id="l80.507" class="difflineplus">+  NS_IMETHOD SetListAddressTotal(nsIMdbRow *aListRow, uint32_t aTotal) override;</span>
<a href="#l80.508"></a><span id="l80.508" class="difflineplus">+  NS_IMETHOD FindRowByCard(nsIAbCard *card, nsIMdbRow **aRow) override;</span>
<a href="#l80.509"></a><span id="l80.509"> </span>
<a href="#l80.510"></a><span id="l80.510" class="difflineminus">-protected:</span>
<a href="#l80.511"></a><span id="l80.511" class="difflineplus">+ protected:</span>
<a href="#l80.512"></a><span id="l80.512">   virtual ~nsAddrDatabase();</span>
<a href="#l80.513"></a><span id="l80.513"> </span>
<a href="#l80.514"></a><span id="l80.514" class="difflineminus">-  static void RemoveFromCache(nsAddrDatabase* pAddrDB);</span>
<a href="#l80.515"></a><span id="l80.515" class="difflineminus">-  bool MatchDbName(nsIFile *dbName); // returns TRUE if they match</span>
<a href="#l80.516"></a><span id="l80.516" class="difflineplus">+  static void RemoveFromCache(nsAddrDatabase *pAddrDB);</span>
<a href="#l80.517"></a><span id="l80.517" class="difflineplus">+  bool MatchDbName(nsIFile *dbName);  // returns TRUE if they match</span>
<a href="#l80.518"></a><span id="l80.518"> </span>
<a href="#l80.519"></a><span id="l80.519">   void YarnToUInt32(struct mdbYarn *yarn, uint32_t *pResult);</span>
<a href="#l80.520"></a><span id="l80.520" class="difflineminus">-  void GetCharStringYarn(char* str, struct mdbYarn* strYarn);</span>
<a href="#l80.521"></a><span id="l80.521" class="difflineminus">-  void GetStringYarn(const nsAString &amp; aStr, struct mdbYarn* strYarn);</span>
<a href="#l80.522"></a><span id="l80.522" class="difflineminus">-  void GetIntYarn(uint32_t nValue, struct mdbYarn* intYarn);</span>
<a href="#l80.523"></a><span id="l80.523" class="difflineminus">-  nsresult AddCharStringColumn(nsIMdbRow* cardRow, mdb_column inColumn, const char* str);</span>
<a href="#l80.524"></a><span id="l80.524" class="difflineminus">-  nsresult AddStringColumn(nsIMdbRow* aCardRow, mdb_column aInColumn, const nsAString &amp; aStr);</span>
<a href="#l80.525"></a><span id="l80.525" class="difflineminus">-  nsresult AddIntColumn(nsIMdbRow* cardRow, mdb_column inColumn, uint32_t nValue);</span>
<a href="#l80.526"></a><span id="l80.526" class="difflineminus">-  nsresult AddBoolColumn(nsIMdbRow* cardRow, mdb_column inColumn, bool bValue);</span>
<a href="#l80.527"></a><span id="l80.527" class="difflineminus">-  nsresult GetStringColumn(nsIMdbRow *cardRow, mdb_token outToken, nsString&amp; str);</span>
<a href="#l80.528"></a><span id="l80.528" class="difflineplus">+  void GetCharStringYarn(char *str, struct mdbYarn *strYarn);</span>
<a href="#l80.529"></a><span id="l80.529" class="difflineplus">+  void GetStringYarn(const nsAString &amp;aStr, struct mdbYarn *strYarn);</span>
<a href="#l80.530"></a><span id="l80.530" class="difflineplus">+  void GetIntYarn(uint32_t nValue, struct mdbYarn *intYarn);</span>
<a href="#l80.531"></a><span id="l80.531" class="difflineplus">+  nsresult AddCharStringColumn(nsIMdbRow *cardRow, mdb_column inColumn,</span>
<a href="#l80.532"></a><span id="l80.532" class="difflineplus">+                               const char *str);</span>
<a href="#l80.533"></a><span id="l80.533" class="difflineplus">+  nsresult AddStringColumn(nsIMdbRow *aCardRow, mdb_column aInColumn,</span>
<a href="#l80.534"></a><span id="l80.534" class="difflineplus">+                           const nsAString &amp;aStr);</span>
<a href="#l80.535"></a><span id="l80.535" class="difflineplus">+  nsresult AddIntColumn(nsIMdbRow *cardRow, mdb_column inColumn,</span>
<a href="#l80.536"></a><span id="l80.536" class="difflineplus">+                        uint32_t nValue);</span>
<a href="#l80.537"></a><span id="l80.537" class="difflineplus">+  nsresult AddBoolColumn(nsIMdbRow *cardRow, mdb_column inColumn, bool bValue);</span>
<a href="#l80.538"></a><span id="l80.538" class="difflineplus">+  nsresult GetStringColumn(nsIMdbRow *cardRow, mdb_token outToken,</span>
<a href="#l80.539"></a><span id="l80.539" class="difflineplus">+                           nsString &amp;str);</span>
<a href="#l80.540"></a><span id="l80.540">   nsresult GetIntColumn(nsIMdbRow *cardRow, mdb_token outToken,</span>
<a href="#l80.541"></a><span id="l80.541" class="difflineminus">-              uint32_t* pValue, uint32_t defaultValue);</span>
<a href="#l80.542"></a><span id="l80.542" class="difflineminus">-  nsresult GetBoolColumn(nsIMdbRow *cardRow, mdb_token outToken, bool* pValue);</span>
<a href="#l80.543"></a><span id="l80.543" class="difflineminus">-  nsresult GetListCardFromDB(nsIAbCard *listCard, nsIMdbRow* listRow);</span>
<a href="#l80.544"></a><span id="l80.544" class="difflineminus">-  nsresult GetListFromDB(nsIAbDirectory *newCard, nsIMdbRow* listRow);</span>
<a href="#l80.545"></a><span id="l80.545" class="difflineplus">+                        uint32_t *pValue, uint32_t defaultValue);</span>
<a href="#l80.546"></a><span id="l80.546" class="difflineplus">+  nsresult GetBoolColumn(nsIMdbRow *cardRow, mdb_token outToken, bool *pValue);</span>
<a href="#l80.547"></a><span id="l80.547" class="difflineplus">+  nsresult GetListCardFromDB(nsIAbCard *listCard, nsIMdbRow *listRow);</span>
<a href="#l80.548"></a><span id="l80.548" class="difflineplus">+  nsresult GetListFromDB(nsIAbDirectory *newCard, nsIMdbRow *listRow);</span>
<a href="#l80.549"></a><span id="l80.549">   nsresult AddRecordKeyColumnToRow(nsIMdbRow *pRow);</span>
<a href="#l80.550"></a><span id="l80.550">   nsresult AddAttributeColumnsToRow(nsIAbCard *card, nsIMdbRow *cardRow);</span>
<a href="#l80.551"></a><span id="l80.551" class="difflineminus">-  nsresult AddListAttributeColumnsToRow(nsIAbDirectory *list, nsIMdbRow *listRow, nsIAbDirectory *parent);</span>
<a href="#l80.552"></a><span id="l80.552" class="difflineminus">-  nsresult CreateCard(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result);</span>
<a href="#l80.553"></a><span id="l80.553" class="difflineminus">-  nsresult CreateCardFromDeletedCardsTable(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result);</span>
<a href="#l80.554"></a><span id="l80.554" class="difflineminus">-  nsresult DeleteCardFromListRow(nsIMdbRow* pListRow, mdb_id cardRowID);</span>
<a href="#l80.555"></a><span id="l80.555" class="difflineplus">+  nsresult AddListAttributeColumnsToRow(nsIAbDirectory *list,</span>
<a href="#l80.556"></a><span id="l80.556" class="difflineplus">+                                        nsIMdbRow *listRow,</span>
<a href="#l80.557"></a><span id="l80.557" class="difflineplus">+                                        nsIAbDirectory *parent);</span>
<a href="#l80.558"></a><span id="l80.558" class="difflineplus">+  nsresult CreateCard(nsIMdbRow *cardRow, mdb_id listRowID, nsIAbCard **result);</span>
<a href="#l80.559"></a><span id="l80.559" class="difflineplus">+  nsresult CreateCardFromDeletedCardsTable(nsIMdbRow *cardRow, mdb_id listRowID,</span>
<a href="#l80.560"></a><span id="l80.560" class="difflineplus">+                                           nsIAbCard **result);</span>
<a href="#l80.561"></a><span id="l80.561" class="difflineplus">+  nsresult DeleteCardFromListRow(nsIMdbRow *pListRow, mdb_id cardRowID);</span>
<a href="#l80.562"></a><span id="l80.562">   void DeleteCardFromAllMailLists(mdb_id cardRowID);</span>
<a href="#l80.563"></a><span id="l80.563">   nsresult NotifyListEntryChange(uint32_t abCode, nsIAbDirectory *dir);</span>
<a href="#l80.564"></a><span id="l80.564"> </span>
<a href="#l80.565"></a><span id="l80.565" class="difflineminus">-  nsresult AddLowercaseColumn(nsIMdbRow * row, mdb_token columnToken, const char* utf8String);</span>
<a href="#l80.566"></a><span id="l80.566" class="difflineplus">+  nsresult AddLowercaseColumn(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l80.567"></a><span id="l80.567" class="difflineplus">+                              const char *utf8String);</span>
<a href="#l80.568"></a><span id="l80.568">   nsresult GetRowFromAttribute(const char *aName, const nsACString &amp;aUTF8Value,</span>
<a href="#l80.569"></a><span id="l80.569" class="difflineminus">-                               bool aCaseInsensitive, nsIMdbRow  **aCardRow,</span>
<a href="#l80.570"></a><span id="l80.570" class="difflineplus">+                               bool aCaseInsensitive, nsIMdbRow **aCardRow,</span>
<a href="#l80.571"></a><span id="l80.571">                                mdb_pos *aRowPos);</span>
<a href="#l80.572"></a><span id="l80.572"> </span>
<a href="#l80.573"></a><span id="l80.573" class="difflineminus">-  static nsTArray&lt;nsAddrDatabase*&gt;* m_dbCache;</span>
<a href="#l80.574"></a><span id="l80.574" class="difflineminus">-  static nsTArray&lt;nsAddrDatabase*&gt;* GetDBCache();</span>
<a href="#l80.575"></a><span id="l80.575" class="difflineplus">+  static nsTArray&lt;nsAddrDatabase *&gt; *m_dbCache;</span>
<a href="#l80.576"></a><span id="l80.576" class="difflineplus">+  static nsTArray&lt;nsAddrDatabase *&gt; *GetDBCache();</span>
<a href="#l80.577"></a><span id="l80.577"> </span>
<a href="#l80.578"></a><span id="l80.578">   // mdb bookkeeping stuff</span>
<a href="#l80.579"></a><span id="l80.579" class="difflineminus">-  nsresult      InitExistingDB();</span>
<a href="#l80.580"></a><span id="l80.580" class="difflineminus">-  nsresult      InitNewDB();</span>
<a href="#l80.581"></a><span id="l80.581" class="difflineminus">-  nsresult      InitMDBInfo();</span>
<a href="#l80.582"></a><span id="l80.582" class="difflineminus">-  nsresult      InitPabTable();</span>
<a href="#l80.583"></a><span id="l80.583" class="difflineplus">+  nsresult InitExistingDB();</span>
<a href="#l80.584"></a><span id="l80.584" class="difflineplus">+  nsresult InitNewDB();</span>
<a href="#l80.585"></a><span id="l80.585" class="difflineplus">+  nsresult InitMDBInfo();</span>
<a href="#l80.586"></a><span id="l80.586" class="difflineplus">+  nsresult InitPabTable();</span>
<a href="#l80.587"></a><span id="l80.587"> </span>
<a href="#l80.588"></a><span id="l80.588" class="difflineminus">-  nsresult      InitLastRecorKey();</span>
<a href="#l80.589"></a><span id="l80.589" class="difflineminus">-  nsresult      GetDataRow(nsIMdbRow **pDataRow);</span>
<a href="#l80.590"></a><span id="l80.590" class="difflineminus">-  nsresult      GetLastRecordKey();</span>
<a href="#l80.591"></a><span id="l80.591" class="difflineminus">-  nsresult      UpdateLastRecordKey();</span>
<a href="#l80.592"></a><span id="l80.592" class="difflineminus">-  nsresult      CheckAndUpdateRecordKey();</span>
<a href="#l80.593"></a><span id="l80.593" class="difflineminus">-  nsresult      UpdateLowercaseEmailListName();</span>
<a href="#l80.594"></a><span id="l80.594" class="difflineminus">-  nsresult      ConvertAndAddLowercaseColumn(nsIMdbRow * row, mdb_token fromCol, mdb_token toCol);</span>
<a href="#l80.595"></a><span id="l80.595" class="difflineminus">-  nsresult      AddUnicodeToColumn(nsIMdbRow * row, mdb_token colToken, mdb_token lowerCaseColToken, const char16_t* pUnicodeStr);</span>
<a href="#l80.596"></a><span id="l80.596" class="difflineplus">+  nsresult InitLastRecorKey();</span>
<a href="#l80.597"></a><span id="l80.597" class="difflineplus">+  nsresult GetDataRow(nsIMdbRow **pDataRow);</span>
<a href="#l80.598"></a><span id="l80.598" class="difflineplus">+  nsresult GetLastRecordKey();</span>
<a href="#l80.599"></a><span id="l80.599" class="difflineplus">+  nsresult UpdateLastRecordKey();</span>
<a href="#l80.600"></a><span id="l80.600" class="difflineplus">+  nsresult CheckAndUpdateRecordKey();</span>
<a href="#l80.601"></a><span id="l80.601" class="difflineplus">+  nsresult UpdateLowercaseEmailListName();</span>
<a href="#l80.602"></a><span id="l80.602" class="difflineplus">+  nsresult ConvertAndAddLowercaseColumn(nsIMdbRow *row, mdb_token fromCol,</span>
<a href="#l80.603"></a><span id="l80.603" class="difflineplus">+                                        mdb_token toCol);</span>
<a href="#l80.604"></a><span id="l80.604" class="difflineplus">+  nsresult AddUnicodeToColumn(nsIMdbRow *row, mdb_token colToken,</span>
<a href="#l80.605"></a><span id="l80.605" class="difflineplus">+                              mdb_token lowerCaseColToken,</span>
<a href="#l80.606"></a><span id="l80.606" class="difflineplus">+                              const char16_t *pUnicodeStr);</span>
<a href="#l80.607"></a><span id="l80.607"> </span>
<a href="#l80.608"></a><span id="l80.608" class="difflineminus">-  nsresult      DeleteRow(nsIMdbTable* dbTable, nsIMdbRow* dbRow);</span>
<a href="#l80.609"></a><span id="l80.609" class="difflineplus">+  nsresult DeleteRow(nsIMdbTable *dbTable, nsIMdbRow *dbRow);</span>
<a href="#l80.610"></a><span id="l80.610"> </span>
<a href="#l80.611"></a><span id="l80.611" class="difflineminus">-  nsIMdbEnv   *m_mdbEnv;  // to be used in all the db calls.</span>
<a href="#l80.612"></a><span id="l80.612" class="difflineplus">+  nsIMdbEnv *m_mdbEnv;  // to be used in all the db calls.</span>
<a href="#l80.613"></a><span id="l80.613">   nsIMdbStore *m_mdbStore;</span>
<a href="#l80.614"></a><span id="l80.614">   nsIMdbTable *m_mdbPabTable;</span>
<a href="#l80.615"></a><span id="l80.615">   nsCOMPtr&lt;nsIFile&gt; m_dbName;</span>
<a href="#l80.616"></a><span id="l80.616" class="difflineminus">-  bool          m_mdbTokensInitialized;</span>
<a href="#l80.617"></a><span id="l80.617" class="difflineminus">-  bool          m_mdbDeletedCardsTableRemoved;</span>
<a href="#l80.618"></a><span id="l80.618" class="difflineminus">-  nsTObserverArray&lt;nsIAddrDBListener*&gt; m_ChangeListeners;</span>
<a href="#l80.619"></a><span id="l80.619" class="difflineplus">+  bool m_mdbTokensInitialized;</span>
<a href="#l80.620"></a><span id="l80.620" class="difflineplus">+  bool m_mdbDeletedCardsTableRemoved;</span>
<a href="#l80.621"></a><span id="l80.621" class="difflineplus">+  nsTObserverArray&lt;nsIAddrDBListener *&gt; m_ChangeListeners;</span>
<a href="#l80.622"></a><span id="l80.622"> </span>
<a href="#l80.623"></a><span id="l80.623" class="difflineminus">-  mdb_kind      m_PabTableKind;</span>
<a href="#l80.624"></a><span id="l80.624" class="difflineminus">-  mdb_kind      m_MailListTableKind;</span>
<a href="#l80.625"></a><span id="l80.625" class="difflineminus">-  mdb_kind      m_DeletedCardsTableKind;</span>
<a href="#l80.626"></a><span id="l80.626" class="difflineplus">+  mdb_kind m_PabTableKind;</span>
<a href="#l80.627"></a><span id="l80.627" class="difflineplus">+  mdb_kind m_MailListTableKind;</span>
<a href="#l80.628"></a><span id="l80.628" class="difflineplus">+  mdb_kind m_DeletedCardsTableKind;</span>
<a href="#l80.629"></a><span id="l80.629"> </span>
<a href="#l80.630"></a><span id="l80.630" class="difflineminus">-  mdb_scope      m_CardRowScopeToken;</span>
<a href="#l80.631"></a><span id="l80.631" class="difflineminus">-  mdb_scope      m_ListRowScopeToken;</span>
<a href="#l80.632"></a><span id="l80.632" class="difflineminus">-  mdb_scope      m_DataRowScopeToken;</span>
<a href="#l80.633"></a><span id="l80.633" class="difflineplus">+  mdb_scope m_CardRowScopeToken;</span>
<a href="#l80.634"></a><span id="l80.634" class="difflineplus">+  mdb_scope m_ListRowScopeToken;</span>
<a href="#l80.635"></a><span id="l80.635" class="difflineplus">+  mdb_scope m_DataRowScopeToken;</span>
<a href="#l80.636"></a><span id="l80.636"> </span>
<a href="#l80.637"></a><span id="l80.637" class="difflineminus">-  mdb_token      m_UIDColumnToken;</span>
<a href="#l80.638"></a><span id="l80.638" class="difflineminus">-  mdb_token      m_FirstNameColumnToken;</span>
<a href="#l80.639"></a><span id="l80.639" class="difflineminus">-  mdb_token      m_LastNameColumnToken;</span>
<a href="#l80.640"></a><span id="l80.640" class="difflineminus">-  mdb_token      m_PhoneticFirstNameColumnToken;</span>
<a href="#l80.641"></a><span id="l80.641" class="difflineminus">-  mdb_token      m_PhoneticLastNameColumnToken;</span>
<a href="#l80.642"></a><span id="l80.642" class="difflineminus">-  mdb_token      m_DisplayNameColumnToken;</span>
<a href="#l80.643"></a><span id="l80.643" class="difflineminus">-  mdb_token      m_NickNameColumnToken;</span>
<a href="#l80.644"></a><span id="l80.644" class="difflineminus">-  mdb_token      m_PriEmailColumnToken;</span>
<a href="#l80.645"></a><span id="l80.645" class="difflineminus">-  mdb_token      m_2ndEmailColumnToken;</span>
<a href="#l80.646"></a><span id="l80.646" class="difflineminus">-  mdb_token      m_DefaultEmailColumnToken;</span>
<a href="#l80.647"></a><span id="l80.647" class="difflineminus">-  mdb_token      m_CardTypeColumnToken;</span>
<a href="#l80.648"></a><span id="l80.648" class="difflineminus">-  mdb_token      m_WorkPhoneColumnToken;</span>
<a href="#l80.649"></a><span id="l80.649" class="difflineminus">-  mdb_token      m_HomePhoneColumnToken;</span>
<a href="#l80.650"></a><span id="l80.650" class="difflineminus">-  mdb_token      m_FaxColumnToken;</span>
<a href="#l80.651"></a><span id="l80.651" class="difflineminus">-  mdb_token      m_PagerColumnToken;</span>
<a href="#l80.652"></a><span id="l80.652" class="difflineminus">-  mdb_token      m_CellularColumnToken;</span>
<a href="#l80.653"></a><span id="l80.653" class="difflineminus">-  mdb_token      m_WorkPhoneTypeColumnToken;</span>
<a href="#l80.654"></a><span id="l80.654" class="difflineminus">-  mdb_token      m_HomePhoneTypeColumnToken;</span>
<a href="#l80.655"></a><span id="l80.655" class="difflineminus">-  mdb_token      m_FaxTypeColumnToken;</span>
<a href="#l80.656"></a><span id="l80.656" class="difflineminus">-  mdb_token      m_PagerTypeColumnToken;</span>
<a href="#l80.657"></a><span id="l80.657" class="difflineminus">-  mdb_token      m_CellularTypeColumnToken;</span>
<a href="#l80.658"></a><span id="l80.658" class="difflineminus">-  mdb_token      m_HomeAddressColumnToken;</span>
<a href="#l80.659"></a><span id="l80.659" class="difflineminus">-  mdb_token      m_HomeAddress2ColumnToken;</span>
<a href="#l80.660"></a><span id="l80.660" class="difflineminus">-  mdb_token      m_HomeCityColumnToken;</span>
<a href="#l80.661"></a><span id="l80.661" class="difflineminus">-  mdb_token      m_HomeStateColumnToken;</span>
<a href="#l80.662"></a><span id="l80.662" class="difflineminus">-  mdb_token      m_HomeZipCodeColumnToken;</span>
<a href="#l80.663"></a><span id="l80.663" class="difflineminus">-  mdb_token      m_HomeCountryColumnToken;</span>
<a href="#l80.664"></a><span id="l80.664" class="difflineminus">-  mdb_token      m_WorkAddressColumnToken;</span>
<a href="#l80.665"></a><span id="l80.665" class="difflineminus">-  mdb_token      m_WorkAddress2ColumnToken;</span>
<a href="#l80.666"></a><span id="l80.666" class="difflineminus">-  mdb_token      m_WorkCityColumnToken;</span>
<a href="#l80.667"></a><span id="l80.667" class="difflineminus">-  mdb_token      m_WorkStateColumnToken;</span>
<a href="#l80.668"></a><span id="l80.668" class="difflineminus">-  mdb_token      m_WorkZipCodeColumnToken;</span>
<a href="#l80.669"></a><span id="l80.669" class="difflineminus">-  mdb_token      m_WorkCountryColumnToken;</span>
<a href="#l80.670"></a><span id="l80.670" class="difflineminus">-  mdb_token      m_JobTitleColumnToken;</span>
<a href="#l80.671"></a><span id="l80.671" class="difflineminus">-  mdb_token      m_DepartmentColumnToken;</span>
<a href="#l80.672"></a><span id="l80.672" class="difflineminus">-  mdb_token      m_CompanyColumnToken;</span>
<a href="#l80.673"></a><span id="l80.673" class="difflineminus">-  mdb_token      m_AimScreenNameColumnToken;</span>
<a href="#l80.674"></a><span id="l80.674" class="difflineminus">-  mdb_token      m_AnniversaryYearColumnToken;</span>
<a href="#l80.675"></a><span id="l80.675" class="difflineminus">-  mdb_token      m_AnniversaryMonthColumnToken;</span>
<a href="#l80.676"></a><span id="l80.676" class="difflineminus">-  mdb_token      m_AnniversaryDayColumnToken;</span>
<a href="#l80.677"></a><span id="l80.677" class="difflineminus">-  mdb_token      m_SpouseNameColumnToken;</span>
<a href="#l80.678"></a><span id="l80.678" class="difflineminus">-  mdb_token      m_FamilyNameColumnToken;</span>
<a href="#l80.679"></a><span id="l80.679" class="difflineminus">-  mdb_token      m_DefaultAddressColumnToken;</span>
<a href="#l80.680"></a><span id="l80.680" class="difflineminus">-  mdb_token      m_CategoryColumnToken;</span>
<a href="#l80.681"></a><span id="l80.681" class="difflineminus">-  mdb_token      m_WebPage1ColumnToken;</span>
<a href="#l80.682"></a><span id="l80.682" class="difflineminus">-  mdb_token      m_WebPage2ColumnToken;</span>
<a href="#l80.683"></a><span id="l80.683" class="difflineminus">-  mdb_token      m_BirthYearColumnToken;</span>
<a href="#l80.684"></a><span id="l80.684" class="difflineminus">-  mdb_token      m_BirthMonthColumnToken;</span>
<a href="#l80.685"></a><span id="l80.685" class="difflineminus">-  mdb_token      m_BirthDayColumnToken;</span>
<a href="#l80.686"></a><span id="l80.686" class="difflineminus">-  mdb_token      m_Custom1ColumnToken;</span>
<a href="#l80.687"></a><span id="l80.687" class="difflineminus">-  mdb_token      m_Custom2ColumnToken;</span>
<a href="#l80.688"></a><span id="l80.688" class="difflineminus">-  mdb_token      m_Custom3ColumnToken;</span>
<a href="#l80.689"></a><span id="l80.689" class="difflineminus">-  mdb_token      m_Custom4ColumnToken;</span>
<a href="#l80.690"></a><span id="l80.690" class="difflineminus">-  mdb_token      m_NotesColumnToken;</span>
<a href="#l80.691"></a><span id="l80.691" class="difflineminus">-  mdb_token      m_LastModDateColumnToken;</span>
<a href="#l80.692"></a><span id="l80.692" class="difflineminus">-  mdb_token      m_RecordKeyColumnToken;</span>
<a href="#l80.693"></a><span id="l80.693" class="difflineminus">-  mdb_token      m_LowerPriEmailColumnToken;</span>
<a href="#l80.694"></a><span id="l80.694" class="difflineminus">-  mdb_token      m_Lower2ndEmailColumnToken;</span>
<a href="#l80.695"></a><span id="l80.695" class="difflineplus">+  mdb_token m_UIDColumnToken;</span>
<a href="#l80.696"></a><span id="l80.696" class="difflineplus">+  mdb_token m_FirstNameColumnToken;</span>
<a href="#l80.697"></a><span id="l80.697" class="difflineplus">+  mdb_token m_LastNameColumnToken;</span>
<a href="#l80.698"></a><span id="l80.698" class="difflineplus">+  mdb_token m_PhoneticFirstNameColumnToken;</span>
<a href="#l80.699"></a><span id="l80.699" class="difflineplus">+  mdb_token m_PhoneticLastNameColumnToken;</span>
<a href="#l80.700"></a><span id="l80.700" class="difflineplus">+  mdb_token m_DisplayNameColumnToken;</span>
<a href="#l80.701"></a><span id="l80.701" class="difflineplus">+  mdb_token m_NickNameColumnToken;</span>
<a href="#l80.702"></a><span id="l80.702" class="difflineplus">+  mdb_token m_PriEmailColumnToken;</span>
<a href="#l80.703"></a><span id="l80.703" class="difflineplus">+  mdb_token m_2ndEmailColumnToken;</span>
<a href="#l80.704"></a><span id="l80.704" class="difflineplus">+  mdb_token m_DefaultEmailColumnToken;</span>
<a href="#l80.705"></a><span id="l80.705" class="difflineplus">+  mdb_token m_CardTypeColumnToken;</span>
<a href="#l80.706"></a><span id="l80.706" class="difflineplus">+  mdb_token m_WorkPhoneColumnToken;</span>
<a href="#l80.707"></a><span id="l80.707" class="difflineplus">+  mdb_token m_HomePhoneColumnToken;</span>
<a href="#l80.708"></a><span id="l80.708" class="difflineplus">+  mdb_token m_FaxColumnToken;</span>
<a href="#l80.709"></a><span id="l80.709" class="difflineplus">+  mdb_token m_PagerColumnToken;</span>
<a href="#l80.710"></a><span id="l80.710" class="difflineplus">+  mdb_token m_CellularColumnToken;</span>
<a href="#l80.711"></a><span id="l80.711" class="difflineplus">+  mdb_token m_WorkPhoneTypeColumnToken;</span>
<a href="#l80.712"></a><span id="l80.712" class="difflineplus">+  mdb_token m_HomePhoneTypeColumnToken;</span>
<a href="#l80.713"></a><span id="l80.713" class="difflineplus">+  mdb_token m_FaxTypeColumnToken;</span>
<a href="#l80.714"></a><span id="l80.714" class="difflineplus">+  mdb_token m_PagerTypeColumnToken;</span>
<a href="#l80.715"></a><span id="l80.715" class="difflineplus">+  mdb_token m_CellularTypeColumnToken;</span>
<a href="#l80.716"></a><span id="l80.716" class="difflineplus">+  mdb_token m_HomeAddressColumnToken;</span>
<a href="#l80.717"></a><span id="l80.717" class="difflineplus">+  mdb_token m_HomeAddress2ColumnToken;</span>
<a href="#l80.718"></a><span id="l80.718" class="difflineplus">+  mdb_token m_HomeCityColumnToken;</span>
<a href="#l80.719"></a><span id="l80.719" class="difflineplus">+  mdb_token m_HomeStateColumnToken;</span>
<a href="#l80.720"></a><span id="l80.720" class="difflineplus">+  mdb_token m_HomeZipCodeColumnToken;</span>
<a href="#l80.721"></a><span id="l80.721" class="difflineplus">+  mdb_token m_HomeCountryColumnToken;</span>
<a href="#l80.722"></a><span id="l80.722" class="difflineplus">+  mdb_token m_WorkAddressColumnToken;</span>
<a href="#l80.723"></a><span id="l80.723" class="difflineplus">+  mdb_token m_WorkAddress2ColumnToken;</span>
<a href="#l80.724"></a><span id="l80.724" class="difflineplus">+  mdb_token m_WorkCityColumnToken;</span>
<a href="#l80.725"></a><span id="l80.725" class="difflineplus">+  mdb_token m_WorkStateColumnToken;</span>
<a href="#l80.726"></a><span id="l80.726" class="difflineplus">+  mdb_token m_WorkZipCodeColumnToken;</span>
<a href="#l80.727"></a><span id="l80.727" class="difflineplus">+  mdb_token m_WorkCountryColumnToken;</span>
<a href="#l80.728"></a><span id="l80.728" class="difflineplus">+  mdb_token m_JobTitleColumnToken;</span>
<a href="#l80.729"></a><span id="l80.729" class="difflineplus">+  mdb_token m_DepartmentColumnToken;</span>
<a href="#l80.730"></a><span id="l80.730" class="difflineplus">+  mdb_token m_CompanyColumnToken;</span>
<a href="#l80.731"></a><span id="l80.731" class="difflineplus">+  mdb_token m_AimScreenNameColumnToken;</span>
<a href="#l80.732"></a><span id="l80.732" class="difflineplus">+  mdb_token m_AnniversaryYearColumnToken;</span>
<a href="#l80.733"></a><span id="l80.733" class="difflineplus">+  mdb_token m_AnniversaryMonthColumnToken;</span>
<a href="#l80.734"></a><span id="l80.734" class="difflineplus">+  mdb_token m_AnniversaryDayColumnToken;</span>
<a href="#l80.735"></a><span id="l80.735" class="difflineplus">+  mdb_token m_SpouseNameColumnToken;</span>
<a href="#l80.736"></a><span id="l80.736" class="difflineplus">+  mdb_token m_FamilyNameColumnToken;</span>
<a href="#l80.737"></a><span id="l80.737" class="difflineplus">+  mdb_token m_DefaultAddressColumnToken;</span>
<a href="#l80.738"></a><span id="l80.738" class="difflineplus">+  mdb_token m_CategoryColumnToken;</span>
<a href="#l80.739"></a><span id="l80.739" class="difflineplus">+  mdb_token m_WebPage1ColumnToken;</span>
<a href="#l80.740"></a><span id="l80.740" class="difflineplus">+  mdb_token m_WebPage2ColumnToken;</span>
<a href="#l80.741"></a><span id="l80.741" class="difflineplus">+  mdb_token m_BirthYearColumnToken;</span>
<a href="#l80.742"></a><span id="l80.742" class="difflineplus">+  mdb_token m_BirthMonthColumnToken;</span>
<a href="#l80.743"></a><span id="l80.743" class="difflineplus">+  mdb_token m_BirthDayColumnToken;</span>
<a href="#l80.744"></a><span id="l80.744" class="difflineplus">+  mdb_token m_Custom1ColumnToken;</span>
<a href="#l80.745"></a><span id="l80.745" class="difflineplus">+  mdb_token m_Custom2ColumnToken;</span>
<a href="#l80.746"></a><span id="l80.746" class="difflineplus">+  mdb_token m_Custom3ColumnToken;</span>
<a href="#l80.747"></a><span id="l80.747" class="difflineplus">+  mdb_token m_Custom4ColumnToken;</span>
<a href="#l80.748"></a><span id="l80.748" class="difflineplus">+  mdb_token m_NotesColumnToken;</span>
<a href="#l80.749"></a><span id="l80.749" class="difflineplus">+  mdb_token m_LastModDateColumnToken;</span>
<a href="#l80.750"></a><span id="l80.750" class="difflineplus">+  mdb_token m_RecordKeyColumnToken;</span>
<a href="#l80.751"></a><span id="l80.751" class="difflineplus">+  mdb_token m_LowerPriEmailColumnToken;</span>
<a href="#l80.752"></a><span id="l80.752" class="difflineplus">+  mdb_token m_Lower2ndEmailColumnToken;</span>
<a href="#l80.753"></a><span id="l80.753"> </span>
<a href="#l80.754"></a><span id="l80.754" class="difflineminus">-  mdb_token      m_MailFormatColumnToken;</span>
<a href="#l80.755"></a><span id="l80.755" class="difflineminus">-  mdb_token     m_PopularityIndexColumnToken;</span>
<a href="#l80.756"></a><span id="l80.756" class="difflineplus">+  mdb_token m_MailFormatColumnToken;</span>
<a href="#l80.757"></a><span id="l80.757" class="difflineplus">+  mdb_token m_PopularityIndexColumnToken;</span>
<a href="#l80.758"></a><span id="l80.758"> </span>
<a href="#l80.759"></a><span id="l80.759" class="difflineminus">-  mdb_token      m_AddressCharSetColumnToken;</span>
<a href="#l80.760"></a><span id="l80.760" class="difflineminus">-  mdb_token      m_LastRecordKeyColumnToken;</span>
<a href="#l80.761"></a><span id="l80.761" class="difflineplus">+  mdb_token m_AddressCharSetColumnToken;</span>
<a href="#l80.762"></a><span id="l80.762" class="difflineplus">+  mdb_token m_LastRecordKeyColumnToken;</span>
<a href="#l80.763"></a><span id="l80.763"> </span>
<a href="#l80.764"></a><span id="l80.764" class="difflineminus">-  mdb_token      m_ListNameColumnToken;</span>
<a href="#l80.765"></a><span id="l80.765" class="difflineminus">-  mdb_token      m_ListNickNameColumnToken;</span>
<a href="#l80.766"></a><span id="l80.766" class="difflineminus">-  mdb_token      m_ListDescriptionColumnToken;</span>
<a href="#l80.767"></a><span id="l80.767" class="difflineminus">-  mdb_token      m_ListTotalColumnToken;</span>
<a href="#l80.768"></a><span id="l80.768" class="difflineminus">-  mdb_token      m_LowerListNameColumnToken;</span>
<a href="#l80.769"></a><span id="l80.769" class="difflineplus">+  mdb_token m_ListNameColumnToken;</span>
<a href="#l80.770"></a><span id="l80.770" class="difflineplus">+  mdb_token m_ListNickNameColumnToken;</span>
<a href="#l80.771"></a><span id="l80.771" class="difflineplus">+  mdb_token m_ListDescriptionColumnToken;</span>
<a href="#l80.772"></a><span id="l80.772" class="difflineplus">+  mdb_token m_ListTotalColumnToken;</span>
<a href="#l80.773"></a><span id="l80.773" class="difflineplus">+  mdb_token m_LowerListNameColumnToken;</span>
<a href="#l80.774"></a><span id="l80.774"> </span>
<a href="#l80.775"></a><span id="l80.775" class="difflineminus">-  uint32_t      m_LastRecordKey;</span>
<a href="#l80.776"></a><span id="l80.776" class="difflineplus">+  uint32_t m_LastRecordKey;</span>
<a href="#l80.777"></a><span id="l80.777">   nsWeakPtr m_dbDirectory;</span>
<a href="#l80.778"></a><span id="l80.778">   nsCOMPtr&lt;nsIMdbFactory&gt; mMdbFactory;</span>
<a href="#l80.779"></a><span id="l80.779"> </span>
<a href="#l80.780"></a><span id="l80.780" class="difflineminus">-private:</span>
<a href="#l80.781"></a><span id="l80.781" class="difflineplus">+ private:</span>
<a href="#l80.782"></a><span id="l80.782">   nsresult GetRowForCharColumn(const char16_t *unicodeStr,</span>
<a href="#l80.783"></a><span id="l80.783">                                mdb_column findColumn, bool bIsCard,</span>
<a href="#l80.784"></a><span id="l80.784">                                bool aCaseInsensitive, nsIMdbRow **findRow,</span>
<a href="#l80.785"></a><span id="l80.785">                                mdb_pos *aRowPos);</span>
<a href="#l80.786"></a><span id="l80.786" class="difflineminus">-  bool HasRowForCharColumn(const char16_t *unicodeStr, mdb_column findColumn, bool aIsCard, nsIMdbRow **aFindRow);</span>
<a href="#l80.787"></a><span id="l80.787" class="difflineminus">-  nsresult OpenInternal(nsIFile *aMabFile, bool aCreate, nsIAddrDatabase **pCardDB);</span>
<a href="#l80.788"></a><span id="l80.788" class="difflineminus">-  nsresult AlertAboutCorruptMabFile(const char16_t *aOldFileName, const char16_t *aNewFileName);</span>
<a href="#l80.789"></a><span id="l80.789" class="difflineplus">+  bool HasRowForCharColumn(const char16_t *unicodeStr, mdb_column findColumn,</span>
<a href="#l80.790"></a><span id="l80.790" class="difflineplus">+                           bool aIsCard, nsIMdbRow **aFindRow);</span>
<a href="#l80.791"></a><span id="l80.791" class="difflineplus">+  nsresult OpenInternal(nsIFile *aMabFile, bool aCreate,</span>
<a href="#l80.792"></a><span id="l80.792" class="difflineplus">+                        nsIAddrDatabase **pCardDB);</span>
<a href="#l80.793"></a><span id="l80.793" class="difflineplus">+  nsresult AlertAboutCorruptMabFile(const char16_t *aOldFileName,</span>
<a href="#l80.794"></a><span id="l80.794" class="difflineplus">+                                    const char16_t *aNewFileName);</span>
<a href="#l80.795"></a><span id="l80.795">   nsresult AlertAboutLockedMabFile(const char16_t *aFileName);</span>
<a href="#l80.796"></a><span id="l80.796" class="difflineminus">-  nsresult DisplayAlert(const char16_t *titleName, const char16_t *alertStringName,</span>
<a href="#l80.797"></a><span id="l80.797" class="difflineminus">-                        const char16_t **formatStrings, int32_t numFormatStrings);</span>
<a href="#l80.798"></a><span id="l80.798" class="difflineplus">+  nsresult DisplayAlert(const char16_t *titleName,</span>
<a href="#l80.799"></a><span id="l80.799" class="difflineplus">+                        const char16_t *alertStringName,</span>
<a href="#l80.800"></a><span id="l80.800" class="difflineplus">+                        const char16_t **formatStrings,</span>
<a href="#l80.801"></a><span id="l80.801" class="difflineplus">+                        int32_t numFormatStrings);</span>
<a href="#l80.802"></a><span id="l80.802"> };</span>
<a href="#l80.803"></a><span id="l80.803"> </span>
<a href="#l80.804"></a><span id="l80.804"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -15,17 +15,17 @@</span>
<a href="#l81.4"></a><span id="l81.4"> #include &quot;nsMemory.h&quot;</span>
<a href="#l81.5"></a><span id="l81.5"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l81.6"></a><span id="l81.6"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l81.7"></a><span id="l81.7"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l81.8"></a><span id="l81.8"> #include &quot;nsIFile.h&quot;</span>
<a href="#l81.9"></a><span id="l81.9"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l81.10"></a><span id="l81.10"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l81.11"></a><span id="l81.11"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-#include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+#  include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l81.14"></a><span id="l81.14"> #endif</span>
<a href="#l81.15"></a><span id="l81.15"> #include &quot;prmem.h&quot;</span>
<a href="#l81.16"></a><span id="l81.16"> #include &quot;prprf.h&quot;</span>
<a href="#l81.17"></a><span id="l81.17"> #include &quot;plstr.h&quot;</span>
<a href="#l81.18"></a><span id="l81.18"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l81.19"></a><span id="l81.19"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l81.20"></a><span id="l81.20"> #include &quot;msgCore.h&quot;</span>
<a href="#l81.21"></a><span id="l81.21"> #include &quot;nsString.h&quot;</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineat">@@ -33,285 +33,266 @@</span>
<a href="#l81.23"></a><span id="l81.23"> #include &lt;ctype.h&gt;</span>
<a href="#l81.24"></a><span id="l81.24"> </span>
<a href="#l81.25"></a><span id="l81.25"> /*****************************************************************************</span>
<a href="#l81.26"></a><span id="l81.26">  * Private definitions</span>
<a href="#l81.27"></a><span id="l81.27">  */</span>
<a href="#l81.28"></a><span id="l81.28"> </span>
<a href="#l81.29"></a><span id="l81.29"> /* Default settings for site-configurable prefs */</span>
<a href="#l81.30"></a><span id="l81.30"> #define kDefaultPosition 1</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineminus">-static bool dir_IsServerDeleted(DIR_Server * server);</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+static bool dir_IsServerDeleted(DIR_Server *server);</span>
<a href="#l81.33"></a><span id="l81.33"> </span>
<a href="#l81.34"></a><span id="l81.34" class="difflineminus">-static char *DIR_GetStringPref(const char *prefRoot, const char *prefLeaf, const char *defaultValue);</span>
<a href="#l81.35"></a><span id="l81.35" class="difflineminus">-static int32_t DIR_GetIntPref(const char *prefRoot, const char *prefLeaf, int32_t defaultValue);</span>
<a href="#l81.36"></a><span id="l81.36" class="difflineminus">-static char *DIR_GetLocalizedStringPref(const char *prefRoot, const char *prefLeaf);</span>
<a href="#l81.37"></a><span id="l81.37" class="difflineplus">+static char *DIR_GetStringPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l81.38"></a><span id="l81.38" class="difflineplus">+                               const char *defaultValue);</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineplus">+static int32_t DIR_GetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l81.40"></a><span id="l81.40" class="difflineplus">+                              int32_t defaultValue);</span>
<a href="#l81.41"></a><span id="l81.41" class="difflineplus">+static char *DIR_GetLocalizedStringPref(const char *prefRoot,</span>
<a href="#l81.42"></a><span id="l81.42" class="difflineplus">+                                        const char *prefLeaf);</span>
<a href="#l81.43"></a><span id="l81.43"> </span>
<a href="#l81.44"></a><span id="l81.44" class="difflineminus">-static char * dir_ConvertDescriptionToPrefName(DIR_Server * server);</span>
<a href="#l81.45"></a><span id="l81.45" class="difflineplus">+static char *dir_ConvertDescriptionToPrefName(DIR_Server *server);</span>
<a href="#l81.46"></a><span id="l81.46"> </span>
<a href="#l81.47"></a><span id="l81.47" class="difflineminus">-void DIR_SetFileName(char** filename, const char* leafName);</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineminus">-static void DIR_SetIntPref(const char *prefRoot, const char *prefLeaf, int32_t value, int32_t defaultValue);</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineminus">-static DIR_Server *dir_MatchServerPrefToServer(nsTArray&lt;DIR_Server*&gt; *wholeList, const char *pref);</span>
<a href="#l81.50"></a><span id="l81.50" class="difflineminus">-static bool dir_ValidateAndAddNewServer(nsTArray&lt;DIR_Server*&gt; *wholeList, const char *fullprefname);</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineminus">-static void DIR_DeleteServerList(nsTArray&lt;DIR_Server*&gt; *wholeList);</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+void DIR_SetFileName(char **filename, const char *leafName);</span>
<a href="#l81.53"></a><span id="l81.53" class="difflineplus">+static void DIR_SetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l81.54"></a><span id="l81.54" class="difflineplus">+                           int32_t value, int32_t defaultValue);</span>
<a href="#l81.55"></a><span id="l81.55" class="difflineplus">+static DIR_Server *dir_MatchServerPrefToServer(</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineplus">+    nsTArray&lt;DIR_Server *&gt; *wholeList, const char *pref);</span>
<a href="#l81.57"></a><span id="l81.57" class="difflineplus">+static bool dir_ValidateAndAddNewServer(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineplus">+                                        const char *fullprefname);</span>
<a href="#l81.59"></a><span id="l81.59" class="difflineplus">+static void DIR_DeleteServerList(nsTArray&lt;DIR_Server *&gt; *wholeList);</span>
<a href="#l81.60"></a><span id="l81.60"> </span>
<a href="#l81.61"></a><span id="l81.61"> static char *dir_CreateServerPrefName(DIR_Server *server);</span>
<a href="#l81.62"></a><span id="l81.62"> static void DIR_GetPrefsForOneServer(DIR_Server *server);</span>
<a href="#l81.63"></a><span id="l81.63"> </span>
<a href="#l81.64"></a><span id="l81.64" class="difflineminus">-static void DIR_InitServer(DIR_Server *server, DirectoryType dirType = (DirectoryType)0);</span>
<a href="#l81.65"></a><span id="l81.65" class="difflineminus">-static DIR_PrefId  DIR_AtomizePrefName(const char *prefname);</span>
<a href="#l81.66"></a><span id="l81.66" class="difflineplus">+static void DIR_InitServer(DIR_Server *server,</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineplus">+                           DirectoryType dirType = (DirectoryType)0);</span>
<a href="#l81.68"></a><span id="l81.68" class="difflineplus">+static DIR_PrefId DIR_AtomizePrefName(const char *prefname);</span>
<a href="#l81.69"></a><span id="l81.69"> </span>
<a href="#l81.70"></a><span id="l81.70"> const int32_t DIR_POS_APPEND = -1;</span>
<a href="#l81.71"></a><span id="l81.71"> const int32_t DIR_POS_DELETE = -2;</span>
<a href="#l81.72"></a><span id="l81.72" class="difflineminus">-static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server*&gt; *wholeList, DIR_Server *server, int32_t position);</span>
<a href="#l81.73"></a><span id="l81.73" class="difflineplus">+static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l81.74"></a><span id="l81.74" class="difflineplus">+                                  DIR_Server *server, int32_t position);</span>
<a href="#l81.75"></a><span id="l81.75"> </span>
<a href="#l81.76"></a><span id="l81.76"> /* These two routines should be called to initialize and save</span>
<a href="#l81.77"></a><span id="l81.77">  * directory preferences from the XP Java Script preferences</span>
<a href="#l81.78"></a><span id="l81.78">  */</span>
<a href="#l81.79"></a><span id="l81.79" class="difflineminus">-static nsresult DIR_GetServerPreferences(nsTArray&lt;DIR_Server*&gt;** list);</span>
<a href="#l81.80"></a><span id="l81.80" class="difflineminus">-static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server*&gt; *wholeList);</span>
<a href="#l81.81"></a><span id="l81.81" class="difflineplus">+static nsresult DIR_GetServerPreferences(nsTArray&lt;DIR_Server *&gt; **list);</span>
<a href="#l81.82"></a><span id="l81.82" class="difflineplus">+static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server *&gt; *wholeList);</span>
<a href="#l81.83"></a><span id="l81.83"> </span>
<a href="#l81.84"></a><span id="l81.84"> static int32_t dir_UserId = 0;</span>
<a href="#l81.85"></a><span id="l81.85" class="difflineminus">-nsTArray&lt;DIR_Server*&gt; *dir_ServerList = nullptr;</span>
<a href="#l81.86"></a><span id="l81.86" class="difflineplus">+nsTArray&lt;DIR_Server *&gt; *dir_ServerList = nullptr;</span>
<a href="#l81.87"></a><span id="l81.87"> </span>
<a href="#l81.88"></a><span id="l81.88"> /*****************************************************************************</span>
<a href="#l81.89"></a><span id="l81.89">  * Functions for creating the new back end managed DIR_Server list.</span>
<a href="#l81.90"></a><span id="l81.90">  */</span>
<a href="#l81.91"></a><span id="l81.91"> class DirPrefObserver final : public nsSupportsWeakReference,</span>
<a href="#l81.92"></a><span id="l81.92" class="difflineminus">-                              public nsIObserver</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineminus">-{</span>
<a href="#l81.94"></a><span id="l81.94" class="difflineminus">-public:</span>
<a href="#l81.95"></a><span id="l81.95" class="difflineplus">+                              public nsIObserver {</span>
<a href="#l81.96"></a><span id="l81.96" class="difflineplus">+ public:</span>
<a href="#l81.97"></a><span id="l81.97">   NS_DECL_ISUPPORTS</span>
<a href="#l81.98"></a><span id="l81.98">   NS_DECL_NSIOBSERVER</span>
<a href="#l81.99"></a><span id="l81.99"> </span>
<a href="#l81.100"></a><span id="l81.100" class="difflineminus">-private:</span>
<a href="#l81.101"></a><span id="l81.101" class="difflineplus">+ private:</span>
<a href="#l81.102"></a><span id="l81.102">   ~DirPrefObserver() {}</span>
<a href="#l81.103"></a><span id="l81.103"> };</span>
<a href="#l81.104"></a><span id="l81.104"> </span>
<a href="#l81.105"></a><span id="l81.105"> NS_IMPL_ISUPPORTS(DirPrefObserver, nsISupportsWeakReference, nsIObserver)</span>
<a href="#l81.106"></a><span id="l81.106"> </span>
<a href="#l81.107"></a><span id="l81.107" class="difflineminus">-NS_IMETHODIMP DirPrefObserver::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *aData)</span>
<a href="#l81.108"></a><span id="l81.108" class="difflineminus">-{</span>
<a href="#l81.109"></a><span id="l81.109" class="difflineplus">+NS_IMETHODIMP DirPrefObserver::Observe(nsISupports *aSubject,</span>
<a href="#l81.110"></a><span id="l81.110" class="difflineplus">+                                       const char *aTopic,</span>
<a href="#l81.111"></a><span id="l81.111" class="difflineplus">+                                       const char16_t *aData) {</span>
<a href="#l81.112"></a><span id="l81.112">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_QueryInterface(aSubject));</span>
<a href="#l81.113"></a><span id="l81.113">   nsCString strPrefName;</span>
<a href="#l81.114"></a><span id="l81.114">   strPrefName.Assign(NS_ConvertUTF16toUTF8(aData));</span>
<a href="#l81.115"></a><span id="l81.115">   const char *prefname = strPrefName.get();</span>
<a href="#l81.116"></a><span id="l81.116"> </span>
<a href="#l81.117"></a><span id="l81.117">   DIR_PrefId id = DIR_AtomizePrefName(prefname);</span>
<a href="#l81.118"></a><span id="l81.118"> </span>
<a href="#l81.119"></a><span id="l81.119">   // Just get out if we get nothing here - we don't need to do anything</span>
<a href="#l81.120"></a><span id="l81.120" class="difflineminus">-  if (id == idNone)</span>
<a href="#l81.121"></a><span id="l81.121" class="difflineminus">-    return NS_OK;</span>
<a href="#l81.122"></a><span id="l81.122" class="difflineplus">+  if (id == idNone) return NS_OK;</span>
<a href="#l81.123"></a><span id="l81.123"> </span>
<a href="#l81.124"></a><span id="l81.124">   /* Check to see if the server is in the unified server list.</span>
<a href="#l81.125"></a><span id="l81.125">    */</span>
<a href="#l81.126"></a><span id="l81.126">   DIR_Server *server = dir_MatchServerPrefToServer(dir_ServerList, prefname);</span>
<a href="#l81.127"></a><span id="l81.127" class="difflineminus">-  if (server)</span>
<a href="#l81.128"></a><span id="l81.128" class="difflineminus">-  {</span>
<a href="#l81.129"></a><span id="l81.129" class="difflineplus">+  if (server) {</span>
<a href="#l81.130"></a><span id="l81.130">     /* If the server is in the process of being saved, just ignore this</span>
<a href="#l81.131"></a><span id="l81.131">      * change.  The DIR_Server structure is not really changing.</span>
<a href="#l81.132"></a><span id="l81.132">      */</span>
<a href="#l81.133"></a><span id="l81.133" class="difflineminus">-    if (server-&gt;savingServer)</span>
<a href="#l81.134"></a><span id="l81.134" class="difflineminus">-      return NS_OK;</span>
<a href="#l81.135"></a><span id="l81.135" class="difflineplus">+    if (server-&gt;savingServer) return NS_OK;</span>
<a href="#l81.136"></a><span id="l81.136"> </span>
<a href="#l81.137"></a><span id="l81.137">     /* If the pref that changed is the position, read it in.  If the new</span>
<a href="#l81.138"></a><span id="l81.138">      * position is zero, remove the server from the list.</span>
<a href="#l81.139"></a><span id="l81.139">      */</span>
<a href="#l81.140"></a><span id="l81.140" class="difflineminus">-    if (id == idPosition)</span>
<a href="#l81.141"></a><span id="l81.141" class="difflineminus">-    {</span>
<a href="#l81.142"></a><span id="l81.142" class="difflineplus">+    if (id == idPosition) {</span>
<a href="#l81.143"></a><span id="l81.143">       int32_t position;</span>
<a href="#l81.144"></a><span id="l81.144"> </span>
<a href="#l81.145"></a><span id="l81.145">       /* We must not do anything if the new position is the same as the</span>
<a href="#l81.146"></a><span id="l81.146">        * position in the DIR_Server.  This avoids recursion in cases</span>
<a href="#l81.147"></a><span id="l81.147">        * where we are deleting the server.</span>
<a href="#l81.148"></a><span id="l81.148">        */</span>
<a href="#l81.149"></a><span id="l81.149">       prefBranch-&gt;GetIntPref(prefname, &amp;position);</span>
<a href="#l81.150"></a><span id="l81.150" class="difflineminus">-      if (position != server-&gt;position)</span>
<a href="#l81.151"></a><span id="l81.151" class="difflineminus">-      {</span>
<a href="#l81.152"></a><span id="l81.152" class="difflineplus">+      if (position != server-&gt;position) {</span>
<a href="#l81.153"></a><span id="l81.153">         server-&gt;position = position;</span>
<a href="#l81.154"></a><span id="l81.154">         if (dir_IsServerDeleted(server))</span>
<a href="#l81.155"></a><span id="l81.155">           DIR_SetServerPosition(dir_ServerList, server, DIR_POS_DELETE);</span>
<a href="#l81.156"></a><span id="l81.156">       }</span>
<a href="#l81.157"></a><span id="l81.157">     }</span>
<a href="#l81.158"></a><span id="l81.158"> </span>
<a href="#l81.159"></a><span id="l81.159">     if (id == idDescription) {</span>
<a href="#l81.160"></a><span id="l81.160">       // Ensure the local copy of the description is kept up to date.</span>
<a href="#l81.161"></a><span id="l81.161">       PR_FREEIF(server-&gt;description);</span>
<a href="#l81.162"></a><span id="l81.162">       server-&gt;description = DIR_GetLocalizedStringPref(prefname, nullptr);</span>
<a href="#l81.163"></a><span id="l81.163">     }</span>
<a href="#l81.164"></a><span id="l81.164">   }</span>
<a href="#l81.165"></a><span id="l81.165">   /* If the server is not in the unified list, we may need to add it.  Servers</span>
<a href="#l81.166"></a><span id="l81.166">    * are only added when the position, serverName and description are valid.</span>
<a href="#l81.167"></a><span id="l81.167">    */</span>
<a href="#l81.168"></a><span id="l81.168" class="difflineminus">-  else if (id == idPosition || id == idType || id == idDescription)</span>
<a href="#l81.169"></a><span id="l81.169" class="difflineminus">-  {</span>
<a href="#l81.170"></a><span id="l81.170" class="difflineplus">+  else if (id == idPosition || id == idType || id == idDescription) {</span>
<a href="#l81.171"></a><span id="l81.171">     dir_ValidateAndAddNewServer(dir_ServerList, prefname);</span>
<a href="#l81.172"></a><span id="l81.172">   }</span>
<a href="#l81.173"></a><span id="l81.173"> </span>
<a href="#l81.174"></a><span id="l81.174">   return NS_OK;</span>
<a href="#l81.175"></a><span id="l81.175"> }</span>
<a href="#l81.176"></a><span id="l81.176"> </span>
<a href="#l81.177"></a><span id="l81.177"> // A pointer to the pref observer</span>
<a href="#l81.178"></a><span id="l81.178"> static RefPtr&lt;DirPrefObserver&gt; prefObserver;</span>
<a href="#l81.179"></a><span id="l81.179"> </span>
<a href="#l81.180"></a><span id="l81.180" class="difflineminus">-static nsresult DIR_GetDirServers()</span>
<a href="#l81.181"></a><span id="l81.181" class="difflineminus">-{</span>
<a href="#l81.182"></a><span id="l81.182" class="difflineplus">+static nsresult DIR_GetDirServers() {</span>
<a href="#l81.183"></a><span id="l81.183">   nsresult rv = NS_OK;</span>
<a href="#l81.184"></a><span id="l81.184"> </span>
<a href="#l81.185"></a><span id="l81.185" class="difflineminus">-  if (!dir_ServerList)</span>
<a href="#l81.186"></a><span id="l81.186" class="difflineminus">-  {</span>
<a href="#l81.187"></a><span id="l81.187" class="difflineplus">+  if (!dir_ServerList) {</span>
<a href="#l81.188"></a><span id="l81.188">     /* we need to build the DIR_Server list */</span>
<a href="#l81.189"></a><span id="l81.189">     rv = DIR_GetServerPreferences(&amp;dir_ServerList);</span>
<a href="#l81.190"></a><span id="l81.190"> </span>
<a href="#l81.191"></a><span id="l81.191">     /* Register the preference call back if necessary. */</span>
<a href="#l81.192"></a><span id="l81.192" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !prefObserver)</span>
<a href="#l81.193"></a><span id="l81.193" class="difflineminus">-    {</span>
<a href="#l81.194"></a><span id="l81.194" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; pbi(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.195"></a><span id="l81.195" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l81.196"></a><span id="l81.196" class="difflineminus">-        return rv;</span>
<a href="#l81.197"></a><span id="l81.197" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !prefObserver) {</span>
<a href="#l81.198"></a><span id="l81.198" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; pbi(</span>
<a href="#l81.199"></a><span id="l81.199" class="difflineplus">+          do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.200"></a><span id="l81.200" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l81.201"></a><span id="l81.201">       prefObserver = new DirPrefObserver();</span>
<a href="#l81.202"></a><span id="l81.202"> </span>
<a href="#l81.203"></a><span id="l81.203">       pbi-&gt;AddObserver(PREF_LDAP_SERVER_TREE_NAME, prefObserver, true);</span>
<a href="#l81.204"></a><span id="l81.204">     }</span>
<a href="#l81.205"></a><span id="l81.205">   }</span>
<a href="#l81.206"></a><span id="l81.206">   return rv;</span>
<a href="#l81.207"></a><span id="l81.207"> }</span>
<a href="#l81.208"></a><span id="l81.208"> </span>
<a href="#l81.209"></a><span id="l81.209" class="difflineminus">-nsTArray&lt;DIR_Server*&gt;* DIR_GetDirectories()</span>
<a href="#l81.210"></a><span id="l81.210" class="difflineminus">-{</span>
<a href="#l81.211"></a><span id="l81.211" class="difflineminus">-    if (!dir_ServerList)</span>
<a href="#l81.212"></a><span id="l81.212" class="difflineminus">-        DIR_GetDirServers();</span>
<a href="#l81.213"></a><span id="l81.213" class="difflineplus">+nsTArray&lt;DIR_Server *&gt; *DIR_GetDirectories() {</span>
<a href="#l81.214"></a><span id="l81.214" class="difflineplus">+  if (!dir_ServerList) DIR_GetDirServers();</span>
<a href="#l81.215"></a><span id="l81.215">   return dir_ServerList;</span>
<a href="#l81.216"></a><span id="l81.216"> }</span>
<a href="#l81.217"></a><span id="l81.217"> </span>
<a href="#l81.218"></a><span id="l81.218" class="difflineminus">-DIR_Server* DIR_GetServerFromList(const char* prefName)</span>
<a href="#l81.219"></a><span id="l81.219" class="difflineminus">-{</span>
<a href="#l81.220"></a><span id="l81.220" class="difflineminus">-  DIR_Server* result = nullptr;</span>
<a href="#l81.221"></a><span id="l81.221" class="difflineplus">+DIR_Server *DIR_GetServerFromList(const char *prefName) {</span>
<a href="#l81.222"></a><span id="l81.222" class="difflineplus">+  DIR_Server *result = nullptr;</span>
<a href="#l81.223"></a><span id="l81.223"> </span>
<a href="#l81.224"></a><span id="l81.224" class="difflineminus">-  if (!dir_ServerList)</span>
<a href="#l81.225"></a><span id="l81.225" class="difflineminus">-    DIR_GetDirServers();</span>
<a href="#l81.226"></a><span id="l81.226" class="difflineplus">+  if (!dir_ServerList) DIR_GetDirServers();</span>
<a href="#l81.227"></a><span id="l81.227"> </span>
<a href="#l81.228"></a><span id="l81.228" class="difflineminus">-  if (dir_ServerList)</span>
<a href="#l81.229"></a><span id="l81.229" class="difflineminus">-  {</span>
<a href="#l81.230"></a><span id="l81.230" class="difflineplus">+  if (dir_ServerList) {</span>
<a href="#l81.231"></a><span id="l81.231">     int32_t count = dir_ServerList-&gt;Length();</span>
<a href="#l81.232"></a><span id="l81.232">     int32_t i;</span>
<a href="#l81.233"></a><span id="l81.233" class="difflineminus">-    for (i = 0; i &lt; count; ++i)</span>
<a href="#l81.234"></a><span id="l81.234" class="difflineminus">-    {</span>
<a href="#l81.235"></a><span id="l81.235" class="difflineplus">+    for (i = 0; i &lt; count; ++i) {</span>
<a href="#l81.236"></a><span id="l81.236">       DIR_Server *server = dir_ServerList-&gt;ElementAt(i);</span>
<a href="#l81.237"></a><span id="l81.237"> </span>
<a href="#l81.238"></a><span id="l81.238" class="difflineminus">-      if (server &amp;&amp; strcmp(server-&gt;prefName, prefName) == 0)</span>
<a href="#l81.239"></a><span id="l81.239" class="difflineminus">-      {</span>
<a href="#l81.240"></a><span id="l81.240" class="difflineplus">+      if (server &amp;&amp; strcmp(server-&gt;prefName, prefName) == 0) {</span>
<a href="#l81.241"></a><span id="l81.241">         result = server;</span>
<a href="#l81.242"></a><span id="l81.242">         break;</span>
<a href="#l81.243"></a><span id="l81.243">       }</span>
<a href="#l81.244"></a><span id="l81.244">     }</span>
<a href="#l81.245"></a><span id="l81.245">   }</span>
<a href="#l81.246"></a><span id="l81.246">   return result;</span>
<a href="#l81.247"></a><span id="l81.247"> }</span>
<a href="#l81.248"></a><span id="l81.248"> </span>
<a href="#l81.249"></a><span id="l81.249" class="difflineminus">-static nsresult SavePrefsFile()</span>
<a href="#l81.250"></a><span id="l81.250" class="difflineminus">-{</span>
<a href="#l81.251"></a><span id="l81.251" class="difflineplus">+static nsresult SavePrefsFile() {</span>
<a href="#l81.252"></a><span id="l81.252">   nsresult rv;</span>
<a href="#l81.253"></a><span id="l81.253">   nsCOMPtr&lt;nsIPrefService&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.254"></a><span id="l81.254" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.255"></a><span id="l81.255" class="difflineminus">-    return rv;</span>
<a href="#l81.256"></a><span id="l81.256" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l81.257"></a><span id="l81.257">   return pPref-&gt;SavePrefFile(nullptr);</span>
<a href="#l81.258"></a><span id="l81.258"> }</span>
<a href="#l81.259"></a><span id="l81.259"> </span>
<a href="#l81.260"></a><span id="l81.260" class="difflineminus">-nsresult DIR_ShutDown()  /* FEs should call this when the app is shutting down. It frees all DIR_Servers regardless of ref count values! */</span>
<a href="#l81.261"></a><span id="l81.261" class="difflineplus">+nsresult</span>
<a href="#l81.262"></a><span id="l81.262" class="difflineplus">+DIR_ShutDown() /* FEs should call this when the app is shutting down. It frees</span>
<a href="#l81.263"></a><span id="l81.263" class="difflineplus">+                  all DIR_Servers regardless of ref count values! */</span>
<a href="#l81.264"></a><span id="l81.264"> {</span>
<a href="#l81.265"></a><span id="l81.265">   nsresult rv = SavePrefsFile();</span>
<a href="#l81.266"></a><span id="l81.266">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l81.267"></a><span id="l81.267"> </span>
<a href="#l81.268"></a><span id="l81.268">   DIR_DeleteServerList(dir_ServerList);</span>
<a href="#l81.269"></a><span id="l81.269">   dir_ServerList = nullptr;</span>
<a href="#l81.270"></a><span id="l81.270"> </span>
<a href="#l81.271"></a><span id="l81.271">   /* unregister the preference call back, if necessary.</span>
<a href="#l81.272"></a><span id="l81.272" class="difflineminus">-  * we need to do this as DIR_Shutdown() is called when switching profiles</span>
<a href="#l81.273"></a><span id="l81.273" class="difflineminus">-  * when using turbo.  (see nsAbDirectoryDataSource::Observe())</span>
<a href="#l81.274"></a><span id="l81.274" class="difflineminus">-  * When switching profiles, prefs get unloaded and then re-loaded</span>
<a href="#l81.275"></a><span id="l81.275" class="difflineminus">-  * we don't want our callback to get called for all that.</span>
<a href="#l81.276"></a><span id="l81.276" class="difflineminus">-  * We'll reset our callback the first time DIR_GetDirServers() is called</span>
<a href="#l81.277"></a><span id="l81.277" class="difflineminus">-  * after we've switched profiles.</span>
<a href="#l81.278"></a><span id="l81.278" class="difflineminus">-  */</span>
<a href="#l81.279"></a><span id="l81.279" class="difflineplus">+   * we need to do this as DIR_Shutdown() is called when switching profiles</span>
<a href="#l81.280"></a><span id="l81.280" class="difflineplus">+   * when using turbo.  (see nsAbDirectoryDataSource::Observe())</span>
<a href="#l81.281"></a><span id="l81.281" class="difflineplus">+   * When switching profiles, prefs get unloaded and then re-loaded</span>
<a href="#l81.282"></a><span id="l81.282" class="difflineplus">+   * we don't want our callback to get called for all that.</span>
<a href="#l81.283"></a><span id="l81.283" class="difflineplus">+   * We'll reset our callback the first time DIR_GetDirServers() is called</span>
<a href="#l81.284"></a><span id="l81.284" class="difflineplus">+   * after we've switched profiles.</span>
<a href="#l81.285"></a><span id="l81.285" class="difflineplus">+   */</span>
<a href="#l81.286"></a><span id="l81.286">   prefObserver = nullptr;</span>
<a href="#l81.287"></a><span id="l81.287"> </span>
<a href="#l81.288"></a><span id="l81.288">   return NS_OK;</span>
<a href="#l81.289"></a><span id="l81.289"> }</span>
<a href="#l81.290"></a><span id="l81.290"> </span>
<a href="#l81.291"></a><span id="l81.291" class="difflineminus">-nsresult DIR_ContainsServer(DIR_Server* pServer, bool *hasDir)</span>
<a href="#l81.292"></a><span id="l81.292" class="difflineminus">-{</span>
<a href="#l81.293"></a><span id="l81.293" class="difflineminus">-  if (dir_ServerList)</span>
<a href="#l81.294"></a><span id="l81.294" class="difflineminus">-  {</span>
<a href="#l81.295"></a><span id="l81.295" class="difflineplus">+nsresult DIR_ContainsServer(DIR_Server *pServer, bool *hasDir) {</span>
<a href="#l81.296"></a><span id="l81.296" class="difflineplus">+  if (dir_ServerList) {</span>
<a href="#l81.297"></a><span id="l81.297">     int32_t count = dir_ServerList-&gt;Length();</span>
<a href="#l81.298"></a><span id="l81.298">     int32_t i;</span>
<a href="#l81.299"></a><span id="l81.299" class="difflineminus">-    for (i = 0; i &lt; count; i++)</span>
<a href="#l81.300"></a><span id="l81.300" class="difflineminus">-    {</span>
<a href="#l81.301"></a><span id="l81.301" class="difflineminus">-      DIR_Server* server = dir_ServerList-&gt;ElementAt(i);</span>
<a href="#l81.302"></a><span id="l81.302" class="difflineminus">-      if (server == pServer)</span>
<a href="#l81.303"></a><span id="l81.303" class="difflineminus">-      {</span>
<a href="#l81.304"></a><span id="l81.304" class="difflineplus">+    for (i = 0; i &lt; count; i++) {</span>
<a href="#l81.305"></a><span id="l81.305" class="difflineplus">+      DIR_Server *server = dir_ServerList-&gt;ElementAt(i);</span>
<a href="#l81.306"></a><span id="l81.306" class="difflineplus">+      if (server == pServer) {</span>
<a href="#l81.307"></a><span id="l81.307">         *hasDir = true;</span>
<a href="#l81.308"></a><span id="l81.308">         return NS_OK;</span>
<a href="#l81.309"></a><span id="l81.309">       }</span>
<a href="#l81.310"></a><span id="l81.310">     }</span>
<a href="#l81.311"></a><span id="l81.311">   }</span>
<a href="#l81.312"></a><span id="l81.312">   *hasDir = false;</span>
<a href="#l81.313"></a><span id="l81.313">   return NS_OK;</span>
<a href="#l81.314"></a><span id="l81.314"> }</span>
<a href="#l81.315"></a><span id="l81.315"> </span>
<a href="#l81.316"></a><span id="l81.316"> nsresult DIR_AddNewAddressBook(const nsAString &amp;dirName,</span>
<a href="#l81.317"></a><span id="l81.317">                                const nsACString &amp;fileName,</span>
<a href="#l81.318"></a><span id="l81.318" class="difflineminus">-                               const nsACString &amp;uri,</span>
<a href="#l81.319"></a><span id="l81.319" class="difflineminus">-                               DirectoryType dirType,</span>
<a href="#l81.320"></a><span id="l81.320" class="difflineplus">+                               const nsACString &amp;uri, DirectoryType dirType,</span>
<a href="#l81.321"></a><span id="l81.321">                                const nsACString &amp;prefName,</span>
<a href="#l81.322"></a><span id="l81.322" class="difflineminus">-                               DIR_Server** pServer)</span>
<a href="#l81.323"></a><span id="l81.323" class="difflineminus">-{</span>
<a href="#l81.324"></a><span id="l81.324" class="difflineminus">-  DIR_Server * server = (DIR_Server *) PR_Malloc(sizeof(DIR_Server));</span>
<a href="#l81.325"></a><span id="l81.325" class="difflineminus">-  if (!server)</span>
<a href="#l81.326"></a><span id="l81.326" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l81.327"></a><span id="l81.327" class="difflineplus">+                               DIR_Server **pServer) {</span>
<a href="#l81.328"></a><span id="l81.328" class="difflineplus">+  DIR_Server *server = (DIR_Server *)PR_Malloc(sizeof(DIR_Server));</span>
<a href="#l81.329"></a><span id="l81.329" class="difflineplus">+  if (!server) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l81.330"></a><span id="l81.330"> </span>
<a href="#l81.331"></a><span id="l81.331">   DIR_InitServer(server, dirType);</span>
<a href="#l81.332"></a><span id="l81.332" class="difflineminus">-  if (!dir_ServerList)</span>
<a href="#l81.333"></a><span id="l81.333" class="difflineminus">-    DIR_GetDirServers();</span>
<a href="#l81.334"></a><span id="l81.334" class="difflineminus">-  if (dir_ServerList)</span>
<a href="#l81.335"></a><span id="l81.335" class="difflineminus">-  {</span>
<a href="#l81.336"></a><span id="l81.336" class="difflineplus">+  if (!dir_ServerList) DIR_GetDirServers();</span>
<a href="#l81.337"></a><span id="l81.337" class="difflineplus">+  if (dir_ServerList) {</span>
<a href="#l81.338"></a><span id="l81.338">     server-&gt;description = ToNewCString(NS_ConvertUTF16toUTF8(dirName));</span>
<a href="#l81.339"></a><span id="l81.339" class="difflineminus">-    server-&gt;position = kDefaultPosition; // don't set position so alphabetic sort will happen.</span>
<a href="#l81.340"></a><span id="l81.340" class="difflineplus">+    server-&gt;position =</span>
<a href="#l81.341"></a><span id="l81.341" class="difflineplus">+        kDefaultPosition;  // don't set position so alphabetic sort will happen.</span>
<a href="#l81.342"></a><span id="l81.342"> </span>
<a href="#l81.343"></a><span id="l81.343">     if (!fileName.IsEmpty())</span>
<a href="#l81.344"></a><span id="l81.344">       server-&gt;fileName = ToNewCString(fileName);</span>
<a href="#l81.345"></a><span id="l81.345">     else if (dirType == PABDirectory)</span>
<a href="#l81.346"></a><span id="l81.346">       DIR_SetFileName(&amp;server-&gt;fileName, kPersonalAddressbook);</span>
<a href="#l81.347"></a><span id="l81.347">     else if (dirType == LDAPDirectory)</span>
<a href="#l81.348"></a><span id="l81.348">       DIR_SetFileName(&amp;server-&gt;fileName, kMainLdapAddressBook);</span>
<a href="#l81.349"></a><span id="l81.349"> </span>
<a href="#l81.350"></a><span id="l81.350">     if (dirType != PABDirectory) {</span>
<a href="#l81.351"></a><span id="l81.351" class="difflineminus">-      if (!uri.IsEmpty())</span>
<a href="#l81.352"></a><span id="l81.352" class="difflineminus">-        server-&gt;uri = ToNewCString(uri);</span>
<a href="#l81.353"></a><span id="l81.353" class="difflineplus">+      if (!uri.IsEmpty()) server-&gt;uri = ToNewCString(uri);</span>
<a href="#l81.354"></a><span id="l81.354">     }</span>
<a href="#l81.355"></a><span id="l81.355"> </span>
<a href="#l81.356"></a><span id="l81.356" class="difflineminus">-    if (!prefName.IsEmpty())</span>
<a href="#l81.357"></a><span id="l81.357" class="difflineminus">-      server-&gt;prefName = ToNewCString(prefName);</span>
<a href="#l81.358"></a><span id="l81.358" class="difflineplus">+    if (!prefName.IsEmpty()) server-&gt;prefName = ToNewCString(prefName);</span>
<a href="#l81.359"></a><span id="l81.359"> </span>
<a href="#l81.360"></a><span id="l81.360">     dir_ServerList-&gt;AppendElement(server);</span>
<a href="#l81.361"></a><span id="l81.361"> </span>
<a href="#l81.362"></a><span id="l81.362">     DIR_SavePrefsForOneServer(server);</span>
<a href="#l81.363"></a><span id="l81.363"> </span>
<a href="#l81.364"></a><span id="l81.364">     *pServer = server;</span>
<a href="#l81.365"></a><span id="l81.365"> </span>
<a href="#l81.366"></a><span id="l81.366">     // save new address book into pref file</span>
<a href="#l81.367"></a><span id="l81.367">     return SavePrefsFile();</span>
<a href="#l81.368"></a><span id="l81.368">   }</span>
<a href="#l81.369"></a><span id="l81.369">   return NS_ERROR_FAILURE;</span>
<a href="#l81.370"></a><span id="l81.370"> }</span>
<a href="#l81.371"></a><span id="l81.371"> </span>
<a href="#l81.372"></a><span id="l81.372"> /*****************************************************************************</span>
<a href="#l81.373"></a><span id="l81.373">  * Functions for creating DIR_Servers</span>
<a href="#l81.374"></a><span id="l81.374">  */</span>
<a href="#l81.375"></a><span id="l81.375" class="difflineminus">-static void DIR_InitServer(DIR_Server *server, DirectoryType dirType)</span>
<a href="#l81.376"></a><span id="l81.376" class="difflineminus">-{</span>
<a href="#l81.377"></a><span id="l81.377" class="difflineplus">+static void DIR_InitServer(DIR_Server *server, DirectoryType dirType) {</span>
<a href="#l81.378"></a><span id="l81.378">   if (!server) {</span>
<a href="#l81.379"></a><span id="l81.379">     NS_WARNING(&quot;DIR_InitServer: server parameter not initialized&quot;);</span>
<a href="#l81.380"></a><span id="l81.380">     return;</span>
<a href="#l81.381"></a><span id="l81.381">   }</span>
<a href="#l81.382"></a><span id="l81.382"> </span>
<a href="#l81.383"></a><span id="l81.383">   memset(server, 0, sizeof(DIR_Server));</span>
<a href="#l81.384"></a><span id="l81.384">   server-&gt;position = kDefaultPosition;</span>
<a href="#l81.385"></a><span id="l81.385">   server-&gt;uri = nullptr;</span>
<a href="#l81.386"></a><span id="l81.386" class="difflineat">@@ -328,1120 +309,1024 @@ static void DIR_InitServer(DIR_Server *s</span>
<a href="#l81.387"></a><span id="l81.387">  * are supported:</span>
<a href="#l81.388"></a><span id="l81.388">  *   DIR_POS_APPEND - Appends the server to the end of the list.  If the server</span>
<a href="#l81.389"></a><span id="l81.389">  *                    is already in the list, does nothing.</span>
<a href="#l81.390"></a><span id="l81.390">  *   DIR_POS_DELETE - Deletes the given server from the list.  Note that this</span>
<a href="#l81.391"></a><span id="l81.391">  *                    does not cause the server structure to be freed.</span>
<a href="#l81.392"></a><span id="l81.392">  *</span>
<a href="#l81.393"></a><span id="l81.393">  * Returns true if the server list was re-sorted.</span>
<a href="#l81.394"></a><span id="l81.394">  */</span>
<a href="#l81.395"></a><span id="l81.395" class="difflineminus">-static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server*&gt; *wholeList, DIR_Server *server, int32_t position)</span>
<a href="#l81.396"></a><span id="l81.396" class="difflineminus">- {</span>
<a href="#l81.397"></a><span id="l81.397" class="difflineminus">-   NS_ENSURE_TRUE(wholeList, false);</span>
<a href="#l81.398"></a><span id="l81.398" class="difflineplus">+static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l81.399"></a><span id="l81.399" class="difflineplus">+                                  DIR_Server *server, int32_t position) {</span>
<a href="#l81.400"></a><span id="l81.400" class="difflineplus">+  NS_ENSURE_TRUE(wholeList, false);</span>
<a href="#l81.401"></a><span id="l81.401"> </span>
<a href="#l81.402"></a><span id="l81.402" class="difflineminus">-   int32_t    i, count, num;</span>
<a href="#l81.403"></a><span id="l81.403" class="difflineminus">-   bool       resort = false;</span>
<a href="#l81.404"></a><span id="l81.404" class="difflineminus">-   DIR_Server *s=nullptr;</span>
<a href="#l81.405"></a><span id="l81.405" class="difflineplus">+  int32_t i, count, num;</span>
<a href="#l81.406"></a><span id="l81.406" class="difflineplus">+  bool resort = false;</span>
<a href="#l81.407"></a><span id="l81.407" class="difflineplus">+  DIR_Server *s = nullptr;</span>
<a href="#l81.408"></a><span id="l81.408"> </span>
<a href="#l81.409"></a><span id="l81.409" class="difflineminus">-   switch (position) {</span>
<a href="#l81.410"></a><span id="l81.410" class="difflineminus">-   case DIR_POS_APPEND:</span>
<a href="#l81.411"></a><span id="l81.411" class="difflineminus">-   /* Do nothing if the request is to append a server that is already</span>
<a href="#l81.412"></a><span id="l81.412" class="difflineminus">-     * in the list.</span>
<a href="#l81.413"></a><span id="l81.413" class="difflineminus">-     */</span>
<a href="#l81.414"></a><span id="l81.414" class="difflineminus">-     count = wholeList-&gt;Length();</span>
<a href="#l81.415"></a><span id="l81.415" class="difflineminus">-     for (i= 0; i &lt; count; i++)</span>
<a href="#l81.416"></a><span id="l81.416" class="difflineminus">-     {</span>
<a href="#l81.417"></a><span id="l81.417" class="difflineminus">-       if  ((s = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l81.418"></a><span id="l81.418" class="difflineminus">-         if (s == server)</span>
<a href="#l81.419"></a><span id="l81.419" class="difflineminus">-           return false;</span>
<a href="#l81.420"></a><span id="l81.420" class="difflineminus">-     }</span>
<a href="#l81.421"></a><span id="l81.421" class="difflineminus">-     /* In general, if there are any servers already in the list, set the</span>
<a href="#l81.422"></a><span id="l81.422" class="difflineminus">-     * position to the position of the last server plus one.  If there</span>
<a href="#l81.423"></a><span id="l81.423" class="difflineminus">-     * are none, set it to position 1.</span>
<a href="#l81.424"></a><span id="l81.424" class="difflineminus">-     */</span>
<a href="#l81.425"></a><span id="l81.425" class="difflineminus">-     if (count &gt; 0)</span>
<a href="#l81.426"></a><span id="l81.426" class="difflineminus">-     {</span>
<a href="#l81.427"></a><span id="l81.427" class="difflineminus">-       s = wholeList-&gt;ElementAt(count - 1);</span>
<a href="#l81.428"></a><span id="l81.428" class="difflineminus">-       server-&gt;position = s-&gt;position + 1;</span>
<a href="#l81.429"></a><span id="l81.429" class="difflineminus">-     }</span>
<a href="#l81.430"></a><span id="l81.430" class="difflineminus">-     else</span>
<a href="#l81.431"></a><span id="l81.431" class="difflineminus">-       server-&gt;position = 1;</span>
<a href="#l81.432"></a><span id="l81.432" class="difflineplus">+  switch (position) {</span>
<a href="#l81.433"></a><span id="l81.433" class="difflineplus">+    case DIR_POS_APPEND:</span>
<a href="#l81.434"></a><span id="l81.434" class="difflineplus">+      /* Do nothing if the request is to append a server that is already</span>
<a href="#l81.435"></a><span id="l81.435" class="difflineplus">+       * in the list.</span>
<a href="#l81.436"></a><span id="l81.436" class="difflineplus">+       */</span>
<a href="#l81.437"></a><span id="l81.437" class="difflineplus">+      count = wholeList-&gt;Length();</span>
<a href="#l81.438"></a><span id="l81.438" class="difflineplus">+      for (i = 0; i &lt; count; i++) {</span>
<a href="#l81.439"></a><span id="l81.439" class="difflineplus">+        if ((s = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l81.440"></a><span id="l81.440" class="difflineplus">+          if (s == server) return false;</span>
<a href="#l81.441"></a><span id="l81.441" class="difflineplus">+      }</span>
<a href="#l81.442"></a><span id="l81.442" class="difflineplus">+      /* In general, if there are any servers already in the list, set the</span>
<a href="#l81.443"></a><span id="l81.443" class="difflineplus">+       * position to the position of the last server plus one.  If there</span>
<a href="#l81.444"></a><span id="l81.444" class="difflineplus">+       * are none, set it to position 1.</span>
<a href="#l81.445"></a><span id="l81.445" class="difflineplus">+       */</span>
<a href="#l81.446"></a><span id="l81.446" class="difflineplus">+      if (count &gt; 0) {</span>
<a href="#l81.447"></a><span id="l81.447" class="difflineplus">+        s = wholeList-&gt;ElementAt(count - 1);</span>
<a href="#l81.448"></a><span id="l81.448" class="difflineplus">+        server-&gt;position = s-&gt;position + 1;</span>
<a href="#l81.449"></a><span id="l81.449" class="difflineplus">+      } else</span>
<a href="#l81.450"></a><span id="l81.450" class="difflineplus">+        server-&gt;position = 1;</span>
<a href="#l81.451"></a><span id="l81.451"> </span>
<a href="#l81.452"></a><span id="l81.452" class="difflineminus">-     wholeList-&gt;AppendElement(server);</span>
<a href="#l81.453"></a><span id="l81.453" class="difflineminus">-     break;</span>
<a href="#l81.454"></a><span id="l81.454" class="difflineplus">+      wholeList-&gt;AppendElement(server);</span>
<a href="#l81.455"></a><span id="l81.455" class="difflineplus">+      break;</span>
<a href="#l81.456"></a><span id="l81.456"> </span>
<a href="#l81.457"></a><span id="l81.457" class="difflineminus">-   case DIR_POS_DELETE:</span>
<a href="#l81.458"></a><span id="l81.458" class="difflineminus">-       /* Remove the prefs corresponding to the given server.  If the prefName</span>
<a href="#l81.459"></a><span id="l81.459" class="difflineplus">+    case DIR_POS_DELETE:</span>
<a href="#l81.460"></a><span id="l81.460" class="difflineplus">+      /* Remove the prefs corresponding to the given server.  If the prefName</span>
<a href="#l81.461"></a><span id="l81.461">        * value is nullptr, the server has never been saved and there are no</span>
<a href="#l81.462"></a><span id="l81.462">        * prefs to remove.</span>
<a href="#l81.463"></a><span id="l81.463" class="difflineminus">-     */</span>
<a href="#l81.464"></a><span id="l81.464" class="difflineminus">-     if (server-&gt;prefName)</span>
<a href="#l81.465"></a><span id="l81.465" class="difflineminus">-     {</span>
<a href="#l81.466"></a><span id="l81.466" class="difflineminus">-       nsresult rv;</span>
<a href="#l81.467"></a><span id="l81.467" class="difflineminus">-       nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.468"></a><span id="l81.468" class="difflineminus">-       if (NS_FAILED(rv))</span>
<a href="#l81.469"></a><span id="l81.469" class="difflineminus">-         return false;</span>
<a href="#l81.470"></a><span id="l81.470" class="difflineplus">+       */</span>
<a href="#l81.471"></a><span id="l81.471" class="difflineplus">+      if (server-&gt;prefName) {</span>
<a href="#l81.472"></a><span id="l81.472" class="difflineplus">+        nsresult rv;</span>
<a href="#l81.473"></a><span id="l81.473" class="difflineplus">+        nsCOMPtr&lt;nsIPrefBranch&gt; pPref(</span>
<a href="#l81.474"></a><span id="l81.474" class="difflineplus">+            do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.475"></a><span id="l81.475" class="difflineplus">+        if (NS_FAILED(rv)) return false;</span>
<a href="#l81.476"></a><span id="l81.476"> </span>
<a href="#l81.477"></a><span id="l81.477" class="difflineminus">-       pPref-&gt;DeleteBranch(server-&gt;prefName);</span>
<a href="#l81.478"></a><span id="l81.478" class="difflineplus">+        pPref-&gt;DeleteBranch(server-&gt;prefName);</span>
<a href="#l81.479"></a><span id="l81.479"> </span>
<a href="#l81.480"></a><span id="l81.480" class="difflineminus">-       // mark the server as deleted by setting its position to 0</span>
<a href="#l81.481"></a><span id="l81.481" class="difflineminus">-       DIR_SetIntPref(server-&gt;prefName, &quot;position&quot;, 0, -1);</span>
<a href="#l81.482"></a><span id="l81.482" class="difflineminus">-     }</span>
<a href="#l81.483"></a><span id="l81.483" class="difflineplus">+        // mark the server as deleted by setting its position to 0</span>
<a href="#l81.484"></a><span id="l81.484" class="difflineplus">+        DIR_SetIntPref(server-&gt;prefName, &quot;position&quot;, 0, -1);</span>
<a href="#l81.485"></a><span id="l81.485" class="difflineplus">+      }</span>
<a href="#l81.486"></a><span id="l81.486"> </span>
<a href="#l81.487"></a><span id="l81.487" class="difflineminus">-     /* If the server is in the server list, remove it.</span>
<a href="#l81.488"></a><span id="l81.488" class="difflineminus">-     */</span>
<a href="#l81.489"></a><span id="l81.489" class="difflineminus">-     num = wholeList-&gt;IndexOf(server);</span>
<a href="#l81.490"></a><span id="l81.490" class="difflineminus">-     if (num &gt;= 0)</span>
<a href="#l81.491"></a><span id="l81.491" class="difflineminus">-     {</span>
<a href="#l81.492"></a><span id="l81.492" class="difflineminus">-     /* The list does not need to be re-sorted if the server is the</span>
<a href="#l81.493"></a><span id="l81.493" class="difflineminus">-     * last one in the list.</span>
<a href="#l81.494"></a><span id="l81.494" class="difflineplus">+      /* If the server is in the server list, remove it.</span>
<a href="#l81.495"></a><span id="l81.495">        */</span>
<a href="#l81.496"></a><span id="l81.496" class="difflineminus">-       count = wholeList-&gt;Length();</span>
<a href="#l81.497"></a><span id="l81.497" class="difflineminus">-       if (num == count - 1)</span>
<a href="#l81.498"></a><span id="l81.498" class="difflineminus">-       {</span>
<a href="#l81.499"></a><span id="l81.499" class="difflineminus">-         wholeList-&gt;RemoveElementAt(num);</span>
<a href="#l81.500"></a><span id="l81.500" class="difflineminus">-       }</span>
<a href="#l81.501"></a><span id="l81.501" class="difflineminus">-       else</span>
<a href="#l81.502"></a><span id="l81.502" class="difflineminus">-       {</span>
<a href="#l81.503"></a><span id="l81.503" class="difflineminus">-         resort = true;</span>
<a href="#l81.504"></a><span id="l81.504" class="difflineminus">-         wholeList-&gt;RemoveElement(server);</span>
<a href="#l81.505"></a><span id="l81.505" class="difflineminus">-       }</span>
<a href="#l81.506"></a><span id="l81.506" class="difflineminus">-     }</span>
<a href="#l81.507"></a><span id="l81.507" class="difflineminus">-     break;</span>
<a href="#l81.508"></a><span id="l81.508" class="difflineplus">+      num = wholeList-&gt;IndexOf(server);</span>
<a href="#l81.509"></a><span id="l81.509" class="difflineplus">+      if (num &gt;= 0) {</span>
<a href="#l81.510"></a><span id="l81.510" class="difflineplus">+        /* The list does not need to be re-sorted if the server is the</span>
<a href="#l81.511"></a><span id="l81.511" class="difflineplus">+         * last one in the list.</span>
<a href="#l81.512"></a><span id="l81.512" class="difflineplus">+         */</span>
<a href="#l81.513"></a><span id="l81.513" class="difflineplus">+        count = wholeList-&gt;Length();</span>
<a href="#l81.514"></a><span id="l81.514" class="difflineplus">+        if (num == count - 1) {</span>
<a href="#l81.515"></a><span id="l81.515" class="difflineplus">+          wholeList-&gt;RemoveElementAt(num);</span>
<a href="#l81.516"></a><span id="l81.516" class="difflineplus">+        } else {</span>
<a href="#l81.517"></a><span id="l81.517" class="difflineplus">+          resort = true;</span>
<a href="#l81.518"></a><span id="l81.518" class="difflineplus">+          wholeList-&gt;RemoveElement(server);</span>
<a href="#l81.519"></a><span id="l81.519" class="difflineplus">+        }</span>
<a href="#l81.520"></a><span id="l81.520" class="difflineplus">+      }</span>
<a href="#l81.521"></a><span id="l81.521" class="difflineplus">+      break;</span>
<a href="#l81.522"></a><span id="l81.522"> </span>
<a href="#l81.523"></a><span id="l81.523" class="difflineminus">-   default:</span>
<a href="#l81.524"></a><span id="l81.524" class="difflineminus">-   /* See if the server is already in the list.</span>
<a href="#l81.525"></a><span id="l81.525" class="difflineminus">-     */</span>
<a href="#l81.526"></a><span id="l81.526" class="difflineminus">-     count = wholeList-&gt;Length();</span>
<a href="#l81.527"></a><span id="l81.527" class="difflineminus">-     for (i= 0; i &lt; count; i++)</span>
<a href="#l81.528"></a><span id="l81.528" class="difflineminus">-     {</span>
<a href="#l81.529"></a><span id="l81.529" class="difflineminus">-       if  ((s = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l81.530"></a><span id="l81.530" class="difflineminus">-         if (s == server)</span>
<a href="#l81.531"></a><span id="l81.531" class="difflineminus">-           break;</span>
<a href="#l81.532"></a><span id="l81.532" class="difflineminus">-     }</span>
<a href="#l81.533"></a><span id="l81.533" class="difflineplus">+    default:</span>
<a href="#l81.534"></a><span id="l81.534" class="difflineplus">+      /* See if the server is already in the list.</span>
<a href="#l81.535"></a><span id="l81.535" class="difflineplus">+       */</span>
<a href="#l81.536"></a><span id="l81.536" class="difflineplus">+      count = wholeList-&gt;Length();</span>
<a href="#l81.537"></a><span id="l81.537" class="difflineplus">+      for (i = 0; i &lt; count; i++) {</span>
<a href="#l81.538"></a><span id="l81.538" class="difflineplus">+        if ((s = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l81.539"></a><span id="l81.539" class="difflineplus">+          if (s == server) break;</span>
<a href="#l81.540"></a><span id="l81.540" class="difflineplus">+      }</span>
<a href="#l81.541"></a><span id="l81.541" class="difflineplus">+</span>
<a href="#l81.542"></a><span id="l81.542" class="difflineplus">+      /* If the server is not in the list, add it to the beginning and re-sort.</span>
<a href="#l81.543"></a><span id="l81.543" class="difflineplus">+       */</span>
<a href="#l81.544"></a><span id="l81.544" class="difflineplus">+      if (s == nullptr) {</span>
<a href="#l81.545"></a><span id="l81.545" class="difflineplus">+        server-&gt;position = position;</span>
<a href="#l81.546"></a><span id="l81.546" class="difflineplus">+        wholeList-&gt;AppendElement(server);</span>
<a href="#l81.547"></a><span id="l81.547" class="difflineplus">+        resort = true;</span>
<a href="#l81.548"></a><span id="l81.548" class="difflineplus">+      }</span>
<a href="#l81.549"></a><span id="l81.549"> </span>
<a href="#l81.550"></a><span id="l81.550" class="difflineminus">-     /* If the server is not in the list, add it to the beginning and re-sort.</span>
<a href="#l81.551"></a><span id="l81.551" class="difflineminus">-     */</span>
<a href="#l81.552"></a><span id="l81.552" class="difflineminus">-     if (s == nullptr)</span>
<a href="#l81.553"></a><span id="l81.553" class="difflineminus">-     {</span>
<a href="#l81.554"></a><span id="l81.554" class="difflineminus">-       server-&gt;position = position;</span>
<a href="#l81.555"></a><span id="l81.555" class="difflineminus">-       wholeList-&gt;AppendElement(server);</span>
<a href="#l81.556"></a><span id="l81.556" class="difflineminus">-       resort = true;</span>
<a href="#l81.557"></a><span id="l81.557" class="difflineminus">-     }</span>
<a href="#l81.558"></a><span id="l81.558" class="difflineplus">+      /* Don't re-sort if the server is already in the requested position.</span>
<a href="#l81.559"></a><span id="l81.559" class="difflineplus">+       */</span>
<a href="#l81.560"></a><span id="l81.560" class="difflineplus">+      else if (server-&gt;position != position) {</span>
<a href="#l81.561"></a><span id="l81.561" class="difflineplus">+        server-&gt;position = position;</span>
<a href="#l81.562"></a><span id="l81.562" class="difflineplus">+        wholeList-&gt;RemoveElement(server);</span>
<a href="#l81.563"></a><span id="l81.563" class="difflineplus">+        wholeList-&gt;AppendElement(server);</span>
<a href="#l81.564"></a><span id="l81.564" class="difflineplus">+        resort = true;</span>
<a href="#l81.565"></a><span id="l81.565" class="difflineplus">+      }</span>
<a href="#l81.566"></a><span id="l81.566" class="difflineplus">+      break;</span>
<a href="#l81.567"></a><span id="l81.567" class="difflineplus">+  }</span>
<a href="#l81.568"></a><span id="l81.568"> </span>
<a href="#l81.569"></a><span id="l81.569" class="difflineminus">-       /* Don't re-sort if the server is already in the requested position.</span>
<a href="#l81.570"></a><span id="l81.570" class="difflineminus">-     */</span>
<a href="#l81.571"></a><span id="l81.571" class="difflineminus">-     else if (server-&gt;position != position)</span>
<a href="#l81.572"></a><span id="l81.572" class="difflineminus">-     {</span>
<a href="#l81.573"></a><span id="l81.573" class="difflineminus">-       server-&gt;position = position;</span>
<a href="#l81.574"></a><span id="l81.574" class="difflineminus">-       wholeList-&gt;RemoveElement(server);</span>
<a href="#l81.575"></a><span id="l81.575" class="difflineminus">-       wholeList-&gt;AppendElement(server);</span>
<a href="#l81.576"></a><span id="l81.576" class="difflineminus">-       resort = true;</span>
<a href="#l81.577"></a><span id="l81.577" class="difflineminus">-     }</span>
<a href="#l81.578"></a><span id="l81.578" class="difflineminus">-     break;</span>
<a href="#l81.579"></a><span id="l81.579" class="difflineminus">-        }</span>
<a href="#l81.580"></a><span id="l81.580" class="difflineplus">+  /* Make sure our position changes get saved back to prefs</span>
<a href="#l81.581"></a><span id="l81.581" class="difflineplus">+   */</span>
<a href="#l81.582"></a><span id="l81.582" class="difflineplus">+  DIR_SaveServerPreferences(wholeList);</span>
<a href="#l81.583"></a><span id="l81.583"> </span>
<a href="#l81.584"></a><span id="l81.584" class="difflineminus">-        /* Make sure our position changes get saved back to prefs</span>
<a href="#l81.585"></a><span id="l81.585" class="difflineminus">-        */</span>
<a href="#l81.586"></a><span id="l81.586" class="difflineminus">-        DIR_SaveServerPreferences(wholeList);</span>
<a href="#l81.587"></a><span id="l81.587" class="difflineminus">-</span>
<a href="#l81.588"></a><span id="l81.588" class="difflineminus">-        return resort;</span>
<a href="#l81.589"></a><span id="l81.589" class="difflineplus">+  return resort;</span>
<a href="#l81.590"></a><span id="l81.590"> }</span>
<a href="#l81.591"></a><span id="l81.591"> </span>
<a href="#l81.592"></a><span id="l81.592"> /*****************************************************************************</span>
<a href="#l81.593"></a><span id="l81.593">  * DIR_Server Callback Notification Functions</span>
<a href="#l81.594"></a><span id="l81.594">  */</span>
<a href="#l81.595"></a><span id="l81.595"> </span>
<a href="#l81.596"></a><span id="l81.596"> /* dir_matchServerPrefToServer</span>
<a href="#l81.597"></a><span id="l81.597">  *</span>
<a href="#l81.598"></a><span id="l81.598">  * This function finds the DIR_Server in the unified DIR_Server list to which</span>
<a href="#l81.599"></a><span id="l81.599">  * the given preference string belongs.</span>
<a href="#l81.600"></a><span id="l81.600">  */</span>
<a href="#l81.601"></a><span id="l81.601" class="difflineminus">-static DIR_Server *dir_MatchServerPrefToServer(nsTArray&lt;DIR_Server*&gt; *wholeList, const char *pref)</span>
<a href="#l81.602"></a><span id="l81.602" class="difflineminus">-{</span>
<a href="#l81.603"></a><span id="l81.603" class="difflineplus">+static DIR_Server *dir_MatchServerPrefToServer(</span>
<a href="#l81.604"></a><span id="l81.604" class="difflineplus">+    nsTArray&lt;DIR_Server *&gt; *wholeList, const char *pref) {</span>
<a href="#l81.605"></a><span id="l81.605">   DIR_Server *server;</span>
<a href="#l81.606"></a><span id="l81.606"> </span>
<a href="#l81.607"></a><span id="l81.607">   int32_t count = wholeList-&gt;Length();</span>
<a href="#l81.608"></a><span id="l81.608">   int32_t i;</span>
<a href="#l81.609"></a><span id="l81.609" class="difflineminus">-  for (i = 0; i &lt; count; i++)</span>
<a href="#l81.610"></a><span id="l81.610" class="difflineminus">-  {</span>
<a href="#l81.611"></a><span id="l81.611" class="difflineminus">-    if ((server = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l81.612"></a><span id="l81.612" class="difflineminus">-    {</span>
<a href="#l81.613"></a><span id="l81.613" class="difflineminus">-      if (server-&gt;prefName &amp;&amp; PL_strstr(pref, server-&gt;prefName) == pref)</span>
<a href="#l81.614"></a><span id="l81.614" class="difflineminus">-      {</span>
<a href="#l81.615"></a><span id="l81.615" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l81.616"></a><span id="l81.616" class="difflineplus">+    if ((server = wholeList-&gt;ElementAt(i)) != nullptr) {</span>
<a href="#l81.617"></a><span id="l81.617" class="difflineplus">+      if (server-&gt;prefName &amp;&amp; PL_strstr(pref, server-&gt;prefName) == pref) {</span>
<a href="#l81.618"></a><span id="l81.618">         char c = pref[PL_strlen(server-&gt;prefName)];</span>
<a href="#l81.619"></a><span id="l81.619" class="difflineminus">-        if (c == 0 || c == '.')</span>
<a href="#l81.620"></a><span id="l81.620" class="difflineminus">-          return server;</span>
<a href="#l81.621"></a><span id="l81.621" class="difflineplus">+        if (c == 0 || c == '.') return server;</span>
<a href="#l81.622"></a><span id="l81.622">       }</span>
<a href="#l81.623"></a><span id="l81.623">     }</span>
<a href="#l81.624"></a><span id="l81.624">   }</span>
<a href="#l81.625"></a><span id="l81.625">   return nullptr;</span>
<a href="#l81.626"></a><span id="l81.626"> }</span>
<a href="#l81.627"></a><span id="l81.627"> </span>
<a href="#l81.628"></a><span id="l81.628"> /* dir_ValidateAndAddNewServer</span>
<a href="#l81.629"></a><span id="l81.629">  *</span>
<a href="#l81.630"></a><span id="l81.630">  * This function verifies that the position, serverName and description values</span>
<a href="#l81.631"></a><span id="l81.631">  * are set for the given prefName.  If they are then it adds the server to the</span>
<a href="#l81.632"></a><span id="l81.632">  * unified server list.</span>
<a href="#l81.633"></a><span id="l81.633">  */</span>
<a href="#l81.634"></a><span id="l81.634" class="difflineminus">-static bool dir_ValidateAndAddNewServer(nsTArray&lt;DIR_Server*&gt; *wholeList, const char *fullprefname)</span>
<a href="#l81.635"></a><span id="l81.635" class="difflineminus">-{</span>
<a href="#l81.636"></a><span id="l81.636" class="difflineplus">+static bool dir_ValidateAndAddNewServer(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l81.637"></a><span id="l81.637" class="difflineplus">+                                        const char *fullprefname) {</span>
<a href="#l81.638"></a><span id="l81.638">   bool rc = false;</span>
<a href="#l81.639"></a><span id="l81.639"> </span>
<a href="#l81.640"></a><span id="l81.640" class="difflineminus">-  const char *endname = PL_strchr(&amp;fullprefname[PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1], '.');</span>
<a href="#l81.641"></a><span id="l81.641" class="difflineminus">-  if (endname)</span>
<a href="#l81.642"></a><span id="l81.642" class="difflineminus">-  {</span>
<a href="#l81.643"></a><span id="l81.643" class="difflineplus">+  const char *endname =</span>
<a href="#l81.644"></a><span id="l81.644" class="difflineplus">+      PL_strchr(&amp;fullprefname[PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1], '.');</span>
<a href="#l81.645"></a><span id="l81.645" class="difflineplus">+  if (endname) {</span>
<a href="#l81.646"></a><span id="l81.646">     char *prefname = (char *)PR_Malloc(endname - fullprefname + 1);</span>
<a href="#l81.647"></a><span id="l81.647" class="difflineminus">-    if (prefname)</span>
<a href="#l81.648"></a><span id="l81.648" class="difflineminus">-    {</span>
<a href="#l81.649"></a><span id="l81.649" class="difflineplus">+    if (prefname) {</span>
<a href="#l81.650"></a><span id="l81.650">       int32_t dirType;</span>
<a href="#l81.651"></a><span id="l81.651">       char *t1 = nullptr, *t2 = nullptr;</span>
<a href="#l81.652"></a><span id="l81.652"> </span>
<a href="#l81.653"></a><span id="l81.653">       PL_strncpyz(prefname, fullprefname, endname - fullprefname + 1);</span>
<a href="#l81.654"></a><span id="l81.654"> </span>
<a href="#l81.655"></a><span id="l81.655">       dirType = DIR_GetIntPref(prefname, &quot;dirType&quot;, -1);</span>
<a href="#l81.656"></a><span id="l81.656" class="difflineminus">-      if (dirType != -1 &amp;&amp;</span>
<a href="#l81.657"></a><span id="l81.657" class="difflineminus">-          DIR_GetIntPref(prefname, &quot;position&quot;, 0) != 0 &amp;&amp;</span>
<a href="#l81.658"></a><span id="l81.658" class="difflineminus">-          (t1 = DIR_GetLocalizedStringPref(prefname, &quot;description&quot;)) != nullptr)</span>
<a href="#l81.659"></a><span id="l81.659" class="difflineminus">-      {</span>
<a href="#l81.660"></a><span id="l81.660" class="difflineplus">+      if (dirType != -1 &amp;&amp; DIR_GetIntPref(prefname, &quot;position&quot;, 0) != 0 &amp;&amp;</span>
<a href="#l81.661"></a><span id="l81.661" class="difflineplus">+          (t1 = DIR_GetLocalizedStringPref(prefname, &quot;description&quot;)) !=</span>
<a href="#l81.662"></a><span id="l81.662" class="difflineplus">+              nullptr) {</span>
<a href="#l81.663"></a><span id="l81.663">         if (dirType == PABDirectory ||</span>
<a href="#l81.664"></a><span id="l81.664" class="difflineminus">-           (t2 = DIR_GetStringPref(prefname, &quot;serverName&quot;,  nullptr)) != nullptr)</span>
<a href="#l81.665"></a><span id="l81.665" class="difflineminus">-        {</span>
<a href="#l81.666"></a><span id="l81.666" class="difflineplus">+            (t2 = DIR_GetStringPref(prefname, &quot;serverName&quot;, nullptr)) !=</span>
<a href="#l81.667"></a><span id="l81.667" class="difflineplus">+                nullptr) {</span>
<a href="#l81.668"></a><span id="l81.668">           DIR_Server *server = (DIR_Server *)PR_Malloc(sizeof(DIR_Server));</span>
<a href="#l81.669"></a><span id="l81.669" class="difflineminus">-          if (server)</span>
<a href="#l81.670"></a><span id="l81.670" class="difflineminus">-          {</span>
<a href="#l81.671"></a><span id="l81.671" class="difflineplus">+          if (server) {</span>
<a href="#l81.672"></a><span id="l81.672">             DIR_InitServer(server, (DirectoryType)dirType);</span>
<a href="#l81.673"></a><span id="l81.673">             server-&gt;prefName = prefname;</span>
<a href="#l81.674"></a><span id="l81.674">             DIR_GetPrefsForOneServer(server);</span>
<a href="#l81.675"></a><span id="l81.675">             DIR_SetServerPosition(wholeList, server, server-&gt;position);</span>
<a href="#l81.676"></a><span id="l81.676">             rc = true;</span>
<a href="#l81.677"></a><span id="l81.677">           }</span>
<a href="#l81.678"></a><span id="l81.678">           PR_FREEIF(t2);</span>
<a href="#l81.679"></a><span id="l81.679">         }</span>
<a href="#l81.680"></a><span id="l81.680">         PR_Free(t1);</span>
<a href="#l81.681"></a><span id="l81.681" class="difflineminus">-      }</span>
<a href="#l81.682"></a><span id="l81.682" class="difflineminus">-      else</span>
<a href="#l81.683"></a><span id="l81.683" class="difflineplus">+      } else</span>
<a href="#l81.684"></a><span id="l81.684">         PR_Free(prefname);</span>
<a href="#l81.685"></a><span id="l81.685">     }</span>
<a href="#l81.686"></a><span id="l81.686">   }</span>
<a href="#l81.687"></a><span id="l81.687"> </span>
<a href="#l81.688"></a><span id="l81.688">   return rc;</span>
<a href="#l81.689"></a><span id="l81.689"> }</span>
<a href="#l81.690"></a><span id="l81.690"> </span>
<a href="#l81.691"></a><span id="l81.691" class="difflineminus">-static DIR_PrefId DIR_AtomizePrefName(const char *prefname)</span>
<a href="#l81.692"></a><span id="l81.692" class="difflineminus">-{</span>
<a href="#l81.693"></a><span id="l81.693" class="difflineminus">-  if (!prefname)</span>
<a href="#l81.694"></a><span id="l81.694" class="difflineminus">-    return idNone;</span>
<a href="#l81.695"></a><span id="l81.695" class="difflineplus">+static DIR_PrefId DIR_AtomizePrefName(const char *prefname) {</span>
<a href="#l81.696"></a><span id="l81.696" class="difflineplus">+  if (!prefname) return idNone;</span>
<a href="#l81.697"></a><span id="l81.697"> </span>
<a href="#l81.698"></a><span id="l81.698">   DIR_PrefId rc = idNone;</span>
<a href="#l81.699"></a><span id="l81.699"> </span>
<a href="#l81.700"></a><span id="l81.700">   /* Skip the &quot;ldap_2.servers.&lt;server-name&gt;.&quot; portion of the string.</span>
<a href="#l81.701"></a><span id="l81.701">    */</span>
<a href="#l81.702"></a><span id="l81.702" class="difflineminus">-  if (PL_strstr(prefname, PREF_LDAP_SERVER_TREE_NAME) == prefname)</span>
<a href="#l81.703"></a><span id="l81.703" class="difflineminus">-  {</span>
<a href="#l81.704"></a><span id="l81.704" class="difflineminus">-    prefname = PL_strchr(&amp;prefname[PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1], '.');</span>
<a href="#l81.705"></a><span id="l81.705" class="difflineplus">+  if (PL_strstr(prefname, PREF_LDAP_SERVER_TREE_NAME) == prefname) {</span>
<a href="#l81.706"></a><span id="l81.706" class="difflineplus">+    prefname =</span>
<a href="#l81.707"></a><span id="l81.707" class="difflineplus">+        PL_strchr(&amp;prefname[PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1], '.');</span>
<a href="#l81.708"></a><span id="l81.708">     if (!prefname)</span>
<a href="#l81.709"></a><span id="l81.709">       return idNone;</span>
<a href="#l81.710"></a><span id="l81.710">     else</span>
<a href="#l81.711"></a><span id="l81.711">       prefname = prefname + 1;</span>
<a href="#l81.712"></a><span id="l81.712">   }</span>
<a href="#l81.713"></a><span id="l81.713"> </span>
<a href="#l81.714"></a><span id="l81.714">   switch (prefname[0]) {</span>
<a href="#l81.715"></a><span id="l81.715" class="difflineminus">-  case 'd':</span>
<a href="#l81.716"></a><span id="l81.716" class="difflineminus">-    switch (prefname[1]) {</span>
<a href="#l81.717"></a><span id="l81.717" class="difflineminus">-    case 'e': /* description */</span>
<a href="#l81.718"></a><span id="l81.718" class="difflineminus">-      rc = idDescription;</span>
<a href="#l81.719"></a><span id="l81.719" class="difflineminus">-      break;</span>
<a href="#l81.720"></a><span id="l81.720" class="difflineminus">-    case 'i': /* dirType */</span>
<a href="#l81.721"></a><span id="l81.721" class="difflineminus">-      rc = idType;</span>
<a href="#l81.722"></a><span id="l81.722" class="difflineminus">-      break;</span>
<a href="#l81.723"></a><span id="l81.723" class="difflineminus">-    }</span>
<a href="#l81.724"></a><span id="l81.724" class="difflineminus">-    break;</span>
<a href="#l81.725"></a><span id="l81.725" class="difflineminus">-</span>
<a href="#l81.726"></a><span id="l81.726" class="difflineminus">-  case 'f':</span>
<a href="#l81.727"></a><span id="l81.727" class="difflineminus">-    rc = idFileName;</span>
<a href="#l81.728"></a><span id="l81.728" class="difflineminus">-    break;</span>
<a href="#l81.729"></a><span id="l81.729" class="difflineminus">-</span>
<a href="#l81.730"></a><span id="l81.730" class="difflineminus">-  case 'p':</span>
<a href="#l81.731"></a><span id="l81.731" class="difflineminus">-    switch (prefname[1]) {</span>
<a href="#l81.732"></a><span id="l81.732" class="difflineminus">-    case 'o':</span>
<a href="#l81.733"></a><span id="l81.733" class="difflineminus">-      switch (prefname[2]) {</span>
<a href="#l81.734"></a><span id="l81.734" class="difflineminus">-      case 's': /* position */</span>
<a href="#l81.735"></a><span id="l81.735" class="difflineminus">-        rc = idPosition;</span>
<a href="#l81.736"></a><span id="l81.736" class="difflineminus">-        break;</span>
<a href="#l81.737"></a><span id="l81.737" class="difflineplus">+    case 'd':</span>
<a href="#l81.738"></a><span id="l81.738" class="difflineplus">+      switch (prefname[1]) {</span>
<a href="#l81.739"></a><span id="l81.739" class="difflineplus">+        case 'e': /* description */</span>
<a href="#l81.740"></a><span id="l81.740" class="difflineplus">+          rc = idDescription;</span>
<a href="#l81.741"></a><span id="l81.741" class="difflineplus">+          break;</span>
<a href="#l81.742"></a><span id="l81.742" class="difflineplus">+        case 'i': /* dirType */</span>
<a href="#l81.743"></a><span id="l81.743" class="difflineplus">+          rc = idType;</span>
<a href="#l81.744"></a><span id="l81.744" class="difflineplus">+          break;</span>
<a href="#l81.745"></a><span id="l81.745">       }</span>
<a href="#l81.746"></a><span id="l81.746">       break;</span>
<a href="#l81.747"></a><span id="l81.747" class="difflineminus">-    }</span>
<a href="#l81.748"></a><span id="l81.748" class="difflineminus">-    break;</span>
<a href="#l81.749"></a><span id="l81.749" class="difflineplus">+</span>
<a href="#l81.750"></a><span id="l81.750" class="difflineplus">+    case 'f':</span>
<a href="#l81.751"></a><span id="l81.751" class="difflineplus">+      rc = idFileName;</span>
<a href="#l81.752"></a><span id="l81.752" class="difflineplus">+      break;</span>
<a href="#l81.753"></a><span id="l81.753"> </span>
<a href="#l81.754"></a><span id="l81.754" class="difflineminus">-  case 'u': /* uri */</span>
<a href="#l81.755"></a><span id="l81.755" class="difflineminus">-    rc = idUri;</span>
<a href="#l81.756"></a><span id="l81.756" class="difflineminus">-    break;</span>
<a href="#l81.757"></a><span id="l81.757" class="difflineplus">+    case 'p':</span>
<a href="#l81.758"></a><span id="l81.758" class="difflineplus">+      switch (prefname[1]) {</span>
<a href="#l81.759"></a><span id="l81.759" class="difflineplus">+        case 'o':</span>
<a href="#l81.760"></a><span id="l81.760" class="difflineplus">+          switch (prefname[2]) {</span>
<a href="#l81.761"></a><span id="l81.761" class="difflineplus">+            case 's': /* position */</span>
<a href="#l81.762"></a><span id="l81.762" class="difflineplus">+              rc = idPosition;</span>
<a href="#l81.763"></a><span id="l81.763" class="difflineplus">+              break;</span>
<a href="#l81.764"></a><span id="l81.764" class="difflineplus">+          }</span>
<a href="#l81.765"></a><span id="l81.765" class="difflineplus">+          break;</span>
<a href="#l81.766"></a><span id="l81.766" class="difflineplus">+      }</span>
<a href="#l81.767"></a><span id="l81.767" class="difflineplus">+      break;</span>
<a href="#l81.768"></a><span id="l81.768" class="difflineplus">+</span>
<a href="#l81.769"></a><span id="l81.769" class="difflineplus">+    case 'u': /* uri */</span>
<a href="#l81.770"></a><span id="l81.770" class="difflineplus">+      rc = idUri;</span>
<a href="#l81.771"></a><span id="l81.771" class="difflineplus">+      break;</span>
<a href="#l81.772"></a><span id="l81.772">   }</span>
<a href="#l81.773"></a><span id="l81.773"> </span>
<a href="#l81.774"></a><span id="l81.774">   return rc;</span>
<a href="#l81.775"></a><span id="l81.775"> }</span>
<a href="#l81.776"></a><span id="l81.776"> </span>
<a href="#l81.777"></a><span id="l81.777"> /*****************************************************************************</span>
<a href="#l81.778"></a><span id="l81.778">  * Functions for destroying DIR_Servers</span>
<a href="#l81.779"></a><span id="l81.779">  */</span>
<a href="#l81.780"></a><span id="l81.780"> </span>
<a href="#l81.781"></a><span id="l81.781"> /* this function determines if the passed in server is no longer part of the of</span>
<a href="#l81.782"></a><span id="l81.782">    the global server list. */</span>
<a href="#l81.783"></a><span id="l81.783" class="difflineminus">-static bool dir_IsServerDeleted(DIR_Server * server)</span>
<a href="#l81.784"></a><span id="l81.784" class="difflineminus">-{</span>
<a href="#l81.785"></a><span id="l81.785" class="difflineplus">+static bool dir_IsServerDeleted(DIR_Server *server) {</span>
<a href="#l81.786"></a><span id="l81.786">   return (server &amp;&amp; server-&gt;position == 0);</span>
<a href="#l81.787"></a><span id="l81.787"> }</span>
<a href="#l81.788"></a><span id="l81.788"> </span>
<a href="#l81.789"></a><span id="l81.789" class="difflineminus">-/* when the back end manages the server list, deleting a server just decrements its ref count,</span>
<a href="#l81.790"></a><span id="l81.790" class="difflineminus">-   in the old world, we actually delete the server */</span>
<a href="#l81.791"></a><span id="l81.791" class="difflineminus">-static void DIR_DeleteServer(DIR_Server *server)</span>
<a href="#l81.792"></a><span id="l81.792" class="difflineminus">-{</span>
<a href="#l81.793"></a><span id="l81.793" class="difflineminus">-  if (server)</span>
<a href="#l81.794"></a><span id="l81.794" class="difflineminus">-  {</span>
<a href="#l81.795"></a><span id="l81.795" class="difflineminus">-    /* when destroying the server check its clear flag to see if things need cleared */</span>
<a href="#l81.796"></a><span id="l81.796" class="difflineplus">+/* when the back end manages the server list, deleting a server just decrements</span>
<a href="#l81.797"></a><span id="l81.797" class="difflineplus">+   its ref count, in the old world, we actually delete the server */</span>
<a href="#l81.798"></a><span id="l81.798" class="difflineplus">+static void DIR_DeleteServer(DIR_Server *server) {</span>
<a href="#l81.799"></a><span id="l81.799" class="difflineplus">+  if (server) {</span>
<a href="#l81.800"></a><span id="l81.800" class="difflineplus">+    /* when destroying the server check its clear flag to see if things need</span>
<a href="#l81.801"></a><span id="l81.801" class="difflineplus">+     * cleared */</span>
<a href="#l81.802"></a><span id="l81.802"> #ifdef XP_FileRemove</span>
<a href="#l81.803"></a><span id="l81.803" class="difflineminus">-    if (DIR_TestFlag(server, DIR_CLEAR_SERVER))</span>
<a href="#l81.804"></a><span id="l81.804" class="difflineminus">-    {</span>
<a href="#l81.805"></a><span id="l81.805" class="difflineminus">-      if (server-&gt;fileName)</span>
<a href="#l81.806"></a><span id="l81.806" class="difflineminus">-        XP_FileRemove (server-&gt;fileName, xpAddrBookNew);</span>
<a href="#l81.807"></a><span id="l81.807" class="difflineplus">+    if (DIR_TestFlag(server, DIR_CLEAR_SERVER)) {</span>
<a href="#l81.808"></a><span id="l81.808" class="difflineplus">+      if (server-&gt;fileName) XP_FileRemove(server-&gt;fileName, xpAddrBookNew);</span>
<a href="#l81.809"></a><span id="l81.809">     }</span>
<a href="#l81.810"></a><span id="l81.810"> #endif /* XP_FileRemove */</span>
<a href="#l81.811"></a><span id="l81.811">     PR_Free(server-&gt;prefName);</span>
<a href="#l81.812"></a><span id="l81.812">     PR_Free(server-&gt;description);</span>
<a href="#l81.813"></a><span id="l81.813">     PR_Free(server-&gt;fileName);</span>
<a href="#l81.814"></a><span id="l81.814">     PR_Free(server-&gt;uri);</span>
<a href="#l81.815"></a><span id="l81.815">     PR_Free(server);</span>
<a href="#l81.816"></a><span id="l81.816">   }</span>
<a href="#l81.817"></a><span id="l81.817"> }</span>
<a href="#l81.818"></a><span id="l81.818"> </span>
<a href="#l81.819"></a><span id="l81.819" class="difflineminus">-nsresult DIR_DeleteServerFromList(DIR_Server *server)</span>
<a href="#l81.820"></a><span id="l81.820" class="difflineminus">-{</span>
<a href="#l81.821"></a><span id="l81.821" class="difflineminus">-  if (!server)</span>
<a href="#l81.822"></a><span id="l81.822" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l81.823"></a><span id="l81.823" class="difflineplus">+nsresult DIR_DeleteServerFromList(DIR_Server *server) {</span>
<a href="#l81.824"></a><span id="l81.824" class="difflineplus">+  if (!server) return NS_ERROR_NULL_POINTER;</span>
<a href="#l81.825"></a><span id="l81.825"> </span>
<a href="#l81.826"></a><span id="l81.826">   nsresult rv = NS_OK;</span>
<a href="#l81.827"></a><span id="l81.827">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l81.828"></a><span id="l81.828"> </span>
<a href="#l81.829"></a><span id="l81.829" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l81.830"></a><span id="l81.830" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l81.831"></a><span id="l81.831" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l81.832"></a><span id="l81.832">   if (NS_SUCCEEDED(rv))</span>
<a href="#l81.833"></a><span id="l81.833">     rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l81.834"></a><span id="l81.834"> </span>
<a href="#l81.835"></a><span id="l81.835" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l81.836"></a><span id="l81.836" class="difflineminus">-  {</span>
<a href="#l81.837"></a><span id="l81.837" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l81.838"></a><span id="l81.838">     // close the database, as long as it isn't the special ones</span>
<a href="#l81.839"></a><span id="l81.839">     // (personal addressbook and collected addressbook)</span>
<a href="#l81.840"></a><span id="l81.840">     // which can never be deleted.  There was a bug where we would slap in</span>
<a href="#l81.841"></a><span id="l81.841" class="difflineminus">-    // &quot;abook.mab&quot; as the file name for LDAP directories, which would cause a crash</span>
<a href="#l81.842"></a><span id="l81.842" class="difflineminus">-    // on delete of LDAP directories.  this is just extra protection.</span>
<a href="#l81.843"></a><span id="l81.843" class="difflineminus">-    if (server-&gt;fileName &amp;&amp;</span>
<a href="#l81.844"></a><span id="l81.844" class="difflineminus">-        strcmp(server-&gt;fileName, kPersonalAddressbook) &amp;&amp;</span>
<a href="#l81.845"></a><span id="l81.845" class="difflineminus">-        strcmp(server-&gt;fileName, kCollectedAddressbook))</span>
<a href="#l81.846"></a><span id="l81.846" class="difflineminus">-    {</span>
<a href="#l81.847"></a><span id="l81.847" class="difflineplus">+    // &quot;abook.mab&quot; as the file name for LDAP directories, which would cause a</span>
<a href="#l81.848"></a><span id="l81.848" class="difflineplus">+    // crash on delete of LDAP directories.  this is just extra protection.</span>
<a href="#l81.849"></a><span id="l81.849" class="difflineplus">+    if (server-&gt;fileName &amp;&amp; strcmp(server-&gt;fileName, kPersonalAddressbook) &amp;&amp;</span>
<a href="#l81.850"></a><span id="l81.850" class="difflineplus">+        strcmp(server-&gt;fileName, kCollectedAddressbook)) {</span>
<a href="#l81.851"></a><span id="l81.851">       nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l81.852"></a><span id="l81.852"> </span>
<a href="#l81.853"></a><span id="l81.853">       rv = dbPath-&gt;AppendNative(nsDependentCString(server-&gt;fileName));</span>
<a href="#l81.854"></a><span id="l81.854">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l81.855"></a><span id="l81.855"> </span>
<a href="#l81.856"></a><span id="l81.856">       // close file before delete it</span>
<a href="#l81.857"></a><span id="l81.857">       nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l81.858"></a><span id="l81.858" class="difflineminus">-               do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l81.859"></a><span id="l81.859" class="difflineplus">+          do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l81.860"></a><span id="l81.860"> </span>
<a href="#l81.861"></a><span id="l81.861">       if (NS_SUCCEEDED(rv) &amp;&amp; addrDBFactory)</span>
<a href="#l81.862"></a><span id="l81.862">         rv = addrDBFactory-&gt;Open(dbPath, false, true, getter_AddRefs(database));</span>
<a href="#l81.863"></a><span id="l81.863" class="difflineminus">-      if (database)  /* database exists */</span>
<a href="#l81.864"></a><span id="l81.864" class="difflineplus">+      if (database) /* database exists */</span>
<a href="#l81.865"></a><span id="l81.865">       {</span>
<a href="#l81.866"></a><span id="l81.866">         database-&gt;ForceClosed();</span>
<a href="#l81.867"></a><span id="l81.867">         rv = dbPath-&gt;Remove(false);</span>
<a href="#l81.868"></a><span id="l81.868">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l81.869"></a><span id="l81.869">       }</span>
<a href="#l81.870"></a><span id="l81.870">     }</span>
<a href="#l81.871"></a><span id="l81.871"> </span>
<a href="#l81.872"></a><span id="l81.872" class="difflineminus">-    nsTArray&lt;DIR_Server*&gt; *dirList = DIR_GetDirectories();</span>
<a href="#l81.873"></a><span id="l81.873" class="difflineplus">+    nsTArray&lt;DIR_Server *&gt; *dirList = DIR_GetDirectories();</span>
<a href="#l81.874"></a><span id="l81.874">     DIR_SetServerPosition(dirList, server, DIR_POS_DELETE);</span>
<a href="#l81.875"></a><span id="l81.875">     DIR_DeleteServer(server);</span>
<a href="#l81.876"></a><span id="l81.876"> </span>
<a href="#l81.877"></a><span id="l81.877">     return SavePrefsFile();</span>
<a href="#l81.878"></a><span id="l81.878">   }</span>
<a href="#l81.879"></a><span id="l81.879"> </span>
<a href="#l81.880"></a><span id="l81.880">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l81.881"></a><span id="l81.881"> }</span>
<a href="#l81.882"></a><span id="l81.882"> </span>
<a href="#l81.883"></a><span id="l81.883" class="difflineminus">-static void DIR_DeleteServerList(nsTArray&lt;DIR_Server*&gt; *wholeList)</span>
<a href="#l81.884"></a><span id="l81.884" class="difflineminus">-{</span>
<a href="#l81.885"></a><span id="l81.885" class="difflineminus">-  if (wholeList)</span>
<a href="#l81.886"></a><span id="l81.886" class="difflineminus">-  {</span>
<a href="#l81.887"></a><span id="l81.887" class="difflineplus">+static void DIR_DeleteServerList(nsTArray&lt;DIR_Server *&gt; *wholeList) {</span>
<a href="#l81.888"></a><span id="l81.888" class="difflineplus">+  if (wholeList) {</span>
<a href="#l81.889"></a><span id="l81.889">     DIR_Server *server = nullptr;</span>
<a href="#l81.890"></a><span id="l81.890"> </span>
<a href="#l81.891"></a><span id="l81.891">     /* TBD: Send notifications? */</span>
<a href="#l81.892"></a><span id="l81.892">     int32_t count = wholeList-&gt;Length();</span>
<a href="#l81.893"></a><span id="l81.893">     int32_t i;</span>
<a href="#l81.894"></a><span id="l81.894" class="difflineminus">-    for (i = count - 1; i &gt;=0; i--)</span>
<a href="#l81.895"></a><span id="l81.895" class="difflineminus">-    {</span>
<a href="#l81.896"></a><span id="l81.896" class="difflineplus">+    for (i = count - 1; i &gt;= 0; i--) {</span>
<a href="#l81.897"></a><span id="l81.897">       server = wholeList-&gt;ElementAt(i);</span>
<a href="#l81.898"></a><span id="l81.898" class="difflineminus">-      if (server != nullptr)</span>
<a href="#l81.899"></a><span id="l81.899" class="difflineminus">-        DIR_DeleteServer(server);</span>
<a href="#l81.900"></a><span id="l81.900" class="difflineplus">+      if (server != nullptr) DIR_DeleteServer(server);</span>
<a href="#l81.901"></a><span id="l81.901">     }</span>
<a href="#l81.902"></a><span id="l81.902">     delete wholeList;</span>
<a href="#l81.903"></a><span id="l81.903">   }</span>
<a href="#l81.904"></a><span id="l81.904"> }</span>
<a href="#l81.905"></a><span id="l81.905"> </span>
<a href="#l81.906"></a><span id="l81.906"> /*****************************************************************************</span>
<a href="#l81.907"></a><span id="l81.907">  * Functions for managing JavaScript prefs for the DIR_Servers</span>
<a href="#l81.908"></a><span id="l81.908">  */</span>
<a href="#l81.909"></a><span id="l81.909"> </span>
<a href="#l81.910"></a><span id="l81.910" class="difflineminus">-static int</span>
<a href="#l81.911"></a><span id="l81.911" class="difflineminus">-comparePrefArrayMembers(const void* aElement1, const void* aElement2, void* aData)</span>
<a href="#l81.912"></a><span id="l81.912" class="difflineminus">-{</span>
<a href="#l81.913"></a><span id="l81.913" class="difflineminus">-    const char* element1 = *static_cast&lt;const char* const *&gt;(aElement1);</span>
<a href="#l81.914"></a><span id="l81.914" class="difflineminus">-    const char* element2 = *static_cast&lt;const char* const *&gt;(aElement2);</span>
<a href="#l81.915"></a><span id="l81.915" class="difflineminus">-    const uint32_t offset = *((const uint32_t*)aData);</span>
<a href="#l81.916"></a><span id="l81.916" class="difflineplus">+static int comparePrefArrayMembers(const void *aElement1, const void *aElement2,</span>
<a href="#l81.917"></a><span id="l81.917" class="difflineplus">+                                   void *aData) {</span>
<a href="#l81.918"></a><span id="l81.918" class="difflineplus">+  const char *element1 = *static_cast&lt;const char *const *&gt;(aElement1);</span>
<a href="#l81.919"></a><span id="l81.919" class="difflineplus">+  const char *element2 = *static_cast&lt;const char *const *&gt;(aElement2);</span>
<a href="#l81.920"></a><span id="l81.920" class="difflineplus">+  const uint32_t offset = *((const uint32_t *)aData);</span>
<a href="#l81.921"></a><span id="l81.921"> </span>
<a href="#l81.922"></a><span id="l81.922" class="difflineminus">-    // begin the comparison at |offset| chars into the string -</span>
<a href="#l81.923"></a><span id="l81.923" class="difflineminus">-    // this avoids comparing the &quot;ldap_2.servers.&quot; portion of every element,</span>
<a href="#l81.924"></a><span id="l81.924" class="difflineminus">-    // which will always remain the same.</span>
<a href="#l81.925"></a><span id="l81.925" class="difflineminus">-    return strcmp(element1 + offset, element2 + offset);</span>
<a href="#l81.926"></a><span id="l81.926" class="difflineplus">+  // begin the comparison at |offset| chars into the string -</span>
<a href="#l81.927"></a><span id="l81.927" class="difflineplus">+  // this avoids comparing the &quot;ldap_2.servers.&quot; portion of every element,</span>
<a href="#l81.928"></a><span id="l81.928" class="difflineplus">+  // which will always remain the same.</span>
<a href="#l81.929"></a><span id="l81.929" class="difflineplus">+  return strcmp(element1 + offset, element2 + offset);</span>
<a href="#l81.930"></a><span id="l81.930"> }</span>
<a href="#l81.931"></a><span id="l81.931"> </span>
<a href="#l81.932"></a><span id="l81.932" class="difflineminus">-static nsresult dir_GetChildList(const nsCString &amp;aBranch,</span>
<a href="#l81.933"></a><span id="l81.933" class="difflineminus">-                                 uint32_t *aCount, char ***aChildList)</span>
<a href="#l81.934"></a><span id="l81.934" class="difflineminus">-{</span>
<a href="#l81.935"></a><span id="l81.935" class="difflineminus">-    uint32_t branchLen = aBranch.Length();</span>
<a href="#l81.936"></a><span id="l81.936" class="difflineplus">+static nsresult dir_GetChildList(const nsCString &amp;aBranch, uint32_t *aCount,</span>
<a href="#l81.937"></a><span id="l81.937" class="difflineplus">+                                 char ***aChildList) {</span>
<a href="#l81.938"></a><span id="l81.938" class="difflineplus">+  uint32_t branchLen = aBranch.Length();</span>
<a href="#l81.939"></a><span id="l81.939" class="difflineplus">+</span>
<a href="#l81.940"></a><span id="l81.940" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l81.941"></a><span id="l81.941" class="difflineplus">+  if (!prefBranch) {</span>
<a href="#l81.942"></a><span id="l81.942" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l81.943"></a><span id="l81.943" class="difflineplus">+  }</span>
<a href="#l81.944"></a><span id="l81.944"> </span>
<a href="#l81.945"></a><span id="l81.945" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l81.946"></a><span id="l81.946" class="difflineminus">-    if (!prefBranch) {</span>
<a href="#l81.947"></a><span id="l81.947" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l81.948"></a><span id="l81.948" class="difflineminus">-    }</span>
<a href="#l81.949"></a><span id="l81.949" class="difflineplus">+  nsresult rv = prefBranch-&gt;GetChildList(aBranch.get(), aCount, aChildList);</span>
<a href="#l81.950"></a><span id="l81.950" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l81.951"></a><span id="l81.951" class="difflineplus">+    return rv;</span>
<a href="#l81.952"></a><span id="l81.952" class="difflineplus">+  }</span>
<a href="#l81.953"></a><span id="l81.953" class="difflineplus">+</span>
<a href="#l81.954"></a><span id="l81.954" class="difflineplus">+  // traverse the list, and truncate all the descendant strings to just</span>
<a href="#l81.955"></a><span id="l81.955" class="difflineplus">+  // one branch level below the root branch.</span>
<a href="#l81.956"></a><span id="l81.956" class="difflineplus">+  for (uint32_t i = *aCount; i--;) {</span>
<a href="#l81.957"></a><span id="l81.957" class="difflineplus">+    // The prefname we passed to GetChildList was of the form</span>
<a href="#l81.958"></a><span id="l81.958" class="difflineplus">+    // &quot;ldap_2.servers.&quot; and we are returned the descendants</span>
<a href="#l81.959"></a><span id="l81.959" class="difflineplus">+    // in the form of &quot;ldap_2.servers.servername.foo&quot;</span>
<a href="#l81.960"></a><span id="l81.960" class="difflineplus">+    // But we want the prefbranch of the servername, so</span>
<a href="#l81.961"></a><span id="l81.961" class="difflineplus">+    // write a NUL character in to terminate the string early.</span>
<a href="#l81.962"></a><span id="l81.962" class="difflineplus">+    char *endToken = strchr((*aChildList)[i] + branchLen, '.');</span>
<a href="#l81.963"></a><span id="l81.963" class="difflineplus">+    if (endToken) *endToken = '\0';</span>
<a href="#l81.964"></a><span id="l81.964" class="difflineplus">+  }</span>
<a href="#l81.965"></a><span id="l81.965"> </span>
<a href="#l81.966"></a><span id="l81.966" class="difflineminus">-    nsresult rv = prefBranch-&gt;GetChildList(aBranch.get(), aCount, aChildList);</span>
<a href="#l81.967"></a><span id="l81.967" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l81.968"></a><span id="l81.968" class="difflineminus">-        return rv;</span>
<a href="#l81.969"></a><span id="l81.969" class="difflineminus">-    }</span>
<a href="#l81.970"></a><span id="l81.970" class="difflineplus">+  if (*aCount &gt; 1) {</span>
<a href="#l81.971"></a><span id="l81.971" class="difflineplus">+    // sort the list, in preparation for duplicate entry removal</span>
<a href="#l81.972"></a><span id="l81.972" class="difflineplus">+    NS_QuickSort(*aChildList, *aCount, sizeof(char *), comparePrefArrayMembers,</span>
<a href="#l81.973"></a><span id="l81.973" class="difflineplus">+                 &amp;branchLen);</span>
<a href="#l81.974"></a><span id="l81.974"> </span>
<a href="#l81.975"></a><span id="l81.975" class="difflineminus">-    // traverse the list, and truncate all the descendant strings to just</span>
<a href="#l81.976"></a><span id="l81.976" class="difflineminus">-    // one branch level below the root branch.</span>
<a href="#l81.977"></a><span id="l81.977" class="difflineminus">-    for (uint32_t i = *aCount; i--; ) {</span>
<a href="#l81.978"></a><span id="l81.978" class="difflineminus">-        // The prefname we passed to GetChildList was of the form</span>
<a href="#l81.979"></a><span id="l81.979" class="difflineminus">-        // &quot;ldap_2.servers.&quot; and we are returned the descendants</span>
<a href="#l81.980"></a><span id="l81.980" class="difflineminus">-        // in the form of &quot;ldap_2.servers.servername.foo&quot;</span>
<a href="#l81.981"></a><span id="l81.981" class="difflineminus">-        // But we want the prefbranch of the servername, so</span>
<a href="#l81.982"></a><span id="l81.982" class="difflineminus">-        // write a NUL character in to terminate the string early.</span>
<a href="#l81.983"></a><span id="l81.983" class="difflineminus">-        char *endToken = strchr((*aChildList)[i] + branchLen, '.');</span>
<a href="#l81.984"></a><span id="l81.984" class="difflineminus">-        if (endToken)</span>
<a href="#l81.985"></a><span id="l81.985" class="difflineminus">-            *endToken = '\0';</span>
<a href="#l81.986"></a><span id="l81.986" class="difflineplus">+    // traverse the list and remove duplicate entries.</span>
<a href="#l81.987"></a><span id="l81.987" class="difflineplus">+    // we use two positions in the list; the current entry and the next</span>
<a href="#l81.988"></a><span id="l81.988" class="difflineplus">+    // entry; and perform a bunch of in-place ptr moves. so |cur| points</span>
<a href="#l81.989"></a><span id="l81.989" class="difflineplus">+    // to the last unique entry, and |next| points to some (possibly much</span>
<a href="#l81.990"></a><span id="l81.990" class="difflineplus">+    // later) entry to test, at any given point. we know we have &gt;= 2</span>
<a href="#l81.991"></a><span id="l81.991" class="difflineplus">+    // elements in the list here, so we just init the two counters sensibly</span>
<a href="#l81.992"></a><span id="l81.992" class="difflineplus">+    // to begin with.</span>
<a href="#l81.993"></a><span id="l81.993" class="difflineplus">+    uint32_t cur = 0;</span>
<a href="#l81.994"></a><span id="l81.994" class="difflineplus">+    for (uint32_t next = 1; next &lt; *aCount; ++next) {</span>
<a href="#l81.995"></a><span id="l81.995" class="difflineplus">+      // check if the elements are equal or unique</span>
<a href="#l81.996"></a><span id="l81.996" class="difflineplus">+      if (!comparePrefArrayMembers(&amp;((*aChildList)[cur]),</span>
<a href="#l81.997"></a><span id="l81.997" class="difflineplus">+                                   &amp;((*aChildList)[next]), &amp;branchLen)) {</span>
<a href="#l81.998"></a><span id="l81.998" class="difflineplus">+        // equal - just free &amp; increment the next element ptr</span>
<a href="#l81.999"></a><span id="l81.999" class="difflineplus">+</span>
<a href="#l81.1000"></a><span id="l81.1000" class="difflineplus">+        free((*aChildList)[next]);</span>
<a href="#l81.1001"></a><span id="l81.1001" class="difflineplus">+      } else {</span>
<a href="#l81.1002"></a><span id="l81.1002" class="difflineplus">+        // cur &amp; next are unique, so we need to shift the element.</span>
<a href="#l81.1003"></a><span id="l81.1003" class="difflineplus">+        // ++cur will point to the next free location in the</span>
<a href="#l81.1004"></a><span id="l81.1004" class="difflineplus">+        // reduced array (it's okay if that's == next)</span>
<a href="#l81.1005"></a><span id="l81.1005" class="difflineplus">+        (*aChildList)[++cur] = (*aChildList)[next];</span>
<a href="#l81.1006"></a><span id="l81.1006" class="difflineplus">+      }</span>
<a href="#l81.1007"></a><span id="l81.1007">     }</span>
<a href="#l81.1008"></a><span id="l81.1008"> </span>
<a href="#l81.1009"></a><span id="l81.1009" class="difflineminus">-    if (*aCount &gt; 1) {</span>
<a href="#l81.1010"></a><span id="l81.1010" class="difflineminus">-        // sort the list, in preparation for duplicate entry removal</span>
<a href="#l81.1011"></a><span id="l81.1011" class="difflineminus">-        NS_QuickSort(*aChildList, *aCount, sizeof(char*), comparePrefArrayMembers, &amp;branchLen);</span>
<a href="#l81.1012"></a><span id="l81.1012" class="difflineplus">+    // update the unique element count</span>
<a href="#l81.1013"></a><span id="l81.1013" class="difflineplus">+    *aCount = cur + 1;</span>
<a href="#l81.1014"></a><span id="l81.1014" class="difflineplus">+  }</span>
<a href="#l81.1015"></a><span id="l81.1015"> </span>
<a href="#l81.1016"></a><span id="l81.1016" class="difflineminus">-        // traverse the list and remove duplicate entries.</span>
<a href="#l81.1017"></a><span id="l81.1017" class="difflineminus">-        // we use two positions in the list; the current entry and the next</span>
<a href="#l81.1018"></a><span id="l81.1018" class="difflineminus">-        // entry; and perform a bunch of in-place ptr moves. so |cur| points</span>
<a href="#l81.1019"></a><span id="l81.1019" class="difflineminus">-        // to the last unique entry, and |next| points to some (possibly much</span>
<a href="#l81.1020"></a><span id="l81.1020" class="difflineminus">-        // later) entry to test, at any given point. we know we have &gt;= 2</span>
<a href="#l81.1021"></a><span id="l81.1021" class="difflineminus">-        // elements in the list here, so we just init the two counters sensibly</span>
<a href="#l81.1022"></a><span id="l81.1022" class="difflineminus">-        // to begin with.</span>
<a href="#l81.1023"></a><span id="l81.1023" class="difflineminus">-        uint32_t cur = 0;</span>
<a href="#l81.1024"></a><span id="l81.1024" class="difflineminus">-        for (uint32_t next = 1; next &lt; *aCount; ++next) {</span>
<a href="#l81.1025"></a><span id="l81.1025" class="difflineminus">-            // check if the elements are equal or unique</span>
<a href="#l81.1026"></a><span id="l81.1026" class="difflineminus">-            if (!comparePrefArrayMembers(&amp;((*aChildList)[cur]), &amp;((*aChildList)[next]), &amp;branchLen)) {</span>
<a href="#l81.1027"></a><span id="l81.1027" class="difflineminus">-                // equal - just free &amp; increment the next element ptr</span>
<a href="#l81.1028"></a><span id="l81.1028" class="difflineminus">-</span>
<a href="#l81.1029"></a><span id="l81.1029" class="difflineminus">-                free((*aChildList)[next]);</span>
<a href="#l81.1030"></a><span id="l81.1030" class="difflineminus">-            } else {</span>
<a href="#l81.1031"></a><span id="l81.1031" class="difflineminus">-                // cur &amp; next are unique, so we need to shift the element.</span>
<a href="#l81.1032"></a><span id="l81.1032" class="difflineminus">-                // ++cur will point to the next free location in the</span>
<a href="#l81.1033"></a><span id="l81.1033" class="difflineminus">-                // reduced array (it's okay if that's == next)</span>
<a href="#l81.1034"></a><span id="l81.1034" class="difflineminus">-                (*aChildList)[++cur] = (*aChildList)[next];</span>
<a href="#l81.1035"></a><span id="l81.1035" class="difflineminus">-            }</span>
<a href="#l81.1036"></a><span id="l81.1036" class="difflineminus">-        }</span>
<a href="#l81.1037"></a><span id="l81.1037" class="difflineminus">-</span>
<a href="#l81.1038"></a><span id="l81.1038" class="difflineminus">-        // update the unique element count</span>
<a href="#l81.1039"></a><span id="l81.1039" class="difflineminus">-        *aCount = cur + 1;</span>
<a href="#l81.1040"></a><span id="l81.1040" class="difflineminus">-    }</span>
<a href="#l81.1041"></a><span id="l81.1041" class="difflineminus">-</span>
<a href="#l81.1042"></a><span id="l81.1042" class="difflineminus">-    return NS_OK;</span>
<a href="#l81.1043"></a><span id="l81.1043" class="difflineplus">+  return NS_OK;</span>
<a href="#l81.1044"></a><span id="l81.1044"> }</span>
<a href="#l81.1045"></a><span id="l81.1045"> </span>
<a href="#l81.1046"></a><span id="l81.1046" class="difflineminus">-static char *DIR_GetStringPref(const char *prefRoot, const char *prefLeaf, const char *defaultValue)</span>
<a href="#l81.1047"></a><span id="l81.1047" class="difflineminus">-{</span>
<a href="#l81.1048"></a><span id="l81.1048" class="difflineminus">-    nsresult rv;</span>
<a href="#l81.1049"></a><span id="l81.1049" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1050"></a><span id="l81.1050" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l81.1051"></a><span id="l81.1051" class="difflineminus">-        return nullptr;</span>
<a href="#l81.1052"></a><span id="l81.1052" class="difflineplus">+static char *DIR_GetStringPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l81.1053"></a><span id="l81.1053" class="difflineplus">+                               const char *defaultValue) {</span>
<a href="#l81.1054"></a><span id="l81.1054" class="difflineplus">+  nsresult rv;</span>
<a href="#l81.1055"></a><span id="l81.1055" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1056"></a><span id="l81.1056" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l81.1057"></a><span id="l81.1057"> </span>
<a href="#l81.1058"></a><span id="l81.1058" class="difflineminus">-    nsCString value;</span>
<a href="#l81.1059"></a><span id="l81.1059" class="difflineminus">-    nsAutoCString prefLocation(prefRoot);</span>
<a href="#l81.1060"></a><span id="l81.1060" class="difflineplus">+  nsCString value;</span>
<a href="#l81.1061"></a><span id="l81.1061" class="difflineplus">+  nsAutoCString prefLocation(prefRoot);</span>
<a href="#l81.1062"></a><span id="l81.1062"> </span>
<a href="#l81.1063"></a><span id="l81.1063" class="difflineminus">-    prefLocation.Append('.');</span>
<a href="#l81.1064"></a><span id="l81.1064" class="difflineminus">-    prefLocation.Append(prefLeaf);</span>
<a href="#l81.1065"></a><span id="l81.1065" class="difflineplus">+  prefLocation.Append('.');</span>
<a href="#l81.1066"></a><span id="l81.1066" class="difflineplus">+  prefLocation.Append(prefLeaf);</span>
<a href="#l81.1067"></a><span id="l81.1067"> </span>
<a href="#l81.1068"></a><span id="l81.1068" class="difflineminus">-    if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), value)))</span>
<a href="#l81.1069"></a><span id="l81.1069" class="difflineminus">-    {</span>
<a href="#l81.1070"></a><span id="l81.1070" class="difflineminus">-        /* unfortunately, there may be some prefs out there which look like this */</span>
<a href="#l81.1071"></a><span id="l81.1071" class="difflineminus">-        if (value.EqualsLiteral(&quot;(null)&quot;))</span>
<a href="#l81.1072"></a><span id="l81.1072" class="difflineminus">-        {</span>
<a href="#l81.1073"></a><span id="l81.1073" class="difflineminus">-            if (defaultValue)</span>
<a href="#l81.1074"></a><span id="l81.1074" class="difflineminus">-                value = defaultValue;</span>
<a href="#l81.1075"></a><span id="l81.1075" class="difflineminus">-            else</span>
<a href="#l81.1076"></a><span id="l81.1076" class="difflineminus">-                value.Truncate();</span>
<a href="#l81.1077"></a><span id="l81.1077" class="difflineminus">-        }</span>
<a href="#l81.1078"></a><span id="l81.1078" class="difflineplus">+  if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), value))) {</span>
<a href="#l81.1079"></a><span id="l81.1079" class="difflineplus">+    /* unfortunately, there may be some prefs out there which look like this */</span>
<a href="#l81.1080"></a><span id="l81.1080" class="difflineplus">+    if (value.EqualsLiteral(&quot;(null)&quot;)) {</span>
<a href="#l81.1081"></a><span id="l81.1081" class="difflineplus">+      if (defaultValue)</span>
<a href="#l81.1082"></a><span id="l81.1082" class="difflineplus">+        value = defaultValue;</span>
<a href="#l81.1083"></a><span id="l81.1083" class="difflineplus">+      else</span>
<a href="#l81.1084"></a><span id="l81.1084" class="difflineplus">+        value.Truncate();</span>
<a href="#l81.1085"></a><span id="l81.1085" class="difflineplus">+    }</span>
<a href="#l81.1086"></a><span id="l81.1086"> </span>
<a href="#l81.1087"></a><span id="l81.1087" class="difflineminus">-        if (value.IsEmpty())</span>
<a href="#l81.1088"></a><span id="l81.1088" class="difflineminus">-        {</span>
<a href="#l81.1089"></a><span id="l81.1089" class="difflineminus">-          rv = pPref-&gt;GetCharPref(prefLocation.get(), value);</span>
<a href="#l81.1090"></a><span id="l81.1090" class="difflineminus">-        }</span>
<a href="#l81.1091"></a><span id="l81.1091" class="difflineplus">+    if (value.IsEmpty()) {</span>
<a href="#l81.1092"></a><span id="l81.1092" class="difflineplus">+      rv = pPref-&gt;GetCharPref(prefLocation.get(), value);</span>
<a href="#l81.1093"></a><span id="l81.1093">     }</span>
<a href="#l81.1094"></a><span id="l81.1094" class="difflineminus">-    else</span>
<a href="#l81.1095"></a><span id="l81.1095" class="difflineminus">-        value = defaultValue;</span>
<a href="#l81.1096"></a><span id="l81.1096" class="difflineplus">+  } else</span>
<a href="#l81.1097"></a><span id="l81.1097" class="difflineplus">+    value = defaultValue;</span>
<a href="#l81.1098"></a><span id="l81.1098"> </span>
<a href="#l81.1099"></a><span id="l81.1099" class="difflineminus">-    return ToNewCString(value);</span>
<a href="#l81.1100"></a><span id="l81.1100" class="difflineplus">+  return ToNewCString(value);</span>
<a href="#l81.1101"></a><span id="l81.1101"> }</span>
<a href="#l81.1102"></a><span id="l81.1102"> </span>
<a href="#l81.1103"></a><span id="l81.1103"> /**</span>
<a href="#l81.1104"></a><span id="l81.1104" class="difflineminus">- * Get localized unicode string pref from properties file, convert into an UTF8 string</span>
<a href="#l81.1105"></a><span id="l81.1105" class="difflineminus">- * since address book prefs store as UTF8 strings. So far there are 2 default</span>
<a href="#l81.1106"></a><span id="l81.1106" class="difflineminus">- * prefs stored in addressbook.properties.</span>
<a href="#l81.1107"></a><span id="l81.1107" class="difflineplus">+ * Get localized unicode string pref from properties file, convert into an UTF8</span>
<a href="#l81.1108"></a><span id="l81.1108" class="difflineplus">+ * string since address book prefs store as UTF8 strings. So far there are 2</span>
<a href="#l81.1109"></a><span id="l81.1109" class="difflineplus">+ * default prefs stored in addressbook.properties.</span>
<a href="#l81.1110"></a><span id="l81.1110">  * &quot;ldap_2.servers.pab.description&quot;</span>
<a href="#l81.1111"></a><span id="l81.1111">  * &quot;ldap_2.servers.history.description&quot;</span>
<a href="#l81.1112"></a><span id="l81.1112">  */</span>
<a href="#l81.1113"></a><span id="l81.1113" class="difflineminus">-static char *DIR_GetLocalizedStringPref(const char *prefRoot, const char *prefLeaf)</span>
<a href="#l81.1114"></a><span id="l81.1114" class="difflineminus">-{</span>
<a href="#l81.1115"></a><span id="l81.1115" class="difflineplus">+static char *DIR_GetLocalizedStringPref(const char *prefRoot,</span>
<a href="#l81.1116"></a><span id="l81.1116" class="difflineplus">+                                        const char *prefLeaf) {</span>
<a href="#l81.1117"></a><span id="l81.1117">   nsresult rv;</span>
<a href="#l81.1118"></a><span id="l81.1118">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1119"></a><span id="l81.1119"> </span>
<a href="#l81.1120"></a><span id="l81.1120" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1121"></a><span id="l81.1121" class="difflineminus">-    return nullptr;</span>
<a href="#l81.1122"></a><span id="l81.1122" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l81.1123"></a><span id="l81.1123"> </span>
<a href="#l81.1124"></a><span id="l81.1124">   nsAutoCString prefLocation(prefRoot);</span>
<a href="#l81.1125"></a><span id="l81.1125">   if (prefLeaf) {</span>
<a href="#l81.1126"></a><span id="l81.1126">     prefLocation.Append('.');</span>
<a href="#l81.1127"></a><span id="l81.1127">     prefLocation.Append(prefLeaf);</span>
<a href="#l81.1128"></a><span id="l81.1128">   }</span>
<a href="#l81.1129"></a><span id="l81.1129"> </span>
<a href="#l81.1130"></a><span id="l81.1130">   nsString wvalue;</span>
<a href="#l81.1131"></a><span id="l81.1131">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; locStr;</span>
<a href="#l81.1132"></a><span id="l81.1132"> </span>
<a href="#l81.1133"></a><span id="l81.1133" class="difflineminus">-  rv = pPref-&gt;GetComplexValue(prefLocation.get(), NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(locStr));</span>
<a href="#l81.1134"></a><span id="l81.1134" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l81.1135"></a><span id="l81.1135" class="difflineminus">-    rv = locStr-&gt;ToString(getter_Copies(wvalue));</span>
<a href="#l81.1136"></a><span id="l81.1136" class="difflineplus">+  rv = pPref-&gt;GetComplexValue(prefLocation.get(),</span>
<a href="#l81.1137"></a><span id="l81.1137" class="difflineplus">+                              NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l81.1138"></a><span id="l81.1138" class="difflineplus">+                              getter_AddRefs(locStr));</span>
<a href="#l81.1139"></a><span id="l81.1139" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = locStr-&gt;ToString(getter_Copies(wvalue));</span>
<a href="#l81.1140"></a><span id="l81.1140"> </span>
<a href="#l81.1141"></a><span id="l81.1141">   nsCString value;</span>
<a href="#l81.1142"></a><span id="l81.1142" class="difflineminus">-  if (!wvalue.IsEmpty())</span>
<a href="#l81.1143"></a><span id="l81.1143" class="difflineminus">-  {</span>
<a href="#l81.1144"></a><span id="l81.1144" class="difflineplus">+  if (!wvalue.IsEmpty()) {</span>
<a href="#l81.1145"></a><span id="l81.1145">     value = NS_ConvertUTF16toUTF8(wvalue);</span>
<a href="#l81.1146"></a><span id="l81.1146" class="difflineminus">-  }</span>
<a href="#l81.1147"></a><span id="l81.1147" class="difflineminus">-  else</span>
<a href="#l81.1148"></a><span id="l81.1148" class="difflineminus">-  {</span>
<a href="#l81.1149"></a><span id="l81.1149" class="difflineminus">-    // In TB 2 only some prefs had chrome:// URIs. We had code in place that would</span>
<a href="#l81.1150"></a><span id="l81.1150" class="difflineminus">-    // only get the localized string pref for the particular address books that</span>
<a href="#l81.1151"></a><span id="l81.1151" class="difflineminus">-    // were built-in.</span>
<a href="#l81.1152"></a><span id="l81.1152" class="difflineminus">-    // Additionally, nsIPrefBranch::getComplexValue will only get a non-user-set,</span>
<a href="#l81.1153"></a><span id="l81.1153" class="difflineminus">-    // non-locked pref value if it is a chrome:// URI and will get the string</span>
<a href="#l81.1154"></a><span id="l81.1154" class="difflineminus">-    // value at that chrome URI. This breaks extensions/autoconfig that want to</span>
<a href="#l81.1155"></a><span id="l81.1155" class="difflineminus">-    // set default pref values and allow users to change directory names.</span>
<a href="#l81.1156"></a><span id="l81.1156" class="difflineplus">+  } else {</span>
<a href="#l81.1157"></a><span id="l81.1157" class="difflineplus">+    // In TB 2 only some prefs had chrome:// URIs. We had code in place that</span>
<a href="#l81.1158"></a><span id="l81.1158" class="difflineplus">+    // would only get the localized string pref for the particular address books</span>
<a href="#l81.1159"></a><span id="l81.1159" class="difflineplus">+    // that were built-in. Additionally, nsIPrefBranch::getComplexValue will</span>
<a href="#l81.1160"></a><span id="l81.1160" class="difflineplus">+    // only get a non-user-set, non-locked pref value if it is a chrome:// URI</span>
<a href="#l81.1161"></a><span id="l81.1161" class="difflineplus">+    // and will get the string value at that chrome URI. This breaks</span>
<a href="#l81.1162"></a><span id="l81.1162" class="difflineplus">+    // extensions/autoconfig that want to set default pref values and allow</span>
<a href="#l81.1163"></a><span id="l81.1163" class="difflineplus">+    // users to change directory names.</span>
<a href="#l81.1164"></a><span id="l81.1164">     //</span>
<a href="#l81.1165"></a><span id="l81.1165">     // Now we have to support this, and so if for whatever reason we fail to get</span>
<a href="#l81.1166"></a><span id="l81.1166">     // the localized version, then we try and get the non-localized version</span>
<a href="#l81.1167"></a><span id="l81.1167" class="difflineminus">-    // instead. If the string value is empty, then we'll just get the empty value</span>
<a href="#l81.1168"></a><span id="l81.1168" class="difflineminus">-    // back here.</span>
<a href="#l81.1169"></a><span id="l81.1169" class="difflineplus">+    // instead. If the string value is empty, then we'll just get the empty</span>
<a href="#l81.1170"></a><span id="l81.1170" class="difflineplus">+    // value back here.</span>
<a href="#l81.1171"></a><span id="l81.1171">     rv = pPref-&gt;GetCharPref(prefLocation.get(), value);</span>
<a href="#l81.1172"></a><span id="l81.1172" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l81.1173"></a><span id="l81.1173" class="difflineminus">-      value.Truncate();</span>
<a href="#l81.1174"></a><span id="l81.1174" class="difflineplus">+    if (NS_FAILED(rv)) value.Truncate();</span>
<a href="#l81.1175"></a><span id="l81.1175">   }</span>
<a href="#l81.1176"></a><span id="l81.1176"> </span>
<a href="#l81.1177"></a><span id="l81.1177">   return moz_xstrdup(value.get());</span>
<a href="#l81.1178"></a><span id="l81.1178"> }</span>
<a href="#l81.1179"></a><span id="l81.1179"> </span>
<a href="#l81.1180"></a><span id="l81.1180" class="difflineminus">-static int32_t DIR_GetIntPref(const char *prefRoot, const char *prefLeaf, int32_t defaultValue)</span>
<a href="#l81.1181"></a><span id="l81.1181" class="difflineminus">-{</span>
<a href="#l81.1182"></a><span id="l81.1182" class="difflineplus">+static int32_t DIR_GetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l81.1183"></a><span id="l81.1183" class="difflineplus">+                              int32_t defaultValue) {</span>
<a href="#l81.1184"></a><span id="l81.1184">   nsresult rv;</span>
<a href="#l81.1185"></a><span id="l81.1185">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1186"></a><span id="l81.1186"> </span>
<a href="#l81.1187"></a><span id="l81.1187" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1188"></a><span id="l81.1188" class="difflineminus">-    return defaultValue;</span>
<a href="#l81.1189"></a><span id="l81.1189" class="difflineplus">+  if (NS_FAILED(rv)) return defaultValue;</span>
<a href="#l81.1190"></a><span id="l81.1190"> </span>
<a href="#l81.1191"></a><span id="l81.1191">   int32_t value;</span>
<a href="#l81.1192"></a><span id="l81.1192">   nsAutoCString prefLocation(prefRoot);</span>
<a href="#l81.1193"></a><span id="l81.1193"> </span>
<a href="#l81.1194"></a><span id="l81.1194">   prefLocation.Append('.');</span>
<a href="#l81.1195"></a><span id="l81.1195">   prefLocation.Append(prefLeaf);</span>
<a href="#l81.1196"></a><span id="l81.1196"> </span>
<a href="#l81.1197"></a><span id="l81.1197">   if (NS_FAILED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;value)))</span>
<a href="#l81.1198"></a><span id="l81.1198">     value = defaultValue;</span>
<a href="#l81.1199"></a><span id="l81.1199"> </span>
<a href="#l81.1200"></a><span id="l81.1200">   return value;</span>
<a href="#l81.1201"></a><span id="l81.1201"> }</span>
<a href="#l81.1202"></a><span id="l81.1202"> </span>
<a href="#l81.1203"></a><span id="l81.1203"> /* This will convert from the old preference that was a path and filename */</span>
<a href="#l81.1204"></a><span id="l81.1204"> /* to a just a filename */</span>
<a href="#l81.1205"></a><span id="l81.1205" class="difflineminus">-static void DIR_ConvertServerFileName(DIR_Server* pServer)</span>
<a href="#l81.1206"></a><span id="l81.1206" class="difflineminus">-{</span>
<a href="#l81.1207"></a><span id="l81.1207" class="difflineminus">-  char* leafName = pServer-&gt;fileName;</span>
<a href="#l81.1208"></a><span id="l81.1208" class="difflineminus">-  char* newLeafName = nullptr;</span>
<a href="#l81.1209"></a><span id="l81.1209" class="difflineplus">+static void DIR_ConvertServerFileName(DIR_Server *pServer) {</span>
<a href="#l81.1210"></a><span id="l81.1210" class="difflineplus">+  char *leafName = pServer-&gt;fileName;</span>
<a href="#l81.1211"></a><span id="l81.1211" class="difflineplus">+  char *newLeafName = nullptr;</span>
<a href="#l81.1212"></a><span id="l81.1212"> #if defined(XP_WIN)</span>
<a href="#l81.1213"></a><span id="l81.1213">   /* jefft -- bug 73349 This is to allow users share same address book.</span>
<a href="#l81.1214"></a><span id="l81.1214">    * It only works if the user specify a full path filename.</span>
<a href="#l81.1215"></a><span id="l81.1215">    */</span>
<a href="#l81.1216"></a><span id="l81.1216" class="difflineminus">-#ifdef XP_FileIsFullPath</span>
<a href="#l81.1217"></a><span id="l81.1217" class="difflineminus">-  if (! XP_FileIsFullPath(leafName))</span>
<a href="#l81.1218"></a><span id="l81.1218" class="difflineminus">-    newLeafName = XP_STRRCHR (leafName, '\\');</span>
<a href="#l81.1219"></a><span id="l81.1219" class="difflineminus">-#endif /* XP_FileIsFullPath */</span>
<a href="#l81.1220"></a><span id="l81.1220" class="difflineplus">+#  ifdef XP_FileIsFullPath</span>
<a href="#l81.1221"></a><span id="l81.1221" class="difflineplus">+  if (!XP_FileIsFullPath(leafName)) newLeafName = XP_STRRCHR(leafName, '\\');</span>
<a href="#l81.1222"></a><span id="l81.1222" class="difflineplus">+#  endif /* XP_FileIsFullPath */</span>
<a href="#l81.1223"></a><span id="l81.1223"> #else</span>
<a href="#l81.1224"></a><span id="l81.1224">   newLeafName = strrchr(leafName, '/');</span>
<a href="#l81.1225"></a><span id="l81.1225"> #endif</span>
<a href="#l81.1226"></a><span id="l81.1226" class="difflineminus">-    pServer-&gt;fileName = newLeafName ? strdup(newLeafName + 1) : strdup(leafName);</span>
<a href="#l81.1227"></a><span id="l81.1227" class="difflineplus">+  pServer-&gt;fileName = newLeafName ? strdup(newLeafName + 1) : strdup(leafName);</span>
<a href="#l81.1228"></a><span id="l81.1228">   if (leafName) PR_Free(leafName);</span>
<a href="#l81.1229"></a><span id="l81.1229"> }</span>
<a href="#l81.1230"></a><span id="l81.1230"> </span>
<a href="#l81.1231"></a><span id="l81.1231"> /* This will generate a correct filename and then remove the path.</span>
<a href="#l81.1232"></a><span id="l81.1232">  * Note: we are assuming that the default name is in the native</span>
<a href="#l81.1233"></a><span id="l81.1233">  * filesystem charset. The filename will be returned as a UTF8</span>
<a href="#l81.1234"></a><span id="l81.1234">  * string.</span>
<a href="#l81.1235"></a><span id="l81.1235">  */</span>
<a href="#l81.1236"></a><span id="l81.1236" class="difflineminus">-void DIR_SetFileName(char** fileName, const char* defaultName)</span>
<a href="#l81.1237"></a><span id="l81.1237" class="difflineminus">-{</span>
<a href="#l81.1238"></a><span id="l81.1238" class="difflineminus">-  if (!fileName)</span>
<a href="#l81.1239"></a><span id="l81.1239" class="difflineminus">-    return;</span>
<a href="#l81.1240"></a><span id="l81.1240" class="difflineplus">+void DIR_SetFileName(char **fileName, const char *defaultName) {</span>
<a href="#l81.1241"></a><span id="l81.1241" class="difflineplus">+  if (!fileName) return;</span>
<a href="#l81.1242"></a><span id="l81.1242"> </span>
<a href="#l81.1243"></a><span id="l81.1243">   nsresult rv = NS_OK;</span>
<a href="#l81.1244"></a><span id="l81.1244">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l81.1245"></a><span id="l81.1245"> </span>
<a href="#l81.1246"></a><span id="l81.1246">   *fileName = nullptr;</span>
<a href="#l81.1247"></a><span id="l81.1247"> </span>
<a href="#l81.1248"></a><span id="l81.1248" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l81.1249"></a><span id="l81.1249" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l81.1250"></a><span id="l81.1250" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l81.1251"></a><span id="l81.1251">   if (NS_SUCCEEDED(rv))</span>
<a href="#l81.1252"></a><span id="l81.1252">     rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l81.1253"></a><span id="l81.1253" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l81.1254"></a><span id="l81.1254" class="difflineminus">-  {</span>
<a href="#l81.1255"></a><span id="l81.1255" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l81.1256"></a><span id="l81.1256">     rv = dbPath-&gt;AppendNative(nsDependentCString(defaultName));</span>
<a href="#l81.1257"></a><span id="l81.1257" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l81.1258"></a><span id="l81.1258" class="difflineminus">-    {</span>
<a href="#l81.1259"></a><span id="l81.1259" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l81.1260"></a><span id="l81.1260">       rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0664);</span>
<a href="#l81.1261"></a><span id="l81.1261"> </span>
<a href="#l81.1262"></a><span id="l81.1262">       nsAutoString realFileName;</span>
<a href="#l81.1263"></a><span id="l81.1263">       rv = dbPath-&gt;GetLeafName(realFileName);</span>
<a href="#l81.1264"></a><span id="l81.1264"> </span>
<a href="#l81.1265"></a><span id="l81.1265" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l81.1266"></a><span id="l81.1266" class="difflineminus">-        *fileName = ToNewUTF8String(realFileName);</span>
<a href="#l81.1267"></a><span id="l81.1267" class="difflineplus">+      if (NS_SUCCEEDED(rv)) *fileName = ToNewUTF8String(realFileName);</span>
<a href="#l81.1268"></a><span id="l81.1268">     }</span>
<a href="#l81.1269"></a><span id="l81.1269">   }</span>
<a href="#l81.1270"></a><span id="l81.1270"> }</span>
<a href="#l81.1271"></a><span id="l81.1271"> </span>
<a href="#l81.1272"></a><span id="l81.1272"> /****************************************************************</span>
<a href="#l81.1273"></a><span id="l81.1273"> Helper function used to generate a file name from the description</span>
<a href="#l81.1274"></a><span id="l81.1274"> of a directory. Caller must free returned string.</span>
<a href="#l81.1275"></a><span id="l81.1275"> An extension is not applied</span>
<a href="#l81.1276"></a><span id="l81.1276"> *****************************************************************/</span>
<a href="#l81.1277"></a><span id="l81.1277"> </span>
<a href="#l81.1278"></a><span id="l81.1278" class="difflineminus">-static char * dir_ConvertDescriptionToPrefName(DIR_Server * server)</span>
<a href="#l81.1279"></a><span id="l81.1279" class="difflineminus">-{</span>
<a href="#l81.1280"></a><span id="l81.1280" class="difflineplus">+static char *dir_ConvertDescriptionToPrefName(DIR_Server *server) {</span>
<a href="#l81.1281"></a><span id="l81.1281"> #define MAX_PREF_NAME_SIZE 25</span>
<a href="#l81.1282"></a><span id="l81.1282" class="difflineminus">-  char * fileName = nullptr;</span>
<a href="#l81.1283"></a><span id="l81.1283" class="difflineplus">+  char *fileName = nullptr;</span>
<a href="#l81.1284"></a><span id="l81.1284">   char fileNameBuf[MAX_PREF_NAME_SIZE];</span>
<a href="#l81.1285"></a><span id="l81.1285">   int32_t srcIndex = 0;</span>
<a href="#l81.1286"></a><span id="l81.1286">   int32_t destIndex = 0;</span>
<a href="#l81.1287"></a><span id="l81.1287">   int32_t numSrcBytes = 0;</span>
<a href="#l81.1288"></a><span id="l81.1288" class="difflineminus">-  const char * descr = nullptr;</span>
<a href="#l81.1289"></a><span id="l81.1289" class="difflineminus">-  if (server &amp;&amp; server-&gt;description)</span>
<a href="#l81.1290"></a><span id="l81.1290" class="difflineminus">-  {</span>
<a href="#l81.1291"></a><span id="l81.1291" class="difflineplus">+  const char *descr = nullptr;</span>
<a href="#l81.1292"></a><span id="l81.1292" class="difflineplus">+  if (server &amp;&amp; server-&gt;description) {</span>
<a href="#l81.1293"></a><span id="l81.1293">     descr = server-&gt;description;</span>
<a href="#l81.1294"></a><span id="l81.1294">     numSrcBytes = PL_strlen(descr);</span>
<a href="#l81.1295"></a><span id="l81.1295" class="difflineminus">-    while (srcIndex &lt; numSrcBytes &amp;&amp; destIndex &lt; MAX_PREF_NAME_SIZE-1)</span>
<a href="#l81.1296"></a><span id="l81.1296" class="difflineminus">-    {</span>
<a href="#l81.1297"></a><span id="l81.1297" class="difflineminus">-      if (IS_DIGIT(descr[srcIndex]) || IS_ALPHA(descr[srcIndex]))</span>
<a href="#l81.1298"></a><span id="l81.1298" class="difflineminus">-      {</span>
<a href="#l81.1299"></a><span id="l81.1299" class="difflineplus">+    while (srcIndex &lt; numSrcBytes &amp;&amp; destIndex &lt; MAX_PREF_NAME_SIZE - 1) {</span>
<a href="#l81.1300"></a><span id="l81.1300" class="difflineplus">+      if (IS_DIGIT(descr[srcIndex]) || IS_ALPHA(descr[srcIndex])) {</span>
<a href="#l81.1301"></a><span id="l81.1301">         fileNameBuf[destIndex] = descr[srcIndex];</span>
<a href="#l81.1302"></a><span id="l81.1302">         destIndex++;</span>
<a href="#l81.1303"></a><span id="l81.1303">       }</span>
<a href="#l81.1304"></a><span id="l81.1304"> </span>
<a href="#l81.1305"></a><span id="l81.1305">       srcIndex++;</span>
<a href="#l81.1306"></a><span id="l81.1306">     }</span>
<a href="#l81.1307"></a><span id="l81.1307"> </span>
<a href="#l81.1308"></a><span id="l81.1308">     fileNameBuf[destIndex] = '\0'; /* zero out the last character */</span>
<a href="#l81.1309"></a><span id="l81.1309">   }</span>
<a href="#l81.1310"></a><span id="l81.1310"> </span>
<a href="#l81.1311"></a><span id="l81.1311">   if (destIndex) /* have at least one character in the file name? */</span>
<a href="#l81.1312"></a><span id="l81.1312" class="difflineminus">-  fileName = strdup(fileNameBuf);</span>
<a href="#l81.1313"></a><span id="l81.1313" class="difflineplus">+    fileName = strdup(fileNameBuf);</span>
<a href="#l81.1314"></a><span id="l81.1314"> </span>
<a href="#l81.1315"></a><span id="l81.1315">   return fileName;</span>
<a href="#l81.1316"></a><span id="l81.1316"> }</span>
<a href="#l81.1317"></a><span id="l81.1317"> </span>
<a href="#l81.1318"></a><span id="l81.1318" class="difflineminus">-</span>
<a href="#l81.1319"></a><span id="l81.1319" class="difflineminus">-void DIR_SetServerFileName(DIR_Server *server)</span>
<a href="#l81.1320"></a><span id="l81.1320" class="difflineminus">-{</span>
<a href="#l81.1321"></a><span id="l81.1321" class="difflineminus">-  char * tempName = nullptr;</span>
<a href="#l81.1322"></a><span id="l81.1322" class="difflineminus">-  const char * prefName = nullptr;</span>
<a href="#l81.1323"></a><span id="l81.1323" class="difflineplus">+void DIR_SetServerFileName(DIR_Server *server) {</span>
<a href="#l81.1324"></a><span id="l81.1324" class="difflineplus">+  char *tempName = nullptr;</span>
<a href="#l81.1325"></a><span id="l81.1325" class="difflineplus">+  const char *prefName = nullptr;</span>
<a href="#l81.1326"></a><span id="l81.1326">   uint32_t numHeaderBytes = 0;</span>
<a href="#l81.1327"></a><span id="l81.1327"> </span>
<a href="#l81.1328"></a><span id="l81.1328" class="difflineminus">-  if (server &amp;&amp; (!server-&gt;fileName || !(*server-&gt;fileName)) )</span>
<a href="#l81.1329"></a><span id="l81.1329" class="difflineminus">-  {</span>
<a href="#l81.1330"></a><span id="l81.1330" class="difflineminus">-          PR_FREEIF(server-&gt;fileName); // might be one byte empty string.</span>
<a href="#l81.1331"></a><span id="l81.1331" class="difflineplus">+  if (server &amp;&amp; (!server-&gt;fileName || !(*server-&gt;fileName))) {</span>
<a href="#l81.1332"></a><span id="l81.1332" class="difflineplus">+    PR_FREEIF(server-&gt;fileName);  // might be one byte empty string.</span>
<a href="#l81.1333"></a><span id="l81.1333">     /* make sure we have a pref name...*/</span>
<a href="#l81.1334"></a><span id="l81.1334">     if (!server-&gt;prefName || !*server-&gt;prefName)</span>
<a href="#l81.1335"></a><span id="l81.1335">       server-&gt;prefName = dir_CreateServerPrefName(server);</span>
<a href="#l81.1336"></a><span id="l81.1336"> </span>
<a href="#l81.1337"></a><span id="l81.1337">     /* set default personal address book file name*/</span>
<a href="#l81.1338"></a><span id="l81.1338">     if ((server-&gt;position == 1) &amp;&amp; (server-&gt;dirType == PABDirectory))</span>
<a href="#l81.1339"></a><span id="l81.1339" class="difflineminus">-            server-&gt;fileName = strdup(kPersonalAddressbook);</span>
<a href="#l81.1340"></a><span id="l81.1340" class="difflineminus">-    else</span>
<a href="#l81.1341"></a><span id="l81.1341" class="difflineminus">-    {</span>
<a href="#l81.1342"></a><span id="l81.1342" class="difflineplus">+      server-&gt;fileName = strdup(kPersonalAddressbook);</span>
<a href="#l81.1343"></a><span id="l81.1343" class="difflineplus">+    else {</span>
<a href="#l81.1344"></a><span id="l81.1344">       /* now use the pref name as the file name since we know the pref name</span>
<a href="#l81.1345"></a><span id="l81.1345">          will be unique */</span>
<a href="#l81.1346"></a><span id="l81.1346">       prefName = server-&gt;prefName;</span>
<a href="#l81.1347"></a><span id="l81.1347" class="difflineminus">-      if (prefName &amp;&amp; *prefName)</span>
<a href="#l81.1348"></a><span id="l81.1348" class="difflineminus">-      {</span>
<a href="#l81.1349"></a><span id="l81.1349" class="difflineminus">-        /* extract just the pref name part and not the ldap tree name portion from the string */</span>
<a href="#l81.1350"></a><span id="l81.1350" class="difflineminus">-        numHeaderBytes = PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1; /* + 1 for the '.' b4 the name */</span>
<a href="#l81.1351"></a><span id="l81.1351" class="difflineplus">+      if (prefName &amp;&amp; *prefName) {</span>
<a href="#l81.1352"></a><span id="l81.1352" class="difflineplus">+        /* extract just the pref name part and not the ldap tree name portion</span>
<a href="#l81.1353"></a><span id="l81.1353" class="difflineplus">+         * from the string */</span>
<a href="#l81.1354"></a><span id="l81.1354" class="difflineplus">+        numHeaderBytes = PL_strlen(PREF_LDAP_SERVER_TREE_NAME) +</span>
<a href="#l81.1355"></a><span id="l81.1355" class="difflineplus">+                         1; /* + 1 for the '.' b4 the name */</span>
<a href="#l81.1356"></a><span id="l81.1356">         if (PL_strlen(prefName) &gt; numHeaderBytes)</span>
<a href="#l81.1357"></a><span id="l81.1357" class="difflineminus">-                    tempName = strdup(prefName + numHeaderBytes);</span>
<a href="#l81.1358"></a><span id="l81.1358" class="difflineplus">+          tempName = strdup(prefName + numHeaderBytes);</span>
<a href="#l81.1359"></a><span id="l81.1359"> </span>
<a href="#l81.1360"></a><span id="l81.1360" class="difflineminus">-        if (tempName)</span>
<a href="#l81.1361"></a><span id="l81.1361" class="difflineminus">-        {</span>
<a href="#l81.1362"></a><span id="l81.1362" class="difflineminus">-          server-&gt;fileName = PR_smprintf(&quot;%s%s&quot;, tempName, kABFileName_CurrentSuffix);</span>
<a href="#l81.1363"></a><span id="l81.1363" class="difflineplus">+        if (tempName) {</span>
<a href="#l81.1364"></a><span id="l81.1364" class="difflineplus">+          server-&gt;fileName =</span>
<a href="#l81.1365"></a><span id="l81.1365" class="difflineplus">+              PR_smprintf(&quot;%s%s&quot;, tempName, kABFileName_CurrentSuffix);</span>
<a href="#l81.1366"></a><span id="l81.1366">           PR_Free(tempName);</span>
<a href="#l81.1367"></a><span id="l81.1367">         }</span>
<a href="#l81.1368"></a><span id="l81.1368">       }</span>
<a href="#l81.1369"></a><span id="l81.1369">     }</span>
<a href="#l81.1370"></a><span id="l81.1370"> </span>
<a href="#l81.1371"></a><span id="l81.1371" class="difflineminus">-    if (!server-&gt;fileName || !*server-&gt;fileName) /* when all else has failed, generate a default name */</span>
<a href="#l81.1372"></a><span id="l81.1372" class="difflineplus">+    if (!server-&gt;fileName || !*server-&gt;fileName) /* when all else has failed,</span>
<a href="#l81.1373"></a><span id="l81.1373" class="difflineplus">+                                                    generate a default name */</span>
<a href="#l81.1374"></a><span id="l81.1374">     {</span>
<a href="#l81.1375"></a><span id="l81.1375">       if (server-&gt;dirType == LDAPDirectory)</span>
<a href="#l81.1376"></a><span id="l81.1376" class="difflineminus">-        DIR_SetFileName(&amp;(server-&gt;fileName), kMainLdapAddressBook); /* generates file name with an ldap prefix */</span>
<a href="#l81.1377"></a><span id="l81.1377" class="difflineplus">+        DIR_SetFileName(</span>
<a href="#l81.1378"></a><span id="l81.1378" class="difflineplus">+            &amp;(server-&gt;fileName),</span>
<a href="#l81.1379"></a><span id="l81.1379" class="difflineplus">+            kMainLdapAddressBook); /* generates file name with an ldap prefix */</span>
<a href="#l81.1380"></a><span id="l81.1380">       else</span>
<a href="#l81.1381"></a><span id="l81.1381">         DIR_SetFileName(&amp;(server-&gt;fileName), kPersonalAddressbook);</span>
<a href="#l81.1382"></a><span id="l81.1382">     }</span>
<a href="#l81.1383"></a><span id="l81.1383">   }</span>
<a href="#l81.1384"></a><span id="l81.1384"> }</span>
<a href="#l81.1385"></a><span id="l81.1385"> </span>
<a href="#l81.1386"></a><span id="l81.1386" class="difflineminus">-static char *dir_CreateServerPrefName (DIR_Server *server)</span>
<a href="#l81.1387"></a><span id="l81.1387" class="difflineminus">-{</span>
<a href="#l81.1388"></a><span id="l81.1388" class="difflineplus">+static char *dir_CreateServerPrefName(DIR_Server *server) {</span>
<a href="#l81.1389"></a><span id="l81.1389">   /* we are going to try to be smart in how we generate our server</span>
<a href="#l81.1390"></a><span id="l81.1390">      pref name. We'll try to convert the description into a pref name</span>
<a href="#l81.1391"></a><span id="l81.1391">      and then verify that it is unique. If it is unique then use it... */</span>
<a href="#l81.1392"></a><span id="l81.1392" class="difflineminus">-  char * leafName = dir_ConvertDescriptionToPrefName(server);</span>
<a href="#l81.1393"></a><span id="l81.1393" class="difflineminus">-  char * prefName = nullptr;</span>
<a href="#l81.1394"></a><span id="l81.1394" class="difflineplus">+  char *leafName = dir_ConvertDescriptionToPrefName(server);</span>
<a href="#l81.1395"></a><span id="l81.1395" class="difflineplus">+  char *prefName = nullptr;</span>
<a href="#l81.1396"></a><span id="l81.1396">   bool isUnique = false;</span>
<a href="#l81.1397"></a><span id="l81.1397"> </span>
<a href="#l81.1398"></a><span id="l81.1398" class="difflineminus">-  if (!leafName || !*leafName)</span>
<a href="#l81.1399"></a><span id="l81.1399" class="difflineminus">-  {</span>
<a href="#l81.1400"></a><span id="l81.1400" class="difflineplus">+  if (!leafName || !*leafName) {</span>
<a href="#l81.1401"></a><span id="l81.1401">     // we need to handle this in case the description has no alphanumeric chars</span>
<a href="#l81.1402"></a><span id="l81.1402">     // it's very common for cjk users</span>
<a href="#l81.1403"></a><span id="l81.1403">     leafName = strdup(&quot;_nonascii&quot;);</span>
<a href="#l81.1404"></a><span id="l81.1404">   }</span>
<a href="#l81.1405"></a><span id="l81.1405"> </span>
<a href="#l81.1406"></a><span id="l81.1406" class="difflineminus">-  if (leafName)</span>
<a href="#l81.1407"></a><span id="l81.1407" class="difflineminus">-  {</span>
<a href="#l81.1408"></a><span id="l81.1408" class="difflineplus">+  if (leafName) {</span>
<a href="#l81.1409"></a><span id="l81.1409">     int32_t uniqueIDCnt = 0;</span>
<a href="#l81.1410"></a><span id="l81.1410" class="difflineminus">-        char **children = nullptr;</span>
<a href="#l81.1411"></a><span id="l81.1411" class="difflineplus">+    char **children = nullptr;</span>
<a href="#l81.1412"></a><span id="l81.1412">     /* we need to verify that this pref string name is unique */</span>
<a href="#l81.1413"></a><span id="l81.1413" class="difflineminus">-    prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME&quot;.%s&quot;, leafName);</span>
<a href="#l81.1414"></a><span id="l81.1414" class="difflineplus">+    prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.%s&quot;, leafName);</span>
<a href="#l81.1415"></a><span id="l81.1415">     isUnique = false;</span>
<a href="#l81.1416"></a><span id="l81.1416">     uint32_t prefCount;</span>
<a href="#l81.1417"></a><span id="l81.1417" class="difflineminus">-    nsresult rv = dir_GetChildList(NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;),</span>
<a href="#l81.1418"></a><span id="l81.1418" class="difflineminus">-                                   &amp;prefCount, &amp;children);</span>
<a href="#l81.1419"></a><span id="l81.1419" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l81.1420"></a><span id="l81.1420" class="difflineminus">-    {</span>
<a href="#l81.1421"></a><span id="l81.1421" class="difflineminus">-      while (!isUnique &amp;&amp; prefName)</span>
<a href="#l81.1422"></a><span id="l81.1422" class="difflineminus">-      {</span>
<a href="#l81.1423"></a><span id="l81.1423" class="difflineminus">-        isUnique = true; /* now flip the logic and assume we are unique until we find a match */</span>
<a href="#l81.1424"></a><span id="l81.1424" class="difflineminus">-        for (uint32_t i = 0; i &lt; prefCount &amp;&amp; isUnique; ++i)</span>
<a href="#l81.1425"></a><span id="l81.1425" class="difflineminus">-        {</span>
<a href="#l81.1426"></a><span id="l81.1426" class="difflineminus">-          if (!PL_strcasecmp(children[i], prefName)) /* are they the same branch? */</span>
<a href="#l81.1427"></a><span id="l81.1427" class="difflineplus">+    nsresult rv =</span>
<a href="#l81.1428"></a><span id="l81.1428" class="difflineplus">+        dir_GetChildList(NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;),</span>
<a href="#l81.1429"></a><span id="l81.1429" class="difflineplus">+                         &amp;prefCount, &amp;children);</span>
<a href="#l81.1430"></a><span id="l81.1430" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l81.1431"></a><span id="l81.1431" class="difflineplus">+      while (!isUnique &amp;&amp; prefName) {</span>
<a href="#l81.1432"></a><span id="l81.1432" class="difflineplus">+        isUnique = true; /* now flip the logic and assume we are unique until we</span>
<a href="#l81.1433"></a><span id="l81.1433" class="difflineplus">+                            find a match */</span>
<a href="#l81.1434"></a><span id="l81.1434" class="difflineplus">+        for (uint32_t i = 0; i &lt; prefCount &amp;&amp; isUnique; ++i) {</span>
<a href="#l81.1435"></a><span id="l81.1435" class="difflineplus">+          if (!PL_strcasecmp(children[i],</span>
<a href="#l81.1436"></a><span id="l81.1436" class="difflineplus">+                             prefName)) /* are they the same branch? */</span>
<a href="#l81.1437"></a><span id="l81.1437">             isUnique = false;</span>
<a href="#l81.1438"></a><span id="l81.1438">         }</span>
<a href="#l81.1439"></a><span id="l81.1439">         if (!isUnique) /* then try generating a new pref name and try again */</span>
<a href="#l81.1440"></a><span id="l81.1440">         {</span>
<a href="#l81.1441"></a><span id="l81.1441">           PR_smprintf_free(prefName);</span>
<a href="#l81.1442"></a><span id="l81.1442" class="difflineminus">-          prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME&quot;.%s_%d&quot;, leafName, ++uniqueIDCnt);</span>
<a href="#l81.1443"></a><span id="l81.1443" class="difflineplus">+          prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.%s_%d&quot;, leafName,</span>
<a href="#l81.1444"></a><span id="l81.1444" class="difflineplus">+                                 ++uniqueIDCnt);</span>
<a href="#l81.1445"></a><span id="l81.1445">         }</span>
<a href="#l81.1446"></a><span id="l81.1446">       } /* if we have a list of pref Names */</span>
<a href="#l81.1447"></a><span id="l81.1447"> </span>
<a href="#l81.1448"></a><span id="l81.1448">       NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, children);</span>
<a href="#l81.1449"></a><span id="l81.1449">     } /* while we don't have a unique name */</span>
<a href="#l81.1450"></a><span id="l81.1450"> </span>
<a href="#l81.1451"></a><span id="l81.1451">     // fallback to &quot;user_directory_N&quot; form if we failed to verify</span>
<a href="#l81.1452"></a><span id="l81.1452" class="difflineminus">-    if (!isUnique &amp;&amp; prefName)</span>
<a href="#l81.1453"></a><span id="l81.1453" class="difflineminus">-    {</span>
<a href="#l81.1454"></a><span id="l81.1454" class="difflineplus">+    if (!isUnique &amp;&amp; prefName) {</span>
<a href="#l81.1455"></a><span id="l81.1455">       PR_smprintf_free(prefName);</span>
<a href="#l81.1456"></a><span id="l81.1456">       prefName = nullptr;</span>
<a href="#l81.1457"></a><span id="l81.1457">     }</span>
<a href="#l81.1458"></a><span id="l81.1458"> </span>
<a href="#l81.1459"></a><span id="l81.1459">     PR_Free(leafName);</span>
<a href="#l81.1460"></a><span id="l81.1460"> </span>
<a href="#l81.1461"></a><span id="l81.1461">   } /* if leafName */</span>
<a href="#l81.1462"></a><span id="l81.1462"> </span>
<a href="#l81.1463"></a><span id="l81.1463" class="difflineminus">-  if (!prefName) /* last resort if we still don't have a pref name is to use user_directory string */</span>
<a href="#l81.1464"></a><span id="l81.1464" class="difflineminus">-    return PR_smprintf(PREF_LDAP_SERVER_TREE_NAME&quot;.user_directory_%d&quot;, ++dir_UserId);</span>
<a href="#l81.1465"></a><span id="l81.1465" class="difflineplus">+  if (!prefName) /* last resort if we still don't have a pref name is to use</span>
<a href="#l81.1466"></a><span id="l81.1466" class="difflineplus">+                    user_directory string */</span>
<a href="#l81.1467"></a><span id="l81.1467" class="difflineplus">+    return PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.user_directory_%d&quot;,</span>
<a href="#l81.1468"></a><span id="l81.1468" class="difflineplus">+                       ++dir_UserId);</span>
<a href="#l81.1469"></a><span id="l81.1469">   else</span>
<a href="#l81.1470"></a><span id="l81.1470">     return prefName;</span>
<a href="#l81.1471"></a><span id="l81.1471"> }</span>
<a href="#l81.1472"></a><span id="l81.1472"> </span>
<a href="#l81.1473"></a><span id="l81.1473" class="difflineminus">-static void DIR_GetPrefsForOneServer(DIR_Server *server)</span>
<a href="#l81.1474"></a><span id="l81.1474" class="difflineminus">-{</span>
<a href="#l81.1475"></a><span id="l81.1475" class="difflineplus">+static void DIR_GetPrefsForOneServer(DIR_Server *server) {</span>
<a href="#l81.1476"></a><span id="l81.1476">   nsresult rv;</span>
<a href="#l81.1477"></a><span id="l81.1477">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1478"></a><span id="l81.1478" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1479"></a><span id="l81.1479" class="difflineminus">-    return;</span>
<a href="#l81.1480"></a><span id="l81.1480" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l81.1481"></a><span id="l81.1481"> </span>
<a href="#l81.1482"></a><span id="l81.1482" class="difflineminus">-  char    *prefstring = server-&gt;prefName;</span>
<a href="#l81.1483"></a><span id="l81.1483" class="difflineplus">+  char *prefstring = server-&gt;prefName;</span>
<a href="#l81.1484"></a><span id="l81.1484"> </span>
<a href="#l81.1485"></a><span id="l81.1485">   // this call fills in tempstring with the position pref, and</span>
<a href="#l81.1486"></a><span id="l81.1486">   // we then check to see if it's locked.</span>
<a href="#l81.1487"></a><span id="l81.1487" class="difflineminus">-  server-&gt;position = DIR_GetIntPref (prefstring, &quot;position&quot;, kDefaultPosition);</span>
<a href="#l81.1488"></a><span id="l81.1488" class="difflineplus">+  server-&gt;position = DIR_GetIntPref(prefstring, &quot;position&quot;, kDefaultPosition);</span>
<a href="#l81.1489"></a><span id="l81.1489"> </span>
<a href="#l81.1490"></a><span id="l81.1490">   // For default address books, this will get the name from the chrome</span>
<a href="#l81.1491"></a><span id="l81.1491">   // file referenced, for other address books it'll just retrieve it from prefs</span>
<a href="#l81.1492"></a><span id="l81.1492">   // as normal.</span>
<a href="#l81.1493"></a><span id="l81.1493">   server-&gt;description = DIR_GetLocalizedStringPref(prefstring, &quot;description&quot;);</span>
<a href="#l81.1494"></a><span id="l81.1494"> </span>
<a href="#l81.1495"></a><span id="l81.1495" class="difflineminus">-  server-&gt;dirType = (DirectoryType)DIR_GetIntPref (prefstring, &quot;dirType&quot;, LDAPDirectory);</span>
<a href="#l81.1496"></a><span id="l81.1496" class="difflineplus">+  server-&gt;dirType =</span>
<a href="#l81.1497"></a><span id="l81.1497" class="difflineplus">+      (DirectoryType)DIR_GetIntPref(prefstring, &quot;dirType&quot;, LDAPDirectory);</span>
<a href="#l81.1498"></a><span id="l81.1498"> </span>
<a href="#l81.1499"></a><span id="l81.1499" class="difflineminus">-  server-&gt;fileName = DIR_GetStringPref (prefstring, &quot;filename&quot;, &quot;&quot;);</span>
<a href="#l81.1500"></a><span id="l81.1500" class="difflineplus">+  server-&gt;fileName = DIR_GetStringPref(prefstring, &quot;filename&quot;, &quot;&quot;);</span>
<a href="#l81.1501"></a><span id="l81.1501">   // if we don't have a file name try and get one</span>
<a href="#l81.1502"></a><span id="l81.1502" class="difflineminus">-  if (!server-&gt;fileName || !*(server-&gt;fileName))</span>
<a href="#l81.1503"></a><span id="l81.1503" class="difflineminus">-    DIR_SetServerFileName (server);</span>
<a href="#l81.1504"></a><span id="l81.1504" class="difflineminus">-  if (server-&gt;fileName &amp;&amp; *server-&gt;fileName)</span>
<a href="#l81.1505"></a><span id="l81.1505" class="difflineminus">-    DIR_ConvertServerFileName(server);</span>
<a href="#l81.1506"></a><span id="l81.1506" class="difflineplus">+  if (!server-&gt;fileName || !*(server-&gt;fileName)) DIR_SetServerFileName(server);</span>
<a href="#l81.1507"></a><span id="l81.1507" class="difflineplus">+  if (server-&gt;fileName &amp;&amp; *server-&gt;fileName) DIR_ConvertServerFileName(server);</span>
<a href="#l81.1508"></a><span id="l81.1508"> </span>
<a href="#l81.1509"></a><span id="l81.1509">   // the string &quot;s&quot; is the default uri ( &lt;scheme&gt; + &quot;://&quot; + &lt;filename&gt; )</span>
<a href="#l81.1510"></a><span id="l81.1510" class="difflineminus">-  nsCString s((server-&gt;dirType == PABDirectory || server-&gt;dirType == MAPIDirectory) ?</span>
<a href="#l81.1511"></a><span id="l81.1511" class="difflineplus">+  nsCString s(</span>
<a href="#l81.1512"></a><span id="l81.1512" class="difflineplus">+      (server-&gt;dirType == PABDirectory || server-&gt;dirType == MAPIDirectory)</span>
<a href="#l81.1513"></a><span id="l81.1513" class="difflineplus">+          ?</span>
<a href="#l81.1514"></a><span id="l81.1514"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l81.1515"></a><span id="l81.1515" class="difflineminus">-    kMDBDirectoryRoot : kLDAPDirectoryRoot);</span>
<a href="#l81.1516"></a><span id="l81.1516" class="difflineplus">+          kMDBDirectoryRoot</span>
<a href="#l81.1517"></a><span id="l81.1517" class="difflineplus">+          : kLDAPDirectoryRoot);</span>
<a href="#l81.1518"></a><span id="l81.1518"> #else</span>
<a href="#l81.1519"></a><span id="l81.1519" class="difflineminus">-    // Fallback to the all directory root in the non-ldap enabled case.</span>
<a href="#l81.1520"></a><span id="l81.1520" class="difflineminus">-    kMDBDirectoryRoot : kAllDirectoryRoot);</span>
<a href="#l81.1521"></a><span id="l81.1521" class="difflineplus">+          // Fallback to the all directory root in the non-ldap enabled case.</span>
<a href="#l81.1522"></a><span id="l81.1522" class="difflineplus">+          kMDBDirectoryRoot</span>
<a href="#l81.1523"></a><span id="l81.1523" class="difflineplus">+          : kAllDirectoryRoot);</span>
<a href="#l81.1524"></a><span id="l81.1524"> #endif</span>
<a href="#l81.1525"></a><span id="l81.1525" class="difflineminus">-  s.Append (server-&gt;fileName);</span>
<a href="#l81.1526"></a><span id="l81.1526" class="difflineminus">-  server-&gt;uri = DIR_GetStringPref (prefstring, &quot;uri&quot;, s.get ());</span>
<a href="#l81.1527"></a><span id="l81.1527" class="difflineplus">+  s.Append(server-&gt;fileName);</span>
<a href="#l81.1528"></a><span id="l81.1528" class="difflineplus">+  server-&gt;uri = DIR_GetStringPref(prefstring, &quot;uri&quot;, s.get());</span>
<a href="#l81.1529"></a><span id="l81.1529"> }</span>
<a href="#l81.1530"></a><span id="l81.1530"> </span>
<a href="#l81.1531"></a><span id="l81.1531" class="difflineminus">-static nsresult dir_GetPrefs(nsTArray&lt;DIR_Server*&gt; **list)</span>
<a href="#l81.1532"></a><span id="l81.1532" class="difflineminus">-{</span>
<a href="#l81.1533"></a><span id="l81.1533" class="difflineminus">-    nsresult rv;</span>
<a href="#l81.1534"></a><span id="l81.1534" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1535"></a><span id="l81.1535" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l81.1536"></a><span id="l81.1536" class="difflineminus">-        return rv;</span>
<a href="#l81.1537"></a><span id="l81.1537" class="difflineplus">+static nsresult dir_GetPrefs(nsTArray&lt;DIR_Server *&gt; **list) {</span>
<a href="#l81.1538"></a><span id="l81.1538" class="difflineplus">+  nsresult rv;</span>
<a href="#l81.1539"></a><span id="l81.1539" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1540"></a><span id="l81.1540" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l81.1541"></a><span id="l81.1541"> </span>
<a href="#l81.1542"></a><span id="l81.1542" class="difflineminus">-    (*list) = new nsTArray&lt;DIR_Server*&gt;();</span>
<a href="#l81.1543"></a><span id="l81.1543" class="difflineminus">-    if (!(*list))</span>
<a href="#l81.1544"></a><span id="l81.1544" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l81.1545"></a><span id="l81.1545" class="difflineplus">+  (*list) = new nsTArray&lt;DIR_Server *&gt;();</span>
<a href="#l81.1546"></a><span id="l81.1546" class="difflineplus">+  if (!(*list)) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l81.1547"></a><span id="l81.1547"> </span>
<a href="#l81.1548"></a><span id="l81.1548" class="difflineminus">-    char **children;</span>
<a href="#l81.1549"></a><span id="l81.1549" class="difflineminus">-    uint32_t prefCount;</span>
<a href="#l81.1550"></a><span id="l81.1550" class="difflineplus">+  char **children;</span>
<a href="#l81.1551"></a><span id="l81.1551" class="difflineplus">+  uint32_t prefCount;</span>
<a href="#l81.1552"></a><span id="l81.1552"> </span>
<a href="#l81.1553"></a><span id="l81.1553" class="difflineminus">-    rv = dir_GetChildList(NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;),</span>
<a href="#l81.1554"></a><span id="l81.1554" class="difflineminus">-                          &amp;prefCount, &amp;children);</span>
<a href="#l81.1555"></a><span id="l81.1555" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l81.1556"></a><span id="l81.1556" class="difflineminus">-        return rv;</span>
<a href="#l81.1557"></a><span id="l81.1557" class="difflineplus">+  rv = dir_GetChildList(NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;),</span>
<a href="#l81.1558"></a><span id="l81.1558" class="difflineplus">+                        &amp;prefCount, &amp;children);</span>
<a href="#l81.1559"></a><span id="l81.1559" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l81.1560"></a><span id="l81.1560"> </span>
<a href="#l81.1561"></a><span id="l81.1561" class="difflineminus">-    /* TBD: Temporary code to read broken &quot;ldap&quot; preferences tree.</span>
<a href="#l81.1562"></a><span id="l81.1562" class="difflineminus">-     *      Remove line with if statement after M10.</span>
<a href="#l81.1563"></a><span id="l81.1563" class="difflineminus">-     */</span>
<a href="#l81.1564"></a><span id="l81.1564" class="difflineminus">-    if (dir_UserId == 0)</span>
<a href="#l81.1565"></a><span id="l81.1565" class="difflineminus">-        pPref-&gt;GetIntPref(PREF_LDAP_GLOBAL_TREE_NAME&quot;.user_id&quot;, &amp;dir_UserId);</span>
<a href="#l81.1566"></a><span id="l81.1566" class="difflineplus">+  /* TBD: Temporary code to read broken &quot;ldap&quot; preferences tree.</span>
<a href="#l81.1567"></a><span id="l81.1567" class="difflineplus">+   *      Remove line with if statement after M10.</span>
<a href="#l81.1568"></a><span id="l81.1568" class="difflineplus">+   */</span>
<a href="#l81.1569"></a><span id="l81.1569" class="difflineplus">+  if (dir_UserId == 0)</span>
<a href="#l81.1570"></a><span id="l81.1570" class="difflineplus">+    pPref-&gt;GetIntPref(PREF_LDAP_GLOBAL_TREE_NAME &quot;.user_id&quot;, &amp;dir_UserId);</span>
<a href="#l81.1571"></a><span id="l81.1571"> </span>
<a href="#l81.1572"></a><span id="l81.1572" class="difflineminus">-    for (uint32_t i = 0; i &lt; prefCount; ++i)</span>
<a href="#l81.1573"></a><span id="l81.1573" class="difflineminus">-    {</span>
<a href="#l81.1574"></a><span id="l81.1574" class="difflineminus">-        DIR_Server *server;</span>
<a href="#l81.1575"></a><span id="l81.1575" class="difflineplus">+  for (uint32_t i = 0; i &lt; prefCount; ++i) {</span>
<a href="#l81.1576"></a><span id="l81.1576" class="difflineplus">+    DIR_Server *server;</span>
<a href="#l81.1577"></a><span id="l81.1577"> </span>
<a href="#l81.1578"></a><span id="l81.1578" class="difflineminus">-        server = (DIR_Server *)PR_Calloc(1, sizeof(DIR_Server));</span>
<a href="#l81.1579"></a><span id="l81.1579" class="difflineminus">-        if (server)</span>
<a href="#l81.1580"></a><span id="l81.1580" class="difflineminus">-        {</span>
<a href="#l81.1581"></a><span id="l81.1581" class="difflineminus">-            DIR_InitServer(server);</span>
<a href="#l81.1582"></a><span id="l81.1582" class="difflineminus">-            server-&gt;prefName = strdup(children[i]);</span>
<a href="#l81.1583"></a><span id="l81.1583" class="difflineminus">-            DIR_GetPrefsForOneServer(server);</span>
<a href="#l81.1584"></a><span id="l81.1584" class="difflineminus">-            if (server-&gt;description &amp;&amp; server-&gt;description[0] &amp;&amp;</span>
<a href="#l81.1585"></a><span id="l81.1585" class="difflineminus">-                ((server-&gt;dirType == PABDirectory ||</span>
<a href="#l81.1586"></a><span id="l81.1586" class="difflineminus">-                  server-&gt;dirType == MAPIDirectory ||</span>
<a href="#l81.1587"></a><span id="l81.1587" class="difflineminus">-                  server-&gt;dirType == FixedQueryLDAPDirectory ||  // this one might go away</span>
<a href="#l81.1588"></a><span id="l81.1588" class="difflineminus">-                  server-&gt;dirType == LDAPDirectory)))</span>
<a href="#l81.1589"></a><span id="l81.1589" class="difflineminus">-            {</span>
<a href="#l81.1590"></a><span id="l81.1590" class="difflineminus">-                if (!dir_IsServerDeleted(server))</span>
<a href="#l81.1591"></a><span id="l81.1591" class="difflineminus">-                {</span>
<a href="#l81.1592"></a><span id="l81.1592" class="difflineminus">-                    (*list)-&gt;AppendElement(server);</span>
<a href="#l81.1593"></a><span id="l81.1593" class="difflineminus">-                }</span>
<a href="#l81.1594"></a><span id="l81.1594" class="difflineminus">-                else</span>
<a href="#l81.1595"></a><span id="l81.1595" class="difflineminus">-                    DIR_DeleteServer(server);</span>
<a href="#l81.1596"></a><span id="l81.1596" class="difflineminus">-            }</span>
<a href="#l81.1597"></a><span id="l81.1597" class="difflineminus">-            else</span>
<a href="#l81.1598"></a><span id="l81.1598" class="difflineminus">-            {</span>
<a href="#l81.1599"></a><span id="l81.1599" class="difflineminus">-                DIR_DeleteServer(server);</span>
<a href="#l81.1600"></a><span id="l81.1600" class="difflineminus">-            }</span>
<a href="#l81.1601"></a><span id="l81.1601" class="difflineminus">-        }</span>
<a href="#l81.1602"></a><span id="l81.1602" class="difflineplus">+    server = (DIR_Server *)PR_Calloc(1, sizeof(DIR_Server));</span>
<a href="#l81.1603"></a><span id="l81.1603" class="difflineplus">+    if (server) {</span>
<a href="#l81.1604"></a><span id="l81.1604" class="difflineplus">+      DIR_InitServer(server);</span>
<a href="#l81.1605"></a><span id="l81.1605" class="difflineplus">+      server-&gt;prefName = strdup(children[i]);</span>
<a href="#l81.1606"></a><span id="l81.1606" class="difflineplus">+      DIR_GetPrefsForOneServer(server);</span>
<a href="#l81.1607"></a><span id="l81.1607" class="difflineplus">+      if (server-&gt;description &amp;&amp; server-&gt;description[0] &amp;&amp;</span>
<a href="#l81.1608"></a><span id="l81.1608" class="difflineplus">+          ((server-&gt;dirType == PABDirectory ||</span>
<a href="#l81.1609"></a><span id="l81.1609" class="difflineplus">+            server-&gt;dirType == MAPIDirectory ||</span>
<a href="#l81.1610"></a><span id="l81.1610" class="difflineplus">+            server-&gt;dirType ==</span>
<a href="#l81.1611"></a><span id="l81.1611" class="difflineplus">+                FixedQueryLDAPDirectory ||  // this one might go away</span>
<a href="#l81.1612"></a><span id="l81.1612" class="difflineplus">+            server-&gt;dirType == LDAPDirectory))) {</span>
<a href="#l81.1613"></a><span id="l81.1613" class="difflineplus">+        if (!dir_IsServerDeleted(server)) {</span>
<a href="#l81.1614"></a><span id="l81.1614" class="difflineplus">+          (*list)-&gt;AppendElement(server);</span>
<a href="#l81.1615"></a><span id="l81.1615" class="difflineplus">+        } else</span>
<a href="#l81.1616"></a><span id="l81.1616" class="difflineplus">+          DIR_DeleteServer(server);</span>
<a href="#l81.1617"></a><span id="l81.1617" class="difflineplus">+      } else {</span>
<a href="#l81.1618"></a><span id="l81.1618" class="difflineplus">+        DIR_DeleteServer(server);</span>
<a href="#l81.1619"></a><span id="l81.1619" class="difflineplus">+      }</span>
<a href="#l81.1620"></a><span id="l81.1620">     }</span>
<a href="#l81.1621"></a><span id="l81.1621" class="difflineplus">+  }</span>
<a href="#l81.1622"></a><span id="l81.1622"> </span>
<a href="#l81.1623"></a><span id="l81.1623" class="difflineminus">-    NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, children);</span>
<a href="#l81.1624"></a><span id="l81.1624" class="difflineplus">+  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, children);</span>
<a href="#l81.1625"></a><span id="l81.1625"> </span>
<a href="#l81.1626"></a><span id="l81.1626" class="difflineminus">-    return NS_OK;</span>
<a href="#l81.1627"></a><span id="l81.1627" class="difflineplus">+  return NS_OK;</span>
<a href="#l81.1628"></a><span id="l81.1628"> }</span>
<a href="#l81.1629"></a><span id="l81.1629"> </span>
<a href="#l81.1630"></a><span id="l81.1630"> // I don't think we care about locked positions, etc.</span>
<a href="#l81.1631"></a><span id="l81.1631" class="difflineminus">-void DIR_SortServersByPosition(nsTArray&lt;DIR_Server*&gt; *serverList)</span>
<a href="#l81.1632"></a><span id="l81.1632" class="difflineminus">-{</span>
<a href="#l81.1633"></a><span id="l81.1633" class="difflineplus">+void DIR_SortServersByPosition(nsTArray&lt;DIR_Server *&gt; *serverList) {</span>
<a href="#l81.1634"></a><span id="l81.1634">   int i, j;</span>
<a href="#l81.1635"></a><span id="l81.1635">   DIR_Server *server;</span>
<a href="#l81.1636"></a><span id="l81.1636"> </span>
<a href="#l81.1637"></a><span id="l81.1637">   int count = serverList-&gt;Length();</span>
<a href="#l81.1638"></a><span id="l81.1638" class="difflineminus">-  for (i = 0; i &lt; count - 1; i++)</span>
<a href="#l81.1639"></a><span id="l81.1639" class="difflineminus">-  {</span>
<a href="#l81.1640"></a><span id="l81.1640" class="difflineminus">-    for (j = i + 1; j &lt; count; j++)</span>
<a href="#l81.1641"></a><span id="l81.1641" class="difflineminus">-    {</span>
<a href="#l81.1642"></a><span id="l81.1642" class="difflineminus">-      if (serverList-&gt;ElementAt(j)-&gt;position &lt; serverList-&gt;ElementAt(i)-&gt;position)</span>
<a href="#l81.1643"></a><span id="l81.1643" class="difflineminus">-      {</span>
<a href="#l81.1644"></a><span id="l81.1644" class="difflineplus">+  for (i = 0; i &lt; count - 1; i++) {</span>
<a href="#l81.1645"></a><span id="l81.1645" class="difflineplus">+    for (j = i + 1; j &lt; count; j++) {</span>
<a href="#l81.1646"></a><span id="l81.1646" class="difflineplus">+      if (serverList-&gt;ElementAt(j)-&gt;position &lt;</span>
<a href="#l81.1647"></a><span id="l81.1647" class="difflineplus">+          serverList-&gt;ElementAt(i)-&gt;position) {</span>
<a href="#l81.1648"></a><span id="l81.1648">         server = serverList-&gt;ElementAt(i);</span>
<a href="#l81.1649"></a><span id="l81.1649">         serverList-&gt;ReplaceElementAt(i, serverList-&gt;ElementAt(j));</span>
<a href="#l81.1650"></a><span id="l81.1650">         serverList-&gt;ReplaceElementAt(j, server);</span>
<a href="#l81.1651"></a><span id="l81.1651">       }</span>
<a href="#l81.1652"></a><span id="l81.1652">     }</span>
<a href="#l81.1653"></a><span id="l81.1653">   }</span>
<a href="#l81.1654"></a><span id="l81.1654"> }</span>
<a href="#l81.1655"></a><span id="l81.1655"> </span>
<a href="#l81.1656"></a><span id="l81.1656" class="difflineminus">-static nsresult DIR_GetServerPreferences(nsTArray&lt;DIR_Server*&gt;** list)</span>
<a href="#l81.1657"></a><span id="l81.1657" class="difflineminus">-{</span>
<a href="#l81.1658"></a><span id="l81.1658" class="difflineplus">+static nsresult DIR_GetServerPreferences(nsTArray&lt;DIR_Server *&gt; **list) {</span>
<a href="#l81.1659"></a><span id="l81.1659">   nsresult err;</span>
<a href="#l81.1660"></a><span id="l81.1660">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;err));</span>
<a href="#l81.1661"></a><span id="l81.1661" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l81.1662"></a><span id="l81.1662" class="difflineminus">-    return err;</span>
<a href="#l81.1663"></a><span id="l81.1663" class="difflineplus">+  if (NS_FAILED(err)) return err;</span>
<a href="#l81.1664"></a><span id="l81.1664"> </span>
<a href="#l81.1665"></a><span id="l81.1665">   int32_t version = -1;</span>
<a href="#l81.1666"></a><span id="l81.1666" class="difflineminus">-  nsTArray&lt;DIR_Server*&gt; *newList = nullptr;</span>
<a href="#l81.1667"></a><span id="l81.1667" class="difflineplus">+  nsTArray&lt;DIR_Server *&gt; *newList = nullptr;</span>
<a href="#l81.1668"></a><span id="l81.1668"> </span>
<a href="#l81.1669"></a><span id="l81.1669">   /* Update the ldap list version and see if there are old prefs to migrate. */</span>
<a href="#l81.1670"></a><span id="l81.1670">   err = pPref-&gt;GetIntPref(PREF_LDAP_VERSION_NAME, &amp;version);</span>
<a href="#l81.1671"></a><span id="l81.1671">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l81.1672"></a><span id="l81.1672"> </span>
<a href="#l81.1673"></a><span id="l81.1673">   /* Find the new-style &quot;ldap_2.servers&quot; tree in prefs */</span>
<a href="#l81.1674"></a><span id="l81.1674">   err = dir_GetPrefs(&amp;newList);</span>
<a href="#l81.1675"></a><span id="l81.1675"> </span>
<a href="#l81.1676"></a><span id="l81.1676" class="difflineminus">-  if (version &lt; kCurrentListVersion)</span>
<a href="#l81.1677"></a><span id="l81.1677" class="difflineminus">-  {</span>
<a href="#l81.1678"></a><span id="l81.1678" class="difflineplus">+  if (version &lt; kCurrentListVersion) {</span>
<a href="#l81.1679"></a><span id="l81.1679">     pPref-&gt;SetIntPref(PREF_LDAP_VERSION_NAME, kCurrentListVersion);</span>
<a href="#l81.1680"></a><span id="l81.1680">   }</span>
<a href="#l81.1681"></a><span id="l81.1681"> </span>
<a href="#l81.1682"></a><span id="l81.1682">   DIR_SortServersByPosition(newList);</span>
<a href="#l81.1683"></a><span id="l81.1683"> </span>
<a href="#l81.1684"></a><span id="l81.1684">   *list = newList;</span>
<a href="#l81.1685"></a><span id="l81.1685"> </span>
<a href="#l81.1686"></a><span id="l81.1686">   return err;</span>
<a href="#l81.1687"></a><span id="l81.1687"> }</span>
<a href="#l81.1688"></a><span id="l81.1688"> </span>
<a href="#l81.1689"></a><span id="l81.1689" class="difflineminus">-static void DIR_SetStringPref(const char *prefRoot, const char *prefLeaf, const char *value, const char *defaultValue)</span>
<a href="#l81.1690"></a><span id="l81.1690" class="difflineminus">-{</span>
<a href="#l81.1691"></a><span id="l81.1691" class="difflineplus">+static void DIR_SetStringPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l81.1692"></a><span id="l81.1692" class="difflineplus">+                              const char *value, const char *defaultValue) {</span>
<a href="#l81.1693"></a><span id="l81.1693">   nsresult rv;</span>
<a href="#l81.1694"></a><span id="l81.1694">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1695"></a><span id="l81.1695" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1696"></a><span id="l81.1696" class="difflineminus">-    return;</span>
<a href="#l81.1697"></a><span id="l81.1697" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l81.1698"></a><span id="l81.1698"> </span>
<a href="#l81.1699"></a><span id="l81.1699">   nsCString defaultPref;</span>
<a href="#l81.1700"></a><span id="l81.1700">   nsAutoCString prefLocation(prefRoot);</span>
<a href="#l81.1701"></a><span id="l81.1701"> </span>
<a href="#l81.1702"></a><span id="l81.1702">   prefLocation.Append('.');</span>
<a href="#l81.1703"></a><span id="l81.1703">   prefLocation.Append(prefLeaf);</span>
<a href="#l81.1704"></a><span id="l81.1704"> </span>
<a href="#l81.1705"></a><span id="l81.1705" class="difflineminus">-  if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), defaultPref)))</span>
<a href="#l81.1706"></a><span id="l81.1706" class="difflineminus">-  {</span>
<a href="#l81.1707"></a><span id="l81.1707" class="difflineplus">+  if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), defaultPref))) {</span>
<a href="#l81.1708"></a><span id="l81.1708">     /* If there's a default pref, just set ours in and let libpref worry</span>
<a href="#l81.1709"></a><span id="l81.1709">      * about potential defaults in all.js</span>
<a href="#l81.1710"></a><span id="l81.1710">      */</span>
<a href="#l81.1711"></a><span id="l81.1711" class="difflineminus">-    if (value) /* added this check to make sure we have a value before we try to set it..*/</span>
<a href="#l81.1712"></a><span id="l81.1712" class="difflineplus">+    if (value) /* added this check to make sure we have a value before we try to</span>
<a href="#l81.1713"></a><span id="l81.1713" class="difflineplus">+                  set it..*/</span>
<a href="#l81.1714"></a><span id="l81.1714">       rv = pPref-&gt;SetCharPref(prefLocation.get(), nsDependentCString(value));</span>
<a href="#l81.1715"></a><span id="l81.1715">     else</span>
<a href="#l81.1716"></a><span id="l81.1716">       rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l81.1717"></a><span id="l81.1717" class="difflineminus">-  }</span>
<a href="#l81.1718"></a><span id="l81.1718" class="difflineminus">-  else</span>
<a href="#l81.1719"></a><span id="l81.1719" class="difflineminus">-  {</span>
<a href="#l81.1720"></a><span id="l81.1720" class="difflineminus">-    /* If there's no default pref, look for a user pref, and only set our value in</span>
<a href="#l81.1721"></a><span id="l81.1721" class="difflineminus">-     * if the user pref is different than one of them.</span>
<a href="#l81.1722"></a><span id="l81.1722" class="difflineplus">+  } else {</span>
<a href="#l81.1723"></a><span id="l81.1723" class="difflineplus">+    /* If there's no default pref, look for a user pref, and only set our value</span>
<a href="#l81.1724"></a><span id="l81.1724" class="difflineplus">+     * in if the user pref is different than one of them.</span>
<a href="#l81.1725"></a><span id="l81.1725">      */</span>
<a href="#l81.1726"></a><span id="l81.1726">     nsCString userPref;</span>
<a href="#l81.1727"></a><span id="l81.1727" class="difflineminus">-    if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), userPref)))</span>
<a href="#l81.1728"></a><span id="l81.1728" class="difflineminus">-    {</span>
<a href="#l81.1729"></a><span id="l81.1729" class="difflineminus">-      if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue) : value != defaultValue))</span>
<a href="#l81.1730"></a><span id="l81.1730" class="difflineplus">+    if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), userPref))) {</span>
<a href="#l81.1731"></a><span id="l81.1731" class="difflineplus">+      if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue)</span>
<a href="#l81.1732"></a><span id="l81.1732" class="difflineplus">+                                 : value != defaultValue))</span>
<a href="#l81.1733"></a><span id="l81.1733">         rv = pPref-&gt;SetCharPref(prefLocation.get(), nsDependentCString(value));</span>
<a href="#l81.1734"></a><span id="l81.1734">       else</span>
<a href="#l81.1735"></a><span id="l81.1735">         rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l81.1736"></a><span id="l81.1736" class="difflineminus">-    }</span>
<a href="#l81.1737"></a><span id="l81.1737" class="difflineminus">-    else</span>
<a href="#l81.1738"></a><span id="l81.1738" class="difflineminus">-    {</span>
<a href="#l81.1739"></a><span id="l81.1739" class="difflineminus">-      if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue) : value != defaultValue))</span>
<a href="#l81.1740"></a><span id="l81.1740" class="difflineplus">+    } else {</span>
<a href="#l81.1741"></a><span id="l81.1741" class="difflineplus">+      if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue)</span>
<a href="#l81.1742"></a><span id="l81.1742" class="difflineplus">+                                 : value != defaultValue))</span>
<a href="#l81.1743"></a><span id="l81.1743">         rv = pPref-&gt;SetCharPref(prefLocation.get(), nsDependentCString(value));</span>
<a href="#l81.1744"></a><span id="l81.1744">     }</span>
<a href="#l81.1745"></a><span id="l81.1745">   }</span>
<a href="#l81.1746"></a><span id="l81.1746"> </span>
<a href="#l81.1747"></a><span id="l81.1747">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetStringPref&quot;);</span>
<a href="#l81.1748"></a><span id="l81.1748"> }</span>
<a href="#l81.1749"></a><span id="l81.1749"> </span>
<a href="#l81.1750"></a><span id="l81.1750" class="difflineminus">-static void DIR_SetLocalizedStringPref</span>
<a href="#l81.1751"></a><span id="l81.1751" class="difflineminus">-(const char *prefRoot, const char *prefLeaf, const char *value)</span>
<a href="#l81.1752"></a><span id="l81.1752" class="difflineminus">-{</span>
<a href="#l81.1753"></a><span id="l81.1753" class="difflineplus">+static void DIR_SetLocalizedStringPref(const char *prefRoot,</span>
<a href="#l81.1754"></a><span id="l81.1754" class="difflineplus">+                                       const char *prefLeaf,</span>
<a href="#l81.1755"></a><span id="l81.1755" class="difflineplus">+                                       const char *value) {</span>
<a href="#l81.1756"></a><span id="l81.1756">   nsresult rv;</span>
<a href="#l81.1757"></a><span id="l81.1757" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefSvc(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1758"></a><span id="l81.1758" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefSvc(</span>
<a href="#l81.1759"></a><span id="l81.1759" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1760"></a><span id="l81.1760"> </span>
<a href="#l81.1761"></a><span id="l81.1761" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1762"></a><span id="l81.1762" class="difflineminus">-    return;</span>
<a href="#l81.1763"></a><span id="l81.1763" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l81.1764"></a><span id="l81.1764"> </span>
<a href="#l81.1765"></a><span id="l81.1765">   nsAutoCString prefLocation(prefRoot);</span>
<a href="#l81.1766"></a><span id="l81.1766">   prefLocation.Append('.');</span>
<a href="#l81.1767"></a><span id="l81.1767"> </span>
<a href="#l81.1768"></a><span id="l81.1768">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l81.1769"></a><span id="l81.1769">   rv = prefSvc-&gt;GetBranch(prefLocation.get(), getter_AddRefs(prefBranch));</span>
<a href="#l81.1770"></a><span id="l81.1770" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1771"></a><span id="l81.1771" class="difflineminus">-    return;</span>
<a href="#l81.1772"></a><span id="l81.1772" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l81.1773"></a><span id="l81.1773"> </span>
<a href="#l81.1774"></a><span id="l81.1774">   nsString wvalue;</span>
<a href="#l81.1775"></a><span id="l81.1775">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; newStr(</span>
<a href="#l81.1776"></a><span id="l81.1776" class="difflineminus">-    do_CreateInstance(NS_PREFLOCALIZEDSTRING_CONTRACTID, &amp;rv));</span>
<a href="#l81.1777"></a><span id="l81.1777" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1778"></a><span id="l81.1778" class="difflineminus">-  {</span>
<a href="#l81.1779"></a><span id="l81.1779" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not createInstance in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l81.1780"></a><span id="l81.1780" class="difflineplus">+      do_CreateInstance(NS_PREFLOCALIZEDSTRING_CONTRACTID, &amp;rv));</span>
<a href="#l81.1781"></a><span id="l81.1781" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l81.1782"></a><span id="l81.1782" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l81.1783"></a><span id="l81.1783" class="difflineplus">+                 &quot;Could not createInstance in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l81.1784"></a><span id="l81.1784">     return;</span>
<a href="#l81.1785"></a><span id="l81.1785">   }</span>
<a href="#l81.1786"></a><span id="l81.1786"> </span>
<a href="#l81.1787"></a><span id="l81.1787">   NS_ConvertUTF8toUTF16 newValue(value);</span>
<a href="#l81.1788"></a><span id="l81.1788"> </span>
<a href="#l81.1789"></a><span id="l81.1789">   rv = newStr-&gt;SetData(newValue);</span>
<a href="#l81.1790"></a><span id="l81.1790" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1791"></a><span id="l81.1791" class="difflineminus">-  {</span>
<a href="#l81.1792"></a><span id="l81.1792" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref data in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l81.1793"></a><span id="l81.1793" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l81.1794"></a><span id="l81.1794" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l81.1795"></a><span id="l81.1795" class="difflineplus">+                 &quot;Could not set pref data in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l81.1796"></a><span id="l81.1796">     return;</span>
<a href="#l81.1797"></a><span id="l81.1797">   }</span>
<a href="#l81.1798"></a><span id="l81.1798">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; locStr;</span>
<a href="#l81.1799"></a><span id="l81.1799" class="difflineminus">-  if (NS_SUCCEEDED(prefBranch-&gt;GetComplexValue(prefLeaf,</span>
<a href="#l81.1800"></a><span id="l81.1800" class="difflineminus">-                                               NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l81.1801"></a><span id="l81.1801" class="difflineminus">-                                               getter_AddRefs(locStr))))</span>
<a href="#l81.1802"></a><span id="l81.1802" class="difflineminus">-  {</span>
<a href="#l81.1803"></a><span id="l81.1803" class="difflineplus">+  if (NS_SUCCEEDED(prefBranch-&gt;GetComplexValue(</span>
<a href="#l81.1804"></a><span id="l81.1804" class="difflineplus">+          prefLeaf, NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l81.1805"></a><span id="l81.1805" class="difflineplus">+          getter_AddRefs(locStr)))) {</span>
<a href="#l81.1806"></a><span id="l81.1806">     nsString data;</span>
<a href="#l81.1807"></a><span id="l81.1807">     locStr-&gt;GetData(data);</span>
<a href="#l81.1808"></a><span id="l81.1808"> </span>
<a href="#l81.1809"></a><span id="l81.1809">     // Only set the pref if the data values aren't the same (i.e. don't change</span>
<a href="#l81.1810"></a><span id="l81.1810">     // unnecessarily, but also, don't change in the case that its a chrome</span>
<a href="#l81.1811"></a><span id="l81.1811">     // string pointing to the value we want to set the pref to).</span>
<a href="#l81.1812"></a><span id="l81.1812">     if (newValue != data)</span>
<a href="#l81.1813"></a><span id="l81.1813" class="difflineminus">-      rv = prefBranch-&gt;SetComplexValue(prefLeaf,</span>
<a href="#l81.1814"></a><span id="l81.1814" class="difflineminus">-                                       NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l81.1815"></a><span id="l81.1815" class="difflineminus">-                                       newStr);</span>
<a href="#l81.1816"></a><span id="l81.1816" class="difflineminus">-  }</span>
<a href="#l81.1817"></a><span id="l81.1817" class="difflineminus">-  else {</span>
<a href="#l81.1818"></a><span id="l81.1818" class="difflineplus">+      rv = prefBranch-&gt;SetComplexValue(</span>
<a href="#l81.1819"></a><span id="l81.1819" class="difflineplus">+          prefLeaf, NS_GET_IID(nsIPrefLocalizedString), newStr);</span>
<a href="#l81.1820"></a><span id="l81.1820" class="difflineplus">+  } else {</span>
<a href="#l81.1821"></a><span id="l81.1821">     // No value set, but check the default pref branch (i.e. user may have</span>
<a href="#l81.1822"></a><span id="l81.1822">     // cleared the pref)</span>
<a href="#l81.1823"></a><span id="l81.1823">     nsCOMPtr&lt;nsIPrefBranch&gt; dPB;</span>
<a href="#l81.1824"></a><span id="l81.1824" class="difflineminus">-    rv = prefSvc-&gt;GetDefaultBranch(prefLocation.get(),</span>
<a href="#l81.1825"></a><span id="l81.1825" class="difflineminus">-                                   getter_AddRefs(dPB));</span>
<a href="#l81.1826"></a><span id="l81.1826" class="difflineplus">+    rv = prefSvc-&gt;GetDefaultBranch(prefLocation.get(), getter_AddRefs(dPB));</span>
<a href="#l81.1827"></a><span id="l81.1827"> </span>
<a href="#l81.1828"></a><span id="l81.1828">     if (NS_SUCCEEDED(dPB-&gt;GetComplexValue(prefLeaf,</span>
<a href="#l81.1829"></a><span id="l81.1829">                                           NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l81.1830"></a><span id="l81.1830" class="difflineminus">-                                          getter_AddRefs(locStr))))</span>
<a href="#l81.1831"></a><span id="l81.1831" class="difflineminus">-    {</span>
<a href="#l81.1832"></a><span id="l81.1832" class="difflineplus">+                                          getter_AddRefs(locStr)))) {</span>
<a href="#l81.1833"></a><span id="l81.1833">       // Default branch has a value</span>
<a href="#l81.1834"></a><span id="l81.1834">       nsString data;</span>
<a href="#l81.1835"></a><span id="l81.1835">       locStr-&gt;GetData(data);</span>
<a href="#l81.1836"></a><span id="l81.1836"> </span>
<a href="#l81.1837"></a><span id="l81.1837">       if (newValue != data)</span>
<a href="#l81.1838"></a><span id="l81.1838">         // If the vales aren't the same, set the data on the main pref branch</span>
<a href="#l81.1839"></a><span id="l81.1839" class="difflineminus">-        rv = prefBranch-&gt;SetComplexValue(prefLeaf,</span>
<a href="#l81.1840"></a><span id="l81.1840" class="difflineminus">-                                         NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l81.1841"></a><span id="l81.1841" class="difflineminus">-                                         newStr);</span>
<a href="#l81.1842"></a><span id="l81.1842" class="difflineplus">+        rv = prefBranch-&gt;SetComplexValue(</span>
<a href="#l81.1843"></a><span id="l81.1843" class="difflineplus">+            prefLeaf, NS_GET_IID(nsIPrefLocalizedString), newStr);</span>
<a href="#l81.1844"></a><span id="l81.1844">       else</span>
<a href="#l81.1845"></a><span id="l81.1845">         // Else if they are, kill the user pref</span>
<a href="#l81.1846"></a><span id="l81.1846">         rv = prefBranch-&gt;ClearUserPref(prefLeaf);</span>
<a href="#l81.1847"></a><span id="l81.1847" class="difflineminus">-    }</span>
<a href="#l81.1848"></a><span id="l81.1848" class="difflineminus">-    else</span>
<a href="#l81.1849"></a><span id="l81.1849" class="difflineplus">+    } else</span>
<a href="#l81.1850"></a><span id="l81.1850">       // No values set anywhere, so just set the pref</span>
<a href="#l81.1851"></a><span id="l81.1851" class="difflineminus">-      rv = prefBranch-&gt;SetComplexValue(prefLeaf,</span>
<a href="#l81.1852"></a><span id="l81.1852" class="difflineminus">-                                       NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l81.1853"></a><span id="l81.1853" class="difflineminus">-                                       newStr);</span>
<a href="#l81.1854"></a><span id="l81.1854" class="difflineplus">+      rv = prefBranch-&gt;SetComplexValue(</span>
<a href="#l81.1855"></a><span id="l81.1855" class="difflineplus">+          prefLeaf, NS_GET_IID(nsIPrefLocalizedString), newStr);</span>
<a href="#l81.1856"></a><span id="l81.1856">   }</span>
<a href="#l81.1857"></a><span id="l81.1857"> </span>
<a href="#l81.1858"></a><span id="l81.1858" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l81.1859"></a><span id="l81.1859" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l81.1860"></a><span id="l81.1860" class="difflineplus">+               &quot;Could not set pref in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l81.1861"></a><span id="l81.1861"> }</span>
<a href="#l81.1862"></a><span id="l81.1862"> </span>
<a href="#l81.1863"></a><span id="l81.1863" class="difflineminus">-</span>
<a href="#l81.1864"></a><span id="l81.1864" class="difflineminus">-static void DIR_SetIntPref(const char *prefRoot, const char *prefLeaf, int32_t value, int32_t defaultValue)</span>
<a href="#l81.1865"></a><span id="l81.1865" class="difflineminus">-{</span>
<a href="#l81.1866"></a><span id="l81.1866" class="difflineplus">+static void DIR_SetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l81.1867"></a><span id="l81.1867" class="difflineplus">+                           int32_t value, int32_t defaultValue) {</span>
<a href="#l81.1868"></a><span id="l81.1868">   nsresult rv;</span>
<a href="#l81.1869"></a><span id="l81.1869">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1870"></a><span id="l81.1870" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l81.1871"></a><span id="l81.1871" class="difflineminus">-    return;</span>
<a href="#l81.1872"></a><span id="l81.1872" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l81.1873"></a><span id="l81.1873"> </span>
<a href="#l81.1874"></a><span id="l81.1874">   int32_t defaultPref;</span>
<a href="#l81.1875"></a><span id="l81.1875">   nsAutoCString prefLocation(prefRoot);</span>
<a href="#l81.1876"></a><span id="l81.1876"> </span>
<a href="#l81.1877"></a><span id="l81.1877">   prefLocation.Append('.');</span>
<a href="#l81.1878"></a><span id="l81.1878">   prefLocation.Append(prefLeaf);</span>
<a href="#l81.1879"></a><span id="l81.1879"> </span>
<a href="#l81.1880"></a><span id="l81.1880" class="difflineminus">-  if (NS_SUCCEEDED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;defaultPref)))</span>
<a href="#l81.1881"></a><span id="l81.1881" class="difflineminus">-  {</span>
<a href="#l81.1882"></a><span id="l81.1882" class="difflineminus">-    /* solve the problem where reordering user prefs must override default prefs */</span>
<a href="#l81.1883"></a><span id="l81.1883" class="difflineplus">+  if (NS_SUCCEEDED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;defaultPref))) {</span>
<a href="#l81.1884"></a><span id="l81.1884" class="difflineplus">+    /* solve the problem where reordering user prefs must override default prefs</span>
<a href="#l81.1885"></a><span id="l81.1885" class="difflineplus">+     */</span>
<a href="#l81.1886"></a><span id="l81.1886">     rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l81.1887"></a><span id="l81.1887" class="difflineminus">-  }</span>
<a href="#l81.1888"></a><span id="l81.1888" class="difflineminus">-  else</span>
<a href="#l81.1889"></a><span id="l81.1889" class="difflineminus">-  {</span>
<a href="#l81.1890"></a><span id="l81.1890" class="difflineplus">+  } else {</span>
<a href="#l81.1891"></a><span id="l81.1891">     int32_t userPref;</span>
<a href="#l81.1892"></a><span id="l81.1892" class="difflineminus">-    if (NS_SUCCEEDED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;userPref)))</span>
<a href="#l81.1893"></a><span id="l81.1893" class="difflineminus">-    {</span>
<a href="#l81.1894"></a><span id="l81.1894" class="difflineplus">+    if (NS_SUCCEEDED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;userPref))) {</span>
<a href="#l81.1895"></a><span id="l81.1895">       if (value != defaultValue)</span>
<a href="#l81.1896"></a><span id="l81.1896">         rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l81.1897"></a><span id="l81.1897">       else</span>
<a href="#l81.1898"></a><span id="l81.1898">         rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l81.1899"></a><span id="l81.1899" class="difflineminus">-    }</span>
<a href="#l81.1900"></a><span id="l81.1900" class="difflineminus">-    else</span>
<a href="#l81.1901"></a><span id="l81.1901" class="difflineminus">-    {</span>
<a href="#l81.1902"></a><span id="l81.1902" class="difflineplus">+    } else {</span>
<a href="#l81.1903"></a><span id="l81.1903">       if (value != defaultValue)</span>
<a href="#l81.1904"></a><span id="l81.1904">         rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l81.1905"></a><span id="l81.1905">     }</span>
<a href="#l81.1906"></a><span id="l81.1906">   }</span>
<a href="#l81.1907"></a><span id="l81.1907"> </span>
<a href="#l81.1908"></a><span id="l81.1908">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetIntPref&quot;);</span>
<a href="#l81.1909"></a><span id="l81.1909"> }</span>
<a href="#l81.1910"></a><span id="l81.1910"> </span>
<a href="#l81.1911"></a><span id="l81.1911" class="difflineminus">-void DIR_SavePrefsForOneServer(DIR_Server *server)</span>
<a href="#l81.1912"></a><span id="l81.1912" class="difflineminus">-{</span>
<a href="#l81.1913"></a><span id="l81.1913" class="difflineminus">-  if (!server)</span>
<a href="#l81.1914"></a><span id="l81.1914" class="difflineminus">-    return;</span>
<a href="#l81.1915"></a><span id="l81.1915" class="difflineplus">+void DIR_SavePrefsForOneServer(DIR_Server *server) {</span>
<a href="#l81.1916"></a><span id="l81.1916" class="difflineplus">+  if (!server) return;</span>
<a href="#l81.1917"></a><span id="l81.1917"> </span>
<a href="#l81.1918"></a><span id="l81.1918">   char *prefstring;</span>
<a href="#l81.1919"></a><span id="l81.1919"> </span>
<a href="#l81.1920"></a><span id="l81.1920">   if (server-&gt;prefName == nullptr)</span>
<a href="#l81.1921"></a><span id="l81.1921">     server-&gt;prefName = dir_CreateServerPrefName(server);</span>
<a href="#l81.1922"></a><span id="l81.1922">   prefstring = server-&gt;prefName;</span>
<a href="#l81.1923"></a><span id="l81.1923"> </span>
<a href="#l81.1924"></a><span id="l81.1924">   server-&gt;savingServer = true;</span>
<a href="#l81.1925"></a><span id="l81.1925"> </span>
<a href="#l81.1926"></a><span id="l81.1926" class="difflineminus">-  DIR_SetIntPref (prefstring, &quot;position&quot;, server-&gt;position, kDefaultPosition);</span>
<a href="#l81.1927"></a><span id="l81.1927" class="difflineplus">+  DIR_SetIntPref(prefstring, &quot;position&quot;, server-&gt;position, kDefaultPosition);</span>
<a href="#l81.1928"></a><span id="l81.1928"> </span>
<a href="#l81.1929"></a><span id="l81.1929">   // Only save the non-default address book name</span>
<a href="#l81.1930"></a><span id="l81.1930">   DIR_SetLocalizedStringPref(prefstring, &quot;description&quot;, server-&gt;description);</span>
<a href="#l81.1931"></a><span id="l81.1931"> </span>
<a href="#l81.1932"></a><span id="l81.1932">   DIR_SetStringPref(prefstring, &quot;filename&quot;, server-&gt;fileName, &quot;&quot;);</span>
<a href="#l81.1933"></a><span id="l81.1933">   DIR_SetIntPref(prefstring, &quot;dirType&quot;, server-&gt;dirType, LDAPDirectory);</span>
<a href="#l81.1934"></a><span id="l81.1934"> </span>
<a href="#l81.1935"></a><span id="l81.1935">   if (server-&gt;dirType != PABDirectory)</span>
<a href="#l81.1936"></a><span id="l81.1936">     DIR_SetStringPref(prefstring, &quot;uri&quot;, server-&gt;uri, &quot;&quot;);</span>
<a href="#l81.1937"></a><span id="l81.1937"> </span>
<a href="#l81.1938"></a><span id="l81.1938">   server-&gt;savingServer = false;</span>
<a href="#l81.1939"></a><span id="l81.1939"> }</span>
<a href="#l81.1940"></a><span id="l81.1940"> </span>
<a href="#l81.1941"></a><span id="l81.1941" class="difflineminus">-static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server*&gt; *wholeList)</span>
<a href="#l81.1942"></a><span id="l81.1942" class="difflineminus">-{</span>
<a href="#l81.1943"></a><span id="l81.1943" class="difflineminus">-  if (wholeList)</span>
<a href="#l81.1944"></a><span id="l81.1944" class="difflineminus">-  {</span>
<a href="#l81.1945"></a><span id="l81.1945" class="difflineplus">+static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server *&gt; *wholeList) {</span>
<a href="#l81.1946"></a><span id="l81.1946" class="difflineplus">+  if (wholeList) {</span>
<a href="#l81.1947"></a><span id="l81.1947">     nsresult rv;</span>
<a href="#l81.1948"></a><span id="l81.1948" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1949"></a><span id="l81.1949" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pPref(</span>
<a href="#l81.1950"></a><span id="l81.1950" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.1951"></a><span id="l81.1951">     if (NS_FAILED(rv)) {</span>
<a href="#l81.1952"></a><span id="l81.1952">       NS_WARNING(&quot;DIR_SaveServerPreferences: Failed to get the pref service\n&quot;);</span>
<a href="#l81.1953"></a><span id="l81.1953">       return;</span>
<a href="#l81.1954"></a><span id="l81.1954">     }</span>
<a href="#l81.1955"></a><span id="l81.1955"> </span>
<a href="#l81.1956"></a><span id="l81.1956" class="difflineminus">-    int32_t  i;</span>
<a href="#l81.1957"></a><span id="l81.1957" class="difflineminus">-    int32_t  count = wholeList-&gt;Length();</span>
<a href="#l81.1958"></a><span id="l81.1958" class="difflineplus">+    int32_t i;</span>
<a href="#l81.1959"></a><span id="l81.1959" class="difflineplus">+    int32_t count = wholeList-&gt;Length();</span>
<a href="#l81.1960"></a><span id="l81.1960">     DIR_Server *server;</span>
<a href="#l81.1961"></a><span id="l81.1961"> </span>
<a href="#l81.1962"></a><span id="l81.1962" class="difflineminus">-    for (i = 0; i &lt; count; i++)</span>
<a href="#l81.1963"></a><span id="l81.1963" class="difflineminus">-    {</span>
<a href="#l81.1964"></a><span id="l81.1964" class="difflineplus">+    for (i = 0; i &lt; count; i++) {</span>
<a href="#l81.1965"></a><span id="l81.1965">       server = wholeList-&gt;ElementAt(i);</span>
<a href="#l81.1966"></a><span id="l81.1966" class="difflineminus">-      if (server)</span>
<a href="#l81.1967"></a><span id="l81.1967" class="difflineminus">-        DIR_SavePrefsForOneServer(server);</span>
<a href="#l81.1968"></a><span id="l81.1968" class="difflineplus">+      if (server) DIR_SavePrefsForOneServer(server);</span>
<a href="#l81.1969"></a><span id="l81.1969">     }</span>
<a href="#l81.1970"></a><span id="l81.1970" class="difflineminus">-    pPref-&gt;SetIntPref(PREF_LDAP_GLOBAL_TREE_NAME&quot;.user_id&quot;, dir_UserId);</span>
<a href="#l81.1971"></a><span id="l81.1971" class="difflineplus">+    pPref-&gt;SetIntPref(PREF_LDAP_GLOBAL_TREE_NAME &quot;.user_id&quot;, dir_UserId);</span>
<a href="#l81.1972"></a><span id="l81.1972">   }</span>
<a href="#l81.1973"></a><span id="l81.1973"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -8,79 +8,79 @@</span>
<a href="#l82.4"></a><span id="l82.4"> </span>
<a href="#l82.5"></a><span id="l82.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l82.6"></a><span id="l82.6"> </span>
<a href="#l82.7"></a><span id="l82.7"> //</span>
<a href="#l82.8"></a><span id="l82.8"> // XXX nsDirPrefs is being greatly reduced if not removed altogether. Directory</span>
<a href="#l82.9"></a><span id="l82.9"> // Prefs etc. should be handled via their appropriate nsAb*Directory classes.</span>
<a href="#l82.10"></a><span id="l82.10"> //</span>
<a href="#l82.11"></a><span id="l82.11"> </span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-#define kPreviousListVersion   2</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineminus">-#define kCurrentListVersion    3</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+#define kPreviousListVersion 2</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+#define kCurrentListVersion 3</span>
<a href="#l82.16"></a><span id="l82.16"> #define PREF_LDAP_GLOBAL_TREE_NAME &quot;ldap_2&quot;</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineminus">-#define PREF_LDAP_VERSION_NAME     &quot;ldap_2.version&quot;</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineplus">+#define PREF_LDAP_VERSION_NAME &quot;ldap_2.version&quot;</span>
<a href="#l82.19"></a><span id="l82.19"> #define PREF_LDAP_SERVER_TREE_NAME &quot;ldap_2.servers&quot;</span>
<a href="#l82.20"></a><span id="l82.20"> </span>
<a href="#l82.21"></a><span id="l82.21" class="difflineminus">-#define kMainLdapAddressBook &quot;ldap.mab&quot;   /* v3 main ldap address book file */</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineplus">+#define kMainLdapAddressBook &quot;ldap.mab&quot; /* v3 main ldap address book file */</span>
<a href="#l82.23"></a><span id="l82.23"> </span>
<a href="#l82.24"></a><span id="l82.24"> /* DIR_Server.dirType */</span>
<a href="#l82.25"></a><span id="l82.25" class="difflineminus">-typedef enum</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineminus">-{</span>
<a href="#l82.27"></a><span id="l82.27" class="difflineplus">+typedef enum {</span>
<a href="#l82.28"></a><span id="l82.28">   LDAPDirectory,</span>
<a href="#l82.29"></a><span id="l82.29">   HTMLDirectory,</span>
<a href="#l82.30"></a><span id="l82.30">   PABDirectory,</span>
<a href="#l82.31"></a><span id="l82.31">   MAPIDirectory,</span>
<a href="#l82.32"></a><span id="l82.32">   FixedQueryLDAPDirectory = 777</span>
<a href="#l82.33"></a><span id="l82.33"> } DirectoryType;</span>
<a href="#l82.34"></a><span id="l82.34"> </span>
<a href="#l82.35"></a><span id="l82.35" class="difflineminus">-typedef enum</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineminus">-{</span>
<a href="#l82.37"></a><span id="l82.37" class="difflineminus">-  idNone = 0,  /* Special value */</span>
<a href="#l82.38"></a><span id="l82.38" class="difflineplus">+typedef enum {</span>
<a href="#l82.39"></a><span id="l82.39" class="difflineplus">+  idNone = 0, /* Special value */</span>
<a href="#l82.40"></a><span id="l82.40">   idPrefName,</span>
<a href="#l82.41"></a><span id="l82.41">   idPosition,</span>
<a href="#l82.42"></a><span id="l82.42">   idDescription,</span>
<a href="#l82.43"></a><span id="l82.43">   idFileName,</span>
<a href="#l82.44"></a><span id="l82.44">   idUri,</span>
<a href="#l82.45"></a><span id="l82.45">   idType</span>
<a href="#l82.46"></a><span id="l82.46"> } DIR_PrefId;</span>
<a href="#l82.47"></a><span id="l82.47"> </span>
<a href="#l82.48"></a><span id="l82.48" class="difflineminus">-#define DIR_Server_typedef 1     /* this quiets a redeclare warning in libaddr */</span>
<a href="#l82.49"></a><span id="l82.49" class="difflineplus">+#define DIR_Server_typedef 1 /* this quiets a redeclare warning in libaddr */</span>
<a href="#l82.50"></a><span id="l82.50"> </span>
<a href="#l82.51"></a><span id="l82.51" class="difflineminus">-typedef struct DIR_Server</span>
<a href="#l82.52"></a><span id="l82.52" class="difflineminus">-{</span>
<a href="#l82.53"></a><span id="l82.53" class="difflineplus">+typedef struct DIR_Server {</span>
<a href="#l82.54"></a><span id="l82.54">   /* Housekeeping fields */</span>
<a href="#l82.55"></a><span id="l82.55" class="difflineminus">-  char    *prefName;      /* preference name, this server's subtree */</span>
<a href="#l82.56"></a><span id="l82.56" class="difflineminus">-  int32_t  position;      /* relative position in server list       */</span>
<a href="#l82.57"></a><span id="l82.57" class="difflineplus">+  char *prefName;   /* preference name, this server's subtree */</span>
<a href="#l82.58"></a><span id="l82.58" class="difflineplus">+  int32_t position; /* relative position in server list       */</span>
<a href="#l82.59"></a><span id="l82.59"> </span>
<a href="#l82.60"></a><span id="l82.60">   /* General purpose fields */</span>
<a href="#l82.61"></a><span id="l82.61" class="difflineminus">-  char   *description;    /* human readable name                    */</span>
<a href="#l82.62"></a><span id="l82.62" class="difflineminus">-  char   *fileName;       /* XP path name of local DB               */</span>
<a href="#l82.63"></a><span id="l82.63" class="difflineplus">+  char *description; /* human readable name                    */</span>
<a href="#l82.64"></a><span id="l82.64" class="difflineplus">+  char *fileName;    /* XP path name of local DB               */</span>
<a href="#l82.65"></a><span id="l82.65">   DirectoryType dirType;</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineminus">-  char   *uri;            // URI of the address book</span>
<a href="#l82.67"></a><span id="l82.67" class="difflineplus">+  char *uri;  // URI of the address book</span>
<a href="#l82.68"></a><span id="l82.68"> </span>
<a href="#l82.69"></a><span id="l82.69">   // Set whilst saving the server to avoid updating it again</span>
<a href="#l82.70"></a><span id="l82.70">   bool savingServer;</span>
<a href="#l82.71"></a><span id="l82.71"> } DIR_Server;</span>
<a href="#l82.72"></a><span id="l82.72"> </span>
<a href="#l82.73"></a><span id="l82.73" class="difflineminus">-/* We are developing a new model for managing DIR_Servers. In the 4.0x world, the FEs managed each list.</span>
<a href="#l82.74"></a><span id="l82.74" class="difflineminus">-  Calls to FE_GetDirServer caused the FEs to manage and return the DIR_Server list. In our new view of the</span>
<a href="#l82.75"></a><span id="l82.75" class="difflineminus">-  world, the back end does most of the list management so we are going to have the back end create and</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineminus">-  manage the list. Replace calls to FE_GetDirServers() with DIR_GetDirServers(). */</span>
<a href="#l82.77"></a><span id="l82.77" class="difflineplus">+/* We are developing a new model for managing DIR_Servers. In the 4.0x world,</span>
<a href="#l82.78"></a><span id="l82.78" class="difflineplus">+  the FEs managed each list. Calls to FE_GetDirServer caused the FEs to manage</span>
<a href="#l82.79"></a><span id="l82.79" class="difflineplus">+  and return the DIR_Server list. In our new view of the world, the back end</span>
<a href="#l82.80"></a><span id="l82.80" class="difflineplus">+  does most of the list management so we are going to have the back end create</span>
<a href="#l82.81"></a><span id="l82.81" class="difflineplus">+  and manage the list. Replace calls to FE_GetDirServers() with</span>
<a href="#l82.82"></a><span id="l82.82" class="difflineplus">+  DIR_GetDirServers(). */</span>
<a href="#l82.83"></a><span id="l82.83"> </span>
<a href="#l82.84"></a><span id="l82.84" class="difflineminus">-nsTArray&lt;DIR_Server*&gt;* DIR_GetDirectories();</span>
<a href="#l82.85"></a><span id="l82.85" class="difflineminus">-DIR_Server* DIR_GetServerFromList(const char* prefName);</span>
<a href="#l82.86"></a><span id="l82.86" class="difflineminus">-nsresult DIR_ShutDown(void);  /* FEs should call this when the app is shutting down. It frees all DIR_Servers regardless of ref count values! */</span>
<a href="#l82.87"></a><span id="l82.87" class="difflineplus">+nsTArray&lt;DIR_Server *&gt; *DIR_GetDirectories();</span>
<a href="#l82.88"></a><span id="l82.88" class="difflineplus">+DIR_Server *DIR_GetServerFromList(const char *prefName);</span>
<a href="#l82.89"></a><span id="l82.89" class="difflineplus">+nsresult DIR_ShutDown(</span>
<a href="#l82.90"></a><span id="l82.90" class="difflineplus">+    void); /* FEs should call this when the app is shutting down. It frees all</span>
<a href="#l82.91"></a><span id="l82.91" class="difflineplus">+              DIR_Servers regardless of ref count values! */</span>
<a href="#l82.92"></a><span id="l82.92"> </span>
<a href="#l82.93"></a><span id="l82.93"> nsresult DIR_AddNewAddressBook(const nsAString &amp;dirName,</span>
<a href="#l82.94"></a><span id="l82.94">                                const nsACString &amp;fileName,</span>
<a href="#l82.95"></a><span id="l82.95" class="difflineminus">-                               const nsACString &amp;uri,</span>
<a href="#l82.96"></a><span id="l82.96" class="difflineminus">-                               DirectoryType dirType,</span>
<a href="#l82.97"></a><span id="l82.97" class="difflineplus">+                               const nsACString &amp;uri, DirectoryType dirType,</span>
<a href="#l82.98"></a><span id="l82.98">                                const nsACString &amp;prefName,</span>
<a href="#l82.99"></a><span id="l82.99" class="difflineminus">-                               DIR_Server** pServer);</span>
<a href="#l82.100"></a><span id="l82.100" class="difflineminus">-nsresult DIR_ContainsServer(DIR_Server* pServer, bool *hasDir);</span>
<a href="#l82.101"></a><span id="l82.101" class="difflineplus">+                               DIR_Server **pServer);</span>
<a href="#l82.102"></a><span id="l82.102" class="difflineplus">+nsresult DIR_ContainsServer(DIR_Server *pServer, bool *hasDir);</span>
<a href="#l82.103"></a><span id="l82.103"> </span>
<a href="#l82.104"></a><span id="l82.104" class="difflineminus">-nsresult DIR_DeleteServerFromList (DIR_Server *);</span>
<a href="#l82.105"></a><span id="l82.105" class="difflineplus">+nsresult DIR_DeleteServerFromList(DIR_Server *);</span>
<a href="#l82.106"></a><span id="l82.106"> </span>
<a href="#l82.107"></a><span id="l82.107"> void DIR_SavePrefsForOneServer(DIR_Server *server);</span>
<a href="#l82.108"></a><span id="l82.108"> </span>
<a href="#l82.109"></a><span id="l82.109" class="difflineminus">-void DIR_SetServerFileName(DIR_Server* pServer);</span>
<a href="#l82.110"></a><span id="l82.110" class="difflineplus">+void DIR_SetServerFileName(DIR_Server *pServer);</span>
<a href="#l82.111"></a><span id="l82.111"> </span>
<a href="#l82.112"></a><span id="l82.112"> #endif /* dirprefs.h */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMapiAddressBook.cpp</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMapiAddressBook.cpp</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -4,142 +4,154 @@</span>
<a href="#l83.4"></a><span id="l83.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l83.5"></a><span id="l83.5"> #include &quot;nsMapiAddressBook.h&quot;</span>
<a href="#l83.6"></a><span id="l83.6"> </span>
<a href="#l83.7"></a><span id="l83.7"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l83.8"></a><span id="l83.8"> #include &quot;mozilla/DebugOnly.h&quot;</span>
<a href="#l83.9"></a><span id="l83.9"> </span>
<a href="#l83.10"></a><span id="l83.10"> static mozilla::LazyLogModule gMapiAddressBookLog(&quot;MAPIAddressBook&quot;);</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-#define PRINTF(args) MOZ_LOG(gMapiAddressBookLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+#define PRINTF(args) \</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+  MOZ_LOG(gMapiAddressBookLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l83.15"></a><span id="l83.15"> </span>
<a href="#l83.16"></a><span id="l83.16"> using namespace mozilla;</span>
<a href="#l83.17"></a><span id="l83.17"> </span>
<a href="#l83.18"></a><span id="l83.18" class="difflineminus">-HMODULE nsMapiAddressBook::mLibrary = NULL ;</span>
<a href="#l83.19"></a><span id="l83.19" class="difflineminus">-int32_t nsMapiAddressBook::mLibUsage = 0 ;</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineminus">-LPMAPIINITIALIZE nsMapiAddressBook::mMAPIInitialize = NULL ;</span>
<a href="#l83.21"></a><span id="l83.21" class="difflineminus">-LPMAPIUNINITIALIZE nsMapiAddressBook::mMAPIUninitialize = NULL ;</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineminus">-LPMAPIALLOCATEBUFFER nsMapiAddressBook::mMAPIAllocateBuffer = NULL ;</span>
<a href="#l83.23"></a><span id="l83.23" class="difflineminus">-LPMAPIFREEBUFFER nsMapiAddressBook::mMAPIFreeBuffer = NULL ;</span>
<a href="#l83.24"></a><span id="l83.24" class="difflineminus">-LPMAPILOGONEX nsMapiAddressBook::mMAPILogonEx = NULL ;</span>
<a href="#l83.25"></a><span id="l83.25" class="difflineplus">+HMODULE nsMapiAddressBook::mLibrary = NULL;</span>
<a href="#l83.26"></a><span id="l83.26" class="difflineplus">+int32_t nsMapiAddressBook::mLibUsage = 0;</span>
<a href="#l83.27"></a><span id="l83.27" class="difflineplus">+LPMAPIINITIALIZE nsMapiAddressBook::mMAPIInitialize = NULL;</span>
<a href="#l83.28"></a><span id="l83.28" class="difflineplus">+LPMAPIUNINITIALIZE nsMapiAddressBook::mMAPIUninitialize = NULL;</span>
<a href="#l83.29"></a><span id="l83.29" class="difflineplus">+LPMAPIALLOCATEBUFFER nsMapiAddressBook::mMAPIAllocateBuffer = NULL;</span>
<a href="#l83.30"></a><span id="l83.30" class="difflineplus">+LPMAPIFREEBUFFER nsMapiAddressBook::mMAPIFreeBuffer = NULL;</span>
<a href="#l83.31"></a><span id="l83.31" class="difflineplus">+LPMAPILOGONEX nsMapiAddressBook::mMAPILogonEx = NULL;</span>
<a href="#l83.32"></a><span id="l83.32"> </span>
<a href="#l83.33"></a><span id="l83.33" class="difflineminus">-BOOL nsMapiAddressBook::mInitialized = FALSE ;</span>
<a href="#l83.34"></a><span id="l83.34" class="difflineminus">-BOOL nsMapiAddressBook::mLogonDone = FALSE ;</span>
<a href="#l83.35"></a><span id="l83.35" class="difflineminus">-LPMAPISESSION nsMapiAddressBook::mRootSession = NULL ;</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineminus">-LPADRBOOK nsMapiAddressBook::mRootBook = NULL ;</span>
<a href="#l83.37"></a><span id="l83.37" class="difflineplus">+BOOL nsMapiAddressBook::mInitialized = FALSE;</span>
<a href="#l83.38"></a><span id="l83.38" class="difflineplus">+BOOL nsMapiAddressBook::mLogonDone = FALSE;</span>
<a href="#l83.39"></a><span id="l83.39" class="difflineplus">+LPMAPISESSION nsMapiAddressBook::mRootSession = NULL;</span>
<a href="#l83.40"></a><span id="l83.40" class="difflineplus">+LPADRBOOK nsMapiAddressBook::mRootBook = NULL;</span>
<a href="#l83.41"></a><span id="l83.41"> </span>
<a href="#l83.42"></a><span id="l83.42" class="difflineminus">-BOOL nsMapiAddressBook::LoadMapiLibrary(void)</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineminus">-{</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineminus">-    if (mLibrary) { ++ mLibUsage ; return TRUE ; }</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineminus">-    HMODULE libraryHandle = LoadLibrary(&quot;MAPI32.DLL&quot;) ;</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineplus">+BOOL nsMapiAddressBook::LoadMapiLibrary(void) {</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineplus">+  if (mLibrary) {</span>
<a href="#l83.48"></a><span id="l83.48" class="difflineplus">+    ++mLibUsage;</span>
<a href="#l83.49"></a><span id="l83.49" class="difflineplus">+    return TRUE;</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineplus">+  }</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+  HMODULE libraryHandle = LoadLibrary(&quot;MAPI32.DLL&quot;);</span>
<a href="#l83.52"></a><span id="l83.52"> </span>
<a href="#l83.53"></a><span id="l83.53" class="difflineminus">-    if (!libraryHandle) { return FALSE ; }</span>
<a href="#l83.54"></a><span id="l83.54" class="difflineminus">-    FARPROC entryPoint = GetProcAddress(libraryHandle, &quot;MAPIGetNetscapeVersion&quot;) ;</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineplus">+  if (!libraryHandle) {</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineplus">+    return FALSE;</span>
<a href="#l83.57"></a><span id="l83.57" class="difflineplus">+  }</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineplus">+  FARPROC entryPoint = GetProcAddress(libraryHandle, &quot;MAPIGetNetscapeVersion&quot;);</span>
<a href="#l83.59"></a><span id="l83.59"> </span>
<a href="#l83.60"></a><span id="l83.60" class="difflineminus">-    if (entryPoint) {</span>
<a href="#l83.61"></a><span id="l83.61" class="difflineminus">-        FreeLibrary(libraryHandle) ;</span>
<a href="#l83.62"></a><span id="l83.62" class="difflineminus">-        libraryHandle = LoadLibrary(&quot;MAPI32BAK.DLL&quot;) ;</span>
<a href="#l83.63"></a><span id="l83.63" class="difflineminus">-        if (!libraryHandle) { return FALSE ; }</span>
<a href="#l83.64"></a><span id="l83.64" class="difflineplus">+  if (entryPoint) {</span>
<a href="#l83.65"></a><span id="l83.65" class="difflineplus">+    FreeLibrary(libraryHandle);</span>
<a href="#l83.66"></a><span id="l83.66" class="difflineplus">+    libraryHandle = LoadLibrary(&quot;MAPI32BAK.DLL&quot;);</span>
<a href="#l83.67"></a><span id="l83.67" class="difflineplus">+    if (!libraryHandle) {</span>
<a href="#l83.68"></a><span id="l83.68" class="difflineplus">+      return FALSE;</span>
<a href="#l83.69"></a><span id="l83.69">     }</span>
<a href="#l83.70"></a><span id="l83.70" class="difflineminus">-    mLibrary = libraryHandle ;</span>
<a href="#l83.71"></a><span id="l83.71" class="difflineminus">-    ++ mLibUsage ;</span>
<a href="#l83.72"></a><span id="l83.72" class="difflineminus">-    mMAPIInitialize = reinterpret_cast&lt;LPMAPIINITIALIZE&gt;(GetProcAddress(mLibrary, &quot;MAPIInitialize&quot;)) ;</span>
<a href="#l83.73"></a><span id="l83.73" class="difflineminus">-    if (!mMAPIInitialize) { return FALSE ; }</span>
<a href="#l83.74"></a><span id="l83.74" class="difflineminus">-    mMAPIUninitialize = reinterpret_cast&lt;LPMAPIUNINITIALIZE&gt;(GetProcAddress(mLibrary, &quot;MAPIUninitialize&quot;)) ;</span>
<a href="#l83.75"></a><span id="l83.75" class="difflineminus">-    if (!mMAPIUninitialize) { return FALSE ; }</span>
<a href="#l83.76"></a><span id="l83.76" class="difflineminus">-    mMAPIAllocateBuffer = reinterpret_cast&lt;LPMAPIALLOCATEBUFFER&gt;(GetProcAddress(mLibrary, &quot;MAPIAllocateBuffer&quot;)) ;</span>
<a href="#l83.77"></a><span id="l83.77" class="difflineminus">-    if (!mMAPIAllocateBuffer) { return FALSE ; }</span>
<a href="#l83.78"></a><span id="l83.78" class="difflineminus">-    mMAPIFreeBuffer = reinterpret_cast&lt;LPMAPIFREEBUFFER&gt;(GetProcAddress(mLibrary, &quot;MAPIFreeBuffer&quot;)) ;</span>
<a href="#l83.79"></a><span id="l83.79" class="difflineminus">-    if (!mMAPIFreeBuffer) { return FALSE ; }</span>
<a href="#l83.80"></a><span id="l83.80" class="difflineminus">-    mMAPILogonEx = reinterpret_cast&lt;LPMAPILOGONEX&gt;(GetProcAddress(mLibrary, &quot;MAPILogonEx&quot;)) ;</span>
<a href="#l83.81"></a><span id="l83.81" class="difflineminus">-    if (!mMAPILogonEx) { return FALSE ; }</span>
<a href="#l83.82"></a><span id="l83.82" class="difflineminus">-    MAPIINIT_0 mapiInit = { MAPI_INIT_VERSION, MAPI_MULTITHREAD_NOTIFICATIONS } ;</span>
<a href="#l83.83"></a><span id="l83.83" class="difflineminus">-    HRESULT retCode = mMAPIInitialize(&amp;mapiInit) ;</span>
<a href="#l83.84"></a><span id="l83.84" class="difflineplus">+  }</span>
<a href="#l83.85"></a><span id="l83.85" class="difflineplus">+  mLibrary = libraryHandle;</span>
<a href="#l83.86"></a><span id="l83.86" class="difflineplus">+  ++mLibUsage;</span>
<a href="#l83.87"></a><span id="l83.87" class="difflineplus">+  mMAPIInitialize = reinterpret_cast&lt;LPMAPIINITIALIZE&gt;(</span>
<a href="#l83.88"></a><span id="l83.88" class="difflineplus">+      GetProcAddress(mLibrary, &quot;MAPIInitialize&quot;));</span>
<a href="#l83.89"></a><span id="l83.89" class="difflineplus">+  if (!mMAPIInitialize) {</span>
<a href="#l83.90"></a><span id="l83.90" class="difflineplus">+    return FALSE;</span>
<a href="#l83.91"></a><span id="l83.91" class="difflineplus">+  }</span>
<a href="#l83.92"></a><span id="l83.92" class="difflineplus">+  mMAPIUninitialize = reinterpret_cast&lt;LPMAPIUNINITIALIZE&gt;(</span>
<a href="#l83.93"></a><span id="l83.93" class="difflineplus">+      GetProcAddress(mLibrary, &quot;MAPIUninitialize&quot;));</span>
<a href="#l83.94"></a><span id="l83.94" class="difflineplus">+  if (!mMAPIUninitialize) {</span>
<a href="#l83.95"></a><span id="l83.95" class="difflineplus">+    return FALSE;</span>
<a href="#l83.96"></a><span id="l83.96" class="difflineplus">+  }</span>
<a href="#l83.97"></a><span id="l83.97" class="difflineplus">+  mMAPIAllocateBuffer = reinterpret_cast&lt;LPMAPIALLOCATEBUFFER&gt;(</span>
<a href="#l83.98"></a><span id="l83.98" class="difflineplus">+      GetProcAddress(mLibrary, &quot;MAPIAllocateBuffer&quot;));</span>
<a href="#l83.99"></a><span id="l83.99" class="difflineplus">+  if (!mMAPIAllocateBuffer) {</span>
<a href="#l83.100"></a><span id="l83.100" class="difflineplus">+    return FALSE;</span>
<a href="#l83.101"></a><span id="l83.101" class="difflineplus">+  }</span>
<a href="#l83.102"></a><span id="l83.102" class="difflineplus">+  mMAPIFreeBuffer = reinterpret_cast&lt;LPMAPIFREEBUFFER&gt;(</span>
<a href="#l83.103"></a><span id="l83.103" class="difflineplus">+      GetProcAddress(mLibrary, &quot;MAPIFreeBuffer&quot;));</span>
<a href="#l83.104"></a><span id="l83.104" class="difflineplus">+  if (!mMAPIFreeBuffer) {</span>
<a href="#l83.105"></a><span id="l83.105" class="difflineplus">+    return FALSE;</span>
<a href="#l83.106"></a><span id="l83.106" class="difflineplus">+  }</span>
<a href="#l83.107"></a><span id="l83.107" class="difflineplus">+  mMAPILogonEx =</span>
<a href="#l83.108"></a><span id="l83.108" class="difflineplus">+      reinterpret_cast&lt;LPMAPILOGONEX&gt;(GetProcAddress(mLibrary, &quot;MAPILogonEx&quot;));</span>
<a href="#l83.109"></a><span id="l83.109" class="difflineplus">+  if (!mMAPILogonEx) {</span>
<a href="#l83.110"></a><span id="l83.110" class="difflineplus">+    return FALSE;</span>
<a href="#l83.111"></a><span id="l83.111" class="difflineplus">+  }</span>
<a href="#l83.112"></a><span id="l83.112" class="difflineplus">+  MAPIINIT_0 mapiInit = {MAPI_INIT_VERSION, MAPI_MULTITHREAD_NOTIFICATIONS};</span>
<a href="#l83.113"></a><span id="l83.113" class="difflineplus">+  HRESULT retCode = mMAPIInitialize(&amp;mapiInit);</span>
<a href="#l83.114"></a><span id="l83.114"> </span>
<a href="#l83.115"></a><span id="l83.115" class="difflineminus">-    if (HR_FAILED(retCode)) {</span>
<a href="#l83.116"></a><span id="l83.116" class="difflineminus">-        PRINTF((&quot;Cannot initialize MAPI %08x.\n&quot;, retCode)) ; return FALSE ;</span>
<a href="#l83.117"></a><span id="l83.117" class="difflineminus">-    }</span>
<a href="#l83.118"></a><span id="l83.118" class="difflineminus">-    mInitialized = TRUE ;</span>
<a href="#l83.119"></a><span id="l83.119" class="difflineminus">-    retCode = mMAPILogonEx(0, NULL, NULL,</span>
<a href="#l83.120"></a><span id="l83.120" class="difflineminus">-                           MAPI_NO_MAIL |</span>
<a href="#l83.121"></a><span id="l83.121" class="difflineminus">-                           MAPI_USE_DEFAULT |</span>
<a href="#l83.122"></a><span id="l83.122" class="difflineminus">-                           MAPI_EXTENDED |</span>
<a href="#l83.123"></a><span id="l83.123" class="difflineminus">-                           MAPI_NEW_SESSION,</span>
<a href="#l83.124"></a><span id="l83.124" class="difflineminus">-                           &amp;mRootSession) ;</span>
<a href="#l83.125"></a><span id="l83.125" class="difflineminus">-    if (HR_FAILED(retCode)) {</span>
<a href="#l83.126"></a><span id="l83.126" class="difflineminus">-        PRINTF((&quot;Cannot logon to MAPI %08x.\n&quot;, retCode)) ; return FALSE ;</span>
<a href="#l83.127"></a><span id="l83.127" class="difflineminus">-    }</span>
<a href="#l83.128"></a><span id="l83.128" class="difflineminus">-    mLogonDone = TRUE ;</span>
<a href="#l83.129"></a><span id="l83.129" class="difflineminus">-    retCode = mRootSession-&gt;OpenAddressBook(0, NULL, 0, &amp;mRootBook) ;</span>
<a href="#l83.130"></a><span id="l83.130" class="difflineminus">-    if (HR_FAILED(retCode)) {</span>
<a href="#l83.131"></a><span id="l83.131" class="difflineminus">-        PRINTF((&quot;Cannot open MAPI address book %08x.\n&quot;, retCode)) ;</span>
<a href="#l83.132"></a><span id="l83.132" class="difflineminus">-    }</span>
<a href="#l83.133"></a><span id="l83.133" class="difflineminus">-    return HR_SUCCEEDED(retCode) ;</span>
<a href="#l83.134"></a><span id="l83.134" class="difflineplus">+  if (HR_FAILED(retCode)) {</span>
<a href="#l83.135"></a><span id="l83.135" class="difflineplus">+    PRINTF((&quot;Cannot initialize MAPI %08x.\n&quot;, retCode));</span>
<a href="#l83.136"></a><span id="l83.136" class="difflineplus">+    return FALSE;</span>
<a href="#l83.137"></a><span id="l83.137" class="difflineplus">+  }</span>
<a href="#l83.138"></a><span id="l83.138" class="difflineplus">+  mInitialized = TRUE;</span>
<a href="#l83.139"></a><span id="l83.139" class="difflineplus">+  retCode = mMAPILogonEx(</span>
<a href="#l83.140"></a><span id="l83.140" class="difflineplus">+      0, NULL, NULL,</span>
<a href="#l83.141"></a><span id="l83.141" class="difflineplus">+      MAPI_NO_MAIL | MAPI_USE_DEFAULT | MAPI_EXTENDED | MAPI_NEW_SESSION,</span>
<a href="#l83.142"></a><span id="l83.142" class="difflineplus">+      &amp;mRootSession);</span>
<a href="#l83.143"></a><span id="l83.143" class="difflineplus">+  if (HR_FAILED(retCode)) {</span>
<a href="#l83.144"></a><span id="l83.144" class="difflineplus">+    PRINTF((&quot;Cannot logon to MAPI %08x.\n&quot;, retCode));</span>
<a href="#l83.145"></a><span id="l83.145" class="difflineplus">+    return FALSE;</span>
<a href="#l83.146"></a><span id="l83.146" class="difflineplus">+  }</span>
<a href="#l83.147"></a><span id="l83.147" class="difflineplus">+  mLogonDone = TRUE;</span>
<a href="#l83.148"></a><span id="l83.148" class="difflineplus">+  retCode = mRootSession-&gt;OpenAddressBook(0, NULL, 0, &amp;mRootBook);</span>
<a href="#l83.149"></a><span id="l83.149" class="difflineplus">+  if (HR_FAILED(retCode)) {</span>
<a href="#l83.150"></a><span id="l83.150" class="difflineplus">+    PRINTF((&quot;Cannot open MAPI address book %08x.\n&quot;, retCode));</span>
<a href="#l83.151"></a><span id="l83.151" class="difflineplus">+  }</span>
<a href="#l83.152"></a><span id="l83.152" class="difflineplus">+  return HR_SUCCEEDED(retCode);</span>
<a href="#l83.153"></a><span id="l83.153"> }</span>
<a href="#l83.154"></a><span id="l83.154"> </span>
<a href="#l83.155"></a><span id="l83.155" class="difflineminus">-void nsMapiAddressBook::FreeMapiLibrary(void)</span>
<a href="#l83.156"></a><span id="l83.156" class="difflineminus">-{</span>
<a href="#l83.157"></a><span id="l83.157" class="difflineminus">-    if (mLibrary) {</span>
<a href="#l83.158"></a><span id="l83.158" class="difflineminus">-        if (-- mLibUsage == 0) {</span>
<a href="#l83.159"></a><span id="l83.159" class="difflineminus">-            {</span>
<a href="#l83.160"></a><span id="l83.160" class="difflineminus">-                if (mRootBook) { mRootBook-&gt;Release() ; }</span>
<a href="#l83.161"></a><span id="l83.161" class="difflineminus">-                if (mRootSession) {</span>
<a href="#l83.162"></a><span id="l83.162" class="difflineminus">-                    if (mLogonDone) {</span>
<a href="#l83.163"></a><span id="l83.163" class="difflineminus">-                        mRootSession-&gt;Logoff(NULL, 0, 0) ;</span>
<a href="#l83.164"></a><span id="l83.164" class="difflineminus">-                        mLogonDone = FALSE ;</span>
<a href="#l83.165"></a><span id="l83.165" class="difflineminus">-                    }</span>
<a href="#l83.166"></a><span id="l83.166" class="difflineminus">-                    mRootSession-&gt;Release() ;</span>
<a href="#l83.167"></a><span id="l83.167" class="difflineminus">-                }</span>
<a href="#l83.168"></a><span id="l83.168" class="difflineminus">-                if (mInitialized) {</span>
<a href="#l83.169"></a><span id="l83.169" class="difflineminus">-                    mMAPIUninitialize() ;</span>
<a href="#l83.170"></a><span id="l83.170" class="difflineminus">-                    mInitialized = FALSE ;</span>
<a href="#l83.171"></a><span id="l83.171" class="difflineminus">-                }</span>
<a href="#l83.172"></a><span id="l83.172" class="difflineminus">-            }</span>
<a href="#l83.173"></a><span id="l83.173" class="difflineminus">-            FreeLibrary(mLibrary) ;</span>
<a href="#l83.174"></a><span id="l83.174" class="difflineminus">-            mLibrary = NULL ;</span>
<a href="#l83.175"></a><span id="l83.175" class="difflineplus">+void nsMapiAddressBook::FreeMapiLibrary(void) {</span>
<a href="#l83.176"></a><span id="l83.176" class="difflineplus">+  if (mLibrary) {</span>
<a href="#l83.177"></a><span id="l83.177" class="difflineplus">+    if (--mLibUsage == 0) {</span>
<a href="#l83.178"></a><span id="l83.178" class="difflineplus">+      {</span>
<a href="#l83.179"></a><span id="l83.179" class="difflineplus">+        if (mRootBook) {</span>
<a href="#l83.180"></a><span id="l83.180" class="difflineplus">+          mRootBook-&gt;Release();</span>
<a href="#l83.181"></a><span id="l83.181">         }</span>
<a href="#l83.182"></a><span id="l83.182" class="difflineplus">+        if (mRootSession) {</span>
<a href="#l83.183"></a><span id="l83.183" class="difflineplus">+          if (mLogonDone) {</span>
<a href="#l83.184"></a><span id="l83.184" class="difflineplus">+            mRootSession-&gt;Logoff(NULL, 0, 0);</span>
<a href="#l83.185"></a><span id="l83.185" class="difflineplus">+            mLogonDone = FALSE;</span>
<a href="#l83.186"></a><span id="l83.186" class="difflineplus">+          }</span>
<a href="#l83.187"></a><span id="l83.187" class="difflineplus">+          mRootSession-&gt;Release();</span>
<a href="#l83.188"></a><span id="l83.188" class="difflineplus">+        }</span>
<a href="#l83.189"></a><span id="l83.189" class="difflineplus">+        if (mInitialized) {</span>
<a href="#l83.190"></a><span id="l83.190" class="difflineplus">+          mMAPIUninitialize();</span>
<a href="#l83.191"></a><span id="l83.191" class="difflineplus">+          mInitialized = FALSE;</span>
<a href="#l83.192"></a><span id="l83.192" class="difflineplus">+        }</span>
<a href="#l83.193"></a><span id="l83.193" class="difflineplus">+      }</span>
<a href="#l83.194"></a><span id="l83.194" class="difflineplus">+      FreeLibrary(mLibrary);</span>
<a href="#l83.195"></a><span id="l83.195" class="difflineplus">+      mLibrary = NULL;</span>
<a href="#l83.196"></a><span id="l83.196">     }</span>
<a href="#l83.197"></a><span id="l83.197" class="difflineminus">-}</span>
<a href="#l83.198"></a><span id="l83.198" class="difflineminus">-</span>
<a href="#l83.199"></a><span id="l83.199" class="difflineminus">-nsMapiAddressBook::nsMapiAddressBook(void)</span>
<a href="#l83.200"></a><span id="l83.200" class="difflineminus">-: nsAbWinHelper()</span>
<a href="#l83.201"></a><span id="l83.201" class="difflineminus">-{</span>
<a href="#l83.202"></a><span id="l83.202" class="difflineminus">-    mozilla::DebugOnly&lt;BOOL&gt; result = Initialize() ;</span>
<a href="#l83.203"></a><span id="l83.203" class="difflineminus">-</span>
<a href="#l83.204"></a><span id="l83.204" class="difflineminus">-    NS_ASSERTION(result == TRUE, &quot;Couldn't initialize Mapi Helper&quot;) ;</span>
<a href="#l83.205"></a><span id="l83.205" class="difflineminus">-    MOZ_COUNT_CTOR(nsMapiAddressBook) ;</span>
<a href="#l83.206"></a><span id="l83.206" class="difflineplus">+  }</span>
<a href="#l83.207"></a><span id="l83.207"> }</span>
<a href="#l83.208"></a><span id="l83.208"> </span>
<a href="#l83.209"></a><span id="l83.209" class="difflineminus">-nsMapiAddressBook::~nsMapiAddressBook(void)</span>
<a href="#l83.210"></a><span id="l83.210" class="difflineminus">-{</span>
<a href="#l83.211"></a><span id="l83.211" class="difflineminus">-    MutexAutoLock guard(*mMutex) ;</span>
<a href="#l83.212"></a><span id="l83.212" class="difflineplus">+nsMapiAddressBook::nsMapiAddressBook(void) : nsAbWinHelper() {</span>
<a href="#l83.213"></a><span id="l83.213" class="difflineplus">+  mozilla::DebugOnly&lt;BOOL&gt; result = Initialize();</span>
<a href="#l83.214"></a><span id="l83.214"> </span>
<a href="#l83.215"></a><span id="l83.215" class="difflineminus">-    FreeMapiLibrary() ;</span>
<a href="#l83.216"></a><span id="l83.216" class="difflineminus">-    MOZ_COUNT_DTOR(nsMapiAddressBook) ;</span>
<a href="#l83.217"></a><span id="l83.217" class="difflineplus">+  NS_ASSERTION(result == TRUE, &quot;Couldn't initialize Mapi Helper&quot;);</span>
<a href="#l83.218"></a><span id="l83.218" class="difflineplus">+  MOZ_COUNT_CTOR(nsMapiAddressBook);</span>
<a href="#l83.219"></a><span id="l83.219" class="difflineplus">+}</span>
<a href="#l83.220"></a><span id="l83.220" class="difflineplus">+</span>
<a href="#l83.221"></a><span id="l83.221" class="difflineplus">+nsMapiAddressBook::~nsMapiAddressBook(void) {</span>
<a href="#l83.222"></a><span id="l83.222" class="difflineplus">+  MutexAutoLock guard(*mMutex);</span>
<a href="#l83.223"></a><span id="l83.223" class="difflineplus">+</span>
<a href="#l83.224"></a><span id="l83.224" class="difflineplus">+  FreeMapiLibrary();</span>
<a href="#l83.225"></a><span id="l83.225" class="difflineplus">+  MOZ_COUNT_DTOR(nsMapiAddressBook);</span>
<a href="#l83.226"></a><span id="l83.226"> }</span>
<a href="#l83.227"></a><span id="l83.227"> </span>
<a href="#l83.228"></a><span id="l83.228" class="difflineminus">-BOOL nsMapiAddressBook::Initialize(void)</span>
<a href="#l83.229"></a><span id="l83.229" class="difflineminus">-{</span>
<a href="#l83.230"></a><span id="l83.230" class="difflineminus">-    if (mAddressBook) { return TRUE ; }</span>
<a href="#l83.231"></a><span id="l83.231" class="difflineminus">-    MutexAutoLock guard(*mMutex) ;</span>
<a href="#l83.232"></a><span id="l83.232" class="difflineplus">+BOOL nsMapiAddressBook::Initialize(void) {</span>
<a href="#l83.233"></a><span id="l83.233" class="difflineplus">+  if (mAddressBook) {</span>
<a href="#l83.234"></a><span id="l83.234" class="difflineplus">+    return TRUE;</span>
<a href="#l83.235"></a><span id="l83.235" class="difflineplus">+  }</span>
<a href="#l83.236"></a><span id="l83.236" class="difflineplus">+  MutexAutoLock guard(*mMutex);</span>
<a href="#l83.237"></a><span id="l83.237"> </span>
<a href="#l83.238"></a><span id="l83.238" class="difflineminus">-    if (!LoadMapiLibrary()) {</span>
<a href="#l83.239"></a><span id="l83.239" class="difflineminus">-        PRINTF((&quot;Cannot load library.\n&quot;)) ;</span>
<a href="#l83.240"></a><span id="l83.240" class="difflineminus">-        return FALSE ;</span>
<a href="#l83.241"></a><span id="l83.241" class="difflineminus">-    }</span>
<a href="#l83.242"></a><span id="l83.242" class="difflineminus">-    mAddressBook = mRootBook ;</span>
<a href="#l83.243"></a><span id="l83.243" class="difflineminus">-    return TRUE ;</span>
<a href="#l83.244"></a><span id="l83.244" class="difflineplus">+  if (!LoadMapiLibrary()) {</span>
<a href="#l83.245"></a><span id="l83.245" class="difflineplus">+    PRINTF((&quot;Cannot load library.\n&quot;));</span>
<a href="#l83.246"></a><span id="l83.246" class="difflineplus">+    return FALSE;</span>
<a href="#l83.247"></a><span id="l83.247" class="difflineplus">+  }</span>
<a href="#l83.248"></a><span id="l83.248" class="difflineplus">+  mAddressBook = mRootBook;</span>
<a href="#l83.249"></a><span id="l83.249" class="difflineplus">+  return TRUE;</span>
<a href="#l83.250"></a><span id="l83.250"> }</span>
<a href="#l83.251"></a><span id="l83.251"> </span>
<a href="#l83.252"></a><span id="l83.252" class="difflineminus">-void nsMapiAddressBook::AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer)</span>
<a href="#l83.253"></a><span id="l83.253" class="difflineminus">-{</span>
<a href="#l83.254"></a><span id="l83.254" class="difflineminus">-    mMAPIAllocateBuffer(aByteCount, aBuffer) ;</span>
<a href="#l83.255"></a><span id="l83.255" class="difflineplus">+void nsMapiAddressBook::AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) {</span>
<a href="#l83.256"></a><span id="l83.256" class="difflineplus">+  mMAPIAllocateBuffer(aByteCount, aBuffer);</span>
<a href="#l83.257"></a><span id="l83.257"> }</span>
<a href="#l83.258"></a><span id="l83.258"> </span>
<a href="#l83.259"></a><span id="l83.259" class="difflineminus">-void nsMapiAddressBook::FreeBuffer(LPVOID aBuffer)</span>
<a href="#l83.260"></a><span id="l83.260" class="difflineminus">-{</span>
<a href="#l83.261"></a><span id="l83.261" class="difflineminus">-    mMAPIFreeBuffer(aBuffer) ;</span>
<a href="#l83.262"></a><span id="l83.262" class="difflineminus">-}</span>
<a href="#l83.263"></a><span id="l83.263" class="difflineminus">-</span>
<a href="#l83.264"></a><span id="l83.264" class="difflineminus">-</span>
<a href="#l83.265"></a><span id="l83.265" class="difflineminus">-</span>
<a href="#l83.266"></a><span id="l83.266" class="difflineminus">-</span>
<a href="#l83.267"></a><span id="l83.267" class="difflineminus">-</span>
<a href="#l83.268"></a><span id="l83.268" class="difflineplus">+void nsMapiAddressBook::FreeBuffer(LPVOID aBuffer) { mMAPIFreeBuffer(aBuffer); }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMapiAddressBook.h</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMapiAddressBook.h</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -3,52 +3,50 @@</span>
<a href="#l84.4"></a><span id="l84.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l84.5"></a><span id="l84.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l84.6"></a><span id="l84.6"> #ifndef nsMapiAddressBook_h___</span>
<a href="#l84.7"></a><span id="l84.7"> #define nsMapiAddressBook_h___</span>
<a href="#l84.8"></a><span id="l84.8"> </span>
<a href="#l84.9"></a><span id="l84.9"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l84.10"></a><span id="l84.10"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l84.11"></a><span id="l84.11"> </span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-class nsMapiAddressBook : public nsAbWinHelper</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineminus">-{</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineminus">-public :</span>
<a href="#l84.15"></a><span id="l84.15" class="difflineminus">-    nsMapiAddressBook(void) ;</span>
<a href="#l84.16"></a><span id="l84.16" class="difflineminus">-    virtual ~nsMapiAddressBook(void) ;</span>
<a href="#l84.17"></a><span id="l84.17" class="difflineplus">+class nsMapiAddressBook : public nsAbWinHelper {</span>
<a href="#l84.18"></a><span id="l84.18" class="difflineplus">+ public:</span>
<a href="#l84.19"></a><span id="l84.19" class="difflineplus">+  nsMapiAddressBook(void);</span>
<a href="#l84.20"></a><span id="l84.20" class="difflineplus">+  virtual ~nsMapiAddressBook(void);</span>
<a href="#l84.21"></a><span id="l84.21"> </span>
<a href="#l84.22"></a><span id="l84.22" class="difflineminus">-protected :</span>
<a href="#l84.23"></a><span id="l84.23" class="difflineminus">-    // Class members to handle the library/entry points</span>
<a href="#l84.24"></a><span id="l84.24" class="difflineminus">-    static HMODULE mLibrary ;</span>
<a href="#l84.25"></a><span id="l84.25" class="difflineminus">-    static int32_t mLibUsage ;</span>
<a href="#l84.26"></a><span id="l84.26" class="difflineminus">-    static LPMAPIINITIALIZE mMAPIInitialize ;</span>
<a href="#l84.27"></a><span id="l84.27" class="difflineminus">-    static LPMAPIUNINITIALIZE mMAPIUninitialize ;</span>
<a href="#l84.28"></a><span id="l84.28" class="difflineminus">-    static LPMAPIALLOCATEBUFFER mMAPIAllocateBuffer ;</span>
<a href="#l84.29"></a><span id="l84.29" class="difflineminus">-    static LPMAPIFREEBUFFER mMAPIFreeBuffer ;</span>
<a href="#l84.30"></a><span id="l84.30" class="difflineminus">-    static LPMAPILOGONEX mMAPILogonEx ;</span>
<a href="#l84.31"></a><span id="l84.31" class="difflineminus">-    // Shared session and address book used by all instances.</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineminus">-    // For reasons best left unknown, MAPI doesn't seem to like</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineminus">-    // having different threads playing with supposedly different</span>
<a href="#l84.34"></a><span id="l84.34" class="difflineminus">-    // sessions and address books. They ll end up fighting over</span>
<a href="#l84.35"></a><span id="l84.35" class="difflineminus">-    // the same resources, with hangups and GPF resulting. Not nice.</span>
<a href="#l84.36"></a><span id="l84.36" class="difflineminus">-    // So it seems that if everybody (as long as some client is</span>
<a href="#l84.37"></a><span id="l84.37" class="difflineminus">-    // still alive) is using the same sessions and address books,</span>
<a href="#l84.38"></a><span id="l84.38" class="difflineminus">-    // MAPI feels better. And who are we to get in the way of MAPI</span>
<a href="#l84.39"></a><span id="l84.39" class="difflineminus">-    // happiness? Thus the following class members:</span>
<a href="#l84.40"></a><span id="l84.40" class="difflineminus">-    static BOOL mInitialized ;</span>
<a href="#l84.41"></a><span id="l84.41" class="difflineminus">-    static BOOL mLogonDone ;</span>
<a href="#l84.42"></a><span id="l84.42" class="difflineminus">-    static LPMAPISESSION mRootSession ;</span>
<a href="#l84.43"></a><span id="l84.43" class="difflineminus">-    static LPADRBOOK mRootBook ;</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineplus">+ protected:</span>
<a href="#l84.45"></a><span id="l84.45" class="difflineplus">+  // Class members to handle the library/entry points</span>
<a href="#l84.46"></a><span id="l84.46" class="difflineplus">+  static HMODULE mLibrary;</span>
<a href="#l84.47"></a><span id="l84.47" class="difflineplus">+  static int32_t mLibUsage;</span>
<a href="#l84.48"></a><span id="l84.48" class="difflineplus">+  static LPMAPIINITIALIZE mMAPIInitialize;</span>
<a href="#l84.49"></a><span id="l84.49" class="difflineplus">+  static LPMAPIUNINITIALIZE mMAPIUninitialize;</span>
<a href="#l84.50"></a><span id="l84.50" class="difflineplus">+  static LPMAPIALLOCATEBUFFER mMAPIAllocateBuffer;</span>
<a href="#l84.51"></a><span id="l84.51" class="difflineplus">+  static LPMAPIFREEBUFFER mMAPIFreeBuffer;</span>
<a href="#l84.52"></a><span id="l84.52" class="difflineplus">+  static LPMAPILOGONEX mMAPILogonEx;</span>
<a href="#l84.53"></a><span id="l84.53" class="difflineplus">+  // Shared session and address book used by all instances.</span>
<a href="#l84.54"></a><span id="l84.54" class="difflineplus">+  // For reasons best left unknown, MAPI doesn't seem to like</span>
<a href="#l84.55"></a><span id="l84.55" class="difflineplus">+  // having different threads playing with supposedly different</span>
<a href="#l84.56"></a><span id="l84.56" class="difflineplus">+  // sessions and address books. They ll end up fighting over</span>
<a href="#l84.57"></a><span id="l84.57" class="difflineplus">+  // the same resources, with hangups and GPF resulting. Not nice.</span>
<a href="#l84.58"></a><span id="l84.58" class="difflineplus">+  // So it seems that if everybody (as long as some client is</span>
<a href="#l84.59"></a><span id="l84.59" class="difflineplus">+  // still alive) is using the same sessions and address books,</span>
<a href="#l84.60"></a><span id="l84.60" class="difflineplus">+  // MAPI feels better. And who are we to get in the way of MAPI</span>
<a href="#l84.61"></a><span id="l84.61" class="difflineplus">+  // happiness? Thus the following class members:</span>
<a href="#l84.62"></a><span id="l84.62" class="difflineplus">+  static BOOL mInitialized;</span>
<a href="#l84.63"></a><span id="l84.63" class="difflineplus">+  static BOOL mLogonDone;</span>
<a href="#l84.64"></a><span id="l84.64" class="difflineplus">+  static LPMAPISESSION mRootSession;</span>
<a href="#l84.65"></a><span id="l84.65" class="difflineplus">+  static LPADRBOOK mRootBook;</span>
<a href="#l84.66"></a><span id="l84.66"> </span>
<a href="#l84.67"></a><span id="l84.67" class="difflineminus">-    // Load the MAPI environment</span>
<a href="#l84.68"></a><span id="l84.68" class="difflineminus">-    BOOL Initialize(void) ;</span>
<a href="#l84.69"></a><span id="l84.69" class="difflineminus">-    // Allocation of a buffer for transmission to interfaces</span>
<a href="#l84.70"></a><span id="l84.70" class="difflineminus">-    virtual void AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) override;</span>
<a href="#l84.71"></a><span id="l84.71" class="difflineminus">-    // Destruction of a buffer provided by the interfaces</span>
<a href="#l84.72"></a><span id="l84.72" class="difflineminus">-    virtual void FreeBuffer(LPVOID aBuffer) override;</span>
<a href="#l84.73"></a><span id="l84.73" class="difflineminus">-    // Library management</span>
<a href="#l84.74"></a><span id="l84.74" class="difflineminus">-    static BOOL LoadMapiLibrary(void) ;</span>
<a href="#l84.75"></a><span id="l84.75" class="difflineminus">-    static void FreeMapiLibrary(void) ;</span>
<a href="#l84.76"></a><span id="l84.76" class="difflineplus">+  // Load the MAPI environment</span>
<a href="#l84.77"></a><span id="l84.77" class="difflineplus">+  BOOL Initialize(void);</span>
<a href="#l84.78"></a><span id="l84.78" class="difflineplus">+  // Allocation of a buffer for transmission to interfaces</span>
<a href="#l84.79"></a><span id="l84.79" class="difflineplus">+  virtual void AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) override;</span>
<a href="#l84.80"></a><span id="l84.80" class="difflineplus">+  // Destruction of a buffer provided by the interfaces</span>
<a href="#l84.81"></a><span id="l84.81" class="difflineplus">+  virtual void FreeBuffer(LPVOID aBuffer) override;</span>
<a href="#l84.82"></a><span id="l84.82" class="difflineplus">+  // Library management</span>
<a href="#l84.83"></a><span id="l84.83" class="difflineplus">+  static BOOL LoadMapiLibrary(void);</span>
<a href="#l84.84"></a><span id="l84.84" class="difflineplus">+  static void FreeMapiLibrary(void);</span>
<a href="#l84.85"></a><span id="l84.85"> </span>
<a href="#l84.86"></a><span id="l84.86" class="difflineminus">-private :</span>
<a href="#l84.87"></a><span id="l84.87" class="difflineminus">-} ;</span>
<a href="#l84.88"></a><span id="l84.88" class="difflineplus">+ private:</span>
<a href="#l84.89"></a><span id="l84.89" class="difflineplus">+};</span>
<a href="#l84.90"></a><span id="l84.90"> </span>
<a href="#l84.91"></a><span id="l84.91" class="difflineminus">-#endif // nsMapiAddressBook_h___</span>
<a href="#l84.92"></a><span id="l84.92" class="difflineminus">-</span>
<a href="#l84.93"></a><span id="l84.93" class="difflineplus">+#endif  // nsMapiAddressBook_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMsgVCardService.cpp</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMsgVCardService.cpp</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -5,73 +5,62 @@</span>
<a href="#l85.4"></a><span id="l85.4"> </span>
<a href="#l85.5"></a><span id="l85.5"> #include &quot;nsMsgVCardService.h&quot;</span>
<a href="#l85.6"></a><span id="l85.6"> #include &quot;nsVCard.h&quot;</span>
<a href="#l85.7"></a><span id="l85.7"> #include &quot;prmem.h&quot;</span>
<a href="#l85.8"></a><span id="l85.8"> #include &quot;plstr.h&quot;</span>
<a href="#l85.9"></a><span id="l85.9"> </span>
<a href="#l85.10"></a><span id="l85.10"> NS_IMPL_ISUPPORTS(nsMsgVCardService, nsIMsgVCardService)</span>
<a href="#l85.11"></a><span id="l85.11"> </span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-nsMsgVCardService::nsMsgVCardService()</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineminus">-{</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineplus">+nsMsgVCardService::nsMsgVCardService() {}</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineplus">+</span>
<a href="#l85.16"></a><span id="l85.16" class="difflineplus">+nsMsgVCardService::~nsMsgVCardService() {}</span>
<a href="#l85.17"></a><span id="l85.17" class="difflineplus">+</span>
<a href="#l85.18"></a><span id="l85.18" class="difflineplus">+NS_IMETHODIMP_(void) nsMsgVCardService::CleanVObject(VObject *o) {</span>
<a href="#l85.19"></a><span id="l85.19" class="difflineplus">+  cleanVObject(o);</span>
<a href="#l85.20"></a><span id="l85.20"> }</span>
<a href="#l85.21"></a><span id="l85.21"> </span>
<a href="#l85.22"></a><span id="l85.22" class="difflineminus">-nsMsgVCardService::~nsMsgVCardService()</span>
<a href="#l85.23"></a><span id="l85.23" class="difflineminus">-{</span>
<a href="#l85.24"></a><span id="l85.24" class="difflineminus">-}</span>
<a href="#l85.25"></a><span id="l85.25" class="difflineminus">-</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineminus">-NS_IMETHODIMP_(void) nsMsgVCardService::CleanVObject(VObject * o)</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineminus">-{</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineminus">-    cleanVObject(o);</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineplus">+NS_IMETHODIMP_(VObject *) nsMsgVCardService::NextVObjectInList(VObject *o) {</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineplus">+  return nextVObjectInList(o);</span>
<a href="#l85.31"></a><span id="l85.31"> }</span>
<a href="#l85.32"></a><span id="l85.32"> </span>
<a href="#l85.33"></a><span id="l85.33" class="difflineminus">-NS_IMETHODIMP_(VObject *) nsMsgVCardService::NextVObjectInList(VObject * o)</span>
<a href="#l85.34"></a><span id="l85.34" class="difflineminus">-{</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineminus">-    return nextVObjectInList(o);</span>
<a href="#l85.36"></a><span id="l85.36" class="difflineplus">+NS_IMETHODIMP_(VObject *)</span>
<a href="#l85.37"></a><span id="l85.37" class="difflineplus">+nsMsgVCardService::Parse_MIME(const char *input, uint32_t len) {</span>
<a href="#l85.38"></a><span id="l85.38" class="difflineplus">+  return parse_MIME(input, (unsigned long)len);</span>
<a href="#l85.39"></a><span id="l85.39"> }</span>
<a href="#l85.40"></a><span id="l85.40"> </span>
<a href="#l85.41"></a><span id="l85.41" class="difflineminus">-NS_IMETHODIMP_(VObject *) nsMsgVCardService::Parse_MIME(const char *input, uint32_t len)</span>
<a href="#l85.42"></a><span id="l85.42" class="difflineminus">-{</span>
<a href="#l85.43"></a><span id="l85.43" class="difflineminus">-    return parse_MIME(input, (unsigned long)len);</span>
<a href="#l85.44"></a><span id="l85.44" class="difflineplus">+NS_IMETHODIMP_(char *) nsMsgVCardService::FakeCString(VObject *o) {</span>
<a href="#l85.45"></a><span id="l85.45" class="difflineplus">+  return fakeCString(vObjectUStringZValue(o));</span>
<a href="#l85.46"></a><span id="l85.46"> }</span>
<a href="#l85.47"></a><span id="l85.47"> </span>
<a href="#l85.48"></a><span id="l85.48" class="difflineminus">-NS_IMETHODIMP_(char *) nsMsgVCardService::FakeCString(VObject * o)</span>
<a href="#l85.49"></a><span id="l85.49" class="difflineminus">-{</span>
<a href="#l85.50"></a><span id="l85.50" class="difflineminus">-    return fakeCString(vObjectUStringZValue(o));</span>
<a href="#l85.51"></a><span id="l85.51" class="difflineminus">-}</span>
<a href="#l85.52"></a><span id="l85.52" class="difflineminus">-</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineminus">-NS_IMETHODIMP_(VObject *) nsMsgVCardService::IsAPropertyOf(VObject * o, const char *id)</span>
<a href="#l85.54"></a><span id="l85.54" class="difflineminus">-{</span>
<a href="#l85.55"></a><span id="l85.55" class="difflineminus">-    return isAPropertyOf(o,id);</span>
<a href="#l85.56"></a><span id="l85.56" class="difflineplus">+NS_IMETHODIMP_(VObject *)</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineplus">+nsMsgVCardService::IsAPropertyOf(VObject *o, const char *id) {</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineplus">+  return isAPropertyOf(o, id);</span>
<a href="#l85.59"></a><span id="l85.59"> }</span>
<a href="#l85.60"></a><span id="l85.60"> </span>
<a href="#l85.61"></a><span id="l85.61" class="difflineminus">-NS_IMETHODIMP_(char *) nsMsgVCardService::WriteMemoryVObjects(const char *s, int32_t *len, VObject * list, bool expandSpaces)</span>
<a href="#l85.62"></a><span id="l85.62" class="difflineminus">-{</span>
<a href="#l85.63"></a><span id="l85.63" class="difflineminus">-    return writeMemoryVObjects((char *)s, len, list, expandSpaces);</span>
<a href="#l85.64"></a><span id="l85.64" class="difflineplus">+NS_IMETHODIMP_(char *)</span>
<a href="#l85.65"></a><span id="l85.65" class="difflineplus">+nsMsgVCardService::WriteMemoryVObjects(const char *s, int32_t *len,</span>
<a href="#l85.66"></a><span id="l85.66" class="difflineplus">+                                       VObject *list, bool expandSpaces) {</span>
<a href="#l85.67"></a><span id="l85.67" class="difflineplus">+  return writeMemoryVObjects((char *)s, len, list, expandSpaces);</span>
<a href="#l85.68"></a><span id="l85.68"> }</span>
<a href="#l85.69"></a><span id="l85.69"> </span>
<a href="#l85.70"></a><span id="l85.70" class="difflineminus">-NS_IMETHODIMP_(VObject *) nsMsgVCardService::NextVObject(VObjectIterator * i)</span>
<a href="#l85.71"></a><span id="l85.71" class="difflineminus">-{</span>
<a href="#l85.72"></a><span id="l85.72" class="difflineminus">-    return nextVObject(i);</span>
<a href="#l85.73"></a><span id="l85.73" class="difflineminus">-}</span>
<a href="#l85.74"></a><span id="l85.74" class="difflineminus">-</span>
<a href="#l85.75"></a><span id="l85.75" class="difflineminus">-NS_IMETHODIMP_(void) nsMsgVCardService::InitPropIterator(VObjectIterator * i, VObject * o)</span>
<a href="#l85.76"></a><span id="l85.76" class="difflineminus">-{</span>
<a href="#l85.77"></a><span id="l85.77" class="difflineminus">-    initPropIterator(i,o);</span>
<a href="#l85.78"></a><span id="l85.78" class="difflineplus">+NS_IMETHODIMP_(VObject *) nsMsgVCardService::NextVObject(VObjectIterator *i) {</span>
<a href="#l85.79"></a><span id="l85.79" class="difflineplus">+  return nextVObject(i);</span>
<a href="#l85.80"></a><span id="l85.80"> }</span>
<a href="#l85.81"></a><span id="l85.81"> </span>
<a href="#l85.82"></a><span id="l85.82" class="difflineminus">-NS_IMETHODIMP_(int32_t) nsMsgVCardService::MoreIteration(VObjectIterator * i)</span>
<a href="#l85.83"></a><span id="l85.83" class="difflineminus">-{</span>
<a href="#l85.84"></a><span id="l85.84" class="difflineminus">-    return ((int32_t)moreIteration(i));</span>
<a href="#l85.85"></a><span id="l85.85" class="difflineplus">+NS_IMETHODIMP_(void)</span>
<a href="#l85.86"></a><span id="l85.86" class="difflineplus">+nsMsgVCardService::InitPropIterator(VObjectIterator *i, VObject *o) {</span>
<a href="#l85.87"></a><span id="l85.87" class="difflineplus">+  initPropIterator(i, o);</span>
<a href="#l85.88"></a><span id="l85.88" class="difflineplus">+}</span>
<a href="#l85.89"></a><span id="l85.89" class="difflineplus">+</span>
<a href="#l85.90"></a><span id="l85.90" class="difflineplus">+NS_IMETHODIMP_(int32_t) nsMsgVCardService::MoreIteration(VObjectIterator *i) {</span>
<a href="#l85.91"></a><span id="l85.91" class="difflineplus">+  return ((int32_t)moreIteration(i));</span>
<a href="#l85.92"></a><span id="l85.92"> }</span>
<a href="#l85.93"></a><span id="l85.93"> </span>
<a href="#l85.94"></a><span id="l85.94" class="difflineminus">-NS_IMETHODIMP_(const char *) nsMsgVCardService::VObjectName(VObject * o)</span>
<a href="#l85.95"></a><span id="l85.95" class="difflineminus">-{</span>
<a href="#l85.96"></a><span id="l85.96" class="difflineminus">-    return vObjectName(o);</span>
<a href="#l85.97"></a><span id="l85.97" class="difflineplus">+NS_IMETHODIMP_(const char *) nsMsgVCardService::VObjectName(VObject *o) {</span>
<a href="#l85.98"></a><span id="l85.98" class="difflineplus">+  return vObjectName(o);</span>
<a href="#l85.99"></a><span id="l85.99"> }</span>
<a href="#l85.100"></a><span id="l85.100"> </span>
<a href="#l85.101"></a><span id="l85.101" class="difflineminus">-NS_IMETHODIMP_(char *) nsMsgVCardService::VObjectAnyValue(VObject * o)</span>
<a href="#l85.102"></a><span id="l85.102" class="difflineminus">-{</span>
<a href="#l85.103"></a><span id="l85.103" class="difflineminus">-    char *retval = (char *)PR_MALLOC(strlen((char *)vObjectAnyValue(o)) + 1);</span>
<a href="#l85.104"></a><span id="l85.104" class="difflineminus">-    if (retval)</span>
<a href="#l85.105"></a><span id="l85.105" class="difflineminus">-        PL_strcpy(retval, (char *) vObjectAnyValue(o));</span>
<a href="#l85.106"></a><span id="l85.106" class="difflineminus">-    return retval;</span>
<a href="#l85.107"></a><span id="l85.107" class="difflineplus">+NS_IMETHODIMP_(char *) nsMsgVCardService::VObjectAnyValue(VObject *o) {</span>
<a href="#l85.108"></a><span id="l85.108" class="difflineplus">+  char *retval = (char *)PR_MALLOC(strlen((char *)vObjectAnyValue(o)) + 1);</span>
<a href="#l85.109"></a><span id="l85.109" class="difflineplus">+  if (retval) PL_strcpy(retval, (char *)vObjectAnyValue(o));</span>
<a href="#l85.110"></a><span id="l85.110" class="difflineplus">+  return retval;</span>
<a href="#l85.111"></a><span id="l85.111"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMsgVCardService.h</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMsgVCardService.h</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -4,21 +4,20 @@</span>
<a href="#l86.4"></a><span id="l86.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l86.5"></a><span id="l86.5"> </span>
<a href="#l86.6"></a><span id="l86.6"> #ifndef nsMsgVCardService_h___</span>
<a href="#l86.7"></a><span id="l86.7"> #define nsMsgVCardService_h___</span>
<a href="#l86.8"></a><span id="l86.8"> </span>
<a href="#l86.9"></a><span id="l86.9"> #include &quot;nsIMsgVCardService.h&quot;</span>
<a href="#l86.10"></a><span id="l86.10"> #include &quot;nsISupports.h&quot;</span>
<a href="#l86.11"></a><span id="l86.11"> </span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-class nsMsgVCardService : public nsIMsgVCardService</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-{</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineminus">-public:</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineplus">+class nsMsgVCardService : public nsIMsgVCardService {</span>
<a href="#l86.16"></a><span id="l86.16" class="difflineplus">+ public:</span>
<a href="#l86.17"></a><span id="l86.17">   NS_DECL_ISUPPORTS</span>
<a href="#l86.18"></a><span id="l86.18">   NS_DECL_NSIMSGVCARDSERVICE</span>
<a href="#l86.19"></a><span id="l86.19"> </span>
<a href="#l86.20"></a><span id="l86.20">   nsMsgVCardService();</span>
<a href="#l86.21"></a><span id="l86.21"> </span>
<a href="#l86.22"></a><span id="l86.22" class="difflineminus">-private:</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineplus">+ private:</span>
<a href="#l86.24"></a><span id="l86.24">   virtual ~nsMsgVCardService();</span>
<a href="#l86.25"></a><span id="l86.25"> };</span>
<a href="#l86.26"></a><span id="l86.26"> </span>
<a href="#l86.27"></a><span id="l86.27"> #endif /* nsMsgVCardService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/mailnews/addrbook/src/nsVCard.cpp</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsVCard.cpp</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -70,17 +70,17 @@ DFARS 252.227-7013 or 48 CFR 52.227-19, </span>
<a href="#l87.4"></a><span id="l87.4"> char yysccsid[] = &quot;@(#)yaccpar  1.4 (Berkeley) 02/25/90&quot;;</span>
<a href="#l87.5"></a><span id="l87.5"> #endif</span>
<a href="#l87.6"></a><span id="l87.6"> /*#line 2 &quot;vcc.y&quot; */</span>
<a href="#l87.7"></a><span id="l87.7"> </span>
<a href="#l87.8"></a><span id="l87.8"> /* debugging utilities */</span>
<a href="#l87.9"></a><span id="l87.9"> #define DBG_(x)</span>
<a href="#l87.10"></a><span id="l87.10"> </span>
<a href="#l87.11"></a><span id="l87.11"> #ifndef _NO_LINE_FOLDING</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-#define _SUPPORT_LINE_FOLDING</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+#  define _SUPPORT_LINE_FOLDING</span>
<a href="#l87.14"></a><span id="l87.14"> #endif</span>
<a href="#l87.15"></a><span id="l87.15"> </span>
<a href="#l87.16"></a><span id="l87.16"> /****  External Functions  ****/</span>
<a href="#l87.17"></a><span id="l87.17"> </span>
<a href="#l87.18"></a><span id="l87.18"> /* assign local name to parser variables and functions so that</span>
<a href="#l87.19"></a><span id="l87.19">  * we can use more than one yacc based parser.</span>
<a href="#l87.20"></a><span id="l87.20">  */</span>
<a href="#l87.21"></a><span id="l87.21"> </span>
<a href="#l87.22"></a><span id="l87.22" class="difflineat">@@ -113,45 +113,45 @@ char yysccsid[] = &quot;@(#)yaccpar  1.4 (Ber</span>
<a href="#l87.23"></a><span id="l87.23"> #define yyname mime_name</span>
<a href="#l87.24"></a><span id="l87.24"> #define yyrule mime_rule</span>
<a href="#l87.25"></a><span id="l87.25"> #define YYPREFIX &quot;mime_&quot;</span>
<a href="#l87.26"></a><span id="l87.26"> </span>
<a href="#l87.27"></a><span id="l87.27"> #include &quot;prmem.h&quot;</span>
<a href="#l87.28"></a><span id="l87.28"> #include &quot;plstr.h&quot;</span>
<a href="#l87.29"></a><span id="l87.29"> </span>
<a href="#l87.30"></a><span id="l87.30"> #ifndef FALSE</span>
<a href="#l87.31"></a><span id="l87.31" class="difflineminus">-#define FALSE 0</span>
<a href="#l87.32"></a><span id="l87.32" class="difflineplus">+#  define FALSE 0</span>
<a href="#l87.33"></a><span id="l87.33"> #endif</span>
<a href="#l87.34"></a><span id="l87.34"> #ifndef TRUE</span>
<a href="#l87.35"></a><span id="l87.35" class="difflineminus">-#define TRUE 1</span>
<a href="#l87.36"></a><span id="l87.36" class="difflineplus">+#  define TRUE 1</span>
<a href="#l87.37"></a><span id="l87.37"> #endif</span>
<a href="#l87.38"></a><span id="l87.38"> </span>
<a href="#l87.39"></a><span id="l87.39"> /****  Types, Constants  ****/</span>
<a href="#l87.40"></a><span id="l87.40"> </span>
<a href="#l87.41"></a><span id="l87.41" class="difflineminus">-#define YYDEBUG       0  /* 1 to compile in some debugging code */</span>
<a href="#l87.42"></a><span id="l87.42" class="difflineminus">-#define PR_MAXTOKEN 256  /* maximum token (line) length */</span>
<a href="#l87.43"></a><span id="l87.43" class="difflineminus">-#define YYSTACKSIZE  50  /* ~unref ?*/</span>
<a href="#l87.44"></a><span id="l87.44" class="difflineminus">-#define PR_MAXLEVEL  10  /* max # of nested objects parseable */</span>
<a href="#l87.45"></a><span id="l87.45" class="difflineminus">-                         /* (includes outermost) */</span>
<a href="#l87.46"></a><span id="l87.46" class="difflineplus">+#define YYDEBUG 0       /* 1 to compile in some debugging code */</span>
<a href="#l87.47"></a><span id="l87.47" class="difflineplus">+#define PR_MAXTOKEN 256 /* maximum token (line) length */</span>
<a href="#l87.48"></a><span id="l87.48" class="difflineplus">+#define YYSTACKSIZE 50  /* ~unref ?*/</span>
<a href="#l87.49"></a><span id="l87.49" class="difflineplus">+#define PR_MAXLEVEL 10  /* max # of nested objects parseable */</span>
<a href="#l87.50"></a><span id="l87.50" class="difflineplus">+                        /* (includes outermost) */</span>
<a href="#l87.51"></a><span id="l87.51"> </span>
<a href="#l87.52"></a><span id="l87.52"> /****  Global Variables  ****/</span>
<a href="#l87.53"></a><span id="l87.53"> int mime_lineNum, mime_numErrors; /* yyerror() can use these */</span>
<a href="#l87.54"></a><span id="l87.54" class="difflineminus">-static VObject* vObjList;</span>
<a href="#l87.55"></a><span id="l87.55" class="difflineplus">+static VObject *vObjList;</span>
<a href="#l87.56"></a><span id="l87.56"> static VObject *curProp;</span>
<a href="#l87.57"></a><span id="l87.57"> static VObject *curObj;</span>
<a href="#l87.58"></a><span id="l87.58" class="difflineminus">-static VObject* ObjStack[PR_MAXLEVEL];</span>
<a href="#l87.59"></a><span id="l87.59" class="difflineplus">+static VObject *ObjStack[PR_MAXLEVEL];</span>
<a href="#l87.60"></a><span id="l87.60"> static int ObjStackTop;</span>
<a href="#l87.61"></a><span id="l87.61"> </span>
<a href="#l87.62"></a><span id="l87.62"> /* A helpful utility for the rest of the app. */</span>
<a href="#l87.63"></a><span id="l87.63"> #ifdef __cplusplus</span>
<a href="#l87.64"></a><span id="l87.64"> extern &quot;C&quot; {</span>
<a href="#l87.65"></a><span id="l87.65"> #endif</span>
<a href="#l87.66"></a><span id="l87.66"> </span>
<a href="#l87.67"></a><span id="l87.67" class="difflineminus">-  extern void yyerror(const char *s);</span>
<a href="#l87.68"></a><span id="l87.68" class="difflineminus">-  extern char** fieldedProp;</span>
<a href="#l87.69"></a><span id="l87.69" class="difflineplus">+extern void yyerror(const char *s);</span>
<a href="#l87.70"></a><span id="l87.70" class="difflineplus">+extern char **fieldedProp;</span>
<a href="#l87.71"></a><span id="l87.71"> </span>
<a href="#l87.72"></a><span id="l87.72"> #ifdef __cplusplus</span>
<a href="#l87.73"></a><span id="l87.73"> }</span>
<a href="#l87.74"></a><span id="l87.74"> #endif</span>
<a href="#l87.75"></a><span id="l87.75"> </span>
<a href="#l87.76"></a><span id="l87.76"> int yyparse();</span>
<a href="#l87.77"></a><span id="l87.77"> </span>
<a href="#l87.78"></a><span id="l87.78"> enum LexMode {</span>
<a href="#l87.79"></a><span id="l87.79" class="difflineat">@@ -162,32 +162,32 @@ enum LexMode {</span>
<a href="#l87.80"></a><span id="l87.80">   L_VTODO,</span>
<a href="#l87.81"></a><span id="l87.81">   L_VALUES,</span>
<a href="#l87.82"></a><span id="l87.82">   L_BASE64,</span>
<a href="#l87.83"></a><span id="l87.83">   L_QUOTED_PRINTABLE</span>
<a href="#l87.84"></a><span id="l87.84"> };</span>
<a href="#l87.85"></a><span id="l87.85"> </span>
<a href="#l87.86"></a><span id="l87.86"> /****  Private Forward Declarations  ****/</span>
<a href="#l87.87"></a><span id="l87.87"> static int pushVObject(const char *prop);</span>
<a href="#l87.88"></a><span id="l87.88" class="difflineminus">-static VObject* popVObject();</span>
<a href="#l87.89"></a><span id="l87.89" class="difflineplus">+static VObject *popVObject();</span>
<a href="#l87.90"></a><span id="l87.90"> static int lexGeta();</span>
<a href="#l87.91"></a><span id="l87.91"> static int lexGetc_();</span>
<a href="#l87.92"></a><span id="l87.92"> static int lexGetc();</span>
<a href="#l87.93"></a><span id="l87.93"> static void lexSkipLookahead();</span>
<a href="#l87.94"></a><span id="l87.94"> static int lexLookahead();</span>
<a href="#l87.95"></a><span id="l87.95"> static void lexSkipWhite();</span>
<a href="#l87.96"></a><span id="l87.96"> static void lexClearToken();</span>
<a href="#l87.97"></a><span id="l87.97" class="difflineminus">-static char * lexStr();</span>
<a href="#l87.98"></a><span id="l87.98" class="difflineminus">-static char * lexGetDataFromBase64();</span>
<a href="#l87.99"></a><span id="l87.99" class="difflineminus">-static char * lexGetQuotedPrintable();</span>
<a href="#l87.100"></a><span id="l87.100" class="difflineminus">-static char * lexGet1Value();</span>
<a href="#l87.101"></a><span id="l87.101" class="difflineminus">-static char * lexGetWord();</span>
<a href="#l87.102"></a><span id="l87.102" class="difflineplus">+static char *lexStr();</span>
<a href="#l87.103"></a><span id="l87.103" class="difflineplus">+static char *lexGetDataFromBase64();</span>
<a href="#l87.104"></a><span id="l87.104" class="difflineplus">+static char *lexGetQuotedPrintable();</span>
<a href="#l87.105"></a><span id="l87.105" class="difflineplus">+static char *lexGet1Value();</span>
<a href="#l87.106"></a><span id="l87.106" class="difflineplus">+static char *lexGetWord();</span>
<a href="#l87.107"></a><span id="l87.107"> static void finiLex();</span>
<a href="#l87.108"></a><span id="l87.108"> </span>
<a href="#l87.109"></a><span id="l87.109" class="difflineminus">-static VObject* parse_MIMEHelper();</span>
<a href="#l87.110"></a><span id="l87.110" class="difflineplus">+static VObject *parse_MIMEHelper();</span>
<a href="#l87.111"></a><span id="l87.111"> </span>
<a href="#l87.112"></a><span id="l87.112"> /*static char* lexDataFromBase64();*/</span>
<a href="#l87.113"></a><span id="l87.113"> static void lexPopMode(int top);</span>
<a href="#l87.114"></a><span id="l87.114"> static int lexWithinMode(enum LexMode mode);</span>
<a href="#l87.115"></a><span id="l87.115"> static void lexPushMode(enum LexMode mode);</span>
<a href="#l87.116"></a><span id="l87.116"> static void enterProps(const char *s);</span>
<a href="#l87.117"></a><span id="l87.117"> static void enterAttr(const char *s1, const char *s2);</span>
<a href="#l87.118"></a><span id="l87.118"> static void enterValues(const char *value);</span>
<a href="#l87.119"></a><span id="l87.119" class="difflineat">@@ -212,16 +212,18 @@ typedef union {</span>
<a href="#l87.120"></a><span id="l87.120"> #define END_VCAL 268</span>
<a href="#l87.121"></a><span id="l87.121"> #define BEGIN_VEVENT 269</span>
<a href="#l87.122"></a><span id="l87.122"> #define END_VEVENT 270</span>
<a href="#l87.123"></a><span id="l87.123"> #define BEGIN_VTODO 271</span>
<a href="#l87.124"></a><span id="l87.124"> #define END_VTODO 272</span>
<a href="#l87.125"></a><span id="l87.125"> #define ID 273</span>
<a href="#l87.126"></a><span id="l87.126"> #define STRING 274</span>
<a href="#l87.127"></a><span id="l87.127"> #define YYERRCODE 256</span>
<a href="#l87.128"></a><span id="l87.128" class="difflineplus">+</span>
<a href="#l87.129"></a><span id="l87.129" class="difflineplus">+// clang-format off</span>
<a href="#l87.130"></a><span id="l87.130"> short yylhs[] = {                                        -1,</span>
<a href="#l87.131"></a><span id="l87.131">     0,    7,    6,    6,    5,    5,    9,    3,   10,    3,</span>
<a href="#l87.132"></a><span id="l87.132">     8,    8,   14,   11,   11,   16,   12,   12,   15,   15,</span>
<a href="#l87.133"></a><span id="l87.133">    17,   18,   18,    1,   19,   13,   13,    2,    2,   21,</span>
<a href="#l87.134"></a><span id="l87.134">     4,   22,    4,   20,   20,   23,   23,   23,   26,   24,</span>
<a href="#l87.135"></a><span id="l87.135">    27,   24,   28,   25,   29,   25,</span>
<a href="#l87.136"></a><span id="l87.136"> };</span>
<a href="#l87.137"></a><span id="l87.137"> short yylen[] = {                                         2,</span>
<a href="#l87.138"></a><span id="l87.138" class="difflineat">@@ -386,114 +388,109 @@ char *yyrule[] = {</span>
<a href="#l87.139"></a><span id="l87.139">   &quot;$$10 :&quot;,</span>
<a href="#l87.140"></a><span id="l87.140">   &quot;eventitem : BEGIN_VEVENT $$10 END_VEVENT&quot;,</span>
<a href="#l87.141"></a><span id="l87.141">   &quot;$$11 :&quot;,</span>
<a href="#l87.142"></a><span id="l87.142">   &quot;todoitem : BEGIN_VTODO $$11 items END_VTODO&quot;,</span>
<a href="#l87.143"></a><span id="l87.143">   &quot;$$12 :&quot;,</span>
<a href="#l87.144"></a><span id="l87.144">   &quot;todoitem : BEGIN_VTODO $$12 END_VTODO&quot;,</span>
<a href="#l87.145"></a><span id="l87.145"> };</span>
<a href="#l87.146"></a><span id="l87.146"> #endif</span>
<a href="#l87.147"></a><span id="l87.147" class="difflineminus">-#define yyclearin (yychar=(-1))</span>
<a href="#l87.148"></a><span id="l87.148" class="difflineminus">-#define yyerrok (yyerrflag=0)</span>
<a href="#l87.149"></a><span id="l87.149" class="difflineplus">+// clang-format on</span>
<a href="#l87.150"></a><span id="l87.150" class="difflineplus">+</span>
<a href="#l87.151"></a><span id="l87.151" class="difflineplus">+#define yyclearin (yychar = (-1))</span>
<a href="#l87.152"></a><span id="l87.152" class="difflineplus">+#define yyerrok (yyerrflag = 0)</span>
<a href="#l87.153"></a><span id="l87.153"> #ifndef YYSTACKSIZE</span>
<a href="#l87.154"></a><span id="l87.154" class="difflineminus">-#ifdef YYPR_MAXDEPTH</span>
<a href="#l87.155"></a><span id="l87.155" class="difflineminus">-#define YYSTACKSIZE YYPR_MAXDEPTH</span>
<a href="#l87.156"></a><span id="l87.156" class="difflineminus">-#else</span>
<a href="#l87.157"></a><span id="l87.157" class="difflineminus">-#define YYSTACKSIZE 300</span>
<a href="#l87.158"></a><span id="l87.158" class="difflineminus">-#endif</span>
<a href="#l87.159"></a><span id="l87.159" class="difflineplus">+#  ifdef YYPR_MAXDEPTH</span>
<a href="#l87.160"></a><span id="l87.160" class="difflineplus">+#    define YYSTACKSIZE YYPR_MAXDEPTH</span>
<a href="#l87.161"></a><span id="l87.161" class="difflineplus">+#  else</span>
<a href="#l87.162"></a><span id="l87.162" class="difflineplus">+#    define YYSTACKSIZE 300</span>
<a href="#l87.163"></a><span id="l87.163" class="difflineplus">+#  endif</span>
<a href="#l87.164"></a><span id="l87.164"> #endif</span>
<a href="#l87.165"></a><span id="l87.165"> int yydebug;</span>
<a href="#l87.166"></a><span id="l87.166"> int yynerrs;</span>
<a href="#l87.167"></a><span id="l87.167"> int yyerrflag;</span>
<a href="#l87.168"></a><span id="l87.168"> int yychar;</span>
<a href="#l87.169"></a><span id="l87.169"> short *yyssp;</span>
<a href="#l87.170"></a><span id="l87.170"> YYSTYPE *yyvsp;</span>
<a href="#l87.171"></a><span id="l87.171"> YYSTYPE yyval;</span>
<a href="#l87.172"></a><span id="l87.172"> YYSTYPE yylval;</span>
<a href="#l87.173"></a><span id="l87.173"> #define yystacksize YYSTACKSIZE</span>
<a href="#l87.174"></a><span id="l87.174"> short yyss[YYSTACKSIZE];</span>
<a href="#l87.175"></a><span id="l87.175"> YYSTYPE yyvs[YYSTACKSIZE];</span>
<a href="#l87.176"></a><span id="l87.176"> /*#line 444 &quot;vcc.y&quot;*/</span>
<a href="#l87.177"></a><span id="l87.177"> /******************************************************************************/</span>
<a href="#l87.178"></a><span id="l87.178" class="difflineminus">-static int pushVObject(const char *prop)</span>
<a href="#l87.179"></a><span id="l87.179" class="difflineminus">-{</span>
<a href="#l87.180"></a><span id="l87.180" class="difflineplus">+static int pushVObject(const char *prop) {</span>
<a href="#l87.181"></a><span id="l87.181">   VObject *newObj;</span>
<a href="#l87.182"></a><span id="l87.182" class="difflineminus">-  if (ObjStackTop == PR_MAXLEVEL)</span>
<a href="#l87.183"></a><span id="l87.183" class="difflineminus">-  return FALSE;</span>
<a href="#l87.184"></a><span id="l87.184" class="difflineplus">+  if (ObjStackTop == PR_MAXLEVEL) return FALSE;</span>
<a href="#l87.185"></a><span id="l87.185"> </span>
<a href="#l87.186"></a><span id="l87.186">   ObjStack[++ObjStackTop] = curObj;</span>
<a href="#l87.187"></a><span id="l87.187"> </span>
<a href="#l87.188"></a><span id="l87.188">   if (curObj) {</span>
<a href="#l87.189"></a><span id="l87.189" class="difflineminus">-    newObj = addProp(curObj,prop);</span>
<a href="#l87.190"></a><span id="l87.190" class="difflineplus">+    newObj = addProp(curObj, prop);</span>
<a href="#l87.191"></a><span id="l87.191">     curObj = newObj;</span>
<a href="#l87.192"></a><span id="l87.192" class="difflineminus">-  }</span>
<a href="#l87.193"></a><span id="l87.193" class="difflineminus">-  else</span>
<a href="#l87.194"></a><span id="l87.194" class="difflineplus">+  } else</span>
<a href="#l87.195"></a><span id="l87.195">     curObj = newVObject(prop);</span>
<a href="#l87.196"></a><span id="l87.196"> </span>
<a href="#l87.197"></a><span id="l87.197">   return TRUE;</span>
<a href="#l87.198"></a><span id="l87.198"> }</span>
<a href="#l87.199"></a><span id="l87.199"> </span>
<a href="#l87.200"></a><span id="l87.200"> /******************************************************************************/</span>
<a href="#l87.201"></a><span id="l87.201"> /* This pops the recently built vCard off the stack and returns it. */</span>
<a href="#l87.202"></a><span id="l87.202" class="difflineminus">-static VObject* popVObject()</span>
<a href="#l87.203"></a><span id="l87.203" class="difflineminus">-{</span>
<a href="#l87.204"></a><span id="l87.204" class="difflineplus">+static VObject *popVObject() {</span>
<a href="#l87.205"></a><span id="l87.205">   VObject *oldObj;</span>
<a href="#l87.206"></a><span id="l87.206">   if (ObjStackTop &lt; 0) {</span>
<a href="#l87.207"></a><span id="l87.207">     yyerror(&quot;pop on empty Object Stack\n&quot;);</span>
<a href="#l87.208"></a><span id="l87.208">     return 0;</span>
<a href="#l87.209"></a><span id="l87.209">   }</span>
<a href="#l87.210"></a><span id="l87.210">   oldObj = curObj;</span>
<a href="#l87.211"></a><span id="l87.211">   curObj = ObjStack[ObjStackTop--];</span>
<a href="#l87.212"></a><span id="l87.212"> </span>
<a href="#l87.213"></a><span id="l87.213">   return oldObj;</span>
<a href="#l87.214"></a><span id="l87.214"> }</span>
<a href="#l87.215"></a><span id="l87.215"> </span>
<a href="#l87.216"></a><span id="l87.216" class="difflineminus">-extern &quot;C&quot; void      deleteString(char *p);</span>
<a href="#l87.217"></a><span id="l87.217" class="difflineplus">+extern &quot;C&quot; void deleteString(char *p);</span>
<a href="#l87.218"></a><span id="l87.218"> </span>
<a href="#l87.219"></a><span id="l87.219" class="difflineminus">-static void enterValues(const char *value)</span>
<a href="#l87.220"></a><span id="l87.220" class="difflineminus">-{</span>
<a href="#l87.221"></a><span id="l87.221" class="difflineplus">+static void enterValues(const char *value) {</span>
<a href="#l87.222"></a><span id="l87.222">   if (fieldedProp &amp;&amp; *fieldedProp) {</span>
<a href="#l87.223"></a><span id="l87.223">     if (value) {</span>
<a href="#l87.224"></a><span id="l87.224" class="difflineminus">-      addPropValue(curProp,*fieldedProp,value);</span>
<a href="#l87.225"></a><span id="l87.225" class="difflineplus">+      addPropValue(curProp, *fieldedProp, value);</span>
<a href="#l87.226"></a><span id="l87.226">     }</span>
<a href="#l87.227"></a><span id="l87.227">     /* else this field is empty, advance to next field */</span>
<a href="#l87.228"></a><span id="l87.228">     fieldedProp++;</span>
<a href="#l87.229"></a><span id="l87.229" class="difflineminus">-  }</span>
<a href="#l87.230"></a><span id="l87.230" class="difflineminus">-  else {</span>
<a href="#l87.231"></a><span id="l87.231" class="difflineplus">+  } else {</span>
<a href="#l87.232"></a><span id="l87.232">     if (value) {</span>
<a href="#l87.233"></a><span id="l87.233" class="difflineminus">-      setVObjectUStringZValue_(curProp,fakeUnicode(value,0));</span>
<a href="#l87.234"></a><span id="l87.234" class="difflineplus">+      setVObjectUStringZValue_(curProp, fakeUnicode(value, 0));</span>
<a href="#l87.235"></a><span id="l87.235">     }</span>
<a href="#l87.236"></a><span id="l87.236">   }</span>
<a href="#l87.237"></a><span id="l87.237">   deleteString((char *)value);</span>
<a href="#l87.238"></a><span id="l87.238"> }</span>
<a href="#l87.239"></a><span id="l87.239"> </span>
<a href="#l87.240"></a><span id="l87.240" class="difflineminus">-static void enterProps(const char *s)</span>
<a href="#l87.241"></a><span id="l87.241" class="difflineminus">-{</span>
<a href="#l87.242"></a><span id="l87.242" class="difflineminus">-  curProp = addGroup(curObj,s);</span>
<a href="#l87.243"></a><span id="l87.243" class="difflineplus">+static void enterProps(const char *s) {</span>
<a href="#l87.244"></a><span id="l87.244" class="difflineplus">+  curProp = addGroup(curObj, s);</span>
<a href="#l87.245"></a><span id="l87.245">   deleteString((char *)s);</span>
<a href="#l87.246"></a><span id="l87.246"> }</span>
<a href="#l87.247"></a><span id="l87.247"> </span>
<a href="#l87.248"></a><span id="l87.248" class="difflineminus">-static void enterAttr(const char *s1, const char *s2)</span>
<a href="#l87.249"></a><span id="l87.249" class="difflineminus">-{</span>
<a href="#l87.250"></a><span id="l87.250" class="difflineplus">+static void enterAttr(const char *s1, const char *s2) {</span>
<a href="#l87.251"></a><span id="l87.251">   const char *p1, *p2 = nullptr;</span>
<a href="#l87.252"></a><span id="l87.252">   p1 = lookupProp_(s1);</span>
<a href="#l87.253"></a><span id="l87.253">   if (s2) {</span>
<a href="#l87.254"></a><span id="l87.254">     VObject *a;</span>
<a href="#l87.255"></a><span id="l87.255">     p2 = lookupProp_(s2);</span>
<a href="#l87.256"></a><span id="l87.256" class="difflineminus">-    a = addProp(curProp,p1);</span>
<a href="#l87.257"></a><span id="l87.257" class="difflineminus">-    setVObjectStringZValue(a,p2);</span>
<a href="#l87.258"></a><span id="l87.258" class="difflineminus">-  }</span>
<a href="#l87.259"></a><span id="l87.259" class="difflineminus">-  else</span>
<a href="#l87.260"></a><span id="l87.260" class="difflineminus">-    addProp(curProp,p1);</span>
<a href="#l87.261"></a><span id="l87.261" class="difflineminus">-  if (PL_strcasecmp(p1,VCBase64Prop) == 0 || (s2 &amp;&amp; PL_strcasecmp(p2,VCBase64Prop)==0))</span>
<a href="#l87.262"></a><span id="l87.262" class="difflineplus">+    a = addProp(curProp, p1);</span>
<a href="#l87.263"></a><span id="l87.263" class="difflineplus">+    setVObjectStringZValue(a, p2);</span>
<a href="#l87.264"></a><span id="l87.264" class="difflineplus">+  } else</span>
<a href="#l87.265"></a><span id="l87.265" class="difflineplus">+    addProp(curProp, p1);</span>
<a href="#l87.266"></a><span id="l87.266" class="difflineplus">+  if (PL_strcasecmp(p1, VCBase64Prop) == 0 ||</span>
<a href="#l87.267"></a><span id="l87.267" class="difflineplus">+      (s2 &amp;&amp; PL_strcasecmp(p2, VCBase64Prop) == 0))</span>
<a href="#l87.268"></a><span id="l87.268">     lexPushMode(L_BASE64);</span>
<a href="#l87.269"></a><span id="l87.269" class="difflineminus">-  else if (PL_strcasecmp(p1,VCQuotedPrintableProp) == 0 ||</span>
<a href="#l87.270"></a><span id="l87.270" class="difflineminus">-           (s2 &amp;&amp; PL_strcasecmp(p2,VCQuotedPrintableProp)==0))</span>
<a href="#l87.271"></a><span id="l87.271" class="difflineplus">+  else if (PL_strcasecmp(p1, VCQuotedPrintableProp) == 0 ||</span>
<a href="#l87.272"></a><span id="l87.272" class="difflineplus">+           (s2 &amp;&amp; PL_strcasecmp(p2, VCQuotedPrintableProp) == 0))</span>
<a href="#l87.273"></a><span id="l87.273">     lexPushMode(L_QUOTED_PRINTABLE);</span>
<a href="#l87.274"></a><span id="l87.274" class="difflineminus">-  deleteString((char *)s1); deleteString((char *)s2);</span>
<a href="#l87.275"></a><span id="l87.275" class="difflineplus">+  deleteString((char *)s1);</span>
<a href="#l87.276"></a><span id="l87.276" class="difflineplus">+  deleteString((char *)s2);</span>
<a href="#l87.277"></a><span id="l87.277"> }</span>
<a href="#l87.278"></a><span id="l87.278"> </span>
<a href="#l87.279"></a><span id="l87.279"> #define PR_MAX_LEX_LOOKAHEAD_0 32</span>
<a href="#l87.280"></a><span id="l87.280"> #define PR_MAX_LEX_LOOKAHEAD 64</span>
<a href="#l87.281"></a><span id="l87.281"> #define PR_MAX_LEX_MODE_STACK_SIZE 10</span>
<a href="#l87.282"></a><span id="l87.282"> #define LEXMODE() (lexBuf.lexModeStack[lexBuf.lexModeStackTop])</span>
<a href="#l87.283"></a><span id="l87.283"> </span>
<a href="#l87.284"></a><span id="l87.284"> struct LexBuf {</span>
<a href="#l87.285"></a><span id="l87.285" class="difflineat">@@ -512,152 +509,134 @@ struct LexBuf {</span>
<a href="#l87.286"></a><span id="l87.286">   unsigned long lexModeStackTop;</span>
<a href="#l87.287"></a><span id="l87.287">   enum LexMode lexModeStack[PR_MAX_LEX_MODE_STACK_SIZE];</span>
<a href="#l87.288"></a><span id="l87.288">   /* token buffer */</span>
<a href="#l87.289"></a><span id="l87.289">   unsigned long maxToken;</span>
<a href="#l87.290"></a><span id="l87.290">   char *strs;</span>
<a href="#l87.291"></a><span id="l87.291">   unsigned long strsLen;</span>
<a href="#l87.292"></a><span id="l87.292"> } lexBuf;</span>
<a href="#l87.293"></a><span id="l87.293"> </span>
<a href="#l87.294"></a><span id="l87.294" class="difflineminus">-static void lexPushMode(enum LexMode mode)</span>
<a href="#l87.295"></a><span id="l87.295" class="difflineminus">-{</span>
<a href="#l87.296"></a><span id="l87.296" class="difflineminus">-  if (lexBuf.lexModeStackTop == (PR_MAX_LEX_MODE_STACK_SIZE-1))</span>
<a href="#l87.297"></a><span id="l87.297" class="difflineplus">+static void lexPushMode(enum LexMode mode) {</span>
<a href="#l87.298"></a><span id="l87.298" class="difflineplus">+  if (lexBuf.lexModeStackTop == (PR_MAX_LEX_MODE_STACK_SIZE - 1))</span>
<a href="#l87.299"></a><span id="l87.299">     yyerror(&quot;lexical context stack overflow&quot;);</span>
<a href="#l87.300"></a><span id="l87.300">   else {</span>
<a href="#l87.301"></a><span id="l87.301">     lexBuf.lexModeStack[++lexBuf.lexModeStackTop] = mode;</span>
<a href="#l87.302"></a><span id="l87.302">   }</span>
<a href="#l87.303"></a><span id="l87.303"> }</span>
<a href="#l87.304"></a><span id="l87.304"> </span>
<a href="#l87.305"></a><span id="l87.305" class="difflineminus">-static void lexPopMode(int top)</span>
<a href="#l87.306"></a><span id="l87.306" class="difflineminus">-{</span>
<a href="#l87.307"></a><span id="l87.307" class="difflineplus">+static void lexPopMode(int top) {</span>
<a href="#l87.308"></a><span id="l87.308">   /* special case of pop for ease of error recovery -- this</span>
<a href="#l87.309"></a><span id="l87.309">   version will never underflow */</span>
<a href="#l87.310"></a><span id="l87.310">   if (top)</span>
<a href="#l87.311"></a><span id="l87.311">     lexBuf.lexModeStackTop = 0;</span>
<a href="#l87.312"></a><span id="l87.312" class="difflineminus">-  else</span>
<a href="#l87.313"></a><span id="l87.313" class="difflineminus">-    if (lexBuf.lexModeStackTop &gt; 0) lexBuf.lexModeStackTop--;</span>
<a href="#l87.314"></a><span id="l87.314" class="difflineplus">+  else if (lexBuf.lexModeStackTop &gt; 0)</span>
<a href="#l87.315"></a><span id="l87.315" class="difflineplus">+    lexBuf.lexModeStackTop--;</span>
<a href="#l87.316"></a><span id="l87.316"> }</span>
<a href="#l87.317"></a><span id="l87.317"> </span>
<a href="#l87.318"></a><span id="l87.318"> static int lexWithinMode(enum LexMode mode) {</span>
<a href="#l87.319"></a><span id="l87.319">   unsigned long i;</span>
<a href="#l87.320"></a><span id="l87.320" class="difflineminus">-  for (i=0;i&lt;lexBuf.lexModeStackTop;i++)</span>
<a href="#l87.321"></a><span id="l87.321" class="difflineplus">+  for (i = 0; i &lt; lexBuf.lexModeStackTop; i++)</span>
<a href="#l87.322"></a><span id="l87.322">     if (mode == lexBuf.lexModeStack[i]) return 1;</span>
<a href="#l87.323"></a><span id="l87.323">   return 0;</span>
<a href="#l87.324"></a><span id="l87.324"> }</span>
<a href="#l87.325"></a><span id="l87.325"> </span>
<a href="#l87.326"></a><span id="l87.326" class="difflineminus">-static int lexGetc_()</span>
<a href="#l87.327"></a><span id="l87.327" class="difflineminus">-{</span>
<a href="#l87.328"></a><span id="l87.328" class="difflineplus">+static int lexGetc_() {</span>
<a href="#l87.329"></a><span id="l87.329">   /* get next char from input, no buffering. */</span>
<a href="#l87.330"></a><span id="l87.330" class="difflineminus">-  if (lexBuf.curPos == lexBuf.inputLen)</span>
<a href="#l87.331"></a><span id="l87.331" class="difflineminus">-    return EOF;</span>
<a href="#l87.332"></a><span id="l87.332" class="difflineminus">-  if (lexBuf.inputString)</span>
<a href="#l87.333"></a><span id="l87.333" class="difflineminus">-    return *(lexBuf.inputString + lexBuf.curPos++);</span>
<a href="#l87.334"></a><span id="l87.334" class="difflineplus">+  if (lexBuf.curPos == lexBuf.inputLen) return EOF;</span>
<a href="#l87.335"></a><span id="l87.335" class="difflineplus">+  if (lexBuf.inputString) return *(lexBuf.inputString + lexBuf.curPos++);</span>
<a href="#l87.336"></a><span id="l87.336"> </span>
<a href="#l87.337"></a><span id="l87.337">   return -1;</span>
<a href="#l87.338"></a><span id="l87.338"> }</span>
<a href="#l87.339"></a><span id="l87.339"> </span>
<a href="#l87.340"></a><span id="l87.340" class="difflineminus">-static int lexGeta()</span>
<a href="#l87.341"></a><span id="l87.341" class="difflineminus">-{</span>
<a href="#l87.342"></a><span id="l87.342" class="difflineplus">+static int lexGeta() {</span>
<a href="#l87.343"></a><span id="l87.343">   ++lexBuf.len;</span>
<a href="#l87.344"></a><span id="l87.344">   return (lexBuf.buf[lexBuf.getPtr] = lexGetc_());</span>
<a href="#l87.345"></a><span id="l87.345"> }</span>
<a href="#l87.346"></a><span id="l87.346"> </span>
<a href="#l87.347"></a><span id="l87.347" class="difflineminus">-static int lexGeta_(int i)</span>
<a href="#l87.348"></a><span id="l87.348" class="difflineminus">-{</span>
<a href="#l87.349"></a><span id="l87.349" class="difflineplus">+static int lexGeta_(int i) {</span>
<a href="#l87.350"></a><span id="l87.350">   ++lexBuf.len;</span>
<a href="#l87.351"></a><span id="l87.351" class="difflineminus">-  return (lexBuf.buf[(lexBuf.getPtr+i)%PR_MAX_LEX_LOOKAHEAD] = lexGetc_());</span>
<a href="#l87.352"></a><span id="l87.352" class="difflineplus">+  return (lexBuf.buf[(lexBuf.getPtr + i) % PR_MAX_LEX_LOOKAHEAD] = lexGetc_());</span>
<a href="#l87.353"></a><span id="l87.353"> }</span>
<a href="#l87.354"></a><span id="l87.354"> </span>
<a href="#l87.355"></a><span id="l87.355"> static void lexSkipLookahead() {</span>
<a href="#l87.356"></a><span id="l87.356" class="difflineminus">-  if (lexBuf.len &gt; 0 &amp;&amp; lexBuf.buf[lexBuf.getPtr]!=EOF) {</span>
<a href="#l87.357"></a><span id="l87.357" class="difflineplus">+  if (lexBuf.len &gt; 0 &amp;&amp; lexBuf.buf[lexBuf.getPtr] != EOF) {</span>
<a href="#l87.358"></a><span id="l87.358">     /* don't skip EOF. */</span>
<a href="#l87.359"></a><span id="l87.359">     lexBuf.getPtr = (lexBuf.getPtr + 1) % PR_MAX_LEX_LOOKAHEAD;</span>
<a href="#l87.360"></a><span id="l87.360">     lexBuf.len--;</span>
<a href="#l87.361"></a><span id="l87.361">   }</span>
<a href="#l87.362"></a><span id="l87.362"> }</span>
<a href="#l87.363"></a><span id="l87.363"> </span>
<a href="#l87.364"></a><span id="l87.364"> static int lexLookahead() {</span>
<a href="#l87.365"></a><span id="l87.365" class="difflineminus">-  int c = (lexBuf.len)?</span>
<a href="#l87.366"></a><span id="l87.366" class="difflineminus">-  lexBuf.buf[lexBuf.getPtr]:</span>
<a href="#l87.367"></a><span id="l87.367" class="difflineminus">-  lexGeta();</span>
<a href="#l87.368"></a><span id="l87.368" class="difflineplus">+  int c = (lexBuf.len) ? lexBuf.buf[lexBuf.getPtr] : lexGeta();</span>
<a href="#l87.369"></a><span id="l87.369">   /* do the \r\n -&gt; \n or \r -&gt; \n translation here */</span>
<a href="#l87.370"></a><span id="l87.370">   if (c == '\r') {</span>
<a href="#l87.371"></a><span id="l87.371" class="difflineminus">-    int a = (lexBuf.len&gt;1)?</span>
<a href="#l87.372"></a><span id="l87.372" class="difflineminus">-    lexBuf.buf[(lexBuf.getPtr+1)%PR_MAX_LEX_LOOKAHEAD]:</span>
<a href="#l87.373"></a><span id="l87.373" class="difflineminus">-    lexGeta_(1);</span>
<a href="#l87.374"></a><span id="l87.374" class="difflineplus">+    int a = (lexBuf.len &gt; 1)</span>
<a href="#l87.375"></a><span id="l87.375" class="difflineplus">+                ? lexBuf.buf[(lexBuf.getPtr + 1) % PR_MAX_LEX_LOOKAHEAD]</span>
<a href="#l87.376"></a><span id="l87.376" class="difflineplus">+                : lexGeta_(1);</span>
<a href="#l87.377"></a><span id="l87.377">     if (a == '\n') {</span>
<a href="#l87.378"></a><span id="l87.378">       lexSkipLookahead();</span>
<a href="#l87.379"></a><span id="l87.379">     }</span>
<a href="#l87.380"></a><span id="l87.380">     lexBuf.buf[lexBuf.getPtr] = c = '\n';</span>
<a href="#l87.381"></a><span id="l87.381" class="difflineminus">-  }</span>
<a href="#l87.382"></a><span id="l87.382" class="difflineminus">-  else if (c == '\n') {</span>
<a href="#l87.383"></a><span id="l87.383" class="difflineminus">-    int a = (lexBuf.len&gt;1)?</span>
<a href="#l87.384"></a><span id="l87.384" class="difflineminus">-    lexBuf.buf[lexBuf.getPtr+1]:</span>
<a href="#l87.385"></a><span id="l87.385" class="difflineminus">-    lexGeta_(1);</span>
<a href="#l87.386"></a><span id="l87.386" class="difflineplus">+  } else if (c == '\n') {</span>
<a href="#l87.387"></a><span id="l87.387" class="difflineplus">+    int a = (lexBuf.len &gt; 1) ? lexBuf.buf[lexBuf.getPtr + 1] : lexGeta_(1);</span>
<a href="#l87.388"></a><span id="l87.388">     if (a == '\r') {</span>
<a href="#l87.389"></a><span id="l87.389">       lexSkipLookahead();</span>
<a href="#l87.390"></a><span id="l87.390">     }</span>
<a href="#l87.391"></a><span id="l87.391">     lexBuf.buf[lexBuf.getPtr] = '\n';</span>
<a href="#l87.392"></a><span id="l87.392">   }</span>
<a href="#l87.393"></a><span id="l87.393">   return c;</span>
<a href="#l87.394"></a><span id="l87.394"> }</span>
<a href="#l87.395"></a><span id="l87.395"> </span>
<a href="#l87.396"></a><span id="l87.396"> static int lexGetc() {</span>
<a href="#l87.397"></a><span id="l87.397">   int c = lexLookahead();</span>
<a href="#l87.398"></a><span id="l87.398" class="difflineminus">-  if (lexBuf.len &gt; 0 &amp;&amp; lexBuf.buf[lexBuf.getPtr]!=EOF) {</span>
<a href="#l87.399"></a><span id="l87.399" class="difflineplus">+  if (lexBuf.len &gt; 0 &amp;&amp; lexBuf.buf[lexBuf.getPtr] != EOF) {</span>
<a href="#l87.400"></a><span id="l87.400">     /* EOF will remain in lookahead buffer */</span>
<a href="#l87.401"></a><span id="l87.401">     lexBuf.getPtr = (lexBuf.getPtr + 1) % PR_MAX_LEX_LOOKAHEAD;</span>
<a href="#l87.402"></a><span id="l87.402">     lexBuf.len--;</span>
<a href="#l87.403"></a><span id="l87.403">   }</span>
<a href="#l87.404"></a><span id="l87.404">   return c;</span>
<a href="#l87.405"></a><span id="l87.405"> }</span>
<a href="#l87.406"></a><span id="l87.406"> </span>
<a href="#l87.407"></a><span id="l87.407"> static void lexSkipLookaheadWord() {</span>
<a href="#l87.408"></a><span id="l87.408">   if (lexBuf.strsLen &lt;= lexBuf.len) {</span>
<a href="#l87.409"></a><span id="l87.409">     lexBuf.len -= lexBuf.strsLen;</span>
<a href="#l87.410"></a><span id="l87.410">     lexBuf.getPtr = (lexBuf.getPtr + lexBuf.strsLen) % PR_MAX_LEX_LOOKAHEAD;</span>
<a href="#l87.411"></a><span id="l87.411">   }</span>
<a href="#l87.412"></a><span id="l87.412"> }</span>
<a href="#l87.413"></a><span id="l87.413"> </span>
<a href="#l87.414"></a><span id="l87.414" class="difflineminus">-static void lexClearToken()</span>
<a href="#l87.415"></a><span id="l87.415" class="difflineminus">-{</span>
<a href="#l87.416"></a><span id="l87.416" class="difflineminus">-  lexBuf.strsLen = 0;</span>
<a href="#l87.417"></a><span id="l87.417" class="difflineminus">-}</span>
<a href="#l87.418"></a><span id="l87.418" class="difflineplus">+static void lexClearToken() { lexBuf.strsLen = 0; }</span>
<a href="#l87.419"></a><span id="l87.419"> </span>
<a href="#l87.420"></a><span id="l87.420" class="difflineminus">-static void lexAppendc(int c)</span>
<a href="#l87.421"></a><span id="l87.421" class="difflineminus">-{</span>
<a href="#l87.422"></a><span id="l87.422" class="difflineplus">+static void lexAppendc(int c) {</span>
<a href="#l87.423"></a><span id="l87.423">   lexBuf.strs[lexBuf.strsLen] = c;</span>
<a href="#l87.424"></a><span id="l87.424">   /* append up to zero termination */</span>
<a href="#l87.425"></a><span id="l87.425">   if (c == 0) return;</span>
<a href="#l87.426"></a><span id="l87.426">   lexBuf.strsLen++;</span>
<a href="#l87.427"></a><span id="l87.427">   if (lexBuf.strsLen &gt;= lexBuf.maxToken) {</span>
<a href="#l87.428"></a><span id="l87.428">     /* double the token string size */</span>
<a href="#l87.429"></a><span id="l87.429">     lexBuf.maxToken &lt;&lt;= 1;</span>
<a href="#l87.430"></a><span id="l87.430" class="difflineminus">-    lexBuf.strs = (char*) PR_Realloc(lexBuf.strs,lexBuf.maxToken);</span>
<a href="#l87.431"></a><span id="l87.431" class="difflineplus">+    lexBuf.strs = (char *)PR_Realloc(lexBuf.strs, lexBuf.maxToken);</span>
<a href="#l87.432"></a><span id="l87.432">   }</span>
<a href="#l87.433"></a><span id="l87.433"> }</span>
<a href="#l87.434"></a><span id="l87.434"> </span>
<a href="#l87.435"></a><span id="l87.435" class="difflineminus">-static char* lexStr() {</span>
<a href="#l87.436"></a><span id="l87.436" class="difflineminus">-  return dupStr(lexBuf.strs,lexBuf.strsLen+1);</span>
<a href="#l87.437"></a><span id="l87.437" class="difflineminus">-}</span>
<a href="#l87.438"></a><span id="l87.438" class="difflineplus">+static char *lexStr() { return dupStr(lexBuf.strs, lexBuf.strsLen + 1); }</span>
<a href="#l87.439"></a><span id="l87.439"> </span>
<a href="#l87.440"></a><span id="l87.440"> static void lexSkipWhite() {</span>
<a href="#l87.441"></a><span id="l87.441">   int c = lexLookahead();</span>
<a href="#l87.442"></a><span id="l87.442">   while (c == ' ' || c == '\t') {</span>
<a href="#l87.443"></a><span id="l87.443">     lexSkipLookahead();</span>
<a href="#l87.444"></a><span id="l87.444">     c = lexLookahead();</span>
<a href="#l87.445"></a><span id="l87.445">   }</span>
<a href="#l87.446"></a><span id="l87.446"> }</span>
<a href="#l87.447"></a><span id="l87.447"> </span>
<a href="#l87.448"></a><span id="l87.448" class="difflineminus">-static char* lexGetWord() {</span>
<a href="#l87.449"></a><span id="l87.449" class="difflineplus">+static char *lexGetWord() {</span>
<a href="#l87.450"></a><span id="l87.450">   int c;</span>
<a href="#l87.451"></a><span id="l87.451">   lexSkipWhite();</span>
<a href="#l87.452"></a><span id="l87.452">   lexClearToken();</span>
<a href="#l87.453"></a><span id="l87.453">   c = lexLookahead();</span>
<a href="#l87.454"></a><span id="l87.454" class="difflineminus">-  while (c != EOF &amp;&amp; !PL_strchr(&quot;\t\n ;:=&quot;,(char)c)) {</span>
<a href="#l87.455"></a><span id="l87.455" class="difflineplus">+  while (c != EOF &amp;&amp; !PL_strchr(&quot;\t\n ;:=&quot;, (char)c)) {</span>
<a href="#l87.456"></a><span id="l87.456">     lexAppendc(c);</span>
<a href="#l87.457"></a><span id="l87.457">     lexSkipLookahead();</span>
<a href="#l87.458"></a><span id="l87.458">     c = lexLookahead();</span>
<a href="#l87.459"></a><span id="l87.459">   }</span>
<a href="#l87.460"></a><span id="l87.460">   lexAppendc(0);</span>
<a href="#l87.461"></a><span id="l87.461">   return lexStr();</span>
<a href="#l87.462"></a><span id="l87.462"> }</span>
<a href="#l87.463"></a><span id="l87.463"> </span>
<a href="#l87.464"></a><span id="l87.464" class="difflineat">@@ -678,48 +657,47 @@ static void lexPushLookahead(char *s, in</span>
<a href="#l87.465"></a><span id="l87.465">   lexBuf.len += len;</span>
<a href="#l87.466"></a><span id="l87.466"> }</span>
<a href="#l87.467"></a><span id="l87.467"> #endif</span>
<a href="#l87.468"></a><span id="l87.468"> </span>
<a href="#l87.469"></a><span id="l87.469"> static void lexPushLookaheadc(int c) {</span>
<a href="#l87.470"></a><span id="l87.470">   int putptr;</span>
<a href="#l87.471"></a><span id="l87.471">   /* can't putback EOF, because it never leaves lookahead buffer */</span>
<a href="#l87.472"></a><span id="l87.472">   if (c == EOF) return;</span>
<a href="#l87.473"></a><span id="l87.473" class="difflineminus">-  putptr = (int) lexBuf.getPtr - 1;</span>
<a href="#l87.474"></a><span id="l87.474" class="difflineplus">+  putptr = (int)lexBuf.getPtr - 1;</span>
<a href="#l87.475"></a><span id="l87.475">   if (putptr &lt; 0) putptr += PR_MAX_LEX_LOOKAHEAD;</span>
<a href="#l87.476"></a><span id="l87.476">   lexBuf.getPtr = putptr;</span>
<a href="#l87.477"></a><span id="l87.477">   lexBuf.buf[putptr] = c;</span>
<a href="#l87.478"></a><span id="l87.478">   lexBuf.len += 1;</span>
<a href="#l87.479"></a><span id="l87.479"> }</span>
<a href="#l87.480"></a><span id="l87.480"> </span>
<a href="#l87.481"></a><span id="l87.481" class="difflineminus">-static char* lexLookaheadWord() {</span>
<a href="#l87.482"></a><span id="l87.482" class="difflineplus">+static char *lexLookaheadWord() {</span>
<a href="#l87.483"></a><span id="l87.483">   /* this function can lookahead word with max size of PR_MAX_LEX_LOOKAHEAD_0</span>
<a href="#l87.484"></a><span id="l87.484">    /  and thing bigger than that will stop the lookahead and return 0;</span>
<a href="#l87.485"></a><span id="l87.485">    / leading white spaces are not recoverable.</span>
<a href="#l87.486"></a><span id="l87.486">    */</span>
<a href="#l87.487"></a><span id="l87.487">   int c;</span>
<a href="#l87.488"></a><span id="l87.488">   int len = 0;</span>
<a href="#l87.489"></a><span id="l87.489">   int curgetptr = 0;</span>
<a href="#l87.490"></a><span id="l87.490">   lexSkipWhite();</span>
<a href="#l87.491"></a><span id="l87.491">   lexClearToken();</span>
<a href="#l87.492"></a><span id="l87.492" class="difflineminus">-  curgetptr = (int) lexBuf.getPtr;  /* remember! */</span>
<a href="#l87.493"></a><span id="l87.493" class="difflineplus">+  curgetptr = (int)lexBuf.getPtr; /* remember! */</span>
<a href="#l87.494"></a><span id="l87.494">   while (len &lt; (PR_MAX_LEX_LOOKAHEAD_0)) {</span>
<a href="#l87.495"></a><span id="l87.495">     c = lexGetc();</span>
<a href="#l87.496"></a><span id="l87.496">     len++;</span>
<a href="#l87.497"></a><span id="l87.497">     if (c == EOF || PL_strchr(&quot;\t\n ;:=&quot;, (char)c)) {</span>
<a href="#l87.498"></a><span id="l87.498">       lexAppendc(0);</span>
<a href="#l87.499"></a><span id="l87.499">       /* restore lookahead buf. */</span>
<a href="#l87.500"></a><span id="l87.500">       lexBuf.len += len;</span>
<a href="#l87.501"></a><span id="l87.501">       lexBuf.getPtr = curgetptr;</span>
<a href="#l87.502"></a><span id="l87.502">       return lexStr();</span>
<a href="#l87.503"></a><span id="l87.503" class="difflineminus">-    }</span>
<a href="#l87.504"></a><span id="l87.504" class="difflineminus">-    else</span>
<a href="#l87.505"></a><span id="l87.505" class="difflineplus">+    } else</span>
<a href="#l87.506"></a><span id="l87.506">       lexAppendc(c);</span>
<a href="#l87.507"></a><span id="l87.507">   }</span>
<a href="#l87.508"></a><span id="l87.508" class="difflineminus">-  lexBuf.len += len;  /* char that has been moved to lookahead buffer */</span>
<a href="#l87.509"></a><span id="l87.509" class="difflineplus">+  lexBuf.len += len; /* char that has been moved to lookahead buffer */</span>
<a href="#l87.510"></a><span id="l87.510">   lexBuf.getPtr = curgetptr;</span>
<a href="#l87.511"></a><span id="l87.511">   return 0;</span>
<a href="#l87.512"></a><span id="l87.512"> }</span>
<a href="#l87.513"></a><span id="l87.513"> </span>
<a href="#l87.514"></a><span id="l87.514"> #ifdef _SUPPORT_LINE_FOLDING</span>
<a href="#l87.515"></a><span id="l87.515"> static void handleMoreRFC822LineBreak(int c) {</span>
<a href="#l87.516"></a><span id="l87.516">   /* support RFC 822 line break in cases like</span>
<a href="#l87.517"></a><span id="l87.517">    *  ADR: foo;</span>
<a href="#l87.518"></a><span id="l87.518" class="difflineat">@@ -739,153 +717,144 @@ static void handleMoreRFC822LineBreak(in</span>
<a href="#l87.519"></a><span id="l87.519">       lexSkipLookahead();</span>
<a href="#l87.520"></a><span id="l87.520">       a = lexLookahead();</span>
<a href="#l87.521"></a><span id="l87.521">       if (a == ' ' || a == '\t') {</span>
<a href="#l87.522"></a><span id="l87.522">         /* continuation, throw away all the \n and spaces read so</span>
<a href="#l87.523"></a><span id="l87.523">          * far</span>
<a href="#l87.524"></a><span id="l87.524">          */</span>
<a href="#l87.525"></a><span id="l87.525">         lexSkipWhite();</span>
<a href="#l87.526"></a><span id="l87.526">         lexPushLookaheadc(';');</span>
<a href="#l87.527"></a><span id="l87.527" class="difflineminus">-      }</span>
<a href="#l87.528"></a><span id="l87.528" class="difflineminus">-      else {</span>
<a href="#l87.529"></a><span id="l87.529" class="difflineplus">+      } else {</span>
<a href="#l87.530"></a><span id="l87.530">         lexPushLookaheadc('\n');</span>
<a href="#l87.531"></a><span id="l87.531">         lexPushLookaheadc(';');</span>
<a href="#l87.532"></a><span id="l87.532">       }</span>
<a href="#l87.533"></a><span id="l87.533" class="difflineminus">-    }</span>
<a href="#l87.534"></a><span id="l87.534" class="difflineminus">-    else {</span>
<a href="#l87.535"></a><span id="l87.535" class="difflineplus">+    } else {</span>
<a href="#l87.536"></a><span id="l87.536">       lexPushLookaheadc(';');</span>
<a href="#l87.537"></a><span id="l87.537">     }</span>
<a href="#l87.538"></a><span id="l87.538">   }</span>
<a href="#l87.539"></a><span id="l87.539"> }</span>
<a href="#l87.540"></a><span id="l87.540"> </span>
<a href="#l87.541"></a><span id="l87.541" class="difflineminus">-static char* lexGet1Value() {</span>
<a href="#l87.542"></a><span id="l87.542" class="difflineminus">-/*  int size = 0; */</span>
<a href="#l87.543"></a><span id="l87.543" class="difflineplus">+static char *lexGet1Value() {</span>
<a href="#l87.544"></a><span id="l87.544" class="difflineplus">+  /*  int size = 0; */</span>
<a href="#l87.545"></a><span id="l87.545">   int c;</span>
<a href="#l87.546"></a><span id="l87.546">   lexSkipWhite();</span>
<a href="#l87.547"></a><span id="l87.547">   c = lexLookahead();</span>
<a href="#l87.548"></a><span id="l87.548">   lexClearToken();</span>
<a href="#l87.549"></a><span id="l87.549">   while (c != EOF &amp;&amp; c != ';') {</span>
<a href="#l87.550"></a><span id="l87.550">     if (c == '\n') {</span>
<a href="#l87.551"></a><span id="l87.551">       int a;</span>
<a href="#l87.552"></a><span id="l87.552">       lexSkipLookahead();</span>
<a href="#l87.553"></a><span id="l87.553" class="difflineminus">-      a  = lexLookahead();</span>
<a href="#l87.554"></a><span id="l87.554" class="difflineplus">+      a = lexLookahead();</span>
<a href="#l87.555"></a><span id="l87.555">       if (a == ' ' || a == '\t') {</span>
<a href="#l87.556"></a><span id="l87.556">         lexAppendc(' ');</span>
<a href="#l87.557"></a><span id="l87.557">         lexSkipLookahead();</span>
<a href="#l87.558"></a><span id="l87.558" class="difflineminus">-      }</span>
<a href="#l87.559"></a><span id="l87.559" class="difflineminus">-      else {</span>
<a href="#l87.560"></a><span id="l87.560" class="difflineplus">+      } else {</span>
<a href="#l87.561"></a><span id="l87.561">         lexPushLookaheadc('\n');</span>
<a href="#l87.562"></a><span id="l87.562">         break;</span>
<a href="#l87.563"></a><span id="l87.563">       }</span>
<a href="#l87.564"></a><span id="l87.564" class="difflineminus">-    }</span>
<a href="#l87.565"></a><span id="l87.565" class="difflineminus">-    else if (c == '\\') {</span>
<a href="#l87.566"></a><span id="l87.566" class="difflineplus">+    } else if (c == '\\') {</span>
<a href="#l87.567"></a><span id="l87.567">       int a;</span>
<a href="#l87.568"></a><span id="l87.568">       lexSkipLookahead();</span>
<a href="#l87.569"></a><span id="l87.569">       a = lexLookahead();</span>
<a href="#l87.570"></a><span id="l87.570">       if (a == '\\' || a == ',' || a == ';' || a == ':') {</span>
<a href="#l87.571"></a><span id="l87.571">         lexAppendc(a);</span>
<a href="#l87.572"></a><span id="l87.572" class="difflineminus">-      }</span>
<a href="#l87.573"></a><span id="l87.573" class="difflineminus">-      else if (a == 'n' || a == 'N') {</span>
<a href="#l87.574"></a><span id="l87.574" class="difflineplus">+      } else if (a == 'n' || a == 'N') {</span>
<a href="#l87.575"></a><span id="l87.575">         lexAppendc('\n');</span>
<a href="#l87.576"></a><span id="l87.576" class="difflineminus">-      }</span>
<a href="#l87.577"></a><span id="l87.577" class="difflineminus">-      else {</span>
<a href="#l87.578"></a><span id="l87.578" class="difflineplus">+      } else {</span>
<a href="#l87.579"></a><span id="l87.579">         lexAppendc(c);</span>
<a href="#l87.580"></a><span id="l87.580">         lexAppendc(a);</span>
<a href="#l87.581"></a><span id="l87.581">       }</span>
<a href="#l87.582"></a><span id="l87.582">       lexSkipLookahead();</span>
<a href="#l87.583"></a><span id="l87.583" class="difflineminus">-    }</span>
<a href="#l87.584"></a><span id="l87.584" class="difflineminus">-    else {</span>
<a href="#l87.585"></a><span id="l87.585" class="difflineplus">+    } else {</span>
<a href="#l87.586"></a><span id="l87.586">       lexAppendc(c);</span>
<a href="#l87.587"></a><span id="l87.587">       lexSkipLookahead();</span>
<a href="#l87.588"></a><span id="l87.588">     }</span>
<a href="#l87.589"></a><span id="l87.589">     c = lexLookahead();</span>
<a href="#l87.590"></a><span id="l87.590">   }</span>
<a href="#l87.591"></a><span id="l87.591">   lexAppendc(0);</span>
<a href="#l87.592"></a><span id="l87.592">   handleMoreRFC822LineBreak(c);</span>
<a href="#l87.593"></a><span id="l87.593" class="difflineminus">-  return c==EOF?0:lexStr();</span>
<a href="#l87.594"></a><span id="l87.594" class="difflineplus">+  return c == EOF ? 0 : lexStr();</span>
<a href="#l87.595"></a><span id="l87.595"> }</span>
<a href="#l87.596"></a><span id="l87.596"> #endif</span>
<a href="#l87.597"></a><span id="l87.597"> </span>
<a href="#l87.598"></a><span id="l87.598" class="difflineminus">-</span>
<a href="#l87.599"></a><span id="l87.599"> #ifndef _SUPPORT_LINE_FOLDING</span>
<a href="#l87.600"></a><span id="l87.600" class="difflineminus">-static char* lexGetStrUntil(char *termset) {</span>
<a href="#l87.601"></a><span id="l87.601" class="difflineplus">+static char *lexGetStrUntil(char *termset) {</span>
<a href="#l87.602"></a><span id="l87.602">   int c = lexLookahead();</span>
<a href="#l87.603"></a><span id="l87.603">   lexClearToken();</span>
<a href="#l87.604"></a><span id="l87.604" class="difflineminus">-  while (c != EOF &amp;&amp; !PL_strchr(termset,c)) {</span>
<a href="#l87.605"></a><span id="l87.605" class="difflineplus">+  while (c != EOF &amp;&amp; !PL_strchr(termset, c)) {</span>
<a href="#l87.606"></a><span id="l87.606">     lexAppendc(c);</span>
<a href="#l87.607"></a><span id="l87.607">     lexSkipLookahead();</span>
<a href="#l87.608"></a><span id="l87.608">     c = lexLookahead();</span>
<a href="#l87.609"></a><span id="l87.609">   }</span>
<a href="#l87.610"></a><span id="l87.610">   lexAppendc(0);</span>
<a href="#l87.611"></a><span id="l87.611" class="difflineminus">-  return c==EOF?0:lexStr();</span>
<a href="#l87.612"></a><span id="l87.612" class="difflineplus">+  return c == EOF ? 0 : lexStr();</span>
<a href="#l87.613"></a><span id="l87.613"> }</span>
<a href="#l87.614"></a><span id="l87.614"> #endif /* ! _SUPPORT_LINE_FOLDING */</span>
<a href="#l87.615"></a><span id="l87.615"> </span>
<a href="#l87.616"></a><span id="l87.616"> static int match_begin_name(int end) {</span>
<a href="#l87.617"></a><span id="l87.617">   char *n = lexLookaheadWord();</span>
<a href="#l87.618"></a><span id="l87.618">   int token = ID;</span>
<a href="#l87.619"></a><span id="l87.619">   if (n) {</span>
<a href="#l87.620"></a><span id="l87.620" class="difflineminus">-    if (!PL_strcasecmp(n,&quot;vcard&quot;)) token = end?END_VCARD:BEGIN_VCARD;</span>
<a href="#l87.621"></a><span id="l87.621" class="difflineminus">-    else if (!PL_strcasecmp(n,&quot;vcalendar&quot;)) token = end?END_VCAL:BEGIN_VCAL;</span>
<a href="#l87.622"></a><span id="l87.622" class="difflineminus">-    else if (!PL_strcasecmp(n,&quot;vevent&quot;)) token = end?END_VEVENT:BEGIN_VEVENT;</span>
<a href="#l87.623"></a><span id="l87.623" class="difflineminus">-    else if (!PL_strcasecmp(n,&quot;vtodo&quot;)) token = end?END_VTODO:BEGIN_VTODO;</span>
<a href="#l87.624"></a><span id="l87.624" class="difflineplus">+    if (!PL_strcasecmp(n, &quot;vcard&quot;))</span>
<a href="#l87.625"></a><span id="l87.625" class="difflineplus">+      token = end ? END_VCARD : BEGIN_VCARD;</span>
<a href="#l87.626"></a><span id="l87.626" class="difflineplus">+    else if (!PL_strcasecmp(n, &quot;vcalendar&quot;))</span>
<a href="#l87.627"></a><span id="l87.627" class="difflineplus">+      token = end ? END_VCAL : BEGIN_VCAL;</span>
<a href="#l87.628"></a><span id="l87.628" class="difflineplus">+    else if (!PL_strcasecmp(n, &quot;vevent&quot;))</span>
<a href="#l87.629"></a><span id="l87.629" class="difflineplus">+      token = end ? END_VEVENT : BEGIN_VEVENT;</span>
<a href="#l87.630"></a><span id="l87.630" class="difflineplus">+    else if (!PL_strcasecmp(n, &quot;vtodo&quot;))</span>
<a href="#l87.631"></a><span id="l87.631" class="difflineplus">+      token = end ? END_VTODO : BEGIN_VTODO;</span>
<a href="#l87.632"></a><span id="l87.632">     deleteString(n);</span>
<a href="#l87.633"></a><span id="l87.633">     return token;</span>
<a href="#l87.634"></a><span id="l87.634">   }</span>
<a href="#l87.635"></a><span id="l87.635">   return 0;</span>
<a href="#l87.636"></a><span id="l87.636"> }</span>
<a href="#l87.637"></a><span id="l87.637"> </span>
<a href="#l87.638"></a><span id="l87.638" class="difflineminus">-void initLex(const char *inputstring, unsigned long inputlen)</span>
<a href="#l87.639"></a><span id="l87.639" class="difflineminus">-{</span>
<a href="#l87.640"></a><span id="l87.640" class="difflineplus">+void initLex(const char *inputstring, unsigned long inputlen) {</span>
<a href="#l87.641"></a><span id="l87.641">   /* initialize lex mode stack */</span>
<a href="#l87.642"></a><span id="l87.642" class="difflineminus">-  lexBuf.lexModeStack[lexBuf.lexModeStackTop=0] = L_NORMAL;</span>
<a href="#l87.643"></a><span id="l87.643" class="difflineplus">+  lexBuf.lexModeStack[lexBuf.lexModeStackTop = 0] = L_NORMAL;</span>
<a href="#l87.644"></a><span id="l87.644"> </span>
<a href="#l87.645"></a><span id="l87.645">   /* iniatialize lex buffer. */</span>
<a href="#l87.646"></a><span id="l87.646" class="difflineminus">-  lexBuf.inputString = (char*) inputstring;</span>
<a href="#l87.647"></a><span id="l87.647" class="difflineplus">+  lexBuf.inputString = (char *)inputstring;</span>
<a href="#l87.648"></a><span id="l87.648">   lexBuf.inputLen = inputlen;</span>
<a href="#l87.649"></a><span id="l87.649">   lexBuf.curPos = 0;</span>
<a href="#l87.650"></a><span id="l87.650"> </span>
<a href="#l87.651"></a><span id="l87.651">   lexBuf.len = 0;</span>
<a href="#l87.652"></a><span id="l87.652">   lexBuf.getPtr = 0;</span>
<a href="#l87.653"></a><span id="l87.653"> </span>
<a href="#l87.654"></a><span id="l87.654">   lexBuf.maxToken = PR_MAXTOKEN;</span>
<a href="#l87.655"></a><span id="l87.655" class="difflineminus">-  lexBuf.strs = (char*)PR_CALLOC(PR_MAXTOKEN);</span>
<a href="#l87.656"></a><span id="l87.656" class="difflineplus">+  lexBuf.strs = (char *)PR_CALLOC(PR_MAXTOKEN);</span>
<a href="#l87.657"></a><span id="l87.657">   lexBuf.strsLen = 0;</span>
<a href="#l87.658"></a><span id="l87.658"> }</span>
<a href="#l87.659"></a><span id="l87.659"> </span>
<a href="#l87.660"></a><span id="l87.660" class="difflineminus">-static void finiLex() {</span>
<a href="#l87.661"></a><span id="l87.661" class="difflineminus">-  PR_FREEIF(lexBuf.strs);</span>
<a href="#l87.662"></a><span id="l87.662" class="difflineminus">-}</span>
<a href="#l87.663"></a><span id="l87.663" class="difflineplus">+static void finiLex() { PR_FREEIF(lexBuf.strs); }</span>
<a href="#l87.664"></a><span id="l87.664"> </span>
<a href="#l87.665"></a><span id="l87.665"> /******************************************************************************/</span>
<a href="#l87.666"></a><span id="l87.666"> /* This parses and converts the base64 format for binary encoding into</span>
<a href="#l87.667"></a><span id="l87.667">  * a decoded buffer (allocated with new).  See RFC 1521.</span>
<a href="#l87.668"></a><span id="l87.668">  */</span>
<a href="#l87.669"></a><span id="l87.669" class="difflineminus">-static char * lexGetDataFromBase64()</span>
<a href="#l87.670"></a><span id="l87.670" class="difflineminus">-{</span>
<a href="#l87.671"></a><span id="l87.671" class="difflineplus">+static char *lexGetDataFromBase64() {</span>
<a href="#l87.672"></a><span id="l87.672">   unsigned long bytesLen = 0, bytesMax = 0;</span>
<a href="#l87.673"></a><span id="l87.673">   int quadIx = 0, pad = 0;</span>
<a href="#l87.674"></a><span id="l87.674">   unsigned long trip = 0;</span>
<a href="#l87.675"></a><span id="l87.675">   unsigned char b;</span>
<a href="#l87.676"></a><span id="l87.676">   int c;</span>
<a href="#l87.677"></a><span id="l87.677">   unsigned char *bytes = nullptr;</span>
<a href="#l87.678"></a><span id="l87.678">   unsigned char *oldBytes = nullptr;</span>
<a href="#l87.679"></a><span id="l87.679"> </span>
<a href="#l87.680"></a><span id="l87.680">   DBG_((&quot;db: lexGetDataFromBase64\n&quot;));</span>
<a href="#l87.681"></a><span id="l87.681">   while (1) {</span>
<a href="#l87.682"></a><span id="l87.682">     c = lexGetc();</span>
<a href="#l87.683"></a><span id="l87.683">     if (c == '\n') {</span>
<a href="#l87.684"></a><span id="l87.684">       ++mime_lineNum;</span>
<a href="#l87.685"></a><span id="l87.685">       if (lexLookahead() == '\n') {</span>
<a href="#l87.686"></a><span id="l87.686">         /* a '\n' character by itself means end of data */</span>
<a href="#l87.687"></a><span id="l87.687">         break;</span>
<a href="#l87.688"></a><span id="l87.688" class="difflineminus">-      }</span>
<a href="#l87.689"></a><span id="l87.689" class="difflineminus">-      else continue; /* ignore '\n' */</span>
<a href="#l87.690"></a><span id="l87.690" class="difflineminus">-    }</span>
<a href="#l87.691"></a><span id="l87.691" class="difflineminus">-    else {</span>
<a href="#l87.692"></a><span id="l87.692" class="difflineplus">+      } else</span>
<a href="#l87.693"></a><span id="l87.693" class="difflineplus">+        continue; /* ignore '\n' */</span>
<a href="#l87.694"></a><span id="l87.694" class="difflineplus">+    } else {</span>
<a href="#l87.695"></a><span id="l87.695">       if ((c &gt;= 'A') &amp;&amp; (c &lt;= 'Z'))</span>
<a href="#l87.696"></a><span id="l87.696">         b = (unsigned char)(c - 'A');</span>
<a href="#l87.697"></a><span id="l87.697">       else if ((c &gt;= 'a') &amp;&amp; (c &lt;= 'z'))</span>
<a href="#l87.698"></a><span id="l87.698">         b = (unsigned char)(c - 'a') + 26;</span>
<a href="#l87.699"></a><span id="l87.699">       else if ((c &gt;= '0') &amp;&amp; (c &lt;= '9'))</span>
<a href="#l87.700"></a><span id="l87.700">         b = (unsigned char)(c - '0') + 52;</span>
<a href="#l87.701"></a><span id="l87.701">       else if (c == '+')</span>
<a href="#l87.702"></a><span id="l87.702">         b = 62;</span>
<a href="#l87.703"></a><span id="l87.703" class="difflineat">@@ -893,22 +862,22 @@ static char * lexGetDataFromBase64()</span>
<a href="#l87.704"></a><span id="l87.704">         b = 63;</span>
<a href="#l87.705"></a><span id="l87.705">       else if (c == '=' &amp;&amp; (quadIx == 2 || quadIx == 3)) {</span>
<a href="#l87.706"></a><span id="l87.706">         b = 0;</span>
<a href="#l87.707"></a><span id="l87.707">         pad++;</span>
<a href="#l87.708"></a><span id="l87.708">       } else if ((c == ' ') || (c == '\t')) {</span>
<a href="#l87.709"></a><span id="l87.709">         continue;</span>
<a href="#l87.710"></a><span id="l87.710">       } else { /* error condition */</span>
<a href="#l87.711"></a><span id="l87.711">         if (bytes)</span>
<a href="#l87.712"></a><span id="l87.712" class="difflineminus">-          PR_Free (bytes);</span>
<a href="#l87.713"></a><span id="l87.713" class="difflineplus">+          PR_Free(bytes);</span>
<a href="#l87.714"></a><span id="l87.714">         else if (oldBytes)</span>
<a href="#l87.715"></a><span id="l87.715" class="difflineminus">-          PR_Free (oldBytes);</span>
<a href="#l87.716"></a><span id="l87.716" class="difflineplus">+          PR_Free(oldBytes);</span>
<a href="#l87.717"></a><span id="l87.717">         /* error recovery: skip until 2 adjacent newlines. */</span>
<a href="#l87.718"></a><span id="l87.718" class="difflineminus">-        DBG_((&quot;db: invalid character 0x%x '%c'\n&quot;, c,c));</span>
<a href="#l87.719"></a><span id="l87.719" class="difflineminus">-        if (c != EOF)  {</span>
<a href="#l87.720"></a><span id="l87.720" class="difflineplus">+        DBG_((&quot;db: invalid character 0x%x '%c'\n&quot;, c, c));</span>
<a href="#l87.721"></a><span id="l87.721" class="difflineplus">+        if (c != EOF) {</span>
<a href="#l87.722"></a><span id="l87.722">           c = lexGetc();</span>
<a href="#l87.723"></a><span id="l87.723">           while (c != EOF) {</span>
<a href="#l87.724"></a><span id="l87.724">             if (c == '\n' &amp;&amp; lexLookahead() == '\n') {</span>
<a href="#l87.725"></a><span id="l87.725">               ++mime_lineNum;</span>
<a href="#l87.726"></a><span id="l87.726">               break;</span>
<a href="#l87.727"></a><span id="l87.727">             }</span>
<a href="#l87.728"></a><span id="l87.728">             c = lexGetc();</span>
<a href="#l87.729"></a><span id="l87.729">           }</span>
<a href="#l87.730"></a><span id="l87.730" class="difflineat">@@ -916,137 +885,131 @@ static char * lexGetDataFromBase64()</span>
<a href="#l87.731"></a><span id="l87.731">         return NULL;</span>
<a href="#l87.732"></a><span id="l87.732">       }</span>
<a href="#l87.733"></a><span id="l87.733">       trip = (trip &lt;&lt; 6) | b;</span>
<a href="#l87.734"></a><span id="l87.734">       if (++quadIx == 4) {</span>
<a href="#l87.735"></a><span id="l87.735">         unsigned char outBytes[3];</span>
<a href="#l87.736"></a><span id="l87.736">         int numOut;</span>
<a href="#l87.737"></a><span id="l87.737">         int i;</span>
<a href="#l87.738"></a><span id="l87.738">         for (i = 0; i &lt; 3; i++) {</span>
<a href="#l87.739"></a><span id="l87.739" class="difflineminus">-          outBytes[2-i] = (unsigned char)(trip &amp; 0xFF);</span>
<a href="#l87.740"></a><span id="l87.740" class="difflineplus">+          outBytes[2 - i] = (unsigned char)(trip &amp; 0xFF);</span>
<a href="#l87.741"></a><span id="l87.741">           trip &gt;&gt;= 8;</span>
<a href="#l87.742"></a><span id="l87.742">         }</span>
<a href="#l87.743"></a><span id="l87.743">         numOut = 3 - pad;</span>
<a href="#l87.744"></a><span id="l87.744">         if (bytesLen + numOut &gt; bytesMax) {</span>
<a href="#l87.745"></a><span id="l87.745">           if (!bytes) {</span>
<a href="#l87.746"></a><span id="l87.746">             bytesMax = 1024;</span>
<a href="#l87.747"></a><span id="l87.747">           } else {</span>
<a href="#l87.748"></a><span id="l87.748">             bytesMax &lt;&lt;= 2;</span>
<a href="#l87.749"></a><span id="l87.749">             oldBytes = bytes;</span>
<a href="#l87.750"></a><span id="l87.750">           }</span>
<a href="#l87.751"></a><span id="l87.751" class="difflineminus">-          bytes = (unsigned char*) PR_Realloc(oldBytes, bytesMax);</span>
<a href="#l87.752"></a><span id="l87.752" class="difflineplus">+          bytes = (unsigned char *)PR_Realloc(oldBytes, bytesMax);</span>
<a href="#l87.753"></a><span id="l87.753">           if (!bytes) {</span>
<a href="#l87.754"></a><span id="l87.754">             mime_error(&quot;out of memory while processing BASE64 data\n&quot;);</span>
<a href="#l87.755"></a><span id="l87.755">             break;</span>
<a href="#l87.756"></a><span id="l87.756">           }</span>
<a href="#l87.757"></a><span id="l87.757">         }</span>
<a href="#l87.758"></a><span id="l87.758">         if (bytes) {</span>
<a href="#l87.759"></a><span id="l87.759">           memcpy(bytes + bytesLen, outBytes, numOut);</span>
<a href="#l87.760"></a><span id="l87.760">           bytesLen += numOut;</span>
<a href="#l87.761"></a><span id="l87.761">         }</span>
<a href="#l87.762"></a><span id="l87.762">         trip = 0;</span>
<a href="#l87.763"></a><span id="l87.763">         quadIx = 0;</span>
<a href="#l87.764"></a><span id="l87.764">         pad = 0;</span>
<a href="#l87.765"></a><span id="l87.765">       }</span>
<a href="#l87.766"></a><span id="l87.766">     }</span>
<a href="#l87.767"></a><span id="l87.767">   } /* while */</span>
<a href="#l87.768"></a><span id="l87.768" class="difflineminus">-  DBG_((&quot;db: bytesLen = %d\n&quot;,  bytesLen));</span>
<a href="#l87.769"></a><span id="l87.769" class="difflineplus">+  DBG_((&quot;db: bytesLen = %d\n&quot;, bytesLen));</span>
<a href="#l87.770"></a><span id="l87.770">   /* kludge: all this won't be necessary if we have tree form</span>
<a href="#l87.771"></a><span id="l87.771">   representation */</span>
<a href="#l87.772"></a><span id="l87.772">   if (bytes) {</span>
<a href="#l87.773"></a><span id="l87.773" class="difflineminus">-    setValueWithSize(curProp,bytes,(unsigned int)bytesLen);</span>
<a href="#l87.774"></a><span id="l87.774" class="difflineplus">+    setValueWithSize(curProp, bytes, (unsigned int)bytesLen);</span>
<a href="#l87.775"></a><span id="l87.775">     PR_FREEIF(bytes);</span>
<a href="#l87.776"></a><span id="l87.776" class="difflineminus">-  }</span>
<a href="#l87.777"></a><span id="l87.777" class="difflineminus">-  else if (oldBytes) {</span>
<a href="#l87.778"></a><span id="l87.778" class="difflineminus">-    setValueWithSize(curProp,oldBytes,(unsigned int)bytesLen);</span>
<a href="#l87.779"></a><span id="l87.779" class="difflineplus">+  } else if (oldBytes) {</span>
<a href="#l87.780"></a><span id="l87.780" class="difflineplus">+    setValueWithSize(curProp, oldBytes, (unsigned int)bytesLen);</span>
<a href="#l87.781"></a><span id="l87.781">     PR_FREEIF(oldBytes);</span>
<a href="#l87.782"></a><span id="l87.782">   }</span>
<a href="#l87.783"></a><span id="l87.783">   return 0;</span>
<a href="#l87.784"></a><span id="l87.784"> }</span>
<a href="#l87.785"></a><span id="l87.785"> </span>
<a href="#l87.786"></a><span id="l87.786"> static int match_begin_end_name(int end) {</span>
<a href="#l87.787"></a><span id="l87.787">   int token;</span>
<a href="#l87.788"></a><span id="l87.788">   lexSkipWhite();</span>
<a href="#l87.789"></a><span id="l87.789">   if (lexLookahead() != ':') return ID;</span>
<a href="#l87.790"></a><span id="l87.790">   lexSkipLookahead();</span>
<a href="#l87.791"></a><span id="l87.791">   lexSkipWhite();</span>
<a href="#l87.792"></a><span id="l87.792">   token = match_begin_name(end);</span>
<a href="#l87.793"></a><span id="l87.793">   if (token == ID) {</span>
<a href="#l87.794"></a><span id="l87.794">     lexPushLookaheadc(':');</span>
<a href="#l87.795"></a><span id="l87.795">     DBG_((&quot;db: ID '%s'\n&quot;, yylval.str));</span>
<a href="#l87.796"></a><span id="l87.796">     return ID;</span>
<a href="#l87.797"></a><span id="l87.797" class="difflineminus">-  }</span>
<a href="#l87.798"></a><span id="l87.798" class="difflineminus">-  else if (token != 0) {</span>
<a href="#l87.799"></a><span id="l87.799" class="difflineplus">+  } else if (token != 0) {</span>
<a href="#l87.800"></a><span id="l87.800">     lexSkipLookaheadWord();</span>
<a href="#l87.801"></a><span id="l87.801">     deleteString(yylval.str);</span>
<a href="#l87.802"></a><span id="l87.802">     DBG_((&quot;db: begin/end %d\n&quot;, token));</span>
<a href="#l87.803"></a><span id="l87.803">     return token;</span>
<a href="#l87.804"></a><span id="l87.804">   }</span>
<a href="#l87.805"></a><span id="l87.805">   return 0;</span>
<a href="#l87.806"></a><span id="l87.806"> }</span>
<a href="#l87.807"></a><span id="l87.807"> </span>
<a href="#l87.808"></a><span id="l87.808" class="difflineminus">-static char* lexGetQuotedPrintable()</span>
<a href="#l87.809"></a><span id="l87.809" class="difflineminus">-{</span>
<a href="#l87.810"></a><span id="l87.810" class="difflineplus">+static char *lexGetQuotedPrintable() {</span>
<a href="#l87.811"></a><span id="l87.811">   char cur;</span>
<a href="#l87.812"></a><span id="l87.812">   /* unsigned long len = 0; */</span>
<a href="#l87.813"></a><span id="l87.813"> </span>
<a href="#l87.814"></a><span id="l87.814">   lexClearToken();</span>
<a href="#l87.815"></a><span id="l87.815">   do {</span>
<a href="#l87.816"></a><span id="l87.816">     cur = lexGetc();</span>
<a href="#l87.817"></a><span id="l87.817">     switch (cur) {</span>
<a href="#l87.818"></a><span id="l87.818" class="difflineminus">-    case '=': {</span>
<a href="#l87.819"></a><span id="l87.819" class="difflineminus">-      int c = 0;</span>
<a href="#l87.820"></a><span id="l87.820" class="difflineminus">-      int next[2];</span>
<a href="#l87.821"></a><span id="l87.821" class="difflineminus">-      int tab [1];</span>
<a href="#l87.822"></a><span id="l87.822" class="difflineminus">-      int i;</span>
<a href="#l87.823"></a><span id="l87.823" class="difflineminus">-      for (i = 0; i &lt; 2; i++) {</span>
<a href="#l87.824"></a><span id="l87.824" class="difflineminus">-        next[i] = lexGetc();</span>
<a href="#l87.825"></a><span id="l87.825" class="difflineminus">-        if (next[i] &gt;= '0' &amp;&amp; next[i] &lt;= '9')</span>
<a href="#l87.826"></a><span id="l87.826" class="difflineminus">-          c = c * 16 + next[i] - '0';</span>
<a href="#l87.827"></a><span id="l87.827" class="difflineminus">-        else if (next[i] &gt;= 'A' &amp;&amp; next[i] &lt;= 'F')</span>
<a href="#l87.828"></a><span id="l87.828" class="difflineminus">-          c = c * 16 + next[i] - 'A' + 10;</span>
<a href="#l87.829"></a><span id="l87.829" class="difflineminus">-        else</span>
<a href="#l87.830"></a><span id="l87.830" class="difflineminus">-          break;</span>
<a href="#l87.831"></a><span id="l87.831" class="difflineminus">-      }</span>
<a href="#l87.832"></a><span id="l87.832" class="difflineminus">-      if (i == 0) {</span>
<a href="#l87.833"></a><span id="l87.833" class="difflineminus">-        /* single '=' follow by LINESEP is continuation sign? */</span>
<a href="#l87.834"></a><span id="l87.834" class="difflineminus">-        if (next[0] == '\n') {</span>
<a href="#l87.835"></a><span id="l87.835" class="difflineminus">-          tab[0] = lexGetc();</span>
<a href="#l87.836"></a><span id="l87.836" class="difflineminus">-          if (tab[0] == '\t')</span>
<a href="#l87.837"></a><span id="l87.837" class="difflineminus">-            lexSkipWhite();</span>
<a href="#l87.838"></a><span id="l87.838" class="difflineminus">-          ++mime_lineNum;</span>
<a href="#l87.839"></a><span id="l87.839" class="difflineplus">+      case '=': {</span>
<a href="#l87.840"></a><span id="l87.840" class="difflineplus">+        int c = 0;</span>
<a href="#l87.841"></a><span id="l87.841" class="difflineplus">+        int next[2];</span>
<a href="#l87.842"></a><span id="l87.842" class="difflineplus">+        int tab[1];</span>
<a href="#l87.843"></a><span id="l87.843" class="difflineplus">+        int i;</span>
<a href="#l87.844"></a><span id="l87.844" class="difflineplus">+        for (i = 0; i &lt; 2; i++) {</span>
<a href="#l87.845"></a><span id="l87.845" class="difflineplus">+          next[i] = lexGetc();</span>
<a href="#l87.846"></a><span id="l87.846" class="difflineplus">+          if (next[i] &gt;= '0' &amp;&amp; next[i] &lt;= '9')</span>
<a href="#l87.847"></a><span id="l87.847" class="difflineplus">+            c = c * 16 + next[i] - '0';</span>
<a href="#l87.848"></a><span id="l87.848" class="difflineplus">+          else if (next[i] &gt;= 'A' &amp;&amp; next[i] &lt;= 'F')</span>
<a href="#l87.849"></a><span id="l87.849" class="difflineplus">+            c = c * 16 + next[i] - 'A' + 10;</span>
<a href="#l87.850"></a><span id="l87.850" class="difflineplus">+          else</span>
<a href="#l87.851"></a><span id="l87.851" class="difflineplus">+            break;</span>
<a href="#l87.852"></a><span id="l87.852">         }</span>
<a href="#l87.853"></a><span id="l87.853" class="difflineminus">-         else {</span>
<a href="#l87.854"></a><span id="l87.854" class="difflineminus">-          lexAppendc(cur);</span>
<a href="#l87.855"></a><span id="l87.855" class="difflineminus">-          /* lexPushLookaheadc('=');</span>
<a href="#l87.856"></a><span id="l87.856" class="difflineminus">-          goto EndString; */</span>
<a href="#l87.857"></a><span id="l87.857" class="difflineplus">+        if (i == 0) {</span>
<a href="#l87.858"></a><span id="l87.858" class="difflineplus">+          /* single '=' follow by LINESEP is continuation sign? */</span>
<a href="#l87.859"></a><span id="l87.859" class="difflineplus">+          if (next[0] == '\n') {</span>
<a href="#l87.860"></a><span id="l87.860" class="difflineplus">+            tab[0] = lexGetc();</span>
<a href="#l87.861"></a><span id="l87.861" class="difflineplus">+            if (tab[0] == '\t') lexSkipWhite();</span>
<a href="#l87.862"></a><span id="l87.862" class="difflineplus">+            ++mime_lineNum;</span>
<a href="#l87.863"></a><span id="l87.863" class="difflineplus">+          } else {</span>
<a href="#l87.864"></a><span id="l87.864" class="difflineplus">+            lexAppendc(cur);</span>
<a href="#l87.865"></a><span id="l87.865" class="difflineplus">+            /* lexPushLookaheadc('=');</span>
<a href="#l87.866"></a><span id="l87.866" class="difflineplus">+            goto EndString; */</span>
<a href="#l87.867"></a><span id="l87.867" class="difflineplus">+          }</span>
<a href="#l87.868"></a><span id="l87.868" class="difflineplus">+        } else if (i == 1) {</span>
<a href="#l87.869"></a><span id="l87.869" class="difflineplus">+          lexPushLookaheadc(next[1]);</span>
<a href="#l87.870"></a><span id="l87.870" class="difflineplus">+          lexPushLookaheadc(next[0]);</span>
<a href="#l87.871"></a><span id="l87.871" class="difflineplus">+          lexAppendc('=');</span>
<a href="#l87.872"></a><span id="l87.872" class="difflineplus">+        } else {</span>
<a href="#l87.873"></a><span id="l87.873" class="difflineplus">+          lexAppendc(c);</span>
<a href="#l87.874"></a><span id="l87.874">         }</span>
<a href="#l87.875"></a><span id="l87.875" class="difflineminus">-      }</span>
<a href="#l87.876"></a><span id="l87.876" class="difflineminus">-      else if (i == 1) {</span>
<a href="#l87.877"></a><span id="l87.877" class="difflineminus">-        lexPushLookaheadc(next[1]);</span>
<a href="#l87.878"></a><span id="l87.878" class="difflineminus">-        lexPushLookaheadc(next[0]);</span>
<a href="#l87.879"></a><span id="l87.879" class="difflineminus">-        lexAppendc('=');</span>
<a href="#l87.880"></a><span id="l87.880" class="difflineminus">-      } else {</span>
<a href="#l87.881"></a><span id="l87.881" class="difflineminus">-        lexAppendc(c);</span>
<a href="#l87.882"></a><span id="l87.882" class="difflineplus">+        break;</span>
<a href="#l87.883"></a><span id="l87.883" class="difflineplus">+      } /* '=' */</span>
<a href="#l87.884"></a><span id="l87.884" class="difflineplus">+      case '\n': {</span>
<a href="#l87.885"></a><span id="l87.885" class="difflineplus">+        lexPushLookaheadc('\n');</span>
<a href="#l87.886"></a><span id="l87.886" class="difflineplus">+        goto EndString;</span>
<a href="#l87.887"></a><span id="l87.887">       }</span>
<a href="#l87.888"></a><span id="l87.888" class="difflineminus">-      break;</span>
<a href="#l87.889"></a><span id="l87.889" class="difflineminus">-    } /* '=' */</span>
<a href="#l87.890"></a><span id="l87.890" class="difflineminus">-    case '\n': {</span>
<a href="#l87.891"></a><span id="l87.891" class="difflineminus">-      lexPushLookaheadc('\n');</span>
<a href="#l87.892"></a><span id="l87.892" class="difflineminus">-      goto EndString;</span>
<a href="#l87.893"></a><span id="l87.893" class="difflineminus">-    }</span>
<a href="#l87.894"></a><span id="l87.894" class="difflineminus">-    case ';': {</span>
<a href="#l87.895"></a><span id="l87.895" class="difflineminus">-      lexPushLookaheadc(';');</span>
<a href="#l87.896"></a><span id="l87.896" class="difflineminus">-      goto EndString;</span>
<a href="#l87.897"></a><span id="l87.897" class="difflineminus">-    }</span>
<a href="#l87.898"></a><span id="l87.898" class="difflineminus">-    case (char)EOF:</span>
<a href="#l87.899"></a><span id="l87.899" class="difflineminus">-      break;</span>
<a href="#l87.900"></a><span id="l87.900" class="difflineminus">-    default:</span>
<a href="#l87.901"></a><span id="l87.901" class="difflineminus">-      lexAppendc(cur);</span>
<a href="#l87.902"></a><span id="l87.902" class="difflineminus">-      break;</span>
<a href="#l87.903"></a><span id="l87.903" class="difflineplus">+      case ';': {</span>
<a href="#l87.904"></a><span id="l87.904" class="difflineplus">+        lexPushLookaheadc(';');</span>
<a href="#l87.905"></a><span id="l87.905" class="difflineplus">+        goto EndString;</span>
<a href="#l87.906"></a><span id="l87.906" class="difflineplus">+      }</span>
<a href="#l87.907"></a><span id="l87.907" class="difflineplus">+      case (char)EOF:</span>
<a href="#l87.908"></a><span id="l87.908" class="difflineplus">+        break;</span>
<a href="#l87.909"></a><span id="l87.909" class="difflineplus">+      default:</span>
<a href="#l87.910"></a><span id="l87.910" class="difflineplus">+        lexAppendc(cur);</span>
<a href="#l87.911"></a><span id="l87.911" class="difflineplus">+        break;</span>
<a href="#l87.912"></a><span id="l87.912">     } /* switch */</span>
<a href="#l87.913"></a><span id="l87.913">   } while (cur != (char)EOF);</span>
<a href="#l87.914"></a><span id="l87.914"> </span>
<a href="#l87.915"></a><span id="l87.915"> EndString:</span>
<a href="#l87.916"></a><span id="l87.916">   lexAppendc(0);</span>
<a href="#l87.917"></a><span id="l87.917">   return lexStr();</span>
<a href="#l87.918"></a><span id="l87.918"> } /* LexQuotedPrintable */</span>
<a href="#l87.919"></a><span id="l87.919"> </span>
<a href="#l87.920"></a><span id="l87.920" class="difflineat">@@ -1058,500 +1021,459 @@ static int yylex() {</span>
<a href="#l87.921"></a><span id="l87.921">     if (c == ';') {</span>
<a href="#l87.922"></a><span id="l87.922">       DBG_((&quot;db: SEMICOLON\n&quot;));</span>
<a href="#l87.923"></a><span id="l87.923"> #ifdef _SUPPORT_LINE_FOLDING</span>
<a href="#l87.924"></a><span id="l87.924">       lexPushLookaheadc(c);</span>
<a href="#l87.925"></a><span id="l87.925">       handleMoreRFC822LineBreak(c);</span>
<a href="#l87.926"></a><span id="l87.926">       lexSkipLookahead();</span>
<a href="#l87.927"></a><span id="l87.927"> #endif</span>
<a href="#l87.928"></a><span id="l87.928">       return SEMICOLON;</span>
<a href="#l87.929"></a><span id="l87.929" class="difflineminus">-    }</span>
<a href="#l87.930"></a><span id="l87.930" class="difflineminus">-    else if (PL_strchr(&quot;\n&quot;,(char)c)) {</span>
<a href="#l87.931"></a><span id="l87.931" class="difflineplus">+    } else if (PL_strchr(&quot;\n&quot;, (char)c)) {</span>
<a href="#l87.932"></a><span id="l87.932">       ++mime_lineNum;</span>
<a href="#l87.933"></a><span id="l87.933">       /* consume all line separator(s) adjacent to each other */</span>
<a href="#l87.934"></a><span id="l87.934">       c = lexLookahead();</span>
<a href="#l87.935"></a><span id="l87.935" class="difflineminus">-      while (PL_strchr(&quot;\n&quot;,(char)c)) {</span>
<a href="#l87.936"></a><span id="l87.936" class="difflineplus">+      while (PL_strchr(&quot;\n&quot;, (char)c)) {</span>
<a href="#l87.937"></a><span id="l87.937">         lexSkipLookahead();</span>
<a href="#l87.938"></a><span id="l87.938">         c = lexLookahead();</span>
<a href="#l87.939"></a><span id="l87.939">         ++mime_lineNum;</span>
<a href="#l87.940"></a><span id="l87.940">       }</span>
<a href="#l87.941"></a><span id="l87.941">       DBG_((&quot;db: LINESEP\n&quot;));</span>
<a href="#l87.942"></a><span id="l87.942">       return LINESEP;</span>
<a href="#l87.943"></a><span id="l87.943" class="difflineminus">-    }</span>
<a href="#l87.944"></a><span id="l87.944" class="difflineminus">-    else {</span>
<a href="#l87.945"></a><span id="l87.945" class="difflineplus">+    } else {</span>
<a href="#l87.946"></a><span id="l87.946">       char *p = 0;</span>
<a href="#l87.947"></a><span id="l87.947">       lexPushLookaheadc(c);</span>
<a href="#l87.948"></a><span id="l87.948">       if (lexWithinMode(L_BASE64)) {</span>
<a href="#l87.949"></a><span id="l87.949">         /* get each char and convert to bin on the fly... */</span>
<a href="#l87.950"></a><span id="l87.950">         p = lexGetDataFromBase64();</span>
<a href="#l87.951"></a><span id="l87.951">         yylval.str = p;</span>
<a href="#l87.952"></a><span id="l87.952">         return !p &amp;&amp; lexLookahead() == EOF ? 0 : STRING;</span>
<a href="#l87.953"></a><span id="l87.953" class="difflineminus">-      }</span>
<a href="#l87.954"></a><span id="l87.954" class="difflineminus">-      else if (lexWithinMode(L_QUOTED_PRINTABLE)) {</span>
<a href="#l87.955"></a><span id="l87.955" class="difflineplus">+      } else if (lexWithinMode(L_QUOTED_PRINTABLE)) {</span>
<a href="#l87.956"></a><span id="l87.956">         p = lexGetQuotedPrintable();</span>
<a href="#l87.957"></a><span id="l87.957" class="difflineminus">-      }</span>
<a href="#l87.958"></a><span id="l87.958" class="difflineminus">-      else {</span>
<a href="#l87.959"></a><span id="l87.959" class="difflineplus">+      } else {</span>
<a href="#l87.960"></a><span id="l87.960"> #ifdef _SUPPORT_LINE_FOLDING</span>
<a href="#l87.961"></a><span id="l87.961">         p = lexGet1Value();</span>
<a href="#l87.962"></a><span id="l87.962"> #else</span>
<a href="#l87.963"></a><span id="l87.963">         p = lexGetStrUntil(&quot;;\n&quot;);</span>
<a href="#l87.964"></a><span id="l87.964"> #endif</span>
<a href="#l87.965"></a><span id="l87.965">       }</span>
<a href="#l87.966"></a><span id="l87.966">       if (p &amp;&amp; (*p || lexLookahead() != EOF)) {</span>
<a href="#l87.967"></a><span id="l87.967">         DBG_((&quot;db: STRING: '%s'\n&quot;, p));</span>
<a href="#l87.968"></a><span id="l87.968">         yylval.str = p;</span>
<a href="#l87.969"></a><span id="l87.969">         return STRING;</span>
<a href="#l87.970"></a><span id="l87.970" class="difflineminus">-      }</span>
<a href="#l87.971"></a><span id="l87.971" class="difflineminus">-      else return 0;</span>
<a href="#l87.972"></a><span id="l87.972" class="difflineplus">+      } else</span>
<a href="#l87.973"></a><span id="l87.973" class="difflineplus">+        return 0;</span>
<a href="#l87.974"></a><span id="l87.974">     }</span>
<a href="#l87.975"></a><span id="l87.975" class="difflineminus">-  }</span>
<a href="#l87.976"></a><span id="l87.976" class="difflineminus">-  else {</span>
<a href="#l87.977"></a><span id="l87.977" class="difflineplus">+  } else {</span>
<a href="#l87.978"></a><span id="l87.978">     /* normal mode */</span>
<a href="#l87.979"></a><span id="l87.979">     while (1) {</span>
<a href="#l87.980"></a><span id="l87.980">       int c = lexGetc();</span>
<a href="#l87.981"></a><span id="l87.981" class="difflineminus">-      switch(c) {</span>
<a href="#l87.982"></a><span id="l87.982" class="difflineminus">-      case ':': {</span>
<a href="#l87.983"></a><span id="l87.983" class="difflineminus">-        /* consume all line separator(s) adjacent to each other */</span>
<a href="#l87.984"></a><span id="l87.984" class="difflineminus">-        /* ignoring linesep immediately after colon. */</span>
<a href="#l87.985"></a><span id="l87.985" class="difflineminus">-        c = lexLookahead();</span>
<a href="#l87.986"></a><span id="l87.986" class="difflineminus">-        while (PL_strchr(&quot;\n&quot;,(char)c)) {</span>
<a href="#l87.987"></a><span id="l87.987" class="difflineminus">-          lexSkipLookahead();</span>
<a href="#l87.988"></a><span id="l87.988" class="difflineplus">+      switch (c) {</span>
<a href="#l87.989"></a><span id="l87.989" class="difflineplus">+        case ':': {</span>
<a href="#l87.990"></a><span id="l87.990" class="difflineplus">+          /* consume all line separator(s) adjacent to each other */</span>
<a href="#l87.991"></a><span id="l87.991" class="difflineplus">+          /* ignoring linesep immediately after colon. */</span>
<a href="#l87.992"></a><span id="l87.992">           c = lexLookahead();</span>
<a href="#l87.993"></a><span id="l87.993" class="difflineminus">-          ++mime_lineNum;</span>
<a href="#l87.994"></a><span id="l87.994" class="difflineplus">+          while (PL_strchr(&quot;\n&quot;, (char)c)) {</span>
<a href="#l87.995"></a><span id="l87.995" class="difflineplus">+            lexSkipLookahead();</span>
<a href="#l87.996"></a><span id="l87.996" class="difflineplus">+            c = lexLookahead();</span>
<a href="#l87.997"></a><span id="l87.997" class="difflineplus">+            ++mime_lineNum;</span>
<a href="#l87.998"></a><span id="l87.998" class="difflineplus">+          }</span>
<a href="#l87.999"></a><span id="l87.999" class="difflineplus">+          DBG_((&quot;db: COLON\n&quot;));</span>
<a href="#l87.1000"></a><span id="l87.1000" class="difflineplus">+          return COLON;</span>
<a href="#l87.1001"></a><span id="l87.1001">         }</span>
<a href="#l87.1002"></a><span id="l87.1002" class="difflineminus">-        DBG_((&quot;db: COLON\n&quot;));</span>
<a href="#l87.1003"></a><span id="l87.1003" class="difflineminus">-        return COLON;</span>
<a href="#l87.1004"></a><span id="l87.1004" class="difflineminus">-      }</span>
<a href="#l87.1005"></a><span id="l87.1005" class="difflineminus">-      case ';':</span>
<a href="#l87.1006"></a><span id="l87.1006" class="difflineminus">-        DBG_((&quot;db: SEMICOLON\n&quot;));</span>
<a href="#l87.1007"></a><span id="l87.1007" class="difflineminus">-        return SEMICOLON;</span>
<a href="#l87.1008"></a><span id="l87.1008" class="difflineminus">-      case '=':</span>
<a href="#l87.1009"></a><span id="l87.1009" class="difflineminus">-        DBG_((&quot;db: EQ\n&quot;));</span>
<a href="#l87.1010"></a><span id="l87.1010" class="difflineminus">-        return EQ;</span>
<a href="#l87.1011"></a><span id="l87.1011" class="difflineminus">-      /* ignore whitespace in this mode */</span>
<a href="#l87.1012"></a><span id="l87.1012" class="difflineminus">-      case '\t':</span>
<a href="#l87.1013"></a><span id="l87.1013" class="difflineminus">-      case ' ': continue;</span>
<a href="#l87.1014"></a><span id="l87.1014" class="difflineminus">-      case '\n': {</span>
<a href="#l87.1015"></a><span id="l87.1015" class="difflineminus">-        ++mime_lineNum;</span>
<a href="#l87.1016"></a><span id="l87.1016" class="difflineminus">-        continue;</span>
<a href="#l87.1017"></a><span id="l87.1017" class="difflineminus">-      }</span>
<a href="#l87.1018"></a><span id="l87.1018" class="difflineminus">-      case EOF:</span>
<a href="#l87.1019"></a><span id="l87.1019" class="difflineminus">-        return 0;</span>
<a href="#l87.1020"></a><span id="l87.1020" class="difflineminus">-      default: {</span>
<a href="#l87.1021"></a><span id="l87.1021" class="difflineminus">-        lexPushLookaheadc(c);</span>
<a href="#l87.1022"></a><span id="l87.1022" class="difflineminus">-        if (isalpha(c)) {</span>
<a href="#l87.1023"></a><span id="l87.1023" class="difflineminus">-          char *t = lexGetWord();</span>
<a href="#l87.1024"></a><span id="l87.1024" class="difflineminus">-          yylval.str = t;</span>
<a href="#l87.1025"></a><span id="l87.1025" class="difflineminus">-          if (!PL_strcasecmp(t, &quot;BEGIN&quot;)) {</span>
<a href="#l87.1026"></a><span id="l87.1026" class="difflineminus">-            return match_begin_end_name(0);</span>
<a href="#l87.1027"></a><span id="l87.1027" class="difflineminus">-          }</span>
<a href="#l87.1028"></a><span id="l87.1028" class="difflineminus">-          else if (!PL_strcasecmp(t,&quot;END&quot;)) {</span>
<a href="#l87.1029"></a><span id="l87.1029" class="difflineminus">-            return match_begin_end_name(1);</span>
<a href="#l87.1030"></a><span id="l87.1030" class="difflineminus">-          }</span>
<a href="#l87.1031"></a><span id="l87.1031" class="difflineminus">-          else {</span>
<a href="#l87.1032"></a><span id="l87.1032" class="difflineminus">-            DBG_((&quot;db: ID '%s'\n&quot;, t));</span>
<a href="#l87.1033"></a><span id="l87.1033" class="difflineminus">-            return ID;</span>
<a href="#l87.1034"></a><span id="l87.1034" class="difflineplus">+        case ';':</span>
<a href="#l87.1035"></a><span id="l87.1035" class="difflineplus">+          DBG_((&quot;db: SEMICOLON\n&quot;));</span>
<a href="#l87.1036"></a><span id="l87.1036" class="difflineplus">+          return SEMICOLON;</span>
<a href="#l87.1037"></a><span id="l87.1037" class="difflineplus">+        case '=':</span>
<a href="#l87.1038"></a><span id="l87.1038" class="difflineplus">+          DBG_((&quot;db: EQ\n&quot;));</span>
<a href="#l87.1039"></a><span id="l87.1039" class="difflineplus">+          return EQ;</span>
<a href="#l87.1040"></a><span id="l87.1040" class="difflineplus">+        /* ignore whitespace in this mode */</span>
<a href="#l87.1041"></a><span id="l87.1041" class="difflineplus">+        case '\t':</span>
<a href="#l87.1042"></a><span id="l87.1042" class="difflineplus">+        case ' ':</span>
<a href="#l87.1043"></a><span id="l87.1043" class="difflineplus">+          continue;</span>
<a href="#l87.1044"></a><span id="l87.1044" class="difflineplus">+        case '\n': {</span>
<a href="#l87.1045"></a><span id="l87.1045" class="difflineplus">+          ++mime_lineNum;</span>
<a href="#l87.1046"></a><span id="l87.1046" class="difflineplus">+          continue;</span>
<a href="#l87.1047"></a><span id="l87.1047" class="difflineplus">+        }</span>
<a href="#l87.1048"></a><span id="l87.1048" class="difflineplus">+        case EOF:</span>
<a href="#l87.1049"></a><span id="l87.1049" class="difflineplus">+          return 0;</span>
<a href="#l87.1050"></a><span id="l87.1050" class="difflineplus">+        default: {</span>
<a href="#l87.1051"></a><span id="l87.1051" class="difflineplus">+          lexPushLookaheadc(c);</span>
<a href="#l87.1052"></a><span id="l87.1052" class="difflineplus">+          if (isalpha(c)) {</span>
<a href="#l87.1053"></a><span id="l87.1053" class="difflineplus">+            char *t = lexGetWord();</span>
<a href="#l87.1054"></a><span id="l87.1054" class="difflineplus">+            yylval.str = t;</span>
<a href="#l87.1055"></a><span id="l87.1055" class="difflineplus">+            if (!PL_strcasecmp(t, &quot;BEGIN&quot;)) {</span>
<a href="#l87.1056"></a><span id="l87.1056" class="difflineplus">+              return match_begin_end_name(0);</span>
<a href="#l87.1057"></a><span id="l87.1057" class="difflineplus">+            } else if (!PL_strcasecmp(t, &quot;END&quot;)) {</span>
<a href="#l87.1058"></a><span id="l87.1058" class="difflineplus">+              return match_begin_end_name(1);</span>
<a href="#l87.1059"></a><span id="l87.1059" class="difflineplus">+            } else {</span>
<a href="#l87.1060"></a><span id="l87.1060" class="difflineplus">+              DBG_((&quot;db: ID '%s'\n&quot;, t));</span>
<a href="#l87.1061"></a><span id="l87.1061" class="difflineplus">+              return ID;</span>
<a href="#l87.1062"></a><span id="l87.1062" class="difflineplus">+            }</span>
<a href="#l87.1063"></a><span id="l87.1063" class="difflineplus">+          } else {</span>
<a href="#l87.1064"></a><span id="l87.1064" class="difflineplus">+            /* unknown token */</span>
<a href="#l87.1065"></a><span id="l87.1065" class="difflineplus">+            return 0;</span>
<a href="#l87.1066"></a><span id="l87.1066">           }</span>
<a href="#l87.1067"></a><span id="l87.1067">         }</span>
<a href="#l87.1068"></a><span id="l87.1068" class="difflineminus">-        else {</span>
<a href="#l87.1069"></a><span id="l87.1069" class="difflineminus">-          /* unknown token */</span>
<a href="#l87.1070"></a><span id="l87.1070" class="difflineminus">-          return 0;</span>
<a href="#l87.1071"></a><span id="l87.1071" class="difflineminus">-        }</span>
<a href="#l87.1072"></a><span id="l87.1072" class="difflineminus">-      }</span>
<a href="#l87.1073"></a><span id="l87.1073">       }</span>
<a href="#l87.1074"></a><span id="l87.1074">     }</span>
<a href="#l87.1075"></a><span id="l87.1075">   }</span>
<a href="#l87.1076"></a><span id="l87.1076"> }</span>
<a href="#l87.1077"></a><span id="l87.1077"> </span>
<a href="#l87.1078"></a><span id="l87.1078" class="difflineminus">-</span>
<a href="#l87.1079"></a><span id="l87.1079"> /***************************************************************************/</span>
<a href="#l87.1080"></a><span id="l87.1080"> /***              Public Functions            ****/</span>
<a href="#l87.1081"></a><span id="l87.1081"> /***************************************************************************/</span>
<a href="#l87.1082"></a><span id="l87.1082"> </span>
<a href="#l87.1083"></a><span id="l87.1083" class="difflineminus">-static VObject* parse_MIMEHelper()</span>
<a href="#l87.1084"></a><span id="l87.1084" class="difflineminus">-{</span>
<a href="#l87.1085"></a><span id="l87.1085" class="difflineplus">+static VObject *parse_MIMEHelper() {</span>
<a href="#l87.1086"></a><span id="l87.1086">   ObjStackTop = -1;</span>
<a href="#l87.1087"></a><span id="l87.1087">   mime_numErrors = 0;</span>
<a href="#l87.1088"></a><span id="l87.1088">   mime_lineNum = 1;</span>
<a href="#l87.1089"></a><span id="l87.1089">   vObjList = 0;</span>
<a href="#l87.1090"></a><span id="l87.1090">   curObj = 0;</span>
<a href="#l87.1091"></a><span id="l87.1091"> </span>
<a href="#l87.1092"></a><span id="l87.1092" class="difflineminus">-  if (yyparse() != 0)</span>
<a href="#l87.1093"></a><span id="l87.1093" class="difflineminus">-    return 0;</span>
<a href="#l87.1094"></a><span id="l87.1094" class="difflineplus">+  if (yyparse() != 0) return 0;</span>
<a href="#l87.1095"></a><span id="l87.1095"> </span>
<a href="#l87.1096"></a><span id="l87.1096">   finiLex();</span>
<a href="#l87.1097"></a><span id="l87.1097">   return vObjList;</span>
<a href="#l87.1098"></a><span id="l87.1098"> }</span>
<a href="#l87.1099"></a><span id="l87.1099"> </span>
<a href="#l87.1100"></a><span id="l87.1100"> /******************************************************************************/</span>
<a href="#l87.1101"></a><span id="l87.1101" class="difflineminus">-VObject* parse_MIME(const char *input, unsigned long len)</span>
<a href="#l87.1102"></a><span id="l87.1102" class="difflineminus">-{</span>
<a href="#l87.1103"></a><span id="l87.1103" class="difflineplus">+VObject *parse_MIME(const char *input, unsigned long len) {</span>
<a href="#l87.1104"></a><span id="l87.1104">   initLex(input, len);</span>
<a href="#l87.1105"></a><span id="l87.1105">   return parse_MIMEHelper();</span>
<a href="#l87.1106"></a><span id="l87.1106"> }</span>
<a href="#l87.1107"></a><span id="l87.1107"> </span>
<a href="#l87.1108"></a><span id="l87.1108"> static MimeErrorHandler mimeErrorHandler;</span>
<a href="#l87.1109"></a><span id="l87.1109"> </span>
<a href="#l87.1110"></a><span id="l87.1110" class="difflineminus">-void registerMimeErrorHandler(MimeErrorHandler me)</span>
<a href="#l87.1111"></a><span id="l87.1111" class="difflineminus">-{</span>
<a href="#l87.1112"></a><span id="l87.1112" class="difflineminus">-  mimeErrorHandler = me;</span>
<a href="#l87.1113"></a><span id="l87.1113" class="difflineminus">-}</span>
<a href="#l87.1114"></a><span id="l87.1114" class="difflineplus">+void registerMimeErrorHandler(MimeErrorHandler me) { mimeErrorHandler = me; }</span>
<a href="#l87.1115"></a><span id="l87.1115"> </span>
<a href="#l87.1116"></a><span id="l87.1116" class="difflineminus">-void mime_error(const char *s)</span>
<a href="#l87.1117"></a><span id="l87.1117" class="difflineminus">-{</span>
<a href="#l87.1118"></a><span id="l87.1118" class="difflineplus">+void mime_error(const char *s) {</span>
<a href="#l87.1119"></a><span id="l87.1119">   char msg[256];</span>
<a href="#l87.1120"></a><span id="l87.1120">   if (mimeErrorHandler) {</span>
<a href="#l87.1121"></a><span id="l87.1121">     PR_snprintf(msg, sizeof(msg), &quot;%s at line %d&quot;, s, mime_lineNum);</span>
<a href="#l87.1122"></a><span id="l87.1122">     mimeErrorHandler(msg);</span>
<a href="#l87.1123"></a><span id="l87.1123">   }</span>
<a href="#l87.1124"></a><span id="l87.1124"> }</span>
<a href="#l87.1125"></a><span id="l87.1125"> </span>
<a href="#l87.1126"></a><span id="l87.1126"> /*#line 1221 &quot;y_tab.c&quot;*/</span>
<a href="#l87.1127"></a><span id="l87.1127"> #define YYABORT goto yyabort</span>
<a href="#l87.1128"></a><span id="l87.1128"> #define YYACCEPT goto yyaccept</span>
<a href="#l87.1129"></a><span id="l87.1129"> #define YYERROR goto yyerrlab</span>
<a href="#l87.1130"></a><span id="l87.1130" class="difflineminus">-int</span>
<a href="#l87.1131"></a><span id="l87.1131" class="difflineminus">-yyparse()</span>
<a href="#l87.1132"></a><span id="l87.1132" class="difflineminus">-{</span>
<a href="#l87.1133"></a><span id="l87.1133" class="difflineplus">+int yyparse() {</span>
<a href="#l87.1134"></a><span id="l87.1134">   int yym, yyn, yystate;</span>
<a href="#l87.1135"></a><span id="l87.1135"> #if YYDEBUG</span>
<a href="#l87.1136"></a><span id="l87.1136">   char *yys;</span>
<a href="#l87.1137"></a><span id="l87.1137">   extern char *getenv();</span>
<a href="#l87.1138"></a><span id="l87.1138"> </span>
<a href="#l87.1139"></a><span id="l87.1139" class="difflineminus">-  if (yys = getenv(&quot;YYDEBUG&quot;))</span>
<a href="#l87.1140"></a><span id="l87.1140" class="difflineminus">-  {</span>
<a href="#l87.1141"></a><span id="l87.1141" class="difflineplus">+  if (yys = getenv(&quot;YYDEBUG&quot;)) {</span>
<a href="#l87.1142"></a><span id="l87.1142">     yyn = *yys;</span>
<a href="#l87.1143"></a><span id="l87.1143" class="difflineminus">-    if (yyn &gt;= '0' &amp;&amp; yyn &lt;= '9')</span>
<a href="#l87.1144"></a><span id="l87.1144" class="difflineminus">-      yydebug = yyn - '0';</span>
<a href="#l87.1145"></a><span id="l87.1145" class="difflineplus">+    if (yyn &gt;= '0' &amp;&amp; yyn &lt;= '9') yydebug = yyn - '0';</span>
<a href="#l87.1146"></a><span id="l87.1146">   }</span>
<a href="#l87.1147"></a><span id="l87.1147"> #endif</span>
<a href="#l87.1148"></a><span id="l87.1148"> </span>
<a href="#l87.1149"></a><span id="l87.1149">   yynerrs = 0;</span>
<a href="#l87.1150"></a><span id="l87.1150">   yyerrflag = 0;</span>
<a href="#l87.1151"></a><span id="l87.1151">   yychar = (-1);</span>
<a href="#l87.1152"></a><span id="l87.1152"> </span>
<a href="#l87.1153"></a><span id="l87.1153">   yyssp = yyss;</span>
<a href="#l87.1154"></a><span id="l87.1154">   yyvsp = yyvs;</span>
<a href="#l87.1155"></a><span id="l87.1155">   *yyssp = yystate = 0;</span>
<a href="#l87.1156"></a><span id="l87.1156"> </span>
<a href="#l87.1157"></a><span id="l87.1157"> yyloop:</span>
<a href="#l87.1158"></a><span id="l87.1158">   if ((yyn = yydefred[yystate])) goto yyreduce;</span>
<a href="#l87.1159"></a><span id="l87.1159" class="difflineminus">-  if (yychar &lt; 0)</span>
<a href="#l87.1160"></a><span id="l87.1160" class="difflineminus">-  {</span>
<a href="#l87.1161"></a><span id="l87.1161" class="difflineplus">+  if (yychar &lt; 0) {</span>
<a href="#l87.1162"></a><span id="l87.1162">     if ((yychar = yylex()) &lt; 0) yychar = 0;</span>
<a href="#l87.1163"></a><span id="l87.1163"> #if YYDEBUG</span>
<a href="#l87.1164"></a><span id="l87.1164" class="difflineminus">-    if (yydebug)</span>
<a href="#l87.1165"></a><span id="l87.1165" class="difflineminus">-    {</span>
<a href="#l87.1166"></a><span id="l87.1166" class="difflineplus">+    if (yydebug) {</span>
<a href="#l87.1167"></a><span id="l87.1167">       yys = 0;</span>
<a href="#l87.1168"></a><span id="l87.1168">       if (yychar &lt;= YYPR_MAXTOKEN) yys = yyname[yychar];</span>
<a href="#l87.1169"></a><span id="l87.1169">       if (!yys) yys = &quot;illegal-symbol&quot;;</span>
<a href="#l87.1170"></a><span id="l87.1170" class="difflineminus">-      printf(&quot;yydebug: state %d, reading %d (%s)\n&quot;, yystate,</span>
<a href="#l87.1171"></a><span id="l87.1171" class="difflineminus">-             yychar, yys);</span>
<a href="#l87.1172"></a><span id="l87.1172" class="difflineplus">+      printf(&quot;yydebug: state %d, reading %d (%s)\n&quot;, yystate, yychar, yys);</span>
<a href="#l87.1173"></a><span id="l87.1173">     }</span>
<a href="#l87.1174"></a><span id="l87.1174"> #endif</span>
<a href="#l87.1175"></a><span id="l87.1175">   }</span>
<a href="#l87.1176"></a><span id="l87.1176" class="difflineminus">-  if ((yyn = yysindex[yystate]) &amp;&amp; (yyn += yychar) &gt;= 0 &amp;&amp;</span>
<a href="#l87.1177"></a><span id="l87.1177" class="difflineminus">-      yyn &lt;= YYTABLESIZE &amp;&amp; yycheck[yyn] == yychar)</span>
<a href="#l87.1178"></a><span id="l87.1178" class="difflineminus">-  {</span>
<a href="#l87.1179"></a><span id="l87.1179" class="difflineplus">+  if ((yyn = yysindex[yystate]) &amp;&amp; (yyn += yychar) &gt;= 0 &amp;&amp; yyn &lt;= YYTABLESIZE &amp;&amp;</span>
<a href="#l87.1180"></a><span id="l87.1180" class="difflineplus">+      yycheck[yyn] == yychar) {</span>
<a href="#l87.1181"></a><span id="l87.1181"> #if YYDEBUG</span>
<a href="#l87.1182"></a><span id="l87.1182">     if (yydebug)</span>
<a href="#l87.1183"></a><span id="l87.1183" class="difflineminus">-      printf(&quot;yydebug: state %d, shifting to state %d\n&quot;,</span>
<a href="#l87.1184"></a><span id="l87.1184" class="difflineminus">-             yystate, yytable[yyn]);</span>
<a href="#l87.1185"></a><span id="l87.1185" class="difflineplus">+      printf(&quot;yydebug: state %d, shifting to state %d\n&quot;, yystate,</span>
<a href="#l87.1186"></a><span id="l87.1186" class="difflineplus">+             yytable[yyn]);</span>
<a href="#l87.1187"></a><span id="l87.1187"> #endif</span>
<a href="#l87.1188"></a><span id="l87.1188" class="difflineminus">-    if (yyssp &gt;= yyss + yystacksize - 1)</span>
<a href="#l87.1189"></a><span id="l87.1189" class="difflineminus">-    {</span>
<a href="#l87.1190"></a><span id="l87.1190" class="difflineplus">+    if (yyssp &gt;= yyss + yystacksize - 1) {</span>
<a href="#l87.1191"></a><span id="l87.1191">       goto yyoverflow;</span>
<a href="#l87.1192"></a><span id="l87.1192">     }</span>
<a href="#l87.1193"></a><span id="l87.1193">     *++yyssp = yystate = yytable[yyn];</span>
<a href="#l87.1194"></a><span id="l87.1194">     *++yyvsp = yylval;</span>
<a href="#l87.1195"></a><span id="l87.1195">     yychar = (-1);</span>
<a href="#l87.1196"></a><span id="l87.1196" class="difflineminus">-    if (yyerrflag &gt; 0)  --yyerrflag;</span>
<a href="#l87.1197"></a><span id="l87.1197" class="difflineplus">+    if (yyerrflag &gt; 0) --yyerrflag;</span>
<a href="#l87.1198"></a><span id="l87.1198">     goto yyloop;</span>
<a href="#l87.1199"></a><span id="l87.1199">   }</span>
<a href="#l87.1200"></a><span id="l87.1200" class="difflineminus">-  if ((yyn = yyrindex[yystate]) &amp;&amp; (yyn += yychar) &gt;= 0 &amp;&amp;</span>
<a href="#l87.1201"></a><span id="l87.1201" class="difflineminus">-      yyn &lt;= YYTABLESIZE &amp;&amp; yycheck[yyn] == yychar)</span>
<a href="#l87.1202"></a><span id="l87.1202" class="difflineminus">-  {</span>
<a href="#l87.1203"></a><span id="l87.1203" class="difflineplus">+  if ((yyn = yyrindex[yystate]) &amp;&amp; (yyn += yychar) &gt;= 0 &amp;&amp; yyn &lt;= YYTABLESIZE &amp;&amp;</span>
<a href="#l87.1204"></a><span id="l87.1204" class="difflineplus">+      yycheck[yyn] == yychar) {</span>
<a href="#l87.1205"></a><span id="l87.1205">     yyn = yytable[yyn];</span>
<a href="#l87.1206"></a><span id="l87.1206">     goto yyreduce;</span>
<a href="#l87.1207"></a><span id="l87.1207">   }</span>
<a href="#l87.1208"></a><span id="l87.1208">   if (yyerrflag) goto yyinrecovery;</span>
<a href="#l87.1209"></a><span id="l87.1209"> #ifdef lint</span>
<a href="#l87.1210"></a><span id="l87.1210">   goto yynewerror;</span>
<a href="#l87.1211"></a><span id="l87.1211"> #endif</span>
<a href="#l87.1212"></a><span id="l87.1212" class="difflineminus">-/*yynewerror: */</span>
<a href="#l87.1213"></a><span id="l87.1213" class="difflineplus">+  /*yynewerror: */</span>
<a href="#l87.1214"></a><span id="l87.1214">   yyerror(&quot;syntax error&quot;);</span>
<a href="#l87.1215"></a><span id="l87.1215"> #ifdef lint</span>
<a href="#l87.1216"></a><span id="l87.1216">   goto yyerrlab;</span>
<a href="#l87.1217"></a><span id="l87.1217"> #endif</span>
<a href="#l87.1218"></a><span id="l87.1218"> yyerrlab:</span>
<a href="#l87.1219"></a><span id="l87.1219">   ++yynerrs;</span>
<a href="#l87.1220"></a><span id="l87.1220"> yyinrecovery:</span>
<a href="#l87.1221"></a><span id="l87.1221" class="difflineminus">-  if (yyerrflag &lt; 3)</span>
<a href="#l87.1222"></a><span id="l87.1222" class="difflineminus">-  {</span>
<a href="#l87.1223"></a><span id="l87.1223" class="difflineplus">+  if (yyerrflag &lt; 3) {</span>
<a href="#l87.1224"></a><span id="l87.1224">     yyerrflag = 3;</span>
<a href="#l87.1225"></a><span id="l87.1225" class="difflineminus">-    for (;;)</span>
<a href="#l87.1226"></a><span id="l87.1226" class="difflineminus">-    {</span>
<a href="#l87.1227"></a><span id="l87.1227" class="difflineplus">+    for (;;) {</span>
<a href="#l87.1228"></a><span id="l87.1228">       if ((yyn = yysindex[*yyssp]) &amp;&amp; (yyn += YYERRCODE) &gt;= 0 &amp;&amp;</span>
<a href="#l87.1229"></a><span id="l87.1229" class="difflineminus">-          yyn &lt;= YYTABLESIZE &amp;&amp; yycheck[yyn] == YYERRCODE)</span>
<a href="#l87.1230"></a><span id="l87.1230" class="difflineminus">-      {</span>
<a href="#l87.1231"></a><span id="l87.1231" class="difflineplus">+          yyn &lt;= YYTABLESIZE &amp;&amp; yycheck[yyn] == YYERRCODE) {</span>
<a href="#l87.1232"></a><span id="l87.1232"> #if YYDEBUG</span>
<a href="#l87.1233"></a><span id="l87.1233">         if (yydebug)</span>
<a href="#l87.1234"></a><span id="l87.1234">           printf(&quot;yydebug: state %d, error recovery shifting to state %d\n&quot;,</span>
<a href="#l87.1235"></a><span id="l87.1235">                  *yyssp, yytable[yyn]);</span>
<a href="#l87.1236"></a><span id="l87.1236"> #endif</span>
<a href="#l87.1237"></a><span id="l87.1237" class="difflineminus">-        if (yyssp &gt;= yyss + yystacksize - 1)</span>
<a href="#l87.1238"></a><span id="l87.1238" class="difflineminus">-        {</span>
<a href="#l87.1239"></a><span id="l87.1239" class="difflineplus">+        if (yyssp &gt;= yyss + yystacksize - 1) {</span>
<a href="#l87.1240"></a><span id="l87.1240">           goto yyoverflow;</span>
<a href="#l87.1241"></a><span id="l87.1241">         }</span>
<a href="#l87.1242"></a><span id="l87.1242">         *++yyssp = yystate = yytable[yyn];</span>
<a href="#l87.1243"></a><span id="l87.1243">         *++yyvsp = yylval;</span>
<a href="#l87.1244"></a><span id="l87.1244">         goto yyloop;</span>
<a href="#l87.1245"></a><span id="l87.1245" class="difflineminus">-      }</span>
<a href="#l87.1246"></a><span id="l87.1246" class="difflineminus">-      else</span>
<a href="#l87.1247"></a><span id="l87.1247" class="difflineminus">-      {</span>
<a href="#l87.1248"></a><span id="l87.1248" class="difflineplus">+      } else {</span>
<a href="#l87.1249"></a><span id="l87.1249"> #if YYDEBUG</span>
<a href="#l87.1250"></a><span id="l87.1250">         if (yydebug)</span>
<a href="#l87.1251"></a><span id="l87.1251" class="difflineminus">-          printf(&quot;yydebug: error recovery discarding state %d\n&quot;,</span>
<a href="#l87.1252"></a><span id="l87.1252" class="difflineminus">-                 *yyssp);</span>
<a href="#l87.1253"></a><span id="l87.1253" class="difflineplus">+          printf(&quot;yydebug: error recovery discarding state %d\n&quot;, *yyssp);</span>
<a href="#l87.1254"></a><span id="l87.1254"> #endif</span>
<a href="#l87.1255"></a><span id="l87.1255">         if (yyssp &lt;= yyss) goto yyabort;</span>
<a href="#l87.1256"></a><span id="l87.1256">         --yyssp;</span>
<a href="#l87.1257"></a><span id="l87.1257">         --yyvsp;</span>
<a href="#l87.1258"></a><span id="l87.1258">       }</span>
<a href="#l87.1259"></a><span id="l87.1259">     }</span>
<a href="#l87.1260"></a><span id="l87.1260" class="difflineminus">-  }</span>
<a href="#l87.1261"></a><span id="l87.1261" class="difflineminus">-  else</span>
<a href="#l87.1262"></a><span id="l87.1262" class="difflineminus">-  {</span>
<a href="#l87.1263"></a><span id="l87.1263" class="difflineplus">+  } else {</span>
<a href="#l87.1264"></a><span id="l87.1264">     if (yychar == 0) goto yyabort;</span>
<a href="#l87.1265"></a><span id="l87.1265"> #if YYDEBUG</span>
<a href="#l87.1266"></a><span id="l87.1266" class="difflineminus">-    if (yydebug)</span>
<a href="#l87.1267"></a><span id="l87.1267" class="difflineminus">-    {</span>
<a href="#l87.1268"></a><span id="l87.1268" class="difflineplus">+    if (yydebug) {</span>
<a href="#l87.1269"></a><span id="l87.1269">       yys = 0;</span>
<a href="#l87.1270"></a><span id="l87.1270">       if (yychar &lt;= YYPR_MAXTOKEN) yys = yyname[yychar];</span>
<a href="#l87.1271"></a><span id="l87.1271">       if (!yys) yys = &quot;illegal-symbol&quot;;</span>
<a href="#l87.1272"></a><span id="l87.1272">       printf(&quot;yydebug: state %d, error recovery discards token %d (%s)\n&quot;,</span>
<a href="#l87.1273"></a><span id="l87.1273">              yystate, yychar, yys);</span>
<a href="#l87.1274"></a><span id="l87.1274">     }</span>
<a href="#l87.1275"></a><span id="l87.1275"> #endif</span>
<a href="#l87.1276"></a><span id="l87.1276">     yychar = (-1);</span>
<a href="#l87.1277"></a><span id="l87.1277">     goto yyloop;</span>
<a href="#l87.1278"></a><span id="l87.1278">   }</span>
<a href="#l87.1279"></a><span id="l87.1279"> yyreduce:</span>
<a href="#l87.1280"></a><span id="l87.1280"> #if YYDEBUG</span>
<a href="#l87.1281"></a><span id="l87.1281">   if (yydebug)</span>
<a href="#l87.1282"></a><span id="l87.1282" class="difflineminus">-    printf(&quot;yydebug: state %d, reducing by rule %d (%s)\n&quot;,</span>
<a href="#l87.1283"></a><span id="l87.1283" class="difflineminus">-           yystate, yyn, yyrule[yyn]);</span>
<a href="#l87.1284"></a><span id="l87.1284" class="difflineplus">+    printf(&quot;yydebug: state %d, reducing by rule %d (%s)\n&quot;, yystate, yyn,</span>
<a href="#l87.1285"></a><span id="l87.1285" class="difflineplus">+           yyrule[yyn]);</span>
<a href="#l87.1286"></a><span id="l87.1286"> #endif</span>
<a href="#l87.1287"></a><span id="l87.1287">   yym = yylen[yyn];</span>
<a href="#l87.1288"></a><span id="l87.1288" class="difflineminus">-  yyval = yyvsp[1-yym];</span>
<a href="#l87.1289"></a><span id="l87.1289" class="difflineminus">-  switch (yyn)</span>
<a href="#l87.1290"></a><span id="l87.1290" class="difflineminus">-  {</span>
<a href="#l87.1291"></a><span id="l87.1291" class="difflineminus">-  case 2:</span>
<a href="#l87.1292"></a><span id="l87.1292" class="difflineminus">-    /*#line 282 &quot;vcc.y&quot;*/</span>
<a href="#l87.1293"></a><span id="l87.1293" class="difflineminus">-    { addList(&amp;vObjList, yyvsp[0].vobj ); curObj = 0; }</span>
<a href="#l87.1294"></a><span id="l87.1294" class="difflineminus">-    break;</span>
<a href="#l87.1295"></a><span id="l87.1295" class="difflineminus">-  case 4:</span>
<a href="#l87.1296"></a><span id="l87.1296" class="difflineminus">-    /*#line 285 &quot;vcc.y&quot;*/</span>
<a href="#l87.1297"></a><span id="l87.1297" class="difflineminus">-    { addList(&amp;vObjList, yyvsp[0].vobj ); curObj = 0; }</span>
<a href="#l87.1298"></a><span id="l87.1298" class="difflineminus">-    break;</span>
<a href="#l87.1299"></a><span id="l87.1299" class="difflineminus">-  case 7:</span>
<a href="#l87.1300"></a><span id="l87.1300" class="difflineminus">-    /*#line 294 &quot;vcc.y&quot;*/</span>
<a href="#l87.1301"></a><span id="l87.1301" class="difflineminus">-    {</span>
<a href="#l87.1302"></a><span id="l87.1302" class="difflineminus">-      lexPushMode(L_VCARD);</span>
<a href="#l87.1303"></a><span id="l87.1303" class="difflineminus">-      if (!pushVObject(VCCardProp)) YYERROR;</span>
<a href="#l87.1304"></a><span id="l87.1304" class="difflineminus">-    }</span>
<a href="#l87.1305"></a><span id="l87.1305" class="difflineminus">-    break;</span>
<a href="#l87.1306"></a><span id="l87.1306" class="difflineminus">-  case 8:</span>
<a href="#l87.1307"></a><span id="l87.1307" class="difflineminus">-    /*#line 299 &quot;vcc.y&quot;*/</span>
<a href="#l87.1308"></a><span id="l87.1308" class="difflineminus">-    {</span>
<a href="#l87.1309"></a><span id="l87.1309" class="difflineminus">-      lexPopMode(0);</span>
<a href="#l87.1310"></a><span id="l87.1310" class="difflineminus">-      yyval.vobj  = popVObject();</span>
<a href="#l87.1311"></a><span id="l87.1311" class="difflineminus">-    }</span>
<a href="#l87.1312"></a><span id="l87.1312" class="difflineminus">-    break;</span>
<a href="#l87.1313"></a><span id="l87.1313" class="difflineminus">-  case 9:</span>
<a href="#l87.1314"></a><span id="l87.1314" class="difflineminus">-    /*#line 304 &quot;vcc.y&quot;*/</span>
<a href="#l87.1315"></a><span id="l87.1315" class="difflineminus">-    {</span>
<a href="#l87.1316"></a><span id="l87.1316" class="difflineminus">-      lexPushMode(L_VCARD);</span>
<a href="#l87.1317"></a><span id="l87.1317" class="difflineminus">-      if (!pushVObject(VCCardProp)) YYERROR;</span>
<a href="#l87.1318"></a><span id="l87.1318" class="difflineminus">-    }</span>
<a href="#l87.1319"></a><span id="l87.1319" class="difflineminus">-    break;</span>
<a href="#l87.1320"></a><span id="l87.1320" class="difflineminus">-  case 10:</span>
<a href="#l87.1321"></a><span id="l87.1321" class="difflineminus">-    /*#line 309 &quot;vcc.y&quot;*/</span>
<a href="#l87.1322"></a><span id="l87.1322" class="difflineminus">-    {</span>
<a href="#l87.1323"></a><span id="l87.1323" class="difflineminus">-      lexPopMode(0);</span>
<a href="#l87.1324"></a><span id="l87.1324" class="difflineminus">-      yyval.vobj  = popVObject();</span>
<a href="#l87.1325"></a><span id="l87.1325" class="difflineminus">-    }</span>
<a href="#l87.1326"></a><span id="l87.1326" class="difflineminus">-    break;</span>
<a href="#l87.1327"></a><span id="l87.1327" class="difflineminus">-  case 13:</span>
<a href="#l87.1328"></a><span id="l87.1328" class="difflineminus">-    /*#line 320 &quot;vcc.y&quot;*/</span>
<a href="#l87.1329"></a><span id="l87.1329" class="difflineminus">-    {</span>
<a href="#l87.1330"></a><span id="l87.1330" class="difflineminus">-      lexPushMode(L_VALUES);</span>
<a href="#l87.1331"></a><span id="l87.1331" class="difflineminus">-    }</span>
<a href="#l87.1332"></a><span id="l87.1332" class="difflineminus">-    break;</span>
<a href="#l87.1333"></a><span id="l87.1333" class="difflineminus">-  case 14:</span>
<a href="#l87.1334"></a><span id="l87.1334" class="difflineminus">-    /*#line 324 &quot;vcc.y&quot;*/</span>
<a href="#l87.1335"></a><span id="l87.1335" class="difflineminus">-    {</span>
<a href="#l87.1336"></a><span id="l87.1336" class="difflineminus">-      if (lexWithinMode(L_BASE64) || lexWithinMode(L_QUOTED_PRINTABLE))</span>
<a href="#l87.1337"></a><span id="l87.1337" class="difflineplus">+  yyval = yyvsp[1 - yym];</span>
<a href="#l87.1338"></a><span id="l87.1338" class="difflineplus">+  switch (yyn) {</span>
<a href="#l87.1339"></a><span id="l87.1339" class="difflineplus">+    case 2:</span>
<a href="#l87.1340"></a><span id="l87.1340" class="difflineplus">+      /*#line 282 &quot;vcc.y&quot;*/</span>
<a href="#l87.1341"></a><span id="l87.1341" class="difflineplus">+      {</span>
<a href="#l87.1342"></a><span id="l87.1342" class="difflineplus">+        addList(&amp;vObjList, yyvsp[0].vobj);</span>
<a href="#l87.1343"></a><span id="l87.1343" class="difflineplus">+        curObj = 0;</span>
<a href="#l87.1344"></a><span id="l87.1344" class="difflineplus">+      }</span>
<a href="#l87.1345"></a><span id="l87.1345" class="difflineplus">+      break;</span>
<a href="#l87.1346"></a><span id="l87.1346" class="difflineplus">+    case 4:</span>
<a href="#l87.1347"></a><span id="l87.1347" class="difflineplus">+      /*#line 285 &quot;vcc.y&quot;*/</span>
<a href="#l87.1348"></a><span id="l87.1348" class="difflineplus">+      {</span>
<a href="#l87.1349"></a><span id="l87.1349" class="difflineplus">+        addList(&amp;vObjList, yyvsp[0].vobj);</span>
<a href="#l87.1350"></a><span id="l87.1350" class="difflineplus">+        curObj = 0;</span>
<a href="#l87.1351"></a><span id="l87.1351" class="difflineplus">+      }</span>
<a href="#l87.1352"></a><span id="l87.1352" class="difflineplus">+      break;</span>
<a href="#l87.1353"></a><span id="l87.1353" class="difflineplus">+    case 7:</span>
<a href="#l87.1354"></a><span id="l87.1354" class="difflineplus">+      /*#line 294 &quot;vcc.y&quot;*/</span>
<a href="#l87.1355"></a><span id="l87.1355" class="difflineplus">+      {</span>
<a href="#l87.1356"></a><span id="l87.1356" class="difflineplus">+        lexPushMode(L_VCARD);</span>
<a href="#l87.1357"></a><span id="l87.1357" class="difflineplus">+        if (!pushVObject(VCCardProp)) YYERROR;</span>
<a href="#l87.1358"></a><span id="l87.1358" class="difflineplus">+      }</span>
<a href="#l87.1359"></a><span id="l87.1359" class="difflineplus">+      break;</span>
<a href="#l87.1360"></a><span id="l87.1360" class="difflineplus">+    case 8:</span>
<a href="#l87.1361"></a><span id="l87.1361" class="difflineplus">+      /*#line 299 &quot;vcc.y&quot;*/</span>
<a href="#l87.1362"></a><span id="l87.1362" class="difflineplus">+      {</span>
<a href="#l87.1363"></a><span id="l87.1363" class="difflineplus">+        lexPopMode(0);</span>
<a href="#l87.1364"></a><span id="l87.1364" class="difflineplus">+        yyval.vobj = popVObject();</span>
<a href="#l87.1365"></a><span id="l87.1365" class="difflineplus">+      }</span>
<a href="#l87.1366"></a><span id="l87.1366" class="difflineplus">+      break;</span>
<a href="#l87.1367"></a><span id="l87.1367" class="difflineplus">+    case 9:</span>
<a href="#l87.1368"></a><span id="l87.1368" class="difflineplus">+      /*#line 304 &quot;vcc.y&quot;*/</span>
<a href="#l87.1369"></a><span id="l87.1369" class="difflineplus">+      {</span>
<a href="#l87.1370"></a><span id="l87.1370" class="difflineplus">+        lexPushMode(L_VCARD);</span>
<a href="#l87.1371"></a><span id="l87.1371" class="difflineplus">+        if (!pushVObject(VCCardProp)) YYERROR;</span>
<a href="#l87.1372"></a><span id="l87.1372" class="difflineplus">+      }</span>
<a href="#l87.1373"></a><span id="l87.1373" class="difflineplus">+      break;</span>
<a href="#l87.1374"></a><span id="l87.1374" class="difflineplus">+    case 10:</span>
<a href="#l87.1375"></a><span id="l87.1375" class="difflineplus">+      /*#line 309 &quot;vcc.y&quot;*/</span>
<a href="#l87.1376"></a><span id="l87.1376" class="difflineplus">+      {</span>
<a href="#l87.1377"></a><span id="l87.1377" class="difflineplus">+        lexPopMode(0);</span>
<a href="#l87.1378"></a><span id="l87.1378" class="difflineplus">+        yyval.vobj = popVObject();</span>
<a href="#l87.1379"></a><span id="l87.1379" class="difflineplus">+      }</span>
<a href="#l87.1380"></a><span id="l87.1380" class="difflineplus">+      break;</span>
<a href="#l87.1381"></a><span id="l87.1381" class="difflineplus">+    case 13:</span>
<a href="#l87.1382"></a><span id="l87.1382" class="difflineplus">+      /*#line 320 &quot;vcc.y&quot;*/</span>
<a href="#l87.1383"></a><span id="l87.1383" class="difflineplus">+      { lexPushMode(L_VALUES); }</span>
<a href="#l87.1384"></a><span id="l87.1384" class="difflineplus">+      break;</span>
<a href="#l87.1385"></a><span id="l87.1385" class="difflineplus">+    case 14:</span>
<a href="#l87.1386"></a><span id="l87.1386" class="difflineplus">+      /*#line 324 &quot;vcc.y&quot;*/</span>
<a href="#l87.1387"></a><span id="l87.1387" class="difflineplus">+      {</span>
<a href="#l87.1388"></a><span id="l87.1388" class="difflineplus">+        if (lexWithinMode(L_BASE64) || lexWithinMode(L_QUOTED_PRINTABLE))</span>
<a href="#l87.1389"></a><span id="l87.1389" class="difflineplus">+          lexPopMode(0);</span>
<a href="#l87.1390"></a><span id="l87.1390">         lexPopMode(0);</span>
<a href="#l87.1391"></a><span id="l87.1391" class="difflineminus">-      lexPopMode(0);</span>
<a href="#l87.1392"></a><span id="l87.1392" class="difflineminus">-    }</span>
<a href="#l87.1393"></a><span id="l87.1393" class="difflineminus">-    break;</span>
<a href="#l87.1394"></a><span id="l87.1394" class="difflineminus">-  case 16:</span>
<a href="#l87.1395"></a><span id="l87.1395" class="difflineminus">-    /*#line 332 &quot;vcc.y&quot;*/</span>
<a href="#l87.1396"></a><span id="l87.1396" class="difflineminus">-    {</span>
<a href="#l87.1397"></a><span id="l87.1397" class="difflineminus">-      enterProps(yyvsp[0].str );</span>
<a href="#l87.1398"></a><span id="l87.1398" class="difflineminus">-    }</span>
<a href="#l87.1399"></a><span id="l87.1399" class="difflineminus">-    break;</span>
<a href="#l87.1400"></a><span id="l87.1400" class="difflineminus">-  case 18:</span>
<a href="#l87.1401"></a><span id="l87.1401" class="difflineminus">-    /*#line 337 &quot;vcc.y&quot;*/</span>
<a href="#l87.1402"></a><span id="l87.1402" class="difflineminus">-    {</span>
<a href="#l87.1403"></a><span id="l87.1403" class="difflineminus">-      enterProps(yyvsp[0].str );</span>
<a href="#l87.1404"></a><span id="l87.1404" class="difflineminus">-    }</span>
<a href="#l87.1405"></a><span id="l87.1405" class="difflineminus">-    break;</span>
<a href="#l87.1406"></a><span id="l87.1406" class="difflineminus">-  case 22:</span>
<a href="#l87.1407"></a><span id="l87.1407" class="difflineminus">-    /*#line 350 &quot;vcc.y&quot;*/</span>
<a href="#l87.1408"></a><span id="l87.1408" class="difflineminus">-    {</span>
<a href="#l87.1409"></a><span id="l87.1409" class="difflineminus">-      enterAttr(yyvsp[0].str ,0);</span>
<a href="#l87.1410"></a><span id="l87.1410" class="difflineminus">-    }</span>
<a href="#l87.1411"></a><span id="l87.1411" class="difflineminus">-    break;</span>
<a href="#l87.1412"></a><span id="l87.1412" class="difflineminus">-  case 23:</span>
<a href="#l87.1413"></a><span id="l87.1413" class="difflineminus">-    /*#line 354 &quot;vcc.y&quot;*/</span>
<a href="#l87.1414"></a><span id="l87.1414" class="difflineminus">-    {</span>
<a href="#l87.1415"></a><span id="l87.1415" class="difflineminus">-      enterAttr(yyvsp[-2].str ,yyvsp[0].str );</span>
<a href="#l87.1416"></a><span id="l87.1416" class="difflineminus">-    }</span>
<a href="#l87.1417"></a><span id="l87.1417" class="difflineminus">-    break;</span>
<a href="#l87.1418"></a><span id="l87.1418" class="difflineminus">-  case 25:</span>
<a href="#l87.1419"></a><span id="l87.1419" class="difflineminus">-    /*#line 363 &quot;vcc.y&quot;*/</span>
<a href="#l87.1420"></a><span id="l87.1420" class="difflineminus">-    { enterValues(yyvsp[-1].str ); }</span>
<a href="#l87.1421"></a><span id="l87.1421" class="difflineminus">-    break;</span>
<a href="#l87.1422"></a><span id="l87.1422" class="difflineminus">-  case 27:</span>
<a href="#l87.1423"></a><span id="l87.1423" class="difflineminus">-    /*#line 365 &quot;vcc.y&quot;*/</span>
<a href="#l87.1424"></a><span id="l87.1424" class="difflineminus">-    { enterValues(yyvsp[0].str ); }</span>
<a href="#l87.1425"></a><span id="l87.1425" class="difflineminus">-    break;</span>
<a href="#l87.1426"></a><span id="l87.1426" class="difflineminus">-  case 29:</span>
<a href="#l87.1427"></a><span id="l87.1427" class="difflineminus">-    /*#line 370 &quot;vcc.y&quot;*/</span>
<a href="#l87.1428"></a><span id="l87.1428" class="difflineminus">-    { yyval.str  = 0; }</span>
<a href="#l87.1429"></a><span id="l87.1429" class="difflineminus">-    break;</span>
<a href="#l87.1430"></a><span id="l87.1430" class="difflineminus">-  case 30:</span>
<a href="#l87.1431"></a><span id="l87.1431" class="difflineminus">-    /*#line 375 &quot;vcc.y&quot;*/</span>
<a href="#l87.1432"></a><span id="l87.1432" class="difflineminus">-    { if (!pushVObject(VCCalProp)) YYERROR; }</span>
<a href="#l87.1433"></a><span id="l87.1433" class="difflineminus">-    break;</span>
<a href="#l87.1434"></a><span id="l87.1434" class="difflineminus">-  case 31:</span>
<a href="#l87.1435"></a><span id="l87.1435" class="difflineminus">-    /*#line 378 &quot;vcc.y&quot;*/</span>
<a href="#l87.1436"></a><span id="l87.1436" class="difflineminus">-    { yyval.vobj  = popVObject(); }</span>
<a href="#l87.1437"></a><span id="l87.1437" class="difflineminus">-    break;</span>
<a href="#l87.1438"></a><span id="l87.1438" class="difflineminus">-  case 32:</span>
<a href="#l87.1439"></a><span id="l87.1439" class="difflineminus">-    /*#line 380 &quot;vcc.y&quot;*/</span>
<a href="#l87.1440"></a><span id="l87.1440" class="difflineminus">-    { if (!pushVObject(VCCalProp)) YYERROR; }</span>
<a href="#l87.1441"></a><span id="l87.1441" class="difflineminus">-    break;</span>
<a href="#l87.1442"></a><span id="l87.1442" class="difflineminus">-  case 33:</span>
<a href="#l87.1443"></a><span id="l87.1443" class="difflineminus">-    /*#line 382 &quot;vcc.y&quot;*/</span>
<a href="#l87.1444"></a><span id="l87.1444" class="difflineminus">-    { yyval.vobj  = popVObject(); }</span>
<a href="#l87.1445"></a><span id="l87.1445" class="difflineminus">-    break;</span>
<a href="#l87.1446"></a><span id="l87.1446" class="difflineminus">-  case 39:</span>
<a href="#l87.1447"></a><span id="l87.1447" class="difflineminus">-  /*#line 397 &quot;vcc.y&quot;*/</span>
<a href="#l87.1448"></a><span id="l87.1448" class="difflineminus">-    {</span>
<a href="#l87.1449"></a><span id="l87.1449" class="difflineminus">-      lexPushMode(L_VEVENT);</span>
<a href="#l87.1450"></a><span id="l87.1450" class="difflineminus">-      if (!pushVObject(VCEventProp)) YYERROR;</span>
<a href="#l87.1451"></a><span id="l87.1451" class="difflineminus">-    }</span>
<a href="#l87.1452"></a><span id="l87.1452" class="difflineminus">-    break;</span>
<a href="#l87.1453"></a><span id="l87.1453" class="difflineminus">-  case 40:</span>
<a href="#l87.1454"></a><span id="l87.1454" class="difflineminus">-  /*#line 403 &quot;vcc.y&quot;*/</span>
<a href="#l87.1455"></a><span id="l87.1455" class="difflineminus">-    {</span>
<a href="#l87.1456"></a><span id="l87.1456" class="difflineminus">-      lexPopMode(0);</span>
<a href="#l87.1457"></a><span id="l87.1457" class="difflineminus">-      popVObject();</span>
<a href="#l87.1458"></a><span id="l87.1458" class="difflineminus">-    }</span>
<a href="#l87.1459"></a><span id="l87.1459" class="difflineminus">-    break;</span>
<a href="#l87.1460"></a><span id="l87.1460" class="difflineminus">-  case 41:</span>
<a href="#l87.1461"></a><span id="l87.1461" class="difflineminus">-    /*#line 408 &quot;vcc.y&quot;*/</span>
<a href="#l87.1462"></a><span id="l87.1462" class="difflineminus">-    {</span>
<a href="#l87.1463"></a><span id="l87.1463" class="difflineminus">-      lexPushMode(L_VEVENT);</span>
<a href="#l87.1464"></a><span id="l87.1464" class="difflineminus">-      if (!pushVObject(VCEventProp)) YYERROR;</span>
<a href="#l87.1465"></a><span id="l87.1465" class="difflineminus">-    }</span>
<a href="#l87.1466"></a><span id="l87.1466" class="difflineminus">-    break;</span>
<a href="#l87.1467"></a><span id="l87.1467" class="difflineminus">-  case 42:</span>
<a href="#l87.1468"></a><span id="l87.1468" class="difflineminus">-    /*#line 413 &quot;vcc.y&quot;*/</span>
<a href="#l87.1469"></a><span id="l87.1469" class="difflineminus">-    {</span>
<a href="#l87.1470"></a><span id="l87.1470" class="difflineminus">-      lexPopMode(0);</span>
<a href="#l87.1471"></a><span id="l87.1471" class="difflineminus">-      popVObject();</span>
<a href="#l87.1472"></a><span id="l87.1472" class="difflineminus">-    }</span>
<a href="#l87.1473"></a><span id="l87.1473" class="difflineminus">-    break;</span>
<a href="#l87.1474"></a><span id="l87.1474" class="difflineminus">-  case 43:</span>
<a href="#l87.1475"></a><span id="l87.1475" class="difflineminus">-    /*#line 421 &quot;vcc.y&quot;*/</span>
<a href="#l87.1476"></a><span id="l87.1476" class="difflineminus">-    {</span>
<a href="#l87.1477"></a><span id="l87.1477" class="difflineminus">-      lexPushMode(L_VTODO);</span>
<a href="#l87.1478"></a><span id="l87.1478" class="difflineminus">-      if (!pushVObject(VCTodoProp)) YYERROR;</span>
<a href="#l87.1479"></a><span id="l87.1479" class="difflineminus">-    }</span>
<a href="#l87.1480"></a><span id="l87.1480" class="difflineminus">-    break;</span>
<a href="#l87.1481"></a><span id="l87.1481" class="difflineminus">-  case 44:</span>
<a href="#l87.1482"></a><span id="l87.1482" class="difflineminus">-    /*#line 427 &quot;vcc.y&quot;*/</span>
<a href="#l87.1483"></a><span id="l87.1483" class="difflineminus">-    {</span>
<a href="#l87.1484"></a><span id="l87.1484" class="difflineminus">-      lexPopMode(0);</span>
<a href="#l87.1485"></a><span id="l87.1485" class="difflineminus">-      popVObject();</span>
<a href="#l87.1486"></a><span id="l87.1486" class="difflineminus">-    }</span>
<a href="#l87.1487"></a><span id="l87.1487" class="difflineminus">-    break;</span>
<a href="#l87.1488"></a><span id="l87.1488" class="difflineminus">-  case 45:</span>
<a href="#l87.1489"></a><span id="l87.1489" class="difflineminus">-    /*#line 432 &quot;vcc.y&quot;*/</span>
<a href="#l87.1490"></a><span id="l87.1490" class="difflineminus">-    {</span>
<a href="#l87.1491"></a><span id="l87.1491" class="difflineminus">-      lexPushMode(L_VTODO);</span>
<a href="#l87.1492"></a><span id="l87.1492" class="difflineminus">-      if (!pushVObject(VCTodoProp)) YYERROR;</span>
<a href="#l87.1493"></a><span id="l87.1493" class="difflineminus">-    }</span>
<a href="#l87.1494"></a><span id="l87.1494" class="difflineminus">-    break;</span>
<a href="#l87.1495"></a><span id="l87.1495" class="difflineminus">-  case 46:</span>
<a href="#l87.1496"></a><span id="l87.1496" class="difflineminus">-    /*#line 437 &quot;vcc.y&quot;*/</span>
<a href="#l87.1497"></a><span id="l87.1497" class="difflineminus">-    {</span>
<a href="#l87.1498"></a><span id="l87.1498" class="difflineminus">-      lexPopMode(0);</span>
<a href="#l87.1499"></a><span id="l87.1499" class="difflineminus">-      popVObject();</span>
<a href="#l87.1500"></a><span id="l87.1500" class="difflineminus">-    }</span>
<a href="#l87.1501"></a><span id="l87.1501" class="difflineminus">-    break;</span>
<a href="#l87.1502"></a><span id="l87.1502" class="difflineminus">-/*#line 1520 &quot;y_tab.c&quot;*/</span>
<a href="#l87.1503"></a><span id="l87.1503" class="difflineplus">+      }</span>
<a href="#l87.1504"></a><span id="l87.1504" class="difflineplus">+      break;</span>
<a href="#l87.1505"></a><span id="l87.1505" class="difflineplus">+    case 16:</span>
<a href="#l87.1506"></a><span id="l87.1506" class="difflineplus">+      /*#line 332 &quot;vcc.y&quot;*/</span>
<a href="#l87.1507"></a><span id="l87.1507" class="difflineplus">+      { enterProps(yyvsp[0].str); }</span>
<a href="#l87.1508"></a><span id="l87.1508" class="difflineplus">+      break;</span>
<a href="#l87.1509"></a><span id="l87.1509" class="difflineplus">+    case 18:</span>
<a href="#l87.1510"></a><span id="l87.1510" class="difflineplus">+      /*#line 337 &quot;vcc.y&quot;*/</span>
<a href="#l87.1511"></a><span id="l87.1511" class="difflineplus">+      { enterProps(yyvsp[0].str); }</span>
<a href="#l87.1512"></a><span id="l87.1512" class="difflineplus">+      break;</span>
<a href="#l87.1513"></a><span id="l87.1513" class="difflineplus">+    case 22:</span>
<a href="#l87.1514"></a><span id="l87.1514" class="difflineplus">+      /*#line 350 &quot;vcc.y&quot;*/</span>
<a href="#l87.1515"></a><span id="l87.1515" class="difflineplus">+      { enterAttr(yyvsp[0].str, 0); }</span>
<a href="#l87.1516"></a><span id="l87.1516" class="difflineplus">+      break;</span>
<a href="#l87.1517"></a><span id="l87.1517" class="difflineplus">+    case 23:</span>
<a href="#l87.1518"></a><span id="l87.1518" class="difflineplus">+      /*#line 354 &quot;vcc.y&quot;*/</span>
<a href="#l87.1519"></a><span id="l87.1519" class="difflineplus">+      { enterAttr(yyvsp[-2].str, yyvsp[0].str); }</span>
<a href="#l87.1520"></a><span id="l87.1520" class="difflineplus">+      break;</span>
<a href="#l87.1521"></a><span id="l87.1521" class="difflineplus">+    case 25:</span>
<a href="#l87.1522"></a><span id="l87.1522" class="difflineplus">+      /*#line 363 &quot;vcc.y&quot;*/</span>
<a href="#l87.1523"></a><span id="l87.1523" class="difflineplus">+      { enterValues(yyvsp[-1].str); }</span>
<a href="#l87.1524"></a><span id="l87.1524" class="difflineplus">+      break;</span>
<a href="#l87.1525"></a><span id="l87.1525" class="difflineplus">+    case 27:</span>
<a href="#l87.1526"></a><span id="l87.1526" class="difflineplus">+      /*#line 365 &quot;vcc.y&quot;*/</span>
<a href="#l87.1527"></a><span id="l87.1527" class="difflineplus">+      { enterValues(yyvsp[0].str); }</span>
<a href="#l87.1528"></a><span id="l87.1528" class="difflineplus">+      break;</span>
<a href="#l87.1529"></a><span id="l87.1529" class="difflineplus">+    case 29:</span>
<a href="#l87.1530"></a><span id="l87.1530" class="difflineplus">+      /*#line 370 &quot;vcc.y&quot;*/</span>
<a href="#l87.1531"></a><span id="l87.1531" class="difflineplus">+      { yyval.str = 0; }</span>
<a href="#l87.1532"></a><span id="l87.1532" class="difflineplus">+      break;</span>
<a href="#l87.1533"></a><span id="l87.1533" class="difflineplus">+    case 30:</span>
<a href="#l87.1534"></a><span id="l87.1534" class="difflineplus">+      /*#line 375 &quot;vcc.y&quot;*/</span>
<a href="#l87.1535"></a><span id="l87.1535" class="difflineplus">+      {</span>
<a href="#l87.1536"></a><span id="l87.1536" class="difflineplus">+        if (!pushVObject(VCCalProp)) YYERROR;</span>
<a href="#l87.1537"></a><span id="l87.1537" class="difflineplus">+      }</span>
<a href="#l87.1538"></a><span id="l87.1538" class="difflineplus">+      break;</span>
<a href="#l87.1539"></a><span id="l87.1539" class="difflineplus">+    case 31:</span>
<a href="#l87.1540"></a><span id="l87.1540" class="difflineplus">+      /*#line 378 &quot;vcc.y&quot;*/</span>
<a href="#l87.1541"></a><span id="l87.1541" class="difflineplus">+      { yyval.vobj = popVObject(); }</span>
<a href="#l87.1542"></a><span id="l87.1542" class="difflineplus">+      break;</span>
<a href="#l87.1543"></a><span id="l87.1543" class="difflineplus">+    case 32:</span>
<a href="#l87.1544"></a><span id="l87.1544" class="difflineplus">+      /*#line 380 &quot;vcc.y&quot;*/</span>
<a href="#l87.1545"></a><span id="l87.1545" class="difflineplus">+      {</span>
<a href="#l87.1546"></a><span id="l87.1546" class="difflineplus">+        if (!pushVObject(VCCalProp)) YYERROR;</span>
<a href="#l87.1547"></a><span id="l87.1547" class="difflineplus">+      }</span>
<a href="#l87.1548"></a><span id="l87.1548" class="difflineplus">+      break;</span>
<a href="#l87.1549"></a><span id="l87.1549" class="difflineplus">+    case 33:</span>
<a href="#l87.1550"></a><span id="l87.1550" class="difflineplus">+      /*#line 382 &quot;vcc.y&quot;*/</span>
<a href="#l87.1551"></a><span id="l87.1551" class="difflineplus">+      { yyval.vobj = popVObject(); }</span>
<a href="#l87.1552"></a><span id="l87.1552" class="difflineplus">+      break;</span>
<a href="#l87.1553"></a><span id="l87.1553" class="difflineplus">+    case 39:</span>
<a href="#l87.1554"></a><span id="l87.1554" class="difflineplus">+      /*#line 397 &quot;vcc.y&quot;*/</span>
<a href="#l87.1555"></a><span id="l87.1555" class="difflineplus">+      {</span>
<a href="#l87.1556"></a><span id="l87.1556" class="difflineplus">+        lexPushMode(L_VEVENT);</span>
<a href="#l87.1557"></a><span id="l87.1557" class="difflineplus">+        if (!pushVObject(VCEventProp)) YYERROR;</span>
<a href="#l87.1558"></a><span id="l87.1558" class="difflineplus">+      }</span>
<a href="#l87.1559"></a><span id="l87.1559" class="difflineplus">+      break;</span>
<a href="#l87.1560"></a><span id="l87.1560" class="difflineplus">+    case 40:</span>
<a href="#l87.1561"></a><span id="l87.1561" class="difflineplus">+      /*#line 403 &quot;vcc.y&quot;*/</span>
<a href="#l87.1562"></a><span id="l87.1562" class="difflineplus">+      {</span>
<a href="#l87.1563"></a><span id="l87.1563" class="difflineplus">+        lexPopMode(0);</span>
<a href="#l87.1564"></a><span id="l87.1564" class="difflineplus">+        popVObject();</span>
<a href="#l87.1565"></a><span id="l87.1565" class="difflineplus">+      }</span>
<a href="#l87.1566"></a><span id="l87.1566" class="difflineplus">+      break;</span>
<a href="#l87.1567"></a><span id="l87.1567" class="difflineplus">+    case 41:</span>
<a href="#l87.1568"></a><span id="l87.1568" class="difflineplus">+      /*#line 408 &quot;vcc.y&quot;*/</span>
<a href="#l87.1569"></a><span id="l87.1569" class="difflineplus">+      {</span>
<a href="#l87.1570"></a><span id="l87.1570" class="difflineplus">+        lexPushMode(L_VEVENT);</span>
<a href="#l87.1571"></a><span id="l87.1571" class="difflineplus">+        if (!pushVObject(VCEventProp)) YYERROR;</span>
<a href="#l87.1572"></a><span id="l87.1572" class="difflineplus">+      }</span>
<a href="#l87.1573"></a><span id="l87.1573" class="difflineplus">+      break;</span>
<a href="#l87.1574"></a><span id="l87.1574" class="difflineplus">+    case 42:</span>
<a href="#l87.1575"></a><span id="l87.1575" class="difflineplus">+      /*#line 413 &quot;vcc.y&quot;*/</span>
<a href="#l87.1576"></a><span id="l87.1576" class="difflineplus">+      {</span>
<a href="#l87.1577"></a><span id="l87.1577" class="difflineplus">+        lexPopMode(0);</span>
<a href="#l87.1578"></a><span id="l87.1578" class="difflineplus">+        popVObject();</span>
<a href="#l87.1579"></a><span id="l87.1579" class="difflineplus">+      }</span>
<a href="#l87.1580"></a><span id="l87.1580" class="difflineplus">+      break;</span>
<a href="#l87.1581"></a><span id="l87.1581" class="difflineplus">+    case 43:</span>
<a href="#l87.1582"></a><span id="l87.1582" class="difflineplus">+      /*#line 421 &quot;vcc.y&quot;*/</span>
<a href="#l87.1583"></a><span id="l87.1583" class="difflineplus">+      {</span>
<a href="#l87.1584"></a><span id="l87.1584" class="difflineplus">+        lexPushMode(L_VTODO);</span>
<a href="#l87.1585"></a><span id="l87.1585" class="difflineplus">+        if (!pushVObject(VCTodoProp)) YYERROR;</span>
<a href="#l87.1586"></a><span id="l87.1586" class="difflineplus">+      }</span>
<a href="#l87.1587"></a><span id="l87.1587" class="difflineplus">+      break;</span>
<a href="#l87.1588"></a><span id="l87.1588" class="difflineplus">+    case 44:</span>
<a href="#l87.1589"></a><span id="l87.1589" class="difflineplus">+      /*#line 427 &quot;vcc.y&quot;*/</span>
<a href="#l87.1590"></a><span id="l87.1590" class="difflineplus">+      {</span>
<a href="#l87.1591"></a><span id="l87.1591" class="difflineplus">+        lexPopMode(0);</span>
<a href="#l87.1592"></a><span id="l87.1592" class="difflineplus">+        popVObject();</span>
<a href="#l87.1593"></a><span id="l87.1593" class="difflineplus">+      }</span>
<a href="#l87.1594"></a><span id="l87.1594" class="difflineplus">+      break;</span>
<a href="#l87.1595"></a><span id="l87.1595" class="difflineplus">+    case 45:</span>
<a href="#l87.1596"></a><span id="l87.1596" class="difflineplus">+      /*#line 432 &quot;vcc.y&quot;*/</span>
<a href="#l87.1597"></a><span id="l87.1597" class="difflineplus">+      {</span>
<a href="#l87.1598"></a><span id="l87.1598" class="difflineplus">+        lexPushMode(L_VTODO);</span>
<a href="#l87.1599"></a><span id="l87.1599" class="difflineplus">+        if (!pushVObject(VCTodoProp)) YYERROR;</span>
<a href="#l87.1600"></a><span id="l87.1600" class="difflineplus">+      }</span>
<a href="#l87.1601"></a><span id="l87.1601" class="difflineplus">+      break;</span>
<a href="#l87.1602"></a><span id="l87.1602" class="difflineplus">+    case 46:</span>
<a href="#l87.1603"></a><span id="l87.1603" class="difflineplus">+      /*#line 437 &quot;vcc.y&quot;*/</span>
<a href="#l87.1604"></a><span id="l87.1604" class="difflineplus">+      {</span>
<a href="#l87.1605"></a><span id="l87.1605" class="difflineplus">+        lexPopMode(0);</span>
<a href="#l87.1606"></a><span id="l87.1606" class="difflineplus">+        popVObject();</span>
<a href="#l87.1607"></a><span id="l87.1607" class="difflineplus">+      }</span>
<a href="#l87.1608"></a><span id="l87.1608" class="difflineplus">+      break;</span>
<a href="#l87.1609"></a><span id="l87.1609" class="difflineplus">+      /*#line 1520 &quot;y_tab.c&quot;*/</span>
<a href="#l87.1610"></a><span id="l87.1610">   }</span>
<a href="#l87.1611"></a><span id="l87.1611">   yyssp -= yym;</span>
<a href="#l87.1612"></a><span id="l87.1612">   yystate = *yyssp;</span>
<a href="#l87.1613"></a><span id="l87.1613">   yyvsp -= yym;</span>
<a href="#l87.1614"></a><span id="l87.1614">   yym = yylhs[yyn];</span>
<a href="#l87.1615"></a><span id="l87.1615" class="difflineminus">-  if (yystate == 0 &amp;&amp; yym == 0)</span>
<a href="#l87.1616"></a><span id="l87.1616" class="difflineminus">-  {</span>
<a href="#l87.1617"></a><span id="l87.1617" class="difflineplus">+  if (yystate == 0 &amp;&amp; yym == 0) {</span>
<a href="#l87.1618"></a><span id="l87.1618"> #if YYDEBUG</span>
<a href="#l87.1619"></a><span id="l87.1619">     if (yydebug)</span>
<a href="#l87.1620"></a><span id="l87.1620">       printf(&quot;yydebug: after reduction, shifting from state 0 to state %d\n&quot;,</span>
<a href="#l87.1621"></a><span id="l87.1621">              YYFINAL);</span>
<a href="#l87.1622"></a><span id="l87.1622"> #endif</span>
<a href="#l87.1623"></a><span id="l87.1623">     yystate = YYFINAL;</span>
<a href="#l87.1624"></a><span id="l87.1624">     *++yyssp = YYFINAL;</span>
<a href="#l87.1625"></a><span id="l87.1625">     *++yyvsp = yyval;</span>
<a href="#l87.1626"></a><span id="l87.1626" class="difflineminus">-    if (yychar &lt; 0)</span>
<a href="#l87.1627"></a><span id="l87.1627" class="difflineminus">-    {</span>
<a href="#l87.1628"></a><span id="l87.1628" class="difflineplus">+    if (yychar &lt; 0) {</span>
<a href="#l87.1629"></a><span id="l87.1629">       if ((yychar = yylex()) &lt; 0) yychar = 0;</span>
<a href="#l87.1630"></a><span id="l87.1630"> #if YYDEBUG</span>
<a href="#l87.1631"></a><span id="l87.1631" class="difflineminus">-      if (yydebug)</span>
<a href="#l87.1632"></a><span id="l87.1632" class="difflineminus">-      {</span>
<a href="#l87.1633"></a><span id="l87.1633" class="difflineplus">+      if (yydebug) {</span>
<a href="#l87.1634"></a><span id="l87.1634">         yys = 0;</span>
<a href="#l87.1635"></a><span id="l87.1635">         if (yychar &lt;= YYPR_MAXTOKEN) yys = yyname[yychar];</span>
<a href="#l87.1636"></a><span id="l87.1636">         if (!yys) yys = &quot;illegal-symbol&quot;;</span>
<a href="#l87.1637"></a><span id="l87.1637" class="difflineminus">-        printf(&quot;yydebug: state %d, reading %d (%s)\n&quot;,</span>
<a href="#l87.1638"></a><span id="l87.1638" class="difflineminus">-               YYFINAL, yychar, yys);</span>
<a href="#l87.1639"></a><span id="l87.1639" class="difflineplus">+        printf(&quot;yydebug: state %d, reading %d (%s)\n&quot;, YYFINAL, yychar, yys);</span>
<a href="#l87.1640"></a><span id="l87.1640">       }</span>
<a href="#l87.1641"></a><span id="l87.1641"> #endif</span>
<a href="#l87.1642"></a><span id="l87.1642">     }</span>
<a href="#l87.1643"></a><span id="l87.1643">     if (yychar == 0) goto yyaccept;</span>
<a href="#l87.1644"></a><span id="l87.1644">     goto yyloop;</span>
<a href="#l87.1645"></a><span id="l87.1645">   }</span>
<a href="#l87.1646"></a><span id="l87.1646" class="difflineminus">-  if ((yyn = yygindex[yym]) &amp;&amp; (yyn += yystate) &gt;= 0 &amp;&amp;</span>
<a href="#l87.1647"></a><span id="l87.1647" class="difflineminus">-      yyn &lt;= YYTABLESIZE &amp;&amp; yycheck[yyn] == yystate)</span>
<a href="#l87.1648"></a><span id="l87.1648" class="difflineplus">+  if ((yyn = yygindex[yym]) &amp;&amp; (yyn += yystate) &gt;= 0 &amp;&amp; yyn &lt;= YYTABLESIZE &amp;&amp;</span>
<a href="#l87.1649"></a><span id="l87.1649" class="difflineplus">+      yycheck[yyn] == yystate)</span>
<a href="#l87.1650"></a><span id="l87.1650">     yystate = yytable[yyn];</span>
<a href="#l87.1651"></a><span id="l87.1651">   else</span>
<a href="#l87.1652"></a><span id="l87.1652">     yystate = yydgoto[yym];</span>
<a href="#l87.1653"></a><span id="l87.1653"> #if YYDEBUG</span>
<a href="#l87.1654"></a><span id="l87.1654">   if (yydebug)</span>
<a href="#l87.1655"></a><span id="l87.1655">     printf(&quot;yydebug: after reduction, shifting from state %d to state %d\n&quot;,</span>
<a href="#l87.1656"></a><span id="l87.1656">            *yyssp, yystate);</span>
<a href="#l87.1657"></a><span id="l87.1657"> #endif</span>
<a href="#l87.1658"></a><span id="l87.1658" class="difflineminus">-  if (yyssp &gt;= yyss + yystacksize - 1)</span>
<a href="#l87.1659"></a><span id="l87.1659" class="difflineminus">-  {</span>
<a href="#l87.1660"></a><span id="l87.1660" class="difflineplus">+  if (yyssp &gt;= yyss + yystacksize - 1) {</span>
<a href="#l87.1661"></a><span id="l87.1661">     goto yyoverflow;</span>
<a href="#l87.1662"></a><span id="l87.1662">   }</span>
<a href="#l87.1663"></a><span id="l87.1663">   *++yyssp = yystate;</span>
<a href="#l87.1664"></a><span id="l87.1664">   *++yyvsp = yyval;</span>
<a href="#l87.1665"></a><span id="l87.1665">   goto yyloop;</span>
<a href="#l87.1666"></a><span id="l87.1666"> yyoverflow:</span>
<a href="#l87.1667"></a><span id="l87.1667">   yyerror(&quot;yacc stack overflow&quot;);</span>
<a href="#l87.1668"></a><span id="l87.1668"> yyabort:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/mailnews/addrbook/src/nsVCard.h</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsVCard.h</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -1,14 +1,13 @@</span>
<a href="#l88.4"></a><span id="l88.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l88.5"></a><span id="l88.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l88.6"></a><span id="l88.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l88.7"></a><span id="l88.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l88.8"></a><span id="l88.8"> </span>
<a href="#l88.9"></a><span id="l88.9" class="difflineminus">-</span>
<a href="#l88.10"></a><span id="l88.10"> /***************************************************************************</span>
<a href="#l88.11"></a><span id="l88.11"> (C) Copyright 1996 Apple Computer, Inc., AT&amp;T Corp., International</span>
<a href="#l88.12"></a><span id="l88.12"> Business Machines Corporation and Siemens Rolm Communications Inc.</span>
<a href="#l88.13"></a><span id="l88.13"> </span>
<a href="#l88.14"></a><span id="l88.14"> For purposes of this license notice, the term Licensors shall mean,</span>
<a href="#l88.15"></a><span id="l88.15"> collectively, Apple Computer, Inc., AT&amp;T Corp., International</span>
<a href="#l88.16"></a><span id="l88.16"> Business Machines Corporation and Siemens Rolm Communications Inc.</span>
<a href="#l88.17"></a><span id="l88.17"> The term Licensor shall mean any of the Licensors.</span>
<a href="#l88.18"></a><span id="l88.18" class="difflineat">@@ -46,17 +45,17 @@ DFARS 252.227-7013 or 48 CFR 52.227-19, </span>
<a href="#l88.19"></a><span id="l88.19"> #define __VCC_H__ 1</span>
<a href="#l88.20"></a><span id="l88.20"> </span>
<a href="#l88.21"></a><span id="l88.21"> #include &quot;nsVCardObj.h&quot;</span>
<a href="#l88.22"></a><span id="l88.22"> </span>
<a href="#l88.23"></a><span id="l88.23"> #ifdef __cplusplus</span>
<a href="#l88.24"></a><span id="l88.24"> extern &quot;C&quot; {</span>
<a href="#l88.25"></a><span id="l88.25"> #endif</span>
<a href="#l88.26"></a><span id="l88.26"> </span>
<a href="#l88.27"></a><span id="l88.27" class="difflineminus">-VObject* parse_MIME(const char *input, unsigned long len);</span>
<a href="#l88.28"></a><span id="l88.28" class="difflineplus">+VObject *parse_MIME(const char *input, unsigned long len);</span>
<a href="#l88.29"></a><span id="l88.29"> </span>
<a href="#l88.30"></a><span id="l88.30"> typedef void (*MimeErrorHandler)(char *);</span>
<a href="#l88.31"></a><span id="l88.31"> </span>
<a href="#l88.32"></a><span id="l88.32"> void registerMimeErrorHandler(MimeErrorHandler);</span>
<a href="#l88.33"></a><span id="l88.33"> </span>
<a href="#l88.34"></a><span id="l88.34"> #ifdef __cplusplus</span>
<a href="#l88.35"></a><span id="l88.35"> }</span>
<a href="#l88.36"></a><span id="l88.36"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/mailnews/addrbook/src/nsVCardObj.cpp</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsVCardObj.cpp</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -62,217 +62,165 @@ extern &quot;C&quot; {</span>
<a href="#l89.4"></a><span id="l89.4"> #endif</span>
<a href="#l89.5"></a><span id="l89.5"> </span>
<a href="#l89.6"></a><span id="l89.6"> char **fieldedProp;</span>
<a href="#l89.7"></a><span id="l89.7"> </span>
<a href="#l89.8"></a><span id="l89.8"> #ifdef __cplusplus</span>
<a href="#l89.9"></a><span id="l89.9"> }</span>
<a href="#l89.10"></a><span id="l89.10"> #endif</span>
<a href="#l89.11"></a><span id="l89.11"> </span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineminus">-</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineminus">-static VObject* newVObject_(const char *id);</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineplus">+static VObject *newVObject_(const char *id);</span>
<a href="#l89.16"></a><span id="l89.16"> #if 0</span>
<a href="#l89.17"></a><span id="l89.17"> static int vObjectValueType(VObject *o);</span>
<a href="#l89.18"></a><span id="l89.18"> static void initVObjectIterator(VObjectIterator *i, VObject *o);</span>
<a href="#l89.19"></a><span id="l89.19"> #endif</span>
<a href="#l89.20"></a><span id="l89.20"> </span>
<a href="#l89.21"></a><span id="l89.21"> /*----------------------------------------------------------------------</span>
<a href="#l89.22"></a><span id="l89.22">   The following functions involve with memory allocation:</span>
<a href="#l89.23"></a><span id="l89.23">   newVObject</span>
<a href="#l89.24"></a><span id="l89.24">   deleteVObject</span>
<a href="#l89.25"></a><span id="l89.25">   dupStr</span>
<a href="#l89.26"></a><span id="l89.26">   deleteString</span>
<a href="#l89.27"></a><span id="l89.27">   newStrItem</span>
<a href="#l89.28"></a><span id="l89.28">   deleteStrItem</span>
<a href="#l89.29"></a><span id="l89.29">   ----------------------------------------------------------------------*/</span>
<a href="#l89.30"></a><span id="l89.30"> </span>
<a href="#l89.31"></a><span id="l89.31" class="difflineminus">-static bool needsQuotedPrintable (const char *s)</span>
<a href="#l89.32"></a><span id="l89.32" class="difflineminus">-{</span>
<a href="#l89.33"></a><span id="l89.33" class="difflineplus">+static bool needsQuotedPrintable(const char *s) {</span>
<a href="#l89.34"></a><span id="l89.34">   const unsigned char *p = (const unsigned char *)s;</span>
<a href="#l89.35"></a><span id="l89.35"> </span>
<a href="#l89.36"></a><span id="l89.36">   while (*p) {</span>
<a href="#l89.37"></a><span id="l89.37" class="difflineminus">-    if (*p &amp; 0x80 || *p == '\015' || *p == '\012')</span>
<a href="#l89.38"></a><span id="l89.38" class="difflineminus">-      return true;</span>
<a href="#l89.39"></a><span id="l89.39" class="difflineplus">+    if (*p &amp; 0x80 || *p == '\015' || *p == '\012') return true;</span>
<a href="#l89.40"></a><span id="l89.40">     p++;</span>
<a href="#l89.41"></a><span id="l89.41">   }</span>
<a href="#l89.42"></a><span id="l89.42"> </span>
<a href="#l89.43"></a><span id="l89.43">   return false;</span>
<a href="#l89.44"></a><span id="l89.44"> }</span>
<a href="#l89.45"></a><span id="l89.45"> </span>
<a href="#l89.46"></a><span id="l89.46" class="difflineminus">-VObject* newVObject_(const char *id)</span>
<a href="#l89.47"></a><span id="l89.47" class="difflineminus">-{</span>
<a href="#l89.48"></a><span id="l89.48" class="difflineminus">-  VObject *p = (VObject*) new(VObject);</span>
<a href="#l89.49"></a><span id="l89.49" class="difflineplus">+VObject *newVObject_(const char *id) {</span>
<a href="#l89.50"></a><span id="l89.50" class="difflineplus">+  VObject *p = (VObject *)new (VObject);</span>
<a href="#l89.51"></a><span id="l89.51">   p-&gt;next = 0;</span>
<a href="#l89.52"></a><span id="l89.52">   p-&gt;id = id;</span>
<a href="#l89.53"></a><span id="l89.53">   p-&gt;prop = 0;</span>
<a href="#l89.54"></a><span id="l89.54">   VALUE_TYPE(p) = 0;</span>
<a href="#l89.55"></a><span id="l89.55">   ANY_VALUE_OF(p) = 0;</span>
<a href="#l89.56"></a><span id="l89.56">   return p;</span>
<a href="#l89.57"></a><span id="l89.57"> }</span>
<a href="#l89.58"></a><span id="l89.58"> </span>
<a href="#l89.59"></a><span id="l89.59" class="difflineminus">-VObject* newVObject(const char *id)</span>
<a href="#l89.60"></a><span id="l89.60" class="difflineminus">-{</span>
<a href="#l89.61"></a><span id="l89.61" class="difflineminus">-  return newVObject_(lookupStr(id));</span>
<a href="#l89.62"></a><span id="l89.62" class="difflineminus">-}</span>
<a href="#l89.63"></a><span id="l89.63" class="difflineplus">+VObject *newVObject(const char *id) { return newVObject_(lookupStr(id)); }</span>
<a href="#l89.64"></a><span id="l89.64"> </span>
<a href="#l89.65"></a><span id="l89.65" class="difflineminus">-void deleteVObject(VObject *p)</span>
<a href="#l89.66"></a><span id="l89.66" class="difflineminus">-{</span>
<a href="#l89.67"></a><span id="l89.67" class="difflineplus">+void deleteVObject(VObject *p) {</span>
<a href="#l89.68"></a><span id="l89.68">   unUseStr(p-&gt;id);</span>
<a href="#l89.69"></a><span id="l89.69">   delete (p);</span>
<a href="#l89.70"></a><span id="l89.70"> }</span>
<a href="#l89.71"></a><span id="l89.71"> </span>
<a href="#l89.72"></a><span id="l89.72" class="difflineminus">-char* dupStr(const char *s, unsigned int size)</span>
<a href="#l89.73"></a><span id="l89.73" class="difflineminus">-{</span>
<a href="#l89.74"></a><span id="l89.74" class="difflineplus">+char *dupStr(const char *s, unsigned int size) {</span>
<a href="#l89.75"></a><span id="l89.75">   char *t;</span>
<a href="#l89.76"></a><span id="l89.76" class="difflineminus">-  if  (size == 0) {</span>
<a href="#l89.77"></a><span id="l89.77" class="difflineplus">+  if (size == 0) {</span>
<a href="#l89.78"></a><span id="l89.78">     size = PL_strlen(s);</span>
<a href="#l89.79"></a><span id="l89.79">   }</span>
<a href="#l89.80"></a><span id="l89.80" class="difflineminus">-  t = (char*)PR_CALLOC(size+1);</span>
<a href="#l89.81"></a><span id="l89.81" class="difflineplus">+  t = (char *)PR_CALLOC(size + 1);</span>
<a href="#l89.82"></a><span id="l89.82">   if (t) {</span>
<a href="#l89.83"></a><span id="l89.83" class="difflineminus">-    memcpy(t,s,size);</span>
<a href="#l89.84"></a><span id="l89.84" class="difflineplus">+    memcpy(t, s, size);</span>
<a href="#l89.85"></a><span id="l89.85">     t[size] = 0;</span>
<a href="#l89.86"></a><span id="l89.86">     return t;</span>
<a href="#l89.87"></a><span id="l89.87" class="difflineminus">-  }</span>
<a href="#l89.88"></a><span id="l89.88" class="difflineminus">-  else {</span>
<a href="#l89.89"></a><span id="l89.89" class="difflineminus">-    return (char*)0;</span>
<a href="#l89.90"></a><span id="l89.90" class="difflineplus">+  } else {</span>
<a href="#l89.91"></a><span id="l89.91" class="difflineplus">+    return (char *)0;</span>
<a href="#l89.92"></a><span id="l89.92">   }</span>
<a href="#l89.93"></a><span id="l89.93"> }</span>
<a href="#l89.94"></a><span id="l89.94"> </span>
<a href="#l89.95"></a><span id="l89.95" class="difflineminus">-static StrItem* newStrItem(const char *s, StrItem *next)</span>
<a href="#l89.96"></a><span id="l89.96" class="difflineminus">-{</span>
<a href="#l89.97"></a><span id="l89.97" class="difflineminus">-  StrItem *p = (StrItem*)PR_CALLOC(sizeof(StrItem));</span>
<a href="#l89.98"></a><span id="l89.98" class="difflineplus">+static StrItem *newStrItem(const char *s, StrItem *next) {</span>
<a href="#l89.99"></a><span id="l89.99" class="difflineplus">+  StrItem *p = (StrItem *)PR_CALLOC(sizeof(StrItem));</span>
<a href="#l89.100"></a><span id="l89.100">   p-&gt;next = next;</span>
<a href="#l89.101"></a><span id="l89.101">   p-&gt;s = s;</span>
<a href="#l89.102"></a><span id="l89.102">   p-&gt;refCnt = 1;</span>
<a href="#l89.103"></a><span id="l89.103">   return p;</span>
<a href="#l89.104"></a><span id="l89.104"> }</span>
<a href="#l89.105"></a><span id="l89.105"> </span>
<a href="#l89.106"></a><span id="l89.106" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l89.107"></a><span id="l89.107" class="difflineminus">-void deleteString(char *p)</span>
<a href="#l89.108"></a><span id="l89.108" class="difflineminus">-{</span>
<a href="#l89.109"></a><span id="l89.109" class="difflineminus">-  if (p)</span>
<a href="#l89.110"></a><span id="l89.110" class="difflineminus">-    PR_Free ((void*)p);</span>
<a href="#l89.111"></a><span id="l89.111" class="difflineplus">+extern &quot;C&quot; void deleteString(char *p) {</span>
<a href="#l89.112"></a><span id="l89.112" class="difflineplus">+  if (p) PR_Free((void *)p);</span>
<a href="#l89.113"></a><span id="l89.113"> }</span>
<a href="#l89.114"></a><span id="l89.114"> </span>
<a href="#l89.115"></a><span id="l89.115" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l89.116"></a><span id="l89.116" class="difflineminus">-void deleteStrItem(StrItem *p)</span>
<a href="#l89.117"></a><span id="l89.117" class="difflineminus">-{</span>
<a href="#l89.118"></a><span id="l89.118" class="difflineminus">-  if (p)</span>
<a href="#l89.119"></a><span id="l89.119" class="difflineminus">-    PR_FREEIF (p);</span>
<a href="#l89.120"></a><span id="l89.120" class="difflineplus">+extern &quot;C&quot; void deleteStrItem(StrItem *p) {</span>
<a href="#l89.121"></a><span id="l89.121" class="difflineplus">+  if (p) PR_FREEIF(p);</span>
<a href="#l89.122"></a><span id="l89.122"> }</span>
<a href="#l89.123"></a><span id="l89.123"> </span>
<a href="#l89.124"></a><span id="l89.124" class="difflineminus">-</span>
<a href="#l89.125"></a><span id="l89.125" class="difflineminus">-</span>
<a href="#l89.126"></a><span id="l89.126"> /*----------------------------------------------------------------------</span>
<a href="#l89.127"></a><span id="l89.127">   The following function provide accesses to VObject's value.</span>
<a href="#l89.128"></a><span id="l89.128">   ----------------------------------------------------------------------*/</span>
<a href="#l89.129"></a><span id="l89.129"> </span>
<a href="#l89.130"></a><span id="l89.130" class="difflineminus">-const char* vObjectName(VObject *o)</span>
<a href="#l89.131"></a><span id="l89.131" class="difflineminus">-{</span>
<a href="#l89.132"></a><span id="l89.132" class="difflineminus">-  return NAME_OF(o);</span>
<a href="#l89.133"></a><span id="l89.133" class="difflineminus">-}</span>
<a href="#l89.134"></a><span id="l89.134" class="difflineplus">+const char *vObjectName(VObject *o) { return NAME_OF(o); }</span>
<a href="#l89.135"></a><span id="l89.135" class="difflineplus">+</span>
<a href="#l89.136"></a><span id="l89.136" class="difflineplus">+void setVObjectName(VObject *o, const char *id) { NAME_OF(o) = id; }</span>
<a href="#l89.137"></a><span id="l89.137"> </span>
<a href="#l89.138"></a><span id="l89.138" class="difflineminus">-void setVObjectName(VObject *o, const char* id)</span>
<a href="#l89.139"></a><span id="l89.139" class="difflineminus">-{</span>
<a href="#l89.140"></a><span id="l89.140" class="difflineminus">-  NAME_OF(o) = id;</span>
<a href="#l89.141"></a><span id="l89.141" class="difflineminus">-}</span>
<a href="#l89.142"></a><span id="l89.142" class="difflineplus">+const char *vObjectStringZValue(VObject *o) { return STRINGZ_VALUE_OF(o); }</span>
<a href="#l89.143"></a><span id="l89.143"> </span>
<a href="#l89.144"></a><span id="l89.144" class="difflineminus">-const char* vObjectStringZValue(VObject *o)</span>
<a href="#l89.145"></a><span id="l89.145" class="difflineminus">-{</span>
<a href="#l89.146"></a><span id="l89.146" class="difflineminus">-  return STRINGZ_VALUE_OF(o);</span>
<a href="#l89.147"></a><span id="l89.147" class="difflineminus">-}</span>
<a href="#l89.148"></a><span id="l89.148" class="difflineminus">-</span>
<a href="#l89.149"></a><span id="l89.149" class="difflineminus">-void setVObjectStringZValue(VObject *o, const char *s)</span>
<a href="#l89.150"></a><span id="l89.150" class="difflineminus">-{</span>
<a href="#l89.151"></a><span id="l89.151" class="difflineminus">-  STRINGZ_VALUE_OF(o) = dupStr(s,0);</span>
<a href="#l89.152"></a><span id="l89.152" class="difflineplus">+void setVObjectStringZValue(VObject *o, const char *s) {</span>
<a href="#l89.153"></a><span id="l89.153" class="difflineplus">+  STRINGZ_VALUE_OF(o) = dupStr(s, 0);</span>
<a href="#l89.154"></a><span id="l89.154">   VALUE_TYPE(o) = VCVT_STRINGZ;</span>
<a href="#l89.155"></a><span id="l89.155"> }</span>
<a href="#l89.156"></a><span id="l89.156"> </span>
<a href="#l89.157"></a><span id="l89.157" class="difflineminus">-void setVObjectStringZValue_(VObject *o, const char *s)</span>
<a href="#l89.158"></a><span id="l89.158" class="difflineminus">-{</span>
<a href="#l89.159"></a><span id="l89.159" class="difflineplus">+void setVObjectStringZValue_(VObject *o, const char *s) {</span>
<a href="#l89.160"></a><span id="l89.160">   STRINGZ_VALUE_OF(o) = s;</span>
<a href="#l89.161"></a><span id="l89.161">   VALUE_TYPE(o) = VCVT_STRINGZ;</span>
<a href="#l89.162"></a><span id="l89.162"> }</span>
<a href="#l89.163"></a><span id="l89.163"> </span>
<a href="#l89.164"></a><span id="l89.164" class="difflineminus">-const vwchar_t* vObjectUStringZValue(VObject *o)</span>
<a href="#l89.165"></a><span id="l89.165" class="difflineminus">-{</span>
<a href="#l89.166"></a><span id="l89.166" class="difflineplus">+const vwchar_t *vObjectUStringZValue(VObject *o) {</span>
<a href="#l89.167"></a><span id="l89.167">   return USTRINGZ_VALUE_OF(o);</span>
<a href="#l89.168"></a><span id="l89.168"> }</span>
<a href="#l89.169"></a><span id="l89.169"> </span>
<a href="#l89.170"></a><span id="l89.170" class="difflineminus">-void setVObjectUStringZValue(VObject *o, const vwchar_t *s)</span>
<a href="#l89.171"></a><span id="l89.171" class="difflineminus">-{</span>
<a href="#l89.172"></a><span id="l89.172" class="difflineminus">-  USTRINGZ_VALUE_OF(o) = (vwchar_t*) dupStr((char*)s,(uStrLen(s)+1)*2);</span>
<a href="#l89.173"></a><span id="l89.173" class="difflineplus">+void setVObjectUStringZValue(VObject *o, const vwchar_t *s) {</span>
<a href="#l89.174"></a><span id="l89.174" class="difflineplus">+  USTRINGZ_VALUE_OF(o) = (vwchar_t *)dupStr((char *)s, (uStrLen(s) + 1) * 2);</span>
<a href="#l89.175"></a><span id="l89.175">   VALUE_TYPE(o) = VCVT_USTRINGZ;</span>
<a href="#l89.176"></a><span id="l89.176"> }</span>
<a href="#l89.177"></a><span id="l89.177"> </span>
<a href="#l89.178"></a><span id="l89.178" class="difflineminus">-void setVObjectUStringZValue_(VObject *o, const vwchar_t *s)</span>
<a href="#l89.179"></a><span id="l89.179" class="difflineminus">-{</span>
<a href="#l89.180"></a><span id="l89.180" class="difflineplus">+void setVObjectUStringZValue_(VObject *o, const vwchar_t *s) {</span>
<a href="#l89.181"></a><span id="l89.181">   USTRINGZ_VALUE_OF(o) = s;</span>
<a href="#l89.182"></a><span id="l89.182">   VALUE_TYPE(o) = VCVT_USTRINGZ;</span>
<a href="#l89.183"></a><span id="l89.183"> }</span>
<a href="#l89.184"></a><span id="l89.184"> </span>
<a href="#l89.185"></a><span id="l89.185" class="difflineminus">-unsigned int vObjectIntegerValue(VObject *o)</span>
<a href="#l89.186"></a><span id="l89.186" class="difflineminus">-{</span>
<a href="#l89.187"></a><span id="l89.187" class="difflineminus">-  return INTEGER_VALUE_OF(o);</span>
<a href="#l89.188"></a><span id="l89.188" class="difflineminus">-}</span>
<a href="#l89.189"></a><span id="l89.189" class="difflineplus">+unsigned int vObjectIntegerValue(VObject *o) { return INTEGER_VALUE_OF(o); }</span>
<a href="#l89.190"></a><span id="l89.190"> </span>
<a href="#l89.191"></a><span id="l89.191" class="difflineminus">-void setVObjectIntegerValue(VObject *o, unsigned int i)</span>
<a href="#l89.192"></a><span id="l89.192" class="difflineminus">-{</span>
<a href="#l89.193"></a><span id="l89.193" class="difflineplus">+void setVObjectIntegerValue(VObject *o, unsigned int i) {</span>
<a href="#l89.194"></a><span id="l89.194">   INTEGER_VALUE_OF(o) = i;</span>
<a href="#l89.195"></a><span id="l89.195">   VALUE_TYPE(o) = VCVT_UINT;</span>
<a href="#l89.196"></a><span id="l89.196"> }</span>
<a href="#l89.197"></a><span id="l89.197"> </span>
<a href="#l89.198"></a><span id="l89.198" class="difflineminus">-unsigned long vObjectLongValue(VObject *o)</span>
<a href="#l89.199"></a><span id="l89.199" class="difflineminus">-{</span>
<a href="#l89.200"></a><span id="l89.200" class="difflineminus">-  return LONG_VALUE_OF(o);</span>
<a href="#l89.201"></a><span id="l89.201" class="difflineminus">-}</span>
<a href="#l89.202"></a><span id="l89.202" class="difflineplus">+unsigned long vObjectLongValue(VObject *o) { return LONG_VALUE_OF(o); }</span>
<a href="#l89.203"></a><span id="l89.203"> </span>
<a href="#l89.204"></a><span id="l89.204" class="difflineminus">-void setVObjectLongValue(VObject *o, unsigned long l)</span>
<a href="#l89.205"></a><span id="l89.205" class="difflineminus">-{</span>
<a href="#l89.206"></a><span id="l89.206" class="difflineplus">+void setVObjectLongValue(VObject *o, unsigned long l) {</span>
<a href="#l89.207"></a><span id="l89.207">   LONG_VALUE_OF(o) = l;</span>
<a href="#l89.208"></a><span id="l89.208">   VALUE_TYPE(o) = VCVT_ULONG;</span>
<a href="#l89.209"></a><span id="l89.209"> }</span>
<a href="#l89.210"></a><span id="l89.210"> </span>
<a href="#l89.211"></a><span id="l89.211" class="difflineminus">-void* vObjectAnyValue(VObject *o)</span>
<a href="#l89.212"></a><span id="l89.212" class="difflineminus">-{</span>
<a href="#l89.213"></a><span id="l89.213" class="difflineminus">-  return ANY_VALUE_OF(o);</span>
<a href="#l89.214"></a><span id="l89.214" class="difflineminus">-}</span>
<a href="#l89.215"></a><span id="l89.215" class="difflineplus">+void *vObjectAnyValue(VObject *o) { return ANY_VALUE_OF(o); }</span>
<a href="#l89.216"></a><span id="l89.216"> </span>
<a href="#l89.217"></a><span id="l89.217" class="difflineminus">-void setVObjectAnyValue(VObject *o, void *t)</span>
<a href="#l89.218"></a><span id="l89.218" class="difflineminus">-{</span>
<a href="#l89.219"></a><span id="l89.219" class="difflineplus">+void setVObjectAnyValue(VObject *o, void *t) {</span>
<a href="#l89.220"></a><span id="l89.220">   ANY_VALUE_OF(o) = t;</span>
<a href="#l89.221"></a><span id="l89.221">   VALUE_TYPE(o) = VCVT_RAW;</span>
<a href="#l89.222"></a><span id="l89.222"> }</span>
<a href="#l89.223"></a><span id="l89.223"> </span>
<a href="#l89.224"></a><span id="l89.224" class="difflineminus">-VObject* vObjectVObjectValue(VObject *o)</span>
<a href="#l89.225"></a><span id="l89.225" class="difflineminus">-{</span>
<a href="#l89.226"></a><span id="l89.226" class="difflineminus">-  return VOBJECT_VALUE_OF(o);</span>
<a href="#l89.227"></a><span id="l89.227" class="difflineminus">-}</span>
<a href="#l89.228"></a><span id="l89.228" class="difflineplus">+VObject *vObjectVObjectValue(VObject *o) { return VOBJECT_VALUE_OF(o); }</span>
<a href="#l89.229"></a><span id="l89.229"> </span>
<a href="#l89.230"></a><span id="l89.230" class="difflineminus">-void setVObjectVObjectValue(VObject *o, VObject *p)</span>
<a href="#l89.231"></a><span id="l89.231" class="difflineminus">-{</span>
<a href="#l89.232"></a><span id="l89.232" class="difflineplus">+void setVObjectVObjectValue(VObject *o, VObject *p) {</span>
<a href="#l89.233"></a><span id="l89.233">   VOBJECT_VALUE_OF(o) = p;</span>
<a href="#l89.234"></a><span id="l89.234">   VALUE_TYPE(o) = VCVT_VOBJECT;</span>
<a href="#l89.235"></a><span id="l89.235"> }</span>
<a href="#l89.236"></a><span id="l89.236"> </span>
<a href="#l89.237"></a><span id="l89.237"> #if 0</span>
<a href="#l89.238"></a><span id="l89.238"> int vObjectValueType(VObject *o)</span>
<a href="#l89.239"></a><span id="l89.239"> {</span>
<a href="#l89.240"></a><span id="l89.240">   return VALUE_TYPE(o);</span>
<a href="#l89.241"></a><span id="l89.241"> }</span>
<a href="#l89.242"></a><span id="l89.242"> #endif</span>
<a href="#l89.243"></a><span id="l89.243"> </span>
<a href="#l89.244"></a><span id="l89.244" class="difflineminus">-</span>
<a href="#l89.245"></a><span id="l89.245"> /*----------------------------------------------------------------------</span>
<a href="#l89.246"></a><span id="l89.246">   The following functions can be used to build VObject.</span>
<a href="#l89.247"></a><span id="l89.247">   ----------------------------------------------------------------------*/</span>
<a href="#l89.248"></a><span id="l89.248"> </span>
<a href="#l89.249"></a><span id="l89.249" class="difflineminus">-VObject* addVObjectProp(VObject *o, VObject *p)</span>
<a href="#l89.250"></a><span id="l89.250" class="difflineminus">-{</span>
<a href="#l89.251"></a><span id="l89.251" class="difflineplus">+VObject *addVObjectProp(VObject *o, VObject *p) {</span>
<a href="#l89.252"></a><span id="l89.252">   /* circular link list pointed to tail */</span>
<a href="#l89.253"></a><span id="l89.253">   /*</span>
<a href="#l89.254"></a><span id="l89.254">   o {next,id,prop,val}</span>
<a href="#l89.255"></a><span id="l89.255">              V</span>
<a href="#l89.256"></a><span id="l89.256">   pn {next,id,prop,val}</span>
<a href="#l89.257"></a><span id="l89.257">              V</span>
<a href="#l89.258"></a><span id="l89.258">   ...</span>
<a href="#l89.259"></a><span id="l89.259">   p1 {next,id,prop,val}</span>
<a href="#l89.260"></a><span id="l89.260" class="difflineat">@@ -289,632 +237,547 @@ VObject* addVObjectProp(VObject *o, VObj</span>
<a href="#l89.261"></a><span id="l89.261">              V</span>
<a href="#l89.262"></a><span id="l89.262">   pn</span>
<a href="#l89.263"></a><span id="l89.263">   */</span>
<a href="#l89.264"></a><span id="l89.264"> </span>
<a href="#l89.265"></a><span id="l89.265">   VObject *tail = o-&gt;prop;</span>
<a href="#l89.266"></a><span id="l89.266">   if (tail) {</span>
<a href="#l89.267"></a><span id="l89.267">     p-&gt;next = tail-&gt;next;</span>
<a href="#l89.268"></a><span id="l89.268">     o-&gt;prop = tail-&gt;next = p;</span>
<a href="#l89.269"></a><span id="l89.269" class="difflineminus">-  }</span>
<a href="#l89.270"></a><span id="l89.270" class="difflineminus">-  else {</span>
<a href="#l89.271"></a><span id="l89.271" class="difflineplus">+  } else {</span>
<a href="#l89.272"></a><span id="l89.272">     o-&gt;prop = p-&gt;next = p;</span>
<a href="#l89.273"></a><span id="l89.273">   }</span>
<a href="#l89.274"></a><span id="l89.274">   return p;</span>
<a href="#l89.275"></a><span id="l89.275"> }</span>
<a href="#l89.276"></a><span id="l89.276"> </span>
<a href="#l89.277"></a><span id="l89.277" class="difflineminus">-VObject* addProp(VObject *o, const char *id)</span>
<a href="#l89.278"></a><span id="l89.278" class="difflineminus">-{</span>
<a href="#l89.279"></a><span id="l89.279" class="difflineminus">-  return addVObjectProp(o,newVObject(id));</span>
<a href="#l89.280"></a><span id="l89.280" class="difflineplus">+VObject *addProp(VObject *o, const char *id) {</span>
<a href="#l89.281"></a><span id="l89.281" class="difflineplus">+  return addVObjectProp(o, newVObject(id));</span>
<a href="#l89.282"></a><span id="l89.282"> }</span>
<a href="#l89.283"></a><span id="l89.283"> </span>
<a href="#l89.284"></a><span id="l89.284" class="difflineminus">-VObject* addProp_(VObject *o, const char *id)</span>
<a href="#l89.285"></a><span id="l89.285" class="difflineminus">-{</span>
<a href="#l89.286"></a><span id="l89.286" class="difflineminus">-  return addVObjectProp(o,newVObject_(id));</span>
<a href="#l89.287"></a><span id="l89.287" class="difflineplus">+VObject *addProp_(VObject *o, const char *id) {</span>
<a href="#l89.288"></a><span id="l89.288" class="difflineplus">+  return addVObjectProp(o, newVObject_(id));</span>
<a href="#l89.289"></a><span id="l89.289"> }</span>
<a href="#l89.290"></a><span id="l89.290"> </span>
<a href="#l89.291"></a><span id="l89.291" class="difflineminus">-void addList(VObject **o, VObject *p)</span>
<a href="#l89.292"></a><span id="l89.292" class="difflineminus">-{</span>
<a href="#l89.293"></a><span id="l89.293" class="difflineplus">+void addList(VObject **o, VObject *p) {</span>
<a href="#l89.294"></a><span id="l89.294">   p-&gt;next = 0;</span>
<a href="#l89.295"></a><span id="l89.295">   if (*o == 0) {</span>
<a href="#l89.296"></a><span id="l89.296">     *o = p;</span>
<a href="#l89.297"></a><span id="l89.297" class="difflineminus">-  }</span>
<a href="#l89.298"></a><span id="l89.298" class="difflineminus">-  else {</span>
<a href="#l89.299"></a><span id="l89.299" class="difflineplus">+  } else {</span>
<a href="#l89.300"></a><span id="l89.300">     VObject *t = *o;</span>
<a href="#l89.301"></a><span id="l89.301">     while (t-&gt;next) {</span>
<a href="#l89.302"></a><span id="l89.302">       t = t-&gt;next;</span>
<a href="#l89.303"></a><span id="l89.303">     }</span>
<a href="#l89.304"></a><span id="l89.304">     t-&gt;next = p;</span>
<a href="#l89.305"></a><span id="l89.305">   }</span>
<a href="#l89.306"></a><span id="l89.306"> }</span>
<a href="#l89.307"></a><span id="l89.307"> </span>
<a href="#l89.308"></a><span id="l89.308" class="difflineminus">-VObject* nextVObjectInList(VObject *o)</span>
<a href="#l89.309"></a><span id="l89.309" class="difflineminus">-{</span>
<a href="#l89.310"></a><span id="l89.310" class="difflineminus">-  return o-&gt;next;</span>
<a href="#l89.311"></a><span id="l89.311" class="difflineminus">-}</span>
<a href="#l89.312"></a><span id="l89.312" class="difflineplus">+VObject *nextVObjectInList(VObject *o) { return o-&gt;next; }</span>
<a href="#l89.313"></a><span id="l89.313"> </span>
<a href="#l89.314"></a><span id="l89.314" class="difflineminus">-VObject* setValueWithSize_(VObject *prop, void *val, unsigned int size)</span>
<a href="#l89.315"></a><span id="l89.315" class="difflineminus">-{</span>
<a href="#l89.316"></a><span id="l89.316" class="difflineplus">+VObject *setValueWithSize_(VObject *prop, void *val, unsigned int size) {</span>
<a href="#l89.317"></a><span id="l89.317">   VObject *sizeProp;</span>
<a href="#l89.318"></a><span id="l89.318">   setVObjectAnyValue(prop, val);</span>
<a href="#l89.319"></a><span id="l89.319" class="difflineminus">-  sizeProp = addProp(prop,VCDataSizeProp);</span>
<a href="#l89.320"></a><span id="l89.320" class="difflineplus">+  sizeProp = addProp(prop, VCDataSizeProp);</span>
<a href="#l89.321"></a><span id="l89.321">   setVObjectLongValue(sizeProp, size);</span>
<a href="#l89.322"></a><span id="l89.322">   return prop;</span>
<a href="#l89.323"></a><span id="l89.323"> }</span>
<a href="#l89.324"></a><span id="l89.324"> </span>
<a href="#l89.325"></a><span id="l89.325" class="difflineminus">-VObject* setValueWithSize(VObject *prop, void *val, unsigned int size)</span>
<a href="#l89.326"></a><span id="l89.326" class="difflineminus">-{</span>
<a href="#l89.327"></a><span id="l89.327" class="difflineminus">-  void *p = dupStr((const char *)val,size);</span>
<a href="#l89.328"></a><span id="l89.328" class="difflineminus">-  return setValueWithSize_(prop,p,p?size:0);</span>
<a href="#l89.329"></a><span id="l89.329" class="difflineplus">+VObject *setValueWithSize(VObject *prop, void *val, unsigned int size) {</span>
<a href="#l89.330"></a><span id="l89.330" class="difflineplus">+  void *p = dupStr((const char *)val, size);</span>
<a href="#l89.331"></a><span id="l89.331" class="difflineplus">+  return setValueWithSize_(prop, p, p ? size : 0);</span>
<a href="#l89.332"></a><span id="l89.332"> }</span>
<a href="#l89.333"></a><span id="l89.333"> </span>
<a href="#l89.334"></a><span id="l89.334" class="difflineminus">-void initPropIterator(VObjectIterator *i, VObject *o)</span>
<a href="#l89.335"></a><span id="l89.335" class="difflineminus">-{</span>
<a href="#l89.336"></a><span id="l89.336" class="difflineplus">+void initPropIterator(VObjectIterator *i, VObject *o) {</span>
<a href="#l89.337"></a><span id="l89.337">   i-&gt;start = o-&gt;prop;</span>
<a href="#l89.338"></a><span id="l89.338">   i-&gt;next = 0;</span>
<a href="#l89.339"></a><span id="l89.339"> }</span>
<a href="#l89.340"></a><span id="l89.340"> </span>
<a href="#l89.341"></a><span id="l89.341"> #if 0</span>
<a href="#l89.342"></a><span id="l89.342"> void initVObjectIterator(VObjectIterator *i, VObject *o)</span>
<a href="#l89.343"></a><span id="l89.343"> {</span>
<a href="#l89.344"></a><span id="l89.344">   i-&gt;start = o-&gt;next;</span>
<a href="#l89.345"></a><span id="l89.345">   i-&gt;next = 0;</span>
<a href="#l89.346"></a><span id="l89.346"> }</span>
<a href="#l89.347"></a><span id="l89.347"> #endif</span>
<a href="#l89.348"></a><span id="l89.348"> </span>
<a href="#l89.349"></a><span id="l89.349" class="difflineminus">-int moreIteration(VObjectIterator *i)</span>
<a href="#l89.350"></a><span id="l89.350" class="difflineminus">-{</span>
<a href="#l89.351"></a><span id="l89.351" class="difflineminus">-  return (i-&gt;start &amp;&amp; (i-&gt;next==0 || i-&gt;next!=i-&gt;start));</span>
<a href="#l89.352"></a><span id="l89.352" class="difflineplus">+int moreIteration(VObjectIterator *i) {</span>
<a href="#l89.353"></a><span id="l89.353" class="difflineplus">+  return (i-&gt;start &amp;&amp; (i-&gt;next == 0 || i-&gt;next != i-&gt;start));</span>
<a href="#l89.354"></a><span id="l89.354"> }</span>
<a href="#l89.355"></a><span id="l89.355"> </span>
<a href="#l89.356"></a><span id="l89.356" class="difflineminus">-VObject* nextVObject(VObjectIterator *i)</span>
<a href="#l89.357"></a><span id="l89.357" class="difflineminus">-{</span>
<a href="#l89.358"></a><span id="l89.358" class="difflineplus">+VObject *nextVObject(VObjectIterator *i) {</span>
<a href="#l89.359"></a><span id="l89.359">   if (i-&gt;start &amp;&amp; i-&gt;next != i-&gt;start) {</span>
<a href="#l89.360"></a><span id="l89.360">     if (i-&gt;next == 0) {</span>
<a href="#l89.361"></a><span id="l89.361">       i-&gt;next = i-&gt;start-&gt;next;</span>
<a href="#l89.362"></a><span id="l89.362">       return i-&gt;next;</span>
<a href="#l89.363"></a><span id="l89.363" class="difflineminus">-    }</span>
<a href="#l89.364"></a><span id="l89.364" class="difflineminus">-    else {</span>
<a href="#l89.365"></a><span id="l89.365" class="difflineplus">+    } else {</span>
<a href="#l89.366"></a><span id="l89.366">       i-&gt;next = i-&gt;next-&gt;next;</span>
<a href="#l89.367"></a><span id="l89.367">       return i-&gt;next;</span>
<a href="#l89.368"></a><span id="l89.368">     }</span>
<a href="#l89.369"></a><span id="l89.369" class="difflineminus">-  }</span>
<a href="#l89.370"></a><span id="l89.370" class="difflineminus">-  else return (VObject*)0;</span>
<a href="#l89.371"></a><span id="l89.371" class="difflineplus">+  } else</span>
<a href="#l89.372"></a><span id="l89.372" class="difflineplus">+    return (VObject *)0;</span>
<a href="#l89.373"></a><span id="l89.373"> }</span>
<a href="#l89.374"></a><span id="l89.374"> </span>
<a href="#l89.375"></a><span id="l89.375" class="difflineminus">-VObject* isAPropertyOf(VObject *o, const char *id)</span>
<a href="#l89.376"></a><span id="l89.376" class="difflineminus">-{</span>
<a href="#l89.377"></a><span id="l89.377" class="difflineplus">+VObject *isAPropertyOf(VObject *o, const char *id) {</span>
<a href="#l89.378"></a><span id="l89.378">   VObjectIterator i;</span>
<a href="#l89.379"></a><span id="l89.379" class="difflineminus">-  initPropIterator(&amp;i,o);</span>
<a href="#l89.380"></a><span id="l89.380" class="difflineplus">+  initPropIterator(&amp;i, o);</span>
<a href="#l89.381"></a><span id="l89.381">   while (moreIteration(&amp;i)) {</span>
<a href="#l89.382"></a><span id="l89.382">     VObject *each = nextVObject(&amp;i);</span>
<a href="#l89.383"></a><span id="l89.383" class="difflineminus">-    if (!PL_strcasecmp(id,each-&gt;id))</span>
<a href="#l89.384"></a><span id="l89.384" class="difflineminus">-        return each;</span>
<a href="#l89.385"></a><span id="l89.385" class="difflineplus">+    if (!PL_strcasecmp(id, each-&gt;id)) return each;</span>
<a href="#l89.386"></a><span id="l89.386">   }</span>
<a href="#l89.387"></a><span id="l89.387" class="difflineminus">-  return (VObject*)0;</span>
<a href="#l89.388"></a><span id="l89.388" class="difflineplus">+  return (VObject *)0;</span>
<a href="#l89.389"></a><span id="l89.389"> }</span>
<a href="#l89.390"></a><span id="l89.390"> </span>
<a href="#l89.391"></a><span id="l89.391" class="difflineminus">-VObject* addGroup(VObject *o, const char *g)</span>
<a href="#l89.392"></a><span id="l89.392" class="difflineminus">-{</span>
<a href="#l89.393"></a><span id="l89.393" class="difflineplus">+VObject *addGroup(VObject *o, const char *g) {</span>
<a href="#l89.394"></a><span id="l89.394">   /*</span>
<a href="#l89.395"></a><span id="l89.395">   a.b.c</span>
<a href="#l89.396"></a><span id="l89.396">   --&gt;</span>
<a href="#l89.397"></a><span id="l89.397">   prop(c)</span>
<a href="#l89.398"></a><span id="l89.398">   prop(VCGrouping=b)</span>
<a href="#l89.399"></a><span id="l89.399">   prop(VCGrouping=a)</span>
<a href="#l89.400"></a><span id="l89.400">   */</span>
<a href="#l89.401"></a><span id="l89.401" class="difflineminus">-  char *dot = PL_strrchr(g,'.');</span>
<a href="#l89.402"></a><span id="l89.402" class="difflineplus">+  char *dot = PL_strrchr(g, '.');</span>
<a href="#l89.403"></a><span id="l89.403">   if (dot) {</span>
<a href="#l89.404"></a><span id="l89.404">     VObject *p, *t;</span>
<a href="#l89.405"></a><span id="l89.405" class="difflineminus">-    char *gs, *n = dot+1;</span>
<a href="#l89.406"></a><span id="l89.406" class="difflineminus">-    gs = dupStr(g,0); /* so we can write to it. */</span>
<a href="#l89.407"></a><span id="l89.407" class="difflineminus">-    t = p = addProp_(o,lookupProp(n));</span>
<a href="#l89.408"></a><span id="l89.408" class="difflineminus">-    dot = PL_strrchr(gs,'.');</span>
<a href="#l89.409"></a><span id="l89.409" class="difflineplus">+    char *gs, *n = dot + 1;</span>
<a href="#l89.410"></a><span id="l89.410" class="difflineplus">+    gs = dupStr(g, 0); /* so we can write to it. */</span>
<a href="#l89.411"></a><span id="l89.411" class="difflineplus">+    t = p = addProp_(o, lookupProp(n));</span>
<a href="#l89.412"></a><span id="l89.412" class="difflineplus">+    dot = PL_strrchr(gs, '.');</span>
<a href="#l89.413"></a><span id="l89.413">     *dot = 0;</span>
<a href="#l89.414"></a><span id="l89.414">     do {</span>
<a href="#l89.415"></a><span id="l89.415" class="difflineminus">-        dot = PL_strrchr(gs,'.');</span>
<a href="#l89.416"></a><span id="l89.416" class="difflineminus">-        if (dot) {</span>
<a href="#l89.417"></a><span id="l89.417" class="difflineminus">-          n = dot+1;</span>
<a href="#l89.418"></a><span id="l89.418" class="difflineminus">-          *dot=0;</span>
<a href="#l89.419"></a><span id="l89.419" class="difflineminus">-        }</span>
<a href="#l89.420"></a><span id="l89.420" class="difflineminus">-        else</span>
<a href="#l89.421"></a><span id="l89.421" class="difflineminus">-          n = gs;</span>
<a href="#l89.422"></a><span id="l89.422" class="difflineminus">-        /* property(VCGroupingProp=n);</span>
<a href="#l89.423"></a><span id="l89.423" class="difflineminus">-         *  and the value may have VCGrouping property</span>
<a href="#l89.424"></a><span id="l89.424" class="difflineminus">-         */</span>
<a href="#l89.425"></a><span id="l89.425" class="difflineminus">-        t = addProp(t,VCGroupingProp);</span>
<a href="#l89.426"></a><span id="l89.426" class="difflineminus">-        setVObjectStringZValue(t,lookupProp_(n));</span>
<a href="#l89.427"></a><span id="l89.427" class="difflineplus">+      dot = PL_strrchr(gs, '.');</span>
<a href="#l89.428"></a><span id="l89.428" class="difflineplus">+      if (dot) {</span>
<a href="#l89.429"></a><span id="l89.429" class="difflineplus">+        n = dot + 1;</span>
<a href="#l89.430"></a><span id="l89.430" class="difflineplus">+        *dot = 0;</span>
<a href="#l89.431"></a><span id="l89.431" class="difflineplus">+      } else</span>
<a href="#l89.432"></a><span id="l89.432" class="difflineplus">+        n = gs;</span>
<a href="#l89.433"></a><span id="l89.433" class="difflineplus">+      /* property(VCGroupingProp=n);</span>
<a href="#l89.434"></a><span id="l89.434" class="difflineplus">+       *  and the value may have VCGrouping property</span>
<a href="#l89.435"></a><span id="l89.435" class="difflineplus">+       */</span>
<a href="#l89.436"></a><span id="l89.436" class="difflineplus">+      t = addProp(t, VCGroupingProp);</span>
<a href="#l89.437"></a><span id="l89.437" class="difflineplus">+      setVObjectStringZValue(t, lookupProp_(n));</span>
<a href="#l89.438"></a><span id="l89.438">     } while (n != gs);</span>
<a href="#l89.439"></a><span id="l89.439">     deleteString(gs);</span>
<a href="#l89.440"></a><span id="l89.440">     return p;</span>
<a href="#l89.441"></a><span id="l89.441" class="difflineminus">-  }</span>
<a href="#l89.442"></a><span id="l89.442" class="difflineminus">-  else</span>
<a href="#l89.443"></a><span id="l89.443" class="difflineminus">-    return addProp_(o,lookupProp(g));</span>
<a href="#l89.444"></a><span id="l89.444" class="difflineplus">+  } else</span>
<a href="#l89.445"></a><span id="l89.445" class="difflineplus">+    return addProp_(o, lookupProp(g));</span>
<a href="#l89.446"></a><span id="l89.446"> }</span>
<a href="#l89.447"></a><span id="l89.447"> </span>
<a href="#l89.448"></a><span id="l89.448" class="difflineminus">-VObject* addPropValue(VObject *o, const char *p, const char *v)</span>
<a href="#l89.449"></a><span id="l89.449" class="difflineminus">-{</span>
<a href="#l89.450"></a><span id="l89.450" class="difflineplus">+VObject *addPropValue(VObject *o, const char *p, const char *v) {</span>
<a href="#l89.451"></a><span id="l89.451">   VObject *prop;</span>
<a href="#l89.452"></a><span id="l89.452" class="difflineminus">-  prop = addProp(o,p);</span>
<a href="#l89.453"></a><span id="l89.453" class="difflineplus">+  prop = addProp(o, p);</span>
<a href="#l89.454"></a><span id="l89.454">   if (v) {</span>
<a href="#l89.455"></a><span id="l89.455" class="difflineminus">-    setVObjectUStringZValue_(prop, fakeUnicode(v,0));</span>
<a href="#l89.456"></a><span id="l89.456" class="difflineminus">-    if (needsQuotedPrintable (v)) {</span>
<a href="#l89.457"></a><span id="l89.457" class="difflineminus">-      if (PL_strcasecmp (VCCardProp, vObjectName(o)) == 0)</span>
<a href="#l89.458"></a><span id="l89.458" class="difflineminus">-        addProp (prop, VCQuotedPrintableProp);</span>
<a href="#l89.459"></a><span id="l89.459" class="difflineplus">+    setVObjectUStringZValue_(prop, fakeUnicode(v, 0));</span>
<a href="#l89.460"></a><span id="l89.460" class="difflineplus">+    if (needsQuotedPrintable(v)) {</span>
<a href="#l89.461"></a><span id="l89.461" class="difflineplus">+      if (PL_strcasecmp(VCCardProp, vObjectName(o)) == 0)</span>
<a href="#l89.462"></a><span id="l89.462" class="difflineplus">+        addProp(prop, VCQuotedPrintableProp);</span>
<a href="#l89.463"></a><span id="l89.463">       else</span>
<a href="#l89.464"></a><span id="l89.464" class="difflineminus">-        addProp (o, VCQuotedPrintableProp);</span>
<a href="#l89.465"></a><span id="l89.465" class="difflineplus">+        addProp(o, VCQuotedPrintableProp);</span>
<a href="#l89.466"></a><span id="l89.466">     }</span>
<a href="#l89.467"></a><span id="l89.467" class="difflineminus">-  }</span>
<a href="#l89.468"></a><span id="l89.468" class="difflineminus">-  else</span>
<a href="#l89.469"></a><span id="l89.469" class="difflineminus">-    setVObjectUStringZValue_(prop, fakeUnicode(&quot;&quot;,0));</span>
<a href="#l89.470"></a><span id="l89.470" class="difflineplus">+  } else</span>
<a href="#l89.471"></a><span id="l89.471" class="difflineplus">+    setVObjectUStringZValue_(prop, fakeUnicode(&quot;&quot;, 0));</span>
<a href="#l89.472"></a><span id="l89.472"> </span>
<a href="#l89.473"></a><span id="l89.473">   return prop;</span>
<a href="#l89.474"></a><span id="l89.474"> }</span>
<a href="#l89.475"></a><span id="l89.475"> </span>
<a href="#l89.476"></a><span id="l89.476" class="difflineminus">-VObject* addPropSizedValue_(VObject *o, const char *p, const char *v,</span>
<a href="#l89.477"></a><span id="l89.477" class="difflineminus">-  unsigned int size)</span>
<a href="#l89.478"></a><span id="l89.478" class="difflineminus">-{</span>
<a href="#l89.479"></a><span id="l89.479" class="difflineplus">+VObject *addPropSizedValue_(VObject *o, const char *p, const char *v,</span>
<a href="#l89.480"></a><span id="l89.480" class="difflineplus">+                            unsigned int size) {</span>
<a href="#l89.481"></a><span id="l89.481">   VObject *prop;</span>
<a href="#l89.482"></a><span id="l89.482" class="difflineminus">-  prop = addProp(o,p);</span>
<a href="#l89.483"></a><span id="l89.483" class="difflineminus">-  setValueWithSize_(prop, (void*)v, size);</span>
<a href="#l89.484"></a><span id="l89.484" class="difflineplus">+  prop = addProp(o, p);</span>
<a href="#l89.485"></a><span id="l89.485" class="difflineplus">+  setValueWithSize_(prop, (void *)v, size);</span>
<a href="#l89.486"></a><span id="l89.486">   return prop;</span>
<a href="#l89.487"></a><span id="l89.487"> }</span>
<a href="#l89.488"></a><span id="l89.488"> </span>
<a href="#l89.489"></a><span id="l89.489" class="difflineminus">-VObject* addPropSizedValue(VObject *o, const char *p, const char *v,</span>
<a href="#l89.490"></a><span id="l89.490" class="difflineminus">-  unsigned int size)</span>
<a href="#l89.491"></a><span id="l89.491" class="difflineminus">-{</span>
<a href="#l89.492"></a><span id="l89.492" class="difflineminus">-  return addPropSizedValue_(o,p,dupStr(v,size),size);</span>
<a href="#l89.493"></a><span id="l89.493" class="difflineplus">+VObject *addPropSizedValue(VObject *o, const char *p, const char *v,</span>
<a href="#l89.494"></a><span id="l89.494" class="difflineplus">+                           unsigned int size) {</span>
<a href="#l89.495"></a><span id="l89.495" class="difflineplus">+  return addPropSizedValue_(o, p, dupStr(v, size), size);</span>
<a href="#l89.496"></a><span id="l89.496"> }</span>
<a href="#l89.497"></a><span id="l89.497"> </span>
<a href="#l89.498"></a><span id="l89.498" class="difflineminus">-void cleanVObject(VObject *o)</span>
<a href="#l89.499"></a><span id="l89.499" class="difflineminus">-{</span>
<a href="#l89.500"></a><span id="l89.500" class="difflineplus">+void cleanVObject(VObject *o) {</span>
<a href="#l89.501"></a><span id="l89.501">   if (o == 0) return;</span>
<a href="#l89.502"></a><span id="l89.502">   if (o-&gt;prop) {</span>
<a href="#l89.503"></a><span id="l89.503">     /* destroy time: cannot use the iterator here.</span>
<a href="#l89.504"></a><span id="l89.504">        Have to break the cycle in the circular link</span>
<a href="#l89.505"></a><span id="l89.505">        list and turns it into regular NULL-terminated</span>
<a href="#l89.506"></a><span id="l89.506">        list -- since at some point of destruction,</span>
<a href="#l89.507"></a><span id="l89.507">        the reference entry for the iterator to work</span>
<a href="#l89.508"></a><span id="l89.508">        will not longer be valid.</span>
<a href="#l89.509"></a><span id="l89.509">      */</span>
<a href="#l89.510"></a><span id="l89.510">     VObject *p;</span>
<a href="#l89.511"></a><span id="l89.511">     p = o-&gt;prop-&gt;next;</span>
<a href="#l89.512"></a><span id="l89.512">     o-&gt;prop-&gt;next = 0;</span>
<a href="#l89.513"></a><span id="l89.513">     do {</span>
<a href="#l89.514"></a><span id="l89.514" class="difflineminus">-       VObject *t = p-&gt;next;</span>
<a href="#l89.515"></a><span id="l89.515" class="difflineminus">-       cleanVObject(p);</span>
<a href="#l89.516"></a><span id="l89.516" class="difflineminus">-       p = t;</span>
<a href="#l89.517"></a><span id="l89.517" class="difflineplus">+      VObject *t = p-&gt;next;</span>
<a href="#l89.518"></a><span id="l89.518" class="difflineplus">+      cleanVObject(p);</span>
<a href="#l89.519"></a><span id="l89.519" class="difflineplus">+      p = t;</span>
<a href="#l89.520"></a><span id="l89.520">     } while (p);</span>
<a href="#l89.521"></a><span id="l89.521">   }</span>
<a href="#l89.522"></a><span id="l89.522">   switch (VALUE_TYPE(o)) {</span>
<a href="#l89.523"></a><span id="l89.523" class="difflineminus">-  case VCVT_USTRINGZ:</span>
<a href="#l89.524"></a><span id="l89.524" class="difflineminus">-  case VCVT_STRINGZ:</span>
<a href="#l89.525"></a><span id="l89.525" class="difflineminus">-  case VCVT_RAW:</span>
<a href="#l89.526"></a><span id="l89.526" class="difflineminus">-    /* assume they are all allocated by malloc. */</span>
<a href="#l89.527"></a><span id="l89.527" class="difflineminus">-    if ((char*) STRINGZ_VALUE_OF(o))</span>
<a href="#l89.528"></a><span id="l89.528" class="difflineminus">-      PR_Free ((char*)STRINGZ_VALUE_OF(o));</span>
<a href="#l89.529"></a><span id="l89.529" class="difflineminus">-    break;</span>
<a href="#l89.530"></a><span id="l89.530" class="difflineminus">-  case VCVT_VOBJECT:</span>
<a href="#l89.531"></a><span id="l89.531" class="difflineminus">-    cleanVObject(VOBJECT_VALUE_OF(o));</span>
<a href="#l89.532"></a><span id="l89.532" class="difflineminus">-    break;</span>
<a href="#l89.533"></a><span id="l89.533" class="difflineplus">+    case VCVT_USTRINGZ:</span>
<a href="#l89.534"></a><span id="l89.534" class="difflineplus">+    case VCVT_STRINGZ:</span>
<a href="#l89.535"></a><span id="l89.535" class="difflineplus">+    case VCVT_RAW:</span>
<a href="#l89.536"></a><span id="l89.536" class="difflineplus">+      /* assume they are all allocated by malloc. */</span>
<a href="#l89.537"></a><span id="l89.537" class="difflineplus">+      if ((char *)STRINGZ_VALUE_OF(o)) PR_Free((char *)STRINGZ_VALUE_OF(o));</span>
<a href="#l89.538"></a><span id="l89.538" class="difflineplus">+      break;</span>
<a href="#l89.539"></a><span id="l89.539" class="difflineplus">+    case VCVT_VOBJECT:</span>
<a href="#l89.540"></a><span id="l89.540" class="difflineplus">+      cleanVObject(VOBJECT_VALUE_OF(o));</span>
<a href="#l89.541"></a><span id="l89.541" class="difflineplus">+      break;</span>
<a href="#l89.542"></a><span id="l89.542">   }</span>
<a href="#l89.543"></a><span id="l89.543">   deleteVObject(o);</span>
<a href="#l89.544"></a><span id="l89.544"> }</span>
<a href="#l89.545"></a><span id="l89.545"> </span>
<a href="#l89.546"></a><span id="l89.546" class="difflineminus">-void cleanVObjects(VObject *list)</span>
<a href="#l89.547"></a><span id="l89.547" class="difflineminus">-{</span>
<a href="#l89.548"></a><span id="l89.548" class="difflineplus">+void cleanVObjects(VObject *list) {</span>
<a href="#l89.549"></a><span id="l89.549">   while (list) {</span>
<a href="#l89.550"></a><span id="l89.550">     VObject *t = list;</span>
<a href="#l89.551"></a><span id="l89.551">     list = nextVObjectInList(list);</span>
<a href="#l89.552"></a><span id="l89.552">     cleanVObject(t);</span>
<a href="#l89.553"></a><span id="l89.553">   }</span>
<a href="#l89.554"></a><span id="l89.554"> }</span>
<a href="#l89.555"></a><span id="l89.555"> </span>
<a href="#l89.556"></a><span id="l89.556"> /*----------------------------------------------------------------------</span>
<a href="#l89.557"></a><span id="l89.557">   The following is a String Table Facilities.</span>
<a href="#l89.558"></a><span id="l89.558">   ----------------------------------------------------------------------*/</span>
<a href="#l89.559"></a><span id="l89.559"> </span>
<a href="#l89.560"></a><span id="l89.560"> #define STRTBLSIZE 255</span>
<a href="#l89.561"></a><span id="l89.561"> </span>
<a href="#l89.562"></a><span id="l89.562"> static StrItem *strTbl[STRTBLSIZE];</span>
<a href="#l89.563"></a><span id="l89.563"> </span>
<a href="#l89.564"></a><span id="l89.564" class="difflineminus">-static unsigned int hashStr(const char *s)</span>
<a href="#l89.565"></a><span id="l89.565" class="difflineminus">-{</span>
<a href="#l89.566"></a><span id="l89.566" class="difflineplus">+static unsigned int hashStr(const char *s) {</span>
<a href="#l89.567"></a><span id="l89.567">   unsigned int h = 0;</span>
<a href="#l89.568"></a><span id="l89.568">   int i;</span>
<a href="#l89.569"></a><span id="l89.569" class="difflineminus">-  for (i=0;s[i];i++) {</span>
<a href="#l89.570"></a><span id="l89.570" class="difflineminus">-    h += s[i]*i;</span>
<a href="#l89.571"></a><span id="l89.571" class="difflineplus">+  for (i = 0; s[i]; i++) {</span>
<a href="#l89.572"></a><span id="l89.572" class="difflineplus">+    h += s[i] * i;</span>
<a href="#l89.573"></a><span id="l89.573">   }</span>
<a href="#l89.574"></a><span id="l89.574">   return h % STRTBLSIZE;</span>
<a href="#l89.575"></a><span id="l89.575"> }</span>
<a href="#l89.576"></a><span id="l89.576"> </span>
<a href="#l89.577"></a><span id="l89.577" class="difflineminus">-void unUseStr(const char *s)</span>
<a href="#l89.578"></a><span id="l89.578" class="difflineminus">-{</span>
<a href="#l89.579"></a><span id="l89.579" class="difflineplus">+void unUseStr(const char *s) {</span>
<a href="#l89.580"></a><span id="l89.580">   StrItem *t, *p;</span>
<a href="#l89.581"></a><span id="l89.581">   unsigned int h = hashStr(s);</span>
<a href="#l89.582"></a><span id="l89.582">   if ((t = strTbl[h]) != 0) {</span>
<a href="#l89.583"></a><span id="l89.583">     p = t;</span>
<a href="#l89.584"></a><span id="l89.584">     do {</span>
<a href="#l89.585"></a><span id="l89.585" class="difflineminus">-      if (PL_strcasecmp(t-&gt;s,s) == 0) {</span>
<a href="#l89.586"></a><span id="l89.586" class="difflineplus">+      if (PL_strcasecmp(t-&gt;s, s) == 0) {</span>
<a href="#l89.587"></a><span id="l89.587">         t-&gt;refCnt--;</span>
<a href="#l89.588"></a><span id="l89.588">         if (t-&gt;refCnt == 0) {</span>
<a href="#l89.589"></a><span id="l89.589">           if (t == strTbl[h]) {</span>
<a href="#l89.590"></a><span id="l89.590">             strTbl[h] = t-&gt;next;</span>
<a href="#l89.591"></a><span id="l89.591" class="difflineminus">-          }</span>
<a href="#l89.592"></a><span id="l89.592" class="difflineminus">-          else {</span>
<a href="#l89.593"></a><span id="l89.593" class="difflineplus">+          } else {</span>
<a href="#l89.594"></a><span id="l89.594">             p-&gt;next = t-&gt;next;</span>
<a href="#l89.595"></a><span id="l89.595">           }</span>
<a href="#l89.596"></a><span id="l89.596">           deleteString((char *)t-&gt;s);</span>
<a href="#l89.597"></a><span id="l89.597">           deleteStrItem(t);</span>
<a href="#l89.598"></a><span id="l89.598">           return;</span>
<a href="#l89.599"></a><span id="l89.599">         }</span>
<a href="#l89.600"></a><span id="l89.600">       }</span>
<a href="#l89.601"></a><span id="l89.601">       p = t;</span>
<a href="#l89.602"></a><span id="l89.602">       t = t-&gt;next;</span>
<a href="#l89.603"></a><span id="l89.603">     } while (t);</span>
<a href="#l89.604"></a><span id="l89.604">   }</span>
<a href="#l89.605"></a><span id="l89.605"> }</span>
<a href="#l89.606"></a><span id="l89.606"> </span>
<a href="#l89.607"></a><span id="l89.607"> struct PreDefProp {</span>
<a href="#l89.608"></a><span id="l89.608">   const char *name;</span>
<a href="#l89.609"></a><span id="l89.609">   const char *alias;</span>
<a href="#l89.610"></a><span id="l89.610" class="difflineminus">-  const char** fields;</span>
<a href="#l89.611"></a><span id="l89.611" class="difflineplus">+  const char **fields;</span>
<a href="#l89.612"></a><span id="l89.612">   unsigned int flags;</span>
<a href="#l89.613"></a><span id="l89.613"> };</span>
<a href="#l89.614"></a><span id="l89.614"> </span>
<a href="#l89.615"></a><span id="l89.615"> /* flags in PreDefProp */</span>
<a href="#l89.616"></a><span id="l89.616" class="difflineminus">-#define PD_BEGIN  0x1</span>
<a href="#l89.617"></a><span id="l89.617" class="difflineplus">+#define PD_BEGIN 0x1</span>
<a href="#l89.618"></a><span id="l89.618"> #define PD_INTERNAL 0x2</span>
<a href="#l89.619"></a><span id="l89.619"> </span>
<a href="#l89.620"></a><span id="l89.620"> static const char *adrFields[] = {</span>
<a href="#l89.621"></a><span id="l89.621" class="difflineminus">-  VCPostalBoxProp,</span>
<a href="#l89.622"></a><span id="l89.622" class="difflineminus">-  VCExtAddressProp,</span>
<a href="#l89.623"></a><span id="l89.623" class="difflineminus">-  VCStreetAddressProp,</span>
<a href="#l89.624"></a><span id="l89.624" class="difflineminus">-  VCCityProp,</span>
<a href="#l89.625"></a><span id="l89.625" class="difflineminus">-  VCRegionProp,</span>
<a href="#l89.626"></a><span id="l89.626" class="difflineminus">-  VCPostalCodeProp,</span>
<a href="#l89.627"></a><span id="l89.627" class="difflineminus">-  VCCountryNameProp,</span>
<a href="#l89.628"></a><span id="l89.628" class="difflineminus">-  0</span>
<a href="#l89.629"></a><span id="l89.629" class="difflineminus">-};</span>
<a href="#l89.630"></a><span id="l89.630" class="difflineplus">+    VCPostalBoxProp, VCExtAddressProp, VCStreetAddressProp, VCCityProp,</span>
<a href="#l89.631"></a><span id="l89.631" class="difflineplus">+    VCRegionProp,    VCPostalCodeProp, VCCountryNameProp,   0};</span>
<a href="#l89.632"></a><span id="l89.632"> </span>
<a href="#l89.633"></a><span id="l89.633" class="difflineminus">-static const char *nameFields[] = {</span>
<a href="#l89.634"></a><span id="l89.634" class="difflineminus">-  VCFamilyNameProp,</span>
<a href="#l89.635"></a><span id="l89.635" class="difflineminus">-  VCGivenNameProp,</span>
<a href="#l89.636"></a><span id="l89.636" class="difflineminus">-  VCAdditionalNamesProp,</span>
<a href="#l89.637"></a><span id="l89.637" class="difflineminus">-  VCNamePrefixesProp,</span>
<a href="#l89.638"></a><span id="l89.638" class="difflineminus">-  VCNameSuffixesProp,</span>
<a href="#l89.639"></a><span id="l89.639" class="difflineminus">-  NULL</span>
<a href="#l89.640"></a><span id="l89.640" class="difflineminus">-};</span>
<a href="#l89.641"></a><span id="l89.641" class="difflineplus">+static const char *nameFields[] = {VCFamilyNameProp,      VCGivenNameProp,</span>
<a href="#l89.642"></a><span id="l89.642" class="difflineplus">+                                   VCAdditionalNamesProp, VCNamePrefixesProp,</span>
<a href="#l89.643"></a><span id="l89.643" class="difflineplus">+                                   VCNameSuffixesProp,    NULL};</span>
<a href="#l89.644"></a><span id="l89.644"> </span>
<a href="#l89.645"></a><span id="l89.645" class="difflineminus">-static const char *orgFields[] = {</span>
<a href="#l89.646"></a><span id="l89.646" class="difflineminus">-  VCOrgNameProp,</span>
<a href="#l89.647"></a><span id="l89.647" class="difflineminus">-  VCOrgUnitProp,</span>
<a href="#l89.648"></a><span id="l89.648" class="difflineminus">-  VCOrgUnit2Prop,</span>
<a href="#l89.649"></a><span id="l89.649" class="difflineminus">-  VCOrgUnit3Prop,</span>
<a href="#l89.650"></a><span id="l89.650" class="difflineminus">-  VCOrgUnit4Prop,</span>
<a href="#l89.651"></a><span id="l89.651" class="difflineminus">-  NULL</span>
<a href="#l89.652"></a><span id="l89.652" class="difflineminus">-};</span>
<a href="#l89.653"></a><span id="l89.653" class="difflineplus">+static const char *orgFields[] = {VCOrgNameProp,  VCOrgUnitProp,</span>
<a href="#l89.654"></a><span id="l89.654" class="difflineplus">+                                  VCOrgUnit2Prop, VCOrgUnit3Prop,</span>
<a href="#l89.655"></a><span id="l89.655" class="difflineplus">+                                  VCOrgUnit4Prop, NULL};</span>
<a href="#l89.656"></a><span id="l89.656"> </span>
<a href="#l89.657"></a><span id="l89.657" class="difflineminus">-static const char *AAlarmFields[] = {</span>
<a href="#l89.658"></a><span id="l89.658" class="difflineminus">-  VCRunTimeProp,</span>
<a href="#l89.659"></a><span id="l89.659" class="difflineminus">-  VCSnoozeTimeProp,</span>
<a href="#l89.660"></a><span id="l89.660" class="difflineminus">-  VCRepeatCountProp,</span>
<a href="#l89.661"></a><span id="l89.661" class="difflineminus">-  VCAudioContentProp,</span>
<a href="#l89.662"></a><span id="l89.662" class="difflineminus">-  0</span>
<a href="#l89.663"></a><span id="l89.663" class="difflineminus">-};</span>
<a href="#l89.664"></a><span id="l89.664" class="difflineplus">+static const char *AAlarmFields[] = {VCRunTimeProp, VCSnoozeTimeProp,</span>
<a href="#l89.665"></a><span id="l89.665" class="difflineplus">+                                     VCRepeatCountProp, VCAudioContentProp, 0};</span>
<a href="#l89.666"></a><span id="l89.666"> </span>
<a href="#l89.667"></a><span id="l89.667" class="difflineminus">-static const char *coolTalkFields[] = {</span>
<a href="#l89.668"></a><span id="l89.668" class="difflineminus">-  VCCooltalkAddress,</span>
<a href="#l89.669"></a><span id="l89.669" class="difflineminus">-  VCUseServer,</span>
<a href="#l89.670"></a><span id="l89.670" class="difflineminus">-  0</span>
<a href="#l89.671"></a><span id="l89.671" class="difflineminus">-};</span>
<a href="#l89.672"></a><span id="l89.672" class="difflineplus">+static const char *coolTalkFields[] = {VCCooltalkAddress, VCUseServer, 0};</span>
<a href="#l89.673"></a><span id="l89.673"> </span>
<a href="#l89.674"></a><span id="l89.674"> /* ExDate -- has unnamed fields */</span>
<a href="#l89.675"></a><span id="l89.675"> /* RDate -- has unnamed fields */</span>
<a href="#l89.676"></a><span id="l89.676"> </span>
<a href="#l89.677"></a><span id="l89.677" class="difflineminus">-static const char *DAlarmFields[] = {</span>
<a href="#l89.678"></a><span id="l89.678" class="difflineminus">-  VCRunTimeProp,</span>
<a href="#l89.679"></a><span id="l89.679" class="difflineminus">-  VCSnoozeTimeProp,</span>
<a href="#l89.680"></a><span id="l89.680" class="difflineminus">-  VCRepeatCountProp,</span>
<a href="#l89.681"></a><span id="l89.681" class="difflineminus">-  VCDisplayStringProp,</span>
<a href="#l89.682"></a><span id="l89.682" class="difflineminus">-  0</span>
<a href="#l89.683"></a><span id="l89.683" class="difflineminus">-};</span>
<a href="#l89.684"></a><span id="l89.684" class="difflineplus">+static const char *DAlarmFields[] = {VCRunTimeProp, VCSnoozeTimeProp,</span>
<a href="#l89.685"></a><span id="l89.685" class="difflineplus">+                                     VCRepeatCountProp, VCDisplayStringProp, 0};</span>
<a href="#l89.686"></a><span id="l89.686"> </span>
<a href="#l89.687"></a><span id="l89.687" class="difflineminus">-static const char *MAlarmFields[] = {</span>
<a href="#l89.688"></a><span id="l89.688" class="difflineminus">-  VCRunTimeProp,</span>
<a href="#l89.689"></a><span id="l89.689" class="difflineminus">-  VCSnoozeTimeProp,</span>
<a href="#l89.690"></a><span id="l89.690" class="difflineminus">-  VCRepeatCountProp,</span>
<a href="#l89.691"></a><span id="l89.691" class="difflineminus">-  VCEmailAddressProp,</span>
<a href="#l89.692"></a><span id="l89.692" class="difflineminus">-  VCNoteProp,</span>
<a href="#l89.693"></a><span id="l89.693" class="difflineminus">-  0</span>
<a href="#l89.694"></a><span id="l89.694" class="difflineminus">-};</span>
<a href="#l89.695"></a><span id="l89.695" class="difflineplus">+static const char *MAlarmFields[] = {VCRunTimeProp,     VCSnoozeTimeProp,</span>
<a href="#l89.696"></a><span id="l89.696" class="difflineplus">+                                     VCRepeatCountProp, VCEmailAddressProp,</span>
<a href="#l89.697"></a><span id="l89.697" class="difflineplus">+                                     VCNoteProp,        0};</span>
<a href="#l89.698"></a><span id="l89.698"> </span>
<a href="#l89.699"></a><span id="l89.699" class="difflineminus">-static const char *PAlarmFields[] = {</span>
<a href="#l89.700"></a><span id="l89.700" class="difflineminus">-  VCRunTimeProp,</span>
<a href="#l89.701"></a><span id="l89.701" class="difflineminus">-  VCSnoozeTimeProp,</span>
<a href="#l89.702"></a><span id="l89.702" class="difflineminus">-  VCRepeatCountProp,</span>
<a href="#l89.703"></a><span id="l89.703" class="difflineminus">-  VCProcedureNameProp,</span>
<a href="#l89.704"></a><span id="l89.704" class="difflineminus">-  0</span>
<a href="#l89.705"></a><span id="l89.705" class="difflineminus">-};</span>
<a href="#l89.706"></a><span id="l89.706" class="difflineplus">+static const char *PAlarmFields[] = {VCRunTimeProp, VCSnoozeTimeProp,</span>
<a href="#l89.707"></a><span id="l89.707" class="difflineplus">+                                     VCRepeatCountProp, VCProcedureNameProp, 0};</span>
<a href="#l89.708"></a><span id="l89.708"> </span>
<a href="#l89.709"></a><span id="l89.709" class="difflineplus">+// clang-format off</span>
<a href="#l89.710"></a><span id="l89.710"> static struct PreDefProp propNames[] = {</span>
<a href="#l89.711"></a><span id="l89.711" class="difflineminus">-  { VC7bitProp, 0, 0, 0 },</span>
<a href="#l89.712"></a><span id="l89.712" class="difflineminus">-  { VC8bitProp, 0, 0, 0 },</span>
<a href="#l89.713"></a><span id="l89.713" class="difflineminus">-  { VCAAlarmProp, 0, AAlarmFields, 0 },</span>
<a href="#l89.714"></a><span id="l89.714" class="difflineminus">-  { VCAdditionalNamesProp, 0, 0, 0 },</span>
<a href="#l89.715"></a><span id="l89.715" class="difflineminus">-  { VCAdrProp, 0, adrFields, 0 },</span>
<a href="#l89.716"></a><span id="l89.716" class="difflineminus">-  { VCAgentProp, 0, 0, 0 },</span>
<a href="#l89.717"></a><span id="l89.717" class="difflineminus">-  { VCAIFFProp, 0, 0, 0 },</span>
<a href="#l89.718"></a><span id="l89.718" class="difflineminus">-  { VCAOLProp, 0, 0, 0 },</span>
<a href="#l89.719"></a><span id="l89.719" class="difflineminus">-  { VCAppleLinkProp, 0, 0, 0 },</span>
<a href="#l89.720"></a><span id="l89.720" class="difflineminus">-  { VCAttachProp, 0, 0, 0 },</span>
<a href="#l89.721"></a><span id="l89.721" class="difflineminus">-  { VCAttendeeProp, 0, 0, 0 },</span>
<a href="#l89.722"></a><span id="l89.722" class="difflineminus">-  { VCATTMailProp, 0, 0, 0 },</span>
<a href="#l89.723"></a><span id="l89.723" class="difflineminus">-  { VCAudioContentProp, 0, 0, 0 },</span>
<a href="#l89.724"></a><span id="l89.724" class="difflineminus">-  { VCAVIProp, 0, 0, 0 },</span>
<a href="#l89.725"></a><span id="l89.725" class="difflineminus">-  { VCBase64Prop, 0, 0, 0 },</span>
<a href="#l89.726"></a><span id="l89.726" class="difflineminus">-  { VCBBSProp, 0, 0, 0 },</span>
<a href="#l89.727"></a><span id="l89.727" class="difflineminus">-  { VCBirthDateProp, 0, 0, 0 },</span>
<a href="#l89.728"></a><span id="l89.728" class="difflineminus">-  { VCBMPProp, 0, 0, 0 },</span>
<a href="#l89.729"></a><span id="l89.729" class="difflineminus">-  { VCBodyProp, 0, 0, 0 },</span>
<a href="#l89.730"></a><span id="l89.730" class="difflineminus">-  { VCBusinessRoleProp, 0, 0, 0 },</span>
<a href="#l89.731"></a><span id="l89.731" class="difflineminus">-  { VCCalProp, 0, 0, PD_BEGIN },</span>
<a href="#l89.732"></a><span id="l89.732" class="difflineminus">-  { VCCaptionProp, 0, 0, 0 },</span>
<a href="#l89.733"></a><span id="l89.733" class="difflineminus">-  { VCCardProp, 0, 0, PD_BEGIN },</span>
<a href="#l89.734"></a><span id="l89.734" class="difflineminus">-  { VCCarProp, 0, 0, 0 },</span>
<a href="#l89.735"></a><span id="l89.735" class="difflineminus">-  { VCCategoriesProp, 0, 0, 0 },</span>
<a href="#l89.736"></a><span id="l89.736" class="difflineminus">-  { VCCellularProp, 0, 0, 0 },</span>
<a href="#l89.737"></a><span id="l89.737" class="difflineminus">-  { VCCGMProp, 0, 0, 0 },</span>
<a href="#l89.738"></a><span id="l89.738" class="difflineminus">-  { VCCharSetProp, 0, 0, 0 },</span>
<a href="#l89.739"></a><span id="l89.739" class="difflineminus">-  { VCCIDProp, VCContentIDProp, 0, 0 },</span>
<a href="#l89.740"></a><span id="l89.740" class="difflineminus">-  { VCCISProp, 0, 0, 0 },</span>
<a href="#l89.741"></a><span id="l89.741" class="difflineminus">-  { VCCityProp, 0, 0, 0 },</span>
<a href="#l89.742"></a><span id="l89.742" class="difflineminus">-  { VCClassProp, 0, 0, 0 },</span>
<a href="#l89.743"></a><span id="l89.743" class="difflineminus">-  { VCCommentProp, 0, 0, 0 },</span>
<a href="#l89.744"></a><span id="l89.744" class="difflineminus">-  { VCCompletedProp, 0, 0, 0 },</span>
<a href="#l89.745"></a><span id="l89.745" class="difflineminus">-  { VCContentIDProp, 0, 0, 0 },</span>
<a href="#l89.746"></a><span id="l89.746" class="difflineminus">-  { VCCountryNameProp, 0, 0, 0 },</span>
<a href="#l89.747"></a><span id="l89.747" class="difflineminus">-  { VCDAlarmProp, 0, DAlarmFields, 0 },</span>
<a href="#l89.748"></a><span id="l89.748" class="difflineminus">-  { VCDataSizeProp, 0, 0, PD_INTERNAL },</span>
<a href="#l89.749"></a><span id="l89.749" class="difflineminus">-  { VCDayLightProp, 0, 0 ,0 },</span>
<a href="#l89.750"></a><span id="l89.750" class="difflineminus">-  { VCDCreatedProp, 0, 0, 0 },</span>
<a href="#l89.751"></a><span id="l89.751" class="difflineminus">-  { VCDeliveryLabelProp, 0, 0, 0 },</span>
<a href="#l89.752"></a><span id="l89.752" class="difflineminus">-  { VCDescriptionProp, 0, 0, 0 },</span>
<a href="#l89.753"></a><span id="l89.753" class="difflineminus">-  { VCDIBProp, 0, 0, 0 },</span>
<a href="#l89.754"></a><span id="l89.754" class="difflineminus">-  { VCDisplayStringProp, 0, 0, 0 },</span>
<a href="#l89.755"></a><span id="l89.755" class="difflineminus">-  { VCDomesticProp, 0, 0, 0 },</span>
<a href="#l89.756"></a><span id="l89.756" class="difflineminus">-  { VCDTendProp, 0, 0, 0 },</span>
<a href="#l89.757"></a><span id="l89.757" class="difflineminus">-  { VCDTstartProp, 0, 0, 0 },</span>
<a href="#l89.758"></a><span id="l89.758" class="difflineminus">-  { VCDueProp, 0, 0, 0 },</span>
<a href="#l89.759"></a><span id="l89.759" class="difflineminus">-  { VCEmailAddressProp, 0, 0, 0 },</span>
<a href="#l89.760"></a><span id="l89.760" class="difflineminus">-  { VCEncodingProp, 0, 0, 0 },</span>
<a href="#l89.761"></a><span id="l89.761" class="difflineminus">-  { VCEndProp, 0, 0, 0 },</span>
<a href="#l89.762"></a><span id="l89.762" class="difflineminus">-  { VCEventProp, 0, 0, PD_BEGIN },</span>
<a href="#l89.763"></a><span id="l89.763" class="difflineminus">-  { VCEWorldProp, 0, 0, 0 },</span>
<a href="#l89.764"></a><span id="l89.764" class="difflineminus">-  { VCExNumProp, 0, 0, 0 },</span>
<a href="#l89.765"></a><span id="l89.765" class="difflineminus">-  { VCExpDateProp, 0, 0, 0 },</span>
<a href="#l89.766"></a><span id="l89.766" class="difflineminus">-  { VCExpectProp, 0, 0, 0 },</span>
<a href="#l89.767"></a><span id="l89.767" class="difflineminus">-  { VCExtAddressProp, 0, 0, 0 },</span>
<a href="#l89.768"></a><span id="l89.768" class="difflineminus">-  { VCFamilyNameProp, 0, 0, 0 },</span>
<a href="#l89.769"></a><span id="l89.769" class="difflineminus">-  { VCFaxProp, 0, 0, 0 },</span>
<a href="#l89.770"></a><span id="l89.770" class="difflineminus">-  { VCFullNameProp, 0, 0, 0 },</span>
<a href="#l89.771"></a><span id="l89.771" class="difflineminus">-  { VCGeoLocationProp, 0, 0, 0 },</span>
<a href="#l89.772"></a><span id="l89.772" class="difflineminus">-  { VCGeoProp, 0, 0, 0 },</span>
<a href="#l89.773"></a><span id="l89.773" class="difflineminus">-  { VCGIFProp, 0, 0, 0 },</span>
<a href="#l89.774"></a><span id="l89.774" class="difflineminus">-  { VCGivenNameProp, 0, 0, 0 },</span>
<a href="#l89.775"></a><span id="l89.775" class="difflineminus">-  { VCGroupingProp, 0, 0, 0 },</span>
<a href="#l89.776"></a><span id="l89.776" class="difflineminus">-  { VCHomeProp, 0, 0, 0 },</span>
<a href="#l89.777"></a><span id="l89.777" class="difflineminus">-  { VCIBMMailProp, 0, 0, 0 },</span>
<a href="#l89.778"></a><span id="l89.778" class="difflineminus">-  { VCInlineProp, 0, 0, 0 },</span>
<a href="#l89.779"></a><span id="l89.779" class="difflineminus">-  { VCInternationalProp, 0, 0, 0 },</span>
<a href="#l89.780"></a><span id="l89.780" class="difflineminus">-  { VCInternetProp, 0, 0, 0 },</span>
<a href="#l89.781"></a><span id="l89.781" class="difflineminus">-  { VCISDNProp, 0, 0, 0 },</span>
<a href="#l89.782"></a><span id="l89.782" class="difflineminus">-  { VCJPEGProp, 0, 0, 0 },</span>
<a href="#l89.783"></a><span id="l89.783" class="difflineminus">-  { VCLanguageProp, 0, 0, 0 },</span>
<a href="#l89.784"></a><span id="l89.784" class="difflineminus">-  { VCLastModifiedProp, 0, 0, 0 },</span>
<a href="#l89.785"></a><span id="l89.785" class="difflineminus">-  { VCLastRevisedProp, 0, 0, 0 },</span>
<a href="#l89.786"></a><span id="l89.786" class="difflineminus">-  { VCLocationProp, 0, 0, 0 },</span>
<a href="#l89.787"></a><span id="l89.787" class="difflineminus">-  { VCLogoProp, 0, 0, 0 },</span>
<a href="#l89.788"></a><span id="l89.788" class="difflineminus">-  { VCMailerProp, 0, 0, 0 },</span>
<a href="#l89.789"></a><span id="l89.789" class="difflineminus">-  { VCMAlarmProp, 0, MAlarmFields, 0 },</span>
<a href="#l89.790"></a><span id="l89.790" class="difflineminus">-  { VCMCIMailProp, 0, 0, 0 },</span>
<a href="#l89.791"></a><span id="l89.791" class="difflineminus">-  { VCMessageProp, 0, 0, 0 },</span>
<a href="#l89.792"></a><span id="l89.792" class="difflineminus">-  { VCMETProp, 0, 0, 0 },</span>
<a href="#l89.793"></a><span id="l89.793" class="difflineminus">-  { VCModemProp, 0, 0, 0 },</span>
<a href="#l89.794"></a><span id="l89.794" class="difflineminus">-  { VCMPEG2Prop, 0, 0, 0 },</span>
<a href="#l89.795"></a><span id="l89.795" class="difflineminus">-  { VCMPEGProp, 0, 0, 0 },</span>
<a href="#l89.796"></a><span id="l89.796" class="difflineminus">-  { VCMSNProp, 0, 0, 0 },</span>
<a href="#l89.797"></a><span id="l89.797" class="difflineminus">-  { VCNamePrefixesProp, 0, 0, 0 },</span>
<a href="#l89.798"></a><span id="l89.798" class="difflineminus">-  { VCNameProp, 0, nameFields, 0 },</span>
<a href="#l89.799"></a><span id="l89.799" class="difflineminus">-  { VCNameSuffixesProp, 0, 0, 0 },</span>
<a href="#l89.800"></a><span id="l89.800" class="difflineminus">-  { VCNoteProp, 0, 0, 0 },</span>
<a href="#l89.801"></a><span id="l89.801" class="difflineminus">-  { VCOrgNameProp, 0, 0, 0 },</span>
<a href="#l89.802"></a><span id="l89.802" class="difflineminus">-  { VCOrgProp, 0, orgFields, 0 },</span>
<a href="#l89.803"></a><span id="l89.803" class="difflineminus">-  { VCOrgUnit2Prop, 0, 0, 0 },</span>
<a href="#l89.804"></a><span id="l89.804" class="difflineminus">-  { VCOrgUnit3Prop, 0, 0, 0 },</span>
<a href="#l89.805"></a><span id="l89.805" class="difflineminus">-  { VCOrgUnit4Prop, 0, 0, 0 },</span>
<a href="#l89.806"></a><span id="l89.806" class="difflineminus">-  { VCOrgUnitProp, 0, 0, 0 },</span>
<a href="#l89.807"></a><span id="l89.807" class="difflineminus">-  { VCPagerProp, 0, 0, 0 },</span>
<a href="#l89.808"></a><span id="l89.808" class="difflineminus">-  { VCPAlarmProp, 0, PAlarmFields, 0 },</span>
<a href="#l89.809"></a><span id="l89.809" class="difflineminus">-  { VCParcelProp, 0, 0, 0 },</span>
<a href="#l89.810"></a><span id="l89.810" class="difflineminus">-  { VCPartProp, 0, 0, 0 },</span>
<a href="#l89.811"></a><span id="l89.811" class="difflineminus">-  { VCPCMProp, 0, 0, 0 },</span>
<a href="#l89.812"></a><span id="l89.812" class="difflineminus">-  { VCPDFProp, 0, 0, 0 },</span>
<a href="#l89.813"></a><span id="l89.813" class="difflineminus">-  { VCPGPProp, 0, 0, 0 },</span>
<a href="#l89.814"></a><span id="l89.814" class="difflineminus">-  { VCPhotoProp, 0, 0, 0 },</span>
<a href="#l89.815"></a><span id="l89.815" class="difflineminus">-  { VCPICTProp, 0, 0, 0 },</span>
<a href="#l89.816"></a><span id="l89.816" class="difflineminus">-  { VCPMBProp, 0, 0, 0 },</span>
<a href="#l89.817"></a><span id="l89.817" class="difflineminus">-  { VCPostalBoxProp, 0, 0, 0 },</span>
<a href="#l89.818"></a><span id="l89.818" class="difflineminus">-  { VCPostalCodeProp, 0, 0, 0 },</span>
<a href="#l89.819"></a><span id="l89.819" class="difflineminus">-  { VCPostalProp, 0, 0, 0 },</span>
<a href="#l89.820"></a><span id="l89.820" class="difflineminus">-  { VCPowerShareProp, 0, 0, 0 },</span>
<a href="#l89.821"></a><span id="l89.821" class="difflineminus">-  { VCPreferredProp, 0, 0, 0 },</span>
<a href="#l89.822"></a><span id="l89.822" class="difflineminus">-  { VCPriorityProp, 0, 0, 0 },</span>
<a href="#l89.823"></a><span id="l89.823" class="difflineminus">-  { VCProcedureNameProp, 0, 0, 0 },</span>
<a href="#l89.824"></a><span id="l89.824" class="difflineminus">-  { VCProdIdProp, 0, 0, 0 },</span>
<a href="#l89.825"></a><span id="l89.825" class="difflineminus">-  { VCProdigyProp, 0, 0, 0 },</span>
<a href="#l89.826"></a><span id="l89.826" class="difflineminus">-  { VCPronunciationProp, 0, 0, 0 },</span>
<a href="#l89.827"></a><span id="l89.827" class="difflineminus">-  { VCPSProp, 0, 0, 0 },</span>
<a href="#l89.828"></a><span id="l89.828" class="difflineminus">-  { VCPublicKeyProp, 0, 0, 0 },</span>
<a href="#l89.829"></a><span id="l89.829" class="difflineminus">-  { VCQPProp, VCQuotedPrintableProp, 0, 0 },</span>
<a href="#l89.830"></a><span id="l89.830" class="difflineminus">-  { VCQuickTimeProp, 0, 0, 0 },</span>
<a href="#l89.831"></a><span id="l89.831" class="difflineminus">-  { VCQuotedPrintableProp, 0, 0, 0 },</span>
<a href="#l89.832"></a><span id="l89.832" class="difflineminus">-  { VCRDateProp, 0, 0, 0 },</span>
<a href="#l89.833"></a><span id="l89.833" class="difflineminus">-  { VCRegionProp, 0, 0, 0 },</span>
<a href="#l89.834"></a><span id="l89.834" class="difflineminus">-  { VCRelatedToProp, 0, 0, 0 },</span>
<a href="#l89.835"></a><span id="l89.835" class="difflineminus">-  { VCRepeatCountProp, 0, 0, 0 },</span>
<a href="#l89.836"></a><span id="l89.836" class="difflineminus">-  { VCResourcesProp, 0, 0, 0 },</span>
<a href="#l89.837"></a><span id="l89.837" class="difflineminus">-  { VCRNumProp, 0, 0, 0 },</span>
<a href="#l89.838"></a><span id="l89.838" class="difflineminus">-  { VCRoleProp, 0, 0, 0 },</span>
<a href="#l89.839"></a><span id="l89.839" class="difflineminus">-  { VCRRuleProp, 0, 0, 0 },</span>
<a href="#l89.840"></a><span id="l89.840" class="difflineminus">-  { VCRSVPProp, 0, 0, 0 },</span>
<a href="#l89.841"></a><span id="l89.841" class="difflineminus">-  { VCRunTimeProp, 0, 0, 0 },</span>
<a href="#l89.842"></a><span id="l89.842" class="difflineminus">-  { VCSequenceProp, 0, 0, 0 },</span>
<a href="#l89.843"></a><span id="l89.843" class="difflineminus">-  { VCSnoozeTimeProp, 0, 0, 0 },</span>
<a href="#l89.844"></a><span id="l89.844" class="difflineminus">-  { VCStartProp, 0, 0, 0 },</span>
<a href="#l89.845"></a><span id="l89.845" class="difflineminus">-  { VCStatusProp, 0, 0, 0 },</span>
<a href="#l89.846"></a><span id="l89.846" class="difflineminus">-  { VCStreetAddressProp, 0, 0, 0 },</span>
<a href="#l89.847"></a><span id="l89.847" class="difflineminus">-  { VCSubTypeProp, 0, 0, 0 },</span>
<a href="#l89.848"></a><span id="l89.848" class="difflineminus">-  { VCSummaryProp, 0, 0, 0 },</span>
<a href="#l89.849"></a><span id="l89.849" class="difflineminus">-  { VCTelephoneProp, 0, 0, 0 },</span>
<a href="#l89.850"></a><span id="l89.850" class="difflineminus">-  { VCTIFFProp, 0, 0, 0 },</span>
<a href="#l89.851"></a><span id="l89.851" class="difflineminus">-  { VCTimeZoneProp, 0, 0, 0 },</span>
<a href="#l89.852"></a><span id="l89.852" class="difflineminus">-  { VCTitleProp, 0, 0, 0 },</span>
<a href="#l89.853"></a><span id="l89.853" class="difflineminus">-  { VCTLXProp, 0, 0, 0 },</span>
<a href="#l89.854"></a><span id="l89.854" class="difflineminus">-  { VCTodoProp, 0, 0, PD_BEGIN },</span>
<a href="#l89.855"></a><span id="l89.855" class="difflineminus">-  { VCTranspProp, 0, 0, 0 },</span>
<a href="#l89.856"></a><span id="l89.856" class="difflineminus">-  { VCUniqueStringProp, 0, 0, 0 },</span>
<a href="#l89.857"></a><span id="l89.857" class="difflineminus">-  { VCURLProp, 0, 0, 0 },</span>
<a href="#l89.858"></a><span id="l89.858" class="difflineminus">-  { VCURLValueProp, 0, 0, 0 },</span>
<a href="#l89.859"></a><span id="l89.859" class="difflineminus">-  { VCValueProp, 0, 0, 0 },</span>
<a href="#l89.860"></a><span id="l89.860" class="difflineminus">-  { VCVersionProp, 0, 0, 0 },</span>
<a href="#l89.861"></a><span id="l89.861" class="difflineminus">-  { VCVideoProp, 0, 0, 0 },</span>
<a href="#l89.862"></a><span id="l89.862" class="difflineminus">-  { VCVoiceProp, 0, 0, 0 },</span>
<a href="#l89.863"></a><span id="l89.863" class="difflineminus">-  { VCWAVEProp, 0, 0, 0 },</span>
<a href="#l89.864"></a><span id="l89.864" class="difflineminus">-  { VCWMFProp, 0, 0, 0 },</span>
<a href="#l89.865"></a><span id="l89.865" class="difflineminus">-  { VCWorkProp, 0, 0, 0 },</span>
<a href="#l89.866"></a><span id="l89.866" class="difflineminus">-  { VCX400Prop, 0, 0, 0 },</span>
<a href="#l89.867"></a><span id="l89.867" class="difflineminus">-  { VCX509Prop, 0, 0, 0 },</span>
<a href="#l89.868"></a><span id="l89.868" class="difflineminus">-  { VCXRuleProp, 0, 0, 0 },</span>
<a href="#l89.869"></a><span id="l89.869" class="difflineminus">-  { VCCooltalk, 0, coolTalkFields, 0 },</span>
<a href="#l89.870"></a><span id="l89.870" class="difflineminus">-  { VCCooltalkAddress, 0, 0, 0 },</span>
<a href="#l89.871"></a><span id="l89.871" class="difflineminus">-  { VCUseServer, 0, 0, 0 },</span>
<a href="#l89.872"></a><span id="l89.872" class="difflineminus">-  { VCUseHTML, 0, 0, 0 },</span>
<a href="#l89.873"></a><span id="l89.873" class="difflineminus">-  { 0,0,0,0 }</span>
<a href="#l89.874"></a><span id="l89.874" class="difflineplus">+  {VC7bitProp, 0, 0, 0},</span>
<a href="#l89.875"></a><span id="l89.875" class="difflineplus">+  {VC8bitProp, 0, 0, 0},</span>
<a href="#l89.876"></a><span id="l89.876" class="difflineplus">+  {VCAAlarmProp, 0, AAlarmFields, 0},</span>
<a href="#l89.877"></a><span id="l89.877" class="difflineplus">+  {VCAdditionalNamesProp, 0, 0, 0},</span>
<a href="#l89.878"></a><span id="l89.878" class="difflineplus">+  {VCAdrProp, 0, adrFields, 0},</span>
<a href="#l89.879"></a><span id="l89.879" class="difflineplus">+  {VCAgentProp, 0, 0, 0},</span>
<a href="#l89.880"></a><span id="l89.880" class="difflineplus">+  {VCAIFFProp, 0, 0, 0},</span>
<a href="#l89.881"></a><span id="l89.881" class="difflineplus">+  {VCAOLProp, 0, 0, 0},</span>
<a href="#l89.882"></a><span id="l89.882" class="difflineplus">+  {VCAppleLinkProp, 0, 0, 0},</span>
<a href="#l89.883"></a><span id="l89.883" class="difflineplus">+  {VCAttachProp, 0, 0, 0},</span>
<a href="#l89.884"></a><span id="l89.884" class="difflineplus">+  {VCAttendeeProp, 0, 0, 0},</span>
<a href="#l89.885"></a><span id="l89.885" class="difflineplus">+  {VCATTMailProp, 0, 0, 0},</span>
<a href="#l89.886"></a><span id="l89.886" class="difflineplus">+  {VCAudioContentProp, 0, 0, 0},</span>
<a href="#l89.887"></a><span id="l89.887" class="difflineplus">+  {VCAVIProp, 0, 0, 0},</span>
<a href="#l89.888"></a><span id="l89.888" class="difflineplus">+  {VCBase64Prop, 0, 0, 0},</span>
<a href="#l89.889"></a><span id="l89.889" class="difflineplus">+  {VCBBSProp, 0, 0, 0},</span>
<a href="#l89.890"></a><span id="l89.890" class="difflineplus">+  {VCBirthDateProp, 0, 0, 0},</span>
<a href="#l89.891"></a><span id="l89.891" class="difflineplus">+  {VCBMPProp, 0, 0, 0},</span>
<a href="#l89.892"></a><span id="l89.892" class="difflineplus">+  {VCBodyProp, 0, 0, 0},</span>
<a href="#l89.893"></a><span id="l89.893" class="difflineplus">+  {VCBusinessRoleProp, 0, 0, 0},</span>
<a href="#l89.894"></a><span id="l89.894" class="difflineplus">+  {VCCalProp, 0, 0, PD_BEGIN},</span>
<a href="#l89.895"></a><span id="l89.895" class="difflineplus">+  {VCCaptionProp, 0, 0, 0},</span>
<a href="#l89.896"></a><span id="l89.896" class="difflineplus">+  {VCCardProp, 0, 0, PD_BEGIN},</span>
<a href="#l89.897"></a><span id="l89.897" class="difflineplus">+  {VCCarProp, 0, 0, 0},</span>
<a href="#l89.898"></a><span id="l89.898" class="difflineplus">+  {VCCategoriesProp, 0, 0, 0},</span>
<a href="#l89.899"></a><span id="l89.899" class="difflineplus">+  {VCCellularProp, 0, 0, 0},</span>
<a href="#l89.900"></a><span id="l89.900" class="difflineplus">+  {VCCGMProp, 0, 0, 0},</span>
<a href="#l89.901"></a><span id="l89.901" class="difflineplus">+  {VCCharSetProp, 0, 0, 0},</span>
<a href="#l89.902"></a><span id="l89.902" class="difflineplus">+  {VCCIDProp, VCContentIDProp, 0, 0},</span>
<a href="#l89.903"></a><span id="l89.903" class="difflineplus">+  {VCCISProp, 0, 0, 0},</span>
<a href="#l89.904"></a><span id="l89.904" class="difflineplus">+  {VCCityProp, 0, 0, 0},</span>
<a href="#l89.905"></a><span id="l89.905" class="difflineplus">+  {VCClassProp, 0, 0, 0},</span>
<a href="#l89.906"></a><span id="l89.906" class="difflineplus">+  {VCCommentProp, 0, 0, 0},</span>
<a href="#l89.907"></a><span id="l89.907" class="difflineplus">+  {VCCompletedProp, 0, 0, 0},</span>
<a href="#l89.908"></a><span id="l89.908" class="difflineplus">+  {VCContentIDProp, 0, 0, 0},</span>
<a href="#l89.909"></a><span id="l89.909" class="difflineplus">+  {VCCountryNameProp, 0, 0, 0},</span>
<a href="#l89.910"></a><span id="l89.910" class="difflineplus">+  {VCDAlarmProp, 0, DAlarmFields, 0},</span>
<a href="#l89.911"></a><span id="l89.911" class="difflineplus">+  {VCDataSizeProp, 0, 0, PD_INTERNAL},</span>
<a href="#l89.912"></a><span id="l89.912" class="difflineplus">+  {VCDayLightProp, 0, 0, 0},</span>
<a href="#l89.913"></a><span id="l89.913" class="difflineplus">+  {VCDCreatedProp, 0, 0, 0},</span>
<a href="#l89.914"></a><span id="l89.914" class="difflineplus">+  {VCDeliveryLabelProp, 0, 0, 0},</span>
<a href="#l89.915"></a><span id="l89.915" class="difflineplus">+  {VCDescriptionProp, 0, 0, 0},</span>
<a href="#l89.916"></a><span id="l89.916" class="difflineplus">+  {VCDIBProp, 0, 0, 0},</span>
<a href="#l89.917"></a><span id="l89.917" class="difflineplus">+  {VCDisplayStringProp, 0, 0, 0},</span>
<a href="#l89.918"></a><span id="l89.918" class="difflineplus">+  {VCDomesticProp, 0, 0, 0},</span>
<a href="#l89.919"></a><span id="l89.919" class="difflineplus">+  {VCDTendProp, 0, 0, 0},</span>
<a href="#l89.920"></a><span id="l89.920" class="difflineplus">+  {VCDTstartProp, 0, 0, 0},</span>
<a href="#l89.921"></a><span id="l89.921" class="difflineplus">+  {VCDueProp, 0, 0, 0},</span>
<a href="#l89.922"></a><span id="l89.922" class="difflineplus">+  {VCEmailAddressProp, 0, 0, 0},</span>
<a href="#l89.923"></a><span id="l89.923" class="difflineplus">+  {VCEncodingProp, 0, 0, 0},</span>
<a href="#l89.924"></a><span id="l89.924" class="difflineplus">+  {VCEndProp, 0, 0, 0},</span>
<a href="#l89.925"></a><span id="l89.925" class="difflineplus">+  {VCEventProp, 0, 0, PD_BEGIN},</span>
<a href="#l89.926"></a><span id="l89.926" class="difflineplus">+  {VCEWorldProp, 0, 0, 0},</span>
<a href="#l89.927"></a><span id="l89.927" class="difflineplus">+  {VCExNumProp, 0, 0, 0},</span>
<a href="#l89.928"></a><span id="l89.928" class="difflineplus">+  {VCExpDateProp, 0, 0, 0},</span>
<a href="#l89.929"></a><span id="l89.929" class="difflineplus">+  {VCExpectProp, 0, 0, 0},</span>
<a href="#l89.930"></a><span id="l89.930" class="difflineplus">+  {VCExtAddressProp, 0, 0, 0},</span>
<a href="#l89.931"></a><span id="l89.931" class="difflineplus">+  {VCFamilyNameProp, 0, 0, 0},</span>
<a href="#l89.932"></a><span id="l89.932" class="difflineplus">+  {VCFaxProp, 0, 0, 0},</span>
<a href="#l89.933"></a><span id="l89.933" class="difflineplus">+  {VCFullNameProp, 0, 0, 0},</span>
<a href="#l89.934"></a><span id="l89.934" class="difflineplus">+  {VCGeoLocationProp, 0, 0, 0},</span>
<a href="#l89.935"></a><span id="l89.935" class="difflineplus">+  {VCGeoProp, 0, 0, 0},</span>
<a href="#l89.936"></a><span id="l89.936" class="difflineplus">+  {VCGIFProp, 0, 0, 0},</span>
<a href="#l89.937"></a><span id="l89.937" class="difflineplus">+  {VCGivenNameProp, 0, 0, 0},</span>
<a href="#l89.938"></a><span id="l89.938" class="difflineplus">+  {VCGroupingProp, 0, 0, 0},</span>
<a href="#l89.939"></a><span id="l89.939" class="difflineplus">+  {VCHomeProp, 0, 0, 0},</span>
<a href="#l89.940"></a><span id="l89.940" class="difflineplus">+  {VCIBMMailProp, 0, 0, 0},</span>
<a href="#l89.941"></a><span id="l89.941" class="difflineplus">+  {VCInlineProp, 0, 0, 0},</span>
<a href="#l89.942"></a><span id="l89.942" class="difflineplus">+  {VCInternationalProp, 0, 0, 0},</span>
<a href="#l89.943"></a><span id="l89.943" class="difflineplus">+  {VCInternetProp, 0, 0, 0},</span>
<a href="#l89.944"></a><span id="l89.944" class="difflineplus">+  {VCISDNProp, 0, 0, 0},</span>
<a href="#l89.945"></a><span id="l89.945" class="difflineplus">+  {VCJPEGProp, 0, 0, 0},</span>
<a href="#l89.946"></a><span id="l89.946" class="difflineplus">+  {VCLanguageProp, 0, 0, 0},</span>
<a href="#l89.947"></a><span id="l89.947" class="difflineplus">+  {VCLastModifiedProp, 0, 0, 0},</span>
<a href="#l89.948"></a><span id="l89.948" class="difflineplus">+  {VCLastRevisedProp, 0, 0, 0},</span>
<a href="#l89.949"></a><span id="l89.949" class="difflineplus">+  {VCLocationProp, 0, 0, 0},</span>
<a href="#l89.950"></a><span id="l89.950" class="difflineplus">+  {VCLogoProp, 0, 0, 0},</span>
<a href="#l89.951"></a><span id="l89.951" class="difflineplus">+  {VCMailerProp, 0, 0, 0},</span>
<a href="#l89.952"></a><span id="l89.952" class="difflineplus">+  {VCMAlarmProp, 0, MAlarmFields, 0},</span>
<a href="#l89.953"></a><span id="l89.953" class="difflineplus">+  {VCMCIMailProp, 0, 0, 0},</span>
<a href="#l89.954"></a><span id="l89.954" class="difflineplus">+  {VCMessageProp, 0, 0, 0},</span>
<a href="#l89.955"></a><span id="l89.955" class="difflineplus">+  {VCMETProp, 0, 0, 0},</span>
<a href="#l89.956"></a><span id="l89.956" class="difflineplus">+  {VCModemProp, 0, 0, 0},</span>
<a href="#l89.957"></a><span id="l89.957" class="difflineplus">+  {VCMPEG2Prop, 0, 0, 0},</span>
<a href="#l89.958"></a><span id="l89.958" class="difflineplus">+  {VCMPEGProp, 0, 0, 0},</span>
<a href="#l89.959"></a><span id="l89.959" class="difflineplus">+  {VCMSNProp, 0, 0, 0},</span>
<a href="#l89.960"></a><span id="l89.960" class="difflineplus">+  {VCNamePrefixesProp, 0, 0, 0},</span>
<a href="#l89.961"></a><span id="l89.961" class="difflineplus">+  {VCNameProp, 0, nameFields, 0},</span>
<a href="#l89.962"></a><span id="l89.962" class="difflineplus">+  {VCNameSuffixesProp, 0, 0, 0},</span>
<a href="#l89.963"></a><span id="l89.963" class="difflineplus">+  {VCNoteProp, 0, 0, 0},</span>
<a href="#l89.964"></a><span id="l89.964" class="difflineplus">+  {VCOrgNameProp, 0, 0, 0},</span>
<a href="#l89.965"></a><span id="l89.965" class="difflineplus">+  {VCOrgProp, 0, orgFields, 0},</span>
<a href="#l89.966"></a><span id="l89.966" class="difflineplus">+  {VCOrgUnit2Prop, 0, 0, 0},</span>
<a href="#l89.967"></a><span id="l89.967" class="difflineplus">+  {VCOrgUnit3Prop, 0, 0, 0},</span>
<a href="#l89.968"></a><span id="l89.968" class="difflineplus">+  {VCOrgUnit4Prop, 0, 0, 0},</span>
<a href="#l89.969"></a><span id="l89.969" class="difflineplus">+  {VCOrgUnitProp, 0, 0, 0},</span>
<a href="#l89.970"></a><span id="l89.970" class="difflineplus">+  {VCPagerProp, 0, 0, 0},</span>
<a href="#l89.971"></a><span id="l89.971" class="difflineplus">+  {VCPAlarmProp, 0, PAlarmFields, 0},</span>
<a href="#l89.972"></a><span id="l89.972" class="difflineplus">+  {VCParcelProp, 0, 0, 0},</span>
<a href="#l89.973"></a><span id="l89.973" class="difflineplus">+  {VCPartProp, 0, 0, 0},</span>
<a href="#l89.974"></a><span id="l89.974" class="difflineplus">+  {VCPCMProp, 0, 0, 0},</span>
<a href="#l89.975"></a><span id="l89.975" class="difflineplus">+  {VCPDFProp, 0, 0, 0},</span>
<a href="#l89.976"></a><span id="l89.976" class="difflineplus">+  {VCPGPProp, 0, 0, 0},</span>
<a href="#l89.977"></a><span id="l89.977" class="difflineplus">+  {VCPhotoProp, 0, 0, 0},</span>
<a href="#l89.978"></a><span id="l89.978" class="difflineplus">+  {VCPICTProp, 0, 0, 0},</span>
<a href="#l89.979"></a><span id="l89.979" class="difflineplus">+  {VCPMBProp, 0, 0, 0},</span>
<a href="#l89.980"></a><span id="l89.980" class="difflineplus">+  {VCPostalBoxProp, 0, 0, 0},</span>
<a href="#l89.981"></a><span id="l89.981" class="difflineplus">+  {VCPostalCodeProp, 0, 0, 0},</span>
<a href="#l89.982"></a><span id="l89.982" class="difflineplus">+  {VCPostalProp, 0, 0, 0},</span>
<a href="#l89.983"></a><span id="l89.983" class="difflineplus">+  {VCPowerShareProp, 0, 0, 0},</span>
<a href="#l89.984"></a><span id="l89.984" class="difflineplus">+  {VCPreferredProp, 0, 0, 0},</span>
<a href="#l89.985"></a><span id="l89.985" class="difflineplus">+  {VCPriorityProp, 0, 0, 0},</span>
<a href="#l89.986"></a><span id="l89.986" class="difflineplus">+  {VCProcedureNameProp, 0, 0, 0},</span>
<a href="#l89.987"></a><span id="l89.987" class="difflineplus">+  {VCProdIdProp, 0, 0, 0},</span>
<a href="#l89.988"></a><span id="l89.988" class="difflineplus">+  {VCProdigyProp, 0, 0, 0},</span>
<a href="#l89.989"></a><span id="l89.989" class="difflineplus">+  {VCPronunciationProp, 0, 0, 0},</span>
<a href="#l89.990"></a><span id="l89.990" class="difflineplus">+  {VCPSProp, 0, 0, 0},</span>
<a href="#l89.991"></a><span id="l89.991" class="difflineplus">+  {VCPublicKeyProp, 0, 0, 0},</span>
<a href="#l89.992"></a><span id="l89.992" class="difflineplus">+  {VCQPProp, VCQuotedPrintableProp, 0, 0},</span>
<a href="#l89.993"></a><span id="l89.993" class="difflineplus">+  {VCQuickTimeProp, 0, 0, 0},</span>
<a href="#l89.994"></a><span id="l89.994" class="difflineplus">+  {VCQuotedPrintableProp, 0, 0, 0},</span>
<a href="#l89.995"></a><span id="l89.995" class="difflineplus">+  {VCRDateProp, 0, 0, 0},</span>
<a href="#l89.996"></a><span id="l89.996" class="difflineplus">+  {VCRegionProp, 0, 0, 0},</span>
<a href="#l89.997"></a><span id="l89.997" class="difflineplus">+  {VCRelatedToProp, 0, 0, 0},</span>
<a href="#l89.998"></a><span id="l89.998" class="difflineplus">+  {VCRepeatCountProp, 0, 0, 0},</span>
<a href="#l89.999"></a><span id="l89.999" class="difflineplus">+  {VCResourcesProp, 0, 0, 0},</span>
<a href="#l89.1000"></a><span id="l89.1000" class="difflineplus">+  {VCRNumProp, 0, 0, 0},</span>
<a href="#l89.1001"></a><span id="l89.1001" class="difflineplus">+  {VCRoleProp, 0, 0, 0},</span>
<a href="#l89.1002"></a><span id="l89.1002" class="difflineplus">+  {VCRRuleProp, 0, 0, 0},</span>
<a href="#l89.1003"></a><span id="l89.1003" class="difflineplus">+  {VCRSVPProp, 0, 0, 0},</span>
<a href="#l89.1004"></a><span id="l89.1004" class="difflineplus">+  {VCRunTimeProp, 0, 0, 0},</span>
<a href="#l89.1005"></a><span id="l89.1005" class="difflineplus">+  {VCSequenceProp, 0, 0, 0},</span>
<a href="#l89.1006"></a><span id="l89.1006" class="difflineplus">+  {VCSnoozeTimeProp, 0, 0, 0},</span>
<a href="#l89.1007"></a><span id="l89.1007" class="difflineplus">+  {VCStartProp, 0, 0, 0},</span>
<a href="#l89.1008"></a><span id="l89.1008" class="difflineplus">+  {VCStatusProp, 0, 0, 0},</span>
<a href="#l89.1009"></a><span id="l89.1009" class="difflineplus">+  {VCStreetAddressProp, 0, 0, 0},</span>
<a href="#l89.1010"></a><span id="l89.1010" class="difflineplus">+  {VCSubTypeProp, 0, 0, 0},</span>
<a href="#l89.1011"></a><span id="l89.1011" class="difflineplus">+  {VCSummaryProp, 0, 0, 0},</span>
<a href="#l89.1012"></a><span id="l89.1012" class="difflineplus">+  {VCTelephoneProp, 0, 0, 0},</span>
<a href="#l89.1013"></a><span id="l89.1013" class="difflineplus">+  {VCTIFFProp, 0, 0, 0},</span>
<a href="#l89.1014"></a><span id="l89.1014" class="difflineplus">+  {VCTimeZoneProp, 0, 0, 0},</span>
<a href="#l89.1015"></a><span id="l89.1015" class="difflineplus">+  {VCTitleProp, 0, 0, 0},</span>
<a href="#l89.1016"></a><span id="l89.1016" class="difflineplus">+  {VCTLXProp, 0, 0, 0},</span>
<a href="#l89.1017"></a><span id="l89.1017" class="difflineplus">+  {VCTodoProp, 0, 0, PD_BEGIN},</span>
<a href="#l89.1018"></a><span id="l89.1018" class="difflineplus">+  {VCTranspProp, 0, 0, 0},</span>
<a href="#l89.1019"></a><span id="l89.1019" class="difflineplus">+  {VCUniqueStringProp, 0, 0, 0},</span>
<a href="#l89.1020"></a><span id="l89.1020" class="difflineplus">+  {VCURLProp, 0, 0, 0},</span>
<a href="#l89.1021"></a><span id="l89.1021" class="difflineplus">+  {VCURLValueProp, 0, 0, 0},</span>
<a href="#l89.1022"></a><span id="l89.1022" class="difflineplus">+  {VCValueProp, 0, 0, 0},</span>
<a href="#l89.1023"></a><span id="l89.1023" class="difflineplus">+  {VCVersionProp, 0, 0, 0},</span>
<a href="#l89.1024"></a><span id="l89.1024" class="difflineplus">+  {VCVideoProp, 0, 0, 0},</span>
<a href="#l89.1025"></a><span id="l89.1025" class="difflineplus">+  {VCVoiceProp, 0, 0, 0},</span>
<a href="#l89.1026"></a><span id="l89.1026" class="difflineplus">+  {VCWAVEProp, 0, 0, 0},</span>
<a href="#l89.1027"></a><span id="l89.1027" class="difflineplus">+  {VCWMFProp, 0, 0, 0},</span>
<a href="#l89.1028"></a><span id="l89.1028" class="difflineplus">+  {VCWorkProp, 0, 0, 0},</span>
<a href="#l89.1029"></a><span id="l89.1029" class="difflineplus">+  {VCX400Prop, 0, 0, 0},</span>
<a href="#l89.1030"></a><span id="l89.1030" class="difflineplus">+  {VCX509Prop, 0, 0, 0},</span>
<a href="#l89.1031"></a><span id="l89.1031" class="difflineplus">+  {VCXRuleProp, 0, 0, 0},</span>
<a href="#l89.1032"></a><span id="l89.1032" class="difflineplus">+  {VCCooltalk, 0, coolTalkFields, 0},</span>
<a href="#l89.1033"></a><span id="l89.1033" class="difflineplus">+  {VCCooltalkAddress, 0, 0, 0},</span>
<a href="#l89.1034"></a><span id="l89.1034" class="difflineplus">+  {VCUseServer, 0, 0, 0},</span>
<a href="#l89.1035"></a><span id="l89.1035" class="difflineplus">+  {VCUseHTML, 0, 0, 0},</span>
<a href="#l89.1036"></a><span id="l89.1036" class="difflineplus">+  {0, 0, 0, 0}</span>
<a href="#l89.1037"></a><span id="l89.1037"> };</span>
<a href="#l89.1038"></a><span id="l89.1038" class="difflineminus">-</span>
<a href="#l89.1039"></a><span id="l89.1039" class="difflineplus">+// clang-format on</span>
<a href="#l89.1040"></a><span id="l89.1040"> </span>
<a href="#l89.1041"></a><span id="l89.1041" class="difflineminus">-static struct PreDefProp* lookupPropInfo(const char* str)</span>
<a href="#l89.1042"></a><span id="l89.1042" class="difflineminus">-{</span>
<a href="#l89.1043"></a><span id="l89.1043" class="difflineplus">+static struct PreDefProp *lookupPropInfo(const char *str) {</span>
<a href="#l89.1044"></a><span id="l89.1044">   /* brute force for now, could use a hash table here. */</span>
<a href="#l89.1045"></a><span id="l89.1045">   int i;</span>
<a href="#l89.1046"></a><span id="l89.1046"> </span>
<a href="#l89.1047"></a><span id="l89.1047">   for (i = 0; propNames[i].name; i++)</span>
<a href="#l89.1048"></a><span id="l89.1048">     if (PL_strcasecmp(str, propNames[i].name) == 0) {</span>
<a href="#l89.1049"></a><span id="l89.1049">       return &amp;propNames[i];</span>
<a href="#l89.1050"></a><span id="l89.1050">     }</span>
<a href="#l89.1051"></a><span id="l89.1051"> </span>
<a href="#l89.1052"></a><span id="l89.1052">   return 0;</span>
<a href="#l89.1053"></a><span id="l89.1053"> }</span>
<a href="#l89.1054"></a><span id="l89.1054"> </span>
<a href="#l89.1055"></a><span id="l89.1055" class="difflineminus">-</span>
<a href="#l89.1056"></a><span id="l89.1056" class="difflineminus">-const char* lookupProp_(const char* str)</span>
<a href="#l89.1057"></a><span id="l89.1057" class="difflineminus">-{</span>
<a href="#l89.1058"></a><span id="l89.1058" class="difflineplus">+const char *lookupProp_(const char *str) {</span>
<a href="#l89.1059"></a><span id="l89.1059">   int i;</span>
<a href="#l89.1060"></a><span id="l89.1060"> </span>
<a href="#l89.1061"></a><span id="l89.1061">   for (i = 0; propNames[i].name; i++)</span>
<a href="#l89.1062"></a><span id="l89.1062" class="difflineminus">-  if (PL_strcasecmp(str, propNames[i].name) == 0) {</span>
<a href="#l89.1063"></a><span id="l89.1063" class="difflineminus">-    const char* s;</span>
<a href="#l89.1064"></a><span id="l89.1064" class="difflineminus">-    s = propNames[i].alias?propNames[i].alias:propNames[i].name;</span>
<a href="#l89.1065"></a><span id="l89.1065" class="difflineminus">-    return lookupStr(s);</span>
<a href="#l89.1066"></a><span id="l89.1066" class="difflineminus">-  }</span>
<a href="#l89.1067"></a><span id="l89.1067" class="difflineplus">+    if (PL_strcasecmp(str, propNames[i].name) == 0) {</span>
<a href="#l89.1068"></a><span id="l89.1068" class="difflineplus">+      const char *s;</span>
<a href="#l89.1069"></a><span id="l89.1069" class="difflineplus">+      s = propNames[i].alias ? propNames[i].alias : propNames[i].name;</span>
<a href="#l89.1070"></a><span id="l89.1070" class="difflineplus">+      return lookupStr(s);</span>
<a href="#l89.1071"></a><span id="l89.1071" class="difflineplus">+    }</span>
<a href="#l89.1072"></a><span id="l89.1072">   return lookupStr(str);</span>
<a href="#l89.1073"></a><span id="l89.1073"> }</span>
<a href="#l89.1074"></a><span id="l89.1074"> </span>
<a href="#l89.1075"></a><span id="l89.1075" class="difflineminus">-</span>
<a href="#l89.1076"></a><span id="l89.1076" class="difflineminus">-const char* lookupProp(const char* str)</span>
<a href="#l89.1077"></a><span id="l89.1077" class="difflineminus">-{</span>
<a href="#l89.1078"></a><span id="l89.1078" class="difflineplus">+const char *lookupProp(const char *str) {</span>
<a href="#l89.1079"></a><span id="l89.1079">   int i;</span>
<a href="#l89.1080"></a><span id="l89.1080"> </span>
<a href="#l89.1081"></a><span id="l89.1081">   for (i = 0; propNames[i].name; i++)</span>
<a href="#l89.1082"></a><span id="l89.1082" class="difflineminus">-  if (PL_strcasecmp(str, propNames[i].name) == 0) {</span>
<a href="#l89.1083"></a><span id="l89.1083" class="difflineminus">-    const char *s;</span>
<a href="#l89.1084"></a><span id="l89.1084" class="difflineminus">-    fieldedProp = (char **)propNames[i].fields;</span>
<a href="#l89.1085"></a><span id="l89.1085" class="difflineminus">-    s = propNames[i].alias?propNames[i].alias:propNames[i].name;</span>
<a href="#l89.1086"></a><span id="l89.1086" class="difflineminus">-    return lookupStr(s);</span>
<a href="#l89.1087"></a><span id="l89.1087" class="difflineminus">-  }</span>
<a href="#l89.1088"></a><span id="l89.1088" class="difflineplus">+    if (PL_strcasecmp(str, propNames[i].name) == 0) {</span>
<a href="#l89.1089"></a><span id="l89.1089" class="difflineplus">+      const char *s;</span>
<a href="#l89.1090"></a><span id="l89.1090" class="difflineplus">+      fieldedProp = (char **)propNames[i].fields;</span>
<a href="#l89.1091"></a><span id="l89.1091" class="difflineplus">+      s = propNames[i].alias ? propNames[i].alias : propNames[i].name;</span>
<a href="#l89.1092"></a><span id="l89.1092" class="difflineplus">+      return lookupStr(s);</span>
<a href="#l89.1093"></a><span id="l89.1093" class="difflineplus">+    }</span>
<a href="#l89.1094"></a><span id="l89.1094">   fieldedProp = 0;</span>
<a href="#l89.1095"></a><span id="l89.1095">   return lookupStr(str);</span>
<a href="#l89.1096"></a><span id="l89.1096"> }</span>
<a href="#l89.1097"></a><span id="l89.1097"> </span>
<a href="#l89.1098"></a><span id="l89.1098" class="difflineminus">-</span>
<a href="#l89.1099"></a><span id="l89.1099"> /*----------------------------------------------------------------------</span>
<a href="#l89.1100"></a><span id="l89.1100">   APIs to Output text form.</span>
<a href="#l89.1101"></a><span id="l89.1101">   ----------------------------------------------------------------------*/</span>
<a href="#l89.1102"></a><span id="l89.1102"> #define OFILE_REALLOC_SIZE 256</span>
<a href="#l89.1103"></a><span id="l89.1103"> </span>
<a href="#l89.1104"></a><span id="l89.1104" class="difflineminus">-static void appendcOFile_(OFile *fp, char c)</span>
<a href="#l89.1105"></a><span id="l89.1105" class="difflineminus">-{</span>
<a href="#l89.1106"></a><span id="l89.1106" class="difflineminus">-  if (fp-&gt;fail)</span>
<a href="#l89.1107"></a><span id="l89.1107" class="difflineminus">-    return;</span>
<a href="#l89.1108"></a><span id="l89.1108" class="difflineplus">+static void appendcOFile_(OFile *fp, char c) {</span>
<a href="#l89.1109"></a><span id="l89.1109" class="difflineplus">+  if (fp-&gt;fail) return;</span>
<a href="#l89.1110"></a><span id="l89.1110"> stuff:</span>
<a href="#l89.1111"></a><span id="l89.1111" class="difflineminus">-  if (fp-&gt;len+1 &lt; fp-&gt;limit) {</span>
<a href="#l89.1112"></a><span id="l89.1112" class="difflineplus">+  if (fp-&gt;len + 1 &lt; fp-&gt;limit) {</span>
<a href="#l89.1113"></a><span id="l89.1113">     fp-&gt;s[fp-&gt;len] = c;</span>
<a href="#l89.1114"></a><span id="l89.1114">     fp-&gt;len++;</span>
<a href="#l89.1115"></a><span id="l89.1115">     return;</span>
<a href="#l89.1116"></a><span id="l89.1116" class="difflineminus">-  }</span>
<a href="#l89.1117"></a><span id="l89.1117" class="difflineminus">-  else if (fp-&gt;alloc) {</span>
<a href="#l89.1118"></a><span id="l89.1118" class="difflineplus">+  } else if (fp-&gt;alloc) {</span>
<a href="#l89.1119"></a><span id="l89.1119">     fp-&gt;limit = fp-&gt;limit + OFILE_REALLOC_SIZE;</span>
<a href="#l89.1120"></a><span id="l89.1120" class="difflineminus">-    char* newBuf = (char *) PR_Realloc(fp-&gt;s, fp-&gt;limit);</span>
<a href="#l89.1121"></a><span id="l89.1121" class="difflineplus">+    char *newBuf = (char *)PR_Realloc(fp-&gt;s, fp-&gt;limit);</span>
<a href="#l89.1122"></a><span id="l89.1122">     if (newBuf) {</span>
<a href="#l89.1123"></a><span id="l89.1123">       fp-&gt;s = newBuf;</span>
<a href="#l89.1124"></a><span id="l89.1124">       goto stuff;</span>
<a href="#l89.1125"></a><span id="l89.1125">     }</span>
<a href="#l89.1126"></a><span id="l89.1126">   }</span>
<a href="#l89.1127"></a><span id="l89.1127" class="difflineminus">-  if (fp-&gt;alloc)</span>
<a href="#l89.1128"></a><span id="l89.1128" class="difflineminus">-    PR_FREEIF(fp-&gt;s);</span>
<a href="#l89.1129"></a><span id="l89.1129" class="difflineplus">+  if (fp-&gt;alloc) PR_FREEIF(fp-&gt;s);</span>
<a href="#l89.1130"></a><span id="l89.1130">   fp-&gt;s = 0;</span>
<a href="#l89.1131"></a><span id="l89.1131">   fp-&gt;fail = 1;</span>
<a href="#l89.1132"></a><span id="l89.1132"> }</span>
<a href="#l89.1133"></a><span id="l89.1133"> </span>
<a href="#l89.1134"></a><span id="l89.1134" class="difflineminus">-static void appendcOFile(OFile *fp, char c)</span>
<a href="#l89.1135"></a><span id="l89.1135" class="difflineminus">-{</span>
<a href="#l89.1136"></a><span id="l89.1136" class="difflineplus">+static void appendcOFile(OFile *fp, char c) {</span>
<a href="#l89.1137"></a><span id="l89.1137">   /* int i = 0; */</span>
<a href="#l89.1138"></a><span id="l89.1138">   if (c == '\n') {</span>
<a href="#l89.1139"></a><span id="l89.1139">     /* write out as &lt;CR&gt;&lt;LF&gt; */</span>
<a href="#l89.1140"></a><span id="l89.1140">     /* for (i = 0; i &lt; LINEBREAK_LEN; i++)</span>
<a href="#l89.1141"></a><span id="l89.1141">       appendcOFile_(fp,LINEBREAK [ i ]); */</span>
<a href="#l89.1142"></a><span id="l89.1142" class="difflineminus">-    appendcOFile_(fp,0xd);</span>
<a href="#l89.1143"></a><span id="l89.1143" class="difflineminus">-    appendcOFile_(fp,0xa);</span>
<a href="#l89.1144"></a><span id="l89.1144" class="difflineminus">-  }</span>
<a href="#l89.1145"></a><span id="l89.1145" class="difflineminus">-  else</span>
<a href="#l89.1146"></a><span id="l89.1146" class="difflineminus">-    appendcOFile_(fp,c);</span>
<a href="#l89.1147"></a><span id="l89.1147" class="difflineplus">+    appendcOFile_(fp, 0xd);</span>
<a href="#l89.1148"></a><span id="l89.1148" class="difflineplus">+    appendcOFile_(fp, 0xa);</span>
<a href="#l89.1149"></a><span id="l89.1149" class="difflineplus">+  } else</span>
<a href="#l89.1150"></a><span id="l89.1150" class="difflineplus">+    appendcOFile_(fp, c);</span>
<a href="#l89.1151"></a><span id="l89.1151"> }</span>
<a href="#l89.1152"></a><span id="l89.1152"> </span>
<a href="#l89.1153"></a><span id="l89.1153" class="difflineminus">-static void appendsOFile(OFile *fp, const char *s)</span>
<a href="#l89.1154"></a><span id="l89.1154" class="difflineminus">-{</span>
<a href="#l89.1155"></a><span id="l89.1155" class="difflineplus">+static void appendsOFile(OFile *fp, const char *s) {</span>
<a href="#l89.1156"></a><span id="l89.1156">   int i, slen;</span>
<a href="#l89.1157"></a><span id="l89.1157" class="difflineminus">-  slen  = PL_strlen (s);</span>
<a href="#l89.1158"></a><span id="l89.1158" class="difflineminus">-  for (i=0; i&lt;slen; i++) {</span>
<a href="#l89.1159"></a><span id="l89.1159" class="difflineminus">-    appendcOFile(fp,s[i]);</span>
<a href="#l89.1160"></a><span id="l89.1160" class="difflineplus">+  slen = PL_strlen(s);</span>
<a href="#l89.1161"></a><span id="l89.1161" class="difflineplus">+  for (i = 0; i &lt; slen; i++) {</span>
<a href="#l89.1162"></a><span id="l89.1162" class="difflineplus">+    appendcOFile(fp, s[i]);</span>
<a href="#l89.1163"></a><span id="l89.1163">   }</span>
<a href="#l89.1164"></a><span id="l89.1164"> }</span>
<a href="#l89.1165"></a><span id="l89.1165"> </span>
<a href="#l89.1166"></a><span id="l89.1166" class="difflineminus">-static void initMemOFile(OFile *fp, char *s, int len)</span>
<a href="#l89.1167"></a><span id="l89.1167" class="difflineminus">-{</span>
<a href="#l89.1168"></a><span id="l89.1168" class="difflineplus">+static void initMemOFile(OFile *fp, char *s, int len) {</span>
<a href="#l89.1169"></a><span id="l89.1169">   fp-&gt;s = s;</span>
<a href="#l89.1170"></a><span id="l89.1170">   fp-&gt;len = 0;</span>
<a href="#l89.1171"></a><span id="l89.1171" class="difflineminus">-  fp-&gt;limit = s?len:0;</span>
<a href="#l89.1172"></a><span id="l89.1172" class="difflineminus">-  fp-&gt;alloc = s?0:1;</span>
<a href="#l89.1173"></a><span id="l89.1173" class="difflineplus">+  fp-&gt;limit = s ? len : 0;</span>
<a href="#l89.1174"></a><span id="l89.1174" class="difflineplus">+  fp-&gt;alloc = s ? 0 : 1;</span>
<a href="#l89.1175"></a><span id="l89.1175">   fp-&gt;fail = 0;</span>
<a href="#l89.1176"></a><span id="l89.1176"> }</span>
<a href="#l89.1177"></a><span id="l89.1177"> </span>
<a href="#l89.1178"></a><span id="l89.1178" class="difflineminus">-</span>
<a href="#l89.1179"></a><span id="l89.1179" class="difflineminus">-static int writeBase64(OFile *fp, unsigned char *s, long len)</span>
<a href="#l89.1180"></a><span id="l89.1180" class="difflineminus">-{</span>
<a href="#l89.1181"></a><span id="l89.1181" class="difflineplus">+static int writeBase64(OFile *fp, unsigned char *s, long len) {</span>
<a href="#l89.1182"></a><span id="l89.1182">   long cur = 0;</span>
<a href="#l89.1183"></a><span id="l89.1183">   int i, numQuads = 0;</span>
<a href="#l89.1184"></a><span id="l89.1184">   unsigned long trip;</span>
<a href="#l89.1185"></a><span id="l89.1185">   unsigned char b;</span>
<a href="#l89.1186"></a><span id="l89.1186">   char quad[5];</span>
<a href="#l89.1187"></a><span id="l89.1187"> #define PR_MAXQUADS 16</span>
<a href="#l89.1188"></a><span id="l89.1188"> </span>
<a href="#l89.1189"></a><span id="l89.1189">   quad[4] = 0;</span>
<a href="#l89.1190"></a><span id="l89.1190" class="difflineat">@@ -928,403 +791,385 @@ static int writeBase64(OFile *fp, unsign</span>
<a href="#l89.1191"></a><span id="l89.1191">       trip = trip &lt;&lt; 8 | b;</span>
<a href="#l89.1192"></a><span id="l89.1192">     }</span>
<a href="#l89.1193"></a><span id="l89.1193">     /* fill in 'quad' with the appropriate four characters */</span>
<a href="#l89.1194"></a><span id="l89.1194">     for (i = 3; i &gt;= 0; i--) {</span>
<a href="#l89.1195"></a><span id="l89.1195">       b = (unsigned char)(trip &amp; 0x3F);</span>
<a href="#l89.1196"></a><span id="l89.1196">       trip = trip &gt;&gt; 6;</span>
<a href="#l89.1197"></a><span id="l89.1197">       if ((3 - i) &lt; (cur - len))</span>
<a href="#l89.1198"></a><span id="l89.1198">         quad[i] = '='; /* pad char */</span>
<a href="#l89.1199"></a><span id="l89.1199" class="difflineminus">-      else if (b &lt; 26) quad[i] = (char)b + 'A';</span>
<a href="#l89.1200"></a><span id="l89.1200" class="difflineminus">-      else if (b &lt; 52) quad[i] = (char)(b - 26) + 'a';</span>
<a href="#l89.1201"></a><span id="l89.1201" class="difflineminus">-      else if (b &lt; 62) quad[i] = (char)(b - 52) + '0';</span>
<a href="#l89.1202"></a><span id="l89.1202" class="difflineminus">-      else if (b == 62) quad[i] = '+';</span>
<a href="#l89.1203"></a><span id="l89.1203" class="difflineminus">-      else quad[i] = '/';</span>
<a href="#l89.1204"></a><span id="l89.1204" class="difflineplus">+      else if (b &lt; 26)</span>
<a href="#l89.1205"></a><span id="l89.1205" class="difflineplus">+        quad[i] = (char)b + 'A';</span>
<a href="#l89.1206"></a><span id="l89.1206" class="difflineplus">+      else if (b &lt; 52)</span>
<a href="#l89.1207"></a><span id="l89.1207" class="difflineplus">+        quad[i] = (char)(b - 26) + 'a';</span>
<a href="#l89.1208"></a><span id="l89.1208" class="difflineplus">+      else if (b &lt; 62)</span>
<a href="#l89.1209"></a><span id="l89.1209" class="difflineplus">+        quad[i] = (char)(b - 52) + '0';</span>
<a href="#l89.1210"></a><span id="l89.1210" class="difflineplus">+      else if (b == 62)</span>
<a href="#l89.1211"></a><span id="l89.1211" class="difflineplus">+        quad[i] = '+';</span>
<a href="#l89.1212"></a><span id="l89.1212" class="difflineplus">+      else</span>
<a href="#l89.1213"></a><span id="l89.1213" class="difflineplus">+        quad[i] = '/';</span>
<a href="#l89.1214"></a><span id="l89.1214">     }</span>
<a href="#l89.1215"></a><span id="l89.1215">     /* now output 'quad' with appropriate whitespace and line ending */</span>
<a href="#l89.1216"></a><span id="l89.1216">     appendsOFile(fp, (numQuads == 0 ? &quot;    &quot; : &quot;&quot;));</span>
<a href="#l89.1217"></a><span id="l89.1217">     appendsOFile(fp, quad);</span>
<a href="#l89.1218"></a><span id="l89.1218" class="difflineminus">-    appendsOFile(fp, ((cur &gt;= len)?&quot;\n&quot; :(numQuads==PR_MAXQUADS-1?&quot;\n&quot; : &quot;&quot;)));</span>
<a href="#l89.1219"></a><span id="l89.1219" class="difflineplus">+    appendsOFile(</span>
<a href="#l89.1220"></a><span id="l89.1220" class="difflineplus">+        fp, ((cur &gt;= len) ? &quot;\n&quot; : (numQuads == PR_MAXQUADS - 1 ? &quot;\n&quot; : &quot;&quot;)));</span>
<a href="#l89.1221"></a><span id="l89.1221">     numQuads = (numQuads + 1) % PR_MAXQUADS;</span>
<a href="#l89.1222"></a><span id="l89.1222">   }</span>
<a href="#l89.1223"></a><span id="l89.1223" class="difflineminus">-  appendcOFile(fp,'\n');</span>
<a href="#l89.1224"></a><span id="l89.1224" class="difflineplus">+  appendcOFile(fp, '\n');</span>
<a href="#l89.1225"></a><span id="l89.1225"> </span>
<a href="#l89.1226"></a><span id="l89.1226">   return 1;</span>
<a href="#l89.1227"></a><span id="l89.1227"> }</span>
<a href="#l89.1228"></a><span id="l89.1228"> </span>
<a href="#l89.1229"></a><span id="l89.1229" class="difflineminus">-static void writeQPString(OFile *fp, const char *s)</span>
<a href="#l89.1230"></a><span id="l89.1230" class="difflineminus">-{</span>
<a href="#l89.1231"></a><span id="l89.1231" class="difflineplus">+static void writeQPString(OFile *fp, const char *s) {</span>
<a href="#l89.1232"></a><span id="l89.1232">   const unsigned char *p = (const unsigned char *)s;</span>
<a href="#l89.1233"></a><span id="l89.1233">   int current_column = 0;</span>
<a href="#l89.1234"></a><span id="l89.1234">   static const char hexdigits[] = &quot;0123456789ABCDEF&quot;;</span>
<a href="#l89.1235"></a><span id="l89.1235">   bool white = false;</span>
<a href="#l89.1236"></a><span id="l89.1236">   bool contWhite = false;</span>
<a href="#l89.1237"></a><span id="l89.1237">   bool mb_p = false;</span>
<a href="#l89.1238"></a><span id="l89.1238"> </span>
<a href="#l89.1239"></a><span id="l89.1239" class="difflineminus">-  if (needsQuotedPrintable (s))</span>
<a href="#l89.1240"></a><span id="l89.1240" class="difflineminus">-  {</span>
<a href="#l89.1241"></a><span id="l89.1241" class="difflineplus">+  if (needsQuotedPrintable(s)) {</span>
<a href="#l89.1242"></a><span id="l89.1242">     while (*p) {</span>
<a href="#l89.1243"></a><span id="l89.1243" class="difflineminus">-      if (*p == '\r' || *p == '\n')</span>
<a href="#l89.1244"></a><span id="l89.1244" class="difflineminus">-      {</span>
<a href="#l89.1245"></a><span id="l89.1245" class="difflineplus">+      if (*p == '\r' || *p == '\n') {</span>
<a href="#l89.1246"></a><span id="l89.1246">         /* Whitespace cannot be allowed to occur at the end of the line.</span>
<a href="#l89.1247"></a><span id="l89.1247">            So we encode &quot; \n&quot; as &quot; =\n\n&quot;, that is, the whitespace, a</span>
<a href="#l89.1248"></a><span id="l89.1248">            soft line break, and then a hard line break.</span>
<a href="#l89.1249"></a><span id="l89.1249">          */</span>
<a href="#l89.1250"></a><span id="l89.1250"> </span>
<a href="#l89.1251"></a><span id="l89.1251" class="difflineminus">-        if (white)</span>
<a href="#l89.1252"></a><span id="l89.1252" class="difflineminus">-        {</span>
<a href="#l89.1253"></a><span id="l89.1253" class="difflineminus">-          appendcOFile(fp,'=');</span>
<a href="#l89.1254"></a><span id="l89.1254" class="difflineminus">-          appendcOFile(fp,'\n');</span>
<a href="#l89.1255"></a><span id="l89.1255" class="difflineminus">-          appendcOFile(fp,'\t');</span>
<a href="#l89.1256"></a><span id="l89.1256" class="difflineminus">-          appendsOFile(fp,&quot;=0D&quot;);</span>
<a href="#l89.1257"></a><span id="l89.1257" class="difflineminus">-          appendsOFile(fp,&quot;=0A&quot;);</span>
<a href="#l89.1258"></a><span id="l89.1258" class="difflineminus">-          appendcOFile(fp,'=');</span>
<a href="#l89.1259"></a><span id="l89.1259" class="difflineminus">-          appendcOFile(fp,'\n');</span>
<a href="#l89.1260"></a><span id="l89.1260" class="difflineminus">-          appendcOFile(fp,'\t');</span>
<a href="#l89.1261"></a><span id="l89.1261" class="difflineminus">-        }</span>
<a href="#l89.1262"></a><span id="l89.1262" class="difflineminus">-        else</span>
<a href="#l89.1263"></a><span id="l89.1263" class="difflineminus">-        {</span>
<a href="#l89.1264"></a><span id="l89.1264" class="difflineminus">-          appendsOFile(fp,&quot;=0D&quot;);</span>
<a href="#l89.1265"></a><span id="l89.1265" class="difflineminus">-          appendsOFile(fp,&quot;=0A&quot;);</span>
<a href="#l89.1266"></a><span id="l89.1266" class="difflineminus">-          appendcOFile(fp,'=');</span>
<a href="#l89.1267"></a><span id="l89.1267" class="difflineminus">-          appendcOFile(fp,'\n');</span>
<a href="#l89.1268"></a><span id="l89.1268" class="difflineminus">-          appendcOFile(fp,'\t');</span>
<a href="#l89.1269"></a><span id="l89.1269" class="difflineplus">+        if (white) {</span>
<a href="#l89.1270"></a><span id="l89.1270" class="difflineplus">+          appendcOFile(fp, '=');</span>
<a href="#l89.1271"></a><span id="l89.1271" class="difflineplus">+          appendcOFile(fp, '\n');</span>
<a href="#l89.1272"></a><span id="l89.1272" class="difflineplus">+          appendcOFile(fp, '\t');</span>
<a href="#l89.1273"></a><span id="l89.1273" class="difflineplus">+          appendsOFile(fp, &quot;=0D&quot;);</span>
<a href="#l89.1274"></a><span id="l89.1274" class="difflineplus">+          appendsOFile(fp, &quot;=0A&quot;);</span>
<a href="#l89.1275"></a><span id="l89.1275" class="difflineplus">+          appendcOFile(fp, '=');</span>
<a href="#l89.1276"></a><span id="l89.1276" class="difflineplus">+          appendcOFile(fp, '\n');</span>
<a href="#l89.1277"></a><span id="l89.1277" class="difflineplus">+          appendcOFile(fp, '\t');</span>
<a href="#l89.1278"></a><span id="l89.1278" class="difflineplus">+        } else {</span>
<a href="#l89.1279"></a><span id="l89.1279" class="difflineplus">+          appendsOFile(fp, &quot;=0D&quot;);</span>
<a href="#l89.1280"></a><span id="l89.1280" class="difflineplus">+          appendsOFile(fp, &quot;=0A&quot;);</span>
<a href="#l89.1281"></a><span id="l89.1281" class="difflineplus">+          appendcOFile(fp, '=');</span>
<a href="#l89.1282"></a><span id="l89.1282" class="difflineplus">+          appendcOFile(fp, '\n');</span>
<a href="#l89.1283"></a><span id="l89.1283" class="difflineplus">+          appendcOFile(fp, '\t');</span>
<a href="#l89.1284"></a><span id="l89.1284">           contWhite = false;</span>
<a href="#l89.1285"></a><span id="l89.1285">         }</span>
<a href="#l89.1286"></a><span id="l89.1286"> </span>
<a href="#l89.1287"></a><span id="l89.1287">         /* If its CRLF, swallow two chars instead of one. */</span>
<a href="#l89.1288"></a><span id="l89.1288" class="difflineminus">-        if (*p == '\r' &amp;&amp; *(p+1) == '\n')</span>
<a href="#l89.1289"></a><span id="l89.1289" class="difflineminus">-          p++;</span>
<a href="#l89.1290"></a><span id="l89.1290" class="difflineplus">+        if (*p == '\r' &amp;&amp; *(p + 1) == '\n') p++;</span>
<a href="#l89.1291"></a><span id="l89.1291">         white = false;</span>
<a href="#l89.1292"></a><span id="l89.1292">         current_column = 0;</span>
<a href="#l89.1293"></a><span id="l89.1293" class="difflineminus">-      }</span>
<a href="#l89.1294"></a><span id="l89.1294" class="difflineminus">-      else</span>
<a href="#l89.1295"></a><span id="l89.1295" class="difflineminus">-      {</span>
<a href="#l89.1296"></a><span id="l89.1296" class="difflineminus">-        if ((*p &gt;= 33 &amp;&amp; *p &lt;= 60) ||   /* safe printing chars */</span>
<a href="#l89.1297"></a><span id="l89.1297" class="difflineminus">-          (*p &gt;= 62 &amp;&amp; *p &lt;= 126) ||</span>
<a href="#l89.1298"></a><span id="l89.1298" class="difflineminus">-          (mb_p &amp;&amp; (*p == 61 || *p == 127 || *p == 0x1B)))</span>
<a href="#l89.1299"></a><span id="l89.1299" class="difflineminus">-        {</span>
<a href="#l89.1300"></a><span id="l89.1300" class="difflineminus">-          appendcOFile(fp,*p);</span>
<a href="#l89.1301"></a><span id="l89.1301" class="difflineplus">+      } else {</span>
<a href="#l89.1302"></a><span id="l89.1302" class="difflineplus">+        if ((*p &gt;= 33 &amp;&amp; *p &lt;= 60) || /* safe printing chars */</span>
<a href="#l89.1303"></a><span id="l89.1303" class="difflineplus">+            (*p &gt;= 62 &amp;&amp; *p &lt;= 126) ||</span>
<a href="#l89.1304"></a><span id="l89.1304" class="difflineplus">+            (mb_p &amp;&amp; (*p == 61 || *p == 127 || *p == 0x1B))) {</span>
<a href="#l89.1305"></a><span id="l89.1305" class="difflineplus">+          appendcOFile(fp, *p);</span>
<a href="#l89.1306"></a><span id="l89.1306">           current_column++;</span>
<a href="#l89.1307"></a><span id="l89.1307">           white = false;</span>
<a href="#l89.1308"></a><span id="l89.1308">           contWhite = false;</span>
<a href="#l89.1309"></a><span id="l89.1309" class="difflineminus">-        }</span>
<a href="#l89.1310"></a><span id="l89.1310" class="difflineminus">-        else if (*p == ' ' || *p == '\t')   /* whitespace */</span>
<a href="#l89.1311"></a><span id="l89.1311" class="difflineplus">+        } else if (*p == ' ' || *p == '\t') /* whitespace */</span>
<a href="#l89.1312"></a><span id="l89.1312">         {</span>
<a href="#l89.1313"></a><span id="l89.1313" class="difflineminus">-          if (contWhite)</span>
<a href="#l89.1314"></a><span id="l89.1314" class="difflineminus">-          {</span>
<a href="#l89.1315"></a><span id="l89.1315" class="difflineminus">-            appendcOFile(fp,'=');</span>
<a href="#l89.1316"></a><span id="l89.1316" class="difflineminus">-            appendcOFile(fp,hexdigits[*p &gt;&gt; 4]);</span>
<a href="#l89.1317"></a><span id="l89.1317" class="difflineminus">-            appendcOFile(fp,hexdigits[*p &amp; 0xF]);</span>
<a href="#l89.1318"></a><span id="l89.1318" class="difflineplus">+          if (contWhite) {</span>
<a href="#l89.1319"></a><span id="l89.1319" class="difflineplus">+            appendcOFile(fp, '=');</span>
<a href="#l89.1320"></a><span id="l89.1320" class="difflineplus">+            appendcOFile(fp, hexdigits[*p &gt;&gt; 4]);</span>
<a href="#l89.1321"></a><span id="l89.1321" class="difflineplus">+            appendcOFile(fp, hexdigits[*p &amp; 0xF]);</span>
<a href="#l89.1322"></a><span id="l89.1322">             current_column += 3;</span>
<a href="#l89.1323"></a><span id="l89.1323">             contWhite = false;</span>
<a href="#l89.1324"></a><span id="l89.1324" class="difflineminus">-          }</span>
<a href="#l89.1325"></a><span id="l89.1325" class="difflineminus">-          else</span>
<a href="#l89.1326"></a><span id="l89.1326" class="difflineminus">-          {</span>
<a href="#l89.1327"></a><span id="l89.1327" class="difflineminus">-            appendcOFile(fp,*p);</span>
<a href="#l89.1328"></a><span id="l89.1328" class="difflineplus">+          } else {</span>
<a href="#l89.1329"></a><span id="l89.1329" class="difflineplus">+            appendcOFile(fp, *p);</span>
<a href="#l89.1330"></a><span id="l89.1330">             current_column++;</span>
<a href="#l89.1331"></a><span id="l89.1331">           }</span>
<a href="#l89.1332"></a><span id="l89.1332">           white = true;</span>
<a href="#l89.1333"></a><span id="l89.1333" class="difflineminus">-        }</span>
<a href="#l89.1334"></a><span id="l89.1334" class="difflineminus">-        else                    /* print as =FF */</span>
<a href="#l89.1335"></a><span id="l89.1335" class="difflineplus">+        } else /* print as =FF */</span>
<a href="#l89.1336"></a><span id="l89.1336">         {</span>
<a href="#l89.1337"></a><span id="l89.1337" class="difflineminus">-          appendcOFile(fp,'=');</span>
<a href="#l89.1338"></a><span id="l89.1338" class="difflineminus">-          appendcOFile(fp,hexdigits[*p &gt;&gt; 4]);</span>
<a href="#l89.1339"></a><span id="l89.1339" class="difflineminus">-          appendcOFile(fp,hexdigits[*p &amp; 0xF]);</span>
<a href="#l89.1340"></a><span id="l89.1340" class="difflineplus">+          appendcOFile(fp, '=');</span>
<a href="#l89.1341"></a><span id="l89.1341" class="difflineplus">+          appendcOFile(fp, hexdigits[*p &gt;&gt; 4]);</span>
<a href="#l89.1342"></a><span id="l89.1342" class="difflineplus">+          appendcOFile(fp, hexdigits[*p &amp; 0xF]);</span>
<a href="#l89.1343"></a><span id="l89.1343">           current_column += 3;</span>
<a href="#l89.1344"></a><span id="l89.1344">           white = false;</span>
<a href="#l89.1345"></a><span id="l89.1345">           contWhite = false;</span>
<a href="#l89.1346"></a><span id="l89.1346">         }</span>
<a href="#l89.1347"></a><span id="l89.1347"> </span>
<a href="#l89.1348"></a><span id="l89.1348" class="difflineminus">-        NS_ASSERTION(current_column &lt;= 76, &quot;1.10 &lt;rhp@netscape.com&gt; 06 Jan 2000 08:01&quot;); /* Hard limit required by spec */</span>
<a href="#l89.1349"></a><span id="l89.1349" class="difflineplus">+        NS_ASSERTION(</span>
<a href="#l89.1350"></a><span id="l89.1350" class="difflineplus">+            current_column &lt;= 76,</span>
<a href="#l89.1351"></a><span id="l89.1351" class="difflineplus">+            &quot;1.10 &lt;rhp@netscape.com&gt; 06 Jan 2000 08:01&quot;); /* Hard limit required</span>
<a href="#l89.1352"></a><span id="l89.1352" class="difflineplus">+                                                             by spec */</span>
<a href="#l89.1353"></a><span id="l89.1353"> </span>
<a href="#l89.1354"></a><span id="l89.1354" class="difflineminus">-        if (current_column &gt;= 73 || ((*(p+1) == ' ') &amp;&amp; (current_column + 3 &gt;= 73)))    /* soft line break: &quot;=\r\n&quot; */</span>
<a href="#l89.1355"></a><span id="l89.1355" class="difflineplus">+        if (current_column &gt;= 73 ||</span>
<a href="#l89.1356"></a><span id="l89.1356" class="difflineplus">+            ((*(p + 1) == ' ') &amp;&amp;</span>
<a href="#l89.1357"></a><span id="l89.1357" class="difflineplus">+             (current_column + 3 &gt;= 73))) /* soft line break: &quot;=\r\n&quot; */</span>
<a href="#l89.1358"></a><span id="l89.1358">         {</span>
<a href="#l89.1359"></a><span id="l89.1359" class="difflineminus">-          appendcOFile(fp,'=');</span>
<a href="#l89.1360"></a><span id="l89.1360" class="difflineminus">-          appendcOFile(fp,'\n');</span>
<a href="#l89.1361"></a><span id="l89.1361" class="difflineminus">-          appendcOFile(fp,'\t');</span>
<a href="#l89.1362"></a><span id="l89.1362" class="difflineplus">+          appendcOFile(fp, '=');</span>
<a href="#l89.1363"></a><span id="l89.1363" class="difflineplus">+          appendcOFile(fp, '\n');</span>
<a href="#l89.1364"></a><span id="l89.1364" class="difflineplus">+          appendcOFile(fp, '\t');</span>
<a href="#l89.1365"></a><span id="l89.1365">           current_column = 0;</span>
<a href="#l89.1366"></a><span id="l89.1366">           if (white)</span>
<a href="#l89.1367"></a><span id="l89.1367">             contWhite = true;</span>
<a href="#l89.1368"></a><span id="l89.1368">           else</span>
<a href="#l89.1369"></a><span id="l89.1369">             contWhite = false;</span>
<a href="#l89.1370"></a><span id="l89.1370">           white = false;</span>
<a href="#l89.1371"></a><span id="l89.1371">         }</span>
<a href="#l89.1372"></a><span id="l89.1372">       }</span>
<a href="#l89.1373"></a><span id="l89.1373">       p++;</span>
<a href="#l89.1374"></a><span id="l89.1374" class="difflineminus">-    }  /* while */</span>
<a href="#l89.1375"></a><span id="l89.1375" class="difflineminus">-  }  /* if */</span>
<a href="#l89.1376"></a><span id="l89.1376" class="difflineminus">-  else</span>
<a href="#l89.1377"></a><span id="l89.1377" class="difflineminus">-  {</span>
<a href="#l89.1378"></a><span id="l89.1378" class="difflineplus">+    } /* while */</span>
<a href="#l89.1379"></a><span id="l89.1379" class="difflineplus">+  }   /* if */</span>
<a href="#l89.1380"></a><span id="l89.1380" class="difflineplus">+  else {</span>
<a href="#l89.1381"></a><span id="l89.1381">     while (*p) {</span>
<a href="#l89.1382"></a><span id="l89.1382" class="difflineminus">-      appendcOFile(fp,*p);</span>
<a href="#l89.1383"></a><span id="l89.1383" class="difflineplus">+      appendcOFile(fp, *p);</span>
<a href="#l89.1384"></a><span id="l89.1384">       p++;</span>
<a href="#l89.1385"></a><span id="l89.1385">     }</span>
<a href="#l89.1386"></a><span id="l89.1386">   }</span>
<a href="#l89.1387"></a><span id="l89.1387"> }</span>
<a href="#l89.1388"></a><span id="l89.1388"> </span>
<a href="#l89.1389"></a><span id="l89.1389" class="difflineminus">-</span>
<a href="#l89.1390"></a><span id="l89.1390" class="difflineminus">-static void writeValue(OFile *fp, VObject *o, unsigned long size)</span>
<a href="#l89.1391"></a><span id="l89.1391" class="difflineminus">-{</span>
<a href="#l89.1392"></a><span id="l89.1392" class="difflineplus">+static void writeValue(OFile *fp, VObject *o, unsigned long size) {</span>
<a href="#l89.1393"></a><span id="l89.1393">   if (o == 0) return;</span>
<a href="#l89.1394"></a><span id="l89.1394">   switch (VALUE_TYPE(o)) {</span>
<a href="#l89.1395"></a><span id="l89.1395">     case VCVT_USTRINGZ: {</span>
<a href="#l89.1396"></a><span id="l89.1396">       char *s = fakeCString(USTRINGZ_VALUE_OF(o));</span>
<a href="#l89.1397"></a><span id="l89.1397">       writeQPString(fp, s);</span>
<a href="#l89.1398"></a><span id="l89.1398">       deleteString(s);</span>
<a href="#l89.1399"></a><span id="l89.1399">       break;</span>
<a href="#l89.1400"></a><span id="l89.1400">     }</span>
<a href="#l89.1401"></a><span id="l89.1401">     case VCVT_STRINGZ: {</span>
<a href="#l89.1402"></a><span id="l89.1402">       writeQPString(fp, STRINGZ_VALUE_OF(o));</span>
<a href="#l89.1403"></a><span id="l89.1403">       break;</span>
<a href="#l89.1404"></a><span id="l89.1404">     }</span>
<a href="#l89.1405"></a><span id="l89.1405">     case VCVT_UINT: {</span>
<a href="#l89.1406"></a><span id="l89.1406">       char buf[11];</span>
<a href="#l89.1407"></a><span id="l89.1407" class="difflineminus">-      sprintf(buf,&quot;%u&quot;, INTEGER_VALUE_OF(o));</span>
<a href="#l89.1408"></a><span id="l89.1408" class="difflineplus">+      sprintf(buf, &quot;%u&quot;, INTEGER_VALUE_OF(o));</span>
<a href="#l89.1409"></a><span id="l89.1409">       appendsOFile(fp, buf);</span>
<a href="#l89.1410"></a><span id="l89.1410">       break;</span>
<a href="#l89.1411"></a><span id="l89.1411">     }</span>
<a href="#l89.1412"></a><span id="l89.1412">     case VCVT_ULONG: {</span>
<a href="#l89.1413"></a><span id="l89.1413">       char buf[21];</span>
<a href="#l89.1414"></a><span id="l89.1414" class="difflineminus">-      sprintf(buf,&quot;%lu&quot;, LONG_VALUE_OF(o));</span>
<a href="#l89.1415"></a><span id="l89.1415" class="difflineplus">+      sprintf(buf, &quot;%lu&quot;, LONG_VALUE_OF(o));</span>
<a href="#l89.1416"></a><span id="l89.1416">       appendsOFile(fp, buf);</span>
<a href="#l89.1417"></a><span id="l89.1417">       break;</span>
<a href="#l89.1418"></a><span id="l89.1418">     }</span>
<a href="#l89.1419"></a><span id="l89.1419">     case VCVT_RAW: {</span>
<a href="#l89.1420"></a><span id="l89.1420" class="difflineminus">-      appendcOFile(fp,'\n');</span>
<a href="#l89.1421"></a><span id="l89.1421" class="difflineminus">-      writeBase64(fp,(unsigned char*)(ANY_VALUE_OF(o)),size);</span>
<a href="#l89.1422"></a><span id="l89.1422" class="difflineplus">+      appendcOFile(fp, '\n');</span>
<a href="#l89.1423"></a><span id="l89.1423" class="difflineplus">+      writeBase64(fp, (unsigned char *)(ANY_VALUE_OF(o)), size);</span>
<a href="#l89.1424"></a><span id="l89.1424">       break;</span>
<a href="#l89.1425"></a><span id="l89.1425">     }</span>
<a href="#l89.1426"></a><span id="l89.1426">     case VCVT_VOBJECT:</span>
<a href="#l89.1427"></a><span id="l89.1427" class="difflineminus">-      appendcOFile(fp,'\n');</span>
<a href="#l89.1428"></a><span id="l89.1428" class="difflineminus">-      writeVObject_(fp,VOBJECT_VALUE_OF(o));</span>
<a href="#l89.1429"></a><span id="l89.1429" class="difflineplus">+      appendcOFile(fp, '\n');</span>
<a href="#l89.1430"></a><span id="l89.1430" class="difflineplus">+      writeVObject_(fp, VOBJECT_VALUE_OF(o));</span>
<a href="#l89.1431"></a><span id="l89.1431">       break;</span>
<a href="#l89.1432"></a><span id="l89.1432">   }</span>
<a href="#l89.1433"></a><span id="l89.1433"> }</span>
<a href="#l89.1434"></a><span id="l89.1434"> </span>
<a href="#l89.1435"></a><span id="l89.1435" class="difflineminus">-static void writeAttrValue(OFile *fp, VObject *o, int* length)</span>
<a href="#l89.1436"></a><span id="l89.1436" class="difflineminus">-{</span>
<a href="#l89.1437"></a><span id="l89.1437" class="difflineplus">+static void writeAttrValue(OFile *fp, VObject *o, int *length) {</span>
<a href="#l89.1438"></a><span id="l89.1438">   int ilen = 0;</span>
<a href="#l89.1439"></a><span id="l89.1439">   if (NAME_OF(o)) {</span>
<a href="#l89.1440"></a><span id="l89.1440">     struct PreDefProp *pi;</span>
<a href="#l89.1441"></a><span id="l89.1441">     pi = lookupPropInfo(NAME_OF(o));</span>
<a href="#l89.1442"></a><span id="l89.1442">     if (pi &amp;&amp; ((pi-&gt;flags &amp; PD_INTERNAL) != 0)) return;</span>
<a href="#l89.1443"></a><span id="l89.1443" class="difflineminus">-    appendcOFile(fp,';');</span>
<a href="#l89.1444"></a><span id="l89.1444" class="difflineminus">-    if (*length != -1)</span>
<a href="#l89.1445"></a><span id="l89.1445" class="difflineminus">-      (*length)++;</span>
<a href="#l89.1446"></a><span id="l89.1446" class="difflineminus">-    appendsOFile(fp,NAME_OF(o));</span>
<a href="#l89.1447"></a><span id="l89.1447" class="difflineminus">-    if (*length != -1)</span>
<a href="#l89.1448"></a><span id="l89.1448" class="difflineminus">-      (*length) += PL_strlen (NAME_OF(o));</span>
<a href="#l89.1449"></a><span id="l89.1449" class="difflineminus">-  }</span>
<a href="#l89.1450"></a><span id="l89.1450" class="difflineminus">-  else {</span>
<a href="#l89.1451"></a><span id="l89.1451" class="difflineminus">-    appendcOFile(fp,';');</span>
<a href="#l89.1452"></a><span id="l89.1452" class="difflineplus">+    appendcOFile(fp, ';');</span>
<a href="#l89.1453"></a><span id="l89.1453" class="difflineplus">+    if (*length != -1) (*length)++;</span>
<a href="#l89.1454"></a><span id="l89.1454" class="difflineplus">+    appendsOFile(fp, NAME_OF(o));</span>
<a href="#l89.1455"></a><span id="l89.1455" class="difflineplus">+    if (*length != -1) (*length) += PL_strlen(NAME_OF(o));</span>
<a href="#l89.1456"></a><span id="l89.1456" class="difflineplus">+  } else {</span>
<a href="#l89.1457"></a><span id="l89.1457" class="difflineplus">+    appendcOFile(fp, ';');</span>
<a href="#l89.1458"></a><span id="l89.1458">     (*length)++;</span>
<a href="#l89.1459"></a><span id="l89.1459">   }</span>
<a href="#l89.1460"></a><span id="l89.1460">   if (VALUE_TYPE(o)) {</span>
<a href="#l89.1461"></a><span id="l89.1461" class="difflineminus">-    appendcOFile(fp,'=');</span>
<a href="#l89.1462"></a><span id="l89.1462" class="difflineplus">+    appendcOFile(fp, '=');</span>
<a href="#l89.1463"></a><span id="l89.1463">     if (*length != -1) {</span>
<a href="#l89.1464"></a><span id="l89.1464">       (*length)++;</span>
<a href="#l89.1465"></a><span id="l89.1465">       for (ilen = 0; ilen &lt; MAXMOZPROPNAMESIZE - (*length); ilen++)</span>
<a href="#l89.1466"></a><span id="l89.1466" class="difflineminus">-        appendcOFile(fp,' ');</span>
<a href="#l89.1467"></a><span id="l89.1467" class="difflineplus">+        appendcOFile(fp, ' ');</span>
<a href="#l89.1468"></a><span id="l89.1468">     }</span>
<a href="#l89.1469"></a><span id="l89.1469" class="difflineminus">-    writeValue(fp,o,0);</span>
<a href="#l89.1470"></a><span id="l89.1470" class="difflineplus">+    writeValue(fp, o, 0);</span>
<a href="#l89.1471"></a><span id="l89.1471">   }</span>
<a href="#l89.1472"></a><span id="l89.1472"> }</span>
<a href="#l89.1473"></a><span id="l89.1473"> </span>
<a href="#l89.1474"></a><span id="l89.1474" class="difflineminus">-static void writeGroup(OFile *fp, VObject *o)</span>
<a href="#l89.1475"></a><span id="l89.1475" class="difflineminus">-{</span>
<a href="#l89.1476"></a><span id="l89.1476" class="difflineplus">+static void writeGroup(OFile *fp, VObject *o) {</span>
<a href="#l89.1477"></a><span id="l89.1477">   nsAutoCString buf(NAME_OF(o));</span>
<a href="#l89.1478"></a><span id="l89.1478"> </span>
<a href="#l89.1479"></a><span id="l89.1479" class="difflineminus">-  while ((o=isAPropertyOf(o,VCGroupingProp)) != 0) {</span>
<a href="#l89.1480"></a><span id="l89.1480" class="difflineplus">+  while ((o = isAPropertyOf(o, VCGroupingProp)) != 0) {</span>
<a href="#l89.1481"></a><span id="l89.1481">     buf.InsertLiteral(&quot;.&quot;, 0);</span>
<a href="#l89.1482"></a><span id="l89.1482">     buf.Insert(STRINGZ_VALUE_OF(o), 0);</span>
<a href="#l89.1483"></a><span id="l89.1483">   }</span>
<a href="#l89.1484"></a><span id="l89.1484">   appendsOFile(fp, buf.get());</span>
<a href="#l89.1485"></a><span id="l89.1485"> }</span>
<a href="#l89.1486"></a><span id="l89.1486"> </span>
<a href="#l89.1487"></a><span id="l89.1487" class="difflineminus">-static int inList(const char **list, const char *s)</span>
<a href="#l89.1488"></a><span id="l89.1488" class="difflineminus">-{</span>
<a href="#l89.1489"></a><span id="l89.1489" class="difflineplus">+static int inList(const char **list, const char *s) {</span>
<a href="#l89.1490"></a><span id="l89.1490">   if (list == 0) return 0;</span>
<a href="#l89.1491"></a><span id="l89.1491">   while (*list) {</span>
<a href="#l89.1492"></a><span id="l89.1492" class="difflineminus">-    if (PL_strcasecmp(*list,s) == 0) return 1;</span>
<a href="#l89.1493"></a><span id="l89.1493" class="difflineplus">+    if (PL_strcasecmp(*list, s) == 0) return 1;</span>
<a href="#l89.1494"></a><span id="l89.1494">     list++;</span>
<a href="#l89.1495"></a><span id="l89.1495">   }</span>
<a href="#l89.1496"></a><span id="l89.1496">   return 0;</span>
<a href="#l89.1497"></a><span id="l89.1497"> }</span>
<a href="#l89.1498"></a><span id="l89.1498"> </span>
<a href="#l89.1499"></a><span id="l89.1499" class="difflineminus">-static void writeProp(OFile *fp, VObject *o)</span>
<a href="#l89.1500"></a><span id="l89.1500" class="difflineminus">-{</span>
<a href="#l89.1501"></a><span id="l89.1501" class="difflineplus">+static void writeProp(OFile *fp, VObject *o) {</span>
<a href="#l89.1502"></a><span id="l89.1502">   int length = -1;</span>
<a href="#l89.1503"></a><span id="l89.1503" class="difflineminus">-  //int ilen = 0;</span>
<a href="#l89.1504"></a><span id="l89.1504" class="difflineplus">+  // int ilen = 0;</span>
<a href="#l89.1505"></a><span id="l89.1505"> </span>
<a href="#l89.1506"></a><span id="l89.1506">   if (NAME_OF(o)) {</span>
<a href="#l89.1507"></a><span id="l89.1507">     struct PreDefProp *pi;</span>
<a href="#l89.1508"></a><span id="l89.1508">     VObjectIterator t;</span>
<a href="#l89.1509"></a><span id="l89.1509">     const char **fields_ = 0;</span>
<a href="#l89.1510"></a><span id="l89.1510">     pi = lookupPropInfo(NAME_OF(o));</span>
<a href="#l89.1511"></a><span id="l89.1511">     if (pi &amp;&amp; ((pi-&gt;flags &amp; PD_BEGIN) != 0)) {</span>
<a href="#l89.1512"></a><span id="l89.1512" class="difflineminus">-      writeVObject_(fp,o);</span>
<a href="#l89.1513"></a><span id="l89.1513" class="difflineplus">+      writeVObject_(fp, o);</span>
<a href="#l89.1514"></a><span id="l89.1514">       return;</span>
<a href="#l89.1515"></a><span id="l89.1515">     }</span>
<a href="#l89.1516"></a><span id="l89.1516" class="difflineminus">-    if (isAPropertyOf(o,VCGroupingProp))</span>
<a href="#l89.1517"></a><span id="l89.1517" class="difflineminus">-      writeGroup(fp,o);</span>
<a href="#l89.1518"></a><span id="l89.1518" class="difflineplus">+    if (isAPropertyOf(o, VCGroupingProp))</span>
<a href="#l89.1519"></a><span id="l89.1519" class="difflineplus">+      writeGroup(fp, o);</span>
<a href="#l89.1520"></a><span id="l89.1520">     else</span>
<a href="#l89.1521"></a><span id="l89.1521" class="difflineminus">-      appendsOFile(fp,NAME_OF(o));</span>
<a href="#l89.1522"></a><span id="l89.1522" class="difflineplus">+      appendsOFile(fp, NAME_OF(o));</span>
<a href="#l89.1523"></a><span id="l89.1523">     if (pi) fields_ = pi-&gt;fields;</span>
<a href="#l89.1524"></a><span id="l89.1524" class="difflineminus">-    initPropIterator(&amp;t,o);</span>
<a href="#l89.1525"></a><span id="l89.1525" class="difflineplus">+    initPropIterator(&amp;t, o);</span>
<a href="#l89.1526"></a><span id="l89.1526">     while (moreIteration(&amp;t)) {</span>
<a href="#l89.1527"></a><span id="l89.1527">       const char *s;</span>
<a href="#l89.1528"></a><span id="l89.1528">       VObject *eachProp = nextVObject(&amp;t);</span>
<a href="#l89.1529"></a><span id="l89.1529">       s = NAME_OF(eachProp);</span>
<a href="#l89.1530"></a><span id="l89.1530" class="difflineminus">-      if (PL_strcasecmp(VCGroupingProp,s) &amp;&amp; !inList(fields_,s))</span>
<a href="#l89.1531"></a><span id="l89.1531" class="difflineminus">-      writeAttrValue(fp,eachProp, &amp;length);</span>
<a href="#l89.1532"></a><span id="l89.1532" class="difflineplus">+      if (PL_strcasecmp(VCGroupingProp, s) &amp;&amp; !inList(fields_, s))</span>
<a href="#l89.1533"></a><span id="l89.1533" class="difflineplus">+        writeAttrValue(fp, eachProp, &amp;length);</span>
<a href="#l89.1534"></a><span id="l89.1534">     }</span>
<a href="#l89.1535"></a><span id="l89.1535">     if (fields_) {</span>
<a href="#l89.1536"></a><span id="l89.1536">       int i = 0, n = 0;</span>
<a href="#l89.1537"></a><span id="l89.1537" class="difflineminus">-      const char** fields = fields_;</span>
<a href="#l89.1538"></a><span id="l89.1538" class="difflineplus">+      const char **fields = fields_;</span>
<a href="#l89.1539"></a><span id="l89.1539">       /* output prop as fields */</span>
<a href="#l89.1540"></a><span id="l89.1540" class="difflineminus">-      appendcOFile(fp,':');</span>
<a href="#l89.1541"></a><span id="l89.1541" class="difflineplus">+      appendcOFile(fp, ':');</span>
<a href="#l89.1542"></a><span id="l89.1542">       while (*fields) {</span>
<a href="#l89.1543"></a><span id="l89.1543" class="difflineminus">-        VObject *tt = isAPropertyOf(o,*fields);</span>
<a href="#l89.1544"></a><span id="l89.1544" class="difflineplus">+        VObject *tt = isAPropertyOf(o, *fields);</span>
<a href="#l89.1545"></a><span id="l89.1545">         i++;</span>
<a href="#l89.1546"></a><span id="l89.1546">         if (tt) n = i;</span>
<a href="#l89.1547"></a><span id="l89.1547">         fields++;</span>
<a href="#l89.1548"></a><span id="l89.1548">       }</span>
<a href="#l89.1549"></a><span id="l89.1549">       fields = fields_;</span>
<a href="#l89.1550"></a><span id="l89.1550" class="difflineminus">-      for (i=0;i&lt;n;i++) {</span>
<a href="#l89.1551"></a><span id="l89.1551" class="difflineminus">-        writeValue(fp,isAPropertyOf(o,*fields),0);</span>
<a href="#l89.1552"></a><span id="l89.1552" class="difflineplus">+      for (i = 0; i &lt; n; i++) {</span>
<a href="#l89.1553"></a><span id="l89.1553" class="difflineplus">+        writeValue(fp, isAPropertyOf(o, *fields), 0);</span>
<a href="#l89.1554"></a><span id="l89.1554">         fields++;</span>
<a href="#l89.1555"></a><span id="l89.1555" class="difflineminus">-        if (i&lt;(n-1)) appendcOFile(fp,';');</span>
<a href="#l89.1556"></a><span id="l89.1556" class="difflineplus">+        if (i &lt; (n - 1)) appendcOFile(fp, ';');</span>
<a href="#l89.1557"></a><span id="l89.1557">       }</span>
<a href="#l89.1558"></a><span id="l89.1558">     }</span>
<a href="#l89.1559"></a><span id="l89.1559">   }</span>
<a href="#l89.1560"></a><span id="l89.1560"> </span>
<a href="#l89.1561"></a><span id="l89.1561">   if (VALUE_TYPE(o)) {</span>
<a href="#l89.1562"></a><span id="l89.1562">     unsigned long size = 0;</span>
<a href="#l89.1563"></a><span id="l89.1563" class="difflineminus">-    VObject *p = isAPropertyOf(o,VCDataSizeProp);</span>
<a href="#l89.1564"></a><span id="l89.1564" class="difflineplus">+    VObject *p = isAPropertyOf(o, VCDataSizeProp);</span>
<a href="#l89.1565"></a><span id="l89.1565">     if (p) size = LONG_VALUE_OF(p);</span>
<a href="#l89.1566"></a><span id="l89.1566" class="difflineminus">-    appendcOFile(fp,':');</span>
<a href="#l89.1567"></a><span id="l89.1567" class="difflineminus">-    writeValue(fp,o,size);</span>
<a href="#l89.1568"></a><span id="l89.1568" class="difflineplus">+    appendcOFile(fp, ':');</span>
<a href="#l89.1569"></a><span id="l89.1569" class="difflineplus">+    writeValue(fp, o, size);</span>
<a href="#l89.1570"></a><span id="l89.1570">   }</span>
<a href="#l89.1571"></a><span id="l89.1571" class="difflineminus">-  appendcOFile(fp,'\n');</span>
<a href="#l89.1572"></a><span id="l89.1572" class="difflineplus">+  appendcOFile(fp, '\n');</span>
<a href="#l89.1573"></a><span id="l89.1573"> }</span>
<a href="#l89.1574"></a><span id="l89.1574"> </span>
<a href="#l89.1575"></a><span id="l89.1575" class="difflineminus">-void writeVObject_(OFile *fp, VObject *o)</span>
<a href="#l89.1576"></a><span id="l89.1576" class="difflineminus">-{</span>
<a href="#l89.1577"></a><span id="l89.1577" class="difflineminus">-  //int ilen = 0;</span>
<a href="#l89.1578"></a><span id="l89.1578" class="difflineplus">+void writeVObject_(OFile *fp, VObject *o) {</span>
<a href="#l89.1579"></a><span id="l89.1579" class="difflineplus">+  // int ilen = 0;</span>
<a href="#l89.1580"></a><span id="l89.1580">   if (NAME_OF(o)) {</span>
<a href="#l89.1581"></a><span id="l89.1581">     struct PreDefProp *pi;</span>
<a href="#l89.1582"></a><span id="l89.1582">     pi = lookupPropInfo(NAME_OF(o));</span>
<a href="#l89.1583"></a><span id="l89.1583"> </span>
<a href="#l89.1584"></a><span id="l89.1584">     if (pi &amp;&amp; ((pi-&gt;flags &amp; PD_BEGIN) != 0)) {</span>
<a href="#l89.1585"></a><span id="l89.1585">       VObjectIterator t;</span>
<a href="#l89.1586"></a><span id="l89.1586">       const char *begin = NAME_OF(o);</span>
<a href="#l89.1587"></a><span id="l89.1587" class="difflineminus">-      appendsOFile(fp,&quot;begin:&quot;);</span>
<a href="#l89.1588"></a><span id="l89.1588" class="difflineminus">-      appendsOFile(fp,begin);</span>
<a href="#l89.1589"></a><span id="l89.1589" class="difflineminus">-      appendcOFile(fp,'\n');</span>
<a href="#l89.1590"></a><span id="l89.1590" class="difflineminus">-      initPropIterator(&amp;t,o);</span>
<a href="#l89.1591"></a><span id="l89.1591" class="difflineplus">+      appendsOFile(fp, &quot;begin:&quot;);</span>
<a href="#l89.1592"></a><span id="l89.1592" class="difflineplus">+      appendsOFile(fp, begin);</span>
<a href="#l89.1593"></a><span id="l89.1593" class="difflineplus">+      appendcOFile(fp, '\n');</span>
<a href="#l89.1594"></a><span id="l89.1594" class="difflineplus">+      initPropIterator(&amp;t, o);</span>
<a href="#l89.1595"></a><span id="l89.1595">       while (moreIteration(&amp;t)) {</span>
<a href="#l89.1596"></a><span id="l89.1596">         VObject *eachProp = nextVObject(&amp;t);</span>
<a href="#l89.1597"></a><span id="l89.1597">         writeProp(fp, eachProp);</span>
<a href="#l89.1598"></a><span id="l89.1598">       }</span>
<a href="#l89.1599"></a><span id="l89.1599" class="difflineminus">-      appendsOFile(fp,&quot;end:&quot;);</span>
<a href="#l89.1600"></a><span id="l89.1600" class="difflineminus">-      appendsOFile(fp,begin);</span>
<a href="#l89.1601"></a><span id="l89.1601" class="difflineminus">-      appendsOFile(fp,&quot;\n\n&quot;);</span>
<a href="#l89.1602"></a><span id="l89.1602" class="difflineplus">+      appendsOFile(fp, &quot;end:&quot;);</span>
<a href="#l89.1603"></a><span id="l89.1603" class="difflineplus">+      appendsOFile(fp, begin);</span>
<a href="#l89.1604"></a><span id="l89.1604" class="difflineplus">+      appendsOFile(fp, &quot;\n\n&quot;);</span>
<a href="#l89.1605"></a><span id="l89.1605">     }</span>
<a href="#l89.1606"></a><span id="l89.1606">   }</span>
<a href="#l89.1607"></a><span id="l89.1607"> }</span>
<a href="#l89.1608"></a><span id="l89.1608"> </span>
<a href="#l89.1609"></a><span id="l89.1609" class="difflineminus">-char* writeMemVObject(char *s, int *len, VObject *o)</span>
<a href="#l89.1610"></a><span id="l89.1610" class="difflineminus">-{</span>
<a href="#l89.1611"></a><span id="l89.1611" class="difflineplus">+char *writeMemVObject(char *s, int *len, VObject *o) {</span>
<a href="#l89.1612"></a><span id="l89.1612">   OFile ofp;</span>
<a href="#l89.1613"></a><span id="l89.1613" class="difflineminus">-  initMemOFile(&amp;ofp,s,len?*len:0);</span>
<a href="#l89.1614"></a><span id="l89.1614" class="difflineminus">-  writeVObject_(&amp;ofp,o);</span>
<a href="#l89.1615"></a><span id="l89.1615" class="difflineplus">+  initMemOFile(&amp;ofp, s, len ? *len : 0);</span>
<a href="#l89.1616"></a><span id="l89.1616" class="difflineplus">+  writeVObject_(&amp;ofp, o);</span>
<a href="#l89.1617"></a><span id="l89.1617">   if (len) *len = ofp.len;</span>
<a href="#l89.1618"></a><span id="l89.1618" class="difflineminus">-  appendcOFile(&amp;ofp,0);</span>
<a href="#l89.1619"></a><span id="l89.1619" class="difflineplus">+  appendcOFile(&amp;ofp, 0);</span>
<a href="#l89.1620"></a><span id="l89.1620">   return ofp.s;</span>
<a href="#l89.1621"></a><span id="l89.1621"> }</span>
<a href="#l89.1622"></a><span id="l89.1622"> </span>
<a href="#l89.1623"></a><span id="l89.1623" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l89.1624"></a><span id="l89.1624" class="difflineminus">-char * writeMemoryVObjects(char *s, int *len, VObject *list, bool expandSpaces)</span>
<a href="#l89.1625"></a><span id="l89.1625" class="difflineminus">-{</span>
<a href="#l89.1626"></a><span id="l89.1626" class="difflineplus">+extern &quot;C&quot; char *writeMemoryVObjects(char *s, int *len, VObject *list,</span>
<a href="#l89.1627"></a><span id="l89.1627" class="difflineplus">+                                     bool expandSpaces) {</span>
<a href="#l89.1628"></a><span id="l89.1628">   OFile ofp;</span>
<a href="#l89.1629"></a><span id="l89.1629" class="difflineminus">-  initMemOFile(&amp;ofp,s,len?*len:0);</span>
<a href="#l89.1630"></a><span id="l89.1630" class="difflineplus">+  initMemOFile(&amp;ofp, s, len ? *len : 0);</span>
<a href="#l89.1631"></a><span id="l89.1631">   while (list) {</span>
<a href="#l89.1632"></a><span id="l89.1632" class="difflineminus">-    writeVObject_(&amp;ofp,list);</span>
<a href="#l89.1633"></a><span id="l89.1633" class="difflineplus">+    writeVObject_(&amp;ofp, list);</span>
<a href="#l89.1634"></a><span id="l89.1634">     list = nextVObjectInList(list);</span>
<a href="#l89.1635"></a><span id="l89.1635">   }</span>
<a href="#l89.1636"></a><span id="l89.1636">   if (len) *len = ofp.len;</span>
<a href="#l89.1637"></a><span id="l89.1637" class="difflineminus">-  appendcOFile(&amp;ofp,0);</span>
<a href="#l89.1638"></a><span id="l89.1638" class="difflineplus">+  appendcOFile(&amp;ofp, 0);</span>
<a href="#l89.1639"></a><span id="l89.1639">   return ofp.s;</span>
<a href="#l89.1640"></a><span id="l89.1640"> }</span>
<a href="#l89.1641"></a><span id="l89.1641"> </span>
<a href="#l89.1642"></a><span id="l89.1642"> /*----------------------------------------------------------------------</span>
<a href="#l89.1643"></a><span id="l89.1643">   APIs to do fake Unicode stuff.</span>
<a href="#l89.1644"></a><span id="l89.1644">   ----------------------------------------------------------------------*/</span>
<a href="#l89.1645"></a><span id="l89.1645" class="difflineminus">-vwchar_t* fakeUnicode(const char *ps, int *bytes)</span>
<a href="#l89.1646"></a><span id="l89.1646" class="difflineminus">-{</span>
<a href="#l89.1647"></a><span id="l89.1647" class="difflineplus">+vwchar_t *fakeUnicode(const char *ps, int *bytes) {</span>
<a href="#l89.1648"></a><span id="l89.1648">   vwchar_t *r, *pw;</span>
<a href="#l89.1649"></a><span id="l89.1649" class="difflineminus">-  int len = strlen(ps)+1;</span>
<a href="#l89.1650"></a><span id="l89.1650" class="difflineplus">+  int len = strlen(ps) + 1;</span>
<a href="#l89.1651"></a><span id="l89.1651"> </span>
<a href="#l89.1652"></a><span id="l89.1652" class="difflineminus">-  pw = r = (vwchar_t*)PR_CALLOC(sizeof(vwchar_t)*len);</span>
<a href="#l89.1653"></a><span id="l89.1653" class="difflineminus">-  if (bytes)</span>
<a href="#l89.1654"></a><span id="l89.1654" class="difflineminus">-    *bytes = len * sizeof(vwchar_t);</span>
<a href="#l89.1655"></a><span id="l89.1655" class="difflineplus">+  pw = r = (vwchar_t *)PR_CALLOC(sizeof(vwchar_t) * len);</span>
<a href="#l89.1656"></a><span id="l89.1656" class="difflineplus">+  if (bytes) *bytes = len * sizeof(vwchar_t);</span>
<a href="#l89.1657"></a><span id="l89.1657"> </span>
<a href="#l89.1658"></a><span id="l89.1658">   while (*ps) {</span>
<a href="#l89.1659"></a><span id="l89.1659">     if (*ps == '\n')</span>
<a href="#l89.1660"></a><span id="l89.1660">       *pw = (vwchar_t)0x2028;</span>
<a href="#l89.1661"></a><span id="l89.1661">     else if (*ps == '\r')</span>
<a href="#l89.1662"></a><span id="l89.1662">       *pw = (vwchar_t)0x2029;</span>
<a href="#l89.1663"></a><span id="l89.1663">     else</span>
<a href="#l89.1664"></a><span id="l89.1664">       *pw = (vwchar_t)(unsigned char)*ps;</span>
<a href="#l89.1665"></a><span id="l89.1665" class="difflineminus">-    ps++; pw++;</span>
<a href="#l89.1666"></a><span id="l89.1666" class="difflineplus">+    ps++;</span>
<a href="#l89.1667"></a><span id="l89.1667" class="difflineplus">+    pw++;</span>
<a href="#l89.1668"></a><span id="l89.1668">   }</span>
<a href="#l89.1669"></a><span id="l89.1669">   *pw = (vwchar_t)0;</span>
<a href="#l89.1670"></a><span id="l89.1670"> </span>
<a href="#l89.1671"></a><span id="l89.1671">   return r;</span>
<a href="#l89.1672"></a><span id="l89.1672"> }</span>
<a href="#l89.1673"></a><span id="l89.1673"> </span>
<a href="#l89.1674"></a><span id="l89.1674" class="difflineminus">-int uStrLen(const vwchar_t *u)</span>
<a href="#l89.1675"></a><span id="l89.1675" class="difflineminus">-{</span>
<a href="#l89.1676"></a><span id="l89.1676" class="difflineminus">-  if (!u)</span>
<a href="#l89.1677"></a><span id="l89.1677" class="difflineminus">-    return 0;</span>
<a href="#l89.1678"></a><span id="l89.1678" class="difflineplus">+int uStrLen(const vwchar_t *u) {</span>
<a href="#l89.1679"></a><span id="l89.1679" class="difflineplus">+  if (!u) return 0;</span>
<a href="#l89.1680"></a><span id="l89.1680">   int i = 0;</span>
<a href="#l89.1681"></a><span id="l89.1681" class="difflineminus">-  while (*u != (vwchar_t)0) { u++; i++; }</span>
<a href="#l89.1682"></a><span id="l89.1682" class="difflineplus">+  while (*u != (vwchar_t)0) {</span>
<a href="#l89.1683"></a><span id="l89.1683" class="difflineplus">+    u++;</span>
<a href="#l89.1684"></a><span id="l89.1684" class="difflineplus">+    i++;</span>
<a href="#l89.1685"></a><span id="l89.1685" class="difflineplus">+  }</span>
<a href="#l89.1686"></a><span id="l89.1686">   return i;</span>
<a href="#l89.1687"></a><span id="l89.1687"> }</span>
<a href="#l89.1688"></a><span id="l89.1688"> </span>
<a href="#l89.1689"></a><span id="l89.1689" class="difflineminus">-char* fakeCString(const vwchar_t *u)</span>
<a href="#l89.1690"></a><span id="l89.1690" class="difflineminus">-{</span>
<a href="#l89.1691"></a><span id="l89.1691" class="difflineplus">+char *fakeCString(const vwchar_t *u) {</span>
<a href="#l89.1692"></a><span id="l89.1692">   char *s, *t;</span>
<a href="#l89.1693"></a><span id="l89.1693">   int len = uStrLen(u) + 1;</span>
<a href="#l89.1694"></a><span id="l89.1694" class="difflineminus">-  t = s = (char*)PR_CALLOC(len);</span>
<a href="#l89.1695"></a><span id="l89.1695" class="difflineplus">+  t = s = (char *)PR_CALLOC(len);</span>
<a href="#l89.1696"></a><span id="l89.1696">   if (u) {</span>
<a href="#l89.1697"></a><span id="l89.1697">     while (*u) {</span>
<a href="#l89.1698"></a><span id="l89.1698">       if (*u == (vwchar_t)0x2028)</span>
<a href="#l89.1699"></a><span id="l89.1699">         *t = '\n';</span>
<a href="#l89.1700"></a><span id="l89.1700">       else if (*u == (vwchar_t)0x2029)</span>
<a href="#l89.1701"></a><span id="l89.1701">         *t = '\r';</span>
<a href="#l89.1702"></a><span id="l89.1702">       else</span>
<a href="#l89.1703"></a><span id="l89.1703">         *t = (char)*u;</span>
<a href="#l89.1704"></a><span id="l89.1704" class="difflineminus">-      u++; t++;</span>
<a href="#l89.1705"></a><span id="l89.1705" class="difflineplus">+      u++;</span>
<a href="#l89.1706"></a><span id="l89.1706" class="difflineplus">+      t++;</span>
<a href="#l89.1707"></a><span id="l89.1707">     }</span>
<a href="#l89.1708"></a><span id="l89.1708">   }</span>
<a href="#l89.1709"></a><span id="l89.1709">   *t = 0;</span>
<a href="#l89.1710"></a><span id="l89.1710">   return s;</span>
<a href="#l89.1711"></a><span id="l89.1711"> }</span>
<a href="#l89.1712"></a><span id="l89.1712"> </span>
<a href="#l89.1713"></a><span id="l89.1713" class="difflineminus">-const char* lookupStr(const char *s)</span>
<a href="#l89.1714"></a><span id="l89.1714" class="difflineminus">-{</span>
<a href="#l89.1715"></a><span id="l89.1715" class="difflineplus">+const char *lookupStr(const char *s) {</span>
<a href="#l89.1716"></a><span id="l89.1716">   StrItem *t;</span>
<a href="#l89.1717"></a><span id="l89.1717">   unsigned int h = hashStr(s);</span>
<a href="#l89.1718"></a><span id="l89.1718">   if ((t = strTbl[h]) != 0) {</span>
<a href="#l89.1719"></a><span id="l89.1719">     do {</span>
<a href="#l89.1720"></a><span id="l89.1720" class="difflineminus">-      if (PL_strcasecmp(t-&gt;s,s) == 0) {</span>
<a href="#l89.1721"></a><span id="l89.1721" class="difflineplus">+      if (PL_strcasecmp(t-&gt;s, s) == 0) {</span>
<a href="#l89.1722"></a><span id="l89.1722">         t-&gt;refCnt++;</span>
<a href="#l89.1723"></a><span id="l89.1723">         return t-&gt;s;</span>
<a href="#l89.1724"></a><span id="l89.1724">       }</span>
<a href="#l89.1725"></a><span id="l89.1725">       t = t-&gt;next;</span>
<a href="#l89.1726"></a><span id="l89.1726">     } while (t);</span>
<a href="#l89.1727"></a><span id="l89.1727">   }</span>
<a href="#l89.1728"></a><span id="l89.1728" class="difflineminus">-  s = dupStr(s,0);</span>
<a href="#l89.1729"></a><span id="l89.1729" class="difflineminus">-  strTbl[h] = newStrItem(s,strTbl[h]);</span>
<a href="#l89.1730"></a><span id="l89.1730" class="difflineplus">+  s = dupStr(s, 0);</span>
<a href="#l89.1731"></a><span id="l89.1731" class="difflineplus">+  strTbl[h] = newStrItem(s, strTbl[h]);</span>
<a href="#l89.1732"></a><span id="l89.1732">   return s;</span>
<a href="#l89.1733"></a><span id="l89.1733"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/mailnews/addrbook/src/nsVCardObj.h</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsVCardObj.h</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -73,27 +73,27 @@ which accompanied this distribution.</span>
<a href="#l90.4"></a><span id="l90.4"> </span>
<a href="#l90.5"></a><span id="l90.5">   Also visit:</span>
<a href="#l90.6"></a><span id="l90.6"> </span>
<a href="#l90.7"></a><span id="l90.7">     http://www.versit.com</span>
<a href="#l90.8"></a><span id="l90.8">     http://www.ralden.com</span>
<a href="#l90.9"></a><span id="l90.9"> </span>
<a href="#l90.10"></a><span id="l90.10"> */</span>
<a href="#l90.11"></a><span id="l90.11"> </span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-</span>
<a href="#l90.13"></a><span id="l90.13"> #ifndef __VOBJECT_H__</span>
<a href="#l90.14"></a><span id="l90.14"> #define __VOBJECT_H__ 1</span>
<a href="#l90.15"></a><span id="l90.15"> </span>
<a href="#l90.16"></a><span id="l90.16"> /*</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineminus">-Unfortunately, on the Mac (and possibly other platforms) with our current, out-dated</span>
<a href="#l90.18"></a><span id="l90.18" class="difflineminus">-libraries (Plauger), |wchar_t| is defined incorrectly, which breaks vcards.</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineplus">+Unfortunately, on the Mac (and possibly other platforms) with our current,</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineplus">+out-dated libraries (Plauger), |wchar_t| is defined incorrectly, which breaks</span>
<a href="#l90.21"></a><span id="l90.21" class="difflineplus">+vcards.</span>
<a href="#l90.22"></a><span id="l90.22"> </span>
<a href="#l90.23"></a><span id="l90.23"> We can't fix Plauger because it doesn't come with source. Later, when we</span>
<a href="#l90.24"></a><span id="l90.24"> upgrade to MSL, we can make this evil hack go away.  In the mean time,</span>
<a href="#l90.25"></a><span id="l90.25" class="difflineminus">-vcards are not allowed to use the (incorrectly defined) |wchar_t| type.  Instead,</span>
<a href="#l90.26"></a><span id="l90.26" class="difflineplus">+vcards are not allowed to use the (incorrectly defined) |wchar_t| type. Instead,</span>
<a href="#l90.27"></a><span id="l90.27"> they will use an appropriately defined local type |vwchar_t|.</span>
<a href="#l90.28"></a><span id="l90.28"> */</span>
<a href="#l90.29"></a><span id="l90.29"> </span>
<a href="#l90.30"></a><span id="l90.30"> typedef wchar_t vwchar_t;</span>
<a href="#l90.31"></a><span id="l90.31"> </span>
<a href="#l90.32"></a><span id="l90.32"> #ifdef __cplusplus</span>
<a href="#l90.33"></a><span id="l90.33"> extern &quot;C&quot; {</span>
<a href="#l90.34"></a><span id="l90.34"> #endif</span>
<a href="#l90.35"></a><span id="l90.35" class="difflineat">@@ -257,39 +257,39 @@ extern &quot;C&quot; {</span>
<a href="#l90.36"></a><span id="l90.36"> #define VCX509Prop &quot;x509&quot;</span>
<a href="#l90.37"></a><span id="l90.37"> #define VCXRuleProp &quot;xrule&quot;</span>
<a href="#l90.38"></a><span id="l90.38"> #define VCCooltalk &quot;x-mozilla-cpt&quot;</span>
<a href="#l90.39"></a><span id="l90.39"> #define VCCooltalkAddress &quot;x-moxilla-cpadr&quot;</span>
<a href="#l90.40"></a><span id="l90.40"> #define VCUseServer &quot;x-mozilla-cpsrv&quot;</span>
<a href="#l90.41"></a><span id="l90.41"> #define VCUseHTML &quot;x-mozilla-html&quot;</span>
<a href="#l90.42"></a><span id="l90.42"> </span>
<a href="#l90.43"></a><span id="l90.43"> /* return type of vObjectValueType: */</span>
<a href="#l90.44"></a><span id="l90.44" class="difflineminus">-#define VCVT_NOVALUE  0</span>
<a href="#l90.45"></a><span id="l90.45" class="difflineminus">-  /* if the VObject has no value associated with it. */</span>
<a href="#l90.46"></a><span id="l90.46" class="difflineminus">-#define VCVT_STRINGZ  1</span>
<a href="#l90.47"></a><span id="l90.47" class="difflineminus">-  /* if the VObject has value set by setVObjectStringZValue. */</span>
<a href="#l90.48"></a><span id="l90.48" class="difflineplus">+#define VCVT_NOVALUE 0</span>
<a href="#l90.49"></a><span id="l90.49" class="difflineplus">+/* if the VObject has no value associated with it. */</span>
<a href="#l90.50"></a><span id="l90.50" class="difflineplus">+#define VCVT_STRINGZ 1</span>
<a href="#l90.51"></a><span id="l90.51" class="difflineplus">+/* if the VObject has value set by setVObjectStringZValue. */</span>
<a href="#l90.52"></a><span id="l90.52"> #define VCVT_USTRINGZ 2</span>
<a href="#l90.53"></a><span id="l90.53" class="difflineminus">-  /* if the VObject has value set by setVObjectUStringZValue. */</span>
<a href="#l90.54"></a><span id="l90.54" class="difflineminus">-#define VCVT_UINT   3</span>
<a href="#l90.55"></a><span id="l90.55" class="difflineminus">-  /* if the VObject has value set by setVObjectIntegerValue. */</span>
<a href="#l90.56"></a><span id="l90.56" class="difflineminus">-#define VCVT_ULONG    4</span>
<a href="#l90.57"></a><span id="l90.57" class="difflineminus">-  /* if the VObject has value set by setVObjectLongValue. */</span>
<a href="#l90.58"></a><span id="l90.58" class="difflineminus">-#define VCVT_RAW    5</span>
<a href="#l90.59"></a><span id="l90.59" class="difflineminus">-  /* if the VObject has value set by setVObjectAnyValue. */</span>
<a href="#l90.60"></a><span id="l90.60" class="difflineminus">-#define VCVT_VOBJECT  6</span>
<a href="#l90.61"></a><span id="l90.61" class="difflineminus">-  /* if the VObject has value set by setVObjectVObjectValue. */</span>
<a href="#l90.62"></a><span id="l90.62" class="difflineplus">+/* if the VObject has value set by setVObjectUStringZValue. */</span>
<a href="#l90.63"></a><span id="l90.63" class="difflineplus">+#define VCVT_UINT 3</span>
<a href="#l90.64"></a><span id="l90.64" class="difflineplus">+/* if the VObject has value set by setVObjectIntegerValue. */</span>
<a href="#l90.65"></a><span id="l90.65" class="difflineplus">+#define VCVT_ULONG 4</span>
<a href="#l90.66"></a><span id="l90.66" class="difflineplus">+/* if the VObject has value set by setVObjectLongValue. */</span>
<a href="#l90.67"></a><span id="l90.67" class="difflineplus">+#define VCVT_RAW 5</span>
<a href="#l90.68"></a><span id="l90.68" class="difflineplus">+/* if the VObject has value set by setVObjectAnyValue. */</span>
<a href="#l90.69"></a><span id="l90.69" class="difflineplus">+#define VCVT_VOBJECT 6</span>
<a href="#l90.70"></a><span id="l90.70" class="difflineplus">+/* if the VObject has value set by setVObjectVObjectValue. */</span>
<a href="#l90.71"></a><span id="l90.71"> </span>
<a href="#l90.72"></a><span id="l90.72" class="difflineminus">-#define NAME_OF(o)        o-&gt;id</span>
<a href="#l90.73"></a><span id="l90.73" class="difflineminus">-#define VALUE_TYPE(o)     o-&gt;valType</span>
<a href="#l90.74"></a><span id="l90.74" class="difflineminus">-#define STRINGZ_VALUE_OF(o)   o-&gt;val.strs</span>
<a href="#l90.75"></a><span id="l90.75" class="difflineminus">-#define USTRINGZ_VALUE_OF(o)  o-&gt;val.ustrs</span>
<a href="#l90.76"></a><span id="l90.76" class="difflineminus">-#define INTEGER_VALUE_OF(o)   o-&gt;val.i</span>
<a href="#l90.77"></a><span id="l90.77" class="difflineminus">-#define LONG_VALUE_OF(o)    o-&gt;val.l</span>
<a href="#l90.78"></a><span id="l90.78" class="difflineminus">-#define ANY_VALUE_OF(o)     o-&gt;val.any</span>
<a href="#l90.79"></a><span id="l90.79" class="difflineminus">-#define VOBJECT_VALUE_OF(o)   o-&gt;val.vobj</span>
<a href="#l90.80"></a><span id="l90.80" class="difflineplus">+#define NAME_OF(o) o-&gt;id</span>
<a href="#l90.81"></a><span id="l90.81" class="difflineplus">+#define VALUE_TYPE(o) o-&gt;valType</span>
<a href="#l90.82"></a><span id="l90.82" class="difflineplus">+#define STRINGZ_VALUE_OF(o) o-&gt;val.strs</span>
<a href="#l90.83"></a><span id="l90.83" class="difflineplus">+#define USTRINGZ_VALUE_OF(o) o-&gt;val.ustrs</span>
<a href="#l90.84"></a><span id="l90.84" class="difflineplus">+#define INTEGER_VALUE_OF(o) o-&gt;val.i</span>
<a href="#l90.85"></a><span id="l90.85" class="difflineplus">+#define LONG_VALUE_OF(o) o-&gt;val.l</span>
<a href="#l90.86"></a><span id="l90.86" class="difflineplus">+#define ANY_VALUE_OF(o) o-&gt;val.any</span>
<a href="#l90.87"></a><span id="l90.87" class="difflineplus">+#define VOBJECT_VALUE_OF(o) o-&gt;val.vobj</span>
<a href="#l90.88"></a><span id="l90.88"> </span>
<a href="#l90.89"></a><span id="l90.89"> typedef struct VObject VObject;</span>
<a href="#l90.90"></a><span id="l90.90"> </span>
<a href="#l90.91"></a><span id="l90.91"> typedef union ValueItem {</span>
<a href="#l90.92"></a><span id="l90.92">   const char *strs;</span>
<a href="#l90.93"></a><span id="l90.93">   const vwchar_t *ustrs;</span>
<a href="#l90.94"></a><span id="l90.94">   unsigned int i;</span>
<a href="#l90.95"></a><span id="l90.95">   unsigned long l;</span>
<a href="#l90.96"></a><span id="l90.96" class="difflineat">@@ -312,85 +312,86 @@ struct StrItem {</span>
<a href="#l90.97"></a><span id="l90.97">   const char *s;</span>
<a href="#l90.98"></a><span id="l90.98">   unsigned int refCnt;</span>
<a href="#l90.99"></a><span id="l90.99"> };</span>
<a href="#l90.100"></a><span id="l90.100"> </span>
<a href="#l90.101"></a><span id="l90.101"> typedef struct OFile {</span>
<a href="#l90.102"></a><span id="l90.102">   char *s;</span>
<a href="#l90.103"></a><span id="l90.103">   int len;</span>
<a href="#l90.104"></a><span id="l90.104">   int limit;</span>
<a href="#l90.105"></a><span id="l90.105" class="difflineminus">-  int alloc:1;</span>
<a href="#l90.106"></a><span id="l90.106" class="difflineminus">-  int fail:1;</span>
<a href="#l90.107"></a><span id="l90.107" class="difflineplus">+  int alloc : 1;</span>
<a href="#l90.108"></a><span id="l90.108" class="difflineplus">+  int fail : 1;</span>
<a href="#l90.109"></a><span id="l90.109"> } OFile;</span>
<a href="#l90.110"></a><span id="l90.110"> </span>
<a href="#l90.111"></a><span id="l90.111"> typedef struct VObjectIterator {</span>
<a href="#l90.112"></a><span id="l90.112" class="difflineminus">-  VObject* start;</span>
<a href="#l90.113"></a><span id="l90.113" class="difflineminus">-  VObject* next;</span>
<a href="#l90.114"></a><span id="l90.114" class="difflineplus">+  VObject *start;</span>
<a href="#l90.115"></a><span id="l90.115" class="difflineplus">+  VObject *next;</span>
<a href="#l90.116"></a><span id="l90.116"> } VObjectIterator;</span>
<a href="#l90.117"></a><span id="l90.117"> </span>
<a href="#l90.118"></a><span id="l90.118" class="difflineminus">-VObject*  newVObject(const char *id);</span>
<a href="#l90.119"></a><span id="l90.119" class="difflineminus">-void      deleteVObject(VObject *p);</span>
<a href="#l90.120"></a><span id="l90.120" class="difflineminus">-char*     dupStr(const char *s, unsigned int size);</span>
<a href="#l90.121"></a><span id="l90.121" class="difflineplus">+VObject *newVObject(const char *id);</span>
<a href="#l90.122"></a><span id="l90.122" class="difflineplus">+void deleteVObject(VObject *p);</span>
<a href="#l90.123"></a><span id="l90.123" class="difflineplus">+char *dupStr(const char *s, unsigned int size);</span>
<a href="#l90.124"></a><span id="l90.124"> extern &quot;C&quot; void deleteString(char *p);</span>
<a href="#l90.125"></a><span id="l90.125" class="difflineminus">-void      unUseStr(const char *s);</span>
<a href="#l90.126"></a><span id="l90.126" class="difflineplus">+void unUseStr(const char *s);</span>
<a href="#l90.127"></a><span id="l90.127"> </span>
<a href="#l90.128"></a><span id="l90.128" class="difflineminus">-void      setVObjectName(VObject *o, const char* id);</span>
<a href="#l90.129"></a><span id="l90.129" class="difflineminus">-void      setVObjectStringZValue(VObject *o, const char *s);</span>
<a href="#l90.130"></a><span id="l90.130" class="difflineminus">-void      setVObjectStringZValue_(VObject *o, const char *s);</span>
<a href="#l90.131"></a><span id="l90.131" class="difflineminus">-void      setVObjectUStringZValue(VObject *o, const vwchar_t *s);</span>
<a href="#l90.132"></a><span id="l90.132" class="difflineminus">-void      setVObjectUStringZValue_(VObject *o, const vwchar_t *s);</span>
<a href="#l90.133"></a><span id="l90.133" class="difflineminus">-void      setVObjectIntegerValue(VObject *o, unsigned int i);</span>
<a href="#l90.134"></a><span id="l90.134" class="difflineminus">-void      setVObjectLongValue(VObject *o, unsigned long l);</span>
<a href="#l90.135"></a><span id="l90.135" class="difflineminus">-void      setVObjectAnyValue(VObject *o, void *t);</span>
<a href="#l90.136"></a><span id="l90.136" class="difflineminus">-VObject*  setValueWithSize(VObject *prop, void *val, unsigned int size);</span>
<a href="#l90.137"></a><span id="l90.137" class="difflineminus">-VObject*  setValueWithSize_(VObject *prop, void *val, unsigned int size);</span>
<a href="#l90.138"></a><span id="l90.138" class="difflineplus">+void setVObjectName(VObject *o, const char *id);</span>
<a href="#l90.139"></a><span id="l90.139" class="difflineplus">+void setVObjectStringZValue(VObject *o, const char *s);</span>
<a href="#l90.140"></a><span id="l90.140" class="difflineplus">+void setVObjectStringZValue_(VObject *o, const char *s);</span>
<a href="#l90.141"></a><span id="l90.141" class="difflineplus">+void setVObjectUStringZValue(VObject *o, const vwchar_t *s);</span>
<a href="#l90.142"></a><span id="l90.142" class="difflineplus">+void setVObjectUStringZValue_(VObject *o, const vwchar_t *s);</span>
<a href="#l90.143"></a><span id="l90.143" class="difflineplus">+void setVObjectIntegerValue(VObject *o, unsigned int i);</span>
<a href="#l90.144"></a><span id="l90.144" class="difflineplus">+void setVObjectLongValue(VObject *o, unsigned long l);</span>
<a href="#l90.145"></a><span id="l90.145" class="difflineplus">+void setVObjectAnyValue(VObject *o, void *t);</span>
<a href="#l90.146"></a><span id="l90.146" class="difflineplus">+VObject *setValueWithSize(VObject *prop, void *val, unsigned int size);</span>
<a href="#l90.147"></a><span id="l90.147" class="difflineplus">+VObject *setValueWithSize_(VObject *prop, void *val, unsigned int size);</span>
<a href="#l90.148"></a><span id="l90.148"> </span>
<a href="#l90.149"></a><span id="l90.149" class="difflineminus">-const char* vObjectName(VObject *o);</span>
<a href="#l90.150"></a><span id="l90.150" class="difflineminus">-const char* vObjectStringZValue(VObject *o);</span>
<a href="#l90.151"></a><span id="l90.151" class="difflineminus">-const vwchar_t* vObjectUStringZValue(VObject *o);</span>
<a href="#l90.152"></a><span id="l90.152" class="difflineplus">+const char *vObjectName(VObject *o);</span>
<a href="#l90.153"></a><span id="l90.153" class="difflineplus">+const char *vObjectStringZValue(VObject *o);</span>
<a href="#l90.154"></a><span id="l90.154" class="difflineplus">+const vwchar_t *vObjectUStringZValue(VObject *o);</span>
<a href="#l90.155"></a><span id="l90.155"> unsigned int vObjectIntegerValue(VObject *o);</span>
<a href="#l90.156"></a><span id="l90.156"> unsigned long vObjectLongValue(VObject *o);</span>
<a href="#l90.157"></a><span id="l90.157" class="difflineminus">-void* vObjectAnyValue(VObject *o);</span>
<a href="#l90.158"></a><span id="l90.158" class="difflineminus">-VObject* vObjectVObjectValue(VObject *o);</span>
<a href="#l90.159"></a><span id="l90.159" class="difflineplus">+void *vObjectAnyValue(VObject *o);</span>
<a href="#l90.160"></a><span id="l90.160" class="difflineplus">+VObject *vObjectVObjectValue(VObject *o);</span>
<a href="#l90.161"></a><span id="l90.161"> void setVObjectVObjectValue(VObject *o, VObject *p);</span>
<a href="#l90.162"></a><span id="l90.162"> </span>
<a href="#l90.163"></a><span id="l90.163" class="difflineminus">-VObject* addVObjectProp(VObject *o, VObject *p);</span>
<a href="#l90.164"></a><span id="l90.164" class="difflineminus">-VObject* addProp(VObject *o, const char *id);</span>
<a href="#l90.165"></a><span id="l90.165" class="difflineminus">-VObject* addProp_(VObject *o, const char *id);</span>
<a href="#l90.166"></a><span id="l90.166" class="difflineminus">-VObject* addPropValue(VObject *o, const char *p, const char *v);</span>
<a href="#l90.167"></a><span id="l90.167" class="difflineminus">-VObject* addPropSizedValue_(VObject *o, const char *p, const char *v, unsigned int size);</span>
<a href="#l90.168"></a><span id="l90.168" class="difflineminus">-VObject* addPropSizedValue(VObject *o, const char *p, const char *v, unsigned int size);</span>
<a href="#l90.169"></a><span id="l90.169" class="difflineminus">-VObject* addGroup(VObject *o, const char *g);</span>
<a href="#l90.170"></a><span id="l90.170" class="difflineplus">+VObject *addVObjectProp(VObject *o, VObject *p);</span>
<a href="#l90.171"></a><span id="l90.171" class="difflineplus">+VObject *addProp(VObject *o, const char *id);</span>
<a href="#l90.172"></a><span id="l90.172" class="difflineplus">+VObject *addProp_(VObject *o, const char *id);</span>
<a href="#l90.173"></a><span id="l90.173" class="difflineplus">+VObject *addPropValue(VObject *o, const char *p, const char *v);</span>
<a href="#l90.174"></a><span id="l90.174" class="difflineplus">+VObject *addPropSizedValue_(VObject *o, const char *p, const char *v,</span>
<a href="#l90.175"></a><span id="l90.175" class="difflineplus">+                            unsigned int size);</span>
<a href="#l90.176"></a><span id="l90.176" class="difflineplus">+VObject *addPropSizedValue(VObject *o, const char *p, const char *v,</span>
<a href="#l90.177"></a><span id="l90.177" class="difflineplus">+                           unsigned int size);</span>
<a href="#l90.178"></a><span id="l90.178" class="difflineplus">+VObject *addGroup(VObject *o, const char *g);</span>
<a href="#l90.179"></a><span id="l90.179"> void addList(VObject **o, VObject *p);</span>
<a href="#l90.180"></a><span id="l90.180"> </span>
<a href="#l90.181"></a><span id="l90.181" class="difflineminus">-VObject* isAPropertyOf(VObject *o, const char *id);</span>
<a href="#l90.182"></a><span id="l90.182" class="difflineplus">+VObject *isAPropertyOf(VObject *o, const char *id);</span>
<a href="#l90.183"></a><span id="l90.183"> </span>
<a href="#l90.184"></a><span id="l90.184" class="difflineminus">-VObject* nextVObjectInList(VObject *o);</span>
<a href="#l90.185"></a><span id="l90.185" class="difflineplus">+VObject *nextVObjectInList(VObject *o);</span>
<a href="#l90.186"></a><span id="l90.186"> void initPropIterator(VObjectIterator *i, VObject *o);</span>
<a href="#l90.187"></a><span id="l90.187"> int moreIteration(VObjectIterator *i);</span>
<a href="#l90.188"></a><span id="l90.188" class="difflineminus">-VObject* nextVObject(VObjectIterator *i);</span>
<a href="#l90.189"></a><span id="l90.189" class="difflineplus">+VObject *nextVObject(VObjectIterator *i);</span>
<a href="#l90.190"></a><span id="l90.190"> </span>
<a href="#l90.191"></a><span id="l90.191"> void writeVObject_(OFile *fp, VObject *o);</span>
<a href="#l90.192"></a><span id="l90.192" class="difflineminus">-char* writeMemVObject(char *s, int *len, VObject *o);</span>
<a href="#l90.193"></a><span id="l90.193" class="difflineminus">-extern &quot;C&quot; char* writeMemoryVObjects(char *s, int *len, VObject *list, bool expandSpaces);</span>
<a href="#l90.194"></a><span id="l90.194" class="difflineplus">+char *writeMemVObject(char *s, int *len, VObject *o);</span>
<a href="#l90.195"></a><span id="l90.195" class="difflineplus">+extern &quot;C&quot; char *writeMemoryVObjects(char *s, int *len, VObject *list,</span>
<a href="#l90.196"></a><span id="l90.196" class="difflineplus">+                                     bool expandSpaces);</span>
<a href="#l90.197"></a><span id="l90.197"> </span>
<a href="#l90.198"></a><span id="l90.198" class="difflineminus">-const char* lookupStr(const char *s);</span>
<a href="#l90.199"></a><span id="l90.199" class="difflineplus">+const char *lookupStr(const char *s);</span>
<a href="#l90.200"></a><span id="l90.200"> </span>
<a href="#l90.201"></a><span id="l90.201"> void cleanVObject(VObject *o);</span>
<a href="#l90.202"></a><span id="l90.202"> void cleanVObjects(VObject *list);</span>
<a href="#l90.203"></a><span id="l90.203"> </span>
<a href="#l90.204"></a><span id="l90.204" class="difflineminus">-const char* lookupProp(const char* str);</span>
<a href="#l90.205"></a><span id="l90.205" class="difflineminus">-const char* lookupProp_(const char* str);</span>
<a href="#l90.206"></a><span id="l90.206" class="difflineplus">+const char *lookupProp(const char *str);</span>
<a href="#l90.207"></a><span id="l90.207" class="difflineplus">+const char *lookupProp_(const char *str);</span>
<a href="#l90.208"></a><span id="l90.208"> </span>
<a href="#l90.209"></a><span id="l90.209" class="difflineminus">-vwchar_t* fakeUnicode(const char *ps, int *bytes);</span>
<a href="#l90.210"></a><span id="l90.210" class="difflineplus">+vwchar_t *fakeUnicode(const char *ps, int *bytes);</span>
<a href="#l90.211"></a><span id="l90.211"> int uStrLen(const vwchar_t *u);</span>
<a href="#l90.212"></a><span id="l90.212" class="difflineminus">-char* fakeCString(const vwchar_t *u);</span>
<a href="#l90.213"></a><span id="l90.213" class="difflineplus">+char *fakeCString(const vwchar_t *u);</span>
<a href="#l90.214"></a><span id="l90.214"> </span>
<a href="#l90.215"></a><span id="l90.215"> #define MAXPROPNAMESIZE 256</span>
<a href="#l90.216"></a><span id="l90.216"> #define MAXMOZPROPNAMESIZE 16</span>
<a href="#l90.217"></a><span id="l90.217"> </span>
<a href="#l90.218"></a><span id="l90.218"> #ifdef __cplusplus</span>
<a href="#l90.219"></a><span id="l90.219"> }</span>
<a href="#l90.220"></a><span id="l90.220"> #endif</span>
<a href="#l90.221"></a><span id="l90.221"> </span>
<a href="#l90.222"></a><span id="l90.222"> #endif /* __VOBJECT_H__ */</span>
<a href="#l90.223"></a><span id="l90.223" class="difflineminus">-</span>
<a href="#l90.224"></a><span id="l90.224" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/mailnews/addrbook/src/nsWabAddressBook.cpp</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsWabAddressBook.cpp</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -10,112 +10,120 @@</span>
<a href="#l91.4"></a><span id="l91.4"> </span>
<a href="#l91.5"></a><span id="l91.5"> using namespace mozilla;</span>
<a href="#l91.6"></a><span id="l91.6"> </span>
<a href="#l91.7"></a><span id="l91.7"> static LazyLogModule gWabAddressBookLog(&quot;WABAddressBook&quot;);</span>
<a href="#l91.8"></a><span id="l91.8"> </span>
<a href="#l91.9"></a><span id="l91.9"> #define PRINTF(args) MOZ_LOG(gWabAddressBookLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l91.10"></a><span id="l91.10"> #define WAB_DLL_NAMEW L&quot;&quot; WAB_DLL_NAME</span>
<a href="#l91.11"></a><span id="l91.11"> </span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-HMODULE nsWabAddressBook::mLibrary = NULL ;</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineminus">-int32_t nsWabAddressBook::mLibUsage = 0 ;</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineminus">-LPWABOPEN nsWabAddressBook::mWABOpen = NULL ;</span>
<a href="#l91.15"></a><span id="l91.15" class="difflineminus">-LPWABOBJECT nsWabAddressBook::mRootSession = NULL ;</span>
<a href="#l91.16"></a><span id="l91.16" class="difflineminus">-LPADRBOOK nsWabAddressBook::mRootBook = NULL ;</span>
<a href="#l91.17"></a><span id="l91.17" class="difflineplus">+HMODULE nsWabAddressBook::mLibrary = NULL;</span>
<a href="#l91.18"></a><span id="l91.18" class="difflineplus">+int32_t nsWabAddressBook::mLibUsage = 0;</span>
<a href="#l91.19"></a><span id="l91.19" class="difflineplus">+LPWABOPEN nsWabAddressBook::mWABOpen = NULL;</span>
<a href="#l91.20"></a><span id="l91.20" class="difflineplus">+LPWABOBJECT nsWabAddressBook::mRootSession = NULL;</span>
<a href="#l91.21"></a><span id="l91.21" class="difflineplus">+LPADRBOOK nsWabAddressBook::mRootBook = NULL;</span>
<a href="#l91.22"></a><span id="l91.22"> </span>
<a href="#l91.23"></a><span id="l91.23" class="difflineminus">-BOOL nsWabAddressBook::LoadWabLibrary(void)</span>
<a href="#l91.24"></a><span id="l91.24" class="difflineminus">-{</span>
<a href="#l91.25"></a><span id="l91.25" class="difflineminus">-    if (mLibrary) { ++ mLibUsage ; return TRUE ; }</span>
<a href="#l91.26"></a><span id="l91.26" class="difflineplus">+BOOL nsWabAddressBook::LoadWabLibrary(void) {</span>
<a href="#l91.27"></a><span id="l91.27" class="difflineplus">+  if (mLibrary) {</span>
<a href="#l91.28"></a><span id="l91.28" class="difflineplus">+    ++mLibUsage;</span>
<a href="#l91.29"></a><span id="l91.29" class="difflineplus">+    return TRUE;</span>
<a href="#l91.30"></a><span id="l91.30" class="difflineplus">+  }</span>
<a href="#l91.31"></a><span id="l91.31"> </span>
<a href="#l91.32"></a><span id="l91.32" class="difflineminus">-    // We try to fetch the location of the WAB DLL from the registry</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineminus">-    WCHAR wabDLLPath [MAX_PATH] ;</span>
<a href="#l91.34"></a><span id="l91.34" class="difflineminus">-    DWORD keyType = 0 ;</span>
<a href="#l91.35"></a><span id="l91.35" class="difflineminus">-    ULONG byteCount = sizeof(wabDLLPath) ;</span>
<a href="#l91.36"></a><span id="l91.36" class="difflineminus">-    HKEY keyHandle = NULL ;</span>
<a href="#l91.37"></a><span id="l91.37" class="difflineminus">-    wabDLLPath [MAX_PATH - 1] = 0 ;</span>
<a href="#l91.38"></a><span id="l91.38" class="difflineminus">-    if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, WAB_DLL_PATH_KEY, 0, KEY_READ, &amp;keyHandle) == ERROR_SUCCESS) {</span>
<a href="#l91.39"></a><span id="l91.39" class="difflineminus">-        RegQueryValueExW(keyHandle, L&quot;&quot;, NULL, &amp;keyType, (LPBYTE) wabDLLPath, &amp;byteCount) ;</span>
<a href="#l91.40"></a><span id="l91.40" class="difflineminus">-        if (keyType == REG_EXPAND_SZ) {</span>
<a href="#l91.41"></a><span id="l91.41" class="difflineminus">-            // Expand the environment variables</span>
<a href="#l91.42"></a><span id="l91.42" class="difflineminus">-            DWORD bufferSize = ExpandEnvironmentStringsW(wabDLLPath, NULL, 0);</span>
<a href="#l91.43"></a><span id="l91.43" class="difflineminus">-            if (bufferSize &amp;&amp; bufferSize &lt; MAX_PATH) {</span>
<a href="#l91.44"></a><span id="l91.44" class="difflineminus">-                WCHAR tmp[MAX_PATH];</span>
<a href="#l91.45"></a><span id="l91.45" class="difflineminus">-                ExpandEnvironmentStringsW(wabDLLPath, tmp, bufferSize);</span>
<a href="#l91.46"></a><span id="l91.46" class="difflineminus">-                wcscpy(wabDLLPath, tmp);</span>
<a href="#l91.47"></a><span id="l91.47" class="difflineminus">-            }</span>
<a href="#l91.48"></a><span id="l91.48" class="difflineminus">-            else {</span>
<a href="#l91.49"></a><span id="l91.49" class="difflineminus">-                return FALSE;</span>
<a href="#l91.50"></a><span id="l91.50" class="difflineminus">-            }</span>
<a href="#l91.51"></a><span id="l91.51" class="difflineminus">-        }</span>
<a href="#l91.52"></a><span id="l91.52" class="difflineplus">+  // We try to fetch the location of the WAB DLL from the registry</span>
<a href="#l91.53"></a><span id="l91.53" class="difflineplus">+  WCHAR wabDLLPath[MAX_PATH];</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineplus">+  DWORD keyType = 0;</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineplus">+  ULONG byteCount = sizeof(wabDLLPath);</span>
<a href="#l91.56"></a><span id="l91.56" class="difflineplus">+  HKEY keyHandle = NULL;</span>
<a href="#l91.57"></a><span id="l91.57" class="difflineplus">+  wabDLLPath[MAX_PATH - 1] = 0;</span>
<a href="#l91.58"></a><span id="l91.58" class="difflineplus">+  if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, WAB_DLL_PATH_KEY, 0, KEY_READ,</span>
<a href="#l91.59"></a><span id="l91.59" class="difflineplus">+                   &amp;keyHandle) == ERROR_SUCCESS) {</span>
<a href="#l91.60"></a><span id="l91.60" class="difflineplus">+    RegQueryValueExW(keyHandle, L&quot;&quot;, NULL, &amp;keyType, (LPBYTE)wabDLLPath,</span>
<a href="#l91.61"></a><span id="l91.61" class="difflineplus">+                     &amp;byteCount);</span>
<a href="#l91.62"></a><span id="l91.62" class="difflineplus">+    if (keyType == REG_EXPAND_SZ) {</span>
<a href="#l91.63"></a><span id="l91.63" class="difflineplus">+      // Expand the environment variables</span>
<a href="#l91.64"></a><span id="l91.64" class="difflineplus">+      DWORD bufferSize = ExpandEnvironmentStringsW(wabDLLPath, NULL, 0);</span>
<a href="#l91.65"></a><span id="l91.65" class="difflineplus">+      if (bufferSize &amp;&amp; bufferSize &lt; MAX_PATH) {</span>
<a href="#l91.66"></a><span id="l91.66" class="difflineplus">+        WCHAR tmp[MAX_PATH];</span>
<a href="#l91.67"></a><span id="l91.67" class="difflineplus">+        ExpandEnvironmentStringsW(wabDLLPath, tmp, bufferSize);</span>
<a href="#l91.68"></a><span id="l91.68" class="difflineplus">+        wcscpy(wabDLLPath, tmp);</span>
<a href="#l91.69"></a><span id="l91.69" class="difflineplus">+      } else {</span>
<a href="#l91.70"></a><span id="l91.70" class="difflineplus">+        return FALSE;</span>
<a href="#l91.71"></a><span id="l91.71" class="difflineplus">+      }</span>
<a href="#l91.72"></a><span id="l91.72">     }</span>
<a href="#l91.73"></a><span id="l91.73" class="difflineminus">-    else {</span>
<a href="#l91.74"></a><span id="l91.74" class="difflineminus">-        if (GetSystemDirectoryW(wabDLLPath, MAX_PATH)) {</span>
<a href="#l91.75"></a><span id="l91.75" class="difflineminus">-            wcsncat(wabDLLPath, WAB_DLL_NAMEW,</span>
<a href="#l91.76"></a><span id="l91.76" class="difflineminus">-                     std::min(wcslen(WAB_DLL_NAMEW), MAX_PATH - wcslen(wabDLLPath) - 1));</span>
<a href="#l91.77"></a><span id="l91.77" class="difflineminus">-        }</span>
<a href="#l91.78"></a><span id="l91.78" class="difflineminus">-        else {</span>
<a href="#l91.79"></a><span id="l91.79" class="difflineminus">-            return FALSE;</span>
<a href="#l91.80"></a><span id="l91.80" class="difflineminus">-        }</span>
<a href="#l91.81"></a><span id="l91.81" class="difflineplus">+  } else {</span>
<a href="#l91.82"></a><span id="l91.82" class="difflineplus">+    if (GetSystemDirectoryW(wabDLLPath, MAX_PATH)) {</span>
<a href="#l91.83"></a><span id="l91.83" class="difflineplus">+      wcsncat(</span>
<a href="#l91.84"></a><span id="l91.84" class="difflineplus">+          wabDLLPath, WAB_DLL_NAMEW,</span>
<a href="#l91.85"></a><span id="l91.85" class="difflineplus">+          std::min(wcslen(WAB_DLL_NAMEW), MAX_PATH - wcslen(wabDLLPath) - 1));</span>
<a href="#l91.86"></a><span id="l91.86" class="difflineplus">+    } else {</span>
<a href="#l91.87"></a><span id="l91.87" class="difflineplus">+      return FALSE;</span>
<a href="#l91.88"></a><span id="l91.88">     }</span>
<a href="#l91.89"></a><span id="l91.89" class="difflineminus">-    if (keyHandle) { RegCloseKey(keyHandle) ; }</span>
<a href="#l91.90"></a><span id="l91.90" class="difflineminus">-    mLibrary = LoadLibraryW((lstrlenW(wabDLLPath)) ? wabDLLPath : WAB_DLL_NAMEW);</span>
<a href="#l91.91"></a><span id="l91.91" class="difflineminus">-    if (!mLibrary) { return FALSE ; }</span>
<a href="#l91.92"></a><span id="l91.92" class="difflineminus">-    ++ mLibUsage ;</span>
<a href="#l91.93"></a><span id="l91.93" class="difflineminus">-    mWABOpen = reinterpret_cast&lt;LPWABOPEN&gt;(GetProcAddress(mLibrary, &quot;WABOpen&quot;)) ;</span>
<a href="#l91.94"></a><span id="l91.94" class="difflineminus">-    if (!mWABOpen) { return FALSE ; }</span>
<a href="#l91.95"></a><span id="l91.95" class="difflineminus">-    HRESULT retCode = mWABOpen(&amp;mRootBook, &amp;mRootSession, NULL, 0) ;</span>
<a href="#l91.96"></a><span id="l91.96" class="difflineplus">+  }</span>
<a href="#l91.97"></a><span id="l91.97" class="difflineplus">+  if (keyHandle) {</span>
<a href="#l91.98"></a><span id="l91.98" class="difflineplus">+    RegCloseKey(keyHandle);</span>
<a href="#l91.99"></a><span id="l91.99" class="difflineplus">+  }</span>
<a href="#l91.100"></a><span id="l91.100" class="difflineplus">+  mLibrary = LoadLibraryW((lstrlenW(wabDLLPath)) ? wabDLLPath : WAB_DLL_NAMEW);</span>
<a href="#l91.101"></a><span id="l91.101" class="difflineplus">+  if (!mLibrary) {</span>
<a href="#l91.102"></a><span id="l91.102" class="difflineplus">+    return FALSE;</span>
<a href="#l91.103"></a><span id="l91.103" class="difflineplus">+  }</span>
<a href="#l91.104"></a><span id="l91.104" class="difflineplus">+  ++mLibUsage;</span>
<a href="#l91.105"></a><span id="l91.105" class="difflineplus">+  mWABOpen = reinterpret_cast&lt;LPWABOPEN&gt;(GetProcAddress(mLibrary, &quot;WABOpen&quot;));</span>
<a href="#l91.106"></a><span id="l91.106" class="difflineplus">+  if (!mWABOpen) {</span>
<a href="#l91.107"></a><span id="l91.107" class="difflineplus">+    return FALSE;</span>
<a href="#l91.108"></a><span id="l91.108" class="difflineplus">+  }</span>
<a href="#l91.109"></a><span id="l91.109" class="difflineplus">+  HRESULT retCode = mWABOpen(&amp;mRootBook, &amp;mRootSession, NULL, 0);</span>
<a href="#l91.110"></a><span id="l91.110"> </span>
<a href="#l91.111"></a><span id="l91.111" class="difflineminus">-    if (HR_FAILED(retCode)) {</span>
<a href="#l91.112"></a><span id="l91.112" class="difflineminus">-        PRINTF((&quot;Cannot initialize WAB %08x.\n&quot;, retCode)) ; return FALSE ;</span>
<a href="#l91.113"></a><span id="l91.113" class="difflineminus">-    }</span>
<a href="#l91.114"></a><span id="l91.114" class="difflineminus">-    return TRUE ;</span>
<a href="#l91.115"></a><span id="l91.115" class="difflineplus">+  if (HR_FAILED(retCode)) {</span>
<a href="#l91.116"></a><span id="l91.116" class="difflineplus">+    PRINTF((&quot;Cannot initialize WAB %08x.\n&quot;, retCode));</span>
<a href="#l91.117"></a><span id="l91.117" class="difflineplus">+    return FALSE;</span>
<a href="#l91.118"></a><span id="l91.118" class="difflineplus">+  }</span>
<a href="#l91.119"></a><span id="l91.119" class="difflineplus">+  return TRUE;</span>
<a href="#l91.120"></a><span id="l91.120"> }</span>
<a href="#l91.121"></a><span id="l91.121"> </span>
<a href="#l91.122"></a><span id="l91.122" class="difflineminus">-void nsWabAddressBook::FreeWabLibrary(void)</span>
<a href="#l91.123"></a><span id="l91.123" class="difflineminus">-{</span>
<a href="#l91.124"></a><span id="l91.124" class="difflineminus">-    if (mLibrary) {</span>
<a href="#l91.125"></a><span id="l91.125" class="difflineminus">-        if (-- mLibUsage == 0) {</span>
<a href="#l91.126"></a><span id="l91.126" class="difflineminus">-            if (mRootBook) { mRootBook-&gt;Release() ; }</span>
<a href="#l91.127"></a><span id="l91.127" class="difflineminus">-            if (mRootSession) { mRootSession-&gt;Release() ; }</span>
<a href="#l91.128"></a><span id="l91.128" class="difflineminus">-            FreeLibrary(mLibrary) ;</span>
<a href="#l91.129"></a><span id="l91.129" class="difflineminus">-            mLibrary = NULL ;</span>
<a href="#l91.130"></a><span id="l91.130" class="difflineminus">-        }</span>
<a href="#l91.131"></a><span id="l91.131" class="difflineplus">+void nsWabAddressBook::FreeWabLibrary(void) {</span>
<a href="#l91.132"></a><span id="l91.132" class="difflineplus">+  if (mLibrary) {</span>
<a href="#l91.133"></a><span id="l91.133" class="difflineplus">+    if (--mLibUsage == 0) {</span>
<a href="#l91.134"></a><span id="l91.134" class="difflineplus">+      if (mRootBook) {</span>
<a href="#l91.135"></a><span id="l91.135" class="difflineplus">+        mRootBook-&gt;Release();</span>
<a href="#l91.136"></a><span id="l91.136" class="difflineplus">+      }</span>
<a href="#l91.137"></a><span id="l91.137" class="difflineplus">+      if (mRootSession) {</span>
<a href="#l91.138"></a><span id="l91.138" class="difflineplus">+        mRootSession-&gt;Release();</span>
<a href="#l91.139"></a><span id="l91.139" class="difflineplus">+      }</span>
<a href="#l91.140"></a><span id="l91.140" class="difflineplus">+      FreeLibrary(mLibrary);</span>
<a href="#l91.141"></a><span id="l91.141" class="difflineplus">+      mLibrary = NULL;</span>
<a href="#l91.142"></a><span id="l91.142">     }</span>
<a href="#l91.143"></a><span id="l91.143" class="difflineplus">+  }</span>
<a href="#l91.144"></a><span id="l91.144"> }</span>
<a href="#l91.145"></a><span id="l91.145"> </span>
<a href="#l91.146"></a><span id="l91.146" class="difflineminus">-nsWabAddressBook::nsWabAddressBook(void)</span>
<a href="#l91.147"></a><span id="l91.147" class="difflineminus">-: nsAbWinHelper()</span>
<a href="#l91.148"></a><span id="l91.148" class="difflineminus">-{</span>
<a href="#l91.149"></a><span id="l91.149" class="difflineminus">-    mozilla::DebugOnly&lt;BOOL&gt; result = Initialize() ;</span>
<a href="#l91.150"></a><span id="l91.150" class="difflineplus">+nsWabAddressBook::nsWabAddressBook(void) : nsAbWinHelper() {</span>
<a href="#l91.151"></a><span id="l91.151" class="difflineplus">+  mozilla::DebugOnly&lt;BOOL&gt; result = Initialize();</span>
<a href="#l91.152"></a><span id="l91.152"> </span>
<a href="#l91.153"></a><span id="l91.153" class="difflineminus">-    NS_ASSERTION(result == TRUE, &quot;Couldn't initialize Wab Helper&quot;) ;</span>
<a href="#l91.154"></a><span id="l91.154" class="difflineminus">-    MOZ_COUNT_CTOR(nsWabAddressBook) ;</span>
<a href="#l91.155"></a><span id="l91.155" class="difflineplus">+  NS_ASSERTION(result == TRUE, &quot;Couldn't initialize Wab Helper&quot;);</span>
<a href="#l91.156"></a><span id="l91.156" class="difflineplus">+  MOZ_COUNT_CTOR(nsWabAddressBook);</span>
<a href="#l91.157"></a><span id="l91.157"> }</span>
<a href="#l91.158"></a><span id="l91.158"> </span>
<a href="#l91.159"></a><span id="l91.159" class="difflineminus">-nsWabAddressBook::~nsWabAddressBook(void)</span>
<a href="#l91.160"></a><span id="l91.160" class="difflineminus">-{</span>
<a href="#l91.161"></a><span id="l91.161" class="difflineminus">-    MutexAutoLock guard(*mMutex) ;</span>
<a href="#l91.162"></a><span id="l91.162" class="difflineminus">-    FreeWabLibrary() ;</span>
<a href="#l91.163"></a><span id="l91.163" class="difflineminus">-    MOZ_COUNT_DTOR(nsWabAddressBook) ;</span>
<a href="#l91.164"></a><span id="l91.164" class="difflineplus">+nsWabAddressBook::~nsWabAddressBook(void) {</span>
<a href="#l91.165"></a><span id="l91.165" class="difflineplus">+  MutexAutoLock guard(*mMutex);</span>
<a href="#l91.166"></a><span id="l91.166" class="difflineplus">+  FreeWabLibrary();</span>
<a href="#l91.167"></a><span id="l91.167" class="difflineplus">+  MOZ_COUNT_DTOR(nsWabAddressBook);</span>
<a href="#l91.168"></a><span id="l91.168"> }</span>
<a href="#l91.169"></a><span id="l91.169"> </span>
<a href="#l91.170"></a><span id="l91.170" class="difflineminus">-BOOL nsWabAddressBook::Initialize(void)</span>
<a href="#l91.171"></a><span id="l91.171" class="difflineminus">-{</span>
<a href="#l91.172"></a><span id="l91.172" class="difflineminus">-    if (mAddressBook) { return TRUE ; }</span>
<a href="#l91.173"></a><span id="l91.173" class="difflineminus">-    MutexAutoLock guard(*mMutex) ;</span>
<a href="#l91.174"></a><span id="l91.174" class="difflineplus">+BOOL nsWabAddressBook::Initialize(void) {</span>
<a href="#l91.175"></a><span id="l91.175" class="difflineplus">+  if (mAddressBook) {</span>
<a href="#l91.176"></a><span id="l91.176" class="difflineplus">+    return TRUE;</span>
<a href="#l91.177"></a><span id="l91.177" class="difflineplus">+  }</span>
<a href="#l91.178"></a><span id="l91.178" class="difflineplus">+  MutexAutoLock guard(*mMutex);</span>
<a href="#l91.179"></a><span id="l91.179"> </span>
<a href="#l91.180"></a><span id="l91.180" class="difflineminus">-    if (!LoadWabLibrary()) {</span>
<a href="#l91.181"></a><span id="l91.181" class="difflineminus">-        PRINTF((&quot;Cannot load library.\n&quot;)) ;</span>
<a href="#l91.182"></a><span id="l91.182" class="difflineminus">-        return FALSE ;</span>
<a href="#l91.183"></a><span id="l91.183" class="difflineminus">-    }</span>
<a href="#l91.184"></a><span id="l91.184" class="difflineminus">-    mAddressBook = mRootBook ;</span>
<a href="#l91.185"></a><span id="l91.185" class="difflineminus">-    return TRUE ;</span>
<a href="#l91.186"></a><span id="l91.186" class="difflineplus">+  if (!LoadWabLibrary()) {</span>
<a href="#l91.187"></a><span id="l91.187" class="difflineplus">+    PRINTF((&quot;Cannot load library.\n&quot;));</span>
<a href="#l91.188"></a><span id="l91.188" class="difflineplus">+    return FALSE;</span>
<a href="#l91.189"></a><span id="l91.189" class="difflineplus">+  }</span>
<a href="#l91.190"></a><span id="l91.190" class="difflineplus">+  mAddressBook = mRootBook;</span>
<a href="#l91.191"></a><span id="l91.191" class="difflineplus">+  return TRUE;</span>
<a href="#l91.192"></a><span id="l91.192"> }</span>
<a href="#l91.193"></a><span id="l91.193"> </span>
<a href="#l91.194"></a><span id="l91.194" class="difflineminus">-void nsWabAddressBook::AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer)</span>
<a href="#l91.195"></a><span id="l91.195" class="difflineminus">-{</span>
<a href="#l91.196"></a><span id="l91.196" class="difflineminus">-    mRootSession-&gt;AllocateBuffer(aByteCount, aBuffer) ;</span>
<a href="#l91.197"></a><span id="l91.197" class="difflineplus">+void nsWabAddressBook::AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) {</span>
<a href="#l91.198"></a><span id="l91.198" class="difflineplus">+  mRootSession-&gt;AllocateBuffer(aByteCount, aBuffer);</span>
<a href="#l91.199"></a><span id="l91.199"> }</span>
<a href="#l91.200"></a><span id="l91.200"> </span>
<a href="#l91.201"></a><span id="l91.201" class="difflineminus">-void nsWabAddressBook::FreeBuffer(LPVOID aBuffer)</span>
<a href="#l91.202"></a><span id="l91.202" class="difflineminus">-{</span>
<a href="#l91.203"></a><span id="l91.203" class="difflineminus">-    mRootSession-&gt;FreeBuffer(aBuffer) ;</span>
<a href="#l91.204"></a><span id="l91.204" class="difflineplus">+void nsWabAddressBook::FreeBuffer(LPVOID aBuffer) {</span>
<a href="#l91.205"></a><span id="l91.205" class="difflineplus">+  mRootSession-&gt;FreeBuffer(aBuffer);</span>
<a href="#l91.206"></a><span id="l91.206"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/mailnews/addrbook/src/nsWabAddressBook.h</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsWabAddressBook.h</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -4,54 +4,54 @@</span>
<a href="#l92.4"></a><span id="l92.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l92.5"></a><span id="l92.5"> #ifndef nsWabAddressBook_h___</span>
<a href="#l92.6"></a><span id="l92.6"> #define nsWabAddressBook_h___</span>
<a href="#l92.7"></a><span id="l92.7"> </span>
<a href="#l92.8"></a><span id="l92.8"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l92.9"></a><span id="l92.9"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l92.10"></a><span id="l92.10"> #include &lt;wab.h&gt;</span>
<a href="#l92.11"></a><span id="l92.11"> </span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-class nsWabAddressBook : public nsAbWinHelper</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineminus">-{</span>
<a href="#l92.14"></a><span id="l92.14" class="difflineminus">-public :</span>
<a href="#l92.15"></a><span id="l92.15" class="difflineminus">-    nsWabAddressBook(void) ;</span>
<a href="#l92.16"></a><span id="l92.16" class="difflineminus">-    virtual ~nsWabAddressBook(void) ;</span>
<a href="#l92.17"></a><span id="l92.17" class="difflineplus">+class nsWabAddressBook : public nsAbWinHelper {</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineplus">+ public:</span>
<a href="#l92.19"></a><span id="l92.19" class="difflineplus">+  nsWabAddressBook(void);</span>
<a href="#l92.20"></a><span id="l92.20" class="difflineplus">+  virtual ~nsWabAddressBook(void);</span>
<a href="#l92.21"></a><span id="l92.21"> </span>
<a href="#l92.22"></a><span id="l92.22" class="difflineminus">-protected :</span>
<a href="#l92.23"></a><span id="l92.23" class="difflineminus">-    // Session and address book that will be shared by all instances</span>
<a href="#l92.24"></a><span id="l92.24" class="difflineminus">-    // (see nsMapiAddressBook.h for details)</span>
<a href="#l92.25"></a><span id="l92.25" class="difflineminus">-    static LPWABOBJECT mRootSession ;</span>
<a href="#l92.26"></a><span id="l92.26" class="difflineminus">-    static LPADRBOOK mRootBook ;</span>
<a href="#l92.27"></a><span id="l92.27" class="difflineminus">-    // Class members to handle library loading/entry points</span>
<a href="#l92.28"></a><span id="l92.28" class="difflineminus">-    static int32_t mLibUsage ;</span>
<a href="#l92.29"></a><span id="l92.29" class="difflineminus">-    static HMODULE mLibrary ;</span>
<a href="#l92.30"></a><span id="l92.30" class="difflineminus">-    static LPWABOPEN mWABOpen ;</span>
<a href="#l92.31"></a><span id="l92.31" class="difflineplus">+ protected:</span>
<a href="#l92.32"></a><span id="l92.32" class="difflineplus">+  // Session and address book that will be shared by all instances</span>
<a href="#l92.33"></a><span id="l92.33" class="difflineplus">+  // (see nsMapiAddressBook.h for details)</span>
<a href="#l92.34"></a><span id="l92.34" class="difflineplus">+  static LPWABOBJECT mRootSession;</span>
<a href="#l92.35"></a><span id="l92.35" class="difflineplus">+  static LPADRBOOK mRootBook;</span>
<a href="#l92.36"></a><span id="l92.36" class="difflineplus">+  // Class members to handle library loading/entry points</span>
<a href="#l92.37"></a><span id="l92.37" class="difflineplus">+  static int32_t mLibUsage;</span>
<a href="#l92.38"></a><span id="l92.38" class="difflineplus">+  static HMODULE mLibrary;</span>
<a href="#l92.39"></a><span id="l92.39" class="difflineplus">+  static LPWABOPEN mWABOpen;</span>
<a href="#l92.40"></a><span id="l92.40"> </span>
<a href="#l92.41"></a><span id="l92.41" class="difflineminus">-    // Load the WAB environment</span>
<a href="#l92.42"></a><span id="l92.42" class="difflineminus">-    BOOL Initialize(void) ;</span>
<a href="#l92.43"></a><span id="l92.43" class="difflineminus">-    // Allocation of a buffer for transmission to interfaces</span>
<a href="#l92.44"></a><span id="l92.44" class="difflineminus">-    virtual void AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) override;</span>
<a href="#l92.45"></a><span id="l92.45" class="difflineminus">-    // Destruction of a buffer provided by the interfaces</span>
<a href="#l92.46"></a><span id="l92.46" class="difflineminus">-    virtual void FreeBuffer(LPVOID aBuffer) override;</span>
<a href="#l92.47"></a><span id="l92.47" class="difflineminus">-    // Manage the library</span>
<a href="#l92.48"></a><span id="l92.48" class="difflineminus">-    static BOOL LoadWabLibrary(void) ;</span>
<a href="#l92.49"></a><span id="l92.49" class="difflineminus">-    static void FreeWabLibrary(void) ;</span>
<a href="#l92.50"></a><span id="l92.50" class="difflineplus">+  // Load the WAB environment</span>
<a href="#l92.51"></a><span id="l92.51" class="difflineplus">+  BOOL Initialize(void);</span>
<a href="#l92.52"></a><span id="l92.52" class="difflineplus">+  // Allocation of a buffer for transmission to interfaces</span>
<a href="#l92.53"></a><span id="l92.53" class="difflineplus">+  virtual void AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) override;</span>
<a href="#l92.54"></a><span id="l92.54" class="difflineplus">+  // Destruction of a buffer provided by the interfaces</span>
<a href="#l92.55"></a><span id="l92.55" class="difflineplus">+  virtual void FreeBuffer(LPVOID aBuffer) override;</span>
<a href="#l92.56"></a><span id="l92.56" class="difflineplus">+  // Manage the library</span>
<a href="#l92.57"></a><span id="l92.57" class="difflineplus">+  static BOOL LoadWabLibrary(void);</span>
<a href="#l92.58"></a><span id="l92.58" class="difflineplus">+  static void FreeWabLibrary(void);</span>
<a href="#l92.59"></a><span id="l92.59"> </span>
<a href="#l92.60"></a><span id="l92.60" class="difflineminus">-private :</span>
<a href="#l92.61"></a><span id="l92.61" class="difflineminus">-} ;</span>
<a href="#l92.62"></a><span id="l92.62" class="difflineplus">+ private:</span>
<a href="#l92.63"></a><span id="l92.63" class="difflineplus">+};</span>
<a href="#l92.64"></a><span id="l92.64"> </span>
<a href="#l92.65"></a><span id="l92.65"> // Additional definitions for WAB stuff. These properties are</span>
<a href="#l92.66"></a><span id="l92.66"> // only defined with regards to the default character sizes,</span>
<a href="#l92.67"></a><span id="l92.67"> // and not in two _A and _W versions...</span>
<a href="#l92.68"></a><span id="l92.68" class="difflineplus">+// clang-format off</span>
<a href="#l92.69"></a><span id="l92.69"> #define PR_BUSINESS_ADDRESS_CITY_A                    PR_LOCALITY_A</span>
<a href="#l92.70"></a><span id="l92.70"> #define PR_BUSINESS_ADDRESS_COUNTRY_A                 PR_COUNTRY_A</span>
<a href="#l92.71"></a><span id="l92.71"> #define PR_BUSINESS_ADDRESS_POSTAL_CODE_A             PR_POSTAL_CODE_A</span>
<a href="#l92.72"></a><span id="l92.72"> #define PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_A       PR_STATE_OR_PROVINCE_A</span>
<a href="#l92.73"></a><span id="l92.73"> #define PR_BUSINESS_ADDRESS_STREET_A                  PR_STREET_ADDRESS_A</span>
<a href="#l92.74"></a><span id="l92.74"> </span>
<a href="#l92.75"></a><span id="l92.75"> #define PR_BUSINESS_ADDRESS_CITY_W                    PR_LOCALITY_W</span>
<a href="#l92.76"></a><span id="l92.76"> #define PR_BUSINESS_ADDRESS_COUNTRY_W                 PR_COUNTRY_W</span>
<a href="#l92.77"></a><span id="l92.77"> #define PR_BUSINESS_ADDRESS_POSTAL_CODE_W             PR_POSTAL_CODE_W</span>
<a href="#l92.78"></a><span id="l92.78"> #define PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_W       PR_STATE_OR_PROVINCE_W</span>
<a href="#l92.79"></a><span id="l92.79"> #define PR_BUSINESS_ADDRESS_STREET_W                  PR_STREET_ADDRESS_W</span>
<a href="#l92.80"></a><span id="l92.80" class="difflineplus">+// clang-format on</span>
<a href="#l92.81"></a><span id="l92.81"> </span>
<a href="#l92.82"></a><span id="l92.82" class="difflineminus">-#endif // nsWABAddressBook_h___</span>
<a href="#l92.83"></a><span id="l92.83" class="difflineminus">-</span>
<a href="#l92.84"></a><span id="l92.84" class="difflineplus">+#endif  // nsWABAddressBook_h___</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

